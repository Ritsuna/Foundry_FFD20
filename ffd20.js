class ChatMessagePF extends ChatMessage{static _initRollObject(e){if(Array.isArray(e))return e.map((e=>this._initRollObject(e)));if(null!=e&&"object"==typeof e&&"class"in e)return Roll.fromData(e);if("object"==typeof e&&null!=e)for(const[t,s]of Object.entries(e))e[t]=this._initRollObject(s);return e}get isRoll(){return this.type===CONST.CHAT_MESSAGE_TYPES.ROLL||this.getFlag("ffd20","noRollRender")}get itemSource(){const e=this.flags?.ffd20?.metadata?.item;if(e){const t=this.constructor.getSpeakerActor(this.speaker);return t?.items.get(e)}return null}get hasItemSource(){return void 0!==this.flags?.ffd20?.metadata?.item}get measureTemplate(){const e=this.system.flags?.ffd20?.metadata?.template;if(!e)return null;return canvas.templates.get(e)||null}get targets(){const e=this.system.flags?.ffd20?.metadata?.targets??[];return canvas.tokens.placeables.filter((t=>e.includes(t.id)))}prepareDerivedData(){super.prepareDerivedData(),this.systemRolls=this.constructor._initRollObject(this.flags?.ffd20?.metadata?.rolls??{})}}const customRolls=function(e,t,s){if(e.match(/^\/(\w+)(?: +([^#]+))(?:#(.+))?/)){const e=RegExp.$1?.toUpperCase(),n=RegExp.$2,l=RegExp.$3,c=CONFIG.ChatMessage.documentClass;t=t??c.getSpeaker();const u=c.getSpeakerActor(t),d=t.scene?game.scenes.get(t.scene):canvas.scene,m=d?.tokens.get(t.token),h=m?.uuid;switch(e){case"D":case"DAMAGE":case"H":case"HEAL":s=s??u?.getRollData()??{};return Roll.create(n,s).evaluate({async:!0}).then((async s=>{s.total;const n="HEAL"===e||"H"===e,u=await renderTemplate("systems/ffd20/templates/chat/simple-damage.hbs",{tokenId:h,isHealing:n,css:n?"heal":"damage",roll:s}),d={type:CONST.CHAT_MESSAGE_TYPES.ROLL,roll:s,flavor:l,sound:CONFIG.sounds.dice,speaker:t,rollMode:game.settings.get("core","rollMode"),content:u,flags:{ffd20:{subject:{health:n?"healing":"damage"}}}};c.create(d)}))}}return!1};class SemanticVersion{static re=/^(0|[1-9]\d*)\.(0|[1-9]\d*)(?:\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?)?$/;constructor(){this.major=0,this.minor=0,this.patch=0,this.preRelease="",this.buildMetaData=""}static fromString(e){if(e.match(this.re)){let e=new this;return e.major=parseInt(RegExp.$1),e.minor=parseInt(RegExp.$2),e.patch=parseInt(RegExp.$3||0),e.preRelease=RegExp.$4||"",e.buildMetaData=RegExp.$5||"",e}return null}toString(){return`${this.major}.${this.minor}.${this.patch}`}isHigherThan(e){return this.major>e.major||(this.major===e.major&&this.minor>e.minor||this.major===e.major&&this.minor===e.minor&&this.patch>e.patch)}isLowerThan(e){return this.major<e.major||(this.major===e.major&&this.minor<e.minor||this.major===e.major&&this.minor===e.minor&&this.patch<e.patch)}}class RollPF extends Roll{get totalHalved(){return Math.floor(this.total/2)}get dice(){return this.terms.reduce(((e,t)=>(t instanceof DiceTerm?e.push(t):(t instanceof PoolTerm||t instanceof ffd20.dice.terms.SizeRollTerm)&&(e=e.concat(t.dice)),e)),[]).concat(this._dice)}static safeRoll(e,t={},s,n={suppressError:!1}){let l;try{l=this.create(e,t).evaluate({async:!1})}catch(e){l=this.create("0",t).evaluate({async:!1}),l.err=e}return l.warning&&(l.err=Error("This formula had a value replaced with null.")),l.err&&(s&&!n.suppressError?console.error(s,l.err):CONFIG.debug.roll&&console.error(l.err)),l}static safeTotal(e,t){return isNaN(+e)?RollPF.safeRoll(e,t).total:+e}static simplifyTerms(e){let t=e.reduce(((e,t)=>{const s=e[e.length-1];if(!(t instanceof OperatorTerm)&&s instanceof StringTerm)return s.term+=t.total,foundry.utils.mergeObject(s.options,t.options),e;const n=s instanceof NumericTerm;if(s&&n&&t instanceof StringTerm&&t.term.match(/\[(.+)\]/))return s.options.flavor=RegExp.$1,e;const l=s instanceof ffd20.dice.terms.SizeRollTerm;if(s&&l&&t instanceof StringTerm){const n=t.term.match(ffd20.dice.terms.SizeRollTerm.TRAILER_REGEXP),[l,c,u]=n;return u&&(s.options.flavor=u),c&&(s.modifiers=Array.from((c||"").matchAll(DiceTerm.MODIFIER_REGEXP)).map((e=>e[0]))),e}const c=s instanceof OperatorTerm;return s&&!c&&t instanceof StringTerm?(t.term=s.total+""+t.term,foundry.utils.mergeObject(t.options,s.options),e[e.length-1]=t,e):(e.push(t),e)}),[]);return t=t.map((e=>{if(!(e instanceof StringTerm))return e;const t=this._classifyStringTerm(e.formula,{intermediate:!1});return t.options=foundry.utils.mergeObject(e.options,t.options,{inplace:!1}),t})),t[0]instanceof OperatorTerm&&"-"!==t[0].operator&&t.shift(),t[e.length-1]instanceof OperatorTerm&&t.pop(),t}static _splitParentheses(e){return this._splitGroup(e,{openRegexp:ParentheticalTerm.OPEN_REGEXP,closeRegexp:ParentheticalTerm.CLOSE_REGEXP,openSymbol:"(",closeSymbol:")",onClose:e=>{const t=e.open.slice(0,-1),s=e.terms.join(""),n={flavor:e.flavor?e.flavor.slice(1,-1):void 0},l=[];if("sizeRoll"===t){const e=this._splitMathArgs(s);l.push(new ffd20.dice.terms.SizeRollTerm({terms:e,options:n}))}else{if(t in ffd20.utils.rollPreProcess){const s=e.terms.reduce(((e,t)=>(e.push(...t.split(/\s*,\s*/)),e)),[]).map((e=>e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e.match(/^[a-zA-Z0-9]+$/)?parseRollStringVariable(e):RollPF.safeRoll(e,this.data).total));return ffd20.utils.rollPreProcess[t](...s)}if(t in Math){const e=this._splitMathArgs(s);l.push(new MathTerm({fn:t,terms:e,options:n}))}else t&&l.push(new StringTerm({term:t})),l.push(new ParentheticalTerm({term:s,options:n}))}return l}})}static cleanFlavor(e){return e.replace(/\[\];/g,"")}async getTooltip(){const e=this.dice.map((e=>e.getTooltipData())),t=this.terms.reduce(((e,t,s,n)=>{const l=t instanceof NumericTerm?t.getTooltipData():void 0,c=n[s-1];return t instanceof NumericTerm&&c&&c instanceof OperatorTerm&&"-"===c.operator&&(l.total=-l.total),void 0!==l&&(l.flavor||(l.flavor=game.i18n.localize("FFD20.Undefined")),e.push(l)),e}),[]);return renderTemplate("systems/ffd20/templates/dice/tooltip.hbs",{parts:e,numericParts:t})}}const parseRollStringVariable=function(e){return"false"!==e&&("true"===e||("null"===e?null:"undefined"!==e?e.match(/^(?:[0-9]+)?(?:\.[0-9]+)?$/)?parseFloat(e):e:void 0))},createTag=function(e){return 0===e.length&&(e="tag"),e.replace(/[^a-zA-Z0-9\s]/g,"").split(/\s+/).map(((e,t)=>(e=e.toLowerCase(),t>0&&(e=e.substring(0,1).toUpperCase()+e.substring(1)),e))).join("")},degtorad=function(e){return e*Math.PI/180},fractionalToString=e=>{const t=Math.floor(e),s=Math.roundDecimals(e-t,3);if(0===s)return""+t;const n=[];return 0!==t&&n.push(t),.25===s?n.push("1/4"):.333===s?n.push("1/3"):.5===s?n.push("1/2"):.667===s?n.push("2/3"):.75===s&&n.push("3/4"),n.join(" ")},e={fromString:e=>"1/8"===e?.125:"1/6"===e?.1625:"1/4"===e?.25:"1/3"===e?.3375:"1/2"===e?.5:parseFloat(e),fromNumber:e=>.125===e?"1/8":.1625===e?"1/6":.25===e?"1/4":.3375===e?"1/3":.5===e?"1/2":Number.isNumeric(e)?e.toString():"0"},getActorFromId=function(e){const t=ChatMessage.getSpeaker();let s=null;return e&&(s=game.actors.tokens[e],s||(s=game.actors.get(e))),t.token&&!s&&(s=game.actors.tokens[t.token]),s||(s=game.actors.get(t.actor)),s},convertDistance=function(e,t="ft"){return"metric"===getDistanceSystem()?"mi"===t?[Math.round(1.6*e*100)/100,"km"]:[Math.round(e/5*1.5*100)/100,"m"]:[e,t]},getDistanceSystem=()=>{let e=game.settings.get("ffd20","distanceUnits");return"default"===e&&(e=game.settings.get("ffd20","units")),e},getWeightSystem=()=>{let e=game.settings.get("ffd20","weightUnits");return"default"===e&&(e=game.settings.get("ffd20","units")),e},measureDistance=function(e,t,{ray:s=null,diagonalRule:n="5105",state:l={diagonals:0,cells:0}}={}){s??=new Ray(e,t);const c=canvas.dimensions.size,u=Math.ceil(Math.abs(s.dx/c)),d=Math.ceil(Math.abs(s.dy/c)),m=Math.min(u,d),h=Math.abs(d-u);l.diagonals+=m;let g=0;if("5105"===n){const e=Math.floor(l.diagonals/2)-Math.floor((l.diagonals-m)/2);g=2*e+(m-e)+h}else g=h+m;return l.cells+=g,g*canvas.dimensions.distance},naturalSort=function(e,t="",{numeric:s=!0,ignorePunctuation:n=!1}={}){const l=new Intl.Collator(game.settings.get("core","language"),{numeric:s,ignorePunctuation:n});return e.sort(((e,s)=>{const n=t?t in e?e[t]:getProperty(e,t):e,c=t?t in s?s[t]:getProperty(s,t):s;return l.compare(n,c)}))},createConsumableSpellDialog=async function(e,{allowSpell:t=!0}={}){const[s,n]=CONFIG.Item.documentClasses.spell.getMinimumCasterLevelBySpellData(e),l=await renderTemplate("systems/ffd20/templates/internal/create-consumable.hbs",{name:e.name,sl:s,cl:n,isGM:game.user.isGM}),getFormData=t=>{const s=expandObject(new FormDataExtended(t.querySelector("form")).object);return e.sl=s.sl??1,e.cl=s.cl??1,e.identified=s.identified,e.unidentifiedName=s.unidentifiedName,Number.isNaN(e.sl)&&(e.sl=1),e},c={potion:{icon:'<i class="fas fa-prescription-bottle"></i>',label:game.i18n.localize("FFD20.CreateItemPotion"),callback:e=>createConsumableSpell(getFormData(e),"potion")},scroll:{icon:'<i class="fas fa-scroll"></i>',label:game.i18n.localize("FFD20.CreateItemScroll"),callback:e=>createConsumableSpell(getFormData(e),"scroll")},wand:{icon:'<i class="fas fa-magic"></i>',label:game.i18n.localize("FFD20.CreateItemWand"),callback:e=>createConsumableSpell(getFormData(e),"wand")},spell:{icon:'<i class="fas fa-hand-sparkles"></i>',label:game.i18n.localize("FFD20.ItemTypeSpell"),callback:()=>"spell"}};return t||delete c.spell,Dialog.wait({title:game.i18n.format("FFD20.CreateItemForSpell",{name:e.name}),content:l,itemData:e,buttons:c,close:()=>!1,default:"potion"},{classes:["dialog","ffd20","create-consumable"],jQuery:!1})},createConsumableSpell=async function(e,t){const s=await CONFIG.Item.documentClasses.spell.toConsumable(e,t);return s._id&&delete s._id,s},adjustNumberByStringCommand=function(e,t,s=null,n=null){let l=e;if(t.match(/(=)?([+-]+)?(\d+)/)){const t=RegExp.$2,s="="==RegExp.$1||["--","++"].includes(t)||!RegExp.$1&&!RegExp.$2,n=["-","--"].includes(t),c=parseInt(RegExp.$3,10),u=n?-c:c;l=s?u:e+u}else l=""===t&&null!=n?n:parseFloat(t||"0");return s&&(l=Math.min(l,s)),Number.isNaN(l)&&(l=e),l},colorToInt=function(e){const t=e.rgb().color;return((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))},getBuffTargets=function(e,t="buffs"){const s=duplicate({buffs:ffd20.config.buffTargets,contextNotes:ffd20.config.contextNoteTargets}[t]);if(e)for(const t of e._skillTargets){const n=t.split(".").slice(1).join("."),l=e.getSkillInfo(n);s[t]={label:l.name,category:"skill"}}else for(const[e,t]of Object.entries(ffd20.config.skills))s["skill."+e]={label:t,category:"skill"};return s},getBuffTargetDictionary=function(e,t="buffs"){const s=getBuffTargets(e,t),n=duplicate({buffs:ffd20.config.buffTargetCategories,contextNotes:ffd20.config.contextNoteCategories}[t]);let l=Object.entries(s).reduce(((e,t)=>{const s=t[0],l=t[1].label,c=t[1].category,u=t[1].icon;return s.startsWith("~")||(e[c]=e[c]||{label:n[c].label,items:[]},e[c].items.push({key:s,label:l,icon:u})),e}),{});return l=Object.entries(l).reduce(((e,t)=>{const s=t[0],n=t[1].label,l=t[1].items;return e.push({key:s,label:n,items:l}),e}),[]),l=naturalSort(l,"label"),l},sortArrayByName=function(e){e=foundry.utils.deepClone(e);for(const t of e)t.name=t.name.toLocaleLowerCase();return naturalSort(e,"name",{numeric:!0,ignorePunctuation:!0})},binarySearch=function(e,t,s){let n=0,l=e.length-1;for(;n<=l;){const c=l+n>>1,u=s(t,e[c]);if(u>0)n=c+1;else{if(!(u<0))return c;l=c-1}}return-n-1};function uniquePermutations(e){const t=new Set;if(e.length>7)return console.warn("Array too large. Not attempting.",e),!1;for(let s=0;s<e.length;s+=1){const n=uniquePermutations(e.slice(0,s).concat(e.slice(s+1)));if(n.length)for(let l=0;l<n.length;l+=1)t.add([e[s]].concat(n[l]));else t.add([e[s]])}return[...t]}const stripRollFlairs=e=>e.replace(/\[[^\]]*]/g,"");function simplifyFormula(e,t={},{combine:s=!0}={}){const n=RollPF.parse(stripRollFlairs(e),t),l=[];for(;n.length;){const e=n.shift();if(e instanceof DiceTerm)l.push(e);else if(e instanceof OperatorTerm)if([">=",">","<=","<","==","===","!=","!==","||","&&","??"].includes(e.operator)){const t=[l.pop(),e,n.shift()],s=RollPF.fromTerms(t);s.evaluate({async:!1}),l.push(new NumericTerm({number:s.total}))}else l.push(e);else if(e instanceof CONFIG.Dice.termTypes.SizeRollTerm)e.evaluate({async:!1}),l.push(e);else if(e.isDeterministic){const t=RollPF.safeTotal(e.formula);l.push(...RollPF.parse(""+t))}else l.push(e)}const c=[];let u,d;for(;l.length;){u=d,d=l.shift();const e=l[0];if(d instanceof OperatorTerm){if("?"===d.operator){l.shift(),l.shift();const t=l.shift();let s=RollPF.safeTotal(u.formula)?e.formula:t?.formula??"";if(c.pop(),s){/^\((.*)\)$/.test(s)&&(s=s.slice(1,-1));const e=RollPF.parse(s);c.push(...e)}continue}if(u instanceof NumericTerm&&e instanceof NumericTerm&&s){const t=RollPF.safeEval(""+u.formula+d.formula+e.formula);d=RollPF.parse(""+t)[0],c.pop(),l.shift()}}c.push(d)}return c.map((e=>e.formula)).join("")}function enrichHTMLUnrolled(e,{rollData:t,secrets:s,rolls:n=!1,documents:l}={}){let c=TextEditor.enrichHTML(e,{secrets:s,rolls:n,documents:l,rollData:t,async:!1});if(!n){const e=document.createElement("div");e.innerHTML=c+"";const s=TextEditor._getTextNodes(e),n=/\[\[(\/[a-zA-Z]+\s)?(.*?)(]{2,3})(?:{([^}]+)})?/gi;TextEditor._replaceTextContent(s,n,(e=>function createInlineFormula(e,t,s){let[n,l,c,u]=e.slice(1,5);const d=["inline-preroll","inline-formula"];3===c.length&&(l+="]");const m=`${n}${l}`;let h=null;try{h=ChatLog.parse(m)}catch(e){return console.error("Failed to parse formula:",m,e),null}const[g,y]=h,[b,F,k,v]=y,D=document.createElement("a");g&&(d.push(g),D.dataset.mode=g),D.dataset.flavor=v?.trim()??u??"",l=Roll.defaultImplementation.replaceFormulaData(l.trim(),t||{});try{l=simplifyFormula(l)}catch(e){return console.error(e),null}return D.dataset.formula=l,D.classList.add(...d),D.dataset.tooltip=l,u=u?`${u}: ${l}`:l,D.innerHTML='<i class="fas fa-dice-d20"></i> '+u,D}(e,t))),c=e.innerHTML}return c}const splitCurrency=e=>{const t=Math.floor(e/100),s=Math.floor(e/10)-10*t;return e=e-100*t-10*s,{gil:Math.max(0,t),sgil:Math.max(0,s),cgil:Math.max(0,e)}},calculateRangeFormula=(e,t="ft",s={})=>{switch(t){case"melee":case"touch":return s.range?.melee??0;case"reach":return s.range?.reach??0;case"close":return RollPF.safeRoll(ffd20.config.spellRangeFormulas.close,s).total;case"medium":return RollPF.safeRoll(ffd20.config.spellRangeFormulas.medium,s).total;case"long":return RollPF.safeRoll(ffd20.config.spellRangeFormulas.long,s).total;case"mi":return 5280*RollPF.safeRoll(e,s).total;case"m":return RollPF.safeRoll(e,s).total/1.5*5;case"km":return 1e3*RollPF.safeRoll(e,s).total/1.5*5;default:return RollPF.safeRoll(e,s).total}};function calculateRange(e,t="ft",s={}){if(null==t)return null;const n=calculateRangeFormula(e,t,s);return convertDistance(n)[0]}function keepUpdateArray(e,t,s){const n=getProperty(t,s);if(null==n)return;if(Array.isArray(n))return;const l=deepClone(getProperty(e,s)||[]);for(const[e,t]of Object.entries(n))if("Object"===foundry.utils.getType(t)){const s=expandObject(t);l[e]=mergeObject(l[e],s)}else l[e]=t;setProperty(t,s,l)}const diffObjectAndArray=function(e,t,{inner:s=!1,keepLength:n=!1}={}){return Object.keys(t).reduce(((l,c)=>{if(s&&!(c in e))return l;const[u,d]=function _difference(e,t){const l=getType(e);if(l!==getType(t))return[!0,t];if("Array"===l){if(e.length!==t.length)return[!0,t];const l=[];for(let c=0;c<e.length;c++){const u=diffObjectAndArray(e[c],t[c],{inner:s,keepLength:n});foundry.utils.isEmpty(u)?n&&l.push({}):l.push(u)}return l.length>0?[!0,l]:[!1,l]}if("Object"===l){if(foundry.utils.isEmpty(e)!==foundry.utils.isEmpty(t))return[!0,t];const l=diffObjectAndArray(e,t,{inner:s,keepLength:n});return[!foundry.utils.isEmpty(l),l]}return[e!==t,t]}(e[c],t[c]);return u&&(l[c]=d),l}),{})};function getAbilityModifier(e=null,t={}){if(null!=e){const s=Math.abs(t.penalty??0),n=Math.abs(t.damage??0);return Math.max(-5,Math.floor((e-10)/2)-Math.floor(s/2)-Math.floor(n/2))}return 0}function setDefaultSceneScaling(e){e??=getDistanceSystem(),"metric"==e?(game.system.gridUnits="m",game.system.gridDistance=1.5):(game.system.gridUnits="ft",game.system.gridDistance=5)}const addLowLightVisionToLightConfig=function(e,t){const s=e.object;let n=`<div class="form-group"><label>${game.i18n.localize("FFD20.DisableLightLowLightVision")}</label>`;n+='<input type="checkbox" name="flags.ffd20.disableLowLight" data-dtype="Boolean"',s.getFlag("ffd20","disableLowLight")&&(n+=" checked"),n+="/></div>";const l=$(n);t.find('div.tab[data-tab="basic"]').append(l)},addLowLightVisionToTokenConfig=function(e,t){const s=e.object;let n=`<div class="form-group"><label>${game.i18n.localize("FFD20.DisableLightLowLightVision")}</label>`;n+='<input type="checkbox" name="flags.ffd20.disableLowLight" data-dtype="Boolean"',s.getFlag("ffd20","disableLowLight")&&(n+=" checked"),n+="/></div>";const l=$(n);t.find('.tab[data-group="light"][data-tab="basic"]').append(l)},patchCore=function(){const e=LightSource.prototype.initialize;LightSource.prototype.initialize=function(t={}){const{dim:s,bright:n}=this.getRadius(t.dim,t.bright);return void 0!==t.dim&&(t.dim=s),void 0!==t.bright&&(t.bright=n),e.call(this,t)},LightSource.prototype.getRadius=function(e,t){const s={dim:e,bright:t};let n={dim:1,bright:1};if(this.object?.document.getFlag("ffd20","disableLowLight"))return s;const l=game.user.isGM||game.settings.get("ffd20","lowLightVisionMode"),c=canvas.tokens.placeables.filter((e=>!!e.actor&&e.actor?.testUserPermission(game.user,"OBSERVER")&&(!l||e.controlled))),u=c.filter((e=>!0===e.actorVision.lowLight));if(l){if(u.length&&u.length===c.length){n={dim:999,bright:999};for(const e of u){const t=e.actorVision;n.dim=Math.min(n.dim,t.lowLightMultiplier),n.bright=Math.min(n.bright,t.lowLightMultiplierBright)}}}else for(const e of u){const t=e.actorVision;n.dim=Math.max(n.dim,t.lowLightMultiplier),n.bright=Math.max(n.bright,t.lowLightMultiplierBright)}return s.dim*=n.dim,s.bright*=n.bright,s}},t=Object.freeze(Object.defineProperty({__proto__:null,addLowLightVisionToLightConfig,addLowLightVisionToTokenConfig,patchCore},Symbol.toStringTag,{value:"Module"}));Hooks.once("init",(()=>{game.release.generation>=11||Object.defineProperty(Users.prototype,"activeGM",{get:function(){const e=game.users.filter((e=>e.active&&e.isGM));return e.sort(((e,t)=>e.id>t.id?1:-1)),e[0]||null}})}));{const e=ChatLog.parse;ChatLog.parse=function(t){const s=t.match(/^\/(\w+)(?: +([^#]+))(?:#(.+))?/),n=s?.[1]?.toUpperCase();return["HEAL","H","DAMAGE","D"].includes(n)?(s[2]=s[0].slice(1),["custom",s]):e.call(this,t)};const t=TextEditor._onClickInlineRoll;TextEditor._onClickInlineRoll=function(e){e.preventDefault();const s=e.currentTarget;if(!s.classList.contains("custom"))return t.call(this,e);const n="/"+s.dataset.formula,l=CONFIG.ChatMessage.documentClass,c=l.getSpeaker(),u=l.getSpeakerActor(c);let d=u?u.getRollData():{};const m=s.closest(".sheet");if(m){const e=ui.windows[m.dataset.appid];["Actor","Item"].includes(e?.document.documentName)&&(d=e.object.getRollData())}return customRolls(n,c,d)},$._data($("body").get(0),"events")?.click?.find((e=>"a.inline-roll"===e.selector))&&($("body").off("click","a.inline-roll",t),$("body").on("click","a.inline-roll",TextEditor._onClickInlineRoll))}{const e=KeyboardManager.prototype._onAlt;KeyboardManager.prototype._onAlt=function(t,s,n){ffd20.tooltip&&(s||(ffd20.tooltip.lock.new=!0),e.call(this,t,s,n),s||(ffd20.tooltip.lock.new=!1))}}StringTerm.prototype.evaluate=function(e={}){const t=parseRollStringVariable(this.term);if("string"==typeof t){const e=`with (sandbox) { return ${this.term}; }`;try{const t=Function("sandbox",e);this._total=t(RollPF.MATH_PROXY)}catch(e){throw e.message=`Failed to evaluate: '${this.term}'\n${e.message}`,e}}else this._total=t},NumericTerm.prototype.getTooltipData=function(){return{formula:this.expression,total:this.total,flavor:this.flavor}},ParentheticalTerm.CLOSE_REGEXP=RegExp(`\\)${RollTerm.FLAVOR_REGEXP_STRING}?`,"g"),OperatorTerm.REGEXP=/(?:&&|\|\||\*\*|\+|-|\*|\/|\\%|\||:|\?)|(?<![a-z])[!=<>]+/g,OperatorTerm.OPERATORS.push("\\%","!","?",":","=","<",">","==","===","<=",">=","??","||","&&","**");{const e=CompendiumCollection.prototype.getIndex;CompendiumCollection.prototype.getIndex=async function({fields:t}={}){const s=await e.call(this,{fields:t});return this.fuzzyIndex=sortArrayByName([...s]),this.index}}{const e=TextEditor._createContentLink;TextEditor._createContentLink=function(t,{async:s=!1,relativeTo:n}={}){const[l,c,u,d]=t.slice(1,5),m=e.call(this,t,{async:s,relativeTo:n});if(d?.indexOf("::")>-1){const e=d.split("::"),t=e.pop();e.length&&(e.forEach((e=>{let[t,s]=e.split(/(?<!\\):/);switch(t&&s||(s=t,t="extra"),t){case"icon":m.firstChild.className="fas fa-"+s;break;case"class":m.classList.add(...s.split(" "));break;default:m.setAttribute("data-"+t,s)}})),m.lastChild.textContent=t)}return m}}{const e=KeybindingsConfig.prototype._detectConflictingActions;KeybindingsConfig.prototype._detectConflictingActions=function(t,s,n){return t.startsWith("ffd20.")&&s.uneditable.includes(n)?[]:e.call(this,t,s,n)}}{const e=Roll.fromData;Roll.fromData=function(t,...s){return"RollPF$1"===t.class&&(t.class="RollPF"),e.call(this,t,...s)}}{const e=ImagePopout._handleShareImage;ImagePopout._handleShareImage=function({image:t,title:s,caption:n,uuid:l,showTitle:c}={}){const u=fromUuidSync(l);return u instanceof Item&&(s=u.name),e.call(this,{image:t,title:s,caption:n,uuid:l,showTitle:c})}}KeyboardManager.prototype._onFocusIn,KeyboardManager.prototype._onFocusIn=function(e){const t=[HTMLInputElement,HTMLSelectElement,HTMLTextAreaElement,HTMLOptionElement];(e.target.isContentEditable||t.some((t=>e.target instanceof t)))&&this.releaseKeys()},Object.defineProperty(KeyboardManager.prototype,"hasFocus",{get(){const e=["input","select","textarea","option","[contenteditable]"].map((e=>e+":focus")).join(", ");return document.querySelectorAll(e).length>0}}),patchCore();const s={spells:{label:"FFD20.BrowseSpells"},items:{label:"FFD20.BrowseItems"},bestiary:{label:"FFD20.BrowseBestiary"},feats:{label:"FFD20.BrowseFeats"},classes:{label:"FFD20.BrowseClasses"},races:{label:"FFD20.BrowseRaces"},buffs:{label:"FFD20.BrowseBuffs",wide:!0}};function compendiumButtonClick(e){e.preventDefault();const t=e.target.dataset.category;ffd20.applications.compendiums[t]._render(!0,{focus:!0})}Hooks.on("renderCompendiumDirectory",(async(e,[t],n)=>{const l=t.querySelector("footer.directory-footer");l.classList.add("action-buttons");for(const[e,t]of Object.entries(s)){const s=document.createElement("button");s.type="button",s.dataset.category=e,s.classList.add("compendium",e),s.innerText=game.i18n.localize(t.label),t.wide&&s.classList.add("colspan-2"),l.append(s),s.addEventListener("click",compendiumButtonClick)}})),Hooks.on("getCompendiumDirectoryEntryContext",((e,t)=>{t.unshift({name:game.i18n.localize("FFD20.CompendiumBrowser.HidePack"),icon:'<i class="fas fa-low-vision"></i>',condition:([e])=>{const t=game.packs.get(e.dataset.pack);return!0!==t.config.ffd20?.disabled},callback:([e])=>{game.packs.get(e.dataset.pack).configure({ffd20:{disabled:!0}})}},{name:game.i18n.localize("FFD20.CompendiumBrowser.ShowPack"),icon:'<i class="fas fa-eye"></i>',condition:([e])=>{const t=game.packs.get(e.dataset.pack);return!0===t.config.ffd20?.disabled},callback:([e])=>{game.packs.get(e.dataset.pack).configure({ffd20:{disabled:!1}})}})}));const tinyMCEInit=function(){CONFIG.TinyMCE.content_css.push("/systems/ffd20/ui/mce.css"),CONFIG.TinyMCE.style_formats[0].items.push({title:game.i18n.localize("FFD20.NotImplemented"),inline:"span",classes:"notImp",attributes:{title:game.i18n.localize("FFD20.NotImplemented")},remove:"all"},{title:game.i18n.localize("FFD20.StepsRequired"),inline:"span",classes:"needSteps",attributes:{title:game.i18n.localize("FFD20.StepsRequired")},remove:"all"}),CONFIG.TinyMCE.formats=Object.assign({},CONFIG.TinyMCE.formats,{removeFormat:[{selector:"span",classes:"notImp,needSteps",remove:"all"}]}),tinyMCE.on("addeditor",(e=>{!function registerContextMenu(e){const isInfoElement=function(e){return"SPAN"!==e.nodeName&&(e=e.parentNode),"SPAN"===e.nodeName&&(e.classList.contains("notImp")||e.classList.contains("needSteps"))},getInfoElement=function(){const t=e.selection.getNode();return isInfoElement(t)?t.closest("span.notImp,span.needSteps"):null};e.ui.registry.addContextForm("info-form",{launch:{type:"contextformtogglebutton",icon:"warning"},label:"Info",predicate:isInfoElement,initValue:function(){const e=getInfoElement();return e?e.title:""},commands:[{type:"contextformtogglebutton",icon:"warning",tooltip:game.i18n.localize("FFD20.NotImplemented"),onSetup:function(t){t.setActive(!!getInfoElement()?.classList.contains("notImp"));const nodeChangeHandler=function(){t.setActive(!e.readonly&&getInfoElement()?.classList.contains("notImp"))};return e.on("nodechange",nodeChangeHandler),function(){e.off("nodechange",nodeChangeHandler)}},onAction:function(t){const s=t.getValue(),n=getInfoElement();e.setDirty(!0),e.dom.setAttribs(n,{title:s,class:"notImp"}),t.hide()}},{type:"contextformtogglebutton",icon:"selected",tooltip:game.i18n.localize("FFD20.StepsRequired"),onSetup:function(t){t.setActive(!!getInfoElement()?.classList.contains("needSteps"));const nodeChangeHandler=function(){t.setActive(!e.readonly&&getInfoElement()?.classList.contains("needSteps"))};return e.on("nodechange",nodeChangeHandler),function(){e.off("nodechange",nodeChangeHandler)}},onAction:function(t){const s=t.getValue(),n=getInfoElement();e.setDirty(!0),e.dom.setAttribs(n,{title:s,class:"needSteps"}),t.hide()}},{type:"contextformtogglebutton",icon:"close",tooltip:game.i18n.localize("FFD20.RemoveInfo"),onAction:function(t){const s=getInfoElement();e.setDirty(!0),e.dom.remove(s,!0),t.hide()}}]})}(e.editor)}))};const measureDistances=function(e,t={}){if(!t.gridSpaces)return BaseGrid.prototype.measureDistances.call(this,e,t);const s=this.parent.diagonalRule,n={diagonals:0};return e.map((e=>measureDistance(null,null,{ray:e.ray,diagonalRule:s,state:n})))},getConditions=function(){const e=CONFIG.statusEffects;let t=Object.keys(ffd20.config.conditions).map((e=>({id:e,label:ffd20.config.conditions[e],icon:ffd20.config.conditionTextures[e]})));return game.settings.get("ffd20","coreEffects")?t.push(...e):t=[e[0]].concat(t),t.sort(((e,t)=>e.label.localeCompare(t.label)))},n=TokenHUD.prototype._getStatusEffectChoices;TokenHUD.prototype._getStatusEffectChoices=function(){const e=n.call(this),t={};for(const e of Object.values(this.object.actor._calcBuffActiveEffects?.()??{}))e&&(t["buff-"+e.id]={id:e.id,title:e.label,src:e.icon,isActive:e.active,isOverlay:!1,cssClass:e.active?"active":""});return{...e,...t}},TokenHUD.prototype._onToggleEffect=function(e,{overlay:t=!1}={}){e.preventDefault();const s=e.currentTarget,n=s.dataset.statusId&&this.object.actor?CONFIG.statusEffects.find((e=>e.id===s.dataset.statusId))??s.dataset.statusId:s.getAttribute("src");return this.object.toggleEffect(n,{overlay:t})};const l=Object.freeze(Object.defineProperty({__proto__:null,getConditions,measureDistances},Symbol.toStringTag,{value:"Module"}));const runSocketFunction=async function(e,t){const s=game.users.activeGM.isSelf,n=game.users.get(t);try{switch(e.eventType){case"currencyTransfer":{if(!s)return;let t=await fromUuid(e.data.sourceActor),n=await fromUuid(e.data.destActor);e.data.sourceContainer&&(t=t.items.get(e.data.sourceContainer)),e.data.destContainer&&(n=n.items.get(e.data.destContainer));const l=e.data.amount;ffd20.applications.CurrencyTransfer.transfer(t,n,l,e.data.sourceAlt,e.data.destAlt,!1);break}case"alterChatTargetAttribute":s&&alterChatTargetAttribute(e);break;case"giveItem":{if(!s)return;const t=await fromUuid(e.item),l=t.actor;if(!l.testUserPermission(n,"OWNER"))return;const c=await fromUuid(e.targetActor),u=t.toObject();await c.createEmbeddedDocuments("Item",[u]),await l.deleteEmbeddedDocuments("Item",[t.id]);break}case"refreshActorSheets":ffd20.utils.refreshActors({renderOnly:!0})}}catch(e){console.log("FFD20 | Socket Error: ",e)}},alterChatTargetAttribute=function(e){const t=game.messages.get(e.message),s=$(t.data.content);if(null!=e.save){const n=s.find(`div.attack-targets .target[data-uuid="${e.targetUuid}"] .saving-throws .${e.save}`).find(".value");return n.html(""+e.value),e.isFailure?n.addClass("failure"):n.removeClass("failure"),e.isSuccess?n.addClass("success"):n.removeClass("success"),t.update({content:s.prop("outerHTML")})}};var c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var s=function a3(){if(this instanceof a3){var e=[null];return e.push.apply(e,arguments),new(Function.bind.apply(t,e))}return t.apply(this,arguments)};s.prototype=t.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),s}var u={exports:{}},d={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},m={exports:{}},h=function isArrayish(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},g=Array.prototype.concat,y=Array.prototype.slice,b=m.exports=function swizzle(e){for(var t=[],s=0,n=e.length;s<n;s++){var l=e[s];h(l)?t=g.call(t,y.call(l)):t.push(l)}return t};b.wrap=function(e){return function(){return e(b(arguments))}};var F=m.exports,k=d,v=F,D=Object.hasOwnProperty,C=Object.create(null);for(var S in k)D.call(k,S)&&(C[k[S]]=S);var T=u.exports={to:{},get:{}};function clamp(e,t,s){return Math.min(Math.max(t,e),s)}function hexDouble(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}T.get=function(e){var t,s;switch(e.substring(0,3).toLowerCase()){case"hsl":t=T.get.hsl(e),s="hsl";break;case"hwb":t=T.get.hwb(e),s="hwb";break;default:t=T.get.rgb(e),s="rgb"}return t?{model:s,value:t}:null},T.get.rgb=function(e){if(!e)return null;var t,s,n,l=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(n=t[2],t=t[1],s=0;s<3;s++){var c=2*s;l[s]=parseInt(t.slice(c,c+2),16)}n&&(l[3]=parseInt(n,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(n=(t=t[1])[3],s=0;s<3;s++)l[s]=parseInt(t[s]+t[s],16);n&&(l[3]=parseInt(n+n,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(s=0;s<3;s++)l[s]=parseInt(t[s+1],0);t[4]&&(t[5]?l[3]=.01*parseFloat(t[4]):l[3]=parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:D.call(k,t[1])?((l=k[t[1]])[3]=1,l):null:null;for(s=0;s<3;s++)l[s]=Math.round(2.55*parseFloat(t[s+1]));t[4]&&(t[5]?l[3]=.01*parseFloat(t[4]):l[3]=parseFloat(t[4]))}for(s=0;s<3;s++)l[s]=clamp(l[s],0,255);return l[3]=clamp(l[3],0,1),l},T.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var s=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,clamp(parseFloat(t[2]),0,100),clamp(parseFloat(t[3]),0,100),clamp(isNaN(s)?1:s,0,1)]}return null},T.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var s=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,clamp(parseFloat(t[2]),0,100),clamp(parseFloat(t[3]),0,100),clamp(isNaN(s)?1:s,0,1)]}return null},T.to.hex=function(){var e=v(arguments);return"#"+hexDouble(e[0])+hexDouble(e[1])+hexDouble(e[2])+(e[3]<1?hexDouble(Math.round(255*e[3])):"")},T.to.rgb=function(){var e=v(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},T.to.rgb.percent=function(){var e=v(arguments),t=Math.round(e[0]/255*100),s=Math.round(e[1]/255*100),n=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+s+"%, "+n+"%)":"rgba("+t+"%, "+s+"%, "+n+"%, "+e[3]+")"},T.to.hsl=function(){var e=v(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},T.to.hwb=function(){var e=v(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},T.to.keyword=function(e){return C[e.slice(0,3)]};var _=u.exports;const w=d,A={};for(const e of Object.keys(w))A[w[e]]=e;const x={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};var I=x;for(const e of Object.keys(x)){if(!("channels"in x[e]))throw Error("missing channels property: "+e);if(!("labels"in x[e]))throw Error("missing channel labels property: "+e);if(x[e].labels.length!==x[e].channels)throw Error("channel and label counts mismatch: "+e);const{channels:t,labels:s}=x[e];delete x[e].channels,delete x[e].labels,Object.defineProperty(x[e],"channels",{value:t}),Object.defineProperty(x[e],"labels",{value:s})}x.rgb.hsl=function(e){const t=e[0]/255,s=e[1]/255,n=e[2]/255,l=Math.min(t,s,n),c=Math.max(t,s,n),u=c-l;let d,m;c===l?d=0:t===c?d=(s-n)/u:s===c?d=2+(n-t)/u:n===c&&(d=4+(t-s)/u),d=Math.min(60*d,360),d<0&&(d+=360);const h=(l+c)/2;return m=c===l?0:h<=.5?u/(c+l):u/(2-c-l),[d,100*m,100*h]},x.rgb.hsv=function(e){let t,s,n,l,c;const u=e[0]/255,d=e[1]/255,m=e[2]/255,h=Math.max(u,d,m),g=h-Math.min(u,d,m),diffc=function(e){return(h-e)/6/g+.5};return 0===g?(l=0,c=0):(c=g/h,t=diffc(u),s=diffc(d),n=diffc(m),u===h?l=n-s:d===h?l=1/3+t-n:m===h&&(l=2/3+s-t),l<0?l+=1:l>1&&(l-=1)),[360*l,100*c,100*h]},x.rgb.hwb=function(e){const t=e[0],s=e[1];let n=e[2];const l=x.rgb.hsl(e)[0],c=1/255*Math.min(t,Math.min(s,n));return n=1-1/255*Math.max(t,Math.max(s,n)),[l,100*c,100*n]},x.rgb.cmyk=function(e){const t=e[0]/255,s=e[1]/255,n=e[2]/255,l=Math.min(1-t,1-s,1-n);return[100*((1-t-l)/(1-l)||0),100*((1-s-l)/(1-l)||0),100*((1-n-l)/(1-l)||0),100*l]},x.rgb.keyword=function(e){const t=A[e];if(t)return t;let s,n=1/0;for(const t of Object.keys(w)){const u=(c=w[t],((l=e)[0]-c[0])**2+(l[1]-c[1])**2+(l[2]-c[2])**2);u<n&&(n=u,s=t)}var l,c;return s},x.keyword.rgb=function(e){return w[e]},x.rgb.xyz=function(e){let t=e[0]/255,s=e[1]/255,n=e[2]/255;t=t>.04045?((t+.055)/1.055)**2.4:t/12.92,s=s>.04045?((s+.055)/1.055)**2.4:s/12.92,n=n>.04045?((n+.055)/1.055)**2.4:n/12.92;return[100*(.4124*t+.3576*s+.1805*n),100*(.2126*t+.7152*s+.0722*n),100*(.0193*t+.1192*s+.9505*n)]},x.rgb.lab=function(e){const t=x.rgb.xyz(e);let s=t[0],n=t[1],l=t[2];s/=95.047,n/=100,l/=108.883,s=s>.008856?s**(1/3):7.787*s+16/116,n=n>.008856?n**(1/3):7.787*n+16/116,l=l>.008856?l**(1/3):7.787*l+16/116;return[116*n-16,500*(s-n),200*(n-l)]},x.hsl.rgb=function(e){const t=e[0]/360,s=e[1]/100,n=e[2]/100;let l,c,u;if(0===s)return u=255*n,[u,u,u];l=n<.5?n*(1+s):n+s-n*s;const d=2*n-l,m=[0,0,0];for(let e=0;e<3;e++)c=t+1/3*-(e-1),c<0&&c++,c>1&&c--,u=6*c<1?d+6*(l-d)*c:2*c<1?l:3*c<2?d+(l-d)*(2/3-c)*6:d,m[e]=255*u;return m},x.hsl.hsv=function(e){const t=e[0];let s=e[1]/100,n=e[2]/100,l=s;const c=Math.max(n,.01);n*=2,s*=n<=1?n:2-n,l*=c<=1?c:2-c;return[t,100*(0===n?2*l/(c+l):2*s/(n+s)),100*((n+s)/2)]},x.hsv.rgb=function(e){const t=e[0]/60,s=e[1]/100;let n=e[2]/100;const l=Math.floor(t)%6,c=t-Math.floor(t),u=255*n*(1-s),d=255*n*(1-s*c),m=255*n*(1-s*(1-c));switch(n*=255,l){case 0:return[n,m,u];case 1:return[d,n,u];case 2:return[u,n,m];case 3:return[u,d,n];case 4:return[m,u,n];case 5:return[n,u,d]}},x.hsv.hsl=function(e){const t=e[0],s=e[1]/100,n=e[2]/100,l=Math.max(n,.01);let c,u;u=(2-s)*n;const d=(2-s)*l;return c=s*l,c/=d<=1?d:2-d,c=c||0,u/=2,[t,100*c,100*u]},x.hwb.rgb=function(e){const t=e[0]/360;let s=e[1]/100,n=e[2]/100;const l=s+n;let c;l>1&&(s/=l,n/=l);const u=Math.floor(6*t),d=1-n;c=6*t-u,0!=(1&u)&&(c=1-c);const m=s+c*(d-s);let h,g,y;switch(u){default:case 6:case 0:h=d,g=m,y=s;break;case 1:h=m,g=d,y=s;break;case 2:h=s,g=d,y=m;break;case 3:h=s,g=m,y=d;break;case 4:h=m,g=s,y=d;break;case 5:h=d,g=s,y=m}return[255*h,255*g,255*y]},x.cmyk.rgb=function(e){const t=e[0]/100,s=e[1]/100,n=e[2]/100,l=e[3]/100;return[255*(1-Math.min(1,t*(1-l)+l)),255*(1-Math.min(1,s*(1-l)+l)),255*(1-Math.min(1,n*(1-l)+l))]},x.xyz.rgb=function(e){const t=e[0]/100,s=e[1]/100,n=e[2]/100;let l,c,u;return l=3.2406*t+-1.5372*s+-.4986*n,c=-.9689*t+1.8758*s+.0415*n,u=.0557*t+-.204*s+1.057*n,l=l>.0031308?1.055*l**(1/2.4)-.055:12.92*l,c=c>.0031308?1.055*c**(1/2.4)-.055:12.92*c,u=u>.0031308?1.055*u**(1/2.4)-.055:12.92*u,l=Math.min(Math.max(0,l),1),c=Math.min(Math.max(0,c),1),u=Math.min(Math.max(0,u),1),[255*l,255*c,255*u]},x.xyz.lab=function(e){let t=e[0],s=e[1],n=e[2];t/=95.047,s/=100,n/=108.883,t=t>.008856?t**(1/3):7.787*t+16/116,s=s>.008856?s**(1/3):7.787*s+16/116,n=n>.008856?n**(1/3):7.787*n+16/116;return[116*s-16,500*(t-s),200*(s-n)]},x.lab.xyz=function(e){let t,s,n;s=(e[0]+16)/116,t=e[1]/500+s,n=s-e[2]/200;const l=s**3,c=t**3,u=n**3;return s=l>.008856?l:(s-16/116)/7.787,t=c>.008856?c:(t-16/116)/7.787,n=u>.008856?u:(n-16/116)/7.787,t*=95.047,s*=100,n*=108.883,[t,s,n]},x.lab.lch=function(e){const t=e[0],s=e[1],n=e[2];let l;l=360*Math.atan2(n,s)/2/Math.PI,l<0&&(l+=360);return[t,Math.sqrt(s*s+n*n),l]},x.lch.lab=function(e){const t=e[0],s=e[1],n=e[2]/360*2*Math.PI;return[t,s*Math.cos(n),s*Math.sin(n)]},x.rgb.ansi16=function(e,t=null){const[s,n,l]=e;let c=null===t?x.rgb.hsv(e)[2]:t;if(c=Math.round(c/50),0===c)return 30;let u=30+(Math.round(l/255)<<2|Math.round(n/255)<<1|Math.round(s/255));return 2===c&&(u+=60),u},x.hsv.ansi16=function(e){return x.rgb.ansi16(x.hsv.rgb(e),e[2])},x.rgb.ansi256=function(e){const t=e[0],s=e[1],n=e[2];if(t===s&&s===n)return t<8?16:t>248?231:Math.round((t-8)/247*24)+232;return 16+36*Math.round(t/255*5)+6*Math.round(s/255*5)+Math.round(n/255*5)},x.ansi16.rgb=function(e){let t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),t=t/10.5*255,[t,t,t];const s=.5*(1+~~(e>50));return[(1&t)*s*255,(t>>1&1)*s*255,(t>>2&1)*s*255]},x.ansi256.rgb=function(e){if(e>=232){const t=10*(e-232)+8;return[t,t,t]}let t;return[Math.floor((e-=16)/36)/5*255,Math.floor((t=e%36)/6)/5*255,t%6/5*255]},x.rgb.hex=function(e){const t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},x.hex.rgb=function(e){const t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];let s=t[0];3===t[0].length&&(s=s.split("").map((e=>e+e)).join(""));const n=parseInt(s,16);return[n>>16&255,n>>8&255,255&n]},x.rgb.hcg=function(e){const t=e[0]/255,s=e[1]/255,n=e[2]/255,l=Math.max(Math.max(t,s),n),c=Math.min(Math.min(t,s),n),u=l-c;let d,m;return d=u<1?c/(1-u):0,m=u<=0?0:l===t?(s-n)/u%6:l===s?2+(n-t)/u:4+(t-s)/u,m/=6,m%=1,[360*m,100*u,100*d]},x.hsl.hcg=function(e){const t=e[1]/100,s=e[2]/100,n=s<.5?2*t*s:2*t*(1-s);let l=0;return n<1&&(l=(s-.5*n)/(1-n)),[e[0],100*n,100*l]},x.hsv.hcg=function(e){const t=e[1]/100,s=e[2]/100,n=t*s;let l=0;return n<1&&(l=(s-n)/(1-n)),[e[0],100*n,100*l]},x.hcg.rgb=function(e){const t=e[0]/360,s=e[1]/100,n=e[2]/100;if(0===s)return[255*n,255*n,255*n];const l=[0,0,0],c=t%1*6,u=c%1,d=1-u;let m=0;switch(Math.floor(c)){case 0:l[0]=1,l[1]=u,l[2]=0;break;case 1:l[0]=d,l[1]=1,l[2]=0;break;case 2:l[0]=0,l[1]=1,l[2]=u;break;case 3:l[0]=0,l[1]=d,l[2]=1;break;case 4:l[0]=u,l[1]=0,l[2]=1;break;default:l[0]=1,l[1]=0,l[2]=d}return m=(1-s)*n,[255*(s*l[0]+m),255*(s*l[1]+m),255*(s*l[2]+m)]},x.hcg.hsv=function(e){const t=e[1]/100,s=t+e[2]/100*(1-t);let n=0;return s>0&&(n=t/s),[e[0],100*n,100*s]},x.hcg.hsl=function(e){const t=e[1]/100,s=e[2]/100*(1-t)+.5*t;let n=0;return s>0&&s<.5?n=t/(2*s):s>=.5&&s<1&&(n=t/(2*(1-s))),[e[0],100*n,100*s]},x.hcg.hwb=function(e){const t=e[1]/100,s=t+e[2]/100*(1-t);return[e[0],100*(s-t),100*(1-s)]},x.hwb.hcg=function(e){const t=e[1]/100,s=1-e[2]/100,n=s-t;let l=0;return n<1&&(l=(s-n)/(1-n)),[e[0],100*n,100*l]},x.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},x.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},x.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},x.gray.hsl=function(e){return[0,0,e[0]]},x.gray.hsv=x.gray.hsl,x.gray.hwb=function(e){return[0,100,e[0]]},x.gray.cmyk=function(e){return[0,0,0,e[0]]},x.gray.lab=function(e){return[e[0],0,0]},x.gray.hex=function(e){const t=255&Math.round(e[0]/100*255),s=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(s.length)+s},x.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};const P=I;function deriveBFS(e){const t=function buildGraph(){const e={},t=Object.keys(P);for(let s=t.length,n=0;n<s;n++)e[t[n]]={distance:-1,parent:null};return e}(),s=[e];for(t[e].distance=0;s.length;){const e=s.pop(),n=Object.keys(P[e]);for(let l=n.length,c=0;c<l;c++){const l=n[c],u=t[l];-1===u.distance&&(u.distance=t[e].distance+1,u.parent=e,s.unshift(l))}}return t}function link$1(e,t){return function(s){return t(e(s))}}function wrapConversion(e,t){const s=[t[e].parent,e];let n=P[t[e].parent][e],l=t[e].parent;for(;t[l].parent;)s.unshift(t[l].parent),n=link$1(P[t[l].parent][l],n),l=t[l].parent;return n.conversion=s,n}const E=I,route=function(e){const t=deriveBFS(e),s={},n=Object.keys(t);for(let e=n.length,l=0;l<e;l++){const e=n[l];null!==t[e].parent&&(s[e]=wrapConversion(e,t))}return s},M={};Object.keys(E).forEach((e=>{M[e]={},Object.defineProperty(M[e],"channels",{value:E[e].channels}),Object.defineProperty(M[e],"labels",{value:E[e].labels});const t=route(e);Object.keys(t).forEach((s=>{const n=t[s];M[e][s]=function wrapRounded(e){const wrappedFn=function(...t){const s=t[0];if(null==s)return s;s.length>1&&(t=s);const n=e(t);if("object"==typeof n)for(let e=n.length,t=0;t<e;t++)n[t]=Math.round(n[t]);return n};return"conversion"in e&&(wrappedFn.conversion=e.conversion),wrappedFn}(n),M[e][s].raw=function wrapRaw(e){const wrappedFn=function(...t){const s=t[0];return null==s?s:(s.length>1&&(t=s),e(t))};return"conversion"in e&&(wrappedFn.conversion=e.conversion),wrappedFn}(n)}))}));const O=_,L=M,R=["keyword","gray","hex"],N={};for(const e of Object.keys(L))N[[...L[e].labels].sort().join("")]=e;const j={};function Color(e,t){if(!(this instanceof Color))return new Color(e,t);if(t&&t in R&&(t=null),t&&!(t in L))throw Error("Unknown model: "+t);let s,n;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof Color)this.model=e.model,this.color=[...e.color],this.valpha=e.valpha;else if("string"==typeof e){const t=O.get(e);if(null===t)throw Error("Unable to parse color from string: "+e);this.model=t.model,n=L[this.model].channels,this.color=t.value.slice(0,n),this.valpha="number"==typeof t.value[n]?t.value[n]:1}else if(e.length>0){this.model=t||"rgb",n=L[this.model].channels;const s=Array.prototype.slice.call(e,0,n);this.color=zeroArray(s,n),this.valpha="number"==typeof e[n]?e[n]:1}else if("number"==typeof e)this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;const t=Object.keys(e);"alpha"in e&&(t.splice(t.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);const n=t.sort().join("");if(!(n in N))throw Error("Unable to parse color from object: "+JSON.stringify(e));this.model=N[n];const{labels:l}=L[this.model],c=[];for(s=0;s<l.length;s++)c.push(e[l[s]]);this.color=zeroArray(c)}if(j[this.model])for(n=L[this.model].channels,s=0;s<n;s++){const e=j[this.model][s];e&&(this.color[s]=e(this.color[s]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}Color.prototype={toString(){return this.string()},toJSON(){return this[this.model]()},string(e){let t=this.model in O.to?this:this.rgb();t=t.round("number"==typeof e?e:1);const s=1===t.valpha?t.color:[...t.color,this.valpha];return O.to[t.model](s)},percentString(e){const t=this.rgb().round("number"==typeof e?e:1),s=1===t.valpha?t.color:[...t.color,this.valpha];return O.to.rgb.percent(s)},array(){return 1===this.valpha?[...this.color]:[...this.color,this.valpha]},object(){const e={},{channels:t}=L[this.model],{labels:s}=L[this.model];for(let n=0;n<t;n++)e[s[n]]=this.color[n];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray(){const e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject(){const e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round(e){return e=Math.max(e||0,0),new Color([...this.color.map(roundToPlace(e)),this.valpha],this.model)},alpha(e){return void 0!==e?new Color([...this.color,Math.max(0,Math.min(1,e))],this.model):this.valpha},red:getset("rgb",0,maxfn(255)),green:getset("rgb",1,maxfn(255)),blue:getset("rgb",2,maxfn(255)),hue:getset(["hsl","hsv","hsl","hwb","hcg"],0,(e=>(e%360+360)%360)),saturationl:getset("hsl",1,maxfn(100)),lightness:getset("hsl",2,maxfn(100)),saturationv:getset("hsv",1,maxfn(100)),value:getset("hsv",2,maxfn(100)),chroma:getset("hcg",1,maxfn(100)),gray:getset("hcg",2,maxfn(100)),white:getset("hwb",1,maxfn(100)),wblack:getset("hwb",2,maxfn(100)),cyan:getset("cmyk",0,maxfn(100)),magenta:getset("cmyk",1,maxfn(100)),yellow:getset("cmyk",2,maxfn(100)),black:getset("cmyk",3,maxfn(100)),x:getset("xyz",0,maxfn(95.047)),y:getset("xyz",1,maxfn(100)),z:getset("xyz",2,maxfn(108.833)),l:getset("lab",0,maxfn(100)),a:getset("lab",1),b:getset("lab",2),keyword(e){return void 0!==e?new Color(e):L[this.model].keyword(this.color)},hex(e){return void 0!==e?new Color(e):O.to.hex(this.rgb().round().color)},hexa(e){if(void 0!==e)return new Color(e);const t=this.rgb().round().color;let s=Math.round(255*this.valpha).toString(16).toUpperCase();return 1===s.length&&(s="0"+s),O.to.hex(t)+s},rgbNumber(){const e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity(){const e=this.rgb().color,t=[];for(const[s,n]of e.entries()){const e=n/255;t[s]=e<=.04045?e/12.92:((e+.055)/1.055)**2.4}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast(e){const t=this.luminosity(),s=e.luminosity();return t>s?(t+.05)/(s+.05):(s+.05)/(t+.05)},level(e){const t=this.contrast(e);return t>=7?"AAA":t>=4.5?"AA":""},isDark(){const e=this.rgb().color;return(2126*e[0]+7152*e[1]+722*e[2])/1e4<128},isLight(){return!this.isDark()},negate(){const e=this.rgb();for(let t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten(e){const t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken(e){const t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate(e){const t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate(e){const t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten(e){const t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken(e){const t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale(){const e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return Color.rgb(t,t,t)},fade(e){return this.alpha(this.valpha-this.valpha*e)},opaquer(e){return this.alpha(this.valpha+this.valpha*e)},rotate(e){const t=this.hsl();let s=t.color[0];return s=(s+e)%360,s=s<0?360+s:s,t.color[0]=s,t},mix(e,t){if(!e||!e.rgb)throw Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);const s=e.rgb(),n=this.rgb(),l=void 0===t?.5:t,c=2*l-1,u=s.alpha()-n.alpha(),d=((c*u==-1?c:(c+u)/(1+c*u))+1)/2,m=1-d;return Color.rgb(d*s.red()+m*n.red(),d*s.green()+m*n.green(),d*s.blue()+m*n.blue(),s.alpha()*l+n.alpha()*(1-l))}};for(const e of Object.keys(L)){if(R.includes(e))continue;const{channels:t}=L[e];Color.prototype[e]=function(...t){return this.model===e?new Color(this):t.length>0?new Color(t,e):new Color([...(s=L[this.model][e].raw(this.color),Array.isArray(s)?s:[s]),this.valpha],e);var s},Color[e]=function(...s){let n=s[0];return"number"==typeof n&&(n=zeroArray(s,t)),new Color(n,e)}}function roundToPlace(e){return function(t){return function roundTo(e,t){return Number(e.toFixed(t))}(t,e)}}function getset(e,t,s){e=Array.isArray(e)?e:[e];for(const n of e)(j[n]||(j[n]=[]))[t]=s;return e=e[0],function(n){let l;return void 0!==n?(s&&(n=s(n)),l=this[e](),l.color[t]=n,l):(l=this[e]().color[t],s&&(l=s(l)),l)}}function maxfn(e){return function(t){return Math.max(0,Math.min(e,t))}}function zeroArray(e,t){for(let s=0;s<t;s++)"number"!=typeof e[s]&&(e[s]=0);return e}const z=getDefaultExportFromCjs(Color),createCustomChatMessage=async function(e,t={},s={},{rolls:n=[]}={}){if(s.user??=game.user.id,s.type??=CONST.CHAT_MESSAGE_TYPES.CHAT,s.content=await renderTemplate(e,t),s.rollMode??=game.settings.get("core","rollMode"),ChatMessage.implementation.applyRollMode(s,s.rollMode),null!=s.roll&&0===n.length&&(n=[s.roll]),null!=game.dice3d&&game.dice3d.isEnabled())for(const e of n)await game.dice3d.showForRoll(e,game.user,!1,s.whisper,s.blind),s.sound=null;return ChatMessage.implementation.create(s)},hideRollInfo=function(e,t,s){const n=e.whisper||[],l=n.length&&e.blind;!n.length||(n.includes(game.user.id)||e.isAuthor&&!l)||(t.find(".dice-formula").text("???"),t.find(".dice-total").text("?"),t.find(".dice").text(""),t.find(".success").removeClass("success"),t.find(".failure").removeClass("failure"))},hideGMSensitiveInfo=function(e,t,s){if(game.user.isGM){const s=e.flags.ffd20?.identifiedInfo??{},{identified:n=!0}=s;if(!n&&e.hasItemSource){t.find(".card-content").append((e=>{const t=e.actionName&&!e.actionDescription;return _templateCache["systems/ffd20/templates/chat/parts/gm-description.hbs"]?.({...e,hasCombinedName:t},{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0})??""})(s))}return}t.find(".gm-sensitive-always").remove(),t.find("[data-gm-sensitive-uuid]").each(((e,t)=>{(t=$(t)).hide();const s=t.data("gm-sensitive-uuid");s&&fromUuid(s).then((e=>{(e instanceof Token||e instanceof TokenDocument)&&(e=e.actor),e?.testUserPermission&&e.testUserPermission(game.user,"OBSERVER")?t.show():t.remove()}))}));const n=e.speaker;let l=null;null!=n&&(n.token&&(l=game.actors.tokens[n.token]),l||(l=game.actors.get(n.actor))),!l||l&&l.testUserPermission(game.user,"OBSERVER")||(t.find(".gm-sensitive").remove(),t.find("[data-gm-sensitive-inner]").each(((e,t)=>{(game.settings.get("ffd20","obscureSaveDCs")||"save"!==t.dataset.action)&&((t=$(t)).text(t.data("gm-sensitive-inner")),t.removeData("gm-sensitive-inner"))})),game.settings.get("ffd20","obscureInlineRolls")&&t.find(".inline-roll").each(((e,t)=>{if(!t.dataset.roll)return;const s=Roll.fromJSON(unescape(t.dataset.roll)),n=t.parentNode;n.insertBefore($(`<span>${s.total}</span>`)[0],t),n.removeChild(t)})))},alterAmmoRecovery=function(e,t){const s=e.getFlag("ffd20","ammoRecovery");s&&t.find(".chat-attack .ammo[data-ammo-id]").each(((e,t)=>{const n=t.closest(".chat-attack").dataset.index,l=t.dataset.ammoId,c=s[n]?.[l];c&&$(t).find(".inline-action").each(((e,t)=>{c.recovered&&t.classList.add("recovered"),c.failed&&t.classList.add("recovery-failed")}))}))},alterTargetDefense=function(e,t){const s=e.getFlag("ffd20","targetDefense");s&&t.find(".attack-targets .saving-throws div[data-saving-throw]").each(((e,t)=>{const n=t.closest(".target").dataset.uuid,l=t.dataset.savingThrow,c=getProperty(s,`${n}.save.${l}`);null!=c&&$(t).find(".value").text(c.toString())}))},applyAccessibilitySettings=function(e,t,s,n){},createInlineRollString=(e,{hide3d:t=!0}={})=>`<a class="inline-roll inline-result ${t?"inline-dsn-hidden":""}"   data-tooltip="${e.formula}" data-roll="${escape(JSON.stringify(e))}">   <i class="fas fa-dice-d20"></i> ${e.total}</a>`,hideInvisibleTargets=async function(e,t){const s=t.find(".attack-targets .target").toArray().reduce(((e,t)=>(e.push({uuid:t.dataset.uuid,elem:t}),e)),[]);for(const e of s){const t=$(e.elem),s=await fromUuid(e.uuid);s&&(e.token=s.object,e.token?.visible?t.show():t.hide())}},addTargetCallbacks=function(e,t){const s=t.find(".attack-targets .target[data-uuid]"),_getTokenByElem=async function(e){return(await fromUuid(e?.dataset.uuid??""))?.object},_getRootTargetElement=function(e){return null!=e.dataset.uuid?e:e.closest("[data-uuid]")},_mouseEnterCallback=function(e){_getTokenByElem(_getRootTargetElement(e.currentTarget)).then((t=>{t?._onHoverIn(e,{hoverOutOthers:!1})}))},_mouseLeaveCallback=function(e){_getTokenByElem(_getRootTargetElement(e.currentTarget)).then((t=>{t?._onHoverOut(e)}))},_imageClickCallback=function(e){e.preventDefault(),_getTokenByElem(_getRootTargetElement(e.currentTarget)).then((t=>{t?.actor.testUserPermission(game.user,"OWNER")&&(t._controlled?e.shiftKey&&t.release():t.control({releaseOthers:!e.shiftKey}))}))};for(let n of s){n=$(n);const s=n.find(".target-image");s.on("mouseenter",_mouseEnterCallback),s.on("mouseleave",_mouseLeaveCallback),s.on("click",_imageClickCallback),n.find(".ac").on("click",(s=>{s.preventDefault(),_getTokenByElem(_getRootTargetElement(s.currentTarget)).then((n=>{n?.actor&&ffd20.utils.chat.targetACClick(e,t,n.actor,s)}))})),n.find(".saving-throws .click").on("click",(s=>{s.preventDefault(),_getTokenByElem(_getRootTargetElement(s.currentTarget)).then((n=>{n?.actor&&ffd20.utils.chat.targetSavingThrowClick(e,t,n.actor,s)}))}))}},B=Object.freeze(Object.defineProperty({__proto__:null,addTargetCallbacks,alterAmmoRecovery,alterTargetDefense,applyAccessibilitySettings,createCustomChatMessage,createInlineRollString,hideGMSensitiveInfo,hideInvisibleTargets,hideRollInfo,targetACClick:async function(e,t,s,n){s.displayDefenseCard({rollMode:"selfroll"})},targetSavingThrowClick:async function(e,t,s,n){const l=n.currentTarget,c=l.dataset.savingThrow,u=await s.rollSavingThrow(c,{event:n}),d=u?.rolls?.[0]?.total;if(null!=d){const t=l.closest(".target").dataset.uuid;await e.setFlag("ffd20","targetDefense",{[t]:{save:{[c]:d}}})}}},Symbol.toStringTag,{value:"Module"})),formulaHasDice=function(e){return e.match(/[0-9)][dD]/)||e.match(/[dD][0-9(]/)};function applyChanges(){this.changeOverrides={};const e=Array.from(this.changes),t=getSortChangePriority.call(this),_sortChanges=function(e,s){const n=t.types.indexOf(e.subTarget),l=t.types.indexOf(s.subTarget),c=t.modifiers.indexOf(e.modifier),u=t.modifiers.indexOf(s.modifier);let d="string"==typeof e.priority?parseInt(e.priority):e.priority,m="string"==typeof s.priority?parseInt(s.priority):s.priority;return d=(d||0)+1e3,m=(m||0)+1e3,m-d||n-l||c-u};e.sort(((e,t)=>_sortChanges(e,t)));for(const e of this.changeItems)for(const[t,s]of Object.entries(e.system.changeFlags))if(!0===s&&(this.changeFlags[t]=!0,"loseDexToAC"===t)){for(const t of["normal","touch"])getSourceInfo(this.sourceInfo,`system.attributes.ac.${t}.total`).negative.push({value:game.i18n.localize("FFD20.ChangeFlagLoseDexToAC"),name:e.name,type:e.type});getSourceInfo(this.sourceInfo,"system.attributes.cmd.total").negative.push({value:game.i18n.localize("FFD20.ChangeFlagLoseDexToAC"),name:e.name,type:e.type})}this.refreshDerivedData();const s=e.filter((e=>!0===e.continuous));for(let t=0;t<e.length;t++){const n=e[t],l=getChangeFlat.call(this,n.subTarget,n.modifier,n.value);for(const e of l)this.changeOverrides[e]||(this.changeOverrides[e]=createOverride());n._safeApplyChange(this,l,{applySourceInfo:!1});for(const e of s){if(e===n)continue;const t=getChangeFlat.call(this,e.subTarget,e.modifier,e.value);for(const e of t)this.changeOverrides[e]||(this.changeOverrides[e]=createOverride());e._safeApplyChange(this,t,{applySourceInfo:!1})}this.refreshDerivedData()}for(const t of e)t.applySourceInfo(this);resetSkills.call(this)}const createOverride=function(){const e={add:{},set:{}};for(const t of Object.keys(ffd20.config.bonusModifiers))e.add[t]=null,e.set[t]=null;return e},getSortChangePriority=function(){return{types:[...this._skillTargets.map(((e,t)=>[e,{sort:76e3+10*t}])),...Object.entries(ffd20.config.buffTargets)].sort((([,{sort:e}],[,{sort:t}])=>e-t)).map((([e])=>e)),modifiers:["untyped","untypedPerm","base","enh","dodge","haste","inherent","deflection","morale","luck","sacred","insight","resist","profane","trait","racial","size","competence","circumstance","alchemical","penalty"]}},getChangeFlat=function(e,t,s){if(null==e)return[];const n=this.system,l=[];switch(e){case"mhp":l.push("system.attributes.hp.max");break;case"wounds":l.push("system.attributes.wounds.max");break;case"vigor":l.push("system.attributes.vigor.max");break;case"mmp":l.push("system.attributes.mp.max");break;case"str":case"dex":case"con":case"int":case"wis":case"cha":if("penalty"===t){l.push(`system.abilities.${e}.penalty`);break}if(["base","untypedPerm"].includes(t)){l.push(`system.abilities.${e}.total`,`system.abilities.${e}.base`);break}l.push(`system.abilities.${e}.total`);break;case"strMod":case"dexMod":case"conMod":case"intMod":case"wisMod":case"chaMod":l.push(`system.abilities.${e.slice(0,3)}.mod`);break;case"carryStr":l.push("system.details.carryCapacity.bonus.total");break;case"carryMult":l.push("system.details.carryCapacity.multiplier.total");break;case"ac":switch(l.push("system.attributes.ac.normal.total","system.attributes.ac.touch.total"),t){case"dodge":case"haste":l.push("system.attributes.cmd.total");break;case"deflection":case"circumstance":case"insight":case"luck":case"morale":case"profane":case"sacred":case"penalty":l.push("system.attributes.ac.flatFooted.total","system.attributes.cmd.total","system.attributes.cmd.flatFootedTotal");break;default:l.push("system.attributes.ac.flatFooted.total"),s<0&&l.push("system.attributes.cmd.total","system.attributes.cmd.flatFootedTotal")}break;case"aac":{const e=["system.ac.normal.total"];switch(t){case"base":e.push("system.ac.normal.base");break;case"enh":e.push("system.ac.normal.enh");break;default:e.push("system.ac.normal.misc")}l.push(...e);break}case"sac":{const e=["system.ac.shield.total"];switch(t){case"base":e.push("system.ac.shield.base");break;case"enh":e.push("system.ac.shield.enh");break;default:e.push("system.ac.shield.misc")}l.push(...e);break}case"nac":{const e=["system.ac.natural.total"];switch(t){case"base":e.push("system.ac.natural.base");break;case"enh":e.push("system.ac.natural.enh");break;default:e.push("system.ac.natural.misc")}l.push(...e);break}case"tac":l.push("system.attributes.ac.touch.total");break;case"ffac":l.push("system.attributes.ac.flatFooted.total");break;case"ffcmd":l.push("system.attributes.cmd.flatFootedTotal");break;case"bab":l.push("system.attributes.bab.total");break;case"~attackCore":l.push("system.attributes.attack.shared");break;case"attack":l.push("system.attributes.attack.general");break;case"mattack":l.push("system.attributes.attack.melee");break;case"rattack":l.push("system.attributes.attack.ranged");break;case"critConfirm":l.push("system.attributes.attack.critConfirm");break;case"allSavingThrows":l.push("system.attributes.savingThrows.fort.total","system.attributes.savingThrows.ref.total","system.attributes.savingThrows.will.total");break;case"fort":l.push("system.attributes.savingThrows.fort.total");break;case"ref":l.push("system.attributes.savingThrows.ref.total");break;case"will":l.push("system.attributes.savingThrows.will.total");break;case"skills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&(l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const s of Object.keys(t.subSkills))l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"~skillMods":for(const[e,t]of Object.entries(n.skills))if(null!=t&&(l.push(`system.skills.${e}.mod`),null!=t.subSkills))for(const s of Object.keys(t.subSkills))l.push(`system.skills.${e}.subSkills.${s}.mod`);break;case"unskills":for(const[e,t]of Object.entries(n.skills))if(null!=t){for(const[s,n]of Object.entries(t.subSkills??{}))n.rank>0||l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);t.rank>0||l.push(`system.skills.${e}.changeBonus`)}break;case"strSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("str"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"str"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"dexSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("dex"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"dex"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"conSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("con"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"con"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"intSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("int"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"int"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"wisSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("wis"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"wis"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"chaSkills":for(const[e,t]of Object.entries(n.skills))if(null!=t&&("cha"===t.ability&&l.push(`system.skills.${e}.changeBonus`),null!=t.subSkills))for(const[s,n]of Object.entries(t.subSkills))null!=n&&"cha"===n.ability&&l.push(`system.skills.${e}.subSkills.${s}.changeBonus`);break;case"allChecks":l.push("system.abilities.str.checkMod","system.abilities.dex.checkMod","system.abilities.con.checkMod","system.abilities.int.checkMod","system.abilities.wis.checkMod","system.abilities.cha.checkMod",...this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"strChecks":l.push("system.abilities.str.checkMod",..."str"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"dexChecks":l.push("system.abilities.dex.checkMod",..."dex"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"conChecks":l.push("system.abilities.con.checkMod",..."con"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"intChecks":l.push("system.abilities.int.checkMod",..."int"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"wisChecks":l.push("system.abilities.wis.checkMod",..."wis"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"chaChecks":l.push("system.abilities.cha.checkMod",..."cha"===this.system.attributes.init.ability?["system.attributes.init.total"]:[]);break;case"allSpeeds":for(const e of Object.keys(n.attributes.speed)){const t=n.attributes.speed[e]?.base;void 0!==t&&l.push(`system.attributes.speed.${e}.total`)}break;case"landSpeed":if("base"===t)return["system.attributes.speed.land.total"];l.push("system.attributes.speed.land.add","system.attributes.speed.land.total");break;case"climbSpeed":if("base"===t){l.push("system.attributes.speed.climb.total");break}l.push("system.attributes.speed.climb.add","system.attributes.speed.climb.total");break;case"swimSpeed":if("base"===t){l.push("system.attributes.speed.swim.total");break}l.push("system.attributes.speed.swim.add","system.attributes.speed.swim.total");break;case"burrowSpeed":if("base"===t){l.push("system.attributes.speed.burrow.total");break}l.push("system.attributes.speed.burrow.add","system.attributes.speed.burrow.total");break;case"flySpeed":if("base"===t){l.push("system.attributes.speed.fly.total");break}l.push("system.attributes.speed.fly.add","system.attributes.speed.fly.total");break;case"cmb":l.push("system.attributes.cmb.bonus");break;case"cmd":if(["dodge","haste"].includes(t)){l.push("system.attributes.cmd.total");break}l.push("system.attributes.cmd.total","system.attributes.cmd.flatFootedTotal");break;case"init":l.push("system.attributes.init.total");break;case"acpA":l.push("system.attributes.acp.armorBonus");break;case"acpS":l.push("system.attributes.acp.shieldBonus");break;case"mDexA":l.push("system.attributes.mDex.armorBonus");break;case"mDexS":l.push("system.attributes.mDex.shieldBonus");break;case"spellResist":l.push("system.attributes.sr.total");break;case"damage":l.push("system.attributes.damage.general");break;case"wdamage":l.push("system.attributes.damage.weapon");break;case"sdamage":l.push("system.attributes.damage.spell");break;case"bonusFeats":l.push("system.details.feats.bonus");break;case"bonusSkillRanks":l.push("system.details.skills.bonus");break;case"concentration":l.push("system.attributes.spells.spellbooks.primary.concentration.total","system.attributes.spells.spellbooks.secondary.concentration.total","system.attributes.spells.spellbooks.tertiary.concentration.total","system.attributes.spells.spellbooks.quaternary.concentration.total","system.attributes.spells.spellbooks.spelllike.concentration.total");break;case"cl":l.push("system.attributes.spells.spellbooks.primary.cl.total","system.attributes.spells.spellbooks.secondary.cl.total","system.attributes.spells.spellbooks.tertiary.cl.total","system.attributes.spells.spellbooks.quaternary.cl.total","system.attributes.spells.spellbooks.spelllike.cl.total")}if(e.match(/^skill\.([a-zA-Z0-9]+)$/)){const e=RegExp.$1,t=n.skills[e];if(null!=t){l.push(`system.skills.${e}.changeBonus`);for(const s of Object.keys(t.subSkills??{}))l.push(`system.skills.${e}.subSkills.${s}.changeBonus`)}}else if(e.match(/^skill\.([a-zA-Z0-9]+)\.subSkills\.([a-zA-Z0-9_]+)$/)){const e=RegExp.$1,t=RegExp.$2;null!=n.skills[e]?.subSkills?.[t]&&l.push(`system.skills.${e}.subSkills.${t}.changeBonus`)}return Hooks.callAll("pf1GetChangeFlat",l,e,t,s,this),l},getBabTotal=function(e){return e.attributes.bab.total},getNegativeEnergyDrain=function(e){return-e.attributes.energyDrain},getAbilityMod=function(e){return function(t){return t.abilities[e]?.mod??0}},addDefaultChanges=function(e){const t=this.system,s=[];Hooks.callAll("pf1AddDefaultChanges",this,s),e.push(...s.filter((e=>e instanceof ffd20.components.ItemChange)));const n=this.items.filter((e=>"class"===e.type)).sort(((e,t)=>e.sort-t.sort)),[l,c]=n.reduce(((e,t)=>("racial"===t.subType?e[1].push(t):e[0].push(t),e)),[[],[]]),u=game.settings.get("ffd20","healthConfig"),d="character"===this.type?u.hitdice.PC:u.hitdice.NPC,m=u.hitdice.Racial,h={up:Math.ceil,nearest:Math.round,down:Math.floor}[u.rounding],g={discrete:!1,continuous:!0}[u.continuity],pushHealth=(t,s)=>{e.push(new ffd20.components.ItemChange({formula:t,target:"misc",subTarget:"mhp",modifier:"untypedPerm",flavor:s.name})),e.push(new ffd20.components.ItemChange({formula:t,target:"misc",subTarget:"vigor",modifier:"untypedPerm",flavor:s.name}))},autoHealth=(e,t,s=0)=>{const n=e.system.hd??0;if(0===n)return;let l=0;if("mythic"===e.subType){const t=n??0;if(0===t)return;const s=e.system.level??0;if(0===s)return;l=t*s}else{let c=1+(n-1)*t.rate;g||(c=h(c));const u=e.hitDice;l=Math.min(u,s)*n+Math.max(0,u-s)*c+("base"===e.system.subType)*e.system.fc.hp.value}pushHealth(l,e)},computeHealth=(e,t)=>{if(t.auto){let s=t.maximized;for(const n of e){autoHealth(n,t,s);const e=n.hitDice;s=Math.max(0,s-e)}}else e.forEach((e=>(e=>{let t=e.system.hp+("base"===e.system.subType)*e.system.fc.hp.value;g||(t=h(t)),pushHealth(t,e)})(e)))};computeHealth(c,m),computeHealth(l,d);const pushMana=(t,s)=>{e.push(new ffd20.components.ItemChange({formula:t,target:"misc",subTarget:"mmp",modifier:"untypedPerm",flavor:s.name}))},computeMana=e=>{e.forEach((e=>{"no"==e.system.classBaseMPauto||null==e.system.classBaseMPauto?(e=>{const t=null===e.system.mp?0:e.system.mp;pushMana(t,e)})(e):(e=>{if("noncaster"===e.system.classBaseMPTypes)return;if(0===e.system.level)return;if("halfCaster"===e.system.classBaseMPTypes&&e.system.level<4)return;let t=1;"half"===e.system.classBaseMPauto&&(t=.5);const s=ffd20.config.classMPlevels[e.system.classBaseMPTypes],n=Math.floor(s[e.system.level-1]*t);pushMana(n,e)})(e)}))};computeMana(c),computeMana(l);const y=!0===game.settings.get("ffd20","useFractionalBaseBonuses");for(const s of Object.keys(t.attributes.savingThrows)){let l=!1;t.attributes.savingThrows[s].total=t.attributes.savingThrows[s]?.base??0;const c=n.reduce(((t,n)=>{const c=n.system.savingThrows[s].base;return y?!0===n.system.savingThrows[s].good&&(l=!0):e.push(new ffd20.components.ItemChange({formula:c,target:"savingThrows",subTarget:s,modifier:"untypedPerm",flavor:n.name})),t+c}),0);if(y&&e.push(new ffd20.components.ItemChange({formula:Math.floor(c),target:"savingThrows",subTarget:s,modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.Base")})),y&&l){const t=ffd20.config.classFractionalSavingThrowFormulas.goodSaveBonus,n=RollPF.safeRoll(t).total;e.push(new ffd20.components.ItemChange({formula:n,target:"savingThrows",subTarget:s,modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.SavingThrowGoodFractionalBonus")}))}}const b=t.attributes.hpAbility;b&&(e.push(new ffd20.components.ItemChange({formula:e=>e.abilities[b].mod*e.attributes.hd.total,operator:"function",target:"misc",subTarget:"mhp",modifier:"base",flavor:ffd20.config.abilities[b]})),this.system.attributes.wounds?.base||e.push(new ffd20.components.ItemChange({formula:e=>2*e.abilities[b].total+e.abilities[b].drain,operator:"function",target:"misc",subTarget:"wounds",modifier:"base",flavor:ffd20.config.abilities[b]}))),l.forEach((s=>{let n=s.system.classCastingStat;if(null==n&&(n="noncaster"),"noncaster"===n)return;if("noncaster"===s.system.classBaseMPTypes)return;if(0===s.system.level)return;if("halfCaster"===s.system.classBaseMPTypes&&s.system.level<4)return;const l=ffd20.config.ClassSpellLvlProgression[s.system.classBaseMPTypes],c=Math.floor(RollPF.safeRoll(l,{level:s.system.level}).total),u=ffd20.config.classMPStatsBonus[c];if(""!==n){const s=Math.max(u[t.abilities.int.mod],0),l=Math.max(u[t.abilities.wis.mod],0),c=Math.max(u[t.abilities.cha.mod],0);"intAndWis"!==n&&"int"!==n||e.push(new ffd20.components.ItemChange({formula:s,target:"misc",subTarget:"mmp",modifier:"base",flavor:"Bonus Mp from Intelligence"})),"intAndWis"!==n&&"wis"!==n||e.push(new ffd20.components.ItemChange({formula:l,target:"misc",subTarget:"mmp",modifier:"base",flavor:"Bonus Mp from Wisdom"})),"cha"===n&&e.push(new ffd20.components.ItemChange({formula:c,target:"misc",subTarget:"mmp",modifier:"base",flavor:"Bonus Mp from Charisma"}))}}));for(const[s,n]of Object.entries(t.attributes.speed)){let t=n.base;t||(t=0),e.push(new ffd20.components.ItemChange({formula:t,target:"speed",subTarget:s+"Speed",modifier:"base",operator:"set",priority:1001,flavor:game.i18n.localize("FFD20.Base")}))}e.push(new ffd20.components.ItemChange({formula:getBabTotal,operator:"function",target:"attack",subTarget:"~attackCore",modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.BAB")})),e.push(new ffd20.components.ItemChange({formula:getNegativeEnergyDrain,operator:"function",target:"attack",subTarget:"~attackCore",modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")})),e.push(new ffd20.components.ItemChange({formula:e=>-e.attributes.acp.attackPenalty,operator:"function",target:"attack",subTarget:"~attackCore",modifier:"penalty",flavor:game.i18n.localize("FFD20.ArmorCheckPenalty")}));{e.push(new ffd20.components.ItemChange({formula:getBabTotal,operator:"function",target:"misc",subTarget:"cmd",modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.BAB")}));const s=t.attributes.cmd.strAbility;s in ffd20.config.abilities&&e.push(new ffd20.components.ItemChange({formula:`@abilities.${s}.mod`,target:"misc",subTarget:"cmd",modifier:"untypedPerm",flavor:ffd20.config.abilities[s]})),e.push(new ffd20.components.ItemChange({formula:getNegativeEnergyDrain,operator:"function",target:"misc",subTarget:"cmd",modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")}))}{const s=t.attributes.init.ability;s&&e.push(new ffd20.components.ItemChange({formula:getAbilityMod(s),operator:"function",target:"misc",subTarget:"init",modifier:"untypedPerm",priority:-100,flavor:ffd20.config.abilities[s]})),["str","dex"].includes(s)&&e.push(new ffd20.components.ItemChange({formula:e=>-e.attributes.acp.attackPenalty,operator:"function",target:"misc",subTarget:"init",modifier:"penalty",priority:-100,flavor:game.i18n.localize("FFD20.ArmorCheckPenalty")}))}{let s=t.attributes.savingThrows.fort.ability;s&&e.push(new ffd20.components.ItemChange({formula:getAbilityMod(s),operator:"function",target:"savingThrows",subTarget:"fort",modifier:"untypedPerm",flavor:ffd20.config.abilities[s]})),s=t.attributes.savingThrows.ref.ability,s&&e.push(new ffd20.components.ItemChange({formula:getAbilityMod(s),operator:"function",target:"savingThrows",subTarget:"ref",modifier:"untypedPerm",flavor:ffd20.config.abilities[s]})),s=t.attributes.savingThrows.will.ability,s&&e.push(new ffd20.components.ItemChange({formula:getAbilityMod(s),operator:"function",target:"savingThrows",subTarget:"will",modifier:"untypedPerm",flavor:ffd20.config.abilities[s]})),e.push(new ffd20.components.ItemChange({formula:getNegativeEnergyDrain,operator:"function",target:"savingThrows",subTarget:"allSavingThrows",modifier:"penalty",flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")}))}{const s=t.attributes.sr.formula||0;e.push(new ffd20.components.ItemChange({formula:s,target:"misc",subTarget:"spellResist",modifier:"base",priority:1e3,flavor:game.i18n.localize("FFD20.Base")}))}{const s=t.details.carryCapacity.bonus.user||0;e.push(new ffd20.components.ItemChange({formula:s,target:"misc",subTarget:"carryStr",modifier:"untyped",priority:1e3,flavor:game.i18n.localize("FFD20.Custom")}));const n=t.details.carryCapacity.multiplier.base??1;e.push(new ffd20.components.ItemChange({formula:n,target:"misc",subTarget:"carryMult",modifier:"base",priority:1e3,flavor:game.i18n.localize("FFD20.Base")}));const l=t.details.carryCapacity.multiplier.user||0;e.push(new ffd20.components.ItemChange({formula:l,target:"misc",subTarget:"carryMult",modifier:"untyped",priority:1e3,flavor:game.i18n.localize("FFD20.Custom")}))}{const s=t.attributes.naturalAC||0;e.push(new ffd20.components.ItemChange({formula:s,subTarget:"nac",modifier:"base",flavor:game.i18n.localize("FFD20.EquipTypeNatural")}))}this.items.filter((e=>"equipment"===e.type&&e.system.equipped)).forEach((t=>{let s="aac";if("shield"===t.system.subType&&(s="sac"),t.system.armor.value||t.system.armor.enh){const n=t.system.broken?Math.floor(t.system.armor.value/2):t.system.armor.value,l=t.system.armor.enh;e.push(new ffd20.components.ItemChange({formula:n,subTarget:s,modifier:"base"},t)),e.push(new ffd20.components.ItemChange({formula:l,subTarget:s,modifier:"enhancement"},t))}}));{const s=t.attributes.speed.fly.maneuverability;let n=0;null!=s&&(n=ffd20.config.flyManeuverabilityValues[s]),0!==n&&e.push(new ffd20.components.ItemChange({formula:n,target:"skill",subTarget:"skill.fly",modifier:"racial",flavor:game.i18n.localize("FFD20.FlyManeuverability")}))}e.push(new ffd20.components.ItemChange({formula:e=>e.attributes.speed.climb.total>0?8:0,operator:"function",target:"skill",subTarget:"skill.clm",modifier:"racial",priority:-1,flavor:game.i18n.localize("FFD20.SpeedClimb")})),e.push(new ffd20.components.ItemChange({formula:e=>e.attributes.speed.swim.total>0?8:0,operator:"function",target:"skill",subTarget:"skill.swm",modifier:"racial",priority:-1,flavor:game.i18n.localize("FFD20.SpeedSwim")})),e.push(new ffd20.components.ItemChange({formula:getNegativeEnergyDrain,operator:"function",target:"skills",subTarget:"skills",modifier:"untypedPerm",flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")}));const F=t.traits.size;"med"!==F&&(e.push(new ffd20.components.ItemChange({formula:ffd20.config.sizeMods[F],target:"ac",subTarget:"ac",modifier:"size",flavor:game.i18n.localize("FFD20.BonusModifierSize")})),e.push(new ffd20.components.ItemChange({formula:ffd20.config.sizeStealthMods[F],target:"skill",subTarget:"skill.ste",modifier:"size",flavor:game.i18n.localize("FFD20.BonusModifierSize")})),e.push(new ffd20.components.ItemChange({formula:ffd20.config.sizeFlyMods[F],target:"skill",subTarget:"skill.fly",modifier:"size",flavor:game.i18n.localize("FFD20.BonusModifierSize")})),e.push(new ffd20.components.ItemChange({formula:ffd20.config.sizeSpecialMods[F],target:"misc",subTarget:"cmd",modifier:"size",flavor:game.i18n.localize("FFD20.BonusModifierSize")})));for(const[s,n]of Object.entries(t.attributes.conditions||{})){if(!n)continue;const t=ffd20.config.conditionMechanics[s];if(t){for(const n of t.changes??[]){const t=deepClone(n);t.flavor=ffd20.config.conditions[s];const l=new ffd20.components.ItemChange(t);e.push(l)}for(const e of t.flags??[])this.changeFlags[e]=!0}}!Number.isNaN(t.attributes.energyDrain)&&t.attributes.energyDrain>0&&(e.push(new ffd20.components.ItemChange({formula:e=>5*-e.attributes.energyDrain,operator:"function",subTarget:"mhp",modifier:"untyped",priority:-750,flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")})),e.push(new ffd20.components.ItemChange({formula:e=>5*-e.attributes.energyDrain,operator:"function",subTarget:"vigor",modifier:"untyped",priority:-750,flavor:game.i18n.localize("FFD20.CondTypeEnergyDrain")})))},resetSkills=function(){const e=this.system,t=e.skills,resetSkill=t=>{const s=t.acp?e.attributes.acp.total:0,n=e.abilities[t.ability]?.mod||0,l=t.changeBonus||0;t.mod=t.rank+(t.cs&&t.rank>0?ffd20.config.classSkillBonus:0)+n+l-s};for(const[e,s]of Object.entries(t))if(s){resetSkill(s);for(const[t,n]of Object.entries(s.subSkills||{}))n?resetSkill(n):console.warn(`Bad subskill data for "${e}.${t}"`,this)}else console.warn(`Bad skill data for "${e}"`,this)},getSourceInfo=function(e,t){return e[t]||(e[t]={negative:[],positive:[]}),e[t]},setSourceInfoByName=function(e,t,s,n,l=!0){const c=l?"positive":"negative",u=getSourceInfo(e,t)[c],d=u.find((e=>e.name===s));d?d.value=n:u.push({name:s,value:n})},getHighestChanges=function(e,t={ignoreTarget:!1}){const s={value:0,ids:[],highestID:null},n=Object.keys(ffd20.config.bonusModifiers).reduce(((e,n)=>(t.ignoreTarget?e[n]=duplicate(s):e[n]={},e)),{});for(const s of e){let e;e=t.ignoreTarget?n[s.modifier]:n[s.modifier]?.[s.subTarget],e&&(e.ids.push(s._id),(e.value<s.value||!e.highestID)&&(e.value=s.value,e.highestID=s._id))}{let s,l;const filterFunc=function(e){return l.highestID===e._id||(-1!==ffd20.config.stackingBonusModifiers.indexOf(s)||!l.ids.includes(e._id))};for(s of Object.keys(n))if(t.ignoreTarget)l=n[s],e=e.filter(filterFunc);else for(const t of Object.keys(n[s]))l=n[s][t],e=e.filter(filterFunc)}return e},q=Object.freeze(Object.defineProperty({__proto__:null,addDefaultChanges,applyChanges,getChangeFlat,getHighestChanges,getSourceInfo,setSourceInfoByName},Symbol.toStringTag,{value:"Module"}));class ItemChange{constructor(e,t){this.data=mergeObject(this.constructor.defaultData,e),this.parent=t,this.updateTime=new Date}static async create(e,t){const{parent:s}=t;if(s instanceof ffd20.documents.item.ItemPF){e=e.map((e=>mergeObject(this.defaultData,e)));const t=deepClone(s.system.changes??[]);return t.push(...e),await s.update({"system.changes":t}),e.map((e=>s.changes.get(e._id)))}return[]}static get defaultData(){return{_id:randomID(8),formula:"",operator:"add",subTarget:"",modifier:"",priority:0,value:0,flavor:void 0}}get id(){return this.data._id}get _id(){return this.data._id}get formula(){return this.data.formula}get operator(){return this.data.operator}get subTarget(){return this.data.subTarget}get modifier(){return this.data.modifier}get priority(){return this.data.priority}get value(){return this.data.value}get flavor(){return this.data.flavor??this.parent?.name.replace(/\[|\]/g,"")??this.modifier}get continuous(){return this.data.continuous}get isDeferred(){return!!["damage","wdamage","sdamage","skills"].includes(this.subTarget)||/^skill\./.test(this.subTarget)}get source(){return this.data.source}getSourceInfoTargets(e){switch(this.subTarget){case"aac":case"sac":case"nac":return["system.attributes.ac.normal.total","system.attributes.ac.flatFooted.total"]}return getChangeFlat.call(e,this.subTarget,this.modifier)}prepareData(){}preUpdate(e){if(e.target){const t=e.subTarget||this.subTarget,s=this.parent.getChangeSubTargets(e.target);null==s[t]&&(e.subTarget=Object.keys(s)[0])}return e}async update(e,t={}){if(this.updateTime=new Date,null!=this.parent){e=this.preUpdate(e);const s=this.parent.system.changes.find((e=>e._id===this._id)),n=this.parent.system.changes.indexOf(s);if(n>=0)return e=Object.entries(e).reduce(((e,t)=>(e[`system.changes.${n}.${t[0]}`]=t[1],e)),{}),this.parent.update(e,t)}}_safeApplyChange(e,t=null,{applySourceInfo:s=!0}={}){try{this.applyChange(e,t,{applySourceInfo:s})}catch(s){if(this.parent?.isOwner||e.isOwner){const n=this.parent?`from ${this.parent.name} [${this.parent.uuid}] to ${e.name}`:`to ${e.name} [${e.uuid}]]`,l=`Failed to apply ItemChange ${this.id} ${n}`,c={change:this,parent:this.parent,actor:e,targets:t};Hooks.onError("ItemChange#applyChange",s,{msg:l,log:"error",data:c}),ui.notifications?.error(s.message,{console:!1})}}}applyChange(e,t=null,{applySourceInfo:s=!0}={}){t??=getChangeFlat.call(e,this.subTarget,this.modifier),"script"===this.operator&&(ui.notifications?.warn(game.i18n.format("SETTINGS.pf1AllowScriptChangesF",{parent:this.parent?.name}),{console:!1}),console.warn(game.i18n.format("SETTINGS.pf1AllowScriptChangesF",{parent:this.parent?.uuid||this.parent?.name}),{change:this,item:this.parent,actor:this.parent?.actor}));const n=this.parent?this.parent.getRollData({refresh:!0}):e.getRollData({refresh:!0}),l=e.changeOverrides;for(const c of t){const t=l[c];let u=this.operator;if("+"===u&&(u="add"),"="===u&&(u="set"),!t)continue;const d=null!=c?c.match(/^system\.abilities\.([a-zA-Z0-9]+)\.(?:total|penalty|base)$/):null,m=null!=d,h=d?.[1];m&&deepClone(e.system.abilities[h]);let g=0;if(this.formula)if("script"===u)if(game.settings.get("ffd20","allowScriptChanges")){const e=this.createFunction(this.formula,["d","item"])(n,this.parent);g=e.value,u=e.operator}else g=0,u="add";else"function"===u?(g=this.formula(n,this.parent),u="add"):g=isNaN(this.formula)?this.isDeferred&&RollPF.parse(this.formula).some((e=>!e.isDeterministic))?RollPF.replaceFormulaData(this.formula,n,{missing:0}):RollPF.safeRoll(this.formula,n,[c,this,n],{suppressError:this.parent&&!this.parent.testUserPermission(game.user,"OWNER")}).total:parseFloat(this.formula);if(this.data.value=g,!c)continue;if("script"===u)continue;const y=t[u][this.modifier];switch(u){case"add":{let s=getProperty(e,c);if(null==s){if(c.match(/^system\.abilities/))continue;s=0}if("string"==typeof g)break;if("number"==typeof s)if(ffd20.config.stackingBonusModifiers.includes(this.modifier))setProperty(e,c,s+g),t[u][this.modifier]=(y??0)+g;else{setProperty(e,c,s+(y?Math.max(0,g-(y??0)):g)),t[u][this.modifier]=Math.max(y??0,g)}}break;case"set":setProperty(e,c,g),t[u][this.modifier]=g}if(s&&this.applySourceInfo(e,g),m){const t=e.system.abilities[h],s=getAbilityModifier(t.total,{damage:t.damage,penalty:t.penalty});e.system.abilities[h].mod=s}}}applySourceInfo(e){const t=this.getSourceInfoTargets(e),s=this.value,n={value:s,name:this.parent?this.parent.name:this.flavor,modifier:this.modifier,type:this.parent?this.parent.type:null,change:this};switch(this.operator){case"add":case"function":if(ffd20.config.stackingBonusModifiers.includes(this.modifier)){const l=s>=0?"positive":"negative";for(const s of t)getSourceInfo(e.sourceInfo,s)[l].push(n)}else for(const l of t){const t=s>=0?"positive":"negative",c=getSourceInfo(e.sourceInfo,l)[t];let u=!0,d=s;const m=c.find((e=>{const t=e.change?.parent===this.parent,s="base"===e.change?.modifier&&"enhancement"===this.modifier||"enhancement"===e.change?.modifier&&"base"===this.modifier,n=e.change?.subTarget===this.subTarget;return t&&s&&n}));if(m){if(u=!1,"base"===m.change?.modifier){m.value+=s;continue}{d+=m.value;const e=!c.some((e=>{const t=e.modifier===n.modifier,s=e.change?.subTarget,l=!s||s===this.subTarget,c=e.value>d;return t&&l&&c}));c.findSplice((e=>e===m),e?{...n,value:d}:void 0)}}c.forEach((e=>{(e.change?.modifier===n.modifier||e.modifier===n.modifier)&&(e.value<d?c.splice(c.indexOf(e),1):u=!1)})),u&&c.push({...n})}break;case"set":for(const n of t)getSourceInfo(e.sourceInfo,n).positive.push({value:s,operator:"set",name:this.parent?this.parent.name:this.flavor,modifier:this.modifier,type:this.parent?this.parent.type:null,change:this})}}createFunction(e,t=[]){try{const s='const actor = item.actor; const result = { operator: "add", value: 0, };',n="return result;",l=`return function(${t.join(",")}) {${s}${e}\n${n}};`;return Function(l)()}catch(t){return console.warn("Could not create change function with definition ",e),function(){return{operator:"add",value:0}}}}}class DamageRoll extends RollPF{constructor(e,t,s={}){super(e,t,s),this.options.damageType??={values:["untyped"],custom:""}}static TYPES={NORMAL:"normal",CRITICAL:"crit",NON_CRITICAL:"nonCrit"};get damageType(){return this.options.damageType}get type(){return this.options.type}get isCritical(){return this.type===this.constructor.TYPES.CRITICAL}}class HealthConfig extends FormApplication{constructor(e,t){super(e||HealthConfig.defaultSettings,t)}async getData(){let e=await game.settings.get("ffd20","healthConfig");return e=mergeObject(HealthConfig.defaultSettings,e),e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("SETTINGS.pf1HealthConfigName"),id:"health-config",template:"systems/ffd20/templates/settings/health.hbs",width:480,height:"auto",tabs:[{navSelector:".tabs",contentSelector:".tabbed",initial:"base",group:"primary"}]})}static get defaultSettings(){return{hitdice:{PC:{auto:!1,rate:.5,maximized:1},NPC:{auto:!1,rate:.5,maximized:0},Racial:{auto:!1,rate:.5,maximized:0}},hitdieOptions:["Compute","Rate","Maximized"],rounding:"up",continuity:"discrete",variants:{pc:{useWoundsAndVigor:!1,useWoundThresholds:0,allowWoundThresholdOverride:!1},npc:{useWoundsAndVigor:!1,useWoundThresholds:0,allowWoundThresholdOverride:!0}}}}activateListeners(e){super.activateListeners(e),e.find('button[name="reset"]').click(this._onReset.bind(this)),e.find('button[name="submit"]').click(this._onSubmit.bind(this))}async _onReset(e){return e.preventDefault(),await game.settings.set("ffd20","healthConfig",HealthConfig.defaultSettings),ui.notifications.info("Reset Pathfinder health configuration."),this.render()}_onSubmit(e){super._onSubmit(e)}async _updateObject(e,t){const s=expandObject(t);for(const e of Object.values(s.hitdice))e.rate=Math.clamped(e.rate,0,100),e.maximized=Math.clamped(Math.floor(e.maximized),0,100);s.variants.npc.allowWoundThresholdOverride=!0,await game.settings.set("ffd20","healthConfig",s),ui.notifications.info("Updated Pathfinder health configuration.")}}class ExperienceConfig extends FormApplication{constructor(e,t){super(e||ExperienceConfig.defaultSettings,t),this._init=!1}async getData(){const e={};if(!this._init){const e=await game.settings.get("ffd20","experienceConfig");this._settings=mergeObject(this.constructor.defaultSettings,e),this._init=!0}return e.settings=this._settings,e.hasCustomFormula="customFormula"===e.settings.track,e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("FFD20.ExperienceConfigName"),id:"experience-config",template:"systems/ffd20/templates/settings/experience.hbs",width:560,height:"auto"})}static get defaultSettings(){return{track:"medium",disableExperienceTracking:!1,openXpDistributor:!0,custom:{formula:""}}}activateListeners(e){super.activateListeners(e),e.find('button[type="submit"]').click(this._onButtonSubmit.bind(this))}_onButtonSubmit(e){this._onSubmit(e)}_onChangeInput(e){super._onChangeInput(e),this._updateApplicationSettings()}_updateApplicationSettings(){this._settings=mergeObject(this._settings,expandObject(this._getSubmitData())),this.render()}async _updateObject(e,t){const s=mergeObject(this._settings,expandObject(t),{inplace:!1});await game.settings.set("ffd20","experienceConfig",s),ui.notifications.info("Updated Pathfinder experience configuration.")}}class AccessibilityConfig extends FormApplication{constructor(e,t){super(e||AccessibilityConfig.defaultSettings,t),this._init=!1}async getData(){const e={};if(!this._init){const e=await game.settings.get("ffd20","accessibilityConfig");this._settings=mergeObject(this.constructor.defaultSettings,e),this._init=!0}return e.settings=this._settings,e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("FFD20.AccessibilityConfigName"),id:"accessibility-config",template:"systems/ffd20/templates/settings/accessibility.hbs",width:560,height:"auto"})}static get defaultSettings(){return{}}activateListeners(e){super.activateListeners(e),e.find('button[type="submit"]').click(this._onButtonSubmit.bind(this))}_onButtonSubmit(e){this._onSubmit(e)}async _updateObject(e,t){const s=expandObject(t);await game.settings.set("ffd20","accessibilityConfig",s),ui.notifications.info("Updated Pathfinder accessibility configuration.")}}class TooltipWorldConfig extends FormApplication{constructor(e,t){super(e||TooltipWorldConfig.defaultSettings,t),this._cachedData=null}getData(){const e={};let t=game.settings.get("ffd20","tooltipWorldConfig");return t=mergeObject(this.constructor.defaultSettings,t),e.data=t,e.permissions={[CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE]:"OWNERSHIP.NONE",[CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED]:"OWNERSHIP.LIMITED",[CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER]:"OWNERSHIP.OBSERVER",[CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER]:"OWNERSHIP.OWNER"},e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("FFD20.TooltipWorldConfigName"),id:"tooltip-world-config",template:"systems/ffd20/templates/settings/tooltip_world.hbs",width:720,height:"auto"})}static get defaultSettings(){return{disable:!1,portrait:{hide:!1},hideHeld:!0,hideArmor:!0,hideBuffs:!0,hideConditions:!1,hideClothing:!0,hideActorNameByDisposition:0,minimumPermission:CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED,hideActorNameReplacement:"???"}}activateListeners(e){e.find('button[name="submit"]').click(this._onSubmit.bind(this)),e.find('button[name="reset"]').click(this._onReset.bind(this))}async _onReset(e){return e.preventDefault(),await game.settings.set("ffd20","tooltipWorldConfig",this.constructor.defaultSettings),ui.notifications.info(game.i18n.localize("FFD20.TooltipConfigResetInfo")),this.render()}async _updateObject(e,t){const s=expandObject(t);await game.settings.set("ffd20","tooltipWorldConfig",s),ui.notifications.info(game.i18n.localize("FFD20.TooltipConfigUpdateInfo"))}}class TooltipConfig extends FormApplication{constructor(e,t){super(e||TooltipConfig.defaultSettings,t),this._cachedData=null}getData(){if(this._cachedData)return this._cachedData;const e=canvas.app.view.getBoundingClientRect(),t={screen:{width:e.width,height:e.height,halfWidth:Math.floor(e.width/2),halfHeight:Math.floor(e.height/2)},isGM:game.user.isGM};{const e={width:320,height:320,tooltip:{width:80,height:48}},s=t.screen.width/t.screen.height,n=t.screen.height/t.screen.width;s>n?e.height=Math.ceil(e.height*n):n>s&&(e.width=Math.ceil(e.width*s)),t.preview=e}let s=game.settings.get("ffd20","tooltipConfig");return s=mergeObject(this.constructor.defaultSettings,s),t.data=s,t.hideKey=game.i18n.localize("FFD20.Key_Control"),this._cachedData=t,t}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:game.i18n.localize("FFD20.TooltipConfigName"),id:"tooltip-config",template:"systems/ffd20/templates/settings/tooltip.hbs",width:720,height:"auto"})}static get defaultSettings(){return{disable:!1,anchor:{x:1,y:1},offset:{x:0,y:0},onMouse:!1,portrait:{hide:!1,maxSize:{width:280,height:280}},hideWithoutKey:!1}}activateListeners(e){e.find(".immediate-change").change(this._handleImmediateChange.bind(this)),e.find("button.world-settings").click(this._openWorldSettings.bind(this)),e.find('button[name="submit"]').click(this._onSubmit.bind(this)),e.find('button[name="reset"]').click(this._onReset.bind(this))}_handleImmediateChange(e){const t=e.currentTarget,s=t.name;if(!s)return;let n;"INPUT"===t.tagName?(n=t.value,"checkbox"===t.type&&(n=!0===t.checked)):n=t.innerHTML,"Boolean"===t.dataset?.dtype?n=!!n:"Number"===t.dataset?.dtype&&(n=parseFloat(n)),setProperty(this._cachedData,"data."+s,n),this.render()}_openWorldSettings(e){game.user.can("SETTINGS_MODIFY")?(new TooltipWorldConfig).render(!0,{focus:!0}):ui.notifications.error("FFD20.ErrorGenericPermission",{localize:!0})}async _onReset(e){return e.preventDefault(),await game.settings.set("ffd20","tooltipConfig",this.constructor.defaultSettings),this._cachedData=null,ui.notifications.info(game.i18n.localize("FFD20.TooltipConfigResetInfo")),this.render()}async _updateObject(e,t){const s=expandObject(t);await game.settings.set("ffd20","tooltipConfig",s),ui.notifications.info(game.i18n.localize("FFD20.TooltipConfigUpdateInfo"))}}class TooltipPF extends Application{constructor(){super(),this.mousePos={x:0,y:0},document.addEventListener("mousemove",(e=>{this.mousePos.x=e.clientX,this.mousePos.y=e.clientY,this.onMouse&&!this.hidden&&this._setPosition()})),this.object=null,this.forceHideGMInfo=!1,this.forceHide=!1,this.lock={new:!1,old:!1}}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"systems/ffd20/templates/hud/tooltip.hbs",popOut:!1})}get config(){return game.settings.get("ffd20","tooltipConfig")}get worldConfig(){return game.settings.get("ffd20","tooltipWorldConfig")}get anchor(){return this.config.anchor}get offset(){return this.config.offset}get onMouse(){return this.config.onMouse}get hidden(){return"hidden"===this.element[0]?.style.visibility}bind(e){this.lock.new||(this.object=e,this.render(!0))}unbind(e){this.lock.old||(this.object=null,this.hide())}clearBind(){this.object=null,this.hide()}async getData(){return"string"==typeof this.object?{stringContent:this.object}:this.object instanceof Token?{actorData:this.getTokenData(this.object)}:this.object instanceof Actor?{actorData:this.getActorData(this.object)}:{}}getTokenData(e){const t=this.getActorData(e.actor);if(!t)return null;if(t.name=e.name,game.user.isGM&&this.forceHideGMInfo||!game.user.isGM&&!e.actor.testUserPermission(game.user,this.worldConfig.minimumPermission??CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED)){const s=e.actor.system.details?.tooltip?.name||"";!0===e.actor.system.details?.tooltip?.hideName||e.document.disposition<=this.worldConfig.hideActorNameByDisposition?t.name=this.worldConfig.hideActorNameReplacement||"???":t.name=s||e.name}return t}getActorData(e){if(!e)return null;const t={data:e.system,name:e.name};if(game.user.isGM&&!this.forceHideGMInfo||(t.name=e.system.details?.tooltip?.name||e.name),t.isOwner=game.user.isGM||e.isOwner,t.isOwner||(t.name="???"),this.getPortrait(t,e.img),game.user.isGM&&!this.forceHideGMInfo||e.isOwner||!e.system.details?.tooltip?.hideConditions&&!this.worldConfig?.hideConditions){const s=e.system.attributes?.conditions||{};for(const[e,n]of Object.entries(s))!0===n&&(t.conditions=t.conditions||[],t.conditions.push({label:ffd20.config.conditions[e],icon:ffd20.config.conditionTextures[e]}))}if(game.user.isGM&&!this.forceHideGMInfo||e.isOwner||!e.system.details?.tooltip?.hideBuffs&&!this.worldConfig.hideBuffs){const s=e.itemTypes.buff?.filter((e=>e.isActive&&!e.system.hideFromToken))??[];for(const e of s)t.buffs=t.buffs||[],t.buffs.push({label:e.name,icon:e.img,level:e.system.level})}if(game.user.isGM&&!this.forceHideGMInfo||e.isOwner||!e.system.details?.tooltip?.hideHeld&&!this.worldConfig.hideHeld){const s=e.items.filter((e=>!!["weapon","equipment"].includes(e.type)&&(!!e.system.equipped&&("equipment"!==e.type||"shield"===e.subType))));for(const e of s)t.held=t.held||[],t.held.push({label:e.getName(this.forceHideGMInfo),icon:e.img})}const s=e.itemTypes.equipment?.filter((e=>e.system.equipped))??[];if(game.user.isGM&&!this.forceHideGMInfo||e.isOwner||!e.system.details?.tooltip?.hideArmor&&!this.worldConfig.hideArmor){const e=s.filter((e=>"armor"===e.subType));for(const s of e)t.armor=t.armor||[],t.armor.push({label:s.getName(this.forceHideGMInfo),icon:s.img})}if(game.user.isGM&&!this.forceHideGMInfo||e.isOwner||!getProperty(e,"item.details.tooltip.hideClothing")&&!this.worldConfig.hideClothing){const e=s.filter((e=>"clothing"===e.subType));for(const s of e)t.clothing=t.clothing||[],t.clothing.push({label:s.getName(this.forceHideGMInfo),icon:s.img})}return t}getPortrait(e,t){!0!==this.config.portrait?.hide&&!0!==this.worldConfig.portrait?.hide&&(e.portrait={maxWidth:this.config.portrait?.maxSize?.width||100,maxHeight:this.config.portrait?.maxSize?.height||100,url:t})}_setPosition(){if(!this.element[0])return;const e=canvas.app.view.getBoundingClientRect(),t=this.element[0].getBoundingClientRect(),s={width:t.width,height:t.height,left:0,top:0},n=ui.sidebar.element[0].getBoundingClientRect(),l=e.width-s.width-n.width,c=e.height-s.height;if(this.onMouse){const t={x:e.left,y:e.top},n={x:t.x+l,y:t.y+c},u={x:this.mousePos.x-s.width+s.width*this.anchor.x+this.offset.x,y:this.mousePos.y-s.height+s.height*this.anchor.y+this.offset.y};s.left=Math.clamped(u.x,t.x,n.x),s.top=Math.clamped(u.y,t.y,n.y)}else s.left=e.left+l*this.anchor.x+this.offset.x,s.top=e.top+c*this.anchor.y+this.offset.y;this.element.css(s)}show(){this.object&&(this.forceHide||!0!==this.config.disable&&!0!==this.worldConfig.disable&&(game.user.isGM||this.object.document.disposition!==CONST.TOKEN_DISPOSITIONS.SECRET)&&this.element.css("visibility","visible"))}hide(){this.element.css("visibility","hidden")}async _render(e=!1,t={}){await super._render(e,t),this.hide();const s=this.element.find("img"),n=s.length;if(n>0){let e=0;s.one("load",(()=>{e++,e===n&&this.object&&(this._setPosition(),this.show())}))}else this.object&&(this._setPosition(),this.show())}activateListeners(e){e.find(".controls .close").click((()=>{this.clearBind()}))}tokenHover(e,t){if(t){const t=ffd20.tooltip.mousePos,s=document.elementFromPoint(t.x,t.y);"board"===s?.id&&ffd20.tooltip.bind(e)}else ffd20.tooltip.unbind(e)}static toggle(e){e?(ffd20.tooltip||(ffd20.tooltip=new TooltipPF,Hooks.on("hoverToken",ffd20.tooltip.tokenHover)),ffd20.tooltip?.setPosition()):ffd20.tooltip&&(Hooks.off("hoverToken",ffd20.tooltip.tokenHover),ffd20.tooltip=null)}async refresh(){await this.render(),this.forceHide?this.hide():this.show()}}const registerSystemSettings=function(){game.settings.register("ffd20","systemMigrationVersion",{name:"System Migration Version",scope:"world",config:!1,type:String,default:"0.0.0"}),game.settings.register("ffd20","changelogVersion",{name:"Changelog Version",scope:"client",config:!1,type:String,default:"0.2.28"}),game.settings.register("ffd20","dontShowChangelog",{name:"Don't Automatically Show Changelog",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.registerMenu("ffd20","healthConfig",{name:"SETTINGS.pf1HealthConfigName",label:"SETTINGS.pf1HealthConfigLabel",hint:"SETTINGS.pf1HealthConfigHint",icon:"fas fa-heartbeat",type:HealthConfig,restricted:!0}),game.settings.register("ffd20","healthConfig",{name:"SETTINGS.pf1HealthConfigName",scope:"world",default:HealthConfig.defaultSettings,type:Object,config:!1,onChange:()=>ffd20.utils.refreshActors()}),game.settings.registerMenu("ffd20","experienceConfig",{name:"FFD20.ExperienceConfigName",label:"FFD20.ExperienceConfigLabel",hint:"FFD20.ExperienceConfigHint",icon:"fas fa-book",type:ExperienceConfig,restricted:!0}),game.settings.register("ffd20","experienceConfig",{name:"FFD20.ExperienceConfigName",scope:"world",default:ExperienceConfig.defaultSettings,type:Object,config:!1,onChange:()=>ffd20.utils.refreshActors()}),game.settings.register("ffd20","accessibilityConfig",{name:"FFD20.AccessibilityConfigName",scope:"client",default:AccessibilityConfig.defaultSettings,type:Object,config:!1,onChange:()=>ffd20.utils.refreshActors()}),game.settings.registerMenu("ffd20","tooltipConfig",{name:"FFD20.TooltipConfigName",label:"FFD20.TooltipConfigLabel",hint:"FFD20.TooltipConfigHint",restricted:!1,icon:"fas fa-window-maximize",type:TooltipConfig}),game.settings.register("ffd20","tooltipConfig",{name:"FFD20.TooltipConfigName",scope:"client",default:TooltipConfig.defaultSettings,type:Object,config:!1,onChange:e=>{const t=!game.settings.get("ffd20","tooltipWorldConfig").disabled&&!e.disabled;TooltipPF.toggle(t)}}),game.settings.register("ffd20","tooltipWorldConfig",{name:"FFD20.TooltipWorldConfigName",scope:"world",default:TooltipWorldConfig.defaultSettings,type:Object,config:!1,onChange:e=>{TooltipPF.toggle(!e.disable),ffd20.tooltip?.setPosition()}}),game.settings.register("ffd20","measureStyle",{name:"SETTINGS.pf1MeasureStyleN",hint:"SETTINGS.pf1MeasureStyleL",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("ffd20","diagonalMovement",{name:"SETTINGS.pf1DiagN",hint:"SETTINGS.pf1DiagL",scope:"world",config:!0,default:"5105",type:String,choices:{555:"SETTINGS.pf1DiagPHB",5105:"SETTINGS.pf1DiagDMG"},onChange:e=>canvas.grid.diagonalRule=e}),game.settings.register("ffd20","units",{name:"SETTINGS.pf1UnitsN",hint:"SETTINGS.pf1UnitsL",scope:"world",config:!0,default:"imperial",type:String,choices:{imperial:game.i18n.localize("SETTINGS.pf1ImperialUnits"),metric:game.i18n.localize("SETTINGS.pf1MetricUnits")},onChange:()=>{ffd20.utils.refreshActors(),setDefaultSceneScaling()}}),game.settings.register("ffd20","distanceUnits",{name:"SETTINGS.pf1DistanceUnitsN",hint:"SETTINGS.pf1DistanceUnitsL",scope:"world",config:!0,default:"default",type:String,choices:{default:game.i18n.localize("FFD20.Default"),imperial:game.i18n.localize("SETTINGS.pf1ImperialDistanceUnits"),metric:game.i18n.localize("SETTINGS.pf1MetricDistanceUnits")},onChange:()=>{ffd20.utils.refreshActors({renderOnly:!0}),setDefaultSceneScaling()}}),game.settings.register("ffd20","weightUnits",{name:"SETTINGS.pf1WeightUnitsN",hint:"SETTINGS.pf1WeightUnitsL",scope:"world",config:!0,default:"default",type:String,choices:{default:game.i18n.localize("FFD20.Default"),imperial:game.i18n.localize("SETTINGS.pf1ImperialWeightUnits"),metric:game.i18n.localize("SETTINGS.pf1MetricWeightUnits")},onChange:()=>ffd20.utils.refreshActors()}),game.settings.register("ffd20","allowBackgroundSkills",{name:"SETTINGS.pf1BackgroundSkillsN",hint:"SETTINGS.pf1BackgroundSkillsH",scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>ffd20.utils.refreshActors({renderOnly:!0})}),game.settings.register("ffd20","useFractionalBaseBonuses",{name:"SETTINGS.pf1FractionalBaseBonusesN",hint:"SETTINGS.pf1FractionalBaseBonusesH",scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>ffd20.utils.refreshActors()}),game.settings.register("ffd20","unchainedActionEconomy",{name:"SETTINGS.pf1UnchainedActionEconomyN",hint:"SETTINGS.pf1UnchainedActionEconomyH",scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>ffd20.utils.refreshActors({renderOnly:!0})}),game.settings.register("ffd20","lowLightVisionMode",{name:"SETTINGS.pf1LowLightVisionModeN",hint:"SETTINGS.pf1LowLightVisionModeH",scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>{canvas.perception.update({initializeLighting:!0,initializeVision:!0,refreshLighting:!0,refreshVision:!0},!0)}}),game.settings.register("ffd20","sharedVisionMode",{name:"SETTINGS.pf1SharedVisionModeN",hint:"SETTINGS.pf1SharedVisionModeH",scope:"world",config:!1,default:"0",type:String,choices:{0:"SETTINGS.pf1SharedVisionWithoutSelection",1:"SETTINGS.pf1SharedVisionWithSelection"},onChange:()=>canvas.perception.update({refreshLighting:!0,refreshVision:!0},!0)}),game.settings.register("ffd20","characterVision",{name:"SETTINGS.pf1characterVisionN",hint:"SETTINGS.pf1characterVisionH",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("ffd20","autoCollapseItemCards",{name:"SETTINGS.pf1AutoCollapseCardN",hint:"SETTINGS.pf1AutoCollapseCardL",scope:"client",config:!0,default:!1,type:Boolean,onChange:()=>ui.chat.render()}),game.settings.register("ffd20","hideChatButtons",{name:"SETTINGS.pf1HideChatButtonsN",hint:"SETTINGS.pf1HideChatButtonsH",scope:"client",config:!0,default:!1,type:Boolean,onChange:()=>ui.chat.render()}),game.settings.register("ffd20","coinWeight",{name:"SETTINGS.pf1CoinWeightN",hint:"SETTINGS.pf1CoinWeightH",scope:"world",config:!0,default:50,type:Number,onChange:()=>ffd20.utils.refreshActors()}),game.settings.register("ffd20","spellPointCost",{name:"SETTINGS.pf1SpellPointCostN",hint:"SETTINGS.pf1SpellPointCostH",scope:"world",config:!0,default:"@sl",type:String,onChange:()=>ffd20.utils.refreshSheets({reset:!1})}),game.settings.register("ffd20","alternativeReachCornerRule",{name:"SETTINGS.pf1AlternativeReachCornerRuleN",hint:"SETTINGS.pf1AlternativeReachCornerRuleH",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","npcProficiencies",{name:"SETTINGS.pf1NPCProficienciesN",hint:"SETTINGS.pf1NPCProficienciesH",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","coreEffects",{name:"SETTINGS.pf1CoreEffectsN",hint:"SETTINGS.pf1CoreEffectsH",scope:"world",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("ffd20","hideTokenConditions",{name:"SETTINGS.pf1HideTokenConditionsN",hint:"SETTINGS.pf1HideTokenConditionsH",scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>{if(!game.users.activeGM.isSelf)return;const e=[],t=[...game.actors.filter((e=>e.prototypeToken.actorLink)),...Object.values(game.actors.tokens).filter((e=>null!=e))];for(const s of t)s.toggleConditionStatusIcons&&e.push(s.toggleConditionStatusIcons({render:!1}));return Promise.all(e)}}),game.settings.register("ffd20","obscureInlineRolls",{name:"SETTINGS.pf1obscureInlineRollsN",hint:"SETTINGS.pf1obscureInlineRollsH",scope:"world",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("ffd20","obscureSaveDCs",{name:"SETTINGS.pf1obscureSaveDCsN",hint:"SETTINGS.pf1obscureSaveDCsH",scope:"world",config:!0,default:!0,type:Boolean,requiresReload:!0}),game.settings.register("ffd20","initiativeTiebreaker",{name:"SETTINGS.pf1InitTiebreakerN",hint:"SETTINGS.pf1InitTiebreakerH",scope:"world",config:!0,default:!0,type:Boolean,requiresReload:!0}),game.settings.register("ffd20","skipActionDialogs",{name:"SETTINGS.pf1SkipActionDialogsN",hint:"SETTINGS.pf1SkipActionDialogsH",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","placeMeasureTemplateOnQuickRolls",{name:"SETTINGS.placeMeasureTemplateOnQuickRollsN",hint:"SETTINGS.placeMeasureTemplateOnQuickRollsH",scope:"client",config:!0,default:!0,type:Boolean}),game.settings.register("ffd20","invertSectionFilterShiftBehaviour",{name:"SETTINGS.pf1InvertSectionFilterBehaviourN",hint:"SETTINGS.pf1InvertSectionFilterBehaviourH",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","hideReachMeasurements",{name:"SETTINGS.pf1HideReachMeasurementsN",hint:"SETTINGS.pf1HideReachMeasurementsH",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","displayIteratives",{name:"SETTINGS.pf1DisplayIterativesN",hint:"SETTINGS.pf1DisplayIterativesH",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","disableAttackCardTargets",{name:"SETTINGS.pf1DisableAttackCardTargetsN",hint:"SETTINGS.pf1DisableAttackCardTargetsH",scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","clearTargetsAfterAttack",{name:"SETTINGS.pf1ClearTargetsAfterAttackN",hint:"SETTINGS.pf1ClearTargetsAfterAttackH",scope:"client",config:!0,default:!1,type:Boolean}),game.settings.register("ffd20","allowScriptChanges",{name:"SETTINGS.pf1AllowScriptChangesN",hint:"SETTINGS.pf1AllowScriptChangesH",scope:"world",config:!0,default:!1,type:Boolean,onChange:e=>{if(!e||!game.user.isGM)return;Dialog.confirm({title:game.i18n.localize("SETTINGS.pf1AllowScriptChangesN"),content:game.i18n.localize("SETTINGS.pf1AllowScriptChangesW"),defaultYes:!1}).then((e=>{e||game.settings.set("ffd20","allowScriptChanges",!1)}))}})},migrateSystemSettings=async function(){game.settings.storage.get("client").removeItem("ffd20.compendiumItems"),game.user.isGM},getSkipActionPrompt=function(){return game.settings.get("ffd20","skipActionDialogs")&&!ffd20.skipConfirmPrompt||!game.settings.get("ffd20","skipActionDialogs")&&ffd20.skipConfirmPrompt},U=Object.freeze(Object.defineProperty({__proto__:null,getSkipActionPrompt,migrateSystemSettings,registerClientSettings:function(){},registerSystemSettings},Symbol.toStringTag,{value:"Module"}));class D20RollPF extends RollPF{options;constructor(e,t,s={}){if(super(e,t,s),this.options=mergeObject(this.constructor.defaultOptions,s),!(this.terms[0]instanceof Die)){if(!(this.terms[0]instanceof NumericTerm&&null===this.options.staticRoll))throw Error("Invalid D20RollPF formula provided: "+this._formula);this.options.staticRoll=this.terms[0].total,this.terms[0]=new Die({number:1,faces:20}),this._formula=this.constructor.getFormula(this.terms)}}static get defaultOptions(){return{critical:20,fumble:1,flavor:"",staticRoll:null,bonus:""}}static DIALOG_TEMPLATE="systems/ffd20/templates/chat/roll-dialog.hbs";static CHAT_TEMPLATE="systems/ffd20/templates/chat/roll-ext.hbs";static STATIC_ROLL={TEN:10,TWENTY:20};get d20(){return this.terms[0]}get isCrit(){if(this._evaluated)return!!Number.isNumeric(this.options.critical)&&this.d20.total>=this.options.critical}get isFumble(){if(foundry.utils.logCompatibilityWarning("D20RollPF.isFumble is deprecated in favor of D20RollPF.isNat1",{since:"PF1 v9",until:"PF1 v10"}),this._evaluated)return!!Number.isNumeric(this.options.fumble)&&this.d20.total<=this.options.fumble}get isNat20(){if(this._evaluated)return 20===this.d20.total}get isNat1(){if(this._evaluated)return 1===this.d20.total}get natural(){if(this._evaluated)return this.d20.total}get bonus(){if(this._evaluated)return this.total-this.natural}get formula(){let e=this.constructor.getFormula(this.terms);const t=this.constructor.parse(""+this.options.bonus,this.data);return this.options.bonus&&!this._evaluated&&(e+=" + "+this.constructor.getFormula(t)),e}get flavor(){return this.options.flavor}async promptDialog(e={}){const{rollMode:t=game.settings.get("core","rollMode"),template:s=this.constructor.DIALOG_TEMPLATE}=e,n=null===this.options.staticRoll?this.d20.formula:this.options.staticRoll,l={data:this.data,rollMode:e.rollMode||t,rollModes:CONFIG.Dice.rollModes,d20:"1d20"===n?"":n,bonus:this.options.bonus},c=e.dialogOptions||{};c.subject=e.subject,c.jQuery=!1,c.classes??=[],c.classes.push(...Dialog.defaultOptions.classes,"ffd20","roll-prompt");const u=await renderTemplate(s,l);return new Promise((t=>{new Dialog({title:e.title||game.i18n.localize("FFD20.Roll"),content:u,buttons:{normal:{label:game.i18n.localize("FFD20.Normal"),callback:e=>t(this._onDialogSubmit(e,null))},takeTen:{label:game.i18n.format("FFD20.TakeX",{number:this.constructor.STATIC_ROLL.TEN}),callback:e=>t(this._onDialogSubmit(e,this.constructor.STATIC_ROLL.TEN))},takeTwenty:{label:game.i18n.format("FFD20.TakeX",{number:this.constructor.STATIC_ROLL.TWENTY}),callback:e=>t(this._onDialogSubmit(e,this.constructor.STATIC_ROLL.TWENTY))}},default:"normal",close:()=>{t(null)}},c).render(!0)}))}_onDialogSubmit(e,t){const s=e.querySelector("form");if(s){if(s.bonus.value&&(this.options.bonus=s.bonus.value),s.d20.value){const e=this.constructor.parse(s.d20.value,this.data);e[0]instanceof NumericTerm?this.options.staticRoll=e[0].total:e[0]instanceof Die&&(this.terms=[...e,...this.terms.slice(1)],void 0!==t&&(this.options.staticRoll=t))}else void 0!==t&&(this.options.staticRoll=t);s.rollMode&&(this.options.rollMode=s.rollMode.value),this._formula=this.constructor.getFormula(this.terms)}return this}async toMessage(e={},t={}){this._evaluated||await this.evaluate({async:!0});const s=t.chatTemplate||this.constructor.CHAT_TEMPLATE,n=mergeObject({user:game.user.id,formula:this.formula,tooltip:await this.getTooltip(),total:this.total,isCrit:this.isCrit,isFumble:this.isNat1,isNat20:this.isNat20,isNat1:this.isNat1,natural:this.natural,bonus:this.bonus,flavor:this.options.flavor,compendiumEntry:t.compendium?.entry,compendiumEntryType:t.compendium?.type},t.chatTemplateData||{}),l=t.rollMode||this.options.rollMode||game.settings.get("core","rollMode");(e=foundry.utils.mergeObject({user:game.user.id,type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:t.noSound?void 0:CONFIG.sounds.dice,content:await renderTemplate(s,n),"flags.ffd20.noRollRender":!0},e)).rolls=[this],t.subject&&foundry.utils.setProperty(e,"flags.ffd20.subject",t.subject);const c=CONFIG.ChatMessage.documentClass,u=new c(e),d=u.toObject();return t.create??!0?c.create(u,{rollMode:l}):(l&&c.applyRollMode(d,l),d)}async _evaluate(e){return this._applyBonus(),await super._evaluate(e),this._applyStaticRoll(),this}_evaluateSync(e){return this._applyBonus(),super._evaluateSync(e),this._applyStaticRoll(),this}_applyBonus(){if(this.options.bonus){const e=this.constructor.parse(""+this.options.bonus,this.data);e[0]instanceof OperatorTerm||e.unshift(new OperatorTerm({operator:"+"})),this.terms=this.terms.concat(...e),this._formula=this.constructor.getFormula(this.terms)}}_applyStaticRoll(){if(!this._evaluated)throw Error("Roll must be evaluated before applying static roll.");if(null!==this.options.staticRoll&&this.options.staticRoll>=0){const e=this.d20,t=this.options.staticRoll-e.total,s=this._total+t;(e.results.find((e=>e.active))??e.results[0]).result=this.options.staticRoll,this._total=s,this.options.flavor+=` (${game.i18n.format("FFD20.TakeX",{number:this.options.staticRoll})})`}}}class ItemAction{constructor(e,t){this.data=mergeObject(ItemAction.defaultData,e),this.parent=t,this.apps={},this.sheet=null,this.prepareData()}get description(){return this.data.description}get isCombatManeuver(){return["mcman","rcman"].includes(this.data.actionType)}get activation(){return(game.settings.get("ffd20","unchainedActionEconomy")?this.data.activation.unchained:this.data.activation)??{}}static async create(e,t={}){const{parent:s}=t;if(s instanceof ffd20.documents.item.ItemPF){e=e.map((e=>mergeObject(this.defaultData,e)));const t=deepClone(s.system.actions||[]);return t.push(...e),await s.update({"system.actions":t}),e.map((e=>s.actions.get(e._id)))}return[]}static get defaultDamageType(){return{values:[],custom:""}}get item(){return this.parent}get actor(){return this.parent.actor}get id(){return this.data._id}get img(){return this.data.img}get name(){return this.data.name}get tag(){return this.data.tag||createTag(this.name)}get hasAction(){return!!this.data.actionType}get hasAttack(){return["mwak","rwak","msak","rsak","mcman","rcman"].includes(this.data.actionType)}get hasMultiAttack(){return this.hasAttack&&(null!=this.data.attackParts&&this.data.attackParts.length>0||this.data.formulaicAttacks?.count?.value>0)}get autoDeductCharges(){return this.getChargeCost()>0}get isCharged(){return this.item.isCharged}get isSelfCharged(){return["single","day","week","charges"].includes(this.data.uses.self?.per)}getChargeCost({rollData:e=null}={}){if(!this.isCharged)return 0;let t="spell"===this.item.type&&this.item.useSpellPoints()?this.data.uses.spellPointCost:this.data.uses.autoDeductChargesCost;t?"string"!=typeof t&&(console.warn(this.item.name,"action",this.name,"has invalid charge formula:",t,this),t=this.item.getDefaultChargeFormula()):t=this.item.getDefaultChargeFormula(),e??=this.getRollData();const s=RollPF.safeRoll(t,e).total;return this.item.isSingleUse?Math.clamped(s,-1,1):s}get range(){return this.getRange({type:"single"})}get minRange(){return this.getRange({type:"min"})}get maxRange(){return this.getRange({type:"max"})}getRange({type:e="single",rollData:t=null}={}){const s="min"===e?this.data.range.minValue:this.data.range.value,n="min"===e?this.data.range.minUnits:this.data.range.units;if(!n)return"min"===e?0:null;t??=this.getRollData();const l=calculateRange(s,n,t);return["single","min"].includes(e)?l:l*this.data.range.maxIncrements}get hasTemplate(){const e=this.data.measureTemplate.type,t=this.data.measureTemplate.size;return"string"==typeof e&&""!==e&&("string"==typeof t&&t.length>0||"number"==typeof t&&t>0)}get hasDamage(){return!!this.data.damage.parts?.length}get hasRange(){const e=this.data.range?.units;return"none"!==e&&!!e}get isHealing(){return"heal"===this.data.actionType&&this.data.damage.parts.length}get hasEffect(){return this.hasDamage||null!=this.data.effectNotes&&this.data.effectNotes.length>0}get hasSave(){return"string"==typeof this.data.save?.type&&this.data.save?.type.length>0}getDC(e=null){if(!this.actor)return 0;e??=this.getRollData();let t=10;const s=e.dcBonus??0;if("spell"!==this.item.type){const n=this.data.save.dc.toString()||"0";return t=RollPF.safeRoll(n,e).total+s,t}{const t=this.item.spellbook;if(t){let n=t.baseDCFormula;const l=e.action;return l.save.dc.length>0&&(n+=" + "+l.save.dc),RollPF.safeRoll(n,e).total+s}}return t}get hasSound(){return!!this.data.soundEffect}get enhancementBonus(){return this.data.enh?.value??this.item.system.enh}get damageSources(){const e=["msak","rsak","spellsave"].includes(this.data.actionType),t=["mwak","rwak"].includes(this.data.actionType),s=this.parent.getContextChanges(e?"sdamage":t?"wdamage":"damage");return getHighestChanges(s,{ignoreTarget:!0})}get allDamageSources(){const e=this.data.conditionals.filter((e=>e.default)).filter((e=>e.modifiers.find((e=>"damage"===e.target)))),t=this.getRollData();if(!t)return[];const s=Object.keys(ffd20.config.bonusModifiers),n=[];for(const l of e)for(const e of l.modifiers){if("damage"!==e.target)continue;const c=RollPF.safeRoll(e.formula,t);if(c.err)continue;const u=s.includes(e.type);n.push({flavor:l.name,value:c.total,modifier:u?e.type:"untyped",type:u?void 0:e.type,formula:e.formula})}const l=[...this.damageSources,...n],c=this.enhancementBonus;return c&&l.push({flavor:game.i18n.localize("FFD20.EnhancementBonus"),value:c,modifier:"enh",formula:c.toString()}),this.item.system.broken&&l.push({flavor:game.i18n.localize("FFD20.Broken"),value:-2,modifier:"untyped",formula:"-2"}),getHighestChanges(l,{ignoreTarget:!0})}getRollData(){const e=this.item.getRollData();return e.action=deepClone(this.data),e.dc=this.hasSave?this.getDC(e):0,Hooks.events.pf1GetRollData?.length>0&&Hooks.callAll("pf1GetRollData",this,e),e}static get defaultData(){return{_id:randomID(16),name:game.i18n.localize("FFD20.Action"),img:"systems/ffd20/icons/skills/gray_04.jpg",description:"",tag:"",activation:{cost:1,type:"",unchained:{cost:1,type:""}},duration:{value:null,units:""},target:{value:""},range:{value:null,units:"",maxIncrements:1,minValue:null,minUnits:""},uses:{autoDeductChargesCost:"",self:{value:0,maxFormula:"",per:""}},measureTemplate:{type:"",size:"",overrideColor:!1,customColor:"",overrideTexture:!1,customTexture:""},attackName:"",actionType:null,attackBonus:"",critConfirmBonus:"",damage:{parts:[],critParts:[],nonCritParts:[]},attackParts:[],formulaicAttacks:{count:{formula:""},bonus:{formula:""},label:null},formula:"",ability:{attack:"",damage:"",damageMult:1,critRange:20,critMult:2},save:{dc:"",type:"",description:""},effectNotes:[],attackNotes:[],soundEffect:"",powerAttack:{multiplier:"",damageBonus:2,critMultiplier:1},naturalAttack:{primaryAttack:!0,secondary:{attackBonus:"-5",damageMult:.5}},nonlethal:!1,touch:!1,usesAmmo:!1,spellEffect:"",spellArea:"",conditionals:[],enh:{value:null}}}prepareData(){const e=this.getRollData();if(this.hasAttack&&this.parseFormulaicAttacks({rollData:e}),this.data.conditionals instanceof Array&&(this.conditionals=this._prepareConditionals(this.data.conditionals)),this.data.uses.self?.per){const t="single"===this.data.uses.self.per?"1":this.data.uses.self.maxFormula,s=RollPF.safeTotal(t,e);setProperty(this.data,"uses.self.max",s)}null==this.data.enh?.value||["weapon","attack"].includes(this.item.type)||setProperty(this.data,"enh.value",null),void 0===this.data.ability?.damageMult&&setProperty(this.data,"ability.damageMult",1),void 0===this.data.naturalAttack?.secondary?.damageMult&&setProperty(this.data,"naturalAttack.secondary.damageMult",.5)}_prepareConditionals(e){const t=this.conditionals,s=new Collection;for(const n of e){let e=null;t&&t.has(n._id)?(e=t.get(n._id),e.data=n,e.prepareData()):e=new ffd20.components.ItemConditional(n,this),s.set(n._id||e.data._id,e)}return s}async delete(){const e=deepClone(this.item.system.actions),t=this.item.system.actions.indexOf(this.data);e.splice(t,1);const s=[];for(const e of Object.values(this.apps))s.push(e.close());return await Promise.all(s),this.item.update({"system.actions":e})}async update(e,t={}){const s=this.item.system.actions.findIndex((e=>e._id===this.id));if(s<0)throw Error(`Action ${this.id} not found on item.`);const n=deepClone(this.data),l=mergeObject(n,expandObject(e));l.name||=this.name;{const e=["attackParts","damage.parts","damage.critParts","damage.nonCritParts","attackNotes","effectNotes","conditionals"];for(const t of e)keepUpdateArray(this.data,l,t)}await this.item.update({"system.actions":{[s]:l}}),await(this.sheet?.render())}getChatData(e={},t={}){return this.parent.getChatData(e,{...t,actionId:this.id})}getLabels({rollData:e}={}){const t=this.data,s={};e??=this.getRollData();const n=game.settings.get("ffd20","unchainedActionEconomy");if(t.activation){const e=n?ffd20.config.abilityActivationTypes_unchained:ffd20.config.abilityActivationTypes,t=n?ffd20.config.abilityActivationTypesPlurals_unchained:ffd20.config.abilityActivationTypesPlurals,l=this.activation;l&&l.cost>1&&null!=t[l.type]?s.activation=[l.cost.toString(),t[l.type]].filterJoin(" "):l&&(s.activation=[["minute","hour","action"].includes(l.type)&&l.cost?l.cost.toString():"",e[l.type]].filterJoin(" "))}if(this.hasSave){const t=e.dc+(e.dcBonus??0);s.save=game.i18n.format("FFD20.DCThreshold",{threshold:t})}if(this.hasRange){const n=t.range.units,l=ffd20.config.distanceUnits[n];if(["personal","touch","melee","reach"].includes(n))s.range=l;else{const t=this.getRange({type:"single",rollData:e});if(t>0){const e="metric"===getDistanceSystem()?"m":"ft";s.range=`${t} ${e}`}["close","medium","long"].includes(n)&&(s.range+=` (${l})`)}}return s}parseFormulaicAttacks({formula:e=null,rollData:t}={}){if(!this.actor)return;const s=e||this.data.formulaicAttacks?.count?.formula||"0";let n,l=0;if(t??=this.getRollData(),s.length>0&&(n=RollPF.safeRoll(s,t),l=Math.clamped(n.total,0,50)),n?.err){const e=game.i18n.format("FFD20.ErrorActionFormula",{action:this.name,item:this.item?.name,actor:this.actor?.name});console.warn(e,n.err,s,this),ui.notifications.warn(e,{console:!1})}const c=this.data.formulaicAttacks?.bonus?.formula||"0";try{c.length>0&&0!=c&&(t.attackCount=1,RollPF.safeRoll(c,t),delete t.attackCount)}catch(e){const t=game.i18n.format("FFD20.ErrorActionFormula",{action:this.name,item:this.item?.name,actor:this.actor?.name});console.error(t,e,c,this),ui.notifications.error(t,{console:!1})}return setProperty(this.data,"formulaicAttacks.count.value",l),l}async rollAttack({data:e=null,extraParts:t=[],bonus:s=null,primaryAttack:n=!0}={}){const l=e??this.getRollData(),c=l.item,u=l.action;l.item.primaryAttack=n;const d=["rwak","rsak","rcman"].includes(u.actionType),m=this.isCombatManeuver;l.sizeBonus=m?ffd20.config.sizeSpecialMods[l.traits.size]:ffd20.config.sizeMods[l.traits.size],l.item.proficiencyPenalty=-4;const h=u.ability.attack;let g=[];this.actor.sourceDetails["system.attributes.attack.shared"]?.reverse().forEach((e=>g.push(`${e.value}[${e.name}]`))),m&&this.actor.sourceDetails["system.attributes.cmb.bonus"]?.reverse().forEach((e=>g.push(`${e.value}[${e.name}]`))),0!==l.sizeBonus&&g.push(`@sizeBonus[${game.i18n.localize("FFD20.Size")}]`),""!=h&&null!=l.abilities[h]&&0!==l.abilities[h].mod&&g.push(`@abilities.${h}.mod[${ffd20.config.abilities[h]}]`),g=g.concat(t),"string"!=typeof u.attackBonus||["","0"].includes(u.attackBonus)?"number"==typeof u.attackBonus&&(l.item.attackBonus=u.attackBonus,g.push(`@item.attackBonus[${game.i18n.localize("FFD20.AttackRollBonus")}]`)):g.push(u.attackBonus);const y=this.item.getContextChanges(d?"rattack":"mattack");["mwak","rwak","mcman","rcman"].includes(this.data.actionType)&&this.item.system.masterwork&&y.push(new ffd20.components.ItemChange({formula:"1",operator:"add",subTarget:"attack",modifier:"enh",value:1,flavor:game.i18n.localize("FFD20.EnhancementBonus")})),this.enhancementBonus&&y.push(new ffd20.components.ItemChange({formula:this.enhancementBonus.toString(),operator:"add",subTarget:"attack",modifier:"enh",value:this.enhancementBonus,flavor:game.i18n.localize("FFD20.EnhancementBonus")}));let b=[];b=getHighestChanges(y.filter((e=>(e.applyChange(this.actor),!["set","="].includes(e.operator)))),{ignoreTarget:!0}).reduce(((e,t)=>(e.push({value:t.value,source:t.flavor}),e)),[]);for(const e of b)g.push(`${e.value}[${RollPF.cleanFlavor(e.source)}]`);if(["attack","weapon","equipment"].includes(this.item.type)&&!c.proficient&&g.push(`@item.proficiencyPenalty[${game.i18n.localize("FFD20.ProficiencyPenalty")}]`),"natural"===this.item.system.subType&&!1===n){const e=-5;g.push(`${e}[${game.i18n.localize("FFD20.SecondaryAttack")}]`)}s&&(l.bonus=RollPF.safeRoll(s,l).total,g.push(`@bonus[${game.i18n.localize("FFD20.SituationalBonus")}]`));const F=c.broken||this.isCombatManeuver?20:u.ability.critRange||20;return await new D20RollPF([l.d20||"1d20",...g.filter((e=>!!e))].join("+"),l,{critical:F}).evaluate({async:!0})}rollEffect({critical:e=!1,primaryAttack:t=!0}={}){const s=this.getRollData();if(!this.hasEffect)throw Error("You may not make an Effect Roll with this Item.");s.critMult=1,e&&(s.critMult=this.data.ability.critMult),null!=this.data.ability.damageMult&&(s.ablMult=this.data.ability.damageMult);const n=this.parent.getContextNotes("attacks.effect").reduce(((e,t)=>(t.notes.reduce(((e,t)=>(e.push(...t.split(/[\n\r]+/)),e)),[]).forEach((t=>{e.push(t)})),e)),[]);n.push(...this.data.effectNotes);let l="";for(const e of n)e.length>0&&(l+=`<span class="tag">${e}</span>`);if(0===l.length)return"";const c=TextEditor.enrichHTML(l,{rollData:s});return`<div class="flexcol property-group"><label>${game.i18n.localize("FFD20.EffectNotes")}</label><div class="flexrow tag-list">${c}</div></div>`}async rollFormula(e={}){const t=this.data;if(!t.formula)throw Error(game.i18n.format("FFD20.ErrorNoFormula",{name:this.name}));const s=this.parent.getRollData();s.item=t;const n=`${this.name} - ${game.i18n.localize("FFD20.OtherFormula")}`;return(await RollPF.create(t.formula,s).evaluate({async:!0})).toMessage({speaker:ChatMessage.getSpeaker({actor:this.parent}),flavor:t.chatFlavor||n,rollMode:game.settings.get("core","rollMode")})}async rollDamage({data:e=null,critical:t=!1,extraParts:s=[],conditionalParts:n={},primaryAttack:l=!0}={}){const c=e??this.getRollData();if(!this.hasDamage)throw Error("You may not make a Damage Roll with this Action.");c.critMult=1,t&&(c.critMult=this.data.ability.critMult),null==c.ablMult&&(c.ablMult=c.action?.ability.damageMult);let u=this.data.damage.parts?.map((e=>({base:e.formula,extra:[],damageType:e.type,type:"normal"})))??[];if(n["damage.normal"]?.forEach((e=>{const[t,s,n]=e;n?u[0].extra.push(t):u.push({base:t,extra:[],damageType:s,type:"normal"})})),!0===t){const e=this.data.damage?.critParts;e&&(u=u.concat(e.map((e=>({base:e.formula,extra:[],damageType:e.type,type:"crit"}))))),n["damage.crit"]?.forEach((e=>{const[t,s,n]=e;n?u[0].extra.push(t):u.push({base:t,extra:[],damageType:s,type:"crit"})}))}if(!1===t){const e=this.data.damage?.nonCritParts;e&&(u=u.concat(e.map((e=>({base:e.formula,extra:[],damageType:e.type,type:"nonCrit"}))))),n["damage.nonCrit"]?.forEach((e=>{const[t,s,n]=e;n?u[0].extra.push(t):u.push({base:t,extra:[],damageType:s,type:"nonCrit"})}))}if(!this.isHealing){const e=["msak","rsak","spellsave"].includes(this.data.actionType),t=["mwak","rwak"].includes(this.data.actionType),s=this.item.getContextChanges(e?"sdamage":t?"wdamage":"damage");if(this.enhancementBonus&&s.push(new ffd20.components.ItemChange({formula:this.enhancementBonus.toString(),operator:"add",subTarget:"damage",modifier:"enh",value:this.enhancementBonus,flavor:game.i18n.localize("FFD20.EnhancementBonus")})),getHighestChanges(s.filter((e=>(e.applyChange(this.actor),!["set","="].includes(e.operator)))),{ignoreTarget:!0}).forEach((e=>{let t=e.value;/[\s+-?:]/.test(t)&&(t=`(${t})`),u[0].extra.push(`${t}[${e.flavor}]`)})),this.item.system.broken){const e=game.i18n.localize("FFD20.Broken");u[0].extra.push(`-2[${e}]`)}}const d=this.data.ability.damage;if("string"==typeof d&&""!==d){c.ablDamage=Math.floor(c.abilities[d].mod*c.ablMult),c.abilities[d].mod<0&&(c.ablDamage=c.abilities[d].mod);const e=ffd20.config.abilities[d];u[0].extra.push(`@ablDamage[${e}]`)}const m=[];for(let e=0;e<u.length;e++){const t=u[e];let n=[];0===e&&(n=[...t.extra,...s]);const l=[t.base,...n].join(" + ");if(0!=l.length)try{const e=await new DamageRoll(l,c,{damageType:t.damageType,type:t.type}).evaluate({async:!0});m.push(e)}catch(e){throw console.error("Error with damage formula:",l,this),e}}return m}getConditionalTargets(){const e={};return this.hasAttack&&(e.attack=game.i18n.localize(ffd20.config.conditionalTargets.attack._label)),this.hasDamage&&(e.damage=game.i18n.localize(ffd20.config.conditionalTargets.damage._label)),e.size=game.i18n.localize(ffd20.config.conditionalTargets.size._label),("spell"===this.item.type||this.hasSave)&&(e.effect=game.i18n.localize(ffd20.config.conditionalTargets.effect._label)),Object.keys(this.getConditionalSubTargets("misc")).length>0&&(e.misc=game.i18n.localize(ffd20.config.conditionalTargets.misc._label)),e}getConditionalSubTargets(e){const t={};if(hasProperty(ffd20.config.conditionalTargets,e))for(const[s,n]of Object.entries(ffd20.config.conditionalTargets[e]))s.startsWith("_")||s.startsWith("~")||(t[s]=n);if(["attack","damage"].includes(e)&&(this.hasAttack?t.attack_0=game.i18n.localize("FFD20.Attack")+" 1":delete t.rapidShotDamage,this.hasMultiAttack))for(const[e,s]of Object.entries(this.data.attackParts))t["attack_"+(Number(e)+1)]=s[1];return"effect"===e&&this.hasSave&&(t.dc=game.i18n.localize("FFD20.DC")),"misc"===e&&this.isCharged&&"spell"!==this.type&&(t.charges=game.i18n.localize("FFD20.ChargeCost")),t}getConditionalModifierTypes(e){const t={};if("attack"===e||"damage"===e)for(const[e,s]of Object.entries(ffd20.config.bonusModifiers))t[e]=s;if("damage"===e)for(const e of ffd20.registry.damageTypes)t[e.id]=e.name;return t}getConditionalCritical(e){let t={};return"attack"===e&&(t={...t,normal:"FFD20.Normal",crit:"FFD20.CriticalConfirmBonus"}),"damage"===e&&(t={...t,normal:"FFD20.Normal"},this.hasAttack&&(t={...t,crit:"FFD20.CritDamageBonusFormula",nonCrit:"FFD20.NonCritDamageBonusFormula"})),t}async use(e={}){return e.actionID=this.id,this.item.use(e)}}class ChatAttack{constructor(e,{label:t="",rollData:s={},targets:n=null}={}){this.rollData=s,this.setAction(e),this.label=t,this.attack=null,this.critConfirm=null,this.hasAttack=!1,this.hasCritConfirm=!1,this.damage={flavor:"",total:0,rolls:[]},this.critDamage={flavor:"",total:0,rolls:[]},this.hasDamage=!1,this.hasRange=e.item.hasRange,this.nonlethal=!1,this.damageRows=[],this.notesOnly=!0,this.cards={},this.hasCards=!1,this.attackNotes=[],this.effectNotes=[],this.attackNotesHTML="",this.effectNotesHTML="",this.targets=n,this.ammo=null}setAmmo(e){if(null==e)this.ammo=null;else{const t=this.action.item.actor?.items.get(e);if(null==t)return void(this.ammo=null);this.ammo={id:e,img:t.img,name:t.name}}}get critRange(){return this.action.item.system.broken?20:this.rollData.action.ability?.critRange||20}setAction(e){if(null==e)return this.rollData=null,void(this.action=null);this.action=e,this.isHealing=e.isHealing,this.setRollData()}setRollData(){const e=this.rollData;e.critMult=1,e.critCount=0,e.critConfirmBonus=RollPF.safeTotal(e.action.critConfirmBonus||"0")??0,null!=e.action.ability.damageMult&&(e.ablMult=e.action.ability.damageMult)}setAttackNotesHTML(){if(0===this.attackNotes.length)return void(this.attackNotesHTML="");let e="";for(const t of this.attackNotes)t.length>0&&(e+=`<span class="tag">${t}</span>`);const t=TextEditor.enrichHTML(e,{rollData:this.rollData,async:!1});this.attackNotesHTML=`<div class="flexcol property-group gm-sensitive attack-notes"><label>${game.i18n.localize("FFD20.AttackNotes")}</label><div class="flexrow tag-list">${t}</div></div>`}setEffectNotesHTML(){if(0===this.effectNotes.length)return void(this.effectNotesHTML="");let e="";for(const t of this.effectNotes)t.length>0&&(e+=`<span class="tag">${t}</span>`);const t=TextEditor.enrichHTML(e,{rollData:this.rollData,async:!1});this.effectNotesHTML=`<div class="flexcol property-group gm-sensitive effect-notes"><label>${game.i18n.localize("FFD20.EffectNotes")}</label><div class="flexrow tag-list">${t}</div></div>`}async addAttack({noAttack:e=!1,bonus:t=null,extraParts:s=[],critical:n=!1,conditionalParts:l={}}={}){if(!this.action.item)return;const c=this.action.actor;let u;if(this.hasAttack=!0,this.notesOnly=!1,!0===n){0!==this.rollData.critConfirmBonus&&s.push(`@critConfirmBonus[${game.i18n.localize("FFD20.CriticalConfirmation")}]`);const e=ffd20.documents.actor.changes.getChangeFlat.call(c,"critConfirm");for(const t of e)c?.sourceDetails[t]?.forEach((e=>s.push(`(${e.value})[${e.name}]`)));l["attack.crit"]?.length&&s.push(...l["attack.crit"])}else l["attack.normal"]?.length&&s.push(...l["attack.normal"]);const d=this.rollData.item.broken;if(d&&!n){const e=game.i18n.localize("FFD20.Broken");s.push(`-2[${e}]`)}e||(u=await this.action.rollAttack({data:this.rollData,bonus:t,extraParts:s}),!0===n?this.critConfirm=u:this.attack=u,!n&&!this.action.isCombatManeuver&&u.isCrit&&this.rollData.action.ability.critMult>1&&(this.hasCritConfirm=!0,this.rollData.critMult=Math.max(1,this.rollData.action.ability.critMult),d&&(this.rollData.critMult=1),await this.addAttack({bonus:t,extraParts:s,critical:!0,conditionalParts:l}))),u.options.flavor=n?game.i18n.localize("FFD20.CriticalConfirmation"):this.label,""===this.attackNotes&&this.addAttackNotes()}addAttackNotes(){if(!this.action.item)return;const e=this.action.data.actionType,t={rsak:["ranged","rangedSpell"],rwak:["ranged","rangedWeapon"],rcman:["ranged"],mwak:["melee","meleeWeapon"],msak:["melee","meleeSpell"],mcman:["melee"]},s=[];null!=this.action.item?.actor&&(s.push(...this.action.item.actor.getContextNotesParsed("attacks.attack")),(t[e]?.length||0)>0&&t[e].forEach((e=>s.push(...this.action.item.actor.getContextNotesParsed("attacks."+e))))),this.action.item?.system.attackNotes&&s.push(...this.action.item.system.attackNotes),this.action.data.attackNotes&&s.push(...this.action.data.attackNotes),this.action.isCombatManeuver&&s.push(...this.action.item?.actor?.getContextNotesParsed("misc.cmb")??[]),this.attackNotes=s,this.setAttackNotesHTML()}async addDamage({flavor:e=null,extraParts:t=[],critical:s=!1,conditionalParts:n={}}={}){if(!this.action.item)return;this.hasDamage=!0,this.notesOnly=!1;let l=this.damage;!0===s&&(l=this.critDamage);const c=duplicate(this.rollData);c.critCount=0;const u=s?Math.max(1,c.critMult-1):1;for(let e=0;e<u;++e)s&&c.critCount++,l.rolls.push(...await this.action.rollDamage({data:c,extraParts:t,critical:s,conditionalParts:n}));let d="";for(const e of l.rolls)d+=await renderTemplate("systems/ffd20/templates/internal/damage-tooltip.hbs",{part:e});e||(e=s?this.isHealing?game.i18n.localize("FFD20.HealingCritical"):game.i18n.localize("FFD20.DamageCritical"):this.isHealing?game.i18n.localize("FFD20.Healing"):game.i18n.localize("FFD20.Damage"));let m=l.rolls.reduce(((e,t)=>e+t.total),0);s&&(m=this.damage.rolls.reduce(((e,t)=>e+t.total),m)),m<1&&(m=1,e=game.i18n.localize("FFD20.Nonlethal"),this.nonlethal=!0),(this.rollData.action.nonlethal||this.action.item.system.properties?.nnl)&&(this.nonlethal=!0,e=game.i18n.localize("FFD20.Nonlethal")),l.flavor=e,l.total=m}addEffectNotes(){if(!this.action.item)return;let e=[];null!=this.action.item&&null!=this.action.item.actor&&(e=this.action.item.actor.getContextNotes("attacks.effect").reduce(((e,t)=>{for(const s of t.notes)e.push(...s.split(/[\n\r]+/));return e}),[]),"spell"===this.action.item.type&&this.action.item.actor.getContextNotes("spell.effect").forEach((t=>{for(const s of t.notes)e.push(...s.split(/[\n\r]+/))}))),null!=this.action.item&&this.action.item.system.effectNotes&&e.push(...this.action.item.system.effectNotes),this.action.data.effectNotes&&e.push(...this.action.data.effectNotes),this.effectNotes=this.effectNotes.concat(e),this.setEffectNotesHTML()}finalize(){this.hasCards=Object.keys(this.cards).length>0;for(let e=0;e<Math.max(this.damage.rolls.length,this.critDamage.rolls.length);e++)this.damageRows.push({normal:null,crit:null});for(let e=0;e<this.damage.rolls.length;e++)this.damageRows[e].normal=this.damage.rolls[e];for(let e=0;e<this.critDamage.rolls.length;e++)this.damageRows[e].crit=this.critDamage.rolls[e];return this}}const H=Object.freeze({NO_ACTOR_PERM:1,DISABLED:2,INSUFFICIENT_QUANTITY:3,INSUFFICIENT_CHARGES:4,MISSING_AMMO:5,INSUFFICIENT_AMMO:6});class ActionUse{actor;token;item;action;shared;constructor(e={}){Object.defineProperties(this,{shared:{value:e},item:{value:e.item},action:{value:e.action},actor:{value:e.item.actor},token:{value:e.token}})}checkRequirements(){const e=this.item.actor;if(e&&!e.isOwner)return ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:e.name})),H.NO_ACTOR_PERM;if("feat"===this.item.type&&this.item.system.disabled)return ui.notifications.warn(game.i18n.localize("FFD20.ErrorFeatDisabled")),H.DISABLED;const t=this.item.system.quantity;return void 0!==t&&t<=0?(ui.notifications.warn(game.i18n.localize("FFD20.ErrorNoQuantity")),H.INSUFFICIENT_QUANTITY):this.action.isSelfCharged&&this.action.data.uses.self?.value<1?(ui.notifications.warn(game.i18n.format("FFD20.ErrorInsufficientCharges",{name:`${this.item.name}: ${this.action.name}`})),H.INSUFFICIENT_CHARGES):0}getRollData(){const e=deepClone(this.shared.action.getRollData());return e.d20="1d20"!==this.shared.dice?this.shared.dice:"",e}createAttackDialog(){return new ffd20.applications.AttackDialog(this.shared.action,this.shared.rollData,this.shared).show()}alterRollData(e={}){let t;t=e instanceof jQuery?new FormDataExtended(e[0].querySelector("form")).object:e,t.d20&&(this.shared.rollData.d20=t.d20);const s=t["attack-bonus"];s&&this.shared.attackBonus.push(s);const n=t["damage-bonus"];n&&this.shared.damageBonus.push(n),t.rollMode&&(this.shared.rollMode=t.rollMode),t["point-blank-shot"]&&(this.shared.attackBonus.push(`1[${game.i18n.localize("FFD20.PointBlankShot")}]`),this.shared.damageBonus.push(`1[${game.i18n.localize("FFD20.PointBlankShot")}]`),this.shared.pointBlankShot=!0),this.shared.fullAttack&&t.manyshot&&(this.shared.manyShot=!0),this.shared.fullAttack&&t["rapid-shot"]&&this.shared.attackBonus.push(`-2[${game.i18n.localize("FFD20.RapidShot")}]`),null!=t["primary-attack"]&&setProperty(this.shared.rollData,"action.naturalAttack.primaryAttack",t["primary-attack"]),null!=t["measure-template"]&&(this.shared.useMeasureTemplate=t["measure-template"]),setProperty(this.shared.rollData,"item.held",t.held??"normal");const l=t["damage-ability-multiplier"];if(null!=l&&(this.shared.rollData.action.ability.damageMult=l),t["power-attack"]){const e=this.shared.rollData.action?.powerAttack?.damageBonus??2;let t=(1+Math.floor(this.shared.rollData.attributes.bab.total/4))*e,s=this.shared.rollData.item?.powerAttack?.multiplier;if(s)s=parseFloat(s);else if(s=1,"natural"===this.item.system.subType)this.shared.rollData.action.naturalAttack?.primaryAttack?this.shared.rollData.action.ability?.damageMult>=1.5&&(s=1.5):s=.5;else{const e=this.shared.rollData.item.held;"2h"===e?s=1.5:"oh"===e&&(s=.5)}t=Math.floor(t*s);const n=["rwak","rsak"].includes(this.action.data.actionType)?game.i18n.localize("FFD20.DeadlyAim"):game.i18n.localize("FFD20.PowerAttack"),l=-(1+Math.floor(getProperty(this.shared.rollData,"attributes.bab.total")/4));this.shared.rollData.powerAttackPenalty=l,this.shared.attackBonus.push(`${l}[${n}]`),this.shared.powerAttack=!0,this.shared.rollData.powerAttackBonus=t,this.shared.rollData.powerAttackPenalty=l}else this.shared.rollData.powerAttackBonus=0,this.shared.rollData.powerAttackPenalty=0;if(Object.keys(t).forEach((e=>{const s=e.match(/conditional\.(\d+)/)?.[1];s&&t[e]&&(this.shared.conditionals?this.shared.conditionals.push(parseInt(s)):this.shared.conditionals=[parseInt(s)])})),"natural"===this.shared.rollData.item.subType&&!1===this.shared.rollData.action?.naturalAttack.primaryAttack){const e=this.shared.rollData.action.naturalAttack?.secondary?.attackBonus||"-5";let t=this.shared.rollData.action.naturalAttack?.secondary?.damageMult??.5;l&&(t=l),this.shared.attackBonus.push(`(${e})[${game.i18n.localize("FFD20.SecondaryAttack")}]`),this.shared.rollData.action.ability.damageMult=t}this.shared.casterLevelCheck=t["cl-check"],this.shared.concentrationCheck=t.concentration,!this.shared.conditionals&&foundry.utils.isEmpty(t)&&(this.shared.conditionals=this.shared.action.data.conditionals?.reduce(((e,t,s)=>(t.default&&e.push(s),e)),[]))}generateAttacks(e=!1){const t=this.shared.rollData,s=t.action;let n=1;const l=s.attackName||game.i18n.format("FFD20.FormulaAttack",{0:n}),c=e||this.shared.fullAttack,u=c?s.attackParts.reduce(((e,t)=>(e.push({attackBonus:t[0],label:t[1]||game.i18n.format("FFD20.FormulaAttack",{0:n+=1})}),e)),[{attackBonus:"",label:l}]):[{attackBonus:"",label:l}];if(c){const e=s.formulaicAttacks?.count?.formula,l=RollPF.safeRoll(e,t)?.total??0,c=s.formulaicAttacks?.bonus?.formula||"0";if(l>0)try{for(let e=0;e<l;e++){t.formulaicAttack=e+1;const l=RollPF.safeRoll(c,t).total;delete t.formulaicAttack,u.push({attackBonus:`(${l})[${game.i18n.localize("FFD20.Iterative")}]`,label:s.formulaicAttacks.label?s.formulaicAttacks.label.replace("{0}",e+1):game.i18n.format("FFD20.FormulaAttack",{0:n+=1})})}}catch(e){console.error(e)}}if(s.usesAmmo){const e=this.item.getFlag("ffd20","defaultAmmo"),t=this.item.actor.items.get(e),s=t?.system.quantity??0,n=t?.flags.ffd20?.abundant;for(let t=0;t<u.length;t++){const l=u[t];l.ammo=n||s>=t+1?e:null}}return u}async subtractAmmo(e=1){if(!this.shared.action.data.usesAmmo)return;const t={};for(const e of this.shared.attacks)if(e.ammo){const s=this.item.actor.items.get(e.ammo);if(s.flags?.ffd20?.abundant)continue;t[e.ammo]?t[e.ammo]++:t[e.ammo]=1}if(!foundry.utils.isEmpty(t)){const e=Object.entries(t).reduce(((e,t)=>{const s=this.item.actor.items.get(t[0]).system.quantity,n={_id:t[0],"system.quantity":s-t[1]};return e.push(n),e}),[]);return this.item.actor.updateEmbeddedDocuments("Item",e)}}handleConditionals(){if(this.shared.conditionals){const e={};for(const t of this.shared.conditionals){const s=this.shared.action.data.conditionals[t],n=createTag(s.name);for(const[t,l]of s.modifiers.entries()){const c=RollPF.safeRoll(l.formula,this.shared.rollData);if(c.err){ui.notifications.warn(game.i18n.format("FFD20.WarningConditionalRoll",{number:t+1,name:s.name}));continue}e[[n,t].join(".")]=RollPF.safeRoll(l.formula,this.shared.rollData).total;const u=`${l.target}.${l.subTarget}${l.critical?"."+l.critical:""}`;if(["attack","effect","misc"].includes(l.target)){const e=/\[.*\]/.test(l.formula)?l.formula:`(${l.formula})[${s.name}]`;this.shared.conditionalPartsCommon[u]=[...this.shared.conditionalPartsCommon[u]??[],e]}else"damage"===l.target?this.shared.conditionalPartsCommon[u]=[...this.shared.conditionalPartsCommon[u]??[],[l.formula,l.damageType,!1]]:"size"===l.target&&(this.shared.rollData.size+=c.total)}}this.shared.rollData.conditionals=expandObject(e,5);for(const e of["effect.cl","effect.dc","misc.charges"])if(null!=this.shared.conditionalPartsCommon[e]){const t=this.shared.conditionalPartsCommon[e].join("+"),s=RollPF.safeRoll(t,this.shared.rollData,[e,t]).total;switch(e){case"effect.cl":this.shared.rollData.cl+=s;break;case"effect.dc":this.shared.rollData.dcBonus=s;break;case"misc.charges":this.shared.rollData.chargeCostBonus=s}}}}checkAttackRequirements(){const e=this.shared.action.getChargeCost({rollData:this.shared.rollData})+(this.shared.rollData.chargeCostBonus??0);if(this.shared.rollData.chargeCost=e,0!=e){let t=this.item.charges;if("spell"===this.item.type&&this.item.useSpellPoints()&&(t=this.item.getSpellUses()),e>t)return ui.notifications.warn(game.i18n.format("FFD20.ErrorInsufficientCharges",{name:this.item.name})),H.INSUFFICIENT_CHARGES}return 0}async generateChatAttacks(){this.shared.action.hasAttack?await this.addAttacks():this.shared.action.hasDamage?await this.addDamage():await this.addEffectNotes(),this.shared.attacks.forEach((e=>{if(!e.ammo)return;const t=e.chatAttack;t&&t.setAmmo(e.ammo)})),this.shared.save=this.shared.action.data.save.type,this.shared.saveDC=this.shared.action.getDC(this.shared.rollData)}_getConditionalParts(e,{index:t=0}){const s={},n={"attack.normal":"attack.;id;.normal","attack.crit":"attack.;id;.crit","damage.normal":"damage.;id;.normal","damage.crit":"damage.;id;.crit","damage.nonCrit":"damage.;id;.nonCrit"},addPart=e=>{for(const[t,l]of Object.entries(n)){s[t]||(s[t]=[]);const n=l.replace(";id;",e);s[t].push(...this.shared.conditionalPartsCommon[n]??[])}};return addPart("attack_"+t),addPart("allAttack"),addPart("allDamage"),"rapid-shot"===e.id?(addPart("rapidShotAttack"),addPart("rapidShotDamage")):"haste-attack"===e.id&&(addPart("hasteAttack"),addPart("hasteDamage")),s}async addAttacks(){for(let e=0;e<this.shared.attacks.length;e++){const t=this.shared.attacks[e],s=this._getConditionalParts(t,{index:e});this.shared.rollData.attackCount=e;const n=new ChatAttack(this.shared.action,{label:t.label,rollData:this.shared.rollData,targets:game.user.targets});if("manyshot"!==t.id&&await n.addAttack({extraParts:duplicate(this.shared.attackBonus).concat([t.attackBonus]),conditionalParts:s}),this.shared.action.hasDamage){const e=duplicate(this.shared.damageBonus),l=[],c=[];if(this.shared.rollData.powerAttackBonus>0){const e=["rwak","rsak"].includes(this.shared.action.data.actionType)?game.i18n.localize("FFD20.DeadlyAim"):game.i18n.localize("FFD20.PowerAttack"),t=this.shared.rollData.powerAttackBonus,s=t*(this.shared.rollData.item?.powerAttack?.critMultiplier??1);l.push(`${t}[${e}]`),c.push(`${s}[${e}]`)}let u=null;"manyshot"===t.id&&(u=game.i18n.localize("FFD20.Manyshot")),await n.addDamage({flavor:u,extraParts:[...e,...l],critical:!1,conditionalParts:s}),n.hasCritConfirm&&await n.addDamage({extraParts:[...e,...c],critical:!0,conditionalParts:s})}0===e&&n.addAttackNotes(),"manyshot"!==t.id&&n.addEffectNotes(),this.shared.chatAttacks.push(n),t.chatAttack=n}delete this.shared.rollData.attackCount}async addDamage(){this.shared.conditionalParts={"damage.normal":this.shared.conditionalPartsCommon["damage.allDamage.normal"]??[]};const e=new ChatAttack(this.shared.action,{rollData:this.shared.rollData,primaryAttack:this.shared.primaryAttack});await e.addDamage({extraParts:duplicate(this.shared.damageBonus),critical:!1,conditionalParts:this.shared.conditionalParts}),e.addEffectNotes(),this.shared.chatAttacks.push(e)}addEffectNotes(){const e=new ChatAttack(this.shared.action,{rollData:this.shared.rollData,primaryAttack:this.shared.primaryAttack});e.addEffectNotes(),this.shared.chatAttacks.push(e)}async promptMeasureTemplate(){let e=this.shared.action.data.measureTemplate.size;"string"==typeof e&&(e=RollPF.safeRoll(this.shared.action.data.measureTemplate.size,this.shared.rollData).total),e=convertDistance(e)[0];const t={type:this.shared.action.data.measureTemplate.type,distance:e};this.shared.action.data.measureTemplate.overrideColor&&(t.color=this.shared.action.data.measureTemplate.customColor),this.shared.action.data.measureTemplate.overrideTexture&&(t.texture=this.shared.action.data.measureTemplate.customTexture),this.shared.template=null;const s=ffd20.canvas.AbilityTemplate.fromData(t);let n;if(s){const e=this.item.actor?.sheet,t=null!=e?._element;if(t&&e.minimize(),n=await s.drawPreview(this.shared.event),!n.result)return t&&e.maximize(),n}return this.shared.template=await n.place(),n}async handleDiceSoNice(){if(null!=game.dice3d&&game.dice3d.isEnabled())try{const e={};ChatMessage.applyRollMode(e,this.shared.rollMode);const t=game.settings.get("dice-so-nice","enabledSimultaneousRolls"),s=game.settings.get("dice-so-nice","immediatelyDisplayChatMessages"),showRoll=async s=>{const n=e.whisper?.length?e.whisper:void 0;if(t)return Promise.all(s.map((t=>game.dice3d.showForRoll(t,game.user,!0,n,e.blind))));for(const t of s)await game.dice3d.showForRoll(t,game.user,!0,n,e.blind)},n=[];for(const e of this.shared.chatAttacks){const t=new PoolTerm;e.attack&&t.rolls.push(e.attack),t.rolls.push(...e.damage?.rolls??[]);const s=new PoolTerm;e.hasCritConfirm&&s.rolls.push(e.critConfirm),s.rolls.push(...e.critDamage?.rolls??[]),t.rolls.length&&n.push(t),s.rolls.length&&n.push(s)}n.length&&(s?showRoll(n):await showRoll(n))}catch(e){console.error(e)}}getMessageData(){if(0===this.shared.chatAttacks.length)return;this.shared.templateData={action:this.shared.action,name:this.item.name,type:CONST.CHAT_MESSAGE_TYPES.OTHER,rollMode:this.shared.rollMode,attacks:this.shared.chatAttacks.map((e=>e.finalize()))};const e=this.item.actor,t=this.token??e.token;this.shared.chatData={speaker:ChatMessage.implementation.getSpeaker({actor:e,token:t,alias:t?.name}),rollMode:this.shared.rollMode},this.shared.action.data.soundEffect?this.shared.chatData.sound=this.shared.action.data.soundEffect:null!=game.dice3d&&game.dice3d.isEnabled()||(this.shared.chatData.sound=CONFIG.sounds.dice);const s=[];let n="";this.shared.templateData.attacks.length>0&&(n=this.shared.templateData.attacks[0].attackNotesHTML);const l=this.item.getChatData({rollData:this.shared.rollData},{actionId:this.shared.action.id,chatcard:!0}),c=[...l.properties,...this.addGenericPropertyLabels()];if(c.length>0&&s.push({header:game.i18n.localize("FFD20.InfoShort"),value:c}),game.combat){const e=this.addCombatPropertyLabels();e.length>0&&s.push({header:game.i18n.localize("FFD20.CombatInfo_Header"),value:e,css:"combat-properties"})}if("spell"===this.item.type&&e){const t=e.getContextNotesParsed("spell.cl."+this.item.system.spellbook);t.length&&s.push({header:game.i18n.localize("FFD20.CLNotes"),value:t})}const u=!!(this.shared.rollData.item?.identified??!0),d=u?`${this.item.name} (${this.shared.action.name})`:this.item.getName(!0);this.shared.templateData=mergeObject(this.shared.templateData,{tokenUuid:t?t.document?.uuid??t.uuid:null,actionId:this.shared.action?.id,extraText:n,identified:u,name:d,description:u?l.identifiedDescription:l.unidentifiedDescription,actionDescription:l.actionDescription,hasExtraText:n.length>0,properties:s,hasProperties:s.length>0,item:this.item.toObject(),actor:e,token:t,hasSave:this.shared.action.hasSave,rollData:this.shared.rollData,save:{dc:this.shared.saveDC,type:this.shared.save,label:game.i18n.format("FFD20.SavingThrowButtonLabel",{type:ffd20.config.savingThrows[this.shared.save],dc:this.shared.saveDC.toString()}),gmSensitiveLabel:game.i18n.format("FFD20.SavingThrowButtonLabelGMSensitive",{save:ffd20.config.savingThrows[this.shared.save]})}},{inplace:!1});{const e=this.shared.action.getRange({type:"max",rollData:this.shared.rollData});if(null!=e){this.shared.templateData.range=e;const t=getDistanceSystem();this.shared.templateData.rangeLabel="metric"===t?e+" m":e+" ft.";const s=this.shared.action.data.range.units;["melee","touch","reach","close","medium","long"].includes(s)&&(this.shared.templateData.rangeLabel=ffd20.config.distanceUnits[s])}}if("spell"===this.item.type&&e){if(e.spellFailure>0&&this.item.system.components.somatic){const t=getProperty(e.system,"attributes.spells.spellbooks."+this.item.system.spellbook);if(t&&t.arcaneSpellFailure){const t=RollPF.safeRoll("1d100");this.shared.templateData.spellFailure=t.total,this.shared.templateData.spellFailureRoll=t,this.shared.templateData.spellFailureSuccess=this.shared.templateData.spellFailure>e.spellFailure}}this.shared.templateData.casterLevelCheck=this.shared.casterLevelCheck,this.shared.templateData.concentrationCheck=this.shared.concentrationCheck}const m=this.generateChatMetadata();if(!game.settings.get("ffd20","disableAttackCardTargets")){const e=m.targets?.length?m.targets.map((e=>canvas.tokens.get(e))).filter((e=>null!=e)):[];e.length&&(this.shared.templateData.targets=e.map((e=>({img:e.document.texture.src,actorData:e.actor?.toObject(!1),tokenData:e.document.toObject(!1),uuid:e.document.uuid}))))}this.shared.chatData["flags.ffd20.metadata"]=m,this.shared.chatData["flags.core.canPopout"]=!0,u||(this.shared.chatData["flags.ffd20.identifiedInfo"]={identified:u,name:this.item._source.name||this.item.name,description:l.identifiedDescription,actionName:this.shared.action.name,actionDescription:l.actionDescription})}addGenericPropertyLabels(){const e=[],t=this.shared.rollData.chargeCost;return t&&!this.item.system.atWill&&("spell"===this.item.type&&this.item.useSpellPoints()?e.push(`${game.i18n.localize("FFD20.SpellPointsCost")}: ${t}`):e.push(`${game.i18n.localize("FFD20.ChargeCost")}: ${t}`)),this.item.system.broken&&e.push(game.i18n.localize("FFD20.Broken")),this.action.data.nonlethal&&e.push(game.i18n.localize("FFD20.Nonlethal")),this.action.data.touch&&e.push(game.i18n.localize("FFD20.TouchAttackShort")),this.shared.powerAttack&&("rwak"===this.action.data.actionType&&e.push(game.i18n.localize("FFD20.DeadlyAim")),"mwak"===this.action.data.actionType&&e.push(game.i18n.localize("FFD20.PowerAttack"))),this.shared.pointBlankShot&&e.push(game.i18n.localize("FFD20.PointBlankShot")),this.shared.attacks.find((e=>"rapid-shot"===e.id))&&e.push(game.i18n.localize("FFD20.RapidShot")),this.shared.manyShot&&e.push(game.i18n.localize("FFD20.Manyshot")),this.item.hasAttack&&this.shared.rollData.attributes.acp.attackPenalty>0&&e.push(game.i18n.localize("FFD20.ArmorCheckPenalty")),this.shared.conditionals?.length&&this.shared.conditionals.forEach((t=>{e.push(this.shared.action.data.conditionals[t].name)})),this.shared.rollData.attributes.woundThresholds.level>0&&e.push(game.i18n.localize(ffd20.config.woundThresholdConditions[this.shared.rollData.attributes.woundThresholds.level])),e}addCombatPropertyLabels(){const e=[];return e.push(game.i18n.format("FFD20.CombatInfo_Round",{round:game.combat.round})),e}generateChatMetadata(){const e={};e.item=this.item.id,e.action=this.action.id,e.template=this.shared.template?this.shared.template.id:null,e.rolls={attacks:[]};const t=canvas.scene?canvas.templates.get(e.template):null;e.targets=null!=t?t.getTokensWithin().filter((e=>!0!==e.combatant?.isDefeated)).map((e=>e.id)):Array.from(game.user.targets).map((e=>e.id));for(let t=0;t<this.shared.chatAttacks.length;t++){const s=this.shared.chatAttacks[t],n={attack:null,damage:[],critConfirm:null,critDamage:[]};if(s.attack&&(n.attack=s.attack.toJSON()),s.damage.rolls.length)for(let e=0;e<s.damage.rolls.length;e++){const t=s.damage.rolls[e];n.damage[e]=t.toJSON()}if(s.critConfirm&&(n.critConfirm=s.critConfirm.toJSON()),s.critDamage.rolls.length)for(let e=0;e<s.critDamage.rolls.length;e++){const t=s.critDamage.rolls[e];n.critDamage[e]=t.toJSON()}e.rolls.attacks[t]=n}return this.shared.saveDC&&(e.save={dc:this.shared.saveDC,type:this.shared.save}),"spell"===this.item.type&&(e.spell={cl:this.shared.rollData.cl,sl:this.shared.rollData.sl}),e}async executeScriptCalls(){this.shared.scriptData=await this.item.executeScriptCalls("use",{attackData:this.shared})}async postMessage(){if(this.shared.event,this.shared.skipDialog,this.shared.chatData,this.shared.templateData,this.shared,this.shared.chatTemplate||="systems/ffd20/templates/chat/attack-roll.hbs",this.shared.templateData.damageTypes=ffd20.registry.damageTypes.toObject(),!1===Hooks.call("pf1PreDisplayActionUse",this))return;let e;return e=this.shared.chatAttacks.length>0?this.shared.chatMessage&&!0!==this.shared.scriptData.hideChat?await createCustomChatMessage(this.shared.chatTemplate,this.shared.templateData,this.shared.chatData):this.shared:this.shared.chatMessage&&!0!==this.shared.scriptData.hideChat?this.item.roll():{descriptionOnly:!0},e}}class ItemPF extends Item{constructor(...e){super(...e),void 0===this.links&&(this.links={}),void 0===this._rollData&&(this._rollData=null),void 0===this.actions&&this.actions instanceof Array&&(this.actions=new Collection)}static system=Object.freeze({isPhysical:!1});static isInventoryItem(e){return foundry.utils.logCompatibilityWarning("ItemPF.isInventoryItem is deprecated. Use ItemPF.isPhysical instead.",{since:"PF1 v9",until:"PF1 v10"}),CONFIG.Item.documentClasses[e]?.isPhysical??!1}async _preCreate(e,t,s){if(await super._preCreate(e,t,s),void 0===e.img||e.img===Item.DEFAULT_ICON){const e=ffd20.config.defaultIcons.items[this.type];e&&this.updateSource({img:e})}const n=this.actor;if(n&&e?.system?.changes?.length>0){const t=e.system.changes;let s=!1;for(const e of t){let t=0;for(;!(void 0===n.changes.get(e._id)&&e._id||(s=!0,t>1e4));)t++>1e3?e._id=foundry.utils.randomID():e._id=ItemChange.defaultData._id}s&&this.updateSource({"system.changes":t})}const l=this.preCreateData(e,t,s);if(Object.keys(l).length)return this.updateSource(l)}preCreateData(e,t,s){return{}}async _preUpdate(e,t,s){await super._preUpdate(e,t,s),e.system&&await this._chargePreUpdate(e,t)}async _chargePreUpdate(e,t){const s=e.system.uses;if(s?.value&&this.isCharged){const n=this.maxCharges;s.value>n&&(s.value=n);const l=this.links.charges;l&&(await l.update({"system.uses.value":s.value},t),delete e.system.uses.value)}}get memoryVariables(){return["quantity","level","inventoryItems"]}static get isPhysical(){return this.system.isPhysical}get isPhysical(){return this.constructor.isPhysical}get subType(){return this.system.subType??null}get firstAction(){return this.actions?.get(this.system.actions?.[0]?._id)}get hasAttack(){return this.actions?.some((e=>e.hasAttack))??!1}get hasDamage(){return this.actions?.some((e=>e.hasDamage))??!1}get isOwned(){return super.isOwned||null!=this.parentItem}get isActive(){return!0}get hasAction(){return this.system.actions?.length>0}get isSingleUse(){return"single"===this.system.uses?.per}get isCharged(){return this.isSingleUse||["day","week","charges"].includes(this.system.uses?.per)}get charges(){if(!this.actor)return 0;const e=this.links?.charges;return e?e.charges:this.isSingleUse?this.system.quantity:this.system.uses?.value??0}get autoDeductCharges(){return this.getDefaultChargeCost()>0}getDefaultChargeCost({rollData:e}={}){e??=this.getRollData();const t=this.getDefaultChargeFormula();return RollPF.safeRoll(t,e).total}getDefaultChargeFormula(){return this.system.uses?.autoDeductChargesCost||"1"}get maxCharges(){const e=this.links?.charges;return e?e.maxCharges:this.isSingleUse?this.system.quantity:this.system.uses?.max??0}async recharge({value:e,period:t="day",exact:s=!1,maximize:n=!1,commit:l=!0,rollData:c,context:u}={}){const d=this.system;if(!d.uses?.per)return;if(this.links.charges)return;if("week"!==t||s){if(d.uses.per!==t&&"any"!==t)return}else if(!["day","week"].includes(d.uses.per))return;const m={system:{uses:{}}};if(!(void 0!==e)){const t=d.uses?.rechargeFormula||"";if(t){c??=this.getRollData();if(e=RollPF.safeRoll(t,c,"recharge").total,!Number.isFinite(e))return}else n=!0}return n&&(e=d.uses.max),(e=Math.clamped(e,0,d.uses.max))!==d.uses.value?(m.system.uses.value=e,l?this.update(m,u):m):void 0}get totalDurationSeconds(){return this.system.duration?.totalSeconds??null}get auraStrength(){const e=this.system.cl||0;return e<1?0:e<6?1:e<12?2:e<21?3:4}get parentActor(){return foundry.utils.logCompatibilityWarning("ItemPF.parentActor is deprecated in favor of Item.actor",{since:"PF1 v9",until:"PF1 v11"}),this.actor}get limited(){return this.parentItem?this.parentItem.limited:super.limited}getName(e=!1){return game.user.isGM&&e&&!1===this.system.identified&&this.system.unidentified?.name||this.name}testUserPermission(e,t,{exact:s=!1}={}){return this.actor?this.actor.testUserPermission(e,t,{exact:s}):this.parentItem?this.parentItem.testUserPermission(e,t,{exact:s}):super.testUserPermission(e,t,{exact:s})}get permission(){return this.actor?this.actor.permission:super.permission}get fullDescription(){return this.system.description.value}getDescription(e){return this.system.description.value}get effect(){return this.actor.effects.find((e=>!!e.origin&&/\.Item\.(?<itemId>[^.]+)/.exec(e.origin)?.groups.itemId===this.id))}get actionTypes(){const e=this.actions?.map((e=>e.data.actionType)).filter(Boolean)??[];return[...new Set(e)]}static get defaultContextNote(){return{text:"",subTarget:""}}async addCharges(e){const t=this.links.charges;if(t)return t.addCharges(e);if("single"===this.system.uses?.per&&null==this.system.quantity)return;const s=this.isSingleUse?this.system.quantity:this.system.uses?.value;return this.isSingleUse?this.update({"system.quantity":s+e}):this.update({"system.uses.value":s+e})}get defaultAmmo(){const e=this.getFlag("ffd20","defaultAmmo");return this.actor?.items.get(e)}get showUnidentifiedData(){return!game.user.isGM&&!1===this.system.identified}prepareWeight(){if(!this.isPhysical)return;const e=this.system;{const t=e.weight;if(void 0===t||Number.isFinite(t)){const t=this._source.system,s=t.baseWeight??t.weight??0;e.weight={value:s}}}const t=e.weight;t.value??=0,t.total??=0;const s=(100-(e.weightReduction??0))/100;t.total=(this.items??[]).reduce(((e,t)=>e+t.system.weight.total*s),t.value*e.quantity),t.currency??=0,t.total+=t.currency,t.converted={value:ffd20.utils.convertWeight(t.value),total:ffd20.utils.convertWeight(t.total)}}prepareDerivedData(){super.prepareDerivedData(),this.prepareLinks();const e=this.system;e.changes instanceof Array&&(this.changes=this._prepareChanges(e.changes)),e.actions instanceof Array&&(this.actions=this._prepareActions(e.actions)),e.scriptCalls instanceof Array&&(this.scriptCalls=this._prepareScriptCalls(e.scriptCalls)),this.prepareWeight(),this.actor||this.prepareDerivedItemData(),this.isPhysical&&this.showUnidentifiedData&&(this.system.description.value=this.system.description.unidentified)}prepareBaseData(){this.showUnidentifiedData?this.name=this.system.unidentified?.name||this._source.name:this.name=this._source.name;const e=this.system,t=game.system.template.Item,s=t.types.filter((e=>t[e].templates?.includes("tagged")));!0!==e.useCustomTag&&s.includes(this.type)&&(e.tag=createTag(this.name))}prepareDerivedItemData(){this._updateMaxUses()}getLabels({actionId:e,rollData:t}={}){const s={},n=this.system,l='<i class="fas fa-check"></i>',c='<i class="fas fa-times"></i>';s.equipped="",!0===n.equipped?s.equipped=l:s.equipped=c,s.carried="",!0===n.carried?s.carried=l:s.carried=c,s.identified="",!0===n.identified?s.identified=l:s.identified=c,this.hasSlots&&(s.slot=ffd20.config.equipmentSlots.wondrous[n.slot]??null);const u=e?this.actions.get(e):this.firstAction;return{...s,...u?.getLabels({rollData:t})??{}}}prepareLinks(){if(this.links)for(const[e,t]of Object.entries(this.links))if("charges"===e){if(!t.getLinkedItemsSync("charges").some((e=>e.id===this.id))){delete this.links.charges;continue}const e=t.system.uses;if(!e)break;for(const[t,s]of Object.entries(e))["autoDeductCharges","autoDeductChargesCost"].includes(t)||(this.system.uses[t]=s)}}_prepareChanges(e){const t=this.changes,s=new Collection;for(const n of e){let e=null;t&&t.has(n._id)?(e=t.get(n._id),e.data=mergeObject(ItemChange.defaultData,n),e.prepareData()):e=new ffd20.components.ItemChange(n,this),s.set(n._id||e.data._id,e)}return s}_prepareActions(e){const t=this.actions,s=new Collection;for(const n of e){let e=null;t&&t.has(n._id)?(e=t.get(n._id),e.data=mergeObject(ItemAction.defaultData,n),e.prepareData()):e=new ffd20.components.ItemAction(n,this),s.set(n._id||e.data._id,e)}return s}_prepareScriptCalls(e){const t=this.scriptCalls,s=new Collection;for(const n of e){let e=null;t&&t.has(n.id)?(e=t.get(n.id),e.data=n):e=new ffd20.components.ItemScriptCall(n,this),s.set(n._id||e.data._id,e)}return s}_prepareInventory(e){const t=this.items,s=new Collection;for(const n of e){let e=null;t&&t.has(n._id)?(e=t.get(n._id),e.updateSource(n),e.reset()):(e=new Item.implementation(n,{parent:this.actor}),e.parentItem=this),s.set(n._id||e.id,e)}return s}async executeScriptCalls(e,t={}){const s=this.scriptCalls?.filter((t=>t.category===e))??[],n={};t.attackData&&(n.attackData=t.attackData,delete t.attackData);for(const e of s)await e.execute(n,t);return n}async update(e,t={}){if(!1===t.recursive)return super.update(e,t);e=expandObject(e);const s=["system.attackNotes","system.effectNotes","system.contextNotes","system.scriptCalls","system.actions","system.inventoryItems","system.changes"];for(const t of s)keepUpdateArray(this,e,t);this.memorizeVariables();const n=diffObject(this.toObject(),e);if(Object.keys(n).length){const e=this.parentItem;if(null==e)return super.update(n,t);{const t=(e.system.inventoryItems||[]).findIndex((e=>e._id===this.id));if(t>=0){for(const[e,s]of Object.entries(n))delete n[e],n[`system.inventoryItems.${t}.${e}`]=s;return e.update(n)}}}}memorizeVariables(){if(null!=this._memoryVariables)return;const e=this.memoryVariables;this._memoryVariables={};for(const t of e)hasProperty(this.system,t)&&(this._memoryVariables[t]=deepClone(getProperty(this.system,t)));for(const e of this.items??[])e.memorizeVariables()}_onUpdate(e,t,s){if(super._onUpdate(e,t,s),s===game.user.id){{let t=null;"buff"===this.type?t=e.system?.active:"feat"===this.type&&void 0!==e.system?.disabled&&(t=!0!==e.system.disabled),null!=t&&this.executeScriptCalls("toggle",{state:t})}{const t=e.system?.equipped;null!=t&&this.executeScriptCalls("equip",{equipped:t})}const t=this._memoryVariables?.quantity;if(void 0!==t){const e={previous:t,new:this.system.quantity};null!=e.new&&e.new!==e.previous&&this.executeScriptCalls("changeQuantity",{quantity:e})}const s=this._memoryVariables?.level;if(void 0!==s&&void 0!==e.system?.level){const e={previous:parseInt(s),new:parseInt(this.system.level)};for(const[t,s]of Object.entries(e))Number.isNaN(s)&&(e[t]=null);void 0!==e.new&&e.new!==e.previous&&this.executeScriptCalls("changeLevel",{level:e})}}for(let n=0;n<(e.system?.inventoryItems??[]).length;n++){const l=e.system?.inventoryItems[n],c=this._memoryVariables?.inventoryItems?.[n];if(!c)continue;const u=diffObjectAndArray(c,l,{keepLength:!0});if(!foundry.utils.isEmpty(u)){this.items.get(c._id)._onUpdate(u,t,s)}}this._memoryVariables=null}_updateMaxUses(){if(!["day","week","charges"].includes(this.system.uses?.per))return;const e=this.getRollData();if(this.system.uses){const t=this.system.uses.maxFormula;if(t)if(formulaHasDice(t)){const e=game.i18n.format("FFD20.WarningNoDiceAllowedInFormula",{formula:t,context:game.i18n.localize("FFD20.ChargePlural")});ui.notifications.warn(e,{console:!1}),console.warn(e,this)}else{const s=RollPF.safeRoll(t,e);this.system.uses.max=s.total}else this.system.uses.max=0}}getRawEffectData(){return{label:this.name,icon:this.img,origin:this.uuid,flags:{ffd20:{origin:{item:this.id}}},disabled:!this.isActive,duration:{}}}getScriptCalls(e){return this.scriptCalls?.filter((t=>t.category===e))??[]}async displayCard(e={},{token:t}={}){const s=this.actor;if(s&&!s.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:s.name}));t??=s?.token;const n=this.getRollData(),l=this.getChatData({rollData:n}),c=!!(n.item?.identified??!0),u={actor:this.actor,token:t,tokenId:t?.uuid,item:this.toObject(),labels:this.getLabels({rollData:n}),hasAttack:this.hasAttack,hasMultiAttack:this.hasMultiAttack,hasAction:this.hasAction,isVersatile:this.isVersatile,isSpell:"spell"===this.type,name:this.getName(!0),description:c?l.identifiedDescription:l.unidentifiedDescription,rollData:n,hasExtraProperties:!1,extraProperties:[]},d={};if(!1===c&&(d.identifiedInfo={identified:c,name:this._source.name,description:l.identifiedDescription}),game.combat){const e=[];e.push(game.i18n.format("FFD20.CombatInfo_Round",{round:game.combat.round})),e.length>0&&(u.extraProperties.push({header:game.i18n.localize("FFD20.CombatInfo_Header"),value:e,css:"combat-properties"}),u.hasExtraProperties=!0)}const m=`systems/ffd20/templates/chat/${["consumable"].includes(this.type)?this.type:"item"}-card.hbs`;d.metadata={},d.metadata.item=this.id;const h=mergeObject({user:game.user.id,type:CONST.CHAT_MESSAGE_TYPES.OTHER,speaker:ChatMessage.implementation.getSpeaker({actor:s,token:t,alias:t?.name}),flags:{core:{canPopout:!0},ffd20:d}},e);return!1!==Hooks.call("pf1DisplayCard",this,{template:m,templateData:u,chatData:h})?createCustomChatMessage(m,u,h):void 0}getChatData(e={},t={}){const s={},{actionId:n=null}=t,l=n?this.actions.get(n):this.firstAction;e.rollData??=l?l.getRollData():this.getRollData();const c=this.getLabels({actionId:n,rollData:e.rollData});e.secrets??=this.isOwner,e.async=!1;const u=e.rollData?.item??this.system,d=e.rollData?.action??l?.data??{},m=this.getDescription({chatcard:t.chatcard});s.identifiedDescription=TextEditor.enrichHTML(m,e),u.shortDescription&&(s.identifiedDescription=`${s.identifiedDescription}${TextEditor.enrichHTML(u.shortDescription,e)}`),s.unidentifiedDescription=TextEditor.enrichHTML(u.description.unidentified,e),s.description=this.showUnidentifiedData?s.unidentifiedDescription:s.identifiedDescription,s.actionDescription=TextEditor.enrichHTML(d.description,e);const h=[];if(Object.prototype.hasOwnProperty.call(u,"equipped")&&["weapon","equipment"].includes(this.type)&&h.push(u.equipped?game.i18n.localize("FFD20.Equipped"):game.i18n.localize("FFD20.NotEquipped")),!this.showUnidentifiedData){const t={};if(t.range=c.range||"",t.level=c.sl||"",null!=d.range){const s=l.getRange({type:"max",rollData:e.rollData}),n="mi"===d.range.units?"mi":"ft",c=convertDistance(s,n);t.range=s>0?game.i18n.format("FFD20.RangeNote",{distance:s,units:c[1]}):null}h.push(c.save);const s=d.save?.description;if(s?.length>0&&h.push(s),null!=d.duration&&!["inst","perm"].includes(d.duration.units)&&"string"==typeof d.duration.value){const s=RollPF.safeRoll(d.duration.value||"0",e.rollData).total;t.duration=[s,ffd20.config.timePeriods[d.duration.units]].filterJoin(" ")}d.activation?.type&&h.push(c.target,c.activation,t.range,t.duration);const n=d.enh?.value??u.enh??0;n>0&&h.push(game.i18n.format("FFD20.Enhancement",{bonus:n}))}return this.getTypeChatData(s,c,h,e.rollData),s.properties=h.filter((e=>!!e)),s}getTypeChatData(e,t,s,n){this.isCharged&&s.push(`${game.i18n.localize("FFD20.ChargePlural")}: ${this.charges}/${this.maxCharges}`)}async use({actionID:e="",ev:t=null,skipDialog:s=getSkipActionPrompt(),chatMessage:n=!0,dice:l="1d20",rollMode:c,token:u}={}){if(c||=game.settings.get("core","rollMode"),!this.hasAction){const e=await this.executeScriptCalls("use",{attackData:{event:t,skipDialog:s,chatMessage:n,rollMode:c}});if(c=e.rollMode||c,e.reject)return e;if(!0===e.hideChat||!n)return e.descriptionOnly=!0,e;if(await this.displayCard({rollMode:c}),this.isCharged){const e=this.getDefaultChargeCost();if(this.charges<e)return this.isSingleUse?void ui.notifications.warn(game.i18n.localize("FFD20.ErrorNoQuantity")):void ui.notifications.warn(game.i18n.format("FFD20.ErrorInsufficientCharges",{name:this.name}));await this.addCharges(-e)}return e}let d;if(t&&t.originalEvent&&(t=t.originalEvent),!(this.system.actions.length>0))return void console.error("This item does not have an action associated with it.");if(e)d=this.actions.get(e);else{if(this.system.actions.length>1&&!0!==s)return void new ffd20.applications.ActionChooser(this).render(!0,{focus:!0});d=this.firstAction}const m={event:t,rollData:{},skipDialog:s,chatMessage:n,dice:l,fullAttack:!0,attackBonus:[],damageBonus:[],attacks:[],chatAttacks:[],rollMode:c,useMeasureTemplate:d.hasTemplate&&game.settings.get("ffd20","placeMeasureTemplateOnQuickRolls"),conditionals:null,conditionalPartsCommon:{},casterLevelCheck:!1,concentrationCheck:!1,scriptData:{}};Object.defineProperties(m,{action:{value:d,writable:!1,enumerable:!0},item:{value:this,writable:!1,enumerable:!0},token:{value:u,writable:!1,enumerable:!0}});const h=new ActionUse(m);let g,y,b=await h.checkRequirements();if(b>0)return{err:ffd20.actionUse.ERR_REQUIREMENT,code:b};if(m.rollData=await h.getRollData(),s)m.attacks=await h.generateAttacks(),await h.alterRollData();else{const e=await h.createAttackDialog();if("object"!=typeof e)return;m.fullAttack=e.fullAttack,m.attacks=e.attacks,await h.alterRollData(e.html)}if(m.action.data.usesAmmo&&(m.attacks=m.attacks.filter((e=>null!=e.ammo)),0===m.attacks.length))ui.notifications.error(game.i18n.localize("FFD20.AmmoDepleted"));else{if(m.fullAttack||(m.attacks=m.attacks.slice(0,1)),await h.handleConditionals(),b=await h.checkAttackRequirements(),b>0)return{err:ffd20.actionUse.ERR_REQUIREMENT,code:b};if(await h.generateChatAttacks(),!m.useMeasureTemplate||!canvas.scene||(g=await h.promptMeasureTemplate(),g.result))if(!1!==Hooks.call("pf1PreActionUse",h)){if(await h.executeScriptCalls(),!m.scriptData?.reject)return await h.handleDiceSoNice(),await h.subtractAmmo(),(m.rollData.chargeCost<0||m.rollData.chargeCost>0)&&await this.addCharges(-m.rollData.chargeCost),m.action.isSelfCharged&&await m.action.update({"uses.self.value":m.action.data.uses.self.value-1}),h.getMessageData(),!0!==m.scriptData?.hideChat&&(y=await h.postMessage()),game.settings.get("ffd20","clearTargetsAfterAttack")&&game.user.targets.size&&(game.user.updateTokenTargets([]),game.user.broadcastActivity({targets:[]})),y;await(g?.delete())}else await(g?.delete())}}getContextChanges(e="attack"){let t=this.actor.changes;switch(e){case"mattack":case"rattack":{const s=["attack",e];t=t.filter((e=>!!s.includes(e.subTarget)));break}case"wdamage":case"sdamage":{const s=["damage",e];t=t.filter((e=>!!s.includes(e.subTarget)));break}case"damage":t=t.filter((e=>"damage"===e.subTarget))}return t}getRollData(){const e=this.actor,t=e?.getRollData()??{};return t.item=deepClone(this.system),this.system.tag&&(t.item.dFlags=getProperty(t,"dFlags."+this.system.tag)),setProperty(t,"item.auraStrength",this.auraStrength),t.dc=this.hasSave?this.getDC(t):0,this._rollData=t.item,Hooks.events.pf1GetRollData?.length>0&&Hooks.callAll("pf1GetRollData",this,t),t}static chatListeners(e){e.on("click",".card-buttons button, .inline-action",this._onChatCardButton.bind(this)),e.on("click",".item-name",this._onChatCardToggleContent.bind(this))}static async _onChatCardButton(e){e.preventDefault();const t=e.currentTarget;t.disabled=!0;const s=t.closest(".chat-card"),n=s.closest(".message").dataset.messageId,l=game.messages.get(n),c=t.dataset.action;if(!(["save","applyDamage"].includes(c)||game.user.isGM||l.isAuthor))return;const u=await this._getChatCardActor(s);if(!u)return void("applyDamage"===c&&(await this._onChatCardAction(c,{button:t}),t.disabled=!1));const d=u.items.get(s.dataset.itemId);await this._onChatCardAction(c,{button:t,item:d})||(t.disabled=!1)}static async _onChatCardAction(e,{button:t=null,item:s=null}={}){if("applyDamage"===e){let e=[...t.closest(".chat-message")?.querySelectorAll(".tag")??[]].map((e=>e.innerText)).includes(game.i18n.localize("FFD20.Nonlethal"));t.dataset.tags?.split(" ").includes("nonlethal")&&(e=!0);const s=t.dataset.value;isNaN(parseInt(s))||Actor.implementation.applyDamage(parseInt(s),{asNonlethal:e})}else{if(["recoverAmmo","forceRecoverAmmo"].includes(e)){if(!s)return;if(!s.isOwner)return;const n=t.closest(".chat-attack").dataset.index,l=game.messages.get(t.closest(".chat-message").dataset.messageId),c=t.closest(".ammo")?.dataset.ammoId||t.dataset.ammoId,u=l.getFlag("ffd20","ammoRecovery"),d=u?.[n]?.[c];if(d?.failed||d?.recovered)return;let m=!1,h=!1;const g=[],y=s.actor.items.get(c);if(!y)return;if(y.getFlag("ffd20","abundant"))return;let b=100;return"recoverAmmo"===e&&(b=y.system.recoverChance??50),b>=100*Math.random()?(m=!0,g.push(y.addCharges(1))):h=!0,(m||h)&&n&&g.push(l.setFlag("ffd20","ammoRecovery",{[n]:{[c]:{failed:h,recovered:m}}})),await Promise.all(g),!0}"concentration"===e?s.actor.rollConcentration(s.system.spellbook):"caster-level-check"===e&&s.actor.rollCL(s.system.spellbook)}return!1}static _onChatCardToggleContent(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".chat-card").querySelector(".card-content");s.style.display="none"===s.style.display?"block":"none";const n=t.closest(".chat-popout");n&&(n.style.height="auto")}static async _getChatCardActor(e){const t=e.dataset.tokenId;if(t)return(await fromUuid(t))?.actor;const s=e.dataset.actorId;return game.actors.get(s)||null}canCreateItemLink(e,t,s,n){const l=this.actor,c=l&&s.actor&&s.actor.id===l.id;if(n===this.id)return!1;if((this.system.links?.[e]||[]).some((e=>e.id===n||e.uuid===n)))return!1;const u=s.system.links?.[e]??[];if(["children","charges","ammunition"].includes(e)&&c){if("charges"===e){if(u.length>0)return ui.notifications.warn(game.i18n.format("FFD20.WarningCannotCreateChargeLink",{source:this.name,target:s.name})),!1;if(null!=s.links.charges)return ui.notifications.warn(game.i18n.format("FFD20.WarningCannotCreateChargeLink2",{source:this.name,target:s.name,deeptarget:s.links.charges.name})),!1}return!0}return"classAssociations"===e&&"compendium"===t}generateInitialLinkData(e,t,s,n){const l={name:s.name};return"data"===t?l.id=n:l.uuid=n,"classAssociations"===e&&(l.level=1),l}async createItemLink(e,t,s,n){if(this.canCreateItemLink(e,t,s,n)){const l=this.generateInitialLinkData(e,t,s,n),c=this.toObject(),u=c.system.links?.[e]??[];u.push(l);const d={["system.links."+e]:u};return await this.update(d),Hooks.callAll("pf1CreateItemLink",this,l,e),!0}if("children"===e&&"data"!==t){const e=s.toObject();delete e._id,"spell"===e.type&&(e.system.spellbook="spelllike");const t=await this.actor.createEmbeddedDocuments("Item",[e]);await this.createItemLink("children","data",t,t._id)}return!1}async getLinkedItems(e,t=!1){const s=this.system.links?.[e];if(!s)return[];const n=[];for(const e of s){const s=await this.getLinkItem(e,t);s&&n.push(s)}return n}getLinkedItemsSync(e){const t=this.system.links?.[e];if(!t)return[];const s=[];for(const e of t){const t=this.getLinkedItemSync(e);t&&s.push(t)}return s}async getAllLinkedItems(){const e=[];for(const t of Object.values(this.system.links??{}))for(const s of t){const t=await this.getLinkItem(s);t&&e.push(t)}return e}async removeItemLink(e){const t={};for(const[s,n]of Object.entries(this.system.links??{})){const l=deepClone(n),c=l.findIndex((t=>t.id===e||t.uuid===e));c>=0&&(l.splice(c,1),t["system.links."+s]=l)}if(!foundry.utils.isEmpty(t))return this.update(t)}async getLinkItem(e,t=!1){let s;return s=e.uuid?await fromUuid(e.uuid):this.actor?.items?.get(e.id),t&&(s={item:s,linkData:e}),s}getLinkedItemSync(e={}){const{id:t,uuid:s}=e,n=this.actor;return s?fromUuidSync(s,n):n?.items.get(t)}getChangeSubTargets(e){const t={};if("skill"===e)if(this.actor){const e=mergeObject(duplicate(ffd20.config.skills),this.actor.system.skills);for(const[s,n]of Object.entries(e))if(n.subSkills)for(const[e,l]of Object.entries(n.subSkills))t[`skill.${s}.subSkills.${e}`]=`${ffd20.config.skills[s]} (${l.name})`;else n.custom?t["skill."+s]=n.name:t["skill."+s]=ffd20.config.skills[s]}else for(const[e,s]of Object.entries(ffd20.config.skills))t["skill."+e]=s;else if(hasProperty(ffd20.config.buffTargets,e))for(const[s,n]of Object.entries(ffd20.config.buffTargets[e]))s.startsWith("_")||s.startsWith("~")||(t[s]=n);return t}async addChange(){return new ItemChange({},this)}getTotalCurrency(){return foundry.utils.logCompatibilityWarning("ItemPF.getTotalCurrency is deprecated",{since:"PF1 v9",until:"PF1 v10"}),0}getValue({recursive:e=!0,sellValue:t=.5,inLowestDenomination:s=!1,forceUnidentified:n=!1}={}){let l=0;const c=this.system.quantity||0;return l+=((e=!0)=>{let t=0;return t=e?this.system.price:this.system.unidentified.price,e&&(t+=(this.system.uses?.pricePerUse??0)*(this.system.uses?.value??0)),s&&(t*=100),this.system.broken&&(t*=.75),t})(!n&&!this.showUnidentifiedData)*c,"loot"===this.type&&"tradeGoods"===this.system.subType||(l*=t),l}convertCurrency(e="pgil"){return foundry.utils.logCompatibilityWarning("ItemPF.convertCurrency is deprecated",{since:"PF1 v9",until:"PF1 v10"}),0}async addItemBooleanFlag(e,t={}){e=(e+"").replace(/[^\w_-]/g,"-").replace(/^-+/,"_");const s=this.system.flags?.boolean??{};if(Array.isArray(s))throw Error(`${this.name} [${this.id}] requires migration.`);return void 0===s[e]&&(await this.update({["system.flags.boolean."+e]:!0},t),!0)}async removeItemBooleanFlag(e,t={}){return void 0!==(this.system.flags?.boolean??{})[e]&&(await this.update({["system.flags.boolean.-="+e]:null},t),!0)}hasItemBooleanFlag(e){return!0===(this.system.flags?.boolean??{})[e]}getItemBooleanFlags(){const e=this.system.flags?.boolean??{};return Object.keys(e)}async setItemDictionaryFlag(e,t,s={}){e=(e+"").replace(/[^\w_-]/g,"-").replace(/^-+/,"_");return(this.system.flags?.dictionary??{})[e]!==t&&(await this.update({["system.flags.dictionary."+e]:t},s),!0)}async removeItemDictionaryFlag(e,t={}){return void 0!==(this.system.flags?.dictionary??{})[e]&&(await this.update({["system.flags.dictionary.-="+e]:null},t),!0)}getItemDictionaryFlag(e){return(this.system.flags?.dictionary||{})[e]}getItemDictionaryFlags(){return this.system.flags?.dictionary||{}}getAttackArray(e){const t=this.actions.get(e),s=t?.data,n=t?.getRollData(),l=[0];if(!s)return l;const appendAttack=e=>{const t=RollPF.safeRoll(e,n).total;Number.isFinite(t)&&l.push(t)},c=s.attackParts.map((e=>e[0]?.toString().trim())).filter((e=>e?.length>0));for(const e of c)appendAttack(e);const u=s.formulaicAttacks?.count?.formula?.trim();if(u?.length>0){const e=s.formulaicAttacks?.bonus?.formula?.trim()||"0",t=RollPF.safeRoll(u,n);for(let s=0;s<t.total;s++)n.formulaicAttack=s+1,appendAttack(e);delete n.formulaicAttack}const d=Array(l.length).fill(0);s.conditionals.filter((e=>e.default&&e.modifiers.find((e=>"attack"===e.target)))).forEach((e=>{e.modifiers.forEach((e=>{const t=RollPF.safeRoll(e.formula,n);if(0!=t.total&&e.subTarget?.match(/^attack\.(\d+)$/)){const e=parseInt(RegExp.$1,10);e in d&&(d[e]+=t.total)}}))}));const m=this.getAttackSources(e).reduce(((e,t)=>e+t.value),0);return l.map(((e,t)=>e+m+d[t]))}get attackArray(){return this.getAttackArray(this.firstAction.id)}getAttackSources(e){const t=this.actions.get(e);if(!t)return;const s=[],n=this.actor?.system,l=this.system,c=t.data;if(!n||!c)return s;const u=t.getRollData(),d=["mwak","msak","mcman"].includes(c.actionType)||["melee","reach"].includes(c.range.units),m=["rwak","rsak","rcman"].includes(c.actionType)||"ranged"===this.system.weaponSubtype,h=t.isCombatManeuver,describePart=(e,t,n,l=0)=>{s.push({value:e,name:t,modifier:n,sort:l})},srcDetails=e=>e?.reverse().forEach((e=>describePart(e.value,e.name,e.modifier,-10))),g=h?ffd20.config.sizeSpecialMods[u.traits.size]:ffd20.config.sizeMods[u.traits.size];0!=g&&describePart(g,game.i18n.localize("FFD20.Size"),"size",-20),srcDetails(this.actor.sourceDetails["system.attributes.attack.shared"]),h&&srcDetails(this.actor.sourceDetails["system.attributes.cmb.bonus"]),srcDetails(this.actor.sourceDetails["system.attributes.attack.general"]);const y=[];m&&y.push("rattack"),d&&y.push("mattack");const b=getHighestChanges(this.actor.changes.filter((e=>y.includes(e.subTarget))),{ignoreTarget:!0});if(b.forEach((e=>describePart(e.value,e.flavor,e.modifier,-800))),c.ability.attack){const e=n.abilities?.[c.ability.attack]?.mod??0;describePart(e,ffd20.config.abilities[c.ability.attack],"untyped",-50)}const F=RollPF.safeRoll(c.attackBonus||"0",u);0!=F.total&&describePart(F.total,F.flavor??game.i18n.localize("FFD20.AttackRollBonus"),"untyped",-100);const k=t.enhancementBonus??(l.masterwork?1:0);if(b.find((e=>"enh"===e.modifier&&e.value>k))||(Number.isFinite(t.enhancementBonus)&&0!==t.enhancementBonus?describePart(t.enhancementBonus,game.i18n.localize("FFD20.EnhancementBonus"),"enh",-300):l.masterwork&&describePart(1,game.i18n.localize("FFD20.Masterwork"),"enh",-300)),l.proficient||describePart(-4,game.i18n.localize("FFD20.ProficiencyPenalty"),"penalty",-500),l.broken&&describePart(-2,game.i18n.localize("FFD20.Broken"),"penalty",-500),!0!==c.naturalAttack.primaryAttack&&"natural"===l.subType){const e=c.naturalAttack?.secondary?.attackBonus||"-5",t=RollPF.safeTotal(""+e,u);describePart(t,game.i18n.localize("FFD20.SecondaryAttack"),"untyped",-400)}return c.conditionals.filter((e=>e.default&&e.modifiers.find((e=>"attack"===e.target)))).forEach((e=>{e.modifiers.forEach((t=>{if("allAttack"===t.subTarget){const s=RollPF.safeRoll(t.formula,u);if(0==s.total)return;describePart(s.total,e.name,t.type,-5e3)}}))})),s.sort(((e,t)=>t.sort-e.sort))}get attackSources(){return this.getAttackSources(this.firstAction.id)}getAllDamageSources(e){return this.actions.get(e)?.allDamageSources}get allDamageSources(){return this.getAllDamageSources(this.firstAction.id)}setActive(e,t){throw Error(`Item type ${this.type} does not support ItemPF#setActive`)}}class ItemAttackPF extends ItemPF{getConditionalTargets(){const e=super.getConditionalTargets();return e.size=game.i18n.localize(ffd20.config.conditionalTargets.size._label),e}}class ItemBuffPF extends ItemPF{async _preUpdate(e,t,s){e.system?.active&&void 0===e.system?.duration?.start&&setProperty(e,"system.duration.start",game.time.worldTime),await super._preUpdate(e,t,s)}async _preDelete(e,t){const s=this.effect;s&&await s.delete({ffd20:{delete:this.uuid}}),t.isSelf&&this.isActive&&this.executeScriptCalls("toggle",{state:!1}),await super._preDelete(e,t)}getLabels({actionId:e,rollData:t}={}){const s=super.getLabels({actionId:e,rollData:t}),n=this.system;if(s.subType=ffd20.config.buffTypes[n.subType],this.system.duration){const e=this.system.duration,t=ffd20.config.timePeriodsShort[e.units];if("turn"===t)s.duration=game.i18n.format("FFD20.TimeFormat",{value:1,unit:t});else if(t&&e.value){const n=RollPF.safeTotal(e.value,this.getRollData());s.duration=game.i18n.format("FFD20.TimeFormat",{value:n,unit:t})}else s.duration=""}return s}prepareDerivedItemData(){super.prepareDerivedItemData(),this._prepareDuration()}_prepareDuration({rollData:e}={}){const t=this.system,s=t.duration??{},{units:n,value:l}=s;if(!n)return;let c=0;if("turn"===n)c=CONFIG.time.roundTime;else{if(!l)return;e??=this.getRollData();const t=RollPF.safeRoll(l,e).total;switch(n){case"hour":c=60*t*60;break;case"minute":c=60*t;break;case"round":c=t*CONFIG.time.roundTime}}t.duration.totalSeconds=c}async toEffect({noCreate:e=!1}={}){const t=this.actor;if(!t)return;const s=t.effects.find((e=>e.origin==this.uuid));if(s||e)return s;const n={label:this.name,icon:this.img,origin:this.uuid,disabled:!this.isActive,flags:{ffd20:{show:!this.system.hideFromToken&&!game.settings.get("ffd20","hideTokenConditions"),origin:{item:this.id}}}};return ActiveEffect.create(n,{parent:t})}getRawEffectData(){const e=super.getRawEffectData(),t=this.system.hideFromToken||game.settings.get("ffd20","hideTokenConditions");e["flags.ffd20.show"]=!t,t&&(e.icon=null);const s=this.system.duration;let n=s.value||"";"number"==typeof n&&(n+="");let l=0;const c=s.units;if("turn"===c)e.duration.turns=1,l=CONFIG.time.roundTime;else if(n)switch(c){case"minute":case"hour":l=this.totalDurationSeconds;break;case"round":{const t=RollPF.safeRoll(n,this.getRollData()).total;t>0&&(e.duration.rounds=t,l=t*CONFIG.time.roundTime);break}}return l>0&&(e.duration.seconds=l),e}getRollData(){const e=super.getRollData();return e.item.level=this.system.level,e}get isActive(){return this.system.active}get effect(){return this.actor?.effects.find((e=>e.origin?.indexOf("Item."+this.id)>0))}async setActive(e,t){return this.update({"system.active":e},t)}recharge(){}}class ItemClassPF extends ItemPF{async _preUpdate(e,t,s){if(await super._preUpdate(e,t,s),!e.system)return;void 0!==e.system.level&&(this._prevLevel=this.system.level);const n=e.system.links?.classAssociations;n?.length&&(n.forEach((e=>e.level||=1)),n.sort(((e,t)=>e.level-t.level)))}_onCreate(e,t,s){if(super._onCreate(e,t,s),s!==game.user.id)return;const n=this.actor;if(!n)return;if(!this.system.casting?.type)return;const l={...this.system.casting,class:this.system.tag};n.createSpellbook(l)}_onDelete(e,t){if(super._onDelete(e,t),t!==game.user.id)return;const s=this.actor;if(!s)return;const n=this.system.tag;if(!n||!this.system.casting?.type)return;const l=s.system.attributes.spells.spellbooks??{},c=Object.entries(l).find((([e,t])=>!!t.class&&t.class===n));if(void 0===c)return;const[u,d]=c;d.inUse&&s.update({[`system.attributes.spells.spellbooks.${u}.inUse`]:!1})}async update(e,t={}){e=expandObject(e),await super.update(e,t);const s=e.system?.level;if(void 0!==s&&this.actor){const e=this._prevLevel;void 0!==e&&(delete this._prevLevel,await this._onLevelChange(e,s))}}async delete(e={}){return await this._onLevelChange(this.system.level,0),super.delete(e)}async _onLevelChange(e,t){const s=this.actor;if(s){if(t>e){const n=(this.system.links?.classAssociations??[]).filter(((s,n)=>s.level>e&&s.level<=t)),l=new Map,c=[];for(const e of n){const t=await fromUuid(e.uuid);if(!t){const t="Could not find class association: "+e.uuid;console.warn(e.uuid,t,this),ui.notifications?.warn(t,{console:!1});continue}l.set(e.uuid,e);const s=game.items.fromCompendium(t);c.push({data:s,link:e})}if(c.length){const e=c.sort(((e,t)=>e.link.level-t.link.level)).map((e=>e.data)),t={};for(const n of e)t[n.type]??=s.items.filter((e=>e.type===n.type)).sort(((e,t)=>t.sort-e.sort))[0]?.sort??0,t[n.type]+=CONST.SORT_INTEGER_DENSITY,n.sort=t[n.type];const n=await s.createEmbeddedDocuments("Item",e),u={},d={flags:{ffd20:{links:{classAssociations:u}}}};for(const e of n){const t=l.get(e.getFlag("core","sourceId"));u[e.id]=t?.level??1}await this.update(d,{render:!1})}}if(t<e){const e=duplicate(this.getFlag("ffd20","links.classAssociations")||{}),n=[];for(const[l,c]of Object.entries(e)){const u=s.items.get(l);u?c>t&&(n.push(u.id),delete e[l]):delete e[l]}await this.setFlag("ffd20","links.classAssociations",e),await Item.implementation.deleteDocuments(n,{parent:s})}Hooks.callAll("pf1ClassLevelChange",this.actor,this,e,t)}}prepareBaseData(){super.prepareBaseData();const e=this.system;e.hitDice=void 0,e.mythicTier=void 0,e.casting?.type&&(e.casting.progression??="high",e.casting.ability??="int",e.casting.spells??="arcane",e.casting.domainSlots??=1,e.casting.cantrips??=!0)}prepareDerivedData(){super.prepareDerivedData();const e=this.system,t=game.settings.get("ffd20","useFractionalBaseBonuses");{const s=t?ffd20.config.classFractionalSavingThrowFormulas:ffd20.config.classSavingThrowFormulas;for(const n of Object.keys(ffd20.config.savingThrows)){const l=e.subType||"base";let c;const u=e.savingThrows[n],d=u.value;c="custom"===d?u.custom||"0":s[l][d],null==c&&(c="0");const m=RollPF.safeRoll(c,{level:e.level,hitDice:this.hitDice}).total;u.base=m,t&&(u.good=!0===s[l].goodSave&&"high"===d)}}{const s=t?ffd20.config.classFractionalBABFormulas:ffd20.config.classBABFormulas,n=e.bab;let l;l="custom"===n?e.babFormula||"0":s[n]||"0",e.babBase=RollPF.safeRoll(l,{level:e.level,hitDice:this.hitDice}).total}const s=this.actor;if(s?.system){s.system;const e=this.system;let t=e.tag;t||(t=createTag(this.name));let n=game.settings.get("ffd20","healthConfig");const l=this.hasPlayerOwner;n="racial"===e.subType?n.hitdice.Racial:l?n.hitdice.PC:n.hitdice.NPC,e.subType||console.warn(this.name+" lacks class type",this);const c="base"===(e.subType||"base");if(!this.actor.classes)return;s.classes[t]={_id:this.id,level:e.level,name:this.name,hd:e.hd,hitDice:this.hitDice,mythicTier:this.mythicTier,bab:e.bab,hp:n.auto,savingThrows:{fort:e.savingThrows.fort.base,ref:e.savingThrows.ref.base,will:e.savingThrows.will.base},fc:{hp:c?e.fc.hp.value:0,skill:c?e.fc.skill.value:0,alt:c?e.fc.alt.value:0}}}}get hitDice(){const e=this.system;if(void 0===e.hitDice)if("mythic"===e.subType)e.hitDice=0;else if(e.customHD?.length>0){const t={item:{level:this.system.level}};e.hitDice=RollPF.safeRoll(e.customHD,t).total}else e.hitDice=e.level;return e.hitDice}get mythicTier(){const e=this.system;return void 0===e.mythicTier&&(e.mythicTier="mythic"===this.subType?e.level:0),e.mythicTier}recharge(){}}class ItemConsumablePF extends ItemPF{static system=Object.freeze(foundry.utils.mergeObject(super.system,{isPhysical:!0},{inplace:!1}));async _preDelete(e,t){t.isSelf&&this.system.quantity>0&&this.executeScriptCalls("changeQuantity",{quantity:{previous:this.system.quantity,new:0}}),await super._preDelete(e,t)}}class ItemContainerPF extends ItemPF{static system=Object.freeze(foundry.utils.mergeObject(super.system,{isPhysical:!0},{inplace:!1}));constructor(...e){super(...e),this.items??=null}async _preDelete(e,t){t.isSelf&&this.system.quantity>0&&this.executeScriptCalls("changeQuantity",{quantity:{previous:this.system.quantity,new:0}}),await super._preDelete(e,t)}prepareBaseData(){super.prepareBaseData(),"object"!=typeof this.system.weight&&(this.system.weight={value:this.system.weight});const e=(100-(this.system.weightReduction??0))/100;this.system.weight.currency=this._calculateCoinWeight()*e}prepareDerivedData(){this.items=this._prepareInventory(this.system.inventoryItems),super.prepareDerivedData()}prepareWeight(){super.prepareWeight();const e=this.system.weight;e.contents=this.items.reduce(((e,t)=>e+t.system.weight.total),this._calculateCoinWeight()),e.converted.contents=ffd20.utils.convertWeight(e.contents)}async createContainerContent(e,t={raw:!1}){const s="Item",n=game.user,l={temporary:!1,renderSheet:!1};let c=deepClone(this.system.inventoryItems??[]);if(e=e instanceof Array?e:[e],!l.temporary&&!l.noHook)for(const t of e){if(!1===Hooks.call("preCreate"+s,this,t,l,n.id))return console.debug(`${vtt} | ${s} creation prevented by preCreate hook`),null;t._id=randomID(16)}const u=e.map((e=>t.raw?e:new ItemPF(e).toObject()));c.push(...u);{const e=[];c=c.filter((t=>!e.includes(t._id)&&(e.push(t._id),!0)))}await this.update({"system.inventoryItems":c});const d=new Set(u.map((e=>e._id)));return this.items.filter((e=>d.has(e.id)))}getContainerContent(e){return this.items.get(e)}async deleteContainerContent(e){const t="ContainerContent",s=game.user,n={noHook:!1};e=e instanceof Array?e:[e];const l=new Set(e),c=deepClone(this.system.inventoryItems??[]).filter((e=>{if(!l.has(e._id))return!0;if(!n.noHook){if(!1===Hooks.call("preDelete"+t,this,e,n,s.id))return console.debug(`${vtt} | ${t} update prevented by preUpdate hook`),!0}return!1}),[]);await this.update({"system.inventoryItems":c})}async updateContainerContents(e){const t="ContainerContent",s=game.user,n={diff:!0},l=new Map;e=e instanceof Array?e:[e];for(const t of e){if(!t._id)throw Error("You must provide an id for every Embedded Document in an update operation");l.set(t._id,t)}const c=this.items.reduce(((e,c)=>{if(!l.has(c.id))return e;let u=l.get(c.id);if(n.diff){if(u=diffObject(c,expandObject(u)),foundry.utils.isEmpty(u))return e;u._id=c.id}if(!n.noHook){if(!1===Hooks.call("preUpdate"+t,this,c,u,n,s.id))return console.debug(`${vtt} | ${t} update prevented by preUpdate hook`),e}return e.push(u),e}),[]);if(!c.length)return[];let u=duplicate(this.system.inventoryItems).map((e=>{for(const t of c)if(t._id===e._id)return mergeObject(e,t);return e}));{const e=[];u=u.filter((t=>!e.includes(t._id)&&(e.push(t._id),!0)))}await this.update({"system.inventoryItems":u})}getTotalCurrency({inLowestDenomination:e=!1}={}){const t=this.system.currency,s=1e3*t.pgil+100*t.gil+10*t.sgil+t.cgil;return e?s:s/100}convertCurrency(e="pgil"){const t=this.getTotalCurrency(),s=[0,0,0,0];switch(e){case"pgil":s[0]=Math.floor(t/10),s[1]=Math.max(0,Math.floor(t)-10*s[0]),s[2]=Math.max(0,Math.floor(10*t)-100*s[0]-10*s[1]),s[3]=Math.max(0,Math.floor(100*t)-1e3*s[0]-100*s[1]-10*s[2]);break;case"gil":s[1]=Math.floor(t),s[2]=Math.max(0,Math.floor(10*t)-10*s[1]),s[3]=Math.max(0,Math.floor(100*t)-100*s[1]-10*s[2]);break;case"sgil":s[2]=Math.floor(10*t),s[3]=Math.max(0,Math.floor(100*t)-10*s[2]);break;case"cgil":s[3]=Math.floor(100*t)}const n={};return n["system.currency.pgil"]=s[0],n["system.currency.gil"]=s[1],n["system.currency.sgil"]=s[2],n["system.currency.cgil"]=s[3],this.update(n)}_calculateCoinWeight(){const e=game.settings.get("ffd20","coinWeight");return e?Object.values(this.system.currency||{}).reduce(((e,t)=>e+t),0)/e:0}getValue({recursive:e=!0,sellValue:t=.5,inLowestDenomination:s=!1,forceUnidentified:n=!1}={}){let l=super.getValue(...arguments);return l+=this.getTotalCurrency({inLowestDenomination:s}),e?(this.items.forEach((n=>{l+=n.getValue({recursive:e,sellValue:t,inLowestDenomination:s})})),l):l}recharge(){}}class ItemEquipmentPF extends ItemPF{static system=Object.freeze(foundry.utils.mergeObject(super.system,{isPhysical:!0},{inplace:!1}));async _preUpdate(e,t,s){await super._preUpdate(e,t,s);const n=e.system?.subType;if(void 0!==n&&n!==this.subType){const t=e.system?.equipmentSubtype??this.system.equipmentSubtype??"",s=Object.keys(ffd20.config.equipmentTypes[n]??{}).filter((e=>!e.startsWith("_")));t&&s.includes(t)?e.system.equipmentSubtype="":e.system.equipmentSubtype=s[0];const l=e.system?.slot??this.system.slot??"",c=Object.keys(ffd20.config.equipmentSlots[n]??{});l&&c.includes(l)||(e.system.slot=c[0])}}async _preDelete(e,t){t.isSelf&&(this.isActive&&this.executeScriptCalls("equip",{equipped:!1}),this.system.quantity>0&&this.executeScriptCalls("changeQuantity",{quantity:{previous:this.system.quantity,new:0}})),await super._preDelete(e,t)}getLabels({actionId:e,rollData:t}={}){const s=super.getLabels({actionId:e,rollData:t}),n=this.system;let l=this.subType;const c=Object.keys(ffd20.config.equipmentTypes);c.includes(l)||(l=c[0]);let u=this.system.equipmentSubtype;const d=Object.keys(ffd20.config.equipmentTypes[l]).filter((e=>!e.startsWith("_")));d.includes(u)||(u=d[0]);const m=ffd20.config.equipmentTypes[l];s.equipmentType=m._label,s.equipmentSubtype=m[u]??m._label;const h=this.showUnidentifiedData?n.armor.value||0:(n.armor.value||0)+(n.armor.enh||0);return s.armor=h>0?h+" AC":"",s}prepareDerivedData(){super.prepareDerivedData();const e=this.system;if(""===e.armor.dex?e.armor.dex=null:"string"==typeof e.armor.dex&&/\d+/.test(e.armor.dex)&&(e.armor.dex=parseInt(e.armor.dex)),null==e.armor.enh&&(e.armor.enh=0),!0===e.equipped){const t=this.actor;if(!t?.system||!t?.equipment)return;t.system;const s=ffd20.config.shieldTypes,n=ffd20.config.armorTypes;switch(e.subType){case"shield":{const n=e.equipmentSubtype;let l=t.equipment.shield.type;"other"===n&&l<s.other?l=s.other:"lightShield"===n&&l<s.light?l=s.light:"heavyShield"===n&&l<s.heavy?l=s.heavy:"towerShield"===n&&l<s.tower&&(l=s.tower),t.equipment.shield.type!==l&&(t.equipment.shield.type=l,t.equipment.shield.id=this.id);break}case"armor":{const s=e.equipmentSubtype;let l=t.equipment.armor.type;"lightArmor"===s&&l<n.light?l=n.light:"mediumArmor"===s&&l<n.medium?l=n.medium:"heavyArmor"===s&&l<n.heavy&&(l=n.heavy),l!==t.equipment.armor.type&&(t.equipment.armor.type=l,t.equipment.armor.id=this.id);break}}}}async setActive(e,t){return this.update({"system.equipped":e},t)}get isActive(){return this.system.equipped}get hasSlots(){return["wondrous","other"].includes(this.subType)}}class ItemFeatPF extends ItemPF{async _preDelete(e,t){t.isSelf&&this.isActive&&this.executeScriptCalls("toggle",{state:!1}),await super._preDelete(e,t)}async setActive(e,t){return this.update({"system.disabled":!e},t)}get isActive(){return!this.system.disabled}getLabels({actionId:e,rollData:t}={}){const s=super.getLabels({actionId:e,rollData:t}),{subType:n,abilityType:l}=this.system;return s.featType=ffd20.config.featTypes[n],s.abilityType=ffd20.config.abilityTypes[this.system.abilityType]?.short,s.traitType=ffd20.config.traitTypes[this.system.traitType],l&&"none"!==l?s.abilityType=ffd20.config.abilityTypes[l].short:s.abilityType&&delete s.abilityType,s}getTypeChatData(e,t,s,n){super.getTypeChatData(e,t,s,n),t.abilityType&&s.push(t.abilityType)}}class ItemLootPF extends ItemPF{static system=Object.freeze(foundry.utils.mergeObject(super.system,{isPhysical:!0},{inplace:!1}));get extraType(){return this.system.extraType}async _preUpdate(e,t,s){await super._preUpdate(e,t,s),void 0!==e.system?.subType&&e.system?.subType!==this.system.subType&&void 0===e.system?.extraType&&setProperty(e,"system.extraType","")}async _preDelete(e,t){t.isSelf&&(this.isActive&&this.executeScriptCalls("equip",{equipped:!1}),this.system.quantity>0&&this.executeScriptCalls("changeQuantity",{quantity:{previous:this.system.quantity,new:0}})),await super._preDelete(e,t)}async setActive(e,t){return this.update({"system.equipped":e},t)}get isActive(){return"gear"!==this.subType||this.system.equipped}get isSingleUse(){return"ammo"===this.subType||super.isSingleUse}async addCharges(e){const t=this.system.quantity;if(Number.isFinite(t))return this.update({"system.quantity":t+e})}get charges(){return this.system.quantity??0}}class ItemRacePF extends ItemPF{async _preCreate(e,t,s){await super._preCreate(e,t,s);const n=this.actor;if(n){const e=n.items.find((e=>"race"===e.type&&e!==this));if(e){await e.delete();const t=n.system.traits.size;t!==this.system.size&&e.system.size}}}async _preUpdate(e,t,s){await super._preUpdate(e,t,s);const n=this.actor;if("basic"===n?.type)return;const l=e.system?.size;if(n&&void 0!==l){const e=n.system.traits?.size;this.system.size===e&&l!==e&&(t._pf1SizeChanged=!0)}}_onUpdate(e,t,s){super._onUpdate(e,t,s);const n=this.actor;n&&t._pf1SizeChanged&&game.user.id===s&&n.update({"system.traits.size":this.system.size})}_onDelete(e,t){super._onDelete(e,t),this.actor?.race===this&&(this.actor.race=null)}prepareBaseData(){super.prepareBaseData();const e=this.actor;e&&(e.race=this)}recharge(){}}const G=["systems/ffd20/templates/actors/parts/actor-summary.hbs","systems/ffd20/templates/actors/parts/actor-traits.hbs","systems/ffd20/templates/actors/parts/actor-inventory.hbs","systems/ffd20/templates/actors/parts/actor-features.hbs","systems/ffd20/templates/actors/parts/actor-spellbook-front.hbs","systems/ffd20/templates/actors/parts/actor-spellbook.hbs","systems/ffd20/templates/actors/parts/actor-skills-front.hbs","systems/ffd20/templates/actors/parts/actor-skills.hbs","systems/ffd20/templates/actors/parts/actor-combat.hbs","systems/ffd20/templates/actors/parts/actor-defenses_tables.hbs","systems/ffd20/templates/actors/parts/actor-buffs.hbs","systems/ffd20/templates/actors/parts/actor-attributes.hbs","systems/ffd20/templates/actors/parts/actor-settings.hbs","systems/ffd20/templates/actors/parts/actor-settings-ability-scores.hbs","systems/ffd20/templates/actors/parts/actor-cmb.hbs","systems/ffd20/templates/actors/parts/actor-contextNotes.hbs","systems/ffd20/templates/actors/parts/actor-source-details.hbs","systems/ffd20/templates/internal/item-search.hbs","systems/ffd20/templates/internal/table_magic-items.hbs","systems/ffd20/templates/items/parts/item-actions.hbs","systems/ffd20/templates/items/parts/item-advanced.hbs","systems/ffd20/templates/items/parts/item-aura.hbs","systems/ffd20/templates/items/parts/item-base-types.hbs","systems/ffd20/templates/items/parts/item-changes.hbs","systems/ffd20/templates/items/parts/item-contents.hbs","systems/ffd20/templates/items/parts/item-description.hbs","systems/ffd20/templates/items/parts/item-links.hbs","systems/ffd20/templates/items/parts/item-name.hbs","systems/ffd20/templates/items/parts/item-proficiencies.hbs","systems/ffd20/templates/items/parts/item-size.hbs","systems/ffd20/templates/items/parts/item-tag.hbs","systems/ffd20/templates/items/parts/item-tags.hbs","systems/ffd20/templates/items/parts/item-weapon-groups.hbs","systems/ffd20/templates/apps/attack-roll-dialog.hbs","systems/ffd20/templates/apps/vision-permission.hbs","systems/ffd20/templates/apps/help-browser.hbs","systems/ffd20/templates/apps/item-action/action.hbs","systems/ffd20/templates/apps/item-action/activation.hbs","systems/ffd20/templates/apps/item-action/template.hbs","systems/ffd20/templates/apps/item-action/conditionals.hbs","systems/ffd20/templates/apps/compendium-browser/entries.hbs","systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs","systems/ffd20/templates/apps/compendium-browser/minmax-filter.hbs","systems/ffd20/templates/chat/roll-ext.hbs","systems/ffd20/templates/chat/defenses.hbs","systems/ffd20/templates/chat/parts/gm-description.hbs","systems/ffd20/templates/chat/parts/attack-roll-header.hbs","systems/ffd20/templates/chat/parts/attack-roll-footer.hbs","systems/ffd20/templates/chat/parts/attack-roll-targets.hbs","systems/ffd20/templates/internal/spell-description.hbs","systems/ffd20/templates/internal/consumable-description.hbs","systems/ffd20/templates/internal/damage-tooltip.hbs","systems/ffd20/templates/internal/token-config_vision.hbs","systems/ffd20/templates/internal/damage-type-visual.hbs","systems/ffd20/templates/hud/tooltip.hbs","systems/ffd20/templates/hud/tooltip_actor.hbs","systems/ffd20/templates/apps/level-up/fc_alt.hbs","systems/ffd20/templates/apps/level-up/fc_hp.hbs","systems/ffd20/templates/apps/level-up/fc_skill.hbs","systems/ffd20/templates/apps/level-up/health_roll.hbs","systems/ffd20/templates/apps/level-up/health_manual.hbs","systems/ffd20/templates/apps/level-up/ability-score.hbs","systems/ffd20/templates/apps/level-up/summary.hbs","systems/ffd20/templates/apps/level-up/summary/health.hbs","systems/ffd20/templates/apps/level-up/summary/fc.hbs","systems/ffd20/templates/apps/level-up/summary/ability-score.hbs"],preloadHandlebarsTemplates=async()=>loadTemplates(G),renderCachedTemplate=(e,t={})=>{const s=Handlebars.partials[e];if(!s)throw Error(`Template ${e} not found in cache`);return s(t,{allowProtoMethodsByDefault:!0,allowProtoPropertiesByDefault:!0,preventIndent:!0})};class ItemSpellPF extends ItemPF{async _preCreate(e,t,s){await super._preCreate(e,t,s),this._assignLevelOnCreate(e,t)}async _preUpdate(e,t,s){await super._preUpdate(e,t,s),e.system&&this._preparationPreUpdate(e)}_preparationPreUpdate(e){const t=e.system.preparation;if(!t)return;const s=this.system.preparation,n=t.maxAmount??s.maxAmount??0,l=t.preparedAmount??s.preparedAmount??0;l>n&&(void 0!==t.maxAmount?t.preparedAmount=n:void 0!==t.preparedAmount&&(t.maxAmount=l)),t.maxAmount<0&&(t.maxAmount=0),t.preparedAmount<0&&(t.preparedAmount=0)}_assignLevelOnCreate(e,t){const s=this.actor,n=this.system.spellbook,l=s?.system.attributes?.spells?.spellbooks?.[n]?.class,c=this.system.learnedAt?.class?.[l];Number.isFinite(c)&&this.updateSource({"system.level":Math.clamped(c,0,9)})}getLabels({actionId:e,rollData:t}={}){const s=super.getLabels({actionId:e,rollData:t}),n=this.system;return s.level=ffd20.config.spellLevels[n.level],s.school=ffd20.config.spellSchools[n.school],s.components=this.getSpellComponents().map((e=>e[0])).join(" "),s}getEffectiveSpellLevel(e=0){const t=this.system.slOffset??0,s=this.system.level;return Math.max(0,s+t+e)}getEffectiveCasterLevel(e=0){const t=this.system.clOffset??0,s=this.spellbook?.cl.total??0;return Math.max(0,s+t+e)}preCreateData(e,t,s){const n=super.preCreateData(e,t,s);return this.actor&&!0===this.spellbook?.psychic&&(!0===this.system.components?.verbal&&(n["system.components.verbal"]=!1,n["system.components.thought"]=!0),!0===this.system.components?.somatic&&(n["system.components.somatic"]=!1,n["system.components.emotion"]=!0)),n}getRollData(){const e=super.getRollData();if(this.actor){const t=this.spellbook;if(null!=t){const s=t.ability;let n="";""!==s&&(n=this.actor.system.abilities?.[s]?.mod),e.cl=this.casterLevel||0,e.sl=this.spellLevel||0,e.classLevel="_hd"===t.class?e.attributes.hd?.total??e.details.level.value:e.classes?.[t.class]?.level||0,e.ablMod=n}}return e}getConditionalSubTargets(e){const t=super.getConditionalSubTargets(e);return"effect"===e&&(t.cl=game.i18n.localize("FFD20.CasterLevel")),"misc"===e&&"spell"===this.type&&this.useSpellPoints()&&(t.charges=game.i18n.localize("FFD20.SpellPointsCost")),t}getTypeChatData(e,t,s,n){n.item.sr&&s.push(game.i18n.localize("FFD20.SpellResistance")),this.isCharged&&!this.system.atWill&&(this.useSpellPoints()?s.push(`${game.i18n.localize("FFD20.SpellPoints")}: ${this.charges}/${this.maxCharges}`):s.push(`${game.i18n.localize("FFD20.ChargePlural")}: ${this.charges}/${this.maxCharges}`))}async addUses(e,t=null){return foundry.utils.logCompatibilityWarning("ItemSpellPF.addUses() is deprecated in favor of .addCharges()",{since:"PF1 v9",until:"PF1 v10"}),this.addCharges(e,t)}async addCharges(e,t=null){if(!this.actor)return;if(this.system.atWill)return;const s=this.spellbook;if(!s)return;const n=s.spontaneous,l=this.system.spellbook||"primary",c=this.system.level;if(this.useSpellPoints()){const t=this.getSpellUses(),s={},n=getProperty(this.actor,"system.attributes.mp.temp"),l=getProperty(this.actor,"system.attributes.mp.value");if(0===n)return s["system.attributes.mp.value"]=t+e,this.actor.update(s);if(n>=-1*e)return s["system.attributes.mp.temp"]=n+e,this.actor.update(s);{const t=n+e;return s["system.attributes.mp.temp"]=0,s["system.attributes.mp.value"]=l+t,this.actor.update(s)}}{const u=Math.max(0,n?(s.spells?.["spell"+c]?.value||0)+e:(this.system.preparation?.preparedAmount||0)+e);if(n){const e={};return e[`system.attributes.spells.spellbooks.${l}.spells.spell${c}.value`]=u,await this.actor.update(e),this}{const e="system.preparation.preparedAmount";if(null==t)return(t={})[e]=u,this.update(t);t[e]=u}}}get isCharged(){return!this.system.atWill}get charges(){return this.getSpellUses()}get maxCharges(){return this.getSpellUses(!0)}getDefaultChargeCost({rollData:e}={}){if(this.system.atWill)return 0;if(this.useSpellPoints()){e??=this.getRollData();const t=this.getDefaultChargeFormula();return RollPF.safeRoll(t,e).total}return super.getDefaultChargeCost({rollData:e})}getDefaultChargeFormula(){return this.useSpellPoints()?this.system.spellPoints?.cost||game.settings.get("ffd20","spellPointCost")||"0":super.getDefaultChargeFormula()}async recharge({value:e,period:t="day",exact:s=!1,maximize:n=!0,commit:l=!0,rollData:c,context:u}={}){const d=this.system,m=this.spellbook;if(m.spontaneous,"week"==t){if(s)return;t="day"}if(!["day","any"].includes(t))return;if(!m)return;if(m.spontaneous)return;if(m.spellPoints?.useSystem)return;const h={system:{preparation:{}}},g=d.preparation;return g.preparedAmount!=g.maxAmount&&(n&&(e=g.maxAmount),e=Math.clamped(e,0,g.maxAmount),Number.isFinite(e))?(h.system.preparation.preparedAmount=g.maxAmount,l&&this.update(h,u),h):void 0}get spellLevel(){return this.system.level+(this.system.slOffset||0)}get casterLevel(){const e=this.spellbook;return e?e.cl.total+(this.system.clOffset||0):null}get spellbook(){const e=this.system.spellbook;return this.actor?.system?.attributes?.spells.spellbooks[e]}getDC(e=null){if(!this.actor)return 0;const t=this.spellbook;if(t){let s=t.baseDCFormula;const n=(e=e??this.getRollData()).item;n.save.dc.length>0&&(s+=" + "+n.save.dc);const l=e.dcBonus??0;return RollPF.safeRoll(s,e).total+l}return 10}getSpellUses(e=!1){if(!this.actor)return 0;const t=this.system;if(t.atWill)return 1/0;const s=this.spellbook;if(!s)return 0;const n=s.spontaneous,l=t.level;return this.useSpellPoints()?e?this.actor.system.attributes.mp.max:this.actor.system.attributes.mp.value+this.actor.system.attributes.mp.temp:n?!0===t.preparation.spontaneousPrepared?e?s.spells?.["spell"+l]?.max||0:s.spells?.["spell"+l]?.value||0:0:e?t.preparation?.maxAmount??0:t.preparation?.preparedAmount??0}useSpellPoints(){return this.spellbook?.spellPoints?.useSystem??!1}getSpellComponents(e){e||(e=duplicate(this.system));const t=ffd20.config.re.traitSeparator,s=this.system.components??{},n=this.system.materials??{},l=[],c={verbal:game.i18n.localize("FFD20.SpellComponentKeys.Verbal"),somatic:game.i18n.localize("FFD20.SpellComponentKeys.Somatic"),thought:game.i18n.localize("FFD20.SpellComponentKeys.Thought"),emotion:game.i18n.localize("FFD20.SpellComponentKeys.Emotion"),material:game.i18n.localize("FFD20.SpellComponentKeys.Material"),focus:game.i18n.localize("FFD20.SpellComponentKeys.Focus"),divineFocus:game.i18n.localize("FFD20.SpellComponentKeys.DivineFocus")};s.verbal&&l.push(c.verbal),s.somatic&&l.push(c.somatic),s.thought&&l.push(c.thought),s.emotion&&l.push(c.emotion);const u=s.divineFocus,d=1,m=2,h=3;if(s.material){let e=c.material;u===m&&(e=`${e}/${c.divineFocus}`),n.value&&(e=`${e} (${n.value})`),e&&l.push(e)}if(s.focus){let e=c.focus;u===h&&(e=`${e}/${c.divineFocus}`),n.focus&&(e=`${e} (${n.focus})`),e&&l.push(e)}return u===d&&l.push(c.divineFocus),c.value&&l.push(...s.value.split(t)),l}static getMinimumCasterLevelBySpellData(e){const t=Object.entries(e.system.learnedAt?.class??{})?.reduce(((e,[t,s])=>{const n=t.split("/");for(const t of n)e.push([t,s]);return e}),[]),s=[9,20];for(const[e,n]of t){s[0]=Math.min(s[0],n);const t=ffd20.config.classCasterType[e]||"high";"high"===t?s[1]=Math.min(s[1],1+2*Math.max(0,n-1)):"med"===t?s[1]=Math.min(s[1],1+3*Math.max(0,n-1)):"low"===t&&(s[1]=Math.min(s[1],1+3*Math.max(0,n)))}return s}static _replaceConsumableConversionString(e,t){return e=(e=e.replace(/@sl/g,t.sl)).replace(/@cl/g,"@item.cl")}static async toConsumable(e,t){const s=e.system.actions?.[0]??{},n={type:"consumable",name:e.name};n["system.unidentified.name"]=e.unidentifiedName||game.i18n.localize("FFD20.CreateItem"+t.capitalize()),n["system.identified"]=e.identified??!0;const l=ffd20.components.ItemAction.defaultData,[c,u]=this.getMinimumCasterLevelBySpellData(e),d=e.sl??c??1,m=e.cl??u??1,h=e.system.materials?.gilValue??0,g=e.system;g.sl=d,g.cl=m,n["system.subType"]=t,"wand"===t?(n.name=game.i18n.format("FFD20.CreateItemWandOf",{name:e.name}),n.img="systems/ffd20/icons/items/inventory/wand-star.jpg",n["system.price"]=0,n["system.uses.pricePerUse"]=Math.floor((Math.max(.5,d)*m*750+h)/50*100)/100,n["system.hardness"]=5,n["system.hp.max"]=5,n["system.hp.value"]=5,l.name=game.i18n.localize("FFD20.Use"),l.img=n.img):"potion"===t?(n.name=game.i18n.format("FFD20.CreateItemPotionOf",{name:e.name}),n.img="systems/ffd20/icons/items/potions/minor-blue.jpg",n["system.price"]=Math.max(.5,d)*m*50+h,n["system.hardness"]=1,n["system.hp.max"]=1,n["system.hp.value"]=1,l.range={value:0,units:"personal"},l.name=game.i18n.localize("FFD20.Drink"),l.img=n.img):"scroll"===t&&(n.name=game.i18n.format("FFD20.CreateItemScrollOf",{name:e.name}),n.img="systems/ffd20/icons/items/inventory/scroll-magic.jpg",n["system.price"]=Math.max(.5,d)*m*25+h,n["system.hardness"]=0,n["system.hp.max"]=1,n["system.hp.value"]=1,l.name=game.i18n.localize("FFD20.Use"),l.img=n.img),"wand"===t?(n["system.uses.maxFormula"]="50",n["system.uses.value"]=50,n["system.uses.max"]=50,n["system.uses.per"]="charges"):n["system.uses.per"]="single",l.activation.type="standard",l.activation.unchained.type="action",l.activation.unchained.cost=2,"potion"!==t&&(l.measureTemplate=s.measureTemplate,["close","medium","long"].includes(s.range?.units)?l.range={units:"ft",value:RollPF.safeTotal(ffd20.config.spellRangeFormulas[s.range.units],g).toString()}:l.range=s.range),l.actionType=e.actionType;for(const e of s.damage?.parts??[])l.damage.parts.push({formula:this._replaceConsumableConversionString(e.formula,g),type:e.type});s.save&&(l.save.description=s.save.description,l.save.type=s.save.type,l.save.dc=`10 + ${e.sl}[${game.i18n.localize("FFD20.SpellLevel")}] + ${Math.floor(e.sl/2)}[${game.i18n.localize("FFD20.SpellcastingAbility")}]`),l.actionType=s.actionType,l.attackNotes=s.attackNotes,l.effectNotes=s.effectNotes,l.attackBonus=s.attackBonus,l.critConfirmBonus=s.critConfirmBonus;for(const e of["attackNotes","effectNotes"]){const t=getProperty(l,e);if(t)for(let e=0;e<t.length;e++){const s=t[e];t[e]=this._replaceConsumableConversionString(s,g)}}return n["system.cl"]=m,n["system.aura.school"]=e.system.school,n["system.description.value"]=this._replaceConsumableConversionString(await renderTemplate("systems/ffd20/templates/internal/consumable-description.hbs",{origData:e,data:n,isWand:"wand"===t,isPotion:"potion"===t,isScroll:"scroll"===t,sl:d,cl:m,config:ffd20.config}),g),n["system.actions"]=[l],new ItemPF(expandObject(n)).toObject()}get canCast(){if(this.system.atWill)return!0;const e=this.charges;return this.isCharged&&e>0||this.spellbook?.spontaneous&&this.system.preparation.spontaneousPrepared&&e>0}get isDomain(){return!0===this.system.domain}get fullDescription(){return super.fullDescription+this.system.shortDescription}getDescription({chatcard:e=!1,data:t={}}={}){return renderCachedTemplate("systems/ffd20/templates/internal/spell-description.hbs",{...t,...this.spellDescriptionData,chatcard:!0===e})}get spellDescriptionData(){const e=ffd20.config.re.traitSeparator,t=this.system,s=this.firstAction,n=s?.data??{},l={school:ffd20.config.spellSchools[t.school],multi:t.multi,multischool:ffd20.config.multiSchools[t.multischool],subschool:t.subschool||"",types:""},c={data:mergeObject(this.system,t,{inplace:!1}),label:l},u=t.types;"string"==typeof u&&u.length>0&&(l.types=u.split(e).join(", "));const d=t.srinfo;"string"==typeof d&&d.length>0&&(l.srinfo=d.split(e).join(", ")),c.learnedAt={},t.learnedAt&&["class","domain"].forEach((e=>c.learnedAt[e]=Object.entries(t.learnedAt[e]).map((([e,t])=>`${e} ${t}`)).join(", ")));const m=game.settings.get("ffd20","unchainedActionEconomy"),h=s?.activation;if(null!=h){const e=h.cost,t=h.type,s=m?ffd20.config.abilityActivationTypes_unchained:ffd20.config.abilityActivationTypes,n=m?ffd20.config.abilityActivationTypesPlurals_unchained:ffd20.config.abilityActivationTypesPlurals;t&&(null!=n[t]?l.castingTime=1===e?""+s[t]:""+n[t]:l.castingTime=""+s[t]),Number.isNaN(e)||null==l.castingTime||(l.castingTime=`${e} ${l.castingTime}`)}l.components=this.getSpellComponents().join(", ");{const e=n.duration?.value;e&&(l.duration=e)}{const e=n.spellEffect;e&&(l.effect=e)}{const e=n.target?.value;e&&(l.targets=e)}{const e=n.range?.units,t=n.range?.value;if(null!=e&&"none"!==e){l.range=ffd20.config.distanceUnits[e];const s=getDistanceSystem();switch(e){case"close":l.range=`${l.range} ${game.i18n.localize("metric"==s?"FFD20.SpellRangeShortMetric":"FFD20.SpellRangeShort")}`;break;case"medium":l.range=`${l.range} ${game.i18n.localize("metric"==s?"FFD20.SpellRangeMediumMetric":"FFD20.SpellRangeMedium")}`;break;case"long":l.range=`${l.range} ${game.i18n.localize("metric"==s?"FFD20.SpellRangeLongMetric":"FFD20.SpellRangeLong")}`;break;case"ft":case"mi":l.range=t?`${t} ${l.range}`:"";break;case"spec":l.range=t||l.range}}}{const e=n.spellArea;e&&(l.area=e)}{const e=n.save?.description;l.savingThrow=e||game.i18n.localize("FFD20.None");const s=t.sr;l.sr=(!0===s?game.i18n.localize("FFD20.Yes"):game.i18n.localize("FFD20.No")).toLowerCase(),"personal"!==n.range?.units&&(c.useDCandSR=!0)}return c}get slotCost(){return this.system.atWill?0:this.system.slotCost??1}}class ItemWeaponPF extends ItemPF{static system=Object.freeze(foundry.utils.mergeObject(super.system,{isPhysical:!0},{inplace:!1}));async _preUpdate(e,t,s){await super._preUpdate(e,t,s);const n=e.system?.subType;if(null!=n&&n!==this.system.subType){const t=e.system.weaponSubtype??this.system.weaponSubtype??"",s=Object.keys(ffd20.config.weaponTypes[n]).filter((e=>!e.startsWith("_")));t&&s.includes(t)||(e.system.weaponSubtype=s[0])}}async _preDelete(e,t){t.isSelf&&(this.isActive&&this.executeScriptCalls("equip",{equipped:!1}),this.system.quantity>0&&this.executeScriptCalls("changeQuantity",{quantity:{previous:this.system.quantity,new:0}})),await super._preDelete(e,t)}getLabels({actionId:e,rollData:t}={}){const s=super.getLabels({actionId:e,rollData:t}),{weaponTypes:n}=ffd20.config;let l=this.system.subType;const c=Object.keys(n);c.includes(l)||(l=c[0]);let u=this.system.weaponSubtype;const d=Object.keys(n[l]).filter((e=>!e.startsWith("_")));return d.includes(u)||(u=d[0]),s.weaponType=n[l]._label,s.weaponSubtype=n[l][u],s}async setActive(e,t){return this.update({"system.equipped":e},t)}get isActive(){return this.system.equipped}}const W=Object.freeze(Object.defineProperty({__proto__:null,ItemAttackPF,ItemBuffPF,ItemClassPF,ItemConsumablePF,ItemContainerPF,ItemEquipmentPF,ItemFeatPF,ItemLootPF,ItemPF,ItemRacePF,ItemSpellPF,ItemWeaponPF},Symbol.toStringTag,{value:"Module"})),V={charges:function(e,t){for(const s of t){const t=this.items.get(s.id);t&&(t.links.charges=e,t.prepareLinks())}}},J=Object.freeze(Object.defineProperty({__proto__:null,LinkFunctions:V},Symbol.toStringTag,{value:"Module"}));class Spellbook{key;actor;data;spells=[];level={};constructor(e,t){this.actor=t,this.data=t.system.attributes.spells.spellbooks[e]}addSpell(e){this.spells.push(e);const t=e.system.level;Math.clamped(t,0,9)===t?(this.level[t]??=new SpellbookLevel(this),this.level[t].spells.push(e)):console.error("Spell with impossible spell level:",e)}}class SpellbookLevel{book;spells=[];constructor(e){this.book=e}}class SpellbookSlots{max;value;domain;domainMax;domainUnused=0;used=0;constructor({value:e=0,max:t=0,domain:s=0}={}){this.value=e??0,this.max=t??0,this.domain=s??0,this.domainMax=this.domain,this.domainUnused=this.domainMax}}class SpellRanges{close;medium;long;cl;constructor(e){this.cl=e,this.close=calculateRange(null,"close",{cl:e}),this.medium=calculateRange(null,"medium",{cl:e}),this.long=calculateRange(null,"long",{cl:e})}}class SpellbookMode{raw;get isHybrid(){return"hybrid"===this.raw}get isPrestige(){return"prestige"===this.raw}get isSpontaneous(){return"spontaneous"===this.raw}get isPrepared(){return"prepared"===this.raw}get usesSpellpoints(){return!0===this.book.spellPoints?.useSystem}get isSemiSpontaneous(){return this.isSpontaneous||this.isHybrid||this.isPrestige||this.usesSpellpoints}constructor(e){this.book=e;let t=e.spellPreparationMode;t||(t=e.spellPreparationMode="spontaneous"),this.raw=t}}const K=Object.freeze(Object.defineProperty({__proto__:null,SpellRanges,Spellbook,SpellbookLevel,SpellbookMode,SpellbookSlots},Symbol.toStringTag,{value:"Module"}));Hooks.on("getActorDirectoryEntryContext",(function sharedVision(e,t){t.push({name:"FFD20.Vision",icon:'<i class="fas fa-eye"></i>',condition:e=>game.user.isGM,callback:e=>{const t=game.actors.get(e.data("documentId"));if(t){const e=t.visionPermissionSheet;e.rendered?e._minimized?e.maximize():e.close():e.render(!0)}}})}));class VisionPermissionSheet extends FormApplication{constructor(e,t){super(e,t),this.object.apps[this.appId]=this}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["sheet","vision-permission"],template:"systems/ffd20/templates/apps/vision-permission.hbs",width:300,height:"auto",closeOnSubmit:!0,submitOnClose:!1,submitOnChange:!1})}get title(){return this.token&&!this.token.data.actorLink?"Vision Permissions: [Token] "+this.object.name:"Vision Permissions: "+this.object.name}get isLinkedToken(){return!!this.token&&this.token.data.actorLink}async _updateObject(e,t){await this.object.setFlag("ffd20","visionPermission",t)}async getData(){let e=super.getData();return e=mergeObject(e,this.object.getFlag("ffd20","visionPermission")),e.users=e.users||{},e.defaultLevels=[{level:"no",name:game.i18n.localize("FFD20.No")},{level:"yes",name:game.i18n.localize("FFD20.Yes")}],e.levels=[{level:"default",name:game.i18n.localize("FFD20.Default")},...e.defaultLevels],null==e.default&&(e.default="no"),e.users=game.users.reduce(((t,s)=>(s.isGM||(t[s.id]={user:s,level:e.users[s.id]?.level||"default",hidden:!1}),t)),{}),e}}class ActorPF extends Actor{constructor(...e){super(...e),void 0===this.itemFlags&&(this.itemFlags={boolean:{},dictionary:{}}),void 0===this.changeItems&&(this.changeItems=[]),void 0===this.changes&&(this.changes=new Collection),void 0===this._queuedUpdates&&(this._queuedUpdates={}),void 0===this._rollData&&(this._rollData=null),void 0===this._runningFunctions&&(this._runningFunctions={}),void 0===this.containerItems&&(this.containerItems=[]),void 0===this._states&&(this._states={}),this.race??=null,this._itemTypes??=null,this._visionPermissionSheet??=null}async _preCreate(e,t,s){await super._preCreate(e,t,s);const n=this.preCreateData(e,t,s);if(void 0===e.img){const e=ffd20.config.defaultIcons.actors[this.type];e&&this.updateSource({img:e})}Object.keys(n).length&&this.updateSource(n)}preCreateData(e,t,s){return{}}static chatListeners(e){e.on("click","button[data-action], a[data-action]",this._onChatCardButtonAction.bind(this))}static async _onChatCardButtonAction(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".chat-card"),n=t.dataset.action;if("defense-save"===n){const n=await ItemPF._getChatCardActor(s),l=t.dataset.save;n&&n.rollSavingThrow(l,{event:e})}else if("save"===n){const s=canvas.tokens.controlled,n=t.dataset.type;let l=!1;for(const t of s){const s=t.actor;s?.rollSavingThrow(n,{event:e,noSound:l}),l=!0}}else if("open-compendium-entry"===n){const e=t.dataset.compendiumEntry,s=await fromUuid(e);s instanceof JournalEntryPage?s.parent.sheet.render(!0,{pageId:s.id}):s.sheet.render(!0)}}static getActiveActor({actorName:e=null,actorId:t=null}={}){foundry.utils.logCompatibilityWarning("ActorPF.getActiveActor() is deprecated in favor of ChatMessage.getSpeakerActor(ChatMessage.getSpeaker())",{since:"PF1 v9",until:"PF1 v10"});const s=ChatMessage.implementation.getSpeaker();let n;return(e||t)&&(n=game.actors.contents.find((s=>(!e||s.name===e)&&(!t||s.id===t)))),s.token&&!n&&(n=canvas.tokens.get(s.token)?.actor),n||(n=game.actors.get(s.actor)),n}static getSelectedActors(){foundry.utils.logCompatibilityWarning("ActorPF.getSelectedActors() is deprecated in favor of canvas.tokens.controlled",{since:"PF1 v9",until:"PF1 v10"});const e=[];for(const t of canvas.tokens.controlled)e.push([t.actor,t]);return e}get spellFailure(){return this.items.filter((e=>"equipment"===e.type&&!0===e.system.equipped)).reduce(((e,t)=>"number"==typeof t.system.spellFailure?e+t.system.spellFailure:e),0)}get race(){return this._race}set race(e){this._race=e;const t=e?.system.creatureType;this.system.traits??={},this.system.traits.type=t,this.system.traits.humanoid="humanoid"===t}get typeColor(){return"#FDE600"}static _translateSourceInfo(e,t,s){let n="";return"size"===e&&(n=game.i18n.localize("FFD20.SourceInfoSize")),"buff"===e&&(n=game.i18n.localize("FFD20.SourceInfoBuffs"),"temp"===t&&(n=game.i18n.localize("FFD20.SourceInfoTemporaryBuffs")),"perm"===t&&(n=game.i18n.localize("FFD20.SourceInfoPermanentBuffs")),"item"===t&&(n=game.i18n.localize("FFD20.SourceInfoItemBuffs")),"misc"===t&&(n=game.i18n.localize("FFD20.SourceInfoMiscBuffs"))),"equipment"===e&&(n=game.i18n.localize("FFD20.SourceInfoEquipment")),"weapon"===e&&(n=game.i18n.localize("FFD20.SourceInfoWeapons")),"feat"===e&&(n=game.i18n.localize("FFD20.SourceInfoFeats"),"classFeat"===t&&(n=game.i18n.localize("FFD20.SourceInfoClassFeatures")),"trait"===t&&(n=game.i18n.localize("FFD20.SourceInfoTraits")),"racial"===t&&(n=game.i18n.localize("FFD20.SourceInfoRacialTraits")),"misc"===t&&(n=game.i18n.localize("FFD20.SourceInfoMiscFeatures")),"template"===t&&(n=game.i18n.localize("FFD20.SourceInfoTemplate"))),"race"===e&&(n=game.i18n.localize("FFD20.SourceInfoRace")),s&&0!==s.length?""===n?s:`${n} (${s})`:n}static _getChangeItemSubtype(e){return"buff"===e.type||"feat"===e.type?e.system.subType:""}get _skillTargets(){const e=[];for(const[t,s]of Object.entries(this.system.skills))if(null!=s){e.push("skill."+t);for(const n of Object.keys(s.subSkills??[]))e.push(`skill.${t}.subSkills.${n}`)}return e}_prepareContainerItems(e){const t=[],getContainerContents=function(e){"container"===e.type&&e.items.forEach((e=>{t.push(e),getContainerContents(e)}))};return e.forEach((e=>{getContainerContents(e)})),t}_prepareItemFlags(e){const t={},s={};for(const n of e){if(n.isActive){const e=n.system.flags?.boolean||{};for(const s of Object.keys(e))t[s]??={sources:[]},t[s].sources.push(n)}const e=n.system.tag;if(e){const t=n.system.flags?.dictionary||{};for(const[l,c]of Object.entries(t))setProperty(s,`${e}.${l}`,n.isActive?c:0)}}this.itemFlags={boolean:t,dictionary:s}}_prepareChanges(){this.changeItems=this.items.filter((e=>e.system.changes instanceof Array&&e.system.changes.length||e.system.changeFlags&&Object.values(e.system.changeFlags).filter((e=>!0===e)).length)).filter((e=>e.isActive));const e=[];for(const t of this.changeItems)e.push(...t.changes);addDefaultChanges.call(this,e);const t=new Collection;for(const s of e)t.set(s._id,s);this.changes=t}applyActiveEffects(){this.containerItems=this._prepareContainerItems(this.items),this._prepareItemFlags(this.allItems),this._prepareChanges(),super.applyActiveEffects()}async expireActiveEffects({combat:e,timeOffset:t=0}={},s={}){if(!this.isOwner)throw Error("Must be owner");const n=game.time.worldTime+t,l=this.temporaryEffects.filter((t=>{const{seconds:s,rounds:l,startTime:c,startRound:u}=t.duration;if(s>0){return s-(n-(c??0))<=0}if(l>0&&e){return l-(e.round-(u??0))<=0}return!1})),c=[],u=[],d=[],m={};for(const e of l){const t=e.origin?.match(/Item\.(?<itemId>\w+)/),s=this.items.get(t?.groups.itemId);if("buff"!==s?.type){const t=e.getFlag("core","statusId");t?m["system.attributes.conditions.-="+t]=null:e.getFlag("ffd20","autoDelete")?u.push(e.id):c.push({_id:e.id,disabled:!0})}else d.push({_id:s.id,"system.active":!1})}s.ffd20??={},s.ffd20.reason="duration";const h=!foundry.utils.isEmpty(m),g=mergeObject({render:!d.length&&!c.length&&!h},s);u.length&&await this.deleteEmbeddedDocuments("ActiveEffect",u,g);const y=mergeObject({render:!d.length&&!h},s);c.length&&await this.updateEmbeddedDocuments("ActiveEffect",c,y);const b=mergeObject({render:!h},s);d.length&&await this.updateEmbeddedDocuments("Item",d,b),h&&await this.update(m,s)}prepareBaseData(){super.prepareBaseData(),this.sourceInfo={},this.changeFlags={},this._itemTypes=null,this.equipment={shield:{type:ffd20.config.shieldTypes.none,id:void 0},armor:{type:ffd20.config.armorTypes.none,id:void 0}},this.classes={},this.system.resources??={},this._resetInherentTotals(),Hooks.callAll("pf1PrepareBaseActorData",this);const e=this.items.filter((e=>"class"===e.type)),{level:t,mythicTier:s}=e.reduce(((e,t)=>(t.prepareDerivedData(),e.level+=t.hitDice,e.mythicTier+=t.mythicTier,e)),{level:0,mythicTier:0});this.system.details.level.value=t,this.system.details.mythicTier=s;for(const e of Object.keys(ffd20.config.conditions))this.system.attributes.conditions[e]??=!1;{const e=Object.keys(this.system.abilities);for(const t of e){const e=this.system.abilities[t].value;null==e?(this.system.abilities[t].total=null,this.system.abilities[t].base=null,this.system.abilities[t].baseMod=0):(this.system.abilities[t].total=e-this.system.abilities[t].drain,this.system.abilities[t].penalty=(this.system.abilities[t].penalty||0)-Math.abs(this.system.abilities[t].userPenalty||0),this.system.abilities[t].base=this.system.abilities[t].total)}this.refreshAbilityModifiers()}{const t="system.attributes.bab.total",s=Math.floor(e.reduce(((e,s)=>{const n=s.system.babBase;return 0!==n&&getSourceInfo(this.sourceInfo,t).positive.push({name:s.name,value:fractionalToString(n)}),e+n}),0));this.system.attributes.bab.total=Math.floor(s)}this._prepareClassSkills(),setProperty(this.system,"attributes.hd.total",this.system.details.level.value)}_prepareClassSkills(){const e=new Set;this.items.filter((e=>["class","race","feat"].includes(e.type))).forEach((t=>{for(const[s,n]of Object.entries(t.system.classSkills||{}))!0===n&&e.add(s)}));for(const[t,s]of Object.entries(this.system.skills))if(s){this.system.skills[t].cs=e.has(t);for(const n of Object.keys(s.subSkills??{}))setProperty(s,`subSkills.${n}.cs`,e.has(t))}else console.warn(`Bad skill data for "${t}"`,this)}hasArmorProficiency(e,t){if("equipment"!==e.type||!["armor","shield"].includes(e.system.subType))return!0;const s=this.system.traits.armorProf?.customTotal?.split(ffd20.config.re.traitSeparator).map((e=>e.trim().toLowerCase())).filter((e=>e.length>0))||[],n=e.name.toLowerCase(),l=e.system.tag;return this.system.traits.armorProf.total.includes(t)||null!=s.find((e=>e.includes(n)||e.includes(l)))}_updateSpellBook(e,t,s){const n=this.system,l=n.attributes.spells.spellbooks[e];if(!l)return void console.error(`Spellbook data not found for "${e} on actor`,this);if(l.label=l.name||game.i18n.localize("FFD20.SpellBook"+e.capitalize()),!l.inUse)return;if(l.name)l.label=l.name;else if(l.class)if("_hd"===l.class)l.label=l.name||game.i18n.localize("FFD20.SpellBookSpelllike");else{const e=this.classes[l.class]?._id,t=this.items.get(e);t&&(l.label=t.name)}t??=this.getRollData({refresh:!0}),s??=this._generateSpellbookCache();const c=s.books[e],u=n.abilities[l.ability],d=RollPF.safeRoll(l.spellSlotAbilityBonusFormula||"0",t).total,m=getAbilityModifier((u?.total??10)+d);let h=0;{const s=`system.attributes.spells.spellbooks.${e}.cl.total`,c=l.cl.formula||"0";let u=0;if("npc"===this.type){const e=l.cl.base||0;u+=e,h+=e,setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.Base"),e)}if("_hd"===l.class){const e=n.attributes.hd.total;u+=e,h+=e,setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.HitDie"),e)}else if(l.class&&t.classes[l.class]){const e=t.classes[l.class].level;u+=e,h+=e,setSourceInfoByName(this.sourceInfo,s,t.classes[l.class].name,e)}if(l.autoSpellLevelCalculation){const e=l.cl.autoSpellLevelCalculationFormula||"0",n=RollPF.safeTotal(e,t),c=Math.clamped(u+n,1,20);l.cl.autoSpellLevelTotal=c,h+=n,0!==n&&setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.AutoSpellClassLevelOffset.Formula"),n)}const d=RollPF.safeRoll(c,t).total;h+=d,d>0?setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.CasterLevelBonusFormula"),d):d<0&&setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.CasterLevelBonusFormula"),d,!1),null!=t.attributes.woundThresholds.penalty&&t.attributes.woundThresholds.penalty>0&&h>1&&(h=Math.max(1,h-t.attributes.woundThresholds.penalty),setSourceInfoByName(this.sourceInfo,s,game.i18n.localize(ffd20.config.woundThresholdConditions[t.attributes.woundThresholds.level]),-t.attributes.woundThresholds.penalty)),t.attributes.energyDrain&&(h=Math.max(0,h-t.attributes.energyDrain),setSourceInfoByName(this.sourceInfo,s,game.i18n.localize("FFD20.CondTypeEnergyDrain"),-Math.abs(t.attributes.energyDrain),!1));h+=l.cl.total??0,l.cl.total=h}{Number.isFinite(l.concentration)&&(console.error(`Bad spellbook concentration value "${l.concentration}" in spellbook "${e}"`),l.concentration={});const s=l.concentrationFormula,c=s.length?RollPF.safeRoll(s,t).total:0,u=n.abilities[l.ability]?.mod??0,d=h+u+c,m=l.concentration.total??0;setSourceInfoByName(this.sourceInfo,`system.attributes.spells.spellbooks.${e}.concentration.total`,game.i18n.localize("FFD20.CasterLevel"),h,!1),setSourceInfoByName(this.sourceInfo,`system.attributes.spells.spellbooks.${e}.concentration.total`,game.i18n.localize("FFD20.SpellcastingAbility"),u,!1),setSourceInfoByName(this.sourceInfo,`system.attributes.spells.spellbooks.${e}.concentration.total`,game.i18n.localize("FFD20.ByBonus"),c,!1),l.concentration={total:m+d}}const getAbilityBonus=e=>0!==e?ActorPF.getSpellSlotIncrease(m,e):0,g=new SpellbookMode(l),y=l.autoSpellLevelCalculation;y&&(l.spellPoints.useSystem=!1);const b=!0===l.spellPoints.useSystem;if((y||b)&&(l.spontaneous=g.isSemiSpontaneous),y){let e=l.casterType;(!e||g.isHybrid&&"high"!==e)&&(l.casterType=e="high"),g.isPrestige&&"low"!==e&&(l.casterType=e="low");const s=ffd20.config.casterProgression[l.spontaneous?"castsPerDay":"spellsPreparedPerDay"][g.raw][e];let n=Math.clamped(l.cl.autoSpellLevelTotal,1,20);if(!Number.isSafeInteger(n)){const e=`Actor ${this.id} has invalid caster class level.`;console.error(e,n),ui.notifications?.error(e),n=Math.floor(n)}t.ablMod=m;const c=l[l.spontaneous?"castPerDayAllOffsetFormula":"preparedAllOffsetFormula"]||"0",u=RollPF.safeTotal(c,t);for(let c=0;c<10;c++){const d=l.spells["spell"+c],m=0===c&&l.spontaneous?ffd20.config.casterProgression.spellsPreparedPerDay[g.raw][e][n-1][c]:s[n-1][c];d.base=m;const h=d[l.spontaneous?"castPerDayOffsetFormula":"preparedOffsetFormula"]||"0",y="number"==typeof m||0===c&&l.hasCantrips?m+getAbilityBonus(c)+u+RollPF.safeTotal(h,t):null;d.max=y,Number.isFinite(d.value)||(d.value=y)}}else for(let e=l.hasCantrips?0:1;e<10;e++){const t=l.spells["spell"+e];let s=parseInt(t.base);Number.isNaN(s)?(t.base=null,t.max=0):l.autoSpellLevels?(s+=getAbilityBonus(e),t.max=s):t.max=s;const n=t.max,c=t.value;Number.isFinite(c)||(t.value=n)}for(let e=0;e<10;e++){const t=l.spells["spell"+e],s=t.value;t.value=s||0}{const e={};for(let t=0;t<10;t++)e[t]=new SpellbookSlots({value:l.spells["spell"+t].max,domain:l.domainSlotValue??0});if(!l.spontaneous)for(let t=0;t<10;t++){const s=c.level[t]?.spells??[],n=e[t];for(const e of s)if(Number.isFinite(e.maxCharges)){const t=e.slotCost,s={domain:0,uses:0};e.isDomain?(s.domain=Math.min(e.maxCharges,n.domain),s.uses=(e.maxCharges-s.domain)*t):s.uses=e.maxCharges*t,n.domain-=s.domain,n.value-=s.uses}l.spells["spell"+t].value=n.value}if(l.autoSpellLevelCalculation){const s=(u?.total??0)-10,n=l.preparedAllOffsetFormula||"0",d=RollPF.safeTotal(n,t),m=l.casterType||"high",h=Math.floor(Math.clamped(l.cl.autoSpellLevelTotal,1,20));for(let n=0;n<10;n++){const u=l.spells["spell"+n];if(s<n){u.lowAbilityScore=!0;continue}let y;if(u.known={unused:0,max:0},u.preparation={unused:0,max:0},g.isPrepared)y=u.value,u.preparation.max=u.max;else{let s=ffd20.config.casterProgression.spellsPreparedPerDay[g.raw][m]?.[h-1][n];s+=d;const l=u.preparedOffsetFormula||"0";s+=RollPF.safeTotal(l,t),u.known.max=s;let b=e[n].domain;const F=c.level[n]?.spells.reduce(((e,t)=>{const{preparation:s,atWill:n,domain:l}=t.system;if(!n&&s.spontaneousPrepared){const s=t.slotCost;l&&b>0?b-=s:e+=s}return e}),0)??0;e[n].domainUnused=b,e[n].used=F,y=s-F}if(!y){u.spellMessage="";continue}let b="";y<0?(b=game.i18n.format("FFD20.TooManySpells",{quantity:Math.abs(y)}),g.isSpontaneous?u.unusedKnown=y:u.preparation.unused=y):y>0&&(g.isSpontaneous?(b=1===y?game.i18n.localize("FFD20.LearnMoreSpell"):game.i18n.format("FFD20.LearnMoreSpells",{quantity:y}),u.known.unused=y):(b=1===y?game.i18n.localize("FFD20.PrepareMoreSpell"):game.i18n.format("FFD20.PrepareMoreSpells",{quantity:y}),u.preparation.unused=y)),u.spellMessage=b}}}if(b){const e=l.spellPoints.maxFormula||"0";t.cl=l.cl.total,t.ablMod=m;const s=l.class??"";t.classLevel="_hd"===s?t.attributes.hd?.total??t.details.level.value:t.classes[s]?.level||0;const n=RollPF.safeRoll(e,t);l.spellPoints.max=n.total}else l.spellPoints.max=0;l.range=new SpellRanges(l.cl.total)}_generateSpellbookCache(){const e=Object.keys(this.system.attributes.spells.spellbooks),t=this.items.filter((e=>"spell"===e.type)),s={spells:t,books:{}};return e.forEach((e=>{s.books[e]??=new Spellbook(e,this)})),t.forEach((t=>{const n=t.system.spellbook;if(!e.includes(n))return console.error("Spell has invalid book",t);s.books[n].addSpell(t)})),s}updateSpellbookInfo(e,t){e??=this.getRollData({refresh:!0}),t??=this._generateSpellbookCache();const s=this.system.attributes.spells.spellbooks;for(const n of Object.keys(s))this._updateSpellBook(n,e,t);this.system.attributes.spells.usedSpellbooks=Object.keys(s).filter((e=>s[e].inUse))}refreshDerivedData(){this.system.attributes.maxDexBonus=null,this.system.abilities.dex.maxBonus=this.system.abilities.dex.mod;{const e=this._computeEncumbrance(),t=this._applyArmorPenalties();this.system.attributes.acp.encumbrance=e.acp,this.system.attributes.acp.gear=t.acp,this.system.attributes.acp.total=Math.max(e.acp,t.acp),null==e.maxDexBonus&&null==t.maxDexBonus||(this.system.attributes.maxDexBonus=Math.min(e.maxDexBonus??1/0,t.maxDexBonus??1/0),this.system.abilities.dex.maxBonus=Math.min(this.system.abilities.dex.maxBonus,this.system.attributes.maxDexBonus))}}prepareDerivedData(){super.prepareDerivedData(),this.prepareProficiencies(),this.getRollData({refresh:!0}),this.items.forEach((e=>{e.prepareDerivedItemData(),this.updateItemResources(e)})),applyChanges.call(this),this.prepareSpecificDerivedData(),this.prepareCMB(),this.prepareItemLinks(),this.getRollData({refresh:!0}),this.items.forEach((e=>{e.prepareDerivedItemData(),this.updateItemResources(e)})),this._initialized=!0,this._setSourceDetails(this.sourceInfo)}prepareProficiencies(){const e=this.system,t={armorProf:ffd20.config.armorProficiencies,weaponProf:ffd20.config.weaponProficiencies,languages:ffd20.config.languages};for(const[s,n]of Object.entries(t)){const t=e.traits[s]?.custom?.split(ffd20.config.re.traitSeparator).filter((e=>e.length>0))||[],l=this.items.reduce(((e,l)=>{if(hasProperty(l,"system."+s)){let c=getSourceInfo(this.sourceInfo,"system.traits."+s).positive.find((e=>e.name===l.name));const u=!!c;c?"string"==typeof c.value&&(c.value=c.value.split(", ")):c={name:l.name,value:[]};for(const t of l.system[s].value)c.value.includes(t)||c.value.push(n[t]),e.includes(t)||e.push(t);const d=l.system[s].custom?.split(ffd20.config.re.traitSeparator).map((e=>e.trim())).filter(((e,t,s)=>e.length>0&&s.indexOf(e)===t))||[];c.value.push(...d),t.push(...d),c.value.length>0&&(u&&(c.value=[...new Set(c.value)]),c.value=c.value.join(", "),u||getSourceInfo(this.sourceInfo,"system.traits."+s).positive.push(c))}return e}),[...e.traits[s]?.value??[]]);e.traits[s]??={},e.traits[s].total=[...l],e.traits[s].customTotal=t.join(";")}}prepareCMB(){const e=this.system.attributes.attack.shared??0,t=this.system.attributes.attack.general??0,s=this.system.attributes.cmbAbility,n=this.system.abilities[s]?.mod??0,l=this.system.traits.size,c=e+t+(ffd20.config.sizeSpecialMods[l]??0)+(this.system.attributes.cmb.bonus??0)+n;this.system.attributes.cmb.total=c}prepareSpecificDerivedData(){Hooks.callAll("pf1PrepareDerivedActorData",this),this.refreshDerivedData();const e=this.system.attributes,t=this.system.abilities;for(const e of Object.keys(t)){const s=t[e].base,n=t[e].penalty||0,l=t[e].damage;t[e].baseMod=getAbilityModifier(s,{penalty:n,damage:l})}const s=this.system,n=s,l=game.settings.get("ffd20","healthConfig"),c={up:Math.ceil,nearest:Math.round,down:Math.floor}[l.rounding];for(const t of["hp","vigor"])e[t].max=c(e[t].max);for(const e of["hp","wounds","vigor"]){const t=this.system.attributes[e];Number.isFinite(t?.offset)&&(t.value=t.max+t.offset)}{const t=e.bab.total-e.acp.attackPenalty-(e.energyDrain??0);e.attack.shared=t}this.updateWoundThreshold();for(const e of ffd20.config.arbitrarySkills){if(null==n.skills[e])continue;const t=n.skills[e];t.subSkills=t.subSkills||{};for(const e of Object.keys(t.subSkills))null==t.subSkills[e]&&delete t.subSkills[e]}for(const e of Object.keys(n.skills)){null==n.skills[e]&&delete n.skills[e]}for(const e of Object.keys(n.skills))if(ffd20.config.backgroundSkills.includes(e)){const t=n.skills[e];t.background=!0;for(const e of Object.keys(t.subSkills??{}))t.subSkills[e].background=!0}for(const t of["ac.normal.total","ac.shield.total","ac.natural.total"]){const n=getProperty(s,t);if(n)for(const t of["normal","flatFooted"])e.ac[t].total+=n}{const s=e.ac.normal.ability??"dex",n=e.ac.touch.ability??"dex",l=e.cmd.dexAbility??"dex";let c=t[s]?.mod??0,u=t[n]?.mod??0;const d=t[l]?.mod??0;this.changeFlags.loseDexToAC&&(c=Math.min(c,0),u=Math.min(u,0));const m=e.maxDexBonus??null,h={normal:null!==m?Math.min(m,c):c,touch:null!==m?Math.min(m,u):u,flatFooted:Math.min(0,c)},g={normal:s,touch:n,flatFooted:s},y={total:d,flatFootedTotal:Math.min(0,d)};for(const[t,s]of Object.entries(h))e.ac[t].total+=s,getSourceInfo(this.sourceInfo,`system.attributes.ac.${t}.total`).positive.push({value:s,name:ffd20.config.abilities[g[t]]});for(const[t,s]of Object.entries(y))e.cmd[t]+=s,getSourceInfo(this.sourceInfo,"system.attributes.cmd."+t).positive.push({value:s,name:ffd20.config.abilities[l]})}{const t=this.items.filter((e=>"equipment"===e.type));let s=!1;const n={name:"",value:game.i18n.localize("FFD20.ReducedMovementSpeed")};if(e.encumbrance.level>=ffd20.config.encumbranceLevels.medium&&!this.changeFlags.noEncumbrance&&(s=!0,n.name=game.i18n.localize("FFD20.Encumbrance")),t.filter((e=>"mediumArmor"===e.system.equipmentSubtype&&e.system.equipped)).length&&!this.changeFlags.mediumArmorFullSpeed&&(s=!0,n.name=game.i18n.localize("FFD20.EquipTypeMedium")),t.filter((e=>"heavyArmor"===e.system.equipmentSubtype&&e.system.equipped)).length&&!this.changeFlags.heavyArmorFullSpeed&&(s=!0,n.name=game.i18n.localize("FFD20.EquipTypeHeavy")),s)for(const e of Object.keys(this.system.attributes.speed)){const t=this.system.attributes.speed[e].total;this.system.attributes.speed[e].total=this.constructor.getReducedMovementSpeed(t),t>0&&getSourceInfo(this.sourceInfo,`system.attributes.speed.${e}.add`).negative.push(n)}}switch(e.encumbrance.level){case ffd20.config.encumbranceLevels.medium:getSourceInfo(this.sourceInfo,"system.attributes.acp.total").negative.push({name:game.i18n.localize("FFD20.Encumbrance"),value:3}),getSourceInfo(this.sourceInfo,"system.attributes.maxDexBonus").negative.push({name:game.i18n.localize("FFD20.Encumbrance"),value:3});break;case ffd20.config.encumbranceLevels.heavy:getSourceInfo(this.sourceInfo,"system.attributes.acp.total").negative.push({name:game.i18n.localize("FFD20.Encumbrance"),value:6}),getSourceInfo(this.sourceInfo,"system.attributes.maxDexBonus").negative.push({name:game.i18n.localize("FFD20.Encumbrance"),value:1})}this.updateSpellbookInfo()}getLabels(){const e={};e.race=this.race?game.i18n.format("FFD20.RaceTitle",{name:this.race.name}):game.i18n.localize("FFD20.Race"),e.alignment=ffd20.config.alignments[this.system.details.alignment],e.speed={};for(const[t,s]of Object.entries(this.system.attributes.speed??{})){const n=ffd20.utils.convertDistance(s.total);e.speed[t]=`${n[0]} ${ffd20.config.measureUnitsShort[n[1]]}`}return e}_applyArmorPenalties(){const e={armor:{lightArmor:"lgt",mediumArmor:"med",heavyArmor:"hvy"},shield:{other:"shl",lightShield:"shl",heavyShield:"shl",towerShield:"twr"}};let t=0;const s={armor:0,shield:0},n={armor:{value:0,item:null},shield:{value:0,item:null}},l={armor:null,shield:null};this.items.filter((e=>"equipment"===e.type&&e.system.equipped)).forEach((c=>{const u=c.system.subType,d=["armor","shield"].includes(u);let m=Math.abs(c.system.armor.acp);!0===c.system.masterwork&&d&&(m=Math.max(0,m-1)),d&&(m=Math.max(0,m+(this.system.attributes?.acp?.[u+"Bonus"]??0)));let h=0;if(c.system.broken&&(h=m,m*=2),m){const e=getSourceInfo(this.sourceInfo,"system.attributes.acp.total").negative.find((e=>e.itemId===c.id));h&&(n[u].value=h,n[u].item=c),e?e.value=m:getSourceInfo(this.sourceInfo,"system.attributes.acp.total").negative.push({name:c.name,itemId:c.id,value:m})}if(d&&(m>s[u]&&(s[u]=m),this.hasArmorProficiency(c,e[u][c.system.equipmentSubtype])||(t+=m)),null!==c.system.armor.dex&&d){const e=Number.parseInt(c.system.armor.dex,10);if(Number.isInteger(e)){const t=e+(this.system.attributes?.mDex?.[u+"Bonus"]??0);l[u]=Math.min(t,l[u]??1/0);const s=getSourceInfo(this.sourceInfo,"system.attributes.maxDexBonus").negative.find((e=>e.itemId===c.id));s?s.value=e:getSourceInfo(this.sourceInfo,"system.attributes.maxDexBonus").negative.push({name:c.name,itemId:c.id,value:e,ignoreNull:!1})}}}));{const e=game.i18n.localize("FFD20.Broken");for(const t of Object.keys(n)){const s=n[t].value;if(0==s)continue;const l=n[t].item.id,c=getSourceInfo(this.sourceInfo,`system.attributes.acp.${t}Bonus`).negative.find((e=>e.brokenId===l));c?c.value=s:getSourceInfo(this.sourceInfo,`system.attributes.acp.${t}Bonus`).negative.push({name:e,brokenId:l,value:s})}}const c=s.armor+s.shield,u={maxDexBonus:null,acp:c};return this.system.attributes.acp.gear=c,null===l.armor&&null===l.shield||(u.maxDexBonus=Math.min(l.armor??1/0,l.shield??1/0)),this.system.attributes.acp.attackPenalty=t,u}prepareItemLinks(){if(this.items)for(const e of this.items)if(null!=e.system.links)for(const t of Object.keys(e.system.links))null!=V[t]&&V[t].call(this,e,e.system.links[t])}_setSourceDetails(e){const t=this.system,s={};for(const e of Object.keys(ffd20.config.buffTargets)){const t=getChangeFlat.call(this,e,null);for(const e of t)s[e]||(s[e]=[])}s["system.attributes.bab.total"]=[],s["system.attributes.ac.normal.total"].push({name:game.i18n.localize("FFD20.Base"),value:10}),s["system.attributes.ac.touch.total"].push({name:game.i18n.localize("FFD20.Base"),value:10}),s["system.attributes.ac.flatFooted.total"].push({name:game.i18n.localize("FFD20.Base"),value:10}),s["system.attributes.cmd.total"].push({name:game.i18n.localize("FFD20.Base"),value:10}),s["system.attributes.cmd.flatFootedTotal"].push({name:game.i18n.localize("FFD20.Base"),value:10});for(const[e,n]of Object.entries(t.abilities))s[`system.abilities.${e}.total`].push({name:game.i18n.localize("FFD20.Base"),value:n.value}),null!=n.damage&&0!==n.damage&&s[`system.abilities.${e}.total`].push({name:game.i18n.localize("FFD20.AbilityDamage"),value:`-${Math.floor(Math.abs(n.damage)/2)} (Mod only)`}),null!=n.drain&&0!==n.drain&&s[`system.abilities.${e}.total`].push({name:game.i18n.localize("FFD20.AbilityDrain"),value:-Math.abs(n.drain)});{const e=game.settings.get("ffd20","healthConfig").variants;if(("npc"===this.type?e.npc.useWoundThresholds:e.pc.useWoundThresholds)>0){const e=this.getWoundThresholdData(t);if(e.level>0){const t=["~attackCore","cmd","init","allSavingThrows","ac","skills","abilityChecks"];for(const n of t){const t=getChangeFlat.call(this,n,"penalty");for(const n of t)n&&s[n].push({name:game.i18n.localize(ffd20.config.woundThresholdConditions[e.level]),value:-e.penalty})}}}}const n=this.getRollData();for(const[t,l]of Object.entries(e))for(const e of Object.values(l))if(e.length>0){s[t]=s[t]||[];for(const l of e){l.operator||(l.operator="add");const e=this.constructor._translateSourceInfo(l.type,l.subtype,l.name);let c=null!=l.value?l.value:RollPF.safeRoll(l.formula||"0",n,[t,l,this],{suppressError:!this.testUserPermission(game.user,"OWNER")}).total;"set"===l.operator&&(c=game.i18n.format("FFD20.SetTo",{value:c})),"add"===l.operator&&0===c&&!1!==l.ignoreNull||s[t].push({name:e.replace(/[[\]]/g,""),modifier:l.modifier||"",value:c})}}this.sourceDetails=s}_getInherentTotalsKeys(){const e={"attributes.ac.normal.total":10,"attributes.ac.touch.total":10,"attributes.ac.flatFooted.total":10,"attributes.bab.total":0,"attributes.bab.value":0,"attributes.cmd.total":10,"attributes.cmd.flatFootedTotal":10,"attributes.acp.armorBonus":0,"attributes.acp.shieldBonus":0,"attributes.acp.gear":0,"attributes.acp.encumbrance":0,"attributes.acp.total":0,"attributes.acp.attackPenalty":0,"attributes.maxDexBonus":null,"ac.normal.total":0,"ac.normal.base":0,"ac.normal.enh":0,"ac.normal.misc":0,"ac.natural.total":0,"ac.natural.base":0,"ac.natural.misc":0,"ac.natural.enh":0,"ac.shield.total":0,"ac.shield.base":0,"ac.shield.enh":0,"ac.shield.misc":0,"attributes.sr.total":0,"attributes.init.bonus":0,"attributes.init.total":0,"attributes.cmb.bonus":0,"attributes.cmb.total":0,"attributes.cmb.value":0,"attributes.hp.max":this.system.attributes.hp.base??0,"attributes.vigor.max":this.system.attributes.vigor.base??0,"attributes.wounds.max":this.system.attributes.wounds.base??0,"attributes.mp.max":this.system.attributes.mp.base??0,"attributes.attack.general":0,"attributes.attack.melee":0,"attributes.attack.ranged":0,"attributes.attack.critConfirm":0,"attributes.mDex":{armorBonus:0,shieldBonus:0},"attributes.damage.general":0,"attributes.damage.weapon":0,"attributes.damage.spell":0,"attributes.damage.shared":0,"attributes.woundThresholds.level":0,"attributes.woundThresholds.mod":0,"attributes.woundThresholds.override":-1,"attributes.woundThresholds.penaltyBase":0,"attributes.woundThresholds.penalty":0,"abilities.str.checkMod":0,"abilities.dex.checkMod":0,"abilities.con.checkMod":0,"abilities.int.checkMod":0,"abilities.wis.checkMod":0,"abilities.cha.checkMod":0,"attributes.spells.spellbooks.primary.concentration.total":0,"attributes.spells.spellbooks.secondary.concentration.total":0,"attributes.spells.spellbooks.tertiary.concentration.total":0,"attributes.spells.spellbooks.quaternary.concentration.total":0,"attributes.spells.spellbooks.spelllike.concentration.total":0,"attributes.spells.spellbooks.primary.cl.total":0,"attributes.spells.spellbooks.secondary.cl.total":0,"attributes.spells.spellbooks.tertiary.cl.total":0,"attributes.spells.spellbooks.quaternary.cl.total":0,"attributes.spells.spellbooks.spelllike.cl.total":0,"details.carryCapacity.bonus.total":0,"details.carryCapacity.multiplier.total":0};try{const t=getChangeFlat.call(this,"skills");for(const s of t)e[s.replace(/^system\./,"")]=0}catch(e){console.error("Could not determine skills for an actor",this)}return e}_resetInherentTotals(){const e=this._getInherentTotalsKeys();for(const[t,s]of Object.entries(e))try{setProperty(this.system,t,s)}catch(e){console.log(e,t)}}static getReducedMovementSpeed(e){return e-5*Math.floor(e/5/3)}static getSpellSlotIncrease(e,t){return 0===t||e<=0?0:Math.max(0,Math.ceil((e+1-t)/4))}getLevelExp(e){return 0}async _preUpdate(e,t,s){if(await super._preUpdate(e,t,s),this._syncTokenImage(e),!e.system)return;const n=this.system,l=e.system.attributes;if(this._initialized&&null!=l)for(const e of["hp","wounds","vigor"]){const t=l[e];if(t&&(void 0!==t.value&&void 0===t.offset)){const s=t.max??n.attributes[e]?.max;t.offset=t.value-s}}const c=e.system.traits?.size;if(void 0!==c&&void 0!==n.traits.size){const t=ffd20.config.tokenSizes[c];this.isToken||this.prototypeToken.flags?.ffd20?.staticSize||(e.token||(e.token={}),e.token.width=t.w,e.token.height=t.h,e.token.scale=t.scale)}const u=e.system.abilities;if(u){const e=["userPenalty","damage","drain"],t=Object.keys(u);for(const s of t)for(const t of e)void 0!==u[s][t]&&(u[s][t]=Math.abs(u[s][t]))}const d=e.system.attributes?.energyDrain;void 0!==d&&(e.system.attributes.energyDrain=Math.abs(d));const m=e.system.attributes?.conditions;if(m){const e=Object.keys(m);for(const t of Object.values(ffd20.config.conditionTracks)){const s=e.find((e=>t.includes(e)));if(s)for(const e of t)e!==s&&(m["-="+e]=null)}}this._updateExp(e)}_syncTokenImage(e){e.img&&void 0===e.prototypeToken?.texture?.src&&this.prototypeToken.texture.src===ffd20.config.defaultIcons.actors[this.type]&&this.img===this.prototypeToken.texture.src&&this.updateSource({"prototypeToken.texture.src":e.img})}_onUpdate(e,t,s){if(super._onUpdate(e,t,s),!e.system)return;const n=game.user.id===s;let l=!1,c=!1;if(hasProperty(e.system,"attributes.conditions")?game.user.id===s&&this.toggleConditionStatusIcons({render:!1}):hasProperty(e.system,"traits.senses")?(l=!0,e.system.traits.senses.ll&&(c=!0)):e.flags?.ffd20?.visionPermissions&&(l=!0,c=!0),(l||c)&&this.testUserPermission(game.user,"OBSERVER")){const e={refreshLighting:!0,refreshVision:!0};if(l){for(const e of this.getActiveTokens(!1,!0))e._syncSenses();e.initializeVision=!0}c&&(e.initializeLighting=!0),canvas.perception.update(e,!0)}const u=e.system.traits?.size;if(n&&u){const e=CONFIG.FFD20.tokenSizes[u],t=this.getActiveTokens(!1,!0).filter((e=>!e.getFlag("ffd20","staticSize"))),s=t[0]?.object.scene;s?.updateEmbeddedDocuments("Token",t.map((t=>({_id:t.id,width:e.w,height:e.h,texture:{scaleX:e.scale,scaleY:e.scale}}))))}}_onCreateEmbeddedDocuments(e,t,s,n,l){if(super._onCreateEmbeddedDocuments(...arguments),l===game.user.id&&"Item"===e){t.some((e=>"buff"===e.type&&e.isActive))&&this.toggleConditionStatusIcons({render:!1});const e=t.find((e=>"race"===e.type));e?.system.size&&this.system.traits.size!==e.system.size&&this.update({"system.traits.size":e.system.size})}}_onUpdateEmbeddedDocuments(e,t,s,n,l){super._onUpdateEmbeddedDocuments(e,t,s,n,l),l===game.user.id&&"Item"===e&&t.some((e=>"buff"===e.type&&s.some((t=>t._id==e.id&&void 0!==t.system?.active))))&&this.toggleConditionStatusIcons({render:!1})}updateItemResources(e){if(e.isCharged){if(e.isSingleUse)return!1;const t=e.system.useCustomTag?e.system.tag:createTag(e.name),s={value:e.charges,max:e.maxCharges,_id:e.id};return this.system.resources[t]=s,!0}return!1}async createAttackFromWeapon(e){if("weapon"!==e.type)throw Error("Wrong Item type");if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const t=e.toObject().system,s={name:e.name,type:"attack",img:e.img,system:{subType:"weapon",held:t.held,masterwork:t.masterwork,proficient:t.proficient,enh:t.enh,broken:t.broken,baseTypes:t.baseTypes,tags:t.tags,weaponGroups:t.weaponGroups,actions:deepClone(t.actions??[])}};for(const e of s.system.actions)e._id=randomID(16);const[n]=await this.createEmbeddedDocuments("Item",[s]);if(!n)throw Error("Failed to create attack from weapon");return await e.createItemLink("children","data",n,n.id),ui.notifications.info(game.i18n.format("FFD20.NotificationCreatedAttack",{item:e.name})),await e.update({"system.showInQuickbar":!1}),n}createSpellbook(e={}){const t=this.system.attributes.spells.spellbooks??{},s=e.class?Object.entries(t).find((([t,s])=>!!s.class&&s.class===e.class)):null;let n;if(s){if(s[1].inUse)return void ui.notifications.warn(game.i18n.localize("FFD20.ErrorSpellbookExists"));n=s[0]}else{const e=Object.entries(t).find((([e,t])=>!0!==t.inUse));if(void 0===e)return void ui.notifications.warn(game.i18n.localize("FFD20.ErrorNoFreeSpellbooks"));n=e[0]}e.type??="prepared",e.class??="_hd",e.progression??="high",e.spells??="arcane",e.ability??="int",e.cantrips??=!0,e.domainSlots??=1;const l={["system.attributes.spells.spellbooks."+n]:{inUse:!0,class:e.class,spellPreparationMode:e.type,casterType:e.progression,ability:e.ability,psychic:"psychic"===e.spells,arcaneSpellFailure:"arcane"===e.spells,hasCantrips:e.cantrips,domainSlotValue:e.domainSlots}};return this.update(l)}getSkillInfo(e,{rollData:t}={}){let s,n,l;const[c,u,d]=e.split(".",3),m="subSkills"===u&&!!d,h=this.system.skills[c];if(!h)throw Error(`Invalid skill ID '${e}'`);if(m){if(s=h.subSkills[d],!s)throw Error(`Invalid skill ID '${e}'`);n=`${ffd20.config.skills[c]} (${s.name})`,l=this.getSkillInfo(c)}else s=h,n=s.name??ffd20.config.skills[e];t??=this.getRollData();const g=getProperty(t.skills,e);if(!g)throw Error(`Invalid skill ID '${e}'`);const y=deepClone(g);return y.name=n,y.id=e,l&&(y.parentSkill=l),y}async rollSkill(e,t={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const s=this.getSkillInfo(e),n=/^(?<mainSkillId>\w+).subSkills.(?<subSkillId>\w+)$/.exec(e),{mainSkillId:l,subSkillId:c}=n?.groups??{},u=!!c,d=this.getRollData(),m=this.getContextNotes("skill."+e);u&&m.push(...this.getContextNotes("skill."+l));const h=this.formatContextNotes(m,d);s.rt&&!s.rank&&h.push(game.i18n.localize("FFD20.Untrained"));const g=[],y=getHighestChanges(this.changes.filter((t=>{const s=getChangeFlat.call(this,t.subTarget,t.modifier);return!(!u||!s.includes(`system.skills.${l}.changeBonus`))||s.includes(`system.skills.${e}.changeBonus`)})),{ignoreTarget:!0});s.ability&&g.push(`@abilities.${s.ability}.mod[${ffd20.config.abilities[s.ability]}]`),s.rank>0&&(g.push(`${s.rank}[${game.i18n.localize("FFD20.SkillRankPlural")}]`),s.cs&&g.push(`${ffd20.config.classSkillBonus}[${game.i18n.localize("FFD20.CSTooltip")}]`)),s.acp&&0!==d.attributes.acp.total&&g.push(`-@attributes.acp.total[${game.i18n.localize("FFD20.ACPLong")}]`),d.attributes.woundThresholds?.penalty>0&&g.push(`- @attributes.woundThresholds.penalty[${game.i18n.localize(ffd20.config.woundThresholdConditions[d.attributes.woundThresholds.level])}]`);for(const e of y)e.value&&("string"==typeof e.value&&RollPF.parse(e.value).length>1?g.push(`(${e.value})[${e.flavor}]`):g.push(`${e.value}[${e.flavor}]`));const b=[];h.length>0&&b.push({header:game.i18n.localize("FFD20.Notes"),value:h});const F=t.token??this.token,k={...t,parts:g,rollData:d,flavor:game.i18n.format("FFD20.SkillCheck",{skill:s.name}),chatTemplateData:{hasProperties:b.length>0,properties:b},compendium:{entry:ffd20.config.skillCompendiumEntries[e]??s.journal,type:"JournalEntry"},subject:{skill:e},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:F,alias:F?.name})};if(!1===Hooks.call("pf1PreActorRollSkill",this,k,e))return;const v=await ffd20.dice.d20Roll(k);return v&&Hooks.callAll("pf1ActorRollSkill",this,v,e),v}async rollBAB(e={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const t=e.token??this.token,s={...e,parts:[`${this.system.attributes.bab.total}[${game.i18n.localize("FFD20.BABAbbr")}]`],subject:{core:"bab"},flavor:game.i18n.localize("FFD20.BAB"),speaker:ChatMessage.implementation.getSpeaker({actor:this,token:t,alias:t?.name})};if(!1===Hooks.call("pf1PreActorRollBab",this,s))return;const n=await ffd20.dice.d20Roll(s);return Hooks.callAll("pf1ActorRollBab",this,n),n}async rollCMB(e={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));e.ranged??=!1,e.ability??=null;const t=this.getRollData(),s=this.getContextNotes("misc.cmb"),n=this.formatContextNotes(s,t),l=[],describePart=(e,t)=>l.push(`${e}[${t}]`),srcDetails=e=>e?.reverse().forEach((e=>describePart(e.value,e.name)));srcDetails(this.sourceDetails["system.attributes.cmb.bonus"]),srcDetails(this.sourceDetails["system.attributes.attack.shared"]);const c=this.system.traits.size??"med";t.sizeBonus=ffd20.config.sizeSpecialMods[c],0!=t.sizeBonus&&l.push(`@sizeBonus[${game.i18n.localize("FFD20.Size")}]`);const u=["attack"];!0===e.ranged?u.push("rattack"):u.push("mattack");getHighestChanges(this.changes.filter((e=>u.includes(e.subTarget))),{ignoreTarget:!0}).forEach((e=>describePart(e.value,e.flavor)));const d=e.ability??this.system.attributes.cmbAbility,m=this.system.abilities[d]?.mod??0;0!=m&&describePart(m,ffd20.config.abilities[d]),this.system.attributes.conditions.grappled&&n.push("+2 to Grapple");const h=[];n.length>0&&h.push({header:game.i18n.localize("FFD20.Notes"),value:n});const g=e.token??this.token,y={...e,parts:l,rollData:t,subject:{core:"cmb"},flavor:game.i18n.localize("FFD20.CMB"),chatTemplateData:{hasProperties:h.length>0,properties:h},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:g,alias:g?.name})};if(!1===Hooks.call("pf1PreActorRollCmb",this,y))return;const b=await ffd20.dice.d20Roll(y);return Hooks.callAll("pf1ActorRollCmb",this,b),b}async rollAttack(e={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));e.melee??=!0;const t=[...this.sourceDetails["system.attributes.attack.shared"]],s=this.getRollData(),n=[...this.getContextNotes("attacks.effect"),...this.getContextNotes("attacks.attack")],l=this.formatContextNotes(n,s);s.item={};const c=t.filter((e=>Number.isInteger(e.value))).map((e=>`${e.value}[${e.name}]`)),u=["attack"].concat(e.melee?["mattack"]:["rattack"]),d=this.changes.filter((e=>u.includes(e.subTarget)));c.push(...d.map((e=>(e.applyChange(this),`${e.value}[${e.parent?e.parent.name:e.data.modifier}]`))));const m=this.system.attributes?.attack?.[(e.melee?"melee":"ranged")+"Ability"];c.push(`${this.system.abilities[m].mod}[${ffd20.config.abilities[m]}]`);const h=this.system.traits.size??"med";s.sizeBonus=ffd20.config.sizeMods[h],0!=s.sizeBonus&&c.push(`@sizeBonus[${game.i18n.localize("FFD20.Size")}]`);const g=[];l.length>0&&g.push({header:game.i18n.localize("FFD20.Notes"),value:l});const y=e.token??this.token,b={...e,parts:c,rollData:s,subject:{core:"attack"},flavor:game.i18n.localize("FFD20."+(e.melee?"Melee":"Ranged")),chatTemplateData:{hasProperties:g.length>0,properties:g},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:y,alias:y?.name})};if(!1===Hooks.call("pf1PreActorRollAttack",this,b))return;const F=await ffd20.dice.d20Roll(b);return Hooks.callAll("pf1ActorRollAttack",this,F),F}async rollCL(e,t={}){const s=this.system.attributes.spells.spellbooks[e],n=duplicate(this.getRollData());n.cl=s.cl.total;const l=[];var c;c=this.sourceDetails[`system.attributes.spells.spellbooks.${e}.cl.total`],c?.reverse().forEach((e=>{return t=e.value,s=e.name,l.push(`${t}[${s}]`);var t,s}));const u=this.getContextNotesParsed("spell.cl."+e),d=this.getWoundThresholdData();d.valid&&u.push(game.i18n.localize(ffd20.config.woundThresholdConditions[d.level]));const m=[];u.length>0&&m.push({header:game.i18n.localize("FFD20.Notes"),value:u});const h=t.token??this.token,g={...t,parts:l,rollData:n,subject:{core:"cl",spellbook:e},flavor:game.i18n.localize("FFD20.CasterLevelCheck"),chatTemplateData:{hasProperties:m.length>0,properties:m},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:h,alias:h?.name})};if(!1===Hooks.call("pf1PreActorRollCl",this,g,e))return;const y=await ffd20.dice.d20Roll(g);return Hooks.callAll("pf1ActorRollCl",this,y,e),y}async rollConcentration(e,t={}){const s=this.system.attributes.spells.spellbooks[e],n=duplicate(this.getRollData());if(n.cl=s.cl.total,n.mod=this.system.abilities[s.ability]?.mod??0,!1===Hooks.call("actorRoll","pf1PreActorRollConcentration",void 0,this,"concentration",e,t))return;const l=[];var c;c=this.sourceDetails[`system.attributes.spells.spellbooks.${e}.concentration.total`],c?.reverse().forEach((e=>{return t=e.value,s=e.name,l.push(`${t}[${s}]`);var t,s}));const u=this.getContextNotesParsed("spell.concentration."+e),d=this.getWoundThresholdData();d.valid&&u.push(game.i18n.localize(ffd20.config.woundThresholdConditions[d.level]));const m=[];u.length>0&&m.push({header:game.i18n.localize("FFD20.Notes"),value:u});let h=0;s.concentrationFormula.length&&(h=RollPF.safeRoll(s.concentrationFormula,n).total),n.formulaBonus=h;const g=t.token??this.token,y={...t,parts:l,rollData:n,subject:{core:"concentration",spellbook:e},flavor:game.i18n.localize("FFD20.ConcentrationCheck"),chatTemplateData:{hasProperties:m.length>0,properties:m},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:g,alias:g?.name})};if(!1===Hooks.call("pf1PreActorRollConcentration",this,y,e))return;const b=ffd20.dice.d20Roll(y);return Hooks.callAll("pf1ActorRollConcentration",this,b,e),b}getDefenseHeaders({damageResistances:e=!0,damageVulnerabilities:t=!0}={}){const s=this.system,n=[],l=ffd20.config.re.traitSeparator,c=[],u=ffd20.registry.damageTypes.getLabels();if(e&&(s.traits.dr.length&&n.push({header:game.i18n.localize("FFD20.DamRed"),value:s.traits.dr.split(l)}),s.traits.eres.length&&n.push({header:game.i18n.localize("FFD20.EnRes"),value:s.traits.eres.split(l)})),t&&(s.traits.dv.value.length||s.traits.dv.custom.length)){const e=[].concat(s.traits.dv.value.map((e=>u[e])),s.traits.dv.custom.length>0?s.traits.dv.custom.split(";"):[]);n.push({header:game.i18n.localize("FFD20.DamVuln"),value:e})}if(s.traits.cres.length&&n.push({header:game.i18n.localize("FFD20.ConRes"),value:s.traits.cres.split(l)}),s.traits.di.value.length||s.traits.di.custom.length||s.traits.ci.value.length||s.traits.ci.custom.length){const e=[].concat(s.traits.di.value.map((e=>u[e])),s.traits.di.custom.length>0?s.traits.di.custom.split(";"):[],s.traits.ci.value.map((e=>ffd20.config.conditionTypes[e])),s.traits.ci.custom.length>0?s.traits.ci.custom.split(";"):[]);n.push({header:game.i18n.localize("FFD20.ImmunityPlural"),value:e})}return s.attributes.sr.total>0&&c.push(game.i18n.format("FFD20.SpellResistanceNote",{value:s.attributes.sr.total})),c.length>0&&n.push({header:game.i18n.localize("FFD20.MiscShort"),value:c}),n}getInitiativeContextNotes(){const e=this.getContextNotes("misc.init").reduce(((e,t)=>{for(const s of t.notes)e.push(...s.split(/[\n\r]+/));return e}),[]);let t;if(e.length>0){const s=[];e.forEach((e=>s.push(`<span class="tag">${e}</span>`))),t='<div class="flexcol property-group gm-sensitive"><label>'+game.i18n.localize("FFD20.Notes")+'</label> <div class="flexrow tag-list">'+s.join("")+"</div></div>"}return[e,t]}async rollInitiative({createCombatants:e=!1,rerollInitiative:t=!1,initiativeOptions:s={},dice:n=null,bonus:l=null,rollMode:c=null,skipDialog:u}={}){let d=game.combat;if(!d){if(!game.user.isGM)return ui.notifications.warn("COMBAT.NoneActive",{localize:!0}),null;{const e=getDocumentClass("Combat");d=await e.create({scene:canvas.scene?.id,active:!0})}}if(e){const e=this.isToken?[this.token]:this.getActiveTokens().map((e=>e.document)),t=[];if(e.length)for(const s of e)s.inCombat||t.push({tokenId:s.id,sceneId:s.parent.id,actorId:this.id,hidden:s.hidden});else t.push({actorId:this.id,hidden:!1});await d.createEmbeddedDocuments("Combatant",t)}const m=d.combatants.filter((e=>e.actor?.id===this.id&&(t||null===e.initiative))).map((e=>e.id));return 0==m.length||(mergeObject(s,{formula:n,bonus:l,rollMode:c,skipDialog:u}),await d.rollInitiative(m,s)),d}async rollSavingThrow(e,t={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const s=this.getRollData(),n=this.getContextNotes("savingThrow."+e),l=this.formatContextNotes(n,s),c=[],u=this.system.attributes.savingThrows[e]?.base;u&&c.push(`${u}[${game.i18n.localize("FFD20.Base")}]`);let d=[];const m=this.changes.filter((t=>["allSavingThrows",e].includes(t.subTarget)));d=getHighestChanges(m.filter((e=>!["set","="].includes(e.operator))),{ignoreTarget:!0}).reduce(((e,t)=>(t.value&&e.push({value:t.value,source:t.flavor}),e)),[]);for(const e of d)c.push(`${e.value}[${e.source}]`);s.attributes.woundThresholds.penalty>0&&(l.push(game.i18n.localize(ffd20.config.woundThresholdConditions[s.attributes.woundThresholds.level])),c.push(`- @attributes.woundThresholds.penalty[${game.i18n.localize(ffd20.config.woundThresholdConditions[s.attributes.woundThresholds.level])}]`));const h=this.getDefenseHeaders({damageResistances:!1,damageVulnerabilities:!1});l.length>0&&h.push({header:game.i18n.localize("FFD20.Notes"),value:l});const g=ffd20.config.savingThrows[e],y=t.token??this.token,b={...t,parts:c,rollData:s,flavor:game.i18n.format("FFD20.SavingThrowRoll",{save:g}),subject:{save:e},chatTemplateData:{hasProperties:h.length>0,properties:h},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:y,alias:y?.name})};if(!1===Hooks.call("pf1PreActorRollSave",this,b,e))return;const F=await ffd20.dice.d20Roll(b);return Hooks.callAll("pf1ActorRollSave",this,F,e),F}async rollAbilityTest(e,t={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const s=this.getRollData(),n=this.getContextNotes("abilityChecks."+e),l=this.formatContextNotes(n,s),c=ffd20.config.abilities[e],u=[`@abilities.${e}.mod[${c}]`];if(0!=this.system.abilities[e].checkMod){const t=this.sourceDetails[`system.abilities.${e}.checkMod`];for(const e of t)u.push(`${e.value}[${e.name}]`)}this.system.attributes.energyDrain&&u.push("-@attributes.energyDrain"),s.attributes.woundThresholds.penalty>0&&(l.push(game.i18n.localize(ffd20.config.woundThresholdConditions[s.attributes.woundThresholds.level])),u.push(`- @attributes.woundThresholds.penalty[${game.i18n.localize(ffd20.config.woundThresholdConditions[s.attributes.woundThresholds.level])}]`));const d=[];l.length>0&&d.push({header:game.i18n.localize("FFD20.Notes"),value:l});const m=t.token??this.token,h={...t,parts:u,rollData:s,flavor:game.i18n.format("FFD20.AbilityTest",{ability:c}),subject:{ability:e},chatTemplateData:{hasProperties:d.length>0,properties:d},speaker:ChatMessage.implementation.getSpeaker({actor:this,token:m,alias:m?.name})};if(!1===Hooks.call("pf1PreActorRollAbility",this,h,e))return;const g=await ffd20.dice.d20Roll(h);return Hooks.callAll("pf1ActorRollAbility",this,g,e),g}async displayDefenseCard({rollMode:e=null,token:t}={}){if(!this.isOwner)return void ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));const s=this.getRollData(),n=ffd20.registry.damageTypes.getLabels(),l=this.getContextNotes("misc.ac"),c=this.formatContextNotes(l,s);this.system.attributes.acNotes.length>0&&c.push(...this.system.attributes.acNotes.split(/[\n\r]+/));const u=this.getContextNotes("misc.cmd"),d=this.formatContextNotes(u,s);this.system.attributes.cmdNotes.length>0&&d.push(...this.system.attributes.cmdNotes.split(/[\n\r]+/));const m=this.getContextNotes("misc.sr"),h=this.formatContextNotes(m,s);this.system.attributes.srNotes.length>0&&h.push(...this.system.attributes.srNotes.split(/[\n\r]+/));const g=ffd20.config.re.traitSeparator;let y=[];this.system.traits.dr.length&&(y=this.system.traits.dr.split(g));const b=[];if(this.system.traits.eres.length&&b.push(...this.system.traits.eres.split(g)),this.system.traits.di.value.length||this.system.traits.di.custom.length){const e=[...this.system.traits.di.value.map((e=>n[e])),...this.system.traits.di.custom.length>0?this.system.traits.di.custom.split(g):[]];b.push(...e.map((e=>game.i18n.format("FFD20.ImmuneTo",{immunity:e}))))}if(this.system.traits.dv.value.length||this.system.traits.dv.custom.length){const e=[...this.system.traits.dv.value.map((e=>n[e])),...this.system.traits.dv.custom.length>0?this.system.traits.dv.custom.split(g):[]];b.push(...e.map((e=>game.i18n.format("FFD20.VulnerableTo",{vulnerability:e}))))}const F=this.getWoundThresholdData();if(F.valid){const e=game.i18n.localize(ffd20.config.woundThresholdConditions[F.level]);c.push(e),d.push(e)}t??=this.token;const k=this.system,v={actor:this,name:t?.name??this.name,tokenUuid:t?.uuid??null,ac:{normal:k.attributes.ac.normal.total,touch:k.attributes.ac.touch.total,flatFooted:k.attributes.ac.flatFooted.total,notes:c},cmd:{normal:k.attributes.cmd.total,flatFooted:k.attributes.cmd.flatFootedTotal,notes:d},misc:{sr:k.attributes.sr.total,srNotes:h,drNotes:y,energyResistance:b}};((k.traits?.fastHealing||"").length||(k.traits?.regen||"").length)&&(v.regen={regen:k.traits.regen,fastHealing:k.traits.fastHealing}),setProperty(v,"flags.ffd20.subject","defenses");const D={speaker:ChatMessage.implementation.getSpeaker({actor:this,token:t,alias:t?.name}),rollMode:e,flags:{core:{canPopout:!0}}};await createCustomChatMessage("systems/ffd20/templates/chat/defenses.hbs",v,D)}async toggleCondition(e){e="system.attributes.conditions."+e;const t=!getProperty(this,e),s=e.replace(/(\w+)$/,(e=>"-="+e)),n=t?{[e]:!0}:{[s]:null};await this.update(n)}async setCondition(e,t){e="system.attributes.conditions."+e;const s=!getProperty(this,e);if(s!==t)return;const n=e.replace(/(\w+)$/,(e=>"-="+e)),l=s?{[e]:!0}:{[n]:null};await this.update(l)}hasCondition(e){return!0===this.system.attributes?.conditions?.[e]}async applyDamage(e,t={}){return this.constructor.applyDamage(e,mergeObject(t,{targets:[this]}))}static async applyDamage(e,{forceDialog:t=!1,reductionDefault:s="",asNonlethal:n=!1,targets:l=null,critMult:c=0,asWounds:u=!1}={}){const d=[];let m=canvas.tokens.controlled,h=1;l instanceof Array&&(m=l.filter((e=>e instanceof Token||e instanceof Actor)));const g=game.settings.get("ffd20","healthConfig"),y=/(\d+)/g,b=/[^,;\n]*(\d+)[^,;\n]*/g,F=/[^,;\n]+/g,_submit=async function(t,s){if(t){e=t.find('[name="damage"]').val();let n=t.find('[name="damage-reduction"]').val();e=e.length?RollPF.safeRoll(e,{},[]).total:0,n=n.length?RollPF.safeRoll(n,{},[]).total:0,e=s<0?Math.min((e=Math.ceil(e*s))-n,0):Math.max((e=Math.floor(e*(s??1)))-n,0);const l=[...t.find(".tokenAffected:checked")].map((e=>e.name.replace("affect.","")));m=m.filter((e=>l.includes(e.id)))}if(0!=e){for(const t of m){const s=t instanceof Token?t.actor:t;if(!s.isOwner){ui.notifications.warn(game.i18n.format("FFD20.ErrorNoActorPermissionAlt",{name:this.name}));continue}const l={character:"pc",npc:"npc"}[s.type],m=g.variants[l]?.useWoundsAndVigor??!1,h=m?s.system.attributes.vigor:s.system.attributes.hp,y=h.temp||0,b={};if(m){const t=h.value;let l=0;u&&(l-=e,e=0);const d=e>0?Math.min(y,e):0;if(e-=d,n&&e>0&&(t>0?e=Math.min(t,e):(l-=c>1?c:1,e=0)),0!=d&&(b["system.attributes.vigor.temp"]=y-d),0!=e){let t=Math.min(h.value-e,h.max);e>0&&(h.value>0?t<0&&(c>0&&(l-=-t,l-=c),t=0):l-=e),t!=h.value&&(b["system.attributes.vigor.value"]=t)}if(0!=l){const e=s.data.attributes.wounds;b["system.attributes.wounds.value"]=Math.clamped(e.value+l,0,e.max)}}else{let t=0;n&&e>0&&(t=Math.min(h.max-h.nonlethal,e),e-=t);const s=e>0?Math.min(y,e):0;b["system.attributes.hp.nonlethal"]=h.nonlethal+t,b["system.attributes.hp.temp"]=y-s,b["system.attributes.hp.value"]=Math.min(h.value-(e-s),h.max)}d.push(s.update(b))}return Promise.all(d)}};if(ffd20.skipConfirmPrompt?!t:t){e<0&&(h=-1,e*=-1);const t=m.map((e=>{const t=e instanceof Token,s=t?e.actor:e,buildResistances=e=>{const t=s.system.traits[e].value.map((t=>{const[s,n]=[t.amount,t.operator];return((t,s,n,l)=>{let c=s;l&&(c=!1===n?game.i18n.format("FFD20.Application.DamageResistanceSelector.CombinationFormattedAnd",{type1:s,type2:l}):game.i18n.format("FFD20.Application.DamageResistanceSelector.CombinationFormattedOr",{type1:s,type2:l}));return"dr"===e?`${t}/${c}`:`${c} ${t}`})(s,ffd20.registry.damageTypes.get(t.types[0]?.toLowerCase())?.name??"-",n,ffd20.registry.damageTypes.get(t.types[1]?.toLowerCase())?.name??"")}));return t.push(...s.system.traits[e].custom.match(b)??[]),t};return{_id:t?e.id:s.id,name:t?e.name:s.name,isToken:t,dr:buildResistances("dr"),eres:buildResistances("eres"),di:[...s.system.traits.di.value,...s.system.traits.di.custom.match(F)??[]],dv:[...s.system.traits.dv.value,...s.system.traits.dv.custom.match(F)??[]],checked:!0}})),l="systems/ffd20/templates/apps/damage-dialog.hbs",c={damage:e,healing:-1==h,damageReduction:s=s??"",tokens:t,nonlethal:n},u=await renderTemplate(l,c);return new Promise((e=>{const t={};t.normal={label:game.i18n.localize("FFD20.Apply"),callback:t=>e(_submit.call(this,t,1*h))},t.half={label:game.i18n.localize("FFD20.ApplyHalf"),callback:t=>e(_submit.call(this,t,.5*h))},new Dialog({title:h>0?game.i18n.localize("FFD20.ApplyDamage"):game.i18n.localize("FFD20.ApplyHealing"),content:u,buttons:t,default:"normal",close:t=>{e(!1)},render:e=>{e.on("click",'a[name="swap-selected"]',(function swapSelected(){[...e[0].querySelectorAll('.selected-tokens input[type="checkbox"]')].forEach((e=>e.checked=!e.checked))})),e.on("click",'a[name="clear-reduction"], p.notes a',(function setReduction(t){e[0].querySelector('input[name="damage-reduction"]').value=t.currentTarget.innerText.match(y)??""})),e.on("wheel","input",(function mouseWheelAdd(e){const t=e.currentTarget;if(/[^\d+-]|(?:\d[+-])/.test(t.value.trim()))return;const s=parseFloat(t.value)||0,n=-Math.sign(e.originalEvent.deltaY);t.value=""+(s+n)}))}},{classes:[...Dialog.defaultOptions.classes,"ffd20","apply-hit-points"]}).render(!0)}))}return _submit()}getWoundThresholdMultiplier(e=null){e=e??this.system;const t=game.settings.get("ffd20","healthConfig").variants,s="npc"===this.type?t.npc:t.pc,n=e.attributes.woundThresholds.override??-1;return n>=0&&s.allowWoundThresholdOverride?n:s.useWoundThresholds}getWoundThresholdData(e=null){e=e??this.system;const t=this.getWoundThresholdMultiplier(e),s=e.attributes.woundThresholds.level??0;return{level:s,penalty:s*t+(e.attributes.woundThresholds.mod??0),multiplier:t,valid:s>0&&t>0}}updateWoundThreshold(){const e=game.settings.get("ffd20","healthConfig").variants,t="npc"===this.type?e.npc.useWoundThresholds:e.pc.useWoundThresholds,s=this.system.attributes.woundThresholds;if(!t)return s.level=0,s.penaltyBase=0,s.penalty=0,void(s.mod=0);const n=this.system.attributes.hp,l=n.value,c=n.temp??0,u=n.max;let d=t>0?Math.clamped(4-Math.ceil((l+c)/u*4),0,3):0;Number.isNaN(d)&&(d=0);const m=this.getWoundThresholdMultiplier(),h=s.mod??0;s.level=d,s.penaltyBase=d*m,s.penalty=d*m+h;const g=s.penalty,y=ffd20.config.woundThresholdChangeTargets;for(const e of y){const t=getChangeFlat.call(this,e,"penalty");for(const e of t){if(!e)continue;const t=getProperty(this,e)??0;setProperty(this,e,t-g)}}}get allSkills(){const e=[];for(const[t,s]of Object.entries(this.system.skills))if(s&&(e.push(t),s.subSkills))for(const n of Object.keys(s.subSkills))e.push(`${t}.subSkills.${n}`);return e}get allNotes(){return this.items.filter((e=>e.isActive&&e.system.contextNotes?.length>0)).map((e=>({notes:e.system.contextNotes,item:e})))}get allItems(){return[...this.containerItems,...Array.from(this.items)]}getContextNotes(e){e.string&&(e=e.string);const t=this.allNotes;if(e.match(/^attacks\.(.+)/)){const e=RegExp.$1;for(const s of t)s.notes=s.notes.filter((t=>t.subTarget===e)).map((e=>e.text));return t}if(e.match(/^skill\.(.+)/)){const s=RegExp.$1,n=this.getSkillInfo(s).ability;for(const s of t)s.notes=s.notes.filter((t=>t.subTarget===e||t.subTarget===n+"Skills"||"skills"===t.subTarget)).map((e=>e.text));return t}if(e.match(/^savingThrow\.(.+)/)){const e=RegExp.$1;for(const s of t)s.notes=s.notes.filter((t=>t.subTarget===e||"allSavingThrows"===t.subTarget)).map((e=>e.text));return null!=this.system.attributes.saveNotes&&""!==this.system.attributes.saveNotes&&t.push({notes:[this.system.attributes.saveNotes],item:null}),t}if(e.match(/^abilityChecks\.(.+)/)){const e=RegExp.$1;for(const s of t)s.notes=s.notes.filter((t=>t.subTarget===e+"Checks"||"allChecks"===t.subTarget)).map((e=>e.text));return t}if(e.match(/^misc\.(.+)/)){const e=RegExp.$1;for(const s of t)s.notes=s.notes.filter((t=>t.subTarget===e)).map((e=>e.text));return t}if(e.match(/^spell\.concentration\.([a-z]+)$/)){const e=RegExp.$1;for(const e of t)e.notes=e.notes.filter((e=>"concentration"===e.subTarget)).map((e=>e.text));const s=this.system.attributes?.spells?.spellbooks?.[e]?.concentrationNotes;return s?.length&&t.push({notes:s.split(/[\n\r]+/),item:null}),t}if(e.match(/^spell\.cl\.([a-z]+)$/)){const e=RegExp.$1;for(const e of t)e.notes=e.notes.filter((e=>"cl"===e.subTarget)).map((e=>e.text));const s=this.system.attributes?.spells?.spellbooks?.[e]?.clNotes;return s?.length&&t.push({notes:s.split(/[\n\r]+/),item:null}),t}if(e.match(/^spell\.effect$/)){for(const e of t)e.notes=e.notes.filter((e=>"spellEffect"===e.subTarget)).map((e=>e.text));return t}return[]}getContextNotesParsed(e,{roll:t=!0}={}){return this.getContextNotes(e).reduce(((e,s)=>{for(const n of s.notes){const l={rollData:null!=s.item?s.item.getRollData():this.getRollData(),rolls:t,async:!1};e.push(enrichHTMLUnrolled(n,l))}return e}),[])}formatContextNotes(e,t,{roll:s=!0}={}){const n=[];t??=this.getRollData();for(const l of e){t.item={},null!=l.item&&(t=l.item.getRollData());for(const e of l.notes)n.push(...e.split(/[\n\r]+/).map((e=>enrichHTMLUnrolled(e,{rollData:t,rolls:s}))))}return n}async createEmbeddedDocuments(e,t,s={}){t=t instanceof Array?t:[t];const n=await super.createEmbeddedDocuments(e,t,s);for(const e of n)"class"===e.type&&await e._onLevelChange(0,e.system.level);return n}_computeEncumbrance(){const e=this.system.attributes;void 0===e.encumbrance&&(e.encumbrance={});const t=e.encumbrance,s=this.getCarryCapacity();t.levels=s,t.levels.carry=2*s.heavy,t.levels.drag=5*s.heavy;const n=Math.max(0,this.getCarriedWeight());t.carriedWeight=Math.round(10*n)/10;let l=ffd20.config.encumbranceLevels.light;n>0&&(n>t.levels.medium?l=ffd20.config.encumbranceLevels.heavy:n>t.levels.light&&(l=ffd20.config.encumbranceLevels.medium)),t.level=l;const c={maxDexBonus:null,acp:0};switch(t.level){case ffd20.config.encumbranceLevels.medium:c.acp=3,c.maxDexBonus=3;break;case ffd20.config.encumbranceLevels.heavy:c.acp=6,c.maxDexBonus=1}return c}_calculateCoinWeight(){const e=game.settings.get("ffd20","coinWeight");return e?Object.values(this.system.currency).reduce(((e,t)=>(parseInt(e)||0)+t),0)/e:0}getCarryCapacity(){const e=this.system.details.carryCapacity,t=this.system.abilities.str.total+e.bonus.total;let s=e.multiplier.total;const n=this.system.traits.size;this.system.attributes.quadruped?s*=ffd20.config.encumbranceMultipliers.quadruped[n]:s*=ffd20.config.encumbranceMultipliers.normal[n];const l=ffd20.config.encumbranceLoads;let c=Math.floor(l[t]*s);if(t>=l.length){const e=(t-(l.length-1))/10;c=Math.floor(l[l.length-1]*Math.pow(4,e)*s)}return c=ffd20.utils.convertWeight(c),{light:Math.floor(c/3),medium:Math.floor(c/3*2),heavy:c}}getCarriedWeight(){const e=this.items.filter((e=>null!=e.system.weight)).reduce(((e,t)=>t.system.carried?e+t.system.weight.total:e),this._calculateCoinWeight());return ffd20.utils.convertWeight(e)}mergeCurrency({inLowestDenomination:e=!1}={}){const t=this.getTotalCurrency("currency",{inLowestDenomination:e})+this.getTotalCurrency("altCurrency",{inLowestDenomination:e});return e?t:t/100}getTotalCurrency(e="currency",{inLowestDenomination:t=!1}={}){const s=this.system[e];if(!s)return console.error(`Currency type "${e}" not found.`),NaN;const n=1e3*s.pgil+100*s.gil+10*s.sgil+s.cgil;return t?n:n/100}convertCurrency(e="currency",t="pgil"){const s={pgil:0,gil:0,sgil:0,cgil:this.getTotalCurrency(e,{inLowestDenomination:!0})};if(!Number.isFinite(s.cgil))return void console.error(`Invalid total currency "${s.cgil}" in "${e}" category`);const n={pgil:3,gil:2,sgil:1,cgil:0},l=n[t];l>=n.pgil&&(s.pgil=Math.floor(s.cgil/1e3),s.cgil-=1e3*s.pgil),l>=n.gil&&(s.gil=Math.max(0,Math.floor(s.cgil/100)),s.cgil-=100*s.gil),l>=n.sp&&(s.sgil=Math.max(0,Math.floor(s.cgil/10)),s.cgil-=10*s.sgil),s.cgil<0&&(s.cgil=0);const c={system:{[e]:s}};return this.update(c)}_prepareArmorData({id:e,type:t}={},s){s.type=t??null;const n=this.items.get(e)?.system;n&&(s.ac=n.armor.value??0,s.enh=n.armor.enh??0,s.total=s.ac+s.enh,Number.isFinite(s.total)||(s.total=0))}getRollData(e={refresh:!1}){let t;const s=!e.refresh&&this._rollData;if(s){t=this._rollData;const e=ffd20.config.temporaryRollDataFields.actor;for(const s of e){const e=s.split("."),n=e.slice(0,-1).join("."),l=e.slice(-1)[0];if(""===n)delete t[s];else{const e=getProperty(t,n);"object"==typeof e&&delete e[l]}}}else t=deepClone(this.system);if(game.combats?.viewed&&(t.combat={round:game.combat.round||0}),t.conditions??={},t.conditions.loseDexToAC=this.changeFlags?.loseDexToAC??!1,s)return t;const n=Object.keys(ffd20.config.sizeChart);t.size=n.indexOf(t.traits.size),t.armor={type:0,total:0,ac:0,enh:0},t.shield={type:0,total:0,ac:0,enh:0};const l=this.equipment;l&&(this._prepareArmorData(l.armor,t.armor),this._prepareArmorData(l.shield,t.shield)),t.spells=t.attributes.spells.spellbooks;for(const[e,s]of Object.entries(t.spells))s.abilityMod=t.abilities[s.ability]?.mod??0,s.class&&"_hd"!==s.class&&(t.spells[s.class]??=s);return t.dFlags=this.itemFlags?.dictionary??{},t.range=this.constructor.getReach(this.system.traits.size,this.system.traits.stature),t.classes=this.classes,this._rollData=t,Hooks.events.pf1GetRollData?.length>0&&Hooks.callAll("pf1GetRollData",this,t),t}static getReach(e="med",t="tall"){const s={melee:5,reach:10};switch(e){case"fine":case"dim":s.melee=0,s.reach=0;break;case"tiny":s.melee=0,s.reach=5;break;case"lg":"tall"===t&&(s.melee=10,s.reach=20);break;case"huge":"tall"===t?(s.melee=15,s.reach=30):(s.melee=10,s.reach=20);break;case"grg":"tall"===t?(s.melee=20,s.reach=40):(s.melee=15,s.reach=30);break;case"col":"tall"===t?(s.melee=30,s.reach=60):(s.melee=20,s.reach=40)}return s}async deleteEmbeddedDocuments(e,t,s={}){if("Item"===e){t instanceof Array||(t=[t]);const _addChildren=async function(e){const s=this.items.get(e),n=await s.getLinkedItems("children");for(const e of n)t.includes(e.id)||(t.push(e.id),await _addChildren.call(this,e.id))};for(const e of t)await _addChildren.call(this,e);for(const e of t)for(const t of this.items)await t.removeItemLink(e)}await super.deleteEmbeddedDocuments(e,t,s)}getQuickActions(){return this.items.filter((e=>e.isActive&&!0===e.system.showInQuickbar&&["weapon","equipment","consumable","attack","spell","feat"].includes(e.type)&&!e.showUnidentifiedData)).sort(((e,t)=>e.sort-t.sort)).map((e=>({item:e,isSingleUse:e.isSingleUse,get haveAnyCharges(){return this.item.isCharged},maxCharge:e.maxCharges,get charges(){return this.item.charges}})))}async toggleConditionStatusIcons(e={}){if(this._states.togglingStatusIcons)return;if(this._states.togglingStatusIcons=!0,!this.testUserPermission(game.user,"OWNER"))return;const t=this._calcBuffActiveEffects(),s=[...this.effects],n=[],l=[],c=[];for(const[e,u]of Object.entries(t)){const t=s.find((t=>t.origin===e||t.flags.ffd20?.origin?.item===u.id));if(t)if(u.active){const e=t.toObject(),s=foundry.utils.mergeObject(e,u.item.getRawEffectData(),{inplace:!1});(u.item.system.hideFromToken||game.settings.get("ffd20","hideTokenConditions"))&&(s.icon=null);const n=foundry.utils.diffObject(e,s);foundry.utils.isEmpty(n)||(n._id=t.id,c.push(n))}else l.push(t.id);else u.active&&n.push(u.item.getRawEffectData())}for(const e of Object.keys(ffd20.config.conditions)){const t=s.findIndex((t=>t.getFlag("core","statusId")===e)),c=!0===this.system.attributes.conditions[e],u=t>=0;if(c&&!u)n.push({flags:{core:{statusId:e},ffd20:{autoDelete:!0}},name:ffd20.config.conditions[e],icon:ffd20.config.conditionTextures[e],label:ffd20.config.conditions[e]});else if(!c&&u){const t=s.filter((t=>t.getFlag("core","statusId")===e));l.push(...t.map((e=>e.id)))}}const u=deepClone(e);!1!==e.render&&(u.render=!n.length&&!c.length);const d=deepClone(e);!1!==e.render&&(d.render=!c.length),l.length&&await this.deleteEmbeddedDocuments("ActiveEffect",l,u),n.length&&await this.createEmbeddedDocuments("ActiveEffect",n,d),c.length&&await this.updateEmbeddedDocuments("ActiveEffect",c,e),this._states.togglingStatusIcons=!1}_calcBuffActiveEffects(){return this.items.filter((e=>"buff"===e.type)).reduce(((e,t)=>{const s=t.uuid;return e[s]??={id:t.id,label:t.name,icon:t.img,item:t},e[s].active=t.isActive,e}),{})}refreshAbilityModifiers(){for(const e of Object.keys(this.system.abilities)){const t=this.system.abilities[e].total,s=getAbilityModifier(t,{penalty:Math.abs(this.system.abilities[e].penalty||0),damage:this.system.abilities[e].damage});if(this.system.abilities[e].mod=s,!ffd20.migrations.isMigrating&&this._initialized&&this._prevAbilityScores){const n=s-(this._prevAbilityScores?.[e].mod??0),l=this.system.abilities[e].mod+n;this._prevAbilityScores[e]={total:t,mod:l}}}}async importFromJSON(e){this._initialized=!1;const t=JSON.parse(e);return delete t._id,t.effects=[],this.update(t,{diff:!1,recursive:!1})}getFeatCount(){const e={max:0,value:0};e.value=this.items.filter((e=>"feat"===e.type&&"feat"===e.system.subType&&!e.system.disabled)).length;const t=this.items.filter((e=>"class"===e.type&&["base","npc","prestige","racial"].includes(e.system.subType))).reduce(((e,t)=>e+t.hitDice),0);e.max+=Math.ceil(t/2);const s=RollPF.safeRoll(this.system.details.bonusFeatFormula||"0",this.getRollData());return e.max+=s.total,s.err&&ui.notifications.error(game.i18n.format("FFD20.ErrorActorFormula",{context:game.i18n.localize("FFD20.BonusFeatFormula"),name:this.actor.name})),this.changes.filter((e=>"bonusFeats"===e.subTarget)).forEach((t=>{t.value&&(e.max+=t.value)})),e}hasItemBooleanFlag(e){return null!=this.itemFlags.boolean[e]}async resetSpellbookUsage({commit:e=!0,rollData:t}={}){const s=this.system,n={};t??=this.getRollData();for(const[e,l]of Object.entries(s.attributes.spells.spellbooks))if(l.spellPoints.useSystem){let s=l.spellPoints.max;if(l.spellPoints.restoreFormula){const e=RollPF.safeRoll(l.spellPoints.restoreFormula,t);e.err?console.error(e.err,l.spellPoints.restoreFormula):s=Math.min(l.spellPoints.value+e.total,l.spellPoints.max)}n[`system.attributes.spells.spellbooks.${e}.spellPoints.value`]=s}else for(let t=0;t<10;t++)n[`system.attributes.spells.spellbooks.${e}.spells.spell${t}.value`]=l.spells["spell"+t]?.max??0;return e?this.update(n):n}async rechargeItems({updateData:e={},commit:t=!0}={}){const s=this.system,n=[],getPathData=t=>e[t]??getProperty(this,t);for(const t of this.items){const l=await t.recharge({period:"day",commit:!1})??{};l.system??={};const c=t.system;if("spell"===t.type){const u=c.spellbook,d=c.level,m=getProperty(s,"attributes.spells.spellbooks."+u);if(!m){console.warn(`${t.name} [${t.id}] has invalid spellbook: "${u}"`);continue}if(m.spontaneous)continue;if(c.preparation.preparedAmount<c.preparation.maxAmount&&(l["system.preparation.preparedAmount"]=c.preparation.maxAmount,n.push(l)),!t.system.domain){let t=getPathData(`system.attributes.spells.spellbooks.${u}.spells.spell${d}.value`)||0;t-=c.preparation.maxAmount,e[`system.attributes.spells.spellbooks.${u}.spells.spell${d}.value`]=t}}if(t.system.actions?.length>0){const e=deepClone(t.system.actions);let s=!1;for(const t of e)if("day"===t.uses?.self?.per){const e=t.uses.self.max||0;t.uses.self.value<e&&(t.uses.self.value=e,s=!0)}s&&(l["system.actions"]=e)}foundry.utils.isEmpty(l)||(l._id=t.id,n.push(l))}return t?n.length?this.updateEmbeddedDocuments("Item",n):[]:n}_restingHeal(e={}){const t=this.system,s=t.attributes.hp,n=t.attributes.mp,{hours:l,longTermCare:c,aidedCare:u}=e,d={},m=t.attributes.hd.total,h={hp:m,mp:t.attributes.mp.recover,abl:1,nonlethal:l*m};!0===c&&!1===u&&(h.hp*=2,h.mp*=2,h.abl*=2),!1===c&&!0===u&&(h.hp*=2,h.mp*=2,h.abl*=2),!0===c&&!0===u&&(h.hp*=5,h.mp*=5,h.abl*=5),d["system.attributes.hp.value"]=Math.min(s.value+h.hp,s.max),d["system.attributes.mp.value"]=Math.min(n.value+h.mp,n.max),d["system.attributes.hp.nonlethal"]=Math.max(0,(s.nonlethal||0)-h.nonlethal);for(const[e,s]of Object.entries(t.abilities)){const t=Math.abs(s.damage);d[`system.abilities.${e}.damage`]=Math.max(0,t-h.abl)}return d}async performRest(e={}){const{restoreHealth:t=!0,longTermCare:s=!1,aidedCare:n=!1,restoreDailyUses:l=!0,hours:c=8}=e;this.system;const u={};if(!0===t){const t=this._restingHeal(e);mergeObject(u,t)}let d=[];if(!0===l){const e=await this.resetSpellbookUsage({commit:!1});mergeObject(u,e),d=await this.rechargeItems({commit:!1,updateData:u})}e={restoreHealth:t,restoreDailyUses:l,longTermCare:s,hours:c};if(!1!==Hooks.call("pf1PreActorRest",this,e,u,d))return d.length&&await this.updateEmbeddedDocuments("Item",d),foundry.utils.isEmpty(u.system)||await this.update(u),Hooks.callAll("pf1ActorRest",this,e,u,d),{options:e,updateData:u,itemUpdates:d}}async modifyTokenAttribute(e,t,s=!1,n=!0){let l=this;const c=getProperty(this.system,e),u={},d=/^resources\.(?<tag>[^.]+)$/.exec(e);if(d){const{tag:e}=d.groups,t=this.system.resources[e]?._id;l=this.items.get(t)}if(!l)return;if("attributes.hp"===e){s||(t=-1*(c.temp+c.value-t));let e=t;c.temp>0&&t<0&&(e=Math.min(0,c.temp+t),u["system.attributes.hp.temp"]=Math.max(0,c.temp+t)),u["system.attributes.hp.value"]=Math.min(c.value+e,c.max)}else if("attributes.vigor"===e){s||(t=-1*(c.temp+c.value-t));let e=t;c.temp>0&&t<0&&(e=Math.min(0,c.temp+t),u["system.attributes.vigor.temp"]=Math.max(0,c.temp+t)),u["system.attributes.vigor.value"]=Math.min(c.value+e,c.max)}else s?l instanceof Actor?n?u[`system.${e}.value`]=Math.clamped(c.min||0,c.value+t,c.max):u["system."+e]=c+t:u["system.uses.value"]=c.value+t:l instanceof Actor?n?u[`system.${e}.value`]=t:u["system."+e]=t:u["system.uses.value"]=t;return!1!==Hooks.call("modifyTokenAttribute",{attribute:e,value:t,isDelta:s,isBar:n},u)?l.update(u):this}getItemByTag(e){return this.items.find((t=>t.system.tag===e))}_itemTypes;get itemTypes(){return this._itemTypes??=super.itemTypes,this._itemTypes}get visionPermissionSheet(){return this._visionPermissionSheet??=new VisionPermissionSheet(this),this._visionPermissionSheet}}const getActorShim=e=>{const t=fromUuidSync(e);let s=t.actor??t;return s||(s=getActorFromId(e),s&&foundry.utils.logCompatibilityWarning("Actor ID for macro creation functions is deprecated in favor of UUID",{since:"PF1 v9",until:"PF1 v10"})),s},createItemMacro=async(e,t)=>{const s=fromUuidSync(e),n=`fromUuidSync("${e}").use();`;let l=game.macros.contents.find((e=>e.name===s.name&&e.data.command===n));return l||(l=await Macro.create({name:s.name,type:"script",img:s.img,command:n,flags:{"ffd20.itemMacro":!0}},{displaySheet:!1})),game.user.assignHotbarMacro(l,t)},createActionMacro=async(e,t,s)=>{const n=fromUuidSync(t),l=n?.actions.get(e);if(!l)return void ui.notifications.error(game.i18n.format("FFD20.ErrorActionNotFound",{id:e,item:n?.name,actor:n?.actor?.name}));const c=`fromUuidSync("${t}")\n\t.actions.get("${e}")\n\t.use();`;let u=game.macros.contents.find((e=>e.name===n.name&&e.data.command===c));return u||(u=await Macro.create({name:`${l.name} (${n.name})`,type:"script",img:l.img||n.img,command:c,flags:{ffd20:{actionMacro:{item:t,action:e}}}},{displaySheet:!1})),game.user.assignHotbarMacro(u,s)},createSkillMacro=async(e,t,s)=>{const n=getActorShim(t);if(!n)return;const l=n.getSkillInfo(e),c=`fromUuidSync("${n.uuid}")\n\t.rollSkill("${e}");`,u=game.i18n.format("FFD20.RollSkillMacroName",{actor:n.name,skill:l.name});let d=game.macros.contents.find((e=>e.name===u&&e.data.command===c));return d||(d=await Macro.create({name:u,type:"script",img:"systems/ffd20/icons/items/inventory/dice.jpg",command:c,flags:{"ffd20.skillMacro":!0}},{displaySheet:!1})),game.user.assignHotbarMacro(d,s)},createSaveMacro=async(e,t,s)=>{const n=getActorShim(t);if(!n)return;const l=game.i18n.localize("FFD20.SavingThrow"+e.capitalize()),c=`fromUuidSync("${n.uuid}")\n\t.rollSavingThrow("${e}");`,u=game.i18n.format("FFD20.RollSaveMacroName",{actor:n.name,type:l});let d=game.macros.contents.find((e=>e.name===u&&e.data.command===c));return d||(d=await Macro.create({name:u,type:"script",img:"systems/ffd20/icons/items/inventory/dice.jpg",command:c,flags:{"ffd20.saveMacro":!0}},{displaySheet:!1})),game.user.assignHotbarMacro(d,s)},createMiscActorMacro=async(e,t,s,n)=>{const l=getActorShim(t);if(!l)return;const getBookLabel=e=>l.system.attributes?.spells?.spellbooks?.[e]?.label;let c,u,d=`fromUuidSync("${l.uuid}")\n\t`;switch(e){case"defenses":d+=".displayDefenseCard();",c=game.i18n.format("FFD20.DisplayDefensesMacroName",{actor:l.name}),u="systems/ffd20/icons/items/armor/shield-light-metal.png";break;case"cmb":d+=".rollCMB();",c=game.i18n.format("FFD20.RollCMBMacroName",{actor:l.name}),u="systems/ffd20/icons/feats/improved-grapple.jpg";break;case"cl":{const{bookId:e}=n;d+=`.rollCL("${e}");`,c=game.i18n.format("FFD20.RollCLMacroName",{actor:l.name,book:getBookLabel(e)}),u="systems/ffd20/icons/spells/wind-grasp-eerie-3.jpg";break}case"concentration":{const{bookId:e}=n;d+=`.rollConcentration("${e}");`,c=game.i18n.format("FFD20.RollConcentrationMacroName",{actor:l.name,book:getBookLabel(e)}),u="systems/ffd20/icons/skills/light_01.jpg";break}case"bab":d+=".rollBAB();",c=game.i18n.format("FFD20.RollBABMacroName",{actor:l.name}),u="systems/ffd20/icons/skills/yellow_08.jpg";break;case"initiative":d+=".rollInitiative();",c=game.i18n.format("FFD20.RollInitiativeMacroName",{actor:l.name}),u="systems/ffd20/icons/skills/weapon_41.jpg";break;case"attack":{const{attack:e}=n,t="melee"===e;d+=`.rollAttack({ melee: ${t?"true":"false"}});`,c=game.i18n.format(t?"FFD20.RollMeleeMacroName":"FFD20.RollRangedMacroName",{actor:l.name}),u=t?"systems/ffd20/icons/skills/weapon_23.jpg":"systems/ffd20/icons/skills/arrow_07.jpg";break}case"abilityScore":{const{ability:e}=n;d+=`.rollAbilityTest("${e}");`,c=game.i18n.format("FFD20.RollAbilityMacroName",{actor:l.name,ability:CONFIG.FFD20.abilities[e]}),u="systems/ffd20/icons/skills/blue_35.jpg";break}}if(!c)return;let m=game.macros.contents.find((e=>e.name===c&&e.command===d));return m??=await Macro.create({name:c,type:"script",img:u,command:d,flags:{ffd20:{type:e,actor:t}}},{displaySheet:!1}),game.user.assignHotbarMacro(m,s)},Q=Object.freeze(Object.defineProperty({__proto__:null,createActionMacro,createItemMacro,createMiscActorMacro,createSaveMacro,createSkillMacro,displayDefenses:({actorName:e=null,actorId:t=null,rollMode:s=null}={})=>{foundry.utils.logCompatibilityWarning("displayDefenses() is deprecated in favor of Actor.displayDefenseCard()",{since:"PF1 v9",until:"PF1 v10"});const n=ActorPF.getActiveActor({actorName:e,actorId:t});if(n)return n.displayDefenseCard({rollMode:s});ui.notifications.warn(game.i18n.format("FFD20.ErrorNoApplicableActorFoundForAction",{name:game.i18n.localize("FFD20.Action_DisplayDefenses")}))},rollActorAttributeMacro:(e,t,s=null)=>{foundry.utils.logCompatibilityWarning("rollActorAttributeMacro() is deprecated in favor of directly calling functions on the actor.",{since:"PF1 v9",until:"PF1 v10"});const n=getActorFromId(e);if(n)switch(t){case"defenses":return n.displayDefenseCard();case"cmb":return n.rollCMB();case"cl":return n.rollCL(s);case"concentration":return n.rollConcentration(s);case"bab":return n.rollBAB()}else ui.notifications.error(game.i18n.format("FFD20.ErrorActorNotFound",{id:e}))},rollItemMacro:(e,{itemId:t,itemType:s,actorId:n}={})=>{foundry.utils.logCompatibilityWarning("rollItemMacro() is deprecated in favor of Item.use()",{since:"PF1 v9",until:"PF1 v10"});const l=getActorFromId(n);if(l&&!l.testUserPermission(game.user,"OWNER"))return void ui.notifications.warn(game.i18n.localize("FFD20.ErrorNoActorPermission"));const c=l?l.items.find((n=>(null==t||n.id===t)&&((null==s||n.type===s)&&n.name===e))):null;if(c)return!ffd20.forceShowItem&&c.hasAction?c.use():c.roll();ui.notifications.warn(game.i18n.format("FFD20.WarningNoItemOnActor",{actor:l?.name,item:e}))},rollSaveMacro:(e,t)=>{foundry.utils.logCompatibilityWarning("rollSaveMacro() is deprecated in favor of Actor.rollSavingThrow()",{since:"PF1 v9",until:"PF1 v10"});const s=getActorFromId(e);if(s)return s.rollSavingThrow(t);ui.notifications.error(game.i18n.format("FFD20.ErrorActorNotFound",{id:e}))},rollSkillMacro:(e,t)=>{foundry.utils.logCompatibilityWarning("rollSkillMacro() is deprecated in favor of Actor.rollSkill()",{since:"PF1 v9",until:"PF1 v10"});const s=getActorFromId(e);if(s)return s.rollSkill(t);ui.notifications.error(game.i18n.format("FFD20.ErrorActorNotFound",{id:e}))}},Symbol.toStringTag,{value:"Module"}));const Z=new Proxy(ActorPF,{construct:(e,t)=>new CONFIG.Actor.documentClasses[t[0]?.type](...t)}),Y=new Proxy(ItemPF,{construct:(e,t)=>new CONFIG.Item.documentClasses[t[0]?.type](...t)}),X={fine:{w:1,h:1,scale:.45},dim:{w:1,h:1,scale:.6},tiny:{w:1,h:1,scale:.75},sm:{w:1,h:1,scale:.9},med:{w:1,h:1,scale:1},lg:{w:2,h:2,scale:1},huge:{w:3,h:3,scale:1},grg:{w:4,h:4,scale:1},col:{w:6,h:6,scale:1}},ee=Object.freeze(Object.defineProperty({__proto__:null,CHARACTER_EXP_LEVELS:{slow:[0,3e3,7500,14e3,23e3,35e3,53e3,77e3,115e3,16e4,235e3,33e4,475e3,665e3,955e3,135e4,19e5,27e5,385e4,535e4,835e4,1435e4,2635e4,5035e4,9835e4,19435e4,38635e4,77035e4,153835e4,307435e4],medium:[0,2e3,5e3,9e3,15e3,23e3,35e3,51e3,75e3,105e3,155e3,22e4,315e3,445e3,635e3,89e4,13e5,18e5,255e4,36e5,57e5,99e5,183e5,351e5,687e5,1359e5,2703e5,5391e5,10767e5,21519e5],fast:[0,1300,3300,6e3,1e4,15e3,23e3,34e3,5e4,71e3,105e3,145e3,21e4,295e3,425e3,6e5,85e4,12e5,17e5,24e5,38e5,66e5,122e5,234e5,458e5,906e5,1802e5,3594e5,7178e5,14346e5]},CONFIG_OVERRIDES:{"Combat.initiative.decimals":2,"debug.roll":!1,"debug.template":!1},CR_EXP_LEVELS:[200,400,600,800,1200,1600,2400,3200,4800,6400,9600,12800,19200,25600,38400,51200,76800,102400,153600,204800,307200,409600,614400,819200,1228800,1638400,2457600,3276800,4915200,6553600,9830400],ClassSpellLvlProgression:{noncaster:"0",halfCaster:"min(floor(((@level)-1)/3),4)",dimPacman:"min(floor(((@level)+2)/3),6)",pacman:"min(floor(((@level)+2)/3),6)",dimFullCaster:"min(floor(((@level)+1)/2),9)",fullCaster:"min(floor(((@level)+1)/2),9)",advFullCaster:"min(floor(((@level)+1)/2),9)"},abilities:{str:"FFD20.AbilityStr",dex:"FFD20.AbilityDex",con:"FFD20.AbilityCon",int:"FFD20.AbilityInt",wis:"FFD20.AbilityWis",cha:"FFD20.AbilityCha"},abilitiesShort:{str:"FFD20.AbilityShortStr",dex:"FFD20.AbilityShortDex",con:"FFD20.AbilityShortCon",int:"FFD20.AbilityShortInt",wis:"FFD20.AbilityShortWis",cha:"FFD20.AbilityShortCha"},abilityActivationTypes:{passive:"FFD20.ActivationTypePassive",free:"FFD20.ActivationTypeFree",nonaction:"FFD20.ActivationTypeNonaction",swift:"FFD20.ActivationTypeSwift",immediate:"FFD20.ActivationTypeImmediate",move:"FFD20.ActivationTypeMove",standard:"FFD20.ActivationTypeStandard",full:"FFD20.ActivationTypeFullround",attack:"FFD20.ActivationTypeAttack",aoo:"FFD20.ActivationTypeAoO",round:"FFD20.ActivationTypeRound",minute:"FFD20.ActivationTypeMinute",hour:"FFD20.ActivationTypeHour",special:"FFD20.ActivationTypeSpecial"},abilityActivationTypesPlurals:{free:"FFD20.ActivationTypeFreePlural",swift:"FFD20.ActivationTypeSwiftPlural",immediate:"FFD20.ActivationTypeImmediatePlural",move:"FFD20.ActivationTypeMovePlural",standard:"FFD20.ActivationTypeStandardPlural",full:"FFD20.ActivationTypeFullroundPlural",attack:"FFD20.ActivationTypeAttackPlural",round:"FFD20.ActivationTypeRoundPlural",minute:"FFD20.ActivationTypeMinutePlural",hour:"FFD20.ActivationTypeHourPlural"},abilityActivationTypesPlurals_unchained:{passive:"FFD20.ActivationTypePassive",free:"FFD20.ActivationTypeFreePlural",reaction:"FFD20.ActivationTypeReactionPlural",action:"FFD20.ActivationTypeActionPlural",minute:"FFD20.ActivationTypeMinutePlural",hour:"FFD20.ActivationTypeHourPlural",special:"FFD20.ActivationTypeSpecial"},abilityActivationTypes_unchained:{passive:"FFD20.ActivationTypePassive",free:"FFD20.ActivationTypeFree",nonaction:"FFD20.ActivationTypeNonaction",reaction:"FFD20.ActivationTypeReaction",action:"FFD20.ActivationTypeAction",attack:"FFD20.ActivationTypeAttack",aoo:"FFD20.ActivationTypeAoO",minute:"FFD20.ActivationTypeMinute",hour:"FFD20.ActivationTypeHour",special:"FFD20.ActivationTypeSpecial"},abilityCost:{7:-4,8:-2,9:-1,10:0,11:1,12:2,13:3,14:5,15:7,16:10,17:13,18:17},abilityDamageMultipliers:[{value:.5,label:"×0.5"},{value:1,label:"×1"},{value:1.5,label:"×1.5"},{value:2,label:"×2"},{value:2.5,label:"×2.5"}],abilityTypes:{ex:{short:"FFD20.AbilityTypeShortExtraordinary",long:"FFD20.AbilityTypeExtraordinary"},su:{short:"FFD20.AbilityTypeShortSupernatural",long:"FFD20.AbilityTypeSupernatural"},sp:{short:"FFD20.AbilityTypeShortSpell-Like",long:"FFD20.AbilityTypeSpell-Like"}},ac:{normal:"FFD20.ACNormal",touch:"FFD20.ACTouch",flatFooted:"FFD20.ACFlatFooted"},actorSizes:{fine:"FFD20.ActorSizeFine",dim:"FFD20.ActorSizeDiminutive",tiny:"FFD20.ActorSizeTiny",sm:"FFD20.ActorSizeSmall",med:"FFD20.ActorSizeMedium",lg:"FFD20.ActorSizeLarge",huge:"FFD20.ActorSizeHuge",grg:"FFD20.ActorSizeGargantuan",col:"FFD20.ActorSizeColossal"},actorStatures:{tall:"FFD20.StatureTall",long:"FFD20.StatureLong"},alignments:{lg:"FFD20.AlignmentLG",ng:"FFD20.AlignmentNG",cg:"FFD20.AlignmentCG",ln:"FFD20.AlignmentLN",tn:"FFD20.AlignmentTN",cn:"FFD20.AlignmentCN",le:"FFD20.AlignmentLE",ne:"FFD20.AlignmentNE",ce:"FFD20.AlignmentCE"},alignmentsShort:{lg:"FFD20.AlignmentShortLG",ng:"FFD20.AlignmentShortNG",cg:"FFD20.AlignmentShortCG",ln:"FFD20.AlignmentShortLN",tn:"FFD20.AlignmentShortTN",cn:"FFD20.AlignmentShortCN",le:"FFD20.AlignmentShortLE",ne:"FFD20.AlignmentShortNE",ce:"FFD20.AlignmentShortCE"},ammoTypes:{arrow:"FFD20.AmmoTypeArrow",bolt:"FFD20.AmmoTypeBolt",repeatingBolt:"FFD20.AmmoTypeRepeatingBolt",slingBullet:"FFD20.AmmoTypeBulletSling",gunBullet:"FFD20.AmmoTypeBulletGun",dragoonBullet:"FFD20.AmmoTypeBulletDragoon",dart:"FFD20.AmmoTypeDart"},arbitrarySkills:["crf","prf","pro"],armorProficiencies:{lgt:"FFD20.ArmorProfLight",med:"FFD20.ArmorProfMedium",hvy:"FFD20.ArmorProfHeavy",shl:"FFD20.ArmorProfShield",twr:"FFD20.ArmorProfTowerShield"},armorTypes:{none:0,light:1,medium:2,heavy:3},attackTypes:{weapon:"FFD20.AttackTypeWeapon",natural:"FFD20.AttackTypeNatural",ability:"FFD20.AttackTypeAbility",racialAbility:"FFD20.AttackTypeRacial",item:"FFD20.Item",misc:"FFD20.Misc"},auraStrengths:{1:"FFD20.AuraStrength_Faint",2:"FFD20.AuraStrength_Moderate",3:"FFD20.AuraStrength_Strong",4:"FFD20.AuraStrength_Overwhelming"},backgroundOnlySkills:["lor","art"],backgroundSkillClasses:["base","prestige"],backgroundSkills:["apr","crf","han","ken","kge","khi","kno","lin","prf","pro","slt"],backgroundSkillsPerLevel:2,bonusModifiers:{untyped:"FFD20.BonusModifierUntyped",untypedPerm:"FFD20.BonusModifierUntypedPerm",base:"FFD20.BonusModifierBase",enh:"FFD20.BonusModifierEnhancement",dodge:"FFD20.BonusModifierDodge",haste:"FFD20.BonusModifierHaste",inherent:"FFD20.BonusModifierInherent",deflection:"FFD20.BonusModifierDeflection",morale:"FFD20.BonusModifierMorale",luck:"FFD20.BonusModifierLuck",sacred:"FFD20.BonusModifierSacred",insight:"FFD20.BonusModifierInsight",resist:"FFD20.BonusModifierResistance",profane:"FFD20.BonusModifierProfane",trait:"FFD20.BonusModifierTrait",racial:"FFD20.BonusModifierRacial",size:"FFD20.BonusModifierSize",competence:"FFD20.BonusModifierCompetence",circumstance:"FFD20.BonusModifierCircumstance",alchemical:"FFD20.BonusModifierAlchemical",penalty:"FFD20.BonusModifierPenalty"},buffTargetCategories:{defense:{label:"FFD20.Defense"},savingThrows:{label:"FFD20.SavingThrowPlural"},attack:{label:"FFD20.Attack"},damage:{label:"FFD20.Damage"},ability:{label:"FFD20.AbilityScore"},abilityChecks:{label:"FFD20.BuffTarAbilityChecks"},health:{label:"FFD20.Health"},skills:{label:"FFD20.Skills"},skill:{label:"FFD20.BuffTarSpecificSkill"},speed:{label:"FFD20.Speed"},spell:{label:"FFD20.BuffTarSpells"},misc:{label:"FFD20.Misc"}},buffTargets:{acpA:{label:"FFD20.ACPArmor",category:"misc",sort:1e4},acpS:{label:"FFD20.ACPShield",category:"misc",sort:11e3},mDexA:{label:"FFD20.MaxDexArmor",category:"misc",sort:2e4},mDexS:{label:"FFD20.MaxDexShield",category:"misc",sort:21e3},str:{label:"FFD20.AbilityStr",category:"ability",sort:3e4},dex:{label:"FFD20.AbilityDex",category:"ability",sort:31e3},con:{label:"FFD20.AbilityCon",category:"ability",sort:32e3},int:{label:"FFD20.AbilityInt",category:"ability",sort:33e3},wis:{label:"FFD20.AbilityWis",category:"ability",sort:34e3},cha:{label:"FFD20.AbilityCha",category:"ability",sort:35e3},strMod:{label:"FFD20.AbilityStrMod",category:"ability",sort:4e4},dexMod:{label:"FFD20.AbilityDexMod",category:"ability",sort:41e3},conMod:{label:"FFD20.AbilityConMod",category:"ability",sort:42e3},intMod:{label:"FFD20.AbilityIntMod",category:"ability",sort:43e3},wisMod:{label:"FFD20.AbilityWisMod",category:"ability",sort:44e3},chaMod:{label:"FFD20.AbilityChaMod",category:"ability",sort:45e3},skills:{label:"FFD20.BuffTarAllSkills",category:"skills",sort:5e4},unskills:{label:"FFD20.BuffTarUntrainedSkills",category:"skills",sort:1e5},carryStr:{label:"FFD20.CarryStrength",category:"misc",sort:6e4},carryMult:{label:"FFD20.CarryMultiplier",category:"misc",sort:61e3},strSkills:{label:"FFD20.BuffTarStrSkills",category:"skills",sort:7e4},dexSkills:{label:"FFD20.BuffTarDexSkills",category:"skills",sort:71e3},conSkills:{label:"FFD20.BuffTarConSkills",category:"skills",sort:72e3},intSkills:{label:"FFD20.BuffTarIntSkills",category:"skills",sort:73e3},wisSkills:{label:"FFD20.BuffTarWisSkills",category:"skills",sort:74e3},chaSkills:{label:"FFD20.BuffTarChaSkills",category:"skills",sort:75e3},allChecks:{label:"FFD20.BuffTarAllAbilityChecks",category:"abilityChecks",sort:8e4},strChecks:{label:"FFD20.BuffTarStrChecks",category:"abilityChecks",sort:81e3},dexChecks:{label:"FFD20.BuffTarDexChecks",category:"abilityChecks",sort:82e3},conChecks:{label:"FFD20.BuffTarConChecks",category:"abilityChecks",sort:83e3},intChecks:{label:"FFD20.BuffTarIntChecks",category:"abilityChecks",sort:84e3},wisChecks:{label:"FFD20.BuffTarWisChecks",category:"abilityChecks",sort:85e3},chaChecks:{label:"FFD20.BuffTarChaChecks",category:"abilityChecks",sort:86e3},landSpeed:{label:"FFD20.SpeedLand",category:"speed",sort:9e4},climbSpeed:{label:"FFD20.SpeedClimb",category:"speed",sort:91e3},swimSpeed:{label:"FFD20.SpeedSwim",category:"speed",sort:92e3},burrowSpeed:{label:"FFD20.SpeedBurrow",category:"speed",sort:93e3},flySpeed:{label:"FFD20.SpeedFly",category:"speed",sort:94e3},allSpeeds:{label:"FFD20.BuffTarAllSpeeds",category:"speed",sort:95e3},ac:{label:"FFD20.BuffTarACGeneric",category:"defense",sort:1e5},aac:{label:"FFD20.BuffTarACArmor",category:"defense",sort:101e3},sac:{label:"FFD20.BuffTarACShield",category:"defense",sort:102e3},nac:{label:"FFD20.BuffTarACNatural",category:"defense",sort:103e3},tac:{label:"FFD20.BuffTarACTouch",category:"defense",sort:104e3},ffac:{label:"FFD20.BuffTarACFlatFooted",category:"defense",sort:105e3},attack:{label:"FFD20.BuffTarAllAttackRolls",category:"attack",sort:11e4},bab:{label:"FFD20.BAB",category:"attack",sort:111e3},"~attackCore":{label:"",category:"attack",sort:112e3},mattack:{label:"FFD20.BuffTarMeleeAttack",category:"attack",sort:113e3},rattack:{label:"FFD20.BuffTarRangedAttack",category:"attack",sort:114e3},damage:{label:"FFD20.BuffTarAllDamageRolls",category:"damage",sort:12e4},wdamage:{label:"FFD20.WeaponDamage",category:"damage",sort:121e3},sdamage:{label:"FFD20.SpellDamage",category:"damage",sort:122e3},critConfirm:{label:"FFD20.CriticalConfirmation",category:"attack",sort:13e4},allSavingThrows:{label:"FFD20.BuffTarAllSavingThrows",category:"savingThrows",sort:14e4},fort:{label:"FFD20.SavingThrowFort",category:"savingThrows",sort:141e3},ref:{label:"FFD20.SavingThrowRef",category:"savingThrows",sort:142e3},will:{label:"FFD20.SavingThrowWill",category:"savingThrows",sort:143e3},cmb:{label:"FFD20.CMB",category:"attack",sort:15e4},cmd:{label:"FFD20.CMD",category:"defense",sort:151e3},ffcmd:{label:"FFD20.CMDFlatFooted",category:"defense",sort:152e3},init:{label:"FFD20.Initiative",category:"misc",sort:16e4},mhp:{label:"FFD20.HitPoints",category:"health",sort:17e4},wounds:{label:"FFD20.Wounds",category:"health",sort:18e4},vigor:{label:"FFD20.Vigor",category:"health",sort:181e3},mmp:{label:"FFD20.ManaPoints",category:"health",sort:171e3},spellResist:{label:"FFD20.SpellResistance",category:"defense",sort:19e4},bonusFeats:{label:"FFD20.BuffTarBonusFeats",category:"misc",sort:2e5},bonusSkillRanks:{label:"FFD20.BuffTarBonusSkillRanks",category:"skills",sort:21e4},concentration:{label:"FFD20.Concentration",category:"spell",sort:22e4},cl:{label:"FFD20.CasterLevel",category:"spell",sort:23e4}},buffTypes:{temp:"FFD20.Temporary",perm:"FFD20.Permanent",item:"FFD20.Item",misc:"FFD20.Misc"},casterProgression:{castsPerDay:{prepared:{low:[[1/0],[1/0],[1/0],[1/0,0],[1/0,1],[1/0,1],[1/0,1,0],[1/0,1,1],[1/0,2,1],[1/0,2,1,0],[1/0,2,1,1],[1/0,2,2,1],[1/0,3,2,1,0],[1/0,3,2,1,1],[1/0,3,2,2,1],[1/0,3,3,2,1],[1/0,4,3,2,1],[1/0,4,3,2,2],[1/0,4,3,3,2],[1/0,4,4,3,3]],med:[[1/0,1],[1/0,2],[1/0,3],[1/0,3,1],[1/0,4,2],[1/0,4,3],[1/0,4,3,1],[1/0,4,4,2],[1/0,5,4,3],[1/0,5,4,3,1],[1/0,5,4,4,2],[1/0,5,5,4,3],[1/0,5,5,4,3,1],[1/0,5,5,4,4,2],[1/0,5,5,5,4,3],[1/0,5,5,5,4,3,1],[1/0,5,5,5,4,4,2],[1/0,5,5,5,5,4,3],[1/0,5,5,5,5,5,4],[1/0,5,5,5,5,5,5]],high:[[1/0,1],[1/0,2],[1/0,2,1],[1/0,3,2],[1/0,3,2,1],[1/0,3,3,2],[1/0,4,3,2,1],[1/0,4,3,3,2],[1/0,4,4,3,2,1],[1/0,4,4,3,3,2],[1/0,4,4,4,3,2,1],[1/0,4,4,4,3,3,2],[1/0,4,4,4,4,3,2,1],[1/0,4,4,4,4,3,3,2],[1/0,4,4,4,4,4,3,2,1],[1/0,4,4,4,4,4,3,3,2],[1/0,4,4,4,4,4,4,3,2,1],[1/0,4,4,4,4,4,4,3,3,2],[1/0,4,4,4,4,4,4,4,3,3],[1/0,4,4,4,4,4,4,4,4,4]]},spontaneous:{low:[[1/0],[1/0],[1/0],[1/0,1],[1/0,1],[1/0,1],[1/0,1,1],[1/0,1,1],[1/0,2,1],[1/0,2,1,1],[1/0,2,1,1],[1/0,2,2,1],[1/0,3,2,1,1],[1/0,3,2,1,1],[1/0,3,2,2,1],[1/0,3,3,2,1],[1/0,4,3,2,1],[1/0,4,3,2,2],[1/0,4,3,3,2],[1/0,4,4,3,2]],med:[[1/0,1],[1/0,2],[1/0,3],[1/0,3,1],[1/0,4,2],[1/0,4,3],[1/0,4,3,1],[1/0,4,4,2],[1/0,5,4,3],[1/0,5,4,3,1],[1/0,5,4,4,2],[1/0,5,5,4,3],[1/0,5,5,4,3,1],[1/0,5,5,4,4,2],[1/0,5,5,5,4,3],[1/0,5,5,5,4,3,1],[1/0,5,5,5,4,4,2],[1/0,5,5,5,5,4,3],[1/0,5,5,5,5,5,4],[1/0,5,5,5,5,5,5]],high:[[1/0,3],[1/0,4],[1/0,5],[1/0,6,3],[1/0,6,4],[1/0,6,5,3],[1/0,6,6,4],[1/0,6,6,5,3],[1/0,6,6,6,4],[1/0,6,6,6,5,3],[1/0,6,6,6,6,4],[1/0,6,6,6,6,5,3],[1/0,6,6,6,6,6,4],[1/0,6,6,6,6,6,5,3],[1/0,6,6,6,6,6,6,4],[1/0,6,6,6,6,6,6,5,3],[1/0,6,6,6,6,6,6,6,4],[1/0,6,6,6,6,6,6,6,5,3],[1/0,6,6,6,6,6,6,6,6,4],[1/0,6,6,6,6,6,6,6,6,6]]},hybrid:{high:[[1/0,2],[1/0,3],[1/0,4],[1/0,4,2],[1/0,4,3],[1/0,4,4,2],[1/0,4,4,3],[1/0,4,4,4,2],[1/0,4,4,4,3],[1/0,4,4,4,4,2],[1/0,4,4,4,4,3],[1/0,4,4,4,4,4,2],[1/0,4,4,4,4,4,3],[1/0,4,4,4,4,4,4,2],[1/0,4,4,4,4,4,4,3],[1/0,4,4,4,4,4,4,4,2],[1/0,4,4,4,4,4,4,4,3],[1/0,4,4,4,4,4,4,4,4,2],[1/0,4,4,4,4,4,4,4,4,3],[1/0,4,4,4,4,4,4,4,4,4]]},prestige:{low:[[1/0,1],[1/0,2],[1/0,3],[1/0,3,1],[1/0,4,2],[1/0,4,3],[1/0,4,3,1],[1/0,4,4,2],[1/0,5,4,3],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1],[1/0,5,4,3,1]]}},spellsPreparedPerDay:{prepared:{low:[[null],[null],[null],[null,0],[null,1],[null,1],[null,1,0],[null,1,1],[null,2,1],[null,2,1,0],[null,2,1,1],[null,2,2,1],[null,3,2,1,0],[null,3,2,1,1],[null,3,2,2,1],[null,3,3,2,1],[null,4,3,2,1],[null,4,3,2,2],[null,4,3,3,2],[null,4,4,3,3]],med:[[3,1],[4,2],[4,3],[4,3,1],[4,4,2],[5,4,3],[5,4,3,1],[5,4,4,2],[5,5,4,3],[5,5,4,3,1],[5,5,4,4,2],[5,5,5,4,3],[5,5,5,4,3,1],[5,5,5,4,4,2],[5,5,5,5,4,3],[5,5,5,5,4,3,1],[5,5,5,5,4,4,2],[5,5,5,5,5,4,3],[5,5,5,5,5,5,4],[5,5,5,5,5,5,5]],high:[[3,1],[4,2],[4,2,1],[4,3,2],[4,3,2,1],[4,3,3,2],[4,4,3,2,1],[4,4,3,3,2],[4,4,4,3,2,1],[4,4,4,3,3,2],[4,4,4,4,3,2,1],[4,4,4,4,3,3,2],[4,4,4,4,4,3,2,1],[4,4,4,4,4,3,3,2],[4,4,4,4,4,4,3,2,1],[4,4,4,4,4,4,3,3,2],[4,4,4,4,4,4,4,3,2,1],[4,4,4,4,4,4,4,3,3,2],[4,4,4,4,4,4,4,4,3,3],[4,4,4,4,4,4,4,4,4,4]]},spontaneous:{low:[[2],[3],[4],[4,2],[5,3],[5,4],[6,4,2],[6,4,3],[6,5,4],[6,5,4,2],[6,5,4,3],[6,6,5,4],[6,6,5,4,2],[6,6,5,4,3],[6,6,6,5,4],[6,6,6,5,4],[6,6,6,5,4],[6,6,6,6,5],[6,6,6,6,5],[6,6,6,6,5]],med:[[4,2],[5,3],[6,4],[6,4,2],[6,4,3],[6,4,4],[6,5,4,2],[6,5,4,3],[6,5,4,4],[6,5,5,4,2],[6,6,5,4,3],[6,6,5,4,4],[6,6,5,5,4,2],[6,6,6,5,4,3],[6,6,6,5,4,4],[6,6,6,5,5,4,2],[6,6,6,6,5,4,3],[6,6,6,6,5,4,4],[6,6,6,6,5,5,4],[6,6,6,6,6,5,5]],high:[[4,2],[5,2],[5,3],[6,3,1],[6,4,2],[7,4,2,1],[7,5,3,2],[8,5,3,2,1],[8,5,4,3,2],[9,5,4,3,2,1],[9,5,5,4,3,2],[9,5,5,4,3,2,1],[9,5,5,4,4,3,2],[9,5,5,4,4,3,2,1],[9,5,5,4,4,4,3,2],[9,5,5,4,4,4,3,2,1],[9,5,5,4,4,4,3,3,2],[9,5,5,4,4,4,3,3,2,1],[9,5,5,4,4,4,3,3,3,2],[9,5,5,4,4,4,3,3,3,3]]},hybrid:{high:[[4,2],[5,2],[5,3],[6,3,1],[6,4,2],[7,4,2,1],[7,5,3,2],[8,5,3,2,1],[8,5,4,3,2],[9,5,4,3,2,1],[9,5,5,4,3,2],[9,5,5,4,3,2,1],[9,5,5,4,4,3,2],[9,5,5,4,4,3,2,1],[9,5,5,4,4,4,3,2],[9,5,5,4,4,4,3,2,1],[9,5,5,4,4,4,3,3,2],[9,5,5,4,4,4,3,3,2,1],[9,5,5,4,4,4,3,3,3,2],[9,5,5,4,4,4,3,3,3,3]]},prestige:{low:[[null,2],[null,3],[null,4],[null,4,2],[null,4,3],[null,4,4],[null,5,4,2],[null,5,4,3],[null,5,4,4],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2],[null,5,5,4,2]]}}},classBAB:{low:"FFD20.Low",med:"FFD20.Medium",high:"FFD20.High",custom:"FFD20.Custom"},classBABFormulas:{low:"floor(@hitDice * 0.5)",med:"floor(@hitDice * 0.75)",high:"@hitDice",custom:"0"},classBaseMPTypes:{noncaster:"FFD20.NonCaster",halfCaster:"FFD20.HalfCaster",dimPacman:"FFD20.DimPacman",pacman:"FFD20.Pacman",dimFullCaster:"FFD20.DimFullCaster",fullCaster:"FFD20.FullCaster",advFullCaster:"FFD20.AdvFullCaster"},classBaseMPauto:{no:"FFD20.No",yes:"FFD20.Yes",half:"FFD20.Half"},classCasterType:{astrologian:"high",blackmage:"high",bluemage:"high",geomancer:"high",illusionist:"high",necromancer:"high",summoner:"high",timemage:"high",whitemage:"high",bard:"med",cleric:"med",redmage:"med",scholar:"med",darkknight:"low",holyknight:"low"},classCastingStats:{noncaster:"FFD20.NonCaster",int:"FFD20.AbilityShortInt",wis:"FFD20.AbilityShortWis",cha:"FFD20.AbilityShortCha",intAndWis:"FFD20.AbilityShortIntAndWis"},classFractionalBABFormulas:{low:"@hitDice * 0.5",med:"@hitDice * 0.75",high:"@hitDice",custom:"0"},classFractionalSavingThrowFormulas:{goodSaveBonus:"2",base:{low:"@hitDice / 3",high:"@hitDice / 2",goodSave:!0},prestige:{low:"(1 + @hitDice) / 3",high:"(1 + @hitDice) / 2"},npc:{low:"@hitDice / 3",high:"@hitDice / 2",goodSave:!0},racial:{low:"@hitDice / 3",high:"@hitDice / 2",goodSave:!0},mythic:{low:"0",high:"0"},custom:{low:"0",high:"0"}},classMPStatsBonus:{1:[0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5],2:[0,1,3,3,3,4,6,6,6,7,9,9,9,10,12,12,12,13],3:[0,1,3,6,6,7,9,12,12,13,15,18,18,19,21,24,24,25],4:[0,1,3,6,10,11,13,16,20,21,23,26,30,31,33,36,40,41],5:[0,1,3,6,10,16,18,21,25,31,33,36,40,46,48,51,55,61],6:[0,1,3,6,10,16,24,27,31,37,45,48,52,58,66,69,73,79],7:[0,1,3,6,10,16,24,34,38,44,52,62,66,72,80,90,94,100],8:[0,1,3,6,10,16,24,34,46,52,60,70,82,88,96,106,118,124],9:[0,1,3,6,10,16,24,34,46,61,69,79,91,106,114,124,136,151]},classMPlevels:{noncaster:[0],halfCaster:[0,0,0,1,2,3,4,5,6,7,8,10,12,14,16,19,22,25,29,33],dimPacman:[1,2,3,4,5,6,8,10,12,15,18,21,25,29,33,38,43,48,53,58],pacman:[2,3,4,5,6,8,10,13,16,20,24,29,34,39,45,51,57,64,71,79],dimFullCaster:[2,3,4,5,6,8,11,15,20,24,29,35,42,49,56,65,74,83,92,101],fullCaster:[3,4,5,6,8,11,15,20,26,32,39,47,56,65,75,86,98,110,122,135],advFullCaster:[4,6,8,9,14,17,25,30,41,47,60,68,84,93,111,124,143,155,167,180]},classSavingThrowFormulas:{base:{low:"floor(@hitDice / 3)",high:"2 + floor(@hitDice / 2)"},prestige:{low:"floor((1 + @hitDice) / 3)",high:"floor((1 + @hitDice) / 2)"},npc:{low:"floor(@hitDice / 3)",high:"2 + floor(@hitDice / 2)"},racial:{low:"floor(@hitDice / 3)",high:"2 + floor(@hitDice / 2)"},mythic:{low:"0",high:"0"},custom:{low:"0",high:"0"}},classSavingThrows:{low:"FFD20.Poor",high:"FFD20.Good",custom:"FFD20.Custom"},classSkillBonus:3,classSubTypes:{none:"FFD20.None",core:"FFD20.ClassSubTypeCore",coreArc:"FFD20.ClassSubTypeCoreArc",base:"FFD20.ClassSubTypeBase",baseArc:"FFD20.ClassSubTypeBaseArc",hybrid:"FFD20.ClassSubTypeHybrid",hybridArc:"FFD20.ClassSubTypeHybridArc"},classTypes:{base:"FFD20.ClassTypeBase",prestige:"FFD20.ClassTypePrestige",npc:"FFD20.ClassTypeNPC",racial:"FFD20.ClassTypeRacial",mythic:"FFD20.ClassTypeMythic"},conditionMechanics:{pf1_blind:{changes:[{formula:-2,subTarget:"ac",modifier:"penalty"}],flags:["loseDexToAC"]},dazzled:{changes:[{formula:-1,subTarget:"attack",modifier:"penalty"}]},pf1_deaf:{changes:[{formula:-4,subTarget:"init",modifier:"penalty"}]},entangled:{changes:[{formula:-4,subTarget:"dex",modifier:"penalty"},{formula:-2,subTarget:"attack",modifier:"penalty"}]},grappled:{changes:[{formula:-4,subTarget:"dex",modifier:"penalty"},{formula:-2,subTarget:"attack",modifier:"penalty"}]},helpless:{changes:[{formula:0,subTarget:"dex",modifier:"untypedPerm",operator:"set",priority:1001,continuous:!0}]},pf1_sleep:{changes:[{formula:0,subTarget:"dex",modifier:"untypedPerm",operator:"set",priority:1001,continuous:!0}]},paralyzed:{changes:[{formula:0,subTarget:"dex",modifier:"untypedPerm",operator:"set",priority:1001,continuous:!0},{formula:0,subTarget:"str",modifier:"untypedPerm",operator:"set",priority:1001,continuous:!0}]},pf1_prone:{changes:[{formula:-4,subTarget:"mattack",modifier:"penalty"}]},pinned:{changes:[{formula:"min(0, @abilities.dex.mod)",subTarget:"dexMod",modifier:"untyped",operator:"set",priority:1001,continuous:!0},{formula:-4,subTarget:"ac",modifier:"penalty"},{formula:-4,subTarget:"cmd",modifier:"penalty"}],flags:["loseDexToAC"]},cowering:{changes:[{formula:-2,subTarget:"ac",modifier:"penalty"}]},shaken:{changes:[{formula:-2,subTarget:"attack",modifier:"penalty"},{formula:-2,subTarget:"allSavingThrows",modifier:"penalty"},{formula:-2,subTarget:"skills",modifier:"penalty"},{formula:-2,subTarget:"allChecks",modifier:"penalty"}]},frightened:{changes:[{formula:-2,subTarget:"attack",modifier:"penalty"},{formula:-2,subTarget:"allSavingThrows",modifier:"penalty"},{formula:-2,subTarget:"skills",modifier:"penalty"},{formula:-2,subTarget:"allChecks",modifier:"penalty"}]},panicked:{changes:[{formula:-2,subTarget:"attack",modifier:"penalty"},{formula:-2,subTarget:"allSavingThrows",modifier:"penalty"},{formula:-2,subTarget:"skills",modifier:"penalty"},{formula:-2,subTarget:"allChecks",modifier:"penalty"}]},sickened:{changes:[{formula:-2,subTarget:"attack",modifier:"penalty"},{formula:-2,subTarget:"wdamage",modifier:"penalty"},{formula:-2,subTarget:"allSavingThrows",modifier:"penalty"},{formula:-2,subTarget:"skills",modifier:"penalty"},{formula:-2,subTarget:"allChecks",modifier:"penalty"}]},nauseated:{},stunned:{changes:[{formula:-2,subTarget:"ac",modifier:"penalty"}]},exhausted:{changes:[{formula:-6,subTarget:"str",modifier:"penalty"},{formula:-6,subTarget:"dex",modifier:"penalty"}]},fatigued:{changes:[{formula:-2,subTarget:"str",modifier:"penalty"},{formula:-2,subTarget:"dex",modifier:"penalty"}]},squeezing:{changes:[{formula:-4,subTarget:"ac",modifier:"penalty"},{formula:-4,subTarget:"attack",modifier:"penalty"}]}},conditionTextures:{antagonized:"systems/ffd20/icons/conditions/antagonized.png",berserk:"systems/ffd20/icons/conditions/berserk.png",bleed:"systems/ffd20/icons/conditions/bleed.png",pf1_blind:"systems/ffd20/icons/conditions/blind.png",burning:"systems/ffd20/icons/conditions/burning.png",charmed:"systems/ffd20/icons/conditions/charmed.png",confused:"systems/ffd20/icons/conditions/confused.png",cowering:"systems/ffd20/icons/conditions/cowering.png",cursed:"systems/ffd20/icons/conditions/cursed.png",dazed:"systems/ffd20/icons/conditions/dazed.png",dazzled:"systems/ffd20/icons/conditions/dazzled.png",pf1_deaf:"systems/ffd20/icons/conditions/deaf.png",deprotect:"systems/ffd20/icons/conditions/deprotect.png",deshell:"systems/ffd20/icons/conditions/deshell.png",dimmed:"systems/ffd20/icons/conditions/dimmed.png",disabled:"systems/ffd20/icons/conditions/disabled.png",diseased:"systems/ffd20/icons/conditions/diseased.png",doom:"systems/ffd20/icons/conditions/doom.png",drenched:"systems/ffd20/icons/conditions/drenched.png",energyDrained:"systems/ffd20/icons/conditions/energydrained.png",entangled:"systems/ffd20/icons/conditions/entangled.png",exhausted:"systems/ffd20/icons/conditions/exhausted.png",fascinated:"systems/ffd20/icons/conditions/fascinated.png",fatigued:"systems/ffd20/icons/conditions/fatigued.png",frightened:"systems/ffd20/icons/conditions/frightened.png",frog:"systems/ffd20/icons/conditions/frog.png",frozen:"systems/ffd20/icons/conditions/frozen.png",grappled:"systems/ffd20/icons/conditions/grappled.png",helpless:"systems/ffd20/icons/conditions/helpless.png",immobilized:"systems/ffd20/icons/conditions/immobilized.png",imperil:"systems/ffd20/icons/conditions/imperil.png",incorporeal:"systems/ffd20/icons/conditions/incorporeal.png",invisible:"systems/ffd20/icons/conditions/invisible.png",mini:"systems/ffd20/icons/conditions/mini.png",nauseated:"systems/ffd20/icons/conditions/nauseated.png",panicked:"systems/ffd20/icons/conditions/fear.png",paralyzed:"systems/ffd20/icons/conditions/paralyzed.png",petrified:"systems/ffd20/icons/conditions/petrified.png",pinned:"systems/ffd20/icons/conditions/pinned.png",poisoned:"systems/ffd20/icons/conditions/poisoned.png",pf1_prone:"systems/ffd20/icons/conditions/prone.png",sapped:"systems/ffd20/icons/conditions/sapped.png",shaken:"systems/ffd20/icons/conditions/shaken.png",sickened:"systems/ffd20/icons/conditions/sickened.png",silenced:"systems/ffd20/icons/conditions/silenced.png",pf1_sleep:"systems/ffd20/icons/conditions/sleep.png",slow:"systems/ffd20/icons/conditions/slow.png",squalled:"systems/ffd20/icons/conditions/squalled.png",staggered:"systems/ffd20/icons/conditions/staggered.png",static:"systems/ffd20/icons/conditions/static.png",stop:"systems/ffd20/icons/conditions/stop.png",stunned:"systems/ffd20/icons/conditions/stunned.png",unlucky:"systems/ffd20/icons/conditions/unlucky.png",weighted:"systems/ffd20/icons/conditions/weighted.png",zombie:"systems/ffd20/icons/conditions/zombie.png"},conditionTracks:{fear:["shaken","frightened","panicked"],lethargy:["fatigued","exhausted"]},conditionTypes:{antagonized:"FFD20.CondTypeAntagonized",berserk:"FFD20.CondTypeBerserk",bleed:"FFD20.CondTypeBleed",pf1_blind:"FFD20.CondTypeBlinded",burning:"FFD20.CondTypeBurning",charmed:"FFD20.CondTypeCharmed",confused:"FFD20.CondTypeConfused",cowering:"FFD20.CondTypeCowering",cursed:"FFD20.CondTypeCursed",dazed:"FFD20.CondTypeDazed",dazzled:"FFD20.CondTypeDazzled",pf1_deaf:"FFD20.CondTypeDeafened",deprotect:"FFD20.CondTypeDeprotect",deshell:"FFD20.CondTypeDeshell",dimmed:"FFD20.CondTypeDimmed",disabled:"FFD20.CondTypeDisabled",diseased:"FFD20.CondTypeDiseased",doom:"FFD20.CondTypeDoom",drenched:"FFD20.CondTypeDrenched",energyDrained:"FFD20.CondTypeEnergyDrained",entangled:"FFD20.CondTypeEntangled",exhausted:"FFD20.CondTypeExhausted",fascinated:"FFD20.CondTypeFascinated",fatigued:"FFD20.CondTypeFatigued",frightened:"FFD20.CondTypeFrightened",frog:"FFD20.CondTypeFrog",frozen:"FFD20.CondTypeFrozen",immobilized:"FFD20.CondTypeImmobilized",imperil:"FFD20.CondTypeImperil",invisible:"FFD20.CondTypeInvisible",mini:"FFD20.CondTypeMini",nauseated:"FFD20.CondTypeNauseated",panicked:"FFD20.CondTypePanicked",paralyzed:"FFD20.CondTypeParalyzed",petrified:"FFD20.CondTypePetrified",poisoned:"FFD20.CondTypePoisoned",pf1_prone:"FFD20.CondTypeProne",sapped:"FFD20.CondTypeSapped",shaken:"FFD20.CondTypeShaken",sickened:"FFD20.CondTypeSickened",silenced:"FFD20.CondTypeSilenced",pf1_sleep:"FFD20.CondTypeSleep",slow:"FFD20.CondTypeSlow",squalled:"FFD20.CondTypeSqualled",staggered:"FFD20.CondTypeStaggered",static:"FFD20.CondTypeStatic",stop:"FFD20.CondTypeStop",stunned:"FFD20.CondTypeStunned",weighted:"FFD20.CondTypeWeighted",unlucky:"FFD20.CondTypeUnlucky",zombie:"FFD20.CondTypeZombie"},conditionalTargets:{attack:{_label:"FFD20.AttackRollPlural",allAttack:"FFD20.All",hasteAttack:"FFD20.Haste",rapidShotAttack:"FFD20.RapidShot"},damage:{_label:"FFD20.Damage",allDamage:"FFD20.All",hasteDamage:"FFD20.Haste",rapidShotDamage:"FFD20.RapidShot"},size:{_label:"FFD20.Size"},effect:{_label:"FFD20.Effects"},misc:{_label:"FFD20.MiscShort"}},conditions:{antagonized:"FFD20.CondAntagonized",berserk:"FFD20.CondBerserk",bleed:"FFD20.CondBleed",pf1_blind:"FFD20.CondBlinded",burning:"FFD20.CondBurning",charmed:"FFD20.CondCharmed",confused:"FFD20.CondConfused",cowering:"FFD20.CondCowering",cursed:"FFD20.CondCursed",dazed:"FFD20.CondDazed",dazzled:"FFD20.CondDazzled",pf1_deaf:"FFD20.CondDeafened",deprotect:"FFD20.CondDeprotect",deshell:"FFD20.CondDeshell",dimmed:"FFD20.CondDimmed",disabled:"FFD20.CondDisabled",diseased:"FFD20.CondDiseased",doom:"FFD20.CondDoom",drenched:"FFD20.CondDrenched",energyDrained:"FFD20.CondEnergyDrained",entangled:"FFD20.CondEntangled",exhausted:"FFD20.CondExhausted",fascinated:"FFD20.CondFascinated",fatigued:"FFD20.CondFatigued",frightened:"FFD20.CondFrightened",frog:"FFD20.CondFrog",frozen:"FFD20.CondFrozen",grappled:"FFD20.CondGrappled",helpless:"FFD20.CondHelpless",immobilized:"FFD20.CondImmobilized",imperil:"FFD20.CondImperil",incorporeal:"FFD20.CondIncorporeal",invisible:"FFD20.CondInvisible",mini:"FFD20.CondMini",nauseated:"FFD20.CondNauseated",panicked:"FFD20.CondPanicked",paralyzed:"FFD20.CondParalyzed",petrified:"FFD20.CondPetrified",pinned:"FFD20.CondPinned",poisoned:"FFD20.CondPoisoned",pf1_prone:"FFD20.CondProne",sapped:"FFD20.CondSapped",shaken:"FFD20.CondShaken",sickened:"FFD20.CondSickened",silenced:"FFD20.CondSilenced",pf1_sleep:"FFD20.CondSleep",slow:"FFD20.CondSlow",squalled:"FFD20.CondSqualled",staggered:"FFD20.CondStaggered",static:"FFD20.CondStatic",stop:"FFD20.CondStop",stunned:"FFD20.CondStunned",unlucky:"FFD20.CondUnlucky",weighted:"FFD20.CondWeighted",zombie:"FFD20.CondZombie"},consumableTypes:{potion:"FFD20.ConsumableTypePotion",oil:"FFD20.ConsumableTypeOil",poison:"FFD20.ConsumableTypePoison",drug:"FFD20.ConsumableTypeDrug",alchContact:"FFD20.ConsumableTypeAlchContact",alchIngested:"FFD20.ConsumableTypeAlchIngested",alchInhaled:"FFD20.ConsumableTypeAlchInhaled",scroll:"FFD20.ConsumableTypeScroll",wand:"FFD20.ConsumableTypeWand",rod:"FFD20.ConsumableTypeRod",staff:"FFD20.ConsumableTypeStaff",misc:"FFD20.Misc"},contextNoteCategories:{attacks:{label:"FFD20.Attacks"},savingThrows:{label:"FFD20.SavingThrowPlural"},skills:{label:"FFD20.Skills"},skill:{label:"FFD20.BuffTarSpecificSkill"},abilityChecks:{label:"FFD20.BuffTarAbilityChecks"},spell:{label:"FFD20.BuffTarSpells"},defense:{label:"FFD20.Defense"},misc:{label:"FFD20.Misc"}},contextNoteTargets:{attack:{label:"FFD20.AttackRollPlural",category:"attacks"},effect:{label:"FFD20.Effects",category:"attacks"},melee:{label:"FFD20.Melee",category:"attacks"},meleeWeapon:{label:"FFD20.MeleeWeapon",category:"attacks"},meleeSpell:{label:"FFD20.MeleeSpell",category:"attacks"},ranged:{label:"FFD20.Ranged",category:"attacks"},rangedWeapon:{label:"FFD20.RangedWeapon",category:"attacks"},rangedSpell:{label:"FFD20.RangedSpell",category:"attacks"},cmb:{label:"FFD20.CMB",category:"attacks"},allSavingThrows:{label:"FFD20.BuffTarAllSavingThrows",category:"savingThrows"},fort:{label:"FFD20.SavingThrowFort",category:"savingThrows"},ref:{label:"FFD20.SavingThrowRef",category:"savingThrows"},will:{label:"FFD20.SavingThrowWill",category:"savingThrows"},skills:{label:"FFD20.BuffTarAllSkills",category:"skills"},strSkills:{label:"FFD20.BuffTarStrSkills",category:"skills"},dexSkills:{label:"FFD20.BuffTarDexSkills",category:"skills"},conSkills:{label:"FFD20.BuffTarConSkills",category:"skills"},intSkills:{label:"FFD20.BuffTarIntSkills",category:"skills"},wisSkills:{label:"FFD20.BuffTarWisSkills",category:"skills"},chaSkills:{label:"FFD20.BuffTarChaSkills",category:"skills"},allChecks:{label:"FFD20.BuffTarAllAbilityChecks",category:"abilityChecks"},strChecks:{label:"FFD20.BuffTarStrChecks",category:"abilityChecks"},dexChecks:{label:"FFD20.BuffTarDexChecks",category:"abilityChecks"},conChecks:{label:"FFD20.BuffTarConChecks",category:"abilityChecks"},intChecks:{label:"FFD20.BuffTarIntChecks",category:"abilityChecks"},wisChecks:{label:"FFD20.BuffTarWisChecks",category:"abilityChecks"},chaChecks:{label:"FFD20.BuffTarChaChecks",category:"abilityChecks"},spellEffect:{label:"FFD20.SpellBuffEffect",category:"spell"},concentration:{label:"FFD20.Concentration",category:"spell"},cl:{label:"FFD20.CasterLevel",category:"spell"},ac:{label:"FFD20.ACNormal",category:"defense"},cmd:{label:"FFD20.CMD",category:"defense"},sr:{label:"FFD20.SpellResistance",category:"defense"},init:{label:"FFD20.Initiative",category:"misc"}},countforexp:{exp:"FFD20.ClassExp",noExp:"FFD20.ClassNoExp"},creatureTypes:{aberration:"FFD20.CreatureTypeAberration",animal:"FFD20.CreatureTypeAnimal",construct:"FFD20.CreatureTypeConstruct",dragon:"FFD20.CreatureTypeDragon",fey:"FFD20.CreatureTypeFey",humanoid:"FFD20.CreatureTypeHumanoid",magicalBeast:"FFD20.CreatureTypeMagicalBeast",monstrousHumanoid:"FFD20.CreatureTypeMonstrousHumanoid",ooze:"FFD20.CreatureTypeOoze",outsider:"FFD20.CreatureTypeOutsider",plant:"FFD20.CreatureTypePlant",undead:"FFD20.CreatureTypeUndead",vermin:"FFD20.CreatureTypeVermin"},currencies:{pgil:"FFD20.CurrencyPGil",gil:"FFD20.CurrencyGil",sgil:"FFD20.CurrencySGil",cgil:"FFD20.CurrencyCGil"},defaultIcons:{items:{attack:"icons/svg/explosion.svg",buff:"icons/svg/ice-aura.svg",class:"icons/svg/paralysis.svg",consumable:"icons/svg/tankard.svg",container:"icons/svg/barrel.svg",equipment:"icons/svg/combat.svg",feat:"icons/svg/book.svg",loot:"icons/svg/item-bag.svg",race:"icons/svg/wing.svg",spell:"icons/svg/daze.svg",weapon:"icons/svg/sword.svg"},actors:{character:"icons/svg/mystery-man.svg",npc:"icons/svg/terror.svg",basic:"icons/svg/castle.svg"}},distanceUnits:{none:"FFD20.None",personal:"FFD20.DistPersonal",touch:"FFD20.DistTouch",melee:"FFD20.DistMelee",reach:"FFD20.DistReach",close:"FFD20.DistClose",medium:"FFD20.DistMedium",long:"FFD20.DistLong",ft:"FFD20.DistFt",mi:"FFD20.DistMi",spec:"FFD20.Special",seeText:"FFD20.SeeText",unlimited:"FFD20.Unlimited"},divineFocus:{0:"",1:"FFD20.SpellComponentDivineFocusAlone",2:"FFD20.SpellComponentDivineFocusMaterial",3:"FFD20.SpellComponentDivineFocusFocus"},encumbranceLevels:{light:0,medium:1,heavy:2},encumbranceLoads:[0,10,20,30,40,50,60,70,80,90,100,115,130,150,175,200,230,260,300,350,400,460,520,600,700,800,920,1040,1200,1400,1600,1840,2080,2400,2800,3200,3680,4160,4800,5600,6400,7360,8320,9600,11200,12800,14720,16640,19200,22400,25600],encumbranceMultipliers:{normal:{fine:.125,dim:.25,tiny:.5,sm:.75,med:1,lg:2,huge:4,grg:8,col:16},quadruped:{fine:.25,dim:.5,tiny:.75,sm:1,med:1.5,lg:3,huge:6,grg:12,col:24}},equipmentSlots:{armor:{armor:"FFD20.EquipSlotArmor"},shield:{shield:"FFD20.EquipSlotShield"},wondrous:{slotless:"FFD20.EquipSlotSlotless",head:"FFD20.EquipSlotHead",headband:"FFD20.EquipSlotHeadband",eyes:"FFD20.EquipSlotEyes",shoulders:"FFD20.EquipSlotShoulders",neck:"FFD20.EquipSlotNeck",chest:"FFD20.EquipSlotChest",body:"FFD20.EquipSlotBody",belt:"FFD20.EquipSlotBelt",wrists:"FFD20.EquipSlotWrists",hands:"FFD20.EquipSlotHands",ring:"FFD20.EquipSlotRing",feet:"FFD20.EquipSlotFeet"},clothing:{clothing:"FFD20.EquipTypeClothing"},materia:{any:"FFD20.MateriaSlotAny",weapon:"FFD20.MateriaSlotWeapon",shield:"FFD20.MateriaSlotShield",armor:"FFD20.MateriaSlotArmor",weaponarmor:"FFD20.MateriaSlotWeaponArmor",armorShield:"FFD20.MateriaSlotArmorShield",other:"FFD20.MateriaSlotOther"},other:{other:"FFD20.Other"}},equipmentTypes:{armor:{_label:"FFD20.EquipTypeArmor",lightArmor:"FFD20.EquipTypeLight",mediumArmor:"FFD20.EquipTypeMedium",heavyArmor:"FFD20.EquipTypeHeavy"},shield:{_label:"FFD20.EquipTypeShield",lightShield:"FFD20.EquipTypeLightShield",heavyShield:"FFD20.EquipTypeHeavyShield",towerShield:"FFD20.EquipTypeTowerShield",other:"FFD20.EquipTypeOtherShield"},wondrous:{_label:"FFD20.EquipTypeWondrousItem"},clothing:{_label:"FFD20.EquipTypeClothing"},materia:{_label:"FFD20.Materia",ability:"FFD20.MateriaTypeAbility",independent:"FFD20.MateriaTypeIndependent",spell:"FFD20.MateriaTypeSpell",summon:"FFD20.MateriaTypeSummon",support:"FFD20.MateriaTypeSupport"},other:{_label:"FFD20.Other"}},favouredClassBonusIcons:{hp:"fa-heartbeat",skill:"fa-wrench",alt:"fa-tag"},favouredClassBonuses:{hp:"FFD20.FavouredClassHP",skill:"FFD20.FavouredClassSkill",alt:"FFD20.FavouredClassAlt"},featTypes:{feat:"FFD20.FeatTypeFeat",classFeat:"FFD20.FeatTypeClassFeat",trait:"FFD20.FeatTypeTraits",racial:"FFD20.FeatTypeRacial",misc:"FFD20.Misc",template:"FFD20.FeatTypeTemplate"},featTypesPlurals:{feat:"FFD20.FeatPlural",classFeat:"FFD20.ClassFeaturePlural",trait:"FFD20.TraitPlural",racial:"FFD20.RacialTraitPlural",template:"FFD20.TemplatePlural"},flyManeuverabilities:{clumsy:"FFD20.FlyManeuverabilityClumsy",poor:"FFD20.FlyManeuverabilityPoor",average:"FFD20.FlyManeuverabilityAverage",good:"FFD20.FlyManeuverabilityGood",perfect:"FFD20.FlyManeuverabilityPerfect"},flyManeuverabilityValues:{clumsy:-8,poor:-4,average:0,good:4,perfect:8},healingTypes:{healing:"FFD20.Healing",temphp:"FFD20.HealingTemp"},itemActionTypes:{mwak:"FFD20.ActionMWAK",rwak:"FFD20.ActionRWAK",msak:"FFD20.ActionMSAK",rsak:"FFD20.ActionRSAK",mcman:"FFD20.ActionMCMan",rcman:"FFD20.ActionRCMan",spellsave:"FFD20.ActionSpellSave",save:"FFD20.ActionSave",heal:"FFD20.ActionHeal",other:"FFD20.ActionOther"},itemCapacityTypes:{items:"FFD20.ItemContainerCapacityItems",weight:"FFD20.ItemContainerCapacityWeight"},itemTypes:{equipment:"FFD20.ItemTypeEquipment",weapon:"FFD20.ItemTypeWeapon",loot:"FFD20.ItemTypeLoot",consumable:"FFD20.ItemTypeConsumable",class:"FFD20.ItemTypeClass",buff:"FFD20.ItemTypeBuff",spell:"FFD20.ItemTypeSpell",feat:"FFD20.ItemTypeFeat",attack:"FFD20.ItemTypeAttack"},keepItemLinksOnCopy:["classAssociations"],languages:{common:"FFD20.LanguageCommon",dwarven:"FFD20.LanguageDwarven",elvaan:"FFD20.LanguageElvaan",galkan:"FFD20.LanguageGalkan",lalafellan:"FFD20.LanguageLalafellan",mithran:"FFD20.LanguageMithran",moogle:"FFD20.LanguageMoogle",aegyllan:"FFD20.LanguageAegyllan",albhedian:"FFD20.LanguageAlbhedian",banganese:"FFD20.LanguageBanganese",burmecian:"FFD20.LanguageBurmecian",draconic:"FFD20.LanguageDraconic",garif:"FFD20.LanguageGarif",guado:"FFD20.LanguageGuado",hypello:"FFD20.LanguageHypello",lupin:"FFD20.LanguageLupin",mandragoran:"FFD20.LanguageMandragoran",numish:"FFD20.LanguageNumish",qiqirn:"FFD20.LanguageQiqirn",queran:"FFD20.LanguageQueran",roegadyn:"FFD20.LanguageRoegadyn",ronsaur:"FFD20.LanguageRonsaur",seeq:"FFD20.LanguageSeeq",tonberry:"FFD20.LanguageTonberry",vieran:"FFD20.LanguageVieran",celestial:"FFD20.LanguageCelestial",infernal:"FFD20.LanguageInfernal",abyssal:"FFD20.LanguageAbyssal",aquan:"FFD20.LanguageAquan",auran:"FFD20.LanguageAuran",auroran:"FFD20.LanguageAuroran",enochian:"FFD20.LanguageEnochian",ignan:"FFD20.LanguageIgnan",terran:"FFD20.LanguageTerran",thorian:"FFD20.LanguageThorian",umbran:"FFD20.LanguageUmbran",amaljaa:"FFD20.LanguageAmaljaa",antican:"FFD20.LanguageAntican",goblin:"FFD20.LanguageGoblin",kojin:"FFD20.LanguageKojin",orcish:"FFD20.LanguageOrcish",quadav:"FFD20.LanguageQuadav",sahagin:"FFD20.LanguageSahagin",sylvan:"FFD20.LanguageSylvan",undercommon:"FFD20.LanguageUndercommon",vanu:"FFD20.LanguageVanu",yagudo:"FFD20.LanguageYagudo"},levelAbilityScoreFeature:{img:"systems/ffd20/icons/skills/affliction_10.jpg",name:"FFD20.LevelUp.AbilityScore.Item.Name",system:{description:{value:"FFD20.LevelUp.AbilityScore.Item.Desc"},subType:"misc"},type:"feat"},levelAbilityScores:{4:1,8:1,12:1,16:1,20:1},limitedUsePeriods:{single:"FFD20.LimitedUseSingle",unlimited:"FFD20.Unlimited",day:"FFD20.LimitedUseDay",week:"FFD20.LimitedUseWeek",charges:"FFD20.LimitedUseCharges"},lootTypes:{gear:"FFD20.LootTypeGear",ammo:"FFD20.LootTypeAmmo",tradeGoods:"FFD20.LootTypeTradeGoods",misc:"FFD20.Misc"},magicAuraByLevel:{spell:[{power:"faint",level:1},{power:"moderate",level:4},{power:"strong",level:7},{power:"overwhelming",level:10}],item:[{power:"faint",level:1},{power:"moderate",level:6},{power:"strong",level:12},{power:"overwhelming",level:21}]},materiaRarity:{common:"FFD20.MateriaRarityCommon",uncommon:"FFD20.MateriaRarityUncommon",rare:"FFD20.MateriaRarityRare",legendary:"FFD20.MateriaRarityLegendary"},materiaRarityMath:{common:1,uncommon:2,rare:3,legendary:4},materiaSlot:{unslotted:"FFD20.MateriaSlotUnslotted",weapon:"FFD20.MateriaSlotWeapon",shield:"FFD20.MateriaSlotShield",armor:"FFD20.MateriaSlotArmor",other:"FFD20.MateriaSlotOther"},measureTemplateTypes:{cone:"FFD20.MeasureTemplateCone",circle:"FFD20.MeasureTemplateCircle",ray:"FFD20.MeasureTemplateRay",rect:"FFD20.MeasureTemplateRectangle"},measureUnits:{ft:"FFD20.DistFt",mi:"FFD20.DistMi",m:"FFD20.DistM",km:"FFD20.DistKM"},measureUnitsShort:{ft:"FFD20.DistFtShort",mi:"FFD20.DistMiShort",m:"FFD20.DistMShort",km:"FFD20.DistKMShort"},multiSchools:{blank:"",sumhealenc:"FFD20.SpellSchoolSummoningHealingEnhancing",sumheal:"FFD20.SpellSchoolSummoningHealing",sumenfdrk:"FFD20.SpellSchoolSummoningEnfeeblingDark",sumenflit:"FFD20.SpellSchoolSummoningEnfeeblingLight",sumenfele:"FFD20.SpellSchoolSummoningEnfeeblingElemental",sumenf:"FFD20.SpellSchoolSummoningEnfeebling",sumenc:"FFD20.SpellSchoolSummoningEnhancing",sumdrk:"FFD20.SpellSchoolSummoningDark",sumlit:"FFD20.SpellSchoolSummoningLight",sumele:"FFD20.SpellSchoolSummoningElemental",sumnel:"FFD20.SpellSchoolSummoningNonElemental",crnheal:"FFD20.SpellSchoolChronomancyHealing",crnnec:"FFD20.SpellSchoolChronomancyNecromancy",crnenf:"FFD20.SpellSchoolChronomancyEnfeebling",crnenc:"FFD20.SpellSchoolChronomancyEnhancing",healenf:"FFD20.SpellSchoolHealingEnfeebling",healenc:"FFD20.SpellSchoolHealingEnhancing",illenf:"FFD20.SpellSchoolIllusionEnfeebling",illenc:"FFD20.SpellSchoolIllusionEnhancing",necenc:"FFD20.SpellSchoolNecromancyEnhancing",necenf:"FFD20.SpellSchoolNecromancyEnfeebling",necele:"FFD20.SpellSchoolNecromancyElemental",necnel:"FFD20.SpellSchoolNecromancyNonElemental",enfenc:"FFD20.SpellSchoolEnfeeblingEnhancing",enfdrkele:"FFD20.SpellSchoolEnfeeblingDarkElemental",enfdrknel:"FFD20.SpellSchoolEnfeeblingDarkNonElemental",enfdrk:"FFD20.SpellSchoolEnfeeblingDark",enflit:"FFD20.SpellSchoolEnfeeblingLight",enfele:"FFD20.SpellSchoolEnfeeblingElemental",enfnel:"FFD20.SpellSchoolEnfeeblingNonElemental",encdrk:"FFD20.SpellSchoolEnhancingDark",enclit:"FFD20.SpellSchoolEnhancingLight",encele:"FFD20.SpellSchoolEnhancingElemental",encnel:"FFD20.SpellSchoolEnhancingNonElemental",drkele:"FFD20.SpellSchoolDarkElemental",drknel:"FFD20.SpellSchoolDarkNonElemental",litele:"FFD20.SpellSchoolLightElemental",litnel:"FFD20.SpellSchoolLightNonElemental"},pointBuy:{low:{label:"FFD20.PointBuyCalculatorLowFantasy",points:10},standard:{label:"FFD20.PointBuyCalculatorStandardFantasy",points:15},high:{label:"FFD20.PointBuyCalculatorHighFantasy",points:20},epic:{label:"FFD20.PointBuyCalculatorEpicFantasy",points:25}},proficiencyLevels:{"-4":"Not Proficient",0:"Proficient"},re:{traitSeparator:/\s*[;]\s*/g},savingThrows:{fort:"FFD20.SavingThrowFort",ref:"FFD20.SavingThrowRef",will:"FFD20.SavingThrowWill"},senses:{bs:"FFD20.SenseBS",bse:"FFD20.SenseBSense",dv:"FFD20.SenseDV",ts:"FFD20.SenseTS",tr:"FFD20.SenseTR",ll:"FFD20.SenseLL",si:"FFD20.SenseSI",sid:"FFD20.SenseSID",sc:"FFD20.SenseSC"},shieldTypes:{none:0,other:1,light:2,heavy:3,tower:4},sizeChart:{fine:"F",dim:"D",tiny:"T",sm:"S",med:"M",lg:"L",huge:"H",grg:"G",col:"C"},sizeDie:["1","1d2","1d3","1d4","1d6","1d8","1d10","2d6","2d8","3d6","3d8","4d6","4d8","6d6","6d8","8d6","8d8","12d6","12d8","16d6","16d8"],sizeFlyMods:{fine:8,dim:6,tiny:4,sm:2,med:0,lg:-2,huge:-4,grg:-6,col:-8},sizeMods:{fine:8,dim:4,tiny:2,sm:1,med:0,lg:-1,huge:-2,grg:-4,col:-8},sizeSpecialMods:{fine:-8,dim:-4,tiny:-2,sm:-1,med:0,lg:1,huge:2,grg:4,col:8},sizeStealthMods:{fine:16,dim:12,tiny:8,sm:4,med:0,lg:-4,huge:-8,grg:-12,col:-16},skillCompendiumEntries:{acr:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.gGfJO90ZuRT4sZ9X",apr:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.QGxoGsSIAOoe5dTW",blf:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.kRK5XwVBvcMi35w2",clm:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ZAwjVOTwsBpZRgw4",crf:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.3E8pxbjI8MD3JbfQ",dip:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.uB9Fy36RUjibxqvt",dev:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.cSdUATLHBFfw3v4s",dis:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xg25z3GIpS590NDW",dri:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.EiaJIZVdGDvLxVll",esc:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DTNlXXg77s3178WJ",fly:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.iH69GIwm8BjecrPN",han:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.IrVgSeMcAM8rAh2B",hea:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.nHbYSOoe1SzqEO9w",int:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.KNn8uxHu23phKC0y",kar:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kdu:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",ken:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kge:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",khi:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",klo:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kna:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kno:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kpl:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kre:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt",kte:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ki0QvL0K7u4YuK0O",lin:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.SqLm3Deag2FpP8ty",nav:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.qtwTUimJjHnSjLkp",per:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.2h6hz5AkTDxKPFxr",prf:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.emzBKDFNkNnC7N8u",pil:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.rVqzliJeSlYj7ewt",pro:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.224EaK0K72NhCeRi",rep:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DWB0xZqtaxOwfd2S",rid:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xQbTtefpEfEaOYo7",sen:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ka0VQGItdrWw3paO",slt:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.joza8kAIiImrPft7",spl:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.VRD7jxiIAxKPt6EF",ste:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.wRWHk7tCUHR99PzD",sur:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.pLdYavy4nssLEoGV",swm:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xhmDhOXuBbfVcD0Q",umd:"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.A8j7nF6qHwuGEC2E"},skills:{acr:"FFD20.SkillAcr",apr:"FFD20.SkillApr",blf:"FFD20.SkillBlf",clm:"FFD20.SkillClm",crf:"FFD20.SkillCrf",dip:"FFD20.SkillDip",dev:"FFD20.SkillDev",dis:"FFD20.SkillDis",dri:"FFD20.SkillDri",esc:"FFD20.SkillEsc",fly:"FFD20.SkillFly",han:"FFD20.SkillHan",hea:"FFD20.SkillHea",int:"FFD20.SkillInt",kar:"FFD20.SkillKAr",kdu:"FFD20.SkillKDu",ken:"FFD20.SkillKEn",kge:"FFD20.SkillKGe",khi:"FFD20.SkillKHi",klo:"FFD20.SkillKLo",kna:"FFD20.SkillKNa",kno:"FFD20.SkillKNo",kpl:"FFD20.SkillKPl",kre:"FFD20.SkillKRe",kte:"FFD20.SkillKTe",lin:"FFD20.SkillLin",nav:"FFD20.SkillNav",per:"FFD20.SkillPer",prf:"FFD20.SkillPrf",pil:"FFD20.SkillPil",pro:"FFD20.SkillPro",rep:"FFD20.SkillRep",rid:"FFD20.SkillRid",sen:"FFD20.SkillSen",slt:"FFD20.SkillSlt",spl:"FFD20.SkillSpl",ste:"FFD20.SkillSte",sur:"FFD20.SkillSur",swm:"FFD20.SkillSwm",umd:"FFD20.SkillUMD"},speedReduction:{5:5,15:10,20:15,30:20,35:25,45:30,50:35,60:40,65:45,75:50,80:55,90:60,95:65,105:70,110:75,120:80},spellComponents:{V:"FFD20.SpellComponentVerbal",S:"FFD20.SpellComponentSomatic",T:"FFD20.SpellComponentThought",E:"FFD20.SpellComponentEmotion",M:"FFD20.SpellComponentMaterial",F:"FFD20.SpellComponentFocus",DF:"FFD20.SpellComponentDivineFocus"},spellLevels:{0:"FFD20.SpellLevel0",1:"FFD20.SpellLevel1",2:"FFD20.SpellLevel2",3:"FFD20.SpellLevel3",4:"FFD20.SpellLevel4",5:"FFD20.SpellLevel5",6:"FFD20.SpellLevel6",7:"FFD20.SpellLevel7",8:"FFD20.SpellLevel8",9:"FFD20.SpellLevel9"},spellPreparationModes:{atwill:"FFD20.SpellPrepAtWill",prepared:"FFD20.SpellPrepPrepared",spontaneous:"FFD20.SpellPrepSpontaneous"},spellRangeFormulas:{close:"25 + floor(@cl / 2) * 5",medium:"100 + @cl * 10",long:"400 + @cl * 40"},spellSchools:{crn:"FFD20.SpellSchoolChronomancy",drk:"FFD20.SpellSchoolDark",div:"FFD20.SpellSchoolDivination",ele:"FFD20.SpellSchoolElemental",enc:"FFD20.SpellSchoolEnhancing",enf:"FFD20.SpellSchoolEnfeebling",heal:"FFD20.SpellSchoolHealing",ill:"FFD20.SpellSchoolIllusion",lit:"FFD20.SpellSchoolLight",multi:"FFD20.multiSchool",misc:"FFD20.SpellSchoolMisc",nec:"FFD20.SpellSchoolNecromancy",nel:"FFD20.SpellSchoolNonElemental",sum:"FFD20.SpellSchoolSummoning",uni:"FFD20.SpellSchoolUniversal"},spellcasting:{type:{spontaneous:"FFD20.SpellPrepSpontaneous",prepared:"FFD20.SpellPrepPrepared",hybrid:"FFD20.Arcanist"},spells:{astrologian:"Astrologian",blackmage:"Black Mage",bluemage:"Blue Mage",geomancer:"Geomancer",illusionist:"Illusionist",necromancer:"Necromancer",summoner:"Summoner",timemage:"Time Mage",whitemage:"White Mage",bard:"Bard",cleric:"Cleric",redmage:"Red Mage",scholar:"Scholar",darkknight:"Dark Knight",holyknight:"Holy Knight"}},stackingBonusModifiers:["untyped","untypedPerm","dodge","racial","penalty"],targetTypes:{none:"FFD20.None",self:"FFD20.TargetSelf",creature:"FFD20.TargetCreature",ally:"FFD20.TargetAlly",enemy:"FFD20.TargetEnemy",object:"FFD20.TargetObject",space:"FFD20.TargetSpace",radius:"FFD20.TargetRadius",sphere:"FFD20.TargetSphere",cylinder:"FFD20.TargetCylinder",cone:"FFD20.TargetCone",square:"FFD20.TargetSquare",cube:"FFD20.TargetCube",line:"FFD20.TargetLine",wall:"FFD20.TargetWall"},temporaryRollDataFields:{actor:["d20","attackBonus","attackCount","formulaicAttack","damageBonus","pointBlankBonus","rapidShotPenalty","powerAttackBonus","powerAttackPenalty","conditionals","concentrationBonus","formulaBonus","dcBonus","chargeCostBonus","chargeCost","sizeBonus","bonus","critMult","ablMult","ablDamage","cl","sl","classLevel","ablMod","item","action","level","mod"]},timePeriods:{inst:"FFD20.TimeInst",turn:"FFD20.TimeTurn",round:"FFD20.TimeRound",minute:"FFD20.TimeMinute",hour:"FFD20.TimeHour",day:"FFD20.TimeDay",month:"FFD20.TimeMonth",year:"FFD20.TimeYear",perm:"FFD20.TimePerm",seeText:"FFD20.SeeText",spec:"FFD20.Special"},timePeriodsShort:{turn:"FFD20.TimeTurnShort",round:"FFD20.TimeRoundShort",minute:"FFD20.TimeMinuteShort",hour:"FFD20.TimeHourShort"},tokenSizes:X,traitTypes:{combat:"FFD20.Trait.Combat",magic:"FFD20.Trait.Magic",faith:"FFD20.Trait.Faith",social:"FFD20.Trait.Social",campaign:"FFD20.Trait.Campaign",cosmic:"FFD20.Trait.Cosmic",equipment:"FFD20.Trait.Equipment",exemplar:"FFD20.Trait.Exemplar",faction:"FFD20.Trait.Faction",family:"FFD20.Trait.Family",mount:"FFD20.Trait.Mount",race:"FFD20.Trait.Race",region:"FFD20.Trait.Region",religion:"FFD20.Trait.Religion",drawback:"FFD20.Trait.Drawback"},weaponGroups:{axes:"FFD20.WeaponGroupAxes",bladesHeavy:"FFD20.WeaponGroupBladesHeavy",bladesLight:"FFD20.WeaponGroupBladesLight",bows:"FFD20.WeaponGroupBows",close:"FFD20.WeaponGroupClose",crossbows:"FFD20.WeaponGroupCrossbows",double:"FFD20.WeaponGroupDouble",firearms:"FFD20.WeaponGroupFirearms",flails:"FFD20.WeaponGroupFlails",hammers:"FFD20.WeaponGroupHammers",monk:"FFD20.WeaponGroupMonk",natural:"FFD20.WeaponGroupNatural",polearms:"FFD20.WeaponGroupPolearms",siegeEngines:"FFD20.WeaponGroupSiegeEngines",spears:"FFD20.WeaponGroupSpears",thrown:"FFD20.WeaponGroupThrown",tribal:"FFD20.WeaponGroupTribal"},weaponHoldTypes:{normal:"FFD20.WeaponHoldTypeNormal","2h":"FFD20.WeaponHoldTypeTwoHanded",oh:"FFD20.WeaponHoldTypeOffhand"},weaponProficiencies:{sim:"FFD20.WeaponProfSimple",mar:"FFD20.WeaponProfMartial",exo:"FFD20.WeaponProfExotic",che:"FFD20.WeaponProfChef",pow:"FFD20.WeaponProfPower"},weaponProperties:{ato:"FFD20.WeaponPropAutomatic",blc:"FFD20.WeaponPropBlocking",brc:"FFD20.WeaponPropBrace",dea:"FFD20.WeaponPropDeadly",dst:"FFD20.WeaponPropDistracting",dbl:"FFD20.WeaponPropDouble",dis:"FFD20.WeaponPropDisarm",fin:"FFD20.WeaponPropFinesse",frg:"FFD20.WeaponPropFragile",grp:"FFD20.WeaponPropGrapple",imp:"FFD20.WeaponPropImprovised",mnk:"FFD20.WeaponPropMonk",nnl:"FFD20.WeaponPropNonLethal",prf:"FFD20.WeaponPropPerformance",rch:"FFD20.WeaponPropReach",sct:"FFD20.WeaponPropScatter",snd:"FFD20.WeaponPropSunder",spc:"FFD20.WeaponPropSpecial",thr:"FFD20.WeaponPropThrown",trp:"FFD20.WeaponPropTrip"},weaponTypes:{simple:{_label:"FFD20.WeaponTypeSimple",light:"FFD20.WeaponPropLight","1h":"FFD20.WeaponPropOneHanded","2h":"FFD20.WeaponPropTwoHanded",ranged:"FFD20.WeaponSubtypeRanged"},martial:{_label:"FFD20.WeaponTypeMartial",light:"FFD20.WeaponPropLight","1h":"FFD20.WeaponPropOneHanded","2h":"FFD20.WeaponPropTwoHanded",ranged:"FFD20.WeaponSubtypeRanged"},exotic:{_label:"FFD20.WeaponTypeExotic",light:"FFD20.WeaponPropLight","1h":"FFD20.WeaponPropOneHanded","2h":"FFD20.WeaponPropTwoHanded",ranged:"FFD20.WeaponSubtypeRanged"},chef:{_label:"FFD20.WeaponTypeChef",light:"FFD20.WeaponPropLight","1h":"FFD20.WeaponPropOneHanded","2h":"FFD20.WeaponPropTwoHanded",ranged:"FFD20.WeaponSubtypeRanged"},power:{_label:"FFD20.WeaponTypePower",light:"FFD20.WeaponPropLight","1h":"FFD20.WeaponPropOneHanded","2h":"FFD20.WeaponPropTwoHanded",ranged:"FFD20.WeaponSubtypeRanged"},misc:{_label:"FFD20.Misc",splash:"FFD20.WeaponTypeSplash",other:"FFD20.Other"}},woundThresholdChangeTargets:["~attackCore","cmd","allSavingThrows","ac","~skillMods","allChecks"],woundThresholdConditions:{0:"FFD20.WoundLevelHealthy",1:"FFD20.WoundLevelGrazed",2:"FFD20.WoundLevelWounded",3:"FFD20.WoundLevelCritical"}},Symbol.toStringTag,{value:"Module"}));class BaseFilter{static label="";static indexField="";static type="";static types=[];static TEMPLATE="";id;choices=null;compendiumBrowser=null;constructor(e){this.compendiumBrowser=e,Object.defineProperty(this,"id",{value:foundry.utils.randomID(),writable:!1,configurable:!1}),this.registerIndexFields()}static get handledTypes(){return new Set([this.type,...this.types].filter((e=>e)))}get active(){return this.choices?.some((e=>e.active))??!1}get activeChoiceCount(){return this.choices?.filter((e=>e.active)).length??0}registerIndexFields(){if(!this.compendiumBrowser)return;const e=this.compendiumBrowser.constructor.documentName;if(this.constructor.indexField.startsWith("__"))return;const t=CONFIG[e]?.compendiumIndexFields;t&&this.constructor.indexField&&!t.includes(this.constructor.indexField)&&t?.push(this.constructor.indexField)}setup(){this.prepareChoices()}prepareChoices(){this.choices=new foundry.utils.Collection}hasChoices(e=1){return this.choices?.size>e}reset(){}applyFilter(e){}getData(){return{id:this.id,template:this.constructor.TEMPLATE,label:game.i18n.localize(this.constructor.label),active:this.active,activeCount:this.activeChoiceCount,choices:this.choices?.contents??[],field:this.constructor.indexField}}activateListeners(e){}}var te,se,ae,ie={exports:{}};se=c,ae=e=>{var highlightCallback=(e,t)=>{if(e===b)return b;var s=e.target,n=s.length,l=e._indexes;l=l.slice(0,l.len).sort(((e,t)=>e-t));for(var c="",u=0,d=0,m=!1,h=(e=[],0);h<n;++h){var g=s[h];if(l[d]===h){if(++d,m||(m=!0,e.push(c),c=""),d===l.length){c+=g,e.push(t(c,u++)),c="",e.push(s.substr(h+1));break}}else m&&(m=!1,e.push(t(c,u++)),c="");c+=g}return e},prepare=e=>{"string"!=typeof e&&(e="");var t=prepareLowerInfo(e);return{target:e,_targetLower:t._lower,_targetLowerCodes:t.lowerCodes,_nextBeginningIndexes:b,_bitflags:t.bitflags,score:b,_indexes:[0],obj:b}},prepareSearch=e=>{"string"!=typeof e&&(e=""),e=e.trim();var t=prepareLowerInfo(e),s=[];if(t.containsSpace){var n=e.split(/\s+/);n=[...new Set(n)];for(var l=0;l<n.length;l++)if(""!==n[l]){var c=prepareLowerInfo(n[l]);s.push({lowerCodes:c.lowerCodes,_lower:n[l].toLowerCase(),containsSpace:!1})}}return{lowerCodes:t.lowerCodes,bitflags:t.bitflags,containsSpace:t.containsSpace,_lower:t._lower,spaceSearches:s}},getPrepared=e=>{if(e.length>999)return prepare(e);var s=t.get(e);return void 0!==s||(s=prepare(e),t.set(e,s)),s},getPreparedSearch=e=>{if(e.length>999)return prepareSearch(e);var t=s.get(e);return void 0!==t||(t=prepareSearch(e),s.set(e,t)),t},all=(e,t,s)=>{var n=[];n.total=t.length;var l=s&&s.limit||c;if(s&&s.key)for(var d=0;d<t.length;d++){var m=t[d];if(F=getValue(m,s.key)){isObj(F)||(F=getPrepared(F)),F.score=u,F._indexes.len=0;var h=F;if(h={target:h.target,_targetLower:"",_targetLowerCodes:b,_nextBeginningIndexes:b,_bitflags:0,score:F.score,_indexes:b,obj:m},n.push(h),n.length>=l)return n}}else if(s&&s.keys)for(d=0;d<t.length;d++){m=t[d];for(var g=Array(s.keys.length),y=s.keys.length-1;y>=0;--y)(F=getValue(m,s.keys[y]))?(isObj(F)||(F=getPrepared(F)),F.score=u,F._indexes.len=0,g[y]=F):g[y]=b;if(g.obj=m,g.score=u,n.push(g),n.length>=l)return n}else for(d=0;d<t.length;d++){var F;if((F=t[d])&&(isObj(F)||(F=getPrepared(F)),F.score=u,F._indexes.len=0,n.push(F),n.length>=l))return n}return n},algorithm=(e,t,s=!1)=>{if(!1===s&&e.containsSpace)return algorithmSpaces(e,t);for(var c=e._lower,u=e.lowerCodes,d=u[0],m=t._targetLowerCodes,h=u.length,g=m.length,y=0,F=0,k=0;;){if(d===m[F]){if(n[k++]=F,++y===h)break;d=u[y]}if(++F>=g)return b}y=0;var v=!1,D=0,C=t._nextBeginningIndexes;C===b&&(C=t._nextBeginningIndexes=prepareNextBeginningIndexes(t.target));var S=0;if((F=0===n[0]?0:C[n[0]-1])!==g)for(;;)if(F>=g){if(y<=0)break;if(++S>200)break;--y,F=C[l[--D]]}else if(u[y]===m[F]){if(l[D++]=F,++y===h){v=!0;break}++F}else F=C[F];var T=t._targetLower.indexOf(c,n[0]),_=~T;if(_&&!v)for(var w=0;w<k;++w)n[w]=T+w;var A=!1;if(_&&(A=t._nextBeginningIndexes[T-1]===T),v)var x=l,I=D;else x=n,I=k;var P=0,E=0;for(w=1;w<h;++w)x[w]-x[w-1]!=1&&(P-=x[w],++E);if(P-=(x[h-1]-x[0]-(h-1)+12)*E,0!==x[0]&&(P-=x[0]*x[0]*.2),v){var M=1;for(w=C[0];w<g;w=C[w])++M;M>24&&(P*=10*(M-24))}else P*=1e3;for(_&&(P/=1+h*h*1),A&&(P/=1+h*h*1),P-=g-h,t.score=P,w=0;w<I;++w)t._indexes[w]=x[w];return t._indexes.len=I,t},algorithmSpaces=(e,t)=>{for(var s=new Set,n=0,l=b,c=0,u=e.spaceSearches,d=0;d<u.length;++d){var m=u[d];if((l=algorithm(m,t))===b)return b;n+=l.score,l._indexes[0]<c&&(n-=c-l._indexes[0]),c=l._indexes[0];for(var h=0;h<l._indexes.len;++h)s.add(l._indexes[h])}var g=algorithm(e,t,!0);if(g!==b&&g.score>n)return g;l.score=n,d=0;for(let e of s)l._indexes[d++]=e;return l._indexes.len=d,l},prepareLowerInfo=e=>{for(var t=e.length,s=e.toLowerCase(),n=[],l=0,c=!1,u=0;u<t;++u){var d=n[u]=s.charCodeAt(u);32!==d?l|=1<<(d>=97&&d<=122?d-97:d>=48&&d<=57?26:d<=127?30:31):c=!0}return{lowerCodes:n,bitflags:l,containsSpace:c,_lower:s}},prepareNextBeginningIndexes=e=>{for(var t=e.length,s=(e=>{for(var t=e.length,s=[],n=0,l=!1,c=!1,u=0;u<t;++u){var d=e.charCodeAt(u),m=d>=65&&d<=90,h=m||d>=97&&d<=122||d>=48&&d<=57,g=m&&!l||!c||!h;l=m,c=h,g&&(s[n++]=u)}return s})(e),n=[],l=s[0],c=0,u=0;u<t;++u)l>u?n[u]=l:(l=s[++c],n[u]=void 0===l?t:l);return n},t=new Map,s=new Map,n=[],l=[],defaultScoreFn=e=>{for(var t=u,s=e.length,n=0;n<s;++n){var l=e[n];if(l!==b){var c=l.score;c>t&&(t=c)}}return t===u?b:t},getValue=(e,t)=>{var s=e[t];if(void 0!==s)return s;var n=t;Array.isArray(t)||(n=t.split("."));for(var l=n.length,c=-1;e&&++c<l;)e=e[n[c]];return e},isObj=e=>"object"==typeof e,c=1/0,u=-c,d=[];d.total=0;var m,h,g,y,b=null,F=(m=[],h=0,y=e=>{for(var t=0,s=m[t],n=1;n<h;){var l=n+1;t=n,l<h&&m[l].score<m[n].score&&(t=l),m[t-1>>1]=m[t],n=1+(t<<1)}for(var c=t-1>>1;t>0&&s.score<m[c].score;c=(t=c)-1>>1)m[t]=m[c];m[t]=s},(g={}).add=e=>{var t=h;m[h++]=e;for(var s=t-1>>1;t>0&&e.score<m[s].score;s=(t=s)-1>>1)m[t]=m[s];m[t]=e},g.poll=e=>{if(0!==h){var t=m[0];return m[0]=m[--h],y(),t}},g.peek=e=>{if(0!==h)return m[0]},g.replaceTop=e=>{m[0]=e,y()},g);return{single:(e,t)=>{if("farzher"==e)return{target:"farzher was here (^-^*)/",score:0,_indexes:[0]};if(!e||!t)return b;var s=getPreparedSearch(e);isObj(t)||(t=getPrepared(t));var n=s.bitflags;return(n&t._bitflags)!==n?b:algorithm(s,t)},go:(e,t,s)=>{if("farzher"==e)return[{target:"farzher was here (^-^*)/",score:0,_indexes:[0],obj:t?t[0]:b}];if(!e)return s&&s.all?all(e,t,s):d;var n=getPreparedSearch(e),l=n.bitflags;n.containsSpace;var m=s&&s.threshold||u,h=s&&s.limit||c,g=0,y=0,k=t.length;if(s&&s.key)for(var v=s.key,D=0;D<k;++D){var C=t[D];(I=getValue(C,v))&&(isObj(I)||(I=getPrepared(I)),(l&I._bitflags)===l&&(P=algorithm(n,I))!==b&&(P.score<m||(P={target:P.target,_targetLower:"",_targetLowerCodes:b,_nextBeginningIndexes:b,_bitflags:0,score:P.score,_indexes:P._indexes,obj:C},g<h?(F.add(P),++g):(++y,P.score>F.peek().score&&F.replaceTop(P)))))}else if(s&&s.keys){var S=s.scoreFn||defaultScoreFn,T=s.keys,_=T.length;for(D=0;D<k;++D){C=t[D];for(var w=Array(_),A=0;A<_;++A)v=T[A],(I=getValue(C,v))?(isObj(I)||(I=getPrepared(I)),(l&I._bitflags)!==l?w[A]=b:w[A]=algorithm(n,I)):w[A]=b;w.obj=C;var x=S(w);x!==b&&(x<m||(w.score=x,g<h?(F.add(w),++g):(++y,x>F.peek().score&&F.replaceTop(w))))}}else for(D=0;D<k;++D){var I,P;(I=t[D])&&(isObj(I)||(I=getPrepared(I)),(l&I._bitflags)===l&&(P=algorithm(n,I))!==b&&(P.score<m||(g<h?(F.add(P),++g):(++y,P.score>F.peek().score&&F.replaceTop(P)))))}if(0===g)return d;var E=Array(g);for(D=g-1;D>=0;--D)E[D]=F.poll();return E.total=g+y,E},highlight:(e,t,s)=>{if("function"==typeof t)return highlightCallback(e,t);if(e===b)return b;void 0===t&&(t="<b>"),void 0===s&&(s="</b>");var n="",l=0,c=!1,u=e.target,d=u.length,m=e._indexes;m=m.slice(0,m.len).sort(((e,t)=>e-t));for(var h=0;h<d;++h){var g=u[h];if(m[l]===h){if(c||(c=!0,n+=t),++l===m.length){n+=g+s+u.substr(h+1);break}}else c&&(c=!1,n+=s);n+=g}return n},prepare,indexes:e=>e._indexes.slice(0,e._indexes.len).sort(((e,t)=>e-t)),cleanup:()=>{t.clear(),s.clear(),n=[],l=[]}}},(te=ie).exports?te.exports=ae():se.fuzzysort=ae();const ne=getDefaultExportFromCjs(ie.exports);class CompendiumBrowser extends Application{static documentName="Item";static typeName;static filterClasses=[];static ENTRY_TEMPLATE="systems/ffd20/templates/apps/compendium-browser/entries.hbs";static#e=new Map;filters=new foundry.utils.Collection;handledTypes=new Set;packs=[];expandedFilters=new Set;entries;_query="";_loadingInfo=null;#t=!1;constructor(e={}){super(e),Object.defineProperty(this,"entries",{value:new Collection}),this.initialize(),this._debouncedRender=foundry.utils.debounce(this.render,300)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"systems/ffd20/templates/apps/compendium-browser/compendium-browser.hbs",classes:["ffd20","app"],id:"ffd20-compendium-browser-"+this.name,width:800,height:window.innerHeight-60,top:30,left:40,resizable:!0,scrollY:[".filter-container"],dragDrop:[{dragSelector:".directory-item",dropSelector:null}]})}static initializeBrowsers(){const e=ffd20.applications.compendiums,t=ffd20.applications.compendiumBrowser;e.items=new t.ItemBrowser,e.feats=new t.FeatBrowser,e.spells=new t.SpellBrowser,e.classes=new t.ClassBrowser,e.races=new t.RaceBrowser,e.bestiary=new t.CreatureBrowser,e.buffs=new t.BuffBrowser}static getIndexes(e=[]){const t=e.map((e=>game.packs.get(e))),s=[];for(const e of t)this.#e.has(e.collection)||this.#e.set(e.collection,e.getIndex()),s.push(this.#e.get(e.collection));return Promise.all(s).finally((()=>{for(const e of t)this.#e.delete(e.collection)}))}static _mapEntry(e,t){const s=foundry.utils.deepClone(e);return s.system=mergeObject(game.model[this.documentName][e.type],s.system,{inplace:!1}),s.__pack=t.collection,s.__packLabel=t.metadata.label,s.__uuid=`Compendium.${t.collection}.${e._id}`,s.__name=ne.prepare(e.name.normalize("NFKD")),s}static async _renderEntries(e){return renderTemplate(this.ENTRY_TEMPLATE,{entries:e})}get title(){return game.i18n.format("FFD20.CompendiumBrowserTitle",{type:game.i18n.localize(this.constructor.typeName)})}initialize(){this.filters?.clear();for(const e of this.constructor.filterClasses){if(!(e.prototype instanceof BaseFilter))throw Error(`Filter class ${e.name} does not extend BaseFilter`);const t=new e(this);this.filters.set(t.id,t),e.handledTypes.forEach((e=>this.handledTypes.add(e)))}this.packs=game.packs.filter((e=>this.isPackIncluded(e))),this._loadingInfo={indexCount:this.packs.length,entryCount:this.packs.reduce(((e,t)=>e+t.index.contents.filter((e=>this.handledTypes.has(e.type))).length),0)}}isPackIncluded(e){return!e.config.ffd20?.disabled&&(e.documentName===this.constructor.documentName&&(e.metadata.system===game.system.id&&(!(e.private&&!game.user.isGM)&&0!==e.index.contents.filter((e=>this.handledTypes.has(e.type))).length)))}async setup(){this.#t=!1,this.entries?.clear(),await CompendiumBrowser.getIndexes(this.packs.map((e=>e.collection)));const e=await Promise.all(this.packs.map((e=>this.loadPackIndex(e))));naturalSort(e.flat(),"name").forEach((e=>this.entries.set(""+e.__uuid,e))),this.filters.forEach((e=>e.setup())),this.#t=!0}async loadPackIndex(e){!1===e.indexed&&await CompendiumBrowser.getIndexes(e.collection);return e.index.filter((e=>this.handledTypes.has(e.type))).map((t=>{try{return this.constructor._mapEntry(t,e)}catch(s){return Hooks.onError("CompendiumBrowser#_mapEntry",s,{msg:`${this.constructor.name} failed to map entry ${t.name} [${t._id}] from pack ${e.collection}`,log:"error",entry:t,pack:e}),null}})).filter((e=>null!==e))}getFilteredEntries(){let e=this.entries.contents;const t=this.filters.filter((e=>e.active));return t.length&&(e=e.filter((e=>t.every((t=>t.applyFilter(e)))))),this._query&&(e=ne.go(this._query.normalize("NFKD"),e,{key:"__name",threshold:-1e4}).map((e=>e.obj))),e}async _render(e,t){const s=this.element?.[0]?.querySelector(":focus"),n=s?.selectionStart;if(await super._render(e,t),s&&s.name){const e=this._element[0].querySelector(`[name="${s.name}"]`);e&&e.focus instanceof Function&&(e.focus(),n&&(e.selectionStart=e.selectionEnd=n))}}async getData(...e){const t=await super.getData(...e);return t.id=e[0]?.id,t.query=this._query??"",t.filters=this.filters.filter((e=>e.hasChoices())).map((e=>({...e.getData(),collapsed:this.expandedFilters.has(e.id)?"":"collapsed"}))),this.#t?(this._entries=this.getFilteredEntries(),t.entries=this._entries.slice(0,100),t.itemCount=this.entries.size,t.filteredItemCount=this._entries.length):(t.loading=!0,t.loadingInfo=this._loadingInfo),t}activateListeners(e){super.activateListeners(e);const t=e[0];this.#t?(this._initLazyScrolling(t),t.querySelectorAll(".filter-content").forEach((e=>{this.filters.get(e.closest(".filter").dataset.filterId).activateListeners(e)})),t.querySelector(".directory-list").addEventListener("click",(e=>{this._onClickEntry(e)})),t.querySelector("button.refresh").addEventListener("click",(e=>{this._onRefresh(e)})),t.querySelector("button.reset").addEventListener("click",(e=>{this._onResetFilters(e)})),t.querySelectorAll(".filter>h3").forEach((e=>{e.addEventListener("click",(e=>{this._onFilterHeaderClick(e)}))})),t.querySelector("input[name=filter]")?.addEventListener("input",(e=>{this._onCustomSearchFilter(e)})),ContextMenu.create(this,e,".directory-item",this._getEntryContextOptions())):this.setup().then((()=>this.render()))}_onCustomSearchFilter(e){e.preventDefault(),this._query=e.target.value,this._debouncedRender()}async _onClickEntry(e){const t=e.target.closest(".directory-item");if(!t)return;const{uuid:s}=t.dataset,n=await fromUuid(s),l=game.packs.get(n.pack);return n.sheet.render(!0,{editable:game.user.isGM&&!l.locked,focus:!0})}_getEntryContextOptions(){return[{name:"COMPENDIUM.ImportEntry",icon:'<i class="fas fa-download"></i>',condition:()=>getDocumentClass(this.constructor.documentName).canUserCreate(game.user),callback:async e=>{const t=game.collections.get(this.constructor.documentName),s=e.data("uuid"),n=this.entries.get(s);return t.importFromCompendium(game.packs.get(n.__pack),n._id,{},{renderSheet:!0})}},{name:"FFD20.CopyUuidToClipboard",icon:'<i class="fas fa-id-badge"></i>',callback:e=>{const t=e.data("uuid");game.clipboard.copyPlainText(t);const s=game.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label);ui.notifications.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:s,type:"uuid",id:t}))}}]}_canDragStart(e){return!0}_onDragStart(e){const{uuid:t}=e.currentTarget.dataset;e.dataTransfer.setData("text/plain",JSON.stringify({type:this.constructor.documentName,uuid:t}))}_onResetFilters(e){for(const e of this.filters)e.reset();this._query="",this.expandedFilters.clear(),this.render()}async _onRefresh(e){this.#t=!1,this.initialize(),this.render()}_onFilterHeaderClick(e){const{filterId:t}=e.target.closest(".filter").dataset,s=e.target.closest(".filter").querySelector(".filter-content");this.expandedFilters.has(t)?(this.expandedFilters.delete(t),s.classList.add("collapsed")):(this.expandedFilters.add(t),s.classList.remove("collapsed"))}_initLazyScrolling(e){const t=e.querySelector(".directory-bottom");t&&new IntersectionObserver((async([s],n)=>{if(s.isIntersecting){const s=e.querySelectorAll(".directory-item").length,l=this._entries.slice(s,s+50);if(0===l.length)n.unobserve(t);else{const e=await this.constructor._renderEntries(l);t.insertAdjacentHTML("beforebegin",e)}}}),{root:e.querySelector(".directory-list"),rootMargin:"300px"}).observe(t)}}class ActorTraitSelector extends DocumentSheet{constructor(e,t){super(e,t),this.options.classes.push(t.subject)}get title(){return`${this.options.title} – ${this.object.name}`}get id(){return`trait-selector-${this.document.uuid}-${this.options.subject}`}static get defaultOptions(){return{...super.defaultOptions,classes:["ffd20","trait-selector"],template:"systems/ffd20/templates/apps/trait-selector.hbs",width:320,height:"auto",sheetConfig:!1}}get attribute(){return this.options.name}getData(){const e=getProperty(this.object,this.attribute)??{value:[],custom:""},t=duplicate(this.options.choices);for(const[s,n]of Object.entries(t))t[s]={label:n,chosen:e.value?.includes(s)};const s=this.object instanceof Actor?"FFD20.UpdateActor":"FFD20.UpdateItem";return{choices:t,custom:e.custom,updateButton:s}}_updateObject(e,t){const s=[];for(const[e,n]of Object.entries(t))"custom"!==e&&n&&s.push(e);this.object.update({[this.attribute+".value"]:s,[this.attribute+".custom"]:t.custom})}}const oe=foundry.data.fields;class Registry extends foundry.utils.Collection{static model=null;static _defaultData=[];model=null;constructor(){super(),Object.defineProperty(this,"model",{value:this.constructor.model,writable:!1,enumerable:!1}),this._initialize()}get name(){return this.constructor.name}_initialize(){this.clear();for(const e of this.constructor._defaultData)try{const t=new this.model({...e,namespace:"ffd20"});super.set(t.id,t)}catch(e){console.error(e)}Hooks.callAll("pf1Register"+this.name,this)}setup(){for(const e of this)e.prepareData()}set(e,t){const s=this.model;if(!(t instanceof s))throw Error(`Registry '${this.name}' can only register ${s.name}`);return super.set(e,t)}register(e,t,s){if(!e||!t)throw Error("Registering requires both a namespace and an ID");if(this.has(t))throw Error(`Registry '${this.name}' already has a key '${t}'`);return this.set(t,new this.model({...s,namespace:e,_id:t}))}unregister(e,t){if(!e|!t)throw Error("Unregistering requires both a namespace and an ID");if(t){const s=this.get(t);if(!s||s.namespace!==e)throw Error(`Registry '${this.name}' has no key '${t}'`);this.delete(t)}else for(const t of this)t.namespace===e&&this.delete(t.id)}toObject(e=!1){return Object.fromEntries(this.map((t=>[t.id,t.toObject(e)])))}getLabels(){return Object.fromEntries(this.map((e=>[e.id,e.name])))}}class RegistryEntry extends foundry.abstract.DataModel{static defineSchema(){return{_id:new oe.StringField({required:!0,blank:!1,readonly:!0}),name:new oe.StringField({required:!1,initial:"",localize:!0}),flags:new oe.ObjectField({required:!1,initial:{}}),namespace:new oe.StringField({required:!0,blank:!1})}}get id(){return this._id}prepareData(){this.reset();for(const[e,t]of Object.entries(this.constructor.schema.fields))t instanceof oe.StringField&&!0===t.options.localize&&(this[e]=game.i18n.localize(this[e]))}}const re=foundry.data.fields;class DamageType extends RegistryEntry{static defineSchema(){return{...super.defineSchema(),icon:new re.StringField({required:!1,initial:""}),category:new re.StringField({required:!0,blank:!1,initial:"misc",choices:DamageTypes.CATEGORIES}),isModifier:new re.BooleanField({required:!1,initial:!1}),color:new re.StringField({required:!0,initial:"black"})}}}class DamageTypes extends Registry{static model=DamageType;static CATEGORIES=["physical","energy","misc"];static _defaultData=[{_id:"untyped",name:"FFD20.DamageTypeUntyped",icon:"ra ra-uncertainty",category:"misc"},{_id:"slashing",name:"FFD20.DamageTypeSlashing",icon:"ra ra-sword",color:"yellow",category:"physical"},{_id:"piercing",name:"FFD20.DamageTypePiercing",icon:"ra ra-spear-head",color:"blue",category:"physical"},{_id:"bludgeoning",name:"FFD20.DamageTypeBludgeoning",icon:"ra ra-large-hammer",color:"red",category:"physical"},{_id:"fire",name:"FFD20.DamageTypeFire",icon:"ra ra-fire",color:"orange",category:"energy"},{_id:"ice",name:"FFD20.DamageTypeIce",icon:"ra ra-frost-emblem",color:"aqua",category:"energy"},{_id:"wind",name:"FFD20.DamageTypeWind",icon:"ra ra-slash-ring",color:"#04e0ce",category:"energy"},{_id:"earth",name:"FFD20.DamageTypeEarth",icon:"ra ra-groundbreaker",color:"#664a02",category:"energy"},{_id:"lightning",name:"FFD20.DamageTypeLightning",icon:"ra ra-lightning-bolt",color:"yellow",category:"energy"},{_id:"water",name:"FFD20.DamageTypeWater",icon:"ra ra-droplet",color:"blue",category:"energy"},{_id:"light",name:"FFD20.DamageTypeLight",icon:"ra ra-sunbeams",color:"#defffc",category:"energy"},{_id:"dark",name:"FFD20.DamageTypeDark",icon:"ra ra-skull",color:"#765898",category:"energy"},{_id:"nonelemental",name:"FFD20.DamageTypeNonElemental",icon:"ra ra-doubled",color:"#a200ff",category:"energy"},{_id:"precision",name:"FFD20.Precision",icon:"ra ra-archery-target",isModifier:!0},{_id:"nonlethal",name:"FFD20.Nonlethal",icon:"ra ra-hand",isModifier:!0}]}class DamageTypeSelector extends FormApplication{constructor(e,t,s,n={}){super(e,n),this._dataPath=t,this._data=deepClone(s),this._data||(this._data=[])}static get defaultOptions(){return mergeObject(super.defaultOptions,{width:720,height:590,template:"systems/ffd20/templates/apps/damage-type-selector.hbs",closeOnSubmit:!0})}get title(){return game.i18n.localize("FFD20.DamageType")}get id(){return`action-${this.object.id}_${this._dataPath}`}get damageCategorySortOrder(){return["physical","energy","misc"]}async getData(e){const t=await super.getData(e),s=ffd20.registry.damageTypes;t.damageTypes=s.filter((e=>!e.isModifier)),t.damageCategories=t.damageTypes.reduce(((e,t)=>{let s=e.find((e=>e.key===t.category));return s||(s={key:t.category,label:"FFD20.DamageTypeCategory."+t.category,data:[]},e.push(s)),s.data.push(t),e}),[]);{const e=this.damageCategorySortOrder;t.damageCategories=t.damageCategories.sort(((t,s)=>{const n=e.indexOf(t.key),l=e.indexOf(s.key);return-1===n&&l>=0?1:-1===l&&n>=0?-1:n>l?1:n<l?-1:0}))}return t.damageModifiers=s.filter((e=>e.isModifier)),t.data=this._data,t}activateListeners(e){e.find(".damage-type").on("click",this._toggleDamageType.bind(this)),e.find("*[name]").on("change",this._onChangeData.bind(this))}_onChangeData(e){e.preventDefault();const t=e.currentTarget,s=t.name;let n=t.value;switch("checkbox"===t.type&&(n=t.checked),t.dataset.dtype){case"Boolean":n=!!n;break;case"Number":n=Number(n)}setProperty(this._data,s,n)}_toggleDamageType(e){e.preventDefault();const t=e.currentTarget.dataset.id;this._data.values.includes(t)?this._data.values.splice(this._data.values.indexOf(t),1):this._data.values.push(t),this.render()}async _updateObject(e,t){t=expandObject(t);const s=this._data;return this.object.update({[this._dataPath]:s})}}class ActorResistanceSelector extends FormApplication{constructor(...e){super(...e),this.isDR=!0===this.options.isDR;const t=deepClone(getProperty(this.object,this.attribute)??{});this.custom=t.custom,this.originalEntries=t.value,this.entries=t.value;const s=ffd20.registry.damageTypes.filter((e=>!e.isModifier)),n={};Object.values(s).sort().forEach((e=>{("energy"!==e.category&&"misc"!==e.category||!this.isDR)&&("physical"!==e.category&&("misc"!==e.category||"untyped"!==e._id)||this.isDR)&&(n[e._id]=e.name)})),this.damages=n,this.operators={true:"FFD20.Application.DamageResistanceSelector.CombinationOr",false:"FFD20.Application.DamageResistanceSelector.CombinationAnd"}}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"damage-resistance-selector",classes:["ffd20","resistance"],template:"systems/ffd20/templates/apps/damage-resistance-selector.hbs",width:450,height:"auto",closeOnSubmit:!0,submitOnClose:!1})}get title(){return game.i18n.localize("FFD20.Application.DamageResistanceSelector."+(this.isDR?"DR":"ER")+"Title")}get attribute(){return this.options.name}get fields(){return this.options.fields.split(";")}get dtypes(){return this.options.dtypes.split(";")}get dataCount(){return this.fields.length}getData(){return{custom:this.custom,damages:this.damages,operators:this.operators,entries:this.entries,fields:this.fields,dtypes:this.dtypes,isDR:this.isDR}}activateListeners(e){e.find(".resistance-control").click(this._onResistanceControl.bind(this)),e.find("tr td input").change(this._onResistanceChange.bind(this)),e.find("tr td select").change(this._onResistanceChange.bind(this)),e.find("input[name=custom]").change(this._onResistanceCustomChange.bind(this))}async _updateObject(e,t){const s={},n=this.entries.map((e=>(e.types[0]??="",e.types[1]??="",""===e.types[0]&&""!==e.types[1]&&(e.types[0]=e.types[1],e.types[1]=""),e.types[0]===e.types[1]&&(e.types[1]=""),e.operator="true"===(e.operator+"").toLowerCase(),e)));return s[this.attribute+".value"]=n,s[this.attribute+".custom"]=this.custom,this.object.update(s)}async _onResistanceControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-resistance")){const e={amount:0,types:[this.isDR?"":"fire",""],operator:!0};return this.entries.push(e),this.render()}if(t.classList.contains("delete-resistance")){const e=t.closest("tr"),s=parseInt(e.dataset.index);return this.entries.splice(s,1),this.render()}}async _onResistanceChange(e){const t=e.currentTarget,s=t.closest("tr.resistance"),n=parseInt(s.dataset.index),l=t.dataset.index,c=t.value;let u=null;if("Number"===t.dataset.dtype){let e=parseFloat(c);isNaN(e)&&(e=0),u=Math.floor(100*e)/100}else u="Boolean"===t.dataset.dtype?"true"===c:c;switch(l){case"types0":this.entries[n].types[0]=u;break;case"types1":this.entries[n].types[1]=u;break;default:this.entries[n][l]=u}}async _onResistanceCustomChange(e){const t=e.currentTarget;this.custom=t.value}}class ActorRestDialog extends DocumentSheet{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:["ffd20","actor-rest"],template:"systems/ffd20/templates/apps/actor-rest.hbs",width:500,closeOnSubmit:!0})}get title(){return`${game.i18n.localize("FFD20.Rest")}: ${this.object.name}`}async _updateObject(e,t){this.object.performRest({restoreHealth:t.restoreHealth,longTermCare:t.longTermCare,aidedcare:t.aidedCare,restoreDailyUses:t.restoreDailyUses,hours:t.hours})}}class PointBuyCalculator extends DocumentSheet{constructor(...e){super(...e);const t=this.actor.system.abilities;this.abilities=[];for(const[e,s]of Object.entries(ffd20.config.abilities))this.abilities.push({key:e,name:s,value:t[e]?.value??10});const s=Object.keys(ffd20.config.abilityCost).map((e=>Number(e)));this.min=Math.min(...s),this.max=Math.max(...s)}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","pointbuy-calculator"],template:"systems/ffd20/templates/apps/point-buy-calculator.hbs",width:320,height:"auto",closeOnSubmit:!1,submitOnClose:!1})}get title(){return`${game.i18n.localize("FFD20.PointBuyCalculator")}: ${this.object.name}`}get actor(){return this.document}getData(){const e=this.getSpentPoints(),t=ffd20.config.pointBuy,s=Object.entries(t).map((([e,t])=>({...t,key:e})));s.sort(((e,t)=>e.points-t.points));let n=s[0].key;for(const l of s){t[n].points<e&&(n=l.key)}return{abilities:this.abilities,points:e,limits:s,closest:n,invalidPoints:t[n].points!==e}}getSpentPoints(){let e=0;for(const t of this.abilities)e+=ffd20.config.abilityCost[t.value];return e}activateListeners(e){super.activateListeners(e),e.find(".control").click(this._onAbilityControl.bind(this))}_onAbilityControl(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".ability").dataset.ability,n=this.abilities.find((e=>e.key===s));t.classList.contains("add")?n.value=Math.min(this.max,n.value+1):t.classList.contains("subtract")&&(n.value=Math.max(this.min,n.value-1)),this.render()}_updateObject(){const e={};for(const t of this.abilities)e[`system.abilities.${t.key}.value`]=t.value;this.actor.update(e),this.close()}}class Widget_ItemPicker{constructor(e,{items:t,columns:s=3}={}){this.element=null,this.callback=e,this._items=t,this.columns=s}render(e){const t=$($.parseHTML('<div class="widget item-picker"></div>'));let s;for(let e=0;e<this._items.length;e++){const n=this._items[e];e%this.columns==0&&(s=$($.parseHTML('<div class="row"></div>')),t.append(s));const l=$($.parseHTML(`<div class="item" value="${n.value}">${n.label}</div>`)),c=Math.floor(1e4/this.columns)/100;l.css("flex",`0 0 calc(${c}% - 4px)`),s.append(l)}e instanceof jQuery||(e=$(e)),t.css("position","absolute"),t.css("left",e[0].offsetLeft+"px"),t.css("position",e[0].offsetBottom+"px"),e.parent().append(t),this.element=t,window.setTimeout((()=>{this.activateListeners(t)}),10)}activateListeners(e){e.find(".item").click(this._onClickItem.bind(this)),this._cancelCallback=this._onCancel.bind(this),document.addEventListener("click",this._cancelCallback)}_onCancel(e){e.preventDefault();let t=e.target;if(t!==this.element[0]){for(;t.parentNode;){if(t===this.element[0])return;t=t.parentNode}this.cancel()}}_onClickItem(e){e.preventDefault();const t=e.currentTarget;this.callback($(t).attr("value"))}cancel(){document.removeEventListener("click",this._cancelCallback),this.element.remove()}}const dialogGetActor=function(e="",t=[]){return new Promise((s=>{let n="";t.forEach((e=>{if(e instanceof Actor){const t=game.users.some((e=>e.active&&e.isGM))||e.testUserPermission(game.user,"OWNER");n+=`<div class="dialog-get-actor flexrow ${t?"":"disabled"}" data-actor-id="${e.id}"><img src="${e.img}"><h2>${e.name}</h2></div>`}else e instanceof Item&&(n+=`<div class="dialog-get-actor flexrow" data-item-id="${e.id}"><img src="${e.img}"><h2>${e.name}</h2></div>`)})),new Dialog({title:e,content:n,buttons:{},close:()=>{s(null)},render:function(e){e.find(".dialog-get-actor:not(.disabled)").click((e=>{const t=e.currentTarget,n=t.dataset.actorId;if(n)s({type:"actor",id:n});else{const e=t.dataset.itemId;e&&s({type:"item",id:e})}this.close()}))}},{classes:[...Dialog.defaultOptions.classes,"ffd20","get-actor"]}).render(!0)}))},le=Object.freeze(Object.defineProperty({__proto__:null,dialogGetActor,dialogGetNumber:function dialogGetNumber({title:e="Input Number",initial:t=null,min:s=-1/0,max:n=1/0}={}){return new Promise((l=>{let c=!0;new Dialog({title:e,content:`<input type="number" name="result" min="${s}" max="${n}" value="${t||0}">`,buttons:{ok:{label:"Submit",callback:e=>{c=!1;const t=e.find('input[name="result"]');l(t.val())}}},close:()=>{c||l(t)},default:"ok",render:e=>{e.find("input").select()}},{classes:[...Dialog.defaultOptions.classes,"ffd20","get-number"]}).render(!0)}))}},Symbol.toStringTag,{value:"Module"}));class LevelUpForm extends FormApplication{constructor(e,t={}){super(e,t),this.token=t.token,this._submitted=!1,this._section=0,this._sections=this._addSections(),this._sections.push(this._addSummarySection())}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","level-up"],template:"systems/ffd20/templates/apps/level-up.hbs",width:720,height:480,closeOnSubmit:!0})}get section(){return this._section}get currentSection(){return this._sections[this.section]}setSection(e){return this._section=e,this._render()}get title(){return game.i18n.format("FFD20.LevelUpForm_Title",{className:this.object.name})}get actor(){return this.object.actor}static async addClassWizard(e,t){setProperty(t,"system.hp",0),setProperty(t,"system.level",0);let s=await e.createEmbeddedDocuments("Item",[t]);s=s instanceof Array?s:[s];const n=e.items.get(s[0].id);if(!n)throw Error("No class was created at class initialization wizard");return new Promise((t=>{const s=new LevelUpForm(n).render(!0);Hooks.on("closeLevelUpForm",(function _onClose(l){l===s&&(0===n.system.level&&e.deleteEmbeddedDocuments("Item",[n.id]),Hooks.off("closeLevelUpForm",_onClose),t())}))}))}getData(){const e={};return e.data=this.object.toObject(),e.actor=this.actor.toObject(),e.config=ffd20.config,e.section=this.currentSection,e.sections=this._sections,e.summary=this.getSummaryData(),e.uuid=this.object.uuid,e}getSummaryData(){const e={};for(const t of this._sections){if("summary"===t.name)continue;const{summary:s}=this._parseSection(t);e[t.name]=s}return e}_addSections(){const e=[],t=game.settings.get("ffd20","healthConfig");!0!==("character"===this.actor.type?t.hitdice.PC:t.hitdice.NPC).auto&&e.push({name:"health",label:"FFD20.LevelUpForm_Health",choice:null,manualValue:Math.ceil(1+(this.object.system.hd-1)/2),items:[{img:"systems/ffd20/icons/items/inventory/dice.jpg",name:game.i18n.localize("FFD20.LevelUpForm_Health_Roll"),id:"roll",type:"html",target:"systems/ffd20/templates/apps/level-up/health_roll.hbs"},{img:"systems/ffd20/icons/skills/green_19.jpg",name:game.i18n.localize("FFD20.LevelUpForm_Health_Manual"),id:"manual",type:"html",target:"systems/ffd20/templates/apps/level-up/health_manual.hbs"}]}),this.isFavouredClass()&&e.push({name:"fc",label:"FFD20.LevelUp.FC.Label",choice:null,items:[{name:game.i18n.localize("FFD20.None"),id:"none"},{img:"systems/ffd20/icons/skills/green_19.jpg",name:game.i18n.localize("FFD20.FavouredClassBonus.HP"),id:"hp",type:"html",target:"systems/ffd20/templates/apps/level-up/fc_hp.hbs"},{img:"systems/ffd20/icons/items/inventory/dice.jpg",name:game.i18n.localize("FFD20.FavouredClassBonus.Skill"),id:"skill",type:"html",target:"systems/ffd20/templates/apps/level-up/fc_skill.hbs"},{img:"systems/ffd20/icons/skills/affliction_22.jpg",name:game.i18n.localize("FFD20.FavouredClassBonus.Alt"),id:"alt",type:"html",target:"systems/ffd20/templates/apps/level-up/fc_alt.hbs"}]});const s=this.actor.getRollData().attributes.hd.total+1,n=ffd20.config.levelAbilityScores[s];return"number"==typeof n&&n>0&&e.push({name:"ability",label:"FFD20.LevelUp.AbilityScore.Label",template:"systems/ffd20/templates/apps/level-up/ability-score.hbs",choice:null,abilities:Object.keys(ffd20.config.abilities).reduce(((e,t)=>(e[t]={value:this.actor.system.abilities[t].total,name:ffd20.config.abilities[t],added:0,isEnhanced:this.actor.system.abilities[t].total!==this.actor.system.abilities[t].base},e)),{}),value:n}),e}_addSummarySection(){return{name:"summary",label:"FFD20.LevelUp.Summary.Label",template:"systems/ffd20/templates/apps/level-up/summary.hbs"}}isFavouredClass(){return"base"===this.object.system.subType}async _updateObject(e,t){const s={},n={},l={config:ffd20.config},c=[],u=[];for(const e of this._sections){const t=this._parseSection(e);mergeObject(s,t.item),mergeObject(n,t.actor),mergeObject(l,t.chatData),u.push(...t.callbacks);for(const e of t.newItems){const t=c.find((t=>t._id===e._id));null!=t?mergeObject(t,e):c.push(e)}}l.level={previous:this.object.system.level,new:this.object.system.level+1},mergeObject(s,{"system.level":l.level.new});const d=this.object,m=new Promise((e=>{const t=Hooks.on("pf1ClassLevelChange",(function _waiter(s,n,l,c){n.id===d.id&&(Hooks.off("pf1ClassLevelChange",t),e())}))}));await d.update(s),await m,Object.keys(n).length&&await this.actor.update(n),c.length>0&&await this.actor.createEmbeddedDocuments("Item",c);for(const e of u)await e.call(this);{const e=getProperty(this.object,"flags.ffd20.links.classAssociations")||{},t=Object.entries(e).filter((e=>e[1]===l.level.new));l.newFeatures=[];for(const e of t){const t=this.actor.items.get(e[0]);t&&l.newFeatures.push(t.toObject())}}{const e={};l.extra=e;const t=this.actor.getFeatCount();t.new=Math.max(0,t.max-t.value),e.feats=t,t.new>0&&(e.enabled=!0,1===t.new?t.label=game.i18n.localize("FFD20.LevelUp.Chat.Extra.NewFeat"):t.label=game.i18n.format("FFD20.LevelUp.Chat.Extra.NewFeats",{newValue:t.new}));const s=this.actor.system.attributes.hd.total;"number"==typeof s&&s%4==0&&(e.enabled=!0,e.newAbilityScore={label:game.i18n.localize("FFD20.LevelUp.Chat.Extra.NewAbilityScore")})}return this.createChatMessage(l)}_parseSection(e){const t={item:{},actor:{},chatData:{},newItems:[],summary:{},callbacks:[]},s=this["_parseSection_"+e.name];return s instanceof Function?s.call(this,e,t):t}_parseSection_health(e,t){if(t.summary={label:"FFD20.LevelUp.Chat.Health.Header",template:"systems/ffd20/templates/apps/level-up/summary/health.hbs",type:e.choice},"manual"===e.choice){const s=e.manualValue;t.item["system.hp"]=this.object.system.hp+s,t.chatData.hp={label:"FFD20.LevelUp.Chat.Health.Manual",add:s,roll:RollPF.safeRoll(""+s)},t.summary.hp=s}else if("roll"===e.choice){const e="1d"+this.object.system.hd,s=RollPF.safeRoll(e);t.chatData.hp={label:"FFD20.LevelUp.Chat.Health.Roll",add:createInlineRollString(s),roll:s},Number.isNaN(s.total)||(t.item["system.hp"]=this.object.system.hp+s.total)}return t}_parseSection_fc(e,t){t.summary={label:"FFD20.LevelUp.Chat.FC.Header",template:"systems/ffd20/templates/apps/level-up/summary/fc.hbs",id:e.choice};const s=e.choice;if(["hp","skill","alt"].includes(s)){const n=`system.fc.${e.choice}.value`;t.item[n]=getProperty(this.object,n)+1;const l={hp:"HP",skill:"Skill",alt:"Alt"}[s];t.chatData.fc={type:s,label:"FFD20.FavouredClassBonus."+l},t.summary.desc=`FFD20.LevelUp.FC.${l}.Desc`}return t}_parseSection_ability(e,t){const s=Object.entries(e.abilities).reduce(((e,t)=>t[1].added>0?(e[t[0]]=t[1].added,e):e),{});t.summary={label:"FFD20.LevelUp.AbilityScore.Label",template:"systems/ffd20/templates/apps/level-up/summary/ability-score.hbs",choices:s},Object.keys(s).length&&(t.chatData.ability={choices:s});const n=this.actor.items.find((e=>!0===e.getFlag("ffd20","levelUp")));if(n){const cb=async function(){const e=duplicate(n.system.changes??[]);for(const[t,n]of Object.entries(s)){const s=e.find((e=>e.subTarget===t));if(null!=s){const e=parseInt(s.formula);if(!Number.isNaN(e)){const t=e+n;s.formula=""+t;continue}}e.push(mergeObject(ffd20.components.ItemChange.defaultData,{subTarget:t,formula:""+n,modifier:"untypedPerm"}))}await n.update({"system.changes":e})};t.callbacks.push(cb)}else{const e=mergeObject(ffd20.config.levelAbilityScoreFeature,{flags:{ffd20:{levelUp:!0}}},{inplace:!1});setProperty(e,"system.changes",Object.entries(s).reduce(((e,t)=>{const s=mergeObject(ffd20.components.ItemChange.defaultData,{formula:""+t[1],subTarget:t[0],modifier:"untypedPerm"});return e.push(s),e}),[])),t.newItems.push(e)}return t}async createChatMessage(e){const t=ChatMessage.getSpeaker({actor:this.actor,token:this.token}),s={formData:e,config:ffd20.config,item:this.object.toObject(),actor:this.actor.toObject()};return ChatMessage.create({content:await renderTemplate("systems/ffd20/templates/chat/level-up.hbs",s),user:game.user.id,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t,roll:e.hp?.roll??RollPF.safeRoll("0")})}activateListeners(e){e.find(".list-selector .item").on("click",this._onClickListItem.bind(this)),e.find("input.section-choice").on("change",this._onChangeSectionChoice.bind(this)),e.find(".ability-scores .ability-score .operator").on("click",this._onClickAbilityScoreOperator.bind(this)),e.find('button[data-type="previous"]').on("click",this._onPreviousSection.bind(this)),e.find('button[data-type="next"]').on("click",this._onNextSection.bind(this)),e.find('button[name="submit"]').on("click",this._onSubmit.bind(this))}_onPreviousSection(e){e.preventDefault(),this.setSection(this.section-1)}_onNextSection(e){e.preventDefault(),this.setSection(this.section+1)}_onClickListItem(e){e.preventDefault();const t=e.currentTarget;if(!t.classList.contains("active"))return this.currentSection.currentItem=this.currentSection.items.find((e=>e.id===t.dataset.id)),setProperty(this.currentSection,"choice",t.dataset.id),this._render()}async _render(...e){await super._render(...e),this._updateNavButtons()}_onChangeSectionChoice(e){e.preventDefault();const t=e.currentTarget,[s,n]=t.name.split(":"),l=this._sections.find((e=>e.name===s));if(!l)return;let c=t.value;switch(t.dataset.dtype){case"Number":c=parseFloat(c);break;case"Boolean":c=["true","1"].includes(c)}setProperty(l,n,c)}_onClickAbilityScoreOperator(e){e.preventDefault();const t=e.currentTarget,s=t.dataset.operator,n=t.closest(".ability-score").dataset.key,l=this.currentSection,c="add"===s?1:"subtract"===s?-1:0;l.abilities[n].value+=c,l.abilities[n].added+=c,l.value-=c,l.choice=0===l.value||null,this._render()}_updateNavButtons(){const e=this.element.find(".nav-buttons"),t={previous:e.find('button[data-type="previous"]'),next:e.find('button[data-type="next"]'),submit:e.find('button[type="submit"]')};this._section>0?t.previous.prop("disabled",!1):t.previous.prop("disabled",!0);const s=!!this.currentSection.choice;this.section<this._sections.length-1&&s?t.next.prop("disabled",!1):t.next.prop("disabled",!0),this.section===this._sections.length-1?t.submit.prop("disabled",!1):t.submit.prop("disabled",!0)}_onSubmit(e,...t){e.preventDefault(),this._submitted||(this._submitted=!0,super._onSubmit(e,...t))}}class CurrencyTransfer extends FormApplication{constructor(e={actor:null,container:null,amount:{},alt:!1},t={actor:null,container:null,amount:{},alt:!1},s={}){if(super(s),e.actor&&("string"==typeof e.actor&&(e.actor=game.actors.get(e.actor)),"npc"==e.actor.type&&(e.alt=!1)),e.container&&(e.alt=!1,"string"==typeof e.container&&(e.container=e.actor?e.actor.items.get(e.container):game.items.get(e.container))),t.actor&&("string"==typeof t.actor&&(t.actor=game.actors.get(t.actor)),"npc"==t.actor.type?t.alt=!1:t.actor!==e.actor||e.container||t.container||(t.alt=!e.alt)),t.container&&"string"==typeof t.container&&(t.container=t.actor?t.actor.items.get(t.container):game.items.get(t.container)),e.container)e.amount=mergeObject(e.container.system.currency,e.amount??{});else if(e.actor)e.amount=mergeObject(e.alt?e.actor.system.altCurrency:e.actor.system.currency,e.amount??{});else{if(!game.user.isGM)return void ui.notification.warning("Cannot use Infinite currency transfer as non-gm.");e.amount=mergeObject({pgil:"∞",gil:"∞",sgil:"∞",cgil:"∞"},e.amount??{})}(t.actor||t.container)&&(this.source=e,this.dest=t)}get title(){let e;return this.source.actor?(e=this.source.actor.name+" ",this.source.container&&(e+=`(${this.source.container.name}) `)):e=this.source.container?this.source.container.name+" ":"∞ ",e+="➤ ",this.source.actor==this.dest.actor&&(this.source.alt||this.dest.alt)?e+=this.dest.alt?game.i18n.localize("FFD20.WeightlessCurrency"):game.i18n.localize("FFD20.Currency"):this.dest.actor?(e+=this.dest.actor.name,this.dest.container&&(e+=` (${this.dest.container.name})`)):e+=this.dest.container.name,e}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","currency-transfer"],template:"systems/ffd20/templates/apps/currency-transfer.hbs",width:380,height:235})}static get order(){return["pgil","gil","sgil","cgil"]}activateListeners(e){e.find('button[type="submit"]').click(this._onSubmit.bind(this)),e.find("button.cur-range").click(this._curRange.bind(this)),e.find("input").on("input",this._calcTotal.bind(this)),$(e.find("input")[0]).trigger("input")}_updateObject(e,t){this.dest.amount={pgil:t.pgil??0,gil:t.gil??0,sgil:t.sgil??0,cgil:t.cgil??0},this.constructor.transfer(this.source.container?this.source.container:this.source.actor,this.dest.container?this.dest.container:this.dest.actor,this.dest.amount,this.source.alt,this.dest.alt,2)}getData(e={}){return{source:this.source,dest:this.dest,options:this.options,title:this.title,total:"∞"===this.source.amount.gil?"∞":this.constructor.order.reduce(((e,t,s)=>e+this.source.amount[t]*10**(1-s)),0)}}_curRange(e){e.preventDefault();const t=e.target.closest("button"),s=t.closest(".form-fields"),n=t.classList.contains("down"),l=s.querySelector("input");l.value=n?"":s.querySelector("span").textContent,$(l).trigger("input")}_calcTotal(e){const t=e.target.closest(".currency-transfer"),s=Object.fromEntries([...t.querySelectorAll("input")].map((e=>[e.name,parseInt(e.value||0)]))),n=this.constructor.order.reduce(((e,t,n)=>e+s[t]*10**(1-n)),0);t.querySelector(".currency-total .form-fields label").textContent=Math.round(100*n)/100+" gil"}async close(...e){super.close(...e)}static _failed(e){ui.notifications.error(game.i18n.localize("FFD20.CurrencyFailed")+game.i18n.localize(e))}static async _directoryDrop(e,t){let s;t.preventDefault();try{if(s=JSON.parse(t.dataTransfer.getData("text/plain")),"Currency"!==s.type)return}catch(e){return!1}const n=t.currentTarget.classList.contains("item")?game.items.get(e):game.actors.get(e);let l=await fromUuid(s.actorUuid||"");if(l instanceof Actor||(l=l?.actor),s.currency&&l)return new CurrencyTransfer({actor:l,container:s.containerId,alt:s.alt},{actor:n?.actor??n,container:"container"===n.system.type?n.id:null,amount:Object.fromEntries([[s.currency,parseInt(s.amount)]])}).render(!0)}static async transfer(e,t,s,n=!1,l=!1,c=!1){if(!e&&!game.user.isGM||!t||!s)return!1;if("object"!=typeof s&&(s={gil:parseInt(s)}),this.order.forEach((e=>s[e]=s[e]??0)),!Object.values(s).find((e=>e>0)))return this._failed("FFD20.CurrencyInsufficient"),!1;let u=duplicate(n?e?.system.altCurrency:e?.system.currency);const d=duplicate(l?t.system.altCurrency:t.system.currency);if(!u&&!game.user.isGM||!d)return!1;const m=Object.assign(Object.fromEntries(this.order.map((e=>[e,1/0]))),u),h=this.order.reduce(((e,t,n)=>e+s[t]*10**(1-n)),0),g=this.order.reduce(((e,t,s)=>e+u[t]*10**(1-s)),0);return h>g?(this._failed("FFD20.CurrencyInsufficient"),!1):(u&&this.order.some((e=>{const t=u[e]-s[e];if(t<0&&c)return s=this.convert(m,h,c),u=Object.fromEntries(this.order.map((e=>[e,m[e]-s[e]]))),!0;u[e]=t})),!(!s||Object.values(u).find((e=>e<0)))&&(e.testUserPermission(game.user,3)&&t.testUserPermission(game.user,3)?(this.order.forEach((e=>d[e]+=s[e])),e===t?e.update({"system.altCurrency":n?u:d,"system.currency":l?u:d}):(n?e.update({"system.altCurrency":u}):e.update({"system.currency":u}),l?t.update({"system.altCurrency":d}):t.update({"system.currency":d}),s)):game.users.find((e=>e.active&&e.isGM))?(game.socket.emit("system.ffd20",{eventType:"currencyTransfer",data:{sourceActor:e.actor?.uuid??e.uuid,destActor:t.actor?.uuid??t.uuid,sourceContainer:"container"===e.type?e.id:"",destContainer:"container"===t.type?t.id:"",sourceAlt:n,destAlt:l,amount:s}}),s):(this._failed("FFD20.CurrencyGMRequired"),!1)))}static convert(e,t){if(e=e?Object.assign({},e):Object.fromEntries(this.order.map((e=>[e,1/0]))),"number"!=typeof t&&(t=this.order.reduce(((e,s,n)=>e+t?.[s]*10**(1-n)))),!t)return!1;const s={};return!((t=this.order.reduce(((t,n,l)=>{const c=Math.min(e[n],Math.floor(t%1e4/10**(3-l))),u=c*10**(3-l);return s[n]=c,e[n]-=c,t-u}),100*t)/100)<0)&&s}}class ActorSheetPF extends ActorSheet{constructor(...e){super(...e),this._filters={inventory:new Set,"spellbook-primary":new Set,"spellbook-secondary":new Set,"spellbook-tertiary":new Set,"spellbook-quaternary":new Set,"spellbook-spelllike":new Set,features:new Set,buffs:new Set,attacks:new Set,search:{inventory:"",attacks:"",feats:"",buffs:"","spellbook-primary":"","spellbook-secondary":"","spellbook-tertiary":"","spellbook-quaternary":"","spellbook-spelllike":""}},this.searchCompositioning=!1,this.searchRefresh=!0,this.searchDelay=250,this.searchDelayEvent=null,this.effectiveSearch={},this._itemUpdates=[],this._hiddenElems={},this._submitQueued=!1,this._renderedInner=!1,this._pendingUpdates={},this._skillsLocked=!0,this._expandedItems=[]}static get defaultOptions(){return mergeObject(super.defaultOptions,{scrollY:[".combat-attacks",".item-groups-list",".skills-list",".traits",".actor-notes",".editor-content[data-edit='system.details.biography.value']"],dragDrop:[{dragSelector:"li.item[data-item-id]"},{dragSelector:"label.denomination"},{dragSelector:".race-container.item[data-item-id]"},{dragSelector:"li.skill[data-skill]"},{dragSelector:"li.sub-skill[data-skill]"},{dragSelector:"th.saving-throw[data-savingthrow]"},{dragSelector:"th.attribute.cmb[data-attribute]"},{dragSelector:"th.attribute.bab[data-attribute]"},{dragSelector:"th.attribute.initiative[data-attribute]"},{dragSelector:"li.generic-defenses[data-drag]"},{dragSelector:".ability-scores .ability[data-ability]"},{dragSelector:".attribute.attack[data-attack]"},{dragSelector:".spellcasting-concentration[data-drag]"},{dragSelector:".spellcasting-cl"}],tabs:[{navSelector:"nav.tabs[data-group='primary']",contentSelector:"section.primary-body",initial:"summary",group:"primary"},{navSelector:"nav.tabs[data-group='skillset']",contentSelector:"section.skillset-body",initial:"adventure",group:"skills"},{navSelector:"nav.tabs[data-group='spellbooks']",contentSelector:"section.spellbooks-body",initial:"primary",group:"spellbooks"}]})}static get featTypeData(){return{template:{hasActions:!1}}}get currentPrimaryTab(){const e=this.element.find('nav[data-group="primary"] .item.active');return 1!==e.length?null:e.attr("data-tab")}get currentSpellbookKey(){const e=this.element.find("nav.spellbooks .item.active");return 1===e.length?e.attr("data-tab"):"primary"}async getData(e){const t=this.document.isOwner,s=mergeObject(await super.getData(e),{owner:t,limited:this.document.limited,editable:this.isEditable,cssClass:t?"editable":"locked",isCharacter:"character"===this.document.type,hasRace:!1,config:ffd20.config,useBGSkills:game.settings.get("ffd20","allowBackgroundSkills"),isGM:game.user.isGM,race:null!=this.document.race?this.document.race.toObject():null,usesAnySpellbook:this.document.system.attributes.spells.usedSpellbooks?.length>0,sourceData:{},skillsLocked:this._skillsLocked}),n=this.document.getRollData();s.rollData=n,s.system=deepClone(this.document.system),s.inCharacterGeneration=this.inCharacterGeneration,s.hasProficiencies=s.isCharacter||game.settings.get("ffd20","npcProficiencies"),s.hasCurrency=Object.values(this.object.system.currency).some((e=>e>0)),s.hasAltCurrency=Object.values(this.object.system.altCurrency).some((e=>e>0)),s.biographyHTML=await TextEditor.enrichHTML(s.system.details.biography.value,{secrets:t,rollData:s.rollData,async:!0}),s.notesHTML=await TextEditor.enrichHTML(s.system.details.notes.value,{secrets:t,rollData:s.rollData,async:!0}),s.token=this.token,s.items=this.document.items.map((e=>{const t=deepClone(e.system);t.document=e,t.type=e.type,t.id=e.id,t.img=e.img,t.isSingleUse=e.isSingleUse,t.isCharged=e.isCharged,t.hasResource=t.isCharged&&!t.isSingleUse,t.hasUses=t.uses?.max>0;const s=e.firstAction,n=s?.getRollData();t.labels=e.getLabels({actionId:s?.id,rollData:n}),t.hasAttack=s?.hasAttack,t.hasMultiAttack=s?.hasMultiAttack,t.hasDamage=s?.hasDamage,t.hasRange=s?.hasRange,t.hasEffect=s?.hasEffect,t.hasAction=e.hasAction||e.getScriptCalls("use").length>0,t.range=mergeObject(s?.data?.range??{},{min:s?.getRange({type:"min",rollData:n}),max:s?.getRange({type:"max",rollData:n})},{inplace:!1}),t.sort=e.sort,t.showUnidentifiedData=e.showUnidentifiedData,t.name=e.name,t.isStack=t.quantity>1,t.price=e.getValue({recursive:!1,sellValue:1});const l=null!=t.quantity?t.quantity:1,c=null!=t.uses?.value?t.uses.value:1;return t.empty=l<=0||t.isCharged&&!t.isSingleUse&&c<=0,t})),s.items.sort(((e,t)=>(e.sort||0)-(t.sort||0))),s.labels=this.document.getLabels(),s.filters=this._filters;{const e=s.system.attributes,t=s.system.abilities,n=ffd20.config.sizeMods[s.system.traits.size],l=e.attack.shared+e.attack.general+n,c=t[e.attack.meleeAbility]?.mod??0,u=t[e.attack.rangedAbility]?.mod??0;s.genericAttacks={melee:{ability:e.attack.meleeAbility,abilityMod:c,modifier:l+e.attack.melee+c},ranged:{ability:e.attack.rangedAbility,abilityMod:u,modifier:l+e.attack.ranged+u}}}{const e=this.calculateTotalItemValue({inLowestDenomination:!0}),t=splitCurrency(e);s.labels.totalValue=game.i18n.format("FFD20.ItemContainerTotalItemValue",{gil:t.gil,sgil:t.sgil,cgil:t.cgil})}null!=this.document.sourceDetails?s.sourceDetails=expandObject(this.document.sourceDetails):s.sourceDetails=null;for(const[e,t]of Object.entries(s.system.abilities))t.label=ffd20.config.abilities[e],t.totalLabel=null==t.total?"-":t.total,t.sourceDetails=[...s.sourceDetails?.system?.abilities?.[e]?.total??[],...s.sourceDetails?.system?.abilities?.[e]?.penalty??[]];for(const[e,t]of Object.entries(s.system.attributes.ac))t.label=ffd20.config.ac[e],t.sourceDetails=null!=s.sourceDetails?s.sourceDetails.system.attributes.ac[e].total:[];for(const[e,t]of Object.entries(s.system.attributes.savingThrows))t.label=ffd20.config.savingThrows[e],t.sourceDetails=null!=s.sourceDetails?s.sourceDetails.system.attributes.savingThrows[e].total:[];const l=this.document.system.attributes?.acp?.total;for(const[e,t]of Object.entries(s.system.skills??{}))if(t.label=ffd20.config.skills[e],t.arbitrary=ffd20.config.arbitrarySkills.includes(e),t.sourceDetails=[],t.compendiumEntry=ffd20.config.skillCompendiumEntries[e]??t.journal??null,t.rank>0&&(t.sourceDetails.push({name:game.i18n.localize("FFD20.SkillRankPlural"),value:t.rank}),t.cs&&t.sourceDetails.push({name:game.i18n.localize("FFD20.CSTooltip"),value:3})),t.acp&&l>0&&t.sourceDetails.push({name:game.i18n.localize("FFD20.ACPLong"),value:-l}),t.ability&&t.sourceDetails.push({name:ffd20.config.abilities[t.ability],value:s.rollData.abilities[t.ability]?.mod??0}),null!=s.sourceDetails&&null!=s.sourceDetails.system.skills[e]&&(t.sourceDetails=t.sourceDetails.concat(s.sourceDetails.system.skills[e].changeBonus)),t.untrained=!0===t.rt&&t.rank<=0,null!=t.subSkills)for(const[n,l]of Object.entries(t.subSkills))l.compendiumEntry=l.journal??null,l.sourceDetails=[],l.rank>0&&(l.sourceDetails.push({name:game.i18n.localize("FFD20.SkillRankPlural"),value:l.rank}),l.cs&&l.sourceDetails.push({name:game.i18n.localize("FFD20.CSTooltip"),value:3})),l.sourceDetails.push({name:ffd20.config.abilities[l.ability],value:s.system.abilities[l.ability]?.mod??0}),null!=s.sourceDetails&&null!=s.sourceDetails.system.skills[e]&&null!=s.sourceDetails.system.skills[e].subSkills&&null!=s.sourceDetails.system.skills[e].subSkills[n]&&(l.sourceDetails=l.sourceDetails.concat(s.sourceDetails.system.skills[e].subSkills[n].changeBonus)),l.untrained=!0===l.rt&&l.rank<=0;this._prepareTraits(s.system.traits),s.senses=this._prepareSenses(s.system.traits.senses),s.dr=this._prepareResistance(s.system.traits.dr,"dr"),s.eres=this._prepareResistance(s.system.traits.eres,"eres"),this._prepareItems(s),s.encumbrance=this._computeEncumbrance(s.system),s.skillsets=this._prepareSkillsets(s.system.skills);const c={allowed:0,used:0,bgAllowed:0,bgUsed:0,sentToBG:0};for(const e of Object.values(s.rollData.skills))if(null!=e.subSkills)for(const t of Object.values(e.subSkills))s.useBGSkills&&e.background?c.bgUsed+=t.rank:c.used+=t.rank;else s.useBGSkills&&e.background?c.bgUsed+=e.rank:c.used+=e.rank;const u=[];setProperty(s.sourceData,"skillRanks",u),this.document.items.filter((e=>"class"===e.type&&"mythic"!==e.system.subType)).forEach((e=>{const t=e.system.hitDice,n=e.system.skillsPerLevel,l=e.system.fc.skill.value;c.allowed+=Math.max(1,n+this.document.system.abilities.int.mod)*t+l,s.useBGSkills&&ffd20.config.backgroundSkillClasses.includes(e.system.subType)&&(c.bgAllowed+=t*ffd20.config.backgroundSkillsPerLevel),u.push({name:game.i18n.format("FFD20.SourceInfoSkillRank_ClassBase",{className:e.name}),value:n*t}),l>0&&u.push({name:game.i18n.format("FFD20.SourceInfoSkillRank_ClassFC",{className:e.name}),value:l})}));const d=this.actor.system.abilities?.int?.mod;if(0!==d&&u.push({name:game.i18n.localize("FFD20.AbilityInt"),value:d*this.actor.system.attributes?.hd?.total}),""!==this.actor.system.details.bonusSkillRankFormula){const e=RollPF.safeRoll(this.actor.system.details.bonusSkillRankFormula,n);e.err&&console.error(`An error occurred in the Bonus Skill Rank formula of actor ${this.actor.name}.`),c.allowed+=e.total,u.push({name:game.i18n.localize("FFD20.SkillBonusRankFormula"),value:e.total})}this.actor.changes.filter((e=>"bonusSkillRanks"===e.subTarget)).forEach((e=>{e.value&&(c.allowed+=e.value,u.push({name:e.parent?.name??game.i18n.localize("FFD20.Change"),value:e.value}))})),s.useBGSkills&&c.bgUsed>c.bgAllowed&&(c.sentToBG=c.bgUsed-c.bgAllowed,c.allowed-=c.sentToBG,c.bgAllowed+=c.sentToBG),s.skillRanks=c;{const e=[];setProperty(s.sourceData,"bonusFeats",e),s.featCount={},s.featCount.value=this.actor.items.filter((e=>"feat"===e.type&&"feat"===e.system.subType&&!e.system.disabled)).length;const t=this.document.items.filter((e=>"class"===e.type&&["base","npc","prestige","racial"].includes(e.system.subType))).reduce(((e,t)=>e+t.hitDice),0);s.featCount.byLevel=Math.ceil(t/2),e.push({name:game.i18n.localize("FFD20.Level"),value:s.featCount.byLevel});const l=RollPF.safeRoll(this.document.system.details.bonusFeatFormula||"0",n),c=this.document.changes.filter((e=>"bonusFeats"===e.subTarget)),u=getHighestChanges(c.filter((t=>(t.applyChange(this.document),(t.parent||t.flavor)&&e.push({name:t.parent?.name??t.flavor,value:t.value}),!["set","="].includes(t.operator)))),{ignoreTarget:!0}).reduce(((e,t)=>e+t.value),0);s.featCount.byFormula=l.total+u,l.err&&ui.notifications.error(game.i18n.format("FFD20.ErrorActorFormula",{error:game.i18n.localize("FFD20.BonusFeatFormula"),name:this.document.name})),0!==l.total&&e.push({name:game.i18n.localize("FFD20.BonusFeatFormula"),value:l.total}),s.featCount.total=s.featCount.byLevel+s.featCount.byFormula}{const e={character:"pc",npc:"npc"}[this.document.type];s.healthConfig=game.settings.get("ffd20","healthConfig"),s.useWoundsAndVigor=s.healthConfig.variants[e].useWoundsAndVigor}return this._prepareHiddenElements(),s.hiddenElems=this._hiddenElems,s.magicItems={identified:[],unidentified:[]},this.document.items.filter((e=>{if(!e.isPhysical)return!1;if(e.showUnidentifiedData)return!1;if(!e.system.carried)return!1;if(0===e.system.quantity)return!1;const t=e.system.aura?.school,s=e.system.cl;return t?.length>0&&s>0})).forEach((e=>{const t={};t.name=e.name,t.img=e.img,t.id=e.id,t.cl=e.system.cl,t.school=e.system.aura?.school,null!=CONFIG.FFD20.spellSchools[t.school]&&(t.school=CONFIG.FFD20.spellSchools[t.school]),t.aura={strength:CONFIG.FFD20.auraStrengths[e.auraStrength],school:t.school},t.identifyDC=15+t.cl,t.quantity=e.system.quantity||0,t.identified=!0===e.system.identified,t.unidentifiedName=game.user.isGM?e.system.unidentified?.name:null,t.identified?s.magicItems.identified.push(t):s.magicItems.unidentified.push(t)})),s.labels.firstClass=game.i18n.format("FFD20.Info_FirstClass",{html:`<a data-action="compendium" data-action-target="classes" data-tooltip="FFD20.OpenCompendium">${game.i18n.localize("FFD20.Info_FirstClass_Compendium")}</a>`}).replace(/\n+/,"<br>"),s}get inCharacterGeneration(){return this.actor.system.attributes.hd.total<=1||Object.values(this.actor.system.abilities).every((e=>10===e.value))}_prepareHiddenElements(){const e=this.document.system.attributes?.spells?.spellbooks??{};for(const t of Object.keys(e)){const e="spellbook-info_"+t;null==this._hiddenElems[e]&&(this._hiddenElems[e]=!0)}}_prepareTraits(e){const t=ffd20.registry.damageTypes.getLabels(),s={di:t,dv:t,ci:ffd20.config.conditionTypes,languages:ffd20.config.languages,armorProf:ffd20.config.armorProficiencies,weaponProf:ffd20.config.weaponProficiencies};for(const[t,n]of Object.entries(s)){const s=e[t];if(!s)continue;let l=[];["armorProf","weaponProf","languages"].includes(t)?l=s.total??s.value:s.value&&(l=s.value instanceof Array?s.value:[s.value]),s.selected=l.reduce(((e,t)=>(e[t]=n[t],e)),{}),s.customTotal?s.customTotal.split(ffd20.config.re.traitSeparator).forEach(((e,t)=>s.selected["custom"+(t+1)]=e.trim())):s.custom&&s.custom.split(ffd20.config.re.traitSeparator).forEach(((e,t)=>s.selected["custom"+(t+1)]=e.trim())),s.cssClass=foundry.utils.isEmpty(s.selected)?"inactive":""}}_prepareSenses(e){const t={};for(const[s,n]of Object.entries(e))if("ll"===s&&e[s].enabled)t[s]=ffd20.config.senses[s];else if("custom"===s&&n.length)n.split(ffd20.config.re.traitSeparator).forEach(((e,s)=>{t["custom"+(s+1)]=e.trim()}));else if("number"==typeof n&&n>0){const e=ffd20.utils.convertDistance(n);t[s]=`${ffd20.config.senses[s]} ${e[0]} ${e[1]}`}else!0!==n||(t[s]=ffd20.config.senses[s]);return t}_prepareResistance(e,t){const s={},format3=(e,s,n,l)=>{let c=s;if(l)if(!1===n)c=game.i18n.format("FFD20.Application.DamageResistanceSelector.CombinationFormattedAnd",{type1:s,type2:l});else c=game.i18n.format("FFD20.Application.DamageResistanceSelector.CombinationFormattedOr",{type1:s,type2:l});return"dr"===t?`${e}/${c}`:`${c} ${e}`};for(const[n,l]of Object.entries(e))"custom"!==n?l.forEach(((e,t)=>{const[n,l]=[e.amount,e.operator],c=ffd20.registry.damageTypes.get(e.types[0]?.toLowerCase())?.name??"-",u=ffd20.registry.damageTypes.get(e.types[1]?.toLowerCase())?.name??"";s[""+(t+1)]=format3(n,c,l,u)})):l.length&&l.split(ffd20.config.re.traitSeparator).forEach(((e,n)=>{const l=e.split("dr"===t?/\s*\/\s*/:/\s+/),c=l["dr"===t?1:0],u=l["dr"===t?0:1];s["custom"+(n+1)]=format3(u,c,null,"")}));return s}_prepareSpellbook(e,t,s){const n=this.document.isOwner,l=this.document.system.attributes.spells.spellbooks[s],c=l.hasCantrips?0:1;let u=9;if(l.autoSpellLevelCalculation){const e=l.cl.autoSpellLevelTotal,t=ffd20.config.casterProgression.castsPerDay[l.spellPreparationMode]?.[l.casterType]?.[e-1];u=void 0!==t?t.length-1:0}const d={};for(let t=0;t<10;t++){const c=l.spells?.["spell"+t];c?isNaN(c.max)||(d[t]={level:t,usesSlots:!0,spontaneous:l.spontaneous,canCreate:!0===n,canPrepare:"character"===e.actor.type,label:ffd20.config.spellLevels[t],items:[],uses:c.value||0,baseSlots:c.base||0,slots:c.max||0,dataset:{type:"spell",level:t,spellbook:s},name:game.i18n.localize("FFD20.SpellLevel"+t),spellMessage:c.spellMessage,lowAbilityScore:c.lowAbilityScore,known:c.known,preparation:c.preparation}):console.error(`Bad data for spell level ${t} in spellbook "${s}" for actor "${this.actor.name}"`)}t.forEach((e=>{const t=e.level??c;d[t]?.items.push(e)}));for(let e=0;e<10;e++)0===d[e]?.items.length&&(e>u||e<c)&&delete d[e];return d}_prepareSkillsets(e){const t={all:{skills:{}},adventure:{skills:{}},background:{skills:{}}};return Object.keys(e).sort((function(t,s){return e[t].custom&&!e[s].custom?1:!e[t].custom&&e[s].custom?-1:(""+e[t].label).localeCompare(e[s].label)})).forEach((s=>{const n=e[s];ffd20.config.backgroundOnlySkills.includes(s)||(t.all.skills[s]=n),n.background?t.background.skills[s]=n:t.adventure.skills[s]=n})),t}_typeFilterCount(e){return Array.from(e).filter((e=>e.startsWith("type-"))).length}_filterItems(e,t){const s=this._typeFilterCount(t)>0;return e.filter((e=>{if(["feat","buff","attack"].includes(e.type)&&s&&!t.has("type-"+e.subType))return!1;if(e.document.isPhysical){if(s&&"loot"!==e.type&&!t.has("type-"+e.type))return!1;if(s&&"loot"===e.type&&!t.has("type-"+e.subType))return!1}return!("spell"===e.type&&s&&!t.has("type-"+e.level))}))}_computeEncumbrance(e){const t=e.attributes.encumbrance.carriedWeight,s=e.attributes.encumbrance.levels.light,n=e.attributes.encumbrance.levels.medium,l=e.attributes.encumbrance.levels.heavy,c="metric"===getWeightSystem()?game.i18n.format("FFD20.CarryLabelKg",{kg:t}):game.i18n.format("FFD20.CarryLabel",{lbs:t});return{pct:{light:Math.clamped(100*t/s,0,99.5),medium:Math.clamped(100*(t-s)/(n-s),0,99.5),heavy:Math.clamped(100*(t-n)/(l-n),0,99.5)},encumbered:{light:e.attributes.encumbrance.level>=ffd20.config.encumbranceLevels.medium,medium:e.attributes.encumbrance.level>=ffd20.config.encumbranceLevels.heavy,heavy:e.attributes.encumbrance.carriedWeight>=e.attributes.encumbrance.levels.heavy},light:e.attributes.encumbrance.levels.light,medium:e.attributes.encumbrance.levels.medium,heavy:e.attributes.encumbrance.levels.heavy,aboveHead:e.attributes.encumbrance.levels.heavy,offGround:2*e.attributes.encumbrance.levels.heavy,dragPush:5*e.attributes.encumbrance.levels.heavy,value:e.attributes.encumbrance.carriedWeight,carryLabel:c}}activateListeners(e){super.activateListeners(e),e.mousemove((e=>this._moveTooltips(e)));const t=e.find(".filter-list");t.each(this._initializeFilterItemList.bind(this)),t.on("click",".filter-item",this._onToggleFilter.bind(this));{const t=e.find(".search-input");t.on("keyup change",this._searchFilterChange.bind(this)),t.on("compositionstart compositionend",this._searchFilterCompositioning.bind(this)),this.searchRefresh=!0,t.each((function(){this.value.length>0&&$(this).change()})),e.find(".clear-search").on("click",this._clearSearch.bind(this))}e.find(".item .item-name").click((e=>this._onItemSummary(e))),e.find(".race").each(((e,t)=>{t.closest(".item").dataset?.itemId&&t.addEventListener("contextmenu",(e=>this._onItemEdit(e)))})),e.find(".item-edit").on("click",this._onItemEdit.bind(this)),e.find(".item .item-name").contextmenu(this._onItemEdit.bind(this)),e.find(".quick-actions li").contextmenu(this._onItemEdit.bind(this)),e.find(".race-container .item-control").click(this._onRaceControl.bind(this)),this.options.editable?(e.off("change"),e.find("input,select,textarea").on("change",this._onChangeInput.bind(this)),e.find("span.text-box.direct").on("click",(e=>{this._onSpanTextInput(e,this._adjustActorPropertyBySpan.bind(this))})),e.find('*[data-action="input-text"]').click((e=>this._onInputText(e))),e.find('*[data-action="input-text"].wheel-change').on("wheel",(e=>this._onInputText(e.originalEvent))),e.find("textarea").change(this._onSubmit.bind(this)),e.find(".config .config-control").click(this._onConfigControl.bind(this)),e.find(".select-on-click").click(this._selectOnClick.bind(this)),e.find(".submit-on-blur").on("blur",(async e=>{await this._onSubmit(e,{preventRender:!0}),this.render()})),e.find('input[name="system.attributes.hp.value"]').keypress(this._onSubmitElement.bind(this)),e.find('input[name="system.attributes.mp.value"]').keypress(this._onSubmitElement.bind(this)),e.find(".ability-name").click(this._onRollAbilityTest.bind(this)),e.find(".attribute.bab .rollable").click(this._onRollBAB.bind(this)),e.find(".attribute.cmb .rollable").click(this._onRollCMB.bind(this)),e.find(".attribute.attack.melee .rollable").click(this._onRollMelee.bind(this)),e.find(".attribute.attack.ranged .rollable").click(this._onRollRanged.bind(this)),e.find(".attribute.initiative .rollable").click(this._onRollInitiative.bind(this)),e.find(".saving-throw .rollable").click(this._onRollSavingThrow.bind(this)),e.find("span.text-box.skill-rank").on("click",(e=>{this._onSpanTextInput(e,this._adjustActorPropertyBySpan.bind(this))})),e.find(".skill.arbitrary .skill-create").click((e=>this._onArbitrarySkillCreate(e))),e.find(".sub-skill > .skill-controls > .skill-delete").click((e=>this._onArbitrarySkillDelete(e))),e.find(".skill-controls.skills .skill-create").click((e=>this._onSkillCreate(e))),e.find(".sub-skill > .skill-controls > .skill-edit").on("click",(e=>this._onSkillEdit(e))),e.find(".skill > .skill-controls > .skill-edit").on("click",(e=>this._onSkillEdit(e))),e.find(".skill > .skill-controls > .skill-delete").click((e=>this._onSkillDelete(e))),e.find(".item-actions a.item-action").click(this._itemActivationControl.bind(this)),e.find(".skill > .action.roll").click(this._onRollSkillCheck.bind(this)),e.find(".sub-skill > .action.roll").click(this._onRollSubSkillCheck.bind(this)),e.find("a.compendium-entry").click(this._onOpenCompendiumEntry.bind(this)),e.find(".trait-selector").click(this._onTraitSelector.bind(this)),e.find(".resistance-selector").click(this._onResistanceSelector.bind(this)),e.find(".generic-defenses .rollable").click((e=>{this.document.displayDefenseCard({token:this.token})})),e.find(".rest").click(this._onRest.bind(this)),e.find("button.pointbuy-calculator").click(this._onPointBuyCalculator.bind(this)),e.find(".control.alignment").click(this._onControlAlignment.bind(this)),e.find(".senses-selector").on("click",this._onSensesSelector.bind(this)),e.find(".item-create").on("click",(e=>this._onItemCreate(e))),e.find(".item-delete").on("click",this._onItemDelete.bind(this)),e.find(".item-give").on("click",this._onItemGive.bind(this)),e.find(".item-split:not(.disabled)").on("click",this._onItemSplit.bind(this)),e.find(".item .item-image").click((e=>this._onItemRoll(e))),e.find("a.item-control.item-quantity-add").click((e=>{this._quickChangeItemQuantity(e,1)})),e.find("a.item-control.item-quantity-subtract").click((e=>{this._quickChangeItemQuantity(e,-1)})),e.find("a.item-control.item-equip").click((e=>{this._quickEquipItem(e)})),e.find("a.item-control.item-carry").click((e=>{this._quickCarryItem(e)})),e.find("a.item-control.item-identify").click((e=>{this._quickIdentifyItem(e)})),e.find("a.item-control.item-toggle-data").click(this._itemToggleData.bind(this)),e.find("a.item-control.item-duplicate").click(this._duplicateItem.bind(this)),e.find(".quick-actions li").click(this._quickAction.bind(this)),e.find("a.convert-currency").click(this._convertCurrency.bind(this)),e.find(".inventory-body .item-uses span.text-box.value").on("wheel",this._setFeatUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setFeatUses.bind(this))})),e.find(".attacks-body .item-uses span.text-box.value").on("wheel",this._setFeatUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setFeatUses.bind(this))})),e.find(".feats-body .item-uses span.text-box.value").on("wheel",this._setFeatUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setFeatUses.bind(this))})),e.find(".level-up").click(this._onLevelUp.bind(this)),e.find(".item-list .spell-uses span.text-box[data-type='amount']").on("wheel",this._setSpellUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setSpellUses.bind(this))})),e.find(".item-list .spell-uses span.text-box[data-type='max']").on("wheel",this._setMaxSpellUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setMaxSpellUses.bind(this))})),e.find(".spell-uses .spell-slots.spontaneous span.text-box").on("wheel",this._adjustActorPropertyBySpan.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._adjustActorPropertyBySpan.bind(this))})),e.find(".spell-uses .spell-max span.text-box").on("click",(e=>{this._onSpanTextInput(e,this._onSubmit.bind(this))})),e.find(".spell-points-current .value span.text-box").on("wheel",this._adjustActorPropertyBySpan.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._adjustActorPropertyBySpan.bind(this))})),e.find(".spellcasting-concentration.rollable").click(this._onRollConcentration.bind(this)),e.find(".spellcasting-cl.rollable").click(this._onRollCL.bind(this)),e.find(".item-detail.item-active input[type='checkbox']").off("change").on("change",this._setItemActive.bind(this)),e.find(".item-detail.item-level span.text-box").on("wheel",this._setBuffLevel.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setBuffLevel.bind(this))})),e.find("a.hide-show").click(this._hideShowElement.bind(this)),e.find(".condition .checkbox").click(this._onToggleCondition.bind(this)),e.find(".skill-lock-button").on("click",this._onToggleSkillLock.bind(this)),e.find('a[data-action="compendium"]').click(this._onOpenCompendium.bind(this))):e.find("span.text-box").addClass("readonly")}_onSpanTextInput(e,t=null){const s=e.currentTarget,n=s.parentElement,l=document.createElement("INPUT");l.type="text",s.dataset?.dtype&&(l.dataset.dtype=s.dataset.dtype);let c=s.innerText;s.classList.contains("placeholder")&&(c="");const u=s.classList.contains("no-value-cap"),d=s.getAttribute("name");let m;if(d&&(l.setAttribute("name",d),c=getProperty(this.document,d)??"",c&&"string"!=typeof c&&(c=c.toString()),d.endsWith(".value")&&!u)){const e=d.replace(/\.value$/,".max");m=getProperty(this.document,e)}l.value=c;const h=["placeholder","direct","allow-relative"];for(const e of s.classList)h.includes(e)||l.classList.add(e);const g=s.classList.contains("allow-relative"),y=parseFloat(s.dataset.clearValue||"0");n.replaceChild(l,s);let b=!1;l.addEventListener("keypress",(e=>{if("Enter"===e.key){if(b=!0,g){const e=adjustNumberByStringCommand(parseFloat(c),l.value,m,y);l.value=e}l.value.toString()===c.toString()?this.render():"function"==typeof t&&t.call(this,e)}})),l.addEventListener("focusout",(e=>{if(!b){if(b=!0,g&&parseFloat(c)!==parseFloat(l.value)){const e=adjustNumberByStringCommand(parseFloat(c),l.value,m,y);l.value=e}l.value.toString()===c.toString()?this.render():"function"==typeof t&&t.call(this,e)}})),l.focus(),l.select()}_moveTooltips(e){const t=$(e.currentTarget),s=e.clientX,n=e.clientY+24;t.find(".tooltip:hover .tooltipcontent").css("left",s+"px").css("top",n+"px")}_onDragSkillStart(e){const t=e.currentTarget;let s=t.closest(".sub-skill"),n=null,l=null,c=!0;if(s||(s=t.closest(".skill"),c=!1),!s)return;c?(n=s.dataset.mainSkill,l=s.dataset.skill):n=s.dataset.skill;const u={type:"skill",uuid:this.document.uuid,skill:l?`${n}.subSkills.${l}`:n};e.dataTransfer.setData("text/plain",JSON.stringify(u))}_onDragMiscStart(e,t,s){const n={type:t,uuid:this.document.uuid};switch(t){case"bab":case"cmb":case"initiative":case"defenses":break;case"concentration":case"cl":{const t=e.currentTarget.closest(".tab.spellbook-group");n.bookId=t.dataset.tab;break}case"abilityScore":n.ability=s;break;case"attack":n.attack=s;break;default:throw Error("Unrecognized drag source: "+t)}e.dataTransfer.setData("text/plain",JSON.stringify(n))}_onDragSaveStart(e,t){const s={type:"save",save:t,uuid:this.document.uuid};e.dataTransfer.setData("text/plain",JSON.stringify(s))}_initializeFilterItemList(e,t){const s=this._filters[t.dataset.filter],n=t.querySelectorAll(".filter-item");for(const e of n)s.has(e.dataset.filter)&&e.classList.add("active")}_onRest(e){e.preventDefault();const t=Object.values(this.document.apps).find((e=>e instanceof ActorRestDialog&&e._element));t?t.render(!0,{focus:!0}):new ActorRestDialog(this.document).render(!0)}_onItemRoll(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.closest(".item").dataset.itemId,s=this.document.items.get(t);if(null!=s)return s.displayCard(void 0,{token:this.token})}_mouseWheelAdd(e,t){const s="INPUT"===t.tagName,{originalEvent:n}=e;if(n&&n instanceof WheelEvent&&n.ctrlKey){e.preventDefault();const l=parseFloat(s?t.value:t.innerText)||0;if(Number.isNaN(l))return;const c=-Math.sign(n.deltaY),u=parseFloat(t.dataset.wheelStep)||1;s?t.value=l+u*c:t.innerText=""+(l+u*c)}}_setFeatUses(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget,s=t.closest(".item").dataset.itemId,n=this.document.items.get(s);this._mouseWheelAdd(e,t);const l="INPUT"===t.tagName?Number(t.value):Number(t.innerText);this.setItemUpdate(n.id,"system.uses.value",l),e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._updateItems()})):this._updateItems()}_setSpellUses(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget,s=e.currentTarget.closest(".item").dataset.itemId,n=this.document.items.get(s);this._mouseWheelAdd(e,t);const l=n.system.preparation?.preparedAmount,c="INPUT"===t.tagName?Number(t.value):Number(t.innerText);if(this.setItemUpdate(n.id,"system.preparation.preparedAmount",c),l<c){const e=n.system.preparation.maxAmount;this.setItemUpdate(n.id,"system.preparation.maxAmount",Math.max(e,c))}e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._updateItems()})):this._updateItems()}_setMaxSpellUses(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget,s=t.closest(".item").dataset.itemId,n=this.document.items.get(s);this._mouseWheelAdd(e,t);const l=n.system.preparation?.maxAmount,c="INPUT"===t.tagName?Number(t.value):Number(t.innerText);if(this.setItemUpdate(n.id,"system.preparation.maxAmount",Math.max(0,c)),l>c){const e=n.system.preparation.preparedAmount;this.setItemUpdate(n.id,"system.preparation.preparedAmount",Math.min(e,c))}c<0&&("INPUT"===t.tagName?t.value=0:t.innerText=0),e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._updateItems()})):this._updateItems()}_adjustActorPropertyBySpan(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget;this._mouseWheelAdd(e,t);const s="INPUT"===t.tagName?t.value:t.innerText;let n="String"===t.dataset.dtype?s:Number(s);const l=t.getAttribute("name");l.match(/^system\.abilities\.([a-zA-Z0-9]+)\.value$/)&&(n=Number.isNaN(parseInt(n))?null:parseInt(n)),l&&(this._pendingUpdates[l]=n),e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._onSubmit(e)})):this._onSubmit(e)}_setBuffLevel(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget,s=t.closest(".item").dataset.itemId,n=this.document.items.get(s);this._mouseWheelAdd(e,t);const l="INPUT"===t.tagName?Number(t.value):Number(t.innerText),c=t.getAttribute("name");c&&(this._pendingUpdates[c]=l),this.setItemUpdate(n.id,"system.level",l),e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._updateItems()})):this._updateItems()}_hideShowElement(e){e.preventDefault();const t=e.currentTarget,s=this.element.find("."+t.dataset.for);s.hasClass("hidden")?($(t).find("i").removeClass("fa-arrow-circle-down").addClass("fa-arrow-circle-up"),s.removeClass("hidden"),s.hide(),s.slideDown(200),this._hiddenElems[t.dataset.for]=!1):($(t).find("i").removeClass("fa-arrow-circle-up").addClass("fa-arrow-circle-down"),s.slideUp(200,(()=>s.addClass("hidden"))),this._hiddenElems[t.dataset.for]=!0)}_onToggleCondition(e){e.preventDefault();const t=e.currentTarget.name,s=!getProperty(this.actor,t),n=t.replace(/(\w+)$/,(e=>"-="+e)),l=s?{[t]:!0}:{[n]:null};this.actor.update(l)}_onToggleSkillLock(e){e.preventDefault(),this._skillsLocked=!this._skillsLocked;const t=e.currentTarget;t.classList.toggle("unlocked",!this._skillsLocked);const s=t.closest(".tab");s.classList.toggle("locked",this._skillsLocked),s.querySelectorAll(".lockable").forEach((e=>{["INPUT","SELECT"].includes(e.tagName)?e.disabled=this._skillsLocked:e.classList.toggle("hide-contents",this._skillsLocked)}))}_onOpenCompendium(e){e.preventDefault();const t=e.currentTarget.dataset.actionTarget;ffd20.applications.compendiums[t].render(!0,{focus:!0})}_onRollConcentration(e){e.preventDefault();const t=$(e.currentTarget).closest(".spellbook-group").data("tab");this.document.rollConcentration(t,{token:this.token})}_onRollCL(e){e.preventDefault();const t=$(e.currentTarget).closest(".spellbook-group").data("tab");this.document.rollCL(t,{token:this.token})}_setItemActive(e){e.preventDefault();const t=e.currentTarget.closest(".item").dataset.itemId,s=this.document.items.get(t),n=$(e.currentTarget).prop("checked");this.setItemUpdate(s.id,"system.active",n),this._updateItems()}_onLevelUp(e){e.preventDefault;const t=e.currentTarget.closest(".item").dataset.itemId,s=this.actor.items.get(t),n=Object.values(this.actor.apps).find((e=>e instanceof LevelUpForm&&e._element&&e.object===s));n?n.render(!0,{focus:!0}):new LevelUpForm(s,{token:this.token}).render(!0)}_onItemSummary(e){e.preventDefault();const t=$(e.currentTarget).parents(".item");this.openItemSummary(t)}openItemSummary(e,{instant:t=!1}={}){const s=e.attr("data-item-collection")??"items",n=e.attr("data-item-id"),l=this.document[s].get(n),{description:c,properties:u}=l.getChatData({chatcard:!1});if(this._expandedItems=this._expandedItems.filter((e=>e!==n)),e.hasClass("expanded")){const s=e.children(".item-summary");t?s.remove():s.slideUp(200,(()=>s.remove()))}else{const s=$(`<div class="item-summary">${c}</div>`),l=$('<div class="item-properties tag-list"></div>');u.forEach((e=>l.append(`<span class="tag">${e}</span>`))),s.append(l),t?e.append(s):(e.append(s.hide()),s.slideDown(200)),this._expandedItems.push(n)}e.toggleClass("expanded")}_onInputText(e){e.preventDefault();let t;if(e.currentTarget.dataset.for.match(/CHILD-([0-9]+)/)){const s=parseInt(RegExp.$1);t=$(e.currentTarget.children[s])}else t=this.element.find(e.currentTarget.dataset.for);if(!t||t&&t.attr("disabled"))return;t.prop("readonly",!1),t.attr("name",e.currentTarget.dataset.attrName);const s=getProperty(this.document,e.currentTarget.dataset.attrName);t.attr("value",s);const n=e&&e instanceof WheelEvent;n?this._mouseWheelAdd(e,t[0]):t.select();const handler=e=>{n?t[0].removeEventListener("mouseout",handler):(t[0].removeEventListener("focusout",handler),t[0].removeEventListener("keydown",keyHandler)),t[0].removeEventListener("click",handler),("string"==typeof s&&s!==t[0].value||"number"==typeof s&&s!==parseInt(t[0].value))&&(l=!0),l?this._onSubmit(e):this.render()},keyHandler=e=>{"Enter"===e.key&&(l=!0,handler.call(this,e))};let l=!1;n?(t[0].addEventListener("mouseout",handler),l=!0):(t[0].addEventListener("focusout",handler),t[0].addEventListener("keydown",keyHandler)),t[0].addEventListener("click",handler)}async _onArbitrarySkillCreate(e){e.preventDefault();const t=$(e.currentTarget).parents(".skill").attr("data-skill"),s=this.document.system.skills[t],n={name:game.i18n.format("DOCUMENT.New",{type:game.i18n.localize("FFD20.Skill")}),ability:s.ability,rank:0,rt:s.rt,cs:s.cs,acp:s.acp};let l=1,c=`${t}${l}`;for(;null!=s.subSkills[c];)l++,c=`${t}${l}`;const u={};return u[`system.skills.${t}.subSkills.${c}`]=n,this.document.testUserPermission(game.user,"OWNER")&&await this.document.update(u),this._editSkill(t,c)}async _onSkillCreate(e){e.preventDefault();const t="true"===$(e.currentTarget).parents(".skills-list").attr("data-background"),s={name:game.i18n.format("DOCUMENT.New",{type:game.i18n.localize("FFD20.Skill")}),ability:"int",rank:0,mod:0,rt:!1,cs:!1,acp:!1,background:t,custom:!0};let n=createTag(s.name||"skill"),l=1;for(;null!=this.document.system.skills[n];)l++,n=createTag(s.name||"skill")+l.toString();const c={};return c["system.skills."+n]=s,this.document.testUserPermission(game.user,"OWNER")&&await this.document.update(c),this._editSkill(n)}_editSkill(e,t){return new Promise((s=>{const n=new ffd20.applications.SkillEditor(this.document,e,t);n.addCallback(s),n.render(!0)}))}_onSkillEdit(e){e.preventDefault();const t=$(e.currentTarget).parents(".sub-skill").attr("data-main-skill")??$(e.currentTarget).parents(".skill").attr("data-skill"),s=$(e.currentTarget).parents(".sub-skill").attr("data-skill");return this._editSkill(t,s)}_onArbitrarySkillDelete(e){e.preventDefault();const t=$(e.currentTarget).parents(".sub-skill").attr("data-main-skill"),s=this.document.system.skills[t],n=$(e.currentTarget).parents(".sub-skill").attr("data-skill"),l=s?.subSkills?.[n],c=`${ffd20.config.skills[t]??s.name} (${l.name})`,deleteSkill=()=>{const e={};e[`system.skills.${t}.subSkills.-=${n}`]=null,this.document.update(e)};if(getSkipActionPrompt())deleteSkill();else{const e=`<p>${game.i18n.localize("FFD20.DeleteSkillConfirmation")}</p>`;Dialog.confirm({title:game.i18n.format("FFD20.DeleteSkillTitle",{name:c}),content:e,yes:()=>{deleteSkill()},rejectClose:!0})}}_onSkillDelete(e){if(e.preventDefault(),!this.document.testUserPermission(game.user,"OWNER"))return;const t=$(e.currentTarget).parents(".skill").attr("data-skill"),s=this.document.system.skills[t],n=ffd20.config.skills[t]??s.name,deleteSkill=()=>{const e={};e["system.skills.-="+t]=null,this.document.update(e)};if(getSkipActionPrompt())deleteSkill();else{const e=`<p>${game.i18n.localize("FFD20.DeleteSkillConfirmation")}</p>`;Dialog.confirm({title:game.i18n.format("FFD20.DeleteSkillTitle",{name:n}),content:e,yes:()=>{deleteSkill()},rejectClose:!0})}}async _onRaceControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("edit"))this._onItemEdit(e);else if(this.isEditable)if(t.classList.contains("add")){const e={name:"New Race",type:"race"};this.document.createEmbeddedDocuments("Item",[e])}else t.classList.contains("delete")&&this._onItemDelete(e)}async _onPointBuyCalculator(e){e.preventDefault();const t=Object.values(this.document.apps).find((e=>e instanceof PointBuyCalculator&&e._element));t?t.render(!0,{focus:!0}):new PointBuyCalculator(this.document).render(!0)}async _onSensesSelector(e){e.preventDefault();const t=Object.values(this.document.apps).find((e=>e instanceof ffd20.applications.SensesSelector&&e._element));t?t.render(!0,{focus:!0}):new ffd20.applications.SensesSelector(this.document).render(!0)}async _onControlAlignment(e){e.preventDefault();const t=e.currentTarget,s=Object.entries(ffd20.config.alignmentsShort).reduce(((e,t)=>(e.push({value:t[0],label:game.i18n.localize(t[1])}),e)),[]);new Widget_ItemPicker((e=>{this.document.update({"system.details.alignment":e})}),{items:s,columns:3}).render($(t))}_itemActivationControl(e){e.preventDefault();const t=e.currentTarget.closest(".item[data-item-id]").dataset.itemId;this.document.items.get(t).use({ev:e,token:this.token})}async _quickChangeItemQuantity(e,t=1){e.preventDefault();const s=$(e.currentTarget).parents(".item").attr("data-item-id"),n=this.document.items.get(s),l=n.system.quantity||0;let c=Math.max(0,l+t);"container"===n.type&&(c=Math.min(c,1)),this.setItemUpdate(n.id,"system.quantity",c),this._updateItems()}async _quickEquipItem(e){e.preventDefault();const t=$(e.currentTarget).parents(".item").attr("data-item-id"),s=this.document.items.get(t);hasProperty(s,"system.equipped")&&(this.setItemUpdate(s.id,"system.equipped",!s.system.equipped),this._updateItems())}async _quickCarryItem(e){e.preventDefault();const t=$(e.currentTarget).parents(".item").attr("data-item-id"),s=this.document.items.get(t);hasProperty(s,"system.carried")&&s.update({"system.carried":!s.system.carried})}async _quickIdentifyItem(e){if(e.preventDefault(),!game.user.isGM)return void ui.notifications.error(game.i18n.localize("FFD20.ErrorCantIdentify"));const t=e.currentTarget.closest(".item").dataset.itemId,s=this.document.items.get(t);hasProperty(s,"system.identified")&&s.update({"system.identified":!s.system.identified})}async _itemToggleData(e){e.preventDefault();const t=e.currentTarget,s=$(t).parents(".item").attr("data-item-id"),n=this.document.items.get(s),l=$(t).attr("name")||t.dataset.name,c={};c[l]=!getProperty(n,l),n.update(c)}async _duplicateItem(e){e.preventDefault();const t=e.currentTarget.closest(".item[data-item-id]").dataset.itemId,s=this.document.items.get(t).toObject();delete s._id,s.system.links?.children&&delete s.system.links.children;s.name=s.name.replace(/\s+\(\d+\)$/,""),s.name=(e=>{let t,s=1;do{s+=1,t=`${e} (${s})`}while(this.actor.items.getName(t));return t})(s.name),this.document.createEmbeddedDocuments("Item",[s])}_quickAction(e){e.preventDefault();const t=e.currentTarget.dataset.itemId,s=this.document.items.get(t);if(s)return s.use({token:this.token})}_convertCurrency(e){e.preventDefault();const t=e.currentTarget,s=t.dataset.type,n=t.dataset.category;this.document.convertCurrency(n,s)}_onItemCreate(e){e.preventDefault();const t=e.currentTarget,s=t.dataset.type;t.dataset.subType;const n=t.dataset.typeName||game.i18n.localize(ffd20.config.itemTypes[s]||s),l={name:game.i18n.format("FFD20.NewItem",{type:n}),type:s,system:duplicate(t.dataset)};delete l.system.type,delete l.system.tooltip,delete l.system.typeName,"spell"===s&&"string"==typeof l.system?.level&&(l.system.level=parseInt(l.system.level));const c=new Item.implementation(l);this._sortNewItem(c),c.subType;const u=this.actor.itemTypes[s].filter((e=>this._isItemSameSubGroup(c,e))).sort(((e,t)=>t.sort-e.sort));if(u.length){const e=c.name;let t=e,s=2;const n=new Set(u.map((e=>e.name)));for(;n.has(t);)t=`${e} (${s++})`;t!==c.name&&c.updateSource({name:t})}return this.document.createEmbeddedDocuments("Item",[c.toObject()])}_onItemEdit(e){e.preventDefault();const t=e.currentTarget.closest(".item"),s=this.document.items.get(t.dataset.itemId);Object.values(s.apps).find((e=>e instanceof ItemSheet&&e.document===s&&null!=e._element)),s.sheet.render(!0,{focus:!0})}_onItemDelete(e){e.preventDefault();const t=e.currentTarget;if(t.disabled)return;const s=e.currentTarget.closest(".item"),n=this.document.items.get(s.dataset.itemId);if(getSkipActionPrompt())n.delete();else{t.disabled=!0;const e=`<p>${game.i18n.localize("FFD20.DeleteItemConfirmation")}</p>`;Dialog.confirm({title:game.i18n.format("FFD20.DeleteItemTitle",{name:n.name}),content:e,yes:()=>{n.delete(),t.disabled=!1},no:()=>t.disabled=!1,rejectClose:!0}).then(null,(()=>t.disabled=!1))}}async _onItemGive(e){e.preventDefault();const t=e.currentTarget.closest(".item").dataset.itemId,s=this.document.items.get(t),n=game.actors.contents.filter((e=>e.testUserPermission(game.user,"OWNER")&&e!==this.document));n.push(...this.document.items.filter((e=>"container"===e.type))),n.push(...game.items.contents.filter((e=>e.testUserPermission(game.user,"OWNER")&&"container"===e.type))),n.push(...game.actors.contents.filter((e=>e.hasPlayerOwner&&e!==this.document&&!e.testUserPermission(game.user,"OWNER"))));const l=await dialogGetActor("Give item to actor",n);if(!l)return;let c;if("actor"===l.type?c=game.actors.get(l.id):"item"===l.type&&(c=this.document.items.get(l.id),c||(c=game.items.get(l.id))),c&&c!==s){const e=s.toObject();if(c instanceof Actor){if(!c.testUserPermission(game.user,"OWNER"))return void game.socket.emit("system.ffd20",{eventType:"giveItem",targetActor:c.uuid,item:s.uuid});await c.createEmbeddedDocuments("Item",[e])}else c instanceof Item&&await c.createContainerContent(e);await this.document.deleteEmbeddedDocuments("Item",[s.id])}}async _onItemSplit(e){e.preventDefault();const t=e.currentTarget.closest(".item").dataset.itemId,s=this.document.items.get(t);new Dialog({title:game.i18n.format("FFD20.Dialog.SplitItem.Title",{name:s.name}),content:`<p>${game.i18n.format("FFD20.Dialog.SplitItem.Desc")}</p><input type="text" name="value" value="1" />`,buttons:{split:{label:game.i18n.localize("FFD20.Split"),callback:async e=>{let t=parseInt(e.find('[name="value"]').val());if(t=Math.min(s.system.quantity-1,Math.max(0,t)),t>0){await s.update({"system.quantity":Math.max(0,s.system.quantity-t)});const e=s.toObject();e.system.quantity=t,await CONFIG.Item.documentClass.createDocuments([e],{parent:this.document})}}}},default:"split"},{classes:[...Dialog.defaultOptions.classes,"ffd20","item-split"]}).render(!0)}_onSubmitElement(e){if("Enter"===e.key){const t=e.currentTarget;if(t.name){const s=getProperty(this.document.system,t.name);("number"==typeof s&&s===parseFloat(t.value)||"string"==typeof s&&s===t.value)&&this._onSubmit(e)}}}_onRollAbilityTest(e){e.preventDefault();const t=e.currentTarget.closest(".ability").dataset.ability;this.document.rollAbilityTest(t,{token:this.token})}_onRollBAB(e){e.preventDefault(),this.document.rollBAB({token:this.token})}_onRollMelee(e){e.preventDefault(),this.document.rollAttack({melee:!0,token:this.token})}_onRollRanged(e){e.preventDefault(),this.document.rollAttack({melee:!1,token:this.token})}_onRollCMB(e){e.preventDefault(),this.document.rollCMB({token:this.token})}_onRollInitiative(e){e.preventDefault(),this.document.rollInitiative({createCombatants:!0,rerollInitiative:game.user.isGM,token:this.token})}_onRollSavingThrow(e){e.preventDefault();const t=e.currentTarget.parentElement.dataset.savingthrow;this.document.rollSavingThrow(t,{token:this.token})}_prepareItems(e){const t={weapon:{label:game.i18n.localize("FFD20.InventoryWeapons"),canCreate:!0,hasActions:!0,items:[],canEquip:!0,dataset:{type:"weapon"}},equipment:{label:game.i18n.localize("FFD20.InventoryArmorEquipment"),canCreate:!0,hasActions:!0,items:[],canEquip:!0,dataset:{type:"equipment"},hasSlots:!0},consumable:{label:game.i18n.localize("FFD20.InventoryConsumables"),canCreate:!0,hasActions:!0,items:[],canEquip:!1,dataset:{type:"consumable"}},gear:{label:ffd20.config.lootTypes.gear,canCreate:!0,hasActions:!1,items:[],canEquip:!0,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeGearSingle"),"sub-type":"gear"}},ammo:{label:ffd20.config.lootTypes.ammo,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeAmmoSingle"),"sub-type":"ammo"}},misc:{label:ffd20.config.lootTypes.misc,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.Misc"),"sub-type":"misc"}},tradeGoods:{label:ffd20.config.lootTypes.tradeGoods,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeTradeGoodsSingle"),"sub-type":"tradeGoods"}},container:{label:game.i18n.localize("FFD20.InventoryContainers"),canCreate:!0,hasActions:!1,items:[],dataset:{type:"container","type-name":game.i18n.localize("ITEM.TypeContainer")}}};let[s,n,l,c,u]=e.items.reduce(((e,t)=>("spell"===t.type?e[1].push(t):"feat"===t.type?e[2].push(t):"class"===t.type?e[3].push(t):"attack"===t.type?e[4].push(t):t.document.isPhysical&&e[0].push(t),e)),[[],[],[],[],[]]);s=this._filterItems(s,this._filters.inventory,this._filters.search.inventory),l=this._filterItems(l,this._filters.features);let d=!1;const m={},h=e.system.attributes.spells.spellbooks;for(const[t,s]of Object.entries(h)){if(m[t]={orig:s,inUse:s.inUse},!s.inUse)continue;let l=n.filter((e=>e.spellbook===t));l=this._filterItems(l,this._filters["spellbook-"+t]),m[t].data=this._prepareSpellbook(e,l,t),m[t].prepared=l.filter((e=>"prepared"===e.preparation.mode&&e.preparation.prepared)).length,m[t].rollData=e.rollData.spells[t],m[t].class=e.rollData.classes[s.class],s.arcaneSpellFailure&&(d=!0)}if(d){const t=[],s=this.actor.items.filter((e=>"equipment"===e.type&&!0===e.system.equipped)).reduce(((e,s)=>{const n=s.system.spellFailure??0;return n>0?(t.push({item:s,asf:n}),e+n):e}),0);e.asf={total:s,sources:t}}const g=getWeightSystem();for(const e of s){const s="loot"===e.type?e.subType||"gear":e.subType;e.quantity=e.quantity||0,e.totalWeight=Math.roundDecimals(e.weight.converted.total,1),e.units="metric"===g?game.i18n.localize("FFD20.Kgs"):game.i18n.localize("FFD20.Lbs"),null!=t[e.type]&&t[e.type].items.push(e),"loot"===e.type&&t[s]?.items.push(e)}const y={},b={items:[],canCreate:!0,hasActions:!0},F=this.constructor.featTypeData;for(const[e,t]of Object.entries(ffd20.config.featTypes))y[e]=mergeObject(b,{label:ffd20.config.featTypesPlurals[e]??t,dataset:{type:"feat","type-name":game.i18n.localize(t),"sub-type":e},...F[e]},{inplace:!1});for(const e of l){const t=e.subType;e.abilityType&&"none"!==e.abilityType?(e.abilityTypeShort=ffd20.config.abilityTypes[e.abilityType].short,e.abilityType=ffd20.config.abilityTypes[e.abilityType].long):(e.abilityTypeShort="",e.abilityType=""),y[t]?.items?.push(e)}c.sort(((e,t)=>t.level-e.level)),c.forEach((e=>{"mythic"!==e.subType&&(e.canLevelUp=!0)}));let k=e.items.filter((e=>"buff"===e.type));k=this._filterItems(k,this._filters.buffs);const v={};Object.entries(ffd20.config.buffTypes).forEach((([e,t])=>{v[e]={label:t,items:[],hasActions:!0,dataset:{type:"buff","sub-type":e}}}));for(const e of k)v[e.subType]?.items.push(e);u=this._filterItems(u,this._filters.attacks);const D={weapon:{label:game.i18n.localize("FFD20.AttackTypeWeaponPlural"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"weapon"}},natural:{label:game.i18n.localize("FFD20.AttackTypeNaturalPlural"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"natural"}},ability:{label:game.i18n.localize("FFD20.AttackTypeAbilityPlural"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"ability"}},racialAbility:{label:game.i18n.localize("FFD20.AttackTypeRacialPlural"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"racialAbility"}},item:{label:game.i18n.localize("FFD20.Items"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"item"}},misc:{label:game.i18n.localize("FFD20.Misc"),items:[],canCreate:!0,initial:!1,showTypes:!1,dataset:{type:"attack","sub-type":"misc"}}};for(const e of u){const t=e.subType;D[t]?D[t].items.push(e):console.warn(`Attack for unrecognized subtype "${t}"`)}{const e=[{key:"inventory",section:t},{key:"features",section:y},{key:"buffs",section:v},{key:"attacks",section:D}];for(const[t,s]of Object.entries(m))s.inUse&&e.push({key:"spellbook-"+t,section:s.data});for(const t of e)for(const[e,s]of Object.entries(t.section)){const n=this._typeFilterCount(this._filters[t.key]);n>0&&0===s.items.length&&(s._hidden=!0),1===n&&this._filters[t.key].has("type-"+e)&&(s._hidden=!1)}}e.inventory=t,e.spellbookData=m,e.features=y,e.buffs=v,e.attacks=D,e.classes=c,e.quickActions=this.document.getQuickActions()}_onRollSkillCheck(e){e.preventDefault();const t=e.currentTarget.parentElement.dataset.skill;this.document.rollSkill(t,{token:this.token})}_onRollSubSkillCheck(e){e.preventDefault();const t=e.currentTarget.parentElement.dataset.mainSkill,s=e.currentTarget.parentElement.dataset.skill;this.document.rollSkill(`${t}.subSkills.${s}`,{token:this.token})}async _onOpenCompendiumEntry(e){const t=e.currentTarget.dataset.compendiumEntry,s=await fromUuid(t);s instanceof JournalEntryPage?s.parent.sheet.render(!0,{pageId:s.id}):s.sheet.render(!0)}_onToggleFilter(e){e.preventDefault();const t=e.currentTarget,s=this._filters[t.parentElement.dataset.filter],n=t.dataset.filter,l=this._typeFilterCount(s);if(game.settings.get("ffd20","invertSectionFilterShiftBehaviour")?!e.shiftKey:e.shiftKey)for(const e of Array.from(s))e.startsWith("type-")&&(e!==n||l>1)&&s.delete(e);s.has(n)?s.delete(n):s.add(n),this.render()}_searchFilterCommit(e){const t=this.actor,s=this._filters.search[e.target.dataset.category].toLowerCase(),n=e.target.dataset.category;if(this.effectiveSearch[n]===s&&!this.searchRefresh)return;this.effectiveSearch[n]=s,this.searchRefresh=!1;$(e.target).closest(".tab").find(".item-list .item").each((function(){const e=$(this);if(s?.length>0){(e=>e.toLowerCase().includes(s))(t.items.get(this.dataset.itemId).name)?e.show():e.hide()}else e.show()}))}_clearSearch(e){const t=$(e.target).prev(".search-input");this._filters.search[t.get(0).dataset.category]="",t.val("").change()}_searchFilterCompositioning(e){this.searchCompositioning="compositionstart"===e.type}_searchFilterChange(e){e.preventDefault(),e.stopPropagation();const t=e.target.value,s=e.target.dataset.category,n=this._filters.search[s]!==t;(this.searchCompositioning||n)&&clearTimeout(this.searchDelayEvent),this.searchCompositioning||(this._filters.search[s]=t,"keyup"===e.type?n&&(this.searchDelayEvent=setTimeout((()=>this._searchFilterCommit(e)),this.searchDelay)):this._searchFilterCommit(e))}_onTraitSelector(e){e.preventDefault();const t=e.currentTarget,s=t.parentElement.querySelector("label"),n=t.dataset.options in ffd20.registry?ffd20.registry[t.dataset.options].getLabels():ffd20.config[t.dataset.options],l={name:s.getAttribute("for"),title:s.innerText,subject:t.dataset.options,choices:n};let c=Object.values(this.document.apps).find((e=>e instanceof ActorTraitSelector&&e.options.name===l.name));c??=new ActorTraitSelector(this.document,l),c.render(!0,{focus:!0})}_onResistanceSelector(e){e.preventDefault();const t=e.currentTarget,s={name:t.getAttribute("for"),title:t.innerText,fields:t.dataset.fields,dtypes:t.dataset.dtypes,isDR:"dr"===t.dataset.options},n=Object.values(this.document.apps).find((e=>e instanceof ActorResistanceSelector&&e.options.name===s.name&&e._element));n?n.render(!0,{focus:!0}):new ActorResistanceSelector(this.document,s).render(!0)}setItemUpdate(e,t,s){let n=this._itemUpdates.filter((t=>t._id===e))[0];null==n&&(n={_id:e},this._itemUpdates.push(n)),n[t]=s}async _render(...e){let t=this.element.find(":focus");t=t.length?t[0]:null,t?.name?.match(/^system\.skills\.(?:[a-zA-Z0-9]*)\.name$/)&&t.blur();const s=await super._render(...e);return this._createPlaceholders(this.element),this.element,game.settings.get("ffd20","accessibilityConfig"),s}async _renderInner(...e){const t=await super._renderInner(...e);for(const e of this._expandedItems)if(this.object.items.has(e)){const s=t.find(`.item-list>.item[data-item-id="${e}"]`);s.length&&this.openItemSummary(s,{instant:!0})}else this._expandedItems.findSplice((t=>t===e));return t}async _onSubmit(e,{updateData:t=null,preventClose:s=!1,preventRender:n=!1}={}){e.preventDefault(),this._submitQueued=!1,this._itemUpdates?.length&&(n=!0),await super._onSubmit(e,{updateData:t,preventClose:s,preventRender:n}),await this._updateItems()}async _updateItems(){const e=this._itemUpdates;this._itemUpdates=[];for(const t of e){const e=this.document.items.get(t._id);e?(e.memorizeVariables(),delete t._id,await e.update(t)):console.error("Item update for non-existing item:",t._id,t)}}async _onDropCurrency(e,t){let s=await fromUuid(t.actorUuid||"");s instanceof Actor||(s=s?.actor);const{currency:n,amount:l,containerId:c,alt:u}=t;return new CurrencyTransfer({actor:s,container:c,alt:u},{actor:this.actor,amount:Object.fromEntries([[n,parseInt(l)]])}).render(!0)}async _onDropItem(e,t){if(!this.actor.isOwner)return!1;const s=await ItemPF.implementation.fromDropData(t),n=s.toObject();let l=await fromUuid(t.actorUuid||"");l instanceof Actor||(l=l?.actor);if(s.actor===this.actor&&!t.containerId)return this._onSortItem(e,n);this._alterDropItemData(n);const c=await this._onDropItemCreate(n);if(t.containerId&&c?.length&&l===this.actor){const e=this.actor.allItems.find((e=>e.id===t.containerId));e&&e.deleteContainerContent(t.itemId)}return c}_alterDropItemData(e){"spell"===e.type&&(e.system.spellbook=this.currentSpellbookKey)}_isItemSameSubGroup(e,t){return"spell"===e.type?e.system.spellbook===t.system.spellbook&&e.system.level===t.system.level:!e.subType||e.subType===t.subType}_sortNewItem(e){const t=e.type,s=this.actor.itemTypes[t].filter((t=>this._isItemSameSubGroup(e,t))).sort(((e,t)=>t.sort-e.sort));s.length&&e.updateSource({sort:s[0].sort+CONST.SORT_INTEGER_DENSITY})}async _onDropItemCreate(e){const t=e instanceof Array?e:[e],s=[];for(const e of t){if(delete e._id,"spell"===e.type&&"spellbook"!==this.currentPrimaryTab){const t=await createConsumableSpellDialog(e);if("spell"!==t)return!!t&&this.document.createEmbeddedDocuments("Item",[t])}if(!("class"!==e.type||"mythic"===e.system.subType||event&&event.shiftKey)){if(await new Promise((t=>{new Dialog({title:game.i18n.localize("FFD20.AddClass"),content:`<div class="ffd20"><p>${game.i18n.localize("FFD20.Info.AddClassDialog_Desc")}</p><div class="help-text"><i class="fas fa-info-circle"></i> ${game.i18n.localize("FFD20.Info.AddClassDialog")}</div></div>`,buttons:{normal:{icon:'<i class="fas fa-hat-wizard"></i>',label:game.i18n.localize("FFD20.Normal"),callback:()=>{LevelUpForm.addClassWizard(this.actor,e).then((()=>{t(!0)}))}},raw:{icon:'<i class="fas fa-file"></i>',label:game.i18n.localize("FFD20.Raw"),callback:()=>{t(!1)}}},close:()=>{t(!0)}},{classes:[...Dialog.defaultOptions.classes,"ffd20","add-character-class"]}).render(!0)})))return!1}const t=new Item.implementation(e);this._sortNewItem(t),s.push(t.toObject())}return this.document.createEmbeddedDocuments("Item",s)}_canDragStart(e){return!e.includes(".denomination")||this.isEditable}_onDragStart(e){const t=e.target;if(t.classList.contains("denomination")){const s={actorUuid:this.actor.uuid,type:"Currency",alt:t.classList.contains("alt-currency"),currency:[...t.classList].find((e=>/[pgsc]p/.test(e))),amount:parseInt(t.nextElementSibling.textContent||t.nextElementSibling.value)};e.dataTransfer.setData("text/plain",JSON.stringify(s))}else t.dataset?.skill?this._onDragSkillStart(e):t.dataset?.attribute?this._onDragMiscStart(e,t.dataset.attribute):t.dataset?.drag?this._onDragMiscStart(e,t.dataset.drag):t.dataset?.savingthrow?this._onDragSaveStart(e,t.dataset.savingthrow):t.dataset?.ability?this._onDragMiscStart(e,"abilityScore",t.dataset.ability):t.dataset?.attack?this._onDragMiscStart(e,"attack",t.dataset.attack):super._onDragStart(e)}async _onConfigControl(t){t.preventDefault();const s=t.currentTarget,n=$(s).attr("for"),l=this.element;if($(s).css("display","none"),"cr"===n){const t=l.find('input[for="system.details.cr"]');t.attr("value",e.fromNumber(this.document.system.details.cr.base)),t.attr("name","system.details.cr.base"),t.prop("disabled",!1),t.focus(),t.select()}else if("spellSlots"===n){const e=$(s).closest(".spell-uses").find(".base");e.css("display","block"),e.focus(),e.select()}}_selectOnClick(e){e.preventDefault();e.currentTarget.select()}_updateObject(t,s){const n=s["system.details.cr.base"];"string"==typeof n&&(s["system.details.cr.base"]=e.fromString(n));{const e=this.element.find("*[data-name]"),t={};for(const s of e){const e=s.dataset.name;let n;"INPUT"===s.nodeName?n=s.value:"SELECT"===s.nodeName&&(n=s.options[s.selectedIndex].value),"Number"===s.dataset.dtype?n=Number(n):"Boolean"===s.dataset.dtype&&(n=!!n),getProperty(this.document.system,e)!==n&&(t[e]=n)}for(const[e,n]of Object.entries(t))s[e]=n}for(const[e,t]of Object.entries(this._pendingUpdates))s[e]=t;return this._pendingUpdates={},this.searchRefresh=!0,super._updateObject(t,s)}calculateTotalItemValue({inLowestDenomination:e=!1}={}){const t=this.document.items.filter((e=>null!=e.system.price)).reduce(((e,t)=>e+t.getValue({sellValue:1,inLowestDenomination:!0})),0);return e?t:t/100}calculateSellItemValue({inLowestDenomination:e=!1}={}){const t=this.document.items.filter((e=>null!=e.system.price)),s=this.document.getFlag("ffd20","sellMultiplier")||.5,n=t.reduce(((e,t)=>e+t.getValue({sellValue:s,inLowestDenomination:!0})),0);return e?n:n/100}_createPlaceholders(e){const t=e.find("span[data-placeholder]");for(const e of t)e.innerText||(e.classList.add("placeholder"),e.innerText=e.dataset.placeholder)}}class ActorSheetPFBasic extends ActorSheet{}class ActorSheetPFCharacter extends ActorSheetPF{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","sheet","actor","character"],width:800,height:840})}get template(){return!game.user.isGM&&this.actor.limited?"systems/ffd20/templates/actors/limited-sheet.hbs":"systems/ffd20/templates/actors/character-sheet.hbs"}async getData(){const e=await super.getData(),t=game.settings.get("ffd20","experienceConfig");e.disableExperience=t.disableExperienceTracking,e.minimumExperience=this.actor.getLevelExp(Math.max(0,(this.actor.system.details.level.value??0)-1)),e.hasClasses=this.actor.items.filter((e=>"class"===e.type)).length>0;const s=game.settings.get("ffd20","healthConfig");e.woundThresholds=s.variants.pc;const n=game.settings.get("ffd20","displayIteratives"),l=e.rollData.attributes.bab.total;if(n){const t=[l];for(let e=l-5;e>0;e-=5)t.push(e);e.iteratives="+"+t.join(" / +")}if("character"===this.actor.type&&!0!==game.settings.get("ffd20","experienceConfig").disableExperienceTracking&&e.hasClasses){const t=this.actor.system.details?.xp;t&&t.value>=t.max&&(e.levelUp=!0)}else e.levelUp=!0;return e}}class ActorSheetPFNPC extends ActorSheetPF{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","sheet","actor","npc"],width:800,height:840})}get template(){return!game.user.isGM&&this.actor.limited?"systems/ffd20/templates/actors/limited-sheet.hbs":"systems/ffd20/templates/actors/npc-sheet.hbs"}async getData(){const t=await super.getData();try{t.labels.cr=e.fromNumber(this.actor.system.details?.cr?.total)}catch(s){try{t.labels.cr=e.fromNumber(this.actor.system.details?.cr)}catch(s){t.labels.cr=e.fromNumber(1)}}const s=game.settings.get("ffd20","healthConfig");return t.woundThresholds=s.variants.npc,t.levelUp=!0,t}activateListeners(e){super.activateListeners(e),e.find("span.text-box.cr-input").on("click",(e=>{this._onSpanTextInput(e,this._adjustCR.bind(this))}))}_adjustCR(t){t.preventDefault();const s=t.currentTarget,n=e.fromString("INPUT"===s.tagName?s.value:s.innerText),l=s.getAttribute("name");l&&(this._pendingUpdates[l]=n),t.originalEvent instanceof MouseEvent?this._submitQueued||$(s).one("mouseleave",(e=>{this._onSubmit(e)})):this._onSubmit(t)}}class ActorSheetPFNPCLite extends ActorSheetPFNPC{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","sheet","actor","npc","lite"],width:440,height:640,tabs:[{navSelector:"nav.tabs",contentSelector:"section.primary-body",initial:"summary",group:"primary"}]})}get template(){return!game.user.isGM&&this.actor.limited?"systems/ffd20/templates/actors/limited-sheet.hbs":"systems/ffd20/templates/actors/npc-sheet-lite.hbs"}_prepareItems(e){const t={all:{label:game.i18n.localize("FFD20.ActionPlural"),items:e.items.filter((e=>"attack"===e.type)),canCreate:!0,initial:!0,showTypes:!0,dataset:{type:"attack","sub-type":"weapon"}}};e.attacks=t}}class ActorSheetPFNPCLoot extends ActorSheetPFNPC{static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","sheet","actor","npc","loot"],tabs:[{navSelector:"nav.tabs",contentSelector:"section.primary-body",initial:"inventory",group:"primary"}],width:620,height:420})}get template(){return"systems/ffd20/templates/actors/npc-sheet-loot.hbs"}get currentPrimaryTab(){return"inventory"}async getData(){const e=await super.getData();e.isLootSheet=!0,e.sellMultiplier=this.actor.getFlag("ffd20","sellMultiplier");const t=this.calculateTotalItemValue({inLowestDenomination:!0})+this.actor.mergeCurrency({inLowestDenomination:!0}),s=this.calculateSellItemValue({inLowestDenomination:!0})+this.actor.mergeCurrency({inLowestDenomination:!0});e.totalValue=splitCurrency(t),e.sellValue=splitCurrency(s),e.labels||(e.labels={}),e.labels.totalValue=game.i18n.format("FFD20.ItemContainerTotalValue",e.totalValue),e.labels.sellValue=game.i18n.format("FFD20.ItemContainerSellValue",e.sellValue);for(const t of Object.values(e.inventory))t.hasActions=!1,t.canEquip=!1,t.showValue=!0;return e}}class ActorSheetFlags extends DocumentSheet{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{id:"actor-flags",classes:["ffd20"],template:"systems/ffd20/templates/apps/actor-flags.hbs",width:500,closeOnSubmit:!0})}get title(){return`${game.i18n.localize("FFD20.FlagsTitle")}: ${this.object.name}`}getData(){const e=super.getData();return e.flags=this._getFlags(),e}_getFlags(){const e={};for(const[t,s]of Object.entries(ffd20.config.characterFlags)){Object.prototype.hasOwnProperty.call(e,s.section)||(e[s.section]={});const n=duplicate(s);n.type=s.type.name,n.isCheckbox=s.type===Boolean,n.isSelect=Object.prototype.hasOwnProperty.call(s,"choices"),n.value=this.document.getFlag("FFD20",t),e[s.section][t]=n}return e}_updateObject(e,t){const s=this.object,n={};for(const[e,s]of Object.entries(CONFIG.ffd20.characterFlags))[void 0,null,"",!1].includes(t[e])||s.type===Number&&0===t[e]?n["-="+e]=null:n[e]=t[e];s.update({"flags.ffd20":n})}}const ce=Object.freeze(Object.defineProperty({__proto__:null,ActorRestDialog,ActorSheetFlags,ActorSheetPF,ActorSheetPFBasic,ActorSheetPFCharacter,ActorSheetPFNPC,ActorSheetPFNPCLite,ActorSheetPFNPCLoot},Symbol.toStringTag,{value:"Module"}));class ScriptEditor extends FormApplication{constructor(e={}){super(e),this.command=e.command||"",this.name=e.name||null,this.parent=e.parent,this.isScriptCall=!0===e.scriptCall,this.name?this.options.title=this.parent?`${this.parent.name}: ${this.name}`:this.name:this.options.title=this.parent?.name??game.i18n.localize("FFD20.Unknown"),this._promises={submit:[]}}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","script-editor"],template:"systems/ffd20/templates/apps/script-editor.hbs",width:640,height:560})}getData(){const e={};return e.command=this.command||"",e.name=this.name,e.isScriptCall=this.isScriptCall,e.canEdit={name:this.isScriptCall},e}awaitResult(){let e;const t=new Promise((t=>{e=t}));return this._promises.submit.push({callback:e,promise:t,resolved:!1}),t}activateListeners(e){e.find('button[type="submit"]').click(this._onSubmit.bind(this)),e.find("a.help-browser[data-url]").click(this._openHelpBrowser.bind(this))}_openHelpBrowser(e){e.preventDefault();const t=e.currentTarget;ffd20.applications.helpBrowser.openUrl(t.dataset.url)}_updateObject(e,t){this.command=t.command,this.name=t.name||null;const s={command:this.command,name:this.name};this.resolvePromises("submit",s)}resolvePromises(e,t){for(const s of this._promises[e])s.resolved||(s.callback(t),s.resolved=!0)}async close(...e){super.close(...e),this.resolvePromises("submit",null)}}class Widget_CategorizedItemPicker extends Application{constructor(e,t,s,n){super(e),this.categories=t,this.selected=n,this.callback=s,this._hiddenElems={},e.classes?.length&&this.options.classes.push(...e.classes)}get template(){return"systems/ffd20/templates/widgets/categorized-item-picker.hbs"}getData(e){const t=super.getData(e);t.categories=[],t.items=[];for(const e of this.categories){t.categories.push({key:e.key,label:e.label});for(const s of e.items)t.items.push(mergeObject({category:e.key},s))}return t}activateListeners(e){e.find(".item").click(this._onClickItem.bind(this)),e.find(".category a").click(this._onClickCategory.bind(this)),this.selected?.category&&(e.find(`.category a[data-category="${this.selected.category}"]`).click(),this.selected?.item&&e.find(`.item[data-category="${this.selected.category}"][data-value="${this.selected.item}"]`).first().addClass("pre-select")),window.setTimeout((()=>{this._cancelCallback&&document.removeEventListener("click",this._cancelCallback),this._cancelCallback=this._onCancel.bind(this),document.addEventListener("click",this._cancelCallback)}),10)}static get defaultOptions(){const e=super.defaultOptions;return{...e,width:480,height:480,classes:[...e.classes,"ffd20","categorized-item-picker"]}}_onClickItem(e){e.preventDefault();const t=e.currentTarget.dataset.value;this.callback(t),this.close()}_onClickCategory(e){e.preventDefault();const t=e.currentTarget,s=$(this.element);s.find(".item-picker-categories").children().removeClass("active"),$(t).closest(".category").addClass("active"),s.find(".item-picker-items").children().hide(),s.find(`.item-picker-items .item[data-category="${t.dataset.category}"]`).show()}_onCancel(e){e.preventDefault();let t=e.target;if(t!==this.element[0]){for(;t.parentNode;){if(t===this.element[0])return;t=t.parentNode}this.close()}}async close(...e){return document.removeEventListener("click",this._cancelCallback),super.close(...e)}}Hooks.on("renderWidget_CategorizedItemPicker",((e,t,s)=>{t.find(".pre-select")[0]?.scrollIntoView({block:"nearest"})}));class ItemSheetPF extends ItemSheet{constructor(...e){super(...e),this.items=[],this._actionUpdates=[]}static get defaultOptions(){return mergeObject(super.defaultOptions,{width:580,classes:["ffd20","sheet","item"],scrollY:[".tab",".buff-flags",".editor-content"],dragDrop:[{dragSelector:"li.action-part",dropSelector:".tab.details"}],tabs:[{navSelector:"nav.tabs[data-group='primary']",contentSelector:"section.primary-body",initial:"description",group:"primary"},{navSelector:"nav.tabs[data-group='links']",contentSelector:"section.links-body",initial:"children",group:"links"},{navSelector:"nav.tabs[data-group='description']",contentSelector:"section.description-body",initial:"identified",group:"description"}]})}get template(){return`systems/ffd20/templates/items/${this.item.type}.hbs`}get title(){const e=this.actor;return e?`${super.title} – ${e.name}`:super.title}async getData(){const e=await super.getData();e.flags={flags:e.flags};const t=this.item,s=t.system;e.system=s;const n=t.actor,l=n?.system,c=t.getRollData();if(e.labels=t.getLabels(),e.items=t.items?.map((e=>e.toObject()))??[],e.config=ffd20.config,e.itemType=this._getItemType(t),e.itemStatus=this._getItemStatus(t),e.itemProperties=this._getItemProperties(),e.itemName=t.name,t.links.charges&&(e.inheritCharges=t.links.charges),e.isCharged=["day","week","charges"].includes(s.uses?.per),e.defaultChargeFormula=t.getDefaultChargeFormula(),e.isPhysical=void 0!==s.quantity,e.isNaturalAttack="natural"===s.subType,e.isSpell="spell"===t.type,e.owned=!!n,e.owner=t.isOwner,e.isGM=game.user.isGM,e.hasAction=t.hasAction,e.showIdentifyDescription=e.isGM&&e.isPhysical,e.showUnidentifiedData=t.showUnidentifiedData,e.unchainedActionEconomy=game.settings.get("ffd20","unchainedActionEconomy"),null!=c.item.auraStrength){const t=c.item.auraStrength;e.auraStrength=t,ffd20.config.auraStrengths[t]&&(e.auraStrength_name=ffd20.config.auraStrengths[t],e.labels.identify=game.i18n.format("FFD20.IdentifyDCNumber",{dc:15+c.item.cl}))}"class"===t.type&&(e.casting={types:ffd20.config.spellcasting.type,spells:ffd20.config.spellcasting.spells,progression:{high:"FFD20.High",med:"FFD20.Medium",low:"FFD20.Low"}},t.actor?e.hasSpellbook=Object.values(c.spells??{}).find((e=>!!e.class&&e.class===s.tag&&e.inUse)):e.hasSpellbook=!0);const u=this.document.getDescription();if(e.descriptionHTML={identified:await TextEditor.enrichHTML(u,{secrets:e.owner,rollData:c,async:!0}),unidentified:await TextEditor.enrichHTML(s.description.unidentified,{secrets:e.owner,rollData:c,async:!0})},e.name=t.name,e.isPhysical&&(e.descriptionAttributes=[],e.descriptionAttributes.push({isNumber:!0,name:"system.quantity",label:game.i18n.localize("FFD20.Quantity"),value:s.quantity,decimals:0,id:"data-quantity"}),e.descriptionAttributes.push({isNumber:!0,name:"system.weight.value",fakeName:!0,label:game.i18n.localize("FFD20.Weight"),value:s.weight.converted.total,inputValue:s.weight.converted.value,decimals:2,id:"data-weight-value"}),e.showIdentifyDescription?e.descriptionAttributes.push({isNumber:!0,name:"system.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:t.getValue({sellValue:1}),decimals:2,id:"data-price"},{isNumber:!0,name:"system.unidentified.price",fakeName:!0,label:game.i18n.localize("FFD20.UnidentifiedPriceShort"),value:t.getValue({sellValue:1,forceUnidentified:!0}),decimals:2,id:"data-unidentifiedPrice"}):e.showUnidentifiedData?e.descriptionAttributes.push({isNumber:!0,name:"system.unidentified.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:t.getValue({sellValue:1}),decimals:2,id:"data-price"}):e.descriptionAttributes.push({isNumber:!0,name:"system.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:t.getValue({sellValue:1}),decimals:2,id:"data-price"}),e.descriptionAttributes.push({isRange:!0,label:game.i18n.localize("FFD20.HPShort"),value:{name:"system.hp.value",value:s.hp.value},max:{name:"system.hp.max",value:s.hp.max}}),e.descriptionAttributes.push({isNumber:!0,label:game.i18n.localize("FFD20.Hardness"),name:"system.hardness",decimals:0,value:s.hardness}),e.descriptionAttributes.push({isBoolean:!0,name:"system.equipped",label:game.i18n.localize("FFD20.Equipped"),value:s.equipped}),e.descriptionAttributes.push({isBoolean:!0,name:"system.carried",label:game.i18n.localize("FFD20.Carried"),value:s.carried})),"feat"===t.type&&(e.isClassFeature="classFeat"===s.subType,e.isTemplate="template"===s.subType),["class","feat","race"].includes(t.type))if(n){const s=mergeObject(deepClone(ffd20.config.skills),l.skills??{});e.skills=Object.entries(s).reduce(((e,[s,n])=>{const l=ffd20.config.skills[s]||n.name;return e[s]={name:l,classSkill:!0===t.system.classSkills?.[s]},e}),{})}else e.skills=Object.entries(ffd20.config.skills).reduce(((e,[t,n])=>(e[t]={name:n,classSkill:!0===s.classSkills?.[t]},e)),{});if("weapon"===t.type){e.isRanged="ranged"===s.weaponSubtype||!0===s.properties.thr,e.weaponCategories={types:{},subTypes:{}};for(const[t,s]of Object.entries(ffd20.config.weaponTypes))"object"==typeof s&&(e.weaponCategories.types[t]=s._label);const t=s.subType;if(t in ffd20.config.weaponTypes)for(const[s,n]of Object.entries(ffd20.config.weaponTypes[t]))s.startsWith("_")||(e.weaponCategories.subTypes[s]=n)}if("equipment"===t.type){e.equipmentCategories={types:{},subTypes:{}};for(const[t,s]of Object.entries(ffd20.config.equipmentTypes))"object"==typeof s&&(e.equipmentCategories.types[t]=s._label);const n=s.subType;if(n in ffd20.config.equipmentTypes)for(const[t,s]of Object.entries(ffd20.config.equipmentTypes[n]))t.startsWith("_")||(e.equipmentCategories.subTypes[t]=s);e.equipmentSlots=ffd20.config.equipmentSlots.wondrous,e.hasMultipleSlots=t.hasSlots,e.hasSubCategory=["armor","shield"].includes(n)}if("spell"===t.type){let u=null;if(n){const e=s.spellbook;u=l?.attributes.spells?.spellbooks[e]}e.isPreparedSpell=null!=u&&(!u.spontaneous&&!u.spellPoints?.useSystem),e.usesSpellpoints=null!=u&&(u.spellPoints?.useSystem??!1),e.isAtWill=s.atWill,e.spellbooks=deepClone(l?.attributes.spells.spellbooks??{});const d=await renderTemplate("systems/ffd20/templates/internal/spell-description.hbs",t.spellDescriptionData),m=t.firstAction;e.topDescription=await TextEditor.enrichHTML(d,{rollData:m?.getRollData()??c,async:!0}),null!=s.shortDescription&&(e.shortDescription=await TextEditor.enrichHTML(s.shortDescription,{rollData:m?.getRollData()??c,secrets:e.owner,async:!0}))}if("class"===t.type){e.isMythicPath="mythic"===s.subType;for(const[e,t]of Object.entries(s.savingThrows))t.label=ffd20.config.savingThrows[e];for(const[e,t]of Object.entries(s.fc))t.label=ffd20.config.favouredClassBonuses[e];if(e.isBaseClass="base"===s.subType,e.isRacialHD="racial"===s.subType,n){const t=game.settings.get("ffd20","healthConfig");e.healthConfig=e.isRacialHD?t.hitdice.Racial:"character"===n.type?t.hitdice.PC:t.hitdice.NPC}else e.healthConfig={auto:!1};if(n){const t=mergeObject(deepClone(ffd20.config.skills),l.skills??{});e.skills=Object.entries(t).reduce(((e,[t,n])=>{const l=null!=ffd20.config.skills[t]?ffd20.config.skills[t]:n.name;return e[t]={name:l,classSkill:!0===s.classSkills?.[t]},e}),{})}else e.skills=Object.entries(ffd20.config.skills).reduce(((e,[t,n])=>(e[t]={name:n,classSkill:!0===s.classSkills?.[t]},e)),{})}const d={armorProf:ffd20.config.armorProficiencies,weaponProf:ffd20.config.weaponProficiencies,languages:ffd20.config.languages,weaponGroups:ffd20.config.weaponGroups};for(const[t,n]of Object.entries(d)){if(!s[t])continue;const l=deepClone(s[t]);e[t]=l;let c=[];l.value&&(c=l.value instanceof Array?l.value:[l.value]),l.selected=c.reduce(((e,t)=>(e[t]=n[t],e)),{}),l.custom&&l.custom.split(ffd20.config.re.traitSeparator).forEach(((e,t)=>l.selected["custom"+(t+1)]=e.trim())),l.active=!foundry.utils.isEmpty(l.selected)}if(t.changes){e.changeGlobals={targets:{},modifiers:ffd20.config.bonusModifiers};for(const[t,s]of Object.entries(ffd20.config.buffTargets))"object"==typeof s&&(e.changeGlobals.targets[t]=s._label);const t=getBuffTargets(n);e.changes=s.changes?.map((e=>{const s=t[e.subTarget];return{data:e,isValid:!!s,label:s?.label??e.subTarget,isScript:"script"===e.operator}}))??[]}if(s.contextNotes){e.contextNotes=deepClone(s.contextNotes);const t=getBuffTargets(n,"contextNotes");e.contextNotes.forEach((e=>{const s=t[e.subTarget];e.isValid=!!s,e.label=s?.label??e.subTarget}))}if(e.distanceUnits=deepClone(ffd20.config.distanceUnits),"spell"!==t.type)for(const t of["close","medium","long"])delete e.distanceUnits[t];if(s.attackNotes){const t=s.attackNotes;setProperty(e,"notes.attack",t)}return this._prepareItemFlags(e),await this._prepareScriptCalls(e),await this._prepareLinks(e),this._prepareActions(e),e}_prepareLinks(e){e.links={list:[]},e.links.list.push({id:"children",label:game.i18n.localize("FFD20.LinkTypeChildren"),help:game.i18n.localize("FFD20.LinkHelpChildren"),items:[]}),["feat","consumable","attack","equipment"].includes(this.item.type)&&e.links.list.push({id:"charges",label:game.i18n.localize("FFD20.LinkTypeCharges"),help:game.i18n.localize("FFD20.LinkHelpCharges"),items:[]}),"class"===this.item.type&&e.links.list.push({id:"classAssociations",label:game.i18n.localize("FFD20.LinkTypeClassAssociations"),help:game.i18n.localize("FFD20.LinkHelpClassAssociations"),fields:{level:{type:"Number",label:game.i18n.localize("FFD20.Level")}},items:[]});const t=this.item;t.actor;for(const s of e.links.list){const e=t.system.links?.[s.id]||[];for(let n=0;n<e.length;n++){const l=deepClone(e[n]);l.index=n;const c=t.getLinkedItemSync(l);c||(l.broken=!0),l.img=c?.img||ItemPF.DEFAULT_ICON,s.items.push(l)}}}_prepareActions(e){if(!e.system.actions)return[];const t=[];for(const s of e.system.actions){const e={data:s,isSelfCharged:this.object.actions.get(s._id).isSelfCharged};t.push(e)}e.actions=t}_prepareItemFlags(e){const t=e.item.system.flags??{};e.flags??={},e.flags.boolean=t.boolean??{},e.flags.dictionary=t.dictionary??{}}async _prepareScriptCalls(e){const t=ffd20.registry.scriptCalls.filter((e=>!!e.itemTypes.includes(this.document.type)&&!(!0===e.hidden&&!game.user.isGM)));if(!t.length)return void(e.scriptCalls=null);if(!game.user.can("MACRO_SCRIPT"))return void(e.scriptCalls=null);e.scriptCalls={};const s=Object.hasOwnProperty.call(this.document,"scriptCalls")?deepClone(Array.from(this.document.scriptCalls).map((e=>e.data))):[];{const e=[];for(const t of s)e.push((async()=>{if("macro"===t.type){const e=await fromUuid(t.value);null==e?(t.name=`${game.i18n.localize("FFD20.Unknown")} (${game.i18n.localize("DOCUMENT.Macro")})`,t.img="icons/svg/hazard.svg"):(t.name=e.data.name,t.img=e.data.img)}t.hiddenIcon=t.hidden?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>',t.hide=t.hidden&&!game.user.isGM})());await Promise.all(e)}for(const n of t)e.scriptCalls[n.id]={name:game.i18n.localize(n.name),info:n.info?game.i18n.localize(n.info):null,items:s.filter((e=>e.category===n.id)),dataset:{category:n.id}}}_getItemType(e){const t=Object.keys(ffd20.config.itemTypes);let s=e.type;return t.includes(s)||(s=t[0]),game.i18n.localize(ffd20.config.itemTypes[s])}_getItemStatus(e){const t=e.system;if("spell"===e.type){const e=this.item.spellbook;if("prepared"===t.preparation.mode)return"spontaneous"===e?.spellPreparationMode?t.preparation.spontaneousPrepared?game.i18n.localize("FFD20.SpellPrepPrepared"):game.i18n.localize("FFD20.Unprepared"):t.preparation.preparedAmount>0?game.i18n.format("FFD20.AmountPrepared",{count:t.preparation.preparedAmount}):game.i18n.localize("FFD20.Unprepared");if(t.preparation.mode)return t.preparation.mode.titleCase()}else if(void 0!==t.equipped)return t.equipped?game.i18n.localize("FFD20.Equipped"):game.i18n.localize("FFD20.NotEquipped")}_getItemProperties(){const e=[],t=this.item,s=this.item.getLabels();if("weapon"===t.type)e.push(...Object.entries(t.system.properties).filter((e=>!0===e[1])).map((e=>ffd20.config.weaponProperties[e[0]])));else if("spell"===t.type)e.push(s.components,s.materials);else if("equipment"===t.type){const n=t.subType;if("wondrous"===n)t.showUnidentifiedData?e.push(ffd20.config.equipmentTypes.other._label):e.push(ffd20.config.equipmentTypes.wondrous._label);else{const s=ffd20.config.equipmentTypes[n],l=s?.[t.system.equipmentSubtype]??s?._label;l&&e.push(l)}e.push(s.armor)}else"feat"===t.type&&e.push(s.subType);const n=t.actionTypes;n&&e.push(...n.map((e=>ffd20.config.itemActionTypes[e]))),"weapon"!==t.type&&t.system.activation&&!foundry.utils.isEmpty(t.system.activation)&&e.push(s.activation,s.range,s.target,s.duration);const l=t.system.tags;return null!=l&&e.push(...l),e.filter((e=>!!e))}async _updateObject(e,t){const s=(t=expandObject(t)).system,n=s.links;if(n){const e=this.item.system?.links??{};for(const[t,s]of Object.entries(n)){n[t]=deepClone(e[t]??[]);for(const[e,l]of Object.entries(s))n[t][e]=mergeObject(n[t][e]??{},l)}}void 0!==s.weight?.value&&(s.weight.value=ffd20.utils.convertWeightBack(s.weight.value));const l=["currency.pgil","currency.gil","currency.sgil","currency.cgil"];for(const e of l){const t=getProperty(s,e);if("string"!=typeof t)continue;let n;if(t.match(/(\+|-)(\d+)/)){const t=RegExp.$1;let s=parseInt(RegExp.$2);"-"===t&&(s=-s);n=getProperty(this.item.system,e)+s}else n=t.match(/^[0-9]+$/)?parseInt(t):0;setProperty(s,e,Math.max(0,n))}return super._updateObject(e,t)}activateListeners(e){super.activateListeners(e),e.mousemove((e=>this._moveTooltips(e))),e.find(".actions .item-list .item").on("contextmenu",this._onActionEdit.bind(this)),e.find(".item .item-name h4").on("click",(e=>this._onItemSummary(e))),e.find(".action-controls a").on("click",this._onActionControl.bind(this)),this.isEditable?(e.find("textarea").change(this._onSubmit.bind(this)),e.find("textarea, .notes input[type='text']").on("drop",this._onTextAreaDrop.bind(this)),e.find("a.help-browser[data-url]").click(this._openHelpBrowser.bind(this)),e.find(".change-control").click(this._onBuffControl.bind(this)),e.find(".change .change-target").click(this._onChangeTargetControl.bind(this)),e.find(".context-note-control").click(this._onNoteControl.bind(this)),e.find(".context-note .context-note-target").click(this._onNoteTargetControl.bind(this)),["weapon"].includes(this.item.type)&&e.find("button[name='create-attack']").click(this._createAttack.bind(this)),"class"===this.item.type&&e.find("button[name='create-spellbook']").click(this._createSpellbook.bind(this)),e.find(".entry-selector").click(this._onEntrySelector.bind(this)),e.find(".entry-control a").click(this._onEntryControl.bind(this)),e.find('div[data-group="links"],a.item[data-tab="links"]').on("drop",this._onLinksDrop.bind(this)),e.find(".link-control").click(this._onLinkControl.bind(this)),e.find(".file-picker-alt").click(this._onFilePickerAlt.bind(this)),e.find('*[data-action="input-text"]').click((e=>this._onInputText(e))),e.find(".select-on-click").click(this._selectOnClick.bind(this)),e.find(".edit-change-contents").on("click",this._onEditChangeScriptContents.bind(this)),e.find(".trait-selector").click(this._onTraitSelector.bind(this)),e.find(".tab[data-tab='links'] .links-item .links-item-name").on("contextmenu",this._openLinkedItem.bind(this)),e.find(".action-parts .item-uses span.text-box.value").on("wheel",this._setActionUses.bind(this)).on("click",(e=>{this._onSpanTextInput(e,this._setActionUses.bind(this))})),e.find(".uses-source [data-item-id]").on("contextmenu",(e=>{e.preventDefault();const t=e.currentTarget.dataset.itemId,s=this.document.actor.items.get(t);s?.sheet.render(!0,{focus:!0})})),e.find('a[data-action="compendium"]').click(this._onOpenCompendium.bind(this)),e.find(".script-calls .item-control").click(this._onScriptCallControl.bind(this)),e.find(".script-calls .item-list .item").contextmenu(this._onScriptCallEdit.bind(this)),e.find(".script-calls .item-list[data-category]").on("drop",this._onScriptCallDrop.bind(this))):e.find("span.text-box").addClass("readonly")}_onSpanTextInput(e,t=null){const s=e.currentTarget,n=s.parentElement,l=document.createElement("INPUT");l.type="text",s.dataset?.dtype&&(l.dataset.dtype=s.dataset.dtype);let c=s.innerText;s.classList.contains("placeholder")&&(c="");const u=s.classList.contains("no-value-cap"),d=s.getAttribute("name");let m;if(d&&(l.setAttribute("name",d),c=getProperty(this.document,d)??"",c&&"string"!=typeof c&&(c=c.toString()),d.endsWith(".value")&&!u)){const e=d.replace(/\.value$/,".max");m=getProperty(this.document,e)}l.value=c;const h=["placeholder","direct","allow-relative"];for(const e of s.classList)h.includes(e)||l.classList.add(e);const g=s.classList.contains("allow-relative"),y=parseFloat(s.dataset.clearValue||"0");n.replaceChild(l,s);let b=!1;l.addEventListener("keypress",(e=>{if("Enter"===e.key){if(b=!0,g){const e=adjustNumberByStringCommand(parseFloat(c),l.value,m,y);l.value=e}l.value.toString()===c.toString()?this.render():"function"==typeof t&&t.call(this,e)}})),l.addEventListener("focusout",(e=>{if(!b){if(b=!0,g&&parseFloat(c)!==parseFloat(l.value)){const e=adjustNumberByStringCommand(parseFloat(c),l.value,m,y);l.value=e}l.value.toString()===c.toString()?this.render():"function"==typeof t&&t.call(this,e)}})),l.focus(),l.select()}_mouseWheelAdd(e,t){const s="INPUT"===t.tagName,{originalEvent:n}=e;if(n&&n instanceof WheelEvent&&n.ctrlKey){e.preventDefault();const l=parseFloat(s?t.value:t.innerText)||0;if(Number.isNaN(l))return;const c=-Math.sign(n.deltaY),u=parseFloat(t.dataset.wheelStep)||1;s?t.value=l+u*c:t.innerText=""+(l+u*c)}}_setActionUses(e){e.originalEvent instanceof MouseEvent||e.preventDefault();const t=e.currentTarget,s=t.closest(".item").dataset.itemId,n=this.document.actions.get(s);this._mouseWheelAdd(e,t);const l="INPUT"===t.tagName?Number(t.value):Number(t.innerText);if(this.setActionUpdate(n.id,"uses.self.value",l),e.originalEvent instanceof MouseEvent){($._data(t,"events")?.mouseout?.length??0)>0||$(t).one("mouseleave",(e=>{this._updateActions()}))}else this._updateActions()}setActionUpdate(e,t,s){let n=this._actionUpdates.filter((t=>t._id===e))[0];null==n&&(n={_id:e},this._actionUpdates.push(n)),n[t]=s}async _updateActions(){const e=this._actionUpdates;this._actionUpdates=[];for(const t of e){const e=this.document.actions.get(t._id);e?await e.update(t):console.error("Item update for non-existing item:",t._id,t)}}_onOpenCompendium(e){e.preventDefault();const t=e.currentTarget.dataset.actionTarget;ffd20.applications.compendiums[t].render(!0,{focus:!0})}async _onScriptCallControl(e){e.preventDefault();const t=e.currentTarget,s=this.document.scriptCalls?this.document.scriptCalls.get(t.closest(".item")?.dataset.itemId):null,n=t.closest(".item-list").dataset.category;if(t.classList.contains("item-create"))return await this._onSubmit(e,{preventRender:!0}),ffd20.components.ItemScriptCall.create([{category:n,type:"script"}],{parent:this.item});if(s&&t.classList.contains("item-delete")){const t=(this.document.system.scriptCalls||[]).filter((e=>e._id!==s.id));return this._onSubmit(e,{updateData:{"system.scriptCalls":t}})}s&&t.classList.contains("item-edit")?s.edit():s&&t.classList.contains("item-hide")&&s.update({hidden:!s.hidden})}_onScriptCallEdit(e){e.preventDefault();const t=e.currentTarget,s=this.document.scriptCalls?this.document.scriptCalls.get(t.dataset.itemId):null;s&&s.edit()}_moveTooltips(e){const t=$(e.currentTarget),s=e.clientX,n=e.clientY+24;t.find(".tooltip:hover .tooltipcontent").css("left",s+"px").css("top",n+"px")}async _onTextAreaDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e.originalEvent);if(!t)return;const s=e.currentTarget,n=await TextEditor.getContentLink(t);return n&&(s.value=s.value?s.value+"\n"+n:n),this._onSubmit(e)}async _onScriptCallDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e.originalEvent);if(!t)return;const{uuid:s,type:n}=t;if("Macro"===n&&s){const t=e.currentTarget.dataset.category;return this.document.system.scriptCalls,await this._onSubmit(e,{preventRender:!0}),ffd20.components.ItemScriptCall.create([{type:"macro",value:s,category:t}],{parent:this.item})}}_openHelpBrowser(e){e.preventDefault();const t=e.currentTarget;ffd20.applications.helpBrowser.openUrl(t.dataset.url)}async _onLinksDrop(e){let t=e.currentTarget.dataset.tab;"links"===t&&(t="children");const s=TextEditor.getDragEventData(e.originalEvent);if(!s.type)return;const n=await fromUuid(s.uuid);if(!n)return;let l,c=s.uuid;n.pack?l="compendium":n.actor===this.document.actor?(l="data",c=n.id):l="world",await this.item.createItemLink(t,l,n,c)}_canDragStart(e){return!0}_onDragStart(e){const t=e.currentTarget;if(t.dataset?.itemId){const s=this.object.actions.get(t.dataset.itemId),n={type:"action",source:this.object.uuid,data:s.data};e.dataTransfer.setData("text/plain",JSON.stringify(n))}}_canDragDrop(){return this.isEditable}async _onDrop(e){let t,s;e.preventDefault(),e.stopPropagation();try{t=JSON.parse(e.dataTransfer.getData("text/plain")),"action"===t.type&&t.source&&(s="action")}catch(e){return!1}const n=this.object;if("action"===s){if(await fromUuid(t.source)===n){const s=e.target?.closest("li.action-part")?.dataset?.itemId,l=deepClone(n.system.actions);let c;c=s?l.indexOf(l.find((e=>e._id===s))):l.length-1;const u=l.indexOf(l.find((e=>e._id===t.data._id)));l.splice(u,1),l.splice(c,0,t.data),await this.object.update({"system.actions":l})}else{const e=deepClone(this.object.system.actions??[]);t.data._id=randomID(16),e.splice(e.length,0,t.data),await this.object.update({"system.actions":e})}}}async _onEditChangeScriptContents(e){const t=e.currentTarget.closest(".change").dataset.change,s=this.item.changes.find((e=>e._id===t));if(!s)return;const n=new ScriptEditor({command:s.formula,parent:this.object}).render(!0),l=await n.awaitResult();return"string"==typeof l?.command?s.update({formula:l.command}):void 0}_onTraitSelector(e){e.preventDefault();const t=e.currentTarget,s=t.parentElement.querySelector("label"),n={name:s.getAttribute("for"),title:s.innerText,subject:t.dataset.options,choices:ffd20.config[t.dataset.options]};new ActorTraitSelector(this.object,n).render(!0)}_onItemSummary(e){e.preventDefault();const t=$(e.currentTarget).closest(".item:not(.sheet)"),s=t.attr("data-item-collection")??"items",n=this.document[s].get(t.attr("data-item-id")),l="actions"===s,{description:c,actionDescription:u,properties:d}=n.getChatData({chatcard:!1});if(t.hasClass("expanded")){const e=t.children(".item-summary");e.slideUp(200,(()=>e.remove()))}else{const e=$(`<div class="item-summary">${l?u:c}</div>`),s=$('<div class="item-properties tag-list"></div>');d?.forEach((e=>s.append(`<span class="tag">${e}</span>`))),e.append(s),t.append(e.hide()),e.slideDown(200)}t.toggleClass("expanded")}async _openLinkedItem(e){e.preventDefault();const t=e.target.closest(".links-item[data-uuid],.links-item[data-item-id]"),{uuid:s,itemId:n}=t.dataset;let l;l=n?this.item.actor.items.get(n):await fromUuid(s),l.sheet.render(!0,{focus:!0})}async _onActionControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("edit-action"))return this._onActionEdit(e);if(this.isEditable){if(t.classList.contains("add-action")){const t={img:this.item.img,name:["weapon","attack"].includes(this.item.type)?game.i18n.localize("FFD20.Attack"):game.i18n.localize("FFD20.Use")};return await this._onSubmit(e,{preventRender:!0}),ffd20.components.ItemAction.create([t],{parent:this.item})}if(t.classList.contains("delete-action")){const e=t.closest(".action-part"),s=this.item.actions.get(e.dataset.itemId),deleteItem=async()=>s.delete();if(getSkipActionPrompt())deleteItem();else{const e=`<p>${game.i18n.localize("FFD20.DeleteItemConfirmation")}</p>`;Dialog.confirm({title:game.i18n.format("FFD20.DeleteItemTitle",{name:s.name}),content:e,yes:()=>{deleteItem()},rejectClose:!0})}}if(t.classList.contains("duplicate-action")){const s=t.closest(".action-part"),n=deepClone(this.item.actions.get(s.dataset.itemId).data);n.name=`${n.name} (${game.i18n.localize("FFD20.Copy")})`,n._id=randomID(16);const l=deepClone(this.item.system.actions??[]);return this._onSubmit(e,{updateData:{"system.actions":l.concat(n)}})}}}async _onActionEdit(e){e.preventDefault();const t=e.currentTarget.closest(".action-part"),s=this.item.actions.get(t.dataset.itemId);for(const e of Object.values(this.item.apps))if(e.object===s)return void e.render(!0,{focus:!0});new ffd20.applications.component.ItemActionSheet(s).render(!0)}async _onBuffControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-change"))return await this._onSubmit(e,{preventRender:!0}),ffd20.components.ItemChange.create([{}],{parent:this.item});if(t.classList.contains("delete-change")){const s=t.closest(".change"),n=deepClone(this.item.system.changes),l=n.find((e=>e._id===s.dataset.change));return n.splice(n.indexOf(l),1),this._onSubmit(e,{updateData:{"system.changes":n}})}}_onChangeTargetControl(e){e.preventDefault();const t=e.currentTarget,s=this.item.changes.get(t.closest(".change").dataset.change),n=getBuffTargetDictionary(this.item.actor),l=s?.subTarget?.split(".")[0],c=ffd20.config.buffTargets[l]?.category??l;new Widget_CategorizedItemPicker({title:"FFD20.Application.ChangeTargetSelector.Title",classes:["change-target-selector"]},n,(e=>{e&&s.update({subTarget:e})}),{category:c,item:s?.subTarget}).render(!0)}async _onNoteControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-note")){const t=this.item.system.contextNotes||[];await this._onSubmit(e,{updateData:{"system.contextNotes":t.concat([ItemPF.defaultContextNote])}})}if(t.classList.contains("delete-note")){const s=t.closest(".context-note"),n=duplicate(this.item.system.contextNotes);n.splice(Number(s.dataset.note),1),await this._onSubmit(e,{updateData:{"system.contextNotes":n}})}}_onNoteTargetControl(e){e.preventDefault();const t=e.currentTarget.closest(".context-note"),s=Number(t.dataset.note),n=this.item.system.contextNotes[s],l=getBuffTargetDictionary(this.item.actor,"contextNotes"),c=n?.subTarget?.split(".")[0],u=ffd20.config.contextNoteTargets[c]?.category??c;new Widget_CategorizedItemPicker({title:"FFD20.Application.ContextNoteTargetSelector.Title"},l,(e=>{if(e){const t={};t[`system.contextNotes.${s}.subTarget`]=e,this.item.update(t)}}),{category:u,item:n?.subTarget}).render(!0)}async _onLinkControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("delete-link")){const s=t.closest(".links-item"),n=t.closest('div[data-group="links"]').dataset.tab;await this._onSubmit(e,{preventRender:!0});let l=deepClone(this.item.system.links?.[n]??[]);const{uuid:c,itemId:u}=s.dataset,d=l.find((e=>c?e.uuid===c:!!u&&e.id===u));l=l.filter((e=>e!==d));const m={};m["system.links."+n]=l,Hooks.callAll("pf1DeleteItemLink",this.item,d,n),await this.document.update(m)}}async _onFilePickerAlt(e){const t=e.currentTarget,s=t.dataset.for,n=getProperty(this.item.system,s),l=t.form[s];if(!l)return;new FilePicker({type:t.dataset.type,current:n,callback:t=>{l.value=t,this.options.submitOnChange&&this._onSubmit(e)},top:this.position.top+40,left:this.position.left+10}).browse(n)}_onInputText(e){e.preventDefault();const t=this.element.find(e.currentTarget.dataset.for);t.removeAttr("readonly"),t.attr("name",e.currentTarget.dataset.attrName);const{inputValue:s}=e.currentTarget.dataset;let n=s??getProperty(this.item,e.currentTarget.dataset.attrName);t.attr("value",n),t.select(),t.focusout((e=>{"number"==typeof n&&(n=n.toString()),n!==t.attr("value")?this._onSubmit(e):this.render()}))}async _createAttack(e){if(null==this.item.actor)throw Error(game.i18n.localize("FFD20.ErrorItemNoOwner"));await this._onSubmit(e,{preventRender:!0}),await this.item.actor.createAttackFromWeapon(this.item)}async _createSpellbook(e){if(e.preventDefault(),null==this.item.actor)throw Error(game.i18n.localize("FFD20.ErrorItemNoOwner"));await this._onSubmit(e,{preventRender:!0}),await this.item.actor.createSpellbook({...this.item.system.casting,class:this.item.system.tag}),this.render()}_onEntrySelector(e){e.preventDefault();const t=e.currentTarget,s={name:t.getAttribute("for"),title:t.innerText,flag:"true"===t.dataset.flag,boolean:"true"===t.dataset.boolean,flat:"true"===t.dataset.flat,fields:t.dataset.fields,dtypes:t.dataset.dtypes};new ffd20.applications.EntrySelector(this.item,s).render(!0)}_onEntryControl(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".notes").dataset.name;if(t.classList.contains("add-entry")){const t=getProperty(this.document,s)??[],n={};return n[s]=t.concat(""),this._onSubmit(e,{updateData:n})}if(t.classList.contains("delete-entry")){const n=t.closest(".entry").dataset.index,l=duplicate(getProperty(this.document,s));l.splice(n,1);const c={};return c[s]=l,this._onSubmit(e,{updateData:c})}}_selectOnClick(e){e.preventDefault();e.currentTarget.select()}}class ItemSheetPF_Container extends ItemSheetPF{constructor(...e){super(...e),this._filters={search:{container:""}},this.searchCompositioning=!1,this.searchRefresh=!0,this.searchDelay=250,this.searchDelayEvent=null,this.effectiveSearch="",this._itemUpdates=[],this.options.tabs[0].initial="contents",this._tabs[0].active="contents"}static get defaultOptions(){return mergeObject(super.defaultOptions,{width:800,classes:["ffd20","sheet","item"],scrollY:[".item-groups-list"],dragDrop:[{dragSelector:"li.item[data-item-id]",dropSelector:'.tab[data-tab="contents"]'},{dragSelector:"label.denomination"}]})}get template(){return"systems/ffd20/templates/items/container.hbs"}async getData(){const e=await super.getData();e.filters=this._filters,e.items=this.item.items.reduce(((e,t)=>{const s=t.toObject();return e.push(s),s.document=t,s.labels=t.getLabels(),s.hasAttack=t.hasAttack,s.hasMultiAttack=t.hasMultiAttack,s.hasDamage=t.hasDamage,s.hasRange=t.hasRange,s.hasEffect=t.hasEffect,s.hasAction=t.hasAction||t.isCharged,s.showUnidentifiedData=t.showUnidentifiedData,s.name=t.name,e}),[]),e.items.sort(((e,t)=>(e.sort||0)-(t.sort||0))),e.hasCurrency=Object.values(this.object.system.currency).some((e=>e>0)),this._prepareContents(e),e.descriptionAttributes=[],e.descriptionAttributes.push({isNumber:!0,name:"system.weight.value",fakeName:!0,label:game.i18n.localize("FFD20.Weight"),value:e.item.system.weight.converted.total,inputValue:e.item.system.weight.converted.value,decimals:2,id:"data-weight-value"}),e.showIdentifyDescription?e.descriptionAttributes.push({isNumber:!0,name:"system.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:e.item.system.price,id:"data-price"},{isNumber:!0,name:"system.unidentified.price",fakeName:!0,label:game.i18n.localize("FFD20.UnidentifiedPriceShort"),value:e.item.system.unidentified?.price,id:"data-unidentifiedPrice"}):e.showUnidentifiedData?e.descriptionAttributes.push({isNumber:!0,name:"system.unidentified.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:e.item.system.unidentified?.price,id:"data-price"}):e.descriptionAttributes.push({isNumber:!0,name:"system.price",fakeName:!0,label:game.i18n.localize("FFD20.Price"),value:e.item.system.price,id:"data-price"}),e.descriptionAttributes.push({isRange:!0,label:game.i18n.localize("FFD20.HPShort"),value:{name:"system.hp.value",value:e.item.system.hp?.value},max:{name:"system.hp.max",value:e.item.system.hp?.max}}),e.descriptionAttributes.push({isNumber:!0,label:game.i18n.localize("FFD20.Hardness"),name:"system.hardness",value:e.item.system.hardness}),e.descriptionAttributes.push({isBoolean:!0,name:"system.carried",label:game.i18n.localize("FFD20.Carried"),value:e.item.system.carried});const t=getWeightSystem();e.weight={contents:this.item.system.weight.converted.contents,units:"metric"===t?game.i18n.localize("FFD20.Kgs"):game.i18n.localize("FFD20.Lbs")};const s=this.item.getValue({sellValue:1,inLowestDenomination:!0})-this.item.getValue({recursive:!1,sellValue:1,inLowestDenomination:!0}),n=this.item.getValue({inLowestDenomination:!0})-this.item.getValue({recursive:!1,inLowestDenomination:!0});return e.totalValue=splitCurrency(s),e.sellValue=splitCurrency(n),e.labels||(e.labels={}),e.labels.totalValue=game.i18n.format("FFD20.ItemContainerTotalValue",e.totalValue),e.labels.sellValue=game.i18n.format("FFD20.ItemContainerSellValue",e.sellValue),e}_prepareContents(e){const t={weapon:{label:game.i18n.localize("FFD20.InventoryWeapons"),canCreate:!0,hasActions:!0,items:[],canEquip:!1,dataset:{type:"weapon"}},equipment:{label:game.i18n.localize("FFD20.InventoryArmorEquipment"),canCreate:!0,hasActions:!0,items:[],canEquip:!1,dataset:{type:"equipment"},hasSlots:!0},consumable:{label:game.i18n.localize("FFD20.InventoryConsumables"),canCreate:!0,hasActions:!0,items:[],canEquip:!1,dataset:{type:"consumable"}},gear:{label:ffd20.config.lootTypes.gear,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeGearSingle"),"sub-type":"gear"}},ammo:{label:ffd20.config.lootTypes.ammo,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeAmmoSingle"),"sub-type":"ammo"}},misc:{label:ffd20.config.lootTypes.misc,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.Misc"),"sub-type":"misc"}},tradeGoods:{label:ffd20.config.lootTypes.tradeGoods,canCreate:!0,hasActions:!1,items:[],canEquip:!1,dataset:{type:"loot","type-name":game.i18n.localize("FFD20.LootTypeTradeGoodsSingle"),"sub-type":"tradeGoods"}},container:{label:game.i18n.localize("FFD20.InventoryContainers"),canCreate:!0,hasActions:!1,items:[],dataset:{type:"container"}}},s=e.items.reduce(((e,t)=>{t.img=t.img||DEFAULT_TOKEN,t.isStack=!!t.system.quantity&&t.system.quantity>1,t.hasUses=t.system.uses&&t.system.uses.max>0,t.isCharged=["day","week","charges"].includes(t.system.uses?.per),t.price=!1===t.system.identified?t.system.unidentified.price:t.system.price;const s=t.system.quantity??1,n=t.system.uses?.value??1;return t.empty=s<=0||t.isCharged&&n<=0,e.push(t),e}),[]),n="metric"===getWeightSystem()?game.i18n.localize("FFD20.Kgs"):game.i18n.localize("FFD20.Lbs");for(const e of s){const s="loot"===e.type?e.system.subType||"gear":e.system.subType;e.system.quantity??=0,e.totalWeight=Math.roundDecimals(e.document.system.weight.converted.total,2),e.units=n,null!=t[e.type]&&t[e.type].items.push(e),"loot"===e.type&&t[s]?.items.push(e)}e.inventory=Object.values(t)}activateListeners(e){super.activateListeners(e),e.find('.tab[data-tab="contents"] .item-create').click((e=>this._onItemCreate(e))),e.find('.tab[data-tab="contents"] .item-edit').click(this._onItemEdit.bind(this)),e.find('.tab[data-tab="contents"] .item-delete').click(this._onItemDelete.bind(this)),e.find('.tab[data-tab="contents"] .item-take').click(this._onItemTake.bind(this)),e.find(".item .item-name").contextmenu(this._onItemEdit.bind(this)),e.find("a.item-control.item-identify").click((e=>{this._quickIdentifyItem(e)})),e.find("a.item-control.item-duplicate").click(this._duplicateItem.bind(this)),e.find("a.item-control.item-quantity-add").click((e=>{this._quickChangeItemQuantity(e,1)})),e.find("a.item-control.item-quantity-subtract").click((e=>{this._quickChangeItemQuantity(e,-1)})),e.find(".item-actions a").click((e=>this._quickItemActionControl(e))),e.find(".item-detail.item-uses input[type='text']:not(:disabled)").off("change").change(this._setItemUses.bind(this)).on("wheel",this._setItemUses.bind(this)),e.find("a.convert-currency").click(this._convertCurrency.bind(this)),e.find(".item .item-image").click((e=>this._onItemRoll(e)));const t=e.find(".search-input");t.on("keyup change",this._searchFilterChange.bind(this)),t.on("compositionstart compositionend",this._searchFilterCompositioning.bind(this)),this.searchRefresh=!0,t.each((function(){this.value.length>0&&$(this).change()})),e.find(".clear-search").on("click",this._clearSearch.bind(this))}_onItemCreate(e){e.preventDefault();const t=e.currentTarget,s=t.dataset.type,n={name:"New "+(t.dataset.typeName||t.dataset.type).capitalize(),type:s,system:duplicate(t.dataset)};return delete n.system.type,delete n.system.typeName,this.item.createContainerContent(n)}_onItemEdit(e){e.preventDefault();const t=e.currentTarget.closest(".item");this.item.getContainerContent(t.dataset.itemId).sheet.render(!0,{focus:!0,editable:this.isEditable})}_onItemDelete(e){e.preventDefault();const t=e.currentTarget;if(t.disabled)return;const s=e.currentTarget.closest(".item");if(getSkipActionPrompt())this.item.deleteContainerContent(s.dataset.itemId);else{t.disabled=!0;const e=this.document.items.get(s.dataset.itemId),n=`<p>${game.i18n.localize("FFD20.DeleteItemConfirmation")}</p>`;Dialog.confirm({title:game.i18n.format("FFD20.DeleteItemTitle",{name:e.name}),content:n,yes:()=>{this.item.deleteContainerContent(s.dataset.itemId),t.disabled=!1},no:()=>t.disabled=!1,rejectClose:!0}).then(null,(()=>t.disabled=!1))}}async _onItemTake(e){e.preventDefault();const t=e.currentTarget.closest(".item"),s=this.item.getContainerContent(t.dataset.itemId);this.actor&&(await this.actor.createEmbeddedDocuments("Item",[s.toObject()]),await this.item.deleteContainerContent(s._id))}_onDragStart(e){if(e.target.classList.contains("entity-link"))return;const t=e.currentTarget;let s;if(t.classList.contains("denomination")){if(!this.item.testUserPermission(game.user,3))return;s={type:"Currency",alt:t.classList.contains("alt-currency"),currency:[...t.classList].find((e=>/[pgsc]p/.test(e))),containerId:this.item.id,amount:parseInt(t.nextElementSibling.textContent||t.nextElementSibling.value)}}else{const e=this.item.getContainerContent(t.dataset.itemId);s={type:"Item",data:e.toObject(),containerId:this.item.id},s.itemId=e.id,delete s.data._id}s.actorUuid=this.item.actor?.uuid,e.dataTransfer.setData("text/plain",JSON.stringify(s))}_onDrop(e){let t;e.preventDefault(),e.stopPropagation();try{t=JSON.parse(e.dataTransfer.getData("text/plain"))}catch(e){return!1}const s=this.item;if(!1!==Hooks.call("pf1DropContainerSheetData",s,this,t))switch(t.type){case"Item":return this._onDropItem(e,t);case"Currency":return this._onDropCurrency(e,t)}}async _onDropCurrency(e,t){let s=await fromUuid(t.actorUuid||"");return s instanceof Actor||(s=s?.actor),new CurrencyTransfer({actor:s,container:t.containerId,alt:t.alt},{actor:this.actor,container:this.item.id,amount:Object.fromEntries([[t.currency,parseInt(t.amount)]])}).render(!0)}async _onDropItem(e,t){if(!this.item.isOwner)return!1;const{actorUuid:s,containerId:n}=t;let l=await fromUuid(s||"");l instanceof Actor||(l=l?.actor);const c=await Item.implementation.fromDropData(t);l??=c.actor;const u=c.toObject(),d=l&&l===this.item.actor;if(d&&n===this.item.id)return this._onSortItem(e,u);if("spell"===u.type){const e=await createConsumableSpellDialog(u,{allowSpell:!1});return!!e&&this.item.createContainerContent(e)}c.isPhysical&&(await this.item.createContainerContent(u),d&&(n?l.containerItems.find((e=>e.id===t.itemId&&e.parentItem?.id===n))?.parentItem.deleteContainerContent(t.itemId):l.items.get(c.id)?.delete()))}async _quickIdentifyItem(e){if(e.preventDefault(),!game.user.isGM)return void ui.notifications.error(game.i18n.localize("FFD20.ErrorCantIdentify"));const t=$(e.currentTarget).parents(".item").attr("data-item-id"),s=this.item.getContainerContent(t),n=s.system.identified;return void 0!==n?s.update({"system.identified":!n}):void 0}async _duplicateItem(e){e.preventDefault();const t=e.currentTarget,s=$(t).parents(".item").attr("data-item-id"),n=this.item.getContainerContent(s),l=duplicate(n.data);return delete l._id,l.name=`${l.name} (${game.i18n.localize("FFD20.Copy")})`,n.isPhysical&&!n.system.identified&&(l.system.unidentified.name=`${n.system.unidentified.name} (${game.i18n.localize("FFD20.Copy")})`),l.system.links?.children&&delete l.system.links.children,this.item.createContainerContent(l)}async _quickChangeItemQuantity(e,t=1){e.preventDefault();const s=$(e.currentTarget).parents(".item").attr("data-item-id"),n=this.item.getContainerContent(s),l=n.system.quantity||0,c=Math.max(0,l+t);return n.update({"system.quantity":c})}_quickItemActionControl(e){e.preventDefault();const t=$(e.currentTarget).closest(".item").attr("data-item-id");this.item.getContainerContent(t).use({ev:e})}async _setItemUses(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".item").dataset.itemId,n=this.item.getContainerContent(s);this._mouseWheelAdd(e.originalEvent,t);const l=Number(t.value);this.setItemUpdate(n._id,"system.uses.value",l),e.originalEvent instanceof MouseEvent?this._submitQueued||$(t).one("mouseleave",(e=>{this._updateItems()})):this._updateItems()}async _updateItems(){const e=[],t=duplicate(this._itemUpdates);this._itemUpdates=[];for(const s of t){const t=this.item.items.filter((e=>e._id===s._id))[0];null!=t&&(delete s._id,t.testUserPermission(game.user,"OWNER")&&e.push(t.update(s)))}return Promise.all(e)}setItemUpdate(e,t,s){let n=this._itemUpdates.filter((t=>t._id===e))[0];null==n&&(n={_id:e},this._itemUpdates.push(n)),n[t]=s}_mouseWheelAdd(e,t){if(e&&e instanceof WheelEvent){const s=parseFloat(t.value);if(Number.isNaN(s))return;const n=-Math.sign(e.deltaY),l=parseFloat(t.dataset.wheelStep)||1;t.value=s+l*n}}_convertCurrency(e){e.preventDefault();const t=e.currentTarget.dataset.type;this.item.convertCurrency(t)}_onSortItem(e,t){const s=this.document.items,n=s.get(t._id),l=e.target.closest(".item"),c=l?l.dataset.itemId:null,u=s.get(c);if(c===n.id)return;const d=[];for(const e of l.parentElement.children){const t=e.dataset.itemId;if(t&&t!==n.id){const t=s.get(e.dataset.itemId);if(t.type!==n.type)continue;d.push(t)}}if(0==d.length)return;const m=SortingHelpers.performIntegerSort(n,{target:u,siblings:d}).map((e=>{const t=e.update;return t._id=e.target._id,t}));return this.item.updateContainerContents(m)}_onItemRoll(e){e.preventDefault();const t=e.currentTarget.closest(".item").dataset.itemId,s=this.item.getContainerContent(t);if(null!=s)return s.displayCard()}_searchFilterCommit(e){const t=this.item,s=this._filters.search.container.toLowerCase();if(this.effectiveSearch===s&&!this.searchRefresh)return;this.effectiveSearch=s,this.searchRefresh=!1;$(e.target).closest(".tab").find(".item-list .item").each((function(){const e=$(this);if(s?.length>0){(e=>e.toLowerCase().includes(s))(t.items.get(this.dataset.itemId).name)?e.show():e.hide()}else e.show()}))}_clearSearch(e){this._filters.search.container="",$(e.target).prev(".search-input").val("").change()}_searchFilterCompositioning(e){this.searchCompositioning="compositionstart"===e.type}_searchFilterChange(e){e.preventDefault(),e.stopPropagation();const t=e.target.value,s=this._filters.search.container!==t;(this.searchCompositioning||s)&&clearTimeout(this.searchDelayEvent),this.searchCompositioning||(this._filters.search.container=t,"keyup"===e.type?s&&(this.searchDelayEvent=setTimeout((()=>this._searchFilterCommit(e)),this.searchDelay)):this._searchFilterCommit(e))}}const ue=Object.freeze(Object.defineProperty({__proto__:null,ItemSheetPF,ItemSheetPF_Container},Symbol.toStringTag,{value:"Module"}));class ItemActionSheet extends FormApplication{constructor(...e){super(...e),this.item.apps[this.appId]=this,this.action.apps[this.appId]=this,this.action.sheet=this}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"systems/ffd20/templates/apps/item-action.hbs",classes:["ffd20","item","sheet","item-action"],width:580,height:720,closeOnSubmit:!1,submitOnClose:!0,submitOnChange:!0,resizable:!0,scrollY:[".tab"],tabs:[{navSelector:"nav.tabs[data-group='primary']",contentSelector:"section.primary-body",initial:"description",group:"primary"}],dragDrop:[{dragSelector:"li.conditional",dropSelector:'div[data-tab="conditionals"]'}]})}get title(){return`${this.item.name}: ${this.action.name}`}get id(){return this.actor?`actor-${this.actor.id}-item-${this.item.id}-action-${this.action.id}`:`item-${this.item.id}-action-${this.action.id}`}get action(){return this.object}get item(){return this.action.item}get actor(){return this.item.actor}async getData(){const e=await super.getData();if(e.action=this.action,e.item=this.item,e.actor=this.actor,e.data=foundry.utils.mergeObject(this.action.constructor.defaultData,deepClone(this.action.data),{inplace:!1}),e.damageTypes=ffd20.registry.damageTypes.toObject(),e.rollData=this.object.getRollData(),e.tag=createTag(e.action.name),e.config=ffd20.config,e.hasAttackRoll=this.action.hasAttack,e.isHealing="heal"===e.data.actionType,e.isCombatManeuver=["mcman","rcman"].includes(e.data.actionType),e.hasAttack=["mwak","rwak","msak","rsak","mcman","rcman"].includes(e.data.actionType),e.hasCritDamage=e.hasAttack||e.data.damage?.critParts?.length>0,e.hasNonCritDamage=e.hasAttack||e.data.damage?.nonCritParts?.length>0,e.isCharged=this.action.isCharged,e.isSelfCharged=this.action.isSelfCharged,e.showMaxChargeFormula=["day","week","charges"].includes(e.data.uses.self.per),this.action.hasRange&&(e.canInputRange=["ft","mi","spec"].includes(e.data.range.units),e.canInputMinRange=["ft","mi","spec"].includes(e.data.range.minUnits)),null!=e.data.duration&&(e.canInputDuration=!["","inst","perm","seeText"].includes(e.data.duration.units)),e.itemName=e.item.name,e.itemEnh=e.item.system.enh||0,e.isSpell="spell"===this.item.type,e.usesSpellPoints=this.item.spellbook?.spellPoints.useSystem,e.defaultChargeFormula=this.item.getDefaultChargeFormula(),e.canUseAmmo=void 0!==this.action.data.usesAmmo,e.owned=null!=this.item.actor,e.parentOwned=null!=this.actor,e.owner=this.item.isOwner,e.isGM=game.user.isGM,e.unchainedActionEconomy=game.settings.get("ffd20","unchainedActionEconomy"),e.activation=this.action.activation,e.hasActivationType=e.activation.type,e.abilityActivationTypes=e.unchainedActionEconomy?ffd20.config.abilityActivationTypes_unchained:ffd20.config.abilityActivationTypes,e.descriptionHTML=await TextEditor.enrichHTML(e.data.description,{secrets:e.owner,rollData:e.rollData,async:!0}),e.showMaxRangeIncrements="ft"===e.data.range.units,"attack"===e.item.type&&(e.isWeaponAttack="weapon"===e.item.system.subType,e.isNaturalAttack="natural"===e.item.system.subType),e.distanceUnits=deepClone(ffd20.config.distanceUnits),"spell"!==this.item.type)for(const t of["close","medium","long"])delete e.distanceUnits[t];if(e.data.conditionals)for(const t of e.data.conditionals)for(const e of t.modifiers)e.targets=this.object.getConditionalTargets(),e.subTargets=this.object.getConditionalSubTargets(e.target),e.conditionalModifierTypes=this.object.getConditionalModifierTypes(e.target),e.conditionalCritical=this.object.getConditionalCritical(e.target);return e}get isEditable(){const e=this.object.item;let t=this.options.editable&&e.isOwner;if(e.pack){game.packs.get(e.pack).locked&&(t=!1)}return t}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find('img[data-edit="img"]').on("click",this._onEditImage.bind(this)),e.find("textarea, .notes input[type='text']").on("drop",this._onTextAreaDrop.bind(this)),e.find(".attack-control").click(this._onAttackControl.bind(this)),e.find(".damage-control").click(this._onDamageControl.bind(this)),e.find(".damage-type-visual").on("click",this._onClickDamageType.bind(this)),e.find(".entry-selector").click(this._onEntrySelector.bind(this)),e.find(".entry-control a").click(this._onEntryControl.bind(this)),e.find(".conditional-control").click(this._onConditionalControl.bind(this)),e.find(".file-picker-alt").click(this._onFilePickerAlt.bind(this)))}_onDragStart(e){const t=e.currentTarget;if(t.dataset?.conditional){const s=this.object.conditionals.get(t.dataset?.conditional);e.dataTransfer.setData("text/plain",JSON.stringify(s.data))}}_canDragStart(e){return this.isEditable}_canDragDrop(e){return this.isEditable}async _onDrop(e){let t,s;e.preventDefault(),e.stopPropagation();try{t=JSON.parse(e.dataTransfer.getData("text/plain")),null!=t.default&&"string"==typeof t.name&&Array.isArray(t.modifiers)&&(s="conditional")}catch(e){return!1}const n=this.object;if("conditional"===s){for(const e of t.modifiers){let t;Object.keys(n.getConditionalTargets()).includes(e.target)||(e.target="");for(let[s,l]of Object.entries(e)){switch(s){case"subTarget":t=Object.keys(n.getConditionalSubTargets(e.target));break;case"type":t=Object.keys(n.getConditionalModifierTypes(e.target));break;case"critical":t=Object.keys(n.getConditionalCritical(e.target))}t?.includes(l)||(l=t?.[0]??"")}}t._id=randomID(16);const e=deepClone(n.data.conditionals||[]).concat(t);await this.object.update({conditionals:e})}}_onEntrySelector(e){e.preventDefault();const t=e.currentTarget,s={name:t.getAttribute("for"),title:t.innerText,flag:"true"===t.dataset.flag,boolean:"true"===t.dataset.boolean,flat:"true"===t.dataset.flat,fields:t.dataset.fields,dtypes:t.dataset.dtypes};new ffd20.applications.EntrySelector(this.object,s).render(!0)}_onEntryControl(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".notes").dataset.name;if(t.classList.contains("add-entry")){const t={[s]:deepClone(getProperty(this.object.data,s)??[]).concat("")};return this._onSubmit(e,{updateData:t})}if(t.classList.contains("delete-entry")){const n=t.closest(".entry").dataset.index,l=deepClone(getProperty(this.object.data,s));l.splice(n,1);const c={};return c[s]=l,this._onSubmit(e,{updateData:c})}}async _onConditionalControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-conditional"))return await this._onSubmit(e,{preventRender:!0}),ffd20.components.ItemConditional.create([{}],{parent:this.object});if(t.classList.contains("delete-conditional")){await this._onSubmit(e,{preventRender:!0});const s=t.closest(".conditional");return this.object.conditionals.get(s.dataset.conditional).delete()}if(t.classList.contains("add-conditional-modifier")){await this._onSubmit(e,{preventRender:!0});const s=t.closest(".conditional"),n=this.object.conditionals.get(s.dataset.conditional);return ffd20.components.ItemConditionalModifier.create([{}],{parent:n})}if(t.classList.contains("delete-conditional-modifier")){await this._onSubmit(e,{preventRender:!0});const s=t.closest(".conditional-modifier");return this.object.conditionals.get(s.dataset.conditional).modifiers.get(s.dataset.modifier).delete()}}async _onDamageControl(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".damage").dataset.key||"damage.parts",n=s.split(".").slice(0,-1).join("."),l=s.split(".").slice(-1).join(".");if(t.classList.contains("add-damage")){const t={formula:"",type:ffd20.components.ItemAction.defaultDamageType},c=getProperty(this.action.data,n),u={};return u[s]=getProperty(c,l).concat([t]),this._onSubmit(e,{updateData:u})}if(t.classList.contains("delete-damage")){const c=t.closest(".damage-part"),u=deepClone(getProperty(this.action.data,n));getProperty(u,l).splice(Number(c.dataset.damagePart),1);const d={};return d[s]=getProperty(u,l),this._onSubmit(e,{updateData:d})}}async _onClickDamageType(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".damage-part")?.dataset.damagePart,n=t.closest(".damage")?.dataset.key;if(null!=s&&null!=n){return new ffd20.applications.DamageTypeSelector(this.object,`${n}.${s}.type`,getProperty(this.object.data,n)[s].type).render(!0)}const l=t.closest(".conditional"),c=t.closest(".conditional-modifier");if(l&&c){const e=this.object.conditionals.get(l.dataset.conditional).modifiers.get(c.dataset.modifier);return new ffd20.applications.DamageTypeSelector(e,"damageType",e.data.damageType).render(!0)}}async _onAttackControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-attack")){const t=this.action.data.attackParts;return this._onSubmit(e,{updateData:{attackParts:t.concat([["",""]])}})}if(t.classList.contains("delete-attack")){const s=t.closest(".attack-part"),n=deepClone(this.action.data.attackParts);return n.splice(Number(s.dataset.attackPart),1),this._onSubmit(e,{updateData:{attackParts:n}})}}async _onFilePickerAlt(e){const t=e.currentTarget,s=t.dataset.for,n=getProperty(this.item.data,s),l=t.form[s];if(!l)return;new FilePicker({type:t.dataset.type,current:n,callback:t=>{l.value=t,this.options.submitOnChange&&this._onSubmit(e)},top:this.position.top+40,left:this.position.left+10}).browse(n)}async _onEditImage(e){e.preventDefault();new FilePicker({type:"image",current:this.action.data.img,callback:async e=>(await this.action.update({img:e}),this.render())}).render()}async _onTextAreaDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e.originalEvent);if(!t)return;const s=e.currentTarget,n=await TextEditor.getContentLink(t);return n&&(s.value=s.value?s.value+"\n"+n:n),this._onSubmit(e)}async _updateObject(e,t){const s=deepClone(this.object.data.conditionals);return Object.entries(t).filter((e=>e[0].startsWith("conditionals"))).forEach((e=>{let t;if(t=e[0].match(/^conditionals.([0-9]+).modifiers.([0-9]+).(.+)$/)){const n=parseInt(t[1]),l=parseInt(t[2]),c=s[n]??deepClone(this.object.data.conditionals[n]),u=t[3];setProperty(c.modifiers[l],u,e[1])}else if(t=e[0].match(/^conditionals.([0-9]+).(.+)$/)){const n=parseInt(t[1]),l=s[n]??deepClone(this.object.data.conditionals[n]),c=t[2];setProperty(l,c,e[1])}})),t.conditionals=s,t=expandObject(t),this.action.update(t)}async close(e){return delete this.item.apps[this.appId],delete this.action.apps[this.appId],this.action.sheet=null,super.close(e)}}const de=Object.freeze(Object.defineProperty({__proto__:null,ItemActionSheet},Symbol.toStringTag,{value:"Module"})),me=Object.freeze(Object.defineProperty({__proto__:null,ExperienceConfig,HealthConfig,TooltipConfig,TooltipWorldConfig},Symbol.toStringTag,{value:"Module"}));class CheckboxFilter extends BaseFilter{static TEMPLATE="systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs";static MIN_SEARCH_CHOICES=10;booleanOperator=he.NONE;_choiceQuery="";constructor(...e){super(...e),this._debouncedFilterChoices=foundry.utils.debounce(this._onCustomSearchFilter,100)}static getChoicesFromConfig(e,{labelKey:t="_label",innerSet:s=!1}={}){const n=new foundry.utils.Collection;for(const[l,c]of Object.entries(e))if(s)for(const[e,s]of Object.entries(c))e!==t&&n.set(e,{key:e,label:s});else"object"==typeof c&&c[t]?n.set(l,{key:l,label:c[t]}):"string"==typeof c&&n.set(l,{key:l,label:c});return n}get hasControls(){return this.booleanOperator!==he.NONE||this.choices.size>=this.constructor.MIN_SEARCH_CHOICES}get hasSearch(){return this.choices.size>=this.constructor.MIN_SEARCH_CHOICES||(this.constructor.MIN_SEARCH_CHOICES??!1)}setup(){super.setup(),this.prepareBooleanOperator()}prepareBooleanOperator(){const e=this.compendiumBrowser?.entries.contents;let t;e.find((e=>t=getProperty(e,this.constructor.indexField))),["Array","Object"].includes(foundry.utils.getType(t))&&(this.booleanOperator=he.AND)}prepareChoices(){const e=this.compendiumBrowser?.entries.contents,t=new Set(e.flatMap((e=>{const t=getProperty(e,this.constructor.indexField);if(Array.isArray(t))return 0===t.length?[]:t;if("object"==typeof t&&null!==t){const e=Object.keys(t);return 0===e.length?[]:e}return null==t||"string"==typeof t&&""===t.trim()?[]:[t]})));this.choices=new foundry.utils.Collection(naturalSort([...t].map((e=>({key:e,label:game.i18n.localize(""+e)}))),"label").map((e=>[""+e.key,e])))}toggleChoice(e,t=null){const s=this.choices?.get(e);if(!s)throw Error(`Choice ${e} does not exist in this filter.`);return s.active=null===t?!s.active:t,s.active}reset(){super.reset(),this.prepareBooleanOperator(),this._choiceQuery="",this.choices?.forEach((e=>e.active=!1))}applyFilter(e){const t=this.choices.filter((e=>e.active));if(0===t.length)return!0;const s=this.constructor.handledTypes;if(s.size&&!s.has(e.type))return!1;const n=getProperty(e,this.constructor.indexField),l=this.booleanOperator===he.OR?"some":"every";return Array.isArray(n)?t[l]((e=>n.includes(e.key))):"object"==typeof n&&null!==n?t[l]((e=>e.key in n&&!1!==n[e.key])):t.some((e=>n==e.key))}getData(){return{...super.getData(),hasControls:this.hasControls,boolean:this.booleanOperator,hasSearch:this.choices.size>this.constructor.MIN_SEARCH_CHOICES,choiceQuery:this._choiceQuery}}activateListeners(e){super.activateListeners(e),this._onCustomSearchFilter(null,e),e.querySelector("button.boolean")?.addEventListener("click",(e=>{e.preventDefault(),this.booleanOperator===he.OR?this.booleanOperator=he.AND:this.booleanOperator=he.OR,this.compendiumBrowser.render()})),e.querySelector("input[name=choice-query]")?.addEventListener("input",(t=>this._debouncedFilterChoices(t,e))),e.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target,s=/filter.\w*.choice.(?<choice>.*)/.exec(t.name)?.groups?.choice;s&&(this.toggleChoice(s,t.checked),this.compendiumBrowser.render())}}))}_onCustomSearchFilter(e,t){e&&(e.preventDefault(),this._choiceQuery=SearchFilter.cleanQuery(e.target.value));const s=ne.go(this._choiceQuery,this.choices.contents,{key:"label",threshold:-1e4}).map((e=>""+e.obj.key)),n=new Set(s);for(const e of t.querySelectorAll("li.filter-choice")){const t=e.dataset.choice;t&&(n.has(t)||!this._choiceQuery?e.classList.remove("hidden"):e.classList.add("hidden"))}this._choiceQuery&&0===s.length?t.querySelector("span.no-choices")?.classList.remove("hidden"):t.querySelector("span.no-choices")?.classList.add("hidden")}}const he={AND:"AND",OR:"OR",NONE:!1};class NumberRangeFilter extends BaseFilter{static TEMPLATE="systems/ffd20/templates/apps/compendium-browser/minmax-filter.hbs";prepareChoices(){this.choices=new foundry.utils.Collection([{key:"min",label:"FFD20.Minimum",placeholder:"0"},{key:"max",label:"FFD20.Maximum",placeholder:"∞"}].map((e=>[e.key,{...e,label:game.i18n.localize(e.label)}])))}reset(){this.choices.forEach((e=>{e.value=null,e.active=!1}))}activateListeners(e){e.addEventListener("change",(e=>{const t=e.target,s=t.value,n=t.name.split("choice.").pop(),l=this.choices.get(n);l&&(l.value=Number(s)||null,l.active=!!s),this.compendiumBrowser.render()}))}applyFilter(e){const t=foundry.utils.getProperty(e,this.constructor.indexField)??0,s=this.choices.get("min").value??0,n=this.choices.get("max").value??1/0;return!(t<s)&&!(t>n)}}class ItemTypeFilter extends CheckboxFilter{static label="FFD20.Type";static indexField="type";static types=["weapon","equipment","consumable","container","loot"];prepareChoices(){this.choices=new foundry.utils.Collection([{key:"weapon",label:game.i18n.localize("FFD20.ItemTypeWeapon")},{key:"equipment",label:game.i18n.localize("FFD20.ItemTypeEquipment")},{key:"consumable",label:game.i18n.localize("FFD20.ItemTypeConsumable")},{key:"container",label:game.i18n.localize("ITEM.TypeContainer")},{key:"loot",label:game.i18n.localize("FFD20.Misc")}].map((e=>[e.key,e])))}}class WeaponTypeFilter extends CheckboxFilter{static label="FFD20.WeaponType";static indexField="system.subType";static type="weapon";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes)}}class WeaponSubtypeFilter extends CheckboxFilter{static label="FFD20.WeaponSubtype";static indexField="system.weaponSubtype";static type="weapon";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes,{innerSet:!0})}}class WeaponPropertyFilter extends CheckboxFilter{static label="FFD20.WeaponProperties";static indexField="system.properties";static type="weapon";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.weaponProperties)}}class WeaponGroupFilter extends CheckboxFilter{static label="FFD20.WeaponGroups";static indexField="system.weaponGroups.value";static type="weapon";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.weaponGroups)}}class EquipmentTypeFilter extends CheckboxFilter{static label="FFD20.EquipmentType";static indexField="system.subType";static type="equipment";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes)}}class EquipmentSubtypeFilter extends CheckboxFilter{static label="FFD20.EquipmentSubtype";static indexField="system.equipmentSubtype";static type="equipment";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes,{innerSet:!0})}}class ItemSlotFilter extends CheckboxFilter{static label="FFD20.Slot";static indexField="system.slot";static type="equipment";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.equipmentSlots,{innerSet:!0})}}class ConsumableTypeFilter extends CheckboxFilter{static label="FFD20.ConsumableType";static indexField="system.subType";static type="consumable";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.consumableTypes)}}class MiscItemTypeFilter extends CheckboxFilter{static label="FFD20.Misc";static indexField="system.subType";static type="loot";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.lootTypes)}}class ItemPriceFilter extends NumberRangeFilter{static label="FFD20.Price";static indexField="system.price"}class ItemCasterLevelFilter extends NumberRangeFilter{static label="FFD20.CasterLevel";static indexField="system.cl"}const pe=Object.freeze(Object.defineProperty({__proto__:null,ConsumableTypeFilter,EquipmentSubtypeFilter,EquipmentTypeFilter,ItemCasterLevelFilter,ItemPriceFilter,ItemSlotFilter,ItemTypeFilter,MiscItemTypeFilter,WeaponGroupFilter,WeaponPropertyFilter,WeaponSubtypeFilter,WeaponTypeFilter},Symbol.toStringTag,{value:"Module"}));class PackFilter extends CheckboxFilter{static label="FFD20.Compendium";static indexField="__pack";prepareChoices(){const e=this.compendiumBrowser?.entries.contents,t=this.compendiumBrowser?.packs?.filter((t=>e.some((e=>e.__pack===t.collection)))).map((e=>({key:e.collection,label:e.metadata.label}))),s=naturalSort(t,"label").map((e=>[e.key,e]));this.choices=new foundry.utils.Collection(s)}}class TagFilter extends CheckboxFilter{static label="FFD20.Tags";static indexField="system.tags"}const fe=Object.freeze(Object.defineProperty({__proto__:null,PackFilter,TagFilter},Symbol.toStringTag,{value:"Module"}));class SpellSchoolFilter extends CheckboxFilter{static label="FFD20.SpellSchool";static indexField="system.school";static type="spell";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.spellSchools)}}class SpellMultiSchoolFilter extends CheckboxFilter{static label="FFD20.multiSchool";static indexField="system.school";static type="spell";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.multiSchools)}}class SpellSubSchoolFilter extends CheckboxFilter{static label="FFD20.SubSchool";static indexField="system.subschool";static type="spell"}class SpellDescriptorFilter extends CheckboxFilter{static label="FFD20.Descriptor";static indexField="system.types";static type="spell"}class SpellLearnedByClassFilter extends CheckboxFilter{static label="FFD20.Classes";static indexField="system.learnedAt.class";static type="spell"}class SpellLearnedByDomainFilter extends CheckboxFilter{static label="FFD20.Domain";static indexField="system.learnedAt.domain";static type="spell"}class SpellLearnedBySubdomainFilter extends CheckboxFilter{static label="FFD20.SubDomain";static indexField="system.learnedAt.subDomain";static type="spell"}class SpellLearnedByBloodlineFilter extends CheckboxFilter{static label="FFD20.Bloodline";static indexField="system.learnedAt.bloodline";static type="spell"}class SpellLevelFilter extends CheckboxFilter{static label="FFD20.SpellLevel";static indexField="system.level";static type="spell";prepareChoices(){const e=this.constructor.getChoicesFromConfig(ffd20.config.spellLevels);e.forEach((e=>{e.key=Number(e.key)})),this.choices=e}applyFilter(e){const t=this.compendiumBrowser.filters.filter((e=>e.active&&e.constructor.indexField.startsWith("system.learnedAt.")));if(0===t.length)return super.applyFilter(e);const s=this.booleanOperator===he.OR?"some":"every",n=this.choices.filter((e=>e.active));return t[s]((t=>{const l=getProperty(e,t.constructor.indexField)??{};return t.choices.filter((e=>e.active))[s]((e=>{const t=l[e.key];return n[s]((e=>e.key===t))}))}))}}const ge=Object.freeze(Object.defineProperty({__proto__:null,SpellDescriptorFilter,SpellLearnedByBloodlineFilter,SpellLearnedByClassFilter,SpellLearnedByDomainFilter,SpellLearnedBySubdomainFilter,SpellLevelFilter,SpellMultiSchoolFilter,SpellSchoolFilter,SpellSubSchoolFilter},Symbol.toStringTag,{value:"Module"}));class FeatTypeFilter extends CheckboxFilter{static label="FFD20.Type";static type="feat";static indexField="system.subType";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.featTypes)}}class FeatClassFilter extends CheckboxFilter{static label="FFD20.Classes";static type="feat";static indexField="system.associations.classes"}const ye=Object.freeze(Object.defineProperty({__proto__:null,FeatClassFilter,FeatTypeFilter},Symbol.toStringTag,{value:"Module"}));class ClassTypeFilter extends CheckboxFilter{static label="FFD20.ClassType";static type="class";static indexField="system.subType";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classTypes)}}class ClassHitDieFilter extends CheckboxFilter{static label="FFD20.HitDie";static type="class";static indexField="system.hd"}class ClassBaseAttackBonusFilter extends CheckboxFilter{static label="FFD20.BAB";static type="class";static indexField="system.bab";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classBAB)}}class ClassSkillPointsFilter extends CheckboxFilter{static label="FFD20.SkillsPerLevel";static type="class";static indexField="system.skillsPerLevel"}class ClassSavingThrowFilter extends CheckboxFilter{static type="class";static savingThrow="";static get label(){return ffd20.config.savingThrows[this.savingThrow]??""}static get indexField(){return`system.savingThrows.${this.savingThrow}.value`}prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classSavingThrows),this.choices.set("none",{label:game.i18n.localize("FFD20.None"),key:"none"})}applyFilter(e){const t=super.applyFilter(e),s=foundry.utils.getProperty(e,this.constructor.indexField),n=this.choices.get("none").active&&""===s;return t||n}}class ClassFortitudeFilter extends ClassSavingThrowFilter{static savingThrow="fort"}class ClassReflexFilter extends ClassSavingThrowFilter{static savingThrow="ref"}class ClassWillFilter extends ClassSavingThrowFilter{static savingThrow="will"}class ClassSubTypeFilter extends CheckboxFilter{static label="FFD20.ClassSubType";static type="class";static indexField="system.classSubType";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classSubTypes)}}class ClassParentFilter extends CheckboxFilter{static label="FFD20.ParentClass";static type="class";static indexField="system.parentClass"}class ClassMPFilter extends CheckboxFilter{static label="FFD20.ClassMPType";static type="class";static indexField="system.classBaseMPTypes";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classBaseMPTypes)}}class ClassCastingStatFilter extends CheckboxFilter{static label="FFD20.SpellcastingAbility";static type="class";static indexField="system.classCastingStat";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.classCastingStats)}}const be=Object.freeze(Object.defineProperty({__proto__:null,ClassBaseAttackBonusFilter,ClassCastingStatFilter,ClassFortitudeFilter,ClassHitDieFilter,ClassMPFilter,ClassParentFilter,ClassReflexFilter,ClassSkillPointsFilter,ClassSubTypeFilter,ClassTypeFilter,ClassWillFilter},Symbol.toStringTag,{value:"Module"}));class CreatureTypeFilter extends CheckboxFilter{static label="FFD20.CreatureType";static type="race";static indexField="system.creatureType";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.creatureTypes)}}class CreatureSubTypeFilter extends CheckboxFilter{static label="FFD20.RaceSubtypePlural";static type="race";static indexField="system.subTypes"}const Fe=Object.freeze(Object.defineProperty({__proto__:null,CreatureSubTypeFilter,CreatureTypeFilter},Symbol.toStringTag,{value:"Module"}));class BuffTypeFilter extends CheckboxFilter{static label="FFD20.Type";static type="buff";static indexField="system.subType";prepareChoices(){this.choices=this.constructor.getChoicesFromConfig(ffd20.config.buffTypes)}}class CreatureCRFilter extends CheckboxFilter{static label="FFD20.ChallengeRatingShort";static indexField="system.details.cr.base";static types=["character","npc"];prepareChoices(){super.prepareChoices();const t=this.choices.contents.map((e=>Number(e.key))).sort(((e,t)=>e-t)).map((t=>{const s=e.fromNumber(t);return[t.toString(),{key:t,label:s}]}));this.choices=new foundry.utils.Collection(t)}}const ke=Object.freeze(Object.defineProperty({__proto__:null,BaseFilter,CheckboxFilter,NumberRangeFilter,class:be,common:fe,feat:ye,item:pe,race:Fe,spell:ge},Symbol.toStringTag,{value:"Module"})),ve=Object.freeze(Object.defineProperty({__proto__:null,BuffBrowser:class BuffBrowser extends CompendiumBrowser{static documentName="Item";static typeName="FFD20.Buffs";static filterClasses=[PackFilter,BuffTypeFilter,TagFilter]},ClassBrowser:class ClassBrowser extends CompendiumBrowser{static typeName="FFD20.Classes";static filterClasses=[PackFilter,ClassTypeFilter,ClassSubTypeFilter,ClassParentFilter,ClassHitDieFilter,ClassMPFilter,ClassCastingStatFilter,ClassBaseAttackBonusFilter,ClassSkillPointsFilter,ClassFortitudeFilter,ClassReflexFilter,ClassWillFilter,TagFilter]},CompendiumBrowser,CreatureBrowser:class CreatureBrowser extends CompendiumBrowser{static documentName="Actor";static typeName="FFD20.Creatures";static filterClasses=[PackFilter,CreatureCRFilter]},FeatBrowser:class FeatBrowser extends CompendiumBrowser{static typeName="FFD20.Feats";static filterClasses=[PackFilter,FeatTypeFilter,FeatClassFilter,TagFilter]},ItemBrowser:class ItemBrowser extends CompendiumBrowser{static typeName="FFD20.Items";static filterClasses=[PackFilter,ItemTypeFilter,WeaponTypeFilter,WeaponSubtypeFilter,WeaponPropertyFilter,WeaponGroupFilter,EquipmentTypeFilter,EquipmentSubtypeFilter,ItemSlotFilter,ConsumableTypeFilter,MiscItemTypeFilter,ItemPriceFilter,ItemCasterLevelFilter,TagFilter];static _mapEntry(e,t){const s=super._mapEntry(e,t),{subType:n,equipmentSubtype:l}=s.system;if(n){const e=Object.keys(ffd20.config.equipmentTypes[n]??{}).filter((e=>!e.startsWith("_")));0===e.length?s.system.equipmentSubtype="":e.includes(l)||(s.system.equipmentSubtype=e.at(0))}return s}},RaceBrowser:class RaceBrowser extends CompendiumBrowser{static typeName="FFD20.Races";static filterClasses=[PackFilter,CreatureTypeFilter,CreatureSubTypeFilter,TagFilter]},SpellBrowser:class SpellBrowser extends CompendiumBrowser{static typeName="FFD20.Spells";static types=["spell"];static filterClasses=[PackFilter,SpellSchoolFilter,SpellMultiSchoolFilter,SpellSubSchoolFilter,SpellDescriptorFilter,SpellLearnedByClassFilter,SpellLearnedByDomainFilter,SpellLearnedBySubdomainFilter,SpellLearnedByBloodlineFilter,SpellLevelFilter,TagFilter];static _mapEntry(e,t){const s=super._mapEntry(e,t);for(const t of["subschool","types"])s.system[t]=e.system[t]?.split(/,|\Wor\s/).map((e=>{let t=e.trim();return t.includes("see text")?"see text":(t.startsWith("or")&&(t=t.replace("or").trim()),t)})).filter((e=>e.length))??[];const n=e.system.learnedAt??{},l=Object.values(n).map((e=>Object.values(e))).flat();return e.system.level&&l.push(e.system.level),s.system.level=[...new Set(l)],s}},filters:ke},Symbol.toStringTag,{value:"Module"}));class ActionChooser extends Application{constructor(e,t={}){super(t),this.item=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"systems/ffd20/templates/apps/action-chooser.hbs",classes:["ffd20","action-chooser"],width:400})}get title(){return game.i18n.format("FFD20.Application.ActionChooser.Title",{actor:this.item.actor.name??"",item:this.item.name})}async getData(e){const t=await super.getData(e);return t.item=this.item.toObject(),t.actions=this.item.system.actions,t}activateListeners(e){super.activateListeners(e),e.find(".action").on("click",this._onClickAction.bind(this))}_onClickAction(e){e.preventDefault();const t=e.currentTarget.dataset?.action;this.item.use({actionID:t,skipDialog:getSkipActionPrompt()}),this.close()}}class AttackDialog extends Application{constructor(e,t=null,s={},n={}){super(n),this.object=e,this.rollData=t||this.object.getRollData(),this.initAmmoUsage(),this.initAttacks(),this.base={cl:this.rollData.cl??0,sl:this.rollData.sl??0};const l="natural"===this.object.item.system.attackType,c=!0===this.object.data.naturalAttack.primaryAttack;this.flags={"primary-attack":c,"cl-check":!0===this.object.clCheck,"measure-template":!0};let u=this.rollData.action?.ability?.damageMult??1;l&&!c&&(u=this.rollData.action.naturalAttack?.secondary?.damageMult??.5),this.attributes={d20:this.rollData.d20??"","attack-bonus":"","damage-bonus":"","cl-offset":"0","sl-offset":"0",rollMode:s.rollMode||game.settings.get("core","rollMode"),"damage-ability-multiplier":u,held:this.rollData.item?.held??"normal"},this.conditionals={},this.object.conditionals?.contents.forEach(((e,t)=>{this.conditionals["conditional."+t]=!0===e.data.default})),this._callbacks={resolve:null,reject:null}}get title(){return"Use: "+this.object.name}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"systems/ffd20/templates/apps/attack-roll-dialog.hbs",classes:["ffd20","attack-dialog"],width:440,height:"auto",closeOnSubmit:!0,sheetConfig:!1,submitOnChange:!1,submitOnClose:!1})}static get defaultAttack(){return{label:"",attackBonus:0,attackBonusTotal:0,ammo:null}}getData(){return{data:this.rollData,item:this.object.data,config:ffd20.config,rollMode:game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes,hasAttack:this.object.hasAttack,hasDamage:this.object.hasDamage,hasDamageAbility:this.object.data.ability?.damage??!1,isNaturalAttack:"natural"===this.object.item.system.subType,isWeaponAttack:"weapon"===this.object.item.system.subType,isMeleeWeaponAttackAction:"mwak"===this.object.data.actionType,isRangedWeaponAttackAction:"rwak"===this.object.data.actionType,isAttack:"attack"===this.object.item.type,isWeapon:"weapon"===this.object.item.type,isSpell:"spell"===this.object.item.type,isFeat:"feat"===this.object.item.type,hasTemplate:this.object.hasTemplate,attacks:this.attacks,flags:this.flags,attributes:this.attributes,conditionals:this.conditionals,usesAmmo:this.object.data.usesAmmo,ammo:this.getAmmo()}}getAmmo(){return this.object.actor.items.filter(this._filterAmmo.bind(this)).map((e=>({data:e.toObject(),isDefault:this.object.item.getFlag("ffd20","defaultAmmo")===e.id})))}_filterAmmo(e){if("loot"!==e.type||"ammo"!==e.system.subType)return!1;if(e.system.quantity<=0)return!1;const t=this.object.data.ammoType,s=e.extraType;return!s||(t===s||void 0)}activateListeners(e){e.find('.flags input[type="checkbox"]').on("change",this._onToggleFlag.bind(this)),e.find("input.attribute").on("change",this._onChangeAttribute.bind(this)),e.find('input[type="checkbox"][name="concentration"]').on("change",this._onToggleFlag.bind(this)),e.find('input[type="checkbox"][name="cl-check"]').on("change",this._onToggleFlag.bind(this)),e.find('input[type="checkbox"][name="measure-template"]').on("change",this._onToggleFlag.bind(this)),e.find("select").on("change",this._onSelectChange.bind(this)),e.find('.conditionals input[type="checkbox"]').on("change",this._onToggleConditional.bind(this)),e.find(".ammo-select").on("click",this._onAmmoSelectClick.bind(this)),e.find(".ammo-select .ammo-item .controls a").on("click",this._onAmmoControlClick.bind(this)),e.find(".ammo-select .ammo-item").on("click",this._onAmmoClick.bind(this)),e.on("click",this._unfocusElements.bind(this)),e.find('button[name="attack_single"]').on("mouseenter",this._hideExtraAttacks.bind(this)),e.find('button[name="attack_single"]').on("mouseleave",this._showExtraAttacks.bind(this)),e.find('button[name="attack_single"]').on("click",this._onAttackSingle.bind(this)),e.find('button[name="attack_full"]').on("click",this._onAttackFull.bind(this))}_onSelectChange(e){e.preventDefault();const t=e.currentTarget;this.attributes[t.name]=t.options[t.selectedIndex].value,this.render()}_hideExtraAttacks(e){this.element.find(".attacks .attack").filter(((e,t)=>parseInt(t.dataset.index)>0)).addClass("disabled")}_showExtraAttacks(e){this.element.find(".attacks .attack").removeClass("disabled")}_onToggleFlag(e){e.preventDefault();const t=e.currentTarget;if(this.flags[t.name]=!0===t.checked,["haste-attack","rapid-shot","manyshot"].includes(t.name))if(t.checked){const e={"haste-attack":"FFD20.Haste","rapid-shot":"FFD20.RapidShot",manyshot:"FFD20.Manyshot"},s="manyshot"===t.name?1:this.attacks.length;this.attacks.splice(s,0,mergeObject(this.constructor.defaultAttack,{id:t.name,label:game.i18n.localize(e[t.name]),attackBonusTotal:""})),this.setAttackAmmo(s,this.object.item.getFlag("ffd20","defaultAmmo"))}else this.attacks=this.attacks.filter((e=>e.id!==t.name));this.render()}_onToggleConditional(e){e.preventDefault();const t=e.currentTarget;this.conditionals[t.name]=!0===t.checked,this.render()}_onAmmoSelectClick(e){e.preventDefault();const t=e.currentTarget,s=t.querySelector("ul");if(!e.target.closest("ul")){s.classList.toggle("open");s.classList.contains("open")?t.classList.add("focus"):t.classList.remove("focus")}}_onAmmoClick(e){const t=e.target;if(t.closest(".controls")&&!t.classList.contains("controls"))return;e.preventDefault();const s=t.closest(".ammo-item").dataset.id,n=parseInt(t.closest(".attack").dataset.index);this.setAttackAmmo(n,"null"===s?null:s),this.render()}async _onAmmoControlClick(e){e.preventDefault();const t=e.currentTarget,s=t.closest(".ammo-item").dataset.id;switch(t.dataset.type){case"set-default":"null"===s?await this.object.item.unsetFlag("ffd20","defaultAmmo"):await this.object.item.setFlag("ffd20","defaultAmmo",s),t.closest("ul").querySelectorAll(".ammo-item").forEach((e=>e.classList.remove("default"))),"null"!==s&&t.closest(".ammo-item").classList.add("default");break;case"set-all":for(let e=0;e<this.attacks.length;e++)this.setAttackAmmo(e,s);this.render()}}_unfocusElements(e){if(null!=this.element[0].querySelector(".ammo-select")&&!e.target.closest(".ammo-select")){const e=this.element[0].querySelector(".ammo-select");e.classList.remove("focus"),e.querySelector("ul").classList.remove("open")}}_onChangeAttribute(e){e.preventDefault();const t=e.currentTarget;switch(this.attributes[t.name]=t.value,t.name){case"cl-offset":this.rollData.cl=this.base.cl+parseInt(t.value);break;case"sl-offset":this.rollData.sl=this.base.sl+parseInt(t.value);break;case"damage-ability-multiplier":setProperty(this.rollData,"item.ability.damageMult",t.value);break;case"held":setProperty(this.rollData,"item.held",t.value)}this.render()}initAttacks(){this.attacks=new ActionUse({rollData:this.rollData,item:this.object.item}).generateAttacks(!0).map((({label:e,attackBonus:t})=>({label:e,attackBonus:t,attackBonusTotal:RollPF.safeTotal(t,this.rollData),ammo:null})));const e=this.object.item.getFlag("ffd20","defaultAmmo");if(null!=e)for(let t=0;t<this.attacks.length;t++)this.setAttackAmmo(t,e)}initAmmoUsage(){this.ammoUsage=this.getAmmo().reduce(((e,t)=>(e[t.data._id]={quantity:t.data.system.quantity,used:0},e)),{})}getFormAttacks(){return this.attacks.map((e=>({id:e.id,label:e.label,attackBonus:e.attackBonus,ammo:e.ammo?.data._id})))}setAttackAmmo(e,t=null){if(!this.object.data.usesAmmo)return;const s=this.attacks[e],n=s.ammo?.data._id,l=t?this.object.actor.items.get(t):null,c=l?.flags?.ffd20?.abundant??!1;if(t&&null==this.ammoUsage[t]&&(t=null),!t)return s.ammo=null,void(null!=n&&this.ammoUsage[n].used--);!c&&this.ammoUsage[t].used>=this.ammoUsage[t].quantity||(s.ammo=this.getAmmo().find((e=>e.data._id===t)),null!=n&&this.ammoUsage[n].used--,this.ammoUsage[t].used++)}_onAttackSingle(e){e.preventDefault();const t=this.getFormAttacks();return this.doAttack(t.slice(0,1),!1)}_onAttackFull(e){e.preventDefault();const t=this.getFormAttacks();return this.doAttack(t,!0)}doAttack(e,t=!0){this._callbacks.resolve({fullAttack:t,attacks:e,html:this.element}),this._callbacks.resolve=null,this.close()}async close(e={}){return null!=this._callbacks.resolve&&this._callbacks.resolve(),super.close(e)}show(){return new Promise(((e,t)=>{this.render(!0),this._callbacks.resolve=(...t)=>{e(...t)},this._callbacks.reject=(...e)=>{t(...e)}}))}}var De={};var Ce={Aacute:"Á",aacute:"á",Abreve:"Ă",abreve:"ă",ac:"∾",acd:"∿",acE:"∾̳",Acirc:"Â",acirc:"â",acute:"´",Acy:"А",acy:"а",AElig:"Æ",aelig:"æ",af:"⁡",Afr:"𝔄",afr:"𝔞",Agrave:"À",agrave:"à",alefsym:"ℵ",aleph:"ℵ",Alpha:"Α",alpha:"α",Amacr:"Ā",amacr:"ā",amalg:"⨿",amp:"&",AMP:"&",andand:"⩕",And:"⩓",and:"∧",andd:"⩜",andslope:"⩘",andv:"⩚",ang:"∠",ange:"⦤",angle:"∠",angmsdaa:"⦨",angmsdab:"⦩",angmsdac:"⦪",angmsdad:"⦫",angmsdae:"⦬",angmsdaf:"⦭",angmsdag:"⦮",angmsdah:"⦯",angmsd:"∡",angrt:"∟",angrtvb:"⊾",angrtvbd:"⦝",angsph:"∢",angst:"Å",angzarr:"⍼",Aogon:"Ą",aogon:"ą",Aopf:"𝔸",aopf:"𝕒",apacir:"⩯",ap:"≈",apE:"⩰",ape:"≊",apid:"≋",apos:"'",ApplyFunction:"⁡",approx:"≈",approxeq:"≊",Aring:"Å",aring:"å",Ascr:"𝒜",ascr:"𝒶",Assign:"≔",ast:"*",asymp:"≈",asympeq:"≍",Atilde:"Ã",atilde:"ã",Auml:"Ä",auml:"ä",awconint:"∳",awint:"⨑",backcong:"≌",backepsilon:"϶",backprime:"‵",backsim:"∽",backsimeq:"⋍",Backslash:"∖",Barv:"⫧",barvee:"⊽",barwed:"⌅",Barwed:"⌆",barwedge:"⌅",bbrk:"⎵",bbrktbrk:"⎶",bcong:"≌",Bcy:"Б",bcy:"б",bdquo:"„",becaus:"∵",because:"∵",Because:"∵",bemptyv:"⦰",bepsi:"϶",bernou:"ℬ",Bernoullis:"ℬ",Beta:"Β",beta:"β",beth:"ℶ",between:"≬",Bfr:"𝔅",bfr:"𝔟",bigcap:"⋂",bigcirc:"◯",bigcup:"⋃",bigodot:"⨀",bigoplus:"⨁",bigotimes:"⨂",bigsqcup:"⨆",bigstar:"★",bigtriangledown:"▽",bigtriangleup:"△",biguplus:"⨄",bigvee:"⋁",bigwedge:"⋀",bkarow:"⤍",blacklozenge:"⧫",blacksquare:"▪",blacktriangle:"▴",blacktriangledown:"▾",blacktriangleleft:"◂",blacktriangleright:"▸",blank:"␣",blk12:"▒",blk14:"░",blk34:"▓",block:"█",bne:"=⃥",bnequiv:"≡⃥",bNot:"⫭",bnot:"⌐",Bopf:"𝔹",bopf:"𝕓",bot:"⊥",bottom:"⊥",bowtie:"⋈",boxbox:"⧉",boxdl:"┐",boxdL:"╕",boxDl:"╖",boxDL:"╗",boxdr:"┌",boxdR:"╒",boxDr:"╓",boxDR:"╔",boxh:"─",boxH:"═",boxhd:"┬",boxHd:"╤",boxhD:"╥",boxHD:"╦",boxhu:"┴",boxHu:"╧",boxhU:"╨",boxHU:"╩",boxminus:"⊟",boxplus:"⊞",boxtimes:"⊠",boxul:"┘",boxuL:"╛",boxUl:"╜",boxUL:"╝",boxur:"└",boxuR:"╘",boxUr:"╙",boxUR:"╚",boxv:"│",boxV:"║",boxvh:"┼",boxvH:"╪",boxVh:"╫",boxVH:"╬",boxvl:"┤",boxvL:"╡",boxVl:"╢",boxVL:"╣",boxvr:"├",boxvR:"╞",boxVr:"╟",boxVR:"╠",bprime:"‵",breve:"˘",Breve:"˘",brvbar:"¦",bscr:"𝒷",Bscr:"ℬ",bsemi:"⁏",bsim:"∽",bsime:"⋍",bsolb:"⧅",bsol:"\\",bsolhsub:"⟈",bull:"•",bullet:"•",bump:"≎",bumpE:"⪮",bumpe:"≏",Bumpeq:"≎",bumpeq:"≏",Cacute:"Ć",cacute:"ć",capand:"⩄",capbrcup:"⩉",capcap:"⩋",cap:"∩",Cap:"⋒",capcup:"⩇",capdot:"⩀",CapitalDifferentialD:"ⅅ",caps:"∩︀",caret:"⁁",caron:"ˇ",Cayleys:"ℭ",ccaps:"⩍",Ccaron:"Č",ccaron:"č",Ccedil:"Ç",ccedil:"ç",Ccirc:"Ĉ",ccirc:"ĉ",Cconint:"∰",ccups:"⩌",ccupssm:"⩐",Cdot:"Ċ",cdot:"ċ",cedil:"¸",Cedilla:"¸",cemptyv:"⦲",cent:"¢",centerdot:"·",CenterDot:"·",cfr:"𝔠",Cfr:"ℭ",CHcy:"Ч",chcy:"ч",check:"✓",checkmark:"✓",Chi:"Χ",chi:"χ",circ:"ˆ",circeq:"≗",circlearrowleft:"↺",circlearrowright:"↻",circledast:"⊛",circledcirc:"⊚",circleddash:"⊝",CircleDot:"⊙",circledR:"®",circledS:"Ⓢ",CircleMinus:"⊖",CirclePlus:"⊕",CircleTimes:"⊗",cir:"○",cirE:"⧃",cire:"≗",cirfnint:"⨐",cirmid:"⫯",cirscir:"⧂",ClockwiseContourIntegral:"∲",CloseCurlyDoubleQuote:"”",CloseCurlyQuote:"’",clubs:"♣",clubsuit:"♣",colon:":",Colon:"∷",Colone:"⩴",colone:"≔",coloneq:"≔",comma:",",commat:"@",comp:"∁",compfn:"∘",complement:"∁",complexes:"ℂ",cong:"≅",congdot:"⩭",Congruent:"≡",conint:"∮",Conint:"∯",ContourIntegral:"∮",copf:"𝕔",Copf:"ℂ",coprod:"∐",Coproduct:"∐",copy:"©",COPY:"©",copysr:"℗",CounterClockwiseContourIntegral:"∳",crarr:"↵",cross:"✗",Cross:"⨯",Cscr:"𝒞",cscr:"𝒸",csub:"⫏",csube:"⫑",csup:"⫐",csupe:"⫒",ctdot:"⋯",cudarrl:"⤸",cudarrr:"⤵",cuepr:"⋞",cuesc:"⋟",cularr:"↶",cularrp:"⤽",cupbrcap:"⩈",cupcap:"⩆",CupCap:"≍",cup:"∪",Cup:"⋓",cupcup:"⩊",cupdot:"⊍",cupor:"⩅",cups:"∪︀",curarr:"↷",curarrm:"⤼",curlyeqprec:"⋞",curlyeqsucc:"⋟",curlyvee:"⋎",curlywedge:"⋏",curren:"¤",curvearrowleft:"↶",curvearrowright:"↷",cuvee:"⋎",cuwed:"⋏",cwconint:"∲",cwint:"∱",cylcty:"⌭",dagger:"†",Dagger:"‡",daleth:"ℸ",darr:"↓",Darr:"↡",dArr:"⇓",dash:"‐",Dashv:"⫤",dashv:"⊣",dbkarow:"⤏",dblac:"˝",Dcaron:"Ď",dcaron:"ď",Dcy:"Д",dcy:"д",ddagger:"‡",ddarr:"⇊",DD:"ⅅ",dd:"ⅆ",DDotrahd:"⤑",ddotseq:"⩷",deg:"°",Del:"∇",Delta:"Δ",delta:"δ",demptyv:"⦱",dfisht:"⥿",Dfr:"𝔇",dfr:"𝔡",dHar:"⥥",dharl:"⇃",dharr:"⇂",DiacriticalAcute:"´",DiacriticalDot:"˙",DiacriticalDoubleAcute:"˝",DiacriticalGrave:"`",DiacriticalTilde:"˜",diam:"⋄",diamond:"⋄",Diamond:"⋄",diamondsuit:"♦",diams:"♦",die:"¨",DifferentialD:"ⅆ",digamma:"ϝ",disin:"⋲",div:"÷",divide:"÷",divideontimes:"⋇",divonx:"⋇",DJcy:"Ђ",djcy:"ђ",dlcorn:"⌞",dlcrop:"⌍",dollar:"$",Dopf:"𝔻",dopf:"𝕕",Dot:"¨",dot:"˙",DotDot:"⃜",doteq:"≐",doteqdot:"≑",DotEqual:"≐",dotminus:"∸",dotplus:"∔",dotsquare:"⊡",doublebarwedge:"⌆",DoubleContourIntegral:"∯",DoubleDot:"¨",DoubleDownArrow:"⇓",DoubleLeftArrow:"⇐",DoubleLeftRightArrow:"⇔",DoubleLeftTee:"⫤",DoubleLongLeftArrow:"⟸",DoubleLongLeftRightArrow:"⟺",DoubleLongRightArrow:"⟹",DoubleRightArrow:"⇒",DoubleRightTee:"⊨",DoubleUpArrow:"⇑",DoubleUpDownArrow:"⇕",DoubleVerticalBar:"∥",DownArrowBar:"⤓",downarrow:"↓",DownArrow:"↓",Downarrow:"⇓",DownArrowUpArrow:"⇵",DownBreve:"̑",downdownarrows:"⇊",downharpoonleft:"⇃",downharpoonright:"⇂",DownLeftRightVector:"⥐",DownLeftTeeVector:"⥞",DownLeftVectorBar:"⥖",DownLeftVector:"↽",DownRightTeeVector:"⥟",DownRightVectorBar:"⥗",DownRightVector:"⇁",DownTeeArrow:"↧",DownTee:"⊤",drbkarow:"⤐",drcorn:"⌟",drcrop:"⌌",Dscr:"𝒟",dscr:"𝒹",DScy:"Ѕ",dscy:"ѕ",dsol:"⧶",Dstrok:"Đ",dstrok:"đ",dtdot:"⋱",dtri:"▿",dtrif:"▾",duarr:"⇵",duhar:"⥯",dwangle:"⦦",DZcy:"Џ",dzcy:"џ",dzigrarr:"⟿",Eacute:"É",eacute:"é",easter:"⩮",Ecaron:"Ě",ecaron:"ě",Ecirc:"Ê",ecirc:"ê",ecir:"≖",ecolon:"≕",Ecy:"Э",ecy:"э",eDDot:"⩷",Edot:"Ė",edot:"ė",eDot:"≑",ee:"ⅇ",efDot:"≒",Efr:"𝔈",efr:"𝔢",eg:"⪚",Egrave:"È",egrave:"è",egs:"⪖",egsdot:"⪘",el:"⪙",Element:"∈",elinters:"⏧",ell:"ℓ",els:"⪕",elsdot:"⪗",Emacr:"Ē",emacr:"ē",empty:"∅",emptyset:"∅",EmptySmallSquare:"◻",emptyv:"∅",EmptyVerySmallSquare:"▫",emsp13:" ",emsp14:" ",emsp:" ",ENG:"Ŋ",eng:"ŋ",ensp:" ",Eogon:"Ę",eogon:"ę",Eopf:"𝔼",eopf:"𝕖",epar:"⋕",eparsl:"⧣",eplus:"⩱",epsi:"ε",Epsilon:"Ε",epsilon:"ε",epsiv:"ϵ",eqcirc:"≖",eqcolon:"≕",eqsim:"≂",eqslantgtr:"⪖",eqslantless:"⪕",Equal:"⩵",equals:"=",EqualTilde:"≂",equest:"≟",Equilibrium:"⇌",equiv:"≡",equivDD:"⩸",eqvparsl:"⧥",erarr:"⥱",erDot:"≓",escr:"ℯ",Escr:"ℰ",esdot:"≐",Esim:"⩳",esim:"≂",Eta:"Η",eta:"η",ETH:"Ð",eth:"ð",Euml:"Ë",euml:"ë",euro:"€",excl:"!",exist:"∃",Exists:"∃",expectation:"ℰ",exponentiale:"ⅇ",ExponentialE:"ⅇ",fallingdotseq:"≒",Fcy:"Ф",fcy:"ф",female:"♀",ffilig:"ﬃ",fflig:"ﬀ",ffllig:"ﬄ",Ffr:"𝔉",ffr:"𝔣",filig:"ﬁ",FilledSmallSquare:"◼",FilledVerySmallSquare:"▪",fjlig:"fj",flat:"♭",fllig:"ﬂ",fltns:"▱",fnof:"ƒ",Fopf:"𝔽",fopf:"𝕗",forall:"∀",ForAll:"∀",fork:"⋔",forkv:"⫙",Fouriertrf:"ℱ",fpartint:"⨍",frac12:"½",frac13:"⅓",frac14:"¼",frac15:"⅕",frac16:"⅙",frac18:"⅛",frac23:"⅔",frac25:"⅖",frac34:"¾",frac35:"⅗",frac38:"⅜",frac45:"⅘",frac56:"⅚",frac58:"⅝",frac78:"⅞",frasl:"⁄",frown:"⌢",fscr:"𝒻",Fscr:"ℱ",gacute:"ǵ",Gamma:"Γ",gamma:"γ",Gammad:"Ϝ",gammad:"ϝ",gap:"⪆",Gbreve:"Ğ",gbreve:"ğ",Gcedil:"Ģ",Gcirc:"Ĝ",gcirc:"ĝ",Gcy:"Г",gcy:"г",Gdot:"Ġ",gdot:"ġ",ge:"≥",gE:"≧",gEl:"⪌",gel:"⋛",geq:"≥",geqq:"≧",geqslant:"⩾",gescc:"⪩",ges:"⩾",gesdot:"⪀",gesdoto:"⪂",gesdotol:"⪄",gesl:"⋛︀",gesles:"⪔",Gfr:"𝔊",gfr:"𝔤",gg:"≫",Gg:"⋙",ggg:"⋙",gimel:"ℷ",GJcy:"Ѓ",gjcy:"ѓ",gla:"⪥",gl:"≷",glE:"⪒",glj:"⪤",gnap:"⪊",gnapprox:"⪊",gne:"⪈",gnE:"≩",gneq:"⪈",gneqq:"≩",gnsim:"⋧",Gopf:"𝔾",gopf:"𝕘",grave:"`",GreaterEqual:"≥",GreaterEqualLess:"⋛",GreaterFullEqual:"≧",GreaterGreater:"⪢",GreaterLess:"≷",GreaterSlantEqual:"⩾",GreaterTilde:"≳",Gscr:"𝒢",gscr:"ℊ",gsim:"≳",gsime:"⪎",gsiml:"⪐",gtcc:"⪧",gtcir:"⩺",gt:">",GT:">",Gt:"≫",gtdot:"⋗",gtlPar:"⦕",gtquest:"⩼",gtrapprox:"⪆",gtrarr:"⥸",gtrdot:"⋗",gtreqless:"⋛",gtreqqless:"⪌",gtrless:"≷",gtrsim:"≳",gvertneqq:"≩︀",gvnE:"≩︀",Hacek:"ˇ",hairsp:" ",half:"½",hamilt:"ℋ",HARDcy:"Ъ",hardcy:"ъ",harrcir:"⥈",harr:"↔",hArr:"⇔",harrw:"↭",Hat:"^",hbar:"ℏ",Hcirc:"Ĥ",hcirc:"ĥ",hearts:"♥",heartsuit:"♥",hellip:"…",hercon:"⊹",hfr:"𝔥",Hfr:"ℌ",HilbertSpace:"ℋ",hksearow:"⤥",hkswarow:"⤦",hoarr:"⇿",homtht:"∻",hookleftarrow:"↩",hookrightarrow:"↪",hopf:"𝕙",Hopf:"ℍ",horbar:"―",HorizontalLine:"─",hscr:"𝒽",Hscr:"ℋ",hslash:"ℏ",Hstrok:"Ħ",hstrok:"ħ",HumpDownHump:"≎",HumpEqual:"≏",hybull:"⁃",hyphen:"‐",Iacute:"Í",iacute:"í",ic:"⁣",Icirc:"Î",icirc:"î",Icy:"И",icy:"и",Idot:"İ",IEcy:"Е",iecy:"е",iexcl:"¡",iff:"⇔",ifr:"𝔦",Ifr:"ℑ",Igrave:"Ì",igrave:"ì",ii:"ⅈ",iiiint:"⨌",iiint:"∭",iinfin:"⧜",iiota:"℩",IJlig:"Ĳ",ijlig:"ĳ",Imacr:"Ī",imacr:"ī",image:"ℑ",ImaginaryI:"ⅈ",imagline:"ℐ",imagpart:"ℑ",imath:"ı",Im:"ℑ",imof:"⊷",imped:"Ƶ",Implies:"⇒",incare:"℅",in:"∈",infin:"∞",infintie:"⧝",inodot:"ı",intcal:"⊺",int:"∫",Int:"∬",integers:"ℤ",Integral:"∫",intercal:"⊺",Intersection:"⋂",intlarhk:"⨗",intprod:"⨼",InvisibleComma:"⁣",InvisibleTimes:"⁢",IOcy:"Ё",iocy:"ё",Iogon:"Į",iogon:"į",Iopf:"𝕀",iopf:"𝕚",Iota:"Ι",iota:"ι",iprod:"⨼",iquest:"¿",iscr:"𝒾",Iscr:"ℐ",isin:"∈",isindot:"⋵",isinE:"⋹",isins:"⋴",isinsv:"⋳",isinv:"∈",it:"⁢",Itilde:"Ĩ",itilde:"ĩ",Iukcy:"І",iukcy:"і",Iuml:"Ï",iuml:"ï",Jcirc:"Ĵ",jcirc:"ĵ",Jcy:"Й",jcy:"й",Jfr:"𝔍",jfr:"𝔧",jmath:"ȷ",Jopf:"𝕁",jopf:"𝕛",Jscr:"𝒥",jscr:"𝒿",Jsercy:"Ј",jsercy:"ј",Jukcy:"Є",jukcy:"є",Kappa:"Κ",kappa:"κ",kappav:"ϰ",Kcedil:"Ķ",kcedil:"ķ",Kcy:"К",kcy:"к",Kfr:"𝔎",kfr:"𝔨",kgreen:"ĸ",KHcy:"Х",khcy:"х",KJcy:"Ќ",kjcy:"ќ",Kopf:"𝕂",kopf:"𝕜",Kscr:"𝒦",kscr:"𝓀",lAarr:"⇚",Lacute:"Ĺ",lacute:"ĺ",laemptyv:"⦴",lagran:"ℒ",Lambda:"Λ",lambda:"λ",lang:"⟨",Lang:"⟪",langd:"⦑",langle:"⟨",lap:"⪅",Laplacetrf:"ℒ",laquo:"«",larrb:"⇤",larrbfs:"⤟",larr:"←",Larr:"↞",lArr:"⇐",larrfs:"⤝",larrhk:"↩",larrlp:"↫",larrpl:"⤹",larrsim:"⥳",larrtl:"↢",latail:"⤙",lAtail:"⤛",lat:"⪫",late:"⪭",lates:"⪭︀",lbarr:"⤌",lBarr:"⤎",lbbrk:"❲",lbrace:"{",lbrack:"[",lbrke:"⦋",lbrksld:"⦏",lbrkslu:"⦍",Lcaron:"Ľ",lcaron:"ľ",Lcedil:"Ļ",lcedil:"ļ",lceil:"⌈",lcub:"{",Lcy:"Л",lcy:"л",ldca:"⤶",ldquo:"“",ldquor:"„",ldrdhar:"⥧",ldrushar:"⥋",ldsh:"↲",le:"≤",lE:"≦",LeftAngleBracket:"⟨",LeftArrowBar:"⇤",leftarrow:"←",LeftArrow:"←",Leftarrow:"⇐",LeftArrowRightArrow:"⇆",leftarrowtail:"↢",LeftCeiling:"⌈",LeftDoubleBracket:"⟦",LeftDownTeeVector:"⥡",LeftDownVectorBar:"⥙",LeftDownVector:"⇃",LeftFloor:"⌊",leftharpoondown:"↽",leftharpoonup:"↼",leftleftarrows:"⇇",leftrightarrow:"↔",LeftRightArrow:"↔",Leftrightarrow:"⇔",leftrightarrows:"⇆",leftrightharpoons:"⇋",leftrightsquigarrow:"↭",LeftRightVector:"⥎",LeftTeeArrow:"↤",LeftTee:"⊣",LeftTeeVector:"⥚",leftthreetimes:"⋋",LeftTriangleBar:"⧏",LeftTriangle:"⊲",LeftTriangleEqual:"⊴",LeftUpDownVector:"⥑",LeftUpTeeVector:"⥠",LeftUpVectorBar:"⥘",LeftUpVector:"↿",LeftVectorBar:"⥒",LeftVector:"↼",lEg:"⪋",leg:"⋚",leq:"≤",leqq:"≦",leqslant:"⩽",lescc:"⪨",les:"⩽",lesdot:"⩿",lesdoto:"⪁",lesdotor:"⪃",lesg:"⋚︀",lesges:"⪓",lessapprox:"⪅",lessdot:"⋖",lesseqgtr:"⋚",lesseqqgtr:"⪋",LessEqualGreater:"⋚",LessFullEqual:"≦",LessGreater:"≶",lessgtr:"≶",LessLess:"⪡",lesssim:"≲",LessSlantEqual:"⩽",LessTilde:"≲",lfisht:"⥼",lfloor:"⌊",Lfr:"𝔏",lfr:"𝔩",lg:"≶",lgE:"⪑",lHar:"⥢",lhard:"↽",lharu:"↼",lharul:"⥪",lhblk:"▄",LJcy:"Љ",ljcy:"љ",llarr:"⇇",ll:"≪",Ll:"⋘",llcorner:"⌞",Lleftarrow:"⇚",llhard:"⥫",lltri:"◺",Lmidot:"Ŀ",lmidot:"ŀ",lmoustache:"⎰",lmoust:"⎰",lnap:"⪉",lnapprox:"⪉",lne:"⪇",lnE:"≨",lneq:"⪇",lneqq:"≨",lnsim:"⋦",loang:"⟬",loarr:"⇽",lobrk:"⟦",longleftarrow:"⟵",LongLeftArrow:"⟵",Longleftarrow:"⟸",longleftrightarrow:"⟷",LongLeftRightArrow:"⟷",Longleftrightarrow:"⟺",longmapsto:"⟼",longrightarrow:"⟶",LongRightArrow:"⟶",Longrightarrow:"⟹",looparrowleft:"↫",looparrowright:"↬",lopar:"⦅",Lopf:"𝕃",lopf:"𝕝",loplus:"⨭",lotimes:"⨴",lowast:"∗",lowbar:"_",LowerLeftArrow:"↙",LowerRightArrow:"↘",loz:"◊",lozenge:"◊",lozf:"⧫",lpar:"(",lparlt:"⦓",lrarr:"⇆",lrcorner:"⌟",lrhar:"⇋",lrhard:"⥭",lrm:"‎",lrtri:"⊿",lsaquo:"‹",lscr:"𝓁",Lscr:"ℒ",lsh:"↰",Lsh:"↰",lsim:"≲",lsime:"⪍",lsimg:"⪏",lsqb:"[",lsquo:"‘",lsquor:"‚",Lstrok:"Ł",lstrok:"ł",ltcc:"⪦",ltcir:"⩹",lt:"<",LT:"<",Lt:"≪",ltdot:"⋖",lthree:"⋋",ltimes:"⋉",ltlarr:"⥶",ltquest:"⩻",ltri:"◃",ltrie:"⊴",ltrif:"◂",ltrPar:"⦖",lurdshar:"⥊",luruhar:"⥦",lvertneqq:"≨︀",lvnE:"≨︀",macr:"¯",male:"♂",malt:"✠",maltese:"✠",Map:"⤅",map:"↦",mapsto:"↦",mapstodown:"↧",mapstoleft:"↤",mapstoup:"↥",marker:"▮",mcomma:"⨩",Mcy:"М",mcy:"м",mdash:"—",mDDot:"∺",measuredangle:"∡",MediumSpace:" ",Mellintrf:"ℳ",Mfr:"𝔐",mfr:"𝔪",mho:"℧",micro:"µ",midast:"*",midcir:"⫰",mid:"∣",middot:"·",minusb:"⊟",minus:"−",minusd:"∸",minusdu:"⨪",MinusPlus:"∓",mlcp:"⫛",mldr:"…",mnplus:"∓",models:"⊧",Mopf:"𝕄",mopf:"𝕞",mp:"∓",mscr:"𝓂",Mscr:"ℳ",mstpos:"∾",Mu:"Μ",mu:"μ",multimap:"⊸",mumap:"⊸",nabla:"∇",Nacute:"Ń",nacute:"ń",nang:"∠⃒",nap:"≉",napE:"⩰̸",napid:"≋̸",napos:"ŉ",napprox:"≉",natural:"♮",naturals:"ℕ",natur:"♮",nbsp:" ",nbump:"≎̸",nbumpe:"≏̸",ncap:"⩃",Ncaron:"Ň",ncaron:"ň",Ncedil:"Ņ",ncedil:"ņ",ncong:"≇",ncongdot:"⩭̸",ncup:"⩂",Ncy:"Н",ncy:"н",ndash:"–",nearhk:"⤤",nearr:"↗",neArr:"⇗",nearrow:"↗",ne:"≠",nedot:"≐̸",NegativeMediumSpace:"​",NegativeThickSpace:"​",NegativeThinSpace:"​",NegativeVeryThinSpace:"​",nequiv:"≢",nesear:"⤨",nesim:"≂̸",NestedGreaterGreater:"≫",NestedLessLess:"≪",NewLine:"\n",nexist:"∄",nexists:"∄",Nfr:"𝔑",nfr:"𝔫",ngE:"≧̸",nge:"≱",ngeq:"≱",ngeqq:"≧̸",ngeqslant:"⩾̸",nges:"⩾̸",nGg:"⋙̸",ngsim:"≵",nGt:"≫⃒",ngt:"≯",ngtr:"≯",nGtv:"≫̸",nharr:"↮",nhArr:"⇎",nhpar:"⫲",ni:"∋",nis:"⋼",nisd:"⋺",niv:"∋",NJcy:"Њ",njcy:"њ",nlarr:"↚",nlArr:"⇍",nldr:"‥",nlE:"≦̸",nle:"≰",nleftarrow:"↚",nLeftarrow:"⇍",nleftrightarrow:"↮",nLeftrightarrow:"⇎",nleq:"≰",nleqq:"≦̸",nleqslant:"⩽̸",nles:"⩽̸",nless:"≮",nLl:"⋘̸",nlsim:"≴",nLt:"≪⃒",nlt:"≮",nltri:"⋪",nltrie:"⋬",nLtv:"≪̸",nmid:"∤",NoBreak:"⁠",NonBreakingSpace:" ",nopf:"𝕟",Nopf:"ℕ",Not:"⫬",not:"¬",NotCongruent:"≢",NotCupCap:"≭",NotDoubleVerticalBar:"∦",NotElement:"∉",NotEqual:"≠",NotEqualTilde:"≂̸",NotExists:"∄",NotGreater:"≯",NotGreaterEqual:"≱",NotGreaterFullEqual:"≧̸",NotGreaterGreater:"≫̸",NotGreaterLess:"≹",NotGreaterSlantEqual:"⩾̸",NotGreaterTilde:"≵",NotHumpDownHump:"≎̸",NotHumpEqual:"≏̸",notin:"∉",notindot:"⋵̸",notinE:"⋹̸",notinva:"∉",notinvb:"⋷",notinvc:"⋶",NotLeftTriangleBar:"⧏̸",NotLeftTriangle:"⋪",NotLeftTriangleEqual:"⋬",NotLess:"≮",NotLessEqual:"≰",NotLessGreater:"≸",NotLessLess:"≪̸",NotLessSlantEqual:"⩽̸",NotLessTilde:"≴",NotNestedGreaterGreater:"⪢̸",NotNestedLessLess:"⪡̸",notni:"∌",notniva:"∌",notnivb:"⋾",notnivc:"⋽",NotPrecedes:"⊀",NotPrecedesEqual:"⪯̸",NotPrecedesSlantEqual:"⋠",NotReverseElement:"∌",NotRightTriangleBar:"⧐̸",NotRightTriangle:"⋫",NotRightTriangleEqual:"⋭",NotSquareSubset:"⊏̸",NotSquareSubsetEqual:"⋢",NotSquareSuperset:"⊐̸",NotSquareSupersetEqual:"⋣",NotSubset:"⊂⃒",NotSubsetEqual:"⊈",NotSucceeds:"⊁",NotSucceedsEqual:"⪰̸",NotSucceedsSlantEqual:"⋡",NotSucceedsTilde:"≿̸",NotSuperset:"⊃⃒",NotSupersetEqual:"⊉",NotTilde:"≁",NotTildeEqual:"≄",NotTildeFullEqual:"≇",NotTildeTilde:"≉",NotVerticalBar:"∤",nparallel:"∦",npar:"∦",nparsl:"⫽⃥",npart:"∂̸",npolint:"⨔",npr:"⊀",nprcue:"⋠",nprec:"⊀",npreceq:"⪯̸",npre:"⪯̸",nrarrc:"⤳̸",nrarr:"↛",nrArr:"⇏",nrarrw:"↝̸",nrightarrow:"↛",nRightarrow:"⇏",nrtri:"⋫",nrtrie:"⋭",nsc:"⊁",nsccue:"⋡",nsce:"⪰̸",Nscr:"𝒩",nscr:"𝓃",nshortmid:"∤",nshortparallel:"∦",nsim:"≁",nsime:"≄",nsimeq:"≄",nsmid:"∤",nspar:"∦",nsqsube:"⋢",nsqsupe:"⋣",nsub:"⊄",nsubE:"⫅̸",nsube:"⊈",nsubset:"⊂⃒",nsubseteq:"⊈",nsubseteqq:"⫅̸",nsucc:"⊁",nsucceq:"⪰̸",nsup:"⊅",nsupE:"⫆̸",nsupe:"⊉",nsupset:"⊃⃒",nsupseteq:"⊉",nsupseteqq:"⫆̸",ntgl:"≹",Ntilde:"Ñ",ntilde:"ñ",ntlg:"≸",ntriangleleft:"⋪",ntrianglelefteq:"⋬",ntriangleright:"⋫",ntrianglerighteq:"⋭",Nu:"Ν",nu:"ν",num:"#",numero:"№",numsp:" ",nvap:"≍⃒",nvdash:"⊬",nvDash:"⊭",nVdash:"⊮",nVDash:"⊯",nvge:"≥⃒",nvgt:">⃒",nvHarr:"⤄",nvinfin:"⧞",nvlArr:"⤂",nvle:"≤⃒",nvlt:"<⃒",nvltrie:"⊴⃒",nvrArr:"⤃",nvrtrie:"⊵⃒",nvsim:"∼⃒",nwarhk:"⤣",nwarr:"↖",nwArr:"⇖",nwarrow:"↖",nwnear:"⤧",Oacute:"Ó",oacute:"ó",oast:"⊛",Ocirc:"Ô",ocirc:"ô",ocir:"⊚",Ocy:"О",ocy:"о",odash:"⊝",Odblac:"Ő",odblac:"ő",odiv:"⨸",odot:"⊙",odsold:"⦼",OElig:"Œ",oelig:"œ",ofcir:"⦿",Ofr:"𝔒",ofr:"𝔬",ogon:"˛",Ograve:"Ò",ograve:"ò",ogt:"⧁",ohbar:"⦵",ohm:"Ω",oint:"∮",olarr:"↺",olcir:"⦾",olcross:"⦻",oline:"‾",olt:"⧀",Omacr:"Ō",omacr:"ō",Omega:"Ω",omega:"ω",Omicron:"Ο",omicron:"ο",omid:"⦶",ominus:"⊖",Oopf:"𝕆",oopf:"𝕠",opar:"⦷",OpenCurlyDoubleQuote:"“",OpenCurlyQuote:"‘",operp:"⦹",oplus:"⊕",orarr:"↻",Or:"⩔",or:"∨",ord:"⩝",order:"ℴ",orderof:"ℴ",ordf:"ª",ordm:"º",origof:"⊶",oror:"⩖",orslope:"⩗",orv:"⩛",oS:"Ⓢ",Oscr:"𝒪",oscr:"ℴ",Oslash:"Ø",oslash:"ø",osol:"⊘",Otilde:"Õ",otilde:"õ",otimesas:"⨶",Otimes:"⨷",otimes:"⊗",Ouml:"Ö",ouml:"ö",ovbar:"⌽",OverBar:"‾",OverBrace:"⏞",OverBracket:"⎴",OverParenthesis:"⏜",para:"¶",parallel:"∥",par:"∥",parsim:"⫳",parsl:"⫽",part:"∂",PartialD:"∂",Pcy:"П",pcy:"п",percnt:"%",period:".",permil:"‰",perp:"⊥",pertenk:"‱",Pfr:"𝔓",pfr:"𝔭",Phi:"Φ",phi:"φ",phiv:"ϕ",phmmat:"ℳ",phone:"☎",Pi:"Π",pi:"π",pitchfork:"⋔",piv:"ϖ",planck:"ℏ",planckh:"ℎ",plankv:"ℏ",plusacir:"⨣",plusb:"⊞",pluscir:"⨢",plus:"+",plusdo:"∔",plusdu:"⨥",pluse:"⩲",PlusMinus:"±",plusmn:"±",plussim:"⨦",plustwo:"⨧",pm:"±",Poincareplane:"ℌ",pointint:"⨕",popf:"𝕡",Popf:"ℙ",pound:"£",prap:"⪷",Pr:"⪻",pr:"≺",prcue:"≼",precapprox:"⪷",prec:"≺",preccurlyeq:"≼",Precedes:"≺",PrecedesEqual:"⪯",PrecedesSlantEqual:"≼",PrecedesTilde:"≾",preceq:"⪯",precnapprox:"⪹",precneqq:"⪵",precnsim:"⋨",pre:"⪯",prE:"⪳",precsim:"≾",prime:"′",Prime:"″",primes:"ℙ",prnap:"⪹",prnE:"⪵",prnsim:"⋨",prod:"∏",Product:"∏",profalar:"⌮",profline:"⌒",profsurf:"⌓",prop:"∝",Proportional:"∝",Proportion:"∷",propto:"∝",prsim:"≾",prurel:"⊰",Pscr:"𝒫",pscr:"𝓅",Psi:"Ψ",psi:"ψ",puncsp:" ",Qfr:"𝔔",qfr:"𝔮",qint:"⨌",qopf:"𝕢",Qopf:"ℚ",qprime:"⁗",Qscr:"𝒬",qscr:"𝓆",quaternions:"ℍ",quatint:"⨖",quest:"?",questeq:"≟",quot:'"',QUOT:'"',rAarr:"⇛",race:"∽̱",Racute:"Ŕ",racute:"ŕ",radic:"√",raemptyv:"⦳",rang:"⟩",Rang:"⟫",rangd:"⦒",range:"⦥",rangle:"⟩",raquo:"»",rarrap:"⥵",rarrb:"⇥",rarrbfs:"⤠",rarrc:"⤳",rarr:"→",Rarr:"↠",rArr:"⇒",rarrfs:"⤞",rarrhk:"↪",rarrlp:"↬",rarrpl:"⥅",rarrsim:"⥴",Rarrtl:"⤖",rarrtl:"↣",rarrw:"↝",ratail:"⤚",rAtail:"⤜",ratio:"∶",rationals:"ℚ",rbarr:"⤍",rBarr:"⤏",RBarr:"⤐",rbbrk:"❳",rbrace:"}",rbrack:"]",rbrke:"⦌",rbrksld:"⦎",rbrkslu:"⦐",Rcaron:"Ř",rcaron:"ř",Rcedil:"Ŗ",rcedil:"ŗ",rceil:"⌉",rcub:"}",Rcy:"Р",rcy:"р",rdca:"⤷",rdldhar:"⥩",rdquo:"”",rdquor:"”",rdsh:"↳",real:"ℜ",realine:"ℛ",realpart:"ℜ",reals:"ℝ",Re:"ℜ",rect:"▭",reg:"®",REG:"®",ReverseElement:"∋",ReverseEquilibrium:"⇋",ReverseUpEquilibrium:"⥯",rfisht:"⥽",rfloor:"⌋",rfr:"𝔯",Rfr:"ℜ",rHar:"⥤",rhard:"⇁",rharu:"⇀",rharul:"⥬",Rho:"Ρ",rho:"ρ",rhov:"ϱ",RightAngleBracket:"⟩",RightArrowBar:"⇥",rightarrow:"→",RightArrow:"→",Rightarrow:"⇒",RightArrowLeftArrow:"⇄",rightarrowtail:"↣",RightCeiling:"⌉",RightDoubleBracket:"⟧",RightDownTeeVector:"⥝",RightDownVectorBar:"⥕",RightDownVector:"⇂",RightFloor:"⌋",rightharpoondown:"⇁",rightharpoonup:"⇀",rightleftarrows:"⇄",rightleftharpoons:"⇌",rightrightarrows:"⇉",rightsquigarrow:"↝",RightTeeArrow:"↦",RightTee:"⊢",RightTeeVector:"⥛",rightthreetimes:"⋌",RightTriangleBar:"⧐",RightTriangle:"⊳",RightTriangleEqual:"⊵",RightUpDownVector:"⥏",RightUpTeeVector:"⥜",RightUpVectorBar:"⥔",RightUpVector:"↾",RightVectorBar:"⥓",RightVector:"⇀",ring:"˚",risingdotseq:"≓",rlarr:"⇄",rlhar:"⇌",rlm:"‏",rmoustache:"⎱",rmoust:"⎱",rnmid:"⫮",roang:"⟭",roarr:"⇾",robrk:"⟧",ropar:"⦆",ropf:"𝕣",Ropf:"ℝ",roplus:"⨮",rotimes:"⨵",RoundImplies:"⥰",rpar:")",rpargt:"⦔",rppolint:"⨒",rrarr:"⇉",Rrightarrow:"⇛",rsaquo:"›",rscr:"𝓇",Rscr:"ℛ",rsh:"↱",Rsh:"↱",rsqb:"]",rsquo:"’",rsquor:"’",rthree:"⋌",rtimes:"⋊",rtri:"▹",rtrie:"⊵",rtrif:"▸",rtriltri:"⧎",RuleDelayed:"⧴",ruluhar:"⥨",rx:"℞",Sacute:"Ś",sacute:"ś",sbquo:"‚",scap:"⪸",Scaron:"Š",scaron:"š",Sc:"⪼",sc:"≻",sccue:"≽",sce:"⪰",scE:"⪴",Scedil:"Ş",scedil:"ş",Scirc:"Ŝ",scirc:"ŝ",scnap:"⪺",scnE:"⪶",scnsim:"⋩",scpolint:"⨓",scsim:"≿",Scy:"С",scy:"с",sdotb:"⊡",sdot:"⋅",sdote:"⩦",searhk:"⤥",searr:"↘",seArr:"⇘",searrow:"↘",sect:"§",semi:";",seswar:"⤩",setminus:"∖",setmn:"∖",sext:"✶",Sfr:"𝔖",sfr:"𝔰",sfrown:"⌢",sharp:"♯",SHCHcy:"Щ",shchcy:"щ",SHcy:"Ш",shcy:"ш",ShortDownArrow:"↓",ShortLeftArrow:"←",shortmid:"∣",shortparallel:"∥",ShortRightArrow:"→",ShortUpArrow:"↑",shy:"­",Sigma:"Σ",sigma:"σ",sigmaf:"ς",sigmav:"ς",sim:"∼",simdot:"⩪",sime:"≃",simeq:"≃",simg:"⪞",simgE:"⪠",siml:"⪝",simlE:"⪟",simne:"≆",simplus:"⨤",simrarr:"⥲",slarr:"←",SmallCircle:"∘",smallsetminus:"∖",smashp:"⨳",smeparsl:"⧤",smid:"∣",smile:"⌣",smt:"⪪",smte:"⪬",smtes:"⪬︀",SOFTcy:"Ь",softcy:"ь",solbar:"⌿",solb:"⧄",sol:"/",Sopf:"𝕊",sopf:"𝕤",spades:"♠",spadesuit:"♠",spar:"∥",sqcap:"⊓",sqcaps:"⊓︀",sqcup:"⊔",sqcups:"⊔︀",Sqrt:"√",sqsub:"⊏",sqsube:"⊑",sqsubset:"⊏",sqsubseteq:"⊑",sqsup:"⊐",sqsupe:"⊒",sqsupset:"⊐",sqsupseteq:"⊒",square:"□",Square:"□",SquareIntersection:"⊓",SquareSubset:"⊏",SquareSubsetEqual:"⊑",SquareSuperset:"⊐",SquareSupersetEqual:"⊒",SquareUnion:"⊔",squarf:"▪",squ:"□",squf:"▪",srarr:"→",Sscr:"𝒮",sscr:"𝓈",ssetmn:"∖",ssmile:"⌣",sstarf:"⋆",Star:"⋆",star:"☆",starf:"★",straightepsilon:"ϵ",straightphi:"ϕ",strns:"¯",sub:"⊂",Sub:"⋐",subdot:"⪽",subE:"⫅",sube:"⊆",subedot:"⫃",submult:"⫁",subnE:"⫋",subne:"⊊",subplus:"⪿",subrarr:"⥹",subset:"⊂",Subset:"⋐",subseteq:"⊆",subseteqq:"⫅",SubsetEqual:"⊆",subsetneq:"⊊",subsetneqq:"⫋",subsim:"⫇",subsub:"⫕",subsup:"⫓",succapprox:"⪸",succ:"≻",succcurlyeq:"≽",Succeeds:"≻",SucceedsEqual:"⪰",SucceedsSlantEqual:"≽",SucceedsTilde:"≿",succeq:"⪰",succnapprox:"⪺",succneqq:"⪶",succnsim:"⋩",succsim:"≿",SuchThat:"∋",sum:"∑",Sum:"∑",sung:"♪",sup1:"¹",sup2:"²",sup3:"³",sup:"⊃",Sup:"⋑",supdot:"⪾",supdsub:"⫘",supE:"⫆",supe:"⊇",supedot:"⫄",Superset:"⊃",SupersetEqual:"⊇",suphsol:"⟉",suphsub:"⫗",suplarr:"⥻",supmult:"⫂",supnE:"⫌",supne:"⊋",supplus:"⫀",supset:"⊃",Supset:"⋑",supseteq:"⊇",supseteqq:"⫆",supsetneq:"⊋",supsetneqq:"⫌",supsim:"⫈",supsub:"⫔",supsup:"⫖",swarhk:"⤦",swarr:"↙",swArr:"⇙",swarrow:"↙",swnwar:"⤪",szlig:"ß",Tab:"\t",target:"⌖",Tau:"Τ",tau:"τ",tbrk:"⎴",Tcaron:"Ť",tcaron:"ť",Tcedil:"Ţ",tcedil:"ţ",Tcy:"Т",tcy:"т",tdot:"⃛",telrec:"⌕",Tfr:"𝔗",tfr:"𝔱",there4:"∴",therefore:"∴",Therefore:"∴",Theta:"Θ",theta:"θ",thetasym:"ϑ",thetav:"ϑ",thickapprox:"≈",thicksim:"∼",ThickSpace:"  ",ThinSpace:" ",thinsp:" ",thkap:"≈",thksim:"∼",THORN:"Þ",thorn:"þ",tilde:"˜",Tilde:"∼",TildeEqual:"≃",TildeFullEqual:"≅",TildeTilde:"≈",timesbar:"⨱",timesb:"⊠",times:"×",timesd:"⨰",tint:"∭",toea:"⤨",topbot:"⌶",topcir:"⫱",top:"⊤",Topf:"𝕋",topf:"𝕥",topfork:"⫚",tosa:"⤩",tprime:"‴",trade:"™",TRADE:"™",triangle:"▵",triangledown:"▿",triangleleft:"◃",trianglelefteq:"⊴",triangleq:"≜",triangleright:"▹",trianglerighteq:"⊵",tridot:"◬",trie:"≜",triminus:"⨺",TripleDot:"⃛",triplus:"⨹",trisb:"⧍",tritime:"⨻",trpezium:"⏢",Tscr:"𝒯",tscr:"𝓉",TScy:"Ц",tscy:"ц",TSHcy:"Ћ",tshcy:"ћ",Tstrok:"Ŧ",tstrok:"ŧ",twixt:"≬",twoheadleftarrow:"↞",twoheadrightarrow:"↠",Uacute:"Ú",uacute:"ú",uarr:"↑",Uarr:"↟",uArr:"⇑",Uarrocir:"⥉",Ubrcy:"Ў",ubrcy:"ў",Ubreve:"Ŭ",ubreve:"ŭ",Ucirc:"Û",ucirc:"û",Ucy:"У",ucy:"у",udarr:"⇅",Udblac:"Ű",udblac:"ű",udhar:"⥮",ufisht:"⥾",Ufr:"𝔘",ufr:"𝔲",Ugrave:"Ù",ugrave:"ù",uHar:"⥣",uharl:"↿",uharr:"↾",uhblk:"▀",ulcorn:"⌜",ulcorner:"⌜",ulcrop:"⌏",ultri:"◸",Umacr:"Ū",umacr:"ū",uml:"¨",UnderBar:"_",UnderBrace:"⏟",UnderBracket:"⎵",UnderParenthesis:"⏝",Union:"⋃",UnionPlus:"⊎",Uogon:"Ų",uogon:"ų",Uopf:"𝕌",uopf:"𝕦",UpArrowBar:"⤒",uparrow:"↑",UpArrow:"↑",Uparrow:"⇑",UpArrowDownArrow:"⇅",updownarrow:"↕",UpDownArrow:"↕",Updownarrow:"⇕",UpEquilibrium:"⥮",upharpoonleft:"↿",upharpoonright:"↾",uplus:"⊎",UpperLeftArrow:"↖",UpperRightArrow:"↗",upsi:"υ",Upsi:"ϒ",upsih:"ϒ",Upsilon:"Υ",upsilon:"υ",UpTeeArrow:"↥",UpTee:"⊥",upuparrows:"⇈",urcorn:"⌝",urcorner:"⌝",urcrop:"⌎",Uring:"Ů",uring:"ů",urtri:"◹",Uscr:"𝒰",uscr:"𝓊",utdot:"⋰",Utilde:"Ũ",utilde:"ũ",utri:"▵",utrif:"▴",uuarr:"⇈",Uuml:"Ü",uuml:"ü",uwangle:"⦧",vangrt:"⦜",varepsilon:"ϵ",varkappa:"ϰ",varnothing:"∅",varphi:"ϕ",varpi:"ϖ",varpropto:"∝",varr:"↕",vArr:"⇕",varrho:"ϱ",varsigma:"ς",varsubsetneq:"⊊︀",varsubsetneqq:"⫋︀",varsupsetneq:"⊋︀",varsupsetneqq:"⫌︀",vartheta:"ϑ",vartriangleleft:"⊲",vartriangleright:"⊳",vBar:"⫨",Vbar:"⫫",vBarv:"⫩",Vcy:"В",vcy:"в",vdash:"⊢",vDash:"⊨",Vdash:"⊩",VDash:"⊫",Vdashl:"⫦",veebar:"⊻",vee:"∨",Vee:"⋁",veeeq:"≚",vellip:"⋮",verbar:"|",Verbar:"‖",vert:"|",Vert:"‖",VerticalBar:"∣",VerticalLine:"|",VerticalSeparator:"❘",VerticalTilde:"≀",VeryThinSpace:" ",Vfr:"𝔙",vfr:"𝔳",vltri:"⊲",vnsub:"⊂⃒",vnsup:"⊃⃒",Vopf:"𝕍",vopf:"𝕧",vprop:"∝",vrtri:"⊳",Vscr:"𝒱",vscr:"𝓋",vsubnE:"⫋︀",vsubne:"⊊︀",vsupnE:"⫌︀",vsupne:"⊋︀",Vvdash:"⊪",vzigzag:"⦚",Wcirc:"Ŵ",wcirc:"ŵ",wedbar:"⩟",wedge:"∧",Wedge:"⋀",wedgeq:"≙",weierp:"℘",Wfr:"𝔚",wfr:"𝔴",Wopf:"𝕎",wopf:"𝕨",wp:"℘",wr:"≀",wreath:"≀",Wscr:"𝒲",wscr:"𝓌",xcap:"⋂",xcirc:"◯",xcup:"⋃",xdtri:"▽",Xfr:"𝔛",xfr:"𝔵",xharr:"⟷",xhArr:"⟺",Xi:"Ξ",xi:"ξ",xlarr:"⟵",xlArr:"⟸",xmap:"⟼",xnis:"⋻",xodot:"⨀",Xopf:"𝕏",xopf:"𝕩",xoplus:"⨁",xotime:"⨂",xrarr:"⟶",xrArr:"⟹",Xscr:"𝒳",xscr:"𝓍",xsqcup:"⨆",xuplus:"⨄",xutri:"△",xvee:"⋁",xwedge:"⋀",Yacute:"Ý",yacute:"ý",YAcy:"Я",yacy:"я",Ycirc:"Ŷ",ycirc:"ŷ",Ycy:"Ы",ycy:"ы",yen:"¥",Yfr:"𝔜",yfr:"𝔶",YIcy:"Ї",yicy:"ї",Yopf:"𝕐",yopf:"𝕪",Yscr:"𝒴",yscr:"𝓎",YUcy:"Ю",yucy:"ю",yuml:"ÿ",Yuml:"Ÿ",Zacute:"Ź",zacute:"ź",Zcaron:"Ž",zcaron:"ž",Zcy:"З",zcy:"з",Zdot:"Ż",zdot:"ż",zeetrf:"ℨ",ZeroWidthSpace:"​",Zeta:"Ζ",zeta:"ζ",zfr:"𝔷",Zfr:"ℨ",ZHcy:"Ж",zhcy:"ж",zigrarr:"⇝",zopf:"𝕫",Zopf:"ℤ",Zscr:"𝒵",zscr:"𝓏",zwj:"‍",zwnj:"‌"},Se=/[!-#%-\*,-\/:;\?@\[-\]_\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166D\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4E\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]/,Te={},_e={};function encode$1(e,t,s){var n,l,c,u,d,m="";for("string"!=typeof t&&(s=t,t=encode$1.defaultChars),void 0===s&&(s=!0),d=function getEncodeCache(e){var t,s,n=_e[e];if(n)return n;for(n=_e[e]=[],t=0;t<128;t++)/^[0-9a-z]$/i.test(s=String.fromCharCode(t))?n.push(s):n.push("%"+("0"+t.toString(16).toUpperCase()).slice(-2));for(t=0;t<e.length;t++)n[e.charCodeAt(t)]=e[t];return n}(t),n=0,l=e.length;n<l;n++)if(c=e.charCodeAt(n),s&&37===c&&n+2<l&&/^[0-9a-f]{2}$/i.test(e.slice(n+1,n+3)))m+=e.slice(n,n+3),n+=2;else if(c<128)m+=d[c];else if(c>=55296&&c<=57343){if(c>=55296&&c<=56319&&n+1<l&&(u=e.charCodeAt(n+1))>=56320&&u<=57343){m+=encodeURIComponent(e[n]+e[n+1]),n++;continue}m+="%EF%BF%BD"}else m+=encodeURIComponent(e[n]);return m}encode$1.defaultChars=";/?:@&=+$,-_.!~*'()#",encode$1.componentChars="-_.!~*'()";var we=encode$1,Ae={};function decode$1(e,t){var s;return"string"!=typeof t&&(t=decode$1.defaultChars),s=function getDecodeCache(e){var t,s,n=Ae[e];if(n)return n;for(n=Ae[e]=[],t=0;t<128;t++)s=String.fromCharCode(t),n.push(s);for(t=0;t<e.length;t++)n[s=e.charCodeAt(t)]="%"+("0"+s.toString(16).toUpperCase()).slice(-2);return n}(t),e.replace(/(%[a-f0-9]{2})+/gi,(function(e){var t,n,l,c,u,d,m,h="";for(t=0,n=e.length;t<n;t+=3)(l=parseInt(e.slice(t+1,t+3),16))<128?h+=s[l]:192==(224&l)&&t+3<n&&128==(192&(c=parseInt(e.slice(t+4,t+6),16)))?(h+=(m=l<<6&1984|63&c)<128?"��":String.fromCharCode(m),t+=3):224==(240&l)&&t+6<n&&(c=parseInt(e.slice(t+4,t+6),16),u=parseInt(e.slice(t+7,t+9),16),128==(192&c)&&128==(192&u))?(h+=(m=l<<12&61440|c<<6&4032|63&u)<2048||m>=55296&&m<=57343?"���":String.fromCharCode(m),t+=6):240==(248&l)&&t+9<n&&(c=parseInt(e.slice(t+4,t+6),16),u=parseInt(e.slice(t+7,t+9),16),d=parseInt(e.slice(t+10,t+12),16),128==(192&c)&&128==(192&u)&&128==(192&d))?(h+=(m=l<<18&1835008|c<<12&258048|u<<6&4032|63&d)<65536||m>1114111?"����":String.fromCharCode(55296+((m-=65536)>>10),56320+(1023&m)),t+=9):h+="�";return h}))}decode$1.defaultChars=";/?:@&=+$,#",decode$1.componentChars="";var xe=decode$1;function Url(){this.protocol=null,this.slashes=null,this.auth=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.pathname=null}var Ie=/^([a-z0-9.+-]+:)/i,Pe=/:[0-9]*$/,Ee=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,Me=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),Oe=["'"].concat(Me),Le=["%","/","?",";","#"].concat(Oe),Re=["/","?","#"],Ne=/^[+a-z0-9A-Z_-]{0,63}$/,je=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,ze={javascript:!0,"javascript:":!0},Be={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};Url.prototype.parse=function(e,t){var s,n,l,c,u,d=e;if(d=d.trim(),!t&&1===e.split("#").length){var m=Ee.exec(d);if(m)return this.pathname=m[1],m[2]&&(this.search=m[2]),this}var h=Ie.exec(d);if(h&&(l=(h=h[0]).toLowerCase(),this.protocol=h,d=d.substr(h.length)),(t||h||d.match(/^\/\/[^@\/]+@[^@\/]+/))&&(!(u="//"===d.substr(0,2))||h&&ze[h]||(d=d.substr(2),this.slashes=!0)),!ze[h]&&(u||h&&!Be[h])){var g,y,b=-1;for(s=0;s<Re.length;s++)-1!==(c=d.indexOf(Re[s]))&&(-1===b||c<b)&&(b=c);for(-1!==(y=-1===b?d.lastIndexOf("@"):d.lastIndexOf("@",b))&&(g=d.slice(0,y),d=d.slice(y+1),this.auth=g),b=-1,s=0;s<Le.length;s++)-1!==(c=d.indexOf(Le[s]))&&(-1===b||c<b)&&(b=c);-1===b&&(b=d.length),":"===d[b-1]&&b--;var F=d.slice(0,b);d=d.slice(b),this.parseHost(F),this.hostname=this.hostname||"";var k="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!k){var v=this.hostname.split(/\./);for(s=0,n=v.length;s<n;s++){var D=v[s];if(D&&!D.match(Ne)){for(var C="",S=0,T=D.length;S<T;S++)D.charCodeAt(S)>127?C+="x":C+=D[S];if(!C.match(Ne)){var _=v.slice(0,s),w=v.slice(s+1),A=D.match(je);A&&(_.push(A[1]),w.unshift(A[2])),w.length&&(d=w.join(".")+d),this.hostname=_.join(".");break}}}}this.hostname.length>255&&(this.hostname=""),k&&(this.hostname=this.hostname.substr(1,this.hostname.length-2))}var x=d.indexOf("#");-1!==x&&(this.hash=d.substr(x),d=d.slice(0,x));var I=d.indexOf("?");return-1!==I&&(this.search=d.substr(I),d=d.slice(0,I)),d&&(this.pathname=d),Be[l]&&this.hostname&&!this.pathname&&(this.pathname=""),this},Url.prototype.parseHost=function(e){var t=Pe.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};var $e=function urlParse(e,t){if(e&&e instanceof Url)return e;var s=new Url;return s.parse(e,t),s};Te.encode=we,Te.decode=xe,Te.format=function format2(e){var t="";return t+=e.protocol||"",t+=e.slashes?"//":"",t+=e.auth?e.auth+"@":"",e.hostname&&-1!==e.hostname.indexOf(":")?t+="["+e.hostname+"]":t+=e.hostname||"",t+=e.port?":"+e.port:"",t+=e.pathname||"",t+=e.search||"",t+=e.hash||""},Te.parse=$e;var qe,Ue,He,Ge,We,Ve,Je,Ke,Qe,Ze={};function requireRegex$3(){return Ue?qe:(Ue=1,qe=/[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/)}function requireRegex$2(){return Ge?He:(Ge=1,He=/[\0-\x1F\x7F-\x9F]/)}function requireRegex(){return Ke?Je:(Ke=1,Je=/[ \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/)}function requireUc_micro(){return Qe||(Qe=1,Ze.Any=requireRegex$3(),Ze.Cc=requireRegex$2(),Ze.Cf=function requireRegex$1(){return Ve?We:(Ve=1,We=/[\xAD\u0600-\u0605\u061C\u06DD\u070F\u08E2\u180E\u200B-\u200F\u202A-\u202E\u2060-\u2064\u2066-\u206F\uFEFF\uFFF9-\uFFFB]|\uD804[\uDCBD\uDCCD]|\uD82F[\uDCA0-\uDCA3]|\uD834[\uDD73-\uDD7A]|\uDB40[\uDC01\uDC20-\uDC7F]/)}(),Ze.P=Se,Ze.Z=requireRegex()),Ze}!function(e){var t=Object.prototype.hasOwnProperty;function has2(e,s){return t.call(e,s)}function isValidEntityCode2(e){return!(e>=55296&&e<=57343)&&(!(e>=64976&&e<=65007)&&(65535!=(65535&e)&&65534!=(65535&e)&&(!(e>=0&&e<=8)&&(11!==e&&(!(e>=14&&e<=31)&&(!(e>=127&&e<=159)&&!(e>1114111)))))))}function fromCodePoint2(e){return e>65535?String.fromCharCode(55296+((e-=65536)>>10),56320+(1023&e)):String.fromCharCode(e)}var s=/\\([!"#$%&'()*+,\-.\/:;<=>?@[\\\]^_`{|}~])/g,n=RegExp(s.source+"|"+/&([a-z#][a-z0-9]{1,31});/gi.source,"gi"),l=/^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))/i,c=Ce;var u=/[&<>"]/,d=/[&<>"]/g,m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};function replaceUnsafeChar(e){return m[e]}var h=/[.?*+^$[\]\\(){}|-]/g;var g=Se;e.lib={},e.lib.mdurl=Te,e.lib.ucmicro=requireUc_micro(),e.assign=function assign2(e){return Array.prototype.slice.call(arguments,1).forEach((function(t){if(t){if("object"!=typeof t)throw new TypeError(t+"must be object");Object.keys(t).forEach((function(s){e[s]=t[s]}))}})),e},e.isString=function isString2(e){return"[object String]"===function _class2(e){return Object.prototype.toString.call(e)}(e)},e.has=has2,e.unescapeMd=function unescapeMd(e){return e.indexOf("\\")<0?e:e.replace(s,"$1")},e.unescapeAll=function unescapeAll2(e){return e.indexOf("\\")<0&&e.indexOf("&")<0?e:e.replace(n,(function(e,t,s){return t||function replaceEntityPattern(e,t){var s=0;return has2(c,t)?c[t]:35===t.charCodeAt(0)&&l.test(t)&&isValidEntityCode2(s="x"===t[1].toLowerCase()?parseInt(t.slice(2),16):parseInt(t.slice(1),10))?fromCodePoint2(s):e}(e,s)}))},e.isValidEntityCode=isValidEntityCode2,e.fromCodePoint=fromCodePoint2,e.escapeHtml=function escapeHtml2(e){return u.test(e)?e.replace(d,replaceUnsafeChar):e},e.arrayReplaceAt=function arrayReplaceAt2(e,t,s){return[].concat(e.slice(0,t),s,e.slice(t+1))},e.isSpace=function isSpace2(e){switch(e){case 9:case 32:return!0}return!1},e.isWhiteSpace=function isWhiteSpace2(e){if(e>=8192&&e<=8202)return!0;switch(e){case 9:case 10:case 11:case 12:case 13:case 32:case 160:case 5760:case 8239:case 8287:case 12288:return!0}return!1},e.isMdAsciiPunct=function isMdAsciiPunct2(e){switch(e){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 58:case 59:case 60:case 61:case 62:case 63:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 124:case 125:case 126:return!0;default:return!1}},e.isPunctChar=function isPunctChar2(e){return g.test(e)},e.escapeRE=function escapeRE2(e){return e.replace(h,"\\$&")},e.normalizeReference=function normalizeReference2(e){return(e=e.trim().replace(/\s+/g," ")).toLowerCase().toUpperCase()}}(De);var Ye={},Xe=De.unescapeAll,et=De.unescapeAll;Ye.parseLinkLabel=function parseLinkLabel(e,t,s){var n,l,c,u,d=-1,m=e.posMax,h=e.pos;for(e.pos=t+1,n=1;e.pos<m;){if(93===(c=e.src.charCodeAt(e.pos))&&0===--n){l=!0;break}if(u=e.pos,e.md.inline.skipToken(e),91===c)if(u===e.pos-1)n++;else if(s)return e.pos=h,-1}return l&&(d=e.pos),e.pos=h,d},Ye.parseLinkDestination=function parseLinkDestination(e,t,s){var n,l,c=t,u={ok:!1,pos:0,lines:0,str:""};if(60===e.charCodeAt(t)){for(t++;t<s;){if(10===(n=e.charCodeAt(t)))return u;if(60===n)return u;if(62===n)return u.pos=t+1,u.str=Xe(e.slice(c+1,t)),u.ok=!0,u;92===n&&t+1<s?t+=2:t++}return u}for(l=0;t<s&&32!==(n=e.charCodeAt(t))&&!(n<32||127===n);)if(92===n&&t+1<s){if(32===e.charCodeAt(t+1))break;t+=2}else{if(40===n&&++l>32)return u;if(41===n){if(0===l)break;l--}t++}return c===t||0!==l||(u.str=Xe(e.slice(c,t)),u.lines=0,u.pos=t,u.ok=!0),u},Ye.parseLinkTitle=function parseLinkTitle(e,t,s){var n,l,c=0,u=t,d={ok:!1,pos:0,lines:0,str:""};if(t>=s)return d;if(34!==(l=e.charCodeAt(t))&&39!==l&&40!==l)return d;for(t++,40===l&&(l=41);t<s;){if((n=e.charCodeAt(t))===l)return d.pos=t+1,d.lines=c,d.str=et(e.slice(u+1,t)),d.ok=!0,d;if(40===n&&41===l)return d;10===n?c++:92===n&&t+1<s&&(t++,10===e.charCodeAt(t)&&c++),t++}return d};var tt=De.assign,st=De.unescapeAll,at=De.escapeHtml,it={};function Renderer$1(){this.rules=tt({},it)}it.code_inline=function(e,t,s,n,l){var c=e[t];return"<code"+l.renderAttrs(c)+">"+at(e[t].content)+"</code>"},it.code_block=function(e,t,s,n,l){var c=e[t];return"<pre"+l.renderAttrs(c)+"><code>"+at(e[t].content)+"</code></pre>\n"},it.fence=function(e,t,s,n,l){var c,u,d,m,h,g=e[t],y=g.info?st(g.info).trim():"",b="",F="";return y&&(b=(d=y.split(/(\s+)/g))[0],F=d.slice(2).join("")),0===(c=s.highlight&&s.highlight(g.content,b,F)||at(g.content)).indexOf("<pre")?c+"\n":y?(u=g.attrIndex("class"),m=g.attrs?g.attrs.slice():[],u<0?m.push(["class",s.langPrefix+b]):(m[u]=m[u].slice(),m[u][1]+=" "+s.langPrefix+b),h={attrs:m},"<pre><code"+l.renderAttrs(h)+">"+c+"</code></pre>\n"):"<pre><code"+l.renderAttrs(g)+">"+c+"</code></pre>\n"},it.image=function(e,t,s,n,l){var c=e[t];return c.attrs[c.attrIndex("alt")][1]=l.renderInlineAsText(c.children,s,n),l.renderToken(e,t,s)},it.hardbreak=function(e,t,s){return s.xhtmlOut?"<br />\n":"<br>\n"},it.softbreak=function(e,t,s){return s.breaks?s.xhtmlOut?"<br />\n":"<br>\n":"\n"},it.text=function(e,t){return at(e[t].content)},it.html_block=function(e,t){return e[t].content},it.html_inline=function(e,t){return e[t].content},Renderer$1.prototype.renderAttrs=function renderAttrs(e){var t,s,n;if(!e.attrs)return"";for(n="",t=0,s=e.attrs.length;t<s;t++)n+=" "+at(e.attrs[t][0])+'="'+at(e.attrs[t][1])+'"';return n},Renderer$1.prototype.renderToken=function renderToken(e,t,s){var n,l="",c=!1,u=e[t];return u.hidden?"":(u.block&&-1!==u.nesting&&t&&e[t-1].hidden&&(l+="\n"),l+=(-1===u.nesting?"</":"<")+u.tag,l+=this.renderAttrs(u),0===u.nesting&&s.xhtmlOut&&(l+=" /"),u.block&&(c=!0,1===u.nesting&&t+1<e.length&&("inline"===(n=e[t+1]).type||n.hidden||-1===n.nesting&&n.tag===u.tag)&&(c=!1)),l+=c?">\n":">")},Renderer$1.prototype.renderInline=function(e,t,s){for(var n,l="",c=this.rules,u=0,d=e.length;u<d;u++)void 0!==c[n=e[u].type]?l+=c[n](e,u,t,s,this):l+=this.renderToken(e,u,t);return l},Renderer$1.prototype.renderInlineAsText=function(e,t,s){for(var n="",l=0,c=e.length;l<c;l++)"text"===e[l].type?n+=e[l].content:"image"===e[l].type?n+=this.renderInlineAsText(e[l].children,t,s):"softbreak"===e[l].type&&(n+="\n");return n},Renderer$1.prototype.render=function(e,t,s){var n,l,c,u="",d=this.rules;for(n=0,l=e.length;n<l;n++)"inline"===(c=e[n].type)?u+=this.renderInline(e[n].children,t,s):void 0!==d[c]?u+=d[e[n].type](e,n,t,s,this):u+=this.renderToken(e,n,t,s);return u};var nt=Renderer$1;function Ruler$3(){this.__rules__=[],this.__cache__=null}Ruler$3.prototype.__find__=function(e){for(var t=0;t<this.__rules__.length;t++)if(this.__rules__[t].name===e)return t;return-1},Ruler$3.prototype.__compile__=function(){var e=this,t=[""];e.__rules__.forEach((function(e){e.enabled&&e.alt.forEach((function(e){t.indexOf(e)<0&&t.push(e)}))})),e.__cache__={},t.forEach((function(t){e.__cache__[t]=[],e.__rules__.forEach((function(s){s.enabled&&(t&&s.alt.indexOf(t)<0||e.__cache__[t].push(s.fn))}))}))},Ruler$3.prototype.at=function(e,t,s){var n=this.__find__(e),l=s||{};if(-1===n)throw Error("Parser rule not found: "+e);this.__rules__[n].fn=t,this.__rules__[n].alt=l.alt||[],this.__cache__=null},Ruler$3.prototype.before=function(e,t,s,n){var l=this.__find__(e),c=n||{};if(-1===l)throw Error("Parser rule not found: "+e);this.__rules__.splice(l,0,{name:t,enabled:!0,fn:s,alt:c.alt||[]}),this.__cache__=null},Ruler$3.prototype.after=function(e,t,s,n){var l=this.__find__(e),c=n||{};if(-1===l)throw Error("Parser rule not found: "+e);this.__rules__.splice(l+1,0,{name:t,enabled:!0,fn:s,alt:c.alt||[]}),this.__cache__=null},Ruler$3.prototype.push=function(e,t,s){var n=s||{};this.__rules__.push({name:e,enabled:!0,fn:t,alt:n.alt||[]}),this.__cache__=null},Ruler$3.prototype.enable=function(e,t){Array.isArray(e)||(e=[e]);var s=[];return e.forEach((function(e){var n=this.__find__(e);if(n<0){if(t)return;throw Error("Rules manager: invalid rule name "+e)}this.__rules__[n].enabled=!0,s.push(e)}),this),this.__cache__=null,s},Ruler$3.prototype.enableOnly=function(e,t){Array.isArray(e)||(e=[e]),this.__rules__.forEach((function(e){e.enabled=!1})),this.enable(e,t)},Ruler$3.prototype.disable=function(e,t){Array.isArray(e)||(e=[e]);var s=[];return e.forEach((function(e){var n=this.__find__(e);if(n<0){if(t)return;throw Error("Rules manager: invalid rule name "+e)}this.__rules__[n].enabled=!1,s.push(e)}),this),this.__cache__=null,s},Ruler$3.prototype.getRules=function(e){return null===this.__cache__&&this.__compile__(),this.__cache__[e]||[]};var ot=Ruler$3,rt=/\r\n?|\n/g,lt=/\0/g,ct=De.arrayReplaceAt;function isLinkClose$1(e){return/^<\/a\s*>/i.test(e)}var ut=/\+-|\.\.|\?\?\?\?|!!!!|,,|--/,dt=/\((c|tm|r)\)/i,mt=/\((c|tm|r)\)/gi,ht={c:"©",r:"®",tm:"™"};function replaceFn(e,t){return ht[t.toLowerCase()]}function replace_scoped(e){var t,s,n=0;for(t=e.length-1;t>=0;t--)"text"!==(s=e[t]).type||n||(s.content=s.content.replace(mt,replaceFn)),"link_open"===s.type&&"auto"===s.info&&n--,"link_close"===s.type&&"auto"===s.info&&n++}function replace_rare(e){var t,s,n=0;for(t=e.length-1;t>=0;t--)"text"!==(s=e[t]).type||n||ut.test(s.content)&&(s.content=s.content.replace(/\+-/g,"±").replace(/\.{2,}/g,"…").replace(/([?!])…/g,"$1..").replace(/([?!]){4,}/g,"$1$1$1").replace(/,{2,}/g,",").replace(/(^|[^-])---(?=[^-]|$)/gm,"$1—").replace(/(^|\s)--(?=\s|$)/gm,"$1–").replace(/(^|[^-\s])--(?=[^-\s]|$)/gm,"$1–")),"link_open"===s.type&&"auto"===s.info&&n--,"link_close"===s.type&&"auto"===s.info&&n++}var pt=De.isWhiteSpace,ft=De.isPunctChar,gt=De.isMdAsciiPunct,yt=/['"]/,bt=/['"]/g;function replaceAt(e,t,s){return e.slice(0,t)+s+e.slice(t+1)}function process_inlines(e,t){var s,n,l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T,_,w,A;for(_=[],s=0;s<e.length;s++){for(n=e[s],m=e[s].level,S=_.length-1;S>=0&&!(_[S].level<=m);S--);if(_.length=S+1,"text"===n.type){u=0,d=(l=n.content).length;e:for(;u<d&&(bt.lastIndex=u,c=bt.exec(l));){if(D=C=!0,u=c.index+1,T="'"===c[0],g=32,c.index-1>=0)g=l.charCodeAt(c.index-1);else for(S=s-1;S>=0&&("softbreak"!==e[S].type&&"hardbreak"!==e[S].type);S--)if(e[S].content){g=e[S].content.charCodeAt(e[S].content.length-1);break}if(y=32,u<d)y=l.charCodeAt(u);else for(S=s+1;S<e.length&&("softbreak"!==e[S].type&&"hardbreak"!==e[S].type);S++)if(e[S].content){y=e[S].content.charCodeAt(0);break}if(b=gt(g)||ft(String.fromCharCode(g)),F=gt(y)||ft(String.fromCharCode(y)),k=pt(g),(v=pt(y))?D=!1:F&&(k||b||(D=!1)),k?C=!1:b&&(v||F||(C=!1)),34===y&&'"'===c[0]&&g>=48&&g<=57&&(C=D=!1),D&&C&&(D=b,C=F),D||C){if(C)for(S=_.length-1;S>=0&&(h=_[S],!(_[S].level<m));S--)if(h.single===T&&_[S].level===m){h=_[S],T?(w=t.md.options.quotes[2],A=t.md.options.quotes[3]):(w=t.md.options.quotes[0],A=t.md.options.quotes[1]),n.content=replaceAt(n.content,c.index,A),e[h.token].content=replaceAt(e[h.token].content,h.pos,w),u+=A.length-1,h.token===s&&(u+=w.length-1),d=(l=n.content).length,_.length=S;continue e}D?_.push({token:s,pos:c.index,single:T,level:m}):C&&T&&(n.content=replaceAt(n.content,c.index,"’"))}else T&&(n.content=replaceAt(n.content,c.index,"’"))}}}}function Token$4(e,t,s){this.type=e,this.tag=t,this.attrs=null,this.map=null,this.nesting=s,this.level=0,this.children=null,this.content="",this.markup="",this.info="",this.meta=null,this.block=!1,this.hidden=!1}Token$4.prototype.attrIndex=function attrIndex(e){var t,s,n;if(!this.attrs)return-1;for(s=0,n=(t=this.attrs).length;s<n;s++)if(t[s][0]===e)return s;return-1},Token$4.prototype.attrPush=function attrPush(e){this.attrs?this.attrs.push(e):this.attrs=[e]},Token$4.prototype.attrSet=function attrSet(e,t){var s=this.attrIndex(e),n=[e,t];s<0?this.attrPush(n):this.attrs[s]=n},Token$4.prototype.attrGet=function attrGet(e){var t=this.attrIndex(e),s=null;return t>=0&&(s=this.attrs[t][1]),s},Token$4.prototype.attrJoin=function attrJoin(e,t){var s=this.attrIndex(e);s<0?this.attrPush([e,t]):this.attrs[s][1]=this.attrs[s][1]+" "+t};var Ft=Token$4,kt=Ft;function StateCore(e,t,s){this.src=e,this.env=s,this.tokens=[],this.inlineMode=!1,this.md=t}StateCore.prototype.Token=kt;var vt=StateCore,Dt=ot,Ct=[["normalize",function normalize2(e){var t;t=(t=e.src.replace(rt,"\n")).replace(lt,"�"),e.src=t}],["block",function block2(e){var t;e.inlineMode?((t=new e.Token("inline","",0)).content=e.src,t.map=[0,1],t.children=[],e.tokens.push(t)):e.md.block.parse(e.src,e.md,e.env,e.tokens)}],["inline",function inline2(e){var t,s,n,l=e.tokens;for(s=0,n=l.length;s<n;s++)"inline"===(t=l[s]).type&&e.md.inline.parse(t.content,e.md,e.env,t.children)}],["linkify",function linkify(e){var t,s,n,l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T=e.tokens;if(e.md.options.linkify)for(s=0,n=T.length;s<n;s++)if("inline"===T[s].type&&e.md.linkify.pretest(T[s].content))for(F=0,t=(l=T[s].children).length-1;t>=0;t--)if("link_close"!==(u=l[t]).type){if("html_inline"===u.type&&(S=u.content,/^<a[>\s]/i.test(S)&&F>0&&F--,isLinkClose$1(u.content)&&F++),!(F>0)&&"text"===u.type&&e.md.linkify.test(u.content)){for(h=u.content,C=e.md.linkify.match(h),d=[],b=u.level,y=0,C.length>0&&0===C[0].index&&t>0&&"text_special"===l[t-1].type&&(C=C.slice(1)),m=0;m<C.length;m++)k=C[m].url,v=e.md.normalizeLink(k),e.md.validateLink(v)&&(D=C[m].text,D=C[m].schema?"mailto:"!==C[m].schema||/^mailto:/i.test(D)?e.md.normalizeLinkText(D):e.md.normalizeLinkText("mailto:"+D).replace(/^mailto:/,""):e.md.normalizeLinkText("http://"+D).replace(/^http:\/\//,""),(g=C[m].index)>y&&((c=new e.Token("text","",0)).content=h.slice(y,g),c.level=b,d.push(c)),(c=new e.Token("link_open","a",1)).attrs=[["href",v]],c.level=b++,c.markup="linkify",c.info="auto",d.push(c),(c=new e.Token("text","",0)).content=D,c.level=b,d.push(c),(c=new e.Token("link_close","a",-1)).level=--b,c.markup="linkify",c.info="auto",d.push(c),y=C[m].lastIndex);y<h.length&&((c=new e.Token("text","",0)).content=h.slice(y),c.level=b,d.push(c)),T[s].children=l=ct(l,t,d)}}else for(t--;l[t].level!==u.level&&"link_open"!==l[t].type;)t--}],["replacements",function replace(e){var t;if(e.md.options.typographer)for(t=e.tokens.length-1;t>=0;t--)"inline"===e.tokens[t].type&&(dt.test(e.tokens[t].content)&&replace_scoped(e.tokens[t].children),ut.test(e.tokens[t].content)&&replace_rare(e.tokens[t].children))}],["smartquotes",function smartquotes2(e){var t;if(e.md.options.typographer)for(t=e.tokens.length-1;t>=0;t--)"inline"===e.tokens[t].type&&yt.test(e.tokens[t].content)&&process_inlines(e.tokens[t].children,e)}],["text_join",function text_join2(e){var t,s,n,l,c,u,d=e.tokens;for(t=0,s=d.length;t<s;t++)if("inline"===d[t].type){for(c=(n=d[t].children).length,l=0;l<c;l++)"text_special"===n[l].type&&(n[l].type="text");for(l=u=0;l<c;l++)"text"===n[l].type&&l+1<c&&"text"===n[l+1].type?n[l+1].content=n[l].content+n[l+1].content:(l!==u&&(n[u]=n[l]),u++);l!==u&&(n.length=u)}}]];function Core(){this.ruler=new Dt;for(var e=0;e<Ct.length;e++)this.ruler.push(Ct[e][0],Ct[e][1])}Core.prototype.process=function(e){var t,s,n;for(t=0,s=(n=this.ruler.getRules("")).length;t<s;t++)n[t](e)},Core.prototype.State=vt;var St=Core,Tt=De.isSpace;function getLine(e,t){var s=e.bMarks[t]+e.tShift[t],n=e.eMarks[t];return e.src.slice(s,n)}function escapedSplit(e){var t,s=[],n=0,l=e.length,c=!1,u=0,d="";for(t=e.charCodeAt(n);n<l;)124===t&&(c?(d+=e.substring(u,n-1),u=n):(s.push(d+e.substring(u,n)),d="",u=n+1)),c=92===t,n++,t=e.charCodeAt(n);return s.push(d+e.substring(u)),s}var _t=De.isSpace,wt=De.isSpace,At=De.isSpace;function skipBulletListMarker(e,t){var s,n,l,c;return n=e.bMarks[t]+e.tShift[t],l=e.eMarks[t],42!==(s=e.src.charCodeAt(n++))&&45!==s&&43!==s||n<l&&(c=e.src.charCodeAt(n),!At(c))?-1:n}function skipOrderedListMarker(e,t){var s,n=e.bMarks[t]+e.tShift[t],l=n,c=e.eMarks[t];if(l+1>=c)return-1;if((s=e.src.charCodeAt(l++))<48||s>57)return-1;for(;;){if(l>=c)return-1;if(!((s=e.src.charCodeAt(l++))>=48&&s<=57)){if(41===s||46===s)break;return-1}if(l-n>=10)return-1}return l<c&&(s=e.src.charCodeAt(l),!At(s))?-1:l}var xt=De.normalizeReference,It=De.isSpace,Pt={},Et="<[A-Za-z][A-Za-z0-9\\-]*(?:\\s+[a-zA-Z_:][a-zA-Z0-9:._-]*(?:\\s*=\\s*(?:[^\"'=<>`\\x00-\\x20]+|'[^']*'|\"[^\"]*\"))?)*\\s*\\/?>",Mt="<\\/[A-Za-z][A-Za-z0-9\\-]*\\s*>",Ot=RegExp("^(?:"+Et+"|"+Mt+"|\x3c!----\x3e|\x3c!--(?:-?[^>-])(?:-?[^-])*--\x3e|<[?][\\s\\S]*?[?]>|<![A-Z]+\\s+[^>]*>|<!\\[CDATA\\[[\\s\\S]*?\\]\\]>)"),Lt=RegExp("^(?:"+Et+"|"+Mt+")");Pt.HTML_TAG_RE=Ot,Pt.HTML_OPEN_CLOSE_TAG_RE=Lt;var Rt=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","section","source","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],Nt=Pt.HTML_OPEN_CLOSE_TAG_RE,jt=[[/^<(script|pre|style|textarea)(?=(\s|>|$))/i,/<\/(script|pre|style|textarea)>/i,!0],[/^<!--/,/-->/,!0],[/^<\?/,/\?>/,!0],[/^<![A-Z]/,/>/,!0],[/^<!\[CDATA\[/,/\]\]>/,!0],[RegExp("^</?("+Rt.join("|")+")(?=(\\s|/?>|$))","i"),/^$/,!0],[RegExp(Nt.source+"\\s*$"),/^$/,!1]],zt=De.isSpace,Bt=Ft,$t=De.isSpace;function StateBlock(e,t,s,n){var l,c,u,d,m,h,g,y;for(this.src=e,this.md=t,this.env=s,this.tokens=n,this.bMarks=[],this.eMarks=[],this.tShift=[],this.sCount=[],this.bsCount=[],this.blkIndent=0,this.line=0,this.lineMax=0,this.tight=!1,this.ddIndent=-1,this.listIndent=-1,this.parentType="root",this.level=0,this.result="",y=!1,u=d=h=g=0,m=(c=this.src).length;d<m;d++){if(l=c.charCodeAt(d),!y){if($t(l)){h++,9===l?g+=4-g%4:g++;continue}y=!0}10!==l&&d!==m-1||(10!==l&&d++,this.bMarks.push(u),this.eMarks.push(d),this.tShift.push(h),this.sCount.push(g),this.bsCount.push(0),y=!1,h=0,g=0,u=d+1)}this.bMarks.push(c.length),this.eMarks.push(c.length),this.tShift.push(0),this.sCount.push(0),this.bsCount.push(0),this.lineMax=this.bMarks.length-1}StateBlock.prototype.push=function(e,t,s){var n=new Bt(e,t,s);return n.block=!0,s<0&&this.level--,n.level=this.level,s>0&&this.level++,this.tokens.push(n),n},StateBlock.prototype.isEmpty=function isEmpty(e){return this.bMarks[e]+this.tShift[e]>=this.eMarks[e]},StateBlock.prototype.skipEmptyLines=function skipEmptyLines(e){for(var t=this.lineMax;e<t&&!(this.bMarks[e]+this.tShift[e]<this.eMarks[e]);e++);return e},StateBlock.prototype.skipSpaces=function skipSpaces(e){for(var t,s=this.src.length;e<s&&(t=this.src.charCodeAt(e),$t(t));e++);return e},StateBlock.prototype.skipSpacesBack=function skipSpacesBack(e,t){if(e<=t)return e;for(;e>t;)if(!$t(this.src.charCodeAt(--e)))return e+1;return e},StateBlock.prototype.skipChars=function skipChars(e,t){for(var s=this.src.length;e<s&&this.src.charCodeAt(e)===t;e++);return e},StateBlock.prototype.skipCharsBack=function skipCharsBack(e,t,s){if(e<=s)return e;for(;e>s;)if(t!==this.src.charCodeAt(--e))return e+1;return e},StateBlock.prototype.getLines=function getLines(e,t,s,n){var l,c,u,d,m,h,g,y=e;if(e>=t)return"";for(h=Array(t-e),l=0;y<t;y++,l++){for(c=0,g=d=this.bMarks[y],m=y+1<t||n?this.eMarks[y]+1:this.eMarks[y];d<m&&c<s;){if(u=this.src.charCodeAt(d),$t(u))9===u?c+=4-(c+this.bsCount[y])%4:c++;else{if(!(d-g<this.tShift[y]))break;c++}d++}h[l]=c>s?Array(c-s+1).join(" ")+this.src.slice(d,m):this.src.slice(d,m)}return h.join("")},StateBlock.prototype.Token=Bt;var qt=StateBlock,Ut=ot,Ht=[["table",function table2(e,t,s,n){var l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T,_,w;if(t+2>s)return!1;if(h=t+1,e.sCount[h]<e.blkIndent)return!1;if(e.sCount[h]-e.blkIndent>=4)return!1;if((u=e.bMarks[h]+e.tShift[h])>=e.eMarks[h])return!1;if(124!==(_=e.src.charCodeAt(u++))&&45!==_&&58!==_)return!1;if(u>=e.eMarks[h])return!1;if(124!==(w=e.src.charCodeAt(u++))&&45!==w&&58!==w&&!Tt(w))return!1;if(45===_&&Tt(w))return!1;for(;u<e.eMarks[h];){if(124!==(l=e.src.charCodeAt(u))&&45!==l&&58!==l&&!Tt(l))return!1;u++}for(g=(c=getLine(e,t+1)).split("|"),F=[],d=0;d<g.length;d++){if(!(k=g[d].trim())){if(0===d||d===g.length-1)continue;return!1}if(!/^:?-+:?$/.test(k))return!1;58===k.charCodeAt(k.length-1)?F.push(58===k.charCodeAt(0)?"center":"right"):58===k.charCodeAt(0)?F.push("left"):F.push("")}if(-1===(c=getLine(e,t).trim()).indexOf("|"))return!1;if(e.sCount[t]-e.blkIndent>=4)return!1;if((g=escapedSplit(c)).length&&""===g[0]&&g.shift(),g.length&&""===g[g.length-1]&&g.pop(),0===(y=g.length)||y!==F.length)return!1;if(n)return!0;for(C=e.parentType,e.parentType="table",T=e.md.block.ruler.getRules("blockquote"),(b=e.push("table_open","table",1)).map=v=[t,0],(b=e.push("thead_open","thead",1)).map=[t,t+1],(b=e.push("tr_open","tr",1)).map=[t,t+1],d=0;d<g.length;d++)b=e.push("th_open","th",1),F[d]&&(b.attrs=[["style","text-align:"+F[d]]]),(b=e.push("inline","",0)).content=g[d].trim(),b.children=[],b=e.push("th_close","th",-1);for(b=e.push("tr_close","tr",-1),b=e.push("thead_close","thead",-1),h=t+2;h<s&&!(e.sCount[h]<e.blkIndent);h++){for(S=!1,d=0,m=T.length;d<m;d++)if(T[d](e,h,s,!0)){S=!0;break}if(S)break;if(!(c=getLine(e,h).trim()))break;if(e.sCount[h]-e.blkIndent>=4)break;for((g=escapedSplit(c)).length&&""===g[0]&&g.shift(),g.length&&""===g[g.length-1]&&g.pop(),h===t+2&&((b=e.push("tbody_open","tbody",1)).map=D=[t+2,0]),(b=e.push("tr_open","tr",1)).map=[h,h+1],d=0;d<y;d++)b=e.push("td_open","td",1),F[d]&&(b.attrs=[["style","text-align:"+F[d]]]),(b=e.push("inline","",0)).content=g[d]?g[d].trim():"",b.children=[],b=e.push("td_close","td",-1);b=e.push("tr_close","tr",-1)}return D&&(b=e.push("tbody_close","tbody",-1),D[1]=h),b=e.push("table_close","table",-1),v[1]=h,e.parentType=C,e.line=h,!0},["paragraph","reference"]],["code",function code2(e,t,s){var n,l,c;if(e.sCount[t]-e.blkIndent<4)return!1;for(l=n=t+1;n<s;)if(e.isEmpty(n))n++;else{if(!(e.sCount[n]-e.blkIndent>=4))break;l=++n}return e.line=l,(c=e.push("code_block","code",0)).content=e.getLines(t,l,4+e.blkIndent,!1)+"\n",c.map=[t,e.line],!0}],["fence",function fence2(e,t,s,n){var l,c,u,d,m,h,g,y=!1,b=e.bMarks[t]+e.tShift[t],F=e.eMarks[t];if(e.sCount[t]-e.blkIndent>=4)return!1;if(b+3>F)return!1;if(126!==(l=e.src.charCodeAt(b))&&96!==l)return!1;if(m=b,(c=(b=e.skipChars(b,l))-m)<3)return!1;if(g=e.src.slice(m,b),u=e.src.slice(b,F),96===l&&u.indexOf(String.fromCharCode(l))>=0)return!1;if(n)return!0;for(d=t;!(++d>=s)&&!((b=m=e.bMarks[d]+e.tShift[d])<(F=e.eMarks[d])&&e.sCount[d]<e.blkIndent);)if(e.src.charCodeAt(b)===l&&!(e.sCount[d]-e.blkIndent>=4||(b=e.skipChars(b,l))-m<c||(b=e.skipSpaces(b))<F)){y=!0;break}return c=e.sCount[t],e.line=d+(y?1:0),(h=e.push("fence","code",0)).info=u,h.content=e.getLines(t+1,d,c,!0),h.markup=g,h.map=[t,e.line],!0},["paragraph","reference","blockquote","list"]],["blockquote",function blockquote2(e,t,s,n){var l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T,_,w,A,x,I=e.lineMax,P=e.bMarks[t]+e.tShift[t],E=e.eMarks[t];if(e.sCount[t]-e.blkIndent>=4)return!1;if(62!==e.src.charCodeAt(P++))return!1;if(n)return!0;for(d=b=e.sCount[t]+1,32===e.src.charCodeAt(P)?(P++,d++,b++,l=!1,T=!0):9===e.src.charCodeAt(P)?(T=!0,(e.bsCount[t]+b)%4==3?(P++,d++,b++,l=!1):l=!0):T=!1,F=[e.bMarks[t]],e.bMarks[t]=P;P<E&&(c=e.src.charCodeAt(P),_t(c));)9===c?b+=4-(b+e.bsCount[t]+(l?1:0))%4:b++,P++;for(k=[e.bsCount[t]],e.bsCount[t]=e.sCount[t]+1+(T?1:0),h=P>=E,C=[e.sCount[t]],e.sCount[t]=b-d,S=[e.tShift[t]],e.tShift[t]=P-e.bMarks[t],w=e.md.block.ruler.getRules("blockquote"),D=e.parentType,e.parentType="blockquote",y=t+1;y<s&&(x=e.sCount[y]<e.blkIndent,!((P=e.bMarks[y]+e.tShift[y])>=(E=e.eMarks[y])));y++)if(62!==e.src.charCodeAt(P++)||x){if(h)break;for(_=!1,u=0,m=w.length;u<m;u++)if(w[u](e,y,s,!0)){_=!0;break}if(_){e.lineMax=y,0!==e.blkIndent&&(F.push(e.bMarks[y]),k.push(e.bsCount[y]),S.push(e.tShift[y]),C.push(e.sCount[y]),e.sCount[y]-=e.blkIndent);break}F.push(e.bMarks[y]),k.push(e.bsCount[y]),S.push(e.tShift[y]),C.push(e.sCount[y]),e.sCount[y]=-1}else{for(d=b=e.sCount[y]+1,32===e.src.charCodeAt(P)?(P++,d++,b++,l=!1,T=!0):9===e.src.charCodeAt(P)?(T=!0,(e.bsCount[y]+b)%4==3?(P++,d++,b++,l=!1):l=!0):T=!1,F.push(e.bMarks[y]),e.bMarks[y]=P;P<E&&(c=e.src.charCodeAt(P),_t(c));)9===c?b+=4-(b+e.bsCount[y]+(l?1:0))%4:b++,P++;h=P>=E,k.push(e.bsCount[y]),e.bsCount[y]=e.sCount[y]+1+(T?1:0),C.push(e.sCount[y]),e.sCount[y]=b-d,S.push(e.tShift[y]),e.tShift[y]=P-e.bMarks[y]}for(v=e.blkIndent,e.blkIndent=0,(A=e.push("blockquote_open","blockquote",1)).markup=">",A.map=g=[t,0],e.md.block.tokenize(e,t,y),(A=e.push("blockquote_close","blockquote",-1)).markup=">",e.lineMax=I,e.parentType=D,g[1]=e.line,u=0;u<S.length;u++)e.bMarks[u+t]=F[u],e.tShift[u+t]=S[u],e.sCount[u+t]=C[u],e.bsCount[u+t]=k[u];return e.blkIndent=v,!0},["paragraph","reference","blockquote","list"]],["hr",function hr2(e,t,s,n){var l,c,u,d,m=e.bMarks[t]+e.tShift[t],h=e.eMarks[t];if(e.sCount[t]-e.blkIndent>=4)return!1;if(42!==(l=e.src.charCodeAt(m++))&&45!==l&&95!==l)return!1;for(c=1;m<h;){if((u=e.src.charCodeAt(m++))!==l&&!wt(u))return!1;u===l&&c++}return!(c<3)&&(n||(e.line=t+1,(d=e.push("hr","hr",0)).map=[t,e.line],d.markup=Array(c+1).join(String.fromCharCode(l))),!0)},["paragraph","reference","blockquote","list"]],["list",function list2(e,t,s,n){var l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T,_,w,A,x,I,P,E,M,O,L,R,N,j=!1,z=!0;if(e.sCount[t]-e.blkIndent>=4)return!1;if(e.listIndent>=0&&e.sCount[t]-e.listIndent>=4&&e.sCount[t]<e.blkIndent)return!1;if(n&&"paragraph"===e.parentType&&e.sCount[t]>=e.blkIndent&&(j=!0),(E=skipOrderedListMarker(e,t))>=0){if(g=!0,O=e.bMarks[t]+e.tShift[t],D=Number(e.src.slice(O,E-1)),j&&1!==D)return!1}else{if(!((E=skipBulletListMarker(e,t))>=0))return!1;g=!1}if(j&&e.skipSpaces(E)>=e.eMarks[t])return!1;if(v=e.src.charCodeAt(E-1),n)return!0;for(k=e.tokens.length,g?(N=e.push("ordered_list_open","ol",1),1!==D&&(N.attrs=[["start",D]])):N=e.push("bullet_list_open","ul",1),N.map=F=[t,0],N.markup=String.fromCharCode(v),S=t,M=!1,R=e.md.block.ruler.getRules("list"),w=e.parentType,e.parentType="list";S<s;){for(P=E,C=e.eMarks[S],h=T=e.sCount[S]+E-(e.bMarks[t]+e.tShift[t]);P<C;){if(9===(l=e.src.charCodeAt(P)))T+=4-(T+e.bsCount[S])%4;else{if(32!==l)break;T++}P++}if((m=(c=P)>=C?1:T-h)>4&&(m=1),d=h+m,(N=e.push("list_item_open","li",1)).markup=String.fromCharCode(v),N.map=y=[t,0],g&&(N.info=e.src.slice(O,E-1)),I=e.tight,x=e.tShift[t],A=e.sCount[t],_=e.listIndent,e.listIndent=e.blkIndent,e.blkIndent=d,e.tight=!0,e.tShift[t]=c-e.bMarks[t],e.sCount[t]=T,c>=C&&e.isEmpty(t+1)?e.line=Math.min(e.line+2,s):e.md.block.tokenize(e,t,s,!0),e.tight&&!M||(z=!1),M=e.line-t>1&&e.isEmpty(e.line-1),e.blkIndent=e.listIndent,e.listIndent=_,e.tShift[t]=x,e.sCount[t]=A,e.tight=I,(N=e.push("list_item_close","li",-1)).markup=String.fromCharCode(v),S=t=e.line,y[1]=S,c=e.bMarks[t],S>=s)break;if(e.sCount[S]<e.blkIndent)break;if(e.sCount[t]-e.blkIndent>=4)break;for(L=!1,u=0,b=R.length;u<b;u++)if(R[u](e,S,s,!0)){L=!0;break}if(L)break;if(g){if((E=skipOrderedListMarker(e,S))<0)break;O=e.bMarks[S]+e.tShift[S]}else if((E=skipBulletListMarker(e,S))<0)break;if(v!==e.src.charCodeAt(E-1))break}return(N=g?e.push("ordered_list_close","ol",-1):e.push("bullet_list_close","ul",-1)).markup=String.fromCharCode(v),F[1]=S,e.line=S,e.parentType=w,z&&function markTightParagraphs(e,t){var s,n,l=e.level+2;for(s=t+2,n=e.tokens.length-2;s<n;s++)e.tokens[s].level===l&&"paragraph_open"===e.tokens[s].type&&(e.tokens[s+2].hidden=!0,e.tokens[s].hidden=!0,s+=2)}(e,k),!0},["paragraph","reference","blockquote"]],["reference",function reference2(e,t,s,n){var l,c,u,d,m,h,g,y,b,F,k,v,D,C,S,T,_=0,w=e.bMarks[t]+e.tShift[t],A=e.eMarks[t],x=t+1;if(e.sCount[t]-e.blkIndent>=4)return!1;if(91!==e.src.charCodeAt(w))return!1;for(;++w<A;)if(93===e.src.charCodeAt(w)&&92!==e.src.charCodeAt(w-1)){if(w+1===A)return!1;if(58!==e.src.charCodeAt(w+1))return!1;break}for(d=e.lineMax,S=e.md.block.ruler.getRules("reference"),F=e.parentType,e.parentType="reference";x<d&&!e.isEmpty(x);x++)if(!(e.sCount[x]-e.blkIndent>3||e.sCount[x]<0)){for(C=!1,h=0,g=S.length;h<g;h++)if(S[h](e,x,d,!0)){C=!0;break}if(C)break}for(A=(D=e.getLines(t,x,e.blkIndent,!1).trim()).length,w=1;w<A;w++){if(91===(l=D.charCodeAt(w)))return!1;if(93===l){b=w;break}(10===l||92===l&&++w<A&&10===D.charCodeAt(w))&&_++}if(b<0||58!==D.charCodeAt(b+1))return!1;for(w=b+2;w<A;w++)if(10===(l=D.charCodeAt(w)))_++;else if(!It(l))break;if(!(k=e.md.helpers.parseLinkDestination(D,w,A)).ok)return!1;if(m=e.md.normalizeLink(k.str),!e.md.validateLink(m))return!1;for(c=w=k.pos,u=_+=k.lines,v=w;w<A;w++)if(10===(l=D.charCodeAt(w)))_++;else if(!It(l))break;for(k=e.md.helpers.parseLinkTitle(D,w,A),w<A&&v!==w&&k.ok?(T=k.str,w=k.pos,_+=k.lines):(T="",w=c,_=u);w<A&&(l=D.charCodeAt(w),It(l));)w++;if(w<A&&10!==D.charCodeAt(w)&&T)for(T="",w=c,_=u;w<A&&(l=D.charCodeAt(w),It(l));)w++;return!(w<A&&10!==D.charCodeAt(w))&&(!!(y=xt(D.slice(1,b)))&&(n||(void 0===e.env.references&&(e.env.references={}),void 0===e.env.references[y]&&(e.env.references[y]={title:T,href:m}),e.parentType=F,e.line=t+_+1),!0))}],["html_block",function html_block2(e,t,s,n){var l,c,u,d,m=e.bMarks[t]+e.tShift[t],h=e.eMarks[t];if(e.sCount[t]-e.blkIndent>=4)return!1;if(!e.md.options.html)return!1;if(60!==e.src.charCodeAt(m))return!1;for(d=e.src.slice(m,h),l=0;l<jt.length&&!jt[l][0].test(d);l++);if(l===jt.length)return!1;if(n)return jt[l][2];if(c=t+1,!jt[l][1].test(d))for(;c<s&&!(e.sCount[c]<e.blkIndent);c++)if(m=e.bMarks[c]+e.tShift[c],h=e.eMarks[c],d=e.src.slice(m,h),jt[l][1].test(d)){0!==d.length&&c++;break}return e.line=c,(u=e.push("html_block","",0)).map=[t,c],u.content=e.getLines(t,c,e.blkIndent,!0),!0},["paragraph","reference","blockquote"]],["heading",function heading2(e,t,s,n){var l,c,u,d,m=e.bMarks[t]+e.tShift[t],h=e.eMarks[t];if(e.sCount[t]-e.blkIndent>=4)return!1;if(35!==(l=e.src.charCodeAt(m))||m>=h)return!1;for(c=1,l=e.src.charCodeAt(++m);35===l&&m<h&&c<=6;)c++,l=e.src.charCodeAt(++m);return!(c>6||m<h&&!zt(l))&&(n||(h=e.skipSpacesBack(h,m),(u=e.skipCharsBack(h,35,m))>m&&zt(e.src.charCodeAt(u-1))&&(h=u),e.line=t+1,(d=e.push("heading_open","h"+c,1)).markup="########".slice(0,c),d.map=[t,e.line],(d=e.push("inline","",0)).content=e.src.slice(m,h).trim(),d.map=[t,e.line],d.children=[],(d=e.push("heading_close","h"+c,-1)).markup="########".slice(0,c)),!0)},["paragraph","reference","blockquote"]],["lheading",function lheading2(e,t,s){var n,l,c,u,d,m,h,g,y,b,F=t+1,k=e.md.block.ruler.getRules("paragraph");if(e.sCount[t]-e.blkIndent>=4)return!1;for(b=e.parentType,e.parentType="paragraph";F<s&&!e.isEmpty(F);F++)if(!(e.sCount[F]-e.blkIndent>3)){if(e.sCount[F]>=e.blkIndent&&(m=e.bMarks[F]+e.tShift[F])<(h=e.eMarks[F])&&(45===(y=e.src.charCodeAt(m))||61===y)&&(m=e.skipChars(m,y),(m=e.skipSpaces(m))>=h)){g=61===y?1:2;break}if(!(e.sCount[F]<0)){for(l=!1,c=0,u=k.length;c<u;c++)if(k[c](e,F,s,!0)){l=!0;break}if(l)break}}return!!g&&(n=e.getLines(t,F,e.blkIndent,!1).trim(),e.line=F+1,(d=e.push("heading_open","h"+g,1)).markup=String.fromCharCode(y),d.map=[t,e.line],(d=e.push("inline","",0)).content=n,d.map=[t,e.line-1],d.children=[],(d=e.push("heading_close","h"+g,-1)).markup=String.fromCharCode(y),e.parentType=b,!0)}],["paragraph",function paragraph2(e,t){var s,n,l,c,u,d,m=t+1,h=e.md.block.ruler.getRules("paragraph"),g=e.lineMax;for(d=e.parentType,e.parentType="paragraph";m<g&&!e.isEmpty(m);m++)if(!(e.sCount[m]-e.blkIndent>3||e.sCount[m]<0)){for(n=!1,l=0,c=h.length;l<c;l++)if(h[l](e,m,g,!0)){n=!0;break}if(n)break}return s=e.getLines(t,m,e.blkIndent,!1).trim(),e.line=m,(u=e.push("paragraph_open","p",1)).map=[t,e.line],(u=e.push("inline","",0)).content=s,u.map=[t,e.line],u.children=[],u=e.push("paragraph_close","p",-1),e.parentType=d,!0}]];function ParserBlock$1(){this.ruler=new Ut;for(var e=0;e<Ht.length;e++)this.ruler.push(Ht[e][0],Ht[e][1],{alt:(Ht[e][2]||[]).slice()})}ParserBlock$1.prototype.tokenize=function(e,t,s){for(var n,l=this.ruler.getRules(""),c=l.length,u=t,d=!1,m=e.md.options.maxNesting;u<s&&(e.line=u=e.skipEmptyLines(u),!(u>=s))&&!(e.sCount[u]<e.blkIndent);){if(e.level>=m){e.line=s;break}for(n=0;n<c&&!l[n](e,u,s,!1);n++);e.tight=!d,e.isEmpty(e.line-1)&&(d=!0),(u=e.line)<s&&e.isEmpty(u)&&(d=!0,u++,e.line=u)}},ParserBlock$1.prototype.parse=function(e,t,s,n){var l;e&&(l=new this.State(e,t,s,n),this.tokenize(l,l.line,l.lineMax))},ParserBlock$1.prototype.State=qt;var Gt=ParserBlock$1;function isTerminatorChar(e){switch(e){case 10:case 33:case 35:case 36:case 37:case 38:case 42:case 43:case 45:case 58:case 60:case 61:case 62:case 64:case 91:case 92:case 93:case 94:case 95:case 96:case 123:case 125:case 126:return!0;default:return!1}}for(var Wt=/(?:^|[^a-z0-9.+-])([a-z][a-z0-9.+-]*)$/i,Vt=De.isSpace,Jt=De.isSpace,Kt=[],Qt=0;Qt<256;Qt++)Kt.push(0);"\\!\"#$%&'()*+,./:;<=>?@[]^_`{|}~-".split("").forEach((function(e){Kt[e.charCodeAt(0)]=1}));var Zt={};function postProcess$1(e,t){var s,n,l,c,u,d=[],m=t.length;for(s=0;s<m;s++)126===(l=t[s]).marker&&-1!==l.end&&(c=t[l.end],(u=e.tokens[l.token]).type="s_open",u.tag="s",u.nesting=1,u.markup="~~",u.content="",(u=e.tokens[c.token]).type="s_close",u.tag="s",u.nesting=-1,u.markup="~~",u.content="","text"===e.tokens[c.token-1].type&&"~"===e.tokens[c.token-1].content&&d.push(c.token-1));for(;d.length;){for(n=(s=d.pop())+1;n<e.tokens.length&&"s_close"===e.tokens[n].type;)n++;s!==--n&&(u=e.tokens[n],e.tokens[n]=e.tokens[s],e.tokens[s]=u)}}Zt.tokenize=function strikethrough2(e,t){var s,n,l,c,u=e.pos,d=e.src.charCodeAt(u);if(t)return!1;if(126!==d)return!1;if(l=(n=e.scanDelims(e.pos,!0)).length,c=String.fromCharCode(d),l<2)return!1;for(l%2&&(e.push("text","",0).content=c,l--),s=0;s<l;s+=2)e.push("text","",0).content=c+c,e.delimiters.push({marker:d,length:0,token:e.tokens.length-1,end:-1,open:n.can_open,close:n.can_close});return e.pos+=n.length,!0},Zt.postProcess=function strikethrough3(e){var t,s=e.tokens_meta,n=e.tokens_meta.length;for(postProcess$1(e,e.delimiters),t=0;t<n;t++)s[t]&&s[t].delimiters&&postProcess$1(e,s[t].delimiters)};var Yt={};function postProcess(e,t){var s,n,l,c,u,d;for(s=t.length-1;s>=0;s--)95!==(n=t[s]).marker&&42!==n.marker||-1!==n.end&&(l=t[n.end],d=s>0&&t[s-1].end===n.end+1&&t[s-1].marker===n.marker&&t[s-1].token===n.token-1&&t[n.end+1].token===l.token+1,u=String.fromCharCode(n.marker),(c=e.tokens[n.token]).type=d?"strong_open":"em_open",c.tag=d?"strong":"em",c.nesting=1,c.markup=d?u+u:u,c.content="",(c=e.tokens[l.token]).type=d?"strong_close":"em_close",c.tag=d?"strong":"em",c.nesting=-1,c.markup=d?u+u:u,c.content="",d&&(e.tokens[t[s-1].token].content="",e.tokens[t[n.end+1].token].content="",s--))}Yt.tokenize=function emphasis2(e,t){var s,n,l=e.pos,c=e.src.charCodeAt(l);if(t)return!1;if(95!==c&&42!==c)return!1;for(n=e.scanDelims(e.pos,42===c),s=0;s<n.length;s++)e.push("text","",0).content=String.fromCharCode(c),e.delimiters.push({marker:c,length:n.length,token:e.tokens.length-1,end:-1,open:n.can_open,close:n.can_close});return e.pos+=n.length,!0},Yt.postProcess=function emphasis3(e){var t,s=e.tokens_meta,n=e.tokens_meta.length;for(postProcess(e,e.delimiters),t=0;t<n;t++)s[t]&&s[t].delimiters&&postProcess(e,s[t].delimiters)};var Xt=De.normalizeReference,es=De.isSpace,ts=De.normalizeReference,ss=De.isSpace,as=/^([a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)$/,is=/^([a-zA-Z][a-zA-Z0-9+.\-]{1,31}):([^<>\x00-\x20]*)$/,ns=Pt.HTML_TAG_RE;var os=Ce,rs=De.has,ls=De.isValidEntityCode,cs=De.fromCodePoint,us=/^&#((?:x[a-f0-9]{1,6}|[0-9]{1,7}));/i,ds=/^&([a-z][a-z0-9]{1,31});/i;function processDelimiters(e,t){var s,n,l,c,u,d,m,h,g={},y=t.length;if(y){var b=0,F=-2,k=[];for(s=0;s<y;s++)if(l=t[s],k.push(0),t[b].marker===l.marker&&F===l.token-1||(b=s),F=l.token,l.length=l.length||0,l.close){for(g.hasOwnProperty(l.marker)||(g[l.marker]=[-1,-1,-1,-1,-1,-1]),u=g[l.marker][(l.open?3:0)+l.length%3],d=n=b-k[b]-1;n>u;n-=k[n]+1)if((c=t[n]).marker===l.marker&&c.open&&c.end<0&&(m=!1,(c.close||l.open)&&(c.length+l.length)%3==0&&(c.length%3==0&&l.length%3==0||(m=!0)),!m)){h=n>0&&!t[n-1].open?k[n-1]+1:0,k[s]=s-n+h,k[n]=h,l.open=!1,c.end=s,c.close=!1,d=-1,F=-2;break}-1!==d&&(g[l.marker][(l.open?3:0)+(l.length||0)%3]=d)}}}var ms=Ft,hs=De.isWhiteSpace,ps=De.isPunctChar,fs=De.isMdAsciiPunct;function StateInline(e,t,s,n){this.src=e,this.env=s,this.md=t,this.tokens=n,this.tokens_meta=Array(n.length),this.pos=0,this.posMax=this.src.length,this.level=0,this.pending="",this.pendingLevel=0,this.cache={},this.delimiters=[],this._prev_delimiters=[],this.backticks={},this.backticksScanned=!1,this.linkLevel=0}StateInline.prototype.pushPending=function(){var e=new ms("text","",0);return e.content=this.pending,e.level=this.pendingLevel,this.tokens.push(e),this.pending="",e},StateInline.prototype.push=function(e,t,s){this.pending&&this.pushPending();var n=new ms(e,t,s),l=null;return s<0&&(this.level--,this.delimiters=this._prev_delimiters.pop()),n.level=this.level,s>0&&(this.level++,this._prev_delimiters.push(this.delimiters),this.delimiters=[],l={delimiters:this.delimiters}),this.pendingLevel=this.level,this.tokens.push(n),this.tokens_meta.push(l),n},StateInline.prototype.scanDelims=function(e,t){var s,n,l,c,u,d,m,h,g,y=e,b=!0,F=!0,k=this.posMax,v=this.src.charCodeAt(e);for(s=e>0?this.src.charCodeAt(e-1):32;y<k&&this.src.charCodeAt(y)===v;)y++;return l=y-e,n=y<k?this.src.charCodeAt(y):32,m=fs(s)||ps(String.fromCharCode(s)),g=fs(n)||ps(String.fromCharCode(n)),d=hs(s),(h=hs(n))?b=!1:g&&(d||m||(b=!1)),d?F=!1:m&&(h||g||(F=!1)),t?(c=b,u=F):(c=b&&(!F||m),u=F&&(!b||g)),{can_open:c,can_close:u,length:l}},StateInline.prototype.Token=ms;var gs=StateInline,ys=ot,bs=[["text",function text2(e,t){for(var s=e.pos;s<e.posMax&&!isTerminatorChar(e.src.charCodeAt(s));)s++;return s!==e.pos&&(t||(e.pending+=e.src.slice(e.pos,s)),e.pos=s,!0)}],["linkify",function linkify3(e,t){var s,n,l,c,u,d,m;return!!e.md.options.linkify&&(!(e.linkLevel>0)&&(!((s=e.pos)+3>e.posMax)&&(58===e.src.charCodeAt(s)&&(47===e.src.charCodeAt(s+1)&&(47===e.src.charCodeAt(s+2)&&(!!(n=e.pending.match(Wt))&&(l=n[1],!!(c=e.md.linkify.matchAtStart(e.src.slice(s-l.length)))&&(u=(u=c.url).replace(/\*+$/,""),d=e.md.normalizeLink(u),!!e.md.validateLink(d)&&(t||(e.pending=e.pending.slice(0,-l.length),(m=e.push("link_open","a",1)).attrs=[["href",d]],m.markup="linkify",m.info="auto",(m=e.push("text","",0)).content=e.md.normalizeLinkText(u),(m=e.push("link_close","a",-1)).markup="linkify",m.info="auto"),e.pos+=u.length-l.length,!0)))))))))}],["newline",function newline2(e,t){var s,n,l,c=e.pos;if(10!==e.src.charCodeAt(c))return!1;if(s=e.pending.length-1,n=e.posMax,!t)if(s>=0&&32===e.pending.charCodeAt(s))if(s>=1&&32===e.pending.charCodeAt(s-1)){for(l=s-1;l>=1&&32===e.pending.charCodeAt(l-1);)l--;e.pending=e.pending.slice(0,l),e.push("hardbreak","br",0)}else e.pending=e.pending.slice(0,-1),e.push("softbreak","br",0);else e.push("softbreak","br",0);for(c++;c<n&&Vt(e.src.charCodeAt(c));)c++;return e.pos=c,!0}],["escape",function escape2(e,t){var s,n,l,c,u,d=e.pos,m=e.posMax;if(92!==e.src.charCodeAt(d))return!1;if(++d>=m)return!1;if(10===(s=e.src.charCodeAt(d))){for(t||e.push("hardbreak","br",0),d++;d<m&&(s=e.src.charCodeAt(d),Jt(s));)d++;return e.pos=d,!0}return c=e.src[d],s>=55296&&s<=56319&&d+1<m&&(n=e.src.charCodeAt(d+1))>=56320&&n<=57343&&(c+=e.src[d+1],d++),l="\\"+c,t||(u=e.push("text_special","",0),s<256&&0!==Kt[s]?u.content=c:u.content=l,u.markup=l,u.info="escape"),e.pos=d+1,!0}],["backticks",function backtick(e,t){var s,n,l,c,u,d,m,h,g=e.pos;if(96!==e.src.charCodeAt(g))return!1;for(s=g,g++,n=e.posMax;g<n&&96===e.src.charCodeAt(g);)g++;if(m=(l=e.src.slice(s,g)).length,e.backticksScanned&&(e.backticks[m]||0)<=s)return t||(e.pending+=l),e.pos+=m,!0;for(u=d=g;-1!==(u=e.src.indexOf("`",d));){for(d=u+1;d<n&&96===e.src.charCodeAt(d);)d++;if((h=d-u)===m)return t||((c=e.push("code_inline","code",0)).markup=l,c.content=e.src.slice(g,u).replace(/\n/g," ").replace(/^ (.+) $/,"$1")),e.pos=d,!0;e.backticks[h]=u}return e.backticksScanned=!0,t||(e.pending+=l),e.pos+=m,!0}],["strikethrough",Zt.tokenize],["emphasis",Yt.tokenize],["link",function link2(e,t){var s,n,l,c,u,d,m,h,g="",y="",b=e.pos,F=e.posMax,k=e.pos,v=!0;if(91!==e.src.charCodeAt(e.pos))return!1;if(u=e.pos+1,(c=e.md.helpers.parseLinkLabel(e,e.pos,!0))<0)return!1;if((d=c+1)<F&&40===e.src.charCodeAt(d)){for(v=!1,d++;d<F&&(n=e.src.charCodeAt(d),es(n)||10===n);d++);if(d>=F)return!1;if(k=d,(m=e.md.helpers.parseLinkDestination(e.src,d,e.posMax)).ok){for(g=e.md.normalizeLink(m.str),e.md.validateLink(g)?d=m.pos:g="",k=d;d<F&&(n=e.src.charCodeAt(d),es(n)||10===n);d++);if(m=e.md.helpers.parseLinkTitle(e.src,d,e.posMax),d<F&&k!==d&&m.ok)for(y=m.str,d=m.pos;d<F&&(n=e.src.charCodeAt(d),es(n)||10===n);d++);}(d>=F||41!==e.src.charCodeAt(d))&&(v=!0),d++}if(v){if(void 0===e.env.references)return!1;if(d<F&&91===e.src.charCodeAt(d)?(k=d+1,(d=e.md.helpers.parseLinkLabel(e,d))>=0?l=e.src.slice(k,d++):d=c+1):d=c+1,l||(l=e.src.slice(u,c)),!(h=e.env.references[Xt(l)]))return e.pos=b,!1;g=h.href,y=h.title}return t||(e.pos=u,e.posMax=c,e.push("link_open","a",1).attrs=s=[["href",g]],y&&s.push(["title",y]),e.linkLevel++,e.md.inline.tokenize(e),e.linkLevel--,e.push("link_close","a",-1)),e.pos=d,e.posMax=F,!0}],["image",function image2(e,t){var s,n,l,c,u,d,m,h,g,y,b,F,k,v="",D=e.pos,C=e.posMax;if(33!==e.src.charCodeAt(e.pos))return!1;if(91!==e.src.charCodeAt(e.pos+1))return!1;if(d=e.pos+2,(u=e.md.helpers.parseLinkLabel(e,e.pos+1,!1))<0)return!1;if((m=u+1)<C&&40===e.src.charCodeAt(m)){for(m++;m<C&&(n=e.src.charCodeAt(m),ss(n)||10===n);m++);if(m>=C)return!1;for(k=m,(g=e.md.helpers.parseLinkDestination(e.src,m,e.posMax)).ok&&(v=e.md.normalizeLink(g.str),e.md.validateLink(v)?m=g.pos:v=""),k=m;m<C&&(n=e.src.charCodeAt(m),ss(n)||10===n);m++);if(g=e.md.helpers.parseLinkTitle(e.src,m,e.posMax),m<C&&k!==m&&g.ok)for(y=g.str,m=g.pos;m<C&&(n=e.src.charCodeAt(m),ss(n)||10===n);m++);else y="";if(m>=C||41!==e.src.charCodeAt(m))return e.pos=D,!1;m++}else{if(void 0===e.env.references)return!1;if(m<C&&91===e.src.charCodeAt(m)?(k=m+1,(m=e.md.helpers.parseLinkLabel(e,m))>=0?c=e.src.slice(k,m++):m=u+1):m=u+1,c||(c=e.src.slice(d,u)),!(h=e.env.references[ts(c)]))return e.pos=D,!1;v=h.href,y=h.title}return t||(l=e.src.slice(d,u),e.md.inline.parse(l,e.md,e.env,F=[]),(b=e.push("image","img",0)).attrs=s=[["src",v],["alt",""]],b.children=F,b.content=l,y&&s.push(["title",y])),e.pos=m,e.posMax=C,!0}],["autolink",function autolink2(e,t){var s,n,l,c,u,d,m=e.pos;if(60!==e.src.charCodeAt(m))return!1;for(u=e.pos,d=e.posMax;;){if(++m>=d)return!1;if(60===(c=e.src.charCodeAt(m)))return!1;if(62===c)break}return s=e.src.slice(u+1,m),is.test(s)?(n=e.md.normalizeLink(s),!!e.md.validateLink(n)&&(t||((l=e.push("link_open","a",1)).attrs=[["href",n]],l.markup="autolink",l.info="auto",(l=e.push("text","",0)).content=e.md.normalizeLinkText(s),(l=e.push("link_close","a",-1)).markup="autolink",l.info="auto"),e.pos+=s.length+2,!0)):!!as.test(s)&&(n=e.md.normalizeLink("mailto:"+s),!!e.md.validateLink(n)&&(t||((l=e.push("link_open","a",1)).attrs=[["href",n]],l.markup="autolink",l.info="auto",(l=e.push("text","",0)).content=e.md.normalizeLinkText(s),(l=e.push("link_close","a",-1)).markup="autolink",l.info="auto"),e.pos+=s.length+2,!0))}],["html_inline",function html_inline2(e,t){var s,n,l,c,u=e.pos;return!!e.md.options.html&&(l=e.posMax,!(60!==e.src.charCodeAt(u)||u+2>=l)&&(!(33!==(s=e.src.charCodeAt(u+1))&&63!==s&&47!==s&&!function isLetter(e){var t=32|e;return t>=97&&t<=122}(s))&&(!!(n=e.src.slice(u).match(ns))&&(t||((c=e.push("html_inline","",0)).content=e.src.slice(u,u+n[0].length),function isLinkOpen(e){return/^<a[>\s]/i.test(e)}(c.content)&&e.linkLevel++,function isLinkClose(e){return/^<\/a\s*>/i.test(e)}(c.content)&&e.linkLevel--),e.pos+=n[0].length,!0))))}],["entity",function entity2(e,t){var s,n,l,c=e.pos,u=e.posMax;if(38!==e.src.charCodeAt(c))return!1;if(c+1>=u)return!1;if(35===e.src.charCodeAt(c+1)){if(n=e.src.slice(c).match(us))return t||(s="x"===n[1][0].toLowerCase()?parseInt(n[1].slice(1),16):parseInt(n[1],10),(l=e.push("text_special","",0)).content=ls(s)?cs(s):cs(65533),l.markup=n[0],l.info="entity"),e.pos+=n[0].length,!0}else if((n=e.src.slice(c).match(ds))&&rs(os,n[1]))return t||((l=e.push("text_special","",0)).content=os[n[1]],l.markup=n[0],l.info="entity"),e.pos+=n[0].length,!0;return!1}]],Fs=[["balance_pairs",function link_pairs(e){var t,s=e.tokens_meta,n=e.tokens_meta.length;for(processDelimiters(0,e.delimiters),t=0;t<n;t++)s[t]&&s[t].delimiters&&processDelimiters(0,s[t].delimiters)}],["strikethrough",Zt.postProcess],["emphasis",Yt.postProcess],["fragments_join",function fragments_join2(e){var t,s,n=0,l=e.tokens,c=e.tokens.length;for(t=s=0;t<c;t++)l[t].nesting<0&&n--,l[t].level=n,l[t].nesting>0&&n++,"text"===l[t].type&&t+1<c&&"text"===l[t+1].type?l[t+1].content=l[t].content+l[t+1].content:(t!==s&&(l[s]=l[t]),s++);t!==s&&(l.length=s)}]];function ParserInline$1(){var e;for(this.ruler=new ys,e=0;e<bs.length;e++)this.ruler.push(bs[e][0],bs[e][1]);for(this.ruler2=new ys,e=0;e<Fs.length;e++)this.ruler2.push(Fs[e][0],Fs[e][1])}ParserInline$1.prototype.skipToken=function(e){var t,s,n=e.pos,l=this.ruler.getRules(""),c=l.length,u=e.md.options.maxNesting,d=e.cache;if(void 0===d[n]){if(e.level<u)for(s=0;s<c&&(e.level++,t=l[s](e,!0),e.level--,!t);s++);else e.pos=e.posMax;t||e.pos++,d[n]=e.pos}else e.pos=d[n]},ParserInline$1.prototype.tokenize=function(e){for(var t,s,n=this.ruler.getRules(""),l=n.length,c=e.posMax,u=e.md.options.maxNesting;e.pos<c;){if(e.level<u)for(s=0;s<l&&!(t=n[s](e,!1));s++);if(t){if(e.pos>=c)break}else e.pending+=e.src[e.pos++]}e.pending&&e.pushPending()},ParserInline$1.prototype.parse=function(e,t,s,n){var l,c,u,d=new this.State(e,t,s,n);for(this.tokenize(d),u=(c=this.ruler2.getRules("")).length,l=0;l<u;l++)c[l](d)},ParserInline$1.prototype.State=gs;var ks,vs,Ds=ParserInline$1;function assign(e){return Array.prototype.slice.call(arguments,1).forEach((function(t){t&&Object.keys(t).forEach((function(s){e[s]=t[s]}))})),e}function _class(e){return Object.prototype.toString.call(e)}function isFunction(e){return"[object Function]"===_class(e)}function escapeRE(e){return e.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}var Cs={fuzzyLink:!0,fuzzyEmail:!0,fuzzyIP:!1};var Ss={"http:":{validate:function(e,t,s){var n=e.slice(t);return s.re.http||(s.re.http=RegExp("^\\/\\/"+s.re.src_auth+s.re.src_host_port_strict+s.re.src_path,"i")),s.re.http.test(n)?n.match(s.re.http)[0].length:0}},"https:":"http:","ftp:":"http:","//":{validate:function(e,t,s){var n=e.slice(t);return s.re.no_http||(s.re.no_http=RegExp("^"+s.re.src_auth+"(?:localhost|(?:(?:"+s.re.src_domain+")\\.)+"+s.re.src_domain_root+")"+s.re.src_port+s.re.src_host_terminator+s.re.src_path,"i")),s.re.no_http.test(n)?t>=3&&":"===e[t-3]||t>=3&&"/"===e[t-3]?0:n.match(s.re.no_http)[0].length:0}},"mailto:":{validate:function(e,t,s){var n=e.slice(t);return s.re.mailto||(s.re.mailto=RegExp("^"+s.re.src_email_name+"@"+s.re.src_host_strict,"i")),s.re.mailto.test(n)?n.match(s.re.mailto)[0].length:0}}},Ts="a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]",_s="biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|рф".split("|");function compile(e){var t=e.re=function requireRe(){return vs?ks:(vs=1,ks=function(e){var t={};e=e||{},t.src_Any=requireRegex$3().source,t.src_Cc=requireRegex$2().source,t.src_Z=requireRegex().source,t.src_P=Se.source,t.src_ZPCc=[t.src_Z,t.src_P,t.src_Cc].join("|"),t.src_ZCc=[t.src_Z,t.src_Cc].join("|");var s="[><｜]";return t.src_pseudo_letter="(?:(?![><｜]|"+t.src_ZPCc+")"+t.src_Any+")",t.src_ip4="(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",t.src_auth="(?:(?:(?!"+t.src_ZCc+"|[@/\\[\\]()]).)+@)?",t.src_port="(?::(?:6(?:[0-4]\\d{3}|5(?:[0-4]\\d{2}|5(?:[0-2]\\d|3[0-5])))|[1-5]?\\d{1,4}))?",t.src_host_terminator="(?=$|[><｜]|"+t.src_ZPCc+")(?!"+(e["---"]?"-(?!--)|":"-|")+"_|:\\d|\\.-|\\.(?!$|"+t.src_ZPCc+"))",t.src_path="(?:[/?#](?:(?!"+t.src_ZCc+"|"+s+"|[()[\\]{}.,\"'?!\\-;]).|\\[(?:(?!"+t.src_ZCc+"|\\]).)*\\]|\\((?:(?!"+t.src_ZCc+"|[)]).)*\\)|\\{(?:(?!"+t.src_ZCc+'|[}]).)*\\}|\\"(?:(?!'+t.src_ZCc+'|["]).)+\\"|\\\'(?:(?!'+t.src_ZCc+"|[']).)+\\'|\\'(?="+t.src_pseudo_letter+"|[-])|\\.{2,}[a-zA-Z0-9%/&]|\\.(?!"+t.src_ZCc+"|[.]|$)|"+(e["---"]?"\\-(?!--(?:[^-]|$))(?:-*)|":"\\-+|")+",(?!"+t.src_ZCc+"|$)|;(?!"+t.src_ZCc+"|$)|\\!+(?!"+t.src_ZCc+"|[!]|$)|\\?(?!"+t.src_ZCc+"|[?]|$))+|\\/)?",t.src_email_name='[\\-;:&=\\+\\$,\\.a-zA-Z0-9_][\\-;:&=\\+\\$,\\"\\.a-zA-Z0-9_]*',t.src_xn="xn--[a-z0-9\\-]{1,59}",t.src_domain_root="(?:"+t.src_xn+"|"+t.src_pseudo_letter+"{1,63})",t.src_domain="(?:"+t.src_xn+"|(?:"+t.src_pseudo_letter+")|(?:"+t.src_pseudo_letter+"(?:-|"+t.src_pseudo_letter+"){0,61}"+t.src_pseudo_letter+"))",t.src_host="(?:(?:(?:(?:"+t.src_domain+")\\.)*"+t.src_domain+"))",t.tpl_host_fuzzy="(?:"+t.src_ip4+"|(?:(?:(?:"+t.src_domain+")\\.)+(?:%TLDS%)))",t.tpl_host_no_ip_fuzzy="(?:(?:(?:"+t.src_domain+")\\.)+(?:%TLDS%))",t.src_host_strict=t.src_host+t.src_host_terminator,t.tpl_host_fuzzy_strict=t.tpl_host_fuzzy+t.src_host_terminator,t.src_host_port_strict=t.src_host+t.src_port+t.src_host_terminator,t.tpl_host_port_fuzzy_strict=t.tpl_host_fuzzy+t.src_port+t.src_host_terminator,t.tpl_host_port_no_ip_fuzzy_strict=t.tpl_host_no_ip_fuzzy+t.src_port+t.src_host_terminator,t.tpl_host_fuzzy_test="localhost|www\\.|\\.\\d{1,3}\\.|(?:\\.(?:%TLDS%)(?:"+t.src_ZPCc+"|>|$))",t.tpl_email_fuzzy='(^|[><｜]|"|\\(|'+t.src_ZCc+")("+t.src_email_name+"@"+t.tpl_host_fuzzy_strict+")",t.tpl_link_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+t.src_ZPCc+"))((?![$+<=>^`|｜])"+t.tpl_host_port_fuzzy_strict+t.src_path+")",t.tpl_link_no_ip_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+t.src_ZPCc+"))((?![$+<=>^`|｜])"+t.tpl_host_port_no_ip_fuzzy_strict+t.src_path+")",t})}()(e.__opts__),s=e.__tlds__.slice();function untpl(e){return e.replace("%TLDS%",t.src_tlds)}e.onCompile(),e.__tlds_replaced__||s.push(Ts),s.push(t.src_xn),t.src_tlds=s.join("|"),t.email_fuzzy=RegExp(untpl(t.tpl_email_fuzzy),"i"),t.link_fuzzy=RegExp(untpl(t.tpl_link_fuzzy),"i"),t.link_no_ip_fuzzy=RegExp(untpl(t.tpl_link_no_ip_fuzzy),"i"),t.host_fuzzy_test=RegExp(untpl(t.tpl_host_fuzzy_test),"i");var n=[];function schemaError(e,t){throw Error('(LinkifyIt) Invalid schema "'+e+'": '+t)}e.__compiled__={},Object.keys(e.__schemas__).forEach((function(t){var s=e.__schemas__[t];if(null!==s){var l={validate:null,link:null};if(e.__compiled__[t]=l,function isObject(e){return"[object Object]"===_class(e)}(s))return!function isRegExp(e){return"[object RegExp]"===_class(e)}(s.validate)?isFunction(s.validate)?l.validate=s.validate:schemaError(t,s):l.validate=function createValidator(e){return function(t,s){var n=t.slice(s);return e.test(n)?n.match(e)[0].length:0}}(s.validate),void(isFunction(s.normalize)?l.normalize=s.normalize:s.normalize?schemaError(t,s):l.normalize=function(e,t){t.normalize(e)});!function isString(e){return"[object String]"===_class(e)}(s)?schemaError(t,s):n.push(t)}})),n.forEach((function(t){e.__compiled__[e.__schemas__[t]]&&(e.__compiled__[t].validate=e.__compiled__[e.__schemas__[t]].validate,e.__compiled__[t].normalize=e.__compiled__[e.__schemas__[t]].normalize)})),e.__compiled__[""]={validate:null,normalize:function(e,t){t.normalize(e)}};var l=Object.keys(e.__compiled__).filter((function(t){return t.length>0&&e.__compiled__[t]})).map(escapeRE).join("|");e.re.schema_test=RegExp("(^|(?!_)(?:[><｜]|"+t.src_ZPCc+"))("+l+")","i"),e.re.schema_search=RegExp("(^|(?!_)(?:[><｜]|"+t.src_ZPCc+"))("+l+")","ig"),e.re.schema_at_start=RegExp("^"+e.re.schema_search.source,"i"),e.re.pretest=RegExp("("+e.re.schema_test.source+")|("+e.re.host_fuzzy_test.source+")|@","i"),function resetScanCache(e){e.__index__=-1,e.__text_cache__=""}(e)}function Match(e,t){var s=e.__index__,n=e.__last_index__,l=e.__text_cache__.slice(s,n);this.schema=e.__schema__.toLowerCase(),this.index=s+t,this.lastIndex=n+t,this.raw=l,this.text=l,this.url=l}function createMatch(e,t){var s=new Match(e,t);return e.__compiled__[s.schema].normalize(s,e),s}function LinkifyIt$1(e,t){if(!(this instanceof LinkifyIt$1))return new LinkifyIt$1(e,t);t||function isOptionsObj(e){return Object.keys(e||{}).reduce((function(e,t){return e||Cs.hasOwnProperty(t)}),!1)}(e)&&(t=e,e={}),this.__opts__=assign({},Cs,t),this.__index__=-1,this.__last_index__=-1,this.__schema__="",this.__text_cache__="",this.__schemas__=assign({},Ss,e),this.__compiled__={},this.__tlds__=_s,this.__tlds_replaced__=!1,this.re={},compile(this)}LinkifyIt$1.prototype.add=function add(e,t){return this.__schemas__[e]=t,compile(this),this},LinkifyIt$1.prototype.set=function set(e){return this.__opts__=assign(this.__opts__,e),this},LinkifyIt$1.prototype.test=function test(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return!1;var t,s,n,l,c,u,d,m;if(this.re.schema_test.test(e))for((d=this.re.schema_search).lastIndex=0;null!==(t=d.exec(e));)if(l=this.testSchemaAt(e,t[2],d.lastIndex)){this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+l;break}return this.__opts__.fuzzyLink&&this.__compiled__["http:"]&&(m=e.search(this.re.host_fuzzy_test))>=0&&(this.__index__<0||m<this.__index__)&&null!==(s=e.match(this.__opts__.fuzzyIP?this.re.link_fuzzy:this.re.link_no_ip_fuzzy))&&(c=s.index+s[1].length,(this.__index__<0||c<this.__index__)&&(this.__schema__="",this.__index__=c,this.__last_index__=s.index+s[0].length)),this.__opts__.fuzzyEmail&&this.__compiled__["mailto:"]&&e.indexOf("@")>=0&&null!==(n=e.match(this.re.email_fuzzy))&&(c=n.index+n[1].length,u=n.index+n[0].length,(this.__index__<0||c<this.__index__||c===this.__index__&&u>this.__last_index__)&&(this.__schema__="mailto:",this.__index__=c,this.__last_index__=u)),this.__index__>=0},LinkifyIt$1.prototype.pretest=function pretest(e){return this.re.pretest.test(e)},LinkifyIt$1.prototype.testSchemaAt=function testSchemaAt(e,t,s){return this.__compiled__[t.toLowerCase()]?this.__compiled__[t.toLowerCase()].validate(e,s,this):0},LinkifyIt$1.prototype.match=function match(e){var t=0,s=[];this.__index__>=0&&this.__text_cache__===e&&(s.push(createMatch(this,t)),t=this.__last_index__);for(var n=t?e.slice(t):e;this.test(n);)s.push(createMatch(this,t)),n=n.slice(this.__last_index__),t+=this.__last_index__;return s.length?s:null},LinkifyIt$1.prototype.matchAtStart=function matchAtStart(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return null;var t=this.re.schema_at_start.exec(e);if(!t)return null;var s=this.testSchemaAt(e,t[2],t[0].length);return s?(this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+s,createMatch(this,0)):null},LinkifyIt$1.prototype.tlds=function tlds(e,t){return e=Array.isArray(e)?e:[e],t?(this.__tlds__=this.__tlds__.concat(e).sort().filter((function(e,t,s){return e!==s[t-1]})).reverse(),compile(this),this):(this.__tlds__=e.slice(),this.__tlds_replaced__=!0,compile(this),this)},LinkifyIt$1.prototype.normalize=function normalize3(e){e.schema||(e.url="http://"+e.url),"mailto:"!==e.schema||/^mailto:/i.test(e.url)||(e.url="mailto:"+e.url)},LinkifyIt$1.prototype.onCompile=function onCompile(){};var ws=LinkifyIt$1;const As=2147483647,xs=36,Is=/^xn--/,Ps=/[^\0-\x7F]/,Es=/[\x2E\u3002\uFF0E\uFF61]/g,Ms={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},Os=Math.floor,Ls=String.fromCharCode;function error(e){throw new RangeError(Ms[e])}function mapDomain(e,t){const s=e.split("@");let n="";s.length>1&&(n=s[0]+"@",e=s[1]);const l=function map(e,t){const s=[];let n=e.length;for(;n--;)s[n]=t(e[n]);return s}((e=e.replace(Es,".")).split("."),t).join(".");return n+l}function ucs2decode(e){const t=[];let s=0;const n=e.length;for(;s<n;){const l=e.charCodeAt(s++);if(l>=55296&&l<=56319&&s<n){const n=e.charCodeAt(s++);56320==(64512&n)?t.push(((1023&l)<<10)+(1023&n)+65536):(t.push(l),s--)}else t.push(l)}return t}const ucs2encode=e=>String.fromCodePoint(...e),digitToBasic=function(e,t){return e+22+75*(e<26)-((0!=t)<<5)},adapt=function(e,t,s){let n=0;for(e=s?Os(e/700):e>>1,e+=Os(e/t);e>455;n+=xs)e=Os(e/35);return Os(n+36*e/(e+38))},decode=function(e){const t=[],s=e.length;let n=0,l=128,c=72,u=e.lastIndexOf("-");u<0&&(u=0);for(let s=0;s<u;++s)e.charCodeAt(s)>=128&&error("not-basic"),t.push(e.charCodeAt(s));for(let m=u>0?u+1:0;m<s;){const u=n;for(let t=1,l=xs;;l+=xs){m>=s&&error("invalid-input");const u=(d=e.charCodeAt(m++))>=48&&d<58?d-48+26:d>=65&&d<91?d-65:d>=97&&d<123?d-97:xs;u>=xs&&error("invalid-input"),u>Os((As-n)/t)&&error("overflow"),n+=u*t;const h=l<=c?1:l>=c+26?26:l-c;if(u<h)break;const g=xs-h;t>Os(As/g)&&error("overflow"),t*=g}const h=t.length+1;c=adapt(n-u,h,0==u),Os(n/h)>As-l&&error("overflow"),l+=Os(n/h),n%=h,t.splice(n++,0,l)}var d;return String.fromCodePoint(...t)},encode=function(e){const t=[],s=(e=ucs2decode(e)).length;let n=128,l=0,c=72;for(const s of e)s<128&&t.push(Ls(s));const u=t.length;let d=u;for(u&&t.push("-");d<s;){let s=As;for(const t of e)t>=n&&t<s&&(s=t);const m=d+1;s-n>Os((As-l)/m)&&error("overflow"),l+=(s-n)*m,n=s;for(const s of e)if(s<n&&++l>As&&error("overflow"),s===n){let e=l;for(let s=xs;;s+=xs){const n=s<=c?1:s>=c+26?26:s-c;if(e<n)break;const l=e-n,u=xs-n;t.push(Ls(digitToBasic(n+l%u,0))),e=Os(l/u)}t.push(Ls(digitToBasic(e,0))),c=adapt(l,m,d===u),l=0,++d}++l,++n}return t.join("")},toUnicode=function(e){return mapDomain(e,(function(e){return Is.test(e)?decode(e.slice(4).toLowerCase()):e}))},toASCII=function(e){return mapDomain(e,(function(e){return Ps.test(e)?"xn--"+encode(e):e}))},Rs=Object.freeze(Object.defineProperty({__proto__:null,decode,default:{version:"2.1.0",ucs2:{decode:ucs2decode,encode:ucs2encode},decode,encode,toASCII,toUnicode},encode,toASCII,toUnicode,ucs2decode,ucs2encode},Symbol.toStringTag,{value:"Module"}));var Ns=De,js=Ye,zs=nt,Bs=St,$s=Gt,qs=Ds,Us=ws,Hs=Te,Gs=getAugmentedNamespace(Rs),Ws={default:{options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:100},components:{core:{},block:{},inline:{}}},zero:{options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["paragraph"]},inline:{rules:["text"],rules2:["balance_pairs","fragments_join"]}}},commonmark:{options:{html:!0,xhtmlOut:!0,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["normalize","block","inline","text_join"]},block:{rules:["blockquote","code","fence","heading","hr","html_block","lheading","list","reference","paragraph"]},inline:{rules:["autolink","backticks","emphasis","entity","escape","html_inline","image","link","newline","text"],rules2:["balance_pairs","emphasis","fragments_join"]}}}},Vs=/^(vbscript|javascript|file|data):/,Js=/^data:image\/(gif|png|jpeg|webp);/;function validateLink(e){var t=e.trim().toLowerCase();return!Vs.test(t)||!!Js.test(t)}var Ks=["http:","https:","mailto:"];function normalizeLink(e){var t=Hs.parse(e,!0);if(t.hostname&&(!t.protocol||Ks.indexOf(t.protocol)>=0))try{t.hostname=Gs.toASCII(t.hostname)}catch(e){}return Hs.encode(Hs.format(t))}function normalizeLinkText(e){var t=Hs.parse(e,!0);if(t.hostname&&(!t.protocol||Ks.indexOf(t.protocol)>=0))try{t.hostname=Gs.toUnicode(t.hostname)}catch(e){}return Hs.decode(Hs.format(t),Hs.decode.defaultChars+"%")}function MarkdownIt$1(e,t){if(!(this instanceof MarkdownIt$1))return new MarkdownIt$1(e,t);t||Ns.isString(e)||(t=e||{},e="default"),this.inline=new qs,this.block=new $s,this.core=new Bs,this.renderer=new zs,this.linkify=new Us,this.validateLink=validateLink,this.normalizeLink=normalizeLink,this.normalizeLinkText=normalizeLinkText,this.utils=Ns,this.helpers=Ns.assign({},js),this.options={},this.configure(e),t&&this.set(t)}MarkdownIt$1.prototype.set=function(e){return Ns.assign(this.options,e),this},MarkdownIt$1.prototype.configure=function(e){var t,s=this;if(Ns.isString(e)&&!(e=Ws[t=e]))throw Error('Wrong `markdown-it` preset "'+t+'", check name');if(!e)throw Error("Wrong `markdown-it` preset, can't be empty");return e.options&&s.set(e.options),e.components&&Object.keys(e.components).forEach((function(t){e.components[t].rules&&s[t].ruler.enableOnly(e.components[t].rules),e.components[t].rules2&&s[t].ruler2.enableOnly(e.components[t].rules2)})),this},MarkdownIt$1.prototype.enable=function(e,t){var s=[];Array.isArray(e)||(e=[e]),["core","block","inline"].forEach((function(t){s=s.concat(this[t].ruler.enable(e,!0))}),this),s=s.concat(this.inline.ruler2.enable(e,!0));var n=e.filter((function(e){return s.indexOf(e)<0}));if(n.length&&!t)throw Error("MarkdownIt. Failed to enable unknown rule(s): "+n);return this},MarkdownIt$1.prototype.disable=function(e,t){var s=[];Array.isArray(e)||(e=[e]),["core","block","inline"].forEach((function(t){s=s.concat(this[t].ruler.disable(e,!0))}),this),s=s.concat(this.inline.ruler2.disable(e,!0));var n=e.filter((function(e){return s.indexOf(e)<0}));if(n.length&&!t)throw Error("MarkdownIt. Failed to disable unknown rule(s): "+n);return this},MarkdownIt$1.prototype.use=function(e){var t=[this].concat(Array.prototype.slice.call(arguments,1));return e.apply(e,t),this},MarkdownIt$1.prototype.parse=function(e,t){if("string"!=typeof e)throw Error("Input data should be a String");var s=new this.core.State(e,this,t);return this.core.process(s),s.tokens},MarkdownIt$1.prototype.render=function(e,t){return t=t||{},this.renderer.render(this.parse(e,t),this.options,t)},MarkdownIt$1.prototype.parseInline=function(e,t){var s=new this.core.State(e,this,t);return s.inlineMode=!0,this.core.process(s),s.tokens},MarkdownIt$1.prototype.renderInline=function(e,t){return t=t||{},this.renderer.render(this.parseInline(e,t),this.options,t)};const Qs=getDefaultExportFromCjs(MarkdownIt$1);class ChangeLogWindow extends FormApplication{constructor(e){super({},{}),this.lastVersion=e}static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{id:"changelog",classes:["ffd20","changelog"],template:"systems/ffd20/templates/apps/changelog.hbs",width:500,submitOnChange:!0,closeOnSubmit:!1})}get title(){return`${game.i18n.localize("FFD20.Title")} ~ ${game.i18n.localize("FFD20.Changelog")}`}async getData(){const e=await super.getData();e.dontShowAgain=game.settings.get("ffd20","dontShowChangelog");const t=new XMLHttpRequest;t.open("GET","systems/ffd20/CHANGELOG.md");const s=new Promise((s=>{t.onload=()=>{200===t.status&&(e.changelog=this._processChangelog(t.response),s(e))}}));return t.send(null),s}_processChangelog(e){const t=new Qs;let s=e.split(/[\n\r]/);if(this.lastVersion)for(let e=0;e<s.length;e++){if(s[e].match(/##\s+([0-9]+\.[0-9]+\.[0-9]+)/)){if(!SemanticVersion.fromString(RegExp.$1).isHigherThan(this.lastVersion)){s=s.slice(0,e);break}}}return t.render(s.join("\n"))}async _updateObject(e,t){null!=t.dontShowAgain&&await game.settings.set("ffd20","dontShowChangelog",t.dontShowAgain)}}class EntrySelector extends FormApplication{constructor(...e){super(...e),this.isFlag=!0===this.options.flag,this.isBoolean=!0===this.options.boolean,this.isFlat=!0===this.options.flat;const t=deepClone(getProperty(this.object,this.attribute)??(this.isFlag?{}:[]));this.originalEntries=t,this.entries=this.isFlag?this.isBoolean?Object.keys(t).map((e=>[e])):Object.entries(t):t}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"entry-selector",classes:["ffd20","entry"],template:"systems/ffd20/templates/apps/entry-selector.hbs",width:320,height:"auto",closeOnSubmit:!1,submitOnClose:!1})}get title(){return game.i18n.localize("FFD20.Application.EntrySelector.Title")}get attribute(){return this.options.name}get fields(){return this.options.fields.split(";")}get dtypes(){return this.options.dtypes.split(";")}get dataCount(){return this.fields.length}getData(){return{entries:this.entries.map((e=>this.isFlat?[e,this.dtypes[e]]:e.map(((e,t)=>[e,this.dtypes[t]])))),fields:this.fields,isFlat:this.isFlat}}activateListeners(e){e.find(".entry-control").click(this._onEntryControl.bind(this)),e.find('tr td input[type="text"]').change(this._onEntryChange.bind(this)),e.find('button[type="submit"]').click(this._submitAndClose.bind(this))}async _updateObject(e,t){const s={};if(this.isFlag){const e=new Set;this.entries.forEach((([t,n])=>{e.add(t),s[`${this.attribute}.${t}`]=!!this.isBoolean||n}));Object.keys(this.originalEntries).forEach((t=>{e.has(t)||(s[`${this.attribute}.-=${t}`]=null)}))}else console.log(deepClone(this.attribute),deepClone(this.entries)),s[this.attribute]=this.entries;return this.object.update(s)}async _onEntryControl(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("add-entry")){if(this.isFlat){"Number"===this.dtypes[t]?this.entries.push(0):this.entries.push("")}else{const e=[];for(let t=0;t<this.dataCount;t++){"Number"===this.dtypes[t]?e.push(0):e.push("")}this.entries.push(e)}return this.render()}if(t.classList.contains("delete-entry")){const e=t.closest("tr"),s=parseInt(e.dataset.index);return this.entries.splice(s,1),this.render()}}async _onEntryChange(e){const t=e.currentTarget,s=t.closest("tr.entry"),n=parseInt(s.dataset.index),l=parseInt(t.dataset.index),c=t.value;if("Number"===t.dataset.dtype){let e=parseFloat(c);isNaN(e)&&(e=0),this.isFlat?this.entries[n]=Math.floor(100*e)/100:this.entries[n][l]=Math.floor(100*e)/100}else this.isFlat?this.entries[n]=c:this.entries[n][l]=c}async _submitAndClose(e){e.preventDefault(),await this._onSubmit(e),this.close()}}var Zs=!1,Ys={false:"push",true:"unshift",after:"push",before:"unshift"},Xs={isPermalinkSymbol:!0};function r(e,t,s,n){var l;if(!Zs){var c="Using deprecated markdown-it-anchor permalink option, see https://github.com/valeriangalliat/markdown-it-anchor#permalinks";"object"==typeof process&&process&&process.emitWarning?process.emitWarning(c):console.warn(c),Zs=!0}var u=[Object.assign(new s.Token("link_open","a",1),{attrs:[].concat(t.permalinkClass?[["class",t.permalinkClass]]:[],[["href",t.permalinkHref(e,s)]],Object.entries(t.permalinkAttrs(e,s)))}),Object.assign(new s.Token("html_block","",0),{content:t.permalinkSymbol,meta:Xs}),new s.Token("link_close","a",-1)];t.permalinkSpace&&s.tokens[n+1].children[Ys[t.permalinkBefore]](Object.assign(new s.Token("text","",0),{content:" "})),(l=s.tokens[n+1].children)[Ys[t.permalinkBefore]].apply(l,u)}function a(e){return"#"+e}function i(e){return{}}var ea={class:"header-anchor",symbol:"#",renderHref:a,renderAttrs:i};function o(e){function n2(t){return t=Object.assign({},n2.defaults,t),function(s,n,l,c){return e(s,t,n,l,c)}}return n2.defaults=Object.assign({},ea),n2.renderPermalinkImpl=e,n2}var ta=o((function(e,t,s,n,l){var c,u=[Object.assign(new n.Token("link_open","a",1),{attrs:[].concat(t.class?[["class",t.class]]:[],[["href",t.renderHref(e,n)]],t.ariaHidden?[["aria-hidden","true"]]:[],Object.entries(t.renderAttrs(e,n)))}),Object.assign(new n.Token("html_inline","",0),{content:t.symbol,meta:Xs}),new n.Token("link_close","a",-1)];if(t.space){var d="string"==typeof t.space?t.space:" ";n.tokens[l+1].children[Ys[t.placement]](Object.assign(new n.Token("string"==typeof t.space?"html_inline":"text","",0),{content:d}))}(c=n.tokens[l+1].children)[Ys[t.placement]].apply(c,u)}));Object.assign(ta.defaults,{space:!0,placement:"after",ariaHidden:!1});var sa=o(ta.renderPermalinkImpl);sa.defaults=Object.assign({},ta.defaults,{ariaHidden:!0});var aa=o((function(e,t,s,n,l){var c=[Object.assign(new n.Token("link_open","a",1),{attrs:[].concat(t.class?[["class",t.class]]:[],[["href",t.renderHref(e,n)]],Object.entries(t.renderAttrs(e,n)))})].concat(t.safariReaderFix?[new n.Token("span_open","span",1)]:[],n.tokens[l+1].children,t.safariReaderFix?[new n.Token("span_close","span",-1)]:[],[new n.Token("link_close","a",-1)]);n.tokens[l+1]=Object.assign(new n.Token("inline","",0),{children:c})}));Object.assign(aa.defaults,{safariReaderFix:!1});var ia=o((function(e,t,s,n,l){var c;if(!["visually-hidden","aria-label","aria-describedby","aria-labelledby"].includes(t.style))throw Error("`permalink.linkAfterHeader` called with unknown style option `"+t.style+"`");if(!["aria-describedby","aria-labelledby"].includes(t.style)&&!t.assistiveText)throw Error("`permalink.linkAfterHeader` called without the `assistiveText` option in `"+t.style+"` style");if("visually-hidden"===t.style&&!t.visuallyHiddenClass)throw Error("`permalink.linkAfterHeader` called without the `visuallyHiddenClass` option in `visually-hidden` style");var u=n.tokens[l+1].children.filter((function(e){return"text"===e.type||"code_inline"===e.type})).reduce((function(e,t){return e+t.content}),""),d=[],m=[];if(t.class&&m.push(["class",t.class]),m.push(["href",t.renderHref(e,n)]),m.push.apply(m,Object.entries(t.renderAttrs(e,n))),"visually-hidden"===t.style){if(d.push(Object.assign(new n.Token("span_open","span",1),{attrs:[["class",t.visuallyHiddenClass]]}),Object.assign(new n.Token("text","",0),{content:t.assistiveText(u)}),new n.Token("span_close","span",-1)),t.space){var h="string"==typeof t.space?t.space:" ";d[Ys[t.placement]](Object.assign(new n.Token("string"==typeof t.space?"html_inline":"text","",0),{content:h}))}d[Ys[t.placement]](Object.assign(new n.Token("span_open","span",1),{attrs:[["aria-hidden","true"]]}),Object.assign(new n.Token("html_inline","",0),{content:t.symbol,meta:Xs}),new n.Token("span_close","span",-1))}else d.push(Object.assign(new n.Token("html_inline","",0),{content:t.symbol,meta:Xs}));"aria-label"===t.style?m.push(["aria-label",t.assistiveText(u)]):["aria-describedby","aria-labelledby"].includes(t.style)&&m.push([t.style,e]);var g=[Object.assign(new n.Token("link_open","a",1),{attrs:m})].concat(d,[new n.Token("link_close","a",-1)]);(c=n.tokens).splice.apply(c,[l+3,0].concat(g)),t.wrapper&&(n.tokens.splice(l,0,Object.assign(new n.Token("html_block","",0),{content:t.wrapper[0]+"\n"})),n.tokens.splice(l+3+g.length+1,0,Object.assign(new n.Token("html_block","",0),{content:t.wrapper[1]+"\n"})))}));function f(e,t,s,n){var l=e,c=n;if(s&&Object.prototype.hasOwnProperty.call(t,l))throw Error("User defined `id` attribute `"+e+"` is not unique. Please fix it in your Markdown to continue.");for(;Object.prototype.hasOwnProperty.call(t,l);)l=e+"-"+c,c+=1;return t[l]=!0,l}function p(e,t){t=Object.assign({},p.defaults,t),e.core.ruler.push("anchor",(function(e){for(var s,n={},l=e.tokens,c=Array.isArray(t.level)?(s=t.level,function(e){return s.includes(e)}):function(e){return function(t){return t>=e}}(t.level),u=0;u<l.length;u++){var d=l[u];if("heading_open"===d.type&&c(Number(d.tag.substr(1)))){var m=t.getTokensText(l[u+1].children),h=d.attrGet("id");h=null==h?f(t.slugify(m),n,!1,t.uniqueSlugStartIndex):f(h,n,!0,t.uniqueSlugStartIndex),d.attrSet("id",h),!1!==t.tabIndex&&d.attrSet("tabindex",""+t.tabIndex),"function"==typeof t.permalink?t.permalink(h,t,e,u):(t.permalink||t.renderPermalink&&t.renderPermalink!==r)&&t.renderPermalink(h,t,e,u),u=l.indexOf(d),t.callback&&t.callback(d,{slug:h,title:m})}}}))}Object.assign(ia.defaults,{style:"visually-hidden",space:!0,placement:"after",wrapper:null}),p.permalink={__proto__:null,legacy:r,renderHref:a,renderAttrs:i,makePermalink:o,linkInsideHeader:ta,ariaHidden:sa,headerLink:aa,linkAfterHeader:ia},p.defaults={level:1,slugify:function(e){return encodeURIComponent((e+"").trim().toLowerCase().replace(/\s+/g,"-"))},uniqueSlugStartIndex:1,tabIndex:"-1",getTokensText:function(e){return e.filter((function(e){return["text","code_inline"].includes(e.type)})).map((function(e){return e.content})).join("")},permalink:!1,renderPermalink:r,permalinkClass:sa.defaults.class,permalinkSpace:sa.defaults.space,permalinkSymbol:"¶",permalinkBefore:"before"===sa.defaults.placement,permalinkHref:sa.defaults.renderHref,permalinkAttrs:sa.defaults.renderAttrs},p.default=p;class HelpBrowserPF extends Application{_backwardHistory=[];_forwardHistory=[];_currentPage={url:""};_md;constructor(...e){return super(...e),this._initMarkdown(),this}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","help-browser"],template:"systems/ffd20/templates/apps/help-browser.hbs",minWidth:800,minHeight:450,width:960,height:600,resizable:!0,id:"ffd20-help-browser"})}get title(){return game.i18n.localize("FFD20.Help.Label")}get currentUrl(){return this._currentPage.url}_initMarkdown(){const e=(new Qs).use(p,{tabIndex:!1,slugify:e=>"ffd20-help-browser."+e.slugify()}),t=e.renderer.rules.image;e.renderer.rules.image=pf1HelpImageRenderer(t),this._md=e}async getData(){const e=await super.getData();return this.nav??=this._md.render(game.i18n.localize("FFD20.Help/Home")),e.hasHistoryBack=this._backwardHistory.length>0,e.hasHistoryForward=this._forwardHistory.length>0,e.nav=this.nav,e.pageContent=this._md.render(game.i18n.localize("FFD20."+this.currentUrl)),e}openUrl(e){let t;e.startsWith("/")&&(e=e.slice(1)),[e,t]=e.split("#"),this.currentUrl&&e!==this.currentUrl&&(this._backwardHistory.push(this.getCurrentHistoryObject()),this._forwardHistory.splice(0,this._forwardHistory.length)),this._currentPage={url:e},this.render(!0,{header:t})}async _render(e,t){await super._render(t);const s=this.element.find(".content")[0];if(this._currentPage.scrollTop)setTimeout((()=>{s.scrollTop=this._currentPage.scrollTop}),0);else if(t.header){const e=document.getElementById("ffd20-help-browser."+t.header);e&&setTimeout((()=>{const t=Number.parseFloat(getComputedStyle(e).fontSize);s.scrollTop=e.offsetTop-(45+1.5*t)}),0)}}getCurrentHistoryObject(){const e=this.element.find(".content")[0],t=e?.scrollTop??0;return{url:this.currentUrl,scrollTop:t}}backInHistory(){this._backwardHistory.length&&(this._forwardHistory.push(this.getCurrentHistoryObject()),this._currentPage=this._backwardHistory.pop(),this.render())}forwardInHistory(){this._forwardHistory.length&&(this._backwardHistory.push(this.getCurrentHistoryObject()),this._currentPage=this._forwardHistory.pop(),this.render())}activateListeners(e){const t=e.find("a[href]");for(const e of t){const t=e.getAttribute("href");e.removeAttribute("href"),e.dataset.url=t}e.on("click","a",(e=>{e.preventDefault();const t=e.currentTarget.dataset.url;t&&this.openUrl(t)})),e.find(".history-back").on("click",this.backInHistory.bind(this)),e.find(".history-forward").on("click",this.forwardInHistory.bind(this))}}const pf1HelpImageRenderer=e=>(t,s,n,l,c)=>{const u=t[s];let d=u.attrGet("src");d.startsWith("/")&&(d=d.slice(1));const m=game.i18n.localize("FFD20."+d);return u.attrSet("src",foundry.utils.getRoute("systems/ffd20/"+m)),e(t,s,n,l,c)},na=new HelpBrowserPF;class LinkOptions extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"link-options",classes:["ffd20"],title:game.i18n.localize("FFD20.LinkOptionsTitle"),template:"systems/ffd20/templates/apps/link-options.hbs",width:320,height:"auto",submitOnClose:!0,closeOnSubmit:!0})}getData(){const e=this.object,t=V.getLinkTypes(e.source(),e.target()),s=t.reduce(((e,t)=>(e[t]="Link_"+t,e)),{}),n=this._getLinkTypeCommandOptions(e,t[0]);return{linkTypes:s,options:n,isNumber:null!=n&&"number"===n.type,isString:null!=n&&"string"===n.type}}_getLinkTypeCommandOptions(e,t){return"minLevel"===(e.data("type")||t)?{type:"number",min:1,max:20,initial:e.data("value")||1}:null}}class SensesSelector extends DocumentSheet{static get defaultOptions(){const e=super.defaultOptions;return mergeObject(e,{classes:["ffd20","senses-selector"],template:"systems/ffd20/templates/apps/senses-selector.hbs",width:500,closeOnSubmit:!0})}get title(){return`${game.i18n.localize("FFD20.Senses")}: ${this.object.name}`}get convertKeys(){return{"system.traits.senses.dv":"distance","system.traits.senses.ts":"distance","system.traits.senses.bse":"distance","system.traits.senses.bs":"distance","system.traits.senses.sc":"distance"}}async getData(){return{system:this.document.system,converted:Object.entries(this.convertKeys).reduce(((e,[t,s])=>("distance"===s&&setProperty(e,t,ffd20.utils.convertDistance(getProperty(this.document,t))[0]),e)),{}),gridUnits:"imperial"===getDistanceSystem()?"ft":"m"}}async _updateObject(e,t){Object.entries(this.convertKeys).forEach((e=>{"distance"===e[1]&&(t[e[0]]=ffd20.utils.convertDistanceBack(t[e[0]])[0])}));return await super._updateObject(e,t)}}class SkillEditor extends FormApplication{constructor(e,t,s,n={}){super(e,n),this.skillId=t,this.subSkillId=s,this._callbacks=[]}static get defaultOptions(){const e=super.defaultOptions;return{...e,width:380,template:"systems/ffd20/templates/apps/skill-editor.hbs",closeOnSubmit:!1,dragDrop:[{dragSelector:null,dropSelector:"*"}],classes:[...e.classes,"ffd20","skill-editor"]}}get title(){return`${game.i18n.localize("FFD20.EditSkill")}: ${this.skillName}`}get actor(){return this.object}get isSubSkill(){return null!=this.subSkillId}get isStaticSkill(){return null!=ffd20.config.skills[this.skillId]&&!this.isSubSkill}get skill(){return this.isSubSkill?this.actor.system.skills[this.skillId]?.subSkills[this.subSkillId]:this.actor.system.skills[this.skillId]}get skillName(){return this.isStaticSkill?ffd20.config.skills[this.skillId]:this.skill.name}get skillTag(){return this.isStaticSkill?this.skillId:this.isSubSkill?this.subSkillId:this.skillId}async getData(e){const t=await super.getData(e);t.config=ffd20.config,t.skill=mergeObject(this.skill,{skillId:this.skillId,subSkillId:this.subSkillId,isSubSkill:this.isSubSkill,name:this.skillName,static:this.isStaticSkill,tag:this.skillTag},{inplace:!1}),t.actorData=this.actor.toObject();try{const e=await fromUuid(t.skill.journal);t.journal=e.toObject(),t.journal.uuid=t.skill.journal,t.journal.documentType=e instanceof JournalEntryPage?"JournalEntryPage":"JournalEntry"}catch(e){t.journal=null}return t}addCallback(e){this._callbacks.push(e)}async _updateObject(e,t){e.preventDefault();const s={system:{skills:{}}},n=s.system.skills;t=expandObject(t);const l=t.tag?.slugify({strict:!0}),c=t.skill,u=this.subSkillId,d=this.skillId;if(c.journal??=this.skill.journal,c.custom??=this.skill.custom,this.isStaticSkill||(c.background??=this.skill.background),this.isStaticSkill||l){if(l&&(this.isSubSkill?this.subSkillId=l:this.skillId=l),this.isSubSkill){if(n[this.skillId]={subSkills:{[this.subSkillId]:c}},!this.isStaticSkill&&u!==this.subSkillId&&(n[this.skillId].subSkills["-="+u]=null,this.subSkillId in this.object.system.skills[this.skillId].subSkills))return void ui.notifications.error(game.i18n.format("FFD20.ErrorSkillTagAlreadyExists",{tag:`${this.skillId}.subSkills.${this.subSkillId}`}))}else if(n[this.skillId]=c,!this.isStaticSkill&&d!==this.skillId&&(n["-="+d]=null,this.skillId in this.object.system.skills))return void ui.notifications.error(game.i18n.format("FFD20.ErrorSkillTagAlreadyExists",{tag:this.skillId}));await this.object.update(s)}else ui.notifications.error(game.i18n.localize("FFD20.ErrorEmptySkillTag"))}async close(...e){await super.close(...e),this._callbacks.forEach((e=>e()))}async _onDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e);if("JournalEntryPage"!==t.type&&"JournalEntry"!==t.type)return;const s=await CONFIG[t.type].documentClass.implementation.fromDropData(t);s&&(await this._onSubmit(e,{updateData:{"skill.journal":s.uuid}}),await this.render())}activateListeners(e){super.activateListeners(e),e.find(".compendium-page").on("click",this._openCompendiumEntry.bind(this)),e.find(".compendium-controls a").on("click",this._onCompendiumControls.bind(this)),e.find('button[type="submit"]').on("click",(e=>{e.preventDefault();this.element[0].querySelector("form").reportValidity()&&this.close({submit:!0})}))}async _openCompendiumEntry(e){e.preventDefault();const t=e.currentTarget.closest(".compendium-entry").dataset.compendiumEntry,s=await fromUuid(t);s instanceof JournalEntryPage?s.parent.sheet.render(!0,{pageId:s.id}):s.sheet.render(!0)}async _onCompendiumControls(e){e.preventDefault();e.currentTarget.classList.contains("delete")&&(await this._onSubmit(e,{updateData:{"skill.journal":null}}),await this.render())}}class ExperienceDistributor extends FormApplication{constructor(e=[],t={}){super(e=e.map((e=>ExperienceDistributor.getActorData(e))).filter((e=>null!=e)),t),this.bonusXP=0}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["ffd20","xp-distributor"],title:game.i18n.localize("FFD20.Application.XPDistributor.Title"),template:"systems/ffd20/templates/apps/xp-distributor.hbs",width:430,height:794,resizable:!0,scrollY:[".selectors"]})}getData(){const e=super.getData();return e.actors={characters:this.getCharacters(),npcs:this.getNPCs()},e.labels={xp:{total:"+ "+this.getTotalExperience().toLocaleString(),split:"+ "+this.getSplitExperience().toLocaleString()}},e.bonusXP=this.bonusXP,e}getCharacters(){return this.object.filter((e=>"character"===e.actor.type))}getNPCs(){return this.object.filter((e=>"npc"===e.actor.type))}activateListeners(e){null!=jQuery&&e instanceof jQuery&&(e=e[0]);const addListener=(t,s,n)=>e.querySelectorAll(t).forEach((e=>e.addEventListener(s,n)));addListener(".character-selector .actor, .npc-selector .actor","click",this._onClickActor.bind(this)),addListener(".bonus-xp input","change",(e=>{e.preventDefault(),this.bonusXP=parseInt(e.currentTarget.value),isNaN(this.bonusXP)&&(this.bonusXP=0),this.render()})),e.addEventListener("drop",this._onDrop.bind(this)),addListener('button[name="split-evenly"], button[name="give-to-all"]',"click",this._onSubmit.bind(this)),addListener('button[name="cancel"]',"click",this._onCancel.bind(this))}async _onDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e);if("Actor"===t.type){const e=await Actor.implementation.fromDropData(t);"character"===e.type&&null!=this.object.find((t=>t.actor===e))||(this.object.push(mergeObject(this.constructor.getActorData(e),{toggled:!0})),this.render(!0))}}_onClickActor(e){e.preventDefault();const t=e.currentTarget,s=e.currentTarget.dataset.id,n=this.object.find((e=>e.id===s));n&&(n.toggled?(n.toggled=!1,t.classList.remove("toggled")):(n.toggled=!0,t.classList.add("toggled")),this.render())}async _onSubmit(e){e.preventDefault();const t="split-evenly"===e.currentTarget.name?this.getSplitExperience():this.getTotalExperience();if(t>0){const e=this.getCharacters().filter((e=>e.toggled));for(const s of e){const e={value:t};Hooks.callAll("pf1GainXp",s.actor,e),s.value=e.value}const s=e.map((e=>0!==e.value&&Number.isFinite(e.value)?{_id:e.actor.id,"system.details.xp.value":e.actor.system.details.xp.value+Math.floor(e.value)}:null)).filter((e=>null!=e));Actor.implementation.updateDocuments(s)}this.close()}_onCancel(e){e.preventDefault(),this.close()}getTotalExperience(){return this.getNPCs().filter((e=>e.toggled)).reduce(((e,t)=>e+t.xp),this.bonusXP)}getSplitExperience(){const e=this.getCharacters().filter((e=>e.toggled)),t=this.getTotalExperience();return e.length>0?Math.floor(t/e.length):0}static getActorData(e){if(!(e instanceof Actor))return null;const t="npc"===e.type?e.system.details.xp.value??0:0;return{id:randomID(16),actor:e,toggled:this.shouldActorBeToggled(e),xp:t,xpString:t.toLocaleString()}}static shouldActorBeToggled(e){const t="character"===e.type,s=e.system.attributes.hp.value<0;return!(!t&&!s)}}class ItemDirectoryPF extends ItemDirectory{static get defaultOptions(){const e=super.defaultOptions;return e.renderUpdateKeys.push("system.unidentified.name","system.identified"),e}async _render(e=!1,t={}){const{action:s,data:n,documentType:l}=t;return s&&!["create","update","delete"].includes(s)?this:"Folder"===l||"update"!==s||n.some((e=>this.options.renderUpdateKeys.some((t=>void 0!==getProperty(e,t)))))?(this.initialize(),SidebarTab.prototype._render.call(this,e,t)):void 0}}class Troubleshooter extends Application{get title(){return game.i18n.localize("FFD20.Troubleshooter.Title")}get template(){return"systems/ffd20/templates/apps/troubleshooter.hbs"}static get defaultOptions(){const e=super.defaultOptions;return{...e,classes:[...e.classes,"ffd20","troubleshooter"],id:"ffd20-troubleshooter",width:460}}getData(){return{isGM:game.user.isGM,links:{help:`<a data-action='help'>${game.i18n.localize("FFD20.Troubleshooter.Steps.HelpLink")}</a>`,report:`<a href="https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/issues">${game.i18n.localize("FFD20.Troubleshooter.Steps.ReportLinkText")}</a>`,foundry:{discord:'<a href="https://discord.gg/foundryvtt">Foundry VTT</a>',channel:"#pf1"},faq:"https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/wikis/FAQs",helpmodule:'<a href="https://foundryvtt.com/packages/find-the-culprit">Find the Culprit</a>'}}}async _runMigration(e){if(!game.user.isGM)return;const t=e.target;t.classList.remove("finished"),t.disabled=!0;const s=t.dataset.target;switch(s){case"world":await ffd20.migrations.migrateWorld();break;case"modules":await ffd20.migrations.migrateModules({unlock:!1});break;default:throw Error(`Unrecognized migration target: "${s}"`)}t.disabled=!1,t.classList.add("finished")}_openHelp(e){ffd20.applications.helpBrowser.openUrl("Help/Home")}activateListeners(e){super.activateListeners(e);const[t]=e,s=t.querySelectorAll("button[data-action='migrate']");for(const e of s)e.addEventListener("click",this._runMigration.bind(this));if(ffd20.migrations.isMigrating){for(const e of s)e.disabled=!0;Hooks.once("pf1MigrationFinished",(()=>{for(const e of s)e.disabled=!1}))}t.querySelector("a[data-action='help']").addEventListener("click",this._openHelp.bind(this))}static open(){(new Troubleshooter).render(!0,{focus:!0})}}const oa=Object.freeze(Object.defineProperty({__proto__:null,ActionChooser,ActorTraitSelector,AttackDialog,ChangeLogWindow,CurrencyTransfer,DamageTypeSelector,EntrySelector,ExperienceDistributor,HelpBrowserPF,ItemDirectoryPF,LevelUpForm,LinkOptions,PointBuyCalculator,ScriptEditor,SensesSelector,SkillEditor,TooltipPF,Troubleshooter,VisionPermissionSheet,Widget_CategorizedItemPicker,Widget_ItemPicker,actor:ce,compendiumBrowser:ve,compendiums:{},component:de,helpBrowser:na,item:ue,settings:me},Symbol.toStringTag,{value:"Module"}));class ActiveEffectPF extends ActiveEffect{async create(e,t={}){const s=this.flags?.core?.statusId,n=this.origin,l={};if(s&&!1===this.parent?.system.attributes.conditions[s]){l["system.attributes.conditions."+s]=!0,await this.parent.update(l);const e=this.parent.effects.find((e=>e.getFlag("core","statusId")===s));if(e)return e}if(n){const e=this.parent.items.get(n.split(".")[3]);e&&!e.system.active&&await e.setActive(!0)}return super.create(e,t)}async delete(e={}){const t=this.getFlag("core","statusId"),s=this.origin?.match(/Item\.(?<itemId>\w+)/),n=s?.groups.itemId,l=this.parent,c=t||n?{render:!1}:{},u=await super.delete(mergeObject(c,e));if(t&&l.system.attributes.conditions[t]){const s={["system.attributes.conditions."+t]:!1};await l.update(s,e)}else if(n){const t=l.items.get(n);e.ffd20?.delete!==t.uuid&&t?.setActive(!1,e)}return u}get isTemporary(){return(this.duration.seconds??(this.duration.rounds||this.duration.turns)??0)>0||this.statuses?.size||this.getFlag("core","statusId")||this.getFlag("ffd20","show")||!1}}const duplicateCombatantInitiativeDialog=function(e,t){const s=e.find((e=>void 0!==e.combatants.get(t)));if(!s)return void ui.notifications.warn(game.i18n.localize("FFD20.WarningNoCombatantFound"));const n=s.combatants.filter((e=>e.id===t))[0];n?new Dialog({title:`${game.i18n.localize("FFD20.DuplicateInitiative")}: ${n.name}`,content:`<div class="flexrow form-group">\n      <label>${game.i18n.localize("FFD20.InitiativeOffset")}</label>\n      <input type="number" name="initiativeOffset" value="0"/>\n    </div>`,buttons:{confirm:{label:game.i18n.localize("FFD20.Confirm"),callback:e=>{const t=parseFloat(e.find('input[name="initiativeOffset"]').val()),l=null!=n.initiative?n.initiative:0;duplicateCombatantInitiative(s,n,l+t)}},cancel:{label:game.i18n.localize("Cancel")}},default:"confirm"},{classes:[...Dialog.defaultOptions.classes,"ffd20","duplicate-initiative"]}).render(!0):ui.notifications.warn(game.i18n.localize("FFD20.WarningNoCombatantFound"))},duplicateCombatantInitiative=function(e,t,s){console.debug("Duplicating combatant:",t),e.createEmbeddedDocuments("Combatant",[mergeObject(t.toObject(),{initiative:s},{inplace:!1})])};Hooks.on("getCombatTrackerEntryContext",(function addCombatTrackerContextOptions(e,t){t.push({name:"FFD20.DuplicateInitiative",icon:'<i class="fas fa-dice-d20"></i>',callback:e=>(game.combat,duplicateCombatantInitiativeDialog(game.combats,e.data("combatant-id")))})}));class CombatPF extends Combat{async rollInitiative(e,{formula:t=null,bonus:s=null,rollMode:n,updateTurn:l=!0,messageOptions:c={},skipDialog:u=null}={}){u??=getSkipActionPrompt(),e="string"==typeof e?[e]:e;const d=this.combatant?.id,m=this.combatants.get(e[0]),h=(e.length>1?m?.actor?.name:m?.token?.name)??m?.name;if(!u){const e=await Combat.implementation.showInitiativeDialog({formula:t,bonus:s,rollMode:n,name:h});if(n=e.rollMode,s=e.bonus||"",t=e.d20,e.stop)return this}const[g,y]=await e.reduce((async(e,l,u)=>{const d=await e,[m,h]=d,g=this.combatants.get(l);if(!g?.isOwner)return e;const y=g.getInitiativeRoll(t,s);await y.evaluate({async:!0}),m.push({_id:l,initiative:y.total});(g.token?.hidden||g.hidden)&&(n=c.rollMode??"gmroll"),y.err&&ui.notifications.warn(y.err.message);const[b,F]=g.actor?.getInitiativeContextNotes?.()??[],k=b?.length>0,v={user:game.user.id,formula:y.formula,tooltip:await y.getTooltip(),total:y.total,hasExtraText:k,extraText:k?F:void 0};n&&(c.rollMode=n);const D=mergeObject({user:game.user.id,type:CONST.CHAT_MESSAGE_TYPES.ROLL,sound:CONFIG.sounds.dice,speaker:{scene:g.sceneId,actor:g.actorId,token:g.tokenId,alias:g.name},flags:{ffd20:{subject:{core:"init"}}},flavor:game.i18n.format("FFD20.RollsForInitiative",{name:g.name}),rolls:[y.toJSON()],content:await renderTemplate("systems/ffd20/templates/chat/roll-ext.hbs",v)},c);return ChatMessage.applyRollMode(D,n),u>0&&(D.sound=null),h.push(D),e}),[[],[]]);if(!g.length)return this;await this.updateEmbeddedDocuments("Combatant",g),l&&d&&await this.update({turn:this.turns.findIndex((e=>e.id===d))});return{combat:this,messages:await ChatMessage.implementation.create(y)}}static async showInitiativeDialog({formula:e=null,bonus:t=null,name:s}={}){const n={d20:e,bonus:t,rollMode:game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes};return Dialog.wait({title:game.i18n.format("FFD20.InitiativeCheck",{name:s}),content:await renderTemplate("systems/ffd20/templates/chat/roll-dialog.hbs",n),buttons:{normal:{label:game.i18n.localize("FFD20.Roll"),callback:e=>new FormDataExtended(e.querySelector("form")).object}},default:"normal",close:e=>({stop:!0})},{subject:{core:"init"},classes:[...Dialog.defaultOptions.classes,"ffd20","roll-initiative"],jQuery:!1},{focus:!0})}async _expireEffectsOnUpdate(e,t,s){if(void 0===e.turn&&void 0===e.round)return;const n=this.combatant?.actor;if(!n)return;const l=t.advanceTime??0,c=Object.entries(n.ownership).filter((([e,t])=>t>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)).map((([e,t])=>game.users.get(e))).filter((e=>e?.active)).sort(((e,t)=>e.id.localeCompare(t.id)))[0];if(c){if(c.id!==game.user.id)return}else if(!game.user.isGM)return;n.expireActiveEffects({timeOffset:l,combat:this})}_onUpdate(e,t,s){super._onUpdate(e,t,s);try{this._expireEffectsOnUpdate(e,t,s)}catch(e){console.error(e)}}}class CombatantPF extends Combatant{updateResource(){return this.actor&&this.combat?this.resource=foundry.utils.getProperty(this.actor.system,this.parent.settings.resource)??null:this.resource=null}getInitiativeRoll(e,t=0){e||=this._getInitiativeFormula();const s=this.actor?.getRollData()||{};return t&&(s.bonus=t,e+=" + @bonus"),RollPF.create(e,s)}_getInitiativeFormula(e){e||="1d20";const t=[e,`@attributes.init.total[${game.i18n.localize("FFD20.Initiative")}]`],s=this.actor;s&&game.settings.get("ffd20","initiativeTiebreaker")&&t.push(`(@attributes.init.total / 100)[${game.i18n.localize("FFD20.Tiebreaker")}]`);const n=CONFIG.Combat.initiative.formula?CONFIG.Combat.initiative.formula.split(/\s*\+\s*/):t;return s?n.filter((e=>null!==e)).join(" + "):n[0]||"0"}}const getLeftRight=e=>[e+"Left",e+"Right"].map((e=>({key:e}))),ra=getLeftRight("Shift"),la=getLeftRight("Control"),registerSystemControls=()=>{game.keybindings.register("ffd20","skipConfirmPrompt",{name:"FFD20.KEYBINDINGS.SkipConfirmPrompt.Name",uneditable:ra,onDown:()=>{ffd20.skipConfirmPrompt=!0},onUp:()=>{ffd20.skipConfirmPrompt=!1}}),game.keybindings.register("ffd20","forceShowItem",{name:"FFD20.KEYBINDINGS.ForceShowItem.Name",hint:game.i18n.localize("FFD20.KEYBINDINGS.ForceShowItem.Hint"),uneditable:la,onDown:()=>{ffd20.forceShowItem=!0},onUp:()=>{ffd20.forceShowItem=!1}}),game.keybindings.register("ffd20","hideTokenTooltip",{name:"FFD20.KEYBINDINGS.HideTokenTooltip.Name",hint:game.i18n.localize("FFD20.KEYBINDINGS.HideTokenTooltip.Hint"),uneditable:la,onDown:()=>ffd20.documents.controls._hideTokenTooltip(!0),onUp:()=>ffd20.documents.controls._hideTokenTooltip(!1)}),game.keybindings.register("ffd20","hideTokenTooltipGMInfo",{name:"FFD20.KEYBINDINGS.HideTokenTooltipGMInfo.Name",uneditable:ra,restricted:!0,onDown:()=>ffd20.documents.controls._hideTokenTooltipGMInfo(!0),onUp:()=>ffd20.documents.controls._hideTokenTooltipGMInfo(!1)})},ca=Object.freeze(Object.defineProperty({__proto__:null,_hideTokenTooltip:e=>{if(ffd20.tooltip)return!0===game.settings.get("ffd20","tooltipConfig")?.hideWithoutKey?ffd20.tooltip.forceHide=!e:ffd20.tooltip.forceHide=e,ffd20.tooltip?.refresh()},_hideTokenTooltipGMInfo:e=>{if(ffd20.tooltip)return ffd20.tooltip.forceHideGMInfo=e,ffd20.tooltip?.refresh()},registerSystemControls},Symbol.toStringTag,{value:"Module"}));class TokenDocumentPF extends TokenDocument{async _preCreate(e,t,s){await super._preCreate(e,t,s),this._preCreateSetSize()}async _preUpdate(e,t,s){await super._preUpdate(e,t,s);const n=e.flags?.ffd20;if(n){const e=["staticSize","disableLowLight","customVisionRules"];for(const t of e)!1===n[t]&&(n["-="+t]=null,delete n[t])}}_preCreateSetSize(){if(!this.actor)return;if(this.getFlag("ffd20","staticSize"))return;const e=ffd20.config.tokenSizes[this.actor.system.traits?.size];e&&this.updateSource({width:e.w,height:e.h,texture:{scaleY:e.scale,scaleX:e.scale}})}getTrackedAttributes(e,t=[]){const s=super.getTrackedAttributes(e,t);return 0===t.length&&s.value.push(["attributes","hp","temp"],["attributes","hp","nonlethal"]),s}getBarAttribute(e,{alternative:t=null}={}){let s;try{s=super.getBarAttribute(e,{alternative:t})}catch(e){s=null}return s?.attribute.startsWith("resources.")&&(s.editable=!0),s}prepareBaseData(){this.detectionModes=[],this._syncSenses(),super.prepareBaseData()}_syncSenses(){if(!this.actor)return;if(this.getFlag("ffd20","customVisionRules"))return;if(!this.sight.enabled)return;const e=this._source.sight.range;this.detectionModes=[],this.sight.visionMode="basic";const t={id:DetectionMode.BASIC_MODE_ID,enabled:!0,range:e};this.detectionModes.push(t);const s=this.actor?.system?.traits?.senses??{},n=s.dv??0;n>0&&(this.sight.visionMode="darkvision",t.range=Math.max(e,ffd20.utils.convertDistance(n)[0])),this.sight.range=Math.max(e,t.range),(s.si||s.tr)&&this.detectionModes.push({id:"seeInvisibility",enabled:!0,range:t.range}),s.ts&&this.detectionModes.push({id:"feelTremor",enabled:!0,range:s.ts}),s.bse&&this.detectionModes.push({id:"blindSense",enabled:!0,range:s.bse}),s.bs&&this.detectionModes.push({id:"blindSight",enabled:!0,range:s.bs}),this.detectionModes.sort(this.constructor._sortDetectionModes);const l=CONFIG.Canvas.visionModes[this.sight.visionMode]?.vision?.defaults||{};for(const e of["attenuation","brightness","saturation","contrast"])e in l&&(this.sight[e]=l[e])}static _sortDetectionModes(e,t){if(e.id===DetectionMode.BASIC_MODE_ID)return-1;if(t.id===DetectionMode.BASIC_MODE_ID)return 1;const s=CONFIG.Canvas.detectionModes[e.id],n=CONFIG.Canvas.detectionModes[t.id];return(s?.constructor.PRIORITY??0)-(n?.constructor.PRIORITY??0)}}class BasicActorPF extends Actor{constructor(...e){foundry.utils.logCompatibilityWarning("Basic actor type will be obsolete with Foundry v11",{since:"PF1 v9",until:"PF1 v11"}),super(...e)}_resetInherentTotals(){}_setSourceDetails(){}prepareBaseData(){}prepareDerivedData(){}applyActiveEffects(){}}class ActorCharacterPF extends ActorPF{async _preCreate(e,t,s){await super._preCreate(e,t,s);const n={};void 0===e.prototypeToken?.actorLink&&(n.actorLink=!0),game.settings.get("ffd20","characterVision")&&void 0===e.prototypeToken?.sight?.enabled&&(n.sight={enabled:!0}),foundry.utils.isEmpty(n)||this.prototypeToken.updateSource(n)}prepareBaseData(){super.prepareBaseData();const e=this.system,t=this.getLevelExp(e.details.level.value);if(e.details.xp.max=t,!hasProperty(this,"system.details.level.value"))return;const s=this.getLevelExp(e.details.level.value-1||0),n=this.getLevelExp(e.details.level.value||1);e.details.xp.pct=(Math.max(s,Math.min(n,e.details.xp.value))-s)/(n-s)*100||0}_updateExp(e){const t=e.details?.xp;if(null==t?.value)return;const s=this.items.filter((e=>"class"===e.type)).filter((e=>"mythic"!==e.system.subType)).reduce(((e,t)=>e+t.system.level),0),n=this.system;let l=t.value,c=!1;if("string"==typeof l){const e=Number(n.details.xp.value);l.match(/^\+([0-9]+)$/)?l=e+parseInt(RegExp.$1):l.match(/^-([0-9]+)$/)?l=e-parseInt(RegExp.$1):""===l?c=!0:l=l.match(/^([0-9]+)$/)?parseInt(l):e,t.value=l}const u=this.getLevelExp(s);if(t.max=u,c){const e=s>0?this.getLevelExp(s-1):0;t.value=e}}getLevelExp(e){const t=game.settings.get("ffd20","experienceConfig"),s=t.track;if(["fast","medium","slow"].includes(s)){const t=ffd20.config.CHARACTER_EXP_LEVELS[s];return t[Math.min(e,t.length-1)]}let n=0;if(t.custom.formula.length>0)for(let s=0;s<e;s++){const e=this.getRollData();e.level=s+1;n+=RollPF.safeRoll(t.custom.formula,e).total}return Math.max(1,n)}}class ActorNPCPF extends ActorPF{prepareBaseData(){super.prepareBaseData(),this.system.details.cr.total=this.getCR(this.system),this.system.attributes.init.total=this.system.attributes.init.value}prepareSpecificDerivedData(){super.prepareSpecificDerivedData(),setProperty(this.system,"details.cr.total",this.getCR());let e=0;try{const t=this.system.details?.cr?.total||0;e=this.getCRExp(t)}catch(t){e=this.getCRExp(1)}setProperty(this.system,"details.xp.value",e)}hasArmorProficiency(e,t){return!game.settings.get("ffd20","npcProficiencies")||super.hasArmorProficiency(e,t)}_updateExp(){}getCR(){const e=this.system.details?.cr?.base??0;return this.items.filter((e=>"feat"===e.type&&"template"===e.subType&&e.isActive)).reduce(((e,t)=>{const s=t.system.crOffset;return s&&(e+=RollPF.safeRoll(s,t.getRollData()).total),e}),e)}getCRExp(e){return e<1?Math.max(400*e,0):ffd20.config.CR_EXP_LEVELS[e]}}const ua=Object.freeze(Object.defineProperty({__proto__:null,ActorCharacterPF,ActorNPCPF,ActorPF,BasicActorPF,changes:q,spellbook:K},Symbol.toStringTag,{value:"Module"})),da=Object.freeze(Object.defineProperty({__proto__:null,ActiveEffectPF,ChatMessagePF,CombatPF,CombatantPF,TokenDocumentPF,actor:ua,addChatMessageContextOptions:function(e,t){const canApply=e=>canvas.tokens.controlled.length&&e.find(".damage-roll .dice-total").length,canApplyCritical=e=>canvas.tokens.controlled.length&&e.find(".crit-damage-roll .dice-total").length;return t.push({name:game.i18n.localize("FFD20.ApplyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:canApply,callback:e=>ActorPF.applyDamage(e,1)},{name:game.i18n.localize("FFD20.ApplyHealing"),icon:'<i class="fas fa-user-plus"></i>',condition:canApply,callback:e=>ActorPF.applyDamage(e,-1)},{name:game.i18n.localize("FFD20.ApplyCriticalDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:canApplyCritical,callback:e=>ActorPF.applyDamage(e,1,!0)},{name:game.i18n.localize("FFD20.ApplyCriticalHealing"),icon:'<i class="fas fa-user-minus"></i>',condition:canApplyCritical,callback:e=>ActorPF.applyDamage(e,-1,!0)}),t},controls:ca,customRolls,duplicateCombatantInitiative,item:W,macros:Q,settings:U},Symbol.toStringTag,{value:"Module"})),ma=Object.freeze(Object.defineProperty({__proto__:null,ActionUse,ChatAttack,ERR_REQUIREMENT:H},Symbol.toStringTag,{value:"Module"})),withinAngle=(e,t,s)=>(e=Math.normalizeDegrees(e),t=Math.normalizeDegrees(t),s=Math.normalizeDegrees(s),e<t?s>=e&&s<=t:s>=e||s<=t),withinRect=(e,t)=>e.x>=t.x&&e.x<t.x+t.width&&e.y>=t.y&&e.y<t.y+t.height;class TemplateLayerPF extends TemplateLayer{async _onDragLeftStart(e){if(!game.settings.get("ffd20","measureStyle"))return super._onDragLeftStart(e);const t=game.release.generation>=11?e.interactionData:e.data;await PlaceablesLayer.prototype._onDragLeftStart.call(this,e);const{origin:s}=t;if(!e.shiftKey){const e=canvas.grid.getSnappedPosition(s.x,s.y,this.gridPrecision);s.x=e.x,s.y=e.y}const n=game.activeTool,l={user:game.user.id,t:n,x:s.x,y:s.y,distance:1,direction:0,fillColor:game.user.color||"#FF0000",hidden:e.altKey},c=CONFIG.MeasuredTemplate.defaults;"cone"===n?l.angle=c.angle:"ray"===n&&(l.width=c.width*canvas.dimensions.distance);const u=new(getDocumentClass("MeasuredTemplate"))(l,{parent:canvas.scene}),d=new CONFIG.MeasuredTemplate.objectClass(u);return t.preview=this.preview.addChild(d),d.draw()}_onDragLeftMove(e){if(!game.settings.get("ffd20","measureStyle"))return super._onDragLeftMove(e);const t=game.release.generation>=11,s=t?e.interactionData:e.data,{destination:n,preview:l,origin:c}=s;if(0===(t?s.layerDragState:s.createState))return;const u=!e.shiftKey;u&&(s.destination=canvas.grid.getSnappedPosition(n.x,n.y,this.gridPrecision));const d=new Ray(c,n),m=canvas.dimensions.distance,h=canvas.dimensions.size/m,g=l.document.t,y=canvas.dimensions.distance,b=Math.normalizeDegrees(Math.toDegrees(d.angle));if(u&&["cone","circle"].includes(g)){const e=CONFIG.MeasuredTemplate.defaults.angle/2;l.document.direction=Math.floor((b+e/2)/e)*e}else l.document.direction=u&&"ray"===g?Math.floor((b+y/2)/y)*y:b;const F=d.distance/h;l.document.distance=u&&["cone","circle","ray"].includes(g)?Math.floor(F/m)*m:F,t?l.renderFlags.set({refreshShape:!0}):l.refresh(),t?s.layerDragState=2:s.createState=2}}class MeasuredTemplatePF extends MeasuredTemplate{getHighlightedSquares(){if(!this.id||!this.shape)return[];const e=this.document.t;if(!game.settings.get("ffd20","measureStyle")||!["circle","cone","ray"].includes(e))return[];const t=canvas.grid,s=canvas.dimensions.size,n=s+s%2,l=canvas.dimensions.distance,c=this.document.direction,u=this.document.angle;if("ray"===e){const e=[],line=(t,s,l,c)=>{t=Math.floor(Math.floor(t)/n),l=Math.floor(Math.floor(l)/n),s=Math.floor(Math.floor(s)/n),c=Math.floor(Math.floor(c)/n);const u=Math.abs(l-t),d=Math.abs(c-s),m=t<l?1:-1,h=s<c?1:-1;let g=u-d;for(;t!==l||s!==c;){e.push({x:t*n,y:s*n});const l=g<<1;l>-d&&(g-=d,t+=m),l<u&&(g+=u,s+=h)}},t=Ray.fromAngle(this.ray.A.x,this.ray.A.y,this.ray.angle,this.ray.distance+n/2);return line(t.A.x,t.A.y,t.B.x,t.B.y),e}const d=Math.ceil(1.5*this.document.distance/l/(n/t.h)),m=Math.ceil(1.5*this.document.distance/l/(n/t.w)),{x:h,y:g}=this.document,[y,b]=t.getCenter(h,g),[F,k]=t.grid.getGridPositionFromPixels(y,b),v=Math.normalizeDegrees(c-u/2),D=Math.normalizeDegrees(c+u/2),C={x:0,y:0};if("cone"===e){const e=(c>=0?360-c:-c)%360;C.x=h%s!=0?Math.sign(Math.round(Math.cos(degtorad(e))))/2:0,C.y=g%s!=0?-Math.sign(Math.round(Math.sin(degtorad(e))))/2:0}const S=[];for(let t=-m;t<m;t++)for(let l=-d;l<d;l++){const[c,u]=canvas.grid.grid.getPixelsFromGridPosition(F+t,k+l),[d,m]=[c+.5*n,u+.5*n],y={x:h+C.x*s,y:g+C.y*s},b={x:d,y:m};if("cone"===e){const e=new Ray(y,b),t=Math.normalizeDegrees(e.angle/(Math.PI/180));if(e.distance>0&&!withinAngle(v,D,t))continue}measureDistance(b,y)<=this.document.distance&&S.push({x:c,y:u})}return S}getTokensWithin(){const e=this.document.t,t=this.scene.dimensions,s=t.size,n=t.distance,l=Math.max(this.height,this.width),c=new Set(canvas.tokens.placeables.filter((e=>new Ray(e.center,this.center).distance+e.sizeErrorMargin<=l))),u=new Set;if(canvas.grid.type===CONST.GRID_TYPES.GRIDLESS&&["circle","cone","rect"].includes(e))for(const t of c)switch(e){case"circle":new Ray(this.center,t.center).distance/s*n<=this.document.distance&&u.add(t);break;case"cone":{const e=this.document.direction,l=this.document.angle,c=Math.normalizeDegrees(e-l/2),d=Math.normalizeDegrees(e+l/2),m=new Ray(this.center,t.center),h=Math.normalizeDegrees(Math.toDegrees(m.angle)),g=withinAngle(c,d,h),y=m.distance/s*n;g&&y<=this.document.distance&&u.add(t);break}case"rect":{const e={x:this.x,y:this.y,width:this.width,height:this.width};withinRect(t.center,e)&&u.add(t);break}}else{const e=this.getHighlightLayer().positions.map((e=>{const[t,n]=e.split(".");return{x:Number(t),y:Number(n),width:s,height:s}}));for(const t of e)for(const e of c)withinRect(e.center,t)&&(u.add(e),c.delete(e))}return Array.from(u)}highlightGrid(){if(!game.settings.get("ffd20","measureStyle")||!["circle","cone","ray"].includes(this.document.t)||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return super.highlightGrid();const e=canvas.grid,t=this.borderColor,s=this.fillColor;if(!this.id||!this.shape)return;const n=this.getHighlightLayer();if(n.clear(),!this.isVisible)return;const l=this.getHighlightedSquares();for(const c of l)e.grid.highlightGridPosition(n,{x:c.x,y:c.y,color:s,border:t})}getHighlightLayer(){return canvas.grid.getHighlightLayer(this.highlightId)}}const ha={fill:z("#ff0000"),border:z("#ff0000").darken(.1)},pa={fill:z("#ffff00"),border:z("#ffff00").darken(.1)};class SquareHighlight{constructor(e,t=65280,s=0){this.origin=e,this.borderColor=s,this.fillColor=t,this._squares=[],this._id=randomID(),canvas.grid.addHighlightLayer("AttackHighlight."+this._id)}addSquare(e,t){this._squares.push({x:e,y:t})}clear(e=!1){const t=canvas.grid.getHighlightLayer("AttackHighlight."+this._id);t&&(t.clear(),e&&canvas.grid.destroyHighlightLayer("AttackHighlight."+this._id))}render(){const e=canvas.grid,t=e.size,s=canvas.grid.getHighlightLayer("AttackHighlight."+this._id);this.clear();for(const n of this._squares){const l=Math.floor(this.origin.x-n.x)*t,c=Math.floor(this.origin.y-n.y)*t;e.grid.highlightGridPosition(s,{x:l,y:c,border:this.borderColor,color:this.fillColor})}}}let fa;const showAttackReach=function(e,t,s){clearHighlight();const n=function(e,t,s){const n=canvas.grid.size,l=e.document.width,c=e.document.height,u={x:Math.floor((e.x+l*n-.5*n)/n),y:Math.floor((e.y+c*n-.5*n)/n)};if(!s)return;const d=s.getRollData(),m=s.data.range.units;if(!["melee","touch","reach","ft","close","medium"].includes(m))return;const h="reach"===m,g=d.range,y=s.data.range.minUnits;let b=null;["melee","touch"].includes(y)&&(b=g.melee),"reach"===y&&(b=g.reach),"ft"===y&&(b=RollPF.safeRoll(s.data.range.minValue||"0",d).total);const F={normal:[],reach:[],extra:[]},k=!0!==game.settings.get("ffd20","alternativeReachCornerRule");if(["melee","touch","reach"].includes(m))F.normal=getReachSquares(e,g.melee,b,null,{useReachRule:k}),F.reach=getReachSquares(e,g.reach,g.melee,null,{useReachRule:k});else if("ft"===m){const t=calculateRangeFormula(s.data.range.value||"0","ft",d);F.normal=getReachSquares(e,t,b,null,{useReachRule:!0});const n=Math.min(60,Math.max(canvas.dimensions.width/canvas.dimensions.size*canvas.dimensions.distance,canvas.dimensions.height/canvas.dimensions.size*canvas.dimensions.distance)+convertDistance(t)[0]),l=s.data.range.maxIncrements;for(let s=1;s<l;s++)(s+1)*convertDistance(t)[0]<=n&&F.extra.push(getReachSquares(e,(s+1)*t,s*t,null,{useReachRule:k}))}else if(["close","medium"].includes(m)&&"spell"===t.type){const t=calculateRangeFormula(null,m,d);F.normal=getReachSquares(e,t,b,null,{useReachRule:k})}const v={normal:new SquareHighlight(u,colorToInt(ha.fill),colorToInt(ha.border)),reach:new SquareHighlight(u,colorToInt(pa.fill),colorToInt(pa.border)),extra:[]};for(const e of F.normal)v.normal.addSquare(e[0],e[1]);if(h)for(const e of F.reach)v.reach.addSquare(e[0],e[1]);for(let e=0;e<F.extra.length;e++){const t=F.extra[e],s={fill:e%2==1?ha.fill:pa.fill,border:e%2==1?ha.border:pa.border},n=new SquareHighlight(u,colorToInt(s.fill),colorToInt(s.border));for(const e of t)n.addSquare(e[0],e[1]);v.extra.push(n)}return v}(e,t,s);n&&(fa=n,renderHighlight())},clearHighlight=function(){if(fa){fa.normal.clear(),fa.reach.clear();for(const e of fa.extra)e.clear();fa=void 0}},renderHighlight=function(){if(fa){fa.normal.render(),fa.reach.render();for(const e of fa.extra)e.render()}};function addReachListeners(e){e.on("mouseenter",".card-range",onMouseEnterReach),e.on("mouseleave",".card-range",onMouseLeaveReach)}const onMouseEnterReach=e=>{e.preventDefault();const t=e.currentTarget.closest(".chat-card"),{tokenUuid:s,actionId:n,itemId:l}=t.dataset;l&&n&&s&&async function(e){if(!e)return;const t=await fromUuid(e);return t instanceof TokenDocument?t.object:t?.token??(null!=t?canvas.tokens.placeables.find((e=>e.actor===t)):null)}(s).then((e=>{if(!e)return;const t=e.actor.allItems.find((e=>e.id===l));t&&(game.settings.get("ffd20","hideReachMeasurements")||showAttackReach(e,t,t.actions.get(n)))}))},onMouseLeaveReach=e=>{e.preventDefault(),clearHighlight()},getReachSquares=function(e,t,s=0,n=null,l){t=convertDistance(t)[0],"number"==typeof s&&(s=convertDistance(s)[0]);const c=[];if(canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return c;n||(n=shouldAddReachSquare);const u=canvas.scene.grid.distance,d=canvas.grid.size,m=[];for(let t=0;t<Math.floor(e.w/d);t++)for(let s=0;s<Math.floor(e.h/d);s++){const n=Math.floor((e.x+.5*d)/d+t),l=Math.floor((e.y+.5*d)/d+s);m.push([n,l])}const h=[Math.floor((e.x+.5*d)/d),Math.floor((e.y+.5*d)/d),Math.floor(e.w/d),Math.floor(e.h/d)],getClosestTokenSquare=function(e){const t={square:null,dist:null};for(const s of m){const n=Math.sqrt((s[0]-e[0])**2+(s[1]-e[1])**2);(null==t.dist||n<t.dist)&&(t.square=s,t.dist=n)}return t.square},g=Math.round(t/u),y=2*g+h[2],b=2*g+h[3],F=[h[0]-g,h[1]-g];for(let u=F[0];u<F[0]+y;u++)for(let d=F[1];d<F[1]+b;d++){const m=getClosestTokenSquare([u,d]),g=[u-h[0],d-h[1]];u>=h[0]&&u<h[0]+h[2]&&d>=h[1]&&d<h[1]+h[2]&&null!=s||n(e,[u,d],m,t,s,h,l)&&c.push(g)}return c},shouldAddReachSquare=function(e,t,s,n,l,c,u={useReachRule:!1}){canvas.scene.grid.distance;const d=canvas.grid.size,m={x:s[0]*d,y:s[1]*d},h={x:t[0]*d,y:t[1]*d},g=measureDistance(m,h),y=u.useReachRule?measureDistance(m,h,{diagonalRule:"555"}):null,b=convertDistance(10)[0];return!(g>n&&(!u.useReachRule||n!==b))&&(!(null!=l&&g<=l)&&!(u.useReachRule&&l>=b&&y<=b))},ga=Object.freeze(Object.defineProperty({__proto__:null,SquareHighlight,addReachListeners,clearHighlight,showAttackReach},Symbol.toStringTag,{value:"Module"}));class TokenPF extends Token{async toggleEffect(e,{active:t,overlay:s=!1,midUpdate:n}={}){let l;if("string"==typeof e){const n=this.actor.items.get(e);l=n?await n.setActive(!n.isActive):await super.toggleEffect(e,{active:t,overlay:s})}else if(e&&!n&&Object.keys(ffd20.config.conditions).includes(e.id)){const t={};t["system.attributes.conditions."+e.id]=!this.actor.system.attributes.conditions[e.id],l=await this.actor.update(t)}else e&&(l=await super.toggleEffect(e,{active:t,overlay:s}));return this.hasActiveHUD&&canvas.tokens.hud.refreshStatusIcons(),l}get actorVision(){const e=this.actor.system.traits?.senses?.ll??{};return{lowLight:e.enabled,lowLightMultiplier:e.multiplier?.dim,lowLightMultiplierBright:e.multiplier?.bright}}get disableLowLight(){return!0===this.document.getFlag("ffd20","disableLowLight")}get observer(){return game.user.isGM||function(e){if(!e.actor)return!1;if(e.actor.testUserPermission(game.user,"OWNER"))return!0;const t=e.actor.getFlag("ffd20","visionPermission");return!(!t||!t.users[game.user.id])&&("yes"===t.users[game.user.id].level||"default"===t.users[game.user.id].level&&"yes"===t.default)}(this)}_getBarBoost(e){return"attributes.hp"===e.attribute?{value:this.actor.system.attributes.hp.temp,color:12637924}:"attributes.vigor"===e.attribute?{value:this.actor.system.attributes.vigor.temp,color:12637924}:null}_getBarUnderline(e){return"attributes.hp"===e.attribute?{value:this.actor.system.attributes.hp.nonlethal,color:8202280}:null}_drawBar(e,t,s){const n=this._getBarBoost(s),l=this._getBarUnderline(s),c=s.max,u=Number(s.value);s.max=Math.max(s.max,(n?.value??0)+u);const d=Math.clamped(u,0,s.max)/s.max,m=Math.clamped(u,0,c)/c;let h=Math.max(canvas.dimensions.size/12,8);const g=this.w,y=Math.clamped(h/8,1,2);this.document.height>=2&&(h*=1.6);let b;if(b=0===e?PIXI.utils.rgb2hex([1-m/2,m,0]):PIXI.utils.rgb2hex([.5*m,.7*m,.5+m/2]),t.clear(),t.beginFill(0,.5).lineStyle(y,0,1).drawRoundedRect(0,0,this.w,h,3),n?.value>0){const e=Math.clamped(u+n.value,0,s.max)/s.max;t.beginFill(n.color,1).lineStyle(y,0,1).drawRoundedRect(0,0,e*g,h,2)}if(t.beginFill(b,1).lineStyle(y,0,1).drawRoundedRect(0,0,d*g,h,2),l?.value>0){const e=Math.clamped(l.value,0,s.max)/s.max;t.beginFill(l.color,1).lineStyle(y,0,1).drawRoundedRect(0,h/2,e*g,h/2,2)}const F=0===e?this.h-h:0;t.position.set(0,F)}get sizeErrorMargin(){return Math.max(this.w/2,this.h/2)}}class TokenQuickActions{static async addQuickActions(e,t){const s=e.object,n=s.actor,l=n?.getQuickActions?.();if(!l)return;const c=$('<div class="col actions">'),u=$('<div class="below">');l.forEach((({item:e})=>{const t=e.firstAction,n=e.img??CONST.DEFAULT_TOKEN;let l="";l=["attack","weapon"].includes(e.type)?game.i18n.format("FFD20.AttackWith",{name:e.name}):"spell"===e.type?game.i18n.format("FFD20.AttackWithSpell",{name:e.name}):"feat"===e.type?game.i18n.format("FFD20.AttackWithFeat",{name:e.name}):game.i18n.format("FFD20.QuickActionUseAny",{name:e.name});const c=e.type,d=[];d.push(`<div data-item-id="${e.id}" data-item-type="${c}" class="control-icon token-quick-action type-${c}">`,`<img src="${n}" width="36" height="36" data-tooltip="${l}">`),t&&(e.isCharged||t?.data.usesAmmo)&&d.push(this.createChargeElement(t)),d.push("</div>");const m=document.createElement("div");m.innerHTML=d.join("");const h=m.firstChild;this.activateElementListeners(h,e,t,s),u.append(h)})),c.append(u),t.find(".col.middle").after(c)}static createChargeElement(e){const t=e.item,s=e.data.usesAmmo??!1,n=e.getChargeCost(),l=t.isSingleUse,c=["<charges>"],u=e.isCharged,d=l?0:u?Math.floor(t.maxCharges/n):0,m=u&&n<0;let h=0;return s?h=t.defaultAmmo?.system.quantity??0:l?h=t.system.quantity:u&&(h=m?-n:Math.floor(t.charges/n)),m?c.push(`<span class='recharge'>+${h}</span>`):c.push(`<span class='remaining'>${h}</span >`),m||0===d||c.push(`<span class='delimiter' >/</span ><span class='max'>${d}</span>`),c.push("</charges>"),c.join("")}static activateElementListeners(e,t,s,n){e.addEventListener("click",(e=>{e.preventDefault(),e.ctrlKey?t.displayCard({token:n.document}):t.use({ev:e,token:n.document,skipDialog:getSkipActionPrompt()})})),e.addEventListener("contextmenu",(e=>{e.preventDefault(),t.sheet.render(!0,{focus:!0})})),game.settings.get("ffd20","hideReachMeasurements")||(e.addEventListener("mouseenter",(()=>showAttackReach(n,t,s)),{passive:!0}),e.addEventListener("mouseleave",(()=>clearHighlight()),{passive:!0}))}}class DetectionModeInvisibilityPF extends DetectionModeInvisibility{static ID="seeInvisibility";static LABEL="DETECTION.SeeInvisibility";static PRIORITY=1e5;_testPoint(e,t,s,n){if(!this._testLOS(e,t,s,n))return!1;if(this._testRange(e,t,s,n))return!0;for(const e of canvas.effects.lightSources.values())if(e.active&&!e.disabled&&e.los.contains(n.point.x,n.point.y))return!0;return!1}}class DetectionModeBlindSensePF extends DetectionMode{static ID="blindSense";static LABEL="FFD20.SenseBSense";static DETECTION_TYPE=DetectionMode.DETECTION_TYPES.OTHER;static PRIORITY=200100;constructor(e={},...t){e.walls=!0,super(e,...t)}static getDetectionFilter(){return this._detectionFilter??=OutlineOverlayFilter.create({outlineColor:[0,.33,.6,1],knockout:!1,wave:"blindSense"===this.ID})}_canDetect(e,t){return!0}}class DetectionModeBlindSightPF extends DetectionModeBlindSensePF{static ID="blindSight";static LABEL="FFD20.SenseBS";static DETECTION_TYPE=DetectionMode.DETECTION_TYPES.OTHER;static PRIORITY=2e5;static getDetectionFilter(){return this._detectionFilter??=OutlineOverlayFilter.create({outlineColor:[0,.33,.6,1],knockout:!1,wave:!1})}}class DetectionModeTremorPF extends DetectionModeTremor{static ID="feelTremor";static LABEL="DETECTION.FeelTremor";static DETECTION_TYPE=DetectionMode.DETECTION_TYPES.MOVE;static PRIORITY=201e3;constructor(e={},...t){e.walls=!1,super(e,...t)}}const ya=Object.freeze(Object.defineProperty({__proto__:null,DetectionModeBlindSensePF,DetectionModeBlindSightPF,DetectionModeInvisibilityPF,DetectionModeTremorPF},Symbol.toStringTag,{value:"Module"})),ba=CONFIG.Canvas.visionModes.darkvision.shader,Fa=new VisionMode({id:"darkvision",label:"VISION.ModeDarkvision",canvas:{shader:ba,uniforms:{contrast:0,saturation:-1,brightness:0}},lighting:{background:{visibility:VisionMode.LIGHTING_VISIBILITY.REQUIRED}},vision:{darkness:{adaptive:!1},defaults:{attenuation:0,contrast:0,saturation:-1,brightness:0}}}),ka=Object.freeze(Object.defineProperty({__proto__:null,darkvision:Fa},Symbol.toStringTag,{value:"Module"})),va=Object.freeze(Object.defineProperty({__proto__:null,AbilityTemplate:class AbilityTemplate extends MeasuredTemplatePF{static fromData(e){const t=e.type,s=e.distance;if(!t)return null;if(!s)return null;if(!canvas.scene)return null;if(!["cone","circle","rect","ray"].includes(t))return null;const n={t,user:game.user.id,distance:s||5,direction:0,x:0,y:0,fillColor:e.color?e.color:game.user.color,texture:e.texture?e.texture:null,_id:randomID(16)};switch(t){case"cone":!0===game.settings.get("ffd20","measureStyle")?n.angle=CONFIG.MeasuredTemplate.defaults.angle:n.angle=CONFIG.MeasuredTemplate.defaults.originalAngle;break;case"rect":n.distance=Math.sqrt(Math.pow(s,2)+Math.pow(s,2)),n.direction=45;break;case"ray":n.width=CONFIG.MeasuredTemplate.defaults.width}return new this(new(0,CONFIG.MeasuredTemplate.documentClass)(n,{parent:canvas.scene}))}async drawPreview(e){const t=canvas.activeLayer;return await this.draw(),this.active=!0,this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(t)}activatePreviewListeners(e){return new Promise((t=>{const s={};let n=0;const l=!0===game.settings.get("ffd20","measureStyle"),_clear=()=>{this.destroyed||this.destroy()};s.mm=e=>{e.stopPropagation();const t=Date.now();if(t-n<=20)return;const s=e.data.getLocalPosition(this.layer),l=canvas.grid.getSnappedPosition(s.x,s.y,2);this.document.x=l.x,this.document.y=l.y,this.refresh(),canvas.app.render(),n=t},s.rc=(n,l=!0)=>{this.layer.preview.removeChildren(),canvas.stage.off("mousemove",s.mm),canvas.stage.off("mousedown",s.lc),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,this.active=!1;canvas.grid.getHighlightLayer(this.highlightId).clear(),_clear(),e.activate(),l&&t({result:!1})},s.lc=async e=>{s.rc(e,!1);const n={result:!0,place:async()=>{const e=(await canvas.scene.createEmbeddedDocuments("MeasuredTemplate",[this.document.toObject(!1)]))[0];return this.document=e,e},delete:()=>this.document.delete()};_clear(),t(n)},s.mw=e=>{let t,s;e.ctrlKey&&e.preventDefault(),e.stopPropagation(),e.ctrlKey?(t="rect"===this.document.t?Math.sqrt(canvas.dimensions.distance*canvas.dimensions.distance):canvas.dimensions.distance,this.document.distance+=t*-Math.sign(e.deltaY)):(l&&"cone"===this.document.t?(t=90,s=e.shiftKey?t:45):(t=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,s=e.shiftKey?t:5),"rect"===this.document.t?(s=Math.sqrt(50),this.document.distance+=s*-Math.sign(e.deltaY)):this.document.direction+=s*Math.sign(e.deltaY)),this.refresh()},this.controlIcon&&this.controlIcon.removeAllListeners(),canvas.stage.on("mousemove",s.mm),canvas.stage.on("mousedown",s.lc),canvas.app.view.oncontextmenu=s.rc,canvas.app.view.onwheel=s.mw,this.hitArea=new PIXI.Polygon([])}))}refresh(){if(this.template&&canvas.scene)return super.refresh()}},MeasuredTemplatePF,TemplateLayerPF,TokenPF,TokenQuickActions,attackReach:ga,detectionModes:ya,lowLightVision:t,visionModes:ka},Symbol.toStringTag,{value:"Module"}));class SizeRollTerm extends RollTerm{constructor({terms:e=[],roll:t,options:s,modifiers:n=[]}){super({options:s}),e&&(e[0]instanceof RollTerm?this.terms=e:"string"==typeof e[0]?(this._terms=e,this.terms=e.reduce(((e,t)=>{const s=RollPF.parse(t);return s.length>1?e.push(ParentheticalTerm.fromTerms(s)):e.push(s[0]),e}),[])):this.terms=e.map((e=>RollTerm.fromData(e)))),this.modifiers=n,t&&(t instanceof Roll?this.roll=t:(t.modifiers=n,this.roll=Roll.fromData(t)))}_terms=[];terms=[];roll=void 0;isIntermediate=!1;static SERIALIZE_ATTRIBUTES=["terms","roll","modifiers"];static TRAILER_REGEXP=RegExp(`${DiceTerm.MODIFIERS_REGEXP_STRING}?${DiceTerm.FLAVOR_REGEXP_STRING}?$`);get total(){return this.roll.total}get dice(){return this.roll?.dice}get formula(){return this.simplify??super.formula}get expression(){return`sizeRoll(${this.terms.map((e=>e.formula)).join(", ")})${this.modifiers.join("")}`}get simplify(){return this.roll?.formula}get isDeterministic(){return!1}_prepareRoll(){const e=!this.roll,t=e?ffd20.utils.rollPreProcess.sizeRoll(...this.terms.map((e=>e.total))):null;t&&(this.flavor&&(t[0].options.flavor=this.flavor),this.modifiers.length&&(t[0].modifiers=this.modifiers));const s=e?RollPF.fromTerms(t):this.roll;return this.flavor&&(s.options.flavor=this.flavor),s}_evaluateSync({minimize:e=!1,maximize:t=!1}={}){const s={minimize:e,maximize:t,async:!1};for(const e of this.terms)e._evaluated||e.evaluate(s);const n=this._prepareRoll();return this.roll=n._evaluated?n:n.evaluate(s),this}async _evaluate({minimize:e=!1,maximize:t=!1}={}){const s={minimize:e,maximize:t,async:!0};for(const e of this.terms)e._evaluated||await e.evaluate(s);const n=this._prepareRoll();return this.roll=n._evaluated?n:await n.evaluate(s),this}toJSON(){return{...super.toJSON(),roll:this.roll?.toJSON()}}}const Da=Object.freeze(Object.defineProperty({__proto__:null,SizeRollTerm},Symbol.toStringTag,{value:"Module"})),Ca=Object.freeze(Object.defineProperty({__proto__:null,D20RollPF,DamageRoll,RollPF,d20Roll:async function d20Roll(e={}){const{skipDialog:t=getSkipActionPrompt(),staticRoll:s=null,chatTemplateData:n={},chatMessage:l=!0,compendium:c,noSound:u=!1,flavor:d="",parts:m=[],dice:h="1d20",rollData:g={},subject:y,rollMode:b,bonus:F="",speaker:k}=e,v=[h,...m].join("+"),D=new CONFIG.Dice.rolls.D20RollPF(v,g,{flavor:d,staticRoll:s,bonus:F});if(!t){const e=k?.alias?`${k.alias}: ${d}`:d;if(null===await D.promptDialog({title:e,rollMode:b,subject:y}))return}return D.toMessage({speaker:k},{create:l,noSound:u,chatTemplateData:n,compendium:c,subject:y,rollMode:b})},formulaHasDice,parseRollStringVariable,terms:Da},Symbol.toStringTag,{value:"Module"}));class ItemScriptCall{static AsyncFunction=Object.getPrototypeOf((async function(){})).constructor;constructor(e,t){this.data=mergeObject(this.constructor.defaultData,e),this.parent=t}static async create(e,t){const{parent:s}=t;if(s instanceof ffd20.documents.item.ItemPF){e=e.map((e=>mergeObject(this.defaultData,e)));const t=deepClone(s.system.scriptCalls||[]);return t.push(...e),await s.update({"system.scriptCalls":t}),e.map((e=>s.scriptCalls.get(e._id)))}return[]}static get defaultData(){return{_id:randomID(16),name:game.i18n.localize("FFD20.ScriptCalls.NewName"),img:"icons/svg/dice-target.svg",type:"script",value:"",category:"",hidden:!1}}get id(){return this.data._id}get type(){return this.data.type}get value(){return this.data.value}get category(){return this.data.category}get name(){return this.data.name}get hidden(){return this.data.hidden}async getScriptBody(){return"script"===this.type?this.value:(await fromUuid(this.value))?.data.command??""}async update(e,t={}){if(null!=this.parent){const s=this.parent.system.scriptCalls.find((e=>e._id===this.id)),n=this.parent.system.scriptCalls.indexOf(s);if(n>=0)return e=Object.entries(e).reduce(((e,t)=>(e[`system.scriptCalls.${n}.${t[0]}`]=t[1],e)),{}),this.parent.update(e,t)}}async edit(){if("macro"===this.type){const e=await fromUuid(this.value);let t;e?e.testUserPermission(game.user,"OBSERVER")?e.sheet.render(!0,{focus:!0}):t=game.i18n.format("DOCUMENT.SheetPermissionWarn",{document:e.documentName}):t=game.i18n.format("FFD20.ErrorNoMacroID",{id:this.value}),t&&(console.error(t),ui.notifications.error(t))}else{const e=new ScriptEditor({command:this.value,name:this.name,parent:this.parent,scriptCall:!0}).render(!0),t=await e.awaitResult();if(t)return this.update({value:t.command,name:t.name})}}async execute(e,t={}){const s=this.parent,n=s.actor,l=n?.token?.object??(n?canvas.tokens.placeables.find((e=>e.actor?.id===n.id)):null),c=`await (async () => {\n      ${await this.getScriptBody()}\n    })()`,u=this.constructor.AsyncFunction("item","actor","token","shared",...Object.keys(t),c);try{return await u.call(this,s,n,l,e,...Object.values(t))}catch(e){ui.notifications.error("There was an error in your script/macro syntax. See the console (F12) for details"),console.error(e)}}}const Sa=Object.freeze(Object.defineProperty({__proto__:null,ItemAction,ItemChange,ItemConditional:class ItemConditional{constructor(e,t){this.data=e,this.parent=t,this.prepareData()}static async create(e,t={}){const{parent:s}=t;if(s instanceof ffd20.components.ItemAction){e=e.map((e=>mergeObject(this.defaultData,e)));const t=deepClone(s.data.conditionals||[]);return t.push(...e),await s.update({conditionals:t}),e.map((e=>s.conditionals.get(e._id)))}return[]}static get defaultData(){return{_id:randomID(16),default:!1,name:"",modifiers:[]}}get id(){return this.data._id}get name(){return this.data.name}prepareData(){this.data.modifiers instanceof Array&&(this.modifiers=this._prepareModifiers(this.data.modifiers))}_prepareModifiers(e){const t=this.modifiers,s=new Collection;for(const n of e){let e=null;t&&t.has(n._id)?(e=t.get(n._id),e.data=n,e.prepareData()):e=new ffd20.components.ItemConditionalModifier(n,this),s.set(n._id||e.data._id,e)}return s}async update(e,t={}){const s=this.parent.data.conditionals.indexOf(this.data),n=deepClone(this.data),l=mergeObject(n,e);if(keepUpdateArray(this.data,l,"modifiers"),t.dryRun)return l;await this.parent.update({["conditionals."+s]:l})}async delete(){const e=foundry.utils.deepClone(this.parent.data.conditionals);return e.findSplice((e=>e._id===this.id)),this.parent.update({conditionals:e})}},ItemConditionalModifier:class ItemConditionalModifier{constructor(e,t){this.data=e,this.parent=t,this.prepareData()}static async create(e,t={}){const{parent:s}=t;if(s instanceof ffd20.components.ItemConditional){e=e.map((e=>mergeObject(this.defaultData,e)));const t=deepClone(s.data.modifiers||[]);return t.push(...e),await s.update({modifiers:t}),e.map((e=>s.modifiers.get(e._id)))}return[]}static get defaultData(){return{_id:randomID(16),formula:"",target:"",subTarget:"",type:"",damageType:ffd20.components.ItemAction.defaultDamageType,critical:""}}get id(){return this.data._id}prepareData(){}async update(e,t={}){const s=this.parent.data.modifiers.indexOf(this.data),n=deepClone(this.data),l=flattenObject(mergeObject(n,e));if(t.dryRun)return l;await this.parent.update({["modifiers."+s]:expandObject(l)})}async delete(){const e=this.parent.data.modifiers.indexOf(this.data);if(e<0)throw Error("Modifier not found in parent "+this.parent.name);const t=duplicate(this.parent.data.modifiers);return t.splice(e,1),this.parent.update({modifiers:t})}},ItemScriptCall},Symbol.toStringTag,{value:"Module"})),registerHandlebarsHelpers=function(){function actionDamage(e,t,s){if(!e.hasDamage)return null;const n=e.actor;e.item;const l=n?.system,c=e.data,u=s.hash.combine??!0,d=[],handleFormula=(e,s)=>{try{switch(typeof e){case"string":{const n=e.indexOf("@")>=0?s?.parent?.getRollData()??t:{},l=simplifyFormula(e,n,{combine:u});0!=l&&d.push(l);break}case"number":0!=e&&d.push(""+e)}}catch(t){console.error(`Formula parsing error with "${e}"`),d.push("NaN")}},handleParts=e=>e.forEach((({formula:e})=>handleFormula(e)));handleParts(c.damage.parts);const m=c.ability.damage,h=Math.floor((l?.abilities[m]?.mod??0)*(c.ability.damageMult||1));0!=h&&d.push(h),handleParts(c.damage.nonCritParts),e.allDamageSources.forEach((e=>{"script"!==e.operator&&handleFormula(e.formula,e)})),0===d.length&&d.push("NaN");const simplifyMath=e=>e.replace(/\s+/g,"").replace(/\+-/g,"-").replace(/--/g,"+").replace(/-\+/g,"-").replace(/\+\++/g,"+"),g=simplifyMath(d.join("+"));if("NaN"===g)return g;if(!u)return g;return simplifyMath(simplifyFormula(g,null,{combine:u}))}Handlebars.registerHelper("convertDistance",(e=>Number.isFinite(e)?convertDistance(e)[0]:e)),Handlebars.registerHelper("distanceUnit",(e=>convertDistance(0,e)[1])),Handlebars.registerHelper("itemRange",((e,t)=>{if(foundry.utils.logCompatibilityWarning("{{itemRange}} helper is deprecated, please use {{actionRange}} instead.",{since:"PF1 v9",until:"PF1 v10"}),!e.document?.firstAction?.hasRange)return null;const s=e.document.firstAction,n=s.data.range.value,l=s.data.range.units;if(null==l)return null;const c=calculateRange(n,l,t);if(c&&"string"!=typeof c){return`${c} ${convertDistance(n)[1]}`}return""+(c??"")})),Handlebars.registerHelper("actionRange",((e,t)=>{if(!e?.hasRange)return null;const s=e.data.range.value,n=e.data.range.units;if(null==n)return null;const l=calculateRange(s,n,t);if(l&&"string"!=typeof l){return`${l} ${convertDistance(s)[1]}`}return l||""})),Handlebars.registerHelper("actionDamage",actionDamage),Handlebars.registerHelper("damageTypes",(e=>{const t=[],{custom:s,values:n}=e;return s&&t.push(s),n.forEach((e=>t.push(game.i18n.localize(ffd20.registry.damageTypes.get(e)?.name??"FFD20.Undefined")))),t.join(", ")})),Handlebars.registerHelper("itemDamage",((e,t)=>{console.warn("{{itemDamage}} handlebars helper is deprecated, use {{actionDamage}} instead");const s=e.document?.firstAction;return actionDamage(s,t)})),Handlebars.registerHelper("itemAttacks",(e=>{foundry.utils.logCompatibilityWarning("{{itemAttacks}} helper is deprecated, please use {{actionAttacks}} instead.",{since:"PF1 v9",until:"PF1 v10"});const t=e.document.attackArray,s=Math.max(...t);return`${t.length} (${s<0?s:"+"+s}${t.length>1?"/…":""})`})),Handlebars.registerHelper("actionAttacks",(e=>{const t=e.item.getAttackArray(e.id),s=Math.max(...t);return`${t.length} (${s<0?s:"+"+s}${t.length>1?"/…":""})`})),Handlebars.registerHelper("optionalConditionals",(e=>e.firstAction?.data.conditionals.find((e=>!e.default)))),Handlebars.registerHelper("abilityMod",((e,t,s)=>Math.floor(t.abilities[e]?.mod*s))),Handlebars.registerHelper("hasContextNotes",((e,t)=>!!e.getContextNotes(t).find((e=>e.notes.length)))),Handlebars.registerHelper("contextNotes",((e,t,s)=>{const n=s.data.root.rollData,l=s.hash.roll??!1,c=e.getContextNotes(t);return e.formatContextNotes(c,n,{roll:l})})),Handlebars.registerHelper("enrich",((e,t)=>{const s=!!t.hash.owner,n=t.hash.rollData;return new Handlebars.SafeString(TextEditor.enrichHTML(e,{secrets:s,rollData:n,async:!1}))})),Handlebars.registerHelper("json-string",(e=>new Handlebars.SafeString(escape(JSON.stringify(e))))),Handlebars.registerHelper("halfNumber",(e=>(e="number"==typeof e?e:parseFloat(e),new Handlebars.SafeString(Math.floor(e/2).toString())))),Handlebars.registerHelper("arrayHas",(e=>{const t=e.hash.array,s=e.hash.value;return t.includes(s)}))},Ta=Object.freeze(Object.defineProperty({__proto__:null,preloadHandlebarsTemplates,registerHandlebarsHelpers,renderCachedTemplate},Symbol.toStringTag,{value:"Module"})),_a=Object.freeze(Object.defineProperty({__proto__:null,sizeReach:function(e="M",t=!1,s="tall"){return"number"==typeof e&&(e=Object.values(ffd20.config.sizeChart)[e]),e=Object.entries(ffd20.config.sizeChart).find((t=>t[1]===e))[0],[new NumericTerm({number:Actor.implementation.getReach(e,s)[t?"reach":"melee"]})]},sizeRoll:function(e,t,s="M",n="M"){const _getSizeIndex=function(e){return"string"==typeof e?Object.values(ffd20.config.sizeChart).indexOf(e.toUpperCase()):e};s=_getSizeIndex(s),n=_getSizeIndex(n);let l=!1;if(e>1&&10===t&&(e%2==0||3===e)){l=!0;const c=[{orig:[2,10],larger:[4,8],smaller:[2,8]},{orig:[3,10],larger:[6,8],smaller:[3,8]},{orig:[4,10],larger:[8,8],smaller:[4,8]},{orig:[6,10],larger:[12,8],smaller:[6,8]},{orig:[8,10],larger:[16,8],smaller:[8,8]}];for(const l of c)l.orig[0]===e&&l.orig[1]===t&&(s<n?(n--,e=l.smaller[0],t=l.smaller[1]):s>n&&(n++,e=l.larger[0],t=l.larger[1]))}const c=`${e}d${t}`,u=e*t;let d=duplicate(ffd20.config.sizeDie);-1===d.indexOf(c)&&(d=d.map((e=>{if(e.match(/^([0-9]+)d([0-9]+)$/)){if(parseInt(RegExp.$1)*parseInt(RegExp.$2)===u)return c}return e})));let m=d.indexOf(c),h=c;if(m>=0){const e=d.indexOf("1d6");let t=d.indexOf("1d8");-1===t&&(t=d.indexOf("2d4"));let l=n-s,c=n;for(;l>0;)c<=4||m<=t?(m--,l--,c--):(m-=2,l--,c--);for(;l<0;)c<=3||m<=e?(m++,l++,c++):(m+=2,l++,c++);m=Math.clamped(m,0,d.length-1),h=d[m]}-1!==m||l||ui.notifications.warn(game.i18n.localize("FFD20.WarningNoSizeDie",{baseline:c,fallback:h}));const g=h.split("d");return 1===g.length?[new NumericTerm({number:parseInt(g[0])})]:[new Die({number:parseInt(g[0]),faces:parseInt(g[1])})]}},Symbol.toStringTag,{value:"Module"})),wa=Object.freeze(Object.defineProperty({__proto__:null,SemanticVersion,binarySearch,canvas:l,chat:B,convertDistance,convertDistanceBack:function(e,t="ft"){return"metric"===getDistanceSystem()?"mi"===t?[Math.round(e/1.6*100)/100,"mi"]:[Math.round(5*e/1.5*100)/100,"ft"]:[e,t]},convertWeight:function(e){return"metric"===getWeightSystem()?e/2:e},convertWeightBack:function(e){return"metric"===getWeightSystem()?2*e:e},createTag,dialog:le,diffObjectAndArray,findInCompendia:function(e,t={packs:[],type:void 0}){let s,n,l,c;s=t?.packs&&t.packs.length?t.packs.flatMap((e=>game.packs.get(e)??[])):game.packs.filter((e=>!t?.type||e.metadata.type==t.type)),e=e.toLocaleLowerCase();for(const t of s)if(t.fuzzyIndex||(t.fuzzyIndex=sortArrayByName([...t.index])),n=binarySearch(t.fuzzyIndex,e,((e,t)=>e.localeCompare(t.name,void 0,{ignorePunctuation:!0}))),n>-1){l=t.index.get(t.fuzzyIndex[n]._id),c=t;break}if(l)return{pack:c,index:l};let u=uniquePermutations(e.split(/[ _-]/));u?u=u.map((e=>e.join(" "))):(u=[null],u.push(e.split(/[ _-]/).reverse().join(" ")),u.push(e.split(/[,;] ?/).reverse().flatMap((e=>e.split(" "))).join(" ")));for(const e of s){for(let t=1;t<u.length;t++)if(n=binarySearch(e.fuzzyIndex,u[t],((e,t)=>e.localeCompare(t.name,void 0,{ignorePunctuation:!0}))),n>-1){l=e.index.get(e.fuzzyIndex[n]._id),c=e;break}if(l)break}return!!l&&{pack:c,index:l}},getAbilityModifier,getActorFromId,getDistanceSystem,getFirstActiveGM:()=>(foundry.utils.logCompatibilityWarning("ffd20.utils.getFirstActiveGM() is deprecated in favor of game.users.activeGM",{since:"PF1 v9",until:"PF1 v10"}),game.users.activeGM),getItemOwner:function(e){return e.actor?e.actor:e.id?game.actors.find((t=>t.items.get(e.id))):null},getWeightSystem,handlebars:Ta,isMinimumCoreVersion:function(e){const t=SemanticVersion.fromString(game.version),s=SemanticVersion.fromString(e);return!t.isLowerThan(s)},links:J,measureDistance,refreshActors:function refreshActors(e={renderOnly:!1,renderForEveryone:!1}){game.actors.contents.forEach((t=>{e.renderOnly||t.reset(),null!=t.sheet&&t.sheet._state>0&&t.sheet.render()})),Object.values(game.actors.tokens).forEach((t=>{t&&(e.renderOnly||t.reset(),null!=t.sheet&&t.sheet._state>0&&t.sheet.render())})),e.renderForEveryone&&game.socket.emit("ffd20","refreshActorSheets")},refreshSheets:function refreshSheets({reset:e=!0,actor:t=!0,item:s=!0,action:n=!0}={}){Object.values(ui.windows).forEach((l=>{(t&&l instanceof ActorSheet||s&&l instanceof ItemSheet||n&&l instanceof ffd20.applications.component.ItemActionSheet)&&(e&&l.object instanceof Document?l.object.reset():l.render())}))},rollPreProcess:_a,sortArrayByName},Symbol.toStringTag,{value:"Module"})),Aa=foundry.data.fields;class ScriptCallCategory extends RegistryEntry{static defineSchema(){return{...super.defineSchema(),itemTypes:new Aa.ArrayField(new Aa.StringField({})),info:new Aa.StringField({required:!0,blank:!1,initial:""},{localize:!0})}}}class ScriptCalls extends Registry{static model=ScriptCallCategory;static _defaultData=[{_id:"use",itemTypes:["attack","buff","feat","equipment","consumable","spell","weapon"],name:"FFD20.ScriptCalls.Use.Name",info:"FFD20.ScriptCalls.Use.Info"},{_id:"equip",itemTypes:["weapon","equipment","loot"],name:"FFD20.ScriptCalls.Equip.Name",info:"FFD20.ScriptCalls.Equip.Info"},{_id:"toggle",itemTypes:["buff","feat"],name:"FFD20.ScriptCalls.Toggle.Name",info:"FFD20.ScriptCalls.Toggle.Info"},{_id:"changeQuantity",itemTypes:["loot","equipment","weapon","consumable","container"],name:"FFD20.ScriptCalls.ChangeQuantity.Name",info:"FFD20.ScriptCalls.ChangeQuantity.Info"},{_id:"changeLevel",itemTypes:["buff","class"],name:"FFD20.ScriptCalls.ChangeLevel.Name",info:"FFD20.ScriptCalls.ChangeLevel.Info"}]}const xa=Object.freeze(Object.defineProperty({__proto__:null,DamageType,DamageTypes,Registry,RegistryEntry,ScriptCallCategory,ScriptCalls,damageTypes:undefined,scriptCalls:undefined},Symbol.toStringTag,{value:"Module"}));const migrateWorld=async function({unlock:e=!1,systemPacks:t=!1}={}){if(!game.user.isGM)return void ui.notifications.error(game.i18n.localize("FFD20.ErrorUnauthorizedAction"));if(ffd20.migrations.isMigrating)return void ui.notifications.error(game.i18n.localize("FFD20.Migration.AlreadyInProgress"));ffd20.migrations.isMigrating=!0,Hooks.callAll("pf1MigrationStarted");const s=game.i18n.format("FFD20.Migration.Start",{version:game.system.version});ui.notifications.info(s,{permanent:!0}),console.log("System Migration starting.");await _migrateWorldSettings(),await migrateActors(),await migrateItems(),await migrateScenes();const n=game.packs.filter((s=>{if(s.locked&&!e)return!1;const n=s.metadata.packageType;return!!["world","system"].includes(n)&&(!("system"===n&&!t)&&["Actor","Item","Scene"].includes(s.metadata.type))}));await migrateCompendiums(n,{unlock:e}),await game.settings.set("ffd20","systemMigrationVersion",game.system.version);const l=ui.notifications.queue.find((e=>e.permanent&&e.message==s))||ui.notifications.active.find((e=>e.hasClass("permanent")&&e[0].innerText===s));var c;l&&((c=l).fadeOut?(c.fadeOut(66,(()=>c.remove())),ui.notifications.active=ui.notifications.active.filter((e=>e!=c)),ui.notifications.fetch()):ui.notifications.queue=ui.notifications.queue.filter((e=>e!=c))),ui.notifications.info(game.i18n.format("FFD20.Migration.End",{version:game.system.version}),{console:!1}),console.log("System Migration completed."),ffd20.migrations.isMigrating=!1,Hooks.callAll("pf1MigrationFinished")};async function migrateActors(){console.log("Actors directory migration starting...");for(const e of game.actors)try{const t=migrateActorData(e.toObject());foundry.utils.isEmpty(t)||(console.log("Migrating Actor document "+e.name),await e.update(t))}catch(t){console.error("Error migrating actor document "+e.name,t)}console.log("Actors directory migration complete!")}const migrateItems=async()=>{console.log("Items directory migration starting...");for(const e of game.items)try{const t=migrateItemData(e.toObject());foundry.utils.isEmpty(t)||(console.log("Migrating Item document "+e.name),await e.update(t))}catch(t){console.error("Error migrating item document "+e.name,t)}console.log("Items directory migration complete!")},migrateScenes=async()=>{console.log("Scene migration starting...");for(const e of game.scenes)console.log(`Migrating Scene document "${e.name}"`),await migrateScene(e);console.log("Scene migration finished!")},migrateCompendiums=async(e=null,{unlock:t=!1}={})=>{null===e&&(e=[...game.packs]);for(const s of e)try{await migrateCompendium(s,{unlock:t})}catch(e){console.error(e)}},migrateCompendium=async function(e,{unlock:t=!1}={}){if("string"==typeof e&&!(e=game.packs.get(e)))throw Error(`Compendium "${e}" not found.`);if(e.locked&&!t)return;const s=e.metadata.type;if(!["Actor","Item","Scene"].includes(s))return;const n=e.locked;n&&await e.configure({locked:!1}),await e.migrate(),console.log(`Migrating ${s} documents in Compendium ${e.collection}`);try{switch(s){case"Item":await e.updateAll((e=>migrateItemData(e.toObject())));break;case"Actor":await e.updateAll((e=>migrateActorData(e.toObject())));break;case"Scene":await e.updateAll((e=>migrateSceneData(e.toObject())))}}catch(t){console.error("Error migrating Compendium "+e.collection,t)}n&&await e.configure({locked:!0}),console.log(`Compendium "${e.collection}" migration complete!`)},_migrateWorldSettings=async function(){const e=game.settings.get("ffd20","tooltipWorldConfig");void 0!==e.hideActorName&&(e.hideActorNameByDisposition,e.hideActorName,game.settings.set("ffd20","tooltipWorldConfig",e))},migrateTokenData=function(e){const t=e.flags?.ffd20??{};void 0!==t.lowLightVision&&(e["flags.ffd20.-=lowLightVision"]=null),void 0!==t.lowLightVisionMultiplier&&(e["flags.ffd20.-=lowLightVisionMultiplier"]=null),void 0!==t.lowLightVisionMultiplierBright&&(e["flags.ffd20.-=lowLightVisionMultiplierBright"]=null),!1===t.disableLowLight&&(e["flags.ffd20.-=disableLowLight"]=null),!1===t.staticSize&&(e["flags.ffd20.-=staticSize"]=null),!1===t.customVisionRules&&(e["flags.ffd20.-=customVisionRules"]=null),t.customVisionRules||("basic"!==e.sight.visionMode&&(0!==e.sight.range&&(e["sight.range"]=0),e["sight.visionMode"]="basic"),"saturation"in e.sight&&(e["sight.-=saturation"]=null),"brightness"in e.sight&&(e["sight.-=brightness"]=null),"attenuation"in e.sight&&(e["sight.-=attenuation"]=null),"contrast"in e.sight&&(e["sight.-=contrast"]=null),e.detectionModes?.length&&(e.detectionModes=[]))};async function migrateToken(e){const t=e.toObject();return migrateTokenData(t),e.update(t)}function migrateActorData(e,t){if("basic"===e.type)return{};const s={},n=t?.isLinked??!0;if(_migrateCharacterLevel(e,s,n),_migrateActorEncumbrance(e,s),_migrateActorNoteArrays(e,s),_migrateActorSpeed(e,s,n),_migrateSpellDivineFocus(e,s),_migrateActorConcentration(e,s),_migrateActorSpellbookCL(e,s),_migrateActorSpellbookSlots(e,s,n),_migrateActorConcentration(e,s),_migrateActorBaseStats(e,s),_migrateUnusedActorCreatureType(e,s),_migrateActorSpellbookDCFormula(e,s,n),_migrateActorHPAbility(e,s),_migrateActorCR(e,s,n),_migrateAttackAbility(e,s,n),_migrateActorDefenseAbility(e,s),_migrateActorSpellbookUsage(e,s),_migrateActorNullValues(e,s),_migrateActorSpellbookDomainSlots(e,s),_migrateActorStatures(e,s),_migrateActorInitAbility(e,s),_migrateActorChangeRevamp(e,s),_migrateActorCMBRevamp(e,s),_migrateActorConditions(e,s),_migrateActorSkillRanks(e,s,n),_migrateCarryBonus(e,s,n),_migrateBuggedValues(e,s),_migrateSpellbookUsage(e,s),_migrateActorHP(e,s),_migrateActorSenses(e,s,n,t),_migrateActorSkillJournals(e,s),_migrateActorSubskillData(e,s),_migrateActorUnusedData(e,s),_migrateActorDRandER(e,s),!e.items)return s;const l=e.items.reduce(((t,s)=>{const n=s instanceof CONFIG.Item.documentClass?s.toObject():s,l=migrateItemData(n,e);return foundry.utils.isEmpty(l)||(l._id=n._id,t.push(expandObject(l))),t}),[]);return l.length>0&&(s.items=l),s}const migrateItemData=function(e,t=null,s=0){const n={};null==e.system&&null!=e.data&&((e=deepClone(e)).system=e.data,delete e.data),_migrateItemArrayTypes(e,n),_migrateItemSpellUses(e,n),_migrateFlagsArrayToObject(e,n),_migrateWeaponImprovised(e,n),_migrateSpellDescription(e,n),_migrateClassDynamics(e,n),_migrateClassType(e,n),_migrateWeaponCategories(e,n),_migrateArmorCategories(e,n),_migrateItemSize(e,n),_migrateAbilityTypes(e,n),_migrateClassLevels(e,n),_migrateSavingThrowTypes(e,n),_migrateCR(e,n),_migrateItemChanges(e,n),_migrateEquipmentSize(e,n),_migrateTags(e,n),_migrateSpellCosts(e,n),_migrateLootEquip(e,n),_migrateItemLinks(e,n),_migrateProficiencies(e,n),_migrateItemNotes(e,n),_migrateSpellData(e,n),_migrateItemActions(e,n,t),_migrateItemChargeCost(e,n),_migrateItemWeight(e,n),_migrateItemHealth(e,n),_migrateContainerPrice(e,n),_migrateItemType(e,n),_migrateItemLearnedAt(e,n),_migrateItemTuples(e,n),_migrateEquipmentCategories(e,n),_migrateItemUnusedData(e,n);const l=e.system.actions instanceof Array&&e.system.actions.length>0?e.system.actions:n["system.actions"];return l instanceof Array&&(n["system.actions"]=l.map((t=>migrateItemActionData(t,e)))),e.system?.inventoryItems instanceof Array&&(n["system.inventoryItems"]=e.system.inventoryItems.map((e=>{e.system??={};const n=mergeObject(e,migrateItemData(e,t,s+1),{inplace:!1,performDeletions:!0});return null!=n.data&&(n.system=mergeObject(n.data,n.system),delete n.data),n}))),n},migrateItemActionData=function(e,t){return((e,t)=>{const s=e.range?.value;null===s||""===s?delete e.range.value:void 0!==s&&"string"!=typeof s&&(e.range.value=s+"")})(e=foundry.utils.mergeObject(ffd20.components.ItemAction.defaultData,e)),_migrateActionDamageParts(e),_migrateUnchainedActionEconomy(e),_migrateActionDamageType(e),_migrateActionConditionals(e),_migrateActionEnhOverride(e),_migrateActionPrimaryAttack(e,t),_migrateActionChargeUsage(e),e};async function migrateScene(e){try{await migrateSceneTokens(e),await migrateSceneActors(e)}catch(t){console.error(`Error migrating scene document "${e.name}"`,t)}}const migrateSceneData=async function(e){const t=[];for(const s of e.tokens){if(s.actorLink)continue;s.actorId;const e=game.actors.get(s.actorId);if(!e)continue;const n=deepClone(s),l=foundry.utils.mergeObject(e.toObject(),n.delta??n.actorData),c=migrateActorData(l,s);["items","effects"].forEach((e=>{if(!c[e]?.length)return;const t=new Map(c[e].map((e=>[e._id,e])));l[e].forEach((e=>{const s=t.get(e._id);s&&foundry.utils.mergeObject(e,s)})),delete c[e]})),game.release.generation>=11?foundry.utils.mergeObject(n.delta,c):foundry.utils.mergeObject(n.actorData,c),migrateTokenData(n),t.push(n)}return{tokens:t}};async function migrateSceneTokens(e){for(const t of e.tokens)await migrateToken(t)}async function migrateSceneActors(e){for(const t of e.tokens){if(t.isLinked)continue;const e=t.actor;if(!e)continue;const s=migrateActorData(e.toObject(),t);if(!foundry.utils.isEmpty(s)){const t=s.items;delete s.items;const n=s.effects;delete s.effects,foundry.utils.isEmpty(s)||await e.update(s),t?.length&&await e.updateEmbeddedDocuments("Item",t),n?.length&&await e.updateEmbeddedDocuments("ActiveEffect",n)}}}const _migrateCharacterLevel=function(e,t,s){const n=["details.level.value","details.level.min","details.level.max","details.mythicTier"];if(s)for(const s of n){null==getProperty(e.system,s)&&(t["system."+s]=0)}},_migrateActorEncumbrance=function(e,t,s){const n={"system.attributes.encumbrance.level":"attributes.encumbrance.-=level","system.attributes.encumbrance.levels.light":"attributes.encumbrance.levels.-=light","system.attributes.encumbrance.levels.medium":"attributes.encumbrance.levels.-=medium","system.attributes.encumbrance.levels.heavy":"attributes.encumbrance.levels.-=heavy","system.attributes.encumbrance.levels.carry":"attributes.encumbrance.levels.-=carry","system.attributes.encumbrance.levels.drag":"attributes.encumbrance.levels.-=drag","system.attributes.encumbrance.carriedWeight":"attributes.encumbrance.-=carriedWeight"};for(const[s,l]of Object.entries(n)){void 0!==getProperty(e,s)&&(t["system."+l]=null)}},_migrateFlagsArrayToObject=function(e,t){const s=e.system.flags;if(!s)return;const n=s.boolean,l=s.dictionary;Array.isArray(n)&&(t["system.flags.boolean"]=n.reduce(((e,t)=>(e[t]=!0,e)),{})),Array.isArray(l)&&(t["system.flags.dictionary"]=l.reduce(((e,[t,s])=>(e[t]=s,e)),{}))},_migrateActorNoteArrays=function(e,t){const s=["system.attributes.acNotes","system.attributes.cmdNotes","system.attributes.srNotes"];for(const n of s){const s=getProperty(e,n);hasProperty(e,n)&&s instanceof Array&&(t[n]=s.join("\n"))}},_migrateActorSpeed=function(e,t,s){const n=["attributes.speed.land","attributes.speed.climb","attributes.speed.swim","attributes.speed.fly","attributes.speed.burrow"];for(const l of n){let n=getProperty(e.system,l);(s||void 0!==n)&&("string"==typeof n&&(n=parseInt(n)),"number"==typeof n?t[`system.${l}.base`]=n:null===n?t[`system.${l}.base`]=0:void 0!==n?.total&&(t[`system.${l}.-=total`]=null),"attributes.speed.fly"===l&&void 0===getProperty(e.system,l+".maneuverability")&&(t[`system.${l}.maneuverability`]="average"))}},_migrateActorSpellbookSlots=function(e,t,s){for(const n of Object.keys(getProperty(e,"system.attributes.spells.spellbooks")||{})){null==getProperty(e,`system.attributes.spells.spellbooks.${n}.autoSpellLevels`)&&(t[`system.attributes.spells.spellbooks.${n}.autoSpellLevels`]=!0);for(let l=0;l<10;l++){const c=`system.attributes.spells.spellbooks.${n}.spells.spell${l}.base`,u=`system.attributes.spells.spellbooks.${n}.spells.spell${l}.max`,d=getProperty(e,c),m=getProperty(e,u);if(void 0===d){if(!s)continue;"number"==typeof m&&m>0&&(t[c]=m.toString())}else{const e=parseInt(d);e>0?e!==d&&(t[c]=e):t[`system.attributes.spells.spellbooks.${n}.spells.spell${l}.-=base`]=null}}}},_migrateActorBaseStats=function(e,t){const s=["system.attributes.hp.base","system.attributes.hd.base","system.attributes.mp.base","system.attributes.savingThrows.fort.value","system.attributes.savingThrows.ref.value","system.attributes.savingThrows.will.value"];for(const n of s)if(("system.attributes.hp.base"!==n||(getProperty(e,"items")||[]).filter((e=>"class"===e.type)).length)&&("system.attributes.mp.base"!==n||(getProperty(e,"items")||[]).filter((e=>"class"===e.type)).length)&&void 0!==getProperty(e,n)){const e=n.split(".");e[e.length-1]="-="+e[e.length-1],t[e.join(".")]=null}},_migrateUnusedActorCreatureType=function(e,t){null!=getProperty(e,"system.attributes.creatureType")&&(t["system.attributes.-=creatureType"]=null)},_migrateActorSpellbookDCFormula=function(e,t,s){const n=Object.keys(getProperty(e,"system.attributes.spells.spellbooks")||{});for(const l of n){const n=`system.attributes.spells.spellbooks.${l}.baseDCFormula`,c=getProperty(e,n);(s||void 0!==c)&&(null==c&&(t[n]="10 + @sl + @ablMod"))}},_migrateActorSpellbookCL=function(e,t){const s=Object.keys(getProperty(e,"system.attributes.spells.spellbooks")||{});for(const n of s){const s=`system.attributes.spells.spellbooks.${n}.cl`,l=parseInt(getProperty(e,s+".base")),c=getProperty(e,s+".formula");l>0&&(c.length>0?t[s+".formula"]=c+" + "+l:t[s+".formula"]=c+l,t[s+".base"]=0)}},_migrateActorConcentration=function(e,t){const s=Object.keys(getProperty(e,"system.attributes.spells.spellbooks")||{});for(const n of s){const s="system.attributes.spells.spellbooks."+n,l=getProperty(e,s+".concentration"),c="string"==typeof l;if((Number.isFinite(l)||c)&&(t[s+".-=concentration"]=null),c){const n=s+".concentrationFormula",c=[l];c.push(getProperty(e,n)||""),t[n]=c.filter((e=>0!==e&&e?.toString().trim().length)).join(" + ")}}},_migrateActorHPAbility=function(e,t){void 0===getProperty(e,"system.attributes.hpAbility")&&(t["system.attributes.hpAbility"]="con"),void 0===getProperty(e,"system.attributes.savingThrows.fort.ability")&&(t["system.attributes.savingThrows.fort.ability"]="con"),void 0===getProperty(e,"system.attributes.savingThrows.ref.ability")&&(t["system.attributes.savingThrows.ref.ability"]="dex"),void 0===getProperty(e,"system.attributes.savingThrows.will.ability")&&(t["system.attributes.savingThrows.will.ability"]="wis")},_migrateItemArrayTypes=function(e,t){const s=getProperty(e,"system.conditionals");null==s||s instanceof Array||(t["system.conditionals"]=[]);const n=getProperty(e,"system.contextNotes");null==n||n instanceof Array||(t["system.contextNotes"]=n instanceof Object?Object.values(n):[])},_migrateItemSpellUses=function(e,t){if(void 0===getProperty(e.system,"preparation"))return;"number"!=typeof getProperty(e.system,"preparation.maxAmount")&&(t["system.preparation.maxAmount"]=0)},_migrateWeaponImprovised=function(e,t){if("weapon"!==e.type)return;"improv"===getProperty(e.system,"weaponType")&&(t["system.weaponType"]="misc",t["system.properties.imp"]=!0)},_migrateSpellDescription=function(e,t){if("spell"!==e.type)return;if(null!=getProperty(e,"system.shortDescription"))return;const s=getProperty(e,"system.description.value");if("string"!=typeof s)return;const n=$(`<div>${s}</div>`),l=n.find("h2").next();1===l.length?t["system.shortDescription"]=l.prop("outerHTML"):t["system.shortDescription"]=n.prop("innerHTML")},_migrateSpellDivineFocus=function(e,t){if("spell"!==e.type)return;const s=getProperty(e,"system.components.divineFocus");"boolean"==typeof s&&(t["system.components.divineFocus"]=!0===s?1:0)},_migrateClassDynamics=function(e,t){if("class"!==e.type)return;"number"==typeof getProperty(e,"system.bab")&&(t["system.bab"]="low");const s=["system.savingThrows.fort.value","system.savingThrows.ref.value","system.savingThrows.will.value"];for(const n of s){"number"==typeof getProperty(e,n)&&(t[n]="low")}},_migrateClassType=function(e,t){"class"===e.type&&null==getProperty(e,"system.classType")&&(t["system.classType"]="base")},_migrateWeaponCategories=function(e,t){if("weapon"!==e.type)return;const s=getProperty(e,"system.weaponType");"misc"===s?(t["system.weaponType"]="misc",t["system.weaponSubtype"]="other"):"splash"===s&&(t["system.weaponType"]="misc",t["system.weaponSubtype"]="splash");const n=["simple","martial","exotic","chef","power"].includes(s);n&&null==getProperty(e,"system.weaponSubtype")&&(t["system.weaponSubtype"]="1h");const l=getProperty(e,"system.properties.lgt");null!=l&&(t["system.properties.-=lgt"]=null,!0===l&&n&&(t["system.weaponSubtype"]="light"));const c=getProperty(e,"system.properties.two");null!=c&&(t["system.properties.-=two"]=null,!0===c&&n&&(t["system.weaponSubtype"]="2h"));const u=getProperty(e,"system.weaponData.isMelee");null!=u&&(t["system.weaponData.-=isMelee"]=null,!1===u&&n&&(t["system.weaponSubtype"]="ranged"))},_migrateArmorCategories=function(e,t){if("equipment"!==e.type)return;const s=getProperty(e,"system.armor.type");null!=s&&("clothing"===s?(t["system.equipmentType"]="misc",t["system.equipmentSubtype"]="clothing"):"shield"===s?(t["system.equipmentType"]="shield",t["system.equipmentSubtype"]="lightShield"):"misc"===s?(t["system.equipmentType"]="misc",t["system.equipmentSubtype"]="wondrous"):["light","medium","heavy"].includes(s)&&(t["system.equipmentType"]="armor",t["system.equipmentSubtype"]=s+"Armor"),t["system.armor.-=type"]=null)},_migrateEquipmentCategories=(e,t)=>{if("equipment"!==e.type)return;if("misc"===(t["system.subType"]??e.system.subType))switch(e.system.equipmentSubtype){case"wondrous":t["system.subType"]="wondrous",t["system.-=equipmentSubtype"]=null;break;case"clothing":t["system.subType"]="clothing",t["system.-=equipmentSubtype"]=null;break;case"other":t["system.subType"]="other",t["system.-=equipmentSubtype"]=null}},_migrateItemSize=function(e,t,s){if("weapon"===e.type){const s=getProperty(e,"system.weaponData.size");if(s)return t["system.size"]=s,void(t["system.weaponData.-=size"]=null)}const n=getProperty(e,"system.size");["spell","class","buff","feat"].includes(e.type)?void 0!==n&&(t["system.-=size"]=null):void 0===n&&(t["system.size"]="med")},_migrateAbilityTypes=function(e,t){"feat"===e.type&&(null==getProperty(e,"system.abilityType")&&(t["system.abilityType"]="none"),"n/a"===getProperty(e,"system.abilityType")&&(t["system.abilityType"]="none"))},_migrateClassLevels=function(e,t){const s=getProperty(e,"system.levels");"number"==typeof s&&null==getProperty(e,"system.level")&&(t["system.level"]=s,t["system.-=levels"]=null)},_migrateSavingThrowTypes=function(e,t){if(null==getProperty(e,"system.save.type")&&"string"==typeof getProperty(e,"system.save.description")){const s=getProperty(e,"system.save.description");s.match(/REF/i)?t["system.save.type"]="ref":s.match(/FORT/i)?t["system.save.type"]="fort":s.match(/WILL/i)&&(t["system.save.type"]="will")}},_migrateCR=function(e,t){const s=getProperty(e,"system.crOffset");"number"==typeof s&&(t["system.crOffset"]=s.toString())},_migrateItemChanges=function(e,t){const s=getProperty(e,"system.changes");if(null!=s&&s instanceof Array){const e=[];for(const t of s)if(t instanceof Array){const s=new ItemChange({formula:t[0],target:t[1],subTarget:t[2],modifier:t[3],value:t[4]},null);e.push(s.data)}else{const s=new ItemChange(t,null);e.push(s.data)}0!==e.length&&0!==s.length&&(t["system.changes"]=e)}const n=getProperty(e,"system.contextNotes");if(null!=n&&n instanceof Array){const e=[];for(const t of n)t instanceof Array?e.push(foundry.utils.mergeObject(ItemPF.defaultContextNote,{text:t[0],subTarget:t[2]},{inplace:!1})):e.push(t),"spell"===t.target&&"effect"===t.subTarget&&(t.subTarget="spellEffect");0!==e.length&&0!==n.length&&(t["system.contextNotes"]=e)}},_migrateEquipmentSize=function(e,t){if("equipment"!==e.type)return;getProperty(e,"system.size")||(t["system.size"]="med")},_migrateItemWeight=function(e,t){const s=getProperty(e,"system.baseWeight"),n=getProperty(e,"system.weight");game.system.template.Item[e.type].templates.includes("physicalItem")?(Number.isFinite(n)?t["system.weight.value"]=n:null!=n&&"object"==typeof n||(t["system.weight.value"]=0),void 0!==s&&(Number.isFinite(s)&&s>0&&(t["system.weight.value"]=s),t["system.-=baseWeight"]=null)):void 0!==n&&(t["system.-=weight"]=null)},_migrateItemHealth=function(e,t){const s=CONFIG.Item.documentClasses[e.type]?.isPhysical,n=e.system.hp;s?n?("string"==typeof n.max&&(t["system.hp.max"]=parseInt(n.max)),"string"==typeof n.value&&(t["system.hp.value"]=parseInt(n.value))):(t["system.hp.value"]=10,t["system.hp.max"]=10):"class"!==e.type&&void 0!==n&&(t["system.-=hp"]=null)},_migrateTags=function(e,t){if(!["class"].includes(e.type))return;!getProperty(e,"system.tag")&&e.name&&(t["system.tag"]=createTag(e.name))},_migrateSpellCosts=function(e,t){if("spell"!==e.type)return;null==getProperty(e,"system.spellPoints.cost")&&(t["system.spellPoints.cost"]="1 + @sl");null==getProperty(e,"system.slotCost")&&(t["system.slotCost"]=1);const s=e.system.preparation?.autoDeductCharges;void 0!==s&&(!1===s&&(t["system.uses.autoDeductChargesCost"]="0"),t["system.preparation.-=autoDeductCharges"]=null)},_migrateLootEquip=function(e,t){"loot"!==e.type||hasProperty(e,"system.equipped")||(t["system.equipped"]=!1)},_migrateUnchainedActionEconomy=(e,t)=>{e.activation??={},e.unchainedAction?.activation&&(e.activation.unchained=e.unchainedAction.activation,delete e.unchainedAction)},_migrateItemLinks=function(e,t){["attack","consumable","equipment"].includes(e.type)&&!hasProperty(e,"system.links.charges")&&(t["system.links.charges"]=[]);const s=e.system.links??{};for(const[e,n]of Object.entries(s)){let s=!1;const l=deepClone(n);for(const e of l){const t=e.dataType;void 0!==t&&("data"===t?delete e.dataType:"world"===t?(e.uuid=e.id.replace(/^world\./,"Item."),delete e.id,delete e.dataType):"compendium"===t&&(e.uuid="Compendium."+e.id,delete e.id,delete e.dataType),delete e.img,s=!0),void 0!==e._index&&(delete e._index,s=!0),void 0!==e.hiddenLinks&&(delete e.hiddenLinks,s=!0)}s&&(t["system.links."+e]=l)}},_migrateProficiencies=function(e,t){if(["feat","class","race"].includes(e.type))for(const s of["armorProf","weaponProf"])hasProperty(e,"system."+s)||(t["system."+s]={value:[],custom:""})},_migrateItemNotes=function(e,t){const s=["system.attackNotes","system.effectNotes"];for(const n of s){const s=getProperty(e,n);!hasProperty(e,n)||s instanceof Array||(t[n]=[],"string"==typeof s&&s.length>0&&(t[n]=s.trim().split(/[\n\r]/)))}},_migrateSpellData=function(e,t){"spell"===e.type&&void 0!==e.system.description?.value&&(t["system.description.-=value"]=null)},_migrateItemActions=function(e,t,s=null){const n=!!e.system.actionType||!!e.system.activation?.type||!!e.system.measureTemplate?.type,l=e.system.actions instanceof Array&&e.system.actions.length>0;if(!n&&"spell"!==e.type||l)return;const c=ffd20.components.ItemAction.defaultData,u=["_id","name","img"];for(const t of Object.keys(c))u.includes(t)||null!=e.system[t]&&(c[t]=deepClone(e.system[t]));if(["weapon","attack"].includes(e.type)?c.name=game.i18n.localize("FFD20.Attack"):c.name=game.i18n.localize("FFD20.Use"),c.img=e.img,c.description="","spell"===e.type&&(c.activation.type||="standard",c.duration.value=e.system.spellDuration,null!=s)){const t=e.system.spellbook,n=s.system.attributes?.spells?.spellbooks?.[t];if(n.spellPoints?.useSystem){const t=e.system.spellPoints?.cost;t&&(c.uses.autoDeductChargesCost=t)}}const d=c.powerAttack?.multiplier;"string"==typeof d&&(""===d?delete c.powerAttack.multiplier:c.powerAttack.multiplier=parseInt(d)),t["system.attackNotes"]=[],t["system.effectNotes"]=[],t["system.actions"]=[c]},_migrateItemLearnedAt=(e,t)=>{const s=e.system.learnedAt??{};for(const[e,n]of Object.entries(s))Array.isArray(n)&&(t["system.learnedAt."+e]=n.reduce(((e,[t,s])=>{for(let n of t.split("/"))n=n.trim().replace(".","-"),n&&(e[n]=s);return e}),{}))},_migrateActionChargeUsage=function(e,t){void 0!==e.uses?.autoDeductCharges&&(!1===e.uses.autoDeductCharges?e.uses.autoDeductChargesCost="0":"1"===e.uses.autoDeductChargesCost&&(e.uses.autoDeductChargesCost=""),delete e.uses.autoDeductCharges)},_migrateItemChargeCost=function(e,t){const s=e.system.uses?.autoDeductCharges;if(void 0!==s)!1===s&&(t["system.uses.autoDeductChargesCost"]="0"),t["system.uses.-=autoDeductCharges"]=null;else if(0===e.system.level&&void 0===e.system.uses?.autoDeductChargesCost){const s=e.system.actions?.[0];!0===s?.uses.autoDeductCharges&&void 0===t["system.uses.autoDeductChargesCost"]&&(t["system.uses.autoDeductChargesCost"]="0")}},_migrateActionDamageParts=function(e,t){const s=e.damage;for(const e of["parts","critParts","nonCritParts"]){const t=s[e];t&&t.forEach(((e,s)=>{if(Array.isArray(e)){const[n,l]=e;t[s]={formula:n,type:l}}}))}},_migrateActionDamageType=function(e,t){const s=["damage.parts","damage.critParts","damage.nonCritParts"];for(const t of s){const s=getProperty(e,t);for(const e of s){const t=e.type;if("string"==typeof t){const s=ffd20.components.ItemAction.defaultDamageType;s.values=_Action_ConvertDamageType(t),0===s.values.length&&(s.custom=t),e.type=s}else if(t instanceof Array){const s=ffd20.components.ItemAction.defaultDamageType;s.values=t,e.type=s}}}},_migrateActionConditionals=function(e,t){for(const t of e.conditionals??[]){t._id||(t._id=randomID(16)),Array.isArray(t.modifiers)||(t.modifiers=Object.values(t.modifiers));for(const e of t.modifiers){let t;if(e._id||(e._id=randomID(16)),e.subTarget??="",(t=e.subTarget.match(/^attack\.([0-9]+)/))&&(e.subTarget="attack_"+t[1]),delete e.targets,delete e.subTargets,delete e.conditionalModifierTypes,delete e.conditionalCritical,"damage"===e.target&&!e.damageType){const t=ffd20.components.ItemAction.defaultDamageType;t.values=_Action_ConvertDamageType(e.type),0===t.values.length&&(t.custom=e.type),e.damageType=t,e.type=""}}}},_migrateActionEnhOverride=function(e,t){"object"!=typeof e.enh&&(e.enh={value:e.enh??null}),(0==e.enh.override||null!==e.enh.value&&"number"!=typeof e.enh.value)&&(e.enh.value=null),delete e.enh.override},_migrateActionPrimaryAttack=function(e,t){void 0===e.naturalAttack?.primaryAttack&&setProperty(e,"naturalAttack.primaryAttack",t.system.primaryAttack)},_migrateActorCR=function(e,t,s){const n=getProperty(e,"system.details.cr");(s||void 0!==n)&&("number"==typeof n?t["system.details.cr.base"]=n:null==n&&(t["system.details.cr.base"]=1),void 0!==getProperty(e,"system.details.cr.total")&&(t["system.details.cr.-=total"]=null))},_migrateAttackAbility=function(e,t,s){void 0===getProperty(e,"system.attributes.cmbAbility")&&s&&(t["system.attributes.cmbAbility"]="str");void 0===getProperty(e,"system.attributes.attack.meleeAbility")&&s&&(t["system.attributes.attack.meleeAbility"]="str");void 0===getProperty(e,"system.attributes.attack.rangedAbility")&&s&&(t["system.attributes.attack.rangedAbility"]="dex")},_migrateActorSpellbookUsage=function(e,t,s){void 0!==getProperty(e,"system.attributes.spells.usedSpellbooks")&&(t["system.attributes.spells.-=usedSpellbooks"]=null)},_migrateActorNullValues=function(e,t){const s={"system.attributes.energyDrain":getProperty(e,"system.attributes.energyDrain")};for(const[t,n]of Object.entries(getProperty(e,"system.abilities")||{}))s[`system.abilities.${t}.damage`]=n.damage,s[`system.abilities.${t}.drain`]=n.drain,s[`system.abilities.${t}.penalty`]=n.penalty;for(const[e,n]of Object.entries(s))null===n&&(t[e]=0)},_migrateActorSpellbookDomainSlots=function(e,t){const s=getProperty(e,"system.attributes.spells.spellbooks")||{};for(const[e,n]of Object.entries(s)){if(void 0!==n.domainSlotValue)continue;t[`system.attributes.spells.spellbooks.${e}.domainSlotValue`]=1}},_migrateActorStatures=function(e,t){void 0===getProperty(e,"system.traits.stature")&&(t["system.traits.stature"]="tall")},_migrateActorDefenseAbility=function(e,t){void 0===getProperty(e,"system.attributes.ac.normal.ability")&&(t["system.attributes.ac.normal.ability"]="dex");void 0===getProperty(e,"system.attributes.ac.touch.ability")&&(t["system.attributes.ac.touch.ability"]="dex");void 0===getProperty(e,"system.attributes.cmd.dexAbility")&&(t["system.attributes.cmd.dexAbility"]="dex");void 0===getProperty(e,"system.attributes.cmd.strAbility")&&(t["system.attributes.cmd.strAbility"]="str")},_migrateActorInitAbility=function(e,t){void 0===getProperty(e,"system.attributes.init.ability")&&(t["system.attributes.init.ability"]="dex")},_migrateActorCMBRevamp=function(e,t,s){void 0!==getProperty(e,"system.attributes.cmb.total")&&(t["system.attributes.cmb.-=total"]=null)},_migrateActorChangeRevamp=function(e,t){Object.keys(getProperty(e,"system.skills")??{}).forEach((s=>{const n=`system.skills.${s}.`;void 0!==getProperty(e,n+"changeBonus")&&(t[n+"-=changeBonus"]=null),Object.keys(getProperty(e,`system.skills.${s}.subSkills`)??{}).forEach((n=>{const l=`system.skills.${s}.subSkills.${n}.`;void 0!==getProperty(e,l+"changeBonus")&&(t[l+"-=changeBonus"]=null)}))}));Object.entries({"system.attributes.hp.max":"attributes.hp.-=max","system.attributes.mp.max":"attributes.mp.-=max","system.attributes.ac.normal.total":"attributes.ac.normal.-=total","system.attributes.ac.touch.total":"attributes.ac.touch.-=total","system.attributes.ac.flatFooted.total":"attributes.ac.flatFooted.-=total","system.attributes.cmd.total":"attributes.cmd.-=total","system.attributes.cmd.flatFootedTotal":"attributes.cmd.-=flatFootedTotal","system.attributes.sr.total":"attributes.sr.-=total","system.attributes.init.total":"attributes.init.-=total"}).forEach((([s,n])=>{void 0!==getProperty(e,s)&&(t["system."+n]=null)}))},_migrateActorConditions=function(e,t){{const s=getProperty(e,"system.conditions.fear");void 0!==s&&(!0===s&&(t["system.attributes.conditions.shaken"]=!0),t["system.conditions.-=fear"]=null);const n=getProperty(e,"system.attributes.conditions.fear");void 0!==n&&(!0===n&&(t["system.attributes.conditions.shaken"]=!0),t["system.attributes.conditions.-=fear"]=null)}},_migrateActorSkillRanks=function(e,t,s){const n=getProperty(e,"system.skills");if(n)for(const[e,l]of Object.entries(n))if(s||void 0!==l.rank){Number.isFinite(l.rank)||(t[`system.skills.${e}.rank`]=0);for(const[n,c]of Object.entries(l.subSkills??{}))(s||void 0!==c.rank)&&(Number.isFinite(c.rank)||(t[`system.skills.${e}.subSkills.${n}.rank`]=0))}},_migrateCarryBonus=function(e,t,s){if(void 0===getProperty(e,"system.details.carryCapacity.bonus.user")){let n=getProperty(e,"system.abilities.str.carryBonus");(void 0!==n||s)&&(n=n||0,t["system.details.carryCapacity.bonus.user"]=n),t["system.abilities.str.-=carryBonus"]=null}if(void 0===getProperty(e,"system.details.carryCapacity.multiplier.user")){let n=getProperty(e,"system.abilities.str.carryMultiplier");(void 0!==n||s)&&(n=n||1,t["system.details.carryCapacity.multiplier.user"]=n-1),t["system.abilities.str.-=carryMultiplier"]=null}},_migrateBuggedValues=function(e,t,s){const n=["system.details.xp.value","system.currency.pgil","system.currency.gil","system.currency.sgil","system.currency.cgil","system.altCurrency.pgil","system.altCurrency.gil","system.altCurrency.sgil","system.altCurrency.cgil"];for(const s of n){const n=getProperty(e,s),l=parseInt(n??0);n!==l&&(t[s]=l)}},_migrateSpellbookUsage=function(e,t,s){const n=e.items.filter((e=>"spell"===e.type)).reduce(((e,t)=>t.system.spellbook?(e.includes(t.system.spellbook)||e.push(t.system.spellbook),e):e),[]);for(const s of n){const n=`system.attributes.spells.spellbooks.${s}.inUse`;!0!==getProperty(e,n)&&(t[n]=!0)}},_migrateActorHP=function(e,t,s){for(const s of["system.attributes.hp","system.attributes.wounds","system.attributes.vigor","system.attributes.mp"])if(null==getProperty(e,s+".offset")){const n=getProperty(e,s+".max")??0,l=getProperty(e,s+".value")??0;t[s+".offset"]=l-n}},_migrateActorSenses=function(e,t,s,n){const l=e.system.traits?.senses;if("string"==typeof l){const s=n??e.prototypeToken;t["system.traits.senses"]={dv:s.brightSight,ts:0,bs:0,bse:0,ll:{enabled:s.flags?.ffd20?.lowLightVision,multiplier:{dim:s.flags?.ffd20?.lowLightVisionMultiplier??2,bright:s.flags?.ffd20?.lowLightVisionMultiplierBright??2}},sid:!1,tr:!1,si:!1,sc:0,custom:l}}"boolean"==typeof l?.sc&&(t["system.traits.senses.sc"]=l.sc?30:0)},_migrateActorSkillJournals=function(e,t,s){const n=/^[a-zA-Z0-9]+$/;for(const[s,l]of Object.entries(e.system.skills??{})){for(const[e,c]of Object.entries(l.subSkills??{}))c.journal?.match(n)&&(t[`system.skills.${s}.subSkills.${e}.journal`]="JournalEntry."+c.journal);l.journal?.match(n)&&(t[`system.skills.${s}.journal`]="JournalEntry."+l.journal)}},_migrateActorSubskillData=(e,t)=>{for(const[s,n]of Object.entries(e.system.skills??{}))for(const[e,l]of Object.entries(n.subSkills??{}))void 0!==l.mod&&(t[`system.skills.${s}.subSkills.${e}.-=mod`]=null)},_migrateActorDRandER=function(e,t){const s=e.system.traits?.dr,n=e.system.traits?.eres;"string"==typeof s&&(t["system.traits.dr"]={value:[],custom:s}),"string"==typeof n&&(t["system.traits.eres"]={value:[],custom:n})},_Action_ConvertDamageType=function(e){const t=[{tests:["b","blunt","bludgeoning"],result:"bludgeoning"},{tests:["p","pierce","piercing"],result:"piercing"},{tests:["s","slash","slashing"],result:"slashing"},{tests:["f","fire"],result:"fire"},{tests:["ice","i"],result:"ice"},{tests:["e","l","lightning","electricity","electrical"],result:"lightning"},{tests:["wind"],result:"wind"},{tests:["earth"],result:"earth"},{tests:["water"],result:"water"},{tests:["force"],result:"force"},{tests:["dark","neg","negative"],result:"dark"},{tests:["light","pos","positive"],result:"light"},{tests:["u","untyped","untype"],result:"untyped"},{tests:["n","nonelemental","non"],result:"nonelemental"}],s=e.split(/(?:\s*\/\s*|\s+and\s+|\s+or\s+)/i).map((e=>e.toLowerCase())),n=[];for(const e of t)for(const t of e.tests)s.includes(t)&&n.push(e.result);return n.length>0?n:[]},_migrateContainerPrice=(e,t)=>{"container"===e.type&&(void 0!==e.system.basePrice&&(t["system.price"]=e.system.basePrice,t["system.-=basePrice"]=null),void 0!==e.system.unidentified?.basePrice&&(t["system.unidentified.price"]=e.system.unidentified.basePrice,t["system.unidentified.-=basePrice"]=null))},_migrateItemType=function(e,t){const s=e.type,n=e.system[s+"Type"];null!=n&&(t["system.subType"]=n,t[`system.-=${s}Type`]=null)},_migrateItemUnusedData=(e,t)=>{void 0!==e.system.priceUnits&&(t["system.-=priceUnits"]=null),void 0!==e.system.description?.chat&&(t["system.description.-=chat"]=null),void 0!==e.system.identifiedName&&(t["system.-=identifiedName"]=null),void 0!==e.system.typeName&&(t["system.-=typeName"]=null),void 0!==e.system.weaponData&&(t["system.-=weaponData"]=null),void 0!==e.system.range&&(t["system.-=range"]=null),void 0!==e.system.primaryAttack&&(t["system.-=primaryAttack"]=null),void 0!==e.system.activation&&(t["system.-=activation"]=null),void 0!==e.system.unchainedAction&&(t["system.-=unchainedAction"]=null),void 0!==e.system.measureTemplate&&(t["system.-=measureTemplate"]=null)},_migrateActorUnusedData=(e,t)=>{void 0!==getProperty(e.system,"attributes.vision")&&(t["system.attributes.-=vision"]=null),void 0!==getProperty(e.prototypeToken,"flags.ffd20.lowLightVision")&&(t["prototypeToken.flags.ffd20.-=lowLightVision"]=null),void 0!==e.system.details?.xp?.max&&(t["system.details.xp.-=max"]=null),void 0!==e.system.resources&&(t["system.-=resources"]=null)},_migrateItemTuples=(e,t)=>{"race"===e.type&&e.system.subTypes?.length&&"string"!=typeof e.system.subTypes[0]&&(t["system.subTypes"]=e.system.subTypes.flat()),e.system.tags?.length&&"string"!=typeof e.system.tags[0]&&(t["system.tags"]=e.system.tags.flat());const s=e.system.associations?.classes;s?.length&&"string"!=typeof s[0]&&(t["system.associations.classes"]=s.flat())},Ia=Object.freeze(Object.defineProperty({__proto__:null,filterItemActions:function(e){return!!e.activation?.type||!!e.actionType},isMigrating:!1,migrateActor:async function migrateActor(e){const t=migrateActorData(e.toObject(),e.token);return foundry.utils.isEmpty(t)?null:e.update(t)},migrateActorData,migrateActors,migrateCompendium,migrateCompendiums,migrateItem:async function migrateItem(e){const t=migrateItemData(e.toObject(),e.actor);return foundry.utils.isEmpty(t)?null:e.update(t)},migrateItemActionData,migrateItemData,migrateItems,migrateModules:({unlock:e=!0}={})=>{const t=game.packs.filter((e=>"module"===e.metadata.packageType));return migrateCompendiums(t,{unlock:e})},migrateScene,migrateSceneActors,migrateSceneData,migrateSceneTokens,migrateScenes,migrateSystem:async({unlock:e=!0}={})=>{const t=game.packs.filter((e=>"system"===e.metadata.packageType));return migrateCompendiums(t,{unlock:e})},migrateToken,migrateTokenData,migrateWorld},Symbol.toStringTag,{value:"Module"}));globalThis.ffd20=function moduleToObject(e){const t={};for(const s in e)"[object Module]"===Object.prototype.toString.call(e[s])?t[s]=moduleToObject(e[s]):t[s]=e[s];return t}({actionUse:ma,applications:oa,canvas:va,components:Sa,config:ee,dice:Ca,documents:da,migrations:Ia,registry:xa,tooltip:null,utils:wa,skipConfirmPrompt:!1}),Hooks.once("init",(function(){console.log("FFD20 | Initializing Final Fantasy D20 System"),ui.notifications={info:(e,t={})=>!1!==t.console?console.log(e):void 0,warn:(e,t={})=>!1!==t.console?console.warn(e):void 0,error:(e,t={})=>!1!==t.console?console.error(e):void 0},globalThis.RollPF=RollPF,CONFIG.FFD20=ffd20.config,CONFIG.Canvas.layers.templates.layerClass=TemplateLayerPF,CONFIG.MeasuredTemplate.objectClass=MeasuredTemplatePF,CONFIG.MeasuredTemplate.defaults.originalAngle=CONFIG.MeasuredTemplate.defaults.angle,CONFIG.MeasuredTemplate.defaults.angle=90,CONFIG.Token.objectClass=TokenPF,CONFIG.Actor.documentClass=Z,CONFIG.Actor.documentClasses={character:ActorCharacterPF,npc:ActorNPCPF,basic:BasicActorPF},CONFIG.Item.documentClass=Y,CONFIG.Item.documentClasses={attack:ItemAttackPF,buff:ItemBuffPF,class:ItemClassPF,consumable:ItemConsumablePF,container:ItemContainerPF,equipment:ItemEquipmentPF,feat:ItemFeatPF,loot:ItemLootPF,race:ItemRacePF,spell:ItemSpellPF,weapon:ItemWeaponPF},CONFIG.Token.documentClass=TokenDocumentPF,CONFIG.ActiveEffect.documentClass=ActiveEffectPF,CONFIG.ActiveEffect.legacyTransferral=!1,CONFIG.Combat.documentClass=CombatPF,CONFIG.Combatant.documentClass=CombatantPF,CONFIG.ChatMessage.documentClass=ChatMessagePF,CONFIG.ui.items=ItemDirectoryPF,CONFIG.Dice.rolls.splice(0,0,RollPF),CONFIG.Dice.termTypes.SizeRollTerm=SizeRollTerm,CONFIG.Dice.RollPF=RollPF,CONFIG.Dice.rolls.push(D20RollPF),CONFIG.Dice.rolls.D20RollPF=D20RollPF,CONFIG.Dice.rolls.push(DamageRoll),CONFIG.Dice.rolls.DamageRoll=DamageRoll,CONFIG.time.roundTime=6,registerSystemSettings(),setDefaultSceneScaling(),CONFIG.statusEffects=getConditions(),preloadHandlebarsTemplates(),registerHandlebarsHelpers(),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("ffd20",ActorSheetPFCharacter,{label:"FFD20.Sheet.PC",types:["character"],makeDefault:!0}),Actors.registerSheet("ffd20",ActorSheetPFNPC,{label:"FFD20.Sheet.NPC",types:["npc"],makeDefault:!0}),Actors.registerSheet("ffd20",ActorSheetPFNPCLite,{label:"FFD20.Sheet.NPCLite",types:["npc"],makeDefault:!1}),Actors.registerSheet("ffd20",ActorSheetPFNPCLoot,{label:"FFD20.Sheet.NPCLoot",types:["npc"],makeDefault:!1}),Actors.registerSheet("ffd20",ActorSheetPFBasic,{label:"FFD20.Sheet.Basic",types:["basic"],makeDefault:!0}),Items.unregisterSheet("core",ItemSheet),Items.registerSheet("ffd20",ItemSheetPF,{label:"FFD20.Sheet.Item",types:["class","feat","spell","consumable","equipment","loot","weapon","buff","attack","race"],makeDefault:!0}),Items.registerSheet("ffd20",ItemSheetPF_Container,{label:"FFD20.Sheet.Container",types:["container"],makeDefault:!0}),CONFIG.specialStatusEffects.BLIND="pf1_blind";for(const e of Object.values(ffd20.canvas.detectionModes))CONFIG.Canvas.detectionModes[e.ID]=new e({id:e.ID,label:e.LABEL,type:e.DETECTION_TYPE||DetectionMode.DETECTION_TYPES.SIGHT});CONFIG.Canvas.visionModes.darkvision=ffd20.canvas.visionModes.darkvision,function initializeSocket(){game.socket.on("system.ffd20",runSocketFunction)}(),function initializeModules(){Hooks.once("dragRuler.ready",(e=>{const t=game.modules.get("enhanced-terrain-layer")?.active;dragRuler.registerSystem("ffd20",class Pf1SpeedProvider extends e{get colors(){return[{id:"walk",default:65280,name:"SETTINGS.pf1DragRulerWalk"},{id:"dash",default:16776960,name:"SETTINGS.pf1DragRulerDash"},{id:"run",default:16744448,name:"SETTINGS.pf1DragRulerRun"}]}getRanges(e){const t=convertDistance(this.getBaseSpeed(e))[0],s=e.actor.getRollData(),n=s.armor.type>=ffd20.config.armorTypes.heavy,l=s.attributes.encumbrance.level>=ffd20.config.encumbranceLevels.heavy;let c=4;return(n||l)&&(c=3),[{range:t,color:"walk"},{range:2*t,color:"dash"},{range:t*c,color:"run"}]}getBaseSpeed(e){const[s,n]=canvas.grid.grid.getGridPositionFromPixels(e.x,e.y),l=this.getSetting("useElevation"),c=e.actor.system.attributes.speed;if(l&&e.document.elevation>0){const e=c.fly.total;if(e>0)return e}if(t&&canvas.terrain.terrainFromGrid(n,s).some((e=>"water"===e.data.environment))){const e=c.swim.total;if(e>0)return e}if(l&&e.document.elevation<0){const e=c.burrow.total;if(e>0)return e}return c.land.total}get settings(){return[{id:"useElevation",name:"SETTINGS.pf1DragRulerUseElevationName",hint:"SETTINGS.pf1DragRulerUseElevationHint",scope:"world",type:Boolean,default:!0}]}})}))}();const e=[["damageTypes",DamageTypes],["scriptCalls",ScriptCalls]];for(const[t,s]of e)ffd20.registry[t]=new s;Object.defineProperty(ffd20.config,"damageTypes",{get:()=>(foundry.utils.logCompatibilityWarning("Damage types have been moved into the DamageTypes registry. Use ffd20.registry.damageTypes.getLabels() for the old format, or access the collection for full damage type data.",{since:"FFD20 v1.1.0",until:"FFD20 v2.0.0"}),ffd20.registry.damageTypes.getLabels())}),Hooks.callAll("pf1PostInit")})),Hooks.once("setup",(function(){const e=["abilities","abilitiesShort","alignments","currencies","distanceUnits","itemActionTypes","senses","skills","targetTypes","timePeriods","timePeriodsShort","savingThrows","ac","featTypes","featTypesPlurals","traitTypes","conditions","lootTypes","flyManeuverabilities","abilityTypes","spellPreparationModes","weaponGroups","weaponTypes","weaponProperties","spellComponents","spellSchools","multiSchools","spellLevels","conditionTypes","favouredClassBonuses","armorProficiencies","weaponProficiencies","actorSizes","abilityActivationTypes","abilityActivationTypesPlurals","limitedUsePeriods","equipmentTypes","equipmentSlots","consumableTypes","attackTypes","buffTypes","healingTypes","divineFocus","classSavingThrows","classBAB","classTypes","measureTemplateTypes","creatureTypes","measureUnits","measureUnitsShort","languages","weaponHoldTypes","auraStrengths","conditionalTargets","bonusModifiers","abilityActivationTypes_unchained","abilityActivationTypesPlurals_unchained","actorStatures","ammoTypes","classBaseMPTypes","classSubTypes","classBaseMPauto","classCastingStats","countforexp","materiaRarity"],t=["skills","conditions","conditionTypes","consumableTypes","creatureTypes","featTypes","weaponProperties","spellSchools","languages","multiSchools"],doLocalize=(e,s)=>{const n=Object.entries(e).reduce(((e,t)=>("string"==typeof t[1]?e.push([t[0],game.i18n.localize(t[1])]):"object"==typeof t[1]&&e.push([t[0],doLocalize(t[1],`${s}.${t[0]}`)]),e)),[]);return t.includes(s)&&n.sort(((e,t)=>{const s="string"==typeof e?.[1]?e[1]:e[1]?._label,n="string"==typeof t?.[1]?t[1]:t[1]?._label;return"misc"===e[0]?1:"misc"===t[0]?-1:s.localeCompare(n)})),n.reduce(((e,t)=>(e[t[0]]=t[1],e)),{})};for(const t of e)ffd20.config[t]=doLocalize(ffd20.config[t],t);const s=["buffTargets","buffTargetCategories","contextNoteTargets","contextNoteCategories"];for(const e of s)for(const[t,s]of Object.entries(ffd20.config[e]))ffd20.config[e][t].label=game.i18n.localize(s.label);for(const e of Object.values(ffd20.registry))e instanceof ffd20.registry.Registry&&e.setup();tinyMCEInit(),registerSystemControls(),Hooks.callAll("pf1PostSetup")})),Hooks.once("ready",(async function(){const e=game.settings.get("ffd20","tooltipConfig"),t=game.settings.get("ffd20","tooltipWorldConfig");e.disable||t.disable||ffd20.applications.TooltipPF.toggle(!0),window.addEventListener("resize",(()=>{ffd20.tooltip?.setPosition()}));let s=game.settings.get("ffd20","systemMigrationVersion");"number"==typeof s?s=s.toString()+".0":"string"==typeof s&&s.match(/^([0-9]+)\.([0-9]+)$/)&&(s+=".0");if(SemanticVersion.fromString("10.2.3").isHigherThan(SemanticVersion.fromString(s))&&game.user.isGM&&await migrateWorld(),await migrateSystemSettings(),ffd20.applications.compendiumBrowser.CompendiumBrowser.initializeBrowsers(),!game.settings.get("ffd20","dontShowChangelog")){const e=game.settings.get("ffd20","changelogVersion")||"0.0.1",t=SemanticVersion.fromString(e),s=SemanticVersion.fromString(game.system.version);if(s.isHigherThan(t)){new ffd20.applications.ChangeLogWindow(t).render(!0,{focus:!0}),game.settings.set("ffd20","changelogVersion",s.toString())}}game.settings.get("ffd20","allowScriptChanges")&&ui.notifications.warn("SETTINGS.pf1AllowScriptChangesD",{localize:!0,permanent:!0}),Hooks.callAll("pf1PostReady")})),Hooks.on("canvasInit",(function(){canvas.grid.diagonalRule=game.settings.get("ffd20","diagonalMovement"),SquareGrid.prototype.measureDistances=measureDistances})),Hooks.on("renderChatMessage",((e,t,s)=>{hideRollInfo(e,t),hideGMSensitiveInfo(e,t),game.user.isGM||hideInvisibleTargets(0,t),addTargetCallbacks(e,t),alterTargetDefense(e,t),game.settings.get("ffd20","autoCollapseItemCards")&&t.find(".card-content").hide(),game.settings.get("ffd20","hideChatButtons")&&t.find(".card-buttons").hide(),game.settings.get("ffd20","accessibilityConfig"),alterAmmoRecovery(e,t),t.find(".tooltip").on("mousemove",(e=>handleChatTooltips(e)))})),Hooks.on("renderChatPopout",((e,t,s)=>{game.settings.get("ffd20","autoCollapseItemCards")&&t.find(".card-content").hide(),game.settings.get("ffd20","hideChatButtons")&&t.find(".card-buttons").hide()})),Hooks.on("renderChatLog",((e,t)=>ItemPF.chatListeners(t))),Hooks.on("renderChatLog",((e,t)=>ActorPF.chatListeners(t))),Hooks.on("renderChatLog",((e,t)=>addReachListeners(t))),Hooks.on("renderChatPopout",((e,t)=>ItemPF.chatListeners(t))),Hooks.on("renderChatPopout",((e,t)=>ActorPF.chatListeners(t))),Hooks.on("renderAmbientLightConfig",((e,t)=>{addLowLightVisionToLightConfig(e,t)})),Hooks.on("renderTokenHUD",((e,t,s)=>{TokenQuickActions.addQuickActions(e,t,s)})),Hooks.on("updateActor",((e,t,s,n)=>{{const s=t.system?.attributes?.conditions||{};for(const[t,n]of Object.entries(s))Hooks.callAll("pf1ToggleActorCondition",e,t,n)}})),Hooks.on("createToken",((e,t,s)=>{if(game.user.id===s&&e.actor.effects?.size){const t=[];for(const s of e.actor.effects){if(!s.origin)continue;const n=s.origin.match(/Item\.(\w+)/)?.pop(),l=e.actor.items.get(n);l&&t.push({_id:s.id,origin:l.uuid})}e.actor.updateEmbeddedDocuments("ActiveEffect",t,{render:!1})}})),Hooks.on("deleteToken",((e,t,s)=>{ffd20.tooltip?.unbind(e.object)})),Hooks.on("updateToken",(function(e,t,s,n){ffd20.tooltip?.unbind(e)})),Hooks.on("preCreateToken",((e,t,s,n)=>{if(e.getFlag("ffd20","staticSize"))return;const l=X[e.actor?.system.traits?.size];l&&(t.width=l.w,t.height=l.h,t.texture??={},t.texture.scaleY=l.scale,t.texture.scaleX=l.scale)})),Hooks.on("createItem",((e,t,s)=>{const n=e.actor;if(s===game.user.id){if("buff"===e.type&&!0===e.system.active&&(n&&Hooks.callAll("pf1ToggleActorBuff",n,e,!0),e.executeScriptCalls("toggle",{state:!0})),"feat"===e.type){!1===e.system.disabled&&e.executeScriptCalls("toggle",{state:!0})}!0===e.system.equipped&&e.executeScriptCalls("equip",{equipped:!0});{const t=e.system.quantity;"number"==typeof t&&t>0&&e.executeScriptCalls("changeQuantity",{quantity:{previous:0,new:t}})}}})),Hooks.on("preDeleteItem",((e,t,s)=>{if(!e.actor)return;if(t.handledChildren)return;const n=new Set,_getChildren=e=>{if(n.has(e.id))return[];n.add(e.id);const t=[],s=e.system.links?.children??[];for(const l of s){if(n.has(l.id))continue;const s=e.actor.items.get(l.id);s&&(t.push(s.id),t.push(..._getChildren(s)))}return t},l=_getChildren(e);if(l.length>0){const t=[e.id,...l].reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[]).filter((t=>e.actor.items.has(t)));return e.actor.deleteEmbeddedDocuments("Item",t,{handledChildren:!0}),!1}})),Hooks.on("deleteItem",(async(e,t,s)=>{if(s!==game.user.id)return;const n=e.actor;if(n){const t=e.system.links;if(t)for(const[e,s]of Object.entries(t))for(const t of s){const s=n.items.get(t.id),l=s?.links||{};l[e]&&delete l[e]}"buff"===e.type&&!0===e.system.active&&Hooks.callAll("pf1ToggleActorBuff",n,e,!1)}})),Hooks.on("updateItem",(async(e,t,s,n)=>{if(n!==game.user.id)return;const l=e.actor;if(l){const s=t.system?.active;"buff"===e.type&&void 0!==s&&Hooks.callAll("pf1ToggleActorBuff",l,e,s)}})),Hooks.on("chatMessage",((e,t,s)=>!customRolls(t,s.speaker))),Hooks.on("renderActorDirectory",((e,t,s)=>{t.find("li.actor").each(((e,t)=>{t.addEventListener("drop",CurrencyTransfer._directoryDrop.bind(void 0,t.getAttribute("data-document-id")))}))})),Hooks.on("renderItemDirectory",((e,t,s)=>{t.find("li.item").each(((e,t)=>{t.addEventListener("drop",CurrencyTransfer._directoryDrop.bind(void 0,t.getAttribute("data-document-id")))}))})),Hooks.on("dropActorSheetData",((e,t,s)=>{"Currency"===s.type&&t._onDropCurrency(event,s)})),Hooks.once("ready",(()=>{Hooks.on("hotbarDrop",((e,t,s)=>{let n;const{type:l,uuid:c}=t;switch(l){case"Item":n=createItemMacro(c,s);break;case"action":n=createActionMacro(t.data?._id,c,s);break;case"skill":n=createSkillMacro(t.skill,c,s);break;case"save":n=createSaveMacro(t.save,c,s);break;case"defenses":case"cmb":case"concentration":case"cl":case"attack":case"abilityScore":case"initiative":case"bab":n=createMiscActorMacro(l,c,s,t);break;default:return!0}if(null==n||n instanceof Promise)return!1}))})),Hooks.on("renderTokenConfig",(async(e,t)=>{let s=e.object;s instanceof Actor&&(s=s.prototypeToken);const n=s.flags?.ffd20;let l=`<div class="form-group"><label>${game.i18n.localize("FFD20.StaticSize")}</label><input type="checkbox" name="flags.ffd20.staticSize" data-dtype="Boolean"`;n?.staticSize&&(l+=" checked"),l+="/></div>",t.find('.tab[data-tab="appearance"] > *:nth-child(3)').after(l);const c=!0===n?.customVisionRules;if(!c){const e=t.find('.tab[data-tab="vision"]');e.find("select[name='sight.visionMode']").prop("disabled",!0);const s=e.find(".tab[data-tab='detection']");s.find("input,select").prop("disabled",!0),s.find("a.action-button").unbind()}l=`<div class="form-group" data-tooltip="FFD20.CustomVisionRules.Description"><label>${game.i18n.localize("FFD20.CustomVisionRules.Label")}</label><input type="checkbox" name="flags.ffd20.customVisionRules" data-dtype="Boolean"`,c&&(l+=" checked"),l+="/></div>",t.find('.tab[data-tab="vision"]').append(l),t.find('.tab[data-tab="vision"] input[name="flags.ffd20.customVisionRules"]').on("change",(async t=>(await e._onSubmit(t,{preventClose:!0}),e.render()))),addLowLightVisionToTokenConfig(e,t),e.setPosition()})),Hooks.on("renderSidebarTab",((e,t)=>{if(e instanceof Settings){const e=$(`<button>${game.i18n.localize("FFD20.Changelog")}</button>`),s=$(`<button>${game.i18n.localize("FFD20.Help.Label")}</button>`),n=$(`<button>${game.i18n.localize("FFD20.Troubleshooter.Button")}</button>`);t.find("#game-details").after($(`<h2>${game.i18n.localize("FFD20.Title")}</h2>`),$("<div id='ffd20-details'>").append(e,s,n)),e.click((()=>{(Object.values(ui.windows).find((e=>"changelog"==e.id))??new ChangeLogWindow).render(!0,{focus:!0})})),s.click((()=>ffd20.applications.helpBrowser.openUrl("Help/Home"))),n.click((()=>ffd20.applications.Troubleshooter.open()))}})),Hooks.on("deleteCombat",((e,t,s)=>{if(game.user.id!==s)return;const n=getSkipActionPrompt(),{disableExperienceTracking:l,openXpDistributor:c}=game.settings.get("ffd20","experienceConfig");if(!l&&e.started&&(c&&!n||!c&&n)){const t=e.combatants.map((e=>e.actor)),s=new ExperienceDistributor(t);s.getCharacters().length>0?s.render(!0):s.close()}})),Hooks.on("controlToken",(()=>{canvas.perception.update({initializeLighting:!0},!0)}));{const expireFromTokens=function(){if(game.users.activeGM?.isSelf)for(const e of canvas.tokens.placeables)e.combatant?.combat?.started||e.actor?.expireActiveEffects&&e.actor.expireActiveEffects()};Hooks.on("updateWorldTime",(()=>{expireFromTokens()})),Hooks.on("canvasReady",(()=>{expireFromTokens()}))}const handleChatTooltips=function(e){const t=$(e.currentTarget),s=e.currentTarget.getBoundingClientRect(),n=s.x,l=s.y,c=s.width;t.find(".tooltipcontent").css("left",n+"px").css("top",l+"px").css("width",c+"px")};window.addEventListener("focus",(()=>ffd20.skipConfirmPrompt=!1),{passive:!0});export{ma as actionUse,oa as applications,va as canvas,Sa as components,ee as config,Ca as dice,da as documents,Ia as migrations,xa as registry,wa as utils};
//# sourceMappingURL=ffd20.js.map
