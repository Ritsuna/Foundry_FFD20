{"version":3,"file":"ffd20.js","sources":["../module/documents/chat-message.mjs","../module/utils/semver.mjs","../module/dice/roll.mjs","../module/utils/lib.mjs","../module/canvas/low-light-vision.mjs","../module/patch-core.mjs","../module/compendium-directory.mjs","../module/mce/mce.mjs","../module/utils/canvas.mjs","../module/socket.mjs","../node_modules/color-name/index.js","../node_modules/simple-swizzle/index.js","../node_modules/simple-swizzle/node_modules/is-arrayish/index.js","../node_modules/color-string/index.js","../node_modules/color-convert/conversions.js","../node_modules/color-convert/route.js","../node_modules/color-convert/index.js","../node_modules/color/index.js","../module/utils/chat.mjs","../module/dice/dice.mjs","../module/documents/actor/utils/apply-changes.mjs","../module/components/change.mjs","../module/dice/damage-roll.mjs","../module/applications/settings/health.mjs","../module/applications/settings/experience.mjs","../module/applications/settings/accessibility.mjs","../module/applications/settings/tooltip_world.mjs","../module/applications/settings/tooltip.mjs","../module/applications/tooltip.mjs","../module/documents/settings.mjs","../module/dice/d20roll.mjs","../module/components/action.mjs","../module/action-use/chat-attack.mjs","../module/action-use/action-use.mjs","../module/documents/item/item-pf.mjs","../module/documents/item/item-attack.mjs","../module/documents/item/item-buff.mjs","../module/documents/item/item-class.mjs","../module/documents/item/item-consumable.mjs","../module/documents/item/item-container.mjs","../module/documents/item/item-equipment.mjs","../module/documents/item/item-feat.mjs","../module/documents/item/item-loot.mjs","../module/documents/item/item-race.mjs","../module/utils/handlebars/templates.mjs","../module/documents/item/item-spell.mjs","../module/documents/item/item-weapon.mjs","../module/utils/links.mjs","../module/documents/actor/utils/spellbook.mjs","../module/applications/vision-permission.mjs","../module/documents/actor/actor-pf.mjs","../module/documents/macros.mjs","../module/documents/actor/actor-proxy.mjs","../module/documents/item/item-proxy.mjs","../module/config.mjs","../module/applications/compendium-browser/filters/base.mjs","../node_modules/fuzzysort/fuzzysort.js","../module/applications/compendium-browser/compendium-browser.mjs","../module/applications/trait-selector.mjs","../module/registry/base-registry.mjs","../module/registry/damage-types.mjs","../module/applications/damage-type-selector.mjs","../module/applications/damage-resistance-selector.mjs","../module/applications/actor/actor-rest.mjs","../module/applications/point-buy-calculator.mjs","../module/applications/item-picker.mjs","../module/utils/dialog.mjs","../module/applications/level-up.mjs","../module/applications/currency-transfer.mjs","../module/applications/actor/actor-sheet.mjs","../module/applications/actor/basic-sheet.mjs","../module/applications/actor/character-sheet.mjs","../module/applications/actor/npc-sheet.mjs","../module/applications/actor/npc-lite-sheet.mjs","../module/applications/actor/npc-loot-sheet.mjs","../module/applications/actor/actor-flags.mjs","../module/applications/script-editor.mjs","../module/applications/categorized-item-picker.mjs","../module/applications/item/item-sheet.mjs","../module/applications/item/container-sheet.mjs","../module/applications/component/action-sheet.mjs","../module/applications/compendium-browser/filters/checkbox.mjs","../module/applications/compendium-browser/filters/number-range.mjs","../module/applications/compendium-browser/filters/item.mjs","../module/applications/compendium-browser/filters/common.mjs","../module/applications/compendium-browser/filters/spell.mjs","../module/applications/compendium-browser/filters/feat.mjs","../module/applications/compendium-browser/filters/class.mjs","../module/applications/compendium-browser/filters/race.mjs","../module/applications/compendium-browser/filters/buff.mjs","../module/applications/compendium-browser/filters/creature.mjs","../module/applications/compendium-browser/buff-browser.mjs","../module/applications/compendium-browser/class-browser.mjs","../module/applications/compendium-browser/creature-browser.mjs","../module/applications/compendium-browser/feat-browser.mjs","../module/applications/compendium-browser/item-browser.mjs","../module/applications/compendium-browser/race-browser.mjs","../module/applications/compendium-browser/spell-browser.mjs","../module/applications/action-chooser.mjs","../module/applications/attack-dialog.mjs","../node_modules/markdown-it/lib/common/entities.js","../node_modules/uc.micro/categories/P/regex.js","../node_modules/mdurl/encode.js","../node_modules/mdurl/decode.js","../node_modules/mdurl/parse.js","../node_modules/mdurl/index.js","../node_modules/mdurl/format.js","../node_modules/uc.micro/properties/Any/regex.js","../node_modules/uc.micro/categories/Cc/regex.js","../node_modules/uc.micro/categories/Z/regex.js","../node_modules/uc.micro/index.js","../node_modules/uc.micro/categories/Cf/regex.js","../node_modules/markdown-it/lib/common/utils.js","../node_modules/markdown-it/lib/helpers/parse_link_destination.js","../node_modules/markdown-it/lib/helpers/parse_link_title.js","../node_modules/markdown-it/lib/helpers/index.js","../node_modules/markdown-it/lib/helpers/parse_link_label.js","../node_modules/markdown-it/lib/renderer.js","../node_modules/markdown-it/lib/ruler.js","../node_modules/markdown-it/lib/rules_core/normalize.js","../node_modules/markdown-it/lib/rules_core/linkify.js","../node_modules/markdown-it/lib/rules_core/replacements.js","../node_modules/markdown-it/lib/rules_core/smartquotes.js","../node_modules/markdown-it/lib/token.js","../node_modules/markdown-it/lib/rules_core/state_core.js","../node_modules/markdown-it/lib/parser_core.js","../node_modules/markdown-it/lib/rules_core/block.js","../node_modules/markdown-it/lib/rules_core/inline.js","../node_modules/markdown-it/lib/rules_core/text_join.js","../node_modules/markdown-it/lib/rules_block/table.js","../node_modules/markdown-it/lib/rules_block/blockquote.js","../node_modules/markdown-it/lib/rules_block/hr.js","../node_modules/markdown-it/lib/rules_block/list.js","../node_modules/markdown-it/lib/rules_block/reference.js","../node_modules/markdown-it/lib/common/html_re.js","../node_modules/markdown-it/lib/rules_block/html_block.js","../node_modules/markdown-it/lib/common/html_blocks.js","../node_modules/markdown-it/lib/rules_block/heading.js","../node_modules/markdown-it/lib/rules_block/state_block.js","../node_modules/markdown-it/lib/parser_block.js","../node_modules/markdown-it/lib/rules_block/code.js","../node_modules/markdown-it/lib/rules_block/fence.js","../node_modules/markdown-it/lib/rules_block/lheading.js","../node_modules/markdown-it/lib/rules_block/paragraph.js","../node_modules/markdown-it/lib/rules_inline/text.js","../node_modules/markdown-it/lib/rules_inline/escape.js","../node_modules/markdown-it/lib/rules_inline/linkify.js","../node_modules/markdown-it/lib/rules_inline/newline.js","../node_modules/markdown-it/lib/rules_inline/strikethrough.js","../node_modules/markdown-it/lib/rules_inline/emphasis.js","../node_modules/markdown-it/lib/rules_inline/link.js","../node_modules/markdown-it/lib/rules_inline/image.js","../node_modules/markdown-it/lib/rules_inline/autolink.js","../node_modules/markdown-it/lib/rules_inline/html_inline.js","../node_modules/markdown-it/lib/rules_inline/entity.js","../node_modules/markdown-it/lib/rules_inline/balance_pairs.js","../node_modules/markdown-it/lib/rules_inline/state_inline.js","../node_modules/markdown-it/lib/parser_inline.js","../node_modules/markdown-it/lib/rules_inline/backticks.js","../node_modules/markdown-it/lib/rules_inline/fragments_join.js","../node_modules/linkify-it/index.js","../node_modules/linkify-it/lib/re.js","../node_modules/punycode/punycode.es6.js","../node_modules/markdown-it/lib/presets/default.js","../node_modules/markdown-it/lib/index.js","../node_modules/markdown-it/lib/presets/zero.js","../node_modules/markdown-it/lib/presets/commonmark.js","../module/applications/change-log.mjs","../module/applications/entry-selector.mjs","../node_modules/markdown-it-anchor/dist/markdownItAnchor.mjs","../module/applications/help-browser.mjs","../module/applications/link-options.mjs","../module/applications/senses-selector.mjs","../module/applications/skill-editor.mjs","../module/applications/xp-distributor.mjs","../module/applications/sidebar/items-directory.mjs","../module/applications/troubleshooter.mjs","../module/applications/_module.mjs","../module/documents/active-effect.mjs","../module/documents/combat.mjs","../module/documents/combatant.mjs","../module/documents/controls.mjs","../module/documents/token.mjs","../module/documents/actor/actor-basic.mjs","../module/documents/actor/actor-character.mjs","../module/documents/actor/actor-npc.mjs","../module/canvas/measure.mjs","../module/canvas/attack-reach.mjs","../module/canvas/token.mjs","../module/canvas/token-quick-actions.mjs","../module/canvas/detection-modes.mjs","../module/canvas/vision-modes.mjs","../module/canvas/ability-template.mjs","../module/dice/terms/sizerollterm.mjs","../module/components/script-call.mjs","../module/components/conditionals.mjs","../module/utils/handlebars/helpers.mjs","../module/utils/roll-preprocess.mjs","../module/registry/script-call.mjs","../module/migration.mjs","../ffd20.mjs","../module/modules.mjs"],"sourcesContent":["export class ChatMessagePF extends ChatMessage {\n  /**\n   * Replaces all roll data object in a given object with {@link Roll} instances\n   *\n   * @param {object} maybeRollObject - The object to replace roll data objects with {@link Roll} instances\n   * @returns {object} The object with all roll data objects replaced with {@link Roll} instances\n   * @private\n   */\n  static _initRollObject(maybeRollObject) {\n    // If object is an array, map to roll objects\n    if (Array.isArray(maybeRollObject)) {\n      return maybeRollObject.map((o) => this._initRollObject(o));\n    }\n\n    // If this is a roll object, initialize it\n    if (maybeRollObject != null && typeof maybeRollObject === \"object\" && \"class\" in maybeRollObject) {\n      return Roll.fromData(maybeRollObject);\n    }\n\n    // If object is a regular object, recurse into it to find roll to initialise\n    if (typeof maybeRollObject === \"object\" && maybeRollObject != null) {\n      for (const [k, v] of Object.entries(maybeRollObject)) {\n        maybeRollObject[k] = this._initRollObject(v);\n      }\n    }\n    // Return object in which all roll data has been replaced by Roll instances\n    return maybeRollObject;\n  }\n\n  get isRoll() {\n    return this.type === CONST.CHAT_MESSAGE_TYPES.ROLL || this.getFlag(\"ffd20\", \"noRollRender\");\n  }\n\n  /**\n   * Linked item.\n   *\n   * @type {ItemPF|undefined|null} - Null is returned if no item is linked, undefined if item is not found, and ItemPF otherwise.\n   */\n  get itemSource() {\n    const itemId = this.flags?.ffd20?.metadata?.item;\n    if (itemId) {\n      const actor = this.constructor.getSpeakerActor(this.speaker);\n      return actor?.items.get(itemId);\n    }\n    return null;\n  }\n\n  /**\n   * @type {boolean} True if item source is defined, regardless if that item source still exists.\n   */\n  get hasItemSource() {\n    return this.flags?.ffd20?.metadata?.item !== undefined;\n  }\n\n  /**\n   * Return associated template or null.\n   *\n   * @type {MeasuredTemplatePF}\n   */\n  get measureTemplate() {\n    const templateId = this.system.flags?.ffd20?.metadata?.template;\n    if (!templateId) return null;\n    const template = canvas.templates.get(templateId);\n    return template || null;\n  }\n\n  /**\n   * @returns {TokenPF[]} The tokens which were targeted with this chat card.\n   */\n  get targets() {\n    const targetIds = this.system.flags?.ffd20?.metadata?.targets ?? [];\n    return canvas.tokens.placeables.filter((o) => targetIds.includes(o.id));\n  }\n\n  /** @inheritDoc */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    /**\n     * An object containing Pathfinder specific rolls for this chat message,\n     * with a structure grouping them by their purpose.\n     *\n     * @type {object}\n     */\n    this.systemRolls = this.constructor._initRollObject(this.flags?.ffd20?.metadata?.rolls ?? {});\n  }\n}\n\n/**\n * @typedef {object} ChatMessagePFIdentifiedInfo\n * @property {boolean} identified - True if item was identified when rolled.\n * @property {string} name - Name of the identified item.\n * @property {string} description - Description of the identified item.\n * @property {string} [actionName] - Name of the action that was used\n * @property {string} [actionDescription] - Description of the action that was used\n */\n\n// Returns a promise to the created chatMessage or false if no command was executed\nexport const customRolls = function (message, speaker, rollData) {\n  if (message.match(/^\\/(\\w+)(?: +([^#]+))(?:#(.+))?/)) {\n    const type = RegExp.$1?.toUpperCase();\n    const value = RegExp.$2;\n    const flavor = RegExp.$3;\n    const cMsg = CONFIG.ChatMessage.documentClass;\n\n    speaker = speaker ?? cMsg.getSpeaker();\n    const actor = cMsg.getSpeakerActor(speaker);\n    const scene = speaker.scene ? game.scenes.get(speaker.scene) : canvas.scene;\n    const tokenDocument = scene?.tokens.get(speaker.token);\n    const tokenUuid = tokenDocument?.uuid;\n\n    switch (type) {\n      case \"D\":\n      case \"DAMAGE\":\n      case \"H\":\n      case \"HEAL\": {\n        rollData = rollData ?? actor?.getRollData() ?? {};\n        const roll = Roll.create(value, rollData).evaluate({ async: true });\n\n        return roll.then(async (roll) => {\n          const total = roll.total;\n          const isHealing = type === \"HEAL\" || type === \"H\";\n          const content = await renderTemplate(\"systems/ffd20/templates/chat/simple-damage.hbs\", {\n            tokenId: tokenUuid,\n            isHealing,\n            css: isHealing ? \"heal\" : \"damage\",\n            roll,\n          });\n          const chatOptions = {\n            type: CONST.CHAT_MESSAGE_TYPES.ROLL,\n            roll: roll,\n            flavor,\n            sound: CONFIG.sounds.dice,\n            speaker: speaker,\n            rollMode: game.settings.get(\"core\", \"rollMode\"),\n            content: content,\n            flags: { ffd20: { subject: { health: isHealing ? \"healing\" : \"damage\" } } },\n          };\n          cMsg.create(chatOptions);\n        });\n      }\n    }\n  }\n  return false;\n};\n","export class SemanticVersion {\n  static re = /^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?)?$/\n\n  constructor() {\n    this.major = 0;\n    this.minor = 0;\n    this.patch = 0;\n    this.preRelease = \"\";\n    this.buildMetaData = \"\";\n  }\n\n  static fromString(str) {\n    if (str.match(this.re)) {\n      let result = new this();\n      result.major = parseInt(RegExp.$1);\n      result.minor = parseInt(RegExp.$2);\n      result.patch = parseInt(RegExp.$3 || 0);\n      result.preRelease = RegExp.$4 || \"\";\n      result.buildMetaData = RegExp.$5 || \"\";\n      return result;\n    }\n    return null;\n  }\n\n  toString() {\n    return `${this.major}.${this.minor}.${this.patch}`;\n  }\n\n  isHigherThan(otherVersion) {\n    if (this.major > otherVersion.major) return true;\n    if (this.major === otherVersion.major && this.minor > otherVersion.minor) return true;\n    if (this.major === otherVersion.major\n      && this.minor === otherVersion.minor\n      && this.patch > otherVersion.patch) return true;\n    return false;\n  }\n\n  isLowerThan(otherVersion) {\n    if (this.major < otherVersion.major) return true;\n    if (this.major === otherVersion.major && this.minor < otherVersion.minor) return true;\n    if (this.major === otherVersion.major\n      && this.minor === otherVersion.minor\n      && this.patch < otherVersion.patch) return true;\n    return false;\n  }\n}\n","export class RollPF extends Roll {\n  get totalHalved() {\n    return Math.floor(this.total / 2);\n  }\n\n  /**\n   * Return an Array of the individual DiceTerm instances contained within this Roll.\n   * Override to recognize dice in SizeRollTerm.\n   *\n   * @override\n   * @returns {DiceTerm[]}\n   */\n  get dice() {\n    return (\n      this.terms\n        .reduce((dice, t) => {\n          if (t instanceof DiceTerm) dice.push(t);\n          else if (t instanceof PoolTerm) dice = dice.concat(t.dice);\n          else if (t instanceof ffd20.dice.terms.SizeRollTerm) dice = dice.concat(t.dice);\n          return dice;\n        }, [])\n        // Append dice from parenthesis and similar eliminated rolls.\n        .concat(this._dice)\n    );\n  }\n\n  static safeRoll(formula, data = {}, context, options = { suppressError: false }) {\n    let roll;\n    try {\n      roll = this.create(formula, data).evaluate({ async: false });\n    } catch (err) {\n      roll = this.create(\"0\", data).evaluate({ async: false });\n      roll.err = err;\n    }\n    if (roll.warning) roll.err = Error(\"This formula had a value replaced with null.\");\n    if (roll.err) {\n      if (context && !options.suppressError) console.error(context, roll.err);\n      else if (CONFIG.debug.roll) console.error(roll.err);\n    }\n    return roll;\n  }\n\n  static safeTotal(formula, data) {\n    return isNaN(+formula) ? RollPF.safeRoll(formula, data).total : +formula;\n  }\n\n  /**\n   * @override\n   */\n  static simplifyTerms(terms) {\n    // Simplify terms by combining with pending strings\n    let simplified = terms.reduce((terms, term) => {\n      const prior = terms[terms.length - 1];\n      const isOperator = term instanceof OperatorTerm;\n\n      // Combine a non-operator term with prior StringTerm\n      if (!isOperator && prior instanceof StringTerm) {\n        prior.term += term.total;\n        foundry.utils.mergeObject(prior.options, term.options);\n        return terms;\n      }\n\n      // Attach string terms as flavor texts to numeric terms, if appropriate\n      const priorNumeric = prior instanceof NumericTerm;\n      if (prior && priorNumeric && term instanceof StringTerm && term.term.match(/\\[(.+)\\]/)) {\n        prior.options.flavor = RegExp.$1;\n        return terms;\n      }\n\n      // Attach string terms as flavor texts to size roll terms, if appropriate\n      // TODO: Review the need for this bit with Foundry v10, according to staff it will no longer be required.\n      const priorSizeRoll = prior instanceof ffd20.dice.terms.SizeRollTerm;\n      if (prior && priorSizeRoll && term instanceof StringTerm) {\n        const re = term.term.match(ffd20.dice.terms.SizeRollTerm.TRAILER_REGEXP);\n        const [match, modifiers, flavor] = re;\n        // Attach Flavor\n        if (flavor) {\n          prior.options.flavor = flavor;\n        }\n        // Attach modifiers\n        if (modifiers) {\n          prior.modifiers = Array.from((modifiers || \"\").matchAll(DiceTerm.MODIFIER_REGEXP)).map((m) => m[0]);\n        }\n        return terms;\n      }\n\n      // Combine StringTerm with a prior non-operator term\n      const priorOperator = prior instanceof OperatorTerm;\n      if (prior && !priorOperator && term instanceof StringTerm) {\n        term.term = String(prior.total) + term.term;\n        foundry.utils.mergeObject(term.options, prior.options);\n        terms[terms.length - 1] = term;\n        return terms;\n      }\n\n      // Otherwise continue\n      terms.push(term);\n      return terms;\n    }, []);\n\n    // Convert remaining String terms to a RollTerm which can be evaluated\n    simplified = simplified.map((term) => {\n      if (!(term instanceof StringTerm)) return term;\n      const t = this._classifyStringTerm(term.formula, { intermediate: false });\n      t.options = foundry.utils.mergeObject(term.options, t.options, { inplace: false });\n      return t;\n    });\n\n    // Eliminate leading or trailing arithmetic\n    if (simplified[0] instanceof OperatorTerm && simplified[0].operator !== \"-\") simplified.shift();\n    if (simplified[terms.length - 1] instanceof OperatorTerm) simplified.pop();\n    return simplified;\n  }\n\n  /**\n   * @override\n   *\n   * Split a formula by identifying its outer-most parenthetical and math terms\n   * @param {string} _formula      The raw formula to split\n   * @returns {string[]}          An array of terms, split on parenthetical terms\n   * @private\n   */\n  static _splitParentheses(_formula) {\n    return this._splitGroup(_formula, {\n      openRegexp: ParentheticalTerm.OPEN_REGEXP,\n      closeRegexp: ParentheticalTerm.CLOSE_REGEXP,\n      openSymbol: \"(\",\n      closeSymbol: \")\",\n      onClose: (group) => {\n        // Extract group arguments\n        const fn = group.open.slice(0, -1);\n        const expression = group.terms.join(\"\");\n        const options = { flavor: group.flavor ? group.flavor.slice(1, -1) : undefined };\n\n        const terms = [];\n        if (fn === \"sizeRoll\") {\n          // TODO: Make more generic\n          const args = this._splitMathArgs(expression);\n          terms.push(new ffd20.dice.terms.SizeRollTerm({ terms: args, options }));\n        } else if (fn in ffd20.utils.rollPreProcess) {\n          const fnParams = group.terms\n            // .slice(2, -1)\n            .reduce((cur, s) => {\n              cur.push(...s.split(/\\s*,\\s*/));\n              return cur;\n            }, [])\n            .map((o) => {\n              // Return raw string\n              if ((o.startsWith('\"') && o.endsWith('\"')) || (o.startsWith(\"'\") && o.endsWith(\"'\"))) {\n                return o.slice(1, -1);\n              }\n              // Return raw string without quotes\n              if (o.match(/^[a-zA-Z0-9]+$/)) {\n                return parseRollStringVariable(o);\n              }\n              // Return roll result\n              return RollPF.safeRoll(o, this.data).total;\n            });\n\n          return ffd20.utils.rollPreProcess[fn](...fnParams);\n        } else if (fn in Math) {\n          const args = this._splitMathArgs(expression);\n          terms.push(new MathTerm({ fn, terms: args, options }));\n        } else {\n          if (fn) terms.push(new StringTerm({ term: fn }));\n          terms.push(new ParentheticalTerm({ term: expression, options }));\n        }\n        return terms;\n      },\n    });\n  }\n\n  static cleanFlavor(flavor) {\n    return flavor.replace(/\\[\\];/g, \"\");\n  }\n\n  /**\n   * Render the tooltip HTML for a RollPF instance\n   *\n   * @returns {Promise<string>} The rendered HTML tooltip as a string\n   */\n  async getTooltip() {\n    const parts = this.dice.map((d) => d.getTooltipData());\n    const numericParts = this.terms.reduce((cur, t, idx, arr) => {\n      const result = t instanceof NumericTerm ? t.getTooltipData() : undefined;\n\n      const prior = arr[idx - 1];\n      if (t instanceof NumericTerm && prior && prior instanceof OperatorTerm && prior.operator === \"-\") {\n        result.total = -result.total;\n      }\n\n      if (result !== undefined) {\n        if (!result.flavor) result.flavor = game.i18n.localize(\"FFD20.Undefined\");\n        cur.push(result);\n      }\n      return cur;\n    }, []);\n    return renderTemplate(\"systems/ffd20/templates/dice/tooltip.hbs\", { parts, numericParts });\n  }\n}\n\nexport const parseRollStringVariable = function (value) {\n  if (value === \"false\") return false;\n  if (value === \"true\") return true;\n  if (value === \"null\") return null;\n  if (value === \"undefined\") return undefined;\n\n  if (value.match(/^(?:[0-9]+)?(?:\\.[0-9]+)?$/)) {\n    return parseFloat(value);\n  }\n  return value;\n};\n","import { SemanticVersion } from \"./semver.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\n\n/**\n * Creates a tag from a string.\n * For example, if you input the string \"Wizard of Oz 2\", you will get \"wizardOfOz2\"\n *\n * @param str\n */\nexport const createTag = function (str) {\n  if (str.length === 0) str = \"tag\";\n  return str\n    .replace(/[^a-zA-Z0-9\\s]/g, \"\")\n    .split(/\\s+/)\n    .map((s, a) => {\n      s = s.toLowerCase();\n      if (a > 0) s = s.substring(0, 1).toUpperCase() + s.substring(1);\n      return s;\n    })\n    .join(\"\");\n};\n\n/**\n * Alters a roll in string form.\n *\n * @param str\n * @param add\n * @param multiply\n */\nexport const alterRoll = function (str, add, multiply) {\n  const rgx = /^([0-9]+)d([0-9]+)/;\n  // const rgx = new RegExp(Die.rgx.die, \"g\");\n  // if (str.match(/^([0-9]+)d([0-9]+)/)) {\n  return str.replace(rgx, (match, nd, d, mods) => {\n    nd = nd * (multiply || 1) + (add || 0);\n    mods = mods || \"\";\n    return (nd == null || Number.isNaN(nd) ? \"\" : nd) + \"d\" + d + mods;\n  });\n  // }\n};\n\n/**\n * @param {string} version - A version string to unpack. Must be something like '0.5.1'.\n * @returns {object} An object containing the keys 'release', 'major', and 'minor', which are numbers.\n */\nexport const unpackVersion = function (version) {\n  if (version.match(/^([0-9]+)\\.([0-9]+)(?:\\.([0-9]+))?$/)) {\n    return {\n      release: parseInt(RegExp.$1),\n      major: parseInt(RegExp.$2),\n      minor: parseInt(RegExp.$3) || null,\n    };\n  }\n};\n\n/**\n * @param {string} version - The minimum core version to compare to. Must be something like '0.5.1'.\n * @returns {boolean} Whether the current core version is at least the given version.\n */\nexport const isMinimumCoreVersion = function (version) {\n  // TODO: Remove after 0.8.X\n  const coreVersion = SemanticVersion.fromString(game.version);\n  const compareVersion = SemanticVersion.fromString(version);\n\n  return !coreVersion.isLowerThan(compareVersion);\n};\n\nexport const degtorad = function (degrees) {\n  return (degrees * Math.PI) / 180;\n};\n\nexport const radtodeg = function (radians) {\n  return (radians / 180) * Math.PI;\n};\n\n/**\n * @param {object} item Item data\n * @returns {User|null}\n */\nexport const getItemOwner = function (item) {\n  if (item.actor) return item.actor;\n  if (item.id) return game.actors.find((o) => o.items.get(item.id));\n  return null;\n};\n\n/**\n * Turn some fractional numbers into pretty strings.\n *\n * @param {number} v\n * @returns {string|undefined}\n */\nexport const fractionalToString = (v) => {\n  const base = Math.floor(v);\n  const f = Math.roundDecimals(v - base, 3);\n  if (f === 0) return `${base}`;\n  const rv = [];\n  if (base !== 0) rv.push(base);\n  if (f === 0.25) rv.push(\"1/4\");\n  else if (f === 0.333) rv.push(\"1/3\");\n  else if (f === 0.5) rv.push(\"1/2\");\n  else if (f === 0.667) rv.push(\"2/3\");\n  else if (f === 0.75) rv.push(\"3/4\");\n  return rv.join(\" \");\n};\n\nexport const CR = {\n  fromString(value) {\n    if (value === \"1/8\") return 0.125;\n    if (value === \"1/6\") return 0.1625;\n    if (value === \"1/4\") return 0.25;\n    if (value === \"1/3\") return 0.3375;\n    if (value === \"1/2\") return 0.5;\n    return parseFloat(value);\n  },\n\n  fromNumber(value) {\n    if (value === 0.125) return \"1/8\";\n    if (value === 0.1625) return \"1/6\";\n    if (value === 0.25) return \"1/4\";\n    if (value === 0.3375) return \"1/3\";\n    if (value === 0.5) return \"1/2\";\n    if (!Number.isNumeric(value)) return \"0\";\n    return value.toString();\n  },\n};\n\nexport const getActorFromId = function (id) {\n  const speaker = ChatMessage.getSpeaker();\n  let actor = null;\n  if (id) {\n    actor = game.actors.tokens[id];\n    if (!actor) actor = game.actors.get(id);\n  }\n  if (speaker.token && !actor) actor = game.actors.tokens[speaker.token];\n  if (!actor) actor = game.actors.get(speaker.actor);\n  return actor;\n};\n\n/**\n * Converts feet to what the world is using as a measurement unit.\n *\n * @param {number} value - The value (in feet) to convert.\n * @param {string} type - The original type to convert from. Either 'ft' (feet, default) or 'mi' (miles, in which case the result is in km (metric))\n * @returns {Array.<number, string>} An array containing the converted value in index 0 and the new unit key in index 1 (for use in FFD20.measureUnits, for example)\n */\nexport const convertDistance = function (value, type = \"ft\") {\n  const system = getDistanceSystem();\n  switch (system) {\n    case \"metric\":\n      switch (type) {\n        case \"mi\":\n          return [Math.round(value * 1.6 * 100) / 100, \"km\"];\n        default:\n          return [Math.round((value / 5) * 1.5 * 100) / 100, \"m\"];\n      }\n    default:\n      return [value, type];\n  }\n};\n\n/**\n * Converts what the world is using as a measurement unit to feet.\n *\n * @param {number} value - The value (in the world's measurement unit) to convert back.\n * @param {string} type - The target type to convert back to. Either 'ft' (feet, default) or 'mi' (miles, in which case the expected given value should be in km (metric))\n * @returns {number} The resulting value.\n */\nexport const convertDistanceBack = function (value, type = \"ft\") {\n  const system = getDistanceSystem();\n  switch (system) {\n    case \"metric\":\n      switch (type) {\n        case \"mi\":\n          return [Math.round((value / 1.6) * 100) / 100, \"mi\"];\n        default:\n          return [Math.round(((value * 5) / 1.5) * 100) / 100, \"ft\"];\n      }\n    default:\n      return [value, type];\n  }\n};\n\n/**\n * @returns {\"metric\"|\"imperial\"} Effective system of units\n */\nexport const getDistanceSystem = () => {\n  let system = game.settings.get(\"ffd20\", \"distanceUnits\"); // override\n  if (system === \"default\") system = game.settings.get(\"ffd20\", \"units\");\n  return system;\n};\n\n/**\n * @returns {\"metric\"|\"imperial\"} Effective system of units\n */\nexport const getWeightSystem = () => {\n  let system = game.settings.get(\"ffd20\", \"weightUnits\"); // override\n  if (system === \"default\") system = game.settings.get(\"ffd20\", \"units\");\n  return system;\n};\n\n/**\n * @typedef Point\n * @property {number} x X coordinate\n * @param {number} y Y coordinate\n */\n\n/**\n * @typedef MeasureState\n * @param {number} diagonals Number of diagonals passed so far.\n * @param {number} cells Total cells in distance\n */\n\n/**\n * Measure distance between two points.\n *\n * @param {Point} p0 Start point on canvas\n * @param {Point} p1 End point on canvas\n * @param {object} options Measuring options.\n * @param {boolean} options.altReach Use alternate reach weapon diagonal rule at 10 ft range.\n * @param {\"5105\"|\"555\"} options.diagonalRule Used diagonal rule. Defaults to 5/10/5 PF measuring.\n * @param {Ray} options.ray Pre-generated ray to use instead of the points.\n * @param {MeasureState} options.state Optional state tracking across multiple measures.\n * @returns {number} Grid distance between the two points.\n */\nexport const measureDistance = function (\n  p0,\n  p1,\n  { ray = null, diagonalRule = \"5105\", state = { diagonals: 0, cells: 0 } } = {}\n) {\n  // TODO: Optionally adjust start and end point to closest grid\n  ray ??= new Ray(p0, p1);\n  const gs = canvas.dimensions.size,\n    nx = Math.ceil(Math.abs(ray.dx / gs)),\n    ny = Math.ceil(Math.abs(ray.dy / gs));\n\n  // Get the number of straight and diagonal moves\n  const nDiagonal = Math.min(nx, ny),\n    nStraight = Math.abs(ny - nx);\n\n  state.diagonals += nDiagonal;\n\n  let cells = 0;\n  // Standard Pathfinder diagonals: double distance for every odd.\n  if (diagonalRule === \"5105\") {\n    const nd10 = Math.floor(state.diagonals / 2) - Math.floor((state.diagonals - nDiagonal) / 2);\n    cells = nd10 * 2 + (nDiagonal - nd10) + nStraight;\n  }\n  // Equal distance diagonals\n  else cells = nStraight + nDiagonal;\n\n  state.cells += cells;\n  return cells * canvas.dimensions.distance;\n};\n\n/**\n * Converts lbs to what the world is using as a measurement unit.\n *\n * @param {number} value - The value (in lbs) to convert.\n * @returns {number} The converted value. In the case of the metric system, converts to kg.\n */\nexport const convertWeight = function (value) {\n  const system = getWeightSystem();\n  switch (system) {\n    case \"metric\":\n      // 1 kg is not exactly 2 lb but this conversion is officially used by Paizo/BBE\n      return value / 2;\n    default:\n      return value;\n  }\n};\n\n/**\n * Converts back to lbs from what the world is using as a measurement unit.\n *\n * @param {number} value - The value to convert back to lbs.\n * @returns {number} The converted value. In the case of the metric system, converts from kg.\n */\nexport const convertWeightBack = function (value) {\n  const system = getWeightSystem();\n  switch (system) {\n    case \"metric\":\n      return value * 2; // 1 kg is not exactly 2 lb but this conversion is officially used by Paizo/BBE\n    default:\n      return value;\n  }\n};\n\n/**\n * Like Foundry's default expandObject function, except it can make arrays\n *\n * @param obj\n * @param options\n * @param _d\n */\nexport const expandObjectExt = function (obj, options = { makeArrays: true }, _d = 0) {\n  const setPropertyExt = function (object, key, value) {\n    let target = object;\n    let changed = false;\n\n    // Convert the key to an object reference if it contains dot notation\n    if (key.indexOf(\".\") !== -1) {\n      const parts = key.split(\".\");\n      key = parts.pop();\n      target = parts.reduce((o, i, a) => {\n        const nextKey = parts.length > a ? parts[a + 1] : null;\n        if (!Object.prototype.hasOwnProperty.call(o, i)) {\n          if (((nextKey && nextKey.match(/^[0-9]+$/)) || (!nextKey && key.match(/^[0-9]+$/))) && options.makeArrays)\n            o[i] = [];\n          else o[i] = {};\n        }\n        return o[i];\n      }, object);\n    }\n\n    // Update the target\n    if (target[key] !== value) {\n      changed = true;\n      target[key] = value;\n    }\n\n    // Return changed status\n    return changed;\n  };\n\n  const expanded = {};\n  if (_d > 10) throw new Error(\"Maximum depth exceeded\");\n  for (let [k, v] of Object.entries(obj)) {\n    if (v instanceof Object && !Array.isArray(v)) {\n      v = expandObjectExt(v, options, _d + 1);\n    }\n    setPropertyExt(expanded, k, v);\n  }\n  return expanded;\n};\n\nexport const mergeObjectExt = function (\n  original,\n  other = {},\n  {\n    insertKeys = true,\n    insertValues = true,\n    overwrite = true,\n    inplace = true,\n    enforceTypes = false,\n    makeArrays = true,\n  } = {},\n  _d = 0\n) {\n  other = other || {};\n  if (!(original instanceof Object) || !(other instanceof Object)) {\n    throw new Error(\"One of original or other are not Objects!\");\n  }\n  const depth = _d + 1;\n\n  // Maybe copy the original data at depth 0\n  if (!inplace && _d === 0) original = duplicate(original);\n\n  // Enforce object expansion at depth 0\n  if (_d === 0 && Object.keys(original).some((k) => /\\./.test(k)))\n    original = expandObjectExt(original, { makeArrays: makeArrays });\n  if (_d === 0 && Object.keys(other).some((k) => /\\./.test(k))) other = expandObject(other, { makeArrays: makeArrays });\n\n  // Iterate over the other object\n  for (let [k, v] of Object.entries(other)) {\n    const tv = getType(v);\n\n    // Prepare to delete\n    let toDelete = false;\n    if (k.startsWith(\"-=\")) {\n      k = k.slice(2);\n      toDelete = v === null;\n    }\n\n    // Get the existing object\n    let x = original[k];\n    let has = Object.prototype.hasOwnProperty.call(original, k);\n    let tx = getType(x);\n\n    // Ensure that inner objects exist\n    if (!has && tv === \"Object\") {\n      x = original[k] = {};\n      has = true;\n      tx = \"Object\";\n    }\n\n    // Case 1 - Key exists\n    if (has) {\n      // 1.1 - Recursively merge an inner object\n      if (tv === \"Object\" && tx === \"Object\") {\n        mergeObjectExt(\n          x,\n          v,\n          {\n            insertKeys: insertKeys,\n            insertValues: insertValues,\n            overwrite: overwrite,\n            inplace: true,\n            enforceTypes: enforceTypes,\n            makeArrays: makeArrays,\n          },\n          depth\n        );\n      }\n\n      // 1.2 - Remove an existing key\n      else if (toDelete) {\n        delete original[k];\n      }\n\n      // 1.3 - Overwrite existing value\n      else if (overwrite) {\n        if (tx && tv !== tx && enforceTypes) {\n          throw new Error(`Mismatched data types encountered during object merge.`);\n        }\n        original[k] = v;\n      }\n\n      // 1.4 - Insert new value\n      else if (x === undefined && insertValues) {\n        original[k] = v;\n      }\n    }\n\n    // Case 2 - Key does not exist\n    else if (!toDelete) {\n      const canInsert = (depth === 1 && insertKeys) || (depth > 1 && insertValues);\n      if (canInsert) original[k] = v;\n    }\n  }\n\n  // Return the object for use\n  return original;\n};\n\n/**\n * Sort an array using a language-aware comparison function that can sort by a property key.\n * If no property key is provided, the array is sorted directly.\n *\n * @template T\n * @param {T[]} arr The array to sort\n * @param {string} [propertyKey=\"\"] The property key to sort by, if any; can be a dot-separated path\n * @param {object} [sortOptions] - Options affecting the sorting of elements\n * @param {boolean} sortOptions.numeric - Whether numeric collation should be used, such that \"1\" < \"2\" < \"10\".\n * @param {boolean} sortOptions.ignorePunctuation - Whether punctuation should be ignored.\n * @returns {T[]} The sorted array\n */\nexport const naturalSort = function (arr, propertyKey = \"\", { numeric = true, ignorePunctuation = false } = {}) {\n  const collator = new Intl.Collator(game.settings.get(\"core\", \"language\"), { numeric, ignorePunctuation });\n  return arr.sort((a, b) => {\n    const propA = propertyKey ? (propertyKey in a ? a[propertyKey] : getProperty(a, propertyKey)) : a;\n    const propB = propertyKey ? (propertyKey in b ? b[propertyKey] : getProperty(b, propertyKey)) : b;\n    return collator.compare(propA, propB);\n  });\n};\n\nexport const createConsumableSpellDialog = async function (itemData, { allowSpell = true } = {}) {\n  const [sl, cl] = CONFIG.Item.documentClasses.spell.getMinimumCasterLevelBySpellData(itemData);\n  const content = await renderTemplate(\"systems/ffd20/templates/internal/create-consumable.hbs\", {\n    name: itemData.name,\n    sl,\n    cl,\n    isGM: game.user.isGM,\n  });\n\n  const getFormData = (html) => {\n    const formData = expandObject(new FormDataExtended(html.querySelector(\"form\")).object);\n    itemData.sl = formData.sl ?? 1;\n    itemData.cl = formData.cl ?? 1;\n    itemData.identified = formData.identified;\n    itemData.unidentifiedName = formData.unidentifiedName;\n    // NaN check here to allow SL 0\n    if (Number.isNaN(itemData.sl)) itemData.sl = 1;\n    return itemData;\n  };\n\n  const buttons = {\n    potion: {\n      icon: '<i class=\"fas fa-prescription-bottle\"></i>',\n      label: game.i18n.localize(\"FFD20.CreateItemPotion\"),\n      callback: (html) => createConsumableSpell(getFormData(html), \"potion\"),\n    },\n    scroll: {\n      icon: '<i class=\"fas fa-scroll\"></i>',\n      label: game.i18n.localize(\"FFD20.CreateItemScroll\"),\n      callback: (html) => createConsumableSpell(getFormData(html), \"scroll\"),\n    },\n    wand: {\n      icon: '<i class=\"fas fa-magic\"></i>',\n      label: game.i18n.localize(\"FFD20.CreateItemWand\"),\n      callback: (html) => createConsumableSpell(getFormData(html), \"wand\"),\n    },\n    spell: {\n      icon: '<i class=\"fas fa-hand-sparkles\"></i>',\n      label: game.i18n.localize(\"FFD20.ItemTypeSpell\"),\n      callback: () => \"spell\",\n    },\n  };\n\n  if (!allowSpell) delete buttons.spell;\n\n  return Dialog.wait(\n    {\n      title: game.i18n.format(\"FFD20.CreateItemForSpell\", { name: itemData.name }),\n      content,\n      itemData,\n      buttons,\n      close: () => false,\n      default: \"potion\",\n    },\n    {\n      classes: [\"dialog\", \"ffd20\", \"create-consumable\"],\n      jQuery: false,\n    }\n  );\n};\n\nexport const createConsumableSpell = async function (itemData, type) {\n  const data = await CONFIG.Item.documentClasses.spell.toConsumable(itemData, type);\n\n  if (data._id) delete data._id;\n  return data;\n};\n\n/**\n * Adjusts a string to a number, allowing relative adjustments.\n *\n * @param {number} initialValue - The initial number to use for relative operations.\n * @param {string} cmdStr - The exact string inputted by the user.\n * @param {number} [maxValue=null] - The maximum allowed value for this variable.\n * @param {number} [clearValue=null] - What to change the variable to if the user simply erased the value.\n * @returns {number} The resulting new value.\n */\nexport const adjustNumberByStringCommand = function (initialValue, cmdStr, maxValue = null, clearValue = null) {\n  let result = initialValue;\n\n  if (cmdStr.match(/(=)?([+-]+)?(\\d+)/)) {\n    const operator = RegExp.$2;\n    const isAbsolute = RegExp.$1 == \"=\" || [\"--\", \"++\"].includes(operator) || (!RegExp.$1 && !RegExp.$2);\n    const isNegative = [\"-\", \"--\"].includes(operator);\n    const rawValue = parseInt(RegExp.$3, 10);\n    const value = isNegative ? -rawValue : rawValue;\n    result = isAbsolute ? value : initialValue + value;\n  } else if (cmdStr === \"\" && clearValue != null) {\n    result = clearValue;\n  } else {\n    result = parseFloat(cmdStr || \"0\");\n  }\n\n  if (maxValue) result = Math.min(result, maxValue);\n  if (Number.isNaN(result)) result = initialValue;\n\n  return result;\n};\n\nexport const colorToInt = function (color) {\n  const rgb = color.rgb().color;\n  const integer =\n    ((Math.round(rgb[0]) & 0xff) << 16) + ((Math.round(rgb[1]) & 0xff) << 8) + (Math.round(rgb[2]) & 0xff);\n\n  return integer;\n};\n\n/**\n * @typedef {object} BuffTargetItem\n * @property {string} [label] - The buff target's label.\n * @property {string} category - The buff target's category.\n * @property {string} [icon] - The URL to an icon.\n */\n/**\n * Assembles an array of all possible buff targets.\n *\n * @param {ActorPF} [actor] - An actor for which to specifically get buff targets.\n * @param {string} [type] - Can be set to \"contextNotes\" to get context notes instead.\n * @returns {Object<string, BuffTargetItem>} The resulting array of buff targets.\n */\nexport const getBuffTargets = function (actor, type = \"buffs\") {\n  const buffTargets = duplicate(\n    {\n      buffs: ffd20.config.buffTargets,\n      contextNotes: ffd20.config.contextNoteTargets,\n    }[type]\n  );\n\n  // Append individual skills to buff targets\n  if (actor) {\n    for (const s of actor._skillTargets) {\n      const sId = s.split(\".\").slice(1).join(\".\");\n      const skill = actor.getSkillInfo(sId);\n      buffTargets[s] = { label: skill.name, category: \"skill\" };\n    }\n  } else {\n    for (const [k, v] of Object.entries(ffd20.config.skills)) {\n      buffTargets[`skill.${k}`] = { label: v, category: \"skill\" };\n    }\n  }\n\n  return buffTargets;\n};\n\n/**\n * @typedef {object} BuffTargetCategory\n * @property {string} label - The category's label.\n */\n/**\n * Assembles an array of buff targets and their categories, ready to be inserted into a Widget_CategorizedItemPicker.\n *\n * @param {ActorPF} [actor] - An actor for which to specifically get buff targets.\n * @param {string} [type] - Can be set to \"contextNotes\" to get context notes instead.\n * @returns {Widget_CategorizedItemPicker~Category[]}\n */\nexport const getBuffTargetDictionary = function (actor, type = \"buffs\") {\n  const buffTargets = getBuffTargets(actor, type);\n\n  // Assemble initial categories and items\n  const targetCategories = duplicate(\n    {\n      buffs: ffd20.config.buffTargetCategories,\n      contextNotes: ffd20.config.contextNoteCategories,\n    }[type]\n  );\n  let categories = Object.entries(buffTargets).reduce((cur, o) => {\n    const key = o[0];\n    const label = o[1].label;\n    const category = o[1].category;\n    const icon = o[1].icon;\n\n    if (!key.startsWith(\"~\")) {\n      cur[category] = cur[category] || {\n        label: targetCategories[category].label,\n        items: [],\n      };\n      cur[category].items.push({ key, label, icon });\n    }\n    return cur;\n  }, {});\n\n  // Turn result into a usable format, and sort\n  categories = Object.entries(categories).reduce((cur, o) => {\n    const key = o[0];\n    const label = o[1].label;\n    const items = o[1].items;\n    cur.push({ key, label, items });\n    return cur;\n  }, []);\n  categories = naturalSort(categories, \"label\");\n\n  // Return result\n  return categories;\n};\n\n/**\n * A locale-safe insertion sort of an Array of Objects, not in place. Ignores punctuation and capitalization.\n * `name` properties in objects will be lowercased.\n *\n * @template T\n * @param {Array.<T & {name: string}>} inputArr - Array to be sorted. Each element must have a name property set\n * @returns {T[]} - New sorted Array\n */\nexport const sortArrayByName = function (inputArr) {\n  inputArr = foundry.utils.deepClone(inputArr);\n  for (const elem of inputArr) {\n    elem.name = elem.name.toLocaleLowerCase();\n  }\n  return naturalSort(inputArr, \"name\", { numeric: true, ignorePunctuation: true });\n};\n\n/**\n * A simple binary search to be used on sorted arrays\n *\n * @template T\n * @param {T[]} searchArr - Sorted Array to be searched\n * @param {T} el - Element to be compared to array values\n * @param {function(T, T): number} compare_fn - Comparison function to be apply el to every element in ar. Should return an positive/ negative integer or 0 if matching.\n * @returns {number} Index where search is found or negative index indicating where it would be inserted\n */\nexport const binarySearch = function (searchArr, el, compare_fn) {\n  let m = 0,\n    n = searchArr.length - 1;\n  while (m <= n) {\n    const k = (n + m) >> 1,\n      cmp = compare_fn(el, searchArr[k]);\n    if (cmp > 0) {\n      m = k + 1;\n    } else if (cmp < 0) {\n      n = k - 1;\n    } else {\n      return k;\n    }\n  }\n  return -m - 1;\n};\n\n/**\n * Generate permutations of an array. Complexity is O(n!).\n * Should be safe up to 7, though you should probably consider something else if you're reaching that high often.\n *\n * @template T\n * @param {T[]} perm - The Array to be generated upon\n * @returns {Array.<T[]>|false} An Array containing all Array permutations or false if failed.\n */\nfunction uniquePermutations(perm) {\n  const total = new Set();\n  if (perm.length > 7) {\n    console.warn(\"Array too large. Not attempting.\", perm);\n    return false;\n  }\n\n  for (let i = 0; i < perm.length; i = i + 1) {\n    const rest = uniquePermutations(perm.slice(0, i).concat(perm.slice(i + 1)));\n\n    if (!rest.length) {\n      total.add([perm[i]]);\n    } else {\n      for (let j = 0; j < rest.length; j = j + 1) {\n        total.add([perm[i]].concat(rest[j]));\n      }\n    }\n  }\n  return [...total];\n}\n\n/**\n * Searches through compendia quickly using the system generated index caches.\n * Exact matches excluding punctuation and case are prioritized before searching word order permutations.\n *\n * @param {string} searchTerm - The name of the Document being searched for\n * @param {object} [options] - Provides a filter to limit search to specific packs or Document types\n * @param {string[]} [options.packs] - An array of packs to search in\n * @param {\"Actor\"|\"Item\"|\"Scene\"|\"JournalEntry\"|\"Macro\"|\"RollTable\"|\"Playlist\"} [options.type] - A Document type to limit which packs are searched in\n * @returns {{pack: CompendiumCollection, index: object}|undefined} The index and pack containing it or undefined if no match is found\n */\nexport const findInCompendia = function (searchTerm, options = { packs: [], type: undefined }) {\n  let packs;\n  if (options?.packs && options.packs.length) packs = options.packs.flatMap((o) => game.packs.get(o) ?? []);\n  else packs = game.packs.filter((o) => !options?.type || o.metadata.type == options.type);\n\n  searchTerm = searchTerm.toLocaleLowerCase();\n  let found, foundDoc, foundPack;\n  for (const pack of packs) {\n    if (!pack.fuzzyIndex) pack.fuzzyIndex = sortArrayByName([...pack.index]);\n    found = binarySearch(pack.fuzzyIndex, searchTerm, (sp, it) =>\n      sp.localeCompare(it.name, undefined, { ignorePunctuation: true })\n    );\n    if (found > -1) {\n      foundDoc = pack.index.get(pack.fuzzyIndex[found]._id);\n      foundPack = pack;\n      break;\n    }\n  }\n  if (foundDoc) return { pack: foundPack, index: foundDoc };\n\n  let searchMutations = uniquePermutations(searchTerm.split(/[ _-]/));\n  if (searchMutations) searchMutations = searchMutations.map((o) => o.join(\" \"));\n  else {\n    // If array is too long, search for just a reversed version and one that pivots around commas/ semicolons\n    searchMutations = [null];\n    searchMutations.push(searchTerm.split(/[ _-]/).reverse().join(\" \"));\n    searchMutations.push(\n      searchTerm\n        .split(/[,;] ?/)\n        .reverse()\n        .flatMap((o) => o.split(\" \"))\n        .join(\" \")\n    );\n  }\n\n  for (const pack of packs) {\n    // Skip first mutation since it is already searched for manually before computing mutations\n    for (let mut = 1; mut < searchMutations.length; mut++) {\n      found = binarySearch(pack.fuzzyIndex, searchMutations[mut], (sp, it) =>\n        sp.localeCompare(it.name, undefined, { ignorePunctuation: true })\n      );\n      if (found > -1) {\n        foundDoc = pack.index.get(pack.fuzzyIndex[found]._id);\n        foundPack = pack;\n        break;\n      }\n    }\n    if (foundDoc) break;\n  }\n\n  if (foundDoc) return { pack: foundPack, index: foundDoc };\n  return false;\n};\n\n/**\n * Removes flairs from a formula.\n *\n * @param {string} formula Formula\n * @returns {string} Stripped formula\n */\nexport const stripRollFlairs = (formula) => formula.replace(/\\[[^\\]]*]/g, \"\");\n\n/**\n * Simplifies formula to very basic level.\n *\n * @param {string} formula Roll formula\n * @param {object} rollData Roll data\n * @param {object} [options={}] Additional options\n * @param {boolean} [options.combine=true] Combine terms\n * @returns {string} Simplified formula\n */\nexport function simplifyFormula(formula, rollData = {}, { combine = true } = {}) {\n  const originalTerms = RollPF.parse(stripRollFlairs(formula), rollData);\n\n  const semiEvalTerms = [];\n  // Resolve sizeRoll() and some other deterministic pieces\n  while (originalTerms.length) {\n    const term = originalTerms.shift();\n\n    if (term instanceof DiceTerm) {\n      semiEvalTerms.push(term);\n    } else if (term instanceof OperatorTerm) {\n      // Combine terms resulting in a boolean\n      if ([\">=\", \">\", \"<=\", \"<\", \"==\", \"===\", \"!=\", \"!==\", \"||\", \"&&\", \"??\"].includes(term.operator)) {\n        const left = semiEvalTerms.pop();\n        const right = originalTerms.shift();\n        const terms = [left, term, right];\n        const roll = RollPF.fromTerms(terms);\n        roll.evaluate({ async: false });\n        semiEvalTerms.push(new NumericTerm({ number: roll.total }));\n      } else {\n        semiEvalTerms.push(term);\n      }\n    } else if (term instanceof CONFIG.Dice.termTypes.SizeRollTerm) {\n      term.evaluate({ async: false });\n      semiEvalTerms.push(term);\n    } else if (term.isDeterministic) {\n      const evl = RollPF.safeTotal(term.formula);\n      semiEvalTerms.push(...RollPF.parse(`${evl}`));\n    } else {\n      semiEvalTerms.push(term);\n    }\n  }\n\n  // Combine simple terms (e.g. 5+3) and resolve ternaries\n  const combinedTerms = [];\n  let prev, term;\n  while (semiEvalTerms.length) {\n    prev = term;\n    term = semiEvalTerms.shift();\n    const next = semiEvalTerms[0];\n    if (term instanceof OperatorTerm) {\n      // Ternary handling\n      if (term.operator === \"?\") {\n        semiEvalTerms.shift(); // remove if-true val\n        const elseOp = semiEvalTerms.shift();\n        const falseVal = semiEvalTerms.shift();\n\n        const condition = RollPF.safeTotal(prev.formula);\n        let resulting = condition ? next.formula : falseVal?.formula ?? \"\";\n        combinedTerms.pop(); // Remove last term\n        if (resulting) {\n          // Unparenthetical\n          if (/^\\((.*)\\)$/.test(resulting)) {\n            resulting = resulting.slice(1, -1);\n          }\n          const subterms = RollPF.parse(resulting);\n          combinedTerms.push(...subterms);\n        }\n        continue;\n      } else if (prev instanceof NumericTerm && next instanceof NumericTerm) {\n        if (combine) {\n          const simpler = RollPF.safeEval([prev.formula, term.formula, next.formula].join(\"\"));\n          term = RollPF.parse(`${simpler}`)[0];\n          combinedTerms.pop(); // Remove the last numeric term\n          semiEvalTerms.shift(); // Remove the next term\n        }\n      }\n    }\n    combinedTerms.push(term);\n  }\n\n  return combinedTerms.map((tt) => tt.formula).join(\"\");\n}\n\n/**\n * Variant of TextEditor._createInlineRoll for creating unrolled inline rolls.\n *\n * Synchronized with Foundry VTT v10.291\n *\n * {@inheritDoc TextEditor._createInlineRoll\n *\n * @param match\n * @param rollData\n * @param options\n */\nexport function createInlineFormula(match, rollData, options) {\n  let [command, formula, closing, label] = match.slice(1, 5);\n  const isDeferred = !!command;\n  let roll;\n\n  const cls = [\"inline-preroll\", \"inline-formula\"];\n\n  // Handle the possibility of closing brackets\n  if (closing.length === 3) formula += \"]\";\n\n  // Extract roll data as a parsed chat command\n  const chatCommand = `${command}${formula}`;\n  let parsedCommand = null;\n  try {\n    parsedCommand = ChatLog.parse(chatCommand);\n  } catch (err) {\n    console.error(\"Failed to parse formula:\", chatCommand, err);\n    return null;\n  }\n  const [cmd, matches] = parsedCommand;\n  const [raw, rollType, fml, flv] = matches;\n  // TODO: Prettify display of commands like: /d 3d6\n\n  const a = document.createElement(\"a\");\n\n  // Set roll data\n  if (cmd) {\n    cls.push(cmd);\n    a.dataset.mode = cmd;\n  }\n  a.dataset.flavor = flv?.trim() ?? label ?? \"\";\n  formula = Roll.defaultImplementation.replaceFormulaData(formula.trim(), rollData || {});\n  try {\n    formula = simplifyFormula(formula);\n  } catch (err) {\n    console.error(err);\n    return null;\n  }\n  a.dataset.formula = formula;\n\n  a.classList.add(...cls);\n\n  a.dataset.tooltip = formula;\n  label = label ? `${label}: ${formula}` : formula;\n  a.innerHTML = `<i class=\"fas fa-dice-d20\"></i> ${label}`;\n\n  return a;\n}\n\n/**\n * enrichHTML but with inline rolls not rolled\n *\n * {@inheritDoc TextEditor.enrichHTML}\n *\n * @param {string} content HTML content in string format to be enriched.\n * @param {options} [options] Additional options passed to enrichHTML\n * @param {object} [options.rollData] Roll data object\n * @param {boolean} [options.secrets] Display secrets\n * @param {boolean} [options.rolls=false] Roll inline rolls. If false, the roll formula is shown instead as if /r had been used.\n * @param {boolean} [options.documents] Parse content links\n *\n * Synchronized with Foundry VTT v10.291\n */\nexport function enrichHTMLUnrolled(content, { rollData, secrets, rolls = false, documents } = {}) {\n  let pcontent = TextEditor.enrichHTML(content, { secrets, rolls, documents, rollData, async: false });\n\n  if (!rolls) {\n    const html = document.createElement(\"div\");\n    html.innerHTML = String(pcontent);\n    const text = TextEditor._getTextNodes(html);\n    const rgx = /\\[\\[(\\/[a-zA-Z]+\\s)?(.*?)(]{2,3})(?:{([^}]+)})?/gi;\n    TextEditor._replaceTextContent(text, rgx, (match) => createInlineFormula(match, rollData));\n    pcontent = html.innerHTML;\n  }\n\n  return pcontent;\n}\n\n/**\n * Split copper currency into gold, silver and copper.\n *\n * @param {number} cgil Copper\n * @returns {{gil:number,sgil:number,cgil:number}} Gold, silver, and copper.\n */\nexport const splitCurrency = (cgil) => {\n  const gil = Math.floor(cgil / 100);\n  const sgil = Math.floor(cgil / 10) - gil * 10;\n  cgil = cgil - gil * 100 - sgil * 10;\n  return {\n    gil: Math.max(0, gil),\n    sgil: Math.max(0, sgil),\n    cgil: Math.max(0, cgil),\n  };\n};\n\n/**\n * Get first active GM user.\n *\n * @deprecated Use `game.users.activeGM` instead\n * @returns {User|undefined} Active GM\n */\nexport const getFirstActiveGM = () => {\n  foundry.utils.logCompatibilityWarning(\"ffd20.utils.getFirstActiveGM() is deprecated in favor of game.users.activeGM\", {\n    since: \"PF1 v9\",\n    until: \"PF1 v10\",\n  });\n\n  return game.users.activeGM;\n};\n\n/**\n * Check whether at least one GM is active.\n *\n * @returns {boolean} Have active GM\n */\nexport const isGMActive = () => game.users.some((u) => u.active && u.isGM);\n\n/**\n * Resolve range formula to numeric value.\n *\n * @param {string} [formula] Range formula. Only used with \"mi\", \"ft\", \"m\", \"km\" and similar types.\n * @param {\"melee\"|\"touch\"|\"reach\"|\"close\"|\"medium\"|\"long\"|\"mi\"} [type=\"ft\"] Formula type\n * @param {object} [rollData] Roll data for evaluating the formula\n * @returns {number} Range in feet for the defined formula\n */\nexport const calculateRangeFormula = (formula, type = \"ft\", rollData = {}) => {\n  switch (type) {\n    case \"melee\":\n    case \"touch\":\n      return rollData.range?.melee ?? 0;\n    case \"reach\":\n      return rollData.range?.reach ?? 0;\n    case \"close\":\n      return RollPF.safeRoll(ffd20.config.spellRangeFormulas.close, rollData).total;\n    case \"medium\":\n      return RollPF.safeRoll(ffd20.config.spellRangeFormulas.medium, rollData).total;\n    case \"long\":\n      return RollPF.safeRoll(ffd20.config.spellRangeFormulas.long, rollData).total;\n    case \"mi\":\n      return RollPF.safeRoll(formula, rollData).total * 5_280;\n    case \"m\":\n      return (RollPF.safeRoll(formula, rollData).total / 1.5) * 5;\n    case \"km\":\n      return ((RollPF.safeRoll(formula, rollData).total * 1000) / 1.5) * 5;\n    default:\n      return RollPF.safeRoll(formula, rollData).total;\n  }\n};\n\n/**\n * Calculates range formula and converts it.\n *\n * @param formula\n * @param type\n * @param rollData\n */\nexport function calculateRange(formula, type = \"ft\", rollData = {}) {\n  if (type == null) return null;\n  const value = calculateRangeFormula(formula, type, rollData);\n  return convertDistance(value)[0];\n}\n\n/**\n * Refreshes all actor data and re-renders sheets.\n *\n * @param options\n */\nexport function refreshActors(options = { renderOnly: false, renderForEveryone: false }) {\n  game.actors.contents.forEach((o) => {\n    if (!options.renderOnly) o.reset();\n    if (o.sheet != null && o.sheet._state > 0) o.sheet.render();\n  });\n  Object.values(game.actors.tokens).forEach((o) => {\n    if (o) {\n      if (!options.renderOnly) o.reset();\n      if (o.sheet != null && o.sheet._state > 0) o.sheet.render();\n    }\n  });\n\n  if (options.renderForEveryone) {\n    game.socket.emit(\"ffd20\", \"refreshActorSheets\");\n  }\n}\n\n/**\n * Refresh all actor, item and action sheets.\n *\n * @param {object} [options] Additional options\n * @param {boolean} [options.reset=true] Reset underlying document.\n * @param {boolean} [options.actor] Include actor sheets\n * @param {boolean} [options.item] Include item sheets\n * @param {boolean} [options.action] Include action sheets\n */\nexport function refreshSheets({ reset = true, actor = true, item = true, action = true } = {}) {\n  Object.values(ui.windows).forEach((app) => {\n    if (\n      (actor && app instanceof ActorSheet) ||\n      (item && app instanceof ItemSheet) ||\n      (action && app instanceof ffd20.applications.component.ItemActionSheet)\n    ) {\n      if (reset && app.object instanceof Document) app.object.reset();\n      else app.render();\n    }\n  });\n}\n\n/**\n * Turns dictionaries with numbered keys into arrays.\n *\n * @param {object} sourceObj The source object which contains the full array in the same path as targetObj.\n * @param {object} targetObj The target object to alter. The array doesn't have to be immediately in this object.\n * @param {string} keepPath A path to the array to keep, separated with dots. e.g. \"system.damageParts\".\n */\nexport function keepUpdateArray(sourceObj, targetObj, keepPath) {\n  const newValue = getProperty(targetObj, keepPath);\n  if (newValue == null) return;\n  if (Array.isArray(newValue)) return;\n\n  const newArray = deepClone(getProperty(sourceObj, keepPath) || []);\n\n  for (const [key, value] of Object.entries(newValue)) {\n    if (foundry.utils.getType(value) === \"Object\") {\n      const subData = expandObject(value);\n      newArray[key] = mergeObject(newArray[key], subData);\n    } else {\n      newArray[key] = value;\n    }\n  }\n\n  setProperty(targetObj, keepPath, newArray);\n}\n\n/**\n * Deeply difference an object against some other, returning the update keys and values.\n * Unlike foundry.utils.diffObject, this function also deeply compares arrays.\n *\n * @param {object} original       An object comparing data against which to compare\n * @param {object} other          An object containing potentially different data\n * @param {object} [options={}]   Additional options which configure the diff operation\n * @param {boolean} [options.inner=false]  Only recognize differences in other for keys which also exist in original\n * @param {boolean} [options.keepLength=false]  Keep array length intact, possibly having to insert empty objects\n * @returns {object}               An object of the data in other which differs from that in original\n */\nexport const diffObjectAndArray = function (original, other, { inner = false, keepLength = false } = {}) {\n  /**\n   *\n   * @param v0\n   * @param v1\n   */\n  function _difference(v0, v1) {\n    const t0 = getType(v0);\n    const t1 = getType(v1);\n    if (t0 !== t1) return [true, v1];\n    if (t0 === \"Array\") {\n      if (v0.length !== v1.length) return [true, v1];\n      const d = [];\n      for (let a = 0; a < v0.length; a++) {\n        const d2 = diffObjectAndArray(v0[a], v1[a], { inner, keepLength });\n        if (!foundry.utils.isEmpty(d2)) d.push(d2);\n        else if (keepLength) d.push({});\n      }\n      if (d.length > 0) return [true, d];\n      return [false, d];\n    }\n    if (t0 === \"Object\") {\n      if (foundry.utils.isEmpty(v0) !== foundry.utils.isEmpty(v1)) return [true, v1];\n      const d = diffObjectAndArray(v0, v1, { inner, keepLength });\n      return [!foundry.utils.isEmpty(d), d];\n    }\n    return [v0 !== v1, v1];\n  }\n\n  // Recursively call the _difference function\n  return Object.keys(other).reduce((obj, key) => {\n    if (inner && !(key in original)) return obj;\n    const [isDifferent, difference] = _difference(original[key], other[key]);\n    if (isDifferent) obj[key] = difference;\n    return obj;\n  }, {});\n};\n\n/**\n * Determines what ability modifier is appropriate for a given score.\n *\n * @param {number} [score] - The score to find the modifier for.\n * @param {object} [options={}] - Options for this function.\n * @param {number} [options.penalty=0] - A penalty value to take into account.\n * @param {number} [options.damage=0] - Ability score damage to take into account.\n * @returns {number} The modifier for the given score.\n */\nexport function getAbilityModifier(score = null, options = {}) {\n  if (score != null) {\n    const penalty = Math.abs(options.penalty ?? 0);\n    const damage = Math.abs(options.damage ?? 0);\n    return Math.max(-5, Math.floor((score - 10) / 2) - Math.floor(penalty / 2) - Math.floor(damage / 2));\n  }\n  return 0;\n}\n\n/**\n * Recursively transforms an ES module to a regular, writable object.\n *\n * @template T\n * @param {T} module - The ES module to transform.\n * @returns {T} The transformed module.\n */\nexport function moduleToObject(module) {\n  const result = {};\n  for (const key in module) {\n    if (Object.prototype.toString.call(module[key]) === \"[object Module]\") {\n      result[key] = moduleToObject(module[key]);\n    } else {\n      result[key] = module[key];\n    }\n  }\n  return result;\n}\n\n/**\n * Set default scene scaling.\n *\n * `imperial` sets scaling to 5 ft, `metric` sets scaling to 1.5 m\n *\n * @param {\"metric\"|\"imperial\"|undefined} [system] System of units. Pull current setting if undefined.\n */\nexport function setDefaultSceneScaling(system) {\n  system ??= getDistanceSystem();\n  if (system == \"metric\") {\n    game.system.gridUnits = \"m\";\n    game.system.gridDistance = 1.5;\n  } else {\n    game.system.gridUnits = \"ft\";\n    game.system.gridDistance = 5;\n  }\n}\n","/**\n * Add a checkbox to enable/disable low-light vision effects to a light's configuration\n *\n * @param {FormApplication} app - The LightConfig app\n * @param {jQuery} html - The jQuery of the inner html\n */\nexport const addLowLightVisionToLightConfig = function (app, html) {\n  /** @type {AmbientLightDocument} */\n  const light = app.object;\n\n  // Create checkbox HTML element\n  let checkboxStr = `<div class=\"form-group\"><label>${game.i18n.localize(\"FFD20.DisableLightLowLightVision\")}</label>`;\n  checkboxStr += '<input type=\"checkbox\" name=\"flags.ffd20.disableLowLight\" data-dtype=\"Boolean\"';\n  if (light.getFlag(\"ffd20\", \"disableLowLight\")) checkboxStr += \" checked\";\n  checkboxStr += \"/></div>\";\n  const checkbox = $(checkboxStr);\n\n  // Insert new checkbox\n  html.find('div.tab[data-tab=\"basic\"]').append(checkbox);\n};\n\n/**\n * Add a checkbox to enable/disable low-light vision to a token's configuration\n *\n * @param {FormApplication} app - The TokenConfig app\n * @param {jQuery} html - The jQuery of the inner html\n */\nexport const addLowLightVisionToTokenConfig = function (app, html) {\n  /** @type {TokenDocument} */\n  const token = app.object;\n\n  // Create checkbox HTML element\n  let checkboxStr = `<div class=\"form-group\"><label>${game.i18n.localize(\"FFD20.DisableLightLowLightVision\")}</label>`;\n  checkboxStr += '<input type=\"checkbox\" name=\"flags.ffd20.disableLowLight\" data-dtype=\"Boolean\"';\n  if (token.getFlag(\"ffd20\", \"disableLowLight\")) checkboxStr += \" checked\";\n  checkboxStr += \"/></div>\";\n  const checkbox = $(checkboxStr);\n\n  // Insert new checkbox\n  html.find('.tab[data-group=\"light\"][data-tab=\"basic\"]').append(checkbox);\n};\n\nexport const patchCore = function () {\n  // Low-light vision light radius initialization (v10 & v11)\n  const LightSource_initialize = LightSource.prototype.initialize;\n  LightSource.prototype.initialize = function (data = {}) {\n    const { dim, bright } = this.getRadius(data.dim, data.bright);\n\n    // Avoid NaN and introducing keys that shouldn't be in the data\n    // Without undefined check, global illumination will cause darkvision and similar vision modes to glitch.\n    // We're assuming getRadius gives sensible values otherwise.\n    if (data.dim !== undefined) data.dim = dim;\n    if (data.bright !== undefined) data.bright = bright;\n\n    return LightSource_initialize.call(this, data);\n  };\n\n  LightSource.prototype.getRadius = function (dim, bright) {\n    const result = { dim, bright };\n    let multiplier = { dim: 1, bright: 1 };\n\n    if (this.object?.document.getFlag(\"ffd20\", \"disableLowLight\")) return result;\n\n    const requiresSelection = game.user.isGM || game.settings.get(\"ffd20\", \"lowLightVisionMode\");\n    const relevantTokens = canvas.tokens.placeables.filter(\n      (o) =>\n        !!o.actor && o.actor?.testUserPermission(game.user, \"OBSERVER\") && (requiresSelection ? o.controlled : true)\n    );\n    const lowLightTokens = relevantTokens.filter((o) => o.actorVision.lowLight === true);\n\n    if (requiresSelection) {\n      if (lowLightTokens.length && lowLightTokens.length === relevantTokens.length) {\n        multiplier = { dim: 999, bright: 999 };\n        for (const t of lowLightTokens) {\n          const tokenVision = t.actorVision;\n          multiplier.dim = Math.min(multiplier.dim, tokenVision.lowLightMultiplier);\n          multiplier.bright = Math.min(multiplier.bright, tokenVision.lowLightMultiplierBright);\n        }\n      }\n    } else {\n      for (const t of lowLightTokens) {\n        const tokenVision = t.actorVision;\n        multiplier.dim = Math.max(multiplier.dim, tokenVision.lowLightMultiplier);\n        multiplier.bright = Math.max(multiplier.bright, tokenVision.lowLightMultiplierBright);\n      }\n    }\n\n    result.dim *= multiplier.dim;\n    result.bright *= multiplier.bright;\n\n    return result;\n  };\n};\n","import { customRolls } from \"./documents/chat-message.mjs\";\nimport { sortArrayByName } from \"./utils/lib.mjs\";\nimport { parseRollStringVariable } from \"./dice/roll.mjs\";\nimport { RollPF } from \"./dice/roll.mjs\";\nimport { patchCore as patchLowLightVision } from \"./canvas/low-light-vision.mjs\";\n\nHooks.once(\"init\", () => {\n  if (game.release.generation >= 11) return;\n  // Mimic v11 game.users.activeGM for v10\n  Object.defineProperty(Users.prototype, \"activeGM\", {\n    get: function () {\n      const activeGMs = game.users.filter((u) => u.active && u.isGM);\n      activeGMs.sort((a, b) => (a.id > b.id ? 1 : -1));\n      return activeGMs[0] || null;\n    },\n  });\n});\n\n/**\n *\n */\n// Add inline support for extra /commands\n{\n  const origParse = ChatLog.parse;\n  ChatLog.parse = function (message) {\n    const match = message.match(/^\\/(\\w+)(?: +([^#]+))(?:#(.+))?/),\n      type = match?.[1]?.toUpperCase();\n    if ([\"HEAL\", \"H\", \"DAMAGE\", \"D\"].includes(type)) {\n      match[2] = match[0].slice(1);\n      return [\"custom\", match];\n    } else return origParse.call(this, message);\n  };\n\n  const origClick = TextEditor._onClickInlineRoll;\n  TextEditor._onClickInlineRoll = function (event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    if (!a.classList.contains(\"custom\")) return origClick.call(this, event);\n\n    const chatMessage = `/${a.dataset.formula}`;\n    const cMsg = CONFIG.ChatMessage.documentClass;\n    const speaker = cMsg.getSpeaker();\n    const actor = cMsg.getSpeakerActor(speaker);\n    let rollData = actor ? actor.getRollData() : {};\n\n    const sheet = a.closest(\".sheet\");\n    if (sheet) {\n      const app = ui.windows[sheet.dataset.appid];\n      if ([\"Actor\", \"Item\"].includes(app?.document.documentName)) rollData = app.object.getRollData();\n    }\n    return customRolls(chatMessage, speaker, rollData);\n  };\n\n  // Fix for race condition\n  if ($._data($(\"body\").get(0), \"events\")?.click?.find((o) => o.selector === \"a.inline-roll\")) {\n    $(\"body\").off(\"click\", \"a.inline-roll\", origClick);\n    $(\"body\").on(\"click\", \"a.inline-roll\", TextEditor._onClickInlineRoll);\n  }\n}\n\n// Change tooltip showing on alt\n{\n  const fn = KeyboardManager.prototype._onAlt;\n  KeyboardManager.prototype._onAlt = function (event, up, modifiers) {\n    if (!ffd20.tooltip) return;\n    if (!up) ffd20.tooltip.lock.new = true;\n    fn.call(this, event, up, modifiers);\n    if (!up) ffd20.tooltip.lock.new = false;\n  };\n}\n\n// Patch StringTerm\nStringTerm.prototype.evaluate = function (options = {}) {\n  const result = parseRollStringVariable(this.term);\n  if (typeof result === \"string\") {\n    const src = `with (sandbox) { return ${this.term}; }`;\n    try {\n      const evalFn = new Function(\"sandbox\", src);\n      this._total = evalFn(RollPF.MATH_PROXY);\n    } catch (err) {\n      err.message = `Failed to evaluate: '${this.term}'\\n${err.message}`;\n      throw err;\n    }\n  } else {\n    this._total = result;\n  }\n};\n\n// Patch NumericTerm\nNumericTerm.prototype.getTooltipData = function () {\n  return {\n    formula: this.expression,\n    total: this.total,\n    flavor: this.flavor,\n  };\n};\n\n// Patch ParentheticalTerm and allowed operators\nParentheticalTerm.CLOSE_REGEXP = new RegExp(`\\\\)${RollTerm.FLAVOR_REGEXP_STRING}?`, \"g\");\nOperatorTerm.REGEXP = /(?:&&|\\|\\||\\*\\*|\\+|-|\\*|\\/|\\\\%|\\||:|\\?)|(?<![a-z])[!=<>]+/g;\nOperatorTerm.OPERATORS.push(\"\\\\%\", \"!\", \"?\", \":\", \"=\", \"<\", \">\", \"==\", \"===\", \"<=\", \">=\", \"??\", \"||\", \"&&\", \"**\");\n\n// Add secondary indexing to compendium collections\n{\n  const origFunc = CompendiumCollection.prototype.getIndex;\n  CompendiumCollection.prototype.getIndex = async function ({ fields } = {}) {\n    const index = await origFunc.call(this, { fields });\n    this.fuzzyIndex = sortArrayByName([...index]);\n    return this.index;\n  };\n}\n\n// Document link attribute stuffing\n{\n  const origFunc = TextEditor._createContentLink;\n  TextEditor._createContentLink = function (match, { async = false, relativeTo } = {}) {\n    const [type, target, hash, name] = match.slice(1, 5);\n    const a = origFunc.call(this, match, { async, relativeTo });\n    if (name?.indexOf(\"::\") > -1) {\n      const args = name.split(\"::\"),\n        label = args.pop();\n      if (args.length) {\n        args.forEach((o) => {\n          let [key, value] = o.split(/(?<!\\\\):/);\n          if (!(key && value)) {\n            value = key;\n            key = \"extra\";\n          }\n          switch (key) {\n            case \"icon\":\n              a.firstChild.className = \"fas fa-\" + value;\n              break;\n            case \"class\":\n              a.classList.add(...value.split(\" \"));\n              break;\n            default:\n              a.setAttribute(\"data-\" + key, value);\n          }\n        });\n        a.lastChild.textContent = label;\n      }\n    }\n    return a;\n  };\n}\n\n// Remove warnings for conflicting uneditable system bindings\n{\n  const origFunc = KeybindingsConfig.prototype._detectConflictingActions;\n  KeybindingsConfig.prototype._detectConflictingActions = function (actionId, action, binding) {\n    // Uneditable System bindings are never wrong, they can never conflict with something\n    if (actionId.startsWith(\"ffd20.\") && action.uneditable.includes(binding)) return [];\n\n    return origFunc.call(this, actionId, action, binding);\n  };\n}\n\n// Patch the `fromData` method used by Foundry to allow rolls from builds with a renamed roll class\n// to still be created from JSON for tooltips etc.\n// Introduced in v0.81.1 for Foundry v9.269\n{\n  const origFunc = Roll.fromData;\n  Roll.fromData = function (data, ...args) {\n    if (data.class === \"RollPF$1\") data.class = \"RollPF\";\n    return origFunc.call(this, data, ...args);\n  };\n}\n\n/**\n * Patch ImagePopout image share handling function to respect identified status of items\n *\n * Synchronized with Foundry VTT v10.291\n */\n{\n  const original_handleShareImage = ImagePopout._handleShareImage;\n  ImagePopout._handleShareImage = function ({ image, title, caption, uuid, showTitle } = {}) {\n    const doc = fromUuidSync(uuid);\n    if (doc instanceof Item) {\n      title = doc.name;\n    }\n\n    return original_handleShareImage.call(this, { image, title, caption, uuid, showTitle });\n  };\n}\n\n/**\n * Stop releasing modifiers on HTMLButtonElement. Check again on proper support of popouts. How blur is handled will have to be reevaluated\n *\n * Introduced Foundry VTT v10.291\n */\n\n{\n  const original_onFocusIn = KeyboardManager.prototype._onFocusIn;\n  KeyboardManager.prototype._onFocusIn = function (event) {\n    const formElements = [HTMLInputElement, HTMLSelectElement, HTMLTextAreaElement, HTMLOptionElement];\n\n    if (event.target.isContentEditable || formElements.some((cls) => event.target instanceof cls)) {\n      this.releaseKeys();\n    }\n  };\n\n  Object.defineProperty(KeyboardManager.prototype, \"hasFocus\", {\n    get() {\n      // Pulled from https://www.w3schools.com/html/html_form_elements.asp\n      const formElements = [\"input\", \"select\", \"textarea\", \"option\", \"[contenteditable]\"];\n      const selector = formElements.map((el) => `${el}:focus`).join(\", \");\n      return document.querySelectorAll(selector).length > 0;\n    },\n  });\n}\n\n// Call patch functions\npatchLowLightVision();\n","const buttons = {\n  spells: { label: \"FFD20.BrowseSpells\" },\n  items: { label: \"FFD20.BrowseItems\" },\n  bestiary: { label: \"FFD20.BrowseBestiary\" },\n  feats: { label: \"FFD20.BrowseFeats\" },\n  classes: { label: \"FFD20.BrowseClasses\" },\n  races: { label: \"FFD20.BrowseRaces\" },\n  buffs: { label: \"FFD20.BrowseBuffs\", wide: true },\n};\n\n/**\n * @param event\n */\nfunction compendiumButtonClick(event) {\n  event.preventDefault();\n  const type = event.target.dataset.category;\n  ffd20.applications.compendiums[type]._render(true, { focus: true });\n}\n\n/**\n * Render compendium browser buttons.\n *\n * @param {CompendiumDirectory} app\n * @param {JQuery} html\n * @param {object} options\n */\nHooks.on(\"renderCompendiumDirectory\", async (app, [html], options) => {\n  const element = html.querySelector(\"footer.directory-footer\");\n  element.classList.add(\"action-buttons\"); // For v10 cross-compatibility\n\n  for (const [category, info] of Object.entries(buttons)) {\n    const button = document.createElement(\"button\");\n    button.type = \"button\";\n    button.dataset.category = category;\n    button.classList.add(\"compendium\", category);\n    button.innerText = game.i18n.localize(info.label);\n    if (info.wide) button.classList.add(\"colspan-2\");\n    element.append(button);\n    button.addEventListener(\"click\", compendiumButtonClick);\n  }\n});\n\n// Add compendium sidebar context options\nHooks.on(\"getCompendiumDirectoryEntryContext\", (html, entryOptions) => {\n  // Add option to enable & disable pack\n  entryOptions.unshift(\n    {\n      name: game.i18n.localize(\"FFD20.CompendiumBrowser.HidePack\"),\n      icon: '<i class=\"fas fa-low-vision\"></i>',\n      condition: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        return pack.config.ffd20?.disabled !== true;\n      },\n      callback: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        pack.configure({ ffd20: { disabled: true } });\n      },\n    },\n    {\n      name: game.i18n.localize(\"FFD20.CompendiumBrowser.ShowPack\"),\n      icon: '<i class=\"fas fa-eye\"></i>',\n      condition: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        return pack.config.ffd20?.disabled === true;\n      },\n      callback: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        pack.configure({ ffd20: { disabled: false } });\n      },\n    }\n  );\n});\n","export const tinyMCEInit = function () {\r\n  CONFIG.TinyMCE.content_css.push(\"/systems/ffd20/ui/mce.css\");\r\n\r\n  CONFIG.TinyMCE.style_formats[0].items.push(\r\n    {\r\n      title: game.i18n.localize(\"FFD20.NotImplemented\"),\r\n      inline: \"span\",\r\n      classes: \"notImp\",\r\n      attributes: { title: game.i18n.localize(\"FFD20.NotImplemented\") },\r\n      remove: \"all\",\r\n    },\r\n    {\r\n      title: game.i18n.localize(\"FFD20.StepsRequired\"),\r\n      inline: \"span\",\r\n      classes: \"needSteps\",\r\n      attributes: { title: game.i18n.localize(\"FFD20.StepsRequired\") },\r\n      remove: \"all\",\r\n    }\r\n  );\r\n  CONFIG.TinyMCE.formats = Object.assign({}, CONFIG.TinyMCE.formats, {\r\n    removeFormat: [{ selector: \"span\", classes: \"notImp,needSteps\", remove: \"all\" }],\r\n  });\r\n\r\n  tinyMCE.on(\"addeditor\", (ev) => {\r\n    registerContextMenu(ev.editor);\r\n  });\r\n};\r\n\r\n/**\r\n * @param editor\r\n */\r\nfunction registerContextMenu(editor) {\r\n  const isInfoElement = function (node) {\r\n    if (node.nodeName !== \"SPAN\") node = node.parentNode;\r\n    return node.nodeName === \"SPAN\" && (node.classList.contains(\"notImp\") || node.classList.contains(\"needSteps\"));\r\n  };\r\n\r\n  const getInfoElement = function () {\r\n    const node = editor.selection.getNode();\r\n    return isInfoElement(node) ? node.closest(\"span.notImp,span.needSteps\") : null;\r\n  };\r\n\r\n  editor.ui.registry.addContextForm(\"info-form\", {\r\n    launch: {\r\n      type: \"contextformtogglebutton\",\r\n      icon: \"warning\",\r\n    },\r\n    label: \"Info\",\r\n    predicate: isInfoElement,\r\n    initValue: function () {\r\n      const elm = getInfoElement();\r\n      return elm ? elm.title : \"\";\r\n    },\r\n    commands: [\r\n      {\r\n        type: \"contextformtogglebutton\",\r\n        icon: \"warning\",\r\n        tooltip: game.i18n.localize(\"FFD20.NotImplemented\"),\r\n        onSetup: function (buttonApi) {\r\n          buttonApi.setActive(!!getInfoElement()?.classList.contains(\"notImp\"));\r\n          const nodeChangeHandler = function () {\r\n            buttonApi.setActive(!editor.readonly && getInfoElement()?.classList.contains(\"notImp\"));\r\n          };\r\n          editor.on(\"nodechange\", nodeChangeHandler);\r\n          return function () {\r\n            editor.off(\"nodechange\", nodeChangeHandler);\r\n          };\r\n        },\r\n        onAction: function (formApi) {\r\n          const value = formApi.getValue(),\r\n            node = getInfoElement();\r\n          editor.setDirty(true);\r\n          editor.dom.setAttribs(node, { title: value, class: \"notImp\" });\r\n          formApi.hide();\r\n        },\r\n      },\r\n      {\r\n        type: \"contextformtogglebutton\",\r\n        icon: \"selected\",\r\n        tooltip: game.i18n.localize(\"FFD20.StepsRequired\"),\r\n        onSetup: function (buttonApi) {\r\n          buttonApi.setActive(!!getInfoElement()?.classList.contains(\"needSteps\"));\r\n          const nodeChangeHandler = function () {\r\n            buttonApi.setActive(!editor.readonly && getInfoElement()?.classList.contains(\"needSteps\"));\r\n          };\r\n          editor.on(\"nodechange\", nodeChangeHandler);\r\n          return function () {\r\n            editor.off(\"nodechange\", nodeChangeHandler);\r\n          };\r\n        },\r\n        onAction: function (formApi) {\r\n          const value = formApi.getValue(),\r\n            node = getInfoElement();\r\n          editor.setDirty(true);\r\n          editor.dom.setAttribs(node, { title: value, class: \"needSteps\" });\r\n          formApi.hide();\r\n        },\r\n      },\r\n      {\r\n        type: \"contextformtogglebutton\",\r\n        icon: \"close\",\r\n        tooltip: game.i18n.localize(\"FFD20.RemoveInfo\"),\r\n        onAction: function (formApi) {\r\n          const node = getInfoElement();\r\n          editor.setDirty(true);\r\n          editor.dom.remove(node, true);\r\n          formApi.hide();\r\n        },\r\n      },\r\n    ],\r\n  });\r\n}\r\n","import { measureDistance as unifiedMeasureDistance } from \"./lib.mjs\";\n\n/**\n * Measure the distance between two pixel coordinates\n * See BaseGrid.measureDistance for more details\n *\n * @param segments\n * @param options\n */\nexport const measureDistances = function (segments, options = {}) {\n  if (!options.gridSpaces) return BaseGrid.prototype.measureDistances.call(this, segments, options);\n\n  // Track the total number of diagonals\n  const diagonalRule = this.parent.diagonalRule;\n  const state = { diagonals: 0 };\n\n  // Iterate over measured segments\n  return segments.map((s) => unifiedMeasureDistance(null, null, { ray: s.ray, diagonalRule, state }));\n};\n\n/* -------------------------------------------- */\n\n/**\n * Condition/ status effects section\n */\nexport const getConditions = function () {\n  const core = CONFIG.statusEffects;\n  let sys = Object.keys(ffd20.config.conditions).map((c) => ({\n    id: c,\n    label: ffd20.config.conditions[c],\n    icon: ffd20.config.conditionTextures[c],\n  }));\n  if (game.settings.get(\"ffd20\", \"coreEffects\")) sys.push(...core);\n  else sys = [core[0]].concat(sys);\n  return sys.sort((a, b) => a.label.localeCompare(b.label));\n};\n\nconst _TokenHUD_getStatusEffectChoices = TokenHUD.prototype._getStatusEffectChoices;\nTokenHUD.prototype._getStatusEffectChoices = function () {\n  const core = _TokenHUD_getStatusEffectChoices.call(this),\n    buffs = {};\n  // Only add buff textures for actors with that function (so not e.g. not actors introduced by modules)\n  for (const buff of Object.values(this.object.actor._calcBuffActiveEffects?.() ?? {})) {\n    if (!buff) continue;\n    buffs[`buff-${buff.id}`] = {\n      id: buff.id,\n      title: buff.label,\n      src: buff.icon,\n      isActive: buff.active,\n      isOverlay: false,\n      cssClass: buff.active ? \"active\" : \"\",\n    };\n  }\n\n  return { ...core, ...buffs };\n};\n\n//const TokenHUD__onToggleEffect = TokenHUD.prototype._onToggleEffect;\nTokenHUD.prototype._onToggleEffect = function (event, { overlay = false } = {}) {\n  event.preventDefault();\n  const img = event.currentTarget;\n  const effect =\n    img.dataset.statusId && this.object.actor\n      ? CONFIG.statusEffects.find((e) => e.id === img.dataset.statusId) ?? img.dataset.statusId\n      : img.getAttribute(\"src\");\n  return this.object.toggleEffect(effect, { overlay });\n};\n","import { refreshActors } from \"./utils/lib.mjs\";\n\n/**\n *\n */\nexport function initializeSocket() {\n  game.socket.on(\"system.ffd20\", runSocketFunction);\n}\n\nconst runSocketFunction = async function (args, senderId) {\n  const isFirstGM = game.users.activeGM.isSelf;\n  const sender = game.users.get(senderId);\n  try {\n    switch (args.eventType) {\n      case \"currencyTransfer\": {\n        if (!isFirstGM) return;\n        let source = await fromUuid(args.data.sourceActor);\n        let dest = await fromUuid(args.data.destActor);\n\n        if (args.data.sourceContainer) source = source.items.get(args.data.sourceContainer);\n        if (args.data.destContainer) dest = dest.items.get(args.data.destContainer);\n        const amount = args.data.amount;\n\n        ffd20.applications.CurrencyTransfer.transfer(source, dest, amount, args.data.sourceAlt, args.data.destAlt, false);\n        break;\n      }\n      case \"alterChatTargetAttribute\":\n        if (isFirstGM) alterChatTargetAttribute(args);\n        break;\n      case \"giveItem\": {\n        if (!isFirstGM) return;\n        const item = await fromUuid(args.item);\n        const sourceActor = item.actor;\n        if (!sourceActor.testUserPermission(sender, \"OWNER\")) return;\n        const targetActor = await fromUuid(args.targetActor);\n        const itemData = item.toObject();\n        await targetActor.createEmbeddedDocuments(\"Item\", [itemData]);\n        await sourceActor.deleteEmbeddedDocuments(\"Item\", [item.id]);\n        break;\n      }\n      case \"refreshActorSheets\":\n        ffd20.utils.refreshActors({ renderOnly: true });\n        break;\n    }\n  } catch (err) {\n    console.log(\"FFD20 |Socket Error: \", err);\n  }\n};\n\nexport const alterChatTargetAttribute = function (args) {\n  const message = game.messages.get(args.message);\n  const contentHTML = $(message.data.content);\n\n  // Alter saving throw\n  if (args.save != null) {\n    const targetElem = contentHTML.find(\n      `div.attack-targets .target[data-uuid=\"${args.targetUuid}\"] .saving-throws .${args.save}`\n    );\n    const valueElem = targetElem.find(\".value\");\n    valueElem.html(`${args.value}`);\n\n    // Add classes based off extra data\n    if (args.isFailure) valueElem.addClass(\"failure\");\n    else valueElem.removeClass(\"failure\");\n    if (args.isSuccess) valueElem.addClass(\"success\");\n    else valueElem.removeClass(\"success\");\n\n    return message.update({\n      content: contentHTML.prop(\"outerHTML\"),\n    });\n  }\n};\n","'use strict'\r\n\r\nmodule.exports = {\r\n\t\"aliceblue\": [240, 248, 255],\r\n\t\"antiquewhite\": [250, 235, 215],\r\n\t\"aqua\": [0, 255, 255],\r\n\t\"aquamarine\": [127, 255, 212],\r\n\t\"azure\": [240, 255, 255],\r\n\t\"beige\": [245, 245, 220],\r\n\t\"bisque\": [255, 228, 196],\r\n\t\"black\": [0, 0, 0],\r\n\t\"blanchedalmond\": [255, 235, 205],\r\n\t\"blue\": [0, 0, 255],\r\n\t\"blueviolet\": [138, 43, 226],\r\n\t\"brown\": [165, 42, 42],\r\n\t\"burlywood\": [222, 184, 135],\r\n\t\"cadetblue\": [95, 158, 160],\r\n\t\"chartreuse\": [127, 255, 0],\r\n\t\"chocolate\": [210, 105, 30],\r\n\t\"coral\": [255, 127, 80],\r\n\t\"cornflowerblue\": [100, 149, 237],\r\n\t\"cornsilk\": [255, 248, 220],\r\n\t\"crimson\": [220, 20, 60],\r\n\t\"cyan\": [0, 255, 255],\r\n\t\"darkblue\": [0, 0, 139],\r\n\t\"darkcyan\": [0, 139, 139],\r\n\t\"darkgoldenrod\": [184, 134, 11],\r\n\t\"darkgray\": [169, 169, 169],\r\n\t\"darkgreen\": [0, 100, 0],\r\n\t\"darkgrey\": [169, 169, 169],\r\n\t\"darkkhaki\": [189, 183, 107],\r\n\t\"darkmagenta\": [139, 0, 139],\r\n\t\"darkolivegreen\": [85, 107, 47],\r\n\t\"darkorange\": [255, 140, 0],\r\n\t\"darkorchid\": [153, 50, 204],\r\n\t\"darkred\": [139, 0, 0],\r\n\t\"darksalmon\": [233, 150, 122],\r\n\t\"darkseagreen\": [143, 188, 143],\r\n\t\"darkslateblue\": [72, 61, 139],\r\n\t\"darkslategray\": [47, 79, 79],\r\n\t\"darkslategrey\": [47, 79, 79],\r\n\t\"darkturquoise\": [0, 206, 209],\r\n\t\"darkviolet\": [148, 0, 211],\r\n\t\"deeppink\": [255, 20, 147],\r\n\t\"deepskyblue\": [0, 191, 255],\r\n\t\"dimgray\": [105, 105, 105],\r\n\t\"dimgrey\": [105, 105, 105],\r\n\t\"dodgerblue\": [30, 144, 255],\r\n\t\"firebrick\": [178, 34, 34],\r\n\t\"floralwhite\": [255, 250, 240],\r\n\t\"forestgreen\": [34, 139, 34],\r\n\t\"fuchsia\": [255, 0, 255],\r\n\t\"gainsboro\": [220, 220, 220],\r\n\t\"ghostwhite\": [248, 248, 255],\r\n\t\"gold\": [255, 215, 0],\r\n\t\"goldenrod\": [218, 165, 32],\r\n\t\"gray\": [128, 128, 128],\r\n\t\"green\": [0, 128, 0],\r\n\t\"greenyellow\": [173, 255, 47],\r\n\t\"grey\": [128, 128, 128],\r\n\t\"honeydew\": [240, 255, 240],\r\n\t\"hotpink\": [255, 105, 180],\r\n\t\"indianred\": [205, 92, 92],\r\n\t\"indigo\": [75, 0, 130],\r\n\t\"ivory\": [255, 255, 240],\r\n\t\"khaki\": [240, 230, 140],\r\n\t\"lavender\": [230, 230, 250],\r\n\t\"lavenderblush\": [255, 240, 245],\r\n\t\"lawngreen\": [124, 252, 0],\r\n\t\"lemonchiffon\": [255, 250, 205],\r\n\t\"lightblue\": [173, 216, 230],\r\n\t\"lightcoral\": [240, 128, 128],\r\n\t\"lightcyan\": [224, 255, 255],\r\n\t\"lightgoldenrodyellow\": [250, 250, 210],\r\n\t\"lightgray\": [211, 211, 211],\r\n\t\"lightgreen\": [144, 238, 144],\r\n\t\"lightgrey\": [211, 211, 211],\r\n\t\"lightpink\": [255, 182, 193],\r\n\t\"lightsalmon\": [255, 160, 122],\r\n\t\"lightseagreen\": [32, 178, 170],\r\n\t\"lightskyblue\": [135, 206, 250],\r\n\t\"lightslategray\": [119, 136, 153],\r\n\t\"lightslategrey\": [119, 136, 153],\r\n\t\"lightsteelblue\": [176, 196, 222],\r\n\t\"lightyellow\": [255, 255, 224],\r\n\t\"lime\": [0, 255, 0],\r\n\t\"limegreen\": [50, 205, 50],\r\n\t\"linen\": [250, 240, 230],\r\n\t\"magenta\": [255, 0, 255],\r\n\t\"maroon\": [128, 0, 0],\r\n\t\"mediumaquamarine\": [102, 205, 170],\r\n\t\"mediumblue\": [0, 0, 205],\r\n\t\"mediumorchid\": [186, 85, 211],\r\n\t\"mediumpurple\": [147, 112, 219],\r\n\t\"mediumseagreen\": [60, 179, 113],\r\n\t\"mediumslateblue\": [123, 104, 238],\r\n\t\"mediumspringgreen\": [0, 250, 154],\r\n\t\"mediumturquoise\": [72, 209, 204],\r\n\t\"mediumvioletred\": [199, 21, 133],\r\n\t\"midnightblue\": [25, 25, 112],\r\n\t\"mintcream\": [245, 255, 250],\r\n\t\"mistyrose\": [255, 228, 225],\r\n\t\"moccasin\": [255, 228, 181],\r\n\t\"navajowhite\": [255, 222, 173],\r\n\t\"navy\": [0, 0, 128],\r\n\t\"oldlace\": [253, 245, 230],\r\n\t\"olive\": [128, 128, 0],\r\n\t\"olivedrab\": [107, 142, 35],\r\n\t\"orange\": [255, 165, 0],\r\n\t\"orangered\": [255, 69, 0],\r\n\t\"orchid\": [218, 112, 214],\r\n\t\"palegoldenrod\": [238, 232, 170],\r\n\t\"palegreen\": [152, 251, 152],\r\n\t\"paleturquoise\": [175, 238, 238],\r\n\t\"palevioletred\": [219, 112, 147],\r\n\t\"papayawhip\": [255, 239, 213],\r\n\t\"peachpuff\": [255, 218, 185],\r\n\t\"peru\": [205, 133, 63],\r\n\t\"pink\": [255, 192, 203],\r\n\t\"plum\": [221, 160, 221],\r\n\t\"powderblue\": [176, 224, 230],\r\n\t\"purple\": [128, 0, 128],\r\n\t\"rebeccapurple\": [102, 51, 153],\r\n\t\"red\": [255, 0, 0],\r\n\t\"rosybrown\": [188, 143, 143],\r\n\t\"royalblue\": [65, 105, 225],\r\n\t\"saddlebrown\": [139, 69, 19],\r\n\t\"salmon\": [250, 128, 114],\r\n\t\"sandybrown\": [244, 164, 96],\r\n\t\"seagreen\": [46, 139, 87],\r\n\t\"seashell\": [255, 245, 238],\r\n\t\"sienna\": [160, 82, 45],\r\n\t\"silver\": [192, 192, 192],\r\n\t\"skyblue\": [135, 206, 235],\r\n\t\"slateblue\": [106, 90, 205],\r\n\t\"slategray\": [112, 128, 144],\r\n\t\"slategrey\": [112, 128, 144],\r\n\t\"snow\": [255, 250, 250],\r\n\t\"springgreen\": [0, 255, 127],\r\n\t\"steelblue\": [70, 130, 180],\r\n\t\"tan\": [210, 180, 140],\r\n\t\"teal\": [0, 128, 128],\r\n\t\"thistle\": [216, 191, 216],\r\n\t\"tomato\": [255, 99, 71],\r\n\t\"turquoise\": [64, 224, 208],\r\n\t\"violet\": [238, 130, 238],\r\n\t\"wheat\": [245, 222, 179],\r\n\t\"white\": [255, 255, 255],\r\n\t\"whitesmoke\": [245, 245, 245],\r\n\t\"yellow\": [255, 255, 0],\r\n\t\"yellowgreen\": [154, 205, 50]\r\n};\r\n","'use strict';\n\nvar isArrayish = require('is-arrayish');\n\nvar concat = Array.prototype.concat;\nvar slice = Array.prototype.slice;\n\nvar swizzle = module.exports = function swizzle(args) {\n\tvar results = [];\n\n\tfor (var i = 0, len = args.length; i < len; i++) {\n\t\tvar arg = args[i];\n\n\t\tif (isArrayish(arg)) {\n\t\t\t// http://jsperf.com/javascript-array-concat-vs-push/98\n\t\t\tresults = concat.call(results, slice.call(arg));\n\t\t} else {\n\t\t\tresults.push(arg);\n\t\t}\n\t}\n\n\treturn results;\n};\n\nswizzle.wrap = function (fn) {\n\treturn function () {\n\t\treturn fn(swizzle(arguments));\n\t};\n};\n","module.exports = function isArrayish(obj) {\n\tif (!obj || typeof obj === 'string') {\n\t\treturn false;\n\t}\n\n\treturn obj instanceof Array || Array.isArray(obj) ||\n\t\t(obj.length >= 0 && (obj.splice instanceof Function ||\n\t\t\t(Object.getOwnPropertyDescriptor(obj, (obj.length - 1)) && obj.constructor.name !== 'String')));\n};\n","/* MIT license */\nvar colorNames = require('color-name');\nvar swizzle = require('simple-swizzle');\nvar hasOwnProperty = Object.hasOwnProperty;\n\nvar reverseNames = Object.create(null);\n\n// create a list of reverse color names\nfor (var name in colorNames) {\n\tif (hasOwnProperty.call(colorNames, name)) {\n\t\treverseNames[colorNames[name]] = name;\n\t}\n}\n\nvar cs = module.exports = {\n\tto: {},\n\tget: {}\n};\n\ncs.get = function (string) {\n\tvar prefix = string.substring(0, 3).toLowerCase();\n\tvar val;\n\tvar model;\n\tswitch (prefix) {\n\t\tcase 'hsl':\n\t\t\tval = cs.get.hsl(string);\n\t\t\tmodel = 'hsl';\n\t\t\tbreak;\n\t\tcase 'hwb':\n\t\t\tval = cs.get.hwb(string);\n\t\t\tmodel = 'hwb';\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval = cs.get.rgb(string);\n\t\t\tmodel = 'rgb';\n\t\t\tbreak;\n\t}\n\n\tif (!val) {\n\t\treturn null;\n\t}\n\n\treturn {model: model, value: val};\n};\n\ncs.get.rgb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar abbr = /^#([a-f0-9]{3,4})$/i;\n\tvar hex = /^#([a-f0-9]{6})([a-f0-9]{2})?$/i;\n\tvar rgba = /^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar per = /^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/;\n\tvar keyword = /^(\\w+)$/;\n\n\tvar rgb = [0, 0, 0, 1];\n\tvar match;\n\tvar i;\n\tvar hexAlpha;\n\n\tif (match = string.match(hex)) {\n\t\thexAlpha = match[2];\n\t\tmatch = match[1];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\t// https://jsperf.com/slice-vs-substr-vs-substring-methods-long-string/19\n\t\t\tvar i2 = i * 2;\n\t\t\trgb[i] = parseInt(match.slice(i2, i2 + 2), 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(abbr)) {\n\t\tmatch = match[1];\n\t\thexAlpha = match[3];\n\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i] + match[i], 16);\n\t\t}\n\n\t\tif (hexAlpha) {\n\t\t\trgb[3] = parseInt(hexAlpha + hexAlpha, 16) / 255;\n\t\t}\n\t} else if (match = string.match(rgba)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = parseInt(match[i + 1], 0);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(per)) {\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\trgb[i] = Math.round(parseFloat(match[i + 1]) * 2.55);\n\t\t}\n\n\t\tif (match[4]) {\n\t\t\tif (match[5]) {\n\t\t\t\trgb[3] = parseFloat(match[4]) * 0.01;\n\t\t\t} else {\n\t\t\t\trgb[3] = parseFloat(match[4]);\n\t\t\t}\n\t\t}\n\t} else if (match = string.match(keyword)) {\n\t\tif (match[1] === 'transparent') {\n\t\t\treturn [0, 0, 0, 0];\n\t\t}\n\n\t\tif (!hasOwnProperty.call(colorNames, match[1])) {\n\t\t\treturn null;\n\t\t}\n\n\t\trgb = colorNames[match[1]];\n\t\trgb[3] = 1;\n\n\t\treturn rgb;\n\t} else {\n\t\treturn null;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\trgb[i] = clamp(rgb[i], 0, 255);\n\t}\n\trgb[3] = clamp(rgb[3], 0, 1);\n\n\treturn rgb;\n};\n\ncs.get.hsl = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hsl = /^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hsl);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar s = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar l = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\n\t\treturn [h, s, l, a];\n\t}\n\n\treturn null;\n};\n\ncs.get.hwb = function (string) {\n\tif (!string) {\n\t\treturn null;\n\t}\n\n\tvar hwb = /^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/;\n\tvar match = string.match(hwb);\n\n\tif (match) {\n\t\tvar alpha = parseFloat(match[4]);\n\t\tvar h = ((parseFloat(match[1]) % 360) + 360) % 360;\n\t\tvar w = clamp(parseFloat(match[2]), 0, 100);\n\t\tvar b = clamp(parseFloat(match[3]), 0, 100);\n\t\tvar a = clamp(isNaN(alpha) ? 1 : alpha, 0, 1);\n\t\treturn [h, w, b, a];\n\t}\n\n\treturn null;\n};\n\ncs.to.hex = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn (\n\t\t'#' +\n\t\thexDouble(rgba[0]) +\n\t\thexDouble(rgba[1]) +\n\t\thexDouble(rgba[2]) +\n\t\t(rgba[3] < 1\n\t\t\t? (hexDouble(Math.round(rgba[3] * 255)))\n\t\t\t: '')\n\t);\n};\n\ncs.to.rgb = function () {\n\tvar rgba = swizzle(arguments);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ')'\n\t\t: 'rgba(' + Math.round(rgba[0]) + ', ' + Math.round(rgba[1]) + ', ' + Math.round(rgba[2]) + ', ' + rgba[3] + ')';\n};\n\ncs.to.rgb.percent = function () {\n\tvar rgba = swizzle(arguments);\n\n\tvar r = Math.round(rgba[0] / 255 * 100);\n\tvar g = Math.round(rgba[1] / 255 * 100);\n\tvar b = Math.round(rgba[2] / 255 * 100);\n\n\treturn rgba.length < 4 || rgba[3] === 1\n\t\t? 'rgb(' + r + '%, ' + g + '%, ' + b + '%)'\n\t\t: 'rgba(' + r + '%, ' + g + '%, ' + b + '%, ' + rgba[3] + ')';\n};\n\ncs.to.hsl = function () {\n\tvar hsla = swizzle(arguments);\n\treturn hsla.length < 4 || hsla[3] === 1\n\t\t? 'hsl(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%)'\n\t\t: 'hsla(' + hsla[0] + ', ' + hsla[1] + '%, ' + hsla[2] + '%, ' + hsla[3] + ')';\n};\n\n// hwb is a bit different than rgb(a) & hsl(a) since there is no alpha specific syntax\n// (hwb have alpha optional & 1 is default value)\ncs.to.hwb = function () {\n\tvar hwba = swizzle(arguments);\n\n\tvar a = '';\n\tif (hwba.length >= 4 && hwba[3] !== 1) {\n\t\ta = ', ' + hwba[3];\n\t}\n\n\treturn 'hwb(' + hwba[0] + ', ' + hwba[1] + '%, ' + hwba[2] + '%' + a + ')';\n};\n\ncs.to.keyword = function (rgb) {\n\treturn reverseNames[rgb.slice(0, 3)];\n};\n\n// helpers\nfunction clamp(num, min, max) {\n\treturn Math.min(Math.max(min, num), max);\n}\n\nfunction hexDouble(num) {\n\tvar str = Math.round(num).toString(16).toUpperCase();\n\treturn (str.length < 2) ? '0' + str : str;\n}\n","/* MIT license */\n/* eslint-disable no-mixed-operators */\nconst cssKeywords = require('color-name');\n\n// NOTE: conversions should only return primitive values (i.e. arrays, or\n//       values that give correct `typeof` results).\n//       do not use box values types (i.e. Number(), String(), etc.)\n\nconst reverseKeywords = {};\nfor (const key of Object.keys(cssKeywords)) {\n\treverseKeywords[cssKeywords[key]] = key;\n}\n\nconst convert = {\n\trgb: {channels: 3, labels: 'rgb'},\n\thsl: {channels: 3, labels: 'hsl'},\n\thsv: {channels: 3, labels: 'hsv'},\n\thwb: {channels: 3, labels: 'hwb'},\n\tcmyk: {channels: 4, labels: 'cmyk'},\n\txyz: {channels: 3, labels: 'xyz'},\n\tlab: {channels: 3, labels: 'lab'},\n\tlch: {channels: 3, labels: 'lch'},\n\thex: {channels: 1, labels: ['hex']},\n\tkeyword: {channels: 1, labels: ['keyword']},\n\tansi16: {channels: 1, labels: ['ansi16']},\n\tansi256: {channels: 1, labels: ['ansi256']},\n\thcg: {channels: 3, labels: ['h', 'c', 'g']},\n\tapple: {channels: 3, labels: ['r16', 'g16', 'b16']},\n\tgray: {channels: 1, labels: ['gray']}\n};\n\nmodule.exports = convert;\n\n// Hide .channels and .labels properties\nfor (const model of Object.keys(convert)) {\n\tif (!('channels' in convert[model])) {\n\t\tthrow new Error('missing channels property: ' + model);\n\t}\n\n\tif (!('labels' in convert[model])) {\n\t\tthrow new Error('missing channel labels property: ' + model);\n\t}\n\n\tif (convert[model].labels.length !== convert[model].channels) {\n\t\tthrow new Error('channel and label counts mismatch: ' + model);\n\t}\n\n\tconst {channels, labels} = convert[model];\n\tdelete convert[model].channels;\n\tdelete convert[model].labels;\n\tObject.defineProperty(convert[model], 'channels', {value: channels});\n\tObject.defineProperty(convert[model], 'labels', {value: labels});\n}\n\nconvert.rgb.hsl = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst min = Math.min(r, g, b);\n\tconst max = Math.max(r, g, b);\n\tconst delta = max - min;\n\tlet h;\n\tlet s;\n\n\tif (max === min) {\n\t\th = 0;\n\t} else if (r === max) {\n\t\th = (g - b) / delta;\n\t} else if (g === max) {\n\t\th = 2 + (b - r) / delta;\n\t} else if (b === max) {\n\t\th = 4 + (r - g) / delta;\n\t}\n\n\th = Math.min(h * 60, 360);\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst l = (min + max) / 2;\n\n\tif (max === min) {\n\t\ts = 0;\n\t} else if (l <= 0.5) {\n\t\ts = delta / (max + min);\n\t} else {\n\t\ts = delta / (2 - max - min);\n\t}\n\n\treturn [h, s * 100, l * 100];\n};\n\nconvert.rgb.hsv = function (rgb) {\n\tlet rdif;\n\tlet gdif;\n\tlet bdif;\n\tlet h;\n\tlet s;\n\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst v = Math.max(r, g, b);\n\tconst diff = v - Math.min(r, g, b);\n\tconst diffc = function (c) {\n\t\treturn (v - c) / 6 / diff + 1 / 2;\n\t};\n\n\tif (diff === 0) {\n\t\th = 0;\n\t\ts = 0;\n\t} else {\n\t\ts = diff / v;\n\t\trdif = diffc(r);\n\t\tgdif = diffc(g);\n\t\tbdif = diffc(b);\n\n\t\tif (r === v) {\n\t\t\th = bdif - gdif;\n\t\t} else if (g === v) {\n\t\t\th = (1 / 3) + rdif - bdif;\n\t\t} else if (b === v) {\n\t\t\th = (2 / 3) + gdif - rdif;\n\t\t}\n\n\t\tif (h < 0) {\n\t\t\th += 1;\n\t\t} else if (h > 1) {\n\t\t\th -= 1;\n\t\t}\n\t}\n\n\treturn [\n\t\th * 360,\n\t\ts * 100,\n\t\tv * 100\n\t];\n};\n\nconvert.rgb.hwb = function (rgb) {\n\tconst r = rgb[0];\n\tconst g = rgb[1];\n\tlet b = rgb[2];\n\tconst h = convert.rgb.hsl(rgb)[0];\n\tconst w = 1 / 255 * Math.min(r, Math.min(g, b));\n\n\tb = 1 - 1 / 255 * Math.max(r, Math.max(g, b));\n\n\treturn [h, w * 100, b * 100];\n};\n\nconvert.rgb.cmyk = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\n\tconst k = Math.min(1 - r, 1 - g, 1 - b);\n\tconst c = (1 - r - k) / (1 - k) || 0;\n\tconst m = (1 - g - k) / (1 - k) || 0;\n\tconst y = (1 - b - k) / (1 - k) || 0;\n\n\treturn [c * 100, m * 100, y * 100, k * 100];\n};\n\nfunction comparativeDistance(x, y) {\n\t/*\n\t\tSee https://en.m.wikipedia.org/wiki/Euclidean_distance#Squared_Euclidean_distance\n\t*/\n\treturn (\n\t\t((x[0] - y[0]) ** 2) +\n\t\t((x[1] - y[1]) ** 2) +\n\t\t((x[2] - y[2]) ** 2)\n\t);\n}\n\nconvert.rgb.keyword = function (rgb) {\n\tconst reversed = reverseKeywords[rgb];\n\tif (reversed) {\n\t\treturn reversed;\n\t}\n\n\tlet currentClosestDistance = Infinity;\n\tlet currentClosestKeyword;\n\n\tfor (const keyword of Object.keys(cssKeywords)) {\n\t\tconst value = cssKeywords[keyword];\n\n\t\t// Compute comparative distance\n\t\tconst distance = comparativeDistance(rgb, value);\n\n\t\t// Check if its less, if so set as closest\n\t\tif (distance < currentClosestDistance) {\n\t\t\tcurrentClosestDistance = distance;\n\t\t\tcurrentClosestKeyword = keyword;\n\t\t}\n\t}\n\n\treturn currentClosestKeyword;\n};\n\nconvert.keyword.rgb = function (keyword) {\n\treturn cssKeywords[keyword];\n};\n\nconvert.rgb.xyz = function (rgb) {\n\tlet r = rgb[0] / 255;\n\tlet g = rgb[1] / 255;\n\tlet b = rgb[2] / 255;\n\n\t// Assume sRGB\n\tr = r > 0.04045 ? (((r + 0.055) / 1.055) ** 2.4) : (r / 12.92);\n\tg = g > 0.04045 ? (((g + 0.055) / 1.055) ** 2.4) : (g / 12.92);\n\tb = b > 0.04045 ? (((b + 0.055) / 1.055) ** 2.4) : (b / 12.92);\n\n\tconst x = (r * 0.4124) + (g * 0.3576) + (b * 0.1805);\n\tconst y = (r * 0.2126) + (g * 0.7152) + (b * 0.0722);\n\tconst z = (r * 0.0193) + (g * 0.1192) + (b * 0.9505);\n\n\treturn [x * 100, y * 100, z * 100];\n};\n\nconvert.rgb.lab = function (rgb) {\n\tconst xyz = convert.rgb.xyz(rgb);\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.hsl.rgb = function (hsl) {\n\tconst h = hsl[0] / 360;\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\tlet t2;\n\tlet t3;\n\tlet val;\n\n\tif (s === 0) {\n\t\tval = l * 255;\n\t\treturn [val, val, val];\n\t}\n\n\tif (l < 0.5) {\n\t\tt2 = l * (1 + s);\n\t} else {\n\t\tt2 = l + s - l * s;\n\t}\n\n\tconst t1 = 2 * l - t2;\n\n\tconst rgb = [0, 0, 0];\n\tfor (let i = 0; i < 3; i++) {\n\t\tt3 = h + 1 / 3 * -(i - 1);\n\t\tif (t3 < 0) {\n\t\t\tt3++;\n\t\t}\n\n\t\tif (t3 > 1) {\n\t\t\tt3--;\n\t\t}\n\n\t\tif (6 * t3 < 1) {\n\t\t\tval = t1 + (t2 - t1) * 6 * t3;\n\t\t} else if (2 * t3 < 1) {\n\t\t\tval = t2;\n\t\t} else if (3 * t3 < 2) {\n\t\t\tval = t1 + (t2 - t1) * (2 / 3 - t3) * 6;\n\t\t} else {\n\t\t\tval = t1;\n\t\t}\n\n\t\trgb[i] = val * 255;\n\t}\n\n\treturn rgb;\n};\n\nconvert.hsl.hsv = function (hsl) {\n\tconst h = hsl[0];\n\tlet s = hsl[1] / 100;\n\tlet l = hsl[2] / 100;\n\tlet smin = s;\n\tconst lmin = Math.max(l, 0.01);\n\n\tl *= 2;\n\ts *= (l <= 1) ? l : 2 - l;\n\tsmin *= lmin <= 1 ? lmin : 2 - lmin;\n\tconst v = (l + s) / 2;\n\tconst sv = l === 0 ? (2 * smin) / (lmin + smin) : (2 * s) / (l + s);\n\n\treturn [h, sv * 100, v * 100];\n};\n\nconvert.hsv.rgb = function (hsv) {\n\tconst h = hsv[0] / 60;\n\tconst s = hsv[1] / 100;\n\tlet v = hsv[2] / 100;\n\tconst hi = Math.floor(h) % 6;\n\n\tconst f = h - Math.floor(h);\n\tconst p = 255 * v * (1 - s);\n\tconst q = 255 * v * (1 - (s * f));\n\tconst t = 255 * v * (1 - (s * (1 - f)));\n\tv *= 255;\n\n\tswitch (hi) {\n\t\tcase 0:\n\t\t\treturn [v, t, p];\n\t\tcase 1:\n\t\t\treturn [q, v, p];\n\t\tcase 2:\n\t\t\treturn [p, v, t];\n\t\tcase 3:\n\t\t\treturn [p, q, v];\n\t\tcase 4:\n\t\t\treturn [t, p, v];\n\t\tcase 5:\n\t\t\treturn [v, p, q];\n\t}\n};\n\nconvert.hsv.hsl = function (hsv) {\n\tconst h = hsv[0];\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\tconst vmin = Math.max(v, 0.01);\n\tlet sl;\n\tlet l;\n\n\tl = (2 - s) * v;\n\tconst lmin = (2 - s) * vmin;\n\tsl = s * vmin;\n\tsl /= (lmin <= 1) ? lmin : 2 - lmin;\n\tsl = sl || 0;\n\tl /= 2;\n\n\treturn [h, sl * 100, l * 100];\n};\n\n// http://dev.w3.org/csswg/css-color/#hwb-to-rgb\nconvert.hwb.rgb = function (hwb) {\n\tconst h = hwb[0] / 360;\n\tlet wh = hwb[1] / 100;\n\tlet bl = hwb[2] / 100;\n\tconst ratio = wh + bl;\n\tlet f;\n\n\t// Wh + bl cant be > 1\n\tif (ratio > 1) {\n\t\twh /= ratio;\n\t\tbl /= ratio;\n\t}\n\n\tconst i = Math.floor(6 * h);\n\tconst v = 1 - bl;\n\tf = 6 * h - i;\n\n\tif ((i & 0x01) !== 0) {\n\t\tf = 1 - f;\n\t}\n\n\tconst n = wh + f * (v - wh); // Linear interpolation\n\n\tlet r;\n\tlet g;\n\tlet b;\n\t/* eslint-disable max-statements-per-line,no-multi-spaces */\n\tswitch (i) {\n\t\tdefault:\n\t\tcase 6:\n\t\tcase 0: r = v;  g = n;  b = wh; break;\n\t\tcase 1: r = n;  g = v;  b = wh; break;\n\t\tcase 2: r = wh; g = v;  b = n; break;\n\t\tcase 3: r = wh; g = n;  b = v; break;\n\t\tcase 4: r = n;  g = wh; b = v; break;\n\t\tcase 5: r = v;  g = wh; b = n; break;\n\t}\n\t/* eslint-enable max-statements-per-line,no-multi-spaces */\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.cmyk.rgb = function (cmyk) {\n\tconst c = cmyk[0] / 100;\n\tconst m = cmyk[1] / 100;\n\tconst y = cmyk[2] / 100;\n\tconst k = cmyk[3] / 100;\n\n\tconst r = 1 - Math.min(1, c * (1 - k) + k);\n\tconst g = 1 - Math.min(1, m * (1 - k) + k);\n\tconst b = 1 - Math.min(1, y * (1 - k) + k);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.rgb = function (xyz) {\n\tconst x = xyz[0] / 100;\n\tconst y = xyz[1] / 100;\n\tconst z = xyz[2] / 100;\n\tlet r;\n\tlet g;\n\tlet b;\n\n\tr = (x * 3.2406) + (y * -1.5372) + (z * -0.4986);\n\tg = (x * -0.9689) + (y * 1.8758) + (z * 0.0415);\n\tb = (x * 0.0557) + (y * -0.2040) + (z * 1.0570);\n\n\t// Assume sRGB\n\tr = r > 0.0031308\n\t\t? ((1.055 * (r ** (1.0 / 2.4))) - 0.055)\n\t\t: r * 12.92;\n\n\tg = g > 0.0031308\n\t\t? ((1.055 * (g ** (1.0 / 2.4))) - 0.055)\n\t\t: g * 12.92;\n\n\tb = b > 0.0031308\n\t\t? ((1.055 * (b ** (1.0 / 2.4))) - 0.055)\n\t\t: b * 12.92;\n\n\tr = Math.min(Math.max(0, r), 1);\n\tg = Math.min(Math.max(0, g), 1);\n\tb = Math.min(Math.max(0, b), 1);\n\n\treturn [r * 255, g * 255, b * 255];\n};\n\nconvert.xyz.lab = function (xyz) {\n\tlet x = xyz[0];\n\tlet y = xyz[1];\n\tlet z = xyz[2];\n\n\tx /= 95.047;\n\ty /= 100;\n\tz /= 108.883;\n\n\tx = x > 0.008856 ? (x ** (1 / 3)) : (7.787 * x) + (16 / 116);\n\ty = y > 0.008856 ? (y ** (1 / 3)) : (7.787 * y) + (16 / 116);\n\tz = z > 0.008856 ? (z ** (1 / 3)) : (7.787 * z) + (16 / 116);\n\n\tconst l = (116 * y) - 16;\n\tconst a = 500 * (x - y);\n\tconst b = 200 * (y - z);\n\n\treturn [l, a, b];\n};\n\nconvert.lab.xyz = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet x;\n\tlet y;\n\tlet z;\n\n\ty = (l + 16) / 116;\n\tx = a / 500 + y;\n\tz = y - b / 200;\n\n\tconst y2 = y ** 3;\n\tconst x2 = x ** 3;\n\tconst z2 = z ** 3;\n\ty = y2 > 0.008856 ? y2 : (y - 16 / 116) / 7.787;\n\tx = x2 > 0.008856 ? x2 : (x - 16 / 116) / 7.787;\n\tz = z2 > 0.008856 ? z2 : (z - 16 / 116) / 7.787;\n\n\tx *= 95.047;\n\ty *= 100;\n\tz *= 108.883;\n\n\treturn [x, y, z];\n};\n\nconvert.lab.lch = function (lab) {\n\tconst l = lab[0];\n\tconst a = lab[1];\n\tconst b = lab[2];\n\tlet h;\n\n\tconst hr = Math.atan2(b, a);\n\th = hr * 360 / 2 / Math.PI;\n\n\tif (h < 0) {\n\t\th += 360;\n\t}\n\n\tconst c = Math.sqrt(a * a + b * b);\n\n\treturn [l, c, h];\n};\n\nconvert.lch.lab = function (lch) {\n\tconst l = lch[0];\n\tconst c = lch[1];\n\tconst h = lch[2];\n\n\tconst hr = h / 360 * 2 * Math.PI;\n\tconst a = c * Math.cos(hr);\n\tconst b = c * Math.sin(hr);\n\n\treturn [l, a, b];\n};\n\nconvert.rgb.ansi16 = function (args, saturation = null) {\n\tconst [r, g, b] = args;\n\tlet value = saturation === null ? convert.rgb.hsv(args)[2] : saturation; // Hsv -> ansi16 optimization\n\n\tvalue = Math.round(value / 50);\n\n\tif (value === 0) {\n\t\treturn 30;\n\t}\n\n\tlet ansi = 30\n\t\t+ ((Math.round(b / 255) << 2)\n\t\t| (Math.round(g / 255) << 1)\n\t\t| Math.round(r / 255));\n\n\tif (value === 2) {\n\t\tansi += 60;\n\t}\n\n\treturn ansi;\n};\n\nconvert.hsv.ansi16 = function (args) {\n\t// Optimization here; we already know the value and don't need to get\n\t// it converted for us.\n\treturn convert.rgb.ansi16(convert.hsv.rgb(args), args[2]);\n};\n\nconvert.rgb.ansi256 = function (args) {\n\tconst r = args[0];\n\tconst g = args[1];\n\tconst b = args[2];\n\n\t// We use the extended greyscale palette here, with the exception of\n\t// black and white. normal palette only has 4 greyscale shades.\n\tif (r === g && g === b) {\n\t\tif (r < 8) {\n\t\t\treturn 16;\n\t\t}\n\n\t\tif (r > 248) {\n\t\t\treturn 231;\n\t\t}\n\n\t\treturn Math.round(((r - 8) / 247) * 24) + 232;\n\t}\n\n\tconst ansi = 16\n\t\t+ (36 * Math.round(r / 255 * 5))\n\t\t+ (6 * Math.round(g / 255 * 5))\n\t\t+ Math.round(b / 255 * 5);\n\n\treturn ansi;\n};\n\nconvert.ansi16.rgb = function (args) {\n\tlet color = args % 10;\n\n\t// Handle greyscale\n\tif (color === 0 || color === 7) {\n\t\tif (args > 50) {\n\t\t\tcolor += 3.5;\n\t\t}\n\n\t\tcolor = color / 10.5 * 255;\n\n\t\treturn [color, color, color];\n\t}\n\n\tconst mult = (~~(args > 50) + 1) * 0.5;\n\tconst r = ((color & 1) * mult) * 255;\n\tconst g = (((color >> 1) & 1) * mult) * 255;\n\tconst b = (((color >> 2) & 1) * mult) * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.ansi256.rgb = function (args) {\n\t// Handle greyscale\n\tif (args >= 232) {\n\t\tconst c = (args - 232) * 10 + 8;\n\t\treturn [c, c, c];\n\t}\n\n\targs -= 16;\n\n\tlet rem;\n\tconst r = Math.floor(args / 36) / 5 * 255;\n\tconst g = Math.floor((rem = args % 36) / 6) / 5 * 255;\n\tconst b = (rem % 6) / 5 * 255;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hex = function (args) {\n\tconst integer = ((Math.round(args[0]) & 0xFF) << 16)\n\t\t+ ((Math.round(args[1]) & 0xFF) << 8)\n\t\t+ (Math.round(args[2]) & 0xFF);\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.hex.rgb = function (args) {\n\tconst match = args.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);\n\tif (!match) {\n\t\treturn [0, 0, 0];\n\t}\n\n\tlet colorString = match[0];\n\n\tif (match[0].length === 3) {\n\t\tcolorString = colorString.split('').map(char => {\n\t\t\treturn char + char;\n\t\t}).join('');\n\t}\n\n\tconst integer = parseInt(colorString, 16);\n\tconst r = (integer >> 16) & 0xFF;\n\tconst g = (integer >> 8) & 0xFF;\n\tconst b = integer & 0xFF;\n\n\treturn [r, g, b];\n};\n\nconvert.rgb.hcg = function (rgb) {\n\tconst r = rgb[0] / 255;\n\tconst g = rgb[1] / 255;\n\tconst b = rgb[2] / 255;\n\tconst max = Math.max(Math.max(r, g), b);\n\tconst min = Math.min(Math.min(r, g), b);\n\tconst chroma = (max - min);\n\tlet grayscale;\n\tlet hue;\n\n\tif (chroma < 1) {\n\t\tgrayscale = min / (1 - chroma);\n\t} else {\n\t\tgrayscale = 0;\n\t}\n\n\tif (chroma <= 0) {\n\t\thue = 0;\n\t} else\n\tif (max === r) {\n\t\thue = ((g - b) / chroma) % 6;\n\t} else\n\tif (max === g) {\n\t\thue = 2 + (b - r) / chroma;\n\t} else {\n\t\thue = 4 + (r - g) / chroma;\n\t}\n\n\thue /= 6;\n\thue %= 1;\n\n\treturn [hue * 360, chroma * 100, grayscale * 100];\n};\n\nconvert.hsl.hcg = function (hsl) {\n\tconst s = hsl[1] / 100;\n\tconst l = hsl[2] / 100;\n\n\tconst c = l < 0.5 ? (2.0 * s * l) : (2.0 * s * (1.0 - l));\n\n\tlet f = 0;\n\tif (c < 1.0) {\n\t\tf = (l - 0.5 * c) / (1.0 - c);\n\t}\n\n\treturn [hsl[0], c * 100, f * 100];\n};\n\nconvert.hsv.hcg = function (hsv) {\n\tconst s = hsv[1] / 100;\n\tconst v = hsv[2] / 100;\n\n\tconst c = s * v;\n\tlet f = 0;\n\n\tif (c < 1.0) {\n\t\tf = (v - c) / (1 - c);\n\t}\n\n\treturn [hsv[0], c * 100, f * 100];\n};\n\nconvert.hcg.rgb = function (hcg) {\n\tconst h = hcg[0] / 360;\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tif (c === 0.0) {\n\t\treturn [g * 255, g * 255, g * 255];\n\t}\n\n\tconst pure = [0, 0, 0];\n\tconst hi = (h % 1) * 6;\n\tconst v = hi % 1;\n\tconst w = 1 - v;\n\tlet mg = 0;\n\n\t/* eslint-disable max-statements-per-line */\n\tswitch (Math.floor(hi)) {\n\t\tcase 0:\n\t\t\tpure[0] = 1; pure[1] = v; pure[2] = 0; break;\n\t\tcase 1:\n\t\t\tpure[0] = w; pure[1] = 1; pure[2] = 0; break;\n\t\tcase 2:\n\t\t\tpure[0] = 0; pure[1] = 1; pure[2] = v; break;\n\t\tcase 3:\n\t\t\tpure[0] = 0; pure[1] = w; pure[2] = 1; break;\n\t\tcase 4:\n\t\t\tpure[0] = v; pure[1] = 0; pure[2] = 1; break;\n\t\tdefault:\n\t\t\tpure[0] = 1; pure[1] = 0; pure[2] = w;\n\t}\n\t/* eslint-enable max-statements-per-line */\n\n\tmg = (1.0 - c) * g;\n\n\treturn [\n\t\t(c * pure[0] + mg) * 255,\n\t\t(c * pure[1] + mg) * 255,\n\t\t(c * pure[2] + mg) * 255\n\t];\n};\n\nconvert.hcg.hsv = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst v = c + g * (1.0 - c);\n\tlet f = 0;\n\n\tif (v > 0.0) {\n\t\tf = c / v;\n\t}\n\n\treturn [hcg[0], f * 100, v * 100];\n};\n\nconvert.hcg.hsl = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\n\tconst l = g * (1.0 - c) + 0.5 * c;\n\tlet s = 0;\n\n\tif (l > 0.0 && l < 0.5) {\n\t\ts = c / (2 * l);\n\t} else\n\tif (l >= 0.5 && l < 1.0) {\n\t\ts = c / (2 * (1 - l));\n\t}\n\n\treturn [hcg[0], s * 100, l * 100];\n};\n\nconvert.hcg.hwb = function (hcg) {\n\tconst c = hcg[1] / 100;\n\tconst g = hcg[2] / 100;\n\tconst v = c + g * (1.0 - c);\n\treturn [hcg[0], (v - c) * 100, (1 - v) * 100];\n};\n\nconvert.hwb.hcg = function (hwb) {\n\tconst w = hwb[1] / 100;\n\tconst b = hwb[2] / 100;\n\tconst v = 1 - b;\n\tconst c = v - w;\n\tlet g = 0;\n\n\tif (c < 1) {\n\t\tg = (v - c) / (1 - c);\n\t}\n\n\treturn [hwb[0], c * 100, g * 100];\n};\n\nconvert.apple.rgb = function (apple) {\n\treturn [(apple[0] / 65535) * 255, (apple[1] / 65535) * 255, (apple[2] / 65535) * 255];\n};\n\nconvert.rgb.apple = function (rgb) {\n\treturn [(rgb[0] / 255) * 65535, (rgb[1] / 255) * 65535, (rgb[2] / 255) * 65535];\n};\n\nconvert.gray.rgb = function (args) {\n\treturn [args[0] / 100 * 255, args[0] / 100 * 255, args[0] / 100 * 255];\n};\n\nconvert.gray.hsl = function (args) {\n\treturn [0, 0, args[0]];\n};\n\nconvert.gray.hsv = convert.gray.hsl;\n\nconvert.gray.hwb = function (gray) {\n\treturn [0, 100, gray[0]];\n};\n\nconvert.gray.cmyk = function (gray) {\n\treturn [0, 0, 0, gray[0]];\n};\n\nconvert.gray.lab = function (gray) {\n\treturn [gray[0], 0, 0];\n};\n\nconvert.gray.hex = function (gray) {\n\tconst val = Math.round(gray[0] / 100 * 255) & 0xFF;\n\tconst integer = (val << 16) + (val << 8) + val;\n\n\tconst string = integer.toString(16).toUpperCase();\n\treturn '000000'.substring(string.length) + string;\n};\n\nconvert.rgb.gray = function (rgb) {\n\tconst val = (rgb[0] + rgb[1] + rgb[2]) / 3;\n\treturn [val / 255 * 100];\n};\n","const conversions = require('./conversions');\n\n/*\n\tThis function routes a model to all other models.\n\n\tall functions that are routed have a property `.conversion` attached\n\tto the returned synthetic function. This property is an array\n\tof strings, each with the steps in between the 'from' and 'to'\n\tcolor models (inclusive).\n\n\tconversions that are not possible simply are not included.\n*/\n\nfunction buildGraph() {\n\tconst graph = {};\n\t// https://jsperf.com/object-keys-vs-for-in-with-closure/3\n\tconst models = Object.keys(conversions);\n\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tgraph[models[i]] = {\n\t\t\t// http://jsperf.com/1-vs-infinity\n\t\t\t// micro-opt, but this is simple.\n\t\t\tdistance: -1,\n\t\t\tparent: null\n\t\t};\n\t}\n\n\treturn graph;\n}\n\n// https://en.wikipedia.org/wiki/Breadth-first_search\nfunction deriveBFS(fromModel) {\n\tconst graph = buildGraph();\n\tconst queue = [fromModel]; // Unshift -> queue -> pop\n\n\tgraph[fromModel].distance = 0;\n\n\twhile (queue.length) {\n\t\tconst current = queue.pop();\n\t\tconst adjacents = Object.keys(conversions[current]);\n\n\t\tfor (let len = adjacents.length, i = 0; i < len; i++) {\n\t\t\tconst adjacent = adjacents[i];\n\t\t\tconst node = graph[adjacent];\n\n\t\t\tif (node.distance === -1) {\n\t\t\t\tnode.distance = graph[current].distance + 1;\n\t\t\t\tnode.parent = current;\n\t\t\t\tqueue.unshift(adjacent);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn graph;\n}\n\nfunction link(from, to) {\n\treturn function (args) {\n\t\treturn to(from(args));\n\t};\n}\n\nfunction wrapConversion(toModel, graph) {\n\tconst path = [graph[toModel].parent, toModel];\n\tlet fn = conversions[graph[toModel].parent][toModel];\n\n\tlet cur = graph[toModel].parent;\n\twhile (graph[cur].parent) {\n\t\tpath.unshift(graph[cur].parent);\n\t\tfn = link(conversions[graph[cur].parent][cur], fn);\n\t\tcur = graph[cur].parent;\n\t}\n\n\tfn.conversion = path;\n\treturn fn;\n}\n\nmodule.exports = function (fromModel) {\n\tconst graph = deriveBFS(fromModel);\n\tconst conversion = {};\n\n\tconst models = Object.keys(graph);\n\tfor (let len = models.length, i = 0; i < len; i++) {\n\t\tconst toModel = models[i];\n\t\tconst node = graph[toModel];\n\n\t\tif (node.parent === null) {\n\t\t\t// No possible conversion, or this node is the source model.\n\t\t\tcontinue;\n\t\t}\n\n\t\tconversion[toModel] = wrapConversion(toModel, graph);\n\t}\n\n\treturn conversion;\n};\n\n","const conversions = require('./conversions');\nconst route = require('./route');\n\nconst convert = {};\n\nconst models = Object.keys(conversions);\n\nfunction wrapRaw(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\treturn fn(args);\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nfunction wrapRounded(fn) {\n\tconst wrappedFn = function (...args) {\n\t\tconst arg0 = args[0];\n\n\t\tif (arg0 === undefined || arg0 === null) {\n\t\t\treturn arg0;\n\t\t}\n\n\t\tif (arg0.length > 1) {\n\t\t\targs = arg0;\n\t\t}\n\n\t\tconst result = fn(args);\n\n\t\t// We're assuming the result is an array here.\n\t\t// see notice in conversions.js; don't use box types\n\t\t// in conversion functions.\n\t\tif (typeof result === 'object') {\n\t\t\tfor (let len = result.length, i = 0; i < len; i++) {\n\t\t\t\tresult[i] = Math.round(result[i]);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t};\n\n\t// Preserve .conversion property if there is one\n\tif ('conversion' in fn) {\n\t\twrappedFn.conversion = fn.conversion;\n\t}\n\n\treturn wrappedFn;\n}\n\nmodels.forEach(fromModel => {\n\tconvert[fromModel] = {};\n\n\tObject.defineProperty(convert[fromModel], 'channels', {value: conversions[fromModel].channels});\n\tObject.defineProperty(convert[fromModel], 'labels', {value: conversions[fromModel].labels});\n\n\tconst routes = route(fromModel);\n\tconst routeModels = Object.keys(routes);\n\n\trouteModels.forEach(toModel => {\n\t\tconst fn = routes[toModel];\n\n\t\tconvert[fromModel][toModel] = wrapRounded(fn);\n\t\tconvert[fromModel][toModel].raw = wrapRaw(fn);\n\t});\n});\n\nmodule.exports = convert;\n","const colorString = require('color-string');\nconst convert = require('color-convert');\n\nconst skippedModels = [\n\t// To be honest, I don't really feel like keyword belongs in color convert, but eh.\n\t'keyword',\n\n\t// Gray conflicts with some method names, and has its own method defined.\n\t'gray',\n\n\t// Shouldn't really be in color-convert either...\n\t'hex',\n];\n\nconst hashedModelKeys = {};\nfor (const model of Object.keys(convert)) {\n\thashedModelKeys[[...convert[model].labels].sort().join('')] = model;\n}\n\nconst limiters = {};\n\nfunction Color(object, model) {\n\tif (!(this instanceof Color)) {\n\t\treturn new Color(object, model);\n\t}\n\n\tif (model && model in skippedModels) {\n\t\tmodel = null;\n\t}\n\n\tif (model && !(model in convert)) {\n\t\tthrow new Error('Unknown model: ' + model);\n\t}\n\n\tlet i;\n\tlet channels;\n\n\tif (object == null) { // eslint-disable-line no-eq-null,eqeqeq\n\t\tthis.model = 'rgb';\n\t\tthis.color = [0, 0, 0];\n\t\tthis.valpha = 1;\n\t} else if (object instanceof Color) {\n\t\tthis.model = object.model;\n\t\tthis.color = [...object.color];\n\t\tthis.valpha = object.valpha;\n\t} else if (typeof object === 'string') {\n\t\tconst result = colorString.get(object);\n\t\tif (result === null) {\n\t\t\tthrow new Error('Unable to parse color from string: ' + object);\n\t\t}\n\n\t\tthis.model = result.model;\n\t\tchannels = convert[this.model].channels;\n\t\tthis.color = result.value.slice(0, channels);\n\t\tthis.valpha = typeof result.value[channels] === 'number' ? result.value[channels] : 1;\n\t} else if (object.length > 0) {\n\t\tthis.model = model || 'rgb';\n\t\tchannels = convert[this.model].channels;\n\t\tconst newArray = Array.prototype.slice.call(object, 0, channels);\n\t\tthis.color = zeroArray(newArray, channels);\n\t\tthis.valpha = typeof object[channels] === 'number' ? object[channels] : 1;\n\t} else if (typeof object === 'number') {\n\t\t// This is always RGB - can be converted later on.\n\t\tthis.model = 'rgb';\n\t\tthis.color = [\n\t\t\t(object >> 16) & 0xFF,\n\t\t\t(object >> 8) & 0xFF,\n\t\t\tobject & 0xFF,\n\t\t];\n\t\tthis.valpha = 1;\n\t} else {\n\t\tthis.valpha = 1;\n\n\t\tconst keys = Object.keys(object);\n\t\tif ('alpha' in object) {\n\t\t\tkeys.splice(keys.indexOf('alpha'), 1);\n\t\t\tthis.valpha = typeof object.alpha === 'number' ? object.alpha : 0;\n\t\t}\n\n\t\tconst hashedKeys = keys.sort().join('');\n\t\tif (!(hashedKeys in hashedModelKeys)) {\n\t\t\tthrow new Error('Unable to parse color from object: ' + JSON.stringify(object));\n\t\t}\n\n\t\tthis.model = hashedModelKeys[hashedKeys];\n\n\t\tconst {labels} = convert[this.model];\n\t\tconst color = [];\n\t\tfor (i = 0; i < labels.length; i++) {\n\t\t\tcolor.push(object[labels[i]]);\n\t\t}\n\n\t\tthis.color = zeroArray(color);\n\t}\n\n\t// Perform limitations (clamping, etc.)\n\tif (limiters[this.model]) {\n\t\tchannels = convert[this.model].channels;\n\t\tfor (i = 0; i < channels; i++) {\n\t\t\tconst limit = limiters[this.model][i];\n\t\t\tif (limit) {\n\t\t\t\tthis.color[i] = limit(this.color[i]);\n\t\t\t}\n\t\t}\n\t}\n\n\tthis.valpha = Math.max(0, Math.min(1, this.valpha));\n\n\tif (Object.freeze) {\n\t\tObject.freeze(this);\n\t}\n}\n\nColor.prototype = {\n\ttoString() {\n\t\treturn this.string();\n\t},\n\n\ttoJSON() {\n\t\treturn this[this.model]();\n\t},\n\n\tstring(places) {\n\t\tlet self = this.model in colorString.to ? this : this.rgb();\n\t\tself = self.round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to[self.model](args);\n\t},\n\n\tpercentString(places) {\n\t\tconst self = this.rgb().round(typeof places === 'number' ? places : 1);\n\t\tconst args = self.valpha === 1 ? self.color : [...self.color, this.valpha];\n\t\treturn colorString.to.rgb.percent(args);\n\t},\n\n\tarray() {\n\t\treturn this.valpha === 1 ? [...this.color] : [...this.color, this.valpha];\n\t},\n\n\tobject() {\n\t\tconst result = {};\n\t\tconst {channels} = convert[this.model];\n\t\tconst {labels} = convert[this.model];\n\n\t\tfor (let i = 0; i < channels; i++) {\n\t\t\tresult[labels[i]] = this.color[i];\n\t\t}\n\n\t\tif (this.valpha !== 1) {\n\t\t\tresult.alpha = this.valpha;\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tunitArray() {\n\t\tconst rgb = this.rgb().color;\n\t\trgb[0] /= 255;\n\t\trgb[1] /= 255;\n\t\trgb[2] /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.push(this.valpha);\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tunitObject() {\n\t\tconst rgb = this.rgb().object();\n\t\trgb.r /= 255;\n\t\trgb.g /= 255;\n\t\trgb.b /= 255;\n\n\t\tif (this.valpha !== 1) {\n\t\t\trgb.alpha = this.valpha;\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tround(places) {\n\t\tplaces = Math.max(places || 0, 0);\n\t\treturn new Color([...this.color.map(roundToPlace(places)), this.valpha], this.model);\n\t},\n\n\talpha(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color([...this.color, Math.max(0, Math.min(1, value))], this.model);\n\t\t}\n\n\t\treturn this.valpha;\n\t},\n\n\t// Rgb\n\tred: getset('rgb', 0, maxfn(255)),\n\tgreen: getset('rgb', 1, maxfn(255)),\n\tblue: getset('rgb', 2, maxfn(255)),\n\n\thue: getset(['hsl', 'hsv', 'hsl', 'hwb', 'hcg'], 0, value => ((value % 360) + 360) % 360),\n\n\tsaturationl: getset('hsl', 1, maxfn(100)),\n\tlightness: getset('hsl', 2, maxfn(100)),\n\n\tsaturationv: getset('hsv', 1, maxfn(100)),\n\tvalue: getset('hsv', 2, maxfn(100)),\n\n\tchroma: getset('hcg', 1, maxfn(100)),\n\tgray: getset('hcg', 2, maxfn(100)),\n\n\twhite: getset('hwb', 1, maxfn(100)),\n\twblack: getset('hwb', 2, maxfn(100)),\n\n\tcyan: getset('cmyk', 0, maxfn(100)),\n\tmagenta: getset('cmyk', 1, maxfn(100)),\n\tyellow: getset('cmyk', 2, maxfn(100)),\n\tblack: getset('cmyk', 3, maxfn(100)),\n\n\tx: getset('xyz', 0, maxfn(95.047)),\n\ty: getset('xyz', 1, maxfn(100)),\n\tz: getset('xyz', 2, maxfn(108.833)),\n\n\tl: getset('lab', 0, maxfn(100)),\n\ta: getset('lab', 1),\n\tb: getset('lab', 2),\n\n\tkeyword(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn convert[this.model].keyword(this.color);\n\t},\n\n\thex(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\treturn colorString.to.hex(this.rgb().round().color);\n\t},\n\n\thexa(value) {\n\t\tif (value !== undefined) {\n\t\t\treturn new Color(value);\n\t\t}\n\n\t\tconst rgbArray = this.rgb().round().color;\n\n\t\tlet alphaHex = Math.round(this.valpha * 255).toString(16).toUpperCase();\n\t\tif (alphaHex.length === 1) {\n\t\t\talphaHex = '0' + alphaHex;\n\t\t}\n\n\t\treturn colorString.to.hex(rgbArray) + alphaHex;\n\t},\n\n\trgbNumber() {\n\t\tconst rgb = this.rgb().color;\n\t\treturn ((rgb[0] & 0xFF) << 16) | ((rgb[1] & 0xFF) << 8) | (rgb[2] & 0xFF);\n\t},\n\n\tluminosity() {\n\t\t// http://www.w3.org/TR/WCAG20/#relativeluminancedef\n\t\tconst rgb = this.rgb().color;\n\n\t\tconst lum = [];\n\t\tfor (const [i, element] of rgb.entries()) {\n\t\t\tconst chan = element / 255;\n\t\t\tlum[i] = (chan <= 0.04045) ? chan / 12.92 : ((chan + 0.055) / 1.055) ** 2.4;\n\t\t}\n\n\t\treturn 0.2126 * lum[0] + 0.7152 * lum[1] + 0.0722 * lum[2];\n\t},\n\n\tcontrast(color2) {\n\t\t// http://www.w3.org/TR/WCAG20/#contrast-ratiodef\n\t\tconst lum1 = this.luminosity();\n\t\tconst lum2 = color2.luminosity();\n\n\t\tif (lum1 > lum2) {\n\t\t\treturn (lum1 + 0.05) / (lum2 + 0.05);\n\t\t}\n\n\t\treturn (lum2 + 0.05) / (lum1 + 0.05);\n\t},\n\n\tlevel(color2) {\n\t\t// https://www.w3.org/TR/WCAG/#contrast-enhanced\n\t\tconst contrastRatio = this.contrast(color2);\n\t\tif (contrastRatio >= 7) {\n\t\t\treturn 'AAA';\n\t\t}\n\n\t\treturn (contrastRatio >= 4.5) ? 'AA' : '';\n\t},\n\n\tisDark() {\n\t\t// YIQ equation from http://24ways.org/2010/calculating-color-contrast\n\t\tconst rgb = this.rgb().color;\n\t\tconst yiq = (rgb[0] * 2126 + rgb[1] * 7152 + rgb[2] * 722) / 10000;\n\t\treturn yiq < 128;\n\t},\n\n\tisLight() {\n\t\treturn !this.isDark();\n\t},\n\n\tnegate() {\n\t\tconst rgb = this.rgb();\n\t\tfor (let i = 0; i < 3; i++) {\n\t\t\trgb.color[i] = 255 - rgb.color[i];\n\t\t}\n\n\t\treturn rgb;\n\t},\n\n\tlighten(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] += hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdarken(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[2] -= hsl.color[2] * ratio;\n\t\treturn hsl;\n\t},\n\n\tsaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] += hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\tdesaturate(ratio) {\n\t\tconst hsl = this.hsl();\n\t\thsl.color[1] -= hsl.color[1] * ratio;\n\t\treturn hsl;\n\t},\n\n\twhiten(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[1] += hwb.color[1] * ratio;\n\t\treturn hwb;\n\t},\n\n\tblacken(ratio) {\n\t\tconst hwb = this.hwb();\n\t\thwb.color[2] += hwb.color[2] * ratio;\n\t\treturn hwb;\n\t},\n\n\tgrayscale() {\n\t\t// http://en.wikipedia.org/wiki/Grayscale#Converting_color_to_grayscale\n\t\tconst rgb = this.rgb().color;\n\t\tconst value = rgb[0] * 0.3 + rgb[1] * 0.59 + rgb[2] * 0.11;\n\t\treturn Color.rgb(value, value, value);\n\t},\n\n\tfade(ratio) {\n\t\treturn this.alpha(this.valpha - (this.valpha * ratio));\n\t},\n\n\topaquer(ratio) {\n\t\treturn this.alpha(this.valpha + (this.valpha * ratio));\n\t},\n\n\trotate(degrees) {\n\t\tconst hsl = this.hsl();\n\t\tlet hue = hsl.color[0];\n\t\thue = (hue + degrees) % 360;\n\t\thue = hue < 0 ? 360 + hue : hue;\n\t\thsl.color[0] = hue;\n\t\treturn hsl;\n\t},\n\n\tmix(mixinColor, weight) {\n\t\t// Ported from sass implementation in C\n\t\t// https://github.com/sass/libsass/blob/0e6b4a2850092356aa3ece07c6b249f0221caced/functions.cpp#L209\n\t\tif (!mixinColor || !mixinColor.rgb) {\n\t\t\tthrow new Error('Argument to \"mix\" was not a Color instance, but rather an instance of ' + typeof mixinColor);\n\t\t}\n\n\t\tconst color1 = mixinColor.rgb();\n\t\tconst color2 = this.rgb();\n\t\tconst p = weight === undefined ? 0.5 : weight;\n\n\t\tconst w = 2 * p - 1;\n\t\tconst a = color1.alpha() - color2.alpha();\n\n\t\tconst w1 = (((w * a === -1) ? w : (w + a) / (1 + w * a)) + 1) / 2;\n\t\tconst w2 = 1 - w1;\n\n\t\treturn Color.rgb(\n\t\t\tw1 * color1.red() + w2 * color2.red(),\n\t\t\tw1 * color1.green() + w2 * color2.green(),\n\t\t\tw1 * color1.blue() + w2 * color2.blue(),\n\t\t\tcolor1.alpha() * p + color2.alpha() * (1 - p));\n\t},\n};\n\n// Model conversion methods and static constructors\nfor (const model of Object.keys(convert)) {\n\tif (skippedModels.includes(model)) {\n\t\tcontinue;\n\t}\n\n\tconst {channels} = convert[model];\n\n\t// Conversion methods\n\tColor.prototype[model] = function (...args) {\n\t\tif (this.model === model) {\n\t\t\treturn new Color(this);\n\t\t}\n\n\t\tif (args.length > 0) {\n\t\t\treturn new Color(args, model);\n\t\t}\n\n\t\treturn new Color([...assertArray(convert[this.model][model].raw(this.color)), this.valpha], model);\n\t};\n\n\t// 'static' construction methods\n\tColor[model] = function (...args) {\n\t\tlet color = args[0];\n\t\tif (typeof color === 'number') {\n\t\t\tcolor = zeroArray(args, channels);\n\t\t}\n\n\t\treturn new Color(color, model);\n\t};\n}\n\nfunction roundTo(number, places) {\n\treturn Number(number.toFixed(places));\n}\n\nfunction roundToPlace(places) {\n\treturn function (number) {\n\t\treturn roundTo(number, places);\n\t};\n}\n\nfunction getset(model, channel, modifier) {\n\tmodel = Array.isArray(model) ? model : [model];\n\n\tfor (const m of model) {\n\t\t(limiters[m] || (limiters[m] = []))[channel] = modifier;\n\t}\n\n\tmodel = model[0];\n\n\treturn function (value) {\n\t\tlet result;\n\n\t\tif (value !== undefined) {\n\t\t\tif (modifier) {\n\t\t\t\tvalue = modifier(value);\n\t\t\t}\n\n\t\t\tresult = this[model]();\n\t\t\tresult.color[channel] = value;\n\t\t\treturn result;\n\t\t}\n\n\t\tresult = this[model]().color[channel];\n\t\tif (modifier) {\n\t\t\tresult = modifier(result);\n\t\t}\n\n\t\treturn result;\n\t};\n}\n\nfunction maxfn(max) {\n\treturn function (v) {\n\t\treturn Math.max(0, Math.min(max, v));\n\t};\n}\n\nfunction assertArray(value) {\n\treturn Array.isArray(value) ? value : [value];\n}\n\nfunction zeroArray(array, length) {\n\tfor (let i = 0; i < length; i++) {\n\t\tif (typeof array[i] !== 'number') {\n\t\t\tarray[i] = 0;\n\t\t}\n\t}\n\n\treturn array;\n}\n\nmodule.exports = Color;\n","import Color from \"color\";\n\n/* -------------------------------------------- */\n\nexport const createCustomChatMessage = async function (\n  chatTemplate,\n  chatTemplateData = {},\n  chatData = {},\n  { rolls = [] } = {}\n) {\n  chatData.user ??= game.user.id;\n  chatData.type ??= CONST.CHAT_MESSAGE_TYPES.CHAT;\n\n  chatData.content = await renderTemplate(chatTemplate, chatTemplateData);\n  chatData.rollMode ??= game.settings.get(\"core\", \"rollMode\");\n\n  // Handle different roll modes\n  ChatMessage.implementation.applyRollMode(chatData, chatData.rollMode);\n\n  // Dice So Nice integration\n  if (chatData.roll != null && rolls.length === 0) rolls = [chatData.roll];\n  if (game.dice3d != null && game.dice3d.isEnabled()) {\n    for (const roll of rolls) {\n      await game.dice3d.showForRoll(roll, game.user, false, chatData.whisper, chatData.blind);\n      chatData.sound = null;\n    }\n  }\n\n  return ChatMessage.implementation.create(chatData);\n};\n\nexport const hideRollInfo = function (app, html, data) {\n  const whisper = app.whisper || [];\n  const isBlind = whisper.length && app.blind;\n  const isVisible = whisper.length ? whisper.includes(game.user.id) || (app.isAuthor && !isBlind) : true;\n  if (!isVisible) {\n    html.find(\".dice-formula\").text(\"???\");\n    html.find(\".dice-total\").text(\"?\");\n    html.find(\".dice\").text(\"\");\n    html.find(\".success\").removeClass(\"success\");\n    html.find(\".failure\").removeClass(\"failure\");\n  }\n};\n\n/**\n * Generates an info block containing an item's identified info for GMs\n *\n * @remarks This HTML has to be generated in a synchronous way, as adding to a rendered chat message's content\n *          will cause erratic scrolling behaviour.\n * @param {ChatMessagePFIdentifiedInfo} info - An object containing the item's identified info\n * @returns {string} HTML string containing the info block\n */\nconst getIdentifiedBlock = (info) => {\n  const hasCombinedName = info.actionName && !info.actionDescription;\n  return (\n    _templateCache[\"systems/ffd20/templates/chat/parts/gm-description.hbs\"]?.(\n      { ...info, hasCombinedName },\n      { allowProtoMethodsByDefault: true, allowProtoPropertiesByDefault: true }\n    ) ?? \"\"\n  );\n};\n\n/**\n * Add GM-sensitive info for GMs and hide GM-sensitive info for players\n *\n * @param {ChatMessagePF} app - The chat message\n * @param {JQuery} html - The chat message's HTML\n * @param {object} data - Data used to render the chat message\n */\nexport const hideGMSensitiveInfo = function (app, html, data) {\n  // Handle adding of GM-sensitive info\n  if (game.user.isGM) {\n    // Show identified info box for GM if item was unidentified when rolled\n    const identifiedInfo = app.flags.ffd20?.identifiedInfo ?? {};\n    const { identified = true } = identifiedInfo;\n    if (!identified && app.hasItemSource) {\n      const cardContent = html.find(\".card-content\");\n      cardContent.append(getIdentifiedBlock(identifiedInfo));\n    }\n    // Return early, as the rest of the function handles removing already existing info\n    return;\n  }\n\n  // Hide info that's always sensitive, no matter the card's owner\n  html.find(\".gm-sensitive-always\").remove();\n\n  // Hide info about unowned tokens\n  html.find(\"[data-gm-sensitive-uuid]\").each((a, elem) => {\n    // Quickly hide element\n    elem = $(elem);\n    elem.hide();\n\n    // Then check for stuff\n    const uuid = elem.data(\"gm-sensitive-uuid\");\n    if (!uuid) return;\n    fromUuid(uuid).then((obj) => {\n      // If token or token document, get actor for testing user permissions\n      if (obj instanceof Token || obj instanceof TokenDocument) obj = obj.actor;\n      //  Show element again, since we have permission\n      if (obj?.testUserPermission && obj.testUserPermission(game.user, \"OBSERVER\")) {\n        elem.show();\n      }\n      // Remove element completely, since we don't have permission\n      else {\n        elem.remove();\n      }\n    });\n  });\n\n  const speaker = app.speaker;\n  let actor = null;\n  if (speaker != null) {\n    if (speaker.token) {\n      actor = game.actors.tokens[speaker.token];\n    }\n    if (!actor) {\n      actor = game.actors.get(speaker.actor);\n    }\n  }\n\n  if (!actor || (actor && actor.testUserPermission(game.user, \"OBSERVER\"))) return;\n\n  // Hide info\n  html.find(\".gm-sensitive\").remove();\n\n  // Alter GM inner texts\n  html.find(\"[data-gm-sensitive-inner]\").each((a, elem) => {\n    if (!game.settings.get(\"ffd20\", \"obscureSaveDCs\") && elem.dataset.action === \"save\") return;\n\n    elem = $(elem);\n    elem.text(elem.data(\"gm-sensitive-inner\"));\n    elem.removeData(\"gm-sensitive-inner\");\n  });\n\n  if (game.settings.get(\"ffd20\", \"obscureInlineRolls\")) {\n    // Turn rolls into raw strings\n    html.find(\".inline-roll\").each((a, elem) => {\n      if (!elem.dataset.roll) {\n        return;\n      }\n\n      const roll = Roll.fromJSON(unescape(elem.dataset.roll));\n      const parent = elem.parentNode;\n      parent.insertBefore($(`<span>${roll.total}</span>`)[0], elem);\n      parent.removeChild(elem);\n    });\n  }\n};\n\nexport const alterAmmoRecovery = function (app, html) {\n  const recoveryData = app.getFlag(\"ffd20\", \"ammoRecovery\");\n  if (!recoveryData) return;\n\n  html.find(\".chat-attack .ammo[data-ammo-id]\").each((a, el) => {\n    const attackIndex = el.closest(\".chat-attack\").dataset.index;\n    const ammoId = el.dataset.ammoId;\n    const data = recoveryData[attackIndex]?.[ammoId];\n    if (!data) return;\n    $(el)\n      .find(\".inline-action\")\n      .each((i, ia) => {\n        // TODO: Disable button & track proper quantities\n        if (data.recovered) ia.classList.add(\"recovered\");\n        if (data.failed) ia.classList.add(\"recovery-failed\");\n      });\n  });\n};\n\nexport const alterTargetDefense = function (app, html) {\n  const defenseData = app.getFlag(\"ffd20\", \"targetDefense\");\n  if (!defenseData) return;\n\n  html.find(\".attack-targets .saving-throws div[data-saving-throw]\").each((a, el) => {\n    const actorUUID = el.closest(\".target\").dataset.uuid;\n    const save = el.dataset.savingThrow;\n    const value = getProperty(defenseData, `${actorUUID}.save.${save}`);\n    if (value == null) return;\n    $(el).find(\".value\").text(value.toString());\n  });\n};\n\nexport const applyAccessibilitySettings = function (app, html, data, conf) {};\n\n/**\n * Returns an inline roll string suitable for chat messages.\n *\n * @param {Roll} roll - The roll to be stringified\n * @param {object} [options] - Additional options affecting the inline roll\n * @param {boolean} [options.hide3d] - Whether the roll should be hidden from DsN\n * @returns {string} The inline roll string\n */\nexport const createInlineRollString = (roll, { hide3d = true } = {}) =>\n  `<a class=\"inline-roll inline-result ${hide3d ? \"inline-dsn-hidden\" : \"\"}\" \\\n  data-tooltip=\"${roll.formula}\" data-roll=\"${escape(JSON.stringify(roll))}\"> \\\n  <i class=\"fas fa-dice-d20\"></i> ${roll.total}</a>`;\n\nexport const hideInvisibleTargets = async function (app, html) {\n  const targetElems = html.find(\".attack-targets .target\");\n  const targets = targetElems.toArray().reduce((cur, o) => {\n    cur.push({ uuid: o.dataset.uuid, elem: o });\n    return cur;\n  }, []);\n\n  for (const t of targets) {\n    const elem = $(t.elem);\n\n    // Gather token\n    const token = await fromUuid(t.uuid);\n    if (!token) continue;\n    t.token = token.object;\n\n    // Hide if token invisible\n    if (!t.token?.visible) elem.hide();\n    else elem.show();\n  }\n};\n\nexport const addTargetCallbacks = function (app, html) {\n  const targetElems = html.find(\".attack-targets .target[data-uuid]\");\n\n  // Define getter functions\n  const _getTokenByElem = async function (elem) {\n    return (await fromUuid(elem?.dataset.uuid ?? \"\"))?.object;\n  };\n  const _getRootTargetElement = function (elem) {\n    if (elem.dataset.uuid != null) return elem;\n    return elem.closest(\"[data-uuid]\");\n  };\n\n  // Create image callback functions\n  const _mouseEnterCallback = function (event) {\n    _getTokenByElem(_getRootTargetElement(event.currentTarget)).then((t) => {\n      t?._onHoverIn(event, { hoverOutOthers: false });\n    });\n  };\n  const _mouseLeaveCallback = function (event) {\n    _getTokenByElem(_getRootTargetElement(event.currentTarget)).then((t) => {\n      t?._onHoverOut(event);\n    });\n  };\n  const _imageClickCallback = function (event) {\n    event.preventDefault();\n    _getTokenByElem(_getRootTargetElement(event.currentTarget)).then((t) => {\n      if (t?.actor.testUserPermission(game.user, \"OWNER\")) {\n        if (t._controlled) {\n          if (event.shiftKey) t.release();\n        } else {\n          t.control({ releaseOthers: !event.shiftKey });\n        }\n      }\n    });\n  };\n\n  // Add callbacks\n  for (let elem of targetElems) {\n    elem = $(elem);\n\n    // Image element events\n    const imgElem = elem.find(\".target-image\");\n    imgElem.on(\"mouseenter\", _mouseEnterCallback);\n    imgElem.on(\"mouseleave\", _mouseLeaveCallback);\n    imgElem.on(\"click\", _imageClickCallback);\n\n    // Misc element events\n    elem.find(\".ac\").on(\"click\", (event) => {\n      event.preventDefault();\n\n      _getTokenByElem(_getRootTargetElement(event.currentTarget)).then((t) => {\n        if (!t?.actor) return;\n        ffd20.utils.chat.targetACClick(app, html, t.actor, event);\n      });\n    });\n    elem.find(\".saving-throws .click\").on(\"click\", (event) => {\n      event.preventDefault();\n\n      _getTokenByElem(_getRootTargetElement(event.currentTarget)).then((t) => {\n        if (!t?.actor) return;\n        ffd20.utils.chat.targetSavingThrowClick(app, html, t.actor, event);\n      });\n    });\n  }\n};\n\nexport const targetACClick = async function (app, html, actor, event) {\n  actor.displayDefenseCard({ rollMode: \"selfroll\" });\n};\n\nexport const targetSavingThrowClick = async function (app, html, actor, event) {\n  const elem = event.currentTarget;\n  const save = elem.dataset.savingThrow;\n\n  const message = await actor.rollSavingThrow(save, { event });\n  const total = message?.rolls?.[0]?.total;\n\n  // Replace saving throw value on original chat card's target\n  if (total != null) {\n    const actorUUID = elem.closest(\".target\").dataset.uuid;\n    await app.setFlag(\"ffd20\", \"targetDefense\", { [actorUUID]: { save: { [save]: total } } });\n  }\n};\n","export const formulaHasDice = function (formula) {\n  return formula.match(/[0-9)][dD]/) || formula.match(/[dD][0-9(]/);\n};\n","import { RollPF } from \"../../../dice/roll.mjs\";\n\n/**\n * @this {import(\"@actor/actor-pf.mjs\").ActorPF}\n */\nexport function applyChanges() {\n  this.changeOverrides = {};\n  const changes = Array.from(this.changes);\n\n  const priority = getSortChangePriority.call(this);\n  const _sortChanges = function (a, b) {\n    const typeA = priority.types.indexOf(a.subTarget);\n    const typeB = priority.types.indexOf(b.subTarget);\n    const modA = priority.modifiers.indexOf(a.modifier);\n    const modB = priority.modifiers.indexOf(b.modifier);\n    let prioA = typeof a.priority === \"string\" ? parseInt(a.priority) : a.priority;\n    let prioB = typeof b.priority === \"string\" ? parseInt(b.priority) : b.priority;\n    prioA = (prioA || 0) + 1000;\n    prioB = (prioB || 0) + 1000;\n\n    return prioB - prioA || typeA - typeB || modA - modB;\n  };\n\n  // Organize changes by priority\n  changes.sort((a, b) => _sortChanges.call(this, a, b));\n\n  // Parse change flags\n  for (const i of this.changeItems) {\n    for (const [k, v] of Object.entries(i.system.changeFlags)) {\n      if (v === true) {\n        this.changeFlags[k] = true;\n\n        if (k === \"loseDexToAC\") {\n          for (const k2 of [\"normal\", \"touch\"]) {\n            getSourceInfo(this.sourceInfo, `system.attributes.ac.${k2}.total`).negative.push({\n              value: game.i18n.localize(\"FFD20.ChangeFlagLoseDexToAC\"),\n              name: i.name,\n              type: i.type,\n            });\n          }\n          getSourceInfo(this.sourceInfo, \"system.attributes.cmd.total\").negative.push({\n            value: game.i18n.localize(\"FFD20.ChangeFlagLoseDexToAC\"),\n            name: i.name,\n            type: i.type,\n          });\n        }\n      }\n    }\n  }\n  this.refreshDerivedData();\n\n  // Determine continuous changes\n  const continuousChanges = changes.filter((o) => o.continuous === true);\n\n  // Apply all changes\n  for (let a = 0; a < changes.length; a++) {\n    const change = changes[a];\n    const flats = getChangeFlat.call(this, change.subTarget, change.modifier, change.value);\n    for (const f of flats) {\n      if (!this.changeOverrides[f]) this.changeOverrides[f] = createOverride();\n    }\n\n    change._safeApplyChange(this, flats, { applySourceInfo: false });\n\n    // Apply continuous changes\n    for (const cc of continuousChanges) {\n      if (cc === change) continue;\n\n      const flats = getChangeFlat.call(this, cc.subTarget, cc.modifier, cc.value);\n      for (const f of flats) {\n        if (!this.changeOverrides[f]) this.changeOverrides[f] = createOverride();\n      }\n\n      cc._safeApplyChange(this, flats, { applySourceInfo: false });\n    }\n\n    this.refreshDerivedData();\n  }\n\n  // Apply source info for changes\n  for (const change of changes) {\n    change.applySourceInfo(this);\n  }\n\n  resetSkills.call(this);\n}\n\nconst createOverride = function () {\n  const result = {\n    add: {},\n    set: {},\n  };\n\n  for (const k of Object.keys(ffd20.config.bonusModifiers)) {\n    result.add[k] = null;\n    result.set[k] = null;\n  }\n\n  return result;\n};\n\nconst getSortChangePriority = function () {\n  /** @type {[string, {sort: number}][]}*/\n  const skillTargets = this._skillTargets.map((target, index) => [target, { sort: 76000 + index * 10 }]);\n  const buffTargets = Object.entries(ffd20.config.buffTargets);\n  const types = [...skillTargets, ...buffTargets]\n    .sort(([, { sort: aSort }], [, { sort: bSort }]) => aSort - bSort)\n    .map(([target]) => target);\n\n  return {\n    types: types,\n    modifiers: [\n      \"untyped\",\n      \"untypedPerm\",\n      \"base\",\n      \"enh\",\n      \"dodge\",\n      \"haste\",\n      \"inherent\",\n      \"deflection\",\n      \"morale\",\n      \"luck\",\n      \"sacred\",\n      \"insight\",\n      \"resist\",\n      \"profane\",\n      \"trait\",\n      \"racial\",\n      \"size\",\n      \"competence\",\n      \"circumstance\",\n      \"alchemical\",\n      \"penalty\",\n    ],\n  };\n};\n\n/**\n * @this {ActorPF}\n * @param {BuffTarget} target Target (e.g. \"ac\" or \"skills\")\n * @param {ModifierType} modifierType Type (e.g. \"profane\", \"untyped\", or \"dodge\"). If undefined, all valid targets will be returned.\n * @param {number} [value]  Value, if known\n * @returns {Array<string>} Array of target paths to modify\n */\nexport const getChangeFlat = function (target, modifierType, value) {\n  if (target == null) return [];\n\n  const curData = this.system;\n  /** @type {string[]} */\n  const result = [];\n\n  switch (target) {\n    case \"mhp\":\n      result.push(\"system.attributes.hp.max\");\n      break;\n    case \"wounds\":\n      result.push(\"system.attributes.wounds.max\");\n      break;\n    case \"vigor\":\n      result.push(\"system.attributes.vigor.max\");\n      break;\n    case \"mmp\":\n      result.push(\"system.attributes.mp.max\");\n      break;\n    case \"str\":\n    case \"dex\":\n    case \"con\":\n    case \"int\":\n    case \"wis\":\n    case \"cha\":\n      if (modifierType === \"penalty\") {\n        result.push(`system.abilities.${target}.penalty`);\n        break;\n      }\n      if ([\"base\", \"untypedPerm\"].includes(modifierType)) {\n        result.push(`system.abilities.${target}.total`, `system.abilities.${target}.base`);\n        break;\n      }\n      result.push(`system.abilities.${target}.total`);\n      break;\n    case \"strMod\":\n    case \"dexMod\":\n    case \"conMod\":\n    case \"intMod\":\n    case \"wisMod\":\n    case \"chaMod\":\n      result.push(`system.abilities.${target.slice(0, 3)}.mod`);\n      break;\n    case \"carryStr\":\n      result.push(\"system.details.carryCapacity.bonus.total\");\n      break;\n    case \"carryMult\":\n      result.push(\"system.details.carryCapacity.multiplier.total\");\n      break;\n    case \"ac\":\n      result.push(\"system.attributes.ac.normal.total\", \"system.attributes.ac.touch.total\");\n\n      switch (modifierType) {\n        case \"dodge\":\n        case \"haste\":\n          result.push(\"system.attributes.cmd.total\");\n          break;\n        case \"deflection\":\n        case \"circumstance\":\n        case \"insight\":\n        case \"luck\":\n        case \"morale\":\n        case \"profane\":\n        case \"sacred\":\n        case \"penalty\":\n          result.push(\n            \"system.attributes.ac.flatFooted.total\",\n            \"system.attributes.cmd.total\",\n            \"system.attributes.cmd.flatFootedTotal\"\n          );\n          break;\n        default:\n          result.push(\"system.attributes.ac.flatFooted.total\");\n          // Other penalties also apply to CMD, but not bonuses\n          if (value < 0) {\n            result.push(\"system.attributes.cmd.total\", \"system.attributes.cmd.flatFootedTotal\");\n          }\n          break;\n      }\n      break;\n    case \"aac\": {\n      const targets = [\"system.ac.normal.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.normal.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.normal.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.normal.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"sac\": {\n      const targets = [\"system.ac.shield.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.shield.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.shield.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.shield.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"nac\": {\n      const targets = [\"system.ac.natural.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.natural.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.natural.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.natural.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"tac\":\n      result.push(\"system.attributes.ac.touch.total\");\n      break;\n    case \"ffac\":\n      result.push(\"system.attributes.ac.flatFooted.total\");\n      break;\n    case \"ffcmd\":\n      result.push(\"system.attributes.cmd.flatFootedTotal\");\n      break;\n    case \"bab\":\n      result.push(\"system.attributes.bab.total\");\n      break;\n    case \"~attackCore\":\n      result.push(\"system.attributes.attack.shared\");\n      break;\n    case \"attack\":\n      result.push(\"system.attributes.attack.general\");\n      break;\n    case \"mattack\":\n      result.push(\"system.attributes.attack.melee\");\n      break;\n    case \"rattack\":\n      result.push(\"system.attributes.attack.ranged\");\n      break;\n    case \"critConfirm\":\n      result.push(\"system.attributes.attack.critConfirm\");\n      break;\n    case \"allSavingThrows\":\n      result.push(\n        \"system.attributes.savingThrows.fort.total\",\n        \"system.attributes.savingThrows.ref.total\",\n        \"system.attributes.savingThrows.will.total\"\n      );\n      break;\n    case \"fort\":\n      result.push(\"system.attributes.savingThrows.fort.total\");\n      break;\n    case \"ref\":\n      result.push(\"system.attributes.savingThrows.ref.total\");\n      break;\n    case \"will\":\n      result.push(\"system.attributes.savingThrows.will.total\");\n      break;\n    case \"skills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const b of Object.keys(skl.subSkills)) {\n            result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"~skillMods\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const b of Object.keys(skl.subSkills)) {\n            result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"unskills\":\n      // Untrained skills\n      for (const [skillId, skill] of Object.entries(curData.skills)) {\n        if (skill == null) continue;\n        for (const [subSkillId, subskill] of Object.entries(skill.subSkills ?? {})) {\n          if (subskill.rank > 0) continue;\n          result.push(`system.skills.${skillId}.subSkills.${subSkillId}.changeBonus`);\n        }\n        if (skill.rank > 0) continue;\n        result.push(`system.skills.${skillId}.changeBonus`);\n      }\n      break;\n    case \"strSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"str\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"str\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"dexSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"dex\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"dex\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"conSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"con\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"con\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"intSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"int\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"int\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"wisSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"wis\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"wis\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"chaSkills\":\n      for (const [a, skl] of Object.entries(curData.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"cha\") result.push(`system.skills.${a}.changeBonus`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"cha\")\n              result.push(`system.skills.${a}.subSkills.${b}.changeBonus`);\n          }\n        }\n      }\n      break;\n    case \"allChecks\":\n      result.push(\n        \"system.abilities.str.checkMod\",\n        \"system.abilities.dex.checkMod\",\n        \"system.abilities.con.checkMod\",\n        \"system.abilities.int.checkMod\",\n        \"system.abilities.wis.checkMod\",\n        \"system.abilities.cha.checkMod\",\n        ...(this.system.attributes.init.ability ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"strChecks\":\n      result.push(\n        \"system.abilities.str.checkMod\",\n        ...(this.system.attributes.init.ability === \"str\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"dexChecks\":\n      result.push(\n        \"system.abilities.dex.checkMod\",\n        ...(this.system.attributes.init.ability === \"dex\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"conChecks\":\n      result.push(\n        \"system.abilities.con.checkMod\",\n        ...(this.system.attributes.init.ability === \"con\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"intChecks\":\n      result.push(\n        \"system.abilities.int.checkMod\",\n        ...(this.system.attributes.init.ability === \"int\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"wisChecks\":\n      result.push(\n        \"system.abilities.wis.checkMod\",\n        ...(this.system.attributes.init.ability === \"wis\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"chaChecks\":\n      result.push(\n        \"system.abilities.cha.checkMod\",\n        ...(this.system.attributes.init.ability === \"cha\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"allSpeeds\":\n      for (const speedKey of Object.keys(curData.attributes.speed)) {\n        const base = curData.attributes.speed[speedKey]?.base;\n        if (base !== undefined) result.push(`system.attributes.speed.${speedKey}.total`);\n      }\n      break;\n    case \"landSpeed\":\n      if (modifierType === \"base\") return [\"system.attributes.speed.land.total\"];\n      result.push(\"system.attributes.speed.land.add\", \"system.attributes.speed.land.total\");\n      break;\n    case \"climbSpeed\":\n      if (modifierType === \"base\") {\n        result.push(\"system.attributes.speed.climb.total\");\n        break;\n      }\n      result.push(\"system.attributes.speed.climb.add\", \"system.attributes.speed.climb.total\");\n      break;\n    case \"swimSpeed\":\n      if (modifierType === \"base\") {\n        result.push(\"system.attributes.speed.swim.total\");\n        break;\n      }\n      result.push(\"system.attributes.speed.swim.add\", \"system.attributes.speed.swim.total\");\n      break;\n    case \"burrowSpeed\":\n      if (modifierType === \"base\") {\n        result.push(\"system.attributes.speed.burrow.total\");\n        break;\n      }\n      result.push(\"system.attributes.speed.burrow.add\", \"system.attributes.speed.burrow.total\");\n      break;\n    case \"flySpeed\":\n      if (modifierType === \"base\") {\n        result.push(\"system.attributes.speed.fly.total\");\n        break;\n      }\n      result.push(\"system.attributes.speed.fly.add\", \"system.attributes.speed.fly.total\");\n      break;\n    case \"cmb\":\n      result.push(\"system.attributes.cmb.bonus\");\n      break;\n    case \"cmd\":\n      if ([\"dodge\", \"haste\"].includes(modifierType)) {\n        result.push(\"system.attributes.cmd.total\");\n        break;\n      }\n      result.push(\"system.attributes.cmd.total\", \"system.attributes.cmd.flatFootedTotal\");\n      break;\n    case \"init\":\n      result.push(\"system.attributes.init.total\");\n      break;\n    case \"acpA\":\n      result.push(\"system.attributes.acp.armorBonus\");\n      break;\n    case \"acpS\":\n      result.push(\"system.attributes.acp.shieldBonus\");\n      break;\n    case \"mDexA\":\n      result.push(\"system.attributes.mDex.armorBonus\");\n      break;\n    case \"mDexS\":\n      result.push(\"system.attributes.mDex.shieldBonus\");\n      break;\n    case \"spellResist\":\n      result.push(\"system.attributes.sr.total\");\n      break;\n    case \"damage\":\n      result.push(\"system.attributes.damage.general\");\n      break;\n    case \"wdamage\":\n      result.push(\"system.attributes.damage.weapon\");\n      break;\n    case \"sdamage\":\n      result.push(\"system.attributes.damage.spell\");\n      break;\n    case \"bonusFeats\":\n      result.push(\"system.details.feats.bonus\");\n      break;\n    case \"bonusSkillRanks\":\n      result.push(\"system.details.skills.bonus\");\n      break;\n    case \"concentration\":\n      result.push(\n        \"system.attributes.spells.spellbooks.primary.concentration.total\",\n        \"system.attributes.spells.spellbooks.secondary.concentration.total\",\n        \"system.attributes.spells.spellbooks.tertiary.concentration.total\",\n        \"system.attributes.spells.spellbooks.quaternary.concentration.total\",\n        \"system.attributes.spells.spellbooks.spelllike.concentration.total\"\n      );\n      break;\n    case \"cl\":\n      result.push(\n        \"system.attributes.spells.spellbooks.primary.cl.total\",\n        \"system.attributes.spells.spellbooks.secondary.cl.total\",\n        \"system.attributes.spells.spellbooks.tertiary.cl.total\",\n        \"system.attributes.spells.spellbooks.quaternary.cl.total\",\n        \"system.attributes.spells.spellbooks.spelllike.cl.total\"\n      );\n      break;\n  }\n\n  if (target.match(/^skill\\.([a-zA-Z0-9]+)$/)) {\n    const sklKey = RegExp.$1;\n    const skillData = curData.skills[sklKey];\n    if (skillData != null) {\n      result.push(`system.skills.${sklKey}.changeBonus`);\n      // Apply to subskills also\n      for (const subSklKey of Object.keys(skillData.subSkills ?? {})) {\n        result.push(`system.skills.${sklKey}.subSkills.${subSklKey}.changeBonus`);\n      }\n    }\n  } else if (target.match(/^skill\\.([a-zA-Z0-9]+)\\.subSkills\\.([a-zA-Z0-9_]+)$/)) {\n    const sklKey = RegExp.$1;\n    const subSklKey = RegExp.$2;\n    if (curData.skills[sklKey]?.subSkills?.[subSklKey] != null) {\n      result.push(`system.skills.${sklKey}.subSkills.${subSklKey}.changeBonus`);\n    }\n  }\n\n  // Call hooks to enable modules to add or adjust the result array\n  Hooks.callAll(\"pf1GetChangeFlat\", result, target, modifierType, value, this);\n\n  // Return results directly when deprecation is removed\n  return result;\n};\n\nconst getBabTotal = function (d) {\n  return d.attributes.bab.total;\n};\n\nconst getNegativeEnergyDrain = function (d) {\n  return -d.attributes.energyDrain;\n};\n\nconst getAbilityMod = function (ability) {\n  return function (d) {\n    return d.abilities[ability]?.mod ?? 0;\n  };\n};\n\nexport const addDefaultChanges = function (changes) {\n  const actorData = this.system;\n  // Call hook\n  const tempChanges = [];\n  Hooks.callAll(\"pf1AddDefaultChanges\", this, tempChanges);\n  changes.push(...tempChanges.filter((c) => c instanceof ffd20.components.ItemChange));\n\n  // Class hit points\n  const allClasses = this.items.filter((item) => item.type === \"class\").sort((a, b) => a.sort - b.sort);\n  // Categorize classes\n  const [classes, racialHD] = allClasses.reduce(\n    (all, cls) => {\n      if (cls.subType === \"racial\") all[1].push(cls);\n      else all[0].push(cls);\n      return all;\n    },\n    [[], []]\n  );\n\n  const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n  const classOptions = this.type === \"character\" ? healthConfig.hitdice.PC : healthConfig.hitdice.NPC;\n  const raceOptions = healthConfig.hitdice.Racial;\n  const round = { up: Math.ceil, nearest: Math.round, down: Math.floor }[healthConfig.rounding];\n  const continuous = { discrete: false, continuous: true }[healthConfig.continuity];\n\n  const pushHealth = (value, source) => {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: value,\n        target: \"misc\",\n        subTarget: \"mhp\",\n        modifier: \"untypedPerm\",\n        flavor: source.name,\n      })\n    );\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: value,\n        target: \"misc\",\n        subTarget: \"vigor\",\n        modifier: \"untypedPerm\",\n        flavor: source.name,\n      })\n    );\n  };\n  const manualHealth = (healthSource) => {\n    let health = healthSource.system.hp + (healthSource.system.subType === \"base\") * healthSource.system.fc.hp.value;\n\n    if (!continuous) health = round(health);\n    pushHealth(health, healthSource);\n  };\n  const autoHealth = (healthSource, options, maximized = 0) => {\n    const hpPerHD = healthSource.system.hd ?? 0;\n    if (hpPerHD === 0) return;\n\n    let health = 0;\n    if (healthSource.subType === \"mythic\") {\n      const hpPerTier = hpPerHD ?? 0;\n      if (hpPerTier === 0) return;\n      const tiers = healthSource.system.level ?? 0;\n      if (tiers === 0) return;\n      health = hpPerTier * tiers;\n    } else {\n      let dieHealth = 1 + (hpPerHD - 1) * options.rate;\n      if (!continuous) dieHealth = round(dieHealth);\n\n      const hitDice = healthSource.hitDice;\n      const maxedHealth = Math.min(hitDice, maximized) * hpPerHD;\n      const levelHealth = Math.max(0, hitDice - maximized) * dieHealth;\n      const favorHealth = (healthSource.system.subType === \"base\") * healthSource.system.fc.hp.value;\n      health = maxedHealth + levelHealth + favorHealth;\n    }\n    pushHealth(health, healthSource);\n  };\n  const computeHealth = (healthSources, options) => {\n    // Compute and push health, tracking the remaining maximized levels.\n    if (options.auto) {\n      let maximized = options.maximized;\n      for (const hd of healthSources) {\n        autoHealth(hd, options, maximized);\n        const hitDice = hd.hitDice;\n        maximized = Math.max(0, maximized - hitDice);\n      }\n    } else healthSources.forEach((race) => manualHealth(race));\n  };\n\n  computeHealth(racialHD, raceOptions);\n  computeHealth(classes, classOptions);\n\n  // Class mana points, call class and race info from above\n  /* Compute and push mana, tracking the remaining maximized levels.\n   * for each class, check if it is calulating mp or defaulting to manually entered value\n   * step 1 - gather all classes\n   * step 2 - check for each if it is auto or manual\n   * step 3 - pass to correct function\n   * step 4 - if manual just add mp to pool\n   * step 5 - for auto follow substeps\n   * the following is for each class passed to it\n   * step 5a - condence relevant variables\n   *   MP type: which mp chart does it look at - manaSource.system. classBaseMPTypes\n   *   Max spell lvl: which spell prog does it look at - manaSource.system.classBaseMPTypes\n   *   level: level of the class - manaSource.system.level\n   *   casting stat: what stat(s) are used for it - manaSource.system.classCastingStat\n   * pass result\n   * else\n   * pass manual mp value\n   * total results\n   */\n\n  // TODO adjust for class autos\n  // check each for false or null, do first manual option, if true move to auto\n\n\n  const pushMana = (value, source) => {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: value,\n        target: \"misc\",\n        subTarget: \"mmp\",\n        modifier: \"untypedPerm\",\n        flavor: source.name,\n      })\n    );\n  };\n\n  const manualMana = (manaSource) => {\n    const mana = manaSource.system.mp === null ? 0 : manaSource.system.mp;\n    //getSourceInfo(this.sourceInfo, \"system.attributes.mp.max\").positive.push({\n    //  value: manaSource.system.mp,\n    //  name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassBase\", { className: manaSource.name }),\n    //});\n    pushMana(mana, manaSource);\n  };\n\n  const autoMana = (manaSource) => {\n    if (manaSource.system.classBaseMPTypes === \"noncaster\") return;\n    if (manaSource.system.level === 0) return;\n    // figure out how much mp comes from the class\n    let mult = 1;\n    if (manaSource.system.classBaseMPauto === \"half\") mult = 0.5;\n    const manaChart = ffd20.config.classMPlevels[manaSource.system.classBaseMPTypes];\n    const level_mana = Math.floor(manaChart[manaSource.system.level - 1] * mult);\n    pushMana(level_mana, manaSource);\n  };\n\n  const computeMana = (manaSources) => {\n    manaSources.forEach((mpsource) => {\n      if (mpsource.system.classBaseMPauto == \"no\" || mpsource.system.classBaseMPauto == null) {\n        manualMana(mpsource);\n      } else {\n        autoMana(mpsource);\n      }\n    });\n  };\n\n  computeMana(racialHD);\n  computeMana(classes);\n\n  // Add class data to saving throws\n  const useFractional = game.settings.get(\"ffd20\", \"useFractionalBaseBonuses\") === true;\n  for (const a of Object.keys(actorData.attributes.savingThrows)) {\n    let hasGoodSave = false;\n    actorData.attributes.savingThrows[a].total = actorData.attributes.savingThrows[a]?.base ?? 0;\n\n    const total = allClasses.reduce((cur, cls) => {\n      const base = cls.system.savingThrows[a].base;\n\n      if (!useFractional) {\n        // Add per class change\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: base,\n            target: \"savingThrows\",\n            subTarget: a,\n            modifier: \"untypedPerm\",\n            flavor: cls.name,\n          })\n        );\n      } else {\n        if (cls.system.savingThrows[a].good === true) hasGoodSave = true;\n      }\n      return cur + base;\n    }, 0);\n\n    if (useFractional) {\n      // Add shared change with fractional\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: Math.floor(total),\n          target: \"savingThrows\",\n          subTarget: a,\n          modifier: \"untypedPerm\",\n          flavor: game.i18n.localize(\"FFD20.Base\"),\n        })\n      );\n    }\n\n    // Fractional bonus +2 when one class has good save\n    if (useFractional && hasGoodSave) {\n      const goodSaveFormula = ffd20.config.classFractionalSavingThrowFormulas.goodSaveBonus;\n      const total = RollPF.safeRoll(goodSaveFormula).total;\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: total,\n          target: \"savingThrows\",\n          subTarget: a,\n          modifier: \"untypedPerm\",\n          flavor: game.i18n.localize(\"FFD20.SavingThrowGoodFractionalBonus\"),\n        })\n      );\n    }\n  }\n\n  // Add Constitution to HP\n  const hpAbility = actorData.attributes.hpAbility;\n  if (hpAbility) {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => d.abilities[hpAbility].mod * d.attributes.hd.total,\n        operator: \"function\",\n        target: \"misc\",\n        subTarget: \"mhp\",\n        modifier: \"base\",\n        flavor: ffd20.config.abilities[hpAbility],\n      })\n    );\n\n    if (!this.system.attributes.wounds?.base) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: (d) => d.abilities[hpAbility].total * 2 + d.abilities[hpAbility].drain,\n          operator: \"function\",\n          target: \"misc\",\n          subTarget: \"wounds\",\n          modifier: \"base\",\n          flavor: ffd20.config.abilities[hpAbility],\n        })\n      );\n    }\n  }\n\n  // add bonus mp and does it after all stat mods\n  classes.forEach((mp_source) => {\n    let mpAbility = mp_source.system.classCastingStat;\n    if (mpAbility == null) mpAbility = \"noncaster\";\n    if (mpAbility === \"noncaster\") return;\n    if (mp_source.system.level === 0) return;\n    const spellMath = ffd20.config.ClassSpellLvlProgression[mp_source.system.classBaseMPTypes];\n    const currentSpellLvl = Math.floor(RollPF.safeRoll(spellMath, { level: mp_source.system.level }).total);\n    const mpProg = ffd20.config.classMPStatsBonus[currentSpellLvl];\n    if (mpAbility !== \"\") {\n      const arrayStr = JSON.stringify(mpProg);\n      if (mpAbility === \"intAndWis\") {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula:  `${arrayStr}[[@abilities.int.mod]] + ${arrayStr}[[@abilities.wis.mod]]`,\n            target: \"misc\",\n            subTarget: \"mmp\",\n            modifier: \"base\",\n          })\n        );\n      } else {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: `${arrayStr}[[@abilities.${mpAbility}.mod]]`,\n            target: \"misc\",\n            subTarget: \"mmp\",\n            modifier: \"base\",\n          })\n        );\n      }\n    }\n  });\n\n  // Add movement speed(s)\n  for (const [k, s] of Object.entries(actorData.attributes.speed)) {\n    let base = s.base;\n    if (!base) base = 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: base,\n        target: \"speed\",\n        subTarget: `${k}Speed`,\n        modifier: \"base\",\n        operator: \"set\",\n        priority: 1001,\n        flavor: game.i18n.localize(\"FFD20.Base\"),\n      })\n    );\n  }\n\n  // Add base attack modifiers shared by all attacks\n  {\n    // BAB to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getBabTotal,\n        operator: \"function\",\n        target: \"attack\",\n        subTarget: \"~attackCore\",\n        modifier: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n    // Energy drain to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getNegativeEnergyDrain,\n        operator: \"function\",\n        target: \"attack\",\n        subTarget: \"~attackCore\",\n        modifier: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n    // ACP to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => -d.attributes.acp.attackPenalty,\n        operator: \"function\",\n        target: \"attack\",\n        subTarget: \"~attackCore\",\n        modifier: \"penalty\",\n        flavor: game.i18n.localize(\"FFD20.ArmorCheckPenalty\"),\n      })\n    );\n  }\n\n  // Add variables to CMD\n  {\n    // BAB to CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getBabTotal,\n        operator: \"function\",\n        target: \"misc\",\n        subTarget: \"cmd\",\n        modifier: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n    // Strength or substitute to CMD\n    const strAbl = actorData.attributes.cmd.strAbility;\n    if (strAbl in ffd20.config.abilities) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${strAbl}.mod`,\n          target: \"misc\",\n          subTarget: \"cmd\",\n          modifier: \"untypedPerm\",\n          flavor: ffd20.config.abilities[strAbl],\n        })\n      );\n    }\n    // Energy Drain to CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getNegativeEnergyDrain,\n        operator: \"function\",\n        target: \"misc\",\n        subTarget: \"cmd\",\n        modifier: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n  }\n\n  // Add Dexterity Modifier to Initiative\n  {\n    const abl = actorData.attributes.init.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: getAbilityMod(abl),\n          operator: \"function\",\n          target: \"misc\",\n          subTarget: \"init\",\n          modifier: \"untypedPerm\",\n          priority: -100,\n          flavor: ffd20.config.abilities[abl],\n        })\n      );\n    }\n\n    // Add ACP penalty\n    if ([\"str\", \"dex\"].includes(abl)) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: (d) => -d.attributes.acp.attackPenalty,\n          operator: \"function\",\n          target: \"misc\",\n          subTarget: \"init\",\n          modifier: \"penalty\",\n          priority: -100,\n          flavor: game.i18n.localize(\"FFD20.ArmorCheckPenalty\"),\n        })\n      );\n    }\n  }\n\n  // Add Ability modifiers and Energy Drain to saving throws\n  {\n    // Ability Mod to Fortitude\n    let abl = actorData.attributes.savingThrows.fort.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: getAbilityMod(abl),\n          operator: \"function\",\n          target: \"savingThrows\",\n          subTarget: \"fort\",\n          modifier: \"untypedPerm\",\n          flavor: ffd20.config.abilities[abl],\n        })\n      );\n    }\n    // Ability Mod to Reflex\n    abl = actorData.attributes.savingThrows.ref.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: getAbilityMod(abl),\n          operator: \"function\",\n          target: \"savingThrows\",\n          subTarget: \"ref\",\n          modifier: \"untypedPerm\",\n          flavor: ffd20.config.abilities[abl],\n        })\n      );\n    }\n    // Ability Mod to Will\n    abl = actorData.attributes.savingThrows.will.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: getAbilityMod(abl),\n          operator: \"function\",\n          target: \"savingThrows\",\n          subTarget: \"will\",\n          modifier: \"untypedPerm\",\n          flavor: ffd20.config.abilities[abl],\n        })\n      );\n    }\n    // Energy Drain\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getNegativeEnergyDrain,\n        operator: \"function\",\n        target: \"savingThrows\",\n        subTarget: \"allSavingThrows\",\n        modifier: \"penalty\",\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n  }\n  // Spell Resistance\n  {\n    const sr = actorData.attributes.sr.formula || 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: sr,\n        target: \"misc\",\n        subTarget: \"spellResist\",\n        modifier: \"base\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Base\"),\n      })\n    );\n  }\n  {\n    // Carry capacity strength bonus\n    const cStr = actorData.details.carryCapacity.bonus.user || 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: cStr,\n        target: \"misc\",\n        subTarget: \"carryStr\",\n        modifier: \"untyped\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Custom\"),\n      })\n    );\n    // Carry capacity multiplier\n    const cMultBase = actorData.details.carryCapacity.multiplier.base ?? 1;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: cMultBase,\n        target: \"misc\",\n        subTarget: \"carryMult\",\n        modifier: \"base\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Base\"),\n      })\n    );\n    const cMult = actorData.details.carryCapacity.multiplier.user || 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: cMult,\n        target: \"misc\",\n        subTarget: \"carryMult\",\n        modifier: \"untyped\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Custom\"),\n      })\n    );\n  }\n  // Natural armor\n  {\n    const ac = actorData.attributes.naturalAC || 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ac,\n        subTarget: \"nac\",\n        modifier: \"base\",\n        flavor: game.i18n.localize(\"FFD20.EquipTypeNatural\"),\n      })\n    );\n  }\n  // Add armor bonuses from equipment\n  this.items\n    .filter((obj) => {\n      return obj.type === \"equipment\" && obj.system.equipped;\n    })\n    .forEach((item) => {\n      let armorTarget = \"aac\";\n      if (item.system.subType === \"shield\") armorTarget = \"sac\";\n      // Push base armor\n      if (item.system.armor.value || item.system.armor.enh) {\n        const baseAC = item.system.broken ? Math.floor(item.system.armor.value / 2) : item.system.armor.value;\n        const enhAC = item.system.armor.enh;\n        changes.push(\n          new ffd20.components.ItemChange(\n            {\n              formula: baseAC,\n              subTarget: armorTarget,\n              modifier: \"base\",\n            },\n            item\n          )\n        );\n        changes.push(\n          new ffd20.components.ItemChange(\n            {\n              formula: enhAC,\n              subTarget: armorTarget,\n              modifier: \"enhancement\",\n            },\n            item\n          )\n        );\n      }\n    });\n\n  // Add fly bonuses or penalties based on maneuverability\n  {\n    const flyKey = actorData.attributes.speed.fly.maneuverability;\n    let flyValue = 0;\n    if (flyKey != null) flyValue = ffd20.config.flyManeuverabilityValues[flyKey];\n    if (flyValue !== 0) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: flyValue,\n          target: \"skill\",\n          subTarget: \"skill.fly\",\n          modifier: \"racial\",\n          flavor: game.i18n.localize(\"FFD20.FlyManeuverability\"),\n        })\n      );\n    }\n  }\n  // Add swim and climb skill bonuses based on having speeds for them\n  {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => (d.attributes.speed.climb.total > 0 ? 8 : 0),\n        operator: \"function\",\n        target: \"skill\",\n        subTarget: \"skill.clm\",\n        modifier: \"racial\",\n        priority: -1,\n        flavor: game.i18n.localize(\"FFD20.SpeedClimb\"),\n      })\n    );\n\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => (d.attributes.speed.swim.total > 0 ? 8 : 0),\n        operator: \"function\",\n        target: \"skill\",\n        subTarget: \"skill.swm\",\n        modifier: \"racial\",\n        priority: -1,\n        flavor: game.i18n.localize(\"FFD20.SpeedSwim\"),\n      })\n    );\n  }\n\n  // Add energy drain to skills\n  {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: getNegativeEnergyDrain,\n        operator: \"function\",\n        target: \"skills\",\n        subTarget: \"skills\",\n        modifier: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n  }\n\n  // Add size bonuses to various attributes\n  const sizeKey = actorData.traits.size;\n  if (sizeKey !== \"med\") {\n    // AC\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ffd20.config.sizeMods[sizeKey],\n        target: \"ac\",\n        subTarget: \"ac\",\n        modifier: \"size\",\n        flavor: game.i18n.localize(\"FFD20.BonusModifierSize\"),\n      })\n    );\n    // Stealth skill\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ffd20.config.sizeStealthMods[sizeKey],\n        target: \"skill\",\n        subTarget: \"skill.ste\",\n        modifier: \"size\",\n        flavor: game.i18n.localize(\"FFD20.BonusModifierSize\"),\n      })\n    );\n    // Fly skill\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ffd20.config.sizeFlyMods[sizeKey],\n        target: \"skill\",\n        subTarget: \"skill.fly\",\n        modifier: \"size\",\n        flavor: game.i18n.localize(\"FFD20.BonusModifierSize\"),\n      })\n    );\n    // CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ffd20.config.sizeSpecialMods[sizeKey],\n        target: \"misc\",\n        subTarget: \"cmd\",\n        modifier: \"size\",\n        flavor: game.i18n.localize(\"FFD20.BonusModifierSize\"),\n      })\n    );\n  }\n\n  // Add conditions\n  for (const [con, v] of Object.entries(actorData.attributes.conditions || {})) {\n    if (!v) continue;\n\n    const mechanic = ffd20.config.conditionMechanics[con];\n    if (!mechanic) continue;\n\n    // Add changes\n    for (const change of mechanic.changes ?? []) {\n      // Alter change data\n      const changeData = deepClone(change);\n      changeData.flavor = ffd20.config.conditions[con];\n\n      // Create change object\n      const changeObj = new ffd20.components.ItemChange(changeData);\n      changes.push(changeObj);\n    }\n\n    // Set flags\n    for (const flag of mechanic.flags ?? []) {\n      this.changeFlags[flag] = true;\n    }\n  }\n\n  // Apply level drain to hit points\n  if (!Number.isNaN(actorData.attributes.energyDrain) && actorData.attributes.energyDrain > 0) {\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => -d.attributes.energyDrain * 5,\n        operator: \"function\",\n        subTarget: \"mhp\",\n        modifier: \"untyped\",\n        priority: -750,\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: (d) => -d.attributes.energyDrain * 5,\n        operator: \"function\",\n        subTarget: \"vigor\",\n        modifier: \"untyped\",\n        priority: -750,\n        flavor: game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n      })\n    );\n  }\n};\n\nconst resetSkills = function () {\n  const actorData = this.system;\n  const skills = actorData.skills;\n\n  const resetSkill = (skill) => {\n    const acpPenalty = skill.acp ? actorData.attributes.acp.total : 0;\n    const abilityModifier = actorData.abilities[skill.ability]?.mod || 0;\n    const changeModifiers = skill.changeBonus || 0;\n\n    skill.mod =\n      skill.rank +\n      (skill.cs && skill.rank > 0 ? ffd20.config.classSkillBonus : 0) +\n      abilityModifier +\n      changeModifiers -\n      acpPenalty;\n  };\n\n  for (const [skillKey, skill] of Object.entries(skills)) {\n    if (!skill) {\n      console.warn(`Bad skill data for \"${skillKey}\"`, this);\n      continue;\n    }\n\n    resetSkill(skill);\n\n    // Parse sub-skills\n    for (const [subSkillKey, subSkill] of Object.entries(skill.subSkills || {})) {\n      if (!subSkill) {\n        console.warn(`Bad subskill data for \"${skillKey}.${subSkillKey}\"`, this);\n      } else {\n        resetSkill(subSkill);\n      }\n    }\n  }\n};\n\nexport const getSourceInfo = function (obj, key) {\n  if (!obj[key]) {\n    obj[key] = { negative: [], positive: [] };\n  }\n  return obj[key];\n};\n\nexport const setSourceInfoByName = function (obj, key, name, value, positive = true) {\n  const target = positive ? \"positive\" : \"negative\";\n  const sourceInfo = getSourceInfo(obj, key)[target];\n  const data = sourceInfo.find((o) => o.name === name);\n  if (data) data.value = value;\n  else {\n    sourceInfo.push({\n      name: name,\n      value: value,\n    });\n  }\n};\n\n/**\n * @param {ItemChange[]} changes - An array containing all changes to check. Must be called after they received a value (by ItemChange.applyChange)\n * @param {object} [options]\n * @param {boolean} [options.ignoreTarget] - Whether to only check for modifiers such as enhancement, insight (true) or whether the target (AC, weapon damage) is also important (false)\n * @returns {ItemChange[]} - A list of processed changes, excluding the lower-valued ones inserted (if they don't stack)\n */\nexport const getHighestChanges = function (changes, options = { ignoreTarget: false }) {\n  const highestTemplate = {\n    value: 0,\n    ids: [],\n    highestID: null,\n  };\n  const highest = Object.keys(ffd20.config.bonusModifiers).reduce((cur, k) => {\n    if (options.ignoreTarget) cur[k] = duplicate(highestTemplate);\n    else cur[k] = {};\n    return cur;\n  }, {});\n\n  for (const c of changes) {\n    let h;\n    if (options.ignoreTarget) h = highest[c.modifier];\n    else h = highest[c.modifier]?.[c.subTarget];\n\n    if (!h) continue; // Ignore bad changes\n    h.ids.push(c._id);\n    if (h.value < c.value || !h.highestID) {\n      h.value = c.value;\n      h.highestID = c._id;\n    }\n  }\n\n  {\n    let mod, h;\n    const filterFunc = function (c) {\n      if (h.highestID === c._id) return true;\n      if (ffd20.config.stackingBonusModifiers.indexOf(mod) === -1 && h.ids.includes(c._id)) return false;\n      return true;\n    };\n\n    for (mod of Object.keys(highest)) {\n      if (options.ignoreTarget) {\n        h = highest[mod];\n        changes = changes.filter(filterFunc);\n      } else {\n        for (const subTarget of Object.keys(highest[mod])) {\n          h = highest[mod][subTarget];\n          changes = changes.filter(filterFunc);\n        }\n      }\n    }\n  }\n\n  return changes;\n};\n","import { getChangeFlat, getSourceInfo } from \"../documents/actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\nimport { getAbilityModifier } from \"@utils\";\n\nexport class ItemChange {\n  constructor(data, parent) {\n    this.data = mergeObject(this.constructor.defaultData, data);\n    this.parent = parent;\n    this.updateTime = new Date();\n  }\n\n  /**\n   * Creates a change.\n   *\n   * @param {object[]} data - Data to initialize the change(s) with.\n   * @param {object} context - An object containing context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the change within.\n   * @returns The resulting changes, or an empty array if nothing was created.\n   */\n  static async create(data, context) {\n    const { parent } = context;\n\n    if (parent instanceof ffd20.documents.item.ItemPF) {\n      // Prepare data\n      data = data.map((dataObj) => mergeObject(this.defaultData, dataObj));\n      const newChangeData = deepClone(parent.system.changes ?? []);\n      newChangeData.push(...data);\n\n      // Update parent\n      await parent.update({ \"system.changes\": newChangeData });\n\n      // Return results\n      return data.map((o) => parent.changes.get(o._id));\n    }\n\n    return [];\n  }\n\n  static get defaultData() {\n    return {\n      _id: randomID(8),\n      formula: \"\",\n      operator: \"add\",\n      subTarget: \"\",\n      modifier: \"\",\n      priority: 0,\n      value: 0,\n      flavor: undefined,\n    };\n  }\n\n  get id() {\n    return this.data._id;\n  }\n  get _id() {\n    return this.data._id;\n  }\n  get formula() {\n    return this.data.formula;\n  }\n  get operator() {\n    return this.data.operator;\n  }\n  /** @type {BuffTarget} */\n  get subTarget() {\n    return this.data.subTarget;\n  }\n  get modifier() {\n    return this.data.modifier;\n  }\n  get priority() {\n    return this.data.priority;\n  }\n  get value() {\n    return this.data.value;\n  }\n  get flavor() {\n    return this.data.flavor ?? this.parent?.name.replace(/\\[|\\]/g, \"\") ?? this.modifier;\n  }\n  get continuous() {\n    return this.data.continuous;\n  }\n  get isDeferred() {\n    if ([\"damage\", \"wdamage\", \"sdamage\", \"skills\"].includes(this.subTarget)) return true;\n    return /^skill\\./.test(this.subTarget);\n  }\n\n  get source() {\n    return this.data.source;\n  }\n  getSourceInfoTargets(actor) {\n    switch (this.subTarget) {\n      case \"aac\":\n      case \"sac\":\n      case \"nac\":\n        return [\"system.attributes.ac.normal.total\", \"system.attributes.ac.flatFooted.total\"];\n    }\n\n    // Return default targets\n    return getChangeFlat.call(actor, this.subTarget, this.modifier);\n  }\n\n  prepareData() {}\n\n  preUpdate(data) {\n    // Make sure sub-target is valid\n    {\n      if (data[\"target\"]) {\n        const subTarget = data[\"subTarget\"] || this.subTarget;\n        const changeSubTargets = this.parent.getChangeSubTargets(data[\"target\"]);\n        if (changeSubTargets[subTarget] == null) {\n          data[\"subTarget\"] = Object.keys(changeSubTargets)[0];\n        }\n      }\n    }\n\n    return data;\n  }\n\n  async update(data, options = {}) {\n    this.updateTime = new Date();\n\n    if (this.parent != null) {\n      data = this.preUpdate(data);\n\n      const rawChange = this.parent.system.changes.find((o) => o._id === this._id);\n      const idx = this.parent.system.changes.indexOf(rawChange);\n      if (idx >= 0) {\n        data = Object.entries(data).reduce((cur, o) => {\n          cur[`system.changes.${idx}.${o[0]}`] = o[1];\n          return cur;\n        }, {});\n        return this.parent.update(data, options);\n      }\n    }\n  }\n\n  /**\n   * Safely apply this change to an actor, catching any errors.\n   *\n   * @internal\n   * @see {@link ItemChange#applyChange}\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * @param {string[]} [targets] - Property paths to target on the actor's data.\n   * @param {object} [options] - Optional options to change the behavior of this function.\n   * @param {boolean} [options.applySourceInfo=true] - Whether to add the changes to the actor's source information.\n   */\n  _safeApplyChange(actor, targets = null, { applySourceInfo = true } = {}) {\n    try {\n      this.applyChange(actor, targets, { applySourceInfo });\n    } catch (error) {\n      if (this.parent?.isOwner || actor.isOwner) {\n        const msgSourceReference = this.parent\n          ? `from ${this.parent.name} [${this.parent.uuid}] to ${actor.name}`\n          : `to ${actor.name} [${actor.uuid}]]`;\n        const errorMessage = `Failed to apply ItemChange ${this.id} ${msgSourceReference}`;\n        const errorData = {\n          change: this,\n          parent: this.parent,\n          actor,\n          targets,\n        };\n        Hooks.onError(\"ItemChange#applyChange\", error, {\n          msg: errorMessage,\n          log: \"error\",\n          data: errorData,\n        });\n        ui.notifications?.error(error.message, { console: false });\n      }\n    }\n  }\n\n  /**\n   * Applies this change to an actor.\n   *\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * @param {string[]} [targets] - Property paths to target on the actor's data.\n   * @param {object} [options] - Optional options to change the behavior of this function.\n   * @param {boolean} [options.applySourceInfo=true] - Whether to add the changes to the actor's source information.\n   */\n  applyChange(actor, targets = null, { applySourceInfo = true } = {}) {\n    // Prepare change targets\n    targets ??= getChangeFlat.call(actor, this.subTarget, this.modifier);\n\n    // Ensure application of script changes creates a warning\n    if (this.operator === \"script\") {\n      ui.notifications?.warn(game.i18n.format(\"SETTINGS.pf1AllowScriptChangesF\", { parent: this.parent?.name }), {\n        console: false,\n      });\n      console.warn(\n        game.i18n.format(\"SETTINGS.pf1AllowScriptChangesF\", { parent: this.parent?.uuid || this.parent?.name }),\n        {\n          change: this,\n          item: this.parent,\n          actor: this.parent?.actor,\n        }\n      );\n    }\n\n    const rollData = this.parent ? this.parent.getRollData({ refresh: true }) : actor.getRollData({ refresh: true });\n\n    const overrides = actor.changeOverrides;\n    for (const t of targets) {\n      const override = overrides[t];\n      let operator = this.operator;\n      if (operator === \"+\") operator = \"add\";\n      if (operator === \"=\") operator = \"set\";\n\n      // HACK: Data prep change application creates overrides; only changes meant for manual comparison lack them,\n      // and those do not have to be applied to the actor.\n      // This hack enables calling applyChange on Changes that are not meant to be applied, but require a call to\n      // determine effective operator and/or value.\n      if (!override) continue;\n\n      const modifierChanger = t != null ? t.match(/^system\\.abilities\\.([a-zA-Z0-9]+)\\.(?:total|penalty|base)$/) : null;\n      const isModifierChanger = modifierChanger != null;\n      const abilityTarget = modifierChanger?.[1];\n      const ability = isModifierChanger ? deepClone(actor.system.abilities[abilityTarget]) : null;\n\n      let value = 0;\n      if (this.formula) {\n        if (operator === \"script\") {\n          if (!game.settings.get(\"ffd20\", \"allowScriptChanges\")) {\n            value = 0;\n            operator = \"add\";\n          } else {\n            const fn = this.createFunction(this.formula, [\"d\", \"item\"]);\n            const result = fn(rollData, this.parent);\n            value = result.value;\n            operator = result.operator;\n          }\n        } else if (operator === \"function\") {\n          value = this.formula(rollData, this.parent);\n          operator = \"add\";\n        } else if (!isNaN(this.formula)) {\n          value = parseFloat(this.formula);\n        } else if (this.isDeferred && RollPF.parse(this.formula).some((t) => !t.isDeterministic)) {\n          value = RollPF.replaceFormulaData(this.formula, rollData, { missing: 0 });\n        } else {\n          value = RollPF.safeRoll(this.formula, rollData, [t, this, rollData], {\n            suppressError: this.parent && !this.parent.testUserPermission(game.user, \"OWNER\"),\n          }).total;\n        }\n      }\n\n      this.data.value = value;\n\n      if (!t) continue;\n      if (operator === \"script\") continue; // HACK: Script Changes without formula are not evaluated\n\n      const prior = override[operator][this.modifier];\n\n      switch (operator) {\n        case \"add\":\n          {\n            let base = getProperty(actor, t);\n\n            // Don't change non-existing ability scores\n            if (base == null) {\n              if (t.match(/^system\\.abilities/)) continue;\n              base = 0;\n            }\n\n            // Deferred formula\n            if (typeof value === \"string\") break;\n\n            if (typeof base === \"number\") {\n              if (ffd20.config.stackingBonusModifiers.includes(this.modifier)) {\n                // Add stacking bonus\n                setProperty(actor, t, base + value);\n                override[operator][this.modifier] = (prior ?? 0) + value;\n              } else {\n                // Use higher value only\n                const diff = !prior ? value : Math.max(0, value - (prior ?? 0));\n                setProperty(actor, t, base + diff);\n                override[operator][this.modifier] = Math.max(prior ?? 0, value);\n              }\n            }\n          }\n          break;\n\n        case \"set\":\n          setProperty(actor, t, value);\n          override[operator][this.modifier] = value;\n          break;\n      }\n\n      if (applySourceInfo) this.applySourceInfo(actor, value);\n\n      // Adjust ability modifier\n      if (isModifierChanger) {\n        const newAbility = actor.system.abilities[abilityTarget];\n        const mod = getAbilityModifier(newAbility.total, {\n          damage: newAbility.damage,\n          penalty: newAbility.penalty,\n        });\n\n        actor.system.abilities[abilityTarget].mod = mod;\n      }\n    }\n  }\n\n  /**\n   * Applies this change's info to an actor's `sourceInfo`.\n   * Info is only added if either the {@link modifier | modifier type} allows stacking or the {@link value} is higher than the previous value.\n   * If the modifier type is not stacking and this change's info is added, existing and now ineffective info entries are removed.\n   *\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * returns {void}\n   */\n  applySourceInfo(actor) {\n    const sourceInfoTargets = this.getSourceInfoTargets(actor);\n    const value = this.value;\n\n    // This Change's info entry data\n    const infoEntryData = {\n      value: value,\n      name: this.parent ? this.parent.name : this.flavor,\n      modifier: this.modifier,\n      type: this.parent ? this.parent.type : null,\n      change: this,\n    };\n\n    switch (this.operator) {\n      case \"add\":\n      case \"function\":\n        if (ffd20.config.stackingBonusModifiers.includes(this.modifier)) {\n          // Always add stacking entries\n          const sourceInfoGroup = value >= 0 ? \"positive\" : \"negative\";\n          for (const si of sourceInfoTargets) {\n            getSourceInfo(actor.sourceInfo, si)[sourceInfoGroup].push(infoEntryData);\n          }\n        } else {\n          for (const infoTarget of sourceInfoTargets) {\n            const sourceInfoGroup = value >= 0 ? \"positive\" : \"negative\";\n            const sInfo = getSourceInfo(actor.sourceInfo, infoTarget)[sourceInfoGroup];\n\n            // Assume this Change's info entry should be added\n            let doAdd = true;\n\n            // The value of the this Change's source info entry for this specific target\n            let sumValue = value;\n\n            // Check if there already is an info entry with which this Change should be combined\n            // This is the case for `enhancement` and `base` entries otherwise sharing parent and target\n            const existingInfoEntry = sInfo.find((infoEntry) => {\n              const hasSameParent = infoEntry.change?.parent === this.parent;\n              const isEnh =\n                (infoEntry.change?.modifier === \"base\" && this.modifier === \"enhancement\") ||\n                (infoEntry.change?.modifier === \"enhancement\" && this.modifier === \"base\");\n              const hasSameTarget = infoEntry.change?.subTarget === this.subTarget;\n              return hasSameParent && isEnh && hasSameTarget;\n            });\n            if (existingInfoEntry) {\n              doAdd = false;\n              if (existingInfoEntry.change?.modifier === \"base\") {\n                // This Change enhances an existing base\n                existingInfoEntry.value += value;\n                continue;\n              } else {\n                // This Change replaces an existing `enhancement` entry with its own `base` entry, using the sum of both values\n                sumValue += existingInfoEntry.value;\n                // Check whether the combined entry should exist, or if another entry is already better than it\n                const hasHighestValue = !sInfo.some((infoEntry) => {\n                  const isSameModifier = infoEntry.modifier === infoEntryData.modifier;\n                  const subTarget = infoEntry.change?.subTarget;\n                  const isSameTarget = subTarget ? subTarget === this.subTarget : true;\n                  const hasHigherValue = infoEntry.value > sumValue;\n                  return isSameModifier && isSameTarget && hasHigherValue;\n                });\n                // If the merged entry is the best, replace the existing entry with it\n                sInfo.findSplice(\n                  (entry) => entry === existingInfoEntry,\n                  hasHighestValue ? { ...infoEntryData, value: sumValue } : undefined\n                );\n              }\n            }\n\n            // Determine whether there is an entry with a higher value; remove entries with lower values\n            sInfo.forEach((infoEntry) => {\n              const isSameModifier =\n                infoEntry.change?.modifier === infoEntryData.modifier || infoEntry.modifier === infoEntryData.modifier;\n              if (isSameModifier) {\n                if (infoEntry.value < sumValue) {\n                  sInfo.splice(sInfo.indexOf(infoEntry), 1);\n                } else {\n                  doAdd = false;\n                }\n              }\n            });\n\n            if (doAdd) {\n              sInfo.push({ ...infoEntryData });\n            }\n          }\n        }\n        break;\n      case \"set\":\n        for (const si of sourceInfoTargets) {\n          getSourceInfo(actor.sourceInfo, si).positive.push({\n            value: value,\n            operator: \"set\",\n            name: this.parent ? this.parent.name : this.flavor,\n            modifier: this.modifier,\n            type: this.parent ? this.parent.type : null,\n            change: this,\n          });\n        }\n        break;\n    }\n  }\n\n  createFunction(funcDef, funcArgs = []) {\n    try {\n      const preDef = `const actor = item.actor; const result = { operator: \"add\", value: 0, };`;\n      const postDef = `return result;`;\n      const fullDef = `return function(${funcArgs.join(\",\")}) {${preDef}${funcDef}\\n${postDef}};`;\n      return new Function(fullDef)();\n    } catch (e) {\n      console.warn(\"Could not create change function with definition \", funcDef);\n      return function () {\n        return { operator: \"add\", value: 0 };\n      };\n    }\n  }\n}\n","import { RollPF } from \"./roll.mjs\";\n\n/**\n * A specialized Roll class which is used to evaluate damage rolls.\n * Provides additional utility getters for data relevant to damage rolls (e.g. damage type).\n */\nexport class DamageRoll extends RollPF {\n  /**\n   * @param {string} formula - The formula to parse.\n   * @param {object} data - The data object against which to parse attributes within the formula.\n   * @param {object} options - Additional options which customize the created Roll instance.\n   */\n  constructor(formula, data, options = {}) {\n    super(formula, data, options);\n\n    this.options.damageType ??= { values: [\"untyped\"], custom: \"\" };\n  }\n\n  /**\n   * Types of damage rolls with regard to their critical status.\n   *\n   * @type {{NON_CRITICAL: string, NORMAL: string, CRITICAL: string}}\n   */\n  static TYPES = {\n    NORMAL: \"normal\",\n    CRITICAL: \"crit\",\n    NON_CRITICAL: \"nonCrit\",\n  };\n\n  /**\n   * The damage type of this damage roll.\n   *\n   * @type {{values: string[], custom: string}}\n   */\n  get damageType() {\n    return this.options.damageType;\n  }\n\n  /**\n   * The type of this damage roll.\n   *\n   * @see {@link DamageRoll.TYPES}\n   * @type {\"normal\"|\"crit\"|\"nonCrit\"}\n   */\n  get type() {\n    return this.options.type;\n  }\n\n  /**\n   * Whether this damage roll is for a critical damage instance.\n   *\n   * @type {boolean}\n   */\n  get isCritical() {\n    return this.type === this.constructor.TYPES.CRITICAL;\n  }\n}\n","export class HealthConfig extends FormApplication {\n  constructor(object, options) {\n    super(object || HealthConfig.defaultSettings, options);\n  }\n\n  /** Collect data for the template. @override */\n  async getData() {\n    let settings = await game.settings.get(\"ffd20\", \"healthConfig\");\n    settings = mergeObject(HealthConfig.defaultSettings, settings);\n    return settings;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      title: game.i18n.localize(\"SETTINGS.pf1HealthConfigName\"),\n      id: \"health-config\",\n      template: \"systems/ffd20/templates/settings/health.hbs\",\n      width: 480,\n      height: \"auto\",\n      tabs: [\n        {\n          navSelector: \".tabs\",\n          contentSelector: \".tabbed\",\n          initial: \"base\",\n          group: \"primary\",\n        },\n      ],\n    });\n  }\n\n  static get defaultSettings() {\n    return {\n      hitdice: {\n        PC: { auto: false, rate: 0.5, maximized: 1 },\n        NPC: { auto: false, rate: 0.5, maximized: 0 },\n        Racial: { auto: false, rate: 0.5, maximized: 0 },\n      },\n      hitdieOptions: [\"Compute\", \"Rate\", \"Maximized\"],\n      rounding: \"up\",\n      continuity: \"discrete\",\n      variants: {\n        pc: { useWoundsAndVigor: false, useWoundThresholds: 0, allowWoundThresholdOverride: false },\n        npc: { useWoundsAndVigor: false, useWoundThresholds: 0, allowWoundThresholdOverride: true },\n      },\n    };\n  }\n\n  /**\n   * Activate the default set of listeners for the Document sheet These listeners handle basic stuff like form submission or updating images.\n   *\n   * @override\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n    html.find('button[name=\"reset\"]').click(this._onReset.bind(this));\n    html.find('button[name=\"submit\"]').click(this._onSubmit.bind(this));\n  }\n\n  /**\n   * Handle button click to reset default settings\n   *\n   * @param event {Event}   The initial button click event\n   * @private\n   */\n  async _onReset(event) {\n    event.preventDefault();\n    await game.settings.set(\"ffd20\", \"healthConfig\", HealthConfig.defaultSettings);\n    ui.notifications.info(`Reset Pathfinder health configuration.`);\n    return this.render();\n  }\n\n  _onSubmit(event) {\n    super._onSubmit(event);\n  }\n\n  /**\n   * This method is called upon form submission after form data is validated.\n   *\n   * @override\n   */\n  async _updateObject(event, formData) {\n    const settings = expandObject(formData);\n    // Some mild sanitation for the numeric values.\n    for (const hd of Object.values(settings.hitdice)) {\n      hd.rate = Math.clamped(hd.rate, 0, 100);\n      hd.maximized = Math.clamped(Math.floor(hd.maximized), 0, 100);\n    }\n\n    settings.variants.npc.allowWoundThresholdOverride = true; // HACK: This setting vanishes otherwise\n\n    await game.settings.set(\"ffd20\", \"healthConfig\", settings);\n    ui.notifications.info(\"Updated Pathfinder health configuration.\");\n  }\n}\n","export class ExperienceConfig extends FormApplication {\n  constructor(object, options) {\n    super(object || ExperienceConfig.defaultSettings, options);\n\n    this._init = false;\n  }\n\n  /** Collect data for the template. @override */\n  async getData() {\n    const data = {};\n\n    if (!this._init) {\n      const settings = await game.settings.get(\"ffd20\", \"experienceConfig\");\n      this._settings = mergeObject(this.constructor.defaultSettings, settings);\n      this._init = true;\n    }\n    data.settings = this._settings;\n\n    // Custom experience track booleans\n    data.hasCustomFormula = data.settings.track === \"customFormula\";\n\n    return data;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      title: game.i18n.localize(\"FFD20.ExperienceConfigName\"),\n      id: \"experience-config\",\n      template: \"systems/ffd20/templates/settings/experience.hbs\",\n      width: 560,\n      height: \"auto\",\n    });\n  }\n\n  static get defaultSettings() {\n    return {\n      track: \"medium\",\n      disableExperienceTracking: false,\n      openXpDistributor: true,\n      custom: {\n        formula: \"\",\n      },\n    };\n  }\n\n  /**\n   * Activate the default set of listeners for the Document sheet These listeners handle basic stuff like form submission or updating images.\n   *\n   * @override\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n    html.find('button[type=\"submit\"]').click(this._onButtonSubmit.bind(this));\n  }\n\n  _onButtonSubmit(event) {\n    this._onSubmit(event);\n  }\n\n  _onChangeInput(event) {\n    super._onChangeInput(event);\n\n    this._updateApplicationSettings();\n  }\n\n  _updateApplicationSettings() {\n    // Update settings and re-render\n    this._settings = mergeObject(this._settings, expandObject(this._getSubmitData()));\n    this.render();\n  }\n\n  /**\n   * This method is called upon form submission after form data is validated.\n   *\n   * @override\n   */\n  async _updateObject(event, formData) {\n    const settings = mergeObject(this._settings, expandObject(formData), { inplace: false });\n    // Some mild sanitation for the numeric values.\n    await game.settings.set(\"ffd20\", \"experienceConfig\", settings);\n    ui.notifications.info(\"Updated Pathfinder experience configuration.\");\n  }\n}\n","export class AccessibilityConfig extends FormApplication {\n  constructor(object, options) {\n    super(object || AccessibilityConfig.defaultSettings, options);\n\n    this._init = false;\n  }\n\n  /** Collect data for the template. @override */\n  async getData() {\n    const data = {};\n\n    if (!this._init) {\n      const settings = await game.settings.get(\"ffd20\", \"accessibilityConfig\");\n      this._settings = mergeObject(this.constructor.defaultSettings, settings);\n      this._init = true;\n    }\n    data.settings = this._settings;\n\n    return data;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      title: game.i18n.localize(\"FFD20.AccessibilityConfigName\"),\n      id: \"accessibility-config\",\n      template: \"systems/ffd20/templates/settings/accessibility.hbs\",\n      width: 560,\n      height: \"auto\",\n    });\n  }\n\n  static get defaultSettings() {\n    return {};\n  }\n\n  /**\n   * Activate the default set of listeners for the Document sheet These listeners handle basic stuff like form submission or updating images.\n   *\n   * @override\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n    html.find('button[type=\"submit\"]').click(this._onButtonSubmit.bind(this));\n  }\n\n  _onButtonSubmit(event) {\n    this._onSubmit(event);\n  }\n\n  /**\n   * This method is called upon form submission after form data is validated.\n   *\n   * @override\n   */\n  async _updateObject(event, formData) {\n    const settings = expandObject(formData);\n    // Some mild sanitation for the numeric values.\n    await game.settings.set(\"ffd20\", \"accessibilityConfig\", settings);\n    ui.notifications.info(\"Updated Pathfinder accessibility configuration.\");\n  }\n}\n","export class TooltipWorldConfig extends FormApplication {\n  constructor(object, options) {\n    super(object || TooltipWorldConfig.defaultSettings, options);\n\n    this._cachedData = null;\n  }\n\n  getData() {\n    const result = {};\n\n    // Get settings\n    let settings = game.settings.get(\"ffd20\", \"tooltipWorldConfig\");\n    settings = mergeObject(this.constructor.defaultSettings, settings);\n    result.data = settings;\n\n    result.permissions = {\n      [CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE]: \"OWNERSHIP.NONE\",\n      [CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED]: \"OWNERSHIP.LIMITED\",\n      [CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER]: \"OWNERSHIP.OBSERVER\",\n      [CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER]: \"OWNERSHIP.OWNER\",\n    };\n\n    return result;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      title: game.i18n.localize(\"FFD20.TooltipWorldConfigName\"),\n      id: \"tooltip-world-config\",\n      template: \"systems/ffd20/templates/settings/tooltip_world.hbs\",\n      width: 720,\n      height: \"auto\",\n    });\n  }\n\n  static get defaultSettings() {\n    return {\n      disable: false,\n      portrait: {\n        hide: false,\n      },\n      hideHeld: true,\n      hideArmor: true,\n      hideBuffs: true,\n      hideConditions: false,\n      hideClothing: true,\n      hideActorNameByDisposition: 0,\n      minimumPermission: CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED,\n      hideActorNameReplacement: \"???\",\n    };\n  }\n\n  activateListeners(html) {\n    html.find('button[name=\"submit\"]').click(this._onSubmit.bind(this));\n    html.find('button[name=\"reset\"]').click(this._onReset.bind(this));\n  }\n\n  async _onReset(event) {\n    event.preventDefault();\n    await game.settings.set(\"ffd20\", \"tooltipWorldConfig\", this.constructor.defaultSettings);\n    ui.notifications.info(game.i18n.localize(\"FFD20.TooltipConfigResetInfo\"));\n    return this.render();\n  }\n\n  async _updateObject(event, formData) {\n    const settings = expandObject(formData);\n\n    await game.settings.set(\"ffd20\", \"tooltipWorldConfig\", settings);\n    ui.notifications.info(game.i18n.localize(\"FFD20.TooltipConfigUpdateInfo\"));\n  }\n}\n","import { TooltipWorldConfig } from \"./tooltip_world.mjs\";\n\nexport class TooltipConfig extends FormApplication {\n  constructor(object, options) {\n    super(object || TooltipConfig.defaultSettings, options);\n\n    this._cachedData = null;\n  }\n\n  getData() {\n    if (this._cachedData) return this._cachedData;\n\n    const canvasRect = canvas.app.view.getBoundingClientRect();\n    const result = {\n      screen: {\n        width: canvasRect.width,\n        height: canvasRect.height,\n        halfWidth: Math.floor(canvasRect.width / 2),\n        halfHeight: Math.floor(canvasRect.height / 2),\n      },\n      isGM: game.user.isGM,\n    };\n\n    // Prepare preview data\n    {\n      const p = {\n        width: 320,\n        height: 320,\n        tooltip: {\n          width: 80,\n          height: 48,\n        },\n      };\n\n      const r1 = result.screen.width / result.screen.height;\n      const r2 = result.screen.height / result.screen.width;\n\n      if (r1 > r2) {\n        p.height = Math.ceil(p.height * r2);\n      } else if (r2 > r1) {\n        p.width = Math.ceil(p.width * r1);\n      }\n\n      result.preview = p;\n    }\n\n    // Get settings\n    let settings = game.settings.get(\"ffd20\", \"tooltipConfig\");\n    settings = mergeObject(this.constructor.defaultSettings, settings);\n    result.data = settings;\n\n    // Get hide key\n    result.hideKey = game.i18n.localize(\"FFD20.Key_Control\");\n\n    this._cachedData = result;\n    return result;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      title: game.i18n.localize(\"FFD20.TooltipConfigName\"),\n      id: \"tooltip-config\",\n      template: \"systems/ffd20/templates/settings/tooltip.hbs\",\n      width: 720,\n      height: \"auto\",\n    });\n  }\n\n  static get defaultSettings() {\n    return {\n      disable: false,\n      anchor: {\n        x: 1,\n        y: 1,\n      },\n      offset: {\n        x: 0,\n        y: 0,\n      },\n      onMouse: false,\n      portrait: {\n        hide: false,\n        maxSize: {\n          width: 280,\n          height: 280,\n        },\n      },\n      hideWithoutKey: false,\n    };\n  }\n\n  activateListeners(html) {\n    html.find(\".immediate-change\").change(this._handleImmediateChange.bind(this));\n\n    html.find(\"button.world-settings\").click(this._openWorldSettings.bind(this));\n\n    html.find('button[name=\"submit\"]').click(this._onSubmit.bind(this));\n    html.find('button[name=\"reset\"]').click(this._onReset.bind(this));\n  }\n\n  _handleImmediateChange(event) {\n    const el = event.currentTarget;\n    const key = el.name;\n    if (!key) return;\n\n    let value;\n    if (el.tagName === \"INPUT\") {\n      value = el.value;\n      if (el.type === \"checkbox\") value = el.checked === true ? true : false;\n    } else {\n      value = el.innerHTML;\n    }\n    if (el.dataset?.dtype === \"Boolean\") value = Boolean(value);\n    else if (el.dataset?.dtype === \"Number\") value = parseFloat(value);\n\n    setProperty(this._cachedData, `data.${key}`, value);\n    this.render();\n  }\n\n  _openWorldSettings(event) {\n    if (!game.user.can(\"SETTINGS_MODIFY\"))\n      return void ui.notifications.error(\"FFD20.ErrorGenericPermission\", { localize: true });\n\n    new TooltipWorldConfig().render(true, { focus: true });\n  }\n\n  async _onReset(event) {\n    event.preventDefault();\n    await game.settings.set(\"ffd20\", \"tooltipConfig\", this.constructor.defaultSettings);\n    this._cachedData = null;\n    ui.notifications.info(game.i18n.localize(\"FFD20.TooltipConfigResetInfo\"));\n    return this.render();\n  }\n\n  async _updateObject(event, formData) {\n    const settings = expandObject(formData);\n\n    await game.settings.set(\"ffd20\", \"tooltipConfig\", settings);\n    ui.notifications.info(game.i18n.localize(\"FFD20.TooltipConfigUpdateInfo\"));\n  }\n}\n","export class TooltipPF extends Application {\n  constructor() {\n    super();\n\n    this.mousePos = {\n      x: 0,\n      y: 0,\n    };\n    document.addEventListener(\"mousemove\", (event) => {\n      this.mousePos.x = event.clientX;\n      this.mousePos.y = event.clientY;\n      if (this.onMouse && !this.hidden) this._setPosition();\n    });\n\n    this.object = null;\n\n    this.forceHideGMInfo = false;\n    this.forceHide = false;\n\n    this.lock = {\n      new: false,\n      old: false,\n    };\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/hud/tooltip.hbs\",\n      popOut: false,\n    });\n  }\n\n  get config() {\n    return game.settings.get(\"ffd20\", \"tooltipConfig\");\n  }\n\n  get worldConfig() {\n    return game.settings.get(\"ffd20\", \"tooltipWorldConfig\");\n  }\n\n  get anchor() {\n    return this.config.anchor;\n  }\n\n  get offset() {\n    return this.config.offset;\n  }\n\n  get onMouse() {\n    return this.config.onMouse;\n  }\n\n  get hidden() {\n    return this.element[0]?.style.visibility === \"hidden\";\n  }\n\n  bind(object) {\n    if (this.lock.new) return;\n    this.object = object;\n    this.render(true);\n  }\n\n  unbind(object) {\n    if (this.lock.old) return;\n    this.object = null;\n    this.hide();\n  }\n\n  clearBind() {\n    this.object = null;\n    this.hide();\n  }\n\n  async getData() {\n    if (typeof this.object === \"string\") {\n      return { stringContent: this.object };\n    } else if (this.object instanceof Token) {\n      return {\n        actorData: this.getTokenData(this.object),\n      };\n    } else if (this.object instanceof Actor) {\n      return {\n        actorData: this.getActorData(this.object),\n      };\n    }\n\n    return {};\n  }\n\n  getTokenData(token) {\n    const data = this.getActorData(token.actor);\n    if (!data) return null;\n\n    data.name = token.name;\n    if (\n      (game.user.isGM && this.forceHideGMInfo) ||\n      (!game.user.isGM &&\n        !token.actor.testUserPermission(\n          game.user,\n          this.worldConfig.minimumPermission ?? CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED\n        ))\n    ) {\n      const tooltipName = token.actor.system.details?.tooltip?.name || \"\";\n      const hideName = token.actor.system.details?.tooltip?.hideName === true;\n      // Hide name if explicitly set to hide or disposition does not match\n      if (hideName || token.document.disposition <= this.worldConfig.hideActorNameByDisposition) {\n        data.name = this.worldConfig.hideActorNameReplacement || \"???\";\n      }\n      // Otherwise display custom name if configured\n      else if (tooltipName) {\n        data.name = tooltipName;\n      }\n      // Otherwise display token name as normal\n      else {\n        data.name = token.name;\n      }\n    }\n\n    return data;\n  }\n\n  getActorData(actor) {\n    if (!actor) return null;\n\n    const data = {\n      data: actor.system,\n      name: actor.name,\n    };\n\n    if (!(game.user.isGM && !this.forceHideGMInfo)) {\n      data.name = actor.system.details?.tooltip?.name || actor.name;\n    }\n\n    data.isOwner = game.user.isGM || actor.isOwner;\n    if (!data.isOwner) data.name = \"???\";\n    this.getPortrait(data, actor.img);\n\n    // Get conditions\n    if (\n      (game.user.isGM && !this.forceHideGMInfo) ||\n      actor.isOwner ||\n      (!actor.system.details?.tooltip?.hideConditions && !this.worldConfig?.hideConditions)\n    ) {\n      const conditions = actor.system.attributes?.conditions || {};\n      for (const [conditionId, active] of Object.entries(conditions)) {\n        if (active === true) {\n          data.conditions = data.conditions || [];\n          data.conditions.push({\n            label: ffd20.config.conditions[conditionId],\n            icon: ffd20.config.conditionTextures[conditionId],\n          });\n        }\n      }\n    }\n\n    // Get buffs\n    if (\n      (game.user.isGM && !this.forceHideGMInfo) ||\n      actor.isOwner ||\n      (!actor.system.details?.tooltip?.hideBuffs && !this.worldConfig.hideBuffs)\n    ) {\n      const buffs = actor.itemTypes.buff?.filter((i) => i.isActive && !i.system.hideFromToken) ?? [];\n      for (const b of buffs) {\n        data.buffs = data.buffs || [];\n        data.buffs.push({\n          label: b.name,\n          icon: b.img,\n          level: b.system.level,\n        });\n      }\n    }\n\n    // Get held items\n    if (\n      (game.user.isGM && !this.forceHideGMInfo) ||\n      actor.isOwner ||\n      (!actor.system.details?.tooltip?.hideHeld && !this.worldConfig.hideHeld)\n    ) {\n      const held = actor.items.filter((i) => {\n        if (![\"weapon\", \"equipment\"].includes(i.type)) return false;\n        if (!i.system.equipped) return false;\n        if (i.type === \"equipment\" && i.subType !== \"shield\") return false;\n        return true;\n      });\n\n      for (const i of held) {\n        data.held = data.held || [];\n        data.held.push({\n          label: i.getName(this.forceHideGMInfo),\n          icon: i.img,\n        });\n      }\n    }\n\n    const equipment = actor.itemTypes.equipment?.filter((i) => i.system.equipped) ?? [];\n\n    // Get armor\n    if (\n      (game.user.isGM && !this.forceHideGMInfo) ||\n      actor.isOwner ||\n      (!actor.system.details?.tooltip?.hideArmor && !this.worldConfig.hideArmor)\n    ) {\n      const armor = equipment.filter((i) => i.subType === \"armor\");\n\n      for (const i of armor) {\n        data.armor = data.armor || [];\n        data.armor.push({\n          label: i.getName(this.forceHideGMInfo),\n          icon: i.img,\n        });\n      }\n    }\n\n    // Get clothing\n    if (\n      (game.user.isGM && !this.forceHideGMInfo) ||\n      actor.isOwner ||\n      (!getProperty(actor, \"item.details.tooltip.hideClothing\") && !this.worldConfig.hideClothing)\n    ) {\n      const clothing = equipment.filter((i) => i.subType === \"clothing\");\n\n      for (const i of clothing) {\n        data.clothing = data.clothing || [];\n        data.clothing.push({\n          label: i.getName(this.forceHideGMInfo),\n          icon: i.img,\n        });\n      }\n    }\n\n    return data;\n  }\n\n  getPortrait(data, url) {\n    if (this.config.portrait?.hide === true || this.worldConfig.portrait?.hide === true) return;\n\n    data.portrait = {\n      maxWidth: this.config.portrait?.maxSize?.width || 100,\n      maxHeight: this.config.portrait?.maxSize?.height || 100,\n      url: url,\n    };\n  }\n\n  _setPosition() {\n    if (!this.element[0]) return;\n\n    const v = canvas.app.view.getBoundingClientRect();\n    const elSize = this.element[0].getBoundingClientRect();\n    const position = {\n      width: elSize.width,\n      height: elSize.height,\n      left: 0,\n      top: 0,\n    };\n\n    const sb = ui.sidebar.element[0].getBoundingClientRect();\n    const mw = v.width - position.width - sb.width,\n      mh = v.height - position.height;\n\n    // Calculate final position\n    if (this.onMouse) {\n      const minPos = {\n        x: v.left,\n        y: v.top,\n      };\n      const maxPos = {\n        x: minPos.x + mw,\n        y: minPos.y + mh,\n      };\n      const pos = {\n        x: this.mousePos.x - position.width + position.width * this.anchor.x + this.offset.x,\n        y: this.mousePos.y - position.height + position.height * this.anchor.y + this.offset.y,\n      };\n      position.left = Math.clamped(pos.x, minPos.x, maxPos.x);\n      position.top = Math.clamped(pos.y, minPos.y, maxPos.y);\n    } else {\n      position.left = v.left + mw * this.anchor.x + this.offset.x;\n      position.top = v.top + mh * this.anchor.y + this.offset.y;\n    }\n\n    this.element.css(position);\n  }\n\n  show() {\n    if (!this.object) return;\n    if (this.forceHide) return;\n    if (this.config.disable === true || this.worldConfig.disable === true) return;\n\n    if (!game.user.isGM && this.object.document.disposition === CONST.TOKEN_DISPOSITIONS.SECRET) return;\n\n    this.element.css(\"visibility\", \"visible\");\n  }\n\n  hide() {\n    this.element.css(\"visibility\", \"hidden\");\n  }\n\n  async _render(force = false, options = {}) {\n    await super._render(force, options);\n\n    this.hide();\n\n    // Required to re-align portraits\n    const loadableContent = this.element.find(\"img\");\n    const loadableContentCount = loadableContent.length;\n    if (loadableContentCount > 0) {\n      let loadedContentCount = 0;\n      loadableContent.one(\"load\", () => {\n        loadedContentCount++;\n        if (loadedContentCount === loadableContentCount && this.object) {\n          this._setPosition();\n          this.show();\n        }\n      });\n    } else if (this.object) {\n      this._setPosition();\n      this.show();\n    }\n  }\n\n  activateListeners(html) {\n    html.find(\".controls .close\").click(() => {\n      this.clearBind();\n    });\n  }\n\n  tokenHover(token, hovering) {\n    // Show token tooltip\n    if (hovering) {\n      const p = ffd20.tooltip.mousePos;\n      const el = document.elementFromPoint(p.x, p.y);\n      // This check is required to prevent hovering over tokens under application windows\n      if (el?.id === \"board\") {\n        ffd20.tooltip.bind(token);\n      }\n    }\n    // Hide token tooltip\n    else ffd20.tooltip.unbind(token);\n  }\n\n  static toggle(enable) {\n    if (enable) {\n      if (!ffd20.tooltip) {\n        ffd20.tooltip = new TooltipPF();\n        Hooks.on(\"hoverToken\", ffd20.tooltip.tokenHover);\n      }\n      ffd20.tooltip?.setPosition();\n    } else {\n      if (ffd20.tooltip) {\n        Hooks.off(\"hoverToken\", ffd20.tooltip.tokenHover);\n        ffd20.tooltip = null;\n      }\n    }\n  }\n\n  async refresh() {\n    await this.render();\n\n    if (this.forceHide) this.hide();\n    else this.show();\n  }\n}\n","import { HealthConfig } from \"../applications/settings/health.mjs\";\nimport { ExperienceConfig } from \"../applications/settings/experience.mjs\";\nimport { AccessibilityConfig } from \"../applications/settings/accessibility.mjs\";\nimport { TooltipConfig } from \"../applications/settings/tooltip.mjs\";\nimport { TooltipWorldConfig } from \"../applications/settings/tooltip_world.mjs\";\nimport { TooltipPF } from \"../applications/tooltip.mjs\";\nimport { setDefaultSceneScaling } from \"@utils\";\n\nexport const registerSystemSettings = function () {\n  /**\n   * Track the system version upon which point a migration was last applied\n   */\n  game.settings.register(\"ffd20\", \"systemMigrationVersion\", {\n    name: \"System Migration Version\",\n    scope: \"world\",\n    config: false,\n    type: String,\n    default: \"0.0.0\",\n  });\n  /**\n   * Track when the last changelog was shown\n   */\n  game.settings.register(\"ffd20\", \"changelogVersion\", {\n    name: \"Changelog Version\",\n    scope: \"client\",\n    config: false,\n    type: String,\n    default: \"0.2.28\",\n  });\n  game.settings.register(\"ffd20\", \"dontShowChangelog\", {\n    name: \"Don't Automatically Show Changelog\",\n    scope: \"client\",\n    config: false,\n    type: Boolean,\n    default: false,\n  });\n\n  // Health configuration\n  game.settings.registerMenu(\"ffd20\", \"healthConfig\", {\n    name: \"SETTINGS.pf1HealthConfigName\",\n    label: \"SETTINGS.pf1HealthConfigLabel\",\n    hint: \"SETTINGS.pf1HealthConfigHint\",\n    icon: \"fas fa-heartbeat\",\n    type: HealthConfig,\n    restricted: true,\n  });\n  game.settings.register(\"ffd20\", \"healthConfig\", {\n    name: \"SETTINGS.pf1HealthConfigName\",\n    scope: \"world\",\n    default: HealthConfig.defaultSettings,\n    type: Object,\n    config: false,\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  // Experience configuration\n  game.settings.registerMenu(\"ffd20\", \"experienceConfig\", {\n    name: \"FFD20.ExperienceConfigName\",\n    label: \"FFD20.ExperienceConfigLabel\",\n    hint: \"FFD20.ExperienceConfigHint\",\n    icon: \"fas fa-book\",\n    type: ExperienceConfig,\n    restricted: true,\n  });\n  game.settings.register(\"ffd20\", \"experienceConfig\", {\n    name: \"FFD20.ExperienceConfigName\",\n    scope: \"world\",\n    default: ExperienceConfig.defaultSettings,\n    type: Object,\n    config: false,\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  // Accessibility configuration\n  /*\n  game.settings.registerMenu(\"ffd20\", \"accessibilityConfig\", {\n    name: \"FFD20.AccessibilityConfigName\",\n    label: \"FFD20.AccessibilityConfigLabel\",\n    hint: \"FFD20.AccessibilityConfigHint\",\n    restricted: false,\n    icon: \"fas fa-wheelchair\",\n    type: AccessibilityConfig,\n  });\n  */\n  game.settings.register(\"ffd20\", \"accessibilityConfig\", {\n    name: \"FFD20.AccessibilityConfigName\",\n    scope: \"client\",\n    default: AccessibilityConfig.defaultSettings,\n    type: Object,\n    config: false,\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  // Tooltip configuration\n  game.settings.registerMenu(\"ffd20\", \"tooltipConfig\", {\n    name: \"FFD20.TooltipConfigName\",\n    label: \"FFD20.TooltipConfigLabel\",\n    hint: \"FFD20.TooltipConfigHint\",\n    restricted: false,\n    icon: \"fas fa-window-maximize\",\n    type: TooltipConfig,\n  });\n  game.settings.register(\"ffd20\", \"tooltipConfig\", {\n    name: \"FFD20.TooltipConfigName\",\n    scope: \"client\",\n    default: TooltipConfig.defaultSettings,\n    type: Object,\n    config: false,\n    onChange: (settings) => {\n      const worldConf = game.settings.get(\"ffd20\", \"tooltipWorldConfig\");\n      const enable = !worldConf.disabled && !settings.disabled;\n      TooltipPF.toggle(enable);\n    },\n  });\n\n  // Tooltip World configuration\n  /* game.settings.registerMenu(\"ffd20\", \"tooltipWorldConfig\", {\n    name: \"FFD20.TooltipWorldConfigName\",\n    label: \"FFD20.TooltipWorldConfigLabel\",\n    hint: \"FFD20.TooltipWorldConfigHint\",\n    restricted: true,\n    icon: \"fas fa-window-maximize\",\n    type: TooltipWorldConfig,\n  }); */\n  game.settings.register(\"ffd20\", \"tooltipWorldConfig\", {\n    name: \"FFD20.TooltipWorldConfigName\",\n    scope: \"world\",\n    default: TooltipWorldConfig.defaultSettings,\n    type: Object,\n    config: false,\n    onChange: (settings) => {\n      TooltipPF.toggle(!settings.disable);\n      ffd20.tooltip?.setPosition();\n    },\n  });\n\n  // MEASURING\n\n  /**\n   * Option to change measure style\n   */\n  game.settings.register(\"ffd20\", \"measureStyle\", {\n    name: \"SETTINGS.pf1MeasureStyleN\",\n    hint: \"SETTINGS.pf1MeasureStyleL\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  /**\n   * Register diagonal movement rule setting\n   */\n  game.settings.register(\"ffd20\", \"diagonalMovement\", {\n    name: \"SETTINGS.pf1DiagN\",\n    hint: \"SETTINGS.pf1DiagL\",\n    scope: \"world\",\n    config: true,\n    default: \"5105\",\n    type: String,\n    choices: {\n      555: \"SETTINGS.pf1DiagPHB\",\n      5105: \"SETTINGS.pf1DiagDMG\",\n    },\n    onChange: (rule) => (canvas.grid.diagonalRule = rule),\n  });\n\n  /**\n   * System of Units\n   */\n  game.settings.register(\"ffd20\", \"units\", {\n    name: \"SETTINGS.pf1UnitsN\",\n    hint: \"SETTINGS.pf1UnitsL\",\n    scope: \"world\",\n    config: true,\n    default: \"imperial\",\n    type: String,\n    choices: {\n      imperial: game.i18n.localize(\"SETTINGS.pf1ImperialUnits\"),\n      metric: game.i18n.localize(\"SETTINGS.pf1MetricUnits\"),\n    },\n    onChange: () => {\n      ffd20.utils.refreshActors();\n      setDefaultSceneScaling();\n    },\n  });\n\n  /**\n   * System of units override for distances.\n   */\n  game.settings.register(\"ffd20\", \"distanceUnits\", {\n    name: \"SETTINGS.pf1DistanceUnitsN\",\n    hint: \"SETTINGS.pf1DistanceUnitsL\",\n    scope: \"world\",\n    config: true,\n    default: \"default\",\n    type: String,\n    choices: {\n      default: game.i18n.localize(\"FFD20.Default\"),\n      imperial: game.i18n.localize(\"SETTINGS.pf1ImperialDistanceUnits\"),\n      metric: game.i18n.localize(\"SETTINGS.pf1MetricDistanceUnits\"),\n    },\n    onChange: () => {\n      ffd20.utils.refreshActors({ renderOnly: true });\n      setDefaultSceneScaling();\n    },\n  });\n\n  /**\n   * System of units override for weights.\n   */\n  game.settings.register(\"ffd20\", \"weightUnits\", {\n    name: \"SETTINGS.pf1WeightUnitsN\",\n    hint: \"SETTINGS.pf1WeightUnitsL\",\n    scope: \"world\",\n    config: true,\n    default: \"default\",\n    type: String,\n    choices: {\n      default: game.i18n.localize(\"FFD20.Default\"),\n      imperial: game.i18n.localize(\"SETTINGS.pf1ImperialWeightUnits\"),\n      metric: game.i18n.localize(\"SETTINGS.pf1MetricWeightUnits\"),\n    },\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  // OPTIONAL RULES\n\n  /**\n   * Option to allow the background skills optional ruleset.\n   */\n  game.settings.register(\"ffd20\", \"allowBackgroundSkills\", {\n    name: \"SETTINGS.pf1BackgroundSkillsN\",\n    hint: \"SETTINGS.pf1BackgroundSkillsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  /**\n   * Option to use the Fractional Base Bonuses optional ruleset.\n   */\n  game.settings.register(\"ffd20\", \"useFractionalBaseBonuses\", {\n    name: \"SETTINGS.pf1FractionalBaseBonusesN\",\n    hint: \"SETTINGS.pf1FractionalBaseBonusesH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  /**\n   * Unchained action economy\n   */\n  game.settings.register(\"ffd20\", \"unchainedActionEconomy\", {\n    name: \"SETTINGS.pf1UnchainedActionEconomyN\",\n    hint: \"SETTINGS.pf1UnchainedActionEconomyH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  // VISION\n\n  /**\n   * Low-light Vision Mode\n   */\n  game.settings.register(\"ffd20\", \"lowLightVisionMode\", {\n    name: \"SETTINGS.pf1LowLightVisionModeN\",\n    hint: \"SETTINGS.pf1LowLightVisionModeH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => {\n      // Refresh canvas sight\n      canvas.perception.update(\n        { initializeLighting: true, initializeVision: true, refreshLighting: true, refreshVision: true },\n        true\n      );\n    },\n  });\n\n  /**\n   * Shared Vision sharing style.\n   */\n  game.settings.register(\"ffd20\", \"sharedVisionMode\", {\n    name: \"SETTINGS.pf1SharedVisionModeN\",\n    hint: \"SETTINGS.pf1SharedVisionModeH\",\n    scope: \"world\",\n    config: false, // Hidden as it is unused; TODO: Re-implement #187's setting usage or remove setting/feature completely\n    default: \"0\",\n    type: String,\n    choices: {\n      0: \"SETTINGS.pf1SharedVisionWithoutSelection\",\n      1: \"SETTINGS.pf1SharedVisionWithSelection\",\n    },\n    onChange: () => canvas.perception.update({ refreshLighting: true, refreshVision: true }, true),\n  });\n\n  /**\n   * Enable vision for player characters by default.\n   */\n  game.settings.register(\"ffd20\", \"characterVision\", {\n    name: \"SETTINGS.pf1characterVisionN\",\n    hint: \"SETTINGS.pf1characterVisionH\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  // CHAT CARDS\n\n  /**\n   * Option to automatically collapse Item Card descriptions\n   */\n  game.settings.register(\"ffd20\", \"autoCollapseItemCards\", {\n    name: \"SETTINGS.pf1AutoCollapseCardN\",\n    hint: \"SETTINGS.pf1AutoCollapseCardL\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ui.chat.render(),\n  });\n\n  /**\n   * Option to hide chat buttons\n   */\n  game.settings.register(\"ffd20\", \"hideChatButtons\", {\n    name: \"SETTINGS.pf1HideChatButtonsN\",\n    hint: \"SETTINGS.pf1HideChatButtonsH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ui.chat.render(),\n  });\n\n  // HOMEBREW\n\n  /**\n   * Set coin weight\n   */\n  game.settings.register(\"ffd20\", \"coinWeight\", {\n    name: \"SETTINGS.pf1CoinWeightN\",\n    hint: \"SETTINGS.pf1CoinWeightH\",\n    scope: \"world\",\n    config: true,\n    default: 50,\n    type: Number,\n    onChange: () => ffd20.utils.refreshActors(),\n  });\n\n  /**\n   * Default spellpoint cost\n   */\n  game.settings.register(\"ffd20\", \"spellPointCost\", {\n    name: \"SETTINGS.pf1SpellPointCostN\",\n    hint: \"SETTINGS.pf1SpellPointCostH\",\n    scope: \"world\",\n    config: true,\n    default: \"@sl\",\n    type: String,\n    onChange: () => ffd20.utils.refreshSheets({ reset: false }),\n  });\n\n  /**\n   * Alternative reach corner rule\n   */\n  game.settings.register(\"ffd20\", \"alternativeReachCornerRule\", {\n    name: \"SETTINGS.pf1AlternativeReachCornerRuleN\",\n    hint: \"SETTINGS.pf1AlternativeReachCornerRuleH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Allow proficiencies on NPCs.\n   */\n  game.settings.register(\"ffd20\", \"npcProficiencies\", {\n    name: \"SETTINGS.pf1NPCProficienciesN\",\n    hint: \"SETTINGS.pf1NPCProficienciesH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  // TOKENS / CONDITIONS\n\n  /**\n   * Display default token conditions alongside system ones\n   */\n  game.settings.register(\"ffd20\", \"coreEffects\", {\n    name: \"SETTINGS.pf1CoreEffectsN\",\n    hint: \"SETTINGS.pf1CoreEffectsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  /**\n   * Hide token conditions\n   */\n  game.settings.register(\"ffd20\", \"hideTokenConditions\", {\n    name: \"SETTINGS.pf1HideTokenConditionsN\",\n    hint: \"SETTINGS.pf1HideTokenConditionsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => {\n      if (!game.users.activeGM.isSelf) return;\n\n      const promises = [];\n      const actors = [\n        ...game.actors.filter((actor) => actor.prototypeToken.actorLink),\n        ...Object.values(game.actors.tokens).filter((actor) => actor != null),\n      ];\n      for (const actor of actors) {\n        if (actor.toggleConditionStatusIcons) {\n          promises.push(actor.toggleConditionStatusIcons({ render: false }));\n        }\n      }\n      return Promise.all(promises);\n    },\n  });\n\n  // TRANSPARENCY\n\n  /**\n   * Hide inline rolls from non-observers.\n   */\n  game.settings.register(\"ffd20\", \"obscureInlineRolls\", {\n    name: \"SETTINGS.pf1obscureInlineRollsN\",\n    hint: \"SETTINGS.pf1obscureInlineRollsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  /**\n   * Hide save DCs.\n   */\n  game.settings.register(\"ffd20\", \"obscureSaveDCs\", {\n    name: \"SETTINGS.pf1obscureSaveDCsN\",\n    hint: \"SETTINGS.pf1obscureSaveDCsH\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  // COMBAT\n\n  game.settings.register(\"ffd20\", \"initiativeTiebreaker\", {\n    name: \"SETTINGS.pf1InitTiebreakerN\",\n    hint: \"SETTINGS.pf1InitTiebreakerH\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  // USER INTERFACE\n\n  /**\n   * Skip action dialog prompts\n   */\n  game.settings.register(\"ffd20\", \"skipActionDialogs\", {\n    name: \"SETTINGS.pf1SkipActionDialogsN\",\n    hint: \"SETTINGS.pf1SkipActionDialogsH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /*\n   * When skipping an action dialog prompt still place the template if one is configured\n   */\n  game.settings.register(\"ffd20\", \"placeMeasureTemplateOnQuickRolls\", {\n    name: \"SETTINGS.placeMeasureTemplateOnQuickRollsN\",\n    hint: \"SETTINGS.placeMeasureTemplateOnQuickRollsH\",\n    scope: \"client\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  /**\n   * Invert filter Shift-clicking\n   */\n  game.settings.register(\"ffd20\", \"invertSectionFilterShiftBehaviour\", {\n    name: \"SETTINGS.pf1InvertSectionFilterBehaviourN\",\n    hint: \"SETTINGS.pf1InvertSectionFilterBehaviourH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Hide reach measurements\n   */\n  game.settings.register(\"ffd20\", \"hideReachMeasurements\", {\n    name: \"SETTINGS.pf1HideReachMeasurementsN\",\n    hint: \"SETTINGS.pf1HideReachMeasurementsH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Display BAB iteratives instead of simply total\n   */\n  game.settings.register(\"ffd20\", \"displayIteratives\", {\n    name: \"SETTINGS.pf1DisplayIterativesN\",\n    hint: \"SETTINGS.pf1DisplayIterativesH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  // TARGETING\n\n  /**\n   * Disable targets for attack cards\n   */\n  game.settings.register(\"ffd20\", \"disableAttackCardTargets\", {\n    name: \"SETTINGS.pf1DisableAttackCardTargetsN\",\n    hint: \"SETTINGS.pf1DisableAttackCardTargetsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Clear targets after attack\n   */\n  game.settings.register(\"ffd20\", \"clearTargetsAfterAttack\", {\n    name: \"SETTINGS.pf1ClearTargetsAfterAttackN\",\n    hint: \"SETTINGS.pf1ClearTargetsAfterAttackH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  // SECURITY\n\n  /**\n   * Allow Script type Changes.\n   */\n  game.settings.register(\"ffd20\", \"allowScriptChanges\", {\n    name: \"SETTINGS.pf1AllowScriptChangesN\",\n    hint: \"SETTINGS.pf1AllowScriptChangesH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: (value) => {\n      if (!value || !game.user.isGM) return;\n      // Flash scare message and confirmation\n      const d = Dialog.confirm({\n        title: game.i18n.localize(\"SETTINGS.pf1AllowScriptChangesN\"),\n        content: game.i18n.localize(\"SETTINGS.pf1AllowScriptChangesW\"),\n        defaultYes: false,\n      });\n      d.then((result) => {\n        if (!result) game.settings.set(\"ffd20\", \"allowScriptChanges\", false);\n      });\n    },\n  });\n};\n\nexport const registerClientSettings = function () {};\n\nexport const migrateSystemSettings = async function () {\n  // Delete now unused compendium browser cache\n  game.settings.storage.get(\"client\").removeItem(\"ffd20.compendiumItems\");\n\n  if (!game.user.isGM) return;\n\n  // Currently empty, since the last option was removed (2022-06-06)\n};\n\n/**\n * Returns whether the user's settings and key presses signal that dialogs should be skipped.\n *\n * @returns {boolean}\n */\nexport const getSkipActionPrompt = function () {\n  return (\n    (game.settings.get(\"ffd20\", \"skipActionDialogs\") && !ffd20.skipConfirmPrompt) ||\n    (!game.settings.get(\"ffd20\", \"skipActionDialogs\") && ffd20.skipConfirmPrompt)\n  );\n};\n","import { getSkipActionPrompt } from \"module/documents/settings.mjs\";\nimport { RollPF } from \"./roll.mjs\";\n\n/**\n * A class adding additional functionality to {@link Roll Rolls} for d20 based Pathfinder rolls.\n */\nexport class D20RollPF extends RollPF {\n  /** @type {D20RollOptions} */\n  options;\n\n  /**\n   * @param {string} formula - The roll formula to parse\n   * @param {object} [data] - The data object against which to parse attributes within the formula\n   * @param {Partial<D20RollConstructorOptions>} [options]\n   */\n  constructor(formula, data, options = {}) {\n    super(formula, data, options);\n    this.options = mergeObject(this.constructor.defaultOptions, options);\n\n    // No dice in the formula\n    if (!(this.terms[0] instanceof Die)) {\n      // If the first term is a number, use it as the static roll\n      if (this.terms[0] instanceof NumericTerm && this.options.staticRoll === null) {\n        this.options.staticRoll = this.terms[0].total;\n        this.terms[0] = new Die({ number: 1, faces: 20 });\n        this._formula = this.constructor.getFormula(this.terms);\n      } else {\n        // Conflict between numeric term and static roll\n        throw new Error(`Invalid D20RollPF formula provided: ${this._formula}`);\n      }\n    }\n  }\n\n  /**\n   * Default options for D20Rolls\n   *\n   * @type {Partial<D20RollOptions>}\n   */\n  static get defaultOptions() {\n    return { critical: 20, fumble: 1, flavor: \"\", staticRoll: null, bonus: \"\" };\n  }\n\n  /**\n   * The default handlebars template used to render the roll's dialog\n   *\n   * @type {string}\n   */\n  static DIALOG_TEMPLATE = \"systems/ffd20/templates/chat/roll-dialog.hbs\";\n\n  /**\n   * The default handlebars template used to render the roll's chat message\n   *\n   * @type {string}\n   */\n  static CHAT_TEMPLATE = \"systems/ffd20/templates/chat/roll-ext.hbs\";\n\n  /**\n   * Static roll results\n   *\n   * @enum {number}\n   */\n  static STATIC_ROLL = {\n    TEN: 10,\n    TWENTY: 20,\n  };\n\n  /**\n   * The D20 die this roll is based on.\n   *\n   * @type {Die}\n   */\n  get d20() {\n    // this.dice[0] returns wrong number if formula had, for example, a die roll inside parenthesis.\n    return this.terms[0];\n  }\n\n  /**\n   * Is this roll a critical success? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isCrit() {\n    if (!this._evaluated) return undefined;\n    if (!Number.isNumeric(this.options.critical)) return false;\n    return this.d20.total >= this.options.critical;\n  }\n\n  /**\n   * Is this roll a critical failure? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isFumble() {\n    foundry.utils.logCompatibilityWarning(\"D20RollPF.isFumble is deprecated in favor of D20RollPF.isNat1\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n    if (!this._evaluated) return undefined;\n    if (!Number.isNumeric(this.options.fumble)) return false;\n    return this.d20.total <= this.options.fumble;\n  }\n\n  /**\n   * Is this roll a natural 20? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isNat20() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total === 20;\n  }\n\n  /**\n   * Is this roll a natural 1? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isNat1() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total === 1;\n  }\n\n  /**\n   * Natural roll value. Undefined if the roll isn't evaluated.\n   *\n   * @type {number|void}\n   */\n  get natural() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total;\n  }\n\n  /**\n   * Modifier on the roll besides natural roll. Undefined if the roll isn't evaluated.\n   *\n   * @type {number|void}\n   */\n  get bonus() {\n    if (!this._evaluated) return undefined;\n    return this.total - this.natural;\n  }\n\n  /**\n   * Return a standardized representation for the displayed formula associated with this Roll.\n   * This formula includes any {@link D20RollOptions.bonus bonus} that might not be part of this roll's {@link terms}.\n   *\n   * @type {string}\n   */\n  get formula() {\n    let formula = this.constructor.getFormula(this.terms);\n    const bonusTerms = this.constructor.parse(`${this.options.bonus}`, this.data);\n    if (this.options.bonus && !this._evaluated) formula += ` + ${this.constructor.getFormula(bonusTerms)}`;\n    return formula;\n  }\n\n  /**\n   * The flavor this roll was created with.\n   *\n   * @type {string}\n   */\n  get flavor() {\n    return this.options.flavor;\n  }\n\n  /**\n   * Render a {@link Dialog} for the user to enter additional bonuses, set a static roll result, or take 10/20.\n   *\n   * @param {D20RollDialogOptions} [options] - Additional options determining what options to show in the dialog\n   * @returns {Promise<this | null>} A promise that resolves when the dialog is closed\n   */\n  async promptDialog(options = {}) {\n    const { rollMode = game.settings.get(\"core\", \"rollMode\"), template = this.constructor.DIALOG_TEMPLATE } = options;\n    const d20 = this.options.staticRoll === null ? this.d20.formula : this.options.staticRoll;\n    const renderData = {\n      data: this.data,\n      rollMode: options.rollMode || rollMode,\n      rollModes: CONFIG.Dice.rollModes,\n      d20: d20 === \"1d20\" ? \"\" : d20,\n      bonus: this.options.bonus,\n    };\n\n    const dialogOptions = options.dialogOptions || {};\n    dialogOptions.subject = options.subject;\n    dialogOptions.jQuery = false;\n    dialogOptions.classes ??= [];\n    dialogOptions.classes.push(...Dialog.defaultOptions.classes, \"ffd20\", \"roll-prompt\");\n\n    const html = await renderTemplate(template, renderData);\n\n    return new Promise((resolve) => {\n      new Dialog(\n        {\n          title: options.title || game.i18n.localize(\"FFD20.Roll\"),\n          content: html,\n          buttons: {\n            normal: {\n              label: game.i18n.localize(\"FFD20.Normal\"),\n              callback: (html) => resolve(this._onDialogSubmit(html, null)),\n            },\n            takeTen: {\n              label: game.i18n.format(\"FFD20.TakeX\", { number: this.constructor.STATIC_ROLL.TEN }),\n              callback: (html) => resolve(this._onDialogSubmit(html, this.constructor.STATIC_ROLL.TEN)),\n            },\n            takeTwenty: {\n              label: game.i18n.format(\"FFD20.TakeX\", { number: this.constructor.STATIC_ROLL.TWENTY }),\n              callback: (html) => resolve(this._onDialogSubmit(html, this.constructor.STATIC_ROLL.TWENTY)),\n            },\n          },\n          default: \"normal\",\n          close: () => {\n            resolve(null);\n          },\n        },\n        dialogOptions\n      ).render(true);\n    });\n  }\n\n  /**\n   * A callback applying the user's input from the dialog to the roll and its options.\n   *\n   * @protected\n   * @param {HTMLElement} html - The dialog's submitted HTML\n   * @param {number | null} [staticRoll] - A static roll result to use instead of rolling the dice\n   * @returns {D20RollPF} This roll\n   */\n  _onDialogSubmit(html, staticRoll) {\n    const form = html.querySelector(\"form\");\n    if (form) {\n      if (form.bonus.value) {\n        this.options.bonus = form.bonus.value;\n      }\n\n      if (form.d20.value) {\n        const baseDice = this.constructor.parse(form.d20.value, this.data);\n        // If a static roll is given as d20 input, Take X button clicks are ignored\n        if (baseDice[0] instanceof NumericTerm) this.options.staticRoll = baseDice[0].total;\n        else if (baseDice[0] instanceof Die) {\n          this.terms = [...baseDice, ...this.terms.slice(1)];\n          // d20 input is actual dice, so Take X buttons are respected\n          if (staticRoll !== undefined) this.options.staticRoll = staticRoll;\n        }\n      } else {\n        // No d20 input, base die is default, so Take X buttons are respected\n        if (staticRoll !== undefined) this.options.staticRoll = staticRoll;\n      }\n\n      if (form.rollMode) {\n        this.options.rollMode = form.rollMode.value;\n      }\n\n      this._formula = this.constructor.getFormula(this.terms);\n    }\n\n    return this;\n  }\n\n  /**\n   * Transform this roll into a {@link ChatMessage} displaying the result.\n   * This function can either create a ChatMessage (by default) or return the data object that would be used to create one.\n   *\n   * @param {object} messageData - The data object to use when creating the message\n   * @param {D20RollChatOptions} options - Additional options which configure how the message is created\n   * @returns {Promise<ChatMessage | object>} The created ChatMessage document, or the object of data that would be used to create one\n   */\n  async toMessage(messageData = {}, options = {}) {\n    if (!this._evaluated) await this.evaluate({ async: true });\n\n    const chatTemplate = options.chatTemplate || this.constructor.CHAT_TEMPLATE;\n    const chatTemplateData = mergeObject(\n      {\n        user: game.user.id,\n        formula: this.formula,\n        tooltip: await this.getTooltip(),\n        total: this.total,\n        isCrit: this.isCrit,\n        isFumble: this.isNat1, // Deprecated until 0.83\n        isNat20: this.isNat20,\n        isNat1: this.isNat1,\n        natural: this.natural,\n        bonus: this.bonus,\n        flavor: this.options.flavor,\n        compendiumEntry: options.compendium?.entry,\n        compendiumEntryType: options.compendium?.type,\n      },\n      options.chatTemplateData || {}\n    );\n\n    const rollMode = options.rollMode || this.options.rollMode || game.settings.get(\"core\", \"rollMode\");\n    messageData = foundry.utils.mergeObject(\n      {\n        user: game.user.id,\n        type: CONST.CHAT_MESSAGE_TYPES.ROLL,\n        sound: options.noSound ? undefined : CONFIG.sounds.dice,\n        content: await renderTemplate(chatTemplate, chatTemplateData),\n        \"flags.ffd20.noRollRender\": true,\n      },\n      messageData\n    );\n    messageData.rolls = [this]; // merge/expandObject would otherwise destroy the `Roll` instance\n    if (options.subject) foundry.utils.setProperty(messageData, \"flags.ffd20.subject\", options.subject);\n\n    const messageClass = CONFIG.ChatMessage.documentClass;\n    const message = new messageClass(messageData);\n    const messageObject = message.toObject();\n\n    const create = options.create ?? true;\n    if (create) {\n      return messageClass.create(message, { rollMode });\n    } else {\n      if (rollMode) messageClass.applyRollMode(messageObject, rollMode);\n      return messageObject;\n    }\n  }\n\n  /** @inheritDoc */\n  async _evaluate(options) {\n    this._applyBonus();\n    await super._evaluate(options);\n    this._applyStaticRoll();\n    return this;\n  }\n\n  /** @inheritDoc */\n  _evaluateSync(options) {\n    this._applyBonus();\n    super._evaluateSync(options);\n    this._applyStaticRoll();\n    return this;\n  }\n\n  /**\n   * Apply the bonus the roll was created with or the user entered into the dialog.\n   *\n   * @private\n   */\n  _applyBonus() {\n    if (this.options.bonus) {\n      const bonusTerms = this.constructor.parse(`${this.options.bonus}`, this.data);\n      if (!(bonusTerms[0] instanceof OperatorTerm)) bonusTerms.unshift(new OperatorTerm({ operator: \"+\" }));\n      this.terms = this.terms.concat(...bonusTerms);\n      this._formula = this.constructor.getFormula(this.terms);\n    }\n  }\n\n  /**\n   * Replace the rolled result of the active d20 (or its replacement) with a static value,\n   * and adjust the total accordingly.\n   *\n   * @remarks This requires the roll to be evaluated.\n   * @private\n   */\n  _applyStaticRoll() {\n    if (!this._evaluated) throw new Error(\"Roll must be evaluated before applying static roll.\");\n\n    if (this.options.staticRoll !== null && this.options.staticRoll >= 0) {\n      const d20 = this.d20;\n      const diff = this.options.staticRoll - d20.total;\n      const newTotal = this._total + diff;\n      const activeDie = d20.results.find((r) => r.active) ?? d20.results[0];\n      activeDie.result = this.options.staticRoll;\n      this._total = newTotal;\n      this.options.flavor += ` (${game.i18n.format(\"FFD20.TakeX\", { number: this.options.staticRoll })})`;\n    }\n  }\n}\n\n/**\n * Performs an actor based d20 roll.\n *\n * @param {Partial<D20ActorRollOptions>} [options]\n * @example Rolling a 1d20 + an actor's BAB + 2 for good behavior\n * ```js\n * const actor = game.actors.getName(\"Righteous Paladin\");\n * await ffd20.dice.d20Roll({\n *   skipDialog: true, // Roll away without a dialog\n *   flavor: \"BAB\", // Add a flavor/title to the roll\n *   parts: [`${actor.system.attributes.bab.total}[BAB]`], // Use the actor's BAB\n *   dice: \"2d20kh\", // Roll 2 d20s and keep the highest\n *   bonus: \"2[Good Behavior]\", // Add a static bonus of 2\n *   rollMode: \"gmroll\", // Make roll only visible to user and GM\n * });\n * ```\n */\nexport async function d20Roll(options = {}) {\n  const {\n    skipDialog = getSkipActionPrompt(),\n    staticRoll = null,\n    chatTemplateData = {},\n    chatMessage = true,\n    compendium,\n    noSound = false,\n    flavor = \"\",\n    parts = [],\n    dice = \"1d20\",\n    rollData = {},\n    subject,\n    rollMode,\n    bonus = \"\",\n    speaker,\n  } = options;\n  const formula = [dice, ...parts].join(\"+\");\n\n  const roll = new CONFIG.Dice.rolls.D20RollPF(formula, rollData, { flavor, staticRoll, bonus });\n  if (!skipDialog) {\n    const title = speaker?.alias ? `${speaker.alias}: ${flavor}` : flavor;\n    const dialogResult = await roll.promptDialog({ title, rollMode, subject });\n    if (dialogResult === null) return;\n  }\n\n  return roll.toMessage({ speaker }, { create: chatMessage, noSound, chatTemplateData, compendium, subject, rollMode });\n}\n","import { calculateRange, convertDistance } from \"../utils/lib.mjs\";\nimport { getHighestChanges } from \"../documents/actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\nimport { keepUpdateArray, createTag } from \"../utils/lib.mjs\";\nimport { DamageRoll } from \"../dice/damage-roll.mjs\";\nimport { D20RollPF } from \"../dice/d20roll.mjs\";\nimport { getDistanceSystem } from \"@utils\";\n\nexport class ItemAction {\n  constructor(data, parent) {\n    this.data = mergeObject(ItemAction.defaultData, data);\n\n    /** @type {import(\"../documents/item/item-pf.mjs\").ItemPF} */\n    this.parent = parent;\n    this.apps = {};\n    this.sheet = null;\n\n    this.prepareData();\n  }\n\n  get description() {\n    return this.data.description;\n  }\n\n  /**\n   * Returns whether this action is a combat maneuver\n   *\n   * @type {boolean}\n   */\n  get isCombatManeuver() {\n    return [\"mcman\", \"rcman\"].includes(this.data.actionType);\n  }\n\n  /*\n   * General activation accessor that removes determining which action economy is in use.\n   */\n  get activation() {\n    return (\n      (game.settings.get(\"ffd20\", \"unchainedActionEconomy\") ? this.data.activation.unchained : this.data.activation) ?? {}\n    );\n  }\n\n  /**\n   * Creates an action.\n   *\n   * @param {object[]} data - Data to initialize the action(s) with.\n   * @param {object} context - An object containing context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the action within.\n   * @returns The resulting actions, or an empty array if nothing was created.\n   */\n  static async create(data, context = {}) {\n    const { parent } = context;\n\n    if (parent instanceof ffd20.documents.item.ItemPF) {\n      // Prepare data\n      data = data.map((dataObj) => mergeObject(this.defaultData, dataObj));\n      const newActionData = deepClone(parent.system.actions || []);\n      newActionData.push(...data);\n\n      // Update parent\n      await parent.update({ \"system.actions\": newActionData });\n\n      // Return results\n      return data.map((o) => parent.actions.get(o._id));\n    }\n\n    return [];\n  }\n\n  static get defaultDamageType() {\n    return {\n      values: [],\n      custom: \"\",\n    };\n  }\n\n  get item() {\n    return this.parent;\n  }\n  get actor() {\n    return this.parent.actor;\n  }\n\n  get id() {\n    return this.data._id;\n  }\n  get img() {\n    return this.data.img;\n  }\n  get name() {\n    return this.data.name;\n  }\n  get tag() {\n    return this.data.tag || createTag(this.name);\n  }\n\n  get hasAction() {\n    return !!this.data.actionType;\n  }\n  get hasAttack() {\n    return [\"mwak\", \"rwak\", \"msak\", \"rsak\", \"mcman\", \"rcman\"].includes(this.data.actionType);\n  }\n\n  get hasMultiAttack() {\n    return (\n      this.hasAttack &&\n      ((this.data.attackParts != null && this.data.attackParts.length > 0) ||\n        this.data.formulaicAttacks?.count?.value > 0)\n    );\n  }\n\n  get autoDeductCharges() {\n    return this.getChargeCost() > 0;\n  }\n\n  get isCharged() {\n    return this.item.isCharged;\n  }\n\n  get isSelfCharged() {\n    return [\"single\", \"day\", \"week\", \"charges\"].includes(this.data.uses.self?.per);\n  }\n\n  /**\n   * @param {object} [options] - Additional options to configure behavior.\n   * @param {object} [options.rollData=null] - Pre-determined roll data to pass for determining the charge cost.\n   * @returns {number} Cost in charges for this action.\n   */\n  getChargeCost({ rollData = null } = {}) {\n    if (!this.isCharged) return 0;\n\n    const isSpell = this.item.type === \"spell\";\n    const isSpellpointSpell = isSpell && this.item.useSpellPoints();\n\n    let formula = !isSpellpointSpell ? this.data.uses.autoDeductChargesCost : this.data.uses.spellPointCost;\n    if (!formula) {\n      formula = this.item.getDefaultChargeFormula();\n    } else if (typeof formula !== \"string\") {\n      console.warn(this.item.name, \"action\", this.name, \"has invalid charge formula:\", formula, this);\n      formula = this.item.getDefaultChargeFormula();\n    }\n\n    rollData ??= this.getRollData();\n    const cost = RollPF.safeRoll(formula, rollData).total;\n    return this.item.isSingleUse ? Math.clamped(cost, -1, 1) : cost;\n  }\n\n  /**\n   * @type {number} The action's first increment range (in system configured units)\n   */\n  get range() {\n    return this.getRange({ type: \"single\" });\n  }\n\n  /**\n   * @type {number} The action's minimum range.\n   */\n  get minRange() {\n    return this.getRange({ type: \"min\" });\n  }\n\n  /**\n   * @type {number} The action's maximum range (range multiplied by range increments).\n   */\n  get maxRange() {\n    return this.getRange({ type: \"max\" });\n  }\n\n  /**\n   * @param {object} [options] - Additional options to configure behavior.\n   * @param {string} [options.type=\"single\"] - What type of range to query. Either \"single\" (for a single range increment), \"max\" or \"min\".\n   * @param {object} [options.rollData=null] - Specific roll data to pass.\n   * @returns {number|null} The given range, in system configured units, or `null` if no range is applicable.\n   */\n  getRange({ type = \"single\", rollData = null } = {}) {\n    const range = type === \"min\" ? this.data.range.minValue : this.data.range.value;\n    const rangeType = type === \"min\" ? this.data.range.minUnits : this.data.range.units;\n    if (!rangeType) {\n      if (type === \"min\") return 0;\n      return null;\n    }\n\n    rollData ??= this.getRollData();\n    const singleIncrementRange = calculateRange(range, rangeType, rollData);\n\n    if ([\"single\", \"min\"].includes(type)) return singleIncrementRange;\n    return singleIncrementRange * this.data.range.maxIncrements;\n  }\n\n  get hasTemplate() {\n    const v = this.data.measureTemplate.type;\n    const s = this.data.measureTemplate.size;\n    return (\n      typeof v === \"string\" && v !== \"\" && ((typeof s === \"string\" && s.length > 0) || (typeof s === \"number\" && s > 0))\n    );\n  }\n\n  /**\n   * Does the action implement a damage roll as part of its usage\n   *\n   * @type {boolean}\n   */\n  get hasDamage() {\n    return !!this.data.damage.parts?.length;\n  }\n\n  /**\n   * Does the item have range defined.\n   *\n   * @type {boolean}\n   */\n  get hasRange() {\n    const units = this.data.range?.units;\n    if (units === \"none\") return false;\n    return !!units;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Does the item provide an amount of healing instead of conventional damage?\n   *\n   * @returns {boolean}\n   */\n  get isHealing() {\n    return this.data.actionType === \"heal\" && this.data.damage.parts.length;\n  }\n\n  get hasEffect() {\n    return this.hasDamage || (this.data.effectNotes != null && this.data.effectNotes.length > 0);\n  }\n\n  /**\n   * Does the Item implement a saving throw as part of its usage\n   *\n   * @type {boolean}\n   */\n  get hasSave() {\n    return typeof this.data.save?.type === \"string\" && this.data.save?.type.length > 0;\n  }\n\n  /**\n   * @param {object} [rollData] - Data to pass to the roll. If none is given, get new roll data.\n   * @returns {number} The Difficulty Class for this action.\n   */\n  getDC(rollData = null) {\n    // No actor? No DC!\n    if (!this.actor) return 0;\n\n    rollData ??= this.getRollData();\n    let result = 10;\n\n    // Get conditional save DC bonus\n    const dcBonus = rollData.dcBonus ?? 0;\n\n    if (this.item.type === \"spell\") {\n      const spellbook = this.item.spellbook;\n      if (spellbook) {\n        let formula = spellbook.baseDCFormula;\n\n        const data = rollData.action;\n        if (data.save.dc.length > 0) formula += ` + ${data.save.dc}`;\n\n        return RollPF.safeRoll(formula, rollData).total + dcBonus;\n      }\n    } else {\n      const dcFormula = this.data.save.dc.toString() || \"0\";\n      result = RollPF.safeRoll(dcFormula, rollData).total + dcBonus;\n      return result;\n    }\n    return result;\n  }\n\n  get hasSound() {\n    return !!this.data.soundEffect;\n  }\n\n  get enhancementBonus() {\n    return this.data.enh?.value ?? this.item.system.enh;\n  }\n\n  /**\n   * An array of changes affecting this action's damage\n   *\n   * @type {ItemChange[]}\n   */\n  get damageSources() {\n    const isSpell = [\"msak\", \"rsak\", \"spellsave\"].includes(this.data.actionType);\n    const isWeapon = [\"mwak\", \"rwak\"].includes(this.data.actionType);\n    const changes = this.parent.getContextChanges(isSpell ? \"sdamage\" : isWeapon ? \"wdamage\" : \"damage\");\n    const highest = getHighestChanges(changes, { ignoreTarget: true });\n    return highest;\n  }\n\n  /**\n   * @type {ItemChange[]} All relevant Changes for this action's damage.\n   */\n  get allDamageSources() {\n    const conds = this.data.conditionals\n      .filter((c) => c.default)\n      .filter((c) => c.modifiers.find((m) => m.target === \"damage\"));\n    const rollData = this.getRollData();\n\n    if (!rollData) return [];\n\n    const mods = Object.keys(ffd20.config.bonusModifiers);\n\n    // Turn relevant conditionals into structure accepted by getHighestChanges\n    const fakeCondChanges = [];\n    for (const c of conds) {\n      for (const m of c.modifiers) {\n        if (m.target !== \"damage\") continue;\n        const roll = RollPF.safeRoll(m.formula, rollData);\n        if (roll.err) continue;\n        const isModifier = mods.includes(m.type);\n        fakeCondChanges.push({\n          flavor: c.name,\n          value: roll.total,\n          modifier: isModifier ? m.type : \"untyped\", // Turn unrecognized types to untyped\n          type: isModifier ? undefined : m.type, // Preserve damage type if present\n          formula: m.formula,\n        });\n      }\n    }\n\n    const allChanges = [...this.damageSources, ...fakeCondChanges];\n\n    // Add enhancement bonus\n    const enh = this.enhancementBonus;\n    if (enh) {\n      allChanges.push({\n        flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        value: enh,\n        modifier: \"enh\",\n        formula: enh.toString(),\n      });\n    }\n\n    // Add special cases specific to the item\n    // Broken\n    if (this.item.system.broken) {\n      allChanges.push({\n        flavor: game.i18n.localize(\"FFD20.Broken\"),\n        value: -2,\n        modifier: \"untyped\",\n        formula: \"-2\",\n      });\n    }\n\n    return getHighestChanges(allChanges, { ignoreTarget: true });\n  }\n\n  getRollData() {\n    const result = this.item.getRollData();\n\n    result.action = deepClone(this.data);\n    result.dc = this.hasSave ? this.getDC(result) : 0;\n\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  static get defaultData() {\n    return {\n      _id: randomID(16),\n      name: game.i18n.localize(\"FFD20.Action\"),\n      img: \"systems/ffd20/icons/skills/gray_04.jpg\",\n      description: \"\",\n      tag: \"\",\n      activation: {\n        cost: 1,\n        type: \"\",\n        unchained: {\n          cost: 1,\n          type: \"\",\n        },\n      },\n      duration: {\n        value: null,\n        units: \"\",\n      },\n      target: {\n        value: \"\",\n      },\n      range: {\n        value: null,\n        units: \"\",\n        maxIncrements: 1,\n        minValue: null,\n        minUnits: \"\",\n      },\n      uses: {\n        autoDeductChargesCost: \"\",\n        self: {\n          value: 0,\n          maxFormula: \"\",\n          per: \"\",\n        },\n      },\n      measureTemplate: {\n        type: \"\",\n        size: \"\",\n        overrideColor: false,\n        customColor: \"\",\n        overrideTexture: false,\n        customTexture: \"\",\n      },\n      attackName: \"\",\n      actionType: null,\n      attackBonus: \"\",\n      critConfirmBonus: \"\",\n      damage: {\n        parts: [],\n        critParts: [],\n        nonCritParts: [],\n      },\n      attackParts: [],\n      formulaicAttacks: {\n        count: { formula: \"\" },\n        bonus: { formula: \"\" },\n        label: null,\n      },\n      formula: \"\",\n      ability: {\n        attack: \"\",\n        damage: \"\",\n        damageMult: 1,\n        critRange: 20,\n        critMult: 2,\n      },\n      save: {\n        dc: \"\",\n        type: \"\",\n        description: \"\",\n      },\n      effectNotes: [],\n      attackNotes: [],\n      soundEffect: \"\",\n      powerAttack: {\n        multiplier: \"\",\n        damageBonus: 2,\n        critMultiplier: 1,\n      },\n      naturalAttack: {\n        primaryAttack: true,\n        secondary: {\n          attackBonus: \"-5\",\n          damageMult: 0.5,\n        },\n      },\n      nonlethal: false,\n      touch: false,\n      usesAmmo: false,\n      spellEffect: \"\",\n      spellArea: \"\",\n      conditionals: [],\n      enh: {\n        value: null,\n      },\n    };\n  }\n\n  prepareData() {\n    const rollData = this.getRollData();\n    // Parse formulaic attacks\n    if (this.hasAttack) {\n      this.parseFormulaicAttacks({ rollData });\n    }\n\n    // Update conditionals\n    if (this.data.conditionals instanceof Array) {\n      this.conditionals = this._prepareConditionals(this.data.conditionals);\n    }\n\n    // Prepare max personal charges\n    if (this.data.uses.self?.per) {\n      const maxFormula = this.data.uses.self.per === \"single\" ? \"1\" : this.data.uses.self.maxFormula;\n      const maxUses = RollPF.safeTotal(maxFormula, rollData);\n      setProperty(this.data, \"uses.self.max\", maxUses);\n    }\n\n    // Remove enhancement bonus override, if wrong type\n    if (this.data.enh?.value != null && ![\"weapon\", \"attack\"].includes(this.item.type)) {\n      setProperty(this.data, \"enh.value\", null);\n    }\n\n    // Initialize default damageMult if missing\n    if (this.data.ability?.damageMult === undefined) {\n      setProperty(this.data, \"ability.damageMult\", 1);\n    }\n    if (this.data.naturalAttack?.secondary?.damageMult === undefined) {\n      setProperty(this.data, \"naturalAttack.secondary.damageMult\", 0.5);\n    }\n  }\n\n  _prepareConditionals(conditionals) {\n    const prior = this.conditionals;\n    const collection = new Collection();\n    for (const o of conditionals) {\n      let conditional = null;\n      if (prior && prior.has(o._id)) {\n        conditional = prior.get(o._id);\n        conditional.data = o;\n        conditional.prepareData();\n      } else conditional = new ffd20.components.ItemConditional(o, this);\n      collection.set(o._id || conditional.data._id, conditional);\n    }\n    return collection;\n  }\n\n  async delete() {\n    const actions = deepClone(this.item.system.actions);\n    const idx = this.item.system.actions.indexOf(this.data);\n    actions.splice(idx, 1);\n\n    // Close applications\n    const promises = [];\n    for (const app of Object.values(this.apps)) {\n      promises.push(app.close());\n    }\n    await Promise.all(promises);\n\n    // Delete action\n    return this.item.update({ \"system.actions\": actions });\n  }\n\n  async update(updateData, options = {}) {\n    const idx = this.item.system.actions.findIndex((action) => action._id === this.id);\n    if (idx < 0) throw new Error(`Action ${this.id} not found on item.`);\n    const prevData = deepClone(this.data);\n    const newUpdateData = mergeObject(prevData, expandObject(updateData));\n\n    // Make sure this action has a name, even if it's removed\n    newUpdateData[\"name\"] ||= this.name;\n\n    // Make sure stuff remains an array\n    {\n      const keepPaths = [\n        \"attackParts\",\n        \"damage.parts\",\n        \"damage.critParts\",\n        \"damage.nonCritParts\",\n        \"attackNotes\",\n        \"effectNotes\",\n        \"conditionals\",\n      ];\n\n      for (const path of keepPaths) {\n        keepUpdateArray(this.data, newUpdateData, path);\n      }\n    }\n\n    await this.item.update({ \"system.actions\": { [idx]: newUpdateData } });\n    await this.sheet?.render();\n  }\n\n  /* -------------------------------------------- */\n  /*  Chat Data Generation\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * Generates {@link ChatData} for this action's parent item, but with this action's data,\n   * regardless of whether it is the first action or not.\n   *\n   * @see {@link ItemPF#getChatData}\n   * @param {EnrichmentOptions} [htmlOptions] - Options passed to {@link ItemPF#getChatData} affecting text enrichment\n   * @param {object} [chatDataOptions] - Options passed to {@link ItemPF#getChatData} affecting the chat data\n   * @returns {import(\"../documents/item/item-pf.mjs\").ChatData} Chat data for this action's parent and this action\n   */\n  getChatData(htmlOptions = {}, chatDataOptions = {}) {\n    return this.parent.getChatData(htmlOptions, { ...chatDataOptions, actionId: this.id });\n  }\n\n  /**\n   * Returns labels related to this particular action\n   *\n   * @param {object} [options]\n   * @param {object} [options.rollData] - Pre-determined roll data. If not provided, finds the action's own roll data.\n   * @returns {Record<string, string>} This action's labels\n   */\n  getLabels({ rollData } = {}) {\n    const actionData = this.data;\n    const labels = {};\n    rollData ??= this.getRollData();\n\n    const isUnchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n\n    // Activation method\n    if (actionData.activation) {\n      const activationTypes = isUnchainedActionEconomy\n        ? ffd20.config.abilityActivationTypes_unchained\n        : ffd20.config.abilityActivationTypes;\n      const activationTypesPlural = isUnchainedActionEconomy\n        ? ffd20.config.abilityActivationTypesPlurals_unchained\n        : ffd20.config.abilityActivationTypesPlurals;\n\n      const activation = this.activation;\n      if (activation && activation.cost > 1 && activationTypesPlural[activation.type] != null) {\n        labels.activation = [activation.cost.toString(), activationTypesPlural[activation.type]].filterJoin(\" \");\n      } else if (activation) {\n        labels.activation = [\n          [\"minute\", \"hour\", \"action\"].includes(activation.type) && activation.cost ? activation.cost.toString() : \"\",\n          activationTypes[activation.type],\n        ].filterJoin(\" \");\n      }\n    }\n\n    // Difficulty Class\n    if (this.hasSave) {\n      const totalDC = rollData.dc + (rollData.dcBonus ?? 0);\n      labels.save = game.i18n.format(\"FFD20.DCThreshold\", { threshold: totalDC });\n    }\n\n    if (this.hasRange) {\n      const sourceUnits = actionData.range.units;\n      const rangeLabel = ffd20.config.distanceUnits[sourceUnits];\n      if ([\"personal\", \"touch\", \"melee\", \"reach\"].includes(sourceUnits)) {\n        labels.range = rangeLabel;\n      } else {\n        const range = this.getRange({ type: \"single\", rollData });\n        if (range > 0) {\n          const usystem = getDistanceSystem();\n          const rangeUnit = usystem === \"metric\" ? \"m\" : \"ft\";\n          labels.range = `${range} ${rangeUnit}`;\n        }\n        if ([\"close\", \"medium\", \"long\"].includes(sourceUnits)) {\n          labels.range += ` (${rangeLabel})`;\n        }\n      }\n    }\n\n    return labels;\n  }\n\n  // -----------------------------------------------------------------------\n\n  parseFormulaicAttacks({ formula = null, rollData } = {}) {\n    if (!this.actor) return;\n\n    const exAtkCountFormula = formula || this.data.formulaicAttacks?.count?.formula || \"0\";\n    let extraAttacks = 0,\n      xaroll;\n    rollData ??= this.getRollData();\n    if (exAtkCountFormula.length > 0) {\n      xaroll = RollPF.safeRoll(exAtkCountFormula, rollData);\n      extraAttacks = Math.clamped(xaroll.total, 0, 50); // Arbitrarily clamp attacks\n    }\n    if (xaroll?.err) {\n      const msg = game.i18n.format(\"FFD20.ErrorActionFormula\", {\n        action: this.name,\n        item: this.item?.name,\n        actor: this.actor?.name,\n      });\n      console.warn(msg, xaroll.err, exAtkCountFormula, this);\n      ui.notifications.warn(msg, { console: false });\n    }\n\n    // Test bonus attack formula\n    const exAtkBonusFormula = this.data.formulaicAttacks?.bonus?.formula || \"0\";\n    try {\n      if (exAtkBonusFormula.length > 0 && exAtkBonusFormula != 0) {\n        rollData.attackCount = 1;\n        RollPF.safeRoll(exAtkBonusFormula, rollData);\n        delete rollData.attackCount;\n      }\n    } catch (err) {\n      const msg = game.i18n.format(\"FFD20.ErrorActionFormula\", {\n        action: this.name,\n        item: this.item?.name,\n        actor: this.actor?.name,\n      });\n      console.error(msg, err, exAtkBonusFormula, this);\n      ui.notifications.error(msg, { console: false });\n    }\n\n    // Update item\n    setProperty(this.data, \"formulaicAttacks.count.value\", extraAttacks);\n\n    return extraAttacks;\n  }\n\n  /**\n   * Place an attack roll using an item (weapon, feat, spell, or equipment)\n   *\n   * @param root0\n   * @param root0.data\n   * @param root0.extraParts\n   * @param root0.bonus\n   * @param root0.primaryAttack\n   */\n  async rollAttack({ data = null, extraParts = [], bonus = null, primaryAttack = true } = {}) {\n    const rollData = data ?? this.getRollData();\n    const itemData = rollData.item;\n    const actionData = rollData.action;\n\n    rollData.item.primaryAttack = primaryAttack;\n\n    const isRanged = [\"rwak\", \"rsak\", \"rcman\"].includes(actionData.actionType);\n    const isCMB = this.isCombatManeuver;\n\n    // Determine size bonus\n    rollData.sizeBonus = !isCMB\n      ? ffd20.config.sizeMods[rollData.traits.size]\n      : ffd20.config.sizeSpecialMods[rollData.traits.size];\n\n    // Add misc bonuses/penalties\n    rollData.item.proficiencyPenalty = -4;\n\n    // Determine ability score modifier\n    const abl = actionData.ability.attack;\n\n    // Define Roll parts\n    let parts = [];\n\n    this.actor.sourceDetails[\"system.attributes.attack.shared\"]\n      ?.reverse()\n      .forEach((s) => parts.push(`${s.value}[${s.name}]`));\n\n    // CMB specific modifiers\n    if (isCMB) {\n      this.actor.sourceDetails[\"system.attributes.cmb.bonus\"]\n        ?.reverse()\n        .forEach((s) => parts.push(`${s.value}[${s.name}]`));\n    }\n\n    // Add size bonus\n    if (rollData.sizeBonus !== 0) parts.push(`@sizeBonus[${game.i18n.localize(\"FFD20.Size\")}]`);\n\n    // Add ability modifier\n    if (abl != \"\" && rollData.abilities[abl] != null && rollData.abilities[abl].mod !== 0) {\n      parts.push(`@abilities.${abl}.mod[${ffd20.config.abilities[abl]}]`);\n    }\n    // Add bonus parts\n    parts = parts.concat(extraParts);\n    // Add attack bonus\n    if (typeof actionData.attackBonus === \"string\" && ![\"\", \"0\"].includes(actionData.attackBonus)) {\n      parts.push(actionData.attackBonus);\n    }\n    // Backwards compatibility\n    else if (typeof actionData.attackBonus === \"number\") {\n      rollData.item.attackBonus = actionData.attackBonus;\n      parts.push(`@item.attackBonus[${game.i18n.localize(\"FFD20.AttackRollBonus\")}]`);\n    }\n\n    // Add change bonus\n    const changes = this.item.getContextChanges(isRanged ? \"rattack\" : \"mattack\");\n    // Add masterwork bonus to changes (if applicable)\n    if ([\"mwak\", \"rwak\", \"mcman\", \"rcman\"].includes(this.data.actionType) && this.item.system.masterwork) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"1\",\n          operator: \"add\",\n          subTarget: \"attack\",\n          modifier: \"enh\",\n          value: 1,\n          flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        })\n      );\n    }\n    // Add enhancement bonus to changes\n    if (this.enhancementBonus) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: this.enhancementBonus.toString(),\n          operator: \"add\",\n          subTarget: \"attack\",\n          modifier: \"enh\",\n          value: this.enhancementBonus,\n          flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        })\n      );\n    }\n    let changeBonus = [];\n    // Get attack bonus\n    changeBonus = getHighestChanges(\n      changes.filter((c) => {\n        c.applyChange(this.actor);\n        return ![\"set\", \"=\"].includes(c.operator);\n      }),\n      { ignoreTarget: true }\n    ).reduce((cur, c) => {\n      cur.push({\n        value: c.value,\n        source: c.flavor,\n      });\n      return cur;\n    }, []);\n    for (const c of changeBonus) {\n      parts.push(`${c.value}[${RollPF.cleanFlavor(c.source)}]`);\n    }\n\n    // Add proficiency penalty\n    if ([\"attack\", \"weapon\", \"equipment\"].includes(this.item.type) && !itemData.proficient) {\n      parts.push(`@item.proficiencyPenalty[${game.i18n.localize(\"FFD20.ProficiencyPenalty\")}]`);\n    }\n    // Add secondary natural attack penalty\n    if (this.item.system.subType === \"natural\" && primaryAttack === false) {\n      const penalty = -5;\n      parts.push(`${penalty}[${game.i18n.localize(\"FFD20.SecondaryAttack\")}]`);\n    }\n    // Add bonus\n    if (bonus) {\n      rollData.bonus = RollPF.safeRoll(bonus, rollData).total;\n      parts.push(`@bonus[${game.i18n.localize(\"FFD20.SituationalBonus\")}]`);\n    }\n\n    const critRange = itemData.broken || this.isCombatManeuver ? 20 : actionData.ability.critRange || 20;\n    const roll = await new D20RollPF([rollData.d20 || \"1d20\", ...parts.filter((p) => !!p)].join(\"+\"), rollData, {\n      critical: critRange,\n    }).evaluate({ async: true });\n    return roll;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Only roll the item's effect.\n   *\n   * @param root0\n   * @param root0.critical\n   * @param root0.primaryAttack\n   */\n  rollEffect({ critical = false, primaryAttack = true } = {}) {\n    const rollData = this.getRollData();\n\n    if (!this.hasEffect) {\n      throw new Error(\"You may not make an Effect Roll with this Item.\");\n    }\n\n    // Determine critical multiplier\n    rollData.critMult = 1;\n    if (critical) rollData.critMult = this.data.ability.critMult;\n    // Determine ability multiplier\n    if (this.data.ability.damageMult != null) rollData.ablMult = this.data.ability.damageMult;\n\n    // Create effect string\n    const effectNotes = this.parent.getContextNotes(\"attacks.effect\").reduce((cur, o) => {\n      o.notes\n        .reduce((cur2, n) => {\n          cur2.push(...n.split(/[\\n\\r]+/));\n          return cur2;\n        }, [])\n        .forEach((n) => {\n          cur.push(n);\n        });\n      return cur;\n    }, []);\n    effectNotes.push(...this.data.effectNotes);\n    let effectContent = \"\";\n    for (const fx of effectNotes) {\n      if (fx.length > 0) {\n        effectContent += `<span class=\"tag\">${fx}</span>`;\n      }\n    }\n\n    if (effectContent.length === 0) return \"\";\n\n    const inner = TextEditor.enrichHTML(effectContent, { rollData: rollData });\n    return `<div class=\"flexcol property-group\"><label>${game.i18n.localize(\n      \"FFD20.EffectNotes\"\n    )}</label><div class=\"flexrow tag-list\">${inner}</div></div>`;\n  }\n\n  /**\n   * Place an attack roll using an item (weapon, feat, spell, or equipment)\n   * Rely upon the DicePF.d20Roll logic for the core implementation\n   *\n   * @param options\n   */\n  async rollFormula(options = {}) {\n    const itemData = this.data;\n    if (!itemData.formula) {\n      throw new Error(game.i18n.format(\"FFD20.ErrorNoFormula\", { name: this.name }));\n    }\n\n    // Define Roll Data\n    const rollData = this.parent.getRollData();\n    rollData.item = itemData;\n    const title = `${this.name} - ${game.i18n.localize(\"FFD20.OtherFormula\")}`;\n\n    const roll = await RollPF.create(itemData.formula, rollData).evaluate({ async: true });\n    return roll.toMessage({\n      speaker: ChatMessage.getSpeaker({ actor: this.parent }),\n      flavor: itemData.chatFlavor || title,\n      rollMode: game.settings.get(\"core\", \"rollMode\"),\n    });\n  }\n\n  /**\n   * Roll damage for an action.\n   *\n   * @param {object} [options] - Options configuring the damage roll\n   * @param {object | null} [options.data=null] - rollData to be used\n   * @param {boolean} [options.critical=false] - Whether to roll critical damage\n   * @param {string[]} [options.extraParts] - Additional strings added to the roll formula\n   * @param {object} [options.conditionalParts=[]] - Conditional data sets\n   * @param {boolean} [options.primaryAttack] - Whether this is the primary attack\n   * @returns {Promise<DamageRoll[]>} Created damage rolls, one roll per damage part\n   */\n  async rollDamage({\n    data = null,\n    critical = false,\n    extraParts = [],\n    conditionalParts = {},\n    primaryAttack = true,\n  } = {}) {\n    const rollData = data ?? this.getRollData();\n\n    if (!this.hasDamage) {\n      throw new Error(\"You may not make a Damage Roll with this Action.\");\n    }\n\n    // Determine critical multiplier\n    rollData.critMult = 1;\n    if (critical) rollData.critMult = this.data.ability.critMult;\n    // Determine ability multiplier\n    if (rollData.ablMult == null) rollData.ablMult = rollData.action?.ability.damageMult;\n\n    // Define Roll parts\n    let parts =\n      this.data.damage.parts?.map((damage) => {\n        return { base: damage.formula, extra: [], damageType: damage.type, type: \"normal\" };\n      }) ?? [];\n    // Add conditionals damage\n    conditionalParts[\"damage.normal\"]?.forEach((p) => {\n      const [base, damageType, isExtra] = p;\n      isExtra ? parts[0].extra.push(base) : parts.push({ base, extra: [], damageType, type: \"normal\" });\n    });\n    // Add critical damage parts\n    if (critical === true) {\n      const critParts = this.data.damage?.critParts;\n      if (critParts) {\n        parts = parts.concat(\n          critParts.map((damage) => {\n            return { base: damage.formula, extra: [], damageType: damage.type, type: \"crit\" };\n          })\n        );\n      }\n      // Add conditional critical damage parts\n      conditionalParts[\"damage.crit\"]?.forEach((p) => {\n        const [base, damageType, isExtra] = p;\n        isExtra ? parts[0].extra.push(base) : parts.push({ base, extra: [], damageType, type: \"crit\" });\n      });\n    }\n    // Add non-critical damage parts\n    if (critical === false) {\n      const nonCritParts = this.data.damage?.nonCritParts;\n      if (nonCritParts) {\n        parts = parts.concat(\n          nonCritParts.map((damage) => {\n            return { base: damage.formula, extra: [], damageType: damage.type, type: \"nonCrit\" };\n          })\n        );\n      }\n      // Add conditional non-critical damage parts\n      conditionalParts[\"damage.nonCrit\"]?.forEach((p) => {\n        const [base, damageType, isExtra] = p;\n        isExtra ? parts[0].extra.push(base) : parts.push({ base, extra: [], damageType, type: \"nonCrit\" });\n      });\n    }\n\n    if (!this.isHealing) {\n      // Gather changes\n      const isSpell = [\"msak\", \"rsak\", \"spellsave\"].includes(this.data.actionType);\n      const isWeapon = [\"mwak\", \"rwak\"].includes(this.data.actionType);\n      const changes = this.item.getContextChanges(isSpell ? \"sdamage\" : isWeapon ? \"wdamage\" : \"damage\");\n\n      // Add enhancement bonus to changes\n      if (this.enhancementBonus) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: this.enhancementBonus.toString(),\n            operator: \"add\",\n            subTarget: \"damage\",\n            modifier: \"enh\",\n            value: this.enhancementBonus,\n            flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n          })\n        );\n      }\n\n      // Get damage bonus\n      getHighestChanges(\n        changes.filter((c) => {\n          c.applyChange(this.actor);\n          return ![\"set\", \"=\"].includes(c.operator);\n        }),\n        { ignoreTarget: true }\n      ).forEach((c) => {\n        let value = c.value;\n        // Put in parenthesis if there's a chance it is more complex\n        if (/[\\s+-?:]/.test(value)) value = `(${value})`;\n        parts[0].extra.push(`${value}[${c.flavor}]`);\n      });\n\n      // Add broken penalty\n      if (this.item.system.broken) {\n        const label = game.i18n.localize(\"FFD20.Broken\");\n        parts[0].extra.push(`-2[${label}]`);\n      }\n    }\n\n    // Determine ability score modifier\n    const abl = this.data.ability.damage;\n    if (typeof abl === \"string\" && abl !== \"\") {\n      // Determine ability score bonus\n      rollData.ablDamage = Math.floor(rollData.abilities[abl].mod * rollData.ablMult);\n      if (rollData.abilities[abl].mod < 0) rollData.ablDamage = rollData.abilities[abl].mod;\n\n      // Determine ability score label\n      const ablLabel = ffd20.config.abilities[abl];\n\n      // Add ability score\n      parts[0].extra.push(`@ablDamage[${ablLabel}]`);\n    }\n\n    // Create roll\n    const rolls = [];\n    for (let a = 0; a < parts.length; a++) {\n      const part = parts[a];\n      let rollParts = [];\n      if (a === 0) rollParts = [...part.extra, ...extraParts];\n      const formula = [part.base, ...rollParts].join(\" + \");\n      // Skip empty formulas instead of erroring on them\n      if (formula.length == 0) continue;\n      try {\n        const roll = await new DamageRoll(formula, rollData, {\n          damageType: part.damageType,\n          type: part.type,\n        }).evaluate({\n          async: true,\n        });\n        // Add to result\n        rolls.push(roll);\n      } catch (err) {\n        console.error(\"Error with damage formula:\", formula, this);\n        throw err;\n      }\n    }\n\n    return rolls;\n  }\n\n  /**\n   * Generates a list of targets this modifier can have.\n   *\n   * @param {ItemPF} item - The item for which the modifier is to be created.\n   * @returns {Object<string, string>} A list of targets\n   */\n  getConditionalTargets() {\n    const result = {};\n    if (this.hasAttack) result[\"attack\"] = game.i18n.localize(ffd20.config.conditionalTargets.attack._label);\n    if (this.hasDamage) result[\"damage\"] = game.i18n.localize(ffd20.config.conditionalTargets.damage._label);\n    result[\"size\"] = game.i18n.localize(ffd20.config.conditionalTargets.size._label);\n    if (this.item.type === \"spell\" || this.hasSave)\n      result[\"effect\"] = game.i18n.localize(ffd20.config.conditionalTargets.effect._label);\n    // Only add Misc target if subTargets are available\n    if (Object.keys(this.getConditionalSubTargets(\"misc\")).length > 0) {\n      result[\"misc\"] = game.i18n.localize(ffd20.config.conditionalTargets.misc._label);\n    }\n    return result;\n  }\n\n  /**\n   * Generates lists of conditional subtargets this attack can have.\n   *\n   * @param {string} target - The target key, as defined in FFD20.conditionTargets.\n   * @returns {Object<string, string>} A list of conditionals\n   */\n  getConditionalSubTargets(target) {\n    const result = {};\n    // Add static targets\n    if (hasProperty(ffd20.config.conditionalTargets, target)) {\n      for (const [k, v] of Object.entries(ffd20.config.conditionalTargets[target])) {\n        if (!k.startsWith(\"_\") && !k.startsWith(\"~\")) result[k] = v;\n      }\n    }\n    // Add subtargets depending on attacks\n    if ([\"attack\", \"damage\"].includes(target)) {\n      // Add specific attacks\n      if (this.hasAttack) {\n        result[\"attack_0\"] = `${game.i18n.localize(\"FFD20.Attack\")} 1`;\n      } else {\n        delete result[\"rapidShotDamage\"];\n      }\n      if (this.hasMultiAttack) {\n        for (const [k, v] of Object.entries(this.data.attackParts)) {\n          result[`attack_${Number(k) + 1}`] = v[1];\n        }\n      }\n    }\n    // Add subtargets affecting effects\n    if (target === \"effect\") {\n      if (this.hasSave) result[\"dc\"] = game.i18n.localize(\"FFD20.DC\");\n    }\n    // Add misc subtargets\n    if (target === \"misc\") {\n      // Add charges subTarget with specific label\n      if (this.isCharged && this.type !== \"spell\") result[\"charges\"] = game.i18n.localize(\"FFD20.ChargeCost\");\n    }\n    return result;\n  }\n\n  /* Generates lists of conditional modifier bonus types applicable to a formula.\n   * @param {string} target - The target key as defined in FFD20.conditionTargets.\n   * @returns {Object.<string, string>} A list of bonus types.\n   * */\n  getConditionalModifierTypes(target) {\n    const result = {};\n    if (target === \"attack\" || target === \"damage\") {\n      // Add bonusModifiers from FFD20.bonusModifiers\n      for (const [k, v] of Object.entries(ffd20.config.bonusModifiers)) {\n        result[k] = v;\n      }\n    }\n    if (target === \"damage\") {\n      for (const damageType of ffd20.registry.damageTypes) {\n        result[damageType.id] = damageType.name;\n      }\n    }\n    return result;\n  }\n\n  /* Generates a list of critical applications for a given formula target.\n   * @param {string} target - The target key as defined in FFD20.conditionalTargets.\n   * @returns {Object.<string, string>} A list of critical applications.\n   * */\n  getConditionalCritical(target) {\n    let result = {};\n    // Attack bonuses can only apply as critical confirm bonus\n    if (target === \"attack\") {\n      result = { ...result, normal: \"FFD20.Normal\", crit: \"FFD20.CriticalConfirmBonus\" };\n    }\n    // Damage bonuses can be multiplied or not\n    if (target === \"damage\") {\n      result = { ...result, normal: \"FFD20.Normal\" };\n      if (this.hasAttack) {\n        result = { ...result, crit: \"FFD20.CritDamageBonusFormula\", nonCrit: \"FFD20.NonCritDamageBonusFormula\" };\n      }\n    }\n    return result;\n  }\n\n  /**\n   * @param {object} options - See ItemPF#useAttack.\n   * @returns {Promise<void>}\n   */\n  async use(options = {}) {\n    options.actionID = this.id;\n\n    return this.item.use(options);\n  }\n}\n","import { RollPF } from \"../dice/roll.mjs\";\n\nexport class ChatAttack {\n  constructor(action, { label = \"\", rollData = {}, targets = null } = {}) {\n    this.rollData = rollData;\n    this.setAction(action);\n    this.label = label;\n\n    /** @type {D20RollPF | null} */\n    this.attack = null;\n    /** @type {D20RollPF | null} */\n    this.critConfirm = null;\n    this.hasAttack = false;\n    this.hasCritConfirm = false;\n\n    this.damage = {\n      flavor: \"\",\n      total: 0,\n      /** @type {DamageRoll[]} */\n      rolls: [],\n    };\n    this.critDamage = {\n      flavor: \"\",\n      total: 0,\n      /** @type {DamageRoll[]} */\n      rolls: [],\n    };\n    this.hasDamage = false;\n    this.hasRange = action.item.hasRange;\n    this.nonlethal = false;\n    this.damageRows = [];\n\n    this.notesOnly = true;\n\n    this.cards = {};\n    this.hasCards = false;\n    this.attackNotes = [];\n    this.effectNotes = [];\n    this.attackNotesHTML = \"\";\n    this.effectNotesHTML = \"\";\n    this.targets = targets;\n    this.ammo = null;\n  }\n\n  setAmmo(ammoId) {\n    if (ammoId == null) {\n      this.ammo = null;\n    } else {\n      const ammoItem = this.action.item.actor?.items.get(ammoId);\n      if (ammoItem == null) {\n        this.ammo = null;\n        return;\n      }\n\n      this.ammo = {\n        id: ammoId,\n        img: ammoItem.img,\n        name: ammoItem.name,\n      };\n    }\n  }\n\n  get critRange() {\n    if (this.action.item.system.broken) return 20;\n    return this.rollData.action.ability?.critRange || 20;\n  }\n\n  /**\n   * Sets the attack's item reference.\n   *\n   * @param {ItemAction} action - The action to reference.\n   */\n  setAction(action) {\n    if (action == null) {\n      this.rollData = null;\n      this.action = null;\n      return;\n    }\n\n    this.action = action;\n    this.isHealing = action.isHealing;\n\n    this.setRollData();\n  }\n\n  /**\n   * Applies changes to the roll data.\n   */\n  setRollData() {\n    const data = this.rollData;\n    // Set critical hit multiplier\n    data.critMult = 1;\n    data.critCount = 0;\n    // Add critical confirmation bonus\n    data.critConfirmBonus = RollPF.safeTotal(data.action.critConfirmBonus || \"0\") ?? 0;\n    // Determine ability multiplier\n    if (data.action.ability.damageMult != null) data.ablMult = data.action.ability.damageMult;\n  }\n\n  setAttackNotesHTML() {\n    if (this.attackNotes.length === 0) {\n      this.attackNotesHTML = \"\";\n      return;\n    }\n\n    let result = \"\";\n    for (const n of this.attackNotes) {\n      if (n.length > 0) {\n        result += `<span class=\"tag\">${n}</span>`;\n      }\n    }\n    const inner = TextEditor.enrichHTML(result, { rollData: this.rollData, async: false });\n    this.attackNotesHTML = `<div class=\"flexcol property-group gm-sensitive attack-notes\"><label>${game.i18n.localize(\n      \"FFD20.AttackNotes\"\n    )}</label><div class=\"flexrow tag-list\">${inner}</div></div>`;\n  }\n\n  setEffectNotesHTML() {\n    if (this.effectNotes.length === 0) {\n      this.effectNotesHTML = \"\";\n      return;\n    }\n\n    let result = \"\";\n    for (const n of this.effectNotes) {\n      if (n.length > 0) {\n        result += `<span class=\"tag\">${n}</span>`;\n      }\n    }\n    const inner = TextEditor.enrichHTML(result, { rollData: this.rollData, async: false });\n    this.effectNotesHTML = `<div class=\"flexcol property-group gm-sensitive effect-notes\"><label>${game.i18n.localize(\n      \"FFD20.EffectNotes\"\n    )}</label><div class=\"flexrow tag-list\">${inner}</div></div>`;\n  }\n\n  async addAttack({ noAttack = false, bonus = null, extraParts = [], critical = false, conditionalParts = {} } = {}) {\n    if (!this.action.item) return;\n\n    const actor = this.action.actor;\n\n    this.hasAttack = true;\n    this.notesOnly = false;\n    /** @type {D20RollPF} */\n    let roll;\n    if (critical === true) {\n      if (this.rollData.critConfirmBonus !== 0) {\n        extraParts.push(`@critConfirmBonus[${game.i18n.localize(\"FFD20.CriticalConfirmation\")}]`);\n      }\n\n      const ccKeys = ffd20.documents.actor.changes.getChangeFlat.call(actor, \"critConfirm\");\n      for (const ccKey of ccKeys) {\n        actor?.sourceDetails[ccKey]?.forEach((c) => extraParts.push(`(${c.value})[${c.name}]`));\n      }\n\n      // Add conditionals for critical confirmation\n      if (conditionalParts[\"attack.crit\"]?.length) extraParts.push(...conditionalParts[\"attack.crit\"]);\n    } else {\n      // Add conditional attack bonus\n      if (conditionalParts[\"attack.normal\"]?.length) extraParts.push(...conditionalParts[\"attack.normal\"]);\n    }\n\n    // Add broken penalty\n    const broken = this.rollData.item.broken;\n    if (broken && !critical) {\n      const label = game.i18n.localize(\"FFD20.Broken\");\n      extraParts.push(`-2[${label}]`);\n    }\n\n    // Roll attack\n    if (!noAttack) {\n      roll = await this.action.rollAttack({\n        data: this.rollData,\n        bonus: bonus,\n        extraParts: extraParts,\n      });\n\n      if (critical === true) this.critConfirm = roll;\n      else this.attack = roll;\n\n      // Add crit confirm\n      if (!critical && !this.action.isCombatManeuver && roll.isCrit && this.rollData.action.ability.critMult > 1) {\n        this.hasCritConfirm = true;\n        this.rollData.critMult = Math.max(1, this.rollData.action.ability.critMult);\n        if (broken) this.rollData.critMult = 1;\n\n        await this.addAttack({ bonus: bonus, extraParts: extraParts, critical: true, conditionalParts });\n      }\n    }\n\n    // Add tooltip\n    roll.options.flavor = critical ? game.i18n.localize(\"FFD20.CriticalConfirmation\") : this.label;\n\n    if (this.attackNotes === \"\") this.addAttackNotes();\n  }\n\n  addAttackNotes() {\n    if (!this.action.item) return;\n\n    const type = this.action.data.actionType;\n    const typeMap = {\n      rsak: [\"ranged\", /*\"spell\",*/ \"rangedSpell\"],\n      rwak: [\"ranged\", /*\"weapon\",*/ \"rangedWeapon\"],\n      rcman: [\"ranged\"],\n      mwak: [\"melee\", /*\"weapon\",*/ \"meleeWeapon\"],\n      msak: [\"melee\", /*\"spell\",*/ \"meleeSpell\"],\n      mcman: [\"melee\"],\n    };\n\n    const notes = [];\n    // Add actor notes\n    if (this.action.item?.actor != null) {\n      notes.push(...this.action.item.actor.getContextNotesParsed(\"attacks.attack\"));\n      if ((typeMap[type]?.length || 0) > 0)\n        typeMap[type].forEach((subTarget) =>\n          notes.push(...this.action.item.actor.getContextNotesParsed(`attacks.${subTarget}`))\n        );\n    }\n    // Add item notes\n    if (this.action.item?.system.attackNotes) {\n      notes.push(...this.action.item.system.attackNotes);\n    }\n    // Add action notes\n    if (this.action.data.attackNotes) {\n      notes.push(...this.action.data.attackNotes);\n    }\n    // Add CMB notes\n    if (this.action.isCombatManeuver) {\n      notes.push(...(this.action.item?.actor?.getContextNotesParsed(\"misc.cmb\") ?? []));\n    }\n\n    this.attackNotes = notes;\n    this.setAttackNotesHTML();\n  }\n\n  async addDamage({ flavor = null, extraParts = [], critical = false, conditionalParts = {} } = {}) {\n    if (!this.action.item) return;\n\n    this.hasDamage = true;\n    this.notesOnly = false;\n    let data = this.damage;\n    if (critical === true) data = this.critDamage;\n\n    const rollData = duplicate(this.rollData);\n    // Enforce critical multiplier\n    rollData.critCount = 0;\n\n    // Roll damage\n    const repeatCount = critical ? Math.max(1, rollData.critMult - 1) : 1;\n    for (let repeat = 0; repeat < repeatCount; ++repeat) {\n      if (critical) rollData.critCount++;\n      data.rolls.push(\n        ...(await this.action.rollDamage({\n          data: rollData,\n          extraParts: extraParts,\n          critical: critical,\n          conditionalParts,\n        }))\n      );\n    }\n\n    // Add tooltip\n    let tooltips = \"\";\n    for (const roll of data.rolls) {\n      tooltips += await renderTemplate(\"systems/ffd20/templates/internal/damage-tooltip.hbs\", {\n        part: roll,\n      });\n    }\n\n    // Add normal data\n    if (!flavor) {\n      if (!critical) flavor = this.isHealing ? game.i18n.localize(\"FFD20.Healing\") : game.i18n.localize(\"FFD20.Damage\");\n      else\n        flavor = this.isHealing ? game.i18n.localize(\"FFD20.HealingCritical\") : game.i18n.localize(\"FFD20.DamageCritical\");\n    }\n\n    // Determine total damage\n    let totalDamage = data.rolls.reduce((cur, p) => {\n      return cur + p.total;\n    }, 0);\n    if (critical) {\n      totalDamage = this.damage.rolls.reduce((cur, p) => {\n        return cur + p.total;\n      }, totalDamage);\n    }\n\n    // Handle minimum damage rule\n    if (totalDamage < 1) {\n      totalDamage = 1;\n      flavor = game.i18n.localize(\"FFD20.Nonlethal\");\n      this.nonlethal = true;\n    }\n\n    // Handle nonlethal attacks\n    if (this.rollData.action.nonlethal || this.action.item.system.properties?.nnl) {\n      this.nonlethal = true;\n      flavor = game.i18n.localize(\"FFD20.Nonlethal\");\n    }\n\n    // Finalize data\n    data.flavor = flavor;\n    data.total = totalDamage;\n  }\n\n  addEffectNotes() {\n    if (!this.action.item) return;\n\n    let notes = [];\n    if (this.action.item != null && this.action.item.actor != null) {\n      notes = this.action.item.actor.getContextNotes(\"attacks.effect\").reduce((arr, o) => {\n        for (const n of o.notes) {\n          arr.push(...n.split(/[\\n\\r]+/));\n        }\n        return arr;\n      }, []);\n\n      // Spell specific notes\n      if (this.action.item.type === \"spell\") {\n        this.action.item.actor.getContextNotes(\"spell.effect\").forEach((o) => {\n          for (const n of o.notes) notes.push(...n.split(/[\\n\\r]+/));\n        });\n      }\n    }\n\n    // Add item notes\n    if (this.action.item != null && this.action.item.system.effectNotes) {\n      notes.push(...this.action.item.system.effectNotes);\n    }\n    // Add action notes\n    if (this.action.data.effectNotes) {\n      notes.push(...this.action.data.effectNotes);\n    }\n\n    this.effectNotes = this.effectNotes.concat(notes);\n    this.setEffectNotesHTML();\n  }\n\n  finalize() {\n    this.hasCards = Object.keys(this.cards).length > 0;\n\n    // Determine damage rows for chat cards\n    // this.damageRows = [];\n    for (let a = 0; a < Math.max(this.damage.rolls.length, this.critDamage.rolls.length); a++) {\n      this.damageRows.push({ normal: null, crit: null });\n    }\n    for (let a = 0; a < this.damage.rolls.length; a++) {\n      this.damageRows[a].normal = this.damage.rolls[a];\n    }\n    for (let a = 0; a < this.critDamage.rolls.length; a++) {\n      this.damageRows[a].crit = this.critDamage.rolls[a];\n    }\n\n    return this;\n  }\n}\n","import { createTag, convertDistance } from \"@utils\";\nimport { ChatAttack } from \"./chat-attack.mjs\";\nimport { createCustomChatMessage } from \"@utils/chat.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\nimport { getDistanceSystem } from \"@utils\";\n\n// Documentation/type imports\n/** @typedef {import(\"@item/item-pf.mjs\").SharedActionData} SharedActionData */\n/** @typedef {import(\"@item/item-pf.mjs\").ItemPF} ItemPF */\n/** @typedef {import(\"@actor/actor-pf.mjs\").ActorPF} ActorPF */\n/** @typedef {import(\"@component/action.mjs\").ItemAction} ItemAction */\n\n/**\n * Error states for when an item does not meet the requirements for an attack.\n *\n * @enum {number}\n * @readonly\n */\nexport const ERR_REQUIREMENT = Object.freeze({\n  NO_ACTOR_PERM: 1,\n  DISABLED: 2,\n  INSUFFICIENT_QUANTITY: 3,\n  INSUFFICIENT_CHARGES: 4,\n  MISSING_AMMO: 5,\n  INSUFFICIENT_AMMO: 6,\n});\n\n/**\n *\n */\nexport class ActionUse {\n  /**\n   * The actor this action use is based on.\n   *\n   * @type {ActorPF}\n   */\n  actor;\n  /**\n   * The actor this action use is based on.\n   *\n   * @type {TokenDocument}\n   */\n  token;\n\n  /**\n   * The item this action use is based on.\n   *\n   * @type {ItemPF}\n   */\n  item;\n  /**\n   * The action this action use is based on.\n   *\n   * @type {ItemAction}\n   */\n  action;\n  /**\n   * The shared data object holding all relevant data for this action use.\n   *\n   * @type {SharedActionData}\n   */\n  shared;\n\n  /**\n   * @param {Partial<SharedActionData>} [shared={}] - The shared context for this action use\n   */\n  constructor(shared = {}) {\n    Object.defineProperties(this, {\n      shared: { value: shared },\n      item: { value: shared.item },\n      action: { value: shared.action },\n      actor: { value: shared.item.actor },\n      token: { value: shared.token },\n    });\n  }\n\n  /**\n   * @returns {Promise<number>} - 0 when successful, otherwise one of the ERR_REQUIREMENT constants.\n   */\n  checkRequirements() {\n    const actor = this.item.actor;\n    if (actor && !actor.isOwner) {\n      ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: actor.name }));\n      return ERR_REQUIREMENT.NO_ACTOR_PERM;\n    }\n\n    if (this.item.type === \"feat\" && this.item.system.disabled) {\n      ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorFeatDisabled\"));\n      return ERR_REQUIREMENT.DISABLED;\n    }\n\n    const itemQuantity = this.item.system.quantity;\n    if (itemQuantity !== undefined && itemQuantity <= 0) {\n      ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorNoQuantity\"));\n      return ERR_REQUIREMENT.INSUFFICIENT_QUANTITY;\n    }\n\n    if (this.action.isSelfCharged && this.action.data.uses.self?.value < 1) {\n      ui.notifications.warn(\n        game.i18n.format(\"FFD20.ErrorInsufficientCharges\", {\n          name: `${this.item.name}: ${this.action.name}`,\n        })\n      );\n      return ERR_REQUIREMENT.INSUFFICIENT_CHARGES;\n    }\n\n    return 0;\n  }\n\n  /**\n   * @returns {object} The roll data object for this attack.\n   */\n  getRollData() {\n    const rollData = deepClone(this.shared.action.getRollData());\n    rollData.d20 = this.shared.dice !== \"1d20\" ? this.shared.dice : \"\";\n\n    return rollData;\n  }\n\n  /**\n   * Creates and renders an attack roll dialog, and returns a result.\n   *\n   * @returns {ItemAttack_Dialog_Result|boolean}\n   */\n  createAttackDialog() {\n    const dialog = new ffd20.applications.AttackDialog(this.shared.action, this.shared.rollData, this.shared);\n    return dialog.show();\n  }\n\n  /**\n   * Alters roll (and shared) data based on user input during the attack's dialog.\n   *\n   * @param {JQuery | object} form - The attack dialog's jQuery form data or FormData object\n   */\n  alterRollData(form = {}) {\n    let formData;\n    if (form instanceof jQuery) formData = new FormDataExtended(form[0].querySelector(\"form\")).object;\n    else formData = form;\n    if (formData[\"d20\"]) this.shared.rollData.d20 = formData[\"d20\"];\n    const atkBonus = formData[\"attack-bonus\"];\n    if (atkBonus) {\n      this.shared.attackBonus.push(atkBonus);\n    }\n    const dmgBonus = formData[\"damage-bonus\"];\n    if (dmgBonus) {\n      this.shared.damageBonus.push(dmgBonus);\n    }\n\n    if (formData.rollMode) this.shared.rollMode = formData.rollMode;\n\n    // Point-Blank Shot\n    if (formData[\"point-blank-shot\"]) {\n      this.shared.attackBonus.push(`1[${game.i18n.localize(\"FFD20.PointBlankShot\")}]`);\n      this.shared.damageBonus.push(`1[${game.i18n.localize(\"FFD20.PointBlankShot\")}]`);\n      this.shared.pointBlankShot = true;\n    }\n\n    // Many-shot\n    if (this.shared.fullAttack && formData[\"manyshot\"]) {\n      this.shared.manyShot = true;\n    }\n\n    // Rapid Shot\n    if (this.shared.fullAttack && formData[\"rapid-shot\"]) {\n      this.shared.attackBonus.push(`-2[${game.i18n.localize(\"FFD20.RapidShot\")}]`);\n    }\n\n    // Primary attack\n    if (formData[\"primary-attack\"] != null)\n      setProperty(this.shared.rollData, \"action.naturalAttack.primaryAttack\", formData[\"primary-attack\"]);\n\n    // Use measure template\n    if (formData[\"measure-template\"] != null) this.shared.useMeasureTemplate = formData[\"measure-template\"];\n\n    // Set held type\n    setProperty(this.shared.rollData, \"item.held\", formData[\"held\"] ?? \"normal\");\n\n    // Damage multiplier\n    const abilityDamageMultOverride = formData[\"damage-ability-multiplier\"];\n    if (abilityDamageMultOverride != null) {\n      this.shared.rollData.action.ability.damageMult = abilityDamageMultOverride;\n    }\n\n    // Power Attack\n    if (formData[\"power-attack\"]) {\n      const basePowerAttackBonus = this.shared.rollData.action?.powerAttack?.damageBonus ?? 2;\n      let powerAttackBonus = (1 + Math.floor(this.shared.rollData.attributes.bab.total / 4)) * basePowerAttackBonus;\n\n      // Get multiplier\n      let powerAttackMultiplier = this.shared.rollData.item?.powerAttack?.multiplier;\n      if (!powerAttackMultiplier) {\n        powerAttackMultiplier = 1;\n        if (this.item.system.subType === \"natural\") {\n          // Primary\n          if (this.shared.rollData.action.naturalAttack?.primaryAttack) {\n            // Primary attack gets +50% damage like with two-handing if ability score multiplier is 1.5x or higher\n            if (this.shared.rollData.action.ability?.damageMult >= 1.5) {\n              powerAttackMultiplier = 1.5;\n            }\n          }\n          // Secondary\n          else {\n            powerAttackMultiplier = 0.5;\n          }\n        } else {\n          const held = this.shared.rollData.item.held;\n          if (held === \"2h\") powerAttackMultiplier = 1.5;\n          else if (held === \"oh\") powerAttackMultiplier = 0.5;\n        }\n      } else {\n        powerAttackMultiplier = parseFloat(powerAttackMultiplier);\n      }\n\n      // Apply multiplier\n      powerAttackBonus = Math.floor(powerAttackBonus * powerAttackMultiplier);\n\n      // Get label\n      const label = [\"rwak\", \"rsak\"].includes(this.action.data.actionType)\n        ? game.i18n.localize(\"FFD20.DeadlyAim\")\n        : game.i18n.localize(\"FFD20.PowerAttack\");\n\n      // Get penalty\n      const powerAttackPenalty = -(1 + Math.floor(getProperty(this.shared.rollData, \"attributes.bab.total\") / 4));\n\n      // Add bonuses\n      this.shared.rollData.powerAttackPenalty = powerAttackPenalty;\n      this.shared.attackBonus.push(`${powerAttackPenalty}[${label}]`);\n      this.shared.powerAttack = true;\n      this.shared.rollData.powerAttackBonus = powerAttackBonus;\n      this.shared.rollData.powerAttackPenalty = powerAttackPenalty;\n    } else {\n      this.shared.rollData.powerAttackBonus = 0;\n      this.shared.rollData.powerAttackPenalty = 0;\n    }\n\n    // Conditionals\n    Object.keys(formData).forEach((f) => {\n      const idx = f.match(/conditional\\.(\\d+)/)?.[1];\n      if (idx && formData[f]) {\n        if (!this.shared.conditionals) this.shared.conditionals = [parseInt(idx)];\n        else this.shared.conditionals.push(parseInt(idx));\n      }\n    });\n\n    // Apply secondary attack penalties\n    if (\n      this.shared.rollData.item.subType === \"natural\" &&\n      this.shared.rollData.action?.naturalAttack.primaryAttack === false\n    ) {\n      const attackBonus = this.shared.rollData.action.naturalAttack?.secondary?.attackBonus || \"-5\";\n      let damageMult = this.shared.rollData.action.naturalAttack?.secondary?.damageMult ?? 0.5;\n      // Allow dialog override to work\n      if (abilityDamageMultOverride) damageMult = abilityDamageMultOverride;\n      this.shared.attackBonus.push(`(${attackBonus})[${game.i18n.localize(\"FFD20.SecondaryAttack\")}]`);\n      this.shared.rollData.action.ability.damageMult = damageMult;\n    }\n\n    // CL check enabled\n    this.shared.casterLevelCheck = formData[\"cl-check\"];\n\n    // Concentration enabled\n    this.shared.concentrationCheck = formData[\"concentration\"];\n\n    // Conditional defaults for fast-forwarding\n    if (!this.shared.conditionals && foundry.utils.isEmpty(formData)) {\n      this.shared.conditionals = this.shared.action.data.conditionals?.reduce((arr, con, i) => {\n        if (con.default) arr.push(i);\n        return arr;\n      }, []);\n    }\n  }\n\n  /**\n   * @typedef {object} ItemAttack_AttackData\n   * @property {string} label - The attack's name\n   * @property {number|string|undefined} [attackBonus] - An attack bonus specific to this attack\n   * @property {number|string|undefined} [damageBonus] - A damage bonus specific to this attack\n   * @property {string|null} [ammo] - The ID of the ammo item used\n   */\n  /**\n   * Generates attacks for an item's action.\n   *\n   * @param {boolean} [forceFullAttack=false] - Generate full attack data, e.g. as base data for an {@link AttackDialog}\n   * @returns {Promise<ItemAttack_AttackData[]> | ItemAttack_AttackData[]} The generated default attacks.\n   */\n  generateAttacks(forceFullAttack = false) {\n    const rollData = this.shared.rollData;\n    const action = rollData.action;\n\n    /**\n     * Counter for unnamed or other numbered attacks, to be incremented with each usage.\n     * Starts at 1 to account for the base attack.\n     */\n    let unnamedAttackIndex = 1;\n\n    const attackName = action.attackName || game.i18n.format(\"FFD20.FormulaAttack\", { 0: unnamedAttackIndex });\n    // Use either natural fullAttack state, or force generation of all attacks via override\n    const fullAttack = forceFullAttack || this.shared.fullAttack;\n\n    const allAttacks = fullAttack\n      ? action.attackParts.reduce(\n          (cur, r) => {\n            cur.push({\n              attackBonus: r[0],\n              // Use defined label, or fall back to continuously numbered default attack name\n              label: r[1] || game.i18n.format(\"FFD20.FormulaAttack\", { 0: (unnamedAttackIndex += 1) }),\n            });\n            return cur;\n          },\n          [{ attackBonus: \"\", label: attackName }]\n        )\n      : [{ attackBonus: \"\", label: attackName }];\n\n    // Formulaic extra attacks\n    if (fullAttack) {\n      const exAtkCountFormula = action.formulaicAttacks?.count?.formula,\n        exAtkCount = RollPF.safeRoll(exAtkCountFormula, rollData)?.total ?? 0,\n        exAtkBonusFormula = action.formulaicAttacks?.bonus?.formula || \"0\";\n      if (exAtkCount > 0) {\n        try {\n          for (let i = 0; i < exAtkCount; i++) {\n            rollData.formulaicAttack = i + 1; // Add and update attack counter\n            const bonus = RollPF.safeRoll(exAtkBonusFormula, rollData).total;\n            delete rollData.formulaicAttack;\n            allAttacks.push({\n              attackBonus: `(${bonus})[${game.i18n.localize(\"FFD20.Iterative\")}]`,\n              // If formulaic attacks have a non-default name, number them with their own counter; otherwise, continue unnamed attack numbering\n              label: action.formulaicAttacks.label\n                ? action.formulaicAttacks.label.replace(\"{0}\", i + 1)\n                : game.i18n.format(\"FFD20.FormulaAttack\", { 0: (unnamedAttackIndex += 1) }),\n            });\n          }\n        } catch (err) {\n          console.error(err);\n        }\n      }\n    }\n\n    // Set ammo usage\n    if (action.usesAmmo) {\n      const ammoId = this.item.getFlag(\"ffd20\", \"defaultAmmo\");\n      const item = this.item.actor.items.get(ammoId);\n      const quantity = item?.system.quantity ?? 0;\n      const abundant = item?.flags.ffd20?.abundant;\n      for (let a = 0; a < allAttacks.length; a++) {\n        const atk = allAttacks[a];\n        if (abundant || quantity >= a + 1) atk.ammo = ammoId;\n        else atk.ammo = null;\n      }\n    }\n\n    return allAttacks;\n  }\n\n  /**\n   * Subtracts ammo for this attack.\n   *\n   * @param {number} [value=1] - How much ammo to subtract.\n   * @returns {Promise}\n   */\n  async subtractAmmo(value = 1) {\n    if (!this.shared.action.data.usesAmmo) return;\n\n    const ammoUsage = {};\n    for (const atk of this.shared.attacks) {\n      if (atk.ammo) {\n        const item = this.item.actor.items.get(atk.ammo);\n        // Don't remove abundant ammunition\n        if (item.flags?.ffd20?.abundant) continue;\n\n        if (!ammoUsage[atk.ammo]) ammoUsage[atk.ammo] = 1;\n        else ammoUsage[atk.ammo]++;\n      }\n    }\n\n    if (!foundry.utils.isEmpty(ammoUsage)) {\n      const updateData = Object.entries(ammoUsage).reduce((cur, o) => {\n        const currentValue = this.item.actor.items.get(o[0]).system.quantity;\n        const obj = {\n          _id: o[0],\n          \"system.quantity\": currentValue - o[1],\n        };\n\n        cur.push(obj);\n        return cur;\n      }, []);\n\n      return this.item.actor.updateEmbeddedDocuments(\"Item\", updateData);\n    }\n  }\n\n  /**\n   */\n  handleConditionals() {\n    if (this.shared.conditionals) {\n      const conditionalData = {};\n      for (const i of this.shared.conditionals) {\n        const conditional = this.shared.action.data.conditionals[i];\n        const tag = createTag(conditional.name);\n        for (const [i, modifier] of conditional.modifiers.entries()) {\n          // Adds a formula's result to rollData to allow referencing it.\n          // Due to being its own roll, this will only correctly work for static formulae.\n          const conditionalRoll = RollPF.safeRoll(modifier.formula, this.shared.rollData);\n          if (conditionalRoll.err) {\n            ui.notifications.warn(\n              game.i18n.format(\"FFD20.WarningConditionalRoll\", { number: i + 1, name: conditional.name })\n            );\n            // Skip modifier to avoid multiple errors from one non-evaluating entry\n            continue;\n          } else conditionalData[[tag, i].join(\".\")] = RollPF.safeRoll(modifier.formula, this.shared.rollData).total;\n\n          // Create a key string for the formula array\n          const partString = `${modifier.target}.${modifier.subTarget}${\n            modifier.critical ? \".\" + modifier.critical : \"\"\n          }`;\n          // Add formula in simple format\n          if ([\"attack\", \"effect\", \"misc\"].includes(modifier.target)) {\n            const hasFlavor = /\\[.*\\]/.test(modifier.formula);\n            const flavoredFormula = hasFlavor ? modifier.formula : `(${modifier.formula})[${conditional.name}]`;\n            this.shared.conditionalPartsCommon[partString] = [\n              ...(this.shared.conditionalPartsCommon[partString] ?? []),\n              flavoredFormula,\n            ];\n          }\n          // Add formula as array for damage\n          else if (modifier.target === \"damage\") {\n            this.shared.conditionalPartsCommon[partString] = [\n              ...(this.shared.conditionalPartsCommon[partString] ?? []),\n              [modifier.formula, modifier.damageType, false],\n            ];\n          }\n          // Add formula to the size property\n          else if (modifier.target === \"size\") {\n            this.shared.rollData.size += conditionalRoll.total;\n          }\n        }\n      }\n      // Expand data into rollData to enable referencing in formulae\n      this.shared.rollData.conditionals = expandObject(conditionalData, 5);\n\n      // Add specific pre-rolled rollData entries\n      for (const target of [\"effect.cl\", \"effect.dc\", \"misc.charges\"]) {\n        if (this.shared.conditionalPartsCommon[target] != null) {\n          const formula = this.shared.conditionalPartsCommon[target].join(\"+\");\n          const roll = RollPF.safeRoll(formula, this.shared.rollData, [target, formula]).total;\n          switch (target) {\n            case \"effect.cl\":\n              this.shared.rollData.cl += roll;\n              break;\n            case \"effect.dc\":\n              this.shared.rollData.dcBonus = roll;\n              break;\n            case \"misc.charges\":\n              this.shared.rollData.chargeCostBonus = roll;\n              break;\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Checks all requirements to make the attack. This is after the attack dialog's data has been parsed.\n   *\n   * @returns {Promise<number> | number} 0 if successful, otherwise one of the ERR_REQUIREMENT constants.\n   */\n  checkAttackRequirements() {\n    // Determine charge cost\n    const baseCost = this.shared.action.getChargeCost({ rollData: this.shared.rollData });\n\n    // Bonus cost, e.g. from a conditional modifier\n    const bonusCost = this.shared.rollData[\"chargeCostBonus\"] ?? 0;\n\n    const cost = baseCost + bonusCost;\n\n    // Save chargeCost as rollData entry for anything else\n    this.shared.rollData.chargeCost = cost;\n\n    if (cost != 0) {\n      let uses = this.item.charges;\n      if (this.item.type === \"spell\") {\n        if (this.item.useSpellPoints()) {\n          uses = this.item.getSpellUses();\n        }\n      }\n\n      // Cancel usage on insufficient charges\n      if (cost > uses) {\n        ui.notifications.warn(game.i18n.format(\"FFD20.ErrorInsufficientCharges\", { name: this.item.name }));\n        return ERR_REQUIREMENT.INSUFFICIENT_CHARGES;\n      }\n    }\n\n    return 0;\n  }\n\n  /**\n   * Generates ChatAttack entries based off the attack type.\n   */\n  async generateChatAttacks() {\n    // Normal attack(s)\n    if (this.shared.action.hasAttack) await this.addAttacks();\n    // Damage only\n    else if (this.shared.action.hasDamage) await this.addDamage();\n    // Effect notes only\n    else await this.addEffectNotes();\n\n    // Add attack cards\n    this.shared.attacks.forEach((attack) => {\n      if (!attack.ammo) return;\n      const atk = attack.chatAttack;\n      if (atk) atk.setAmmo(attack.ammo);\n    });\n\n    // Add save info\n    this.shared.save = this.shared.action.data.save.type;\n    this.shared.saveDC = this.shared.action.getDC(this.shared.rollData);\n  }\n\n  /**\n   * Determines conditional parts used in a specific attack.\n   *\n   * @param {object} atk - The attack used.\n   * @param {number} [index=0] - The index of the attack, in order of enabled attacks.\n   * @returns {object} The conditional parts used.\n   */\n  _getConditionalParts(atk, { index = 0 }) {\n    const result = {};\n\n    const conditionalTemplates = {\n      \"attack.normal\": \"attack.;id;.normal\",\n      \"attack.crit\": \"attack.;id;.crit\",\n      \"damage.normal\": \"damage.;id;.normal\",\n      \"damage.crit\": \"damage.;id;.crit\",\n      \"damage.nonCrit\": \"damage.;id;.nonCrit\",\n    };\n    const addPart = (id) => {\n      for (const [templateKey, templateStr] of Object.entries(conditionalTemplates)) {\n        if (!result[templateKey]) result[templateKey] = [];\n\n        const parsedStr = templateStr.replace(\";id;\", id);\n        result[templateKey].push(...(this.shared.conditionalPartsCommon[parsedStr] ?? []));\n      }\n    };\n\n    addPart(`attack_${index}`);\n    addPart(\"allAttack\");\n    addPart(\"allDamage\");\n\n    if (atk.id === \"rapid-shot\") {\n      addPart(\"rapidShotAttack\");\n      addPart(\"rapidShotDamage\");\n    } else if (atk.id === \"haste-attack\") {\n      addPart(\"hasteAttack\");\n      addPart(\"hasteDamage\");\n    }\n\n    return result;\n  }\n\n  /**\n   * Adds ChatAttack entries to an attack's shared context.\n   */\n  async addAttacks() {\n    for (let a = 0; a < this.shared.attacks.length; a++) {\n      const atk = this.shared.attacks[a];\n\n      // Combine conditional modifiers for attack and damage\n      const conditionalParts = this._getConditionalParts(atk, { index: a });\n\n      this.shared.rollData.attackCount = a;\n\n      // Create attack object\n      const attack = new ChatAttack(this.shared.action, {\n        label: atk.label,\n        rollData: this.shared.rollData,\n        targets: game.user.targets,\n      });\n\n      if (atk.id !== \"manyshot\") {\n        // Add attack roll\n        await attack.addAttack({\n          extraParts: duplicate(this.shared.attackBonus).concat([atk.attackBonus]),\n          conditionalParts,\n        });\n      }\n\n      // Add damage\n      if (this.shared.action.hasDamage) {\n        const extraParts = duplicate(this.shared.damageBonus);\n        const nonCritParts = [];\n        const critParts = [];\n\n        // Add power attack bonus\n        if (this.shared.rollData.powerAttackBonus > 0) {\n          // Get label\n          const label = [\"rwak\", \"rsak\"].includes(this.shared.action.data.actionType)\n            ? game.i18n.localize(\"FFD20.DeadlyAim\")\n            : game.i18n.localize(\"FFD20.PowerAttack\");\n\n          const powerAttackBonus = this.shared.rollData.powerAttackBonus;\n          const powerAttackCritBonus = powerAttackBonus * (this.shared.rollData.item?.powerAttack?.critMultiplier ?? 1);\n          nonCritParts.push(`${powerAttackBonus}[${label}]`);\n          critParts.push(`${powerAttackCritBonus}[${label}]`);\n        }\n\n        // Add damage\n        let flavor = null;\n        if (atk.id === \"manyshot\") flavor = game.i18n.localize(\"FFD20.Manyshot\");\n        await attack.addDamage({\n          flavor,\n          extraParts: [...extraParts, ...nonCritParts],\n          critical: false,\n          conditionalParts,\n        });\n\n        // Add critical hit damage\n        if (attack.hasCritConfirm) {\n          await attack.addDamage({ extraParts: [...extraParts, ...critParts], critical: true, conditionalParts });\n        }\n      }\n\n      // Add attack notes\n      if (a === 0) attack.addAttackNotes();\n\n      // Add effect notes\n      if (atk.id !== \"manyshot\") {\n        attack.addEffectNotes();\n      }\n\n      // Add to list\n      this.shared.chatAttacks.push(attack);\n\n      // Add a reference to the attack that created this chat attack\n      atk.chatAttack = attack;\n    }\n\n    // Cleanup rollData\n    delete this.shared.rollData.attackCount;\n  }\n\n  /**\n   * Adds a ChatAttack entry for damage to an attack's shared context.\n   */\n  async addDamage() {\n    // Set conditional modifiers\n    this.shared.conditionalParts = {\n      \"damage.normal\": this.shared.conditionalPartsCommon[\"damage.allDamage.normal\"] ?? [],\n    };\n\n    const attack = new ChatAttack(this.shared.action, {\n      rollData: this.shared.rollData,\n      primaryAttack: this.shared.primaryAttack,\n    });\n    // Add damage\n    await attack.addDamage({\n      extraParts: duplicate(this.shared.damageBonus),\n      critical: false,\n      conditionalParts: this.shared.conditionalParts,\n    });\n\n    // Add effect notes\n    attack.addEffectNotes();\n\n    // Add to list\n    this.shared.chatAttacks.push(attack);\n  }\n\n  /**\n   * Adds a ChatAttack entry for effect notes to an attack's shared context.\n   */\n  addEffectNotes() {\n    const attack = new ChatAttack(this.shared.action, {\n      rollData: this.shared.rollData,\n      primaryAttack: this.shared.primaryAttack,\n    });\n\n    // Add effect notes\n    attack.addEffectNotes();\n\n    // Add to list\n    this.shared.chatAttacks.push(attack);\n  }\n\n  /**\n   * @typedef {object} Attack_MeasureTemplateResult\n   * @property {boolean} result - Whether an area was selected.\n   * @property {Function} [place] - Function to place the template, if an area was selected.\n   * @property {Function} [delete] - Function to delete the template, if it has been placed.\n   */\n  /**\n   * Prompts the user for an area, based on the attack's measure template.\n   *\n   * @returns {Promise.<Attack_MeasureTemplateResult>} Whether an area was selected.\n   */\n  async promptMeasureTemplate() {\n    // Determine size\n    let dist = this.shared.action.data.measureTemplate.size;\n    if (typeof dist === \"string\") {\n      dist = RollPF.safeRoll(this.shared.action.data.measureTemplate.size, this.shared.rollData).total;\n    }\n    dist = convertDistance(dist)[0];\n\n    // Create data object\n    const templateOptions = {\n      type: this.shared.action.data.measureTemplate.type,\n      distance: dist,\n    };\n    if (this.shared.action.data.measureTemplate.overrideColor) {\n      templateOptions.color = this.shared.action.data.measureTemplate.customColor;\n    }\n    if (this.shared.action.data.measureTemplate.overrideTexture) {\n      templateOptions.texture = this.shared.action.data.measureTemplate.customTexture;\n    }\n\n    // Create template\n    this.shared.template = null;\n    const template = ffd20.canvas.AbilityTemplate.fromData(templateOptions);\n    let result;\n    if (template) {\n      const actorSheet = this.item.actor?.sheet;\n      const sheetRendered = actorSheet?._element != null;\n      if (sheetRendered) actorSheet.minimize();\n      result = await template.drawPreview(this.shared.event);\n      if (!result.result) {\n        if (sheetRendered) actorSheet.maximize();\n        return result;\n      }\n    }\n\n    this.shared.template = await result.place();\n    return result;\n  }\n\n  /**\n   * Handles Dice So Nice integration.\n   */\n  async handleDiceSoNice() {\n    if (game.dice3d != null && game.dice3d.isEnabled()) {\n      // Use try to make sure a chat card is rendered even if DsN fails\n      try {\n        // Define common visibility options for whole attack\n        const chatData = {};\n        ChatMessage.applyRollMode(chatData, this.shared.rollMode);\n\n        const mergeRolls = game.settings.get(\"dice-so-nice\", \"enabledSimultaneousRolls\");\n        const skipRolls = game.settings.get(\"dice-so-nice\", \"immediatelyDisplayChatMessages\");\n\n        /**\n         * Visually roll dice\n         *\n         * @async\n         * @param {PoolTerm[]} pools - An array of PoolTerms to be rolled together\n         * @returns {Promise} A Promise that is resolved when all rolls have been displayed\n         */\n        const showRoll = async (pools) => {\n          const whisper = chatData.whisper?.length ? chatData.whisper : undefined; // DSN does not like empty array for whisper\n          if (mergeRolls) {\n            return Promise.all(\n              pools.map((pool) => game.dice3d.showForRoll(pool, game.user, true, whisper, chatData.blind))\n            );\n          } else {\n            for (const pool of pools) {\n              await game.dice3d.showForRoll(pool, game.user, true, whisper, chatData.blind);\n            }\n          }\n        };\n\n        /** @type {PoolTerm[]} */\n        const pools = [];\n\n        for (const atk of this.shared.chatAttacks) {\n          // Create PoolTerm for attack and damage rolls\n          const attackPool = new PoolTerm();\n          if (atk.attack) attackPool.rolls.push(atk.attack);\n          attackPool.rolls.push(...(atk.damage?.rolls ?? []));\n\n          // Create PoolTerm for crit confirmation and crit damage rolls\n          const critPool = new PoolTerm();\n          if (atk.hasCritConfirm) critPool.rolls.push(atk.critConfirm);\n          critPool.rolls.push(...(atk.critDamage?.rolls ?? []));\n\n          // Add non-empty pools to the array of rolls to be displayed\n          if (attackPool.rolls.length) pools.push(attackPool);\n          if (critPool.rolls.length) pools.push(critPool);\n        }\n\n        if (pools.length) {\n          // Chat card is to be shown immediately\n          if (skipRolls) showRoll(pools);\n          // Wait for rolls to finish before showing the chat card\n          else await showRoll(pools);\n        }\n      } catch (e) {\n        console.error(e);\n      }\n    }\n  }\n\n  /**\n   * Adds an attack's chat card data to the shared object.\n   */\n  getMessageData() {\n    if (this.shared.chatAttacks.length === 0) return;\n\n    // Create chat template data\n    this.shared.templateData = {\n      action: this.shared.action,\n      name: this.item.name,\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER,\n      rollMode: this.shared.rollMode,\n      attacks: this.shared.chatAttacks.map((o) => o.finalize()),\n    };\n\n    const actor = this.item.actor,\n      token = this.token ?? actor.token;\n\n    // Set chat data\n    this.shared.chatData = {\n      speaker: ChatMessage.implementation.getSpeaker({ actor, token, alias: token?.name }),\n      rollMode: this.shared.rollMode,\n    };\n\n    // Set attack sound\n    if (this.shared.action.data.soundEffect) this.shared.chatData.sound = this.shared.action.data.soundEffect;\n    // Set dice sound if neither attack sound nor Dice so Nice are available\n    else if (game.dice3d == null || !game.dice3d.isEnabled()) this.shared.chatData.sound = CONFIG.sounds.dice;\n\n    // Get extra text\n    const props = [];\n    let extraText = \"\";\n    if (this.shared.templateData.attacks.length > 0) extraText = this.shared.templateData.attacks[0].attackNotesHTML;\n\n    const itemChatData = this.item.getChatData(\n      { rollData: this.shared.rollData },\n      { actionId: this.shared.action.id, chatcard: true }\n    );\n\n    // Get properties\n    const properties = [...itemChatData.properties, ...this.addGenericPropertyLabels()];\n    if (properties.length > 0) props.push({ header: game.i18n.localize(\"FFD20.InfoShort\"), value: properties });\n\n    // Get combat properties\n    if (game.combat) {\n      const combatProps = this.addCombatPropertyLabels();\n\n      if (combatProps.length > 0) {\n        props.push({\n          header: game.i18n.localize(\"FFD20.CombatInfo_Header\"),\n          value: combatProps,\n          css: \"combat-properties\",\n        });\n      }\n    }\n\n    // Add CL notes\n    if (this.item.type === \"spell\" && actor) {\n      const clNotes = actor.getContextNotesParsed(`spell.cl.${this.item.system.spellbook}`);\n\n      if (clNotes.length) {\n        props.push({\n          header: game.i18n.localize(\"FFD20.CLNotes\"),\n          value: clNotes,\n        });\n      }\n    }\n\n    // Parse template data\n    const identified = Boolean(this.shared.rollData.item?.identified ?? true);\n    const name = identified ? `${this.item.name} (${this.shared.action.name})` : this.item.getName(true);\n    this.shared.templateData = mergeObject(\n      this.shared.templateData,\n      {\n        tokenUuid: token ? token.document?.uuid ?? token.uuid : null,\n        actionId: this.shared.action?.id,\n        extraText: extraText,\n        identified: identified,\n        name: name,\n        description: identified ? itemChatData.identifiedDescription : itemChatData.unidentifiedDescription,\n        actionDescription: itemChatData.actionDescription,\n        hasExtraText: extraText.length > 0,\n        properties: props,\n        hasProperties: props.length > 0,\n        item: this.item.toObject(),\n        actor,\n        token,\n        hasSave: this.shared.action.hasSave,\n        rollData: this.shared.rollData,\n        save: {\n          dc: this.shared.saveDC,\n          type: this.shared.save,\n          label: game.i18n.format(\"FFD20.SavingThrowButtonLabel\", {\n            type: ffd20.config.savingThrows[this.shared.save],\n            dc: this.shared.saveDC.toString(),\n          }),\n          gmSensitiveLabel: game.i18n.format(\"FFD20.SavingThrowButtonLabelGMSensitive\", {\n            save: ffd20.config.savingThrows[this.shared.save],\n          }),\n        },\n      },\n      { inplace: false }\n    );\n\n    // Add range info\n    {\n      const range = this.shared.action.getRange({ type: \"max\", rollData: this.shared.rollData });\n      if (range != null) {\n        this.shared.templateData.range = range;\n        const usystem = getDistanceSystem();\n        this.shared.templateData.rangeLabel = usystem === \"metric\" ? `${range} m` : `${range} ft.`;\n\n        const rangeUnits = this.shared.action.data.range.units;\n        if ([\"melee\", \"touch\", \"reach\", \"close\", \"medium\", \"long\"].includes(rangeUnits)) {\n          this.shared.templateData.rangeLabel = ffd20.config.distanceUnits[rangeUnits];\n        }\n      }\n    }\n\n    // Add spell info\n    if (this.item.type === \"spell\" && actor) {\n      // Spell failure\n      if (actor.spellFailure > 0 && this.item.system.components.somatic) {\n        const spellbook = getProperty(actor.system, `attributes.spells.spellbooks.${this.item.system.spellbook}`);\n        if (spellbook && spellbook.arcaneSpellFailure) {\n          const roll = RollPF.safeRoll(\"1d100\");\n          this.shared.templateData.spellFailure = roll.total;\n          this.shared.templateData.spellFailureRoll = roll;\n          this.shared.templateData.spellFailureSuccess = this.shared.templateData.spellFailure > actor.spellFailure;\n        }\n      }\n      // Caster Level Check\n      this.shared.templateData.casterLevelCheck = this.shared.casterLevelCheck;\n      // Concentration check\n      this.shared.templateData.concentrationCheck = this.shared.concentrationCheck;\n    }\n\n    // Generate metadata\n    const metadata = this.generateChatMetadata();\n\n    // Get target info\n    if (!game.settings.get(\"ffd20\", \"disableAttackCardTargets\")) {\n      const targets = metadata.targets?.length\n        ? metadata.targets.map((o) => canvas.tokens.get(o)).filter((o) => o != null)\n        : [];\n      if (targets.length) {\n        this.shared.templateData.targets = targets.map((o) => {\n          return {\n            img: o.document.texture.src,\n            actorData: o.actor?.toObject(false),\n            tokenData: o.document.toObject(false),\n            uuid: o.document.uuid,\n          };\n        });\n      }\n    }\n\n    this.shared.chatData[\"flags.ffd20.metadata\"] = metadata;\n    this.shared.chatData[\"flags.core.canPopout\"] = true;\n    if (!identified)\n      this.shared.chatData[\"flags.ffd20.identifiedInfo\"] = {\n        identified,\n        name: this.item._source.name || this.item.name,\n        description: itemChatData.identifiedDescription,\n        actionName: this.shared.action.name,\n        actionDescription: itemChatData.actionDescription,\n      };\n  }\n\n  /**\n   * Adds generic property labels to an attack's chat card.\n   *\n   * @returns {string[]} The resulting property labels.\n   */\n  addGenericPropertyLabels() {\n    const properties = [];\n\n    // Add actual cost\n    const cost = this.shared.rollData.chargeCost;\n    if (cost && !this.item.system.atWill) {\n      if (this.item.type === \"spell\" && this.item.useSpellPoints()) {\n        properties.push(`${game.i18n.localize(\"FFD20.SpellPointsCost\")}: ${cost}`);\n      } else {\n        properties.push(`${game.i18n.localize(\"FFD20.ChargeCost\")}: ${cost}`);\n      }\n    }\n\n    // Add info for broken state\n    if (this.item.system.broken) {\n      properties.push(game.i18n.localize(\"FFD20.Broken\"));\n    }\n\n    // Nonlethal\n    if (this.action.data.nonlethal) properties.push(game.i18n.localize(\"FFD20.Nonlethal\"));\n\n    if (this.action.data.touch) properties.push(game.i18n.localize(\"FFD20.TouchAttackShort\"));\n\n    // Add info for Power Attack to melee, Deadly Aim to ranged attacks\n    if (this.shared.powerAttack) {\n      if (this.action.data.actionType === \"rwak\") properties.push(game.i18n.localize(\"FFD20.DeadlyAim\"));\n      if (this.action.data.actionType === \"mwak\") properties.push(game.i18n.localize(\"FFD20.PowerAttack\"));\n    }\n\n    // Add info for Point-Blank shot\n    if (this.shared.pointBlankShot) properties.push(game.i18n.localize(\"FFD20.PointBlankShot\"));\n\n    // Add info for Rapid Shot\n    if (this.shared.attacks.find((o) => o.id === \"rapid-shot\")) properties.push(game.i18n.localize(\"FFD20.RapidShot\"));\n\n    if (this.shared.manyShot) properties.push(game.i18n.localize(\"FFD20.Manyshot\"));\n\n    // Add Armor Check Penalty's application to attack rolls info\n    if (this.item.hasAttack && this.shared.rollData.attributes.acp.attackPenalty > 0)\n      properties.push(game.i18n.localize(\"FFD20.ArmorCheckPenalty\"));\n\n    // Add conditionals info\n    if (this.shared.conditionals?.length) {\n      this.shared.conditionals.forEach((c) => {\n        properties.push(this.shared.action.data.conditionals[c].name);\n      });\n    }\n\n    // Add Wound Thresholds info\n    if (this.shared.rollData.attributes.woundThresholds.level > 0)\n      properties.push(\n        game.i18n.localize(ffd20.config.woundThresholdConditions[this.shared.rollData.attributes.woundThresholds.level])\n      );\n\n    return properties;\n  }\n\n  /**\n   * Adds combat property labels to an attack's chat card.\n   *\n   * @returns {string[]} The resulting property labels.\n   */\n  addCombatPropertyLabels() {\n    const properties = [];\n\n    // Add round info\n    properties.push(game.i18n.format(\"FFD20.CombatInfo_Round\", { round: game.combat.round }));\n\n    return properties;\n  }\n\n  /**\n   * Generates metadata for this attack for the chat card to store.\n   *\n   * @returns {object} The resulting metadata object.\n   */\n  generateChatMetadata() {\n    const metadata = {};\n\n    metadata.item = this.item.id;\n    metadata.action = this.action.id;\n    metadata.template = this.shared.template ? this.shared.template.id : null;\n    metadata.rolls = {\n      attacks: [],\n    };\n\n    // Get template for later variables\n    const template = canvas.scene ? canvas.templates.get(metadata.template) : null;\n\n    // Add targets\n    if (template != null) {\n      metadata.targets = template\n        .getTokensWithin()\n        .filter((t) => t.combatant?.isDefeated !== true)\n        .map((o) => o.id);\n    } else {\n      metadata.targets = Array.from(game.user.targets).map((o) => o.id);\n    }\n\n    // Add attack rolls\n    for (let attackIndex = 0; attackIndex < this.shared.chatAttacks.length; attackIndex++) {\n      const chatAttack = this.shared.chatAttacks[attackIndex];\n      const attackRolls = { attack: null, damage: [], critConfirm: null, critDamage: [] };\n      // Add attack roll\n      if (chatAttack.attack) attackRolls.attack = chatAttack.attack.toJSON();\n      // Add damage rolls\n      if (chatAttack.damage.rolls.length) {\n        for (let damageIndex = 0; damageIndex < chatAttack.damage.rolls.length; damageIndex++) {\n          const damageRoll = chatAttack.damage.rolls[damageIndex];\n          attackRolls.damage[damageIndex] = damageRoll.toJSON();\n        }\n      }\n      // Add critical confirmation roll\n      if (chatAttack.critConfirm) attackRolls.critConfirm = chatAttack.critConfirm.toJSON();\n      // Add critical damage rolls\n      if (chatAttack.critDamage.rolls.length) {\n        for (let damageIndex = 0; damageIndex < chatAttack.critDamage.rolls.length; damageIndex++) {\n          const damageRoll = chatAttack.critDamage.rolls[damageIndex];\n          attackRolls.critDamage[damageIndex] = damageRoll.toJSON();\n        }\n      }\n\n      metadata.rolls.attacks[attackIndex] = attackRolls;\n    }\n\n    // Add miscellaneous metadata\n    if (this.shared.saveDC) metadata.save = { dc: this.shared.saveDC, type: this.shared.save };\n    if (this.item.type === \"spell\") metadata.spell = { cl: this.shared.rollData.cl, sl: this.shared.rollData.sl };\n\n    return metadata;\n  }\n\n  /**\n   * Executes the item's script calls.\n   *\n   * @returns {object} The resulting data from the script calls.\n   */\n  async executeScriptCalls() {\n    // Execute script call\n    this.shared.scriptData = await this.item.executeScriptCalls(\"use\", {\n      attackData: this.shared,\n    });\n  }\n\n  /**\n   * Posts the attack's chat card.\n   */\n  async postMessage() {\n    // Old hook data + callAll\n    const hookData = {\n      ev: this.shared.event,\n      skipDialog: this.shared.skipDialog,\n      chatData: this.shared.chatData,\n      templateData: this.shared.templateData,\n      shared: this.shared,\n    };\n\n    this.shared.chatTemplate ||= \"systems/ffd20/templates/chat/attack-roll.hbs\";\n    this.shared.templateData.damageTypes = ffd20.registry.damageTypes.toObject();\n    if (Hooks.call(\"pf1PreDisplayActionUse\", this) === false) return;\n\n    // Show chat message\n    let result;\n    if (this.shared.chatAttacks.length > 0) {\n      if (this.shared.chatMessage && this.shared.scriptData.hideChat !== true)\n        result = await createCustomChatMessage(\n          this.shared.chatTemplate,\n          this.shared.templateData,\n          this.shared.chatData\n        );\n      else result = this.shared;\n    } else {\n      if (this.shared.chatMessage && this.shared.scriptData.hideChat !== true) result = this.item.roll();\n      else result = { descriptionOnly: true };\n    }\n\n    return result;\n  }\n}\n\n/**\n * @typedef {object} ItemAttack_Dialog_Result\n * @property {boolean} fullAttack - Whether it's a full attack (true) or a single attack (false)\n * @property {JQuery} html - The html containing user input and selections.\n */\n","import { formulaHasDice } from \"../../dice/dice.mjs\";\nimport { createCustomChatMessage } from \"../../utils/chat.mjs\";\nimport { createTag, convertDistance, keepUpdateArray, diffObjectAndArray } from \"../../utils/lib.mjs\";\nimport { ItemChange } from \"../../components/change.mjs\";\nimport { ItemAction } from \"../../components/action.mjs\";\nimport { getHighestChanges } from \"../actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\nimport { ActionUse } from \"@actionUse/action-use.mjs\";\nimport { getSkipActionPrompt } from \"../settings.mjs\";\n\n/**\n * Override and extend the basic :class:`Item` implementation\n */\nexport class ItemPF extends Item {\n  constructor(...args) {\n    super(...args);\n\n    if (this.links === undefined)\n      /**\n       * An object containing links to other items.\n       *\n       * @type {Record<string, ItemPF>}\n       */\n      this.links = {};\n\n    if (this._rollData === undefined)\n      /**\n       * Cached {@link ItemPF.getRollData}\n       *\n       * @type {null|object}\n       * @private\n       */\n      this._rollData = null;\n\n    if (this.actions === undefined && this.actions instanceof Array)\n      /**\n       * A {@link Collection} of {@link ItemAction}s.\n       *\n       * @type {Collection<ItemAction>}\n       */\n      this.actions = new Collection();\n  }\n\n  /**\n   * A static object holding system-specific metadata applicable to all instances of this Document class.\n   *\n   * @internal\n   */\n  static system = Object.freeze({\n    /**\n     * Whether this item is a physical one, possessing properties like quantity or weight.\n     *\n     * @type {boolean}\n     */\n    isPhysical: false,\n  });\n\n  /**\n   * Determine whether an item type is physical.\n   *\n   * @deprecated Use {@link ItemPF.isPhysical} insted.\n   * @param {string} type - The item type to check\n   * @returns {boolean} Whether an item of that type is physical.\n   */\n  static isInventoryItem(type) {\n    foundry.utils.logCompatibilityWarning(`ItemPF.isInventoryItem is deprecated. Use ItemPF.isPhysical instead.`, {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n    return CONFIG.Item.documentClasses[type]?.isPhysical ?? false;\n  }\n\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    // Set typed image\n    // The test against DEFAULT_ICON is to deal with a Foundry bug with unlinked actors.\n    if (data.img === undefined || data.img === Item.DEFAULT_ICON) {\n      const image = ffd20.config.defaultIcons.items[this.type];\n      if (image) this.updateSource({ img: image });\n    }\n\n    // Ensure unique Change IDs\n    const actor = this.actor;\n    if (actor && data?.system?.changes?.length > 0) {\n      const changes = data.system.changes;\n      let updated = false;\n      for (const c of changes) {\n        let i = 0;\n        // Forcibly seek unused ID.\n        while (actor.changes.get(c._id) !== undefined || !c._id) {\n          updated = true;\n          // Revert to default ID generation if too many iterations have passed. Just let it break if even more has passed.\n          if (i > 10_000) break;\n          else if (i++ > 1_000) c._id = foundry.utils.randomID();\n          else c._id = ItemChange.defaultData._id;\n        }\n      }\n      if (updated) this.updateSource({ \"system.changes\": changes });\n    }\n\n    const updates = this.preCreateData(data, context, user);\n\n    if (Object.keys(updates).length) return this.updateSource(updates);\n  }\n\n  /**\n   * Meant to be overridden.\n   *\n   * {@inheritDoc _preCreate}\n   *\n   * @param data\n   * @param options\n   * @param user\n   * @returns {object} Update data to replace with.\n   */\n  preCreateData(data, options, user) {\n    return {};\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    if (!changed.system) return;\n\n    await this._chargePreUpdate(changed, context);\n  }\n\n  /**\n   * Handle charge update sanity checking, constraining them to reasonable values,\n   *   and propagating to parent items if charges are shared.\n   *\n   * @private\n   * @param {object} changed\n   * @param {object} context\n   */\n  async _chargePreUpdate(changed, context) {\n    // Make sure charges doesn't exceed max charges\n    const uses = changed.system.uses;\n    if (uses?.value && this.isCharged) {\n      const maxCharges = this.maxCharges;\n      if (uses.value > maxCharges) uses.value = maxCharges;\n\n      const link = this.links.charges;\n      if (link) {\n        // Update charges for linked item. This will cascade if items are linked more.\n        await link.update({ \"system.uses.value\": uses.value }, context);\n        // Remove updating current item's inherited value\n        delete changed.system.uses.value;\n      }\n    }\n  }\n\n  /**\n   * @returns {string[]} The keys of data variables to memorize between updates, for e.g. determining the difference in update.\n   */\n  get memoryVariables() {\n    return [\"quantity\", \"level\", \"inventoryItems\"];\n  }\n\n  /**\n   * Whether this item is physical.\n   *\n   * @type {boolean}\n   */\n  static get isPhysical() {\n    return this.system.isPhysical;\n  }\n  /** {@inheritDoc ItemPF.isPhysical:getter} */\n  get isPhysical() {\n    return this.constructor.isPhysical;\n  }\n\n  /**\n   * The item's subtype, or `null` if the item has no subtype\n   *\n   * @type {string|null}\n   */\n  get subType() {\n    return this.system.subType ?? null;\n  }\n\n  get firstAction() {\n    return this.actions?.get(this.system.actions?.[0]?._id);\n  }\n\n  /**\n   * Returns `true` if any of this item's actions have an attack, see {@link ItemAction#hasAttack}.\n   *\n   * @type {boolean}\n   */\n  get hasAttack() {\n    return this.actions?.some((o) => o.hasAttack) ?? false;\n  }\n\n  /**\n   * Returns `true` if any of this item's actions have a damage roll, see {@link ItemAction#hasDamage}.\n   *\n   * @type {boolean}\n   */\n  get hasDamage() {\n    return this.actions?.some((o) => o.hasDamage) ?? false;\n  }\n\n  /* -------------------------------------------- */\n  /*  Item Properties                             */\n  /* -------------------------------------------- */\n\n  get isOwned() {\n    return super.isOwned || this.parentItem != null;\n  }\n\n  // Overriden by more specific implementations where necessary\n  get isActive() {\n    return true;\n  }\n\n  get hasAction() {\n    return this.system.actions?.length > 0;\n  }\n\n  get isSingleUse() {\n    return this.system.uses?.per === \"single\";\n  }\n\n  get isCharged() {\n    return this.isSingleUse || [\"day\", \"week\", \"charges\"].includes(this.system.uses?.per);\n  }\n\n  get charges() {\n    // No actor? No charges!\n    if (!this.actor) return 0;\n\n    // Get linked charges\n    const link = this.links?.charges;\n    if (link) return link.charges;\n\n    // Get own charges\n    if (this.isSingleUse) return this.system.quantity;\n    return this.system.uses?.value ?? 0;\n  }\n\n  get autoDeductCharges() {\n    return this.getDefaultChargeCost() > 0;\n  }\n\n  /**\n   * Get default charge cost for all actions.\n   *\n   * @param {object} [options] Additional options\n   * @param {object} [options.rollData] Roll data instance\n   * @returns {number} Number for default cost.\n   */\n  getDefaultChargeCost({ rollData } = {}) {\n    rollData ??= this.getRollData();\n    const formula = this.getDefaultChargeFormula();\n    return RollPF.safeRoll(formula, rollData).total;\n  }\n\n  getDefaultChargeFormula() {\n    return this.system.uses?.autoDeductChargesCost || \"1\";\n  }\n\n  get maxCharges() {\n    // Get linked charges\n    const link = this.links?.charges;\n    if (link) return link.maxCharges;\n\n    // Get own charges\n    if (this.isSingleUse) return this.system.quantity;\n    return this.system.uses?.max ?? 0;\n  }\n\n  /**\n   * Recharges item's uses, if any.\n   *\n   * @param {object} options Options\n   * @param {string} [options.period=\"day\"] Recharge period. Use \"any\" to ignore item's configuration.\n   * @param {boolean} [options.exact=false] Use exact time period. Otherwise \"week\" for example will also recharge items with \"day\" period.\n   * @param {number} [options.value] Recharge to specific value, respecting maximum and minimum bounds.\n   * @param {boolean} [options.maximize=false] Recharge to full regardless of recharge formula.\n   * @param {boolean} [options.commit=true] Commit update directly. If false, returns the update data instead.\n   * @param {object} [options.rollData] Roll data instance to use for formulas.\n   * @param {object} [options.context] Update context\n   * @returns {Promise<this|object|undefined>} Promise for the update, update data object, or undefined (no update needed).\n   */\n  async recharge({ value, period = \"day\", exact = false, maximize = false, commit = true, rollData, context } = {}) {\n    const itemData = this.system;\n    if (!itemData.uses?.per) return;\n\n    // Cancel if charges are managed by different item.\n    if (this.links.charges) return;\n\n    // No update when period does not match usage\n    if (period === \"week\" && !exact) {\n      // Recharge \"day\" with \"week\" with inexact recharging\n      if (![\"day\", \"week\"].includes(itemData.uses.per)) return;\n    }\n    // Otherwise test if \"any\" period is used\n    else if (itemData.uses.per !== period && period !== \"any\") return;\n\n    const updateData = { system: { uses: {} } };\n    const staticValue = value !== undefined;\n\n    // No specific value given\n    if (!staticValue) {\n      const formula = itemData.uses?.rechargeFormula || \"\";\n      // Default to maximizing value\n      if (!formula) maximize = true;\n      else {\n        rollData ??= this.getRollData();\n        const roll = RollPF.safeRoll(formula, rollData, \"recharge\");\n        value = roll.total;\n\n        // Cancel if formula produced invalid value\n        if (!Number.isFinite(value)) return;\n      }\n    }\n\n    // Maximize value regardless what value is\n    if (maximize) value = itemData.uses.max;\n\n    // Clamp charge value to\n    value = Math.clamped(value, 0, itemData.uses.max);\n\n    // Cancel pointless update\n    if (value === itemData.uses.value) return;\n\n    updateData.system.uses.value = value;\n\n    if (commit) return this.update(updateData, context);\n    return updateData;\n  }\n\n  /**\n   * Returns total duration in seconds or null.\n   *\n   * @returns {number|null} Seconds or null.\n   */\n  get totalDurationSeconds() {\n    return this.system.duration?.totalSeconds ?? null;\n  }\n\n  /**\n   * @type {number} Number from 0 to 4. 0 for no aura and 1-4 matching FFD20.auraStrengths.\n   */\n  get auraStrength() {\n    const cl = this.system.cl || 0;\n    if (cl < 1) {\n      return 0;\n    } else if (cl < 6) {\n      return 1;\n    } else if (cl < 12) {\n      return 2;\n    } else if (cl < 21) {\n      return 3;\n    }\n    return 4;\n  }\n\n  /**\n   * @type {ActorPF|null} Parent actor\n   * @deprecated Use {@link actor instead}\n   */\n  get parentActor() {\n    foundry.utils.logCompatibilityWarning(\"ItemPF.parentActor is deprecated in favor of Item.actor\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v11\",\n    });\n\n    return this.actor;\n  }\n\n  get limited() {\n    if (this.parentItem) return this.parentItem.limited;\n    return super.limited;\n  }\n\n  getName(forcePlayerPerspective = false) {\n    if (game.user.isGM && forcePlayerPerspective) {\n      if (this.system.identified === false) return this.system.unidentified?.name || this.name;\n    }\n    return this.name;\n  }\n\n  testUserPermission(user, permission, { exact = false } = {}) {\n    if (this.actor) return this.actor.testUserPermission(user, permission, { exact });\n    if (this.parentItem) return this.parentItem.testUserPermission(user, permission, { exact });\n    return super.testUserPermission(user, permission, { exact });\n  }\n\n  get permission() {\n    if (this.actor) return this.actor.permission;\n    return super.permission;\n  }\n\n  get fullDescription() {\n    return this.system.description.value;\n  }\n\n  /**\n   * Get full description.\n   *\n   * @param {object} options Item type dependant options for rendering the description.\n   * @param {boolean} [options.chatcard=false] Instruct template to render chat card in mind.\n   * @param {object} [options.data={}] Template data for rendering\n   * @returns {string} Full description.\n   */\n  getDescription(options) {\n    return this.system.description.value;\n  }\n\n  /**\n   * @returns {ActiveEffect} An active effect associated with this item.\n   */\n  get effect() {\n    return this.actor.effects.find((effect) => {\n      if (!effect.origin) return false;\n      // BUG: If origin is from another actor (duplicated actor), this can cause false positives/negatives.\n      return /\\.Item\\.(?<itemId>[^.]+)/.exec(effect.origin)?.groups.itemId === this.id;\n    });\n  }\n\n  /**\n   * An array containing all action types from this item's actions.\n   *\n   * @see {@link config.itemActionTypes}\n   * @type {string[]}\n   */\n  get actionTypes() {\n    const actionTypes = this.actions?.map((action) => action.data.actionType).filter(Boolean) ?? [];\n    return [...new Set(actionTypes)];\n  }\n\n  static get defaultContextNote() {\n    return {\n      text: \"\",\n      subTarget: \"\",\n    };\n  }\n\n  /**\n   * Generic charge addition (or subtraction) function that either adds charges\n   * or quantity, based on item data.\n   *\n   * @param {number} value The amount of charges to add.\n   * @returns {Promise<this | void>} Updated document or undefined if no update is possible.\n   */\n  async addCharges(value) {\n    // Add link charges\n    const link = this.links.charges;\n    if (link) return link.addCharges(value);\n\n    // Add own charges\n    if (this.system.uses?.per === \"single\" && this.system.quantity == null) return;\n\n    const prevValue = this.isSingleUse ? this.system.quantity : this.system.uses?.value;\n\n    if (this.isSingleUse) return this.update({ \"system.quantity\": prevValue + value });\n    else return this.update({ \"system.uses.value\": prevValue + value });\n  }\n\n  /**\n   * Linked ammunition item if any.\n   *\n   * @type {Item|undefined}\n   */\n  get defaultAmmo() {\n    const ammoId = this.getFlag(\"ffd20\", \"defaultAmmo\");\n    return this.actor?.items.get(ammoId);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Should the item show unidentified data\n   *\n   * @type {boolean}\n   */\n  get showUnidentifiedData() {\n    return !game.user.isGM && this.system.identified === false;\n  }\n\n  /* -------------------------------------------- */\n  /*\tData Preparation\t\t\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare this item's {@link ItemWeightData}\n   */\n  prepareWeight() {\n    if (!this.isPhysical) return;\n\n    const itemData = this.system;\n\n    // HACK: Migration shim. Allows unmigrated items to have their weight correct.\n    {\n      const weight = itemData.weight;\n      if (weight === undefined || Number.isFinite(weight)) {\n        const sourceData = this._source.system,\n          sourceWeight = sourceData.baseWeight ?? sourceData.weight ?? 0;\n        itemData.weight = { value: sourceWeight };\n      }\n    }\n\n    const weight = itemData.weight;\n\n    // Make sure there is a weight value\n    weight.value ??= 0;\n    weight.total ??= 0;\n\n    // Determine actual item weight, including sub-items\n    const weightReduction = (100 - (itemData.weightReduction ?? 0)) / 100;\n    weight.total = (this.items ?? []).reduce((cur, o) => {\n      return cur + o.system.weight.total * weightReduction;\n    }, weight.value * itemData.quantity);\n\n    // Add contained currency (mainly containers)\n    weight.currency ??= 0;\n    weight.total += weight.currency;\n\n    // Convert weight according metric system (lb vs kg)\n    weight.converted = {\n      value: ffd20.utils.convertWeight(weight.value),\n      total: ffd20.utils.convertWeight(weight.total),\n    };\n  }\n\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    this.prepareLinks();\n\n    const itemData = this.system;\n\n    // Update changes\n    if (itemData.changes instanceof Array) {\n      this.changes = this._prepareChanges(itemData.changes);\n    }\n\n    // Update actions\n    if (itemData.actions instanceof Array) {\n      this.actions = this._prepareActions(itemData.actions);\n    }\n\n    // Update script calls\n    if (itemData.scriptCalls instanceof Array) {\n      this.scriptCalls = this._prepareScriptCalls(itemData.scriptCalls);\n    }\n\n    this.prepareWeight();\n\n    if (!this.actor) {\n      this.prepareDerivedItemData();\n    }\n\n    // Physical items\n    if (this.isPhysical && this.showUnidentifiedData) {\n      // Set unidentified description for players\n      this.system.description.value = this.system.description.unidentified;\n    }\n  }\n\n  prepareBaseData() {\n    // Set visible name\n    if (this.showUnidentifiedData) {\n      this.name = this.system.unidentified?.name || this._source.name;\n    } else {\n      this.name = this._source.name;\n    }\n\n    const itemData = this.system;\n\n    // Initialize tag for items that have tagged template\n    const itemTemplate = game.system.template.Item;\n    const taggedTypes = itemTemplate.types.filter((t) => itemTemplate[t].templates?.includes(\"tagged\"));\n    if (itemData.useCustomTag !== true && taggedTypes.includes(this.type)) {\n      itemData.tag = createTag(this.name);\n    }\n  }\n\n  prepareDerivedItemData() {\n    // Update maximum uses\n    this._updateMaxUses();\n  }\n\n  /**\n   * Returns labels for this item\n   *\n   * @param {object} [options={}] - Additional options\n   * @param {string} [options.actionId] - ID of one of this item's actions to get labels for; defaults to first action\n   * @param {object} [options.rollData] - Roll data to use.\n   * @returns {Record<string, string>} This item's labels\n   */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = {};\n    const itemData = this.system;\n\n    // Equipped label\n    const checkYes = '<i class=\"fas fa-check\"></i>';\n    const checkNo = '<i class=\"fas fa-times\"></i>';\n    labels.equipped = \"\";\n    if (itemData.equipped === true) labels.equipped = checkYes;\n    else labels.equipped = checkNo;\n\n    // Carried label\n    labels.carried = \"\";\n    if (itemData.carried === true) labels.carried = checkYes;\n    else labels.carried = checkNo;\n\n    // Identified label\n    labels.identified = \"\";\n    if (itemData.identified === true) labels.identified = checkYes;\n    else labels.identified = checkNo;\n\n    // Slot label\n    if (this.hasSlots) {\n      labels.slot = ffd20.config.equipmentSlots.wondrous[itemData.slot] ?? null;\n    }\n\n    const action = actionId ? this.actions.get(actionId) : this.firstAction;\n    return { ...labels, ...(action?.getLabels({ rollData }) ?? {}) };\n  }\n\n  prepareLinks() {\n    if (!this.links) return;\n\n    for (const [type, item] of Object.entries(this.links)) {\n      if (type === \"charges\") {\n        // Remove cached link if stale\n        const links = item.getLinkedItemsSync(\"charges\");\n        if (!links.some((i) => i.id === this.id)) {\n          delete this.links.charges;\n          continue;\n        }\n\n        // Copy charge data\n        const uses = item.system.uses;\n        if (!uses) break;\n        for (const [k, v] of Object.entries(uses)) {\n          if ([\"autoDeductCharges\", \"autoDeductChargesCost\"].includes(k)) continue;\n          this.system.uses[k] = v;\n        }\n      }\n    }\n  }\n\n  _prepareChanges(changes) {\n    const prior = this.changes;\n    const collection = new Collection();\n    for (const c of changes) {\n      let change = null;\n      if (prior && prior.has(c._id)) {\n        change = prior.get(c._id);\n        change.data = mergeObject(ItemChange.defaultData, c);\n        change.prepareData();\n      } else change = new ffd20.components.ItemChange(c, this);\n      collection.set(c._id || change.data._id, change);\n    }\n    return collection;\n  }\n\n  _prepareActions(actions) {\n    const prior = this.actions;\n    const collection = new Collection();\n    for (const o of actions) {\n      let action = null;\n      if (prior && prior.has(o._id)) {\n        action = prior.get(o._id);\n        action.data = mergeObject(ItemAction.defaultData, o);\n        action.prepareData();\n      } else action = new ffd20.components.ItemAction(o, this);\n      collection.set(o._id || action.data._id, action);\n    }\n    return collection;\n  }\n\n  _prepareScriptCalls(scriptCalls) {\n    const prior = this.scriptCalls;\n    const collection = new Collection();\n    for (const s of scriptCalls) {\n      let scriptCall = null;\n      if (prior && prior.has(s.id)) {\n        scriptCall = prior.get(s.id);\n        scriptCall.data = s;\n      } else scriptCall = new ffd20.components.ItemScriptCall(s, this);\n      collection.set(s._id || scriptCall.data._id, scriptCall);\n    }\n    return collection;\n  }\n\n  _prepareInventory(inventory) {\n    const prior = this.items;\n    const collection = new Collection();\n    for (const o of inventory) {\n      let item = null;\n      if (prior && prior.has(o._id)) {\n        item = prior.get(o._id);\n        item.updateSource(o);\n        item.reset();\n      } else {\n        item = new Item.implementation(o, { parent: this.actor });\n        item.parentItem = this;\n      }\n\n      collection.set(o._id || item.id, item);\n    }\n    return collection;\n  }\n\n  /**\n   * Executes all script calls on this item of a specified category.\n   *\n   * @param {string} category - The category of script calls to call.\n   * @param {Object<string, object>} [extraParams={}] - A dictionary of extra parameters to pass as variables for use in the script.\n   * @returns {Promise.<object>} The shared object between calls which may have been given data.\n   */\n  async executeScriptCalls(category, extraParams = {}) {\n    const scripts = this.scriptCalls?.filter((o) => o.category === category) ?? [];\n    const shared = {};\n    if (extraParams.attackData) {\n      shared.attackData = extraParams.attackData;\n      delete extraParams.attackData;\n    }\n\n    for (const s of scripts) {\n      await s.execute(shared, extraParams);\n    }\n\n    return shared;\n  }\n\n  async update(data, context = {}) {\n    // Avoid regular update flow for explicitly non-recursive update calls\n    if (context.recursive === false) {\n      return super.update(data, context);\n    }\n\n    data = expandObject(data);\n\n    // Make sure stuff remains an array\n    const keepPaths = [\n      \"system.attackNotes\",\n      \"system.effectNotes\",\n      \"system.contextNotes\",\n      \"system.scriptCalls\",\n      \"system.actions\",\n      \"system.inventoryItems\",\n      \"system.changes\",\n    ];\n\n    for (const path of keepPaths) {\n      keepUpdateArray(this, data, path);\n    }\n\n    this.memorizeVariables();\n\n    const diff = diffObject(this.toObject(), data);\n\n    if (Object.keys(diff).length) {\n      const parentItem = this.parentItem;\n      if (parentItem == null) {\n        return super.update(diff, context);\n      } else {\n        // Determine item index to update in parent\n        const parentInventory = parentItem.system.inventoryItems || [];\n        const idx = parentInventory.findIndex((item) => item._id === this.id);\n\n        if (idx >= 0) {\n          // Replace keys to suit parent item\n          for (const [k, v] of Object.entries(diff)) {\n            delete diff[k];\n            diff[`system.inventoryItems.${idx}.${k}`] = v;\n          }\n\n          // Update parent item\n          return parentItem.update(diff);\n        }\n      }\n    }\n  }\n\n  memorizeVariables() {\n    if (this._memoryVariables != null) return;\n\n    const memKeys = this.memoryVariables;\n    this._memoryVariables = {};\n    for (const k of memKeys) {\n      if (hasProperty(this.system, k)) {\n        this._memoryVariables[k] = deepClone(getProperty(this.system, k));\n      }\n    }\n\n    // Memorize variables recursively on container items\n    for (const item of this.items ?? []) {\n      item.memorizeVariables();\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    if (userId === game.user.id) {\n      // Call 'toggle' script calls\n      {\n        let state = null;\n        if (this.type === \"buff\") state = changed.system?.active;\n        else if (this.type === \"feat\" && changed.system?.disabled !== undefined)\n          state = changed.system.disabled === true ? false : true;\n        if (state != null) {\n          this.executeScriptCalls(\"toggle\", { state });\n        }\n      }\n\n      // Call 'equip' script calls\n      {\n        const equipped = changed.system?.equipped;\n        if (equipped != null) {\n          this.executeScriptCalls(\"equip\", { equipped });\n        }\n      }\n\n      // Call 'changeQuantity' script calls\n      const oldQuantity = this._memoryVariables?.quantity;\n      if (oldQuantity !== undefined) {\n        const quantity = {\n          previous: oldQuantity,\n          new: this.system.quantity,\n        };\n        if (quantity.new != null && quantity.new !== quantity.previous) {\n          this.executeScriptCalls(\"changeQuantity\", { quantity });\n        }\n      }\n\n      // Call 'changeLevel' script calls\n      const oldLevel = this._memoryVariables?.level;\n      if (oldLevel !== undefined && changed.system?.level !== undefined) {\n        const level = {\n          previous: parseInt(oldLevel),\n          new: parseInt(this.system.level),\n        };\n        for (const [k, v] of Object.entries(level)) {\n          if (Number.isNaN(v)) level[k] = null;\n        }\n        if (level.new !== undefined && level.new !== level.previous) {\n          this.executeScriptCalls(\"changeLevel\", { level });\n        }\n      }\n    }\n\n    // Call _onUpdate for changed items\n    for (let a = 0; a < (changed.system?.inventoryItems ?? []).length; a++) {\n      const itemUpdateData = changed.system?.inventoryItems[a];\n      const memoryItemData = this._memoryVariables?.inventoryItems?.[a];\n      if (!memoryItemData) continue;\n\n      const diffData = diffObjectAndArray(memoryItemData, itemUpdateData, { keepLength: true });\n      if (!foundry.utils.isEmpty(diffData)) {\n        /** @type {Item} */\n        const item = this.items.get(memoryItemData._id);\n        item._onUpdate(diffData, context, userId);\n      }\n    }\n\n    // Forget memory variables\n    this._memoryVariables = null;\n  }\n\n  _updateMaxUses() {\n    // No charges? No charges!\n    if (![\"day\", \"week\", \"charges\"].includes(this.system.uses?.per)) return;\n\n    const rollData = this.getRollData();\n\n    if (this.system.uses) {\n      const maxFormula = this.system.uses.maxFormula;\n      if (!maxFormula) {\n        this.system.uses.max = 0;\n      } else if (!formulaHasDice(maxFormula)) {\n        const roll = RollPF.safeRoll(maxFormula, rollData);\n        this.system.uses.max = roll.total;\n      } else {\n        const msg = game.i18n.format(\"FFD20.WarningNoDiceAllowedInFormula\", {\n          formula: maxFormula,\n          context: game.i18n.localize(\"FFD20.ChargePlural\"),\n        });\n        ui.notifications.warn(msg, { console: false });\n        console.warn(msg, this);\n      }\n    }\n  }\n\n  // Determines the starting data for an ActiveEffect based off this item\n  getRawEffectData() {\n    return {\n      label: this.name,\n      icon: this.img,\n      origin: this.uuid,\n      flags: { ffd20: { origin: { item: this.id } } },\n      disabled: !this.isActive,\n      duration: {},\n    };\n  }\n\n  // Fetches all this item's script calls of a specified category\n  getScriptCalls(category) {\n    return this.scriptCalls?.filter((s) => s.category === category) ?? [];\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Display the chat card for an Item as a message in chat\n   *\n   * @param {object} [altChatData={}] - Optional data that will be merged into the chat data object.\n   * @param {object} [options=[]] Additional options.\n   * @param {TokenDocument} [options.token] Relevant token if any.\n   * @returns {Promise<ChatMessage | void>} Chat message instance if one was created.\n   */\n  async displayCard(altChatData = {}, { token } = {}) {\n    const actor = this.actor;\n    if (actor && !actor.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: actor.name }));\n    }\n\n    // Basic template rendering data\n    token ??= actor?.token;\n    const rollData = this.getRollData();\n    const itemChatData = this.getChatData({ rollData });\n    const identified = Boolean(rollData.item?.identified ?? true);\n\n    const templateData = {\n      actor: this.actor,\n      token,\n      tokenId: token?.uuid,\n      item: this.toObject(),\n      labels: this.getLabels({ rollData }),\n      hasAttack: this.hasAttack,\n      hasMultiAttack: this.hasMultiAttack,\n      hasAction: this.hasAction,\n      isVersatile: this.isVersatile,\n      isSpell: this.type === \"spell\",\n      name: this.getName(true),\n      description: identified ? itemChatData.identifiedDescription : itemChatData.unidentifiedDescription,\n      rollData: rollData,\n      hasExtraProperties: false,\n      extraProperties: [],\n    };\n\n    const pfFlags = {};\n\n    // If the item is unidentified, store data for GM info box containing identified info\n    if (identified === false) {\n      pfFlags.identifiedInfo = {\n        identified,\n        name: this._source.name,\n        description: itemChatData.identifiedDescription,\n      };\n    }\n\n    // Add combat info\n    if (game.combat) {\n      const combatProps = [];\n      // Add round info\n      combatProps.push(game.i18n.format(\"FFD20.CombatInfo_Round\", { round: game.combat.round }));\n\n      if (combatProps.length > 0) {\n        templateData.extraProperties.push({\n          header: game.i18n.localize(\"FFD20.CombatInfo_Header\"),\n          value: combatProps,\n          css: \"combat-properties\",\n        });\n        templateData.hasExtraProperties = true;\n      }\n    }\n\n    // Render the chat card template\n    const templateType = [\"consumable\"].includes(this.type) ? this.type : \"item\";\n    const template = `systems/ffd20/templates/chat/${templateType}-card.hbs`;\n\n    // Determine metadata\n    pfFlags.metadata = {};\n    pfFlags.metadata.item = this.id;\n\n    // Basic chat message data\n    const chatData = mergeObject(\n      {\n        user: game.user.id,\n        type: CONST.CHAT_MESSAGE_TYPES.OTHER,\n        speaker: ChatMessage.implementation.getSpeaker({ actor, token, alias: token?.name }),\n        flags: {\n          core: {\n            canPopout: true,\n          },\n          ffd20: pfFlags,\n        },\n      },\n      altChatData\n    );\n\n    if (Hooks.call(\"pf1DisplayCard\", this, { template, templateData, chatData }) === false) return;\n\n    // Create the chat message\n    return createCustomChatMessage(template, templateData, chatData);\n  }\n\n  /* -------------------------------------------- */\n  /*  Chat Cards\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * Generates {@link ChatData} for this item, either in a default configuration or for a specific action.\n   *\n   * @param {EnrichmentOptions} [enrichOptions] - Options affecting how descriptions are enriched.\n   *                                              `rollData` defaults to {@link ItemAction#getRollData}/{@link ItemPF#getRollData}.\n   *                                              `secrets` defaults to {@link Item#isOwner}.\n   * @param {object} [options] - Additional options affecting the chat data generation\n   * @param {boolean} [options.chatcard=false] Is this actually for chat card.\n   * @param {string} [options.actionId] - The ID of an action on this item to generate chat data for,\n   *                                      defaults to {@link ItemPF.firstAction}\n   * @returns {ChatData} The chat data for this item (+action)\n   */\n  getChatData(enrichOptions = {}, options = {}) {\n    /** @type {ChatData} */\n    const data = {};\n    const { actionId = null } = options;\n    const action = actionId ? this.actions.get(actionId) : this.firstAction;\n\n    enrichOptions.rollData ??= action ? action.getRollData() : this.getRollData();\n\n    const labels = this.getLabels({ actionId, rollData: enrichOptions.rollData });\n\n    enrichOptions.secrets ??= this.isOwner;\n    enrichOptions.async = false; // @TODO: Work on making this async, somehow\n\n    const itemData = enrichOptions.rollData?.item ?? this.system;\n    const actionData = enrichOptions.rollData?.action ?? action?.data ?? {};\n\n    // Rich text descriptions\n    const description = this.getDescription({ chatcard: options.chatcard });\n    data.identifiedDescription = TextEditor.enrichHTML(description, enrichOptions);\n    if (itemData.shortDescription) {\n      data.identifiedDescription = `${data.identifiedDescription}${TextEditor.enrichHTML(\n        itemData.shortDescription,\n        enrichOptions\n      )}`;\n    }\n    data.unidentifiedDescription = TextEditor.enrichHTML(itemData.description.unidentified, enrichOptions);\n    data.description = this.showUnidentifiedData ? data.unidentifiedDescription : data.identifiedDescription;\n    data.actionDescription = TextEditor.enrichHTML(actionData.description, enrichOptions);\n\n    // General equipment properties\n    const props = [];\n    if (Object.prototype.hasOwnProperty.call(itemData, \"equipped\") && [\"weapon\", \"equipment\"].includes(this.type)) {\n      props.push(itemData.equipped ? game.i18n.localize(\"FFD20.Equipped\") : game.i18n.localize(\"FFD20.NotEquipped\"));\n    }\n\n    if (!this.showUnidentifiedData) {\n      // Gather dynamic labels\n      const dynamicLabels = {};\n      dynamicLabels.range = labels.range || \"\";\n      dynamicLabels.level = labels.sl || \"\";\n      // Range\n      if (actionData.range != null) {\n        const range = action.getRange({ type: \"max\", rollData: enrichOptions.rollData }),\n          units = actionData.range.units === \"mi\" ? \"mi\" : \"ft\";\n        const distanceValues = convertDistance(range, units);\n        dynamicLabels.range =\n          range > 0 ? game.i18n.format(\"FFD20.RangeNote\", { distance: range, units: distanceValues[1] }) : null;\n      }\n\n      // Add Difficulty Modifier (DC) label\n      props.push(labels.save);\n      const saveDesc = actionData.save?.description;\n      if (saveDesc?.length > 0) props.push(saveDesc);\n\n      // Duration\n      if (actionData.duration != null) {\n        if (![\"inst\", \"perm\"].includes(actionData.duration.units) && typeof actionData.duration.value === \"string\") {\n          const duration = RollPF.safeRoll(actionData.duration.value || \"0\", enrichOptions.rollData).total;\n          dynamicLabels.duration = [duration, ffd20.config.timePeriods[actionData.duration.units]].filterJoin(\" \");\n        }\n      }\n\n      // Ability activation properties\n      if (actionData.activation?.type) {\n        props.push(labels.target, labels.activation, dynamicLabels.range, dynamicLabels.duration);\n      }\n\n      // Enhancement Bonus\n      const enhBonus = actionData.enh?.value ?? itemData.enh ?? 0;\n      if (enhBonus > 0) {\n        props.push(game.i18n.format(\"FFD20.Enhancement\", { bonus: enhBonus }));\n      }\n    }\n\n    // Get per item type chat data\n    this.getTypeChatData(data, labels, props, enrichOptions.rollData);\n\n    // Filter properties and return\n    data.properties = props.filter((p) => !!p);\n    return data;\n  }\n\n  /**\n   * Per item type chat data.\n   *\n   * @param {ChatData} data - A partial of a chat data object that can be modified to add per item type data.\n   * @param {Object<string, string>} labels - The labels for this item.\n   * @param {string[]} props - Additional property strings\n   * @param {object} rollData - A rollData object to be used for checks\n   */\n  getTypeChatData(data, labels, props, rollData) {\n    // Charges as used by most item types, except spells\n    if (this.isCharged) {\n      props.push(`${game.i18n.localize(\"FFD20.ChargePlural\")}: ${this.charges}/${this.maxCharges}`);\n    }\n  }\n\n  /* -------------------------------------------- */\n  /*  Item Rolls - Attack, Damage, Saves, Checks  */\n  /* -------------------------------------------- */\n\n  /**\n   * Use an attack, using {@link SharedActionData}\n   *\n   * @see {@link SharedActionData}\n   * @param {string} [actionID=\"\"] - The ID of the action to use, defaults to the first action\n   * @param {Event | null} [ev=null] - The event that triggered the use, if any\n   * @param {boolean} [skipDialog=getSkipActionPrompt()] - Whether to skip the dialog for this action\n   * @param {boolean} [chatMessage=true] - Whether to send a chat message for this action\n   * @param {string} [dice=\"1d20\"] - The base dice to roll for this action\n   * @param {string} [rollMode] - The roll mode to use for the chat message\n   * @param {TokenDocument} [token] Token this action is for, if any.\n   * @returns {Promise<SharedActionData | void | ChatMessage | *>}\n   */\n  async use({\n    actionID = \"\",\n    ev = null,\n    skipDialog = getSkipActionPrompt(),\n    chatMessage = true,\n    dice = \"1d20\",\n    rollMode,\n    token,\n  } = {}) {\n    rollMode ||= game.settings.get(\"core\", \"rollMode\");\n\n    // Old use method\n    if (!this.hasAction) {\n      // Use\n      const shared = await this.executeScriptCalls(\"use\", {\n        attackData: { event: ev, skipDialog, chatMessage, rollMode },\n      });\n      rollMode = shared.rollMode || rollMode;\n      if (shared.reject) return shared;\n      if (shared.hideChat !== true && chatMessage) await this.displayCard({ rollMode });\n      else {\n        shared.descriptionOnly = true;\n        return shared; // nothing to show for printing description\n      }\n\n      // Deduct charges\n      if (this.isCharged) {\n        const chargeCost = this.getDefaultChargeCost();\n        if (this.charges < chargeCost) {\n          if (this.isSingleUse) {\n            return void ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorNoQuantity\"));\n          }\n          return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorInsufficientCharges\", { name: this.name }));\n        }\n\n        await this.addCharges(-chargeCost);\n      }\n\n      return shared;\n    }\n\n    if (ev && ev.originalEvent) ev = ev.originalEvent;\n\n    /** @type {ItemAction | undefined} */\n    let action;\n    if (this.system.actions.length > 0) {\n      if (actionID) {\n        action = this.actions.get(actionID);\n      } else if (this.system.actions.length > 1 && skipDialog !== true) {\n        new ffd20.applications.ActionChooser(this).render(true, { focus: true });\n        return;\n      } else {\n        action = this.firstAction;\n      }\n    } else {\n      console.error(\"This item does not have an action associated with it.\");\n      return;\n    }\n\n    // Prepare variables\n    /** @type {SharedActionData} */\n    const shared = {\n      event: ev,\n      rollData: {},\n      skipDialog,\n      chatMessage,\n      dice,\n      fullAttack: true,\n      attackBonus: [],\n      damageBonus: [],\n      attacks: [],\n      chatAttacks: [],\n      rollMode,\n      useMeasureTemplate: action.hasTemplate && game.settings.get(\"ffd20\", \"placeMeasureTemplateOnQuickRolls\"),\n      conditionals: null,\n      conditionalPartsCommon: {},\n      casterLevelCheck: false,\n      concentrationCheck: false,\n      scriptData: {},\n    };\n\n    // Prevent reassigning the ActionUse's item, action, and token\n    Object.defineProperties(shared, {\n      action: { value: action, writable: false, enumerable: true },\n      item: { value: this, writable: false, enumerable: true },\n      token: { value: token, writable: false, enumerable: true },\n    });\n\n    const actionUse = new ActionUse(shared);\n\n    // Check requirements for item\n    let reqErr = await actionUse.checkRequirements();\n    if (reqErr > 0) return { err: ffd20.actionUse.ERR_REQUIREMENT, code: reqErr };\n\n    // Get new roll data\n    shared.rollData = await actionUse.getRollData();\n\n    // Show attack dialog, if appropriate\n    if (!skipDialog) {\n      const result = await actionUse.createAttackDialog();\n\n      // Stop if result is a boolean (i.e. when closed is clicked on the dialog)\n      if (typeof result !== \"object\") return;\n\n      // Alter roll data\n      shared.fullAttack = result.fullAttack;\n      shared.attacks = result.attacks;\n      await actionUse.alterRollData(result.html);\n    } else {\n      shared.attacks = await actionUse.generateAttacks();\n      await actionUse.alterRollData();\n    }\n\n    // Filter out attacks without ammo usage\n    if (shared.action.data.usesAmmo) {\n      shared.attacks = shared.attacks.filter((o) => o.ammo != null);\n      if (shared.attacks.length === 0) {\n        ui.notifications.error(game.i18n.localize(\"FFD20.AmmoDepleted\"));\n        return;\n      }\n    }\n\n    // Limit attacks to 1 if not full rounding\n    if (!shared.fullAttack) shared.attacks = shared.attacks.slice(0, 1);\n    // Handle conditionals\n    await actionUse.handleConditionals();\n\n    // Check attack requirements, post-dialog\n    reqErr = await actionUse.checkAttackRequirements();\n    if (reqErr > 0) return { err: ffd20.actionUse.ERR_REQUIREMENT, code: reqErr };\n\n    // Generate chat attacks\n    await actionUse.generateChatAttacks();\n\n    // Prompt measure template\n    let measureResult;\n    if (shared.useMeasureTemplate && canvas.scene) {\n      measureResult = await actionUse.promptMeasureTemplate();\n      if (!measureResult.result) return;\n    }\n\n    // Call itemUse hook and determine whether the item can be used based off that\n    if (Hooks.call(\"pf1PreActionUse\", actionUse) === false) {\n      await measureResult?.delete();\n      return;\n    }\n\n    // Call script calls\n    await actionUse.executeScriptCalls();\n    if (shared.scriptData?.reject) {\n      await measureResult?.delete();\n      return;\n    }\n\n    // Handle Dice So Nice\n    await actionUse.handleDiceSoNice();\n\n    // Subtract uses\n    await actionUse.subtractAmmo();\n    if (shared.rollData.chargeCost < 0 || shared.rollData.chargeCost > 0)\n      await this.addCharges(-shared.rollData.chargeCost);\n    if (shared.action.isSelfCharged)\n      await shared.action.update({ \"uses.self.value\": shared.action.data.uses.self.value - 1 });\n\n    // Retrieve message data\n    actionUse.getMessageData();\n\n    // Post message\n    let result;\n    if (shared.scriptData?.hideChat !== true) {\n      result = await actionUse.postMessage();\n    }\n\n    // Deselect targets\n    if (game.settings.get(\"ffd20\", \"clearTargetsAfterAttack\") && game.user.targets.size) {\n      game.user.updateTokenTargets([]);\n      // Above does not communicate targets to other users, so..\n      game.user.broadcastActivity({ targets: [] });\n    }\n\n    return result;\n  }\n\n  /**\n   * Finds, filters and alters changes relevant to a context, and returns the result (as an array)\n   *\n   * @param {string} [context=\"mattack\"] - The given context. Either \"mattack\", \"rattack\", \"wdamage\", \"sdamage\".\n   * @returns {ItemChange[]} The resulting changes.\n   */\n  getContextChanges(context = \"attack\") {\n    let result = this.actor.changes;\n\n    switch (context) {\n      case \"mattack\":\n      case \"rattack\": {\n        const subTargetList = [\"attack\", context];\n        result = result.filter((c) => {\n          if (!subTargetList.includes(c.subTarget)) return false;\n          return true;\n        });\n        break;\n      }\n      case \"wdamage\":\n      case \"sdamage\": {\n        const subTargetList = [\"damage\", context];\n        result = result.filter((c) => {\n          if (!subTargetList.includes(c.subTarget)) return false;\n          return true;\n        });\n        break;\n      }\n      case \"damage\": {\n        result = result.filter((c) => c.subTarget === \"damage\");\n        break;\n      }\n    }\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @returns {object} An object with data to be used in rolls in relation to this item.\n   */\n  getRollData() {\n    const actor = this.actor;\n    const result = actor?.getRollData() ?? {};\n\n    result.item = deepClone(this.system);\n\n    // Add dictionary flag\n    if (this.system.tag) {\n      result.item.dFlags = getProperty(result, `dFlags.${this.system.tag}`);\n    }\n\n    // Set aura strength\n    setProperty(result, \"item.auraStrength\", this.auraStrength);\n\n    result.dc = this.hasSave ? this.getDC(result) : 0;\n\n    this._rollData = result.item;\n\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  static chatListeners(html) {\n    html.on(\"click\", \".card-buttons button, .inline-action\", this._onChatCardButton.bind(this));\n    html.on(\"click\", \".item-name\", this._onChatCardToggleContent.bind(this));\n  }\n\n  /* -------------------------------------------- */\n\n  static async _onChatCardButton(event) {\n    event.preventDefault();\n\n    // Extract card data\n    const button = event.currentTarget;\n    button.disabled = true;\n    const card = button.closest(\".chat-card\");\n    const messageId = card.closest(\".message\").dataset.messageId;\n    const message = game.messages.get(messageId);\n    const action = button.dataset.action;\n\n    // Validate permission to proceed with the roll\n    const isTargetted = [\"save\", \"applyDamage\"].includes(action);\n    if (!(isTargetted || game.user.isGM || message.isAuthor)) return;\n\n    // Get the Actor from a synthetic Token\n    const actor = await this._getChatCardActor(card);\n    if (!actor) {\n      if (action === \"applyDamage\") {\n        await this._onChatCardAction(action, { button: button });\n        button.disabled = false;\n      }\n      return;\n    }\n\n    // Get the Item\n    const item = actor.items.get(card.dataset.itemId);\n\n    // Perform action\n    if (!(await this._onChatCardAction(action, { button: button, item: item }))) {\n      button.disabled = false;\n    }\n  }\n\n  static async _onChatCardAction(action, { button = null, item = null } = {}) {\n    // Apply damage\n    if (action === \"applyDamage\") {\n      let asNonlethal = [...(button.closest(\".chat-message\")?.querySelectorAll(\".tag\") ?? [])]\n        .map((o) => o.innerText)\n        .includes(game.i18n.localize(\"FFD20.Nonlethal\"));\n      if (button.dataset.tags?.split(\" \").includes(\"nonlethal\")) asNonlethal = true;\n\n      const value = button.dataset.value;\n      if (!isNaN(parseInt(value))) Actor.implementation.applyDamage(parseInt(value), { asNonlethal });\n    }\n    // Recover ammunition\n    else if ([\"recoverAmmo\", \"forceRecoverAmmo\"].includes(action)) {\n      if (!item) return;\n      if (!item.isOwner) return;\n\n      // Check for recovery state\n      const attackIndex = button.closest(\".chat-attack\").dataset.index;\n      const card = game.messages.get(button.closest(\".chat-message\").dataset.messageId);\n      const ammoId = button.closest(\".ammo\")?.dataset.ammoId || button.dataset.ammoId;\n      const recoveryData = card.getFlag(\"ffd20\", \"ammoRecovery\");\n      const ammoRecovery = recoveryData?.[attackIndex]?.[ammoId];\n      if (ammoRecovery?.failed || ammoRecovery?.recovered) return;\n\n      let recovered = false;\n      let failed = false;\n      const promises = [];\n\n      // Find ammo item\n      const ammoItem = item.actor.items.get(ammoId);\n      if (!ammoItem) return;\n      if (ammoItem.getFlag(\"ffd20\", \"abundant\")) return; // Abundant is unrecoverable\n      let chance = 100;\n      if (action === \"recoverAmmo\") {\n        chance = ammoItem.system.recoverChance ?? 50;\n      }\n\n      // (Try to) recover ammo\n      if (chance >= Math.random() * 100) {\n        recovered = true;\n        promises.push(ammoItem.addCharges(1));\n      } else {\n        failed = true;\n      }\n\n      // Update chat card\n      if (recovered || failed) {\n        if (attackIndex) {\n          promises.push(card.setFlag(\"ffd20\", \"ammoRecovery\", { [attackIndex]: { [ammoId]: { failed, recovered } } }));\n        }\n      }\n\n      await Promise.all(promises);\n\n      return true;\n    } else if (action === \"concentration\") {\n      item.actor.rollConcentration(item.system.spellbook);\n    } else if (action === \"caster-level-check\") {\n      item.actor.rollCL(item.system.spellbook);\n    }\n\n    return false;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle toggling the visibility of chat card content when the name is clicked\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  static _onChatCardToggleContent(event) {\n    event.preventDefault();\n    const header = event.currentTarget;\n    const card = header.closest(\".chat-card\");\n    const content = card.querySelector(\".card-content\");\n    content.style.display = content.style.display === \"none\" ? \"block\" : \"none\";\n\n    // Update chat popout size\n    const popout = header.closest(\".chat-popout\");\n    if (popout) {\n      popout.style.height = \"auto\";\n    }\n  }\n\n  /**\n   * Get the Actor which is the author of a chat card\n   *\n   * @param {HTMLElement} card    The chat card being used\n   * @returns {Actor|null}         The Actor Document or null\n   * @private\n   */\n  static async _getChatCardActor(card) {\n    // Case 1 - a synthetic actor from a Token\n    const tokenUuid = card.dataset.tokenId;\n    if (tokenUuid) {\n      return (await fromUuid(tokenUuid))?.actor;\n    }\n\n    // Case 2 - use Actor ID directory\n    const actorId = card.dataset.actorId;\n    return game.actors.get(actorId) || null;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {string} linkType - The type of link.\n   * @param {string} dataType - Either \"compendium\", \"data\" or \"world\".\n   * @param {object} targetItem - The target item to link to.\n   * @param {string} itemLink - The link identifier for the item.\n   * @returns {boolean} Whether a link to the item is possible here.\n   */\n  canCreateItemLink(linkType, dataType, targetItem, itemLink) {\n    const actor = this.actor;\n    const sameActor = actor && targetItem.actor && targetItem.actor.id === actor.id;\n\n    // Don't create link to self\n    if (itemLink === this.id) return false;\n\n    // Don't re-create existing links\n    const links = this.system.links?.[linkType] || [];\n    if (links.some((o) => o.id === itemLink || o.uuid === itemLink)) return false;\n\n    const targetLinks = targetItem.system.links?.[linkType] ?? [];\n    if ([\"children\", \"charges\", \"ammunition\"].includes(linkType) && sameActor) {\n      if (linkType === \"charges\") {\n        // Prevent the closing of charge link loops\n        if (targetLinks.length > 0) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.WarningCannotCreateChargeLink\", { source: this.name, target: targetItem.name })\n          );\n          return false;\n        } else if (targetItem.links.charges != null) {\n          // Prevent the linking of one item to multiple resource pools\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.WarningCannotCreateChargeLink2\", {\n              source: this.name,\n              target: targetItem.name,\n              deeptarget: targetItem.links.charges.name,\n            })\n          );\n          return false;\n        }\n      }\n      return true;\n    }\n\n    if (linkType === \"classAssociations\" && dataType === \"compendium\") return true;\n\n    return false;\n  }\n\n  /**\n   * @param {string} linkType - The type of link.\n   * @param {string} dataType - Either \"compendium\", \"data\" or \"world\".\n   * @param {object} targetItem - The target item to link to.\n   * @param {string} itemLink - The link identifier for the item.\n   * @returns {Array} An array to insert into this item's link data.\n   */\n  generateInitialLinkData(linkType, dataType, targetItem, itemLink) {\n    const result = {\n      name: targetItem.name,\n    };\n\n    if (dataType === \"data\") result.id = itemLink;\n    else result.uuid = itemLink;\n\n    if (linkType === \"classAssociations\") {\n      result.level = 1;\n    }\n\n    return result;\n  }\n\n  /**\n   * Creates a link to another item.\n   *\n   * @param {string} linkType - The type of link.\n   * e.g. \"children\", \"charges\", \"classAssociations\" or \"ammunition\".\n   * @param {string} dataType - Either \"compendium\", \"data\" or \"world\".\n   * @param {object} targetItem - The target item to link to.\n   * @param {string} itemLink - The link identifier for the item.\n   * e.g. UUID for items external to the actor, and item ID for same actor items.\n   * @returns {boolean} Whether a link was created.\n   */\n  async createItemLink(linkType, dataType, targetItem, itemLink) {\n    if (this.canCreateItemLink(linkType, dataType, targetItem, itemLink)) {\n      const link = this.generateInitialLinkData(linkType, dataType, targetItem, itemLink);\n      const itemData = this.toObject();\n      const links = itemData.system.links?.[linkType] ?? [];\n      links.push(link);\n      const updateData = { [`system.links.${linkType}`]: links };\n\n      // Call link creation hook\n      await this.update(updateData);\n      Hooks.callAll(\"pf1CreateItemLink\", this, link, linkType);\n\n      return true;\n    } else if (linkType === \"children\" && dataType !== \"data\") {\n      const itemData = targetItem.toObject();\n      delete itemData._id;\n\n      // Default to spell-like tab until a selector is designed in the Links tab or elsewhere\n      if (itemData.type === \"spell\") itemData.system.spellbook = \"spelllike\";\n\n      const newItem = await this.actor.createEmbeddedDocuments(\"Item\", [itemData]);\n\n      await this.createItemLink(\"children\", \"data\", newItem, newItem._id);\n    }\n\n    return false;\n  }\n\n  async getLinkedItems(type, extraData = false) {\n    const items = this.system.links?.[type];\n    if (!items) return [];\n\n    const result = [];\n    for (const l of items) {\n      const item = await this.getLinkItem(l, extraData);\n      if (item) result.push(item);\n    }\n\n    return result;\n  }\n\n  /**\n   * Retrieve list of linked items for a type, synchronously.\n   * Intended mainly for fetching child or charge links quickly.\n   *\n   * @example\n   * const childItems = item.getLinkedItemsSync(\"children\");\n   * @param {string} type Link type, e.g. \"children\", \"charges\", or \"classAssociations\"\n   * @returns {Item[]|object[]} Linked items or their compendium index data\n   */\n  getLinkedItemsSync(type) {\n    const links = this.system.links?.[type];\n    if (!links) return [];\n\n    const result = [];\n    for (const linkData of links) {\n      const item = this.getLinkedItemSync(linkData);\n      if (item) result.push(item);\n    }\n\n    return result;\n  }\n\n  async getAllLinkedItems() {\n    const result = [];\n\n    for (const items of Object.values(this.system.links ?? {})) {\n      for (const l of items) {\n        const item = await this.getLinkItem(l);\n        if (item) result.push(item);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Removes all link references to an item.\n   *\n   * @param {string} id - The id of the item to remove links to.\n   */\n  async removeItemLink(id) {\n    const updateData = {};\n    for (const [type, linkItems] of Object.entries(this.system.links ?? {})) {\n      const items = deepClone(linkItems);\n      const idx = items.findIndex((item) => item.id === id || item.uuid === id);\n      if (idx >= 0) {\n        items.splice(idx, 1);\n        updateData[`system.links.${type}`] = items;\n      }\n    }\n\n    if (!foundry.utils.isEmpty(updateData)) {\n      return this.update(updateData);\n    }\n  }\n\n  async getLinkItem(linkData, extraData = false) {\n    let item;\n\n    // Compendium entry\n    if (linkData.uuid) {\n      item = await fromUuid(linkData.uuid);\n    }\n    // Same actor's item\n    else {\n      item = this.actor?.items?.get(linkData.id);\n    }\n\n    // Package extra data\n    if (extraData) {\n      item = { item, linkData };\n    }\n\n    return item;\n  }\n\n  /**\n   * Retrieve item referred to by a link in .system.links data\n   *\n   * @example\n   * const items = (item.system.links?.children ?? [])\n   *   .map(link => item.getLinkedItemSync(link));\n   * @param {object} linkData Link data\n   * @returns {Item|object|undefined} Linked item, undefined, or compendium index data\n   */\n  getLinkedItemSync(linkData = {}) {\n    const { id, uuid } = linkData;\n    const actor = this.actor;\n    if (uuid) return fromUuidSync(uuid, actor);\n    else return actor?.items.get(id);\n  }\n\n  /**\n   * Generates lists of change subtargets this item can have.\n   *\n   * @param {string} target - The target key, as defined in FFD20.buffTargets.\n   * @returns {Object<string, string>} A list of changes\n   */\n  getChangeSubTargets(target) {\n    const result = {};\n    // Add specific skills\n    if (target === \"skill\") {\n      if (!this.actor) {\n        for (const [s, skl] of Object.entries(ffd20.config.skills)) {\n          result[`skill.${s}`] = skl;\n        }\n      } else {\n        const actorSkills = mergeObject(duplicate(ffd20.config.skills), this.actor.system.skills);\n        for (const [s, skl] of Object.entries(actorSkills)) {\n          if (!skl.subSkills) {\n            if (skl.custom) result[`skill.${s}`] = skl.name;\n            else result[`skill.${s}`] = ffd20.config.skills[s];\n          } else {\n            for (const [s2, skl2] of Object.entries(skl.subSkills)) {\n              result[`skill.${s}.subSkills.${s2}`] = `${ffd20.config.skills[s]} (${skl2.name})`;\n            }\n          }\n        }\n      }\n    }\n    // Add static subtargets\n    else if (hasProperty(ffd20.config.buffTargets, target)) {\n      for (const [k, v] of Object.entries(ffd20.config.buffTargets[target])) {\n        if (!k.startsWith(\"_\") && !k.startsWith(\"~\")) result[k] = v;\n      }\n    }\n\n    return result;\n  }\n\n  async addChange() {\n    const change = new ItemChange({}, this);\n    return change;\n  }\n\n  getTotalCurrency() {\n    foundry.utils.logCompatibilityWarning(\"ItemPF.getTotalCurrency is deprecated\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n\n    return 0;\n  }\n\n  /**\n   * Returns the displayed value of an item according to multiple options\n   *\n   * @param {object} [options] - Various optional parameters affecting value calculations\n   * @param {boolean} [options.recursive=true] - Whether the value of contained items should be included\n   * @param {number} [options.sellValue=0.5] - The sell value multiplier\n   * @param {boolean} [options.inLowestDenomination=false] - Whether the value should be returned in the lowest denomination\n   * @param {boolean} [options.forceUnidentified=false] - Override whether the value should use the unidentified price\n   * @returns {number} The item's value\n   */\n  getValue({ recursive = true, sellValue = 0.5, inLowestDenomination = false, forceUnidentified = false } = {}) {\n    let result = 0;\n\n    const getActualValue = (identified = true) => {\n      let value = 0;\n      if (identified) value = this.system.price;\n      else value = this.system.unidentified.price;\n\n      // Add charge price\n      if (identified) value += (this.system.uses?.pricePerUse ?? 0) * (this.system.uses?.value ?? 0);\n\n      if (inLowestDenomination) value *= 100;\n      if (this.system.broken) value *= 0.75; // TODO: Make broken value configurable\n      return value;\n    };\n\n    const quantity = this.system.quantity || 0;\n\n    // Add item's price\n    result += getActualValue(forceUnidentified ? false : !this.showUnidentifiedData) * quantity;\n\n    // Modify sell value\n    if (!(this.type === \"loot\" && this.system.subType === \"tradeGoods\")) result *= sellValue;\n\n    return result;\n  }\n\n  convertCurrency(type = \"pgil\") {\n    foundry.utils.logCompatibilityWarning(\"ItemPF.convertCurrency is deprecated\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n\n    return 0;\n  }\n\n  /**\n   * Sets a boolean flag on this item.\n   *\n   * @param {string} flagName - The name/key of the flag to set.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async addItemBooleanFlag(flagName, context = {}) {\n    flagName = String(flagName)\n      .replace(/[^\\w_-]/g, \"-\")\n      .replace(/^-+/, \"_\");\n    const flags = this.system.flags?.boolean ?? {};\n\n    if (Array.isArray(flags)) throw new Error(`${this.name} [${this.id}] requires migration.`);\n\n    if (flags[flagName] === undefined) {\n      await this.update({ [`system.flags.boolean.${flagName}`]: true }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Removes a boolean flag from this item.\n   *\n   * @param {string} flagName - The name/key of the flag to remove.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async removeItemBooleanFlag(flagName, context = {}) {\n    const flags = this.system.flags?.boolean ?? {};\n\n    if (flags[flagName] !== undefined) {\n      await this.update({ [`system.flags.boolean.-=${flagName}`]: null }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * @param {string} flagName - The name/key of the flag on this item.\n   * @returns {boolean} Whether the flag was found on this item.\n   */\n  hasItemBooleanFlag(flagName) {\n    const flags = this.system.flags?.boolean ?? {};\n    return flags[flagName] === true;\n  }\n\n  /**\n   * Get all item boolean flags as array.\n   *\n   * @returns {string[]}\n   */\n  getItemBooleanFlags() {\n    const flags = this.system.flags?.boolean ?? {};\n    return Object.keys(flags);\n  }\n\n  /**\n   * Sets a dictionary flag value on this item.\n   *\n   * @param {string} flagName - The name/key of the flag to set.\n   * @param {number|string} value - The flag's new value.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async setItemDictionaryFlag(flagName, value, context = {}) {\n    flagName = String(flagName)\n      .replace(/[^\\w_-]/g, \"-\")\n      .replace(/^-+/, \"_\");\n    const flags = this.system.flags?.dictionary ?? {};\n\n    if (flags[flagName] !== value) {\n      await this.update({ [`system.flags.dictionary.${flagName}`]: value }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Removes a dictionary flag from this item.\n   *\n   * @param {string} flagName - The name/key of the flag to remove.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async removeItemDictionaryFlag(flagName, context = {}) {\n    const flags = this.system.flags?.dictionary ?? {};\n\n    if (flags[flagName] !== undefined) {\n      await this.update({ [`system.flags.dictionary.-=${flagName}`]: null }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * @param {string} flagName - The name/key of the flag to get.\n   * @returns {object} The value stored in the flag.\n   */\n  getItemDictionaryFlag(flagName) {\n    const flags = this.system.flags?.dictionary || {};\n    return flags[flagName];\n  }\n\n  /**\n   * Get all item dictionary flags as array of objects.\n   *\n   * @returns {object[]}\n   */\n  getItemDictionaryFlags() {\n    const flags = this.system.flags?.dictionary || {};\n    return flags;\n  }\n\n  /**\n   * Get attack array for specific action.\n   *\n   * @param {string} actionId Action identifier.\n   * @returns {number[]} Simple array describing the individual guaranteed attacks.\n   */\n  getAttackArray(actionId) {\n    const action = this.actions.get(actionId),\n      actionData = action?.data,\n      rollData = action?.getRollData(),\n      attacks = [0];\n    if (!actionData) return attacks;\n\n    const appendAttack = (formula) => {\n      const bonus = RollPF.safeRoll(formula, rollData).total;\n      if (Number.isFinite(bonus)) attacks.push(bonus);\n    };\n\n    // Static extra attacks\n    const extraAttacks = actionData.attackParts.map((n) => n[0]?.toString().trim()).filter((n) => n?.length > 0);\n    for (const formula of extraAttacks) appendAttack(formula);\n\n    // Formula-based extra attacks\n    const fmAtk = actionData.formulaicAttacks?.count?.formula?.trim();\n    if (fmAtk?.length > 0) {\n      const fmAtkBonus = actionData.formulaicAttacks?.bonus?.formula?.trim() || \"0\";\n      const count = RollPF.safeRoll(fmAtk, rollData);\n      for (let i = 0; i < count.total; i++) {\n        rollData.formulaicAttack = i + 1;\n        appendAttack(fmAtkBonus);\n      }\n      delete rollData.formulaicAttack;\n    }\n\n    // Conditional modifiers\n    const condBonuses = new Array(attacks.length).fill(0);\n    actionData.conditionals\n      .filter((c) => c.default && c.modifiers.find((sc) => sc.target === \"attack\"))\n      .forEach((c) => {\n        c.modifiers.forEach((cc) => {\n          const bonusRoll = RollPF.safeRoll(cc.formula, rollData);\n          if (bonusRoll.total == 0) return;\n          if (cc.subTarget?.match(/^attack\\.(\\d+)$/)) {\n            const atk = parseInt(RegExp.$1, 10);\n            if (atk in condBonuses) condBonuses[atk] += bonusRoll.total;\n          }\n        });\n      });\n\n    const sources = this.getAttackSources(actionId);\n    const totalBonus = sources.reduce((f, s) => f + s.value, 0);\n\n    return attacks.map((a, i) => a + totalBonus + condBonuses[i]);\n  }\n\n  /**\n   * Get default action's attack array.\n   *\n   * @returns {number[]} Simple array describing the individual guaranteed attacks.\n   */\n  get attackArray() {\n    return this.getAttackArray(this.firstAction.id);\n  }\n\n  /**\n   * Attack sources for a specific action.\n   *\n   * @param {string} actionId Action ID\n   * @returns {object[]|undefined} Array of value and label pairs for attack bonus sources on the main attack, or undefined if the action is missing.\n   */\n  getAttackSources(actionId) {\n    const action = this.actions.get(actionId);\n    if (!action) return;\n\n    const sources = [];\n\n    const actorData = this.actor?.system,\n      itemData = this.system,\n      actionData = action.data;\n\n    if (!actorData || !actionData) return sources;\n    const rollData = action.getRollData();\n\n    // Attack type identification\n    const isMelee =\n      [\"mwak\", \"msak\", \"mcman\"].includes(actionData.actionType) || [\"melee\", \"reach\"].includes(actionData.range.units);\n    const isRanged =\n      [\"rwak\", \"rsak\", \"rcman\"].includes(actionData.actionType) || this.system.weaponSubtype === \"ranged\";\n    const isManeuver = action.isCombatManeuver;\n\n    const describePart = (value, name, modifier, sort = 0) => {\n      sources.push({ value, name, modifier, sort });\n    };\n\n    // BAB is last for some reason, array is reversed to try make it the first.\n    const srcDetails = (s) => s?.reverse().forEach((d) => describePart(d.value, d.name, d.modifier, -10));\n\n    // Unreliable melee/ranged identification\n    const sizeBonus = !isManeuver\n      ? ffd20.config.sizeMods[rollData.traits.size]\n      : ffd20.config.sizeSpecialMods[rollData.traits.size];\n\n    // Add size bonus\n    if (sizeBonus != 0) describePart(sizeBonus, game.i18n.localize(\"FFD20.Size\"), \"size\", -20);\n\n    srcDetails(this.actor.sourceDetails[\"system.attributes.attack.shared\"]);\n    if (isManeuver) srcDetails(this.actor.sourceDetails[\"system.attributes.cmb.bonus\"]);\n    srcDetails(this.actor.sourceDetails[\"system.attributes.attack.general\"]);\n\n    const changeSources = [];\n    if (isRanged) changeSources.push(\"rattack\");\n    if (isMelee) changeSources.push(\"mattack\");\n    const effectiveChanges = getHighestChanges(\n      this.actor.changes.filter((c) => changeSources.includes(c.subTarget)),\n      { ignoreTarget: true }\n    );\n    effectiveChanges.forEach((ic) => describePart(ic.value, ic.flavor, ic.modifier, -800));\n\n    if (actionData.ability.attack) {\n      const ablMod = actorData.abilities?.[actionData.ability.attack]?.mod ?? 0;\n      describePart(ablMod, ffd20.config.abilities[actionData.ability.attack], \"untyped\", -50);\n    }\n\n    // Attack bonus formula\n    const bonusRoll = RollPF.safeRoll(actionData.attackBonus || \"0\", rollData);\n    if (bonusRoll.total != 0)\n      describePart(bonusRoll.total, bonusRoll.flavor ?? game.i18n.localize(\"FFD20.AttackRollBonus\"), \"untyped\", -100);\n\n    // Masterwork or enhancement bonus\n    // Only add them if there's no larger enhancement bonus from some other source\n    const virtualEnh = action.enhancementBonus ?? (itemData.masterwork ? 1 : 0);\n    if (!effectiveChanges.find((i) => i.modifier === \"enh\" && i.value > virtualEnh)) {\n      if (Number.isFinite(action.enhancementBonus) && action.enhancementBonus !== 0) {\n        describePart(action.enhancementBonus, game.i18n.localize(\"FFD20.EnhancementBonus\"), \"enh\", -300);\n      } else if (itemData.masterwork) {\n        describePart(1, game.i18n.localize(\"FFD20.Masterwork\"), \"enh\", -300);\n      }\n    }\n\n    // Add proficiency penalty\n    if (!itemData.proficient) {\n      describePart(-4, game.i18n.localize(\"FFD20.ProficiencyPenalty\"), \"penalty\", -500);\n    }\n\n    // Broken condition\n    if (itemData.broken) {\n      describePart(-2, game.i18n.localize(\"FFD20.Broken\"), \"penalty\", -500);\n    }\n\n    // Add secondary natural attack penalty\n    if (actionData.naturalAttack.primaryAttack !== true && itemData.subType === \"natural\") {\n      const attackBonus = actionData.naturalAttack?.secondary?.attackBonus || \"-5\";\n      const secondaryModifier = RollPF.safeTotal(`${attackBonus}`, rollData);\n      describePart(secondaryModifier, game.i18n.localize(\"FFD20.SecondaryAttack\"), \"untyped\", -400);\n    }\n\n    // Conditional modifiers\n    actionData.conditionals\n      .filter((c) => c.default && c.modifiers.find((sc) => sc.target === \"attack\"))\n      .forEach((c) => {\n        c.modifiers.forEach((cc) => {\n          if (cc.subTarget === \"allAttack\") {\n            const bonusRoll = RollPF.safeRoll(cc.formula, rollData);\n            if (bonusRoll.total == 0) return;\n            describePart(bonusRoll.total, c.name, cc.type, -5000);\n          }\n        });\n      });\n\n    return sources.sort((a, b) => b.sort - a.sort);\n  }\n\n  /**\n   * Return attack sources for default action.\n   *\n   * @returns {object[]|undefined} Array of value and label pairs for attack bonus sources on the main attack.\n   */\n  get attackSources() {\n    return this.getAttackSources(this.firstAction.id);\n  }\n\n  getAllDamageSources(actionId) {\n    return this.actions.get(actionId)?.allDamageSources;\n  }\n\n  /**\n   * Generic damage source retrieval for default action, includes default conditionals and other item specific modifiers.\n   *\n   * @returns {ItemChange[]|undefined} All relevant changes, or undefined if action was not found.\n   */\n  get allDamageSources() {\n    return this.getAllDamageSources(this.firstAction.id);\n  }\n\n  /**\n   * Set item's active state.\n   *\n   * @abstract\n   * @param {boolean} active Active state\n   * @param {object} context Optional update context\n   * @returns {Promise<this>} Update promise if item type supports the operation.\n   * @throws Error if item does not support the operation.\n   */\n  setActive(active, context) {\n    throw new Error(`Item type ${this.type} does not support ItemPF#setActive`);\n  }\n}\n\n/**\n * @typedef {object} ItemWeightData\n * An item's `weight` data. The only property to be stored is `value`, from which all other values are derived.\n * @see {@link ItemPF.prepareWeight} for generation\n * @remarks A weight property is considered \"effective\" if it is the value that is added to its parent's weight.\n *          An item with a weight of 10 lbs in a container with 50% weight reduction would increase\n *          the container's effective `weight.total` by 5 lbs, but increases the container's `weight.contents` weight by 10 lbs.\n * @property {number} value - The weight of a single item instance, in lbs\n * @property {number} total - The effective total weight of the item (including quantity and contents), in lbs\n * @property {number} [currency] - Effective weight of contained currency for containers, in lbs\n * @property {number} [contents] - Weight of contained items and currency, in lbs\n * @property {object} converted - Weight of this item, converted to the current unit system\n * @property {number} converted.value - The weight of a single item instance, in world units\n * @property {number} converted.total - The effective total weight of the item (including quantity and contents), in world units\n * @property {number} [converted.contents] - Weight of contained items and currency, in world units\n */\n\n/**\n * @typedef {object} ChatData\n * Data required to render an item's summary or chat card, including descriptions and properties/tags/labels\n * @property {string} description - The item's enriched description as appropriate for the current user\n * @property {string} identifiedDescription - The item's full enriched description when identified\n * @property {string} unidentifiedDescription - The item's enriched description when unidentified\n * @property {string} [actionDescription] - The enriched description of a specific action\n * @property {string[]} properties - Additional properties/labels for the item and the action\n */\n\n/**\n * @typedef {object} SharedActionData\n * A common data object used to store and share data between stages of an action's usage.\n * @property {Event | null} event - The event that triggered the action. Defaults to `null`.\n * @property {object} rollData - The singular rollData object used for all rolls in the action\n * @property {boolean} skipDialog - Whether the user-facing dialog should get skipped. Defaults to `false`.\n * @property {boolean} chatMessage - Whether a chat message should be created at the end of the action's usage. Defaults to `true`.\n * @property {string} dice - The base dice used for the action's attack rolls. Defaults to `\"1d20\"`.\n * @property {boolean} fullAttack - Whether the action is a full attack. Defaults to `true`.\n * @property {string[]} attackBonus - Bonus values to be added to the attack roll formula\n * @property {string[]} damageBonus - Bonus values to be added to the damage roll formula\n * @property {object[]} attacks - Array of attacks\n * @property {import(\"@actionUse/chat-attack.mjs\").ChatAttack[]} chatAttacks - Array of chat attacks for this action's use\n * @property {string} rollMode - The roll mode to be used for the creation of the chat message. Defaults to the `core.rollMode` setting.\n * @property {boolean} useMeasureTemplate - Whether to use a measure template\n * @property {object[] | null} conditionals\n * @property {object} conditionalPartsCommon\n * @property {boolean} casterLevelCheck\n * @property {boolean} concentrationCheck\n * @property {object} scriptData\n * @property {ItemAction} action - The {@link ItemAction} this use is based on\n * @property {ItemPF} item - The {@link ItemPF} this use is based on\n * @property {object} chatData - Data to be passed to {@link ChatMessage.create}, excluding `content` rendered using {@link templateData} and {@link template}.\n * @property {string} [chatTemplate] - The template to be used for the creation of the chat message.\n * @property {object} templateData - Data used to render the chat card, passed to {@link foundry.utils.renderTemplate}.\n */\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemAttackPF extends ItemPF {\n  getConditionalTargets() {\n    const result = super.getConditionalTargets();\n\n    result[\"size\"] = game.i18n.localize(ffd20.config.conditionalTargets.size._label);\n\n    return result;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\nexport class ItemBuffPF extends ItemPF {\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    // Add activation time when not present\n    if (changed.system?.active && changed.system?.duration?.start === undefined) {\n      setProperty(changed, \"system.duration.start\", game.time.worldTime);\n    }\n\n    await super._preUpdate(changed, context, user);\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    // Delete associated effect\n    const effect = this.effect;\n    if (effect) {\n      await effect.delete({ ffd20: { delete: this.uuid } });\n    }\n\n    // Run script call(s)\n    if (user.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"toggle\", { state: false });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    const itemData = this.system;\n    labels.subType = ffd20.config.buffTypes[itemData.subType];\n\n    if (this.system.duration) {\n      const duration = this.system.duration;\n      const unit = ffd20.config.timePeriodsShort[duration.units];\n      if (unit === \"turn\") {\n        labels.duration = game.i18n.format(\"FFD20.TimeFormat\", { value: 1, unit });\n      } else if (unit && duration.value) {\n        const value = RollPF.safeTotal(duration.value, this.getRollData());\n        labels.duration = game.i18n.format(\"FFD20.TimeFormat\", { value, unit });\n      } else {\n        labels.duration = \"\";\n      }\n    }\n\n    return labels;\n  }\n\n  prepareDerivedItemData() {\n    super.prepareDerivedItemData();\n    this._prepareDuration();\n  }\n\n  /**\n   * Prepare .system.duration\n   *\n   * @param {object} [options] Additional options\n   * @param {object} [options.rollData] Roll data instance. New instance is generated if undefined and needed.\n   * @private\n   */\n  _prepareDuration({ rollData } = {}) {\n    const itemData = this.system;\n\n    const duration = itemData.duration ?? {};\n    const { units, value: formula } = duration;\n    if (!units) return;\n\n    // Add total duration in seconds\n    let seconds = 0;\n    if (units === \"turn\") {\n      seconds = CONFIG.time.roundTime;\n    } else {\n      if (!formula) return;\n      rollData ??= this.getRollData();\n      const duration = RollPF.safeRoll(formula, rollData).total;\n      switch (units) {\n        case \"hour\":\n          seconds = duration * 60 * 60;\n          break;\n        case \"minute\":\n          seconds = duration * 60;\n          break;\n        case \"round\":\n          seconds = duration * CONFIG.time.roundTime;\n          break;\n      }\n    }\n    itemData.duration.totalSeconds = seconds;\n  }\n\n  // Creates a simple ActiveEffect from a buff item. Returns the effect\n  async toEffect({ noCreate = false } = {}) {\n    const actor = this.actor;\n    if (!actor) return;\n\n    const existing = actor.effects.find((e) => e.origin == this.uuid);\n    if (existing || noCreate) return existing;\n\n    // Add a new effect\n    const createData = {\n      label: this.name,\n      icon: this.img,\n      origin: this.uuid,\n      disabled: !this.isActive,\n      flags: {\n        ffd20: {\n          show: !this.system.hideFromToken && !game.settings.get(\"ffd20\", \"hideTokenConditions\"),\n          origin: { item: this.id },\n        },\n      },\n    };\n    const effect = ActiveEffect.create(createData, { parent: actor });\n\n    return effect;\n  }\n\n  // Determines the starting data for an ActiveEffect based off this item\n  getRawEffectData() {\n    const createData = super.getRawEffectData();\n\n    const hideIcon = this.system.hideFromToken || game.settings.get(\"ffd20\", \"hideTokenConditions\");\n    createData[\"flags.ffd20.show\"] = !hideIcon;\n    if (hideIcon) createData.icon = null;\n\n    // Add buff durations\n    const duration = this.system.duration;\n    let formula = duration.value || \"\";\n    if (typeof formula == \"number\") formula += \"\";\n    let seconds = 0;\n    const units = duration.units;\n    if (units === \"turn\") {\n      createData.duration.turns = 1;\n      seconds = CONFIG.time.roundTime;\n    } else if (formula) {\n      switch (units) {\n        case \"minute\":\n        case \"hour\": {\n          seconds = this.totalDurationSeconds;\n          break;\n        }\n        case \"round\": {\n          const rounds = RollPF.safeRoll(formula, this.getRollData()).total;\n          if (rounds > 0) {\n            createData.duration.rounds = rounds;\n            seconds = rounds * CONFIG.time.roundTime;\n          }\n          break;\n        }\n      }\n    }\n\n    if (seconds > 0) createData.duration.seconds = seconds;\n\n    return createData;\n  }\n\n  getRollData() {\n    const result = super.getRollData();\n\n    result.item.level = this.system.level;\n\n    return result;\n  }\n\n  get isActive() {\n    return this.system.active;\n  }\n\n  get effect() {\n    return this.actor?.effects.find((o) => o.origin?.indexOf(`Item.${this.id}`) > 0);\n  }\n\n  /**\n   * @param {boolean} active\n   * @param {object} context Optional update context\n   * @returns {Promise} Update promise\n   * @override\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.active\": active }, context);\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { createTag } from \"../../utils/lib.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\nexport class ItemClassPF extends ItemPF {\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    if (!changed.system) return;\n\n    // Set level marker\n    if (changed.system.level !== undefined) {\n      this._prevLevel = this.system.level;\n    }\n\n    // Ensure class associations remain in level order\n    const classLinks = changed.system.links?.classAssociations;\n    if (classLinks?.length) {\n      classLinks.forEach((link) => (link.level ||= 1));\n      classLinks.sort((a, b) => a.level - b.level);\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onCreate(data, context, userId) {\n    super._onCreate(data, context, userId);\n\n    if (userId !== game.user.id) return;\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Create spellbook if the class has spellcasting defined\n    if (!this.system.casting?.type) return;\n    const bookData = { ...this.system.casting, class: this.system.tag };\n    actor.createSpellbook(bookData);\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    if (userId !== game.user.id) return;\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Disable book associated with this class, if it has spellcasting defined\n    const tag = this.system.tag;\n    if (!tag || !this.system.casting?.type) return;\n    const books = actor.system.attributes.spells.spellbooks ?? {};\n    const usedBook = Object.entries(books).find(([bookId, book]) => !!book.class && book.class === tag);\n    if (usedBook === undefined) return;\n    const [bookId, book] = usedBook;\n    if (book.inUse) {\n      actor.update({ [`system.attributes.spells.spellbooks.${bookId}.inUse`]: false });\n    }\n  }\n\n  async update(updateData, context = {}) {\n    // Ensure update data is always in expanded format instead of arbitrarily mixed or flattened depending on caller.\n    updateData = expandObject(updateData);\n\n    await super.update(updateData, context);\n\n    // Update class\n    const newLevel = updateData.system?.level;\n    if (newLevel !== undefined && this.actor) {\n      const prevLevel = this._prevLevel;\n      if (prevLevel !== undefined) {\n        delete this._prevLevel;\n        await this._onLevelChange(prevLevel, newLevel);\n      }\n    }\n  }\n\n  async delete(context = {}) {\n    await this._onLevelChange(this.system.level, 0);\n    return super.delete(context);\n  }\n\n  /**\n   * Add or remove class associations on level change.\n   *\n   * @param {number} curLevel Current level, before the level change.\n   * @param {number} newLevel New level, after the level change.\n   */\n  async _onLevelChange(curLevel, newLevel) {\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Add items associated to this class\n    if (newLevel > curLevel) {\n      const classAssociations = (this.system.links?.classAssociations ?? []).filter(\n        (link, index) => link.level > curLevel && link.level <= newLevel\n      );\n\n      const sources = new Map();\n\n      const newItems = [];\n      for (const link of classAssociations) {\n        const item = await fromUuid(link.uuid);\n        if (!item) {\n          const msg = `Could not find class association: ${link.uuid}`;\n          console.warn(link.uuid, msg, this);\n          ui.notifications?.warn(msg, { console: false });\n          continue;\n        }\n\n        sources.set(link.uuid, link);\n\n        // Apply Foundry's transformations for importing (automatically calls .toObject())\n        // This adds flags.core.sourceId, removes extraneous permissions, resets sorting, etc.\n        const itemData = game.items.fromCompendium(item);\n\n        newItems.push({ data: itemData, link });\n      }\n\n      if (newItems.length) {\n        const itemsCreationData = newItems.sort((a, b) => a.link.level - b.link.level).map((o) => o.data);\n        // Put new items at end of their types\n        const _typeSorting = {};\n        for (const item of itemsCreationData) {\n          _typeSorting[item.type] ??=\n            actor.items.filter((i) => i.type === item.type).sort((a, b) => b.sort - a.sort)[0]?.sort ?? 0;\n          _typeSorting[item.type] += CONST.SORT_INTEGER_DENSITY;\n          item.sort = _typeSorting[item.type];\n        }\n        const items = await actor.createEmbeddedDocuments(\"Item\", itemsCreationData);\n\n        const classAssociations = {};\n        const updateData = { flags: { ffd20: { links: { classAssociations } } } };\n        for (const item of items) {\n          const link = sources.get(item.getFlag(\"core\", \"sourceId\"));\n\n          // Set class association flags\n          classAssociations[item.id] = link?.level ?? 1;\n        }\n\n        await this.update(updateData, { render: false });\n      }\n    }\n\n    // Remove items associated to this class\n    if (newLevel < curLevel) {\n      const associations = duplicate(this.getFlag(\"ffd20\", \"links.classAssociations\") || {});\n      const itemIds = [];\n      for (const [id, level] of Object.entries(associations)) {\n        const item = actor.items.get(id);\n        if (!item) {\n          delete associations[id];\n          continue;\n        }\n\n        if (level > newLevel) {\n          itemIds.push(item.id);\n          delete associations[id];\n        }\n      }\n      await this.setFlag(\"ffd20\", \"links.classAssociations\", associations);\n      await Item.implementation.deleteDocuments(itemIds, { parent: actor });\n    }\n\n    // Call level change hook\n    Hooks.callAll(\"pf1ClassLevelChange\", this.actor, this, curLevel, newLevel);\n  }\n\n  prepareBaseData() {\n    super.prepareBaseData();\n    const itemData = this.system;\n    // Reset cached HD/MT\n    // Can't prepare here as the actor uses this info before item preparation is done.\n    itemData.hitDice = undefined;\n    itemData.mythicTier = undefined;\n\n    // Soft fill default casting details when missing\n    if (itemData.casting?.type) {\n      itemData.casting.progression ??= \"high\";\n      itemData.casting.ability ??= \"int\";\n      itemData.casting.spells ??= \"arcane\";\n      itemData.casting.domainSlots ??= 1;\n      itemData.casting.cantrips ??= true;\n    }\n  }\n\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    const itemData = this.system;\n\n    const useFractional = game.settings.get(\"ffd20\", \"useFractionalBaseBonuses\");\n\n    // Prepare class base save\n    {\n      const saveFormulas = useFractional\n        ? ffd20.config.classFractionalSavingThrowFormulas\n        : ffd20.config.classSavingThrowFormulas;\n\n      for (const save of Object.keys(ffd20.config.savingThrows)) {\n        const classType = itemData.subType || \"base\";\n        let formula;\n        const saveData = itemData.savingThrows[save];\n        const saveType = saveData.value;\n        if (saveType === \"custom\") {\n          formula = saveData.custom || \"0\";\n        } else {\n          formula = saveFormulas[classType][saveType];\n        }\n        if (formula == null) formula = \"0\";\n        const total = RollPF.safeRoll(formula, { level: itemData.level, hitDice: this.hitDice }).total;\n        saveData.base = total;\n        if (useFractional) saveData.good = saveFormulas[classType].goodSave === true && saveType === \"high\";\n      }\n    }\n\n    // Prepare BAB\n    {\n      const babFormulas = useFractional ? ffd20.config.classFractionalBABFormulas : ffd20.config.classBABFormulas;\n\n      const babType = itemData.bab;\n      let formula;\n      if (babType === \"custom\") {\n        formula = itemData.babFormula || \"0\";\n      } else {\n        formula = babFormulas[babType] || \"0\";\n      }\n      itemData.babBase = RollPF.safeRoll(formula, { level: itemData.level, hitDice: this.hitDice }).total;\n    }\n\n    // Feed info back to actor\n    const actor = this.actor;\n    // Test against actor.data to avoid unlinked token weirdness\n    if (actor?.system) {\n      const actorData = actor.system,\n        classData = this.system;\n\n      let tag = classData.tag;\n      if (!tag) tag = createTag(this.name);\n\n      let healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n      const hasPlayerOwner = this.hasPlayerOwner;\n      healthConfig =\n        classData.subType === \"racial\"\n          ? healthConfig.hitdice.Racial\n          : hasPlayerOwner\n          ? healthConfig.hitdice.PC\n          : healthConfig.hitdice.NPC;\n\n      if (!classData.subType) console.warn(`${this.name} lacks class type`, this);\n      const isBaseClass = (classData.subType || \"base\") === \"base\";\n      if (!this.actor.classes) return;\n      actor.classes[tag] = {\n        _id: this.id,\n        level: classData.level,\n        name: this.name,\n        hd: classData.hd,\n        hitDice: this.hitDice,\n        mythicTier: this.mythicTier,\n        bab: classData.bab,\n        hp: healthConfig.auto,\n        savingThrows: {\n          fort: classData.savingThrows.fort.base,\n          ref: classData.savingThrows.ref.base,\n          will: classData.savingThrows.will.base,\n        },\n        fc: {\n          hp: isBaseClass ? classData.fc.hp.value : 0,\n          skill: isBaseClass ? classData.fc.skill.value : 0,\n          alt: isBaseClass ? classData.fc.alt.value : 0,\n        },\n      };\n    }\n  }\n\n  get hitDice() {\n    const itemData = this.system;\n    if (itemData.hitDice === undefined) {\n      if (itemData.subType === \"mythic\") {\n        itemData.hitDice = 0;\n      } else if (itemData.customHD?.length > 0) {\n        const rollData = { item: { level: this.system.level } };\n        itemData.hitDice = RollPF.safeRoll(itemData.customHD, rollData).total;\n      } else {\n        itemData.hitDice = itemData.level;\n      }\n    }\n\n    return itemData.hitDice;\n  }\n\n  get mythicTier() {\n    const itemData = this.system;\n    if (itemData.mythicTier === undefined) {\n      itemData.mythicTier = this.subType === \"mythic\" ? itemData.level : 0;\n    }\n    return itemData.mythicTier;\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemConsumablePF extends ItemPF {\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemContainerPF extends ItemPF {\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  constructor(...args) {\n    super(...args);\n\n    this.items ??= null;\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /** @inheritdoc */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    // HACK: Migration shim\n    if (typeof this.system.weight !== \"object\") {\n      this.system.weight = {\n        value: this.system.weight,\n      };\n    }\n\n    // Set base weight to weight of coins, which can be calculated without knowing contained items\n    const weightReduction = (100 - (this.system.weightReduction ?? 0)) / 100;\n    this.system.weight.currency = this._calculateCoinWeight() * weightReduction;\n  }\n\n  prepareDerivedData() {\n    // Update contained items\n    this.items = this._prepareInventory(this.system.inventoryItems);\n\n    super.prepareDerivedData();\n  }\n\n  /** @inheritDoc */\n  prepareWeight() {\n    super.prepareWeight();\n\n    /** @type {ItemWeightData} */\n    const weight = this.system.weight;\n    // Quantity can be ignored for containers\n    weight.contents = this.items.reduce((total, item) => total + item.system.weight.total, this._calculateCoinWeight());\n    weight.converted.contents = ffd20.utils.convertWeight(weight.contents);\n  }\n\n  async createContainerContent(data, options = { raw: false }) {\n    const embeddedName = \"Item\";\n    const user = game.user;\n    const itemOptions = { temporary: false, renderSheet: false };\n\n    let inventory = deepClone(this.system.inventoryItems ?? []);\n    // Iterate over data to create\n    data = data instanceof Array ? data : [data];\n    if (!(itemOptions.temporary || itemOptions.noHook)) {\n      for (const d of data) {\n        const allowed = Hooks.call(`preCreate${embeddedName}`, this, d, itemOptions, user.id);\n        if (allowed === false) {\n          console.debug(`${vtt} | ${embeddedName} creation prevented by preCreate hook`);\n          return null;\n        }\n\n        d._id = randomID(16);\n      }\n    }\n\n    // Add to updates\n    const items = data.map((o) => (options.raw ? o : new ItemPF(o).toObject()));\n    inventory.push(...items);\n\n    // Filter items with duplicate _id\n    {\n      const ids = [];\n      inventory = inventory.filter((i) => {\n        if (ids.includes(i._id)) return false;\n        ids.push(i._id);\n        return true;\n      });\n    }\n\n    await this.update({ \"system.inventoryItems\": inventory });\n\n    // Mimic createEmbeddedDocuments()\n    const newItemIds = new Set(items.map((i) => i._id));\n    return this.items.filter((i) => newItemIds.has(i.id));\n  }\n\n  getContainerContent(itemId) {\n    return this.items.get(itemId);\n  }\n\n  async deleteContainerContent(data) {\n    const embeddedName = \"ContainerContent\";\n    const user = game.user;\n    const options = { noHook: false };\n\n    // Iterate over data to create\n    data = data instanceof Array ? data : [data];\n    const ids = new Set(data);\n\n    // Iterate over elements of the collection\n    const inventory = deepClone(this.system.inventoryItems ?? []).filter((item) => {\n      if (!ids.has(item._id)) return true;\n\n      // Call pre-update hooks to ensure the update is allowed to proceed\n      if (!options.noHook) {\n        const allowed = Hooks.call(`preDelete${embeddedName}`, this, item, options, user.id);\n        if (allowed === false) {\n          console.debug(`${vtt} | ${embeddedName} update prevented by preUpdate hook`);\n          return true;\n        }\n      }\n\n      // Remove document from collection\n      return false;\n    }, []);\n\n    // Trigger the Socket workflow\n    await this.update({ \"system.inventoryItems\": inventory });\n  }\n\n  async updateContainerContents(data) {\n    const embeddedName = \"ContainerContent\";\n    const user = game.user;\n    const options = { diff: true };\n\n    // Structure the update data\n    const pending = new Map();\n    data = data instanceof Array ? data : [data];\n    for (const d of data) {\n      if (!d._id) throw new Error(\"You must provide an id for every Embedded Document in an update operation\");\n      pending.set(d._id, d);\n    }\n\n    // Difference each update against existing data\n    const updates = this.items.reduce((arr, d) => {\n      if (!pending.has(d.id)) return arr;\n      let update = pending.get(d.id);\n\n      // Diff the update against current data\n      if (options.diff) {\n        update = diffObject(d, expandObject(update));\n        if (foundry.utils.isEmpty(update)) return arr;\n        update[\"_id\"] = d.id;\n      }\n\n      // Call pre-update hooks to ensure the update is allowed to proceed\n      if (!options.noHook) {\n        const allowed = Hooks.call(`preUpdate${embeddedName}`, this, d, update, options, user.id);\n        if (allowed === false) {\n          console.debug(`${vtt} | ${embeddedName} update prevented by preUpdate hook`);\n          return arr;\n        }\n      }\n\n      // Stage the update\n      arr.push(update);\n      return arr;\n    }, []);\n    if (!updates.length) return [];\n    let inventory = duplicate(this.system.inventoryItems).map((o) => {\n      for (const u of updates) {\n        if (u._id === o._id) return mergeObject(o, u);\n      }\n      return o;\n    });\n\n    // Filter items with duplicate _id\n    {\n      const ids = [];\n      inventory = inventory.filter((i) => {\n        if (ids.includes(i._id)) return false;\n        ids.push(i._id);\n        return true;\n      });\n    }\n\n    await this.update({ \"system.inventoryItems\": inventory });\n  }\n\n  /**\n   * Returns the currency this item contains\n   *\n   * @param {object} [options] - Additional options affecting how the value is returned\n   * @param {boolean} [options.inLowestDenomination=false] - Whether to return the value in copper, or in gold (default)\n   * @returns {number} The total amount of currency this item contains, in gold pieces\n   */\n  getTotalCurrency({ inLowestDenomination = false } = {}) {\n    const currency = this.system.currency;\n    const total = currency.pgil * 1000 + currency.gil * 100 + currency.sgil * 10 + currency.cgil;\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  /**\n   * Converts currencies of the given category to the given currency type\n   *\n   * @param {string} type - Either 'pgil', 'gil', 'sgil' or 'cgil'. Converts as much currency as possible to this type.\n   */\n  convertCurrency(type = \"pgil\") {\n    const totalValue = this.getTotalCurrency();\n    const values = [0, 0, 0, 0];\n    switch (type) {\n      case \"pgil\":\n        values[0] = Math.floor(totalValue / 10);\n        values[1] = Math.max(0, Math.floor(totalValue) - values[0] * 10);\n        values[2] = Math.max(0, Math.floor(totalValue * 10) - values[0] * 100 - values[1] * 10);\n        values[3] = Math.max(0, Math.floor(totalValue * 100) - values[0] * 1000 - values[1] * 100 - values[2] * 10);\n        break;\n      case \"gil\":\n        values[1] = Math.floor(totalValue);\n        values[2] = Math.max(0, Math.floor(totalValue * 10) - values[1] * 10);\n        values[3] = Math.max(0, Math.floor(totalValue * 100) - values[1] * 100 - values[2] * 10);\n        break;\n      case \"sgil\":\n        values[2] = Math.floor(totalValue * 10);\n        values[3] = Math.max(0, Math.floor(totalValue * 100) - values[2] * 10);\n        break;\n      case \"cgil\":\n        values[3] = Math.floor(totalValue * 100);\n        break;\n    }\n\n    const updateData = {};\n    updateData[`system.currency.pgil`] = values[0];\n    updateData[`system.currency.gil`] = values[1];\n    updateData[`system.currency.sgil`] = values[2];\n    updateData[`system.currency.cgil`] = values[3];\n    return this.update(updateData);\n  }\n\n  /**\n   * @returns {number} Weight of coins on the item.\n   * @private\n   */\n  _calculateCoinWeight() {\n    const coinWeightDivisor = game.settings.get(\"ffd20\", \"coinWeight\");\n    if (!coinWeightDivisor) return 0;\n    return (\n      Object.values(this.system.currency || {}).reduce((cur, amount) => {\n        return cur + amount;\n      }, 0) / coinWeightDivisor\n    );\n  }\n\n  /** @inheritdoc */\n  getValue({ recursive = true, sellValue = 0.5, inLowestDenomination = false, forceUnidentified = false } = {}) {\n    let result = super.getValue(...arguments);\n\n    // Add item's contained currencies at full value\n    result += this.getTotalCurrency({ inLowestDenomination });\n\n    if (!recursive) return result;\n\n    // Add item's content items' values\n    this.items.forEach((i) => {\n      result += i.getValue({ recursive: recursive, sellValue: sellValue, inLowestDenomination });\n    });\n\n    return result;\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemEquipmentPF extends ItemPF {\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    // Set equipment subtype and slot\n    const type = changed.system?.subType;\n    if (type !== undefined && type !== this.subType) {\n      // Set subtype\n      const subtype = changed.system?.equipmentSubtype ?? this.system.equipmentSubtype ?? \"\";\n      const subtypes = Object.keys(ffd20.config.equipmentTypes[type] ?? {}).filter((o) => !o.startsWith(\"_\"));\n      if (!subtype || !subtypes.includes(subtype)) {\n        changed.system.equipmentSubtype = subtypes[0];\n      } else {\n        // Clear otherwise\n        changed.system.equipmentSubtype = \"\";\n      }\n\n      // Set slot\n      const slot = changed.system?.slot ?? this.system.slot ?? \"\";\n      const slotTypes = Object.keys(ffd20.config.equipmentSlots[type] ?? {});\n      if (!slot || !slotTypes.includes(slot)) {\n        changed.system.slot = slotTypes[0];\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"equip\", { equipped: false });\n      }\n\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n    const itemData = this.system;\n\n    let eType = this.subType;\n    const typeKeys = Object.keys(ffd20.config.equipmentTypes);\n    if (!typeKeys.includes(eType)) eType = typeKeys[0];\n\n    let eSubtype = this.system.equipmentSubtype;\n    const subtypeKeys = Object.keys(ffd20.config.equipmentTypes[eType]).filter((o) => !o.startsWith(\"_\"));\n    if (!subtypeKeys.includes(eSubtype)) eSubtype = subtypeKeys[0];\n\n    const subtypeLabels = ffd20.config.equipmentTypes[eType];\n    labels.equipmentType = subtypeLabels._label;\n    labels.equipmentSubtype = subtypeLabels[eSubtype] ?? subtypeLabels._label;\n\n    const ac = this.showUnidentifiedData\n      ? itemData.armor.value || 0\n      : (itemData.armor.value || 0) + (itemData.armor.enh || 0);\n    labels.armor = ac > 0 ? `${ac} AC` : \"\";\n\n    return labels;\n  }\n\n  prepareDerivedData() {\n    super.prepareDerivedData();\n    const itemData = this.system;\n\n    // AC labels\n    if (itemData.armor.dex === \"\") itemData.armor.dex = null;\n    else if (typeof itemData.armor.dex === \"string\" && /\\d+/.test(itemData.armor.dex)) {\n      itemData.armor.dex = parseInt(itemData.armor.dex);\n    }\n    // Add enhancement bonus\n    if (itemData.armor.enh == null) itemData.armor.enh = 0;\n\n    // Feed info back to actor\n    if (itemData.equipped === true) {\n      const actor = this.actor;\n      // Guard against weirdness with unlinked data (data is undefined at this state), and also basic test for if this item has actor.\n      if (!actor?.system || !actor?.equipment) return;\n\n      const actorData = actor.system;\n      const shieldTypes = ffd20.config.shieldTypes,\n        armorTypes = ffd20.config.armorTypes;\n\n      switch (itemData.subType) {\n        case \"shield\": {\n          const subtype = itemData.equipmentSubtype;\n          let shieldType = actor.equipment.shield.type;\n          if (subtype === \"other\" && shieldType < shieldTypes.other) shieldType = shieldTypes.other;\n          else if (subtype === \"lightShield\" && shieldType < shieldTypes.light) shieldType = shieldTypes.light;\n          else if (subtype === \"heavyShield\" && shieldType < shieldTypes.heavy) shieldType = shieldTypes.heavy;\n          else if (subtype === \"towerShield\" && shieldType < shieldTypes.tower) shieldType = shieldTypes.tower;\n          if (actor.equipment.shield.type !== shieldType) {\n            actor.equipment.shield.type = shieldType;\n            actor.equipment.shield.id = this.id;\n          }\n          break;\n        }\n        case \"armor\": {\n          const subtype = itemData.equipmentSubtype;\n          let armorType = actor.equipment.armor.type;\n          if (subtype === \"lightArmor\" && armorType < armorTypes.light) armorType = armorTypes.light;\n          else if (subtype === \"mediumArmor\" && armorType < armorTypes.medium) armorType = armorTypes.medium;\n          else if (subtype === \"heavyArmor\" && armorType < armorTypes.heavy) armorType = armorTypes.heavy;\n          if (armorType !== actor.equipment.armor.type) {\n            actor.equipment.armor.type = armorType;\n            actor.equipment.armor.id = this.id;\n          }\n          break;\n        }\n      }\n    }\n  }\n\n  /**\n   * @param {boolean} active\n   * @param {object} context Optional update context\n   * @returns {Promise} Update promise\n   * @override\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.equipped\": active }, context);\n  }\n\n  get isActive() {\n    return this.system.equipped;\n  }\n\n  /**\n   * Does the equipment subtype use slots.\n   *\n   * @type {boolean}\n   */\n  get hasSlots() {\n    return [\"wondrous\", \"other\"].includes(this.subType);\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemFeatPF extends ItemPF {\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"toggle\", { state: false });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /**\n   * @param {boolean} active\n   * @param {object} context Optional update context\n   * @returns {Promise} Update promise\n   * @override\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.disabled\": !active }, context);\n  }\n\n  get isActive() {\n    return !this.system.disabled;\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n    const { subType, abilityType } = this.system;\n\n    labels.featType = ffd20.config.featTypes[subType];\n    labels.abilityType = ffd20.config.abilityTypes[this.system.abilityType]?.short;\n    labels.traitType = ffd20.config.traitTypes[this.system.traitType];\n\n    // Ability type\n    if (abilityType && abilityType !== \"none\") {\n      labels.abilityType = ffd20.config.abilityTypes[abilityType].short;\n    } else if (labels.abilityType) {\n      delete labels.abilityType;\n    }\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  getTypeChatData(data, labels, props, rollData) {\n    super.getTypeChatData(data, labels, props, rollData);\n    // Add ability type label\n    if (labels.abilityType) {\n      props.push(labels.abilityType);\n    }\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemLootPF extends ItemPF {\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  get extraType() {\n    return this.system.extraType;\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    // Reset loot extra type when loot subtype is changed\n    if (\n      changed.system?.subType !== undefined &&\n      changed.system?.subType !== this.system.subType &&\n      changed.system?.extraType === undefined\n    ) {\n      setProperty(changed, \"system.extraType\", \"\");\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"equip\", { equipped: false });\n      }\n\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /**\n   * @param {boolean} active\n   * @param {object} context Optional update context\n   * @returns {Promise} Update promise\n   * @override\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.equipped\": active }, context);\n  }\n\n  get isActive() {\n    if (this.subType === \"gear\") return this.system.equipped;\n    return true;\n  }\n\n  /**\n   * Make ammo count inherently as single use.\n   *\n   * @inheritdoc\n   * @override\n   */\n  get isSingleUse() {\n    return this.subType === \"ammo\" || super.isSingleUse;\n  }\n\n  /**\n   * Simplified addCharges for items that can't have charges.\n   *\n   * @inheritdoc\n   * @override\n   */\n  async addCharges(value) {\n    const quantity = this.system.quantity;\n    if (!Number.isFinite(quantity)) return;\n    return this.update({ \"system.quantity\": quantity + value });\n  }\n\n  /**\n   * Simplified charges\n   *\n   * @override\n   * @type {number} Quantity\n   */\n  get charges() {\n    return this.system.quantity ?? 0;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemRacePF extends ItemPF {\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const actor = this.actor;\n\n    // Overwrite race\n    if (actor) {\n      const oldRace = actor.items.find((o) => o.type === \"race\" && o !== this);\n      if (oldRace) {\n        await oldRace.delete();\n\n        const context = {};\n        // Ensure actor size is updated to match the race, but only if it's same as old race\n        const actorSize = actor.system.traits.size;\n        if (actorSize !== this.system.size && oldRace.system.size === actorSize) context._pf1SizeChanged = true;\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    const actor = this.actor;\n    if (actor?.type === \"basic\") return;\n\n    // Track size change\n    const newSize = changed.system?.size;\n    if (actor && newSize !== undefined) {\n      const oldSize = actor.system.traits?.size;\n      if (this.system.size === oldSize && newSize !== oldSize) {\n        context._pf1SizeChanged = true;\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onUpdate(data, context, userId) {\n    super._onUpdate(data, context, userId);\n\n    const actor = this.actor;\n    // Change actor size if the old size is same as old race size.\n    if (actor && context._pf1SizeChanged && game.user.id === userId) {\n      actor.update({ \"system.traits.size\": this.system.size });\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    if (this.actor?.race === this) this.actor.race = null;\n  }\n\n  /**\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n    const actor = this.actor;\n    // Self-register on actor\n    if (actor) actor.race = this;\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n}\n","/**\n * @typedef {typeof templatePaths[number]} CachedTemplatePath\n * A path to a template that has been cached as part of the partial preloading process.\n */\n\n/**\n * A list of template paths to pre-load\n *\n * @private\n */\nconst templatePaths = /** @type {const} */ ([\n  // Actor Sheet Partials\n  \"systems/ffd20/templates/actors/parts/actor-summary.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-traits.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-inventory.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-features.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-spellbook-front.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-spellbook.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-skills-front.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-skills.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-combat.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-defenses_tables.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-buffs.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-attributes.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-settings.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-settings-ability-scores.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-cmb.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-contextNotes.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-source-details.hbs\",\n\n  \"systems/ffd20/templates/internal/item-search.hbs\",\n\n  \"systems/ffd20/templates/internal/table_magic-items.hbs\",\n\n  // Item Sheet Partials\n  \"systems/ffd20/templates/items/parts/item-actions.hbs\",\n  \"systems/ffd20/templates/items/parts/item-advanced.hbs\",\n  \"systems/ffd20/templates/items/parts/item-aura.hbs\",\n  \"systems/ffd20/templates/items/parts/item-base-types.hbs\",\n  \"systems/ffd20/templates/items/parts/item-changes.hbs\",\n  \"systems/ffd20/templates/items/parts/item-contents.hbs\",\n  \"systems/ffd20/templates/items/parts/item-description.hbs\",\n  \"systems/ffd20/templates/items/parts/item-links.hbs\",\n  \"systems/ffd20/templates/items/parts/item-name.hbs\",\n  \"systems/ffd20/templates/items/parts/item-proficiencies.hbs\",\n  \"systems/ffd20/templates/items/parts/item-size.hbs\",\n  \"systems/ffd20/templates/items/parts/item-tag.hbs\",\n  \"systems/ffd20/templates/items/parts/item-tags.hbs\",\n  \"systems/ffd20/templates/items/parts/item-weapon-groups.hbs\",\n\n  // Apps\n  \"systems/ffd20/templates/apps/attack-roll-dialog.hbs\",\n  \"systems/ffd20/templates/apps/vision-permission.hbs\",\n  \"systems/ffd20/templates/apps/help-browser.hbs\",\n\n  // Item Action Partials\n  \"systems/ffd20/templates/apps/item-action/action.hbs\",\n  \"systems/ffd20/templates/apps/item-action/activation.hbs\",\n  \"systems/ffd20/templates/apps/item-action/template.hbs\",\n  \"systems/ffd20/templates/apps/item-action/conditionals.hbs\",\n\n  // Compendium browser partials\n  \"systems/ffd20/templates/apps/compendium-browser/entries.hbs\",\n  \"systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs\",\n  \"systems/ffd20/templates/apps/compendium-browser/minmax-filter.hbs\",\n\n  // Chat\n  \"systems/ffd20/templates/chat/roll-ext.hbs\",\n  \"systems/ffd20/templates/chat/defenses.hbs\",\n  \"systems/ffd20/templates/chat/parts/gm-description.hbs\",\n\n  // Chat card partials\n  \"systems/ffd20/templates/chat/parts/attack-roll-header.hbs\",\n  \"systems/ffd20/templates/chat/parts/attack-roll-footer.hbs\",\n  \"systems/ffd20/templates/chat/parts/attack-roll-targets.hbs\",\n\n  // Internal Rendering Partials\n  \"systems/ffd20/templates/internal/spell-description.hbs\",\n  \"systems/ffd20/templates/internal/consumable-description.hbs\",\n  \"systems/ffd20/templates/internal/damage-tooltip.hbs\",\n  \"systems/ffd20/templates/internal/token-config_vision.hbs\",\n  \"systems/ffd20/templates/internal/damage-type-visual.hbs\",\n\n  // Tooltip\n  \"systems/ffd20/templates/hud/tooltip.hbs\",\n  \"systems/ffd20/templates/hud/tooltip_actor.hbs\",\n\n  // Level Up sections\n  \"systems/ffd20/templates/apps/level-up/fc_alt.hbs\",\n  \"systems/ffd20/templates/apps/level-up/fc_hp.hbs\",\n  \"systems/ffd20/templates/apps/level-up/fc_skill.hbs\",\n  \"systems/ffd20/templates/apps/level-up/health_roll.hbs\",\n  \"systems/ffd20/templates/apps/level-up/health_manual.hbs\",\n  \"systems/ffd20/templates/apps/level-up/ability-score.hbs\",\n  \"systems/ffd20/templates/apps/level-up/summary.hbs\",\n\n  // Level Up summary\n  \"systems/ffd20/templates/apps/level-up/summary/health.hbs\",\n  \"systems/ffd20/templates/apps/level-up/summary/fc.hbs\",\n  \"systems/ffd20/templates/apps/level-up/summary/ability-score.hbs\",\n]);\n\n/**\n * Define a set of template paths to pre-load\n * Pre-loaded templates are compiled and cached for fast access when rendering\n *\n * @internal\n * @private\n * @returns {Promise<Function[]>} - A Promise resolving to an array of template functions\n */\nexport const preloadHandlebarsTemplates = async () => {\n  // Load the template parts\n  return loadTemplates(templatePaths);\n};\n\n/**\n * Synchronously render a cached Handlebars template using provided data.\n *\n * @internal\n * @private\n * @see {renderTemplate}\n * @param {CachedTemplatePath} path - The template identifier\n * @param {object} [data={}] - The data provided to the template\n * @returns {string} The rendered HTML\n * @throws {Error} If the requested template could not be found in the cache\n */\nexport const renderCachedTemplate = (path, data = {}) => {\n  /** @type {Handlebars.TemplateDelegate|undefined} */\n  const template = Handlebars.partials[path];\n  if (!template) throw new Error(`Template ${path} not found in cache`);\n\n  return template(data, {\n    allowProtoMethodsByDefault: true,\n    allowProtoPropertiesByDefault: true,\n    preventIndent: true,\n  });\n};\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\nimport { getDistanceSystem } from \"@utils\";\nimport { renderCachedTemplate } from \"@utils/handlebars/templates.mjs\";\n\nexport class ItemSpellPF extends ItemPF {\n  /**\n   * @override\n   * @param {object} data Creation data\n   * @param {object} options Context options\n   * @param {User} user Triggering user\n   */\n  async _preCreate(data, options, user) {\n    await super._preCreate(data, options, user);\n    this._assignLevelOnCreate(data, options);\n  }\n\n  async _preUpdate(changed, options, user) {\n    await super._preUpdate(changed, options, user);\n\n    if (!changed.system) return;\n\n    this._preparationPreUpdate(changed);\n  }\n\n  /**\n   * Constrains and alters prepared slot updates to result in meaningful end results.\n   *\n   * @private\n   * @param {object} changed Change data in pre-update\n   */\n  _preparationPreUpdate(changed) {\n    const prep = changed.system.preparation;\n    if (!prep) return;\n\n    const current = this.system.preparation;\n    const max = prep.maxAmount ?? current.maxAmount ?? 0;\n    const left = prep.preparedAmount ?? current.preparedAmount ?? 0;\n\n    // Constrain left and max to sane values\n    if (left > max) {\n      if (prep.maxAmount !== undefined) {\n        prep.preparedAmount = max;\n      } else if (prep.preparedAmount !== undefined) {\n        prep.maxAmount = left;\n      }\n    }\n\n    // TODO: Remove following once DataModel is implemented with relevant constraints\n    if (prep.maxAmount < 0) prep.maxAmount = 0;\n    if (prep.preparedAmount < 0) prep.preparedAmount = 0;\n  }\n\n  /**\n   * Assign spell level according to spellbook class if present.\n   *\n   * @protected\n   * @param {object} data Item data\n   * @param {object} options Creation options\n   */\n  _assignLevelOnCreate(data, options) {\n    const actor = this.actor;\n    const book = this.system.spellbook;\n    const cls = actor?.system.attributes?.spells?.spellbooks?.[book]?.class;\n    const level = this.system.learnedAt?.class?.[cls];\n    if (Number.isFinite(level)) this.updateSource({ \"system.level\": Math.clamped(level, 0, 9) });\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n    const itemData = this.system;\n\n    // Spell Level, School, and Components\n    labels.level = ffd20.config.spellLevels[itemData.level];\n    labels.school = ffd20.config.spellSchools[itemData.school];\n    labels.components = this.getSpellComponents()\n      .map((o) => o[0])\n      .join(\" \");\n\n    return labels;\n  }\n\n  /**\n   * Returns the spell's effective spell level, after counting in offsets.\n   *\n   * @param {number} [bonus=0] - Another bonus to account for.\n   * @returns {number} The spell's effective spell level.\n   */\n  getEffectiveSpellLevel(bonus = 0) {\n    const slOffset = this.system.slOffset ?? 0;\n    const spellLevel = this.system.level;\n    return Math.max(0, spellLevel + slOffset + bonus);\n  }\n\n  /**\n   * Returns the spell's effective caster level, after counting in offsets.\n   *\n   * @param {number} [bonus=0] - Another bonus to account for.\n   * @returns {number} The spell's effective caster level.\n   */\n  getEffectiveCasterLevel(bonus = 0) {\n    const clOffset = this.system.clOffset ?? 0;\n    const casterLevel = this.spellbook?.cl.total ?? 0;\n    return Math.max(0, casterLevel + clOffset + bonus);\n  }\n\n  preCreateData(data, options, user) {\n    const updates = super.preCreateData(data, options, user);\n\n    const actor = this.actor;\n    if (actor) {\n      // Swap non-psychic components for psychic ones\n      if (this.spellbook?.psychic === true) {\n        if (this.system.components?.verbal === true) {\n          updates[\"system.components.verbal\"] = false;\n          updates[\"system.components.thought\"] = true;\n        }\n        if (this.system.components?.somatic === true) {\n          updates[\"system.components.somatic\"] = false;\n          updates[\"system.components.emotion\"] = true;\n        }\n      }\n    }\n\n    return updates;\n  }\n\n  getRollData() {\n    const result = super.getRollData();\n\n    if (this.actor) {\n      const spellbook = this.spellbook;\n      if (spellbook != null) {\n        const spellAbility = spellbook.ability;\n        let ablMod = \"\";\n        if (spellAbility !== \"\") ablMod = this.actor.system.abilities?.[spellAbility]?.mod;\n\n        result.cl = this.casterLevel || 0;\n        result.sl = this.spellLevel || 0;\n        result.classLevel =\n          spellbook.class === \"_hd\"\n            ? result.attributes.hd?.total ?? result.details.level.value\n            : result.classes?.[spellbook.class]?.level || 0;\n        result.ablMod = ablMod;\n      }\n    }\n\n    return result;\n  }\n\n  getConditionalSubTargets(target) {\n    const result = super.getConditionalSubTargets(target);\n\n    // Add subtargets affecting effects\n    if (target === \"effect\") {\n      result[\"cl\"] = game.i18n.localize(\"FFD20.CasterLevel\");\n    }\n\n    // Add misc subtargets\n    if (target === \"misc\") {\n      // Add charges subTarget with specific label\n      if (this.type === \"spell\" && this.useSpellPoints()) result[\"charges\"] = game.i18n.localize(\"FFD20.SpellPointsCost\");\n    }\n\n    return result;\n  }\n\n  /** @inheritDoc */\n  getTypeChatData(data, labels, props, rollData) {\n    if (rollData.item.sr) {\n      props.push(game.i18n.localize(\"FFD20.SpellResistance\"));\n    }\n\n    // Add charges\n    if (this.isCharged && !this.system.atWill) {\n      if (this.useSpellPoints()) {\n        props.push(`${game.i18n.localize(\"FFD20.SpellPoints\")}: ${this.charges}/${this.maxCharges}`);\n      } else {\n        props.push(`${game.i18n.localize(\"FFD20.ChargePlural\")}: ${this.charges}/${this.maxCharges}`);\n      }\n    }\n  }\n\n  /**\n   * @deprecated Use {@link addCharges} instead.\n   * @param {number} value - The number of charges to add.\n   * @param {object} [data=null] - Additional data to pass to the update\n   * @returns {Promise<this | void>} Updated document or undefined if no update is possible.\n   */\n  async addUses(value, data = null) {\n    foundry.utils.logCompatibilityWarning(\"ItemSpellPF.addUses() is deprecated in favor of .addCharges()\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n\n    return this.addCharges(value, data);\n  }\n\n  /**\n   * Add charges to the spell or its relevant resource pool (spell points or spontaneous spells).\n   *\n   * @override\n   * @param {number} value - Number of charges to add\n   * @param {object} [data=null] - Additional data to pass to the update\n   * @returns {Promise<this | void>} Updated document or undefined if no update is possible or required.\n   */\n  async addCharges(value, data = null) {\n    if (!this.actor) return;\n    if (this.system.atWill) return;\n\n    const spellbook = this.spellbook;\n    if (!spellbook) return;\n    const isSpontaneous = spellbook.spontaneous,\n      spellbookKey = this.system.spellbook || \"primary\",\n      spellLevel = this.system.level;\n\n    if (this.useSpellPoints()) {\n      const curUses = this.getSpellUses();\n      const updateData = {};\n      const tempMP = getProperty(this.actor, \"system.attributes.mp.temp\");\n      const curMP = getProperty(this.actor, \"system.attributes.mp.value\");\n\n      // check for temp mp\n      // if temp mp is 0 do normal\n      // else check if temp mp is greater then spell cost\n      // if so deduct from temp and then from normal\n      // else deduct from temp\n      if (tempMP === 0) {\n        updateData[\"system.attributes.mp.value\"] = curUses + value;\n        return this.actor.update(updateData);\n      } else {\n        if (tempMP >= value * -1) {\n          updateData[\"system.attributes.mp.temp\"] = tempMP + value;\n          return this.actor.update(updateData);\n        } else {\n          const leftMP = tempMP + value;\n          updateData[\"system.attributes.mp.temp\"] = 0;\n          updateData[\"system.attributes.mp.value\"] = curMP + leftMP;\n          return this.actor.update(updateData);\n        }\n      }\n    } else {\n      const newCharges = isSpontaneous\n        ? Math.max(0, (spellbook.spells?.[`spell${spellLevel}`]?.value || 0) + value)\n        : Math.max(0, (this.system.preparation?.preparedAmount || 0) + value);\n\n      if (!isSpontaneous) {\n        const key = \"system.preparation.preparedAmount\";\n        if (data == null) {\n          data = {};\n          data[key] = newCharges;\n          return this.update(data);\n        } else {\n          data[key] = newCharges;\n        }\n      } else {\n        const key = `system.attributes.spells.spellbooks.${spellbookKey}.spells.spell${spellLevel}.value`;\n        const actorUpdateData = {};\n        actorUpdateData[key] = newCharges;\n        await this.actor.update(actorUpdateData);\n        return this;\n      }\n    }\n  }\n\n  get isCharged() {\n    if (this.system.atWill) return false;\n    return true;\n  }\n\n  get charges() {\n    return this.getSpellUses();\n  }\n\n  get maxCharges() {\n    return this.getSpellUses(true);\n  }\n\n  /**\n   * Get default charge cost for spell actions.\n   *\n   * @param options\n   * @param options.rollData\n   * @returns {number} Number for default cost.\n   */\n  getDefaultChargeCost({ rollData } = {}) {\n    if (this.system.atWill) return 0;\n\n    if (this.useSpellPoints()) {\n      rollData ??= this.getRollData();\n      const formula = this.getDefaultChargeFormula();\n      return RollPF.safeRoll(formula, rollData).total;\n    } else {\n      return super.getDefaultChargeCost({ rollData });\n    }\n  }\n\n  getDefaultChargeFormula() {\n    if (this.useSpellPoints()) {\n      return this.system.spellPoints?.cost || game.settings.get(\"ffd20\", \"spellPointCost\") || \"0\";\n    } else {\n      return super.getDefaultChargeFormula();\n    }\n  }\n\n  /**\n   * @inheritdoc\n   */\n  async recharge({ value, period = \"day\", exact = false, maximize = true, commit = true, rollData, context } = {}) {\n    const itemData = this.system,\n      spellbook = this.spellbook,\n      isSpontaneous = spellbook.spontaneous;\n\n    if (period == \"week\") {\n      // Spells do not recharge per week\n      if (exact) return;\n      // When not recharging with exact period, downgrade to \"day\" which is normal spell restoration period\n      period = \"day\";\n    }\n\n    // Spells do not restore on non-day period\n    if (![\"day\", \"any\"].includes(period)) return;\n\n    if (!spellbook) return;\n\n    // Spontaneous spells do not record charges in spell.\n    if (spellbook.spontaneous) return;\n\n    // Spellpoints are not on spells\n    if (spellbook.spellPoints?.useSystem ?? false) return;\n\n    const updateData = { system: { preparation: {} } };\n\n    const prep = itemData.preparation;\n    if (prep.preparedAmount == prep.maxAmount) return;\n\n    if (maximize) value = prep.maxAmount;\n    value = Math.clamped(value, 0, prep.maxAmount);\n\n    if (!Number.isFinite(value)) return;\n\n    updateData.system.preparation.preparedAmount = prep.maxAmount;\n\n    if (commit) this.update(updateData, context);\n    return updateData;\n  }\n\n  get spellLevel() {\n    return this.system.level + (this.system.slOffset || 0);\n  }\n\n  get casterLevel() {\n    const spellbook = this.spellbook;\n    if (!spellbook) return null;\n\n    return spellbook.cl.total + (this.system.clOffset || 0);\n  }\n\n  get spellbook() {\n    const bookId = this.system.spellbook;\n    return this.actor?.system?.attributes?.spells.spellbooks[bookId];\n  }\n\n  getDC(rollData = null) {\n    // No actor? No DC!\n    if (!this.actor) return 0;\n\n    const spellbook = this.spellbook;\n    if (spellbook) {\n      let formula = spellbook.baseDCFormula;\n\n      rollData = rollData ?? this.getRollData();\n      const data = rollData.item;\n      if (data.save.dc.length > 0) formula += ` + ${data.save.dc}`;\n\n      // Get conditional save DC bonus\n      const dcBonus = rollData.dcBonus ?? 0;\n\n      return RollPF.safeRoll(formula, rollData).total + dcBonus;\n    }\n    return 10;\n  }\n\n  getSpellUses(max = false) {\n    if (!this.actor) return 0;\n    const itemData = this.system;\n    if (itemData.atWill) return Number.POSITIVE_INFINITY;\n\n    const spellbook = this.spellbook;\n    if (!spellbook) return 0;\n\n    const isSpontaneous = spellbook.spontaneous,\n      spellLevel = itemData.level;\n\n    // added for temp mp\n    if (this.useSpellPoints()) {\n      if (max) return this.actor.system.attributes.mp.max;\n      return this.actor.system.attributes.mp.value + this.actor.system.attributes.mp.temp;\n    } else {\n      if (isSpontaneous) {\n        if (itemData.preparation.spontaneousPrepared === true) {\n          if (max) return spellbook.spells?.[`spell${spellLevel}`]?.max || 0;\n          return spellbook.spells?.[`spell${spellLevel}`]?.value || 0;\n        }\n      } else {\n        if (max) return itemData.preparation?.maxAmount ?? 0;\n        return itemData.preparation?.preparedAmount ?? 0;\n      }\n    }\n\n    return 0;\n  }\n\n  useSpellPoints() {\n    return this.spellbook?.spellPoints?.useSystem ?? false;\n  }\n\n  getSpellComponents(srcData) {\n    if (!srcData) srcData = duplicate(this.system);\n    const reSplit = ffd20.config.re.traitSeparator,\n      srcComponents = this.system.components ?? {},\n      srcMaterials = this.system.materials ?? {};\n\n    const components = [];\n    const labels = {\n      verbal: game.i18n.localize(\"FFD20.SpellComponentKeys.Verbal\"),\n      somatic: game.i18n.localize(\"FFD20.SpellComponentKeys.Somatic\"),\n      thought: game.i18n.localize(\"FFD20.SpellComponentKeys.Thought\"),\n      emotion: game.i18n.localize(\"FFD20.SpellComponentKeys.Emotion\"),\n      material: game.i18n.localize(\"FFD20.SpellComponentKeys.Material\"),\n      focus: game.i18n.localize(\"FFD20.SpellComponentKeys.Focus\"),\n      divineFocus: game.i18n.localize(\"FFD20.SpellComponentKeys.DivineFocus\"),\n    };\n\n    if (srcComponents.verbal) components.push(labels.verbal);\n    if (srcComponents.somatic) components.push(labels.somatic);\n    if (srcComponents.thought) components.push(labels.thought);\n    if (srcComponents.emotion) components.push(labels.emotion);\n\n    const df = srcComponents.divineFocus;\n    // Reverse mapping of CONFIG.FFD20.divineFocus for readability\n    const dfVariants = { DF: 1, MDF: 2, FDF: 3 };\n\n    if (srcComponents.material) {\n      let material = labels.material;\n      if (df === dfVariants.MDF) material = `${material}/${labels.divineFocus}`;\n      if (srcMaterials.value) material = `${material} (${srcMaterials.value})`;\n      if (material) components.push(material);\n    }\n    if (srcComponents.focus) {\n      let focus = labels.focus;\n      if (df === dfVariants.FDF) focus = `${focus}/${labels.divineFocus}`;\n      if (srcMaterials.focus) focus = `${focus} (${srcMaterials.focus})`;\n      if (focus) components.push(focus);\n    }\n    if (df === dfVariants.DF) components.push(labels.divineFocus);\n    if (labels.value) components.push(...srcComponents.value.split(reSplit));\n\n    return components;\n  }\n\n  /**\n   * @param {object} itemData - A spell item's data.\n   * @returns {number[]} An array containing the spell level and caster level.\n   */\n  static getMinimumCasterLevelBySpellData(itemData) {\n    const learnedAt = Object.entries(itemData.system.learnedAt?.class ?? {})?.reduce((cur, [classId, level]) => {\n      const classes = classId.split(\"/\");\n      for (const cls of classes) cur.push([cls, level]);\n      return cur;\n    }, []);\n    const result = [9, 20];\n    for (const [classId, level] of learnedAt) {\n      result[0] = Math.min(result[0], level);\n\n      const tc = ffd20.config.classCasterType[classId] || \"high\";\n      if (tc === \"high\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level - 1) * 2);\n      } else if (tc === \"med\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level - 1) * 3);\n      } else if (tc === \"low\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level) * 3);\n      }\n    }\n\n    return result;\n  }\n\n  static _replaceConsumableConversionString(string, rollData) {\n    string = string.replace(/@sl/g, rollData.sl);\n    string = string.replace(/@cl/g, \"@item.cl\");\n    return string;\n  }\n\n  static async toConsumable(origData, type) {\n    const actionData = origData.system.actions?.[0] ?? {};\n    const data = {\n      type: \"consumable\",\n      name: origData.name,\n    };\n\n    data[\"system.unidentified.name\"] =\n      origData.unidentifiedName || game.i18n.localize(`FFD20.CreateItem${type.capitalize()}`);\n    data[\"system.identified\"] = origData.identified ?? true;\n\n    const action = ffd20.components.ItemAction.defaultData;\n\n    const [minLevel, minCl] = this.getMinimumCasterLevelBySpellData(origData);\n    const level = origData.sl ?? minLevel ?? 1;\n    const cl = origData.cl ?? minCl ?? 1;\n    const materialPrice = origData.system.materials?.gilValue ?? 0;\n\n    // Fill in pseudo roll data object\n    const rollData = origData.system;\n    rollData.sl = level;\n    rollData.cl = cl;\n\n    // Set consumable type\n    data[\"system.subType\"] = type;\n\n    // Set name\n    if (type === \"wand\") {\n      data.name = game.i18n.format(\"FFD20.CreateItemWandOf\", { name: origData.name });\n      data.img = \"systems/ffd20/icons/items/inventory/wand-star.jpg\";\n      data[\"system.price\"] = 0;\n      data[\"system.uses.pricePerUse\"] =\n        Math.floor(((Math.max(0.5, level) * cl * 750 + materialPrice) / 50) * 100) / 100;\n      data[\"system.hardness\"] = 5;\n      data[\"system.hp.max\"] = 5;\n      data[\"system.hp.value\"] = 5;\n      action.name = game.i18n.localize(\"FFD20.Use\");\n      action.img = data.img;\n    } else if (type === \"potion\") {\n      data.name = game.i18n.format(\"FFD20.CreateItemPotionOf\", { name: origData.name });\n      data.img = \"systems/ffd20/icons/items/potions/minor-blue.jpg\";\n      data[\"system.price\"] = Math.max(0.5, level) * cl * 50 + materialPrice;\n      data[\"system.hardness\"] = 1;\n      data[\"system.hp.max\"] = 1;\n      data[\"system.hp.value\"] = 1;\n      action.range = {\n        value: 0,\n        units: \"personal\",\n      };\n      action.name = game.i18n.localize(\"FFD20.Drink\");\n      action.img = data.img;\n    } else if (type === \"scroll\") {\n      data.name = game.i18n.format(\"FFD20.CreateItemScrollOf\", { name: origData.name });\n      data.img = \"systems/ffd20/icons/items/inventory/scroll-magic.jpg\";\n      data[\"system.price\"] = Math.max(0.5, level) * cl * 25 + materialPrice;\n      data[\"system.hardness\"] = 0;\n      data[\"system.hp.max\"] = 1;\n      data[\"system.hp.value\"] = 1;\n      action.name = game.i18n.localize(\"FFD20.Use\");\n      action.img = data.img;\n    }\n\n    // Set charges\n    if (type === \"wand\") {\n      data[\"system.uses.maxFormula\"] = \"50\";\n      data[\"system.uses.value\"] = 50;\n      data[\"system.uses.max\"] = 50;\n      data[\"system.uses.per\"] = \"charges\";\n    } else {\n      data[\"system.uses.per\"] = \"single\";\n    }\n    // Set activation method\n    action.activation.type = \"standard\";\n    // Set activation for unchained action economy\n    action.activation.unchained.type = \"action\";\n    action.activation.unchained.cost = 2;\n\n    // Set measure template and range\n    if (type !== \"potion\") {\n      action.measureTemplate = actionData.measureTemplate;\n      if ([\"close\", \"medium\", \"long\"].includes(actionData.range?.units)) {\n        action.range = {\n          units: \"ft\",\n          value: RollPF.safeTotal(ffd20.config.spellRangeFormulas[actionData.range.units], rollData).toString(),\n        };\n      } else {\n        action.range = actionData.range;\n      }\n    }\n\n    // Set damage formula\n    action.actionType = origData.actionType;\n    for (const d of actionData.damage?.parts ?? []) {\n      action.damage.parts.push({ formula: this._replaceConsumableConversionString(d.formula, rollData), type: d.type });\n    }\n\n    // Set saves\n    if (actionData.save) {\n      action.save.description = actionData.save.description;\n      action.save.type = actionData.save.type;\n      action.save.dc = `10 + ${origData.sl}[${game.i18n.localize(\"FFD20.SpellLevel\")}] + ${Math.floor(\n        origData.sl / 2\n      )}[${game.i18n.localize(\"FFD20.SpellcastingAbility\")}]`;\n    }\n\n    // Copy variables\n    action.actionType = actionData.actionType;\n    action.attackNotes = actionData.attackNotes;\n    action.effectNotes = actionData.effectNotes;\n    action.attackBonus = actionData.attackBonus;\n    action.critConfirmBonus = actionData.critConfirmBonus;\n\n    // Replace attack and effect formula data\n    for (const arrKey of [\"attackNotes\", \"effectNotes\"]) {\n      const arr = getProperty(action, arrKey);\n      if (!arr) continue;\n      for (let a = 0; a < arr.length; a++) {\n        const note = arr[a];\n        arr[a] = this._replaceConsumableConversionString(note, rollData);\n      }\n    }\n\n    // Set Caster Level\n    data[\"system.cl\"] = cl;\n    data[\"system.aura.school\"] = origData.system.school;\n\n    // Set description\n    data[\"system.description.value\"] = this._replaceConsumableConversionString(\n      await renderTemplate(\"systems/ffd20/templates/internal/consumable-description.hbs\", {\n        origData: origData,\n        data: data,\n        isWand: type === \"wand\",\n        isPotion: type === \"potion\",\n        isScroll: type === \"scroll\",\n        sl: level,\n        cl: cl,\n        config: ffd20.config,\n      }),\n      rollData\n    );\n\n    // Create and return synthetic item data\n    data[\"system.actions\"] = [action];\n    return new ItemPF(expandObject(data)).toObject();\n  }\n\n  /**\n   * @returns true if the spell is prepared to cast in any manner.\n   */\n  get canCast() {\n    if (this.system.atWill) return true;\n    const charges = this.charges; // Cache\n    return (\n      (this.isCharged && charges > 0) ||\n      (this.spellbook?.spontaneous && this.system.preparation.spontaneousPrepared && charges > 0)\n    );\n  }\n\n  /**\n   * Determine if this spell is domain/school spell.\n   *\n   * @type {boolean}\n   */\n  get isDomain() {\n    return this.system.domain === true;\n  }\n\n  get fullDescription() {\n    return super.fullDescription + this.system.shortDescription;\n  }\n\n  /**\n   * @inheritdoc\n   */\n  getDescription({ chatcard = false, data = {} } = {}) {\n    return renderCachedTemplate(\"systems/ffd20/templates/internal/spell-description.hbs\", {\n      ...data,\n      ...this.spellDescriptionData,\n      chatcard: chatcard === true,\n    });\n  }\n\n  get spellDescriptionData() {\n    const reSplit = ffd20.config.re.traitSeparator;\n    const srcData = this.system;\n    const firstAction = this.firstAction;\n    const actionData = firstAction?.data ?? {};\n\n    const label = {\n      school: ffd20.config.spellSchools[srcData.school],\n      multi: srcData.multi,\n      multischool: ffd20.config.multiSchools[srcData.multischool],\n      subschool: srcData.subschool || \"\",\n      types: \"\",\n    };\n    const data = {\n      data: mergeObject(this.system, srcData, { inplace: false }),\n      label: label,\n    };\n\n    // Set subschool and types label\n    const types = srcData.types;\n    if (typeof types === \"string\" && types.length > 0) {\n      label.types = types.split(reSplit).join(\", \");\n    }\n    // Set srinfo label\n    const srinfo = srcData.srinfo;\n    if (typeof srinfo === \"string\" && srinfo.length > 0) {\n      label.srinfo = srinfo.split(reSplit).join(\", \");\n    }\n    // Set information about when the spell is learned\n    data.learnedAt = {};\n    if (srcData.learnedAt) {\n      [\"class\", \"domain\"].forEach(\n        (category) =>\n          (data.learnedAt[category] = Object.entries(srcData.learnedAt[category])\n            .map(([classId, level]) => `${classId} ${level}`)\n            .join(\", \"))\n      );\n    }\n\n    const isUnchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n\n    // Set casting time label\n    const act = firstAction?.activation;\n    if (act != null) {\n      const activationCost = act.cost;\n      const activationType = act.type;\n      const activationTypes = isUnchainedActionEconomy\n        ? ffd20.config.abilityActivationTypes_unchained\n        : ffd20.config.abilityActivationTypes;\n      const activationTypesPlurals = isUnchainedActionEconomy\n        ? ffd20.config.abilityActivationTypesPlurals_unchained\n        : ffd20.config.abilityActivationTypesPlurals;\n\n      if (activationType) {\n        if (activationTypesPlurals[activationType] != null) {\n          if (activationCost === 1) label.castingTime = `${activationTypes[activationType]}`;\n          else label.castingTime = `${activationTypesPlurals[activationType]}`;\n        } else label.castingTime = `${activationTypes[activationType]}`;\n      }\n      if (!Number.isNaN(activationCost) && label.castingTime != null)\n        label.castingTime = `${activationCost} ${label.castingTime}`;\n    }\n\n    // Set components label\n    label.components = this.getSpellComponents().join(\", \");\n\n    // Set duration label\n    {\n      const duration = actionData.duration?.value;\n      if (duration) label.duration = duration;\n    }\n    // Set effect label\n    {\n      const effect = actionData.spellEffect;\n      if (effect) label.effect = effect;\n    }\n    // Set targets label\n    {\n      const targets = actionData.target?.value;\n      if (targets) label.targets = targets;\n    }\n    // Set range label\n    {\n      const rangeUnit = actionData.range?.units;\n      const rangeValue = actionData.range?.value;\n\n      if (rangeUnit != null && rangeUnit !== \"none\") {\n        label.range = ffd20.config.distanceUnits[rangeUnit];\n        const units = getDistanceSystem();\n        switch (rangeUnit) {\n          case \"close\":\n            label.range = `${label.range} ${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeShortMetric\" : \"FFD20.SpellRangeShort\"\n            )}`;\n            break;\n          case \"medium\":\n            label.range = `${label.range} ${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeMediumMetric\" : \"FFD20.SpellRangeMedium\"\n            )}`;\n            break;\n          case \"long\":\n            label.range = `${label.range} ${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeLongMetric\" : \"FFD20.SpellRangeLong\"\n            )}`;\n            break;\n          case \"ft\":\n          case \"mi\":\n            if (!rangeValue) label.range = \"\";\n            else label.range = `${rangeValue} ${label.range}`;\n            break;\n          case \"spec\":\n            label.range = rangeValue || label.range;\n            break;\n        }\n      }\n    }\n    // Set area label\n    {\n      const area = actionData.spellArea;\n\n      if (area) label.area = area;\n    }\n\n    // Set DC and SR\n    {\n      const savingThrowDescription = actionData.save?.description;\n      label.savingThrow = savingThrowDescription || game.i18n.localize(\"FFD20.None\");\n\n      const sr = srcData.sr;\n      label.sr = (sr === true ? game.i18n.localize(\"FFD20.Yes\") : game.i18n.localize(\"FFD20.No\")).toLowerCase();\n\n      if (actionData.range?.units !== \"personal\") data.useDCandSR = true;\n    }\n    return data;\n  }\n\n  /**\n   * Number of slots the spell takes to prepare.\n   *\n   * Quick access to .system.slotCost with additional considerations such as at-will toggle.\n   *\n   * Defaults to 1 if the data is not present, 0 if the spell is at-will.\n   *\n   * @type {number}\n   */\n  get slotCost() {\n    if (this.system.atWill) return 0;\n    return this.system.slotCost ?? 1;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\nexport class ItemWeaponPF extends ItemPF {\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    // Set weapon subtype if not present\n    const newWeaponType = changed.system?.subType;\n    if (newWeaponType != null && newWeaponType !== this.system.subType) {\n      const subtype = changed.system.weaponSubtype ?? this.system.weaponSubtype ?? \"\";\n      const keys = Object.keys(ffd20.config.weaponTypes[newWeaponType]).filter((o) => !o.startsWith(\"_\"));\n      if (!subtype || !keys.includes(subtype)) {\n        changed.system.weaponSubtype = keys[0];\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preDelete(context, user) {\n    if (user.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"equip\", { equipped: false });\n      }\n\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    const { weaponTypes } = ffd20.config;\n\n    // Type and subtype labels\n    let wType = this.system.subType;\n    const typeKeys = Object.keys(weaponTypes);\n    if (!typeKeys.includes(wType)) wType = typeKeys[0];\n\n    let wSubtype = this.system.weaponSubtype;\n    const subtypeKeys = Object.keys(weaponTypes[wType]).filter((o) => !o.startsWith(\"_\"));\n    if (!subtypeKeys.includes(wSubtype)) wSubtype = subtypeKeys[0];\n\n    labels.weaponType = weaponTypes[wType]._label;\n    labels.weaponSubtype = weaponTypes[wType][wSubtype];\n\n    return labels;\n  }\n\n  /**\n   * @param {boolean} active\n   * @param {object} context Optional update context\n   * @returns {Promise} Update promise\n   * @override\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.equipped\": active }, context);\n  }\n\n  get isActive() {\n    return this.system.equipped;\n  }\n}\n","export const LinkFunctions = {\n  charges: function (item, links) {\n    for (const l of links) {\n      const otherItem = this.items.get(l.id);\n      if (!otherItem) continue;\n\n      otherItem.links.charges = item;\n      otherItem.prepareLinks();\n    }\n  },\n};\n","import { calculateRange } from \"../../../utils/lib.mjs\";\n\n/**\n * Spellbook details.\n */\nexport class Spellbook {\n  /**\n   * Book key.\n   */\n  key;\n\n  /**\n   * Owning actor.\n   */\n  actor;\n\n  /**\n   * Raw spellbook data.\n   */\n  data;\n\n  /**\n   * All spells.\n   */\n  spells = [];\n\n  level = {};\n\n  /**\n   * @param bookKey Book key.\n   * @param {ActorPF} actor Owning actor.\n   */\n  constructor(bookKey, actor) {\n    this.actor = actor;\n    this.data = actor.system.attributes.spells.spellbooks[bookKey];\n  }\n\n  /**\n   * Add spell to the spellbook and to its appropriate level.\n   *\n   * @param {ItemSpellPF} spell\n   */\n  addSpell(spell) {\n    this.spells.push(spell);\n\n    // Basic sanity check\n    const level = spell.system.level;\n    if (Math.clamped(level, 0, 9) !== level) {\n      console.error(\"Spell with impossible spell level:\", spell);\n      return;\n    }\n\n    // Ensure appropriate spell level exists\n    this.level[level] ??= new SpellbookLevel(this);\n\n    // Add spell to the spell level also\n    this.level[level].spells.push(spell);\n  }\n}\n\n/**\n * Spellbook leveled details.\n */\nexport class SpellbookLevel {\n  /**\n   * Owning book.\n   */\n\n  book;\n  /**\n   * Spells for level.\n   */\n  spells = [];\n\n  constructor(book) {\n    this.book = book;\n  }\n}\n\nexport class SpellbookSlots {\n  max;\n  value;\n  domain;\n  domainMax;\n  domainUnused = 0;\n  used = 0;\n\n  constructor({ value = 0, max = 0, domain = 0 } = {}) {\n    this.value = value ?? 0;\n    this.max = max ?? 0;\n\n    this.domain = domain ?? 0;\n    this.domainMax = this.domain;\n    this.domainUnused = this.domainMax;\n  }\n}\n\nexport class SpellRanges {\n  close;\n  medium;\n  long;\n\n  cl;\n\n  constructor(cl) {\n    this.cl = cl;\n    this.close = calculateRange(null, \"close\", { cl });\n    this.medium = calculateRange(null, \"medium\", { cl });\n    this.long = calculateRange(null, \"long\", { cl });\n  }\n}\n\nexport class SpellbookMode {\n  raw;\n\n  get isHybrid() {\n    return this.raw === \"hybrid\";\n  }\n\n  get isPrestige() {\n    return this.raw === \"prestige\";\n  }\n\n  get isSpontaneous() {\n    return this.raw === \"spontaneous\";\n  }\n\n  get isPrepared() {\n    return this.raw === \"prepared\";\n  }\n\n  get usesSpellpoints() {\n    return this.book.spellPoints?.useSystem === true;\n  }\n\n  get isSemiSpontaneous() {\n    return this.isSpontaneous || this.isHybrid || this.isPrestige || this.usesSpellpoints;\n  }\n\n  constructor(book) {\n    this.book = book;\n\n    let mode = book.spellPreparationMode;\n\n    // Shunt invalid mode\n    if (!mode) mode = book.spellPreparationMode = \"spontaneous\";\n\n    this.raw = mode;\n  }\n}\n","// Add Vision Permission sheet to ActorDirectory context options\nHooks.on(\"getActorDirectoryEntryContext\", function sharedVision(html, menuItems) {\n  menuItems.push({\n    name: \"FFD20.Vision\",\n    icon: '<i class=\"fas fa-eye\"></i>',\n    condition: (li) => {\n      return game.user.isGM;\n    },\n    callback: (li) => {\n      const doc = game.actors.get(li.data(\"documentId\"));\n      if (doc) {\n        const sheet = doc.visionPermissionSheet;\n        if (sheet.rendered) {\n          if (sheet._minimized) sheet.maximize();\n          else sheet.close();\n        } else sheet.render(true);\n      }\n    },\n  });\n});\n\nexport class VisionPermissionSheet extends FormApplication {\n  constructor(object, options) {\n    super(object, options);\n\n    // Register the sheet as an active Application for the Document\n    this.object.apps[this.appId] = this;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"sheet\", \"vision-permission\"],\n      template: \"systems/ffd20/templates/apps/vision-permission.hbs\",\n      width: 300,\n      height: \"auto\",\n      closeOnSubmit: true,\n      submitOnClose: false,\n      submitOnChange: false,\n    });\n  }\n\n  get title() {\n    return this.token && !this.token.data.actorLink\n      ? `Vision Permissions: [Token] ${this.object.name}`\n      : `Vision Permissions: ${this.object.name}`;\n  }\n  get isLinkedToken() {\n    return this.token ? this.token.data.actorLink : false;\n  }\n\n  async _updateObject(event, formData) {\n    await this.object.setFlag(\"ffd20\", \"visionPermission\", formData);\n  }\n\n  async getData() {\n    let data = super.getData();\n    data = mergeObject(data, this.object.getFlag(\"ffd20\", \"visionPermission\"));\n    data.users = data.users || {};\n\n    data.defaultLevels = [\n      { level: \"no\", name: game.i18n.localize(\"FFD20.No\") },\n      { level: \"yes\", name: game.i18n.localize(\"FFD20.Yes\") },\n    ];\n    data.levels = [{ level: \"default\", name: game.i18n.localize(\"FFD20.Default\") }, ...data.defaultLevels];\n    if (data.default == null) data.default = \"no\";\n\n    data.users = game.users.reduce((cur, o) => {\n      if (!o.isGM) {\n        cur[o.id] = {\n          user: o,\n          level: data.users[o.id]?.level || \"default\",\n          hidden: false,\n        };\n      }\n\n      return cur;\n    }, {});\n\n    return data;\n  }\n}\n\n/**\n * Check if a Token can be a vison source for the current user (due to shared vision).\n *\n * @param {Token} token - The Token\n * @returns {boolean} Whether token is a possible vision source\n */\nexport const hasTokenVision = function (token) {\n  if (!token.actor) return false;\n  if (token.actor.testUserPermission(game.user, \"OWNER\")) return true;\n\n  const visionFlag = token.actor.getFlag(\"ffd20\", \"visionPermission\");\n  if (!visionFlag || !visionFlag.users[game.user.id]) return false;\n  if (visionFlag.users[game.user.id].level === \"yes\") return true;\n  if (visionFlag.users[game.user.id].level === \"default\" && visionFlag.default === \"yes\") return true;\n\n  return false;\n};\n","import { getAbilityModifier } from \"@utils\";\nimport { ItemPF, ItemRacePF } from \"@item/_module.mjs\";\nimport { createTag, fractionalToString, enrichHTMLUnrolled } from \"../../utils/lib.mjs\";\nimport { createCustomChatMessage } from \"../../utils/chat.mjs\";\nimport { LinkFunctions } from \"../../utils/links.mjs\";\nimport {\n  applyChanges,\n  addDefaultChanges,\n  getChangeFlat,\n  getSourceInfo,\n  setSourceInfoByName,\n  getHighestChanges,\n} from \"./utils/apply-changes.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\nimport { Spellbook, SpellRanges, SpellbookMode, SpellbookSlots } from \"./utils/spellbook.mjs\";\nimport { ItemChange } from \"../../components/change.mjs\";\nimport { VisionPermissionSheet } from \"module/applications/vision-permission.mjs\";\n\n/**\n * Extend the base Actor class to implement additional game system logic.\n */\nexport class ActorPF extends Actor {\n  constructor(...args) {\n    super(...args);\n\n    if (this.itemFlags === undefined)\n      /**\n       * Init item flags.\n       */\n      this.itemFlags = { boolean: {}, dictionary: {} };\n\n    if (this.changeItems === undefined)\n      /**\n       * A list of all the active items with changes.\n       *\n       * @type {ItemPF[]}\n       */\n      this.changeItems = [];\n\n    if (this.changes === undefined)\n      /**\n       * Stores all ItemChanges from carried items.\n       *\n       * @public\n       * @type {Collection<ItemChange>}\n       */\n      this.changes = new Collection();\n\n    if (this._queuedUpdates === undefined)\n      /**\n       * Stores updates to be applied to the actor near the end of the _onUpdate method.\n       *\n       * @private\n       * @type {Object<string, any>}\n       */\n      this._queuedUpdates = {};\n\n    if (this._rollData === undefined)\n      /**\n       * Cached roll data for this item.\n       *\n       * @type {object}\n       */\n      this._rollData = null;\n\n    if (this._runningFunctions === undefined)\n      /**\n       * Keeps track of currently running async functions that shouldn't run multiple times simultaneously.\n       *\n       * @type {Object<string>}\n       */\n      this._runningFunctions = {};\n\n    if (this.containerItems === undefined)\n      /**\n       * All items this actor is holding in containers.\n       *\n       * @type {ItemPF[]}\n       */\n      this.containerItems = [];\n\n    if (this._states === undefined)\n      /**\n       * Tracks various states which need to be tracked.\n       *\n       * @type {object}\n       */\n      this._states = {};\n\n    // Init race reference\n    this.race ??= null;\n\n    this._itemTypes ??= null;\n    this._visionPermissionSheet ??= null;\n  }\n\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const updates = this.preCreateData(data, context, user);\n\n    // Set typed image\n    if (data.img === undefined) {\n      const image = ffd20.config.defaultIcons.actors[this.type];\n      if (image) this.updateSource({ img: image });\n    }\n\n    if (Object.keys(updates).length) this.updateSource(updates);\n  }\n\n  /**\n   * Meant to be overridden.\n   *\n   * @abstract\n   * @augments _preCreate\n   * @param data\n   * @param options\n   * @param userId\n   * @returns {object} Update data to replace with.\n   */\n  preCreateData(data, options, userId) {\n    return {};\n  }\n\n  /* -------------------------------------------- */\n\n  static chatListeners(html) {\n    html.on(\"click\", \"button[data-action], a[data-action]\", this._onChatCardButtonAction.bind(this));\n  }\n\n  static async _onChatCardButtonAction(event) {\n    event.preventDefault();\n\n    // Extract card data\n    const button = event.currentTarget;\n    const card = button.closest(\".chat-card\");\n    const action = button.dataset.action;\n\n    // Roll saving throw\n    if (action === \"defense-save\") {\n      const actor = await ItemPF._getChatCardActor(card);\n      const saveId = button.dataset.save;\n      if (actor) actor.rollSavingThrow(saveId, { event: event });\n    } else if (action === \"save\") {\n      const tokens = canvas.tokens.controlled;\n      const saveId = button.dataset.type;\n      let noSound = false;\n      for (const token of tokens) {\n        const actor = token.actor;\n        actor?.rollSavingThrow(saveId, { event: event, noSound: noSound });\n        noSound = true;\n      }\n    }\n    // Show compendium entry\n    else if (action === \"open-compendium-entry\") {\n      const uuid = button.dataset.compendiumEntry;\n      const document = await fromUuid(uuid);\n\n      if (document instanceof JournalEntryPage) {\n        document.parent.sheet.render(true, { pageId: document.id });\n      } else {\n        document.sheet.render(true);\n      }\n    }\n  }\n\n  /**\n   * @param root0\n   * @param root0.actorName\n   * @param root0.actorId\n   * @deprecated\n   */\n  static getActiveActor({ actorName = null, actorId = null } = {}) {\n    foundry.utils.logCompatibilityWarning(\n      \"ActorPF.getActiveActor() is deprecated in favor of ChatMessage.getSpeakerActor(ChatMessage.getSpeaker())\",\n      {\n        since: \"PF1 v9\",\n        until: \"PF1 v10\",\n      }\n    );\n\n    const speaker = ChatMessage.implementation.getSpeaker();\n    let actor;\n\n    if (actorName || actorId) {\n      actor = game.actors.contents.find((o) => {\n        if (actorName && o.name !== actorName) return false;\n        if (actorId && o.id !== actorId) return false;\n        return true;\n      });\n    }\n    if (speaker.token && !actor) actor = canvas.tokens.get(speaker.token)?.actor;\n    if (!actor) actor = game.actors.get(speaker.actor);\n\n    return actor;\n  }\n\n  /**\n   * Returns an array of all selected tokens, along with their actors.\n   *\n   * @returns {Array.<ActorPF, Token>[]}\n   * @deprecated\n   */\n  static getSelectedActors() {\n    foundry.utils.logCompatibilityWarning(\n      \"ActorPF.getSelectedActors() is deprecated in favor of canvas.tokens.controlled\",\n      {\n        since: \"PF1 v9\",\n        until: \"PF1 v10\",\n      }\n    );\n\n    const result = [];\n    for (const t of canvas.tokens.controlled) {\n      result.push([t.actor, t]);\n    }\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  get spellFailure() {\n    return this.items\n      .filter((o) => {\n        return o.type === \"equipment\" && o.system.equipped === true;\n      })\n      .reduce((cur, o) => {\n        if (typeof o.system.spellFailure === \"number\") return cur + o.system.spellFailure;\n        return cur;\n      }, 0);\n  }\n\n  /**\n   * Actor's current race item.\n   *\n   * @type {ffd20.documents.item.ItemRacePF|null}\n   */\n  get race() {\n    return this._race;\n  }\n\n  /**\n   * Set reference to actor's current race (item).\n   * Fill in any additional info, such as easy reference to creature type.\n   *\n   * @type {ItemRacePF|null}\n   */\n  set race(item) {\n    this._race = item;\n    const creatureType = item?.system.creatureType;\n    this.system.traits ??= {};\n    this.system.traits.type = creatureType;\n    this.system.traits.humanoid = creatureType === \"humanoid\";\n  }\n\n  get typeColor() {\n    return \"#FDE600\";\n  }\n\n  static _translateSourceInfo(type, subtype, name) {\n    let result = \"\";\n    if (type === \"size\") result = game.i18n.localize(\"FFD20.SourceInfoSize\");\n    if (type === \"buff\") {\n      result = game.i18n.localize(\"FFD20.SourceInfoBuffs\");\n      if (subtype === \"temp\") result = game.i18n.localize(\"FFD20.SourceInfoTemporaryBuffs\");\n      if (subtype === \"perm\") result = game.i18n.localize(\"FFD20.SourceInfoPermanentBuffs\");\n      if (subtype === \"item\") result = game.i18n.localize(\"FFD20.SourceInfoItemBuffs\");\n      if (subtype === \"misc\") result = game.i18n.localize(\"FFD20.SourceInfoMiscBuffs\");\n    }\n    if (type === \"equipment\") result = game.i18n.localize(\"FFD20.SourceInfoEquipment\");\n    if (type === \"weapon\") result = game.i18n.localize(\"FFD20.SourceInfoWeapons\");\n    if (type === \"feat\") {\n      result = game.i18n.localize(\"FFD20.SourceInfoFeats\");\n      if (subtype === \"classFeat\") result = game.i18n.localize(\"FFD20.SourceInfoClassFeatures\");\n      if (subtype === \"trait\") result = game.i18n.localize(\"FFD20.SourceInfoTraits\");\n      if (subtype === \"racial\") result = game.i18n.localize(\"FFD20.SourceInfoRacialTraits\");\n      if (subtype === \"misc\") result = game.i18n.localize(\"FFD20.SourceInfoMiscFeatures\");\n      if (subtype === \"template\") result = game.i18n.localize(\"FFD20.SourceInfoTemplate\");\n    }\n    if (type === \"race\") {\n      result = game.i18n.localize(\"FFD20.SourceInfoRace\");\n    }\n\n    if (!name || name.length === 0) return result;\n    if (result === \"\") return name;\n    return `${result} (${name})`;\n  }\n\n  static _getChangeItemSubtype(item) {\n    if (item.type === \"buff\" || item.type === \"feat\") return item.system.subType;\n    return \"\";\n  }\n\n  get _skillTargets() {\n    const skills = [];\n    for (const [sklKey, skl] of Object.entries(this.system.skills)) {\n      if (skl == null) continue;\n      // Add main skill\n      skills.push(`skill.${sklKey}`);\n      // Add subskills if present\n      for (const subSklKey of Object.keys(skl.subSkills ?? [])) {\n        skills.push(`skill.${sklKey}.subSkills.${subSklKey}`);\n      }\n    }\n    return skills;\n  }\n\n  _prepareContainerItems(items) {\n    const collection = [];\n\n    const getContainerContents = function (item) {\n      if (item.type !== \"container\") return;\n\n      item.items.forEach((i) => {\n        collection.push(i);\n        getContainerContents(i);\n      });\n    };\n\n    items.forEach((item) => {\n      getContainerContents(item);\n    });\n\n    return collection;\n  }\n\n  _prepareItemFlags(items) {\n    const bFlags = {};\n    const dFlags = {};\n\n    for (const item of items) {\n      // Process boolean flags\n      if (item.isActive) {\n        const flags = item.system.flags?.boolean || {};\n        for (const flag of Object.keys(flags)) {\n          bFlags[flag] ??= { sources: [] };\n          bFlags[flag].sources.push(item);\n        }\n      }\n\n      // Process dictionary flags\n      const tag = item.system.tag;\n      if (tag) {\n        const flags = item.system.flags?.dictionary || {};\n        for (const [key, value] of Object.entries(flags)) {\n          setProperty(dFlags, `${tag}.${key}`, item.isActive ? value : 0);\n        }\n      }\n    }\n\n    this.itemFlags = {\n      boolean: bFlags,\n      dictionary: dFlags,\n    };\n  }\n\n  _prepareChanges() {\n    this.changeItems = this.items\n      .filter((obj) => {\n        return (\n          (obj.system.changes instanceof Array && obj.system.changes.length) ||\n          (obj.system.changeFlags && Object.values(obj.system.changeFlags).filter((o) => o === true).length)\n        );\n      })\n      .filter((obj) => obj.isActive);\n\n    const changes = [];\n    for (const i of this.changeItems) {\n      changes.push(...i.changes);\n    }\n    addDefaultChanges.call(this, changes);\n\n    const c = new Collection();\n    for (const change of changes) {\n      c.set(change._id, change);\n    }\n    this.changes = c;\n  }\n\n  applyActiveEffects() {\n    this.containerItems = this._prepareContainerItems(this.items);\n    this._prepareItemFlags(this.allItems);\n    this._prepareChanges();\n\n    // Apply active effects. Required for status effects in v11 and onward, such as blind and invisible.\n    super.applyActiveEffects();\n  }\n\n  /**\n   * Deletes expired temporary active effects and disables linked expired buffs.\n   *\n   * @param {object} [options] Additional options\n   * @param {Combat} [options.combat] Combat to expire data in, if relevant\n   * @param {number} [options.timeOffset=0] Time offset from world time\n   * @param {DocumentModificationContext} [context] Document update context\n   */\n  async expireActiveEffects({ combat, timeOffset = 0 } = {}, context = {}) {\n    if (!this.isOwner) throw new Error(\"Must be owner\");\n\n    const worldTime = game.time.worldTime + timeOffset;\n\n    const temporaryEffects = this.temporaryEffects.filter((ae) => {\n      const { seconds, rounds, startTime, startRound } = ae.duration;\n      // Calculate remaining duration.\n      // AE.duration.remaining is updated by Foundry only in combat and is unreliable.\n      if (seconds > 0) {\n        const elapsed = worldTime - (startTime ?? 0),\n          remaining = seconds - elapsed;\n        return remaining <= 0;\n      } else if (rounds > 0 && combat) {\n        // BUG: This will ignore which combat\n        const elapsed = combat.round - (startRound ?? 0),\n          remaining = rounds - elapsed;\n        return remaining <= 0;\n      }\n      return false;\n    });\n\n    const disableActiveEffects = [],\n      deleteActiveEffects = [],\n      disableBuffs = [],\n      actorUpdate = {};\n\n    for (const ae of temporaryEffects) {\n      const re = ae.origin?.match(/Item\\.(?<itemId>\\w+)/);\n      const item = this.items.get(re?.groups.itemId);\n      if (item?.type !== \"buff\") {\n        const conditionId = ae.getFlag(\"core\", \"statusId\");\n        if (conditionId) {\n          // Disable expired conditions\n          actorUpdate[`system.attributes.conditions.-=${conditionId}`] = null;\n        } else {\n          if (ae.getFlag(\"ffd20\", \"autoDelete\")) {\n            deleteActiveEffects.push(ae.id);\n          } else {\n            disableActiveEffects.push({ _id: ae.id, disabled: true });\n          }\n        }\n      } else {\n        disableBuffs.push({ _id: item.id, \"system.active\": false });\n      }\n    }\n\n    // Add context info for why this update happens to allow modules to understand the cause.\n    context.ffd20 ??= {};\n    context.ffd20.reason = \"duration\";\n\n    const hasActorUpdates = !foundry.utils.isEmpty(actorUpdate);\n\n    const deleteAEContext = mergeObject(\n      { render: !disableBuffs.length && !disableActiveEffects.length && !hasActorUpdates },\n      context\n    );\n    if (deleteActiveEffects.length)\n      await this.deleteEmbeddedDocuments(\"ActiveEffect\", deleteActiveEffects, deleteAEContext);\n\n    const disableAEContext = mergeObject({ render: !disableBuffs.length && !hasActorUpdates }, context);\n    if (disableActiveEffects.length)\n      await this.updateEmbeddedDocuments(\"ActiveEffect\", disableActiveEffects, disableAEContext);\n\n    const disableBuffContext = mergeObject({ render: !hasActorUpdates }, context);\n    if (disableBuffs.length) await this.updateEmbeddedDocuments(\"Item\", disableBuffs, disableBuffContext);\n\n    if (hasActorUpdates) await this.update(actorUpdate, context);\n  }\n\n  /**\n   * Prepare actor data before items are prepared.\n   *\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    this.sourceInfo = {};\n    this.changeFlags = {};\n\n    // Reset item types cache\n    this._itemTypes = null;\n\n    // Reset equipment info\n    this.equipment = {\n      shield: { type: ffd20.config.shieldTypes.none, id: undefined },\n      armor: { type: ffd20.config.armorTypes.none, id: undefined },\n    };\n\n    // Reset class info\n    this.classes = {};\n\n    //  Init resources structure\n    this.system.resources ??= {};\n\n    this._resetInherentTotals();\n    Hooks.callAll(\"pf1PrepareBaseActorData\", this);\n\n    // Update total level and mythic tier\n    const classes = this.items.filter((o) => o.type === \"class\");\n    const { level, mythicTier } = classes.reduce(\n      (cur, o) => {\n        o.prepareDerivedData(); // HACK: Out of order preparation for later.\n        cur.level += o.hitDice;\n        cur.mythicTier += o.mythicTier;\n        return cur;\n      },\n      { level: 0, mythicTier: 0 }\n    );\n\n    this.system.details.level.value = level;\n    this.system.details.mythicTier = mythicTier;\n\n    // Populate conditions\n    for (const condition of Object.keys(ffd20.config.conditions)) {\n      this.system.attributes.conditions[condition] ??= false;\n    }\n\n    // Refresh ability scores\n    {\n      const abs = Object.keys(this.system.abilities);\n      for (const ab of abs) {\n        const value = this.system.abilities[ab].value;\n        if (value == null) {\n          this.system.abilities[ab].total = null;\n          this.system.abilities[ab].base = null;\n          this.system.abilities[ab].baseMod = 0;\n        } else {\n          this.system.abilities[ab].total = value - this.system.abilities[ab].drain;\n          this.system.abilities[ab].penalty =\n            (this.system.abilities[ab].penalty || 0) - Math.abs(this.system.abilities[ab].userPenalty || 0);\n          this.system.abilities[ab].base = this.system.abilities[ab].total;\n        }\n      }\n      this.refreshAbilityModifiers();\n    }\n\n    // Reset BAB\n    {\n      const k = \"system.attributes.bab.total\";\n      const v = Math.floor(\n        classes.reduce((cur, cls) => {\n          // HACK: Depends on earlier out of order preparation\n          const bab = cls.system.babBase;\n          if (bab !== 0) {\n            getSourceInfo(this.sourceInfo, k).positive.push({\n              name: cls.name,\n              value: fractionalToString(bab),\n            });\n          }\n          return cur + bab;\n        }, 0)\n      );\n      this.system.attributes.bab.total = Math.floor(v);\n    }\n\n    this._prepareClassSkills();\n\n    // Reset HD\n    setProperty(this.system, \"attributes.hd.total\", this.system.details.level.value);\n  }\n\n  /**\n   * Reset class skills.\n   *\n   * @protected\n   */\n  _prepareClassSkills() {\n    const skillSet = new Set();\n    this.items\n      .filter((actorItems) => [\"class\", \"race\", \"feat\"].includes(actorItems.type))\n      .forEach((relevantActorItems) => {\n        for (const [classSkillName, isClassSkill] of Object.entries(relevantActorItems.system.classSkills || {})) {\n          if (isClassSkill === true) skillSet.add(classSkillName);\n        }\n      });\n\n    for (const [skillKey, skillData] of Object.entries(this.system.skills)) {\n      if (!skillData) {\n        console.warn(`Bad skill data for \"${skillKey}\"`, this);\n        continue;\n      }\n      this.system.skills[skillKey].cs = skillSet.has(skillKey);\n      for (const k2 of Object.keys(skillData.subSkills ?? {})) {\n        setProperty(skillData, `subSkills.${k2}.cs`, skillSet.has(skillKey));\n      }\n    }\n  }\n\n  /**\n   * Checks if there's any matching proficiency\n   *\n   * @param {ItemPF } item - The item to check for.\n   * @param {string} proficiencyName - The proficiency name to look for. e.g. 'lightShield' or 'mediumArmor'.\n   * @returns {boolean} Whether the actor is proficient with that item.\n   */\n  hasArmorProficiency(item, proficiencyName) {\n    // Check for item type\n    if (item.type !== \"equipment\" || ![\"armor\", \"shield\"].includes(item.system.subType)) return true;\n\n    // Custom proficiencies\n    const customProficiencies =\n      this.system.traits.armorProf?.customTotal\n        ?.split(ffd20.config.re.traitSeparator)\n        .map((item) => item.trim().toLowerCase())\n        .filter((item) => item.length > 0) || [];\n\n    const name = item.name.toLowerCase(),\n      tag = item.system.tag;\n    return (\n      this.system.traits.armorProf.total.includes(proficiencyName) ||\n      customProficiencies.find((prof) => prof.includes(name) || prof.includes(tag)) != undefined\n    );\n  }\n\n  /**\n   * Update specific spellbook.\n   *\n   * @param {string} bookId Spellbook identifier\n   * @param {object} [rollData] Roll data instance\n   * @param {object} cache Pre-calculated data for re-use from _generateSpellbookCache\n   */\n  _updateSpellBook(bookId, rollData, cache) {\n    const actorData = this.system;\n    const book = actorData.attributes.spells.spellbooks[bookId];\n    if (!book) {\n      console.error(`Spellbook data not found for \"${bookId} on actor`, this);\n      return;\n    }\n\n    // Set spellbook label\n    book.label = book.name || game.i18n.localize(`FFD20.SpellBook${bookId.capitalize()}`);\n\n    // Do not process spellbooks that are not in use\n    if (!book.inUse) return;\n\n    // Use custom name if present\n    if (book.name) book.label = book.name;\n    // Get name from class if selected\n    else if (book.class) {\n      if (book.class === \"_hd\") book.label = book.name || game.i18n.localize(\"FFD20.SpellBookSpelllike\");\n      else {\n        const bookClassId = this.classes[book.class]?._id;\n        const bookClass = this.items.get(bookClassId);\n        if (bookClass) book.label = bookClass.name;\n      }\n    }\n\n    rollData ??= this.getRollData({ refresh: true });\n    cache ??= this._generateSpellbookCache();\n\n    const bookInfo = cache.books[bookId];\n\n    const spellbookAbility = actorData.abilities[book.ability];\n\n    // Add spell slots based on ability bonus slot formula\n    const spellSlotAbilityScoreBonus = RollPF.safeRoll(book.spellSlotAbilityBonusFormula || \"0\", rollData).total,\n      spellSlotAbilityScore = (spellbookAbility?.total ?? 10) + spellSlotAbilityScoreBonus,\n      spellSlotAbilityMod = getAbilityModifier(spellSlotAbilityScore);\n\n    // Set CL\n    let clTotal = 0;\n    {\n      const key = `system.attributes.spells.spellbooks.${bookId}.cl.total`;\n      const formula = book.cl.formula || \"0\";\n      let total = 0;\n\n      // Add NPC base\n      if (this.type === \"npc\") {\n        const value = book.cl.base || 0;\n        total += value;\n        clTotal += value;\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.Base\"), value);\n      }\n      // Add HD\n      if (book.class === \"_hd\") {\n        const value = actorData.attributes.hd.total;\n        total += value;\n        clTotal += value;\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.HitDie\"), value);\n      }\n      // Add class levels\n      else if (book.class && rollData.classes[book.class]) {\n        const value = rollData.classes[book.class].level;\n        total += value;\n        clTotal += value;\n\n        setSourceInfoByName(this.sourceInfo, key, rollData.classes[book.class].name, value);\n      }\n\n      // Set auto spell level calculation offset\n      if (book.autoSpellLevelCalculation) {\n        const autoFormula = book.cl.autoSpellLevelCalculationFormula || \"0\";\n        const autoBonus = RollPF.safeTotal(autoFormula, rollData);\n        const autoTotal = Math.clamped(total + autoBonus, 1, 20);\n        book.cl.autoSpellLevelTotal = autoTotal;\n\n        clTotal += autoBonus;\n        if (autoBonus !== 0) {\n          setSourceInfoByName(\n            this.sourceInfo,\n            key,\n            game.i18n.localize(\"FFD20.AutoSpellClassLevelOffset.Formula\"),\n            autoBonus\n          );\n        }\n      }\n\n      // Add from bonus formula\n      const clBonus = RollPF.safeRoll(formula, rollData).total;\n      clTotal += clBonus;\n      if (clBonus > 0) {\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.CasterLevelBonusFormula\"), clBonus);\n      } else if (clBonus < 0) {\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.CasterLevelBonusFormula\"), clBonus, false);\n      }\n\n      if (rollData.attributes.woundThresholds.penalty != null) {\n        // Subtract Wound Thresholds penalty. Can't reduce below 1.\n        if (rollData.attributes.woundThresholds.penalty > 0 && clTotal > 1) {\n          clTotal = Math.max(1, clTotal - rollData.attributes.woundThresholds.penalty);\n          setSourceInfoByName(\n            this.sourceInfo,\n            key,\n            game.i18n.localize(ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]),\n            -rollData.attributes.woundThresholds.penalty\n          );\n        }\n      }\n\n      // Subtract energy drain\n      if (rollData.attributes.energyDrain) {\n        clTotal = Math.max(0, clTotal - rollData.attributes.energyDrain);\n        setSourceInfoByName(\n          this.sourceInfo,\n          key,\n          game.i18n.localize(\"FFD20.CondTypeEnergyDrain\"),\n          -Math.abs(rollData.attributes.energyDrain),\n          false\n        );\n      }\n\n      const prevTotal = book.cl.total ?? 0;\n      clTotal += prevTotal;\n      book.cl.total = clTotal;\n    }\n\n    // Set concentration bonus\n    {\n      // Temp fix for old actors that fail migration\n      if (Number.isFinite(book.concentration)) {\n        console.error(`Bad spellbook concentration value \"${book.concentration}\" in spellbook \"${bookId}\"`);\n        book.concentration = {};\n      }\n      const concFormula = book.concentrationFormula;\n      const formulaRoll = concFormula.length ? RollPF.safeRoll(concFormula, rollData).total : 0;\n      const classAbilityMod = actorData.abilities[book.ability]?.mod ?? 0;\n      const concentration = clTotal + classAbilityMod + formulaRoll;\n      const prevTotal = book.concentration.total ?? 0;\n\n      // Set source info\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.CasterLevel\"),\n        clTotal,\n        false\n      );\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.SpellcastingAbility\"),\n        classAbilityMod,\n        false\n      );\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.ByBonus\"),\n        formulaRoll,\n        false\n      );\n\n      // Apply value\n      book.concentration = { total: prevTotal + concentration };\n    }\n\n    const getAbilityBonus = (a) => (a !== 0 ? ActorPF.getSpellSlotIncrease(spellSlotAbilityMod, a) : 0);\n\n    const mode = new SpellbookMode(book);\n\n    // Spell slots\n    const useAuto = book.autoSpellLevelCalculation;\n\n    // Turn off spell points with auto slots\n    if (useAuto) book.spellPoints.useSystem = false;\n\n    const useSpellPoints = book.spellPoints.useSystem === true;\n\n    // Set base \"spontaneous\" based on spell prep mode when using auto slots or spell points\n    if (useAuto || useSpellPoints) book.spontaneous = mode.isSemiSpontaneous;\n\n    if (useAuto) {\n      let casterType = book.casterType;\n      if (!casterType || (mode.isHybrid && casterType !== \"high\")) {\n        book.casterType = casterType = \"high\";\n      }\n      if (mode.isPrestige && casterType !== \"low\") {\n        book.casterType = casterType = \"low\";\n      }\n\n      const castsForLevels =\n        ffd20.config.casterProgression[book.spontaneous ? \"castsPerDay\" : \"spellsPreparedPerDay\"][mode.raw][casterType];\n      let classLevel = Math.clamped(book.cl.autoSpellLevelTotal, 1, 20);\n\n      // Protect against invalid class level bricking actors\n      if (!Number.isSafeInteger(classLevel)) {\n        const msg = `Actor ${this.id} has invalid caster class level.`;\n        console.error(msg, classLevel);\n        ui.notifications?.error(msg);\n        classLevel = Math.floor(classLevel);\n      }\n\n      rollData.ablMod = spellSlotAbilityMod;\n\n      const allLevelModFormula =\n        book[book.spontaneous ? \"castPerDayAllOffsetFormula\" : \"preparedAllOffsetFormula\"] || \"0\";\n      const allLevelMod = RollPF.safeTotal(allLevelModFormula, rollData);\n\n      for (let level = 0; level < 10; level++) {\n        const levelData = book.spells[`spell${level}`];\n        // 0 is special because it doesn't get bonus preps and can cast them indefinitely so can't use the \"cast per day\" value\n        const spellsForLevel =\n          level === 0 && book.spontaneous\n            ? ffd20.config.casterProgression.spellsPreparedPerDay[mode.raw][casterType][classLevel - 1][level]\n            : castsForLevels[classLevel - 1][level];\n        levelData.base = spellsForLevel;\n\n        const offsetFormula = levelData[book.spontaneous ? \"castPerDayOffsetFormula\" : \"preparedOffsetFormula\"] || \"0\";\n\n        const max =\n          typeof spellsForLevel === \"number\" || (level === 0 && book.hasCantrips)\n            ? spellsForLevel + getAbilityBonus(level) + allLevelMod + RollPF.safeTotal(offsetFormula, rollData)\n            : null;\n\n        levelData.max = max;\n        if (!Number.isFinite(levelData.value)) levelData.value = max;\n      }\n    } else {\n      for (let level = book.hasCantrips ? 0 : 1; level < 10; level++) {\n        const spellLevel = book.spells[`spell${level}`];\n        let base = parseInt(spellLevel.base);\n        if (Number.isNaN(base)) {\n          spellLevel.base = null;\n          spellLevel.max = 0;\n        } else if (book.autoSpellLevels) {\n          base += getAbilityBonus(level);\n          spellLevel.max = base;\n        } else {\n          spellLevel.max = base;\n        }\n\n        const max = spellLevel.max;\n        const oldval = spellLevel.value;\n        if (!Number.isFinite(oldval)) spellLevel.value = max;\n      }\n    }\n\n    // Set spontaneous spell slots to something sane\n    for (let a = 0; a < 10; a++) {\n      const spellLevel = book.spells[`spell${a}`];\n      const current = spellLevel.value;\n      spellLevel.value = current || 0;\n    }\n\n    // Update spellbook slots\n    {\n      const slots = {};\n      for (let spellLevel = 0; spellLevel < 10; spellLevel++) {\n        slots[spellLevel] = new SpellbookSlots({\n          value: book.spells[`spell${spellLevel}`].max,\n          domain: book.domainSlotValue ?? 0,\n        });\n      }\n\n      // Slot usage\n      if (!book.spontaneous) {\n        for (let level = 0; level < 10; level++) {\n          const levelSpells = bookInfo.level[level]?.spells ?? [];\n          const lvlSlots = slots[level];\n          for (const spell of levelSpells) {\n            if (Number.isFinite(spell.maxCharges)) {\n              const slotCost = spell.slotCost;\n              const subtract = { domain: 0, uses: 0 };\n              if (spell.isDomain) {\n                subtract.domain = Math.min(spell.maxCharges, lvlSlots.domain);\n                subtract.uses = (spell.maxCharges - subtract.domain) * slotCost;\n              } else {\n                subtract.uses = spell.maxCharges * slotCost;\n              }\n              lvlSlots.domain -= subtract.domain;\n              lvlSlots.value -= subtract.uses;\n            }\n          }\n          book.spells[`spell${level}`].value = lvlSlots.value;\n        }\n      }\n\n      // Spells available hint text if auto spell levels is enabled\n      const useAuto = book.autoSpellLevelCalculation;\n      if (useAuto) {\n        const maxLevelByAblScore = (spellbookAbility?.total ?? 0) - 10;\n\n        const allLevelModFormula = book.preparedAllOffsetFormula || \"0\";\n        const allLevelMod = RollPF.safeTotal(allLevelModFormula, rollData);\n\n        const casterType = book.casterType || \"high\";\n        const classLevel = Math.floor(Math.clamped(book.cl.autoSpellLevelTotal, 1, 20));\n\n        for (let spellLevel = 0; spellLevel < 10; spellLevel++) {\n          const spellLevelData = book.spells[`spell${spellLevel}`];\n          if (maxLevelByAblScore < spellLevel) {\n            spellLevelData.lowAbilityScore = true;\n            continue;\n          }\n\n          spellLevelData.known = { unused: 0, max: 0 };\n          spellLevelData.preparation = { unused: 0, max: 0 };\n\n          let remaining;\n          if (mode.isPrepared) {\n            // for prepared casters, just use the 'value' calculated above\n            remaining = spellLevelData.value;\n            spellLevelData.preparation.max = spellLevelData.max;\n          } else {\n            // spontaneous or hybrid\n            // if not prepared then base off of casts per day\n            let available =\n              ffd20.config.casterProgression.spellsPreparedPerDay[mode.raw][casterType]?.[classLevel - 1][spellLevel];\n            available += allLevelMod;\n\n            const formula = spellLevelData.preparedOffsetFormula || \"0\";\n            available += RollPF.safeTotal(formula, rollData);\n\n            // Leave record of max known\n            spellLevelData.known.max = available;\n\n            // Count spell slots used\n            let dSlots = slots[spellLevel].domain;\n            const used =\n              bookInfo.level[spellLevel]?.spells.reduce((acc, i) => {\n                const { preparation, atWill, domain } = i.system;\n                if (!atWill && preparation.spontaneousPrepared) {\n                  const slotCost = i.slotCost;\n                  if (domain && dSlots > 0) dSlots -= slotCost;\n                  else acc += slotCost;\n                }\n                return acc;\n              }, 0) ?? 0;\n            slots[spellLevel].domainUnused = dSlots;\n            slots[spellLevel].used = used;\n\n            remaining = available - used;\n          }\n\n          if (!remaining) {\n            spellLevelData.spellMessage = \"\";\n            continue;\n          }\n\n          let spellRemainingMsg = \"\";\n\n          if (remaining < 0) {\n            spellRemainingMsg = game.i18n.format(\"FFD20.TooManySpells\", { quantity: Math.abs(remaining) });\n            if (mode.isSpontaneous) spellLevelData.unusedKnown = remaining;\n            else spellLevelData.preparation.unused = remaining;\n          } else if (remaining > 0) {\n            if (mode.isSpontaneous) {\n              spellRemainingMsg =\n                remaining === 1\n                  ? game.i18n.localize(\"FFD20.LearnMoreSpell\")\n                  : game.i18n.format(\"FFD20.LearnMoreSpells\", { quantity: remaining });\n              spellLevelData.known.unused = remaining;\n            } else {\n              // hybrid or prepared\n              spellRemainingMsg =\n                remaining === 1\n                  ? game.i18n.localize(\"FFD20.PrepareMoreSpell\")\n                  : game.i18n.format(\"FFD20.PrepareMoreSpells\", { quantity: remaining });\n              spellLevelData.preparation.unused = remaining;\n            }\n          }\n\n          spellLevelData.spellMessage = spellRemainingMsg;\n        }\n      }\n    }\n\n    // Spell points fix for mp\n    if (useSpellPoints) {\n      const formula = book.spellPoints.maxFormula || \"0\";\n      rollData.cl = book.cl.total;\n      rollData.ablMod = spellSlotAbilityMod;\n      const spellClass = book.class ?? \"\";\n      rollData.classLevel =\n        spellClass === \"_hd\"\n          ? rollData.attributes.hd?.total ?? rollData.details.level.value\n          : rollData.classes[spellClass]?.level || 0;\n\n      const roll = RollPF.safeRoll(formula, rollData);\n      book.spellPoints.max = roll.total;\n    } else {\n      book.spellPoints.max = 0;\n    }\n\n    // Set spellbook ranges\n    book.range = new SpellRanges(book.cl.total);\n  }\n\n  /**\n   * Collect some basic spellbook info so it doesn't need to be gathered again for each spellbook.\n   *\n   * @returns {object} Spellbook cache\n   */\n  _generateSpellbookCache() {\n    const bookKeys = Object.keys(this.system.attributes.spells.spellbooks);\n\n    const allSpells = this.items.filter((i) => i.type === \"spell\");\n\n    const cache = {\n      spells: allSpells,\n      books: {},\n    };\n\n    // Prepare spellbooks\n    bookKeys.forEach((bookKey) => {\n      cache.books[bookKey] ??= new Spellbook(bookKey, this);\n    });\n\n    // Spread out spells to books\n    allSpells.forEach((spell) => {\n      const bookKey = spell.system.spellbook;\n      if (!bookKeys.includes(bookKey)) return console.error(\"Spell has invalid book\", spell);\n      cache.books[bookKey].addSpell(spell);\n    });\n\n    return cache;\n  }\n\n  /**\n   * Update all spellbooks\n   *\n   * @param {object} [rollData] Roll data instance\n   * @param {object} [cache] Spellbook cache\n   */\n  updateSpellbookInfo(rollData, cache) {\n    rollData ??= this.getRollData({ refresh: true });\n    cache ??= this._generateSpellbookCache();\n\n    const spellbooks = this.system.attributes.spells.spellbooks;\n\n    // Set spellbook info\n    for (const bookKey of Object.keys(spellbooks)) {\n      this._updateSpellBook(bookKey, rollData, cache);\n    }\n\n    // usedSpellbooks backwards compatibility. Mostly unused by the system itself\n    this.system.attributes.spells.usedSpellbooks = Object.keys(spellbooks).filter((book) => spellbooks[book].inUse);\n  }\n\n  /**\n   * Called just before the first change is applied, and after every change is applied.\n   * Sets additional variables (such as spellbook range)\n   */\n  refreshDerivedData() {\n    // Reset maximum dexterity bonus\n    this.system.attributes.maxDexBonus = null;\n    this.system.abilities.dex.maxBonus = this.system.abilities.dex.mod;\n\n    {\n      // Compute encumbrance\n      const encPen = this._computeEncumbrance();\n\n      // Apply armor penalties\n      const gearPen = this._applyArmorPenalties();\n\n      // Set armor check penalty\n      this.system.attributes.acp.encumbrance = encPen.acp;\n      this.system.attributes.acp.gear = gearPen.acp;\n      this.system.attributes.acp.total = Math.max(encPen.acp, gearPen.acp);\n\n      // Set maximum dexterity bonus\n      if (encPen.maxDexBonus != null || gearPen.maxDexBonus != null) {\n        this.system.attributes.maxDexBonus = Math.min(\n          encPen.maxDexBonus ?? Number.POSITIVE_INFINITY,\n          gearPen.maxDexBonus ?? Number.POSITIVE_INFINITY\n        );\n        this.system.abilities.dex.maxBonus = Math.min(\n          this.system.abilities.dex.maxBonus,\n          this.system.attributes.maxDexBonus\n        );\n      }\n    }\n  }\n\n  /**\n   * Augment the basic actor data with additional dynamic data.\n   */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    this.prepareProficiencies();\n\n    // Refresh roll data\n    // Some changes act wonky without this\n    // Example: `@skills.hea.rank >= 10 ? 6 : 3` doesn't work well without this\n    this.getRollData({ refresh: true });\n\n    this.items.forEach((item) => {\n      item.prepareDerivedItemData();\n      this.updateItemResources(item);\n    });\n\n    applyChanges.call(this);\n\n    // Prepare specific derived data\n    this.prepareSpecificDerivedData();\n\n    // Prepare CMB total\n    this.prepareCMB();\n\n    // Setup links\n    this.prepareItemLinks();\n\n    // Refresh roll data again to include processed  info\n    this.getRollData({ refresh: true });\n\n    // Update item resources\n    this.items.forEach((item) => {\n      item.prepareDerivedItemData();\n      this.updateItemResources(item);\n    });\n\n    this._initialized = true;\n    this._setSourceDetails(this.sourceInfo);\n  }\n\n  /**\n   * Prepare armor, weapon, and language proficiencies.\n   */\n  prepareProficiencies() {\n    const actorData = this.system;\n    // Handle armor and weapon proficiencies for PCs\n    // NPCs are considered proficient with their armor\n    // Collect proficiencies from items, add them to actor's proficiency totals\n    const proficiencies = {\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      languages: ffd20.config.languages,\n    };\n    for (const [prof, translations] of Object.entries(proficiencies)) {\n      // Custom proficiency baseline from actor\n      const customProficiencies =\n        actorData.traits[prof]?.custom?.split(ffd20.config.re.traitSeparator).filter((item) => item.length > 0) || [];\n\n      // Iterate over all items to create one array of non-custom proficiencies\n      const proficiencies = this.items.reduce(\n        (profs, item) => {\n          // Check only items able to grant proficiencies\n          if (hasProperty(item, `system.${prof}`)) {\n            // Get existing sourceInfo for item with this name, create sourceInfo if none is found\n            // Remember whether sourceInfo can be modified or has to be pushed at the end\n            let sInfo = getSourceInfo(this.sourceInfo, `system.traits.${prof}`).positive.find(\n              (o) => o.name === item.name\n            );\n            const hasInfo = !!sInfo;\n            if (!sInfo) sInfo = { name: item.name, value: [] };\n            else if (typeof sInfo.value === \"string\") sInfo.value = sInfo.value.split(\", \");\n\n            // Regular proficiencies\n            for (const proficiency of item.system[prof].value) {\n              // Add localized source info if item's info does not have this proficiency already\n              if (!sInfo.value.includes(proficiency)) sInfo.value.push(translations[proficiency]);\n              // Add raw proficiency key\n              if (!profs.includes(proficiency)) profs.push(proficiency);\n            }\n\n            // Collect trimmed but otherwise original proficiency strings, dedupe array for actor's total\n            const customProfs =\n              item.system[prof].custom\n                ?.split(ffd20.config.re.traitSeparator)\n                .map((i) => i.trim())\n                .filter((el, i, arr) => el.length > 0 && arr.indexOf(el) === i) || [];\n            // Add readable custom profs to sources and overall collection\n            sInfo.value.push(...customProfs);\n            customProficiencies.push(...customProfs);\n\n            if (sInfo.value.length > 0) {\n              // Dedupe if adding to existing sourceInfo\n              if (hasInfo) sInfo.value = [...new Set(sInfo.value)];\n              // Transform arrays into presentable strings\n              sInfo.value = sInfo.value.join(\", \");\n              // If sourceInfo was not a reference to existing info, push it now\n              if (!hasInfo) getSourceInfo(this.sourceInfo, `system.traits.${prof}`).positive.push(sInfo);\n            }\n          }\n          return profs;\n        },\n        [...(actorData.traits[prof]?.value ?? [])] // Default proficiency baseline from actor\n      );\n\n      // Save collected proficiencies in actor's data\n      actorData.traits[prof] ??= {}; // In case the data structure is missing\n      actorData.traits[prof].total = [...proficiencies];\n      actorData.traits[prof].customTotal = customProficiencies.join(\";\");\n    }\n  }\n\n  prepareCMB() {\n    const shrAtk = this.system.attributes.attack.shared ?? 0,\n      genAtk = this.system.attributes.attack.general ?? 0,\n      cmbAbl = this.system.attributes.cmbAbility,\n      cmbAblMod = this.system.abilities[cmbAbl]?.mod ?? 0,\n      size = this.system.traits.size,\n      szCMBMod = ffd20.config.sizeSpecialMods[size] ?? 0,\n      cmbBonus = this.system.attributes.cmb.bonus ?? 0,\n      cmb = shrAtk + genAtk + szCMBMod + cmbBonus + cmbAblMod;\n    this.system.attributes.cmb.total = cmb;\n  }\n\n  prepareSpecificDerivedData() {\n    Hooks.callAll(\"pf1PrepareDerivedActorData\", this);\n\n    this.refreshDerivedData();\n\n    const attributes = this.system.attributes,\n      abilities = this.system.abilities;\n\n    // Set base ability modifier\n    for (const ab of Object.keys(abilities)) {\n      const total = abilities[ab].base;\n      const penalty = abilities[ab].penalty || 0;\n      const damage = abilities[ab].damage;\n      abilities[ab].baseMod = getAbilityModifier(total, { penalty, damage });\n    }\n\n    const actorData = this.system;\n    const data = actorData;\n\n    // Round health\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const round = { up: Math.ceil, nearest: Math.round, down: Math.floor }[healthConfig.rounding];\n    for (const k of [\"hp\", \"vigor\"]) {\n      attributes[k].max = round(attributes[k].max);\n    }\n\n    // Offset relative health\n    for (const key of [\"hp\", \"wounds\", \"vigor\"]) {\n      const hp = this.system.attributes[key];\n      if (Number.isFinite(hp?.offset)) {\n        hp.value = hp.max + hp.offset;\n      }\n    }\n\n    // Shared attack bonuses\n    {\n      // Total\n      const totalAtk = attributes.bab.total - attributes.acp.attackPenalty - (attributes.energyDrain ?? 0);\n      attributes.attack.shared = totalAtk;\n    }\n\n    // Update wound threshold\n    this.updateWoundThreshold();\n\n    // Create arbitrary skill slots\n    for (const skillId of ffd20.config.arbitrarySkills) {\n      if (data.skills[skillId] == null) continue;\n      const skill = data.skills[skillId];\n      skill.subSkills = skill.subSkills || {};\n      for (const subSkillId of Object.keys(skill.subSkills)) {\n        if (skill.subSkills[subSkillId] == null) delete skill.subSkills[subSkillId];\n      }\n    }\n\n    // Delete removed skills\n    for (const skillId of Object.keys(data.skills)) {\n      const skl = data.skills[skillId];\n      if (skl == null) {\n        delete data.skills[skillId];\n      }\n    }\n\n    // Mark background skills\n    for (const skillId of Object.keys(data.skills)) {\n      if (ffd20.config.backgroundSkills.includes(skillId)) {\n        const skill = data.skills[skillId];\n        skill.background = true;\n        for (const subSkillId of Object.keys(skill.subSkills ?? {})) skill.subSkills[subSkillId].background = true;\n      }\n    }\n\n    // Combine AC types\n    for (const k of [\"ac.normal.total\", \"ac.shield.total\", \"ac.natural.total\"]) {\n      const v = getProperty(actorData, k);\n      if (v) {\n        for (const k2 of [\"normal\", \"flatFooted\"]) {\n          attributes.ac[k2].total += v;\n        }\n      }\n    }\n\n    // Add Dexterity to AC\n    {\n      // get configured ability scores\n      const acAbl = attributes.ac.normal.ability ?? \"dex\";\n      const acTouchAbl = attributes.ac.touch.ability ?? \"dex\";\n      const cmdDexAbl = attributes.cmd.dexAbility ?? \"dex\";\n      let acAblMod = abilities[acAbl]?.mod ?? 0;\n      let acTouchAblMod = abilities[acTouchAbl]?.mod ?? 0;\n      const cmdDexAblMod = abilities[cmdDexAbl]?.mod ?? 0;\n      if (this.changeFlags[\"loseDexToAC\"]) {\n        acAblMod = Math.min(acAblMod, 0);\n        acTouchAblMod = Math.min(acTouchAblMod, 0);\n      }\n      const maxDex = attributes.maxDexBonus ?? null;\n      const ac = {\n        normal: maxDex !== null ? Math.min(maxDex, acAblMod) : acAblMod,\n        touch: maxDex !== null ? Math.min(maxDex, acTouchAblMod) : acTouchAblMod,\n        flatFooted: Math.min(0, acAblMod),\n      };\n      const acAblKey = {\n        normal: acAbl,\n        touch: acTouchAbl,\n        flatFooted: acAbl,\n      };\n      const cmd = {\n        total: cmdDexAblMod,\n        flatFootedTotal: Math.min(0, cmdDexAblMod),\n      };\n      for (const [k, v] of Object.entries(ac)) {\n        attributes.ac[k].total += v;\n        getSourceInfo(this.sourceInfo, `system.attributes.ac.${k}.total`).positive.push({\n          value: v,\n          name: ffd20.config.abilities[acAblKey[k]],\n        });\n      }\n      for (const [k, v] of Object.entries(cmd)) {\n        attributes.cmd[k] += v;\n        getSourceInfo(this.sourceInfo, `system.attributes.cmd.${k}`).positive.push({\n          value: v,\n          name: ffd20.config.abilities[cmdDexAbl],\n        });\n      }\n    }\n\n    // Reduce final speed under certain circumstances\n    {\n      const armorItems = this.items.filter((o) => o.type === \"equipment\");\n      let reducedSpeed = false;\n      const sInfo = { name: \"\", value: game.i18n.localize(\"FFD20.ReducedMovementSpeed\") };\n      if (attributes.encumbrance.level >= ffd20.config.encumbranceLevels.medium && !this.changeFlags[\"noEncumbrance\"]) {\n        reducedSpeed = true;\n        sInfo.name = game.i18n.localize(\"FFD20.Encumbrance\");\n      }\n      if (\n        armorItems.filter((o) => o.system.equipmentSubtype === \"mediumArmor\" && o.system.equipped).length &&\n        !this.changeFlags[\"mediumArmorFullSpeed\"]\n      ) {\n        reducedSpeed = true;\n        sInfo.name = game.i18n.localize(\"FFD20.EquipTypeMedium\");\n      }\n      if (\n        armorItems.filter((o) => o.system.equipmentSubtype === \"heavyArmor\" && o.system.equipped).length &&\n        !this.changeFlags[\"heavyArmorFullSpeed\"]\n      ) {\n        reducedSpeed = true;\n        sInfo.name = game.i18n.localize(\"FFD20.EquipTypeHeavy\");\n      }\n      if (reducedSpeed) {\n        for (const speedKey of Object.keys(this.system.attributes.speed)) {\n          const speedValue = this.system.attributes.speed[speedKey].total;\n          this.system.attributes.speed[speedKey].total = this.constructor.getReducedMovementSpeed(speedValue);\n          if (speedValue > 0) {\n            getSourceInfo(this.sourceInfo, `system.attributes.speed.${speedKey}.add`).negative.push(sInfo);\n          }\n        }\n      }\n    }\n\n    // Add encumbrance source details\n    switch (attributes.encumbrance.level) {\n      case ffd20.config.encumbranceLevels.medium:\n        getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.push({\n          name: game.i18n.localize(\"FFD20.Encumbrance\"),\n          value: 3,\n        });\n        getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.push({\n          name: game.i18n.localize(\"FFD20.Encumbrance\"),\n          value: 3,\n        });\n        break;\n      case ffd20.config.encumbranceLevels.heavy:\n        getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.push({\n          name: game.i18n.localize(\"FFD20.Encumbrance\"),\n          value: 6,\n        });\n        getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.push({\n          name: game.i18n.localize(\"FFD20.Encumbrance\"),\n          value: 1,\n        });\n        break;\n    }\n\n    this.updateSpellbookInfo();\n  }\n\n  /**\n   * Returns this actor's labels\n   *\n   * @returns {Record<string, string>}\n   */\n  getLabels() {\n    const labels = {};\n    // Race\n    labels.race = this.race\n      ? game.i18n.format(\"FFD20.RaceTitle\", { name: this.race.name })\n      : game.i18n.localize(\"FFD20.Race\");\n    labels.alignment = ffd20.config.alignments[this.system.details.alignment];\n\n    // Speed\n    labels.speed = {};\n    for (const [key, obj] of Object.entries(this.system.attributes.speed ?? {})) {\n      const dist = ffd20.utils.convertDistance(obj.total);\n      labels.speed[key] = `${dist[0]} ${ffd20.config.measureUnitsShort[dist[1]]}`;\n    }\n\n    return labels;\n  }\n\n  /**\n   * Computes armor penalties for this actor.\n   *\n   * @returns {MobilityPenaltyResult} The resulting penalties from armor.\n   */\n  _applyArmorPenalties() {\n    // Item type to proficiency maps\n    const proficiencyMaps = {\n      armor: {\n        lightArmor: \"lgt\",\n        mediumArmor: \"med\",\n        heavyArmor: \"hvy\",\n      },\n      shield: {\n        other: \"shl\", // buckler\n        lightShield: \"shl\",\n        heavyShield: \"shl\",\n        towerShield: \"twr\",\n      },\n    };\n\n    let attackACPPenalty = 0; // ACP to attack penalty from lacking proficiency. Stacks infinitely.\n    const acp = { armor: 0, shield: 0 };\n    const broken = { armor: { value: 0, item: null }, shield: { value: 0, item: null } };\n    const mdex = { armor: null, shield: null };\n\n    this.items\n      .filter((obj) => {\n        return obj.type === \"equipment\" && obj.system.equipped;\n      })\n      .forEach((obj) => {\n        const eqType = obj.system.subType;\n        const isShieldOrArmor = [\"armor\", \"shield\"].includes(eqType);\n        let itemACP = Math.abs(obj.system.armor.acp);\n        if (obj.system.masterwork === true && isShieldOrArmor) itemACP = Math.max(0, itemACP - 1);\n\n        if (isShieldOrArmor) {\n          itemACP = Math.max(0, itemACP + (this.system.attributes?.acp?.[`${eqType}Bonus`] ?? 0));\n        }\n\n        let brokenACP = 0;\n        if (obj.system.broken) {\n          brokenACP = itemACP;\n          itemACP *= 2;\n        }\n\n        if (itemACP) {\n          const sInfo = getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.find(\n            (o) => o.itemId === obj.id\n          );\n\n          if (brokenACP) {\n            broken[eqType].value = brokenACP;\n            broken[eqType].item = obj;\n          }\n\n          if (sInfo) sInfo.value = itemACP;\n          else {\n            getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.push({\n              name: obj.name,\n              itemId: obj.id,\n              value: itemACP,\n            });\n          }\n        }\n\n        if (isShieldOrArmor) {\n          if (itemACP > acp[eqType]) acp[eqType] = itemACP;\n          if (!this.hasArmorProficiency(obj, proficiencyMaps[eqType][obj.system.equipmentSubtype]))\n            attackACPPenalty += itemACP;\n        }\n\n        if (obj.system.armor.dex !== null && isShieldOrArmor) {\n          const mDex = Number.parseInt(obj.system.armor.dex, 10);\n          if (Number.isInteger(mDex)) {\n            const mod = this.system.attributes?.mDex?.[`${eqType}Bonus`] ?? 0;\n            const itemMDex = mDex + mod;\n            mdex[eqType] = Math.min(itemMDex, mdex[eqType] ?? Number.POSITIVE_INFINITY);\n\n            const sInfo = getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.find(\n              (o) => o.itemId === obj.id\n            );\n            if (sInfo) sInfo.value = mDex;\n            else {\n              getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.push({\n                name: obj.name,\n                itemId: obj.id,\n                value: mDex,\n                ignoreNull: false,\n              });\n            }\n          }\n        }\n      });\n\n    // Add Broken to sources\n    {\n      const name = game.i18n.localize(\"FFD20.Broken\");\n      for (const eqType of Object.keys(broken)) {\n        const value = broken[eqType].value;\n        if (value == 0) continue;\n        const brokenId = broken[eqType].item.id;\n        const sInfo = getSourceInfo(this.sourceInfo, `system.attributes.acp.${eqType}Bonus`).negative.find(\n          (o) => o.brokenId === brokenId\n        );\n        if (sInfo) sInfo.value = value;\n        else\n          getSourceInfo(this.sourceInfo, `system.attributes.acp.${eqType}Bonus`).negative.push({\n            name,\n            brokenId,\n            value,\n          });\n      }\n    }\n\n    // Return result\n    const totalACP = acp.armor + acp.shield;\n    const result = {\n      maxDexBonus: null,\n      acp: totalACP,\n    };\n    this.system.attributes.acp.gear = totalACP;\n    if (mdex.armor !== null || mdex.shield !== null)\n      result.maxDexBonus = Math.min(mdex.armor ?? Number.POSITIVE_INFINITY, mdex.shield ?? Number.POSITIVE_INFINITY);\n\n    // Set armor penalty to attack rolls\n    this.system.attributes.acp.attackPenalty = attackACPPenalty;\n\n    return result;\n  }\n\n  prepareItemLinks() {\n    if (!this.items) return;\n\n    for (const a of this.items) {\n      if (a.system.links == null) continue;\n\n      for (const l of Object.keys(a.system.links)) {\n        if (LinkFunctions[l] != null) {\n          LinkFunctions[l].call(this, a, a.system.links[l]);\n        }\n      }\n    }\n  }\n\n  _setSourceDetails(extraData) {\n    const actorData = this.system;\n    const sourceDetails = {};\n    // Get empty source arrays\n    for (const b of Object.keys(ffd20.config.buffTargets)) {\n      const buffTargets = getChangeFlat.call(this, b, null);\n      for (const bt of buffTargets) {\n        if (!sourceDetails[bt]) sourceDetails[bt] = [];\n      }\n    }\n    // Add additional source arrays not covered by changes\n    sourceDetails[\"system.attributes.bab.total\"] = [];\n\n    // Add base values to certain bonuses\n    sourceDetails[\"system.attributes.ac.normal.total\"].push({ name: game.i18n.localize(\"FFD20.Base\"), value: 10 });\n    sourceDetails[\"system.attributes.ac.touch.total\"].push({ name: game.i18n.localize(\"FFD20.Base\"), value: 10 });\n    sourceDetails[\"system.attributes.ac.flatFooted.total\"].push({ name: game.i18n.localize(\"FFD20.Base\"), value: 10 });\n    sourceDetails[\"system.attributes.cmd.total\"].push({ name: game.i18n.localize(\"FFD20.Base\"), value: 10 });\n    sourceDetails[\"system.attributes.cmd.flatFootedTotal\"].push({ name: game.i18n.localize(\"FFD20.Base\"), value: 10 });\n    // Add ability score data\n    for (const [a, abl] of Object.entries(actorData.abilities)) {\n      sourceDetails[`system.abilities.${a}.total`].push({ name: game.i18n.localize(\"FFD20.Base\"), value: abl.value });\n      // Add ability penalty, damage and drain\n      if (abl.damage != null && abl.damage !== 0) {\n        sourceDetails[`system.abilities.${a}.total`].push({\n          name: game.i18n.localize(\"FFD20.AbilityDamage\"),\n          value: `-${Math.floor(Math.abs(abl.damage) / 2)} (Mod only)`,\n        });\n      }\n      if (abl.drain != null && abl.drain !== 0) {\n        sourceDetails[`system.abilities.${a}.total`].push({\n          name: game.i18n.localize(\"FFD20.AbilityDrain\"),\n          value: -Math.abs(abl.drain),\n        });\n      }\n    }\n\n    // Add wound threshold data\n    {\n      const hpconf = game.settings.get(\"ffd20\", \"healthConfig\").variants;\n      const wtUsage = this.type === \"npc\" ? hpconf.npc.useWoundThresholds : hpconf.pc.useWoundThresholds;\n      if (wtUsage > 0) {\n        const wtData = this.getWoundThresholdData(actorData);\n\n        if (wtData.level > 0) {\n          const changeFlatKeys = [\"~attackCore\", \"cmd\", \"init\", \"allSavingThrows\", \"ac\", \"skills\", \"abilityChecks\"];\n          for (const fk of changeFlatKeys) {\n            const flats = getChangeFlat.call(this, fk, \"penalty\");\n            for (const k of flats) {\n              if (!k) continue;\n              sourceDetails[k].push({\n                name: game.i18n.localize(ffd20.config.woundThresholdConditions[wtData.level]),\n                value: -wtData.penalty,\n              });\n            }\n          }\n        }\n      }\n    }\n\n    // Add extra data\n    const rollData = this.getRollData();\n    for (const [changeTarget, changeGrp] of Object.entries(extraData)) {\n      for (const grp of Object.values(changeGrp)) {\n        if (grp.length > 0) {\n          sourceDetails[changeTarget] = sourceDetails[changeTarget] || [];\n          for (const src of grp) {\n            if (!src.operator) src.operator = \"add\";\n            const srcInfo = this.constructor._translateSourceInfo(src.type, src.subtype, src.name);\n            let srcValue =\n              src.value != null\n                ? src.value\n                : RollPF.safeRoll(src.formula || \"0\", rollData, [changeTarget, src, this], {\n                    suppressError: !this.testUserPermission(game.user, \"OWNER\"),\n                  }).total;\n            if (src.operator === \"set\") srcValue = game.i18n.format(\"FFD20.SetTo\", { value: srcValue });\n            if (!(src.operator === \"add\" && srcValue === 0) || src.ignoreNull === false) {\n              sourceDetails[changeTarget].push({\n                name: srcInfo.replace(/[[\\]]/g, \"\"),\n                modifier: src.modifier || \"\",\n                value: srcValue,\n              });\n            }\n          }\n        }\n      }\n    }\n\n    this.sourceDetails = sourceDetails;\n  }\n\n  _getInherentTotalsKeys() {\n    // Determine base keys\n    const keys = {\n      \"attributes.ac.normal.total\": 10,\n      \"attributes.ac.touch.total\": 10,\n      \"attributes.ac.flatFooted.total\": 10,\n      \"attributes.bab.total\": 0,\n      \"attributes.bab.value\": 0,\n      \"attributes.cmd.total\": 10,\n      \"attributes.cmd.flatFootedTotal\": 10,\n      \"attributes.acp.armorBonus\": 0,\n      \"attributes.acp.shieldBonus\": 0,\n      \"attributes.acp.gear\": 0,\n      \"attributes.acp.encumbrance\": 0,\n      \"attributes.acp.total\": 0,\n      \"attributes.acp.attackPenalty\": 0,\n      \"attributes.maxDexBonus\": null,\n      \"ac.normal.total\": 0,\n      \"ac.normal.base\": 0,\n      \"ac.normal.enh\": 0,\n      \"ac.normal.misc\": 0,\n      \"ac.natural.total\": 0,\n      \"ac.natural.base\": 0,\n      \"ac.natural.misc\": 0,\n      \"ac.natural.enh\": 0,\n      \"ac.shield.total\": 0,\n      \"ac.shield.base\": 0,\n      \"ac.shield.enh\": 0,\n      \"ac.shield.misc\": 0,\n      \"attributes.sr.total\": 0,\n      \"attributes.init.bonus\": 0,\n      \"attributes.init.total\": 0,\n      \"attributes.cmb.bonus\": 0,\n      \"attributes.cmb.total\": 0,\n      \"attributes.cmb.value\": 0,\n      \"attributes.hp.max\": this.system.attributes.hp.base ?? 0,\n      \"attributes.vigor.max\": this.system.attributes.vigor.base ?? 0,\n      \"attributes.wounds.max\": this.system.attributes.wounds.base ?? 0,\n      \"attributes.mp.max\": this.system.attributes.mp.base ?? 0,\n      \"attributes.attack.general\": 0,\n      \"attributes.attack.melee\": 0,\n      \"attributes.attack.ranged\": 0,\n      \"attributes.attack.critConfirm\": 0,\n      \"attributes.mDex\": { armorBonus: 0, shieldBonus: 0 },\n      \"attributes.damage.general\": 0,\n      \"attributes.damage.weapon\": 0,\n      \"attributes.damage.spell\": 0,\n      \"attributes.damage.shared\": 0,\n      \"attributes.woundThresholds.level\": 0,\n      \"attributes.woundThresholds.mod\": 0,\n      \"attributes.woundThresholds.override\": -1,\n      \"attributes.woundThresholds.penaltyBase\": 0,\n      \"attributes.woundThresholds.penalty\": 0,\n      \"abilities.str.checkMod\": 0,\n      \"abilities.dex.checkMod\": 0,\n      \"abilities.con.checkMod\": 0,\n      \"abilities.int.checkMod\": 0,\n      \"abilities.wis.checkMod\": 0,\n      \"abilities.cha.checkMod\": 0,\n      \"attributes.spells.spellbooks.primary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.secondary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.tertiary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.quaternary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.spelllike.concentration.total\": 0,\n      \"attributes.spells.spellbooks.primary.cl.total\": 0,\n      \"attributes.spells.spellbooks.secondary.cl.total\": 0,\n      \"attributes.spells.spellbooks.tertiary.cl.total\": 0,\n      \"attributes.spells.spellbooks.quaternary.cl.total\": 0,\n      \"attributes.spells.spellbooks.spelllike.cl.total\": 0,\n      \"details.carryCapacity.bonus.total\": 0,\n      \"details.carryCapacity.multiplier.total\": 0,\n    };\n\n    // Determine skill keys\n    try {\n      const skillKeys = getChangeFlat.call(this, \"skills\");\n      for (const k of skillKeys) {\n        keys[k.replace(/^system\\./, \"\")] = 0;\n      }\n    } catch (err) {\n      console.error(\"Could not determine skills for an actor\", this);\n    }\n\n    return keys;\n  }\n\n  _resetInherentTotals() {\n    const keys = this._getInherentTotalsKeys();\n\n    // Reset totals\n    for (const [k, v] of Object.entries(keys)) {\n      try {\n        setProperty(this.system, k, v);\n      } catch (err) {\n        console.log(err, k);\n      }\n    }\n  }\n\n  /**\n   * Return reduced movement speed.\n   *\n   * @param {number} value - The non-reduced movement speed.\n   * @returns {number} The reduced movement speed.\n   */\n  static getReducedMovementSpeed(value) {\n    return value - Math.floor(value / 5 / 3) * 5;\n  }\n\n  /**\n   * Return increased amount of spell slots by ability score modifier.\n   *\n   * @param {number} mod - The associated ability modifier.\n   * @param {number} level - Spell level.\n   * @returns {number} Amount of spell levels to increase.\n   */\n  static getSpellSlotIncrease(mod, level) {\n    if (level === 0) return 0;\n    if (mod <= 0) return 0;\n    return Math.max(0, Math.ceil((mod + 1 - level) / 4));\n  }\n\n  /**\n   * Return the amount of experience required to gain a certain character level.\n   *\n   * @abstract\n   * @param {number} level The desired level\n   * @returns {number} The XP required\n   */\n  getLevelExp(level) {\n    return 0; // Only used by PCs\n  }\n\n  /* -------------------------------------------- */\n\n  /* -------------------------------------------- */\n  /*  Socket Listeners and Handlers\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    this._syncTokenImage(changed);\n\n    if (!changed.system) return; // No system updates.\n\n    const oldData = this.system;\n\n    // Offset HP values\n    const attributes = changed.system.attributes;\n    if (this._initialized && attributes != undefined) {\n      for (const key of [\"hp\", \"wounds\", \"vigor\"]) {\n        const hp = attributes[key];\n        if (!hp) continue;\n        if (hp.value !== undefined && hp.offset === undefined) {\n          const max = hp.max ?? oldData.attributes[key]?.max;\n          hp.offset = hp.value - max;\n        }\n      }\n    }\n\n    // Apply changes in Actor size to Token width/height\n    const newSize = changed.system.traits?.size;\n    if (newSize !== undefined && oldData.traits.size !== undefined) {\n      const size = ffd20.config.tokenSizes[newSize];\n      if (!this.isToken && !this.prototypeToken.flags?.ffd20?.staticSize) {\n        if (!changed.token) changed.token = {};\n        changed.token.width = size.w;\n        changed.token.height = size.h;\n        changed.token.scale = size.scale;\n      }\n    }\n\n    // Make certain variables absolute\n    const abilities = changed.system.abilities;\n    if (abilities) {\n      const absoluteKeys = [\"userPenalty\", \"damage\", \"drain\"];\n      const keys = Object.keys(abilities);\n      for (const abl of keys) {\n        for (const absKey of absoluteKeys) {\n          if (abilities[abl][absKey] !== undefined) {\n            abilities[abl][absKey] = Math.abs(abilities[abl][absKey]);\n          }\n        }\n      }\n    }\n\n    const energyDrain = changed.system.attributes?.energyDrain;\n    if (energyDrain !== undefined) {\n      changed.system.attributes.energyDrain = Math.abs(energyDrain);\n    }\n\n    // Make only 1 fear or fatigue condition active at most\n    const conditions = changed.system.attributes?.conditions;\n    if (conditions) {\n      const keys = Object.keys(conditions);\n      for (const conditionGroup of Object.values(ffd20.config.conditionTracks)) {\n        const conditionKey = keys.find((condition) => conditionGroup.includes(condition));\n        if (!conditionKey) continue;\n        for (const key of conditionGroup) {\n          if (key !== conditionKey) {\n            conditions[`-=${key}`] = null;\n          }\n        }\n      }\n    }\n\n    // Update experience\n    this._updateExp(changed);\n  }\n\n  /**\n   * Sync images in _preUpdate when moving away from default\n   *\n   * @param {object} update Update data\n   */\n  _syncTokenImage(update) {\n    // No image update\n    if (!update.img) return;\n    // Explicit token image update\n    if (update.prototypeToken?.texture?.src !== undefined) return;\n    // Old token image mismatch with default\n    if (this.prototypeToken.texture.src !== ffd20.config.defaultIcons.actors[this.type]) return;\n    // Portrait and token image mismatch\n    if (this.img !== this.prototypeToken.texture.src) return;\n\n    this.updateSource({ \"prototypeToken.texture.src\": update.img });\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    // No system data updated\n    if (!changed.system) return;\n\n    const sourceUser = game.user.id === userId;\n\n    let initializeVision = false,\n      refreshLighting = false;\n\n    if (hasProperty(changed.system, \"attributes.conditions\")) {\n      if (game.user.id === userId) this.toggleConditionStatusIcons({ render: false });\n    } else if (hasProperty(changed.system, \"traits.senses\")) {\n      initializeVision = true;\n      if (changed.system.traits.senses.ll) {\n        refreshLighting = true;\n      }\n    } else if (changed.flags?.ffd20?.visionPermissions) {\n      initializeVision = true;\n      refreshLighting = true;\n    }\n\n    if (initializeVision || refreshLighting) {\n      if (this.testUserPermission(game.user, \"OBSERVER\")) {\n        const visionUpdate = {\n          refreshLighting: true,\n          refreshVision: true,\n        };\n\n        // Ensure vision immediately updates\n        if (initializeVision) {\n          for (const token of this.getActiveTokens(false, true)) {\n            token._syncSenses();\n          }\n          visionUpdate.initializeVision = true;\n        }\n\n        // Ensure LLV functions correctly\n        if (refreshLighting) {\n          visionUpdate.initializeLighting = true;\n        }\n\n        canvas.perception.update(visionUpdate, true);\n      }\n    }\n\n    // Resize token(s)\n    const sizeKey = changed.system.traits?.size;\n    if (sourceUser && sizeKey) {\n      const size = CONFIG.FFD20.tokenSizes[sizeKey];\n      const tokens = this.getActiveTokens(false, true).filter((token) => !token.getFlag(\"ffd20\", \"staticSize\"));\n\n      const scene = tokens[0]?.object.scene;\n      scene?.updateEmbeddedDocuments(\n        \"Token\",\n        tokens.map((t) => ({\n          _id: t.id,\n          width: size.w,\n          height: size.h,\n          texture: { scaleX: size.scale, scaleY: size.scale },\n        }))\n      );\n    }\n  }\n\n  /**\n   * @override\n   * @param {\"Item\"|\"ActiveEffect\"} embeddedName\n   * @param {Item[]|ActiveEffect[]} documents\n   * @param {*} result\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onCreateEmbeddedDocuments(embeddedName, documents, result, options, userId) {\n    super._onCreateEmbeddedDocuments(...arguments);\n\n    if (userId === game.user.id && embeddedName === \"Item\") {\n      // Creating anything but active buffs should not prompt toggling conditions\n      if (documents.some((item) => item.type === \"buff\" && item.isActive)) {\n        this.toggleConditionStatusIcons({ render: false });\n      }\n\n      // Apply race size to actor\n      const race = documents.find((d) => d.type === \"race\");\n      if (race?.system.size) {\n        if (this.system.traits.size !== race.system.size) this.update({ \"system.traits.size\": race.system.size });\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {\"Item\"|\"ActiveEffect\"} embeddedName\n   * @param {Item[]|ActiveEffect[]} documents\n   * @param {*} result\n   * @param {object} context\n   * @param {string} userId\n   */\n  _onUpdateEmbeddedDocuments(embeddedName, documents, result, context, userId) {\n    super._onUpdateEmbeddedDocuments(embeddedName, documents, result, context, userId);\n\n    if (userId === game.user.id && embeddedName === \"Item\") {\n      // Toggle conditions only if updated items included buffs and the buff's active state was changed\n      if (\n        documents.some(\n          (item) => item.type === \"buff\" && result.some((ri) => ri._id == item.id && ri.system?.active !== undefined)\n        )\n      ) {\n        this.toggleConditionStatusIcons({ render: false });\n      }\n    }\n  }\n\n  updateItemResources(item) {\n    if (item.isCharged) {\n      if (item.isSingleUse) return false;\n\n      const itemTag = !item.system.useCustomTag ? createTag(item.name) : item.system.tag;\n\n      const res = {\n        value: item.charges,\n        max: item.maxCharges,\n        _id: item.id,\n      };\n      this.system.resources[itemTag] = res;\n      return true;\n    }\n\n    return false;\n  }\n\n  /* -------------------------------------------- */\n  /*  Rolls                                       */\n  /* -------------------------------------------- */\n\n  async createAttackFromWeapon(item) {\n    if (item.type !== \"weapon\") throw new Error(\"Wrong Item type\");\n\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const srcData = item.toObject().system;\n\n    // Get attack template\n    const attackItem = {\n      name: item.name,\n      type: \"attack\",\n      img: item.img,\n      system: {\n        subType: \"weapon\",\n        held: srcData.held,\n        masterwork: srcData.masterwork,\n        proficient: srcData.proficient,\n        enh: srcData.enh,\n        broken: srcData.broken,\n        baseTypes: srcData.baseTypes,\n        tags: srcData.tags,\n        weaponGroups: srcData.weaponGroups,\n        actions: deepClone(srcData.actions ?? []),\n      },\n    };\n\n    // Add ensure action IDs are correct and unique\n    for (const action of attackItem.system.actions) {\n      action._id = randomID(16);\n    }\n\n    // Create attack\n    const [newItem] = await this.createEmbeddedDocuments(\"Item\", [attackItem]);\n    if (!newItem) throw new Error(\"Failed to create attack from weapon\");\n\n    // Create link\n    await item.createItemLink(\"children\", \"data\", newItem, newItem.id);\n\n    // Notify user\n    ui.notifications.info(game.i18n.format(\"FFD20.NotificationCreatedAttack\", { item: item.name }));\n\n    // Disable quick use of weapon\n    await item.update({ \"system.showInQuickbar\": false });\n\n    return newItem;\n  }\n\n  /**\n   * Enable and configure a new spellbook.\n   *\n   * @param {object} [casting] Book casting configuration\n   * @param {\"prepared\"|\"spontaneous\"|\"hybrid\"} [casting.type=\"prepared\"] Spellbook type\n   * @param {\"high\"|\"med\"|\"low\"} [casting.progression=\"high\"] Casting progression type\n   * @param {string} [casting.ability=\"int\"] Spellcasting ability score ID\n   * @param {\"arcane\"|\"divine\"|\"psychic\"|\"alchemy\"} [casting.spells=\"arcane\"] Spell/spellcasting type\n   * @param {string} [casting.class=\"_hd\"] Class tag\n   * @param {boolean} [casting.cantrips=true] Has cantrips?\n   * @param {number} [casting.domainSlots=1] Number of domain slots.\n   * @returns {Promise<this>} Promise to updated document\n   */\n  createSpellbook(casting = {}) {\n    const books = this.system.attributes.spells.spellbooks ?? {};\n    const oldBook = casting.class\n      ? Object.entries(books).find(([_, book]) => !!book.class && book.class === casting.class)\n      : null;\n\n    let bookId;\n    if (oldBook) {\n      if (oldBook[1].inUse) return void ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorSpellbookExists\"));\n      bookId = oldBook[0]; // Reuse old book\n    } else {\n      const available = Object.entries(books).find(([bookId, bookData]) => bookData.inUse !== true);\n      if (available === undefined) return void ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorNoFreeSpellbooks\"));\n      bookId = available[0];\n    }\n\n    // Add defaults when unconfigured\n    // `class` causes problems if destructured, hence why it is here.\n    casting.type ??= \"prepared\";\n    casting.class ??= \"_hd\";\n    casting.progression ??= \"high\";\n    casting.spells ??= \"arcane\";\n    casting.ability ??= \"int\";\n    casting.cantrips ??= true;\n    casting.domainSlots ??= 1;\n\n    const updateData = {\n      [`system.attributes.spells.spellbooks.${bookId}`]: {\n        inUse: true,\n        class: casting.class,\n        spellPreparationMode: casting.type,\n        casterType: casting.progression,\n        ability: casting.ability,\n        psychic: casting.spells === \"psychic\",\n        arcaneSpellFailure: casting.spells === \"arcane\",\n        hasCantrips: casting.cantrips,\n        domainSlotValue: casting.domainSlots,\n      },\n    };\n\n    return this.update(updateData);\n  }\n\n  /* -------------------------------------------- */\n\n  getSkillInfo(skillId, { rollData } = {}) {\n    let skill, skillName, parentSkill;\n    const [mainSkillId, subSkillDelim, subSkillId] = skillId.split(\".\", 3),\n      isSubSkill = subSkillDelim === \"subSkills\" && !!subSkillId,\n      mainSkill = this.system.skills[mainSkillId];\n    if (!mainSkill) throw new Error(`Invalid skill ID '${skillId}'`);\n\n    if (isSubSkill) {\n      skill = mainSkill.subSkills[subSkillId];\n      if (!skill) throw new Error(`Invalid skill ID '${skillId}'`);\n      skillName = `${ffd20.config.skills[mainSkillId]} (${skill.name})`;\n      parentSkill = this.getSkillInfo(mainSkillId);\n    } else {\n      skill = mainSkill;\n      skillName = skill.name ?? ffd20.config.skills[skillId];\n    }\n\n    rollData ??= this.getRollData();\n    const dataSkill = getProperty(rollData.skills, skillId);\n    if (!dataSkill) throw new Error(`Invalid skill ID '${skillId}'`);\n\n    const result = deepClone(dataSkill);\n    result.name = skillName;\n    result.id = skillId;\n    if (parentSkill) result.parentSkill = parentSkill;\n    return result;\n  }\n\n  /**\n   * Roll a Skill Check\n   *\n   * @param {string} skillId      The skill id (e.g. \"per\", or \"prf.subSkills.prf1\")\n   * @param {ActorRollOptions} [options={}]      Options which configure how the skill check is rolled\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollSkill(skillId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const skl = this.getSkillInfo(skillId);\n\n    const skillMatch = /^(?<mainSkillId>\\w+).subSkills.(?<subSkillId>\\w+)$/.exec(skillId);\n    const { mainSkillId, subSkillId } = skillMatch?.groups ?? {};\n    const haveParentSkill = !!subSkillId;\n\n    // Add contextual attack string\n    const rollData = this.getRollData();\n    const noteObjects = this.getContextNotes(`skill.${skillId}`);\n    if (haveParentSkill) noteObjects.push(...this.getContextNotes(`skill.${mainSkillId}`));\n    const notes = this.formatContextNotes(noteObjects, rollData);\n\n    // Add untrained note\n    if (skl.rt && !skl.rank) {\n      notes.push(game.i18n.localize(\"FFD20.Untrained\"));\n    }\n\n    // Gather changes\n    const parts = [];\n    const changes = getHighestChanges(\n      this.changes.filter((c) => {\n        const cf = getChangeFlat.call(this, c.subTarget, c.modifier);\n\n        if (haveParentSkill && cf.includes(`system.skills.${mainSkillId}.changeBonus`)) return true;\n        return cf.includes(`system.skills.${skillId}.changeBonus`);\n      }),\n      { ignoreTarget: true }\n    );\n\n    // Add ability modifier\n    if (skl.ability) {\n      parts.push(`@abilities.${skl.ability}.mod[${ffd20.config.abilities[skl.ability]}]`);\n    }\n\n    // Add rank\n    if (skl.rank > 0) {\n      parts.push(`${skl.rank}[${game.i18n.localize(\"FFD20.SkillRankPlural\")}]`);\n      if (skl.cs) {\n        parts.push(`${ffd20.config.classSkillBonus}[${game.i18n.localize(\"FFD20.CSTooltip\")}]`);\n      }\n    }\n\n    // Add armor check penalty\n    if (skl.acp && rollData.attributes.acp.total !== 0) {\n      parts.push(`-@attributes.acp.total[${game.i18n.localize(\"FFD20.ACPLong\")}]`);\n    }\n\n    // Add Wound Thresholds info\n    if (rollData.attributes.woundThresholds?.penalty > 0) {\n      parts.push(\n        `- @attributes.woundThresholds.penalty[${game.i18n.localize(\n          ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]\n        )}]`\n      );\n    }\n\n    // Add changes\n    for (const c of changes) {\n      if (!c.value) continue;\n      // Hide complex change formulas in parenthesis.\n      if (typeof c.value === \"string\" && RollPF.parse(c.value).length > 1) {\n        parts.push(`(${c.value})[${c.flavor}]`);\n      } else {\n        parts.push(`${c.value}[${c.flavor}]`);\n      }\n    }\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.SkillCheck\", { skill: skl.name }),\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      compendium: { entry: ffd20.config.skillCompendiumEntries[skillId] ?? skl.journal, type: \"JournalEntry\" },\n      subject: { skill: skillId },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollSkill\", this, rollOptions, skillId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    if (result) Hooks.callAll(\"pf1ActorRollSkill\", this, result, skillId);\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Roll a 1d20 adding the actor's BAB\n   *\n   * @param {ActorRollOptions} [options]\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollBAB(options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts: [`${this.system.attributes.bab.total}[${game.i18n.localize(\"FFD20.BABAbbr\")}]`],\n      subject: { core: \"bab\" },\n      flavor: game.i18n.localize(\"FFD20.BAB\"),\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollBab\", this, rollOptions) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollBab\", this, result);\n    return result;\n  }\n\n  /**\n   * Roll a basic CMB check for this actor\n   *\n   * @param {ActorRollOptions & {ranged: boolean, ability: string | null}} [options={}]\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollCMB(options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    options.ranged ??= false;\n    options.ability ??= null;\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const noteObjects = this.getContextNotes(\"misc.cmb\");\n    const notes = this.formatContextNotes(noteObjects, rollData);\n\n    const parts = [];\n\n    const describePart = (value, label) => parts.push(`${value}[${label}]`);\n    const srcDetails = (s) => s?.reverse().forEach((d) => describePart(d.value, d.name, -10));\n    srcDetails(this.sourceDetails[\"system.attributes.cmb.bonus\"]);\n    srcDetails(this.sourceDetails[\"system.attributes.attack.shared\"]);\n\n    const size = this.system.traits.size ?? \"med\";\n    rollData.sizeBonus = ffd20.config.sizeSpecialMods[size];\n    if (rollData.sizeBonus != 0) parts.push(`@sizeBonus[${game.i18n.localize(\"FFD20.Size\")}]`);\n\n    const changeSources = [\"attack\"];\n    if (options.ranged === true) changeSources.push(\"rattack\");\n    else changeSources.push(\"mattack\");\n    const effectiveChanges = getHighestChanges(\n      this.changes.filter((c) => changeSources.includes(c.subTarget)),\n      { ignoreTarget: true }\n    );\n    effectiveChanges.forEach((ic) => describePart(ic.value, ic.flavor));\n\n    const abl = options.ability ?? this.system.attributes.cmbAbility;\n    const ablMod = this.system.abilities[abl]?.mod ?? 0;\n    if (ablMod != 0) describePart(ablMod, ffd20.config.abilities[abl]);\n\n    // Add grapple note\n    if (this.system.attributes.conditions.grappled) {\n      notes.push(\"+2 to Grapple\");\n    }\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      subject: { core: \"cmb\" },\n      flavor: game.i18n.localize(\"FFD20.CMB\"),\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollCmb\", this, rollOptions) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollCmb\", this, result);\n    return result;\n  }\n\n  /**\n   * Roll a generic attack\n   *\n   * @param {ActorRollOptions & {melee?: boolean}} [options={}]\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollAttack(options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Default to melee attacks\n    options.melee ??= true;\n\n    const sources = [\n      ...this.sourceDetails[\"system.attributes.attack.shared\"],\n      // ...this.sourceDetails[\"system.attributes.attack.general\"],\n      // ...this.sourceDetails[`system.attributes.attack.${options.melee ? \"melee\" : \"ranged\"}`],\n    ];\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const noteObjects = [...this.getContextNotes(\"attacks.effect\"), ...this.getContextNotes(\"attacks.attack\")];\n    const notes = this.formatContextNotes(noteObjects, rollData);\n    rollData.item = {};\n\n    const changes = sources\n      .filter((item) => Number.isInteger(item.value))\n      .map((i) => {\n        return `${i.value}[${i.name}]`;\n      });\n\n    // Add attack bonuses from changes\n    const attackTargets = [\"attack\"].concat(options.melee ? [\"mattack\"] : [\"rattack\"]);\n    const attackChanges = this.changes.filter((c) => {\n      return attackTargets.includes(c.subTarget);\n    });\n    changes.push(\n      ...attackChanges.map((c) => {\n        c.applyChange(this);\n        return `${c.value}[${c.parent ? c.parent.name : c.data.modifier}]`;\n      })\n    );\n\n    // Add ability modifier\n    const atkAbl = this.system.attributes?.attack?.[`${options.melee ? \"melee\" : \"ranged\"}Ability`];\n    changes.push(`${this.system.abilities[atkAbl].mod}[${ffd20.config.abilities[atkAbl]}]`);\n\n    const size = this.system.traits.size ?? \"med\";\n    rollData.sizeBonus = ffd20.config.sizeMods[size];\n    if (rollData.sizeBonus != 0) changes.push(`@sizeBonus[${game.i18n.localize(\"FFD20.Size\")}]`);\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts: changes,\n      rollData,\n      subject: { core: \"attack\" },\n      flavor: game.i18n.localize(`FFD20.${options.melee ? \"Melee\" : \"Ranged\"}`),\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollAttack\", this, rollOptions) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollAttack\", this, result);\n    return result;\n  }\n\n  /**\n   * Roll a Caster Level check using a particular spellbook of this actor\n   *\n   * @param {string} bookId Spellbook identifier\n   * @param {ActorRollOptions} [options={}] Roll options\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollCL(bookId, options = {}) {\n    const spellbook = this.system.attributes.spells.spellbooks[bookId];\n    const rollData = duplicate(this.getRollData());\n    rollData.cl = spellbook.cl.total;\n\n    // Set up roll parts\n    const parts = [];\n\n    const describePart = (value, label) => parts.push(`${value}[${label}]`);\n    const srcDetails = (s) => s?.reverse().forEach((d) => describePart(d.value, d.name, -10));\n    srcDetails(this.sourceDetails[`system.attributes.spells.spellbooks.${bookId}.cl.total`]);\n\n    // Add contextual caster level string\n    const notes = this.getContextNotesParsed(`spell.cl.${bookId}`);\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) notes.push(game.i18n.localize(ffd20.config.woundThresholdConditions[wT.level]));\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      subject: { core: \"cl\", spellbook: bookId },\n      flavor: game.i18n.localize(\"FFD20.CasterLevelCheck\"),\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollCl\", this, rollOptions, bookId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollCl\", this, result, bookId);\n    return result;\n  }\n\n  /**\n   * Roll a concentration check using a particular spellbook of this actor\n   *\n   * @param {string} bookId Spellbook identifier\n   * @param {ActorRollOptions} [options={}] Roll options\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollConcentration(bookId, options = {}) {\n    const spellbook = this.system.attributes.spells.spellbooks[bookId];\n    const rollData = duplicate(this.getRollData());\n    rollData.cl = spellbook.cl.total;\n    rollData.mod = this.system.abilities[spellbook.ability]?.mod ?? 0;\n\n    if (\n      Hooks.call(\"actorRoll\", \"pf1PreActorRollConcentration\", undefined, this, \"concentration\", bookId, options) ===\n      false\n    )\n      return;\n\n    // Set up roll parts\n    const parts = [];\n\n    const describePart = (value, label) => parts.push(`${value}[${label}]`);\n    const srcDetails = (s) => s?.reverse().forEach((d) => describePart(d.value, d.name, -10));\n    srcDetails(this.sourceDetails[`system.attributes.spells.spellbooks.${bookId}.concentration.total`]);\n\n    // Add contextual concentration string\n    const notes = this.getContextNotesParsed(`spell.concentration.${bookId}`);\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) notes.push(game.i18n.localize(ffd20.config.woundThresholdConditions[wT.level]));\n    // TODO: Make the penalty show separate of the CL.total.\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    let formulaRoll = 0;\n    if (spellbook.concentrationFormula.length)\n      formulaRoll = RollPF.safeRoll(spellbook.concentrationFormula, rollData).total;\n    rollData.formulaBonus = formulaRoll;\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      subject: { core: \"concentration\", spellbook: bookId },\n      flavor: game.i18n.localize(\"FFD20.ConcentrationCheck\"),\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollConcentration\", this, rollOptions, bookId) === false) return;\n    const result = ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollConcentration\", this, result, bookId);\n    return result;\n  }\n\n  /**\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.damageResistances=true] If false, damage resistances (DR, ER) are omitted.\n   * @param {boolean} [options.damageVulnerabilities=true] If false, damage vulnerabilities are omitted.\n   */\n  getDefenseHeaders({ damageResistances = true, damageVulnerabilities = true } = {}) {\n    const actorData = this.system;\n    const headers = [];\n\n    const reSplit = ffd20.config.re.traitSeparator;\n    const misc = [];\n    const damageTypes = ffd20.registry.damageTypes.getLabels();\n\n    if (damageResistances) {\n      // Damage reduction\n      if (actorData.traits.dr.length) {\n        headers.push({ header: game.i18n.localize(\"FFD20.DamRed\"), value: actorData.traits.dr.split(reSplit) });\n      }\n      // Energy resistance\n      if (actorData.traits.eres.length) {\n        headers.push({ header: game.i18n.localize(\"FFD20.EnRes\"), value: actorData.traits.eres.split(reSplit) });\n      }\n    }\n    if (damageVulnerabilities) {\n      // Damage vulnerabilities\n      if (actorData.traits.dv.value.length || actorData.traits.dv.custom.length) {\n        const value = [].concat(\n          actorData.traits.dv.value.map((obj) => damageTypes[obj]),\n          actorData.traits.dv.custom.length > 0 ? actorData.traits.dv.custom.split(\";\") : []\n        );\n        headers.push({ header: game.i18n.localize(\"FFD20.DamVuln\"), value: value });\n      }\n    }\n    // Condition resistance\n    if (actorData.traits.cres.length) {\n      headers.push({ header: game.i18n.localize(\"FFD20.ConRes\"), value: actorData.traits.cres.split(reSplit) });\n    }\n    // Immunities\n    if (\n      actorData.traits.di.value.length ||\n      actorData.traits.di.custom.length ||\n      actorData.traits.ci.value.length ||\n      actorData.traits.ci.custom.length\n    ) {\n      const value = [].concat(\n        actorData.traits.di.value.map((obj) => damageTypes[obj]),\n        actorData.traits.di.custom.length > 0 ? actorData.traits.di.custom.split(\";\") : [],\n        actorData.traits.ci.value.map((obj) => {\n          return ffd20.config.conditionTypes[obj];\n        }),\n        actorData.traits.ci.custom.length > 0 ? actorData.traits.ci.custom.split(\";\") : []\n      );\n      headers.push({ header: game.i18n.localize(\"FFD20.ImmunityPlural\"), value: value });\n    }\n    // Spell Resistance\n    if (actorData.attributes.sr.total > 0) {\n      misc.push(game.i18n.format(\"FFD20.SpellResistanceNote\", { value: actorData.attributes.sr.total }));\n    }\n\n    if (misc.length > 0) {\n      headers.push({ header: game.i18n.localize(\"FFD20.MiscShort\"), value: misc });\n    }\n\n    return headers;\n  }\n\n  getInitiativeContextNotes() {\n    const notes = this.getContextNotes(\"misc.init\").reduce((arr, o) => {\n      for (const n of o.notes) arr.push(...n.split(/[\\n\\r]+/));\n      return arr;\n    }, []);\n\n    let notesHTML;\n    if (notes.length > 0) {\n      // Format notes if they're present\n      const notesHTMLParts = [];\n      notes.forEach((note) => notesHTMLParts.push(`<span class=\"tag\">${note}</span>`));\n      notesHTML =\n        '<div class=\"flexcol property-group gm-sensitive\"><label>' +\n        game.i18n.localize(\"FFD20.Notes\") +\n        '</label> <div class=\"flexrow tag-list\">' +\n        notesHTMLParts.join(\"\") +\n        \"</div></div>\";\n    }\n\n    return [notes, notesHTML];\n  }\n\n  /**\n   * Roll initiative for one or multiple Combatants associated with this actor.\n   * If no combat exists, GMs have the option to create one.\n   * If viewing a full Actor document, all Tokens which map to that actor will be targeted for initiative rolls.\n   * If viewing a synthetic Token actor, only that particular Token will be targeted for an initiative roll.\n   *\n   * @override\n   * @see {@link ffd20.documents.CombatPF#rollInitiative}\n   * @param {object} [options={}] Options which configure how initiative is rolled\n   * @param {boolean} [options.createCombatants=false] - Create new Combatant entries for tokens associated with this actor.\n   * @param {boolean} [options.rerollInitiative=false] - Reroll initiative for existing Combatants\n   * @param {string|null} [options.dice=null] - Formula override for dice to roll\n   * @param {string|null} [options.bonus=null] - Formula for bonus to initiative\n   * @param {boolean} [options.skipDialog] - Skip roll dialog\n   * @param {string} [options.rollMode] - Roll mode override\n   * @returns {Promise<ffd20.documents.CombatPF|null>} The updated Combat document in which initiative was rolled, or null if no initiative was rolled\n   */\n  async rollInitiative({\n    createCombatants = false,\n    rerollInitiative = false,\n    initiativeOptions = {},\n    dice = null,\n    bonus = null,\n    rollMode = null,\n    skipDialog,\n  } = {}) {\n    // Obtain (or create) a combat encounter\n    let combat = game.combat;\n    if (!combat) {\n      if (game.user.isGM) {\n        const cls = getDocumentClass(\"Combat\");\n        combat = await cls.create({ scene: canvas.scene?.id, active: true });\n      } else {\n        ui.notifications.warn(\"COMBAT.NoneActive\", { localize: true });\n        return null;\n      }\n    }\n\n    // Create new combatants\n    if (createCombatants) {\n      const tokens = this.isToken ? [this.token] : this.getActiveTokens().map((t) => t.document);\n      const toCreate = [];\n      if (tokens.length) {\n        for (const t of tokens) {\n          if (t.inCombat) continue;\n          toCreate.push({ tokenId: t.id, sceneId: t.parent.id, actorId: this.id, hidden: t.hidden });\n        }\n      } else toCreate.push({ actorId: this.id, hidden: false });\n      await combat.createEmbeddedDocuments(\"Combatant\", toCreate);\n    }\n\n    // Roll initiative for combatants\n    const combatants = combat.combatants\n      .filter((c) => {\n        if (c.actor?.id !== this.id) return false;\n        return rerollInitiative || c.initiative === null;\n      })\n      .map((c) => c.id);\n\n    // No combatants. Possibly from reroll being disabled.\n    if (combatants.length == 0) return combat;\n\n    mergeObject(initiativeOptions, { formula: dice, bonus, rollMode, skipDialog });\n    await combat.rollInitiative(combatants, initiativeOptions);\n    return combat;\n  }\n\n  /**\n   * Roll a specific saving throw\n   *\n   * @param {\"ref\"|\"fort\"|\"will\"} savingThrowId Identifier for saving throw type.\n   * @param {ActorRollOptions} [options={}] Roll options.\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollSavingThrow(savingThrowId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const noteObjects = this.getContextNotes(`savingThrow.${savingThrowId}`);\n    const notes = this.formatContextNotes(noteObjects, rollData);\n\n    const parts = [];\n\n    // Get base\n    const base = this.system.attributes.savingThrows[savingThrowId]?.base;\n    if (base) parts.push(`${base}[${game.i18n.localize(\"FFD20.Base\")}]`);\n\n    // Add changes\n    let changeBonus = [];\n    const changes = this.changes.filter((c) => [\"allSavingThrows\", savingThrowId].includes(c.subTarget));\n    {\n      // Get damage bonus\n      changeBonus = getHighestChanges(\n        changes.filter((c) => {\n          return ![\"set\", \"=\"].includes(c.operator);\n        }),\n        { ignoreTarget: true }\n      ).reduce((cur, c) => {\n        if (c.value)\n          cur.push({\n            value: c.value,\n            source: c.flavor,\n          });\n        return cur;\n      }, []);\n    }\n    for (const c of changeBonus) {\n      parts.push(`${c.value}[${c.source}]`);\n    }\n\n    // Wound Threshold penalty\n    if (rollData.attributes.woundThresholds.penalty > 0) {\n      notes.push(game.i18n.localize(ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]));\n      parts.push(\n        `- @attributes.woundThresholds.penalty[${game.i18n.localize(\n          ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]\n        )}]`\n      );\n    }\n\n    // Roll saving throw\n    const props = this.getDefenseHeaders({ damageResistances: false, damageVulnerabilities: false });\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n    const label = ffd20.config.savingThrows[savingThrowId];\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.SavingThrowRoll\", { save: label }),\n      subject: { save: savingThrowId },\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollSave\", this, rollOptions, savingThrowId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollSave\", this, result, savingThrowId);\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Roll an Ability Test\n   * Prompt the user for input regarding Advantage/Disadvantage and any Situational Bonus\n   *\n   * @param {string} abilityId    The ability ID (e.g. \"str\")\n   * @param {object} [options={}]      Options which configure how ability tests are rolled\n   * @returns {ChatMessage|object|void} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollAbilityTest(abilityId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const noteObjects = this.getContextNotes(`abilityChecks.${abilityId}`);\n    const notes = this.formatContextNotes(noteObjects, rollData);\n\n    const label = ffd20.config.abilities[abilityId];\n    const abl = this.system.abilities[abilityId];\n\n    const parts = [`@abilities.${abilityId}.mod[${label}]`];\n    if (abl.checkMod != 0) {\n      const changes = this.sourceDetails[`system.abilities.${abilityId}.checkMod`];\n      for (const c of changes) parts.push(`${c.value}[${c.name}]`);\n    }\n    if (this.system.attributes.energyDrain) {\n      parts.push(\"-@attributes.energyDrain\");\n    }\n\n    // Wound Threshold penalty\n    if (rollData.attributes.woundThresholds.penalty > 0) {\n      notes.push(game.i18n.localize(ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]));\n      parts.push(\n        `- @attributes.woundThresholds.penalty[${game.i18n.localize(\n          ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level]\n        )}]`\n      );\n    }\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.AbilityTest\", { ability: label }),\n      subject: { ability: abilityId },\n      chatTemplateData: { hasProperties: props.length > 0, properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n    if (Hooks.call(\"pf1PreActorRollAbility\", this, rollOptions, abilityId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollAbility\", this, result, abilityId);\n    return result;\n  }\n\n  /**\n   * Show defenses in chat\n   *\n   * @param {object} [options={}] Additional options\n   * @param {string | null} [options.rollMode=null]   The roll mode to use for the roll; defaults to the user's current preference when `null`.\n   * @param {TokenDocument} [options.token] Relevant token if any.\n   */\n  async displayDefenseCard({ rollMode = null, token } = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n    }\n    const rollData = this.getRollData();\n    const damageTypes = ffd20.registry.damageTypes.getLabels();\n\n    // Add contextual AC notes\n    const acNoteObjects = this.getContextNotes(\"misc.ac\");\n    const acNotes = this.formatContextNotes(acNoteObjects, rollData);\n    if (this.system.attributes.acNotes.length > 0) acNotes.push(...this.system.attributes.acNotes.split(/[\\n\\r]+/));\n\n    // Add contextual CMD notes\n    const cmdNoteObjects = this.getContextNotes(\"misc.cmd\");\n    const cmdNotes = this.formatContextNotes(cmdNoteObjects, rollData);\n    if (this.system.attributes.cmdNotes.length > 0) cmdNotes.push(...this.system.attributes.cmdNotes.split(/[\\n\\r]+/));\n\n    // Add contextual SR notes\n    const srNoteObjects = this.getContextNotes(\"misc.sr\");\n    const srNotes = this.formatContextNotes(srNoteObjects, rollData);\n    if (this.system.attributes.srNotes.length > 0) srNotes.push(...this.system.attributes.srNotes.split(/[\\n\\r]+/));\n\n    // Add misc data\n    const reSplit = ffd20.config.re.traitSeparator;\n    // Damage Reduction\n    let drNotes = [];\n    if (this.system.traits.dr.length) {\n      drNotes = this.system.traits.dr.split(reSplit);\n    }\n    // Energy Resistance\n    const energyResistance = [];\n    if (this.system.traits.eres.length) {\n      energyResistance.push(...this.system.traits.eres.split(reSplit));\n    }\n    // Damage Immunity\n    if (this.system.traits.di.value.length || this.system.traits.di.custom.length) {\n      const values = [\n        ...this.system.traits.di.value.map((obj) => damageTypes[obj]),\n        ...(this.system.traits.di.custom.length > 0 ? this.system.traits.di.custom.split(reSplit) : []),\n      ];\n      energyResistance.push(...values.map((o) => game.i18n.format(\"FFD20.ImmuneTo\", { immunity: o })));\n    }\n    // Damage Vulnerability\n    if (this.system.traits.dv.value.length || this.system.traits.dv.custom.length) {\n      const values = [\n        ...this.system.traits.dv.value.map((obj) => damageTypes[obj]),\n        ...(this.system.traits.dv.custom.length > 0 ? this.system.traits.dv.custom.split(reSplit) : []),\n      ];\n      energyResistance.push(...values.map((o) => game.i18n.format(\"FFD20.VulnerableTo\", { vulnerability: o })));\n    }\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) {\n      const wTlabel = game.i18n.localize(ffd20.config.woundThresholdConditions[wT.level]);\n      acNotes.push(wTlabel);\n      cmdNotes.push(wTlabel);\n    }\n\n    // Get actor's token\n    token ??= this.token;\n\n    // Create message\n    const actorData = this.system;\n    const data = {\n      actor: this,\n      name: token?.name ?? this.name,\n      tokenUuid: token?.uuid ?? null,\n      ac: {\n        normal: actorData.attributes.ac.normal.total,\n        touch: actorData.attributes.ac.touch.total,\n        flatFooted: actorData.attributes.ac.flatFooted.total,\n        notes: acNotes,\n      },\n      cmd: {\n        normal: actorData.attributes.cmd.total,\n        flatFooted: actorData.attributes.cmd.flatFootedTotal,\n        notes: cmdNotes,\n      },\n      misc: {\n        sr: actorData.attributes.sr.total,\n        srNotes: srNotes,\n        drNotes: drNotes,\n        energyResistance: energyResistance,\n      },\n    };\n    // Add regeneration and fast healing\n    if ((actorData.traits?.fastHealing || \"\").length || (actorData.traits?.regen || \"\").length) {\n      data.regen = {\n        regen: actorData.traits.regen,\n        fastHealing: actorData.traits.fastHealing,\n      };\n    }\n\n    setProperty(data, \"flags.ffd20.subject\", \"defenses\");\n\n    const chatData = {\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n      rollMode,\n      flags: {\n        core: {\n          canPopout: true,\n        },\n      },\n    };\n\n    const msg = await createCustomChatMessage(\"systems/ffd20/templates/chat/defenses.hbs\", data, chatData);\n  }\n\n  /**\n   * Easy way to toggle a condition.\n   *\n   * @param {string} conditionId A direct condition identiifer, as per FFD20.conditions, such as `shaken` or `dazed`.\n   * @returns {Promise<this>|undefined} Promise to updated document, or nothing if no update occurs.\n   */\n  async toggleCondition(conditionId) {\n    conditionId = `system.attributes.conditions.${conditionId}`;\n\n    const newStatus = !getProperty(this, conditionId);\n    const deleteKey = conditionId.replace(/(\\w+)$/, (condition) => `-=${condition}`);\n    const updateData = newStatus ? { [conditionId]: true } : { [deleteKey]: null };\n    await this.update(updateData);\n  }\n\n  /**\n   * Easy way to set a condition.\n   *\n   * @param {string} key - A direct condition key, as per FFD20.conditions, such as `shaken` or `dazed`.\n   * @param {boolean} enabled - Whether to enable (true) the condition, or disable (false) it.\n   */\n  async setCondition(key, enabled) {\n    key = `system.attributes.conditions.${key}`;\n\n    const newStatus = !getProperty(this, key);\n    if (newStatus !== enabled) return;\n    const deleteKey = key.replace(/(\\w+)$/, (condition) => `-=${condition}`);\n    const updateData = newStatus ? { [key]: true } : { [deleteKey]: null };\n    await this.update(updateData);\n  }\n\n  /**\n   * Easy way to determine whether this actor has a condition.\n   *\n   * @param {string} conditionId Condition identifier, as per FFD20.conditions, such as `shaken` or `dazed`.\n   * @returns {boolean} Confirmation as boolean.\n   */\n  hasCondition(conditionId) {\n    return this.system.attributes?.conditions?.[conditionId] === true;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Wrapper for the static function, taking this actor as the only target.\n   *\n   * @param {number} value Value to adjust health by.\n   * @param {object} options Additional options.\n   */\n  async applyDamage(value, options = {}) {\n    return this.constructor.applyDamage(\n      value,\n      mergeObject(options, {\n        targets: [this],\n      })\n    );\n  }\n\n  /**\n   * Apply rolled dice damage to the token or tokens which are currently controlled.\n   * This allows for damage to be scaled by a multiplier to account for healing, critical hits, or resistance\n   * If Shift is held, will prompt for adjustments based on damage reduction and energy resistances\n   *\n   * @param {number} value - The amount of damage to deal.\n   * @param {object} [options] - Object containing default settings for overriding\n   * @param {boolean} [options.forceDialog=true] - Forces the opening of a Dialog as if Shift was pressed\n   * @param {string} [options.reductionDefault] - Default value for Damage Reduction\n   * @param {boolean} [options.asNonlethal] - Marks the damage as non-lethal\n   * @param {Array.<Token|Actor>} [options.targets] - Override the targets to apply damage to\n   * @param {number} options.critMult - Critical multiplier as needed for Wounds & Vigor variant health rule. Set to 0 for non-critical hits.\n   * @param {boolean} options.asWounds - Apply damage to wounds directly instead of vigor, as needed for Wounds & Vigor variant health rule.\n   * @returns {Promise}\n   */\n  static async applyDamage(\n    value,\n    {\n      forceDialog = false,\n      reductionDefault = \"\",\n      asNonlethal = false,\n      targets = null,\n      critMult = 0,\n      asWounds = false,\n    } = {}\n  ) {\n    const promises = [];\n    let controlled = canvas.tokens.controlled,\n      healingInvert = 1;\n\n    // Override targets, if supplied\n    if (targets instanceof Array) {\n      controlled = targets.filter((o) => o instanceof Token || o instanceof Actor);\n    }\n\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n\n    const numReg = /(\\d+)/g,\n      sliceReg = /[^,;\\n]*(\\d+)[^,;\\n]*/g,\n      sliceReg2 = /[^,;\\n]+/g;\n\n    const _submit = async function (form, multiplier) {\n      if (form) {\n        value = form.find('[name=\"damage\"]').val();\n        let dR = form.find('[name=\"damage-reduction\"]').val();\n        value = value.length ? RollPF.safeRoll(value, {}, []).total : 0;\n        dR = dR.length ? RollPF.safeRoll(dR, {}, []).total : 0;\n        if (multiplier < 0) {\n          value = Math.ceil(value * multiplier);\n          value = Math.min(value - dR, 0);\n        } else {\n          value = Math.floor(value * (multiplier ?? 1));\n          value = Math.max(value - dR, 0);\n        }\n        const checked = [...form.find(\".tokenAffected:checked\")].map((tok) => tok.name.replace(\"affect.\", \"\"));\n        controlled = controlled.filter((con) => checked.includes(con.id));\n      }\n\n      if (value == 0) return; // Early exit\n\n      for (const t of controlled) {\n        const a = t instanceof Token ? t.actor : t;\n\n        if (!a.isOwner) {\n          ui.notifications.warn(game.i18n.format(\"FFD20.ErrorNoActorPermissionAlt\", { name: this.name }));\n          continue;\n        }\n\n        const actorType = { character: \"pc\", npc: \"npc\" }[a.type];\n        const useWoundsAndVigor = healthConfig.variants[actorType]?.useWoundsAndVigor ?? false,\n          hp = !useWoundsAndVigor ? a.system.attributes.hp : a.system.attributes.vigor,\n          tmp = hp.temp || 0;\n\n        const update = {};\n\n        if (useWoundsAndVigor) {\n          const currentHealth = hp.value;\n          let woundAdjust = 0;\n\n          if (asWounds) {\n            woundAdjust -= value;\n            value = 0;\n          }\n\n          // Temp HP adjustment\n          const dt = value > 0 ? Math.min(tmp, value) : 0;\n          value -= dt;\n\n          // Nonlethal damage\n          if (asNonlethal && value > 0) {\n            // Wounds & Vigor\n            if (currentHealth > 0) {\n              value = Math.min(currentHealth, value);\n            } else {\n              woundAdjust -= critMult > 1 ? critMult : 1;\n              value = 0; // No other bleedover to wounds\n            }\n          }\n\n          // Create update data\n          if (dt != 0) update[\"system.attributes.vigor.temp\"] = tmp - dt;\n          if (value != 0) {\n            let newHP = Math.min(hp.value - value, hp.max);\n            if (value > 0) {\n              if (hp.value > 0) {\n                if (newHP < 0) {\n                  if (critMult > 0) {\n                    woundAdjust -= -newHP;\n                    woundAdjust -= critMult;\n                  }\n                  newHP = 0;\n                }\n              } else {\n                woundAdjust -= value;\n              }\n            }\n\n            if (newHP != hp.value) update[\"system.attributes.vigor.value\"] = newHP;\n          }\n          if (woundAdjust != 0) {\n            const wounds = a.data.attributes.wounds;\n            update[\"system.attributes.wounds.value\"] = Math.clamped(wounds.value + woundAdjust, 0, wounds.max);\n          }\n        }\n        // Normal Hit Points\n        else {\n          // Nonlethal damage\n          let nld = 0;\n          if (asNonlethal && value > 0) {\n            nld = Math.min(hp.max - hp.nonlethal, value);\n            value -= nld;\n          }\n\n          // Temp HP adjustment\n          const dt = value > 0 ? Math.min(tmp, value) : 0;\n\n          // Create update data\n          update[\"system.attributes.hp.nonlethal\"] = hp.nonlethal + nld;\n          update[\"system.attributes.hp.temp\"] = tmp - dt;\n          update[\"system.attributes.hp.value\"] = Math.min(hp.value - (value - dt), hp.max);\n        }\n\n        promises.push(a.update(update));\n      }\n      return Promise.all(promises);\n    };\n\n    if (ffd20.skipConfirmPrompt ? !forceDialog : forceDialog) {\n      if (value < 0) {\n        healingInvert = -1;\n        value = -1 * value;\n      }\n\n      const tokens = controlled.map((tok) => {\n        const isToken = tok instanceof Token;\n        const actor = isToken ? tok.actor : tok;\n\n        const buildResistances = (damage) => {\n          const format = (amount, type, operator, type2) => {\n            let translatedType = type;\n            if (type2) {\n              switch (operator) {\n                case false: {\n                  // Combine with AND\n                  translatedType = game.i18n.format(\n                    \"FFD20.Application.DamageResistanceSelector.CombinationFormattedAnd\",\n                    {\n                      type1: type,\n                      type2: type2,\n                    }\n                  );\n                  break;\n                }\n                default:\n                case true: {\n                  // Combine with OR\n                  translatedType = game.i18n.format(\"FFD20.Application.DamageResistanceSelector.CombinationFormattedOr\", {\n                    type1: type,\n                    type2: type2,\n                  });\n                  break;\n                }\n              }\n            }\n\n            return damage === \"dr\" ? `${amount}/${translatedType}` : `${translatedType} ${amount}`;\n          };\n\n          const resistances = actor.system.traits[damage].value.map((entry) => {\n            const [amount, operator] = [entry.amount, entry.operator];\n            const type1 = ffd20.registry.damageTypes.get(entry.types[0]?.toLowerCase())?.name ?? \"-\";\n            const type2 = ffd20.registry.damageTypes.get(entry.types[1]?.toLowerCase())?.name ?? \"\";\n\n            return format(amount, type1, operator, type2);\n          });\n\n          resistances.push(...(actor.system.traits[damage].custom.match(sliceReg) ?? []));\n\n          return resistances;\n        };\n\n        return {\n          _id: isToken ? tok.id : actor.id,\n          name: isToken ? tok.name : actor.name,\n          isToken,\n          dr: buildResistances(\"dr\"),\n          eres: buildResistances(\"eres\"),\n          di: [...actor.system.traits.di.value, ...(actor.system.traits.di.custom.match(sliceReg2) ?? [])],\n          dv: [...actor.system.traits.dv.value, ...(actor.system.traits.dv.custom.match(sliceReg2) ?? [])],\n          checked: true,\n        };\n      });\n\n      reductionDefault = reductionDefault ?? \"\";\n\n      // Dialog configuration and callbacks\n      const template = \"systems/ffd20/templates/apps/damage-dialog.hbs\";\n      const dialogData = {\n        damage: value,\n        healing: healingInvert == -1 ? true : false,\n        damageReduction: reductionDefault,\n        tokens: tokens,\n        nonlethal: asNonlethal,\n      };\n      const html = await renderTemplate(template, dialogData);\n\n      return new Promise((resolve) => {\n        const buttons = {};\n        buttons.normal = {\n          label: game.i18n.localize(\"FFD20.Apply\"),\n          callback: (html) => resolve(_submit.call(this, html, 1 * healingInvert)),\n        };\n        buttons.half = {\n          label: game.i18n.localize(\"FFD20.ApplyHalf\"),\n          callback: (html) => resolve(_submit.call(this, html, 0.5 * healingInvert)),\n        };\n\n        new Dialog(\n          {\n            title: healingInvert > 0 ? game.i18n.localize(\"FFD20.ApplyDamage\") : game.i18n.localize(\"FFD20.ApplyHealing\"),\n            content: html,\n            buttons: buttons,\n            default: \"normal\",\n            close: (html) => {\n              resolve(false);\n            },\n            render: (inp) => {\n              /**\n               *\n               */\n              function swapSelected() {\n                const checked = [...inp[0].querySelectorAll('.selected-tokens input[type=\"checkbox\"]')];\n                checked.forEach((chk) => (chk.checked = !chk.checked));\n              }\n              /**\n               * @param {Element} e\n               */\n              function setReduction(e) {\n                inp[0].querySelector('input[name=\"damage-reduction\"]').value =\n                  e.currentTarget.innerText.match(numReg) ?? \"\";\n              }\n              /**\n               * @param {WheelEvent} event\n               */\n              function mouseWheelAdd(event) {\n                const el = event.currentTarget;\n\n                //Digits with optional sign only\n                if (/[^\\d+-]|(?:\\d[+-])/.test(el.value.trim())) return;\n\n                const value = parseFloat(el.value) || 0;\n                const increase = -Math.sign(event.originalEvent.deltaY);\n\n                el.value = (value + increase).toString();\n              }\n\n              inp.on(\"click\", 'a[name=\"swap-selected\"]', swapSelected);\n              inp.on(\"click\", 'a[name=\"clear-reduction\"], p.notes a', setReduction);\n              inp.on(\"wheel\", \"input\", mouseWheelAdd);\n            },\n          },\n          {\n            classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"apply-hit-points\"],\n          }\n        ).render(true);\n      });\n    } else return _submit();\n  }\n\n  /**\n   * Returns effective Wound Threshold multiplier with rules and overrides applied.\n   *\n   * @param {object} [data]\n   * @returns {number} Multiplier\n   */\n  getWoundThresholdMultiplier(data = null) {\n    data = data ?? this.system;\n\n    const hpconf = game.settings.get(\"ffd20\", \"healthConfig\").variants;\n    const conf = this.type === \"npc\" ? hpconf.npc : hpconf.pc;\n    const override = data.attributes.woundThresholds.override ?? -1;\n    return override >= 0 && conf.allowWoundThresholdOverride ? override : conf.useWoundThresholds;\n  }\n\n  /**\n   * Returns Wound Threshold relevant data.\n   *\n   * @param {object} data Provided valid rollData\n   * @returns {{level:number,penalty:number,multiplier:number,valid:boolean}}\n   */\n  getWoundThresholdData(data = null) {\n    data = data ?? this.system;\n\n    const woundMult = this.getWoundThresholdMultiplier(data),\n      woundLevel = data.attributes.woundThresholds.level ?? 0,\n      woundPenalty = woundLevel * woundMult + (data.attributes.woundThresholds.mod ?? 0);\n    return {\n      level: woundLevel,\n      penalty: woundPenalty,\n      multiplier: woundMult,\n      valid: woundLevel > 0 && woundMult > 0,\n    };\n  }\n\n  /**\n   * Updates attributes.woundThresholds.level variable.\n   */\n  updateWoundThreshold() {\n    const hpconf = game.settings.get(\"ffd20\", \"healthConfig\").variants;\n    const usage = this.type === \"npc\" ? hpconf.npc.useWoundThresholds : hpconf.pc.useWoundThresholds;\n    const wt = this.system.attributes.woundThresholds;\n    if (!usage) {\n      wt.level = 0;\n      wt.penaltyBase = 0;\n      wt.penalty = 0;\n      wt.mod = 0;\n      return;\n    }\n    const hp = this.system.attributes.hp,\n      curHP = hp.value,\n      tempHP = hp.temp ?? 0,\n      maxHP = hp.max;\n\n    let level = usage > 0 ? Math.clamped(4 - Math.ceil(((curHP + tempHP) / maxHP) * 4), 0, 3) : 0;\n    if (Number.isNaN(level)) level = 0; // Division by 0 due to max HP on new actors.\n\n    const wtMult = this.getWoundThresholdMultiplier();\n    const wtMod = wt.mod ?? 0;\n\n    wt.level = level;\n    wt.penaltyBase = level * wtMult; // To aid relevant formulas\n    wt.penalty = level * wtMult + wtMod;\n\n    const penalty = wt.penalty;\n    const changeFlatKeys = ffd20.config.woundThresholdChangeTargets;\n    for (const fk of changeFlatKeys) {\n      const flats = getChangeFlat.call(this, fk, \"penalty\");\n      for (const k of flats) {\n        if (!k) continue;\n        const curValue = getProperty(this, k) ?? 0;\n        setProperty(this, k, curValue - penalty);\n      }\n    }\n  }\n\n  get allSkills() {\n    const result = [];\n    for (const [k, s] of Object.entries(this.system.skills)) {\n      if (!s) continue;\n      result.push(k);\n      if (s.subSkills) {\n        for (const k2 of Object.keys(s.subSkills)) {\n          result.push(`${k}.subSkills.${k2}`);\n        }\n      }\n    }\n    return result;\n  }\n\n  /**\n   * An array of all context note data for this actor.\n   *\n   * @type {{notes: {text: string, subTarget: string}[], item: ItemPF}[]}\n   */\n  get allNotes() {\n    return this.items\n      .filter((item) => item.isActive && item.system.contextNotes?.length > 0)\n      .map((item) => ({ notes: item.system.contextNotes, item }));\n  }\n\n  /**\n   * @returns {ItemPF[]} All items on this actor, including those in containers.\n   */\n  get allItems() {\n    return [...this.containerItems, ...Array.from(this.items)];\n  }\n\n  /**\n   * Generates an array with all the active context-sensitive notes for the given context on this actor.\n   *\n   * @param {string|Handlebars.SafeString} context - The context to draw from.\n   */\n  getContextNotes(context) {\n    if (context.string) context = context.string;\n    const result = this.allNotes;\n\n    // Attacks\n    if (context.match(/^attacks\\.(.+)/)) {\n      const key = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === key;\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      return result;\n    }\n\n    // Skill\n    if (context.match(/^skill\\.(.+)/)) {\n      const skillKey = RegExp.$1;\n      const skill = this.getSkillInfo(skillKey);\n      const ability = skill.ability;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter(\n            (note) => note.subTarget === context || note.subTarget === `${ability}Skills` || note.subTarget === \"skills\"\n          )\n          .map((note) => note.text);\n      }\n\n      return result;\n    }\n\n    // Saving throws\n    if (context.match(/^savingThrow\\.(.+)/)) {\n      const saveKey = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === saveKey || o.subTarget === \"allSavingThrows\";\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      if (this.system.attributes.saveNotes != null && this.system.attributes.saveNotes !== \"\") {\n        result.push({ notes: [this.system.attributes.saveNotes], item: null });\n      }\n\n      return result;\n    }\n\n    // Ability checks\n    if (context.match(/^abilityChecks\\.(.+)/)) {\n      const ablKey = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === `${ablKey}Checks` || o.subTarget === \"allChecks\";\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      return result;\n    }\n\n    // Misc\n    if (context.match(/^misc\\.(.+)/)) {\n      const miscKey = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === miscKey;\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      return result;\n    }\n\n    if (context.match(/^spell\\.concentration\\.([a-z]+)$/)) {\n      const spellbookKey = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === \"concentration\";\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      const spellbookNotes = this.system.attributes?.spells?.spellbooks?.[spellbookKey]?.concentrationNotes;\n      if (spellbookNotes?.length) {\n        result.push({ notes: spellbookNotes.split(/[\\n\\r]+/), item: null });\n      }\n\n      return result;\n    }\n\n    if (context.match(/^spell\\.cl\\.([a-z]+)$/)) {\n      const spellbookKey = RegExp.$1;\n      for (const note of result) {\n        note.notes = note.notes\n          .filter((o) => {\n            return o.subTarget === \"cl\";\n          })\n          .map((o) => {\n            return o.text;\n          });\n      }\n\n      const spellbookNotes = this.system.attributes?.spells?.spellbooks?.[spellbookKey]?.clNotes;\n      if (spellbookNotes?.length) {\n        result.push({ notes: spellbookNotes.split(/[\\n\\r]+/), item: null });\n      }\n\n      return result;\n    }\n\n    if (context.match(/^spell\\.effect$/)) {\n      for (const note of result) {\n        note.notes = note.notes.filter((o) => o.subTarget === \"spellEffect\").map((o) => o.text);\n      }\n\n      return result;\n    }\n\n    return [];\n  }\n\n  /**\n   * Returns a list of already parsed context notes.\n   *\n   * @param {string} context - The context to draw notes from.\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.roll=true] Whether to roll inline rolls or not.\n   * @returns {string[]} The resulting notes, already parsed.\n   */\n  getContextNotesParsed(context, { roll = true } = {}) {\n    const noteObjects = this.getContextNotes(context);\n\n    return noteObjects.reduce((cur, o) => {\n      for (const note of o.notes) {\n        const enrichOptions = {\n          rollData: o.item != null ? o.item.getRollData() : this.getRollData(),\n          rolls: roll,\n          async: false,\n        };\n        cur.push(enrichHTMLUnrolled(note, enrichOptions));\n      }\n\n      return cur;\n    }, []);\n  }\n\n  formatContextNotes(notes, rollData, { roll = true } = {}) {\n    const result = [];\n    rollData ??= this.getRollData();\n    for (const noteObj of notes) {\n      rollData.item = {};\n      if (noteObj.item != null) rollData = noteObj.item.getRollData();\n\n      for (const note of noteObj.notes) {\n        result.push(...note.split(/[\\n\\r]+/).map((subnote) => enrichHTMLUnrolled(subnote, { rollData, rolls: roll })));\n      }\n    }\n    return result;\n  }\n\n  async createEmbeddedDocuments(embeddedName, createData, options = {}) {\n    createData = createData instanceof Array ? createData : [createData];\n    const rv = await super.createEmbeddedDocuments(embeddedName, createData, options);\n\n    // Create class\n    for (const item of rv) {\n      if (item.type === \"class\") {\n        await item._onLevelChange(0, item.system.level);\n      }\n    }\n\n    return rv;\n  }\n\n  /**\n   * @typedef {object} MobilityPenaltyResult\n   * @property {number|null} maxDexBonus - The maximum dexterity bonus allowed for this result.\n   * @property {number} acp - The armor check penalty of this result.\n   */\n\n  /**\n   * Computes encumbrance values for this actor.\n   *\n   * @returns {MobilityPenaltyResult} The resulting penalties from encumbrance.\n   */\n  _computeEncumbrance() {\n    // Init base data\n    const attributes = this.system.attributes;\n    if (attributes.encumbrance === undefined) attributes.encumbrance = {};\n    const encumbrance = attributes.encumbrance;\n\n    const carry = this.getCarryCapacity();\n    // Set levels\n    encumbrance.levels = carry;\n    encumbrance.levels.carry = carry.heavy * 2;\n    encumbrance.levels.drag = carry.heavy * 5;\n\n    const carriedWeight = Math.max(0, this.getCarriedWeight());\n    encumbrance.carriedWeight = Math.round(carriedWeight * 10) / 10;\n\n    // Determine load level\n    let encLevel = ffd20.config.encumbranceLevels.light;\n    if (carriedWeight > 0) {\n      if (carriedWeight > encumbrance.levels.medium) encLevel = ffd20.config.encumbranceLevels.heavy;\n      else if (carriedWeight > encumbrance.levels.light) encLevel = ffd20.config.encumbranceLevels.medium;\n    }\n    encumbrance.level = encLevel;\n\n    const result = {\n      maxDexBonus: null,\n      acp: 0,\n    };\n\n    switch (encumbrance.level) {\n      case ffd20.config.encumbranceLevels.medium:\n        result.acp = 3;\n        result.maxDexBonus = 3;\n        break;\n      case ffd20.config.encumbranceLevels.heavy:\n        result.acp = 6;\n        result.maxDexBonus = 1;\n        break;\n    }\n\n    return result;\n  }\n\n  _calculateCoinWeight() {\n    const coinWeightDivisor = game.settings.get(\"ffd20\", \"coinWeight\");\n    if (!coinWeightDivisor) return 0;\n    return (\n      Object.values(this.system.currency).reduce((cur, amount) => {\n        return (parseInt(cur) || 0) + amount;\n      }, 0) / coinWeightDivisor\n    );\n  }\n\n  getCarryCapacity() {\n    // Determine carrying capacity\n    const carryCapacity = this.system.details.carryCapacity;\n    const carryStr = this.system.abilities.str.total + carryCapacity.bonus.total;\n    let carryMultiplier = carryCapacity.multiplier.total;\n    const size = this.system.traits.size;\n    if (this.system.attributes.quadruped) carryMultiplier *= ffd20.config.encumbranceMultipliers.quadruped[size];\n    else carryMultiplier *= ffd20.config.encumbranceMultipliers.normal[size];\n    const table = ffd20.config.encumbranceLoads;\n\n    let heavy = Math.floor(table[carryStr] * carryMultiplier);\n    if (carryStr >= table.length) {\n      const multiplierCount = (carryStr - (table.length - 1)) / 10;\n      heavy = Math.floor(table[table.length - 1] * Math.pow(4, multiplierCount) * carryMultiplier);\n    }\n    // Convert to world unit system\n    heavy = ffd20.utils.convertWeight(heavy);\n\n    return {\n      light: Math.floor(heavy / 3),\n      medium: Math.floor((heavy / 3) * 2),\n      heavy: heavy,\n    };\n  }\n\n  getCarriedWeight() {\n    // Determine carried weight\n    const physicalItems = this.items.filter((o) => {\n      return o.system.weight != null;\n    });\n    const weight = physicalItems.reduce((cur, o) => {\n      if (!o.system.carried) return cur;\n      return cur + o.system.weight.total;\n    }, this._calculateCoinWeight());\n\n    return ffd20.utils.convertWeight(weight);\n  }\n\n  /**\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.inLowestDenomination=false] Use copper for calculations and return.\n   * @returns {number} The total amount of currency this actor has, in gold pieces.\n   */\n  mergeCurrency({ inLowestDenomination = false } = {}) {\n    const total =\n      this.getTotalCurrency(\"currency\", { inLowestDenomination }) +\n      this.getTotalCurrency(\"altCurrency\", { inLowestDenomination });\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  getTotalCurrency(category = \"currency\", { inLowestDenomination = false } = {}) {\n    const currencies = this.system[category];\n    if (!currencies) {\n      console.error(`Currency type \"${category}\" not found.`);\n      return NaN;\n    }\n    const total = currencies.pgil * 1000 + currencies.gil * 100 + currencies.sgil * 10 + currencies.cgil;\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  /**\n   * Converts currencies of the given category to the given currency type\n   *\n   * @param {string} category Either 'currency' or 'altCurrency'.\n   * @param {string} type Either 'pgil', 'gil', 'sgil' or 'cgil'. Converts as much currency as possible to this type.\n   * @returns {Promise<this>|undefined} Updated document or undefined if no update occurred.\n   */\n  convertCurrency(category = \"currency\", type = \"pgil\") {\n    const currency = {\n      pgil: 0,\n      gil: 0,\n      sgil: 0,\n      cgil: this.getTotalCurrency(category, { inLowestDenomination: true }),\n    };\n\n    if (!Number.isFinite(currency.cgil)) {\n      console.error(`Invalid total currency \"${currency.cgil}\" in \"${category}\" category`);\n      return;\n    }\n\n    const types = { pgil: 3, gil: 2, sgil: 1, cgil: 0 };\n    const largestType = types[type];\n\n    if (largestType >= types.pgil) {\n      currency.pgil = Math.floor(currency.cgil / 1_000);\n      currency.cgil -= currency.pgil * 1_000;\n    }\n    if (largestType >= types.gil) {\n      currency.gil = Math.max(0, Math.floor(currency.cgil / 100));\n      currency.cgil -= currency.gil * 100;\n    }\n    if (largestType >= types.sp) {\n      currency.sgil = Math.max(0, Math.floor(currency.cgil / 10));\n      currency.cgil -= currency.sgil * 10;\n    }\n\n    // Sanity check\n    if (currency.cgil < 0) currency.cgil = 0;\n\n    const updateData = { system: { [category]: currency } };\n\n    return this.update(updateData);\n  }\n\n  /**\n   * Prepare armor/shield data for roll data\n   *\n   * @param {object} equipment Equipment info\n   * @param {string} equipment.id Item ID\n   * @param {string} equipment.type Armor/Shield type\n   * @param {object} armorData Armor data object\n   * @private\n   */\n  _prepareArmorData({ id, type } = {}, armorData) {\n    armorData.type = type ?? null;\n\n    const itemData = this.items.get(id)?.system;\n    if (!itemData) return;\n\n    armorData.ac = itemData.armor.value ?? 0;\n    armorData.enh = itemData.armor.enh ?? 0;\n    armorData.total = armorData.ac + armorData.enh;\n    if (!Number.isFinite(armorData.total)) armorData.total = 0;\n  }\n\n  getRollData(options = { refresh: false }) {\n    let result;\n\n    // Return cached data, if applicable\n    const skipRefresh = !options.refresh && this._rollData;\n    if (skipRefresh) {\n      result = this._rollData;\n\n      // Clear certain fields\n      const clearFields = ffd20.config.temporaryRollDataFields.actor;\n      for (const k of clearFields) {\n        const arr = k.split(\".\");\n        const k2 = arr.slice(0, -1).join(\".\");\n        const k3 = arr.slice(-1)[0];\n        if (k2 === \"\") delete result[k];\n        else {\n          const obj = getProperty(result, k2);\n          if (typeof obj === \"object\") delete obj[k3];\n        }\n      }\n    } else {\n      result = deepClone(this.system);\n    }\n\n    /* ----------------------------- */\n    /* Always add the following data\n    /* ----------------------------- */\n\n    // Add combat round, if in combat\n    if (game.combats?.viewed) {\n      result.combat = {\n        round: game.combat.round || 0,\n      };\n    }\n\n    // Add denied Dex to AC\n    result.conditions ??= {};\n    result.conditions.loseDexToAC = this.changeFlags?.loseDexToAC ?? false;\n\n    // Return cached data, if applicable\n    if (skipRefresh) return result;\n\n    /* ----------------------------- */\n    /* Set the following data on a refresh\n    /* ----------------------------- */\n\n    // Set size index\n    const sizeChart = Object.keys(ffd20.config.sizeChart);\n    result.size = sizeChart.indexOf(result.traits.size);\n\n    // Add more info for formulas\n    result.armor = { type: 0, total: 0, ac: 0, enh: 0 };\n    result.shield = { type: 0, total: 0, ac: 0, enh: 0 };\n\n    // Determine equipped armor type\n    const eqData = this.equipment;\n    if (eqData) {\n      this._prepareArmorData(eqData.armor, result.armor);\n      this._prepareArmorData(eqData.shield, result.shield);\n    }\n\n    // Add spellbook info\n    result.spells = result.attributes.spells.spellbooks;\n    for (const [k, book] of Object.entries(result.spells)) {\n      book.abilityMod = result.abilities[book.ability]?.mod ?? 0;\n      // Add alias\n      if (book.class && book.class !== \"_hd\") result.spells[book.class] ??= book;\n    }\n\n    // Add item dictionary flags\n    result.dFlags = this.itemFlags?.dictionary ?? {};\n\n    // Add range info\n    result.range = this.constructor.getReach(this.system.traits.size, this.system.traits.stature);\n\n    // Add class info\n    result.classes = this.classes;\n\n    this._rollData = result;\n\n    // Call hook\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  static getReach(size = \"med\", stature = \"tall\") {\n    const result = {\n      melee: 5,\n      reach: 10,\n    };\n\n    switch (size) {\n      case \"fine\":\n      case \"dim\":\n        result.melee = 0;\n        result.reach = 0;\n        break;\n      case \"tiny\":\n        result.melee = 0;\n        result.reach = 5;\n        break;\n      case \"lg\":\n        if (stature === \"tall\") {\n          result.melee = 10;\n          result.reach = 20;\n        }\n        break;\n      case \"huge\":\n        if (stature === \"tall\") {\n          result.melee = 15;\n          result.reach = 30;\n        } else {\n          result.melee = 10;\n          result.reach = 20;\n        }\n        break;\n      case \"grg\":\n        if (stature === \"tall\") {\n          result.melee = 20;\n          result.reach = 40;\n        } else {\n          result.melee = 15;\n          result.reach = 30;\n        }\n        break;\n      case \"col\":\n        if (stature === \"tall\") {\n          result.melee = 30;\n          result.reach = 60;\n        } else {\n          result.melee = 20;\n          result.reach = 40;\n        }\n        break;\n    }\n\n    return result;\n  }\n\n  async deleteEmbeddedDocuments(embeddedName, data, options = {}) {\n    if (embeddedName === \"Item\") {\n      if (!(data instanceof Array)) data = [data];\n\n      // Add children to list of items to be deleted\n      const _addChildren = async function (id) {\n        const item = this.items.get(id);\n        const children = await item.getLinkedItems(\"children\");\n        for (const child of children) {\n          if (!data.includes(child.id)) {\n            data.push(child.id);\n            await _addChildren.call(this, child.id);\n          }\n        }\n      };\n      for (const id of data) {\n        await _addChildren.call(this, id);\n      }\n\n      // Remove links to this item (and child items)\n      for (const id of data) {\n        for (const i of this.items) {\n          await i.removeItemLink(id);\n        }\n      }\n    }\n\n    await super.deleteEmbeddedDocuments(embeddedName, data, options);\n  }\n\n  getQuickActions() {\n    return this.items\n      .filter(\n        (o) =>\n          o.isActive &&\n          o.system.showInQuickbar === true &&\n          [\"weapon\", \"equipment\", \"consumable\", \"attack\", \"spell\", \"feat\"].includes(o.type) &&\n          !o.showUnidentifiedData\n      )\n      .sort((a, b) => a.sort - b.sort)\n      .map((o) => {\n        return {\n          item: o,\n          isSingleUse: o.isSingleUse,\n          get haveAnyCharges() {\n            return this.item.isCharged;\n          },\n          maxCharge: o.maxCharges,\n          get charges() {\n            return this.item.charges;\n          },\n        };\n      });\n  }\n\n  /**\n   * @param {DocumentModificationContext} context\n   */\n  async toggleConditionStatusIcons(context = {}) {\n    if (this._states.togglingStatusIcons) return;\n    this._states.togglingStatusIcons = true;\n\n    if (!this.testUserPermission(game.user, \"OWNER\")) return;\n\n    const buffTextures = this._calcBuffActiveEffects();\n    const fx = [...this.effects];\n\n    // Create and delete buff ActiveEffects\n    const toCreate = [];\n    const toDelete = [];\n    const toUpdate = [];\n    for (const [id, obj] of Object.entries(buffTextures)) {\n      const existing = fx.find((f) => {\n        return f.origin === id || f.flags.ffd20?.origin?.item === obj.id;\n      });\n      if (!existing) {\n        if (obj.active) toCreate.push(obj.item.getRawEffectData());\n      } else {\n        if (!obj.active) toDelete.push(existing.id);\n        else {\n          const existingData = existing.toObject();\n          const mergedData = foundry.utils.mergeObject(existingData, obj.item.getRawEffectData(), { inplace: false });\n          const hideIcon = obj.item.system.hideFromToken || game.settings.get(\"ffd20\", \"hideTokenConditions\");\n          if (hideIcon) mergedData.icon = null;\n          const diffData = foundry.utils.diffObject(existingData, mergedData);\n          if (!foundry.utils.isEmpty(diffData)) {\n            diffData._id = existing.id;\n            toUpdate.push(diffData);\n          }\n        }\n      }\n    }\n\n    // Create and delete condition ActiveEffects\n    for (const condKey of Object.keys(ffd20.config.conditions)) {\n      const idx = fx.findIndex((e) => e.getFlag(\"core\", \"statusId\") === condKey);\n      const hasCondition = this.system.attributes.conditions[condKey] === true;\n      const hasEffectIcon = idx >= 0;\n\n      if (hasCondition && !hasEffectIcon) {\n        toCreate.push({\n          flags: {\n            core: {\n              statusId: condKey,\n            },\n            ffd20: {\n              autoDelete: true,\n            },\n          },\n          name: ffd20.config.conditions[condKey],\n          icon: ffd20.config.conditionTextures[condKey],\n          label: ffd20.config.conditions[condKey],\n        });\n      } else if (!hasCondition && hasEffectIcon) {\n        const removeEffects = fx.filter((e) => e.getFlag(\"core\", \"statusId\") === condKey);\n        toDelete.push(...removeEffects.map((e) => e.id));\n      }\n    }\n\n    // Create sub-contexts and disable render if more updates are done\n    const deleteContext = deepClone(context);\n    if (context.render !== false) deleteContext.render = !toCreate.length && !toUpdate.length;\n    const createContext = deepClone(context);\n    if (context.render !== false) createContext.render = !toUpdate.length;\n\n    if (toDelete.length) await this.deleteEmbeddedDocuments(\"ActiveEffect\", toDelete, deleteContext);\n    if (toCreate.length) await this.createEmbeddedDocuments(\"ActiveEffect\", toCreate, createContext);\n    if (toUpdate.length) await this.updateEmbeddedDocuments(\"ActiveEffect\", toUpdate, context);\n    this._states.togglingStatusIcons = false;\n  }\n\n  // @Object { id: { title: String, type: buff/string, img: imgPath, active: true/false }, ... }\n  _calcBuffActiveEffects() {\n    const buffs = this.items.filter((o) => o.type === \"buff\");\n    return buffs.reduce((acc, buff) => {\n      const id = buff.uuid;\n      acc[id] ??= { id: buff.id, label: buff.name, icon: buff.img, item: buff };\n      acc[id].active = buff.isActive;\n      return acc;\n    }, {});\n  }\n\n  refreshAbilityModifiers() {\n    for (const k of Object.keys(this.system.abilities)) {\n      const total = this.system.abilities[k].total;\n      const penalty = Math.abs(this.system.abilities[k].penalty || 0);\n      const damage = this.system.abilities[k].damage;\n      const newMod = getAbilityModifier(total, { penalty, damage });\n      this.system.abilities[k].mod = newMod;\n\n      // Store previous ability score\n      if (!ffd20.migrations.isMigrating && this._initialized && this._prevAbilityScores) {\n        const prevMod = this._prevAbilityScores?.[k].mod ?? 0;\n        const diffMod = newMod - prevMod;\n        const result = this.system.abilities[k].mod + diffMod;\n\n        this._prevAbilityScores[k] = {\n          total,\n          mod: result,\n        };\n      }\n    }\n  }\n\n  async importFromJSON(json) {\n    // Set _initialized flag to prevent faults (such as HP changing incorrectly)\n    this._initialized = false;\n\n    // Import from JSON\n    const data = JSON.parse(json);\n    delete data._id;\n    data.effects = [];\n\n    // Update data\n    return this.update(data, { diff: false, recursive: false });\n  }\n\n  /**\n   * @typedef MaxAndValue\n   * @type {object}\n   * @property {number} max - The maximum value.\n   * @property {number} value - The current value.\n   * @returns {MaxAndValue} An object with a property `value` which refers to the current used feats, and `max` which refers to the maximum available feats.\n   */\n  getFeatCount() {\n    const result = { max: 0, value: 0 };\n    result.value = this.items.filter((o) => {\n      return o.type === \"feat\" && o.system.subType === \"feat\" && !o.system.disabled;\n    }).length;\n\n    // Add feat count by level\n    const totalLevels = this.items\n      .filter((o) => o.type === \"class\" && [\"base\", \"npc\", \"prestige\", \"racial\"].includes(o.system.subType))\n      .reduce((cur, o) => {\n        return cur + o.hitDice;\n      }, 0);\n    result.max += Math.ceil(totalLevels / 2);\n\n    // Bonus feat formula\n    const featCountRoll = RollPF.safeRoll(this.system.details.bonusFeatFormula || \"0\", this.getRollData());\n    result.max += featCountRoll.total;\n    if (featCountRoll.err) {\n      ui.notifications.error(\n        game.i18n.format(\"FFD20.ErrorActorFormula\", {\n          context: game.i18n.localize(\"FFD20.BonusFeatFormula\"),\n          name: this.actor.name,\n        })\n      );\n    }\n\n    // Changes\n    this.changes\n      .filter((o) => o.subTarget === \"bonusFeats\")\n      .forEach((o) => {\n        if (!o.value) return;\n\n        result.max += o.value;\n      });\n\n    return result;\n  }\n\n  /**\n   * @param {string} flagName - The name/key of the flag to search for.\n   * @returns {boolean} Whether this actor has any owned item with the given flag.\n   */\n  hasItemBooleanFlag(flagName) {\n    return this.itemFlags.boolean[flagName] != null;\n  }\n\n  /**\n   * Restore spellbook used slots and spellpoints.\n   *\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.commit=true] If false, return update data object instead of directly updating the actor.\n   * @param {object} [options.rollData] Roll data\n   * @returns {Promise<this|object>} Result of update or the update data.\n   */\n  async resetSpellbookUsage({ commit = true, rollData } = {}) {\n    const actorData = this.system;\n    const updateData = {};\n\n    rollData ??= this.getRollData();\n\n    // Update spellbooks\n    for (const [bookId, spellbook] of Object.entries(actorData.attributes.spells.spellbooks)) {\n      // Restore spellbooks using spell points\n      if (spellbook.spellPoints.useSystem) {\n        // Try to roll restoreFormula, fall back to restoring max spell points\n        let restorePoints = spellbook.spellPoints.max;\n        if (spellbook.spellPoints.restoreFormula) {\n          const restoreRoll = RollPF.safeRoll(spellbook.spellPoints.restoreFormula, rollData);\n          if (restoreRoll.err) console.error(restoreRoll.err, spellbook.spellPoints.restoreFormula);\n          else restorePoints = Math.min(spellbook.spellPoints.value + restoreRoll.total, spellbook.spellPoints.max);\n        }\n        updateData[`system.attributes.spells.spellbooks.${bookId}.spellPoints.value`] = restorePoints;\n      }\n      // Restore spell slots\n      else {\n        for (let level = 0; level < 10; level++) {\n          updateData[`system.attributes.spells.spellbooks.${bookId}.spells.spell${level}.value`] =\n            spellbook.spells[`spell${level}`]?.max ?? 0;\n        }\n      }\n    }\n\n    if (commit) return this.update(updateData);\n    return updateData;\n  }\n\n  /**\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.commit=true] If false, return update data object instead of directly updating the actor.\n   * @param {object} [options.updateData] Update data to complement or read changed values from.\n   * @returns {Promise<Item[]|object[]>} Result of an update or the update data.\n   */\n  async rechargeItems({ updateData = {}, commit = true } = {}) {\n    const actorData = this.system;\n    const itemUpdates = [];\n\n    // Get data at path, either from passed updateData or directly from actor\n    const getPathData = (path) => updateData[path] ?? getProperty(this, path);\n\n    // Update charged items\n    for (const item of this.items) {\n      const itemUpdate = (await item.recharge({ period: \"day\", commit: false })) ?? {};\n      itemUpdate.system ??= {};\n\n      const itemData = item.system;\n      if (item.type === \"spell\") {\n        const bookId = itemData.spellbook,\n          level = itemData.level;\n\n        const spellbook = getProperty(actorData, `attributes.spells.spellbooks.${bookId}`);\n\n        // Skip spells with missing spellbook\n        if (!spellbook) {\n          console.warn(`${item.name} [${item.id}] has invalid spellbook: \"${bookId}\"`);\n          continue;\n        }\n\n        // Spontaneous don't store casts in individual spells\n        if (spellbook.spontaneous) continue;\n\n        if (itemData.preparation.preparedAmount < itemData.preparation.maxAmount) {\n          itemUpdate[\"system.preparation.preparedAmount\"] = itemData.preparation.maxAmount;\n          itemUpdates.push(itemUpdate);\n        }\n        if (!item.system.domain) {\n          let sbUses = getPathData(`system.attributes.spells.spellbooks.${bookId}.spells.spell${level}.value`) || 0;\n          sbUses -= itemData.preparation.maxAmount;\n          updateData[`system.attributes.spells.spellbooks.${bookId}.spells.spell${level}.value`] = sbUses;\n        }\n      }\n\n      // Update charged actions\n      if (item.system.actions?.length > 0) {\n        const actions = deepClone(item.system.actions);\n        let _changed = false;\n        for (const actionData of actions) {\n          if (actionData.uses?.self?.per === \"day\") {\n            const maxUses = actionData.uses.self.max || 0;\n            if (actionData.uses.self.value < maxUses) {\n              actionData.uses.self.value = maxUses;\n              _changed = true;\n            }\n          }\n        }\n\n        if (_changed) {\n          itemUpdate[\"system.actions\"] = actions;\n        }\n      }\n\n      // Append update to queue\n      if (!foundry.utils.isEmpty(itemUpdate)) {\n        itemUpdate._id = item.id;\n        itemUpdates.push(itemUpdate);\n      }\n    }\n\n    if (commit) {\n      if (itemUpdates.length) return this.updateEmbeddedDocuments(\"Item\", itemUpdates);\n    } else return itemUpdates;\n    return [];\n  }\n\n  /**\n   * Handler for character healing during rest.\n   *\n   * @param {object} options Resting options.\n   * @returns {object} Update data object\n   */\n  _restingHeal(options = {}) {\n    const actorData = this.system,\n      hp = actorData.attributes.hp,\n      mp = actorData.attributes.mp;\n    const { hours, longTermCare, aidedCare } = options;\n    const updateData = {};\n\n    const hd = actorData.attributes.hd.total;\n    const mprev = actorData.attributes.mp.recover;\n    const heal = {\n      hp: hd,\n      mp: mprev, // change this to reflect total caster level and casting mods\n      abl: 1,\n      nonlethal: hours * hd,\n    };\n    if (longTermCare === true && aidedCare === false) {\n      heal.hp *= 2;\n      heal.mp *= 2;\n      heal.abl *= 2;\n    }\n    if (longTermCare === false && aidedCare === true) {\n      heal.hp *= 2;\n      heal.mp *= 2;\n      heal.abl *= 2;\n    }\n    if (longTermCare === true && aidedCare === true) {\n      heal.hp *= 5;\n      heal.mp *= 5;\n      heal.abl *= 5;\n    }\n    updateData[\"system.attributes.hp.value\"] = Math.min(hp.value + heal.hp, hp.max);\n    updateData[\"system.attributes.mp.value\"] = Math.min(mp.value + heal.mp, mp.max);\n    updateData[\"system.attributes.hp.nonlethal\"] = Math.max(0, (hp.nonlethal || 0) - heal.nonlethal);\n    for (const [key, abl] of Object.entries(actorData.abilities)) {\n      const dmg = Math.abs(abl.damage);\n      updateData[`system.abilities.${key}.damage`] = Math.max(0, dmg - heal.abl);\n    }\n\n    return updateData;\n  }\n\n  /**\n   * Perform all changes related to an actor resting, including restoring HP, ability scores, item uses, etc.\n   *\n   * @see {@link hookEvents!pf1PreActorRest pf1PreActorRest hook}\n   * @see {@link hookEvents!pf1ActorRest pf1ActorRest hook}\n   * @param {Partial<ActorRestOptions>} options - Options affecting an actor's resting\n   * @returns {Promise<ActorRestData | void>} Updates applied to the actor, if resting was completed\n   */\n  async performRest(options = {}) {\n    const {\n      restoreHealth = true,\n      longTermCare = false,\n      aidedCare = false,\n      restoreDailyUses = true,\n      hours = 8,\n    } = options;\n    const actorData = this.system;\n\n    const updateData = {};\n    // Restore health and ability damage\n    if (restoreHealth === true) {\n      const healUpdate = this._restingHeal(options);\n      mergeObject(updateData, healUpdate);\n    }\n\n    let itemUpdates = [];\n    // Restore daily uses of spells, feats, etc.\n    if (restoreDailyUses === true) {\n      const spellbookUpdates = await this.resetSpellbookUsage({ commit: false });\n      mergeObject(updateData, spellbookUpdates);\n\n      itemUpdates = await this.rechargeItems({ commit: false, updateData });\n    }\n\n    options = { restoreHealth, restoreDailyUses, longTermCare, hours };\n    const allowed = Hooks.call(\"pf1PreActorRest\", this, options, updateData, itemUpdates);\n    if (allowed === false) return;\n\n    if (itemUpdates.length) await this.updateEmbeddedDocuments(\"Item\", itemUpdates);\n    if (!foundry.utils.isEmpty(updateData.system)) await this.update(updateData);\n\n    Hooks.callAll(\"pf1ActorRest\", this, options, updateData, itemUpdates);\n    return { options, updateData, itemUpdates };\n  }\n\n  /**\n   * @override\n   */\n  async modifyTokenAttribute(attribute, value, isDelta = false, isBar = true) {\n    let doc = this;\n    const current = getProperty(this.system, attribute),\n      updates = {};\n    const resourceMatch = /^resources\\.(?<tag>[^.]+)$/.exec(attribute);\n    if (resourceMatch) {\n      const { tag } = resourceMatch.groups;\n      const itemId = this.system.resources[tag]?._id;\n      doc = this.items.get(itemId);\n    }\n    if (!doc) return;\n    const updateData = {};\n\n    // Special keys\n    if (attribute === \"attributes.hp\") {\n      if (!isDelta) value = (current.temp + current.value - value) * -1;\n      let dt = value;\n      if (current.temp > 0 && value < 0) {\n        dt = Math.min(0, current.temp + value);\n        updates[\"system.attributes.hp.temp\"] = Math.max(0, current.temp + value);\n      }\n      updates[\"system.attributes.hp.value\"] = Math.min(current.value + dt, current.max);\n    } else if (attribute === \"attributes.vigor\") {\n      if (!isDelta) value = (current.temp + current.value - value) * -1;\n      let dt = value;\n      if (current.temp > 0 && value < 0) {\n        dt = Math.min(0, current.temp + value);\n        updates[\"system.attributes.vigor.temp\"] = Math.max(0, current.temp + value);\n      }\n      updates[\"system.attributes.vigor.value\"] = Math.min(current.value + dt, current.max);\n    }\n    // Absolute\n    else if (!isDelta) {\n      if (doc instanceof Actor) {\n        if (isBar) updates[`system.${attribute}.value`] = value;\n        else updates[`system.${attribute}`] = value;\n      } else {\n        updates[\"system.uses.value\"] = value;\n      }\n      // Relative\n    } else {\n      if (doc instanceof Actor) {\n        if (isBar)\n          updates[`system.${attribute}.value`] = Math.clamped(current.min || 0, current.value + value, current.max);\n        else updates[`system.${attribute}`] = current + value;\n      } else {\n        updates[\"system.uses.value\"] = current.value + value;\n      }\n    }\n\n    const allowed = Hooks.call(\"modifyTokenAttribute\", { attribute, value, isDelta, isBar }, updates);\n    return allowed !== false ? doc.update(updates) : this;\n  }\n\n  getItemByTag(tag) {\n    return this.items.find((o) => o.system.tag === tag);\n  }\n\n  /**\n   * Cached result of .itemTypes\n   *\n   * @private\n   */\n  _itemTypes;\n\n  /**\n   * Cached override\n   *\n   * @override\n   */\n  get itemTypes() {\n    this._itemTypes ??= super.itemTypes;\n    return this._itemTypes;\n  }\n\n  /**\n   * The VisionPermissionSheet instance for this actor\n   *\n   * @type {VisionPermissionSheet}\n   */\n  get visionPermissionSheet() {\n    this._visionPermissionSheet ??= new VisionPermissionSheet(this);\n    return this._visionPermissionSheet;\n  }\n}\n\n/**\n * @typedef {object} ActorRestOptions\n * Options given to {@link ActorPF.performRest} affecting an actor's resting.\n * @property {boolean} restoreHealth - Whether the actor's health should be restored. Defaults to `true`.\n * @property {boolean} restoreDailyUses - Whether daily uses of spells and abilities should be restored. Defaults to `true`.\n * @property {boolean} longTermCare - Whether additional hit and ability score points should be restored through the Heal skill. Defaults to `false`.\n * @property {number} hours - The number of hours the actor will rest. Defaults to `8`.\n */\n\n/**\n * @typedef {object} ActorRestData\n * @property {ActorRestOptions} options - Options for resting\n * @property {object} updateData - Updates applied to the actor\n * @property {object[]} itemUpdates - Updates applied to the actor's items\n */\n","import { ActorPF } from \"./actor/actor-pf.mjs\";\nimport { getActorFromId, getItemOwner } from \"../utils/lib.mjs\";\n\n/**\n * Temporary shared shim for getting actor and printing compatibility warning.\n * Remove once compatibility period is over.\n *\n * @param {string} uuid Actor UUID\n * @returns {Actor|undefined} Actor instance if found, undefined otherwise.\n */\nconst getActorShim = (uuid) => {\n  const doc = fromUuidSync(uuid);\n  let actor = doc.actor ?? doc;\n\n  // Compatibility shim\n  if (!actor) {\n    actor = getActorFromId(uuid);\n    if (actor) {\n      foundry.utils.logCompatibilityWarning(\"Actor ID for macro creation functions is deprecated in favor of UUID\", {\n        since: \"PF1 v9\",\n        until: \"PF1 v10\",\n      });\n    }\n  }\n\n  return actor;\n};\n\n/**\n * Various functions dealing with the creation and usage of macros.\n *\n * @module macros\n */\n\n/**\n * Create a Macro from an Item drop, or get an existing one.\n *\n * @param {object} item The item data\n * @param {string} actor The actor ID\n * @param {object} uuid\n * @param {number} slot The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createItemMacro = async (uuid, slot) => {\n  const item = fromUuidSync(uuid);\n  const command = `fromUuidSync(\"${uuid}\").use();`;\n  let macro = game.macros.contents.find((m) => m.name === item.name && m.data.command === command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name: item.name,\n        type: \"script\",\n        img: item.img,\n        command: command,\n        flags: { \"ffd20.itemMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create action use macro from dropped action.\n *\n * @param {string} actionId Action ID\n * @param {string} uuid UUID to parent item\n * @param {number} slot Hotbar slot to assign to\n * @returns {Promise<User>} The updated User\n */\nexport const createActionMacro = async (actionId, uuid, slot) => {\n  const item = fromUuidSync(uuid);\n\n  const action = item?.actions.get(actionId);\n\n  if (!action) {\n    return void ui.notifications.error(\n      game.i18n.format(\"FFD20.ErrorActionNotFound\", { id: actionId, item: item?.name, actor: item?.actor?.name })\n    );\n  }\n\n  const command = `fromUuidSync(\"${uuid}\")\\n\\t.actions.get(\"${actionId}\")\\n\\t.use();`;\n\n  let macro = game.macros.contents.find((m) => m.name === item.name && m.data.command === command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name: `${action.name} (${item.name})`,\n        type: \"script\",\n        img: action.img || item.img,\n        command,\n        flags: { ffd20: { actionMacro: { item: uuid, action: actionId } } },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro from skill data to roll an actor's skill, or get an existing one.\n *\n * @async\n * @param {string} skillId - The skill's identifier\n * @param {string} uuid - The actor's UUID\n * @param {number} slot - The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createSkillMacro = async (skillId, uuid, slot) => {\n  const actor = getActorShim(uuid);\n  if (!actor) return;\n\n  const skillInfo = actor.getSkillInfo(skillId);\n  const command = `fromUuidSync(\"${actor.uuid}\")\\n\\t.rollSkill(\"${skillId}\");`;\n  const name = game.i18n.format(\"FFD20.RollSkillMacroName\", { actor: actor.name, skill: skillInfo.name });\n  let macro = game.macros.contents.find((m) => m.name === name && m.data.command === command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name: name,\n        type: \"script\",\n        img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n        command: command,\n        flags: { \"ffd20.skillMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro from save data to roll an actor's save, or get an existing one.\n *\n * @async\n * @param {string} saveId - The save's identifier\n * @param {string} uuid - The actor's UUID\n * @param {number} slot - The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createSaveMacro = async (saveId, uuid, slot) => {\n  const actor = getActorShim(uuid);\n  if (!actor) return;\n\n  const saveName = game.i18n.localize(\"FFD20.SavingThrow\" + saveId.capitalize());\n\n  const command = `fromUuidSync(\"${actor.uuid}\")\\n\\t.rollSavingThrow(\"${saveId}\");`;\n  const name = game.i18n.format(\"FFD20.RollSaveMacroName\", { actor: actor.name, type: saveName });\n  let macro = game.macros.contents.find((m) => m.name === name && m.data.command === command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name: name,\n        type: \"script\",\n        img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n        command: command,\n        flags: { \"ffd20.saveMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro to roll one of various checks for an actor\n *\n * @async\n * @param {string} type The type of macro to create\n * @param {string} uuid The actor's UUID\n * @param {number} slot The hotbar slot to use\n * @param {object} [data] Additional context data\n * @returns {Promise<User|void>} The updated User, if an update is triggered\n */\nexport const createMiscActorMacro = async (type, uuid, slot, data) => {\n  const actor = getActorShim(uuid);\n  if (!actor) return;\n\n  const getBookLabel = (bookId) => actor.system.attributes?.spells?.spellbooks?.[bookId]?.label;\n\n  let name,\n    img,\n    command = `fromUuidSync(\"${actor.uuid}\")\\n\\t`;\n  switch (type) {\n    case \"defenses\":\n      command += `.displayDefenseCard();`;\n      name = game.i18n.format(\"FFD20.DisplayDefensesMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/items/armor/shield-light-metal.png\";\n      break;\n    case \"cmb\":\n      command += `.rollCMB();`;\n      name = game.i18n.format(\"FFD20.RollCMBMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/feats/improved-grapple.jpg\";\n      break;\n    case \"cl\": {\n      const { bookId } = data;\n      command += `.rollCL(\"${bookId}\");`;\n      name = game.i18n.format(\"FFD20.RollCLMacroName\", { actor: actor.name, book: getBookLabel(bookId) });\n      img = \"systems/ffd20/icons/spells/wind-grasp-eerie-3.jpg\";\n      break;\n    }\n    case \"concentration\": {\n      const { bookId } = data;\n      command += `.rollConcentration(\"${bookId}\");`;\n      name = game.i18n.format(\"FFD20.RollConcentrationMacroName\", { actor: actor.name, book: getBookLabel(bookId) });\n      img = \"systems/ffd20/icons/skills/light_01.jpg\";\n      break;\n    }\n    case \"bab\":\n      command += `.rollBAB();`;\n      name = game.i18n.format(\"FFD20.RollBABMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/skills/yellow_08.jpg\";\n      break;\n    case \"initiative\":\n      command += \".rollInitiative();\";\n      name = game.i18n.format(\"FFD20.RollInitiativeMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/skills/weapon_41.jpg\";\n      break;\n    case \"attack\": {\n      const { attack } = data;\n      const isMelee = attack === \"melee\";\n      command += `.rollAttack({ melee: ${isMelee ? \"true\" : \"false\"}});`;\n      name = game.i18n.format(isMelee ? \"FFD20.RollMeleeMacroName\" : \"FFD20.RollRangedMacroName\", { actor: actor.name });\n      img = isMelee ? \"systems/ffd20/icons/skills/weapon_23.jpg\" : \"systems/ffd20/icons/skills/arrow_07.jpg\";\n      break;\n    }\n    case \"abilityScore\": {\n      const { ability } = data;\n      command += `.rollAbilityTest(\"${ability}\");`;\n      name = game.i18n.format(\"FFD20.RollAbilityMacroName\", {\n        actor: actor.name,\n        ability: CONFIG.FFD20.abilities[ability],\n      });\n      img = \"systems/ffd20/icons/skills/blue_35.jpg\";\n      break;\n    }\n  }\n\n  if (!name) return;\n\n  let macro = game.macros.contents.find((o) => o.name === name && o.command === command);\n  macro ??= await Macro.create(\n    {\n      name,\n      type: \"script\",\n      img,\n      command,\n      flags: { ffd20: { type, actor: uuid } },\n    },\n    { displaySheet: false }\n  );\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Roll an actor's item\n *\n * @param {string} itemName - The item's name\n * @param {object} [options] - Additional options\n * @param {string} [options.itemId] - The item's identifier\n * @param {string} [options.itemType] - The item's type\n * @param {string} [options.actorId] - The actor identifier\n * @returns {Promise|void} The item's roll or void if any requirements are not met\n * @deprecated\n */\nexport const rollItemMacro = (itemName, { itemId, itemType, actorId } = {}) => {\n  foundry.utils.logCompatibilityWarning(\"rollItemMacro() is deprecated in favor of Item.use()\", {\n    since: \"PF1 v9\",\n    until: \"PF1 v10\",\n  });\n\n  const actor = getActorFromId(actorId);\n  if (actor && !actor.testUserPermission(game.user, \"OWNER\")) {\n    return void ui.notifications.warn(game.i18n.localize(\"FFD20.ErrorNoActorPermission\"));\n  }\n  const item = actor\n    ? actor.items.find((i) => {\n        if (itemId != null && i.id !== itemId) return false;\n        if (itemType != null && i.type !== itemType) return false;\n        return i.name === itemName;\n      })\n    : null;\n  if (!item) {\n    return void ui.notifications.warn(\n      game.i18n.format(\"FFD20.WarningNoItemOnActor\", { actor: actor?.name, item: itemName })\n    );\n  }\n\n  // Trigger the item roll\n  if (!ffd20.forceShowItem && item.hasAction) {\n    return item.use();\n  }\n  return item.roll();\n};\n\n/**\n * Roll an actor's skill\n *\n * @param {string} actorId - The actor's identifier\n * @param {string} skillId - The skill's identifier\n * @returns {Promise|void} The skill roll, or void if no skill is found\n * @deprecated\n */\nexport const rollSkillMacro = (actorId, skillId) => {\n  foundry.utils.logCompatibilityWarning(\"rollSkillMacro() is deprecated in favor of Actor.rollSkill()\", {\n    since: \"PF1 v9\",\n    until: \"PF1 v10\",\n  });\n\n  const actor = getActorFromId(actorId);\n  if (!actor) {\n    return void ui.notifications.error(game.i18n.format(\"FFD20.ErrorActorNotFound\", { id: actorId }));\n  }\n\n  return actor.rollSkill(skillId);\n};\n\n/**\n * Roll an actor's save\n *\n * @param {string} actorId - The actor's identifier\n * @param {string} saveId - The save's identifier\n * @returns {Promise|void} The save roll, or void if no save is found\n * @deprecated\n */\nexport const rollSaveMacro = (actorId, saveId) => {\n  foundry.utils.logCompatibilityWarning(\"rollSaveMacro() is deprecated in favor of Actor.rollSavingThrow()\", {\n    since: \"PF1 v9\",\n    until: \"PF1 v10\",\n  });\n\n  const actor = getActorFromId(actorId);\n  if (!actor) {\n    return void ui.notifications.error(game.i18n.format(\"FFD20.ErrorActorNotFound\", { id: actorId }));\n  }\n\n  return actor.rollSavingThrow(saveId);\n};\n\n/**\n * Show an actor's defenses\n *\n * @param {object} [options] - Additional parameters\n * @param {string} [options.actorName] - The actor's name\n * @param {string} [options.actorId] - The actor's identifier\n * @param options.rollMode\n * @returns {Promise|void} The defense roll, or void if no actor is found\n * @deprecated\n */\nexport const displayDefenses = ({ actorName = null, actorId = null, rollMode = null } = {}) => {\n  foundry.utils.logCompatibilityWarning(\"displayDefenses() is deprecated in favor of Actor.displayDefenseCard()\", {\n    since: \"PF1 v9\",\n    until: \"PF1 v10\",\n  });\n\n  const actor = ActorPF.getActiveActor({ actorName: actorName, actorId: actorId });\n  if (!actor) {\n    return void ui.notifications.warn(\n      game.i18n.format(\"FFD20.ErrorNoApplicableActorFoundForAction\", {\n        name: game.i18n.localize(\"FFD20.Action_DisplayDefenses\"),\n      })\n    );\n  }\n\n  return actor.displayDefenseCard({ rollMode });\n};\n\n/**\n * Roll one of an actor's various attributes\n *\n * @param {string} actorId - The actor's identifier\n * @param {string} type - The attribute to roll\n * @param {string} [altType] - An additional qualifier, used e.g. to determine a roll's spellbook\n * @returns {Promise|void} The roll, or void if no actor is found\n * @deprecated\n */\nexport const rollActorAttributeMacro = (actorId, type, altType = null) => {\n  foundry.utils.logCompatibilityWarning(\n    \"rollActorAttributeMacro() is deprecated in favor of directly calling functions on the actor.\",\n    {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    }\n  );\n\n  const actor = getActorFromId(actorId);\n  if (!actor) {\n    return void ui.notifications.error(game.i18n.format(\"FFD20.ErrorActorNotFound\", { id: actorId }));\n  }\n\n  switch (type) {\n    case \"defenses\":\n      return actor.displayDefenseCard();\n    case \"cmb\":\n      return actor.rollCMB();\n    case \"cl\":\n      return actor.rollCL(altType);\n    case \"concentration\":\n      return actor.rollConcentration(altType);\n    case \"bab\":\n      return actor.rollBAB();\n  }\n};\n","import { ActorPF } from \"./actor-pf.mjs\";\n\nconst actorHandler = {\n  construct(_, args) {\n    return new CONFIG.Actor.documentClasses[args[0]?.type](...args);\n  },\n};\n\nexport const ActorPFProxy = new Proxy(ActorPF, actorHandler);\n","import { ItemPF } from \"./item-pf.mjs\";\n\nconst itemHandler = {\n  construct(_, args) {\n    return new CONFIG.Item.documentClasses[args[0]?.type](...args);\n  },\n};\n\nexport const ItemPFProxy = new Proxy(ItemPF, itemHandler);\n","/**\n * FFD20 Configuration Values\n *\n * A dictionary of dictionaries providing configuration data like formulae,\n * translation keys, and other configuration values. Translations keys are\n * assumed to get replaced by their proper translation when the system is loaded.\n *\n * The FFD20 object may be adjusted to influence the system's behaviour during runtime.\n * It is available as `ffd20.config` as well as through `CONFIG.FFD20`.\n *\n * @module\n */\nexport const re = {\n  traitSeparator: /\\s*[;]\\s*/g,\n};\n\n/**\n * The set of Ability Scores used within the system\n *\n * @enum {string}\n */\nexport const abilities = {\n  str: \"FFD20.AbilityStr\",\n  dex: \"FFD20.AbilityDex\",\n  con: \"FFD20.AbilityCon\",\n  int: \"FFD20.AbilityInt\",\n  wis: \"FFD20.AbilityWis\",\n  cha: \"FFD20.AbilityCha\",\n};\n\n/**\n * The set of Ability Scores used within the system in short form\n */\nexport const abilitiesShort = {\n  str: \"FFD20.AbilityShortStr\",\n  dex: \"FFD20.AbilityShortDex\",\n  con: \"FFD20.AbilityShortCon\",\n  int: \"FFD20.AbilityShortInt\",\n  wis: \"FFD20.AbilityShortWis\",\n  cha: \"FFD20.AbilityShortCha\",\n};\n\n/**\n * The point cost to increase an ability score using Point Buy\n */\nexport const abilityCost = {\n  7: -4,\n  8: -2,\n  9: -1,\n  10: 0,\n  11: 1,\n  12: 2,\n  13: 3,\n  14: 5,\n  15: 7,\n  16: 10,\n  17: 13,\n  18: 17,\n};\n\n/**\n * Point buy calculator.\n */\nexport const pointBuy = {\n  low: { label: \"FFD20.PointBuyCalculatorLowFantasy\", points: 10 },\n  standard: { label: \"FFD20.PointBuyCalculatorStandardFantasy\", points: 15 },\n  high: { label: \"FFD20.PointBuyCalculatorHighFantasy\", points: 20 },\n  epic: { label: \"FFD20.PointBuyCalculatorEpicFantasy\", points: 25 },\n};\n\n/**\n * At which levels you receive how many new ability points.\n */\nexport const levelAbilityScores = {\n  4: 1,\n  8: 1,\n  12: 1,\n  16: 1,\n  20: 1,\n};\n\n/**\n * Data for the feature associated with ability scores gained from leveling.\n */\nexport const levelAbilityScoreFeature = {\n  img: \"systems/ffd20/icons/skills/affliction_10.jpg\",\n  name: \"FFD20.LevelUp.AbilityScore.Item.Name\",\n  system: {\n    description: {\n      value: \"FFD20.LevelUp.AbilityScore.Item.Desc\",\n    },\n    subType: \"misc\",\n  },\n  type: \"feat\",\n};\n\n/**\n * The set of Saving Throws\n */\nexport const savingThrows = {\n  fort: \"FFD20.SavingThrowFort\",\n  ref: \"FFD20.SavingThrowRef\",\n  will: \"FFD20.SavingThrowWill\",\n};\n\n/**\n * The types of classes\n */\nexport const classTypes = {\n  base: \"FFD20.ClassTypeBase\",\n  prestige: \"FFD20.ClassTypePrestige\",\n  npc: \"FFD20.ClassTypeNPC\",\n  racial: \"FFD20.ClassTypeRacial\",\n  mythic: \"FFD20.ClassTypeMythic\",\n};\n\n/**\n * Valid options for a class's BAB progression\n */\nexport const classBAB = {\n  low: \"FFD20.Low\",\n  med: \"FFD20.Medium\",\n  high: \"FFD20.High\",\n  custom: \"FFD20.Custom\",\n};\n\n/**\n * Valid options for a class's saving throw bonus progression\n */\nexport const classSavingThrows = {\n  low: \"FFD20.Poor\",\n  high: \"FFD20.Good\",\n  custom: \"FFD20.Custom\",\n};\n\n/**\n * The formulae for BAB progressions\n */\nexport const classBABFormulas = {\n  low: \"floor(@hitDice * 0.5)\",\n  med: \"floor(@hitDice * 0.75)\",\n  high: \"@hitDice\",\n  custom: \"0\",\n};\n\nexport const classFractionalBABFormulas = {\n  low: \"@hitDice * 0.5\", // 1/2\n  med: \"@hitDice * 0.75\", // 3/4\n  high: \"@hitDice\", // 1/1\n  custom: \"0\",\n};\n\n/**\n * The formulae for saving throw progressions by class type\n */\nexport const classSavingThrowFormulas = {\n  base: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  prestige: {\n    low: \"floor((1 + @hitDice) / 3)\",\n    high: \"floor((1 + @hitDice) / 2)\",\n  },\n  npc: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  racial: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  mythic: {\n    low: \"0\",\n    high: \"0\",\n  },\n  custom: {\n    low: \"0\",\n    high: \"0\",\n  },\n};\nexport const classFractionalSavingThrowFormulas = {\n  goodSaveBonus: \"2\",\n  base: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  prestige: {\n    low: \"(1 + @hitDice) / 3\",\n    high: \"(1 + @hitDice) / 2\",\n  },\n  npc: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  racial: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  mythic: {\n    low: \"0\",\n    high: \"0\",\n  },\n  custom: {\n    low: \"0\",\n    high: \"0\",\n  },\n};\n\n/**\n * The choices available for favored class bonuses\n */\nexport const favouredClassBonuses = {\n  hp: \"FFD20.FavouredClassHP\",\n  skill: \"FFD20.FavouredClassSkill\",\n  alt: \"FFD20.FavouredClassAlt\",\n};\n\n/**\n * Icons used for favored class bonus choices\n */\nexport const favouredClassBonusIcons = {\n  hp: \"fa-heartbeat\",\n  skill: \"fa-wrench\",\n  alt: \"fa-tag\",\n};\n\n/**\n * The set of Armor Classes\n */\nexport const ac = {\n  normal: \"FFD20.ACNormal\",\n  touch: \"FFD20.ACTouch\",\n  flatFooted: \"FFD20.ACFlatFooted\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Character alignment options\n */\nexport const alignments = {\n  lg: \"FFD20.AlignmentLG\",\n  ng: \"FFD20.AlignmentNG\",\n  cg: \"FFD20.AlignmentCG\",\n  ln: \"FFD20.AlignmentLN\",\n  tn: \"FFD20.AlignmentTN\",\n  cn: \"FFD20.AlignmentCN\",\n  le: \"FFD20.AlignmentLE\",\n  ne: \"FFD20.AlignmentNE\",\n  ce: \"FFD20.AlignmentCE\",\n};\n\n/**\n * Character alignment options in their short form\n */\nexport const alignmentsShort = {\n  lg: \"FFD20.AlignmentShortLG\",\n  ng: \"FFD20.AlignmentShortNG\",\n  cg: \"FFD20.AlignmentShortCG\",\n  ln: \"FFD20.AlignmentShortLN\",\n  tn: \"FFD20.AlignmentShortTN\",\n  cn: \"FFD20.AlignmentShortCN\",\n  le: \"FFD20.AlignmentShortLE\",\n  ne: \"FFD20.AlignmentShortNE\",\n  ce: \"FFD20.AlignmentShortCE\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * The set of Armor Proficiencies which a character may have\n */\nexport const armorProficiencies = {\n  lgt: \"FFD20.ArmorProfLight\",\n  med: \"FFD20.ArmorProfMedium\",\n  hvy: \"FFD20.ArmorProfHeavy\",\n  shl: \"FFD20.ArmorProfShield\",\n  twr: \"FFD20.ArmorProfTowerShield\",\n};\n\n/**\n * The set of broad Weapon Proficiencies a character may have\n */\nexport const weaponProficiencies = {\n  sim: \"FFD20.WeaponProfSimple\",\n  mar: \"FFD20.WeaponProfMartial\",\n  exo: \"FFD20.WeaponProfExotic\",\n  che: \"FFD20.WeaponProfChef\",\n  pow: \"FFD20.WeaponProfPower\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * This describes the ways that an ability can be activated.\n */\nexport const abilityActivationTypes = {\n  passive: \"FFD20.ActivationTypePassive\",\n  free: \"FFD20.ActivationTypeFree\",\n  nonaction: \"FFD20.ActivationTypeNonaction\",\n  swift: \"FFD20.ActivationTypeSwift\",\n  immediate: \"FFD20.ActivationTypeImmediate\",\n  move: \"FFD20.ActivationTypeMove\",\n  standard: \"FFD20.ActivationTypeStandard\",\n  full: \"FFD20.ActivationTypeFullround\",\n  attack: \"FFD20.ActivationTypeAttack\",\n  aoo: \"FFD20.ActivationTypeAoO\",\n  round: \"FFD20.ActivationTypeRound\",\n  minute: \"FFD20.ActivationTypeMinute\",\n  hour: \"FFD20.ActivationTypeHour\",\n  special: \"FFD20.ActivationTypeSpecial\",\n};\n\n/**\n * This describes plurals for activation types.\n */\nexport const abilityActivationTypesPlurals = {\n  free: \"FFD20.ActivationTypeFreePlural\",\n  swift: \"FFD20.ActivationTypeSwiftPlural\",\n  immediate: \"FFD20.ActivationTypeImmediatePlural\",\n  move: \"FFD20.ActivationTypeMovePlural\",\n  standard: \"FFD20.ActivationTypeStandardPlural\",\n  full: \"FFD20.ActivationTypeFullroundPlural\",\n  attack: \"FFD20.ActivationTypeAttackPlural\",\n  round: \"FFD20.ActivationTypeRoundPlural\",\n  minute: \"FFD20.ActivationTypeMinutePlural\",\n  hour: \"FFD20.ActivationTypeHourPlural\",\n};\n\n/**\n * This describes the ways that an ability can be activated when using\n * Unchained rules.\n */\nexport const abilityActivationTypes_unchained = {\n  passive: \"FFD20.ActivationTypePassive\",\n  free: \"FFD20.ActivationTypeFree\",\n  nonaction: \"FFD20.ActivationTypeNonaction\",\n  reaction: \"FFD20.ActivationTypeReaction\",\n  action: \"FFD20.ActivationTypeAction\",\n  attack: \"FFD20.ActivationTypeAttack\",\n  aoo: \"FFD20.ActivationTypeAoO\",\n  minute: \"FFD20.ActivationTypeMinute\",\n  hour: \"FFD20.ActivationTypeHour\",\n  special: \"FFD20.ActivationTypeSpecial\",\n};\n\n/**\n * This describes plurals for the ways that an ability can be activated when\n * using Unchained rules.\n */\nexport const abilityActivationTypesPlurals_unchained = {\n  passive: \"FFD20.ActivationTypePassive\",\n  free: \"FFD20.ActivationTypeFreePlural\",\n  reaction: \"FFD20.ActivationTypeReactionPlural\",\n  action: \"FFD20.ActivationTypeActionPlural\",\n  minute: \"FFD20.ActivationTypeMinutePlural\",\n  hour: \"FFD20.ActivationTypeHourPlural\",\n  special: \"FFD20.ActivationTypeSpecial\",\n};\n\n/**\n * The possible conditions when using Wound Threshold rules\n */\nexport const woundThresholdConditions = {\n  0: \"FFD20.WoundLevelHealthy\",\n  1: \"FFD20.WoundLevelGrazed\",\n  2: \"FFD20.WoundLevelWounded\",\n  3: \"FFD20.WoundLevelCritical\",\n};\n\n/**\n * Change targets affected by Wound Thresholds.\n */\nexport const woundThresholdChangeTargets = [\"~attackCore\", \"cmd\", \"allSavingThrows\", \"ac\", \"~skillMods\", \"allChecks\"];\n\nexport const divineFocus = {\n  0: \"\",\n  1: \"FFD20.SpellComponentDivineFocusAlone\",\n  2: \"FFD20.SpellComponentDivineFocusMaterial\",\n  3: \"FFD20.SpellComponentDivineFocusFocus\",\n};\n\n/**\n * The measure template types available e.g. for spells\n */\nexport const measureTemplateTypes = {\n  cone: \"FFD20.MeasureTemplateCone\",\n  circle: \"FFD20.MeasureTemplateCircle\",\n  ray: \"FFD20.MeasureTemplateRay\",\n  rect: \"FFD20.MeasureTemplateRectangle\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * The possible creature sizes\n */\nexport const actorSizes = {\n  fine: \"FFD20.ActorSizeFine\",\n  dim: \"FFD20.ActorSizeDiminutive\",\n  tiny: \"FFD20.ActorSizeTiny\",\n  sm: \"FFD20.ActorSizeSmall\",\n  med: \"FFD20.ActorSizeMedium\",\n  lg: \"FFD20.ActorSizeLarge\",\n  huge: \"FFD20.ActorSizeHuge\",\n  grg: \"FFD20.ActorSizeGargantuan\",\n  col: \"FFD20.ActorSizeColossal\",\n};\n\n/**\n * The possible creature sizes in their one-letter form\n */\nexport const sizeChart = {\n  fine: \"F\",\n  dim: \"D\",\n  tiny: \"T\",\n  sm: \"S\",\n  med: \"M\",\n  lg: \"L\",\n  huge: \"H\",\n  grg: \"G\",\n  col: \"C\",\n};\n\n/**\n * The size values for Tokens according to the creature's size\n */\nexport const tokenSizes = {\n  fine: { w: 1, h: 1, scale: 0.45 },\n  dim: { w: 1, h: 1, scale: 0.6 },\n  tiny: { w: 1, h: 1, scale: 0.75 },\n  sm: { w: 1, h: 1, scale: 0.9 },\n  med: { w: 1, h: 1, scale: 1 },\n  lg: { w: 2, h: 2, scale: 1 },\n  huge: { w: 3, h: 3, scale: 1 },\n  grg: { w: 4, h: 4, scale: 1 },\n  col: { w: 6, h: 6, scale: 1 },\n};\n\n/**\n * The size modifier applied to creatures not of medium size\n */\nexport const sizeMods = {\n  fine: 8,\n  dim: 4,\n  tiny: 2,\n  sm: 1,\n  med: 0,\n  lg: -1,\n  huge: -2,\n  grg: -4,\n  col: -8,\n};\n\n/**\n * The size modifier applied to creatures not of medium size\n */\nexport const sizeSpecialMods = {\n  fine: -8,\n  dim: -4,\n  tiny: -2,\n  sm: -1,\n  med: 0,\n  lg: 1,\n  huge: 2,\n  grg: 4,\n  col: 8,\n};\n\n/**\n * The size modifier applied to fly checks of creatures not of medium size\n */\nexport const sizeFlyMods = {\n  fine: 8,\n  dim: 6,\n  tiny: 4,\n  sm: 2,\n  med: 0,\n  lg: -2,\n  huge: -4,\n  grg: -6,\n  col: -8,\n};\n\n/**\n * The size modifier applied to stealth checks of creatures not of medium size\n */\nexport const sizeStealthMods = {\n  fine: 16,\n  dim: 12,\n  tiny: 8,\n  sm: 4,\n  med: 0,\n  lg: -4,\n  huge: -8,\n  grg: -12,\n  col: -16,\n};\n\n/**\n * The possible options for a creature's maneuverability\n */\nexport const flyManeuverabilities = {\n  clumsy: \"FFD20.FlyManeuverabilityClumsy\",\n  poor: \"FFD20.FlyManeuverabilityPoor\",\n  average: \"FFD20.FlyManeuverabilityAverage\",\n  good: \"FFD20.FlyManeuverabilityGood\",\n  perfect: \"FFD20.FlyManeuverabilityPerfect\",\n};\n\n/**\n * The bonus values for a creature's maneuverability\n */\nexport const flyManeuverabilityValues = {\n  clumsy: -8,\n  poor: -4,\n  average: 0,\n  good: 4,\n  perfect: 8,\n};\n\n/**\n * The resulting speed values when a base speed is reduced\n */\nexport const speedReduction = {\n  5: 5,\n  15: 10,\n  20: 15,\n  30: 20,\n  35: 25,\n  45: 30,\n  50: 35,\n  60: 40,\n  65: 45,\n  75: 50,\n  80: 55,\n  90: 60,\n  95: 65,\n  105: 70,\n  110: 75,\n  120: 80,\n};\n\n/* -------------------------------------------- */\n\n/**\n * An array of maximum carry capacities, where the index is the ability/strength score.\n */\n// prettier-ignore\nexport const encumbranceLoads =  [\n    0,\n    10,\n    20,\n    30,\n    40,\n    50,\n    60,\n    70,\n    80,\n    90,\n    100,\n    115,\n    130,\n    150,\n    175,\n    200,\n    230,\n    260,\n    300,\n    350,\n    400,\n    460,\n    520,\n    600,\n    700,\n    800,\n    920,\n    1040,\n    1200,\n    1400,\n    1600,\n    1840,\n    2080,\n    2400,\n    2800,\n    3200,\n    3680,\n    4160,\n    4800,\n    5600,\n    6400,\n    7360,\n    8320,\n    9600,\n    11200,\n    12800,\n    14720,\n    16640,\n    19200,\n    22400,\n    25600,\n  ];\n\n/**\n * Encumbrance levels for light, medium, and heavy loads.\n *\n * @see {@link ActorPF._computeEncumbrance ActorPF.system.encumbrance.level}\n * @readonly\n * @enum {number}\n */\nexport const encumbranceLevels = {\n  light: 0,\n  medium: 1,\n  heavy: 2,\n};\n\n/**\n * Encumbrance multipliers applied due to a creature's size for bi- and\n * quadrupedal creatures.\n */\nexport const encumbranceMultipliers = {\n  normal: {\n    fine: 0.125,\n    dim: 0.25,\n    tiny: 0.5,\n    sm: 0.75,\n    med: 1,\n    lg: 2,\n    huge: 4,\n    grg: 8,\n    col: 16,\n  },\n  quadruped: {\n    fine: 0.25,\n    dim: 0.5,\n    tiny: 0.75,\n    sm: 1,\n    med: 1.5,\n    lg: 3,\n    huge: 6,\n    grg: 12,\n    col: 24,\n  },\n};\n\n/**\n * Damage multipliers from ability score.\n */\nexport const abilityDamageMultipliers = [\n  { value: 0.5, label: \"0.5\" },\n  { value: 1, label: \"1\" },\n  { value: 1.5, label: \"1.5\" },\n  { value: 2, label: \"2\" },\n  { value: 2.5, label: \"2.5\" },\n];\n\n/* -------------------------------------------- */\n\n/**\n * The types for Items\n */\nexport const itemTypes = {\n  equipment: \"FFD20.ItemTypeEquipment\",\n  weapon: \"FFD20.ItemTypeWeapon\",\n  loot: \"FFD20.ItemTypeLoot\",\n  consumable: \"FFD20.ItemTypeConsumable\",\n  class: \"FFD20.ItemTypeClass\",\n  buff: \"FFD20.ItemTypeBuff\",\n  spell: \"FFD20.ItemTypeSpell\",\n  feat: \"FFD20.ItemTypeFeat\",\n  attack: \"FFD20.ItemTypeAttack\",\n};\n\n/**\n * Classification types for item action types\n */\nexport const itemActionTypes = {\n  mwak: \"FFD20.ActionMWAK\",\n  rwak: \"FFD20.ActionRWAK\",\n  msak: \"FFD20.ActionMSAK\",\n  rsak: \"FFD20.ActionRSAK\",\n  mcman: \"FFD20.ActionMCMan\",\n  rcman: \"FFD20.ActionRCMan\",\n  spellsave: \"FFD20.ActionSpellSave\",\n  save: \"FFD20.ActionSave\",\n  heal: \"FFD20.ActionHeal\",\n  other: \"FFD20.ActionOther\",\n};\n\n/* -------------------------------------------- */\n\nexport const itemCapacityTypes = {\n  items: \"FFD20.ItemContainerCapacityItems\",\n  weight: \"FFD20.ItemContainerCapacityWeight\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Enumerate the lengths of time over which an item can have limited use ability\n */\nexport const limitedUsePeriods = {\n  single: \"FFD20.LimitedUseSingle\",\n  unlimited: \"FFD20.Unlimited\",\n  day: \"FFD20.LimitedUseDay\",\n  week: \"FFD20.LimitedUseWeek\",\n  charges: \"FFD20.LimitedUseCharges\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * The various equipment types and their subtypes\n */\nexport const equipmentTypes = {\n  armor: {\n    _label: \"FFD20.EquipTypeArmor\",\n    lightArmor: \"FFD20.EquipTypeLight\",\n    mediumArmor: \"FFD20.EquipTypeMedium\",\n    heavyArmor: \"FFD20.EquipTypeHeavy\",\n  },\n  shield: {\n    _label: \"FFD20.EquipTypeShield\",\n    lightShield: \"FFD20.EquipTypeLightShield\",\n    heavyShield: \"FFD20.EquipTypeHeavyShield\",\n    towerShield: \"FFD20.EquipTypeTowerShield\",\n    other: \"FFD20.EquipTypeOtherShield\",\n  },\n  wondrous: {\n    _label: \"FFD20.EquipTypeWondrousItem\",\n  },\n  clothing: {\n    _label: \"FFD20.EquipTypeClothing\",\n  },\n  materia: {\n    _label: \"FFD20.Materia\",\n    ability: \"FFD20.MateriaTypeAbility\",\n    independent: \"FFD20.MateriaTypeIndependent\",\n    spell: \"FFD20.MateriaTypeSpell\",\n    summon: \"FFD20.MateriaTypeSummon\",\n    support: \"FFD20.MateriaTypeSupport\",\n  },\n  other: {\n    _label: \"FFD20.Other\",\n  },\n};\n\n/**\n * The slots equipment can occupy, sorted by category\n */\nexport const equipmentSlots = {\n  armor: {\n    armor: \"FFD20.EquipSlotArmor\",\n  },\n  shield: {\n    shield: \"FFD20.EquipSlotShield\",\n  },\n  wondrous: {\n    slotless: \"FFD20.EquipSlotSlotless\",\n    head: \"FFD20.EquipSlotHead\",\n    headband: \"FFD20.EquipSlotHeadband\",\n    eyes: \"FFD20.EquipSlotEyes\",\n    shoulders: \"FFD20.EquipSlotShoulders\",\n    neck: \"FFD20.EquipSlotNeck\",\n    chest: \"FFD20.EquipSlotChest\",\n    body: \"FFD20.EquipSlotBody\",\n    belt: \"FFD20.EquipSlotBelt\",\n    wrists: \"FFD20.EquipSlotWrists\",\n    hands: \"FFD20.EquipSlotHands\",\n    ring: \"FFD20.EquipSlotRing\",\n    feet: \"FFD20.EquipSlotFeet\",\n  },\n  clothing: {\n    clothing: \"FFD20.EquipTypeClothing\",\n  },\n  materia: {\n    any: \"FFD20.MateriaSlotAny\",\n    weapon: \"FFD20.MateriaSlotWeapon\",\n    shield: \"FFD20.MateriaSlotShield\",\n    armor: \"FFD20.MateriaSlotArmor\",\n    weaponarmor: \"FFD20.MateriaSlotWeaponArmor\",\n    armorShield: \"FFD20.MateriaSlotArmorShield\",\n    other: \"FFD20.MateriaSlotOther\",\n  },\n  other: {\n    other: \"FFD20.Other\",\n  },\n};\n\n/**\n * The subtypes for loot items\n */\nexport const lootTypes = {\n  gear: \"FFD20.LootTypeGear\",\n  ammo: \"FFD20.LootTypeAmmo\",\n  tradeGoods: \"FFD20.LootTypeTradeGoods\",\n  misc: \"FFD20.Misc\",\n};\n\n/**\n * The subtypes for ammo type loot items\n */\nexport const ammoTypes = {\n  arrow: \"FFD20.AmmoTypeArrow\",\n  bolt: \"FFD20.AmmoTypeBolt\",\n  repeatingBolt: \"FFD20.AmmoTypeRepeatingBolt\",\n  slingBullet: \"FFD20.AmmoTypeBulletSling\",\n  gunBullet: \"FFD20.AmmoTypeBulletGun\",\n  dragoonBullet: \"FFD20.AmmoTypeBulletDragoon\",\n  dart: \"FFD20.AmmoTypeDart\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Enumerate the valid consumable types which are recognized by the system\n */\nexport const consumableTypes = {\n  potion: \"FFD20.ConsumableTypePotion\",\n  oil: \"FFD20.ConsumableTypeOil\",\n  poison: \"FFD20.ConsumableTypePoison\",\n  drug: \"FFD20.ConsumableTypeDrug\",\n  alchContact: \"FFD20.ConsumableTypeAlchContact\",\n  alchIngested: \"FFD20.ConsumableTypeAlchIngested\",\n  alchInhaled: \"FFD20.ConsumableTypeAlchInhaled\",\n  scroll: \"FFD20.ConsumableTypeScroll\",\n  wand: \"FFD20.ConsumableTypeWand\",\n  rod: \"FFD20.ConsumableTypeRod\",\n  staff: \"FFD20.ConsumableTypeStaff\",\n  misc: \"FFD20.Misc\",\n};\n\nexport const attackTypes = {\n  weapon: \"FFD20.AttackTypeWeapon\",\n  natural: \"FFD20.AttackTypeNatural\",\n  ability: \"FFD20.AttackTypeAbility\",\n  racialAbility: \"FFD20.AttackTypeRacial\",\n  item: \"FFD20.Item\",\n  misc: \"FFD20.Misc\",\n};\n\nexport const featTypes = {\n  feat: \"FFD20.FeatTypeFeat\",\n  classFeat: \"FFD20.FeatTypeClassFeat\",\n  trait: \"FFD20.FeatTypeTraits\",\n  racial: \"FFD20.FeatTypeRacial\",\n  misc: \"FFD20.Misc\",\n  template: \"FFD20.FeatTypeTemplate\",\n};\n\nexport const featTypesPlurals = {\n  feat: \"FFD20.FeatPlural\",\n  classFeat: \"FFD20.ClassFeaturePlural\",\n  trait: \"FFD20.TraitPlural\",\n  racial: \"FFD20.RacialTraitPlural\",\n  template: \"FFD20.TemplatePlural\",\n};\n\nexport const traitTypes = {\n  combat: \"FFD20.Trait.Combat\",\n  magic: \"FFD20.Trait.Magic\",\n  faith: \"FFD20.Trait.Faith\",\n  social: \"FFD20.Trait.Social\",\n  campaign: \"FFD20.Trait.Campaign\",\n  cosmic: \"FFD20.Trait.Cosmic\",\n  equipment: \"FFD20.Trait.Equipment\",\n  exemplar: \"FFD20.Trait.Exemplar\",\n  faction: \"FFD20.Trait.Faction\",\n  family: \"FFD20.Trait.Family\",\n  mount: \"FFD20.Trait.Mount\",\n  race: \"FFD20.Trait.Race\",\n  region: \"FFD20.Trait.Region\",\n  religion: \"FFD20.Trait.Religion\",\n  drawback: \"FFD20.Trait.Drawback\",\n};\n\n/**\n * Ability types, each with their short and their long form\n */\nexport const abilityTypes = {\n  ex: {\n    short: \"FFD20.AbilityTypeShortExtraordinary\",\n    long: \"FFD20.AbilityTypeExtraordinary\",\n  },\n  su: {\n    short: \"FFD20.AbilityTypeShortSupernatural\",\n    long: \"FFD20.AbilityTypeSupernatural\",\n  },\n  sp: {\n    short: \"FFD20.AbilityTypeShortSpell-Like\",\n    long: \"FFD20.AbilityTypeSpell-Like\",\n  },\n};\n\n/* -------------------------------------------- */\n\n/**\n * The valid currency denominations supported by the game system\n */\nexport const currencies = {\n  pgil: \"FFD20.CurrencyPGil\",\n  gil: \"FFD20.CurrencyGil\",\n  sgil: \"FFD20.CurrencySGil\",\n  cgil: \"FFD20.CurrencyCGil\",\n};\n\n/**\n * Resultant armor types for an actor's worn armor as per their roll data\n *\n * @see {@link ActorPF.getRollData ActorRollData.armor.type}\n * @readonly\n * @enum {number}\n */\nexport const armorTypes = {\n  none: 0,\n  light: 1,\n  medium: 2,\n  heavy: 3,\n};\n\n/**\n * Resultant shield types for an actor's worn shield\n *\n * @see {@link ActorPF.getRollData ActorRollData.shield.type}\n * @readonly\n * @enum {number}\n */\nexport const shieldTypes = {\n  none: 0,\n  other: 1, // buckler\n  light: 2,\n  heavy: 3,\n  tower: 4,\n};\n\n/**\n * The types of bonus modifiers\n */\nexport const bonusModifiers = {\n  untyped: \"FFD20.BonusModifierUntyped\",\n  untypedPerm: \"FFD20.BonusModifierUntypedPerm\",\n  base: \"FFD20.BonusModifierBase\",\n  enh: \"FFD20.BonusModifierEnhancement\",\n  dodge: \"FFD20.BonusModifierDodge\",\n  haste: \"FFD20.BonusModifierHaste\",\n  inherent: \"FFD20.BonusModifierInherent\",\n  deflection: \"FFD20.BonusModifierDeflection\",\n  morale: \"FFD20.BonusModifierMorale\",\n  luck: \"FFD20.BonusModifierLuck\",\n  sacred: \"FFD20.BonusModifierSacred\",\n  insight: \"FFD20.BonusModifierInsight\",\n  resist: \"FFD20.BonusModifierResistance\",\n  profane: \"FFD20.BonusModifierProfane\",\n  trait: \"FFD20.BonusModifierTrait\",\n  racial: \"FFD20.BonusModifierRacial\",\n  size: \"FFD20.BonusModifierSize\",\n  competence: \"FFD20.BonusModifierCompetence\",\n  circumstance: \"FFD20.BonusModifierCircumstance\",\n  alchemical: \"FFD20.BonusModifierAlchemical\",\n  penalty: \"FFD20.BonusModifierPenalty\",\n};\n\n/**\n * An array of stacking bonus modifiers by their keys for {@link bonusModifiers}\n */\nexport const stackingBonusModifiers = [\"untyped\", \"untypedPerm\", \"dodge\", \"racial\", \"penalty\"];\n\n/* -------------------------------------------- */\n\n/* -------------------------------------------- */\n\n/**\n * Valid options for the range of abilities and spells\n */\nexport const distanceUnits = {\n  none: \"FFD20.None\",\n  personal: \"FFD20.DistPersonal\",\n  touch: \"FFD20.DistTouch\",\n  melee: \"FFD20.DistMelee\",\n  reach: \"FFD20.DistReach\",\n  close: \"FFD20.DistClose\",\n  medium: \"FFD20.DistMedium\",\n  long: \"FFD20.DistLong\",\n  ft: \"FFD20.DistFt\",\n  mi: \"FFD20.DistMi\",\n  spec: \"FFD20.Special\",\n  seeText: \"FFD20.SeeText\",\n  unlimited: \"FFD20.Unlimited\",\n};\n\nexport const measureUnits = {\n  ft: \"FFD20.DistFt\",\n  mi: \"FFD20.DistMi\",\n  m: \"FFD20.DistM\",\n  km: \"FFD20.DistKM\",\n};\n\nexport const measureUnitsShort = {\n  ft: \"FFD20.DistFtShort\",\n  mi: \"FFD20.DistMiShort\",\n  m: \"FFD20.DistMShort\",\n  km: \"FFD20.DistKMShort\",\n};\n\nexport const actorStatures = {\n  tall: \"FFD20.StatureTall\",\n  long: \"FFD20.StatureLong\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * This Object defines the types of single or area targets which can be applied in the game system.\n */\nexport const targetTypes = {\n  none: \"FFD20.None\",\n  self: \"FFD20.TargetSelf\",\n  creature: \"FFD20.TargetCreature\",\n  ally: \"FFD20.TargetAlly\",\n  enemy: \"FFD20.TargetEnemy\",\n  object: \"FFD20.TargetObject\",\n  space: \"FFD20.TargetSpace\",\n  radius: \"FFD20.TargetRadius\",\n  sphere: \"FFD20.TargetSphere\",\n  cylinder: \"FFD20.TargetCylinder\",\n  cone: \"FFD20.TargetCone\",\n  square: \"FFD20.TargetSquare\",\n  cube: \"FFD20.TargetCube\",\n  line: \"FFD20.TargetLine\",\n  wall: \"FFD20.TargetWall\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * This Object defines the various lengths of time which can occur in FFD20\n */\nexport const timePeriods = {\n  inst: \"FFD20.TimeInst\",\n  turn: \"FFD20.TimeTurn\",\n  round: \"FFD20.TimeRound\",\n  minute: \"FFD20.TimeMinute\",\n  hour: \"FFD20.TimeHour\",\n  day: \"FFD20.TimeDay\",\n  month: \"FFD20.TimeMonth\",\n  year: \"FFD20.TimeYear\",\n  perm: \"FFD20.TimePerm\",\n  seeText: \"FFD20.SeeText\",\n  spec: \"FFD20.Special\",\n};\n\nexport const timePeriodsShort = {\n  turn: \"FFD20.TimeTurnShort\",\n  round: \"FFD20.TimeRoundShort\",\n  minute: \"FFD20.TimeMinuteShort\",\n  hour: \"FFD20.TimeHourShort\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * This Object determines spells gained and cast per level\n */\nexport const casterProgression = {\n  castsPerDay: {\n    prepared: {\n      low: [\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY, 0],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1, 0],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 0],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 0],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 3],\n      ],\n      med: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 4],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2],\n        [Number.POSITIVE_INFINITY, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 3, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    spontaneous: {\n      low: [\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 2],\n      ],\n      med: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 4],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 4],\n        [Number.POSITIVE_INFINITY, 5],\n        [Number.POSITIVE_INFINITY, 6, 3],\n        [Number.POSITIVE_INFINITY, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 6, 6],\n      ],\n    },\n    hybrid: {\n      high: [\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 4],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    prestige: {\n      low: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n      ],\n    },\n  },\n  spellsPreparedPerDay: {\n    prepared: {\n      low: [\n        [null],\n        [null],\n        [null],\n        [null, 0],\n        [null, 1],\n        [null, 1],\n        [null, 1, 0],\n        [null, 1, 1],\n        [null, 2, 1],\n        [null, 2, 1, 0],\n        [null, 2, 1, 1],\n        [null, 2, 2, 1],\n        [null, 3, 2, 1, 0],\n        [null, 3, 2, 1, 1],\n        [null, 3, 2, 2, 1],\n        [null, 3, 3, 2, 1],\n        [null, 4, 3, 2, 1],\n        [null, 4, 3, 2, 2],\n        [null, 4, 3, 3, 2],\n        [null, 4, 4, 3, 3],\n      ],\n      med: [\n        [3, 1],\n        [4, 2],\n        [4, 3],\n        [4, 3, 1],\n        [4, 4, 2],\n        [5, 4, 3],\n        [5, 4, 3, 1],\n        [5, 4, 4, 2],\n        [5, 5, 4, 3],\n        [5, 5, 4, 3, 1],\n        [5, 5, 4, 4, 2],\n        [5, 5, 5, 4, 3],\n        [5, 5, 5, 4, 3, 1],\n        [5, 5, 5, 4, 4, 2],\n        [5, 5, 5, 5, 4, 3],\n        [5, 5, 5, 5, 4, 3, 1],\n        [5, 5, 5, 5, 4, 4, 2],\n        [5, 5, 5, 5, 5, 4, 3],\n        [5, 5, 5, 5, 5, 5, 4],\n        [5, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [3, 1],\n        [4, 2],\n        [4, 2, 1],\n        [4, 3, 2],\n        [4, 3, 2, 1],\n        [4, 3, 3, 2],\n        [4, 4, 3, 2, 1],\n        [4, 4, 3, 3, 2],\n        [4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 4, 4, 3, 3],\n        [4, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    spontaneous: {\n      low: [\n        [2],\n        [3],\n        [4],\n        [4, 2],\n        [5, 3],\n        [5, 4],\n        [6, 4, 2],\n        [6, 4, 3],\n        [6, 5, 4],\n        [6, 5, 4, 2],\n        [6, 5, 4, 3],\n        [6, 6, 5, 4],\n        [6, 6, 5, 4, 2],\n        [6, 6, 5, 4, 3],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 6, 5],\n        [6, 6, 6, 6, 5],\n        [6, 6, 6, 6, 5],\n      ],\n      med: [\n        [4, 2],\n        [5, 3],\n        [6, 4],\n        [6, 4, 2],\n        [6, 4, 3],\n        [6, 4, 4],\n        [6, 5, 4, 2],\n        [6, 5, 4, 3],\n        [6, 5, 4, 4],\n        [6, 5, 5, 4, 2],\n        [6, 6, 5, 4, 3],\n        [6, 6, 5, 4, 4],\n        [6, 6, 5, 5, 4, 2],\n        [6, 6, 6, 5, 4, 3],\n        [6, 6, 6, 5, 4, 4],\n        [6, 6, 6, 5, 5, 4, 2],\n        [6, 6, 6, 6, 5, 4, 3],\n        [6, 6, 6, 6, 5, 4, 4],\n        [6, 6, 6, 6, 5, 5, 4],\n        [6, 6, 6, 6, 6, 5, 5],\n      ],\n      high: [\n        [4, 2],\n        [5, 2],\n        [5, 3],\n        [6, 3, 1],\n        [6, 4, 2],\n        [7, 4, 2, 1],\n        [7, 5, 3, 2],\n        [8, 5, 3, 2, 1],\n        [8, 5, 4, 3, 2],\n        [9, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 3, 2],\n        [9, 5, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 3],\n      ],\n    },\n    hybrid: {\n      high: [\n        [4, 2],\n        [5, 2],\n        [5, 3],\n        [6, 3, 1],\n        [6, 4, 2],\n        [7, 4, 2, 1],\n        [7, 5, 3, 2],\n        [8, 5, 3, 2, 1],\n        [8, 5, 4, 3, 2],\n        [9, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 3, 2],\n        [9, 5, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 3],\n      ],\n    },\n    prestige: {\n      low: [\n        [null, 2],\n        [null, 3],\n        [null, 4],\n        [null, 4, 2],\n        [null, 4, 3],\n        [null, 4, 4],\n        [null, 5, 4, 2],\n        [null, 5, 4, 3],\n        [null, 5, 4, 4],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n      ],\n    },\n  },\n};\n\n/* -------------------------------------------- */\n\n// Healing Types\n/**\n * Types of healing\n */\nexport const healingTypes = {\n  healing: \"FFD20.Healing\",\n  temphp: \"FFD20.HealingTemp\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Character senses options\n */\nexport const senses = {\n  bs: \"FFD20.SenseBS\",\n  bse: \"FFD20.SenseBSense\",\n  dv: \"FFD20.SenseDV\",\n  ts: \"FFD20.SenseTS\",\n  tr: \"FFD20.SenseTR\",\n  ll: \"FFD20.SenseLL\",\n  si: \"FFD20.SenseSI\",\n  sid: \"FFD20.SenseSID\",\n  sc: \"FFD20.SenseSC\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * The set of skill which can be trained in FFD20\n */\nexport const skills = {\n  /* Acrobatics */ acr: \"FFD20.SkillAcr\",\n  /* Appraise */ apr: \"FFD20.SkillApr\",\n  /* Bluff */ blf: \"FFD20.SkillBlf\",\n  /* Climb */ clm: \"FFD20.SkillClm\",\n  /* craft skills */ crf: \"FFD20.SkillCrf\",\n  /* Diplomacy */ dip: \"FFD20.SkillDip\",\n  /* Disable Device */ dev: \"FFD20.SkillDev\",\n  /* Disguise */ dis: \"FFD20.SkillDis\",\n  /* Drive */ dri: \"FFD20.SkillDri\",\n  /* Escape Artist */ esc: \"FFD20.SkillEsc\",\n  /* Fly */ fly: \"FFD20.SkillFly\",\n  /* Handle Animal */ han: \"FFD20.SkillHan\",\n  /* Heal */ hea: \"FFD20.SkillHea\",\n  /* Intimidate */ int: \"FFD20.SkillInt\",\n  /* Knowledge (arcana) */ kar: \"FFD20.SkillKAr\",\n  /* Knowledge (dungeoneering) */ kdu: \"FFD20.SkillKDu\",\n  /* Knowledge (engineering) */ ken: \"FFD20.SkillKEn\",\n  /* Knowledge (geography) */ kge: \"FFD20.SkillKGe\",\n  /* Knowledge (history) */ khi: \"FFD20.SkillKHi\",\n  /* Knowledge (local) */ klo: \"FFD20.SkillKLo\",\n  /* Knowledge (nature) */ kna: \"FFD20.SkillKNa\",\n  /* Knowledge (nobility) */ kno: \"FFD20.SkillKNo\",\n  /* Knowledge (planes) */ kpl: \"FFD20.SkillKPl\",\n  /* Knowledge (religion) */ kre: \"FFD20.SkillKRe\",\n  /* Knowledge (technology) */ kte: \"FFD20.SkillKTe\",\n  /* Linguistics */ lin: \"FFD20.SkillLin\",\n  /* Navigate */ nav: \"FFD20.SkillNav\",\n  /* Perception */ per: \"FFD20.SkillPer\",\n  /* Perform */ prf: \"FFD20.SkillPrf\",\n  /* Pilot */ pil: \"FFD20.SkillPil\",\n  /* Profession */ pro: \"FFD20.SkillPro\",\n  /* Repair */ rep: \"FFD20.SkillRep\",\n  /* Ride */ rid: \"FFD20.SkillRid\",\n  /* Sense Motive */ sen: \"FFD20.SkillSen\",\n  /* Sleight of Hand */ slt: \"FFD20.SkillSlt\",\n  /* Spellcraft */ spl: \"FFD20.SkillSpl\",\n  /* Stealth */ ste: \"FFD20.SkillSte\",\n  /* Survival */ sur: \"FFD20.SkillSur\",\n  /* Swim */ swm: \"FFD20.SkillSwm\",\n  /* Use Magic Device */ umd: \"FFD20.SkillUMD\",\n};\n\n/**\n * Compendium journal entries containing details about {@link skills}\n */\nexport const skillCompendiumEntries = {\n  acr: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.gGfJO90ZuRT4sZ9X\", // Acrobatics\n  apr: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.QGxoGsSIAOoe5dTW\", // Appraise\n  blf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.kRK5XwVBvcMi35w2\", // Bluff\n  clm: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ZAwjVOTwsBpZRgw4\", // Climb\n  crf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.3E8pxbjI8MD3JbfQ\", // craft skills\n  dip: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.uB9Fy36RUjibxqvt\", // Diplomacy\n  dev: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.cSdUATLHBFfw3v4s\", // Disable Device\n  dis: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xg25z3GIpS590NDW\", // Disguise\n  dri: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.EiaJIZVdGDvLxVll\", // Drive\n  esc: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DTNlXXg77s3178WJ\", // Escape Artist\n  fly: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.iH69GIwm8BjecrPN\", // Fly\n  han: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.IrVgSeMcAM8rAh2B\", // Handle Animal\n  hea: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.nHbYSOoe1SzqEO9w\", // Heal\n  int: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.KNn8uxHu23phKC0y\", // Intimidate\n  kar: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (arcana)\n  kdu: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (dungeoneering)\n  ken: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (engineering)\n  kge: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (geography)\n  khi: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (history)\n  klo: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (local)\n  kna: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (nature)\n  kno: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (nobility)\n  kpl: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (planes)\n  kre: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (religion)\n  kte: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ki0QvL0K7u4YuK0O\", // Knowledge (technology)\n  lin: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.SqLm3Deag2FpP8ty\", // Linguistics\n  nav: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.qtwTUimJjHnSjLkp\", // Navigate\n  per: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.2h6hz5AkTDxKPFxr\", // Perception\n  prf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.emzBKDFNkNnC7N8u\", // Perform\n  pil: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.rVqzliJeSlYj7ewt\", // Pilot\n  pro: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.224EaK0K72NhCeRi\", // Profession\n  rep: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DWB0xZqtaxOwfd2S\", // Repair\n  rid: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xQbTtefpEfEaOYo7\", // Ride\n  sen: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ka0VQGItdrWw3paO\", // Sense Motive\n  slt: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.joza8kAIiImrPft7\", // Sleight of Hand\n  spl: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.VRD7jxiIAxKPt6EF\", // Spellcraft\n  ste: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.wRWHk7tCUHR99PzD\", // Stealth\n  sur: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.pLdYavy4nssLEoGV\", // Survival\n  swm: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xhmDhOXuBbfVcD0Q\", // Swim\n  umd: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.A8j7nF6qHwuGEC2E\", // Use Magic Device\n};\n\n/**\n * An array of {@link skills} that can have arbitrary subskills\n */\nexport const arbitrarySkills = [\"crf\", \"prf\", \"pro\"];\n\n/**\n * An array of {@link skills} that are considered background skills.\n */\nexport const backgroundSkills = [\n  \"apr\",\n  \"crf\",\n  \"han\",\n  \"ken\",\n  \"kge\",\n  \"khi\",\n  \"kno\",\n  \"lin\",\n  \"prf\",\n  \"pro\",\n  \"slt\",\n];\n\n/**\n * Array of skills that are only shown with background skills optional rule enabled.\n */\nexport const backgroundOnlySkills = [\"lor\", \"art\"];\n\n/*\n * Number of background skills per level gained from valid classes.\n */\nexport const backgroundSkillsPerLevel = 2;\n\n/**\n * Valid class types to grant background skills.\n */\nexport const backgroundSkillClasses = [\"base\", \"prestige\"];\n\n/**\n * Bonus modifier granted to class skills.\n */\nexport const classSkillBonus = 3;\n\n/* -------------------------------------------- */\n\n/**\n * Valid options for how a spell is prepared\n */\nexport const spellPreparationModes = {\n  atwill: \"FFD20.SpellPrepAtWill\",\n  prepared: \"FFD20.SpellPrepPrepared\",\n  spontaneous: \"FFD20.SpellPrepSpontaneous\",\n};\n\nexport const classCasterType = {\n  astrologian: \"high\",\n  blackmage: \"high\",\n  bluemage: \"high\",\n  geomancer: \"high\",\n  illusionist: \"high\",\n  necromancer: \"high\",\n  summoner: \"high\",\n  timemage: \"high\",\n  whitemage: \"high\",\n  bard: \"med\",\n  cleric: \"med\",\n  redmage: \"med\",\n  scholar: \"med\",\n  darkknight: \"low\",\n  holyknight: \"low\",\n};\n\nexport const spellcasting = {\n  type: {\n    spontaneous: \"FFD20.SpellPrepSpontaneous\",\n    prepared: \"FFD20.SpellPrepPrepared\",\n    hybrid: \"FFD20.Arcanist\",\n  },\n  spells: {\n    astrologian: \"Astrologian\",\n    blackmage: \"Black Mage\",\n    bluemage: \"Blue Mage\",\n    geomancer: \"Geomancer\",\n    illusionist: \"Illusionist\",\n    necromancer: \"Necromancer\",\n    summoner: \"Summoner\",\n    timemage: \"Time Mage\",\n    whitemage: \"White Mage\",\n    bard: \"Bard\",\n    cleric: \"Cleric\",\n    redmage: \"Red Mage\",\n    scholar: \"Scholar\",\n    darkknight: \"Dark Knight\",\n    holyknight: \"Holy Knight\",\n  },\n};\n\nexport const magicAuraByLevel = {\n  spell: [\n    { power: \"faint\", level: 1 },\n    { power: \"moderate\", level: 4 },\n    { power: \"strong\", level: 7 },\n    { power: \"overwhelming\", level: 10 },\n  ],\n  item: [\n    { power: \"faint\", level: 1 },\n    { power: \"moderate\", level: 6 },\n    { power: \"strong\", level: 12 },\n    { power: \"overwhelming\", level: 21 },\n  ],\n};\n\nexport const auraStrengths = {\n  1: \"FFD20.AuraStrength_Faint\",\n  2: \"FFD20.AuraStrength_Moderate\",\n  3: \"FFD20.AuraStrength_Strong\",\n  4: \"FFD20.AuraStrength_Overwhelming\",\n};\n\n/* -------------------------------------------- */\n\n/* -------------------------------------------- */\n\n// Weapon Types\nexport const weaponTypes = {\n  simple: {\n    _label: \"FFD20.WeaponTypeSimple\",\n    light: \"FFD20.WeaponPropLight\",\n    \"1h\": \"FFD20.WeaponPropOneHanded\",\n    \"2h\": \"FFD20.WeaponPropTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  martial: {\n    _label: \"FFD20.WeaponTypeMartial\",\n    light: \"FFD20.WeaponPropLight\",\n    \"1h\": \"FFD20.WeaponPropOneHanded\",\n    \"2h\": \"FFD20.WeaponPropTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  exotic: {\n    _label: \"FFD20.WeaponTypeExotic\",\n    light: \"FFD20.WeaponPropLight\",\n    \"1h\": \"FFD20.WeaponPropOneHanded\",\n    \"2h\": \"FFD20.WeaponPropTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  chef: {\n    _label: \"FFD20.WeaponTypeChef\",\n    light: \"FFD20.WeaponPropLight\",\n    \"1h\": \"FFD20.WeaponPropOneHanded\",\n    \"2h\": \"FFD20.WeaponPropTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  power: {\n    _label: \"FFD20.WeaponTypePower\",\n    light: \"FFD20.WeaponPropLight\",\n    \"1h\": \"FFD20.WeaponPropOneHanded\",\n    \"2h\": \"FFD20.WeaponPropTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  misc: {\n    _label: \"FFD20.Misc\",\n    splash: \"FFD20.WeaponTypeSplash\",\n    other: \"FFD20.Other\",\n  },\n};\n\n// Weapon hold types\nexport const weaponHoldTypes = {\n  normal: \"FFD20.WeaponHoldTypeNormal\",\n  \"2h\": \"FFD20.WeaponHoldTypeTwoHanded\",\n  oh: \"FFD20.WeaponHoldTypeOffhand\",\n};\n\n/**\n * Weapon groups that a weapon can belong to\n */\nexport const weaponGroups = {\n  axes: \"FFD20.WeaponGroupAxes\",\n  bladesHeavy: \"FFD20.WeaponGroupBladesHeavy\",\n  bladesLight: \"FFD20.WeaponGroupBladesLight\",\n  bows: \"FFD20.WeaponGroupBows\",\n  close: \"FFD20.WeaponGroupClose\",\n  crossbows: \"FFD20.WeaponGroupCrossbows\",\n  double: \"FFD20.WeaponGroupDouble\",\n  firearms: \"FFD20.WeaponGroupFirearms\",\n  flails: \"FFD20.WeaponGroupFlails\",\n  hammers: \"FFD20.WeaponGroupHammers\",\n  monk: \"FFD20.WeaponGroupMonk\",\n  natural: \"FFD20.WeaponGroupNatural\",\n  polearms: \"FFD20.WeaponGroupPolearms\",\n  siegeEngines: \"FFD20.WeaponGroupSiegeEngines\",\n  spears: \"FFD20.WeaponGroupSpears\",\n  thrown: \"FFD20.WeaponGroupThrown\",\n  tribal: \"FFD20.WeaponGroupTribal\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Define the set of weapon property flags which can exist on a weapon\n */\nexport const weaponProperties = {\n  ato: \"FFD20.WeaponPropAutomatic\",\n  blc: \"FFD20.WeaponPropBlocking\",\n  brc: \"FFD20.WeaponPropBrace\",\n  dea: \"FFD20.WeaponPropDeadly\",\n  dst: \"FFD20.WeaponPropDistracting\",\n  dbl: \"FFD20.WeaponPropDouble\",\n  dis: \"FFD20.WeaponPropDisarm\",\n  fin: \"FFD20.WeaponPropFinesse\",\n  frg: \"FFD20.WeaponPropFragile\",\n  grp: \"FFD20.WeaponPropGrapple\",\n  imp: \"FFD20.WeaponPropImprovised\",\n  mnk: \"FFD20.WeaponPropMonk\",\n  nnl: \"FFD20.WeaponPropNonLethal\",\n  prf: \"FFD20.WeaponPropPerformance\",\n  rch: \"FFD20.WeaponPropReach\",\n  sct: \"FFD20.WeaponPropScatter\",\n  snd: \"FFD20.WeaponPropSunder\",\n  spc: \"FFD20.WeaponPropSpecial\",\n  thr: \"FFD20.WeaponPropThrown\",\n  trp: \"FFD20.WeaponPropTrip\",\n};\n\n/**\n * The components required for casting a spell\n */\nexport const spellComponents = {\n  V: \"FFD20.SpellComponentVerbal\",\n  S: \"FFD20.SpellComponentSomatic\",\n  T: \"FFD20.SpellComponentThought\",\n  E: \"FFD20.SpellComponentEmotion\",\n  M: \"FFD20.SpellComponentMaterial\",\n  F: \"FFD20.SpellComponentFocus\",\n  DF: \"FFD20.SpellComponentDivineFocus\",\n};\n\n/**\n * Spell schools\n */\nexport const spellSchools = {\n  crn: \"FFD20.SpellSchoolChronomancy\",\n  drk: \"FFD20.SpellSchoolDark\",\n  div: \"FFD20.SpellSchoolDivination\",\n  ele: \"FFD20.SpellSchoolElemental\",\n  enc: \"FFD20.SpellSchoolEnhancing\",\n  enf: \"FFD20.SpellSchoolEnfeebling\",\n  heal: \"FFD20.SpellSchoolHealing\",\n  ill: \"FFD20.SpellSchoolIllusion\",\n  lit: \"FFD20.SpellSchoolLight\",\n  multi: \"FFD20.multiSchool\",\n  misc: \"FFD20.SpellSchoolMisc\",\n  nec: \"FFD20.SpellSchoolNecromancy\",\n  nel: \"FFD20.SpellSchoolNonElemental\",\n  sum: \"FFD20.SpellSchoolSummoning\",\n  uni: \"FFD20.SpellSchoolUniversal\",\n};\n\n/**\n * Spell multi schools\n */\nexport const multiSchools = {\n  blank: \"\",\n  sumhealenc: \"FFD20.SpellSchoolSummoningHealingEnhancing\",\n  sumheal: \"FFD20.SpellSchoolSummoningHealing\",\n  sumenfdrk: \"FFD20.SpellSchoolSummoningEnfeeblingDark\",\n  sumenflit: \"FFD20.SpellSchoolSummoningEnfeeblingLight\",\n  sumenfele: \"FFD20.SpellSchoolSummoningEnfeeblingElemental\",\n  sumenf: \"FFD20.SpellSchoolSummoningEnfeebling\",\n  sumenc: \"FFD20.SpellSchoolSummoningEnhancing\",\n  sumdrk: \"FFD20.SpellSchoolSummoningDark\",\n  sumlit: \"FFD20.SpellSchoolSummoningLight\",\n  sumele: \"FFD20.SpellSchoolSummoningElemental\",\n  sumnel: \"FFD20.SpellSchoolSummoningNonElemental\",\n  crnheal: \"FFD20.SpellSchoolChronomancyHealing\",\n  crnnec: \"FFD20.SpellSchoolChronomancyNecromancy\",\n  crnenf: \"FFD20.SpellSchoolChronomancyEnfeebling\",\n  crnenc: \"FFD20.SpellSchoolChronomancyEnhancing\",\n  healenf: \"FFD20.SpellSchoolHealingEnfeebling\",\n  healenc: \"FFD20.SpellSchoolHealingEnhancing\",\n  illenf: \"FFD20.SpellSchoolIllusionEnfeebling\",\n  illenc: \"FFD20.SpellSchoolIllusionEnhancing\",\n  necenc: \"FFD20.SpellSchoolNecromancyEnhancing\",\n  necenf: \"FFD20.SpellSchoolNecromancyEnfeebling\",\n  necele: \"FFD20.SpellSchoolNecromancyElemental\",\n  necnel: \"FFD20.SpellSchoolNecromancyNonElemental\",\n  enfenc: \"FFD20.SpellSchoolEnfeeblingEnhancing\",\n  enfdrkele: \"FFD20.SpellSchoolEnfeeblingDarkElemental\",\n  enfdrknel: \"FFD20.SpellSchoolEnfeeblingDarkNonElemental\",\n  enfdrk: \"FFD20.SpellSchoolEnfeeblingDark\",\n  enflit: \"FFD20.SpellSchoolEnfeeblingLight\",\n  enfele: \"FFD20.SpellSchoolEnfeeblingElemental\",\n  enfnel: \"FFD20.SpellSchoolEnfeeblingNonElemental\",\n  encdrk: \"FFD20.SpellSchoolEnhancingDark\",\n  enclit: \"FFD20.SpellSchoolEnhancingLight\",\n  encele: \"FFD20.SpellSchoolEnhancingElemental\",\n  encnel: \"FFD20.SpellSchoolEnhancingNonElemental\",\n  drkele: \"FFD20.SpellSchoolDarkElemental\",\n  drknel: \"FFD20.SpellSchoolDarkNonElemental\",\n  litele: \"FFD20.SpellSchoolLightElemental\",\n  litnel: \"FFD20.SpellSchoolLightNonElemental\",\n};\n\n/**\n * Spell levels\n */\nexport const spellLevels = {\n  0: \"FFD20.SpellLevel0\",\n  1: \"FFD20.SpellLevel1\",\n  2: \"FFD20.SpellLevel2\",\n  3: \"FFD20.SpellLevel3\",\n  4: \"FFD20.SpellLevel4\",\n  5: \"FFD20.SpellLevel5\",\n  6: \"FFD20.SpellLevel6\",\n  7: \"FFD20.SpellLevel7\",\n  8: \"FFD20.SpellLevel8\",\n  9: \"FFD20.SpellLevel9\",\n};\n\n/* -------------------------------------------- */\n\n/**\n * Weapon proficiency levels\n * Each level provides a proficiency multiplier\n */\nexport const proficiencyLevels = {\n  \"-4\": \"Not Proficient\",\n  0: \"Proficient\",\n};\n\n/* -------------------------------------------- */\n\nexport const conditionTypes = {\n  antagonized: \"FFD20.CondTypeAntagonized\",\n  berserk: \"FFD20.CondTypeBerserk\",\n  bleed: \"FFD20.CondTypeBleed\",\n  pf1_blind: \"FFD20.CondTypeBlinded\",\n  burning: \"FFD20.CondTypeBurning\",\n  charmed: \"FFD20.CondTypeCharmed\",\n  confused: \"FFD20.CondTypeConfused\",\n  cowering: \"FFD20.CondTypeCowering\",\n  cursed: \"FFD20.CondTypeCursed\",\n  dazed: \"FFD20.CondTypeDazed\",\n  dazzled: \"FFD20.CondTypeDazzled\",\n  pf1_deaf: \"FFD20.CondTypeDeafened\",\n  deprotect: \"FFD20.CondTypeDeprotect\",\n  deshell: \"FFD20.CondTypeDeshell\",\n  dimmed: \"FFD20.CondTypeDimmed\",\n  disabled: \"FFD20.CondTypeDisabled\",\n  diseased: \"FFD20.CondTypeDiseased\",\n  doom: \"FFD20.CondTypeDoom\",\n  drenched: \"FFD20.CondTypeDrenched\",\n  energyDrained: \"FFD20.CondTypeEnergyDrained\",\n  entangled: \"FFD20.CondTypeEntangled\",\n  exhausted: \"FFD20.CondTypeExhausted\",\n  fascinated: \"FFD20.CondTypeFascinated\",\n  fatigued: \"FFD20.CondTypeFatigued\",\n  frightened: \"FFD20.CondTypeFrightened\",\n  frog: \"FFD20.CondTypeFrog\",\n  frozen: \"FFD20.CondTypeFrozen\",\n  immobilized: \"FFD20.CondTypeImmobilized\",\n  imperil: \"FFD20.CondTypeImperil\",\n  invisible: \"FFD20.CondTypeInvisible\",\n  mini: \"FFD20.CondTypeMini\",\n  nauseated: \"FFD20.CondTypeNauseated\",\n  panicked: \"FFD20.CondTypePanicked\",\n  paralyzed: \"FFD20.CondTypeParalyzed\",\n  petrified: \"FFD20.CondTypePetrified\",\n  poisoned: \"FFD20.CondTypePoisoned\",\n  pf1_prone: \"FFD20.CondTypeProne\",\n  sapped: \"FFD20.CondTypeSapped\",\n  shaken: \"FFD20.CondTypeShaken\",\n  sickened: \"FFD20.CondTypeSickened\",\n  silenced: \"FFD20.CondTypeSilenced\",\n  pf1_sleep: \"FFD20.CondTypeSleep\",\n  slow: \"FFD20.CondTypeSlow\",\n  squalled: \"FFD20.CondTypeSqualled\",\n  staggered: \"FFD20.CondTypeStaggered\",\n  static: \"FFD20.CondTypeStatic\",\n  stop: \"FFD20.CondTypeStop\",\n  stunned: \"FFD20.CondTypeStunned\",\n  weighted: \"FFD20.CondTypeWeighted\",\n  unlucky: \"FFD20.CondTypeUnlucky\",\n  zombie: \"FFD20.CondTypeZombie\",\n};\n\nexport const conditions = {\n  antagonized: \"FFD20.CondAntagonized\",\n  berserk: \"FFD20.CondBerserk\",\n  bleed: \"FFD20.CondBleed\",\n  pf1_blind: \"FFD20.CondBlinded\",\n  burning: \"FFD20.CondBurning\",\n  charmed: \"FFD20.CondCharmed\",\n  confused: \"FFD20.CondConfused\",\n  cowering: \"FFD20.CondCowering\",\n  cursed: \"FFD20.CondCursed\",\n  dazed: \"FFD20.CondDazed\",\n  dazzled: \"FFD20.CondDazzled\",\n  pf1_deaf: \"FFD20.CondDeafened\",\n  deprotect: \"FFD20.CondDeprotect\",\n  deshell: \"FFD20.CondDeshell\",\n  dimmed: \"FFD20.CondDimmed\",\n  disabled: \"FFD20.CondDisabled\",\n  diseased: \"FFD20.CondDiseased\",\n  doom: \"FFD20.CondDoom\",\n  drenched: \"FFD20.CondDrenched\",\n  energyDrained: \"FFD20.CondEnergyDrained\",\n  entangled: \"FFD20.CondEntangled\",\n  exhausted: \"FFD20.CondExhausted\",\n  fascinated: \"FFD20.CondFascinated\",\n  fatigued: \"FFD20.CondFatigued\",\n  frightened: \"FFD20.CondFrightened\",\n  frog: \"FFD20.CondFrog\",\n  frozen: \"FFD20.CondFrozen\",\n  grappled: \"FFD20.CondGrappled\",\n  helpless: \"FFD20.CondHelpless\",\n  immobilized: \"FFD20.CondImmobilized\",\n  imperil: \"FFD20.CondImperil\",\n  incorporeal: \"FFD20.CondIncorporeal\",\n  invisible: \"FFD20.CondInvisible\",\n  mini: \"FFD20.CondMini\",\n  nauseated: \"FFD20.CondNauseated\",\n  panicked: \"FFD20.CondPanicked\",\n  paralyzed: \"FFD20.CondParalyzed\",\n  petrified: \"FFD20.CondPetrified\",\n  pinned: \"FFD20.CondPinned\",\n  poisoned: \"FFD20.CondPoisoned\",\n  pf1_prone: \"FFD20.CondProne\",\n  sapped: \"FFD20.CondSapped\",\n  shaken: \"FFD20.CondShaken\",\n  sickened: \"FFD20.CondSickened\",\n  silenced: \"FFD20.CondSilenced\",\n  pf1_sleep: \"FFD20.CondSleep\",\n  slow: \"FFD20.CondSlow\",\n  squalled: \"FFD20.CondSqualled\",\n  staggered: \"FFD20.CondStaggered\",\n  static: \"FFD20.CondStatic\",\n  stop: \"FFD20.CondStop\",\n  stunned: \"FFD20.CondStunned\",\n  unlucky: \"FFD20.CondUnlucky\",\n  weighted: \"FFD20.CondWeighted\",\n  zombie: \"FFD20.CondZombie\",\n};\n\n/**\n * Conditions that override each other.\n */\nexport const conditionTracks = {\n  fear: [\"shaken\", \"frightened\", \"panicked\"],\n  lethargy: [\"fatigued\", \"exhausted\"],\n};\n\nexport const conditionMechanics = {\n  pf1_blind: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"ac\",\n        modifier: \"penalty\",\n      },\n    ],\n    flags: [\"loseDexToAC\"],\n  },\n  dazzled: {\n    changes: [\n      {\n        formula: -1,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  pf1_deaf: {\n    changes: [\n      {\n        formula: -4,\n        subTarget: \"init\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  entangled: {\n    changes: [\n      {\n        formula: -4,\n        subTarget: \"dex\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  grappled: {\n    changes: [\n      {\n        formula: -4,\n        subTarget: \"dex\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  helpless: {\n    changes: [\n      {\n        formula: 0,\n        subTarget: \"dex\",\n        modifier: \"untypedPerm\",\n        operator: \"set\",\n        priority: 1001,\n        continuous: true,\n      },\n    ],\n  },\n  pf1_sleep: {\n    changes: [\n      {\n        formula: 0,\n        subTarget: \"dex\",\n        modifier: \"untypedPerm\",\n        operator: \"set\",\n        priority: 1001,\n        continuous: true,\n      },\n    ],\n  },\n  paralyzed: {\n    changes: [\n      {\n        formula: 0,\n        subTarget: \"dex\",\n        modifier: \"untypedPerm\",\n        operator: \"set\",\n        priority: 1001,\n        continuous: true,\n      },\n      {\n        formula: 0,\n        subTarget: \"str\",\n        modifier: \"untypedPerm\",\n        operator: \"set\",\n        priority: 1001,\n        continuous: true,\n      },\n    ],\n  },\n  pf1_prone: {\n    changes: [\n      {\n        formula: -4,\n        subTarget: \"mattack\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  pinned: {\n    changes: [\n      {\n        formula: \"min(0, @abilities.dex.mod)\",\n        subTarget: \"dexMod\",\n        modifier: \"untyped\",\n        operator: \"set\",\n        priority: 1001,\n        continuous: true,\n      },\n      {\n        formula: -4,\n        subTarget: \"ac\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -4,\n        subTarget: \"cmd\",\n        modifier: \"penalty\",\n      },\n    ],\n    flags: [\"loseDexToAC\"],\n  },\n  cowering: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"ac\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  shaken: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allSavingThrows\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"skills\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allChecks\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  frightened: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allSavingThrows\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"skills\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allChecks\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  panicked: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allSavingThrows\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"skills\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allChecks\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  sickened: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"wdamage\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allSavingThrows\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"skills\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"allChecks\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  nauseated: {\n    // Prevents actions, does not cause modifiers\n  },\n  stunned: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"ac\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  exhausted: {\n    changes: [\n      {\n        formula: -6,\n        subTarget: \"str\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -6,\n        subTarget: \"dex\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  fatigued: {\n    changes: [\n      {\n        formula: -2,\n        subTarget: \"str\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -2,\n        subTarget: \"dex\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n  squeezing: {\n    changes: [\n      {\n        formula: -4,\n        subTarget: \"ac\",\n        modifier: \"penalty\",\n      },\n      {\n        formula: -4,\n        subTarget: \"attack\",\n        modifier: \"penalty\",\n      },\n    ],\n  },\n};\n\nexport const conditionTextures = {\n  antagonized: \"systems/ffd20/icons/conditions/antagonized.png\",\n  berserk: \"systems/ffd20/icons/conditions/berserk.png\",\n  bleed: \"systems/ffd20/icons/conditions/bleed.png\",\n  pf1_blind: \"systems/ffd20/icons/conditions/blind.png\",\n  burning: \"systems/ffd20/icons/conditions/burning.png\",\n  charmed: \"systems/ffd20/icons/conditions/charmed.png\",\n  confused: \"systems/ffd20/icons/conditions/confused.png\",\n  cowering: \"systems/ffd20/icons/conditions/cowering.png\",\n  cursed: \"systems/ffd20/icons/conditions/cursed.png\",\n  dazed: \"systems/ffd20/icons/conditions/dazed.png\",\n  dazzled: \"systems/ffd20/icons/conditions/dazzled.png\",\n  pf1_deaf: \"systems/ffd20/icons/conditions/deaf.png\",\n  deprotect: \"systems/ffd20/icons/conditions/deprotect.png\",\n  deshell: \"systems/ffd20/icons/conditions/deshell.png\",\n  dimmed: \"systems/ffd20/icons/conditions/dimmed.png\",\n  disabled: \"systems/ffd20/icons/conditions/disabled.png\",\n  diseased: \"systems/ffd20/icons/conditions/diseased.png\",\n  doom: \"systems/ffd20/icons/conditions/doom.png\",\n  drenched: \"systems/ffd20/icons/conditions/drenched.png\",\n  energyDrained: \"systems/ffd20/icons/conditions/energydrained.png\",\n  entangled: \"systems/ffd20/icons/conditions/entangled.png\",\n  exhausted: \"systems/ffd20/icons/conditions/exhausted.png\",\n  fascinated: \"systems/ffd20/icons/conditions/fascinated.png\",\n  fatigued: \"systems/ffd20/icons/conditions/fatigued.png\",\n  frightened: \"systems/ffd20/icons/conditions/frightened.png\",\n  frog: \"systems/ffd20/icons/conditions/frog.png\",\n  frozen: \"systems/ffd20/icons/conditions/frozen.png\",\n  grappled: \"systems/ffd20/icons/conditions/grappled.png\",\n  helpless: \"systems/ffd20/icons/conditions/helpless.png\",\n  immobilized: \"systems/ffd20/icons/conditions/immobilized.png\",\n  imperil: \"systems/ffd20/icons/conditions/imperil.png\",\n  incorporeal: \"systems/ffd20/icons/conditions/incorporeal.png\",\n  invisible: \"systems/ffd20/icons/conditions/invisible.png\",\n  mini: \"systems/ffd20/icons/conditions/mini.png\",\n  nauseated: \"systems/ffd20/icons/conditions/nauseated.png\",\n  panicked: \"systems/ffd20/icons/conditions/fear.png\",\n  paralyzed: \"systems/ffd20/icons/conditions/paralyzed.png\",\n  petrified: \"systems/ffd20/icons/conditions/petrified.png\",\n  pinned: \"systems/ffd20/icons/conditions/pinned.png\",\n  poisoned: \"systems/ffd20/icons/conditions/poisoned.png\",\n  pf1_prone: \"systems/ffd20/icons/conditions/prone.png\",\n  sapped: \"systems/ffd20/icons/conditions/sapped.png\",\n  shaken: \"systems/ffd20/icons/conditions/shaken.png\",\n  sickened: \"systems/ffd20/icons/conditions/sickened.png\",\n  silenced: \"systems/ffd20/icons/conditions/silenced.png\",\n  pf1_sleep: \"systems/ffd20/icons/conditions/sleep.png\",\n  slow: \"systems/ffd20/icons/conditions/slow.png\",\n  squalled: \"systems/ffd20/icons/conditions/squalled.png\",\n  staggered: \"systems/ffd20/icons/conditions/staggered.png\",\n  static: \"systems/ffd20/icons/conditions/static.png\",\n  stop: \"systems/ffd20/icons/conditions/stop.png\",\n  stunned: \"systems/ffd20/icons/conditions/stunned.png\",\n  unlucky: \"systems/ffd20/icons/conditions/unlucky.png\",\n  weighted: \"systems/ffd20/icons/conditions/weighted.png\",\n  zombie: \"systems/ffd20/icons/conditions/zombie.png\",\n};\n\nexport const buffTypes = {\n  temp: \"FFD20.Temporary\",\n  perm: \"FFD20.Permanent\",\n  item: \"FFD20.Item\",\n  misc: \"FFD20.Misc\",\n};\n\n/**\n * Dictionaries of conditional modifier targets, each with a label and sub-categories\n */\nexport const conditionalTargets = {\n  attack: {\n    _label: \"FFD20.AttackRollPlural\",\n    allAttack: \"FFD20.All\",\n    hasteAttack: \"FFD20.Haste\",\n    rapidShotAttack: \"FFD20.RapidShot\",\n  },\n  damage: {\n    _label: \"FFD20.Damage\",\n    allDamage: \"FFD20.All\",\n    hasteDamage: \"FFD20.Haste\",\n    rapidShotDamage: \"FFD20.RapidShot\",\n  },\n  size: {\n    _label: \"FFD20.Size\",\n  },\n  effect: {\n    _label: \"FFD20.Effects\",\n  },\n  misc: {\n    _label: \"FFD20.MiscShort\",\n  },\n};\n\n/**\n * Dictionaries of change/buff targets, each with a label and a category it belongs to,\n * as well as a sort value that determines this buffTarget's priority when Changes are applied.\n */\nexport const buffTargets = /** @type {const} */ ({\n  acpA: { label: \"FFD20.ACPArmor\", category: \"misc\", sort: 10000 },\n  acpS: { label: \"FFD20.ACPShield\", category: \"misc\", sort: 11000 },\n  mDexA: { label: \"FFD20.MaxDexArmor\", category: \"misc\", sort: 20000 },\n  mDexS: { label: \"FFD20.MaxDexShield\", category: \"misc\", sort: 21000 },\n  str: { label: \"FFD20.AbilityStr\", category: \"ability\", sort: 30000 },\n  dex: { label: \"FFD20.AbilityDex\", category: \"ability\", sort: 31000 },\n  con: { label: \"FFD20.AbilityCon\", category: \"ability\", sort: 32000 },\n  int: { label: \"FFD20.AbilityInt\", category: \"ability\", sort: 33000 },\n  wis: { label: \"FFD20.AbilityWis\", category: \"ability\", sort: 34000 },\n  cha: { label: \"FFD20.AbilityCha\", category: \"ability\", sort: 35000 },\n  strMod: { label: \"FFD20.AbilityStrMod\", category: \"ability\", sort: 40000 },\n  dexMod: { label: \"FFD20.AbilityDexMod\", category: \"ability\", sort: 41000 },\n  conMod: { label: \"FFD20.AbilityConMod\", category: \"ability\", sort: 42000 },\n  intMod: { label: \"FFD20.AbilityIntMod\", category: \"ability\", sort: 43000 },\n  wisMod: { label: \"FFD20.AbilityWisMod\", category: \"ability\", sort: 44000 },\n  chaMod: { label: \"FFD20.AbilityChaMod\", category: \"ability\", sort: 45000 },\n  skills: { label: \"FFD20.BuffTarAllSkills\", category: \"skills\", sort: 50000 },\n  unskills: { label: \"FFD20.BuffTarUntrainedSkills\", category: \"skills\", sort: 100000 },\n  carryStr: { label: \"FFD20.CarryStrength\", category: \"misc\", sort: 60000 },\n  carryMult: { label: \"FFD20.CarryMultiplier\", category: \"misc\", sort: 61000 },\n  strSkills: { label: \"FFD20.BuffTarStrSkills\", category: \"skills\", sort: 70000 },\n  dexSkills: { label: \"FFD20.BuffTarDexSkills\", category: \"skills\", sort: 71000 },\n  conSkills: { label: \"FFD20.BuffTarConSkills\", category: \"skills\", sort: 72000 },\n  intSkills: { label: \"FFD20.BuffTarIntSkills\", category: \"skills\", sort: 73000 },\n  wisSkills: { label: \"FFD20.BuffTarWisSkills\", category: \"skills\", sort: 74000 },\n  chaSkills: { label: \"FFD20.BuffTarChaSkills\", category: \"skills\", sort: 75000 },\n  allChecks: { label: \"FFD20.BuffTarAllAbilityChecks\", category: \"abilityChecks\", sort: 80000 },\n  strChecks: { label: \"FFD20.BuffTarStrChecks\", category: \"abilityChecks\", sort: 81000 },\n  dexChecks: { label: \"FFD20.BuffTarDexChecks\", category: \"abilityChecks\", sort: 82000 },\n  conChecks: { label: \"FFD20.BuffTarConChecks\", category: \"abilityChecks\", sort: 83000 },\n  intChecks: { label: \"FFD20.BuffTarIntChecks\", category: \"abilityChecks\", sort: 84000 },\n  wisChecks: { label: \"FFD20.BuffTarWisChecks\", category: \"abilityChecks\", sort: 85000 },\n  chaChecks: { label: \"FFD20.BuffTarChaChecks\", category: \"abilityChecks\", sort: 86000 },\n  landSpeed: { label: \"FFD20.SpeedLand\", category: \"speed\", sort: 90000 },\n  climbSpeed: { label: \"FFD20.SpeedClimb\", category: \"speed\", sort: 91000 },\n  swimSpeed: { label: \"FFD20.SpeedSwim\", category: \"speed\", sort: 92000 },\n  burrowSpeed: { label: \"FFD20.SpeedBurrow\", category: \"speed\", sort: 93000 },\n  flySpeed: { label: \"FFD20.SpeedFly\", category: \"speed\", sort: 94000 },\n  allSpeeds: { label: \"FFD20.BuffTarAllSpeeds\", category: \"speed\", sort: 95000 },\n  ac: { label: \"FFD20.BuffTarACGeneric\", category: \"defense\", sort: 100000 },\n  aac: { label: \"FFD20.BuffTarACArmor\", category: \"defense\", sort: 101000 },\n  sac: { label: \"FFD20.BuffTarACShield\", category: \"defense\", sort: 102000 },\n  nac: { label: \"FFD20.BuffTarACNatural\", category: \"defense\", sort: 103000 },\n  tac: { label: \"FFD20.BuffTarACTouch\", category: \"defense\", sort: 104000 },\n  ffac: { label: \"FFD20.BuffTarACFlatFooted\", category: \"defense\", sort: 105000 },\n  attack: { label: \"FFD20.BuffTarAllAttackRolls\", category: \"attack\", sort: 110000 },\n  bab: { label: \"FFD20.BAB\", category: \"attack\", sort: 111000 },\n  \"~attackCore\": { label: \"\", category: \"attack\", sort: 112000 },\n  mattack: { label: \"FFD20.BuffTarMeleeAttack\", category: \"attack\", sort: 113000 },\n  rattack: { label: \"FFD20.BuffTarRangedAttack\", category: \"attack\", sort: 114000 },\n  damage: { label: \"FFD20.BuffTarAllDamageRolls\", category: \"damage\", sort: 120000 },\n  wdamage: { label: \"FFD20.WeaponDamage\", category: \"damage\", sort: 121000 },\n  sdamage: { label: \"FFD20.SpellDamage\", category: \"damage\", sort: 122000 },\n  critConfirm: { label: \"FFD20.CriticalConfirmation\", category: \"attack\", sort: 130000 },\n  allSavingThrows: { label: \"FFD20.BuffTarAllSavingThrows\", category: \"savingThrows\", sort: 140000 },\n  fort: { label: \"FFD20.SavingThrowFort\", category: \"savingThrows\", sort: 141000 },\n  ref: { label: \"FFD20.SavingThrowRef\", category: \"savingThrows\", sort: 142000 },\n  will: { label: \"FFD20.SavingThrowWill\", category: \"savingThrows\", sort: 143000 },\n  cmb: { label: \"FFD20.CMB\", category: \"attack\", sort: 150000 },\n  cmd: { label: \"FFD20.CMD\", category: \"defense\", sort: 151000 },\n  ffcmd: { label: \"FFD20.CMDFlatFooted\", category: \"defense\", sort: 152000 },\n  init: { label: \"FFD20.Initiative\", category: \"misc\", sort: 160000 },\n  mhp: { label: \"FFD20.HitPoints\", category: \"health\", sort: 170000 },\n  wounds: { label: \"FFD20.Wounds\", category: \"health\", sort: 180000 },\n  vigor: { label: \"FFD20.Vigor\", category: \"health\", sort: 181000 },\n  mmp: { label: \"FFD20.ManaPoints\", category: \"health\", sort: 171000 },\n  spellResist: { label: \"FFD20.SpellResistance\", category: \"defense\", sort: 190000 },\n  bonusFeats: { label: \"FFD20.BuffTarBonusFeats\", category: \"misc\", sort: 200000 },\n  bonusSkillRanks: { label: \"FFD20.BuffTarBonusSkillRanks\", category: \"skills\", sort: 210000 },\n  concentration: { label: \"FFD20.Concentration\", category: \"spell\", sort: 220000 },\n  cl: { label: \"FFD20.CasterLevel\", category: \"spell\", sort: 230000 },\n});\n\n/**\n * Categories grouping related {@link BuffTarget change targets} in the selector UI.\n */\nexport const buffTargetCategories = /** @type {const} */ ({\n  defense: { label: \"FFD20.Defense\" },\n  savingThrows: { label: \"FFD20.SavingThrowPlural\" },\n  attack: { label: \"FFD20.Attack\" },\n  damage: { label: \"FFD20.Damage\" },\n  ability: { label: \"FFD20.AbilityScore\" },\n  abilityChecks: { label: \"FFD20.BuffTarAbilityChecks\" },\n  health: { label: \"FFD20.Health\" },\n  skills: { label: \"FFD20.Skills\" },\n  skill: { label: \"FFD20.BuffTarSpecificSkill\" },\n  speed: { label: \"FFD20.Speed\" },\n  spell: { label: \"FFD20.BuffTarSpells\" },\n  misc: { label: \"FFD20.Misc\" },\n});\n\nexport const contextNoteTargets = {\n  attack: { label: \"FFD20.AttackRollPlural\", category: \"attacks\" },\n  effect: { label: \"FFD20.Effects\", category: \"attacks\" },\n  melee: { label: \"FFD20.Melee\", category: \"attacks\" },\n  meleeWeapon: { label: \"FFD20.MeleeWeapon\", category: \"attacks\" },\n  meleeSpell: { label: \"FFD20.MeleeSpell\", category: \"attacks\" },\n  ranged: { label: \"FFD20.Ranged\", category: \"attacks\" },\n  rangedWeapon: { label: \"FFD20.RangedWeapon\", category: \"attacks\" },\n  rangedSpell: { label: \"FFD20.RangedSpell\", category: \"attacks\" },\n  cmb: { label: \"FFD20.CMB\", category: \"attacks\" },\n  allSavingThrows: { label: \"FFD20.BuffTarAllSavingThrows\", category: \"savingThrows\" },\n  fort: { label: \"FFD20.SavingThrowFort\", category: \"savingThrows\" },\n  ref: { label: \"FFD20.SavingThrowRef\", category: \"savingThrows\" },\n  will: { label: \"FFD20.SavingThrowWill\", category: \"savingThrows\" },\n  skills: { label: \"FFD20.BuffTarAllSkills\", category: \"skills\" },\n  strSkills: { label: \"FFD20.BuffTarStrSkills\", category: \"skills\" },\n  dexSkills: { label: \"FFD20.BuffTarDexSkills\", category: \"skills\" },\n  conSkills: { label: \"FFD20.BuffTarConSkills\", category: \"skills\" },\n  intSkills: { label: \"FFD20.BuffTarIntSkills\", category: \"skills\" },\n  wisSkills: { label: \"FFD20.BuffTarWisSkills\", category: \"skills\" },\n  chaSkills: { label: \"FFD20.BuffTarChaSkills\", category: \"skills\" },\n  allChecks: { label: \"FFD20.BuffTarAllAbilityChecks\", category: \"abilityChecks\" },\n  strChecks: { label: \"FFD20.BuffTarStrChecks\", category: \"abilityChecks\" },\n  dexChecks: { label: \"FFD20.BuffTarDexChecks\", category: \"abilityChecks\" },\n  conChecks: { label: \"FFD20.BuffTarConChecks\", category: \"abilityChecks\" },\n  intChecks: { label: \"FFD20.BuffTarIntChecks\", category: \"abilityChecks\" },\n  wisChecks: { label: \"FFD20.BuffTarWisChecks\", category: \"abilityChecks\" },\n  chaChecks: { label: \"FFD20.BuffTarChaChecks\", category: \"abilityChecks\" },\n  spellEffect: { label: \"FFD20.SpellBuffEffect\", category: \"spell\" },\n  concentration: { label: \"FFD20.Concentration\", category: \"spell\" },\n  cl: { label: \"FFD20.CasterLevel\", category: \"spell\" },\n  ac: { label: \"FFD20.ACNormal\", category: \"defense\" },\n  cmd: { label: \"FFD20.CMD\", category: \"defense\" },\n  sr: { label: \"FFD20.SpellResistance\", category: \"defense\" },\n  init: { label: \"FFD20.Initiative\", category: \"misc\" },\n};\n\nexport const contextNoteCategories = {\n  attacks: { label: \"FFD20.Attacks\" },\n  savingThrows: { label: \"FFD20.SavingThrowPlural\" },\n  skills: { label: \"FFD20.Skills\" },\n  skill: { label: \"FFD20.BuffTarSpecificSkill\" },\n  abilityChecks: { label: \"FFD20.BuffTarAbilityChecks\" },\n  spell: { label: \"FFD20.BuffTarSpells\" },\n  defense: { label: \"FFD20.Defense\" },\n  misc: { label: \"FFD20.Misc\" },\n};\n\n/**\n * A list of FFD20's languages\n */\nexport const languages = {\n  common: \"FFD20.LanguageCommon\",\n  dwarven: \"FFD20.LanguageDwarven\",\n  elvaan: \"FFD20.LanguageElvaan\",\n  galkan: \"FFD20.LanguageGalkan\",\n  lalafellan: \"FFD20.LanguageLalafellan\",\n  mithran: \"FFD20.LanguageMithran\",\n  moogle: \"FFD20.LanguageMoogle\",\n  aegyllan: \"FFD20.LanguageAegyllan\",\n  albhedian: \"FFD20.LanguageAlbhedian\",\n  banganese: \"FFD20.LanguageBanganese\",\n  burmecian: \"FFD20.LanguageBurmecian\",\n  draconic: \"FFD20.LanguageDraconic\",\n  garif: \"FFD20.LanguageGarif\",\n  guado: \"FFD20.LanguageGuado\",\n  hypello: \"FFD20.LanguageHypello\",\n  lupin: \"FFD20.LanguageLupin\",\n  mandragoran: \"FFD20.LanguageMandragoran\",\n  numish: \"FFD20.LanguageNumish\",\n  qiqirn: \"FFD20.LanguageQiqirn\",\n  queran: \"FFD20.LanguageQueran\",\n  roegadyn: \"FFD20.LanguageRoegadyn\",\n  ronsaur: \"FFD20.LanguageRonsaur\",\n  seeq: \"FFD20.LanguageSeeq\",\n  tonberry: \"FFD20.LanguageTonberry\",\n  vieran: \"FFD20.LanguageVieran\",\n  celestial: \"FFD20.LanguageCelestial\",\n  infernal: \"FFD20.LanguageInfernal\",\n  abyssal: \"FFD20.LanguageAbyssal\",\n  aquan: \"FFD20.LanguageAquan\",\n  auran: \"FFD20.LanguageAuran\",\n  auroran: \"FFD20.LanguageAuroran\",\n  enochian: \"FFD20.LanguageEnochian\",\n  ignan: \"FFD20.LanguageIgnan\",\n  terran: \"FFD20.LanguageTerran\",\n  thorian: \"FFD20.LanguageThorian\",\n  umbran: \"FFD20.LanguageUmbran\",\n  amaljaa: \"FFD20.LanguageAmaljaa\",\n  antican: \"FFD20.LanguageAntican\",\n  goblin: \"FFD20.LanguageGoblin\",\n  kojin: \"FFD20.LanguageKojin\",\n  orcish: \"FFD20.LanguageOrcish\",\n  quadav: \"FFD20.LanguageQuadav\",\n  sahagin: \"FFD20.LanguageSahagin\",\n  sylvan: \"FFD20.LanguageSylvan\",\n  undercommon: \"FFD20.LanguageUndercommon\",\n  vanu: \"FFD20.LanguageVanu\",\n  yagudo: \"FFD20.LanguageYagudo\",\n};\n\n/**\n * Creature types\n */\nexport const creatureTypes = {\n  aberration: \"FFD20.CreatureTypeAberration\",\n  animal: \"FFD20.CreatureTypeAnimal\",\n  construct: \"FFD20.CreatureTypeConstruct\",\n  dragon: \"FFD20.CreatureTypeDragon\",\n  fey: \"FFD20.CreatureTypeFey\",\n  humanoid: \"FFD20.CreatureTypeHumanoid\",\n  magicalBeast: \"FFD20.CreatureTypeMagicalBeast\",\n  monstrousHumanoid: \"FFD20.CreatureTypeMonstrousHumanoid\",\n  ooze: \"FFD20.CreatureTypeOoze\",\n  outsider: \"FFD20.CreatureTypeOutsider\",\n  plant: \"FFD20.CreatureTypePlant\",\n  undead: \"FFD20.CreatureTypeUndead\",\n  vermin: \"FFD20.CreatureTypeVermin\",\n};\n\nexport const spellRangeFormulas = {\n  close: \"25 + floor(@cl / 2) * 5\",\n  medium: \"100 + @cl * 10\",\n  long: \"400 + @cl * 40\",\n};\n\n/**\n * An array containing the damage dice progression for size adjustments\n */\nexport const sizeDie = [\n  \"1\",\n  \"1d2\",\n  \"1d3\",\n  \"1d4\",\n  \"1d6\",\n  \"1d8\",\n  \"1d10\",\n  \"2d6\",\n  \"2d8\",\n  \"3d6\",\n  \"3d8\",\n  \"4d6\",\n  \"4d8\",\n  \"6d6\",\n  \"6d8\",\n  \"8d6\",\n  \"8d8\",\n  \"12d6\",\n  \"12d8\",\n  \"16d6\",\n  \"16d8\",\n];\n\n/**\n * Arrays of Character Level XP Requirements by XP track\n */\n// prettier-ignore\nexport const CHARACTER_EXP_LEVELS =  {\n    slow: [\n      0,\n      3000,\n      7500,\n      14000,\n      23000,\n      35000,\n      53000,\n      77000,\n      115000,\n      160000,\n      235000,\n      330000,\n      475000,\n      665000,\n      955000,\n      1350000,\n      1900000,\n      2700000,\n      3850000,\n      5350000,\n      8350000,\n      14350000,\n      26350000,\n      50350000,\n      98350000,\n      194350000,\n      386350000,\n      770350000,\n      1538350000,\n      3074350000,\n    ],\n    medium: [\n      0,\n      2000,\n      5000,\n      9000,\n      15000,\n      23000,\n      35000,\n      51000,\n      75000,\n      105000,\n      155000,\n      220000,\n      315000,\n      445000,\n      635000,\n      890000,\n      1300000,\n      1800000,\n      2550000,\n      3600000,\n      5700000,\n      9900000,\n      18300000,\n      35100000,\n      68700000,\n      135900000,\n      270300000,\n      539100000,\n      1076700000,\n      2151900000,\n    ],\n    fast: [\n      0,\n      1300,\n      3300,\n      6000,\n      10000,\n      15000,\n      23000,\n      34000,\n      50000,\n      71000,\n      105000,\n      145000,\n      210000,\n      295000,\n      425000,\n      600000,\n      850000,\n      1200000,\n      1700000,\n      2400000,\n      3800000,\n      6600000,\n      12200000,\n      23400000,\n      45800000,\n      90600000,\n      180200000,\n      359400000,\n      717800000,\n      1434600000,\n    ],\n};\n\n/**\n * An array of Challenge Rating XP Levels\n */\n// prettier-ignore\nexport const CR_EXP_LEVELS =  [\n    200,\n    400,\n    600,\n    800,\n    1200,\n    1600,\n    2400,\n    3200,\n    4800,\n    6400,\n    9600,\n    12800,\n    19200,\n    25600,\n    38400,\n    51200,\n    76800,\n    102400,\n    153600,\n    204800,\n    307200,\n    409600,\n    614400,\n    819200,\n    1228800,\n    1638400,\n    2457600,\n    3276800,\n    4915200,\n    6553600,\n    9830400,\n  ];\n\nexport const temporaryRollDataFields = {\n  actor: [\n    \"d20\",\n    \"attackBonus\",\n    \"attackCount\",\n    \"formulaicAttack\",\n    \"damageBonus\",\n    \"pointBlankBonus\",\n    \"rapidShotPenalty\",\n    \"powerAttackBonus\",\n    \"powerAttackPenalty\",\n    \"conditionals\",\n    \"concentrationBonus\",\n    \"formulaBonus\",\n    \"dcBonus\",\n    \"chargeCostBonus\",\n    \"chargeCost\",\n    \"sizeBonus\",\n    \"bonus\",\n    \"critMult\",\n    \"ablMult\",\n    \"ablDamage\",\n    \"cl\",\n    \"sl\",\n    \"classLevel\",\n    \"ablMod\",\n    \"item\",\n    \"action\",\n    \"level\",\n    \"mod\",\n  ],\n};\n\nexport const keepItemLinksOnCopy = [\"classAssociations\"];\n\nexport const classSubTypes = {\n  none: \"FFD20.None\",\n  core: \"FFD20.ClassSubTypeCore\",\n  coreArc: \"FFD20.ClassSubTypeCoreArc\",\n  base: \"FFD20.ClassSubTypeBase\",\n  baseArc: \"FFD20.ClassSubTypeBaseArc\",\n  hybrid: \"FFD20.ClassSubTypeHybrid\",\n  hybridArc: \"FFD20.ClassSubTypeHybridArc\",\n};\n\nexport const countforexp = {\n  exp: \"FFD20.ClassExp\",\n  noExp: \"FFD20.ClassNoExp\",\n};\n\nexport const classCastingStats = {\n  noncaster: \"FFD20.NonCaster\",\n  int: \"FFD20.AbilityShortInt\",\n  wis: \"FFD20.AbilityShortWis\",\n  cha: \"FFD20.AbilityShortCha\",\n  intAndWis: \"FFD20.AbilityShortIntAndWis\",\n};\n\nexport const classBaseMPTypes = {\n  noncaster: \"FFD20.NonCaster\",\n  halfCaster: \"FFD20.HalfCaster\",\n  dimPacman: \"FFD20.DimPacman\",\n  pacman: \"FFD20.Pacman\",\n  dimFullCaster: \"FFD20.DimFullCaster\",\n  fullCaster: \"FFD20.FullCaster\",\n  advFullCaster: \"FFD20.AdvFullCaster\",\n};\n\n// Current Max Spell Level based on lvl\nexport const ClassSpellLvlProgression = {\n  noncaster: \"0\",\n  halfCaster: \"min(floor(max(@level - 3 ,0) / 3),4)\",\n  dimPacman: \"min(floor((@level + 2) / 3),6)\",\n  pacman: \"min(floor((@level + 2) / 3),6)\",\n  dimFullCaster: \"min(floor((@level + 1) / 2),9)\",\n  fullCaster: \"min(floor((@level + 1) / 2),9)\",\n  advFullCaster: \"min(floor((@level + 1) / 2),9)\",\n};\n\n// Character MP from levels TODO add other mp bases\n// level        1 2 3 4 5  6  7  8  9 10 11 12 13 14 15 16 17  18  19  20\nexport const classMPlevels = {\n  noncaster: [0],\n  halfCaster: [0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 14, 16, 19, 22, 25, 29, 33],\n  dimPacman: [1, 2, 3, 4, 5, 6, 8, 10, 12, 15, 18, 21, 25, 29, 33, 38, 43, 48, 53, 58],\n  pacman: [2, 3, 4, 5, 6, 8, 10, 13, 16, 20, 24, 29, 34, 39, 45, 51, 57, 64, 71, 79],\n  dimFullCaster: [2, 3, 4, 5, 6, 8, 11, 15, 20, 24, 29, 35, 42, 49, 56, 65, 74, 83, 92, 101],\n  fullCaster: [3, 4, 5, 6, 8, 11, 15, 20, 26, 32, 39, 47, 56, 65, 75, 86, 98, 110, 122, 135],\n  advFullCaster: [4, 6, 8, 9, 14, 17, 25, 30, 41, 47, 60, 68, 84, 93, 111, 124, 143, 155, 167, 180],\n};\n\n// Character MP from stat\n// stat mod 0 1 2 3  4  5  6  7  8  9 10 11 12  13  14  15  16  17\nexport const classMPStatsBonus = {\n  1: [0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5],\n  2: [0, 1, 3, 3, 3, 4, 6, 6, 6, 7, 9, 9, 9, 10, 12, 12, 12, 13],\n  3: [0, 1, 3, 6, 6, 7, 9, 12, 12, 13, 15, 18, 18, 19, 21, 24, 24, 25],\n  4: [0, 1, 3, 6, 10, 11, 13, 16, 20, 21, 23, 26, 30, 31, 33, 36, 40, 41],\n  5: [0, 1, 3, 6, 10, 16, 18, 21, 25, 31, 33, 36, 40, 46, 48, 51, 55, 61],\n  6: [0, 1, 3, 6, 10, 16, 24, 27, 31, 37, 45, 48, 52, 58, 66, 69, 73, 79],\n  7: [0, 1, 3, 6, 10, 16, 24, 34, 38, 44, 52, 62, 66, 72, 80, 90, 94, 100],\n  8: [0, 1, 3, 6, 10, 16, 24, 34, 46, 52, 60, 70, 82, 88, 96, 106, 118, 124],\n  9: [0, 1, 3, 6, 10, 16, 24, 34, 46, 61, 69, 79, 91, 106, 114, 124, 136, 151],\n};\n\n// to calculate auto mp\nexport const classBaseMPauto = {\n  no: \"FFD20.No\",\n  yes: \"FFD20.Yes\",\n  half: \"FFD20.Half\",\n};\n\nexport const materiaRarity = {\n  common: \"FFD20.MateriaRarityCommon\",\n  uncommon: \"FFD20.MateriaRarityUncommon\",\n  rare: \"FFD20.MateriaRarityRare\",\n  legendary: \"FFD20.MateriaRarityLegendary\",\n};\n\nexport const materiaRarityMath = {\n  common: 1,\n  uncommon: 2,\n  rare: 3,\n  legendary: 4,\n};\n\nexport const materiaSlot = {\n  unslotted: \"FFD20.MateriaSlotUnslotted\",\n  weapon: \"FFD20.MateriaSlotWeapon\",\n  shield: \"FFD20.MateriaSlotShield\",\n  armor: \"FFD20.MateriaSlotArmor\",\n  other: \"FFD20.MateriaSlotOther\",\n};\n\n/**\n * Non-FFD20 config entries\n *\n * These keys are merged into {@link CONFIG} using {@link mergeObject}.\n */\nexport const CONFIG_OVERRIDES = {\n  \"Combat.initiative.decimals\": 2,\n  \"debug.roll\": false,\n  \"debug.template\": false,\n};\nexport const defaultIcons = {\n  items: {\n    attack: \"icons/svg/explosion.svg\",\n    buff: \"icons/svg/ice-aura.svg\",\n    class: \"icons/svg/paralysis.svg\",\n    consumable: \"icons/svg/tankard.svg\",\n    container: \"icons/svg/barrel.svg\",\n    equipment: \"icons/svg/combat.svg\",\n    feat: \"icons/svg/book.svg\",\n    loot: \"icons/svg/item-bag.svg\",\n    race: \"icons/svg/wing.svg\",\n    spell: \"icons/svg/daze.svg\",\n    weapon: \"icons/svg/sword.svg\",\n  },\n  actors: {\n    character: \"icons/svg/mystery-man.svg\",\n    npc: \"icons/svg/terror.svg\",\n    basic: \"icons/svg/castle.svg\",\n  },\n};\n","import { naturalSort } from \"@utils\";\n\n/**\n * @typedef {object} FilterChoice\n * @property {string} label - The label for this choice visible to the user; will be localized\n * @property {string} key - The key for this choice used to identify it\n * @property {boolean} [active] - Whether this choice is currently active\n */\n\n/**\n * A basic filter class containing common functionality for all filters.\n *\n * Inheriting classes should define the following static properties: {@link label}, {@link indexField}.\n * Inheriting classes may define the following static properties: {@link type}.\n *\n * @abstract\n */\nexport class BaseFilter {\n  /**\n   * The label for this filter visible to the user.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static label = \"\";\n\n  /**\n   * The field this filter checks against its choices.\n   * Will also be added to the `compendiumIndexFields` of the document's `CONFIG` object.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static indexField = \"\";\n\n  /**\n   * A convenience property to define a single `type` this filter applies to.\n   *\n   * @see {@link types}\n   * @see {@link handledTypes}\n   */\n  static type = \"\";\n\n  /**\n   * The `type`s of document this filter applies to.\n   *\n   * @see {Actor#type}\n   * @see {Item#type}\n   * @see {@link handledTypes}\n   * @type {string[]}\n   */\n  static types = [];\n\n  /**\n   * The handlebars template used to render this filter.\n   *\n   * @type {string}\n   */\n  static TEMPLATE = \"\";\n\n  /**\n   * The ID of this filter used to identify it in its browser's filters.\n   *\n   * @type {string}\n   */\n  id;\n\n  /**\n   * A {@link Collection} of {@link FilterChoice}s for this filter.\n   *\n   * @type {Collection<FilterChoice> | null}\n   */\n  choices = null;\n\n  /**\n   * A reference to the {@link CompendiumBrowser} this filter is used in.\n   *\n   * @type {import(\"../compendium-browser.mjs\").CompendiumBrowser | null}\n   */\n  compendiumBrowser = null;\n\n  /**\n   * @param {import(\"../compendium-browser.mjs\").CompendiumBrowser} compendiumBrowser - The compendium browser this filter is used in.\n   */\n  constructor(compendiumBrowser) {\n    this.compendiumBrowser = compendiumBrowser;\n    Object.defineProperty(this, \"id\", { value: foundry.utils.randomID(), writable: false, configurable: false });\n    this.registerIndexFields();\n  }\n\n  /**\n   * The authoritative `Set` of `type`s this filter applies to.\n   *\n   * @type {Set<string>}\n   */\n  static get handledTypes() {\n    return new Set([this.type, ...this.types].filter((type) => type));\n  }\n\n  /**\n   * Whether this filter has any active choices.\n   *\n   * @type {boolean}\n   */\n  get active() {\n    return this.choices?.some((choice) => choice.active) ?? false;\n  }\n\n  /**\n   * The number of active choices.\n   *\n   * @type {number}\n   */\n  get activeChoiceCount() {\n    return this.choices?.filter((choice) => choice.active).length ?? 0;\n  }\n\n  /**\n   * Adds the index fields checked by this filter to the document's `CONFIG` object,\n   * so that {@link CompendiumCollection#getIndex} will include them.\n   */\n  registerIndexFields() {\n    if (!this.compendiumBrowser) return;\n    const documentName = this.compendiumBrowser.constructor.documentName;\n\n    // Fields with double underscore are added in the mapping process and not part of Foundry's index\n    if (this.constructor.indexField.startsWith(\"__\")) return;\n\n    const compendiumIndexFields = CONFIG[documentName]?.compendiumIndexFields;\n    if (\n      compendiumIndexFields &&\n      this.constructor.indexField &&\n      !compendiumIndexFields.includes(this.constructor.indexField)\n    ) {\n      compendiumIndexFields?.push(this.constructor.indexField);\n    }\n  }\n\n  /**\n   * Prepare the filter for use.\n   * This step expects the compendium browser to have gathered its entries.\n   */\n  setup() {\n    this.prepareChoices();\n  }\n\n  /**\n   * Prepare the choices for this filter. This is called after the compendium browser has gathered its entries.\n   * By default, this will generate a list of choices from the index field of all entries in the compendium.\n   */\n  prepareChoices() {\n    this.choices = new foundry.utils.Collection();\n  }\n\n  /**\n   * Returns whether this filter has _more than_ the given number of choices.\n   * Defaults to 1, as a single choice allows for no real filtering.\n   *\n   * @param {number} [number=1] - The number of choices to check for\n   * @returns {boolean} - Whether this filter has more than the given number of choices\n   */\n  hasChoices(number = 1) {\n    return this.choices?.size > number;\n  }\n\n  /**\n   * Reset all choices and controls to their default state (inactive)\n   *\n   * @abstract\n   */\n  reset() {}\n\n  /**\n   * Check whether an entry matches this filter.\n   * If the filter is not active, this will always return true.\n   *\n   * @abstract\n   * @param {object} entry - The entry to check against this filter\n   * @returns {boolean} - Whether the entry matches this filter\n   */\n  applyFilter(entry) {}\n\n  /**\n   * Provide data necessary to render this filter.\n   * The data object generated by {@link BaseFilter#getData} contains the minimum data not only required\n   * by the filter itself, but also by the rendering {@link CompendiumBrowser}.\n   *\n   * @returns {object}} The data object for this filter\n   */\n  getData() {\n    return {\n      id: this.id,\n      template: this.constructor.TEMPLATE,\n      label: game.i18n.localize(this.constructor.label),\n      active: this.active,\n      activeCount: this.activeChoiceCount,\n      choices: this.choices?.contents ?? [],\n      field: this.constructor.indexField,\n    };\n  }\n\n  /**\n   * Activate event listeners for this filter.\n   *\n   * @abstract\n   * @param {HTMLElement} html - The rendered HTML element for this filter only\n   */\n  activateListeners(html) {}\n}\n","// https://github.com/farzher/fuzzysort v2.0.4\r\n/*\r\n  SublimeText-like Fuzzy Search\r\n\r\n  fuzzysort.single('fs', 'Fuzzy Search') // {score: -16}\r\n  fuzzysort.single('test', 'test') // {score: 0}\r\n  fuzzysort.single('doesnt exist', 'target') // null\r\n\r\n  fuzzysort.go('mr', [{file:'Monitor.cpp'}, {file:'MeshRenderer.cpp'}], {key:'file'})\r\n  // [{score:-18, obj:{file:'MeshRenderer.cpp'}}, {score:-6009, obj:{file:'Monitor.cpp'}}]\r\n\r\n  fuzzysort.go('mr', ['Monitor.cpp', 'MeshRenderer.cpp'])\r\n  // [{score: -18, target: \"MeshRenderer.cpp\"}, {score: -6009, target: \"Monitor.cpp\"}]\r\n\r\n  fuzzysort.highlight(fuzzysort.single('fs', 'Fuzzy Search'), '<b>', '</b>')\r\n  // <b>F</b>uzzy <b>S</b>earch\r\n*/\r\n\r\n// UMD (Universal Module Definition) for fuzzysort\r\n;((root, UMD) => {\r\n  if(typeof define === 'function' && define.amd) define([], UMD)\r\n  else if(typeof module === 'object' && module.exports) module.exports = UMD()\r\n  else root['fuzzysort'] = UMD()\r\n})(this, _ => {\r\n  'use strict'\r\n\r\n  var single = (search, target) => {                                                                                                                                                                                                                        if(search=='farzher')return{target:\"farzher was here (^-^*)/\",score:0,_indexes:[0]}\r\n    if(!search || !target) return NULL\r\n\r\n    var preparedSearch = getPreparedSearch(search)\r\n    if(!isObj(target)) target = getPrepared(target)\r\n\r\n    var searchBitflags = preparedSearch.bitflags\r\n    if((searchBitflags & target._bitflags) !== searchBitflags) return NULL\r\n\r\n    return algorithm(preparedSearch, target)\r\n  }\r\n\r\n\r\n  var go = (search, targets, options) => {                                                                                                                                                                                                                  if(search=='farzher')return[{target:\"farzher was here (^-^*)/\",score:0,_indexes:[0],obj:targets?targets[0]:NULL}]\r\n    if(!search) return options&&options.all ? all(search, targets, options) : noResults\r\n\r\n    var preparedSearch = getPreparedSearch(search)\r\n    var searchBitflags = preparedSearch.bitflags\r\n    var containsSpace  = preparedSearch.containsSpace\r\n\r\n    var threshold = options&&options.threshold || INT_MIN\r\n    var limit     = options&&options['limit']  || INT_MAX // for some reason only limit breaks when minified\r\n\r\n    var resultsLen = 0; var limitedCount = 0\r\n    var targetsLen = targets.length\r\n\r\n    // This code is copy/pasted 3 times for performance reasons [options.keys, options.key, no keys]\r\n\r\n    // options.key\r\n    if(options && options.key) {\r\n      var key = options.key\r\n      for(var i = 0; i < targetsLen; ++i) { var obj = targets[i]\r\n        var target = getValue(obj, key)\r\n        if(!target) continue\r\n        if(!isObj(target)) target = getPrepared(target)\r\n\r\n        if((searchBitflags & target._bitflags) !== searchBitflags) continue\r\n        var result = algorithm(preparedSearch, target)\r\n        if(result === NULL) continue\r\n        if(result.score < threshold) continue\r\n\r\n        // have to clone result so duplicate targets from different obj can each reference the correct obj\r\n        result = {target:result.target, _targetLower:'', _targetLowerCodes:NULL, _nextBeginningIndexes:NULL, _bitflags:0, score:result.score, _indexes:result._indexes, obj:obj} // hidden\r\n\r\n        if(resultsLen < limit) { q.add(result); ++resultsLen }\r\n        else {\r\n          ++limitedCount\r\n          if(result.score > q.peek().score) q.replaceTop(result)\r\n        }\r\n      }\r\n\r\n    // options.keys\r\n    } else if(options && options.keys) {\r\n      var scoreFn = options['scoreFn'] || defaultScoreFn\r\n      var keys = options.keys\r\n      var keysLen = keys.length\r\n      for(var i = 0; i < targetsLen; ++i) { var obj = targets[i]\r\n        var objResults = new Array(keysLen)\r\n        for (var keyI = 0; keyI < keysLen; ++keyI) {\r\n          var key = keys[keyI]\r\n          var target = getValue(obj, key)\r\n          if(!target) { objResults[keyI] = NULL; continue }\r\n          if(!isObj(target)) target = getPrepared(target)\r\n\r\n          if((searchBitflags & target._bitflags) !== searchBitflags) objResults[keyI] = NULL\r\n          else objResults[keyI] = algorithm(preparedSearch, target)\r\n        }\r\n        objResults.obj = obj // before scoreFn so scoreFn can use it\r\n        var score = scoreFn(objResults)\r\n        if(score === NULL) continue\r\n        if(score < threshold) continue\r\n        objResults.score = score\r\n        if(resultsLen < limit) { q.add(objResults); ++resultsLen }\r\n        else {\r\n          ++limitedCount\r\n          if(score > q.peek().score) q.replaceTop(objResults)\r\n        }\r\n      }\r\n\r\n    // no keys\r\n    } else {\r\n      for(var i = 0; i < targetsLen; ++i) { var target = targets[i]\r\n        if(!target) continue\r\n        if(!isObj(target)) target = getPrepared(target)\r\n\r\n        if((searchBitflags & target._bitflags) !== searchBitflags) continue\r\n        var result = algorithm(preparedSearch, target)\r\n        if(result === NULL) continue\r\n        if(result.score < threshold) continue\r\n        if(resultsLen < limit) { q.add(result); ++resultsLen }\r\n        else {\r\n          ++limitedCount\r\n          if(result.score > q.peek().score) q.replaceTop(result)\r\n        }\r\n      }\r\n    }\r\n\r\n    if(resultsLen === 0) return noResults\r\n    var results = new Array(resultsLen)\r\n    for(var i = resultsLen - 1; i >= 0; --i) results[i] = q.poll()\r\n    results.total = resultsLen + limitedCount\r\n    return results\r\n  }\r\n\r\n\r\n  var highlight = (result, hOpen, hClose) => {\r\n    if(typeof hOpen === 'function') return highlightCallback(result, hOpen)\r\n    if(result === NULL) return NULL\r\n    if(hOpen === undefined) hOpen = '<b>'\r\n    if(hClose === undefined) hClose = '</b>'\r\n    var highlighted = ''\r\n    var matchesIndex = 0\r\n    var opened = false\r\n    var target = result.target\r\n    var targetLen = target.length\r\n    var indexes = result._indexes\r\n    indexes = indexes.slice(0, indexes.len).sort((a,b)=>a-b)\r\n    for(var i = 0; i < targetLen; ++i) { var char = target[i]\r\n      if(indexes[matchesIndex] === i) {\r\n        ++matchesIndex\r\n        if(!opened) { opened = true\r\n          highlighted += hOpen\r\n        }\r\n\r\n        if(matchesIndex === indexes.length) {\r\n          highlighted += char + hClose + target.substr(i+1)\r\n          break\r\n        }\r\n      } else {\r\n        if(opened) { opened = false\r\n          highlighted += hClose\r\n        }\r\n      }\r\n      highlighted += char\r\n    }\r\n\r\n    return highlighted\r\n  }\r\n  var highlightCallback = (result, cb) => {\r\n    if(result === NULL) return NULL\r\n    var target = result.target\r\n    var targetLen = target.length\r\n    var indexes = result._indexes\r\n    indexes = indexes.slice(0, indexes.len).sort((a,b)=>a-b)\r\n    var highlighted = ''\r\n    var matchI = 0\r\n    var indexesI = 0\r\n    var opened = false\r\n    var result = []\r\n    for(var i = 0; i < targetLen; ++i) { var char = target[i]\r\n      if(indexes[indexesI] === i) {\r\n        ++indexesI\r\n        if(!opened) { opened = true\r\n          result.push(highlighted); highlighted = ''\r\n        }\r\n\r\n        if(indexesI === indexes.length) {\r\n          highlighted += char\r\n          result.push(cb(highlighted, matchI++)); highlighted = ''\r\n          result.push(target.substr(i+1))\r\n          break\r\n        }\r\n      } else {\r\n        if(opened) { opened = false\r\n          result.push(cb(highlighted, matchI++)); highlighted = ''\r\n        }\r\n      }\r\n      highlighted += char\r\n    }\r\n    return result\r\n  }\r\n\r\n\r\n  var indexes = result => result._indexes.slice(0, result._indexes.len).sort((a,b)=>a-b)\r\n\r\n\r\n  var prepare = (target) => {\r\n    if(typeof target !== 'string') target = ''\r\n    var info = prepareLowerInfo(target)\r\n    return {'target':target, _targetLower:info._lower, _targetLowerCodes:info.lowerCodes, _nextBeginningIndexes:NULL, _bitflags:info.bitflags, 'score':NULL, _indexes:[0], 'obj':NULL} // hidden\r\n  }\r\n\r\n\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n\r\n\r\n  var prepareSearch = (search) => {\r\n    if(typeof search !== 'string') search = ''\r\n    search = search.trim()\r\n    var info = prepareLowerInfo(search)\r\n\r\n    var spaceSearches = []\r\n    if(info.containsSpace) {\r\n      var searches = search.split(/\\s+/)\r\n      searches = [...new Set(searches)] // distinct\r\n      for(var i=0; i<searches.length; i++) {\r\n        if(searches[i] === '') continue\r\n        var _info = prepareLowerInfo(searches[i])\r\n        spaceSearches.push({lowerCodes:_info.lowerCodes, _lower:searches[i].toLowerCase(), containsSpace:false})\r\n      }\r\n    }\r\n\r\n    return {lowerCodes: info.lowerCodes, bitflags: info.bitflags, containsSpace: info.containsSpace, _lower: info._lower, spaceSearches: spaceSearches}\r\n  }\r\n\r\n\r\n\r\n  var getPrepared = (target) => {\r\n    if(target.length > 999) return prepare(target) // don't cache huge targets\r\n    var targetPrepared = preparedCache.get(target)\r\n    if(targetPrepared !== undefined) return targetPrepared\r\n    targetPrepared = prepare(target)\r\n    preparedCache.set(target, targetPrepared)\r\n    return targetPrepared\r\n  }\r\n  var getPreparedSearch = (search) => {\r\n    if(search.length > 999) return prepareSearch(search) // don't cache huge searches\r\n    var searchPrepared = preparedSearchCache.get(search)\r\n    if(searchPrepared !== undefined) return searchPrepared\r\n    searchPrepared = prepareSearch(search)\r\n    preparedSearchCache.set(search, searchPrepared)\r\n    return searchPrepared\r\n  }\r\n\r\n\r\n  var all = (search, targets, options) => {\r\n    var results = []; results.total = targets.length\r\n\r\n    var limit = options && options.limit || INT_MAX\r\n\r\n    if(options && options.key) {\r\n      for(var i=0;i<targets.length;i++) { var obj = targets[i]\r\n        var target = getValue(obj, options.key)\r\n        if(!target) continue\r\n        if(!isObj(target)) target = getPrepared(target)\r\n        target.score = INT_MIN\r\n        target._indexes.len = 0\r\n        var result = target\r\n        result = {target:result.target, _targetLower:'', _targetLowerCodes:NULL, _nextBeginningIndexes:NULL, _bitflags:0, score:target.score, _indexes:NULL, obj:obj} // hidden\r\n        results.push(result); if(results.length >= limit) return results\r\n      }\r\n    } else if(options && options.keys) {\r\n      for(var i=0;i<targets.length;i++) { var obj = targets[i]\r\n        var objResults = new Array(options.keys.length)\r\n        for (var keyI = options.keys.length - 1; keyI >= 0; --keyI) {\r\n          var target = getValue(obj, options.keys[keyI])\r\n          if(!target) { objResults[keyI] = NULL; continue }\r\n          if(!isObj(target)) target = getPrepared(target)\r\n          target.score = INT_MIN\r\n          target._indexes.len = 0\r\n          objResults[keyI] = target\r\n        }\r\n        objResults.obj = obj\r\n        objResults.score = INT_MIN\r\n        results.push(objResults); if(results.length >= limit) return results\r\n      }\r\n    } else {\r\n      for(var i=0;i<targets.length;i++) { var target = targets[i]\r\n        if(!target) continue\r\n        if(!isObj(target)) target = getPrepared(target)\r\n        target.score = INT_MIN\r\n        target._indexes.len = 0\r\n        results.push(target); if(results.length >= limit) return results\r\n      }\r\n    }\r\n\r\n    return results\r\n  }\r\n\r\n\r\n  var algorithm = (preparedSearch, prepared, allowSpaces=false) => {\r\n    if(allowSpaces===false && preparedSearch.containsSpace) return algorithmSpaces(preparedSearch, prepared)\r\n\r\n    var searchLower = preparedSearch._lower\r\n    var searchLowerCodes = preparedSearch.lowerCodes\r\n    var searchLowerCode = searchLowerCodes[0]\r\n    var targetLowerCodes = prepared._targetLowerCodes\r\n    var searchLen = searchLowerCodes.length\r\n    var targetLen = targetLowerCodes.length\r\n    var searchI = 0 // where we at\r\n    var targetI = 0 // where you at\r\n    var matchesSimpleLen = 0\r\n\r\n    // very basic fuzzy match; to remove non-matching targets ASAP!\r\n    // walk through target. find sequential matches.\r\n    // if all chars aren't found then exit\r\n    for(;;) {\r\n      var isMatch = searchLowerCode === targetLowerCodes[targetI]\r\n      if(isMatch) {\r\n        matchesSimple[matchesSimpleLen++] = targetI\r\n        ++searchI; if(searchI === searchLen) break\r\n        searchLowerCode = searchLowerCodes[searchI]\r\n      }\r\n      ++targetI; if(targetI >= targetLen) return NULL // Failed to find searchI\r\n    }\r\n\r\n    var searchI = 0\r\n    var successStrict = false\r\n    var matchesStrictLen = 0\r\n\r\n    var nextBeginningIndexes = prepared._nextBeginningIndexes\r\n    if(nextBeginningIndexes === NULL) nextBeginningIndexes = prepared._nextBeginningIndexes = prepareNextBeginningIndexes(prepared.target)\r\n    var firstPossibleI = targetI = matchesSimple[0]===0 ? 0 : nextBeginningIndexes[matchesSimple[0]-1]\r\n\r\n    // Our target string successfully matched all characters in sequence!\r\n    // Let's try a more advanced and strict test to improve the score\r\n    // only count it as a match if it's consecutive or a beginning character!\r\n    var backtrackCount = 0\r\n    if(targetI !== targetLen) for(;;) {\r\n      if(targetI >= targetLen) {\r\n        // We failed to find a good spot for this search char, go back to the previous search char and force it forward\r\n        if(searchI <= 0) break // We failed to push chars forward for a better match\r\n\r\n        ++backtrackCount; if(backtrackCount > 200) break // exponential backtracking is taking too long, just give up and return a bad match\r\n\r\n        --searchI\r\n        var lastMatch = matchesStrict[--matchesStrictLen]\r\n        targetI = nextBeginningIndexes[lastMatch]\r\n\r\n      } else {\r\n        var isMatch = searchLowerCodes[searchI] === targetLowerCodes[targetI]\r\n        if(isMatch) {\r\n          matchesStrict[matchesStrictLen++] = targetI\r\n          ++searchI; if(searchI === searchLen) { successStrict = true; break }\r\n          ++targetI\r\n        } else {\r\n          targetI = nextBeginningIndexes[targetI]\r\n        }\r\n      }\r\n    }\r\n\r\n    // check if it's a substring match\r\n    var substringIndex = prepared._targetLower.indexOf(searchLower, matchesSimple[0]) // perf: this is slow\r\n    var isSubstring = ~substringIndex\r\n    if(isSubstring && !successStrict) { // rewrite the indexes from basic to the substring\r\n      for(var i=0; i<matchesSimpleLen; ++i) matchesSimple[i] = substringIndex+i\r\n    }\r\n    var isSubstringBeginning = false\r\n    if(isSubstring) {\r\n      isSubstringBeginning = prepared._nextBeginningIndexes[substringIndex-1] === substringIndex\r\n    }\r\n\r\n    { // tally up the score & keep track of matches for highlighting later\r\n      if(successStrict) { var matchesBest = matchesStrict; var matchesBestLen = matchesStrictLen }\r\n      else { var matchesBest = matchesSimple; var matchesBestLen = matchesSimpleLen }\r\n\r\n      var score = 0\r\n\r\n      var extraMatchGroupCount = 0\r\n      for(var i = 1; i < searchLen; ++i) {\r\n        if(matchesBest[i] - matchesBest[i-1] !== 1) {score -= matchesBest[i]; ++extraMatchGroupCount}\r\n      }\r\n      var unmatchedDistance = matchesBest[searchLen-1] - matchesBest[0] - (searchLen-1)\r\n\r\n      score -= (12+unmatchedDistance) * extraMatchGroupCount // penality for more groups\r\n\r\n      if(matchesBest[0] !== 0) score -= matchesBest[0]*matchesBest[0]*.2 // penality for not starting near the beginning\r\n\r\n      if(!successStrict) {\r\n        score *= 1000\r\n      } else {\r\n        // successStrict on a target with too many beginning indexes loses points for being a bad target\r\n        var uniqueBeginningIndexes = 1\r\n        for(var i = nextBeginningIndexes[0]; i < targetLen; i=nextBeginningIndexes[i]) ++uniqueBeginningIndexes\r\n\r\n        if(uniqueBeginningIndexes > 24) score *= (uniqueBeginningIndexes-24)*10 // quite arbitrary numbers here ...\r\n      }\r\n\r\n      if(isSubstring)          score /= 1+searchLen*searchLen*1 // bonus for being a full substring\r\n      if(isSubstringBeginning) score /= 1+searchLen*searchLen*1 // bonus for substring starting on a beginningIndex\r\n\r\n      score -= targetLen - searchLen // penality for longer targets\r\n      prepared.score = score\r\n\r\n      for(var i = 0; i < matchesBestLen; ++i) prepared._indexes[i] = matchesBest[i]\r\n      prepared._indexes.len = matchesBestLen\r\n\r\n      return prepared\r\n    }\r\n  }\r\n  var algorithmSpaces = (preparedSearch, target) => {\r\n    var seen_indexes = new Set()\r\n    var score = 0\r\n    var result = NULL\r\n\r\n    var first_seen_index_last_search = 0\r\n    var searches = preparedSearch.spaceSearches\r\n    for(var i=0; i<searches.length; ++i) {\r\n      var search = searches[i]\r\n\r\n      result = algorithm(search, target)\r\n      if(result === NULL) return NULL\r\n\r\n      score += result.score\r\n\r\n      // dock points based on order otherwise \"c man\" returns Manifest.cpp instead of CheatManager.h\r\n      if(result._indexes[0] < first_seen_index_last_search) {\r\n        score -= first_seen_index_last_search - result._indexes[0]\r\n      }\r\n      first_seen_index_last_search = result._indexes[0]\r\n\r\n      for(var j=0; j<result._indexes.len; ++j) seen_indexes.add(result._indexes[j])\r\n    }\r\n\r\n    // allows a search with spaces that's an exact substring to score well\r\n    var allowSpacesResult = algorithm(preparedSearch, target, /*allowSpaces=*/true)\r\n    if(allowSpacesResult !== NULL && allowSpacesResult.score > score) {\r\n      return allowSpacesResult\r\n    }\r\n\r\n    result.score = score\r\n\r\n    var i = 0\r\n    for (let index of seen_indexes) result._indexes[i++] = index\r\n    result._indexes.len = i\r\n\r\n    return result\r\n  }\r\n\r\n\r\n  var prepareLowerInfo = (str) => {\r\n    var strLen = str.length\r\n    var lower = str.toLowerCase()\r\n    var lowerCodes = [] // new Array(strLen)    sparse array is too slow\r\n    var bitflags = 0\r\n    var containsSpace = false // space isn't stored in bitflags because of how searching with a space works\r\n\r\n    for(var i = 0; i < strLen; ++i) {\r\n      var lowerCode = lowerCodes[i] = lower.charCodeAt(i)\r\n\r\n      if(lowerCode === 32) {\r\n        containsSpace = true\r\n        continue // it's important that we don't set any bitflags for space\r\n      }\r\n\r\n      var bit = lowerCode>=97&&lowerCode<=122 ? lowerCode-97 // alphabet\r\n              : lowerCode>=48&&lowerCode<=57  ? 26           // numbers\r\n                                                             // 3 bits available\r\n              : lowerCode<=127                ? 30           // other ascii\r\n              :                                 31           // other utf8\r\n      bitflags |= 1<<bit\r\n    }\r\n\r\n    return {lowerCodes:lowerCodes, bitflags:bitflags, containsSpace:containsSpace, _lower:lower}\r\n  }\r\n  var prepareBeginningIndexes = (target) => {\r\n    var targetLen = target.length\r\n    var beginningIndexes = []; var beginningIndexesLen = 0\r\n    var wasUpper = false\r\n    var wasAlphanum = false\r\n    for(var i = 0; i < targetLen; ++i) {\r\n      var targetCode = target.charCodeAt(i)\r\n      var isUpper = targetCode>=65&&targetCode<=90\r\n      var isAlphanum = isUpper || targetCode>=97&&targetCode<=122 || targetCode>=48&&targetCode<=57\r\n      var isBeginning = isUpper && !wasUpper || !wasAlphanum || !isAlphanum\r\n      wasUpper = isUpper\r\n      wasAlphanum = isAlphanum\r\n      if(isBeginning) beginningIndexes[beginningIndexesLen++] = i\r\n    }\r\n    return beginningIndexes\r\n  }\r\n  var prepareNextBeginningIndexes = (target) => {\r\n    var targetLen = target.length\r\n    var beginningIndexes = prepareBeginningIndexes(target)\r\n    var nextBeginningIndexes = [] // new Array(targetLen)     sparse array is too slow\r\n    var lastIsBeginning = beginningIndexes[0]\r\n    var lastIsBeginningI = 0\r\n    for(var i = 0; i < targetLen; ++i) {\r\n      if(lastIsBeginning > i) {\r\n        nextBeginningIndexes[i] = lastIsBeginning\r\n      } else {\r\n        lastIsBeginning = beginningIndexes[++lastIsBeginningI]\r\n        nextBeginningIndexes[i] = lastIsBeginning===undefined ? targetLen : lastIsBeginning\r\n      }\r\n    }\r\n    return nextBeginningIndexes\r\n  }\r\n\r\n\r\n  var cleanup = () => { preparedCache.clear(); preparedSearchCache.clear(); matchesSimple = []; matchesStrict = [] }\r\n\r\n  var preparedCache       = new Map()\r\n  var preparedSearchCache = new Map()\r\n  var matchesSimple = []; var matchesStrict = []\r\n\r\n\r\n  // for use with keys. just returns the maximum score\r\n  var defaultScoreFn = (a) => {\r\n    var max = INT_MIN\r\n    var len = a.length\r\n    for (var i = 0; i < len; ++i) {\r\n      var result = a[i]; if(result === NULL) continue\r\n      var score = result.score\r\n      if(score > max) max = score\r\n    }\r\n    if(max === INT_MIN) return NULL\r\n    return max\r\n  }\r\n\r\n  // prop = 'key'              2.5ms optimized for this case, seems to be about as fast as direct obj[prop]\r\n  // prop = 'key1.key2'        10ms\r\n  // prop = ['key1', 'key2']   27ms\r\n  var getValue = (obj, prop) => {\r\n    var tmp = obj[prop]; if(tmp !== undefined) return tmp\r\n    var segs = prop\r\n    if(!Array.isArray(prop)) segs = prop.split('.')\r\n    var len = segs.length\r\n    var i = -1\r\n    while (obj && (++i < len)) obj = obj[segs[i]]\r\n    return obj\r\n  }\r\n\r\n  var isObj = (x) => { return typeof x === 'object' } // faster as a function\r\n  // var INT_MAX = 9007199254740991; var INT_MIN = -INT_MAX\r\n  var INT_MAX = Infinity; var INT_MIN = -INT_MAX\r\n  var noResults = []; noResults.total = 0\r\n  var NULL = null\r\n\r\n\r\n  // Hacked version of https://github.com/lemire/FastPriorityQueue.js\r\n  var fastpriorityqueue=r=>{var e=[],o=0,a={},v=r=>{for(var a=0,v=e[a],c=1;c<o;){var s=c+1;a=c,s<o&&e[s].score<e[c].score&&(a=s),e[a-1>>1]=e[a],c=1+(a<<1)}for(var f=a-1>>1;a>0&&v.score<e[f].score;f=(a=f)-1>>1)e[a]=e[f];e[a]=v};return a.add=(r=>{var a=o;e[o++]=r;for(var v=a-1>>1;a>0&&r.score<e[v].score;v=(a=v)-1>>1)e[a]=e[v];e[a]=r}),a.poll=(r=>{if(0!==o){var a=e[0];return e[0]=e[--o],v(),a}}),a.peek=(r=>{if(0!==o)return e[0]}),a.replaceTop=(r=>{e[0]=r,v()}),a}\r\n  var q = fastpriorityqueue() // reuse this\r\n\r\n\r\n  // fuzzysort is written this way for minification. all names are mangeled unless quoted\r\n  return {'single':single, 'go':go, 'highlight':highlight, 'prepare':prepare, 'indexes':indexes, 'cleanup':cleanup}\r\n}) // UMD\r\n\r\n// TODO: (feature) frecency\r\n// TODO: (perf) use different sorting algo depending on the # of results?\r\n// TODO: (perf) preparedCache is a memory leak\r\n// TODO: (like sublime) backslash === forwardslash\r\n// TODO: (perf) prepareSearch seems slow\r\n","import { naturalSort } from \"@utils\";\nimport { BaseFilter } from \"./filters/base.mjs\";\nimport fuzzysort from \"fuzzysort\";\n\n/**\n * The basic compendium browser class allowing the browsing of compendiums by utilising their indexes.\n *\n * Extending classes must define the following static properties if the browser is not meant to browse Item documents: {@link documentName}.\n * Extending classes should define the following static properties: {@link typeName}, {@link filterClasses}.\n *\n * @abstract\n */\nexport class CompendiumBrowser extends Application {\n  /**\n   * The document name of entries this browser displays.\n   *\n   * @abstract\n   * @type {\"Actor\" | \"Item\"}\n   */\n  static documentName = \"Item\";\n\n  /**\n   * A localisation string used in the browser's title.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static typeName;\n\n  /**\n   * An array of classes extending {@link BaseFilter} that should be used for this browser.\n   *\n   * @type {Array<typeof BaseFilter>}\n   */\n  static filterClasses = [];\n\n  /**\n   * The template used to render individual entries in the browser.\n   *\n   * @type {string}\n   */\n  static ENTRY_TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/entries.hbs\";\n\n  /**\n   * A `Promise` that resolves once all pack indexes have been loaded.\n   *\n   * @internal\n   * @type {Map<string, Promise<void>>}\n   */\n  static #indexingPromises = new Map();\n\n  /**\n   * The set of filters to apply to the compendium index.\n   *\n   * @type {Collection<BaseFilter>}\n   */\n  filters = new foundry.utils.Collection();\n\n  /**\n   * The types of entries this browser handles, as per a document's `type` property.\n   *\n   * @type {Set<string>}\n   */\n  handledTypes = new Set();\n\n  /**\n   * Compendium packs this browser gets entries from.\n   *\n   * @type {CompendiumCollection[]}\n   */\n  packs = [];\n\n  /**\n   * A set of filters that were expanded by the user, and should stay expanded upon re-render.\n   *\n   * @type {Set<string>}\n   */\n  expandedFilters = new Set();\n\n  /**\n   * The {@link Collection} of index entries this browser is aware of.\n   *\n   * @readonly\n   * @type {Collection<IndexEntry>}\n   */\n  entries;\n\n  /**\n   * The current search query entered by the user.\n   *\n   * @private\n   * @type {string}\n   */\n  _query = \"\";\n\n  /**\n   * An object containing data used to render the loading spinner and related text.\n   *\n   * @private\n   * @type {object | null}\n   */\n  _loadingInfo = null;\n\n  /**\n   * Whether the browser and its data have been set up using {@link CompendiumBrowser.setup}.\n   *\n   * @private\n   * @internal\n   * @type {boolean}\n   */\n  #setup = false;\n\n  constructor(options = {}) {\n    super(options);\n    /**\n     * All index entries this compendium browser is aware of.\n     *\n     * @type {Collection<object>}\n     */\n    Object.defineProperty(this, \"entries\", { value: new Collection() });\n    this.initialize();\n    this._debouncedRender = foundry.utils.debounce(this.render, 300);\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/apps/compendium-browser/compendium-browser.hbs\",\n      classes: [\"ffd20\", \"app\"],\n      id: `ffd20-compendium-browser-${this.name}`,\n      width: 800,\n      height: window.innerHeight - 60,\n      top: 30,\n      left: 40,\n      resizable: true,\n      scrollY: [\".filter-container\"],\n      dragDrop: [{ dragSelector: \".directory-item\", dropSelector: null }],\n    });\n  }\n\n  /**\n   * Initialize all {@link CompendiumBrowser}s found in {@link ffd20.applications.compendiumBrowser}\n   * and register them in {@link ffd20.applications.compendiums}.\n   */\n  static initializeBrowsers() {\n    const compendiums = ffd20.applications.compendiums;\n    const compendiumClasses = ffd20.applications.compendiumBrowser;\n    compendiums.items = new compendiumClasses.ItemBrowser();\n    compendiums.feats = new compendiumClasses.FeatBrowser();\n    compendiums.spells = new compendiumClasses.SpellBrowser();\n    compendiums.classes = new compendiumClasses.ClassBrowser();\n    compendiums.races = new compendiumClasses.RaceBrowser();\n    compendiums.bestiary = new compendiumClasses.CreatureBrowser();\n    compendiums.buffs = new compendiumClasses.BuffBrowser();\n  }\n\n  /**\n   * Request indexes of all packs of a document type to be loaded.\n   * This method should only ever be called as {@link CompendiumBrowser.getIndexes} to ensure Promises are properly bundled.\n   *\n   * @param {string[]} packNames - The names of the packs to load indexes for\n   * @see {@link CompendiumBrowser.#indexingPromise}\n   * @returns {Promise<void>} A `Promise` that resolves once all indexes have been loaded\n   */\n  static getIndexes(packNames = []) {\n    const packs = packNames.map((name) => game.packs.get(name));\n    const resultPromise = [];\n    for (const pack of packs) {\n      if (!this.#indexingPromises.has(pack.collection)) {\n        this.#indexingPromises.set(pack.collection, pack.getIndex());\n      }\n      resultPromise.push(this.#indexingPromises.get(pack.collection));\n    }\n    return Promise.all(resultPromise).finally(() => {\n      for (const pack of packs) {\n        this.#indexingPromises.delete(pack.collection);\n      }\n    });\n  }\n\n  /**\n   * Map an entry from a compendium to the format used by the browser.\n   *\n   * @param {object} entry - The entry to map\n   * @param {CompendiumCollection} pack - The compendium the entry is from\n   * @returns {IndexEntry} The mapped entry\n   */\n  static _mapEntry(entry, pack) {\n    // NOTE: This decouples the entry from the compendium; it will no longer be refreshed automatically, but changes will stick\n    const result = foundry.utils.deepClone(entry);\n    // Add default `system` data for the entry's type, as pruned compendium data omits default values\n    result.system = mergeObject(game.model[this.documentName][entry.type], result.system, { inplace: false });\n    // Add `pack` related fields to allow filtering by pack and label display\n    result.__pack = pack.collection;\n    result.__packLabel = pack.metadata.label;\n    result.__uuid = `Compendium.${pack.collection}.${entry._id}`;\n    // Prepare `__name` field for fuzzy search optimisation\n    result.__name = fuzzysort.prepare(entry.name.normalize(\"NFKD\"));\n    return result;\n  }\n\n  /**\n   * Renders an array of {@link IndexEntry} objects into HTML.\n   *\n   * @private\n   * @param {IndexEntry[]} entries - The entries to render\n   * @returns {Promise<string>} The rendered HTML\n   */\n  static async _renderEntries(entries) {\n    return renderTemplate(this.ENTRY_TEMPLATE, { entries });\n  }\n\n  /** @inheritDoc */\n  get title() {\n    return game.i18n.format(\"FFD20.CompendiumBrowserTitle\", { type: game.i18n.localize(this.constructor.typeName) });\n  }\n\n  /**\n   * Perform minimal preparation steps to initialize the compendium browser.\n   * Add filters and determine which compendiums include data relevant to this browser.\n   *\n   * @protected\n   */\n  initialize() {\n    this.filters?.clear();\n    for (const cls of this.constructor.filterClasses) {\n      if (!(cls.prototype instanceof BaseFilter)) {\n        throw new Error(`Filter class ${cls.name} does not extend BaseFilter`);\n      }\n      const filter = new cls(this);\n      this.filters.set(filter.id, filter);\n      // Add all types handled by that filter to the browser's list of handled types\n      cls.handledTypes.forEach((type) => this.handledTypes.add(type));\n    }\n    this.packs = game.packs.filter((pack) => this.isPackIncluded(pack));\n    this._loadingInfo = {\n      indexCount: this.packs.length,\n      entryCount: this.packs.reduce(\n        (acc, pack) => acc + pack.index.contents.filter((entry) => this.handledTypes.has(entry.type)).length,\n        0\n      ),\n    };\n  }\n\n  /**\n   * Check whether a compendium should be included in the browser.\n   *\n   * @param {CompendiumCollection} pack - The compendium to test\n   * @returns {boolean} Whether the compendium should be included\n   */\n  isPackIncluded(pack) {\n    // Only include enabled packs with the right document type made for PF1\n    if (pack.config.ffd20?.disabled) return false;\n    if (pack.documentName !== this.constructor.documentName) return false;\n    if (pack.metadata.system !== game.system.id) return false;\n\n    // Skip if set to private and the user is not a GM\n    if (pack.private && !game.user.isGM) return false;\n\n    // Avoid unnecessarily adding packs that don't contain any relevant entries\n    if (pack.index.contents.filter((entry) => this.handledTypes.has(entry.type)).length === 0) return false;\n\n    // Don't skip the compendium\n    return true;\n  }\n\n  /**\n   * Perform the initial setup of the compendium browser.\n   * This includes requesting the index of all relevant compendiums if necessary and preparing the filters.\n   *\n   * @returns {Promise<void>}\n   */\n  async setup() {\n    this.#setup = false;\n    this.entries?.clear();\n    await CompendiumBrowser.getIndexes(this.packs.map((pack) => pack.collection));\n    const unorderedEntries = await Promise.all(this.packs.map((pack) => this.loadPackIndex(pack)));\n    naturalSort(unorderedEntries.flat(), \"name\").forEach((entry) => this.entries.set(`${entry.__uuid}`, entry));\n    this.filters.forEach((filter) => filter.setup());\n    this.#setup = true;\n  }\n\n  /**\n   * Load a compendium's index to prepare it for browsing.\n   *\n   * @param {CompendiumCollection} pack - The compendium to load\n   * @returns {Promise<IndexEntry[]>} The loaded index entries\n   */\n  async loadPackIndex(pack) {\n    if (pack.indexed === false) await CompendiumBrowser.getIndexes(pack.collection);\n    const index = pack.index;\n    return index\n      .filter((entry) => this.handledTypes.has(entry.type))\n      .map((entry) => {\n        try {\n          return this.constructor._mapEntry(entry, pack);\n        } catch (err) {\n          Hooks.onError(`CompendiumBrowser#_mapEntry`, err, {\n            msg: `${this.constructor.name} failed to map entry ${entry.name} [${entry._id}] from pack ${pack.collection}`,\n            log: \"error\",\n            entry,\n            pack,\n          });\n          return null;\n        }\n      })\n      .filter((entry) => entry !== null);\n  }\n\n  /**\n   * Get the current set of entries allowed by the filters.\n   *\n   * @returns {IndexEntry[]} The filtered entries\n   */\n  getFilteredEntries() {\n    let entries = this.entries.contents;\n\n    const activeFilters = this.filters.filter((filter) => filter.active);\n    if (activeFilters.length)\n      entries = entries.filter((entry) => activeFilters.every((filter) => filter.applyFilter(entry)));\n\n    if (this._query)\n      entries = fuzzysort\n        .go(this._query.normalize(\"NFKD\"), entries, { key: \"__name\", threshold: -10000 })\n        .map((match) => match.obj);\n\n    return entries;\n  }\n\n  /** @inheritdoc */\n  async _render(force, options) {\n    // Identify the focused element\n    const focus = this.element?.[0]?.querySelector(\":focus\");\n    const selectionStart = focus?.selectionStart;\n\n    // Render the application and restore focus\n    await super._render(force, options);\n    if (focus && focus.name) {\n      const input = this._element[0].querySelector(`[name=\"${focus.name}\"]`);\n      if (input && input.focus instanceof Function) {\n        input.focus();\n        if (selectionStart) input.selectionStart = input.selectionEnd = selectionStart;\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  async getData(...args) {\n    const context = await super.getData(...args);\n    context.id = args[0]?.id;\n    context.query = this._query ?? \"\";\n    context.filters = this.filters\n      .filter((filter) => filter.hasChoices())\n      .map((filter) => ({\n        ...filter.getData(),\n        collapsed: this.expandedFilters.has(filter.id) ? \"\" : \"collapsed\",\n      }));\n\n    if (this.#setup) {\n      // Browser is set up, so we can render the entries\n      this._entries = this.getFilteredEntries();\n      context.entries = this._entries.slice(0, 100);\n      context.itemCount = this.entries.size;\n      context.filteredItemCount = this._entries.length;\n    } else {\n      // Browser is not set up, display a loading spinner\n      context.loading = true;\n      context.loadingInfo = this._loadingInfo;\n    }\n    return context;\n  }\n\n  /** @inheritDoc */\n  activateListeners(html) {\n    super.activateListeners(html);\n    /** @type {HTMLElement} */\n    const el = html[0];\n\n    // If the browser is not set up yet, start the process and render again once it is done\n    if (!this.#setup) {\n      this.setup().then(() => this.render());\n      // No listeners have to be activated yet, so we can return here\n      return;\n    }\n\n    this._initLazyScrolling(el);\n\n    // Activate listeners for filters, allowing them to define their own\n    el.querySelectorAll(\".filter-content\").forEach((filterContent) => {\n      const filter = this.filters.get(filterContent.closest(\".filter\").dataset.filterId);\n      filter.activateListeners(filterContent);\n    });\n\n    el.querySelector(\".directory-list\").addEventListener(\"click\", (event) => {\n      this._onClickEntry(event);\n    });\n\n    el.querySelector(\"button.refresh\").addEventListener(\"click\", (event) => {\n      this._onRefresh(event);\n    });\n\n    el.querySelector(\"button.reset\").addEventListener(\"click\", (event) => {\n      this._onResetFilters(event);\n    });\n\n    el.querySelectorAll(\".filter>h3\").forEach((header) => {\n      header.addEventListener(\"click\", (event) => {\n        this._onFilterHeaderClick(event);\n      });\n    });\n\n    el.querySelector(\"input[name=filter]\")?.addEventListener(\"input\", (event) => {\n      this._onCustomSearchFilter(event);\n    });\n\n    ContextMenu.create(this, html, \".directory-item\", this._getEntryContextOptions());\n  }\n\n  /**\n   * Store the current search filter query and re-render the application.\n   *\n   * @private\n   * @param {Event} event - The originating change event\n   */\n  _onCustomSearchFilter(event) {\n    event.preventDefault();\n    this._query = event.target.value;\n    this._debouncedRender();\n  }\n\n  /**\n   * Handle a click on an entry in the compendium browser.\n   *\n   * @private\n   * @param {Event} event - The originating click Event\n   */\n  async _onClickEntry(event) {\n    const li = event.target.closest(\".directory-item\");\n    if (!li) return;\n    const { uuid } = li.dataset;\n    const document = await fromUuid(uuid);\n    const collection = game.packs.get(document.pack);\n    return document.sheet.render(true, { editable: game.user.isGM && !collection.locked, focus: true });\n  }\n\n  /**\n   * Get the set of ContextMenu options which should be used for the compendium browser's entries.\n   *\n   * @protected\n   * @returns {object[]} - The Array of ContextMenu options\n   */\n  _getEntryContextOptions() {\n    return [\n      {\n        name: \"COMPENDIUM.ImportEntry\",\n        icon: '<i class=\"fas fa-download\"></i>',\n        condition: () => getDocumentClass(this.constructor.documentName).canUserCreate(game.user),\n        callback: async (li) => {\n          const collection = game.collections.get(this.constructor.documentName);\n          const uuid = li.data(\"uuid\");\n          const entry = this.entries.get(uuid);\n          return collection.importFromCompendium(game.packs.get(entry.__pack), entry._id, {}, { renderSheet: true });\n        },\n      },\n      {\n        name: \"FFD20.CopyUuidToClipboard\",\n        icon: '<i class=\"fas fa-id-badge\"></i>',\n        callback: (li) => {\n          const uuid = li.data(\"uuid\");\n          game.clipboard.copyPlainText(uuid);\n          const label = game.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label);\n          ui.notifications.info(game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label, type: \"uuid\", id: uuid }));\n        },\n      },\n    ];\n  }\n\n  /** @inheritDoc */\n  _canDragStart(selector) {\n    return true;\n  }\n\n  /** @inheritDoc */\n  _onDragStart(event) {\n    const { uuid } = event.currentTarget.dataset;\n    event.dataTransfer.setData(\n      \"text/plain\",\n      JSON.stringify({\n        type: this.constructor.documentName,\n        uuid: uuid,\n      })\n    );\n  }\n\n  /**\n   * Handle a click on the reset filters button, resetting all filters to their default state.\n   *\n   * @private\n   * @param {Event} _event - The originating click event\n   */\n  _onResetFilters(_event) {\n    for (const filter of this.filters) {\n      filter.reset();\n    }\n    this._query = \"\";\n    this.expandedFilters.clear();\n    this.render();\n  }\n\n  /**\n   * Handle a click on the refresh button, re-running the setup process,\n   * and re-rendering the compendium browser afterwards.\n   *\n   * @private\n   * @param {Event} _event - The originating click event\n   */\n  async _onRefresh(_event) {\n    this.#setup = false;\n    this.initialize();\n    this.render();\n  }\n\n  /**\n   * Handle a click on a filter's title to collapse or expand it.\n   *\n   * @private\n   * @param {Event} event - The originating click event\n   */\n  _onFilterHeaderClick(event) {\n    const { filterId } = event.target.closest(\".filter\").dataset;\n    const filterContents = event.target.closest(\".filter\").querySelector(\".filter-content\");\n    if (this.expandedFilters.has(filterId)) {\n      this.expandedFilters.delete(filterId);\n      filterContents.classList.add(\"collapsed\");\n    } else {\n      this.expandedFilters.add(filterId);\n      filterContents.classList.remove(\"collapsed\");\n    }\n  }\n\n  /**\n   * Initializes lazy loading of entries so that they are only rendered when close-ish to being visible.\n   *\n   * @private\n   * @param {HTMLElement} html - The HTML element to initialize lazy loading for\n   */\n  _initLazyScrolling(html) {\n    const listEnd = html.querySelector(\".directory-bottom\");\n    if (listEnd) {\n      new IntersectionObserver(\n        async ([entry], observer) => {\n          if (entry.isIntersecting) {\n            // Append more entries to the list\n            const currentCount = html.querySelectorAll(\".directory-item\").length;\n            const newEntries = this._entries.slice(currentCount, currentCount + 50);\n            if (newEntries.length === 0) {\n              // No more entries to load with current filters\n              observer.unobserve(listEnd);\n            } else {\n              const newHtml = await this.constructor._renderEntries(newEntries);\n              listEnd.insertAdjacentHTML(\"beforebegin\", newHtml);\n            }\n          }\n        },\n        { root: html.querySelector(\".directory-list\"), rootMargin: \"300px\" }\n      ).observe(listEnd);\n    }\n  }\n}\n\n/**\n * @typedef {object} IndexEntry\n * @property {string} _id - The entry's ID\n * @property {string} name - The entry's name\n * @property {string} type - The entry's type\n * @property {string} img - The entry's image\n * @property {string} __pack - The {@link CompendiumCollection} this entry is from\n * @property {string} __packLabel - The label of the {@link CompendiumCollection} this entry is from\n * @property {string} __uuid - The UUID of this entry\n */\n","/**\n * A specialized form used to select damage or condition types which apply to an Actor\n *\n * @type {DocumentSheet}\n */\nexport class ActorTraitSelector extends DocumentSheet {\n  constructor(doc, options) {\n    super(doc, options);\n    // Enrich dialog identity\n    this.options.classes.push(options.subject);\n  }\n\n  get title() {\n    return `${this.options.title}  ${this.object.name}`;\n  }\n\n  get id() {\n    return `trait-selector-${this.document.uuid}-${this.options.subject}`;\n  }\n\n  static get defaultOptions() {\n    return {\n      ...super.defaultOptions,\n      classes: [\"ffd20\", \"trait-selector\"],\n      template: \"systems/ffd20/templates/apps/trait-selector.hbs\",\n      width: 320,\n      height: \"auto\",\n      sheetConfig: false,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Return a reference to the target attribute\n   *\n   * @type {string}\n   */\n  get attribute() {\n    return this.options.name;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provide data to the HTML template for rendering\n   *\n   * @type {object}\n   */\n  getData() {\n    // Get current values\n    const attr = getProperty(this.object, this.attribute) ?? { value: [], custom: \"\" };\n\n    // Populate choices\n    const choices = duplicate(this.options.choices);\n    for (const [k, v] of Object.entries(choices)) {\n      choices[k] = {\n        label: v,\n        chosen: attr.value?.includes(k),\n      };\n    }\n\n    // Object type\n    const updateButton = this.object instanceof Actor ? \"FFD20.UpdateActor\" : \"FFD20.UpdateItem\";\n\n    // Return data\n    return {\n      choices: choices,\n      custom: attr.custom,\n      updateButton,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the Actor object with new trait data processed from the form\n   *\n   * @param event\n   * @param formData\n   * @private\n   */\n  _updateObject(event, formData) {\n    const choices = [];\n    for (const [k, v] of Object.entries(formData)) {\n      if (k !== \"custom\" && v) choices.push(k);\n    }\n    this.object.update({\n      [`${this.attribute}.value`]: choices,\n      [`${this.attribute}.custom`]: formData.custom,\n    });\n  }\n}\n","const fields = foundry.data.fields;\n\n/**\n * The Base Registry class, providing shared functionality for all registries in the system.\n *\n * @abstract\n * @group Base Classes\n * @template {RegistryEntry} Model\n * @augments {foundry.utils.Collection<Model>}\n */\nexport class Registry extends foundry.utils.Collection {\n  /**\n   * The class each of this registry's content is expected to be an instance of.\n   *\n   * @type {typeof Model}\n   */\n  static model = null;\n\n  /**\n   * An array of data used to initialise this registry.\n   *\n   * @type {object[]} An array of data used to initialise this registry.\n   * @private\n   */\n  static _defaultData = [];\n\n  /**\n   * The class each of this registry's content is expected to be an instance of.\n   *\n   * @see {@link Registry.model}\n   * @type {Model}\n   */\n  model = null;\n\n  constructor() {\n    super();\n    Object.defineProperty(this, \"model\", { value: this.constructor.model, writable: false, enumerable: false });\n    this._initialize();\n  }\n\n  /**\n   * The name of the registry\n   *\n   * @type {string}\n   */\n  get name() {\n    return this.constructor.name;\n  }\n\n  /**\n   * Initializes the registry with its default data.\n   *\n   * @remarks This method is called automatically when the registry is instantiated.\n   *  It should be self-reliant and not require any other setup.\n   * @private\n   */\n  _initialize() {\n    this.clear();\n    for (const element of this.constructor._defaultData) {\n      try {\n        const content = new this.model({ ...element, namespace: \"ffd20\" });\n        super.set(content.id, content);\n      } catch (error) {\n        console.error(error);\n      }\n    }\n\n    // Allow modules to register their own content\n    Hooks.callAll(`pf1Register${this.name}`, this);\n  }\n\n  /**\n   * Prepares the data of all entries in the registry.\n   */\n  setup() {\n    for (const element of this) {\n      element.prepareData();\n    }\n  }\n\n  /**\n   * Sets the value of a key in the registry.\n   *\n   * @param {string} id - ID of the value to set.\n   * @param {Model} content - The value to set.\n   * @returns {Registry} The registry itself, after the value has been set.\n   */\n  set(id, content) {\n    const cls = this.model;\n    if (!(content instanceof cls)) {\n      throw new Error(`Registry '${this.name}' can only register ${cls.name}`);\n    }\n    return super.set(id, content);\n  }\n\n  /**\n   * Registers a new instance of {@link Model} with the registry, using a partial of its data as the base.\n   *\n   * @example\n   * ```js\n   * ffd20.registry.damageTypes.register(\"my-module\", \"my-damage-type\", {\n   *   name: \"My Damage Type\",\n   *   icon: \"icons/svg/damage.svg\",\n   *   color: \"#00ff00\",\n   *   category: \"physical\",\n   * });\n   * ```\n   * @param {string} namespace - The namespace for which this value is registered.\n   * @param {string} id - The unique key of the value.\n   * @param {object} value - A {@link Partial} of the data to use as the base for the new value.\n   * @returns {Registry} The registry itself, after the value has been registered.\n   */\n  register(namespace, id, value) {\n    if (!namespace || !id) throw new Error(\"Registering requires both a namespace and an ID\");\n    if (this.has(id)) {\n      throw new Error(`Registry '${this.name}' already has a key '${id}'`);\n    }\n    return this.set(id, new this.model({ ...value, namespace, _id: id }));\n  }\n\n  /**\n   * Unregisters a value from the registry, or if no id is provided, all values belonging to the namespace.\n   *\n   * @param {string} namespace - The namespace for which this value is unregistered.\n   * @param {string} [id] - The unique key of the value, or `undefined` to unregister all values belonging to the namespace.\n   */\n  unregister(namespace, id) {\n    if (!namespace | !id) throw new Error(\"Unregistering requires both a namespace and an ID\");\n    if (id) {\n      const entry = this.get(id);\n      if (entry && entry.namespace === namespace) this.delete(id);\n      else throw new Error(`Registry '${this.name}' has no key '${id}'`);\n    } else {\n      for (const entry of this) {\n        if (entry.namespace === namespace) this.delete(entry.id);\n      }\n    }\n  }\n\n  /**\n   * Returns the contents of this registry as object, using ids as keys.\n   *\n   * @param {boolean} [source=false] - Whether to include the source data instead of its prepared data for each value.\n   * @returns {{ [id: string]: object }} The data of each value in the registry, by id\n   */\n  toObject(source = false) {\n    return Object.fromEntries(this.map((registryObject) => [registryObject.id, registryObject.toObject(source)]));\n  }\n\n  /**\n   * Returns an object of the registry's contents, with the id as key and the name as value.\n   *\n   * @returns {{ [id: string]: string }} The names of each value in the registry, by id\n   */\n  getLabels() {\n    return Object.fromEntries(this.map((registryObject) => [registryObject.id, registryObject.name]));\n  }\n}\n\n/**\n * The Base Registry Object class, providing shared functionality for all registry objects in the system.\n * For the required data, see {@link defineSchema}.\n *\n * @abstract\n * @group Base Classes\n */\nexport class RegistryEntry extends foundry.abstract.DataModel {\n  /** @override */\n  static defineSchema() {\n    return {\n      _id: new fields.StringField({ required: true, blank: false, readonly: true }),\n      name: new fields.StringField({ required: false, initial: \"\", localize: true }),\n      flags: new fields.ObjectField({ required: false, initial: {} }),\n      namespace: new fields.StringField({ required: true, blank: false }),\n    };\n  }\n\n  /**\n   * The unique key of the value.\n   *\n   * @type {string}\n   * @readonly\n   */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * Prepares the data of the registry entry.\n   */\n  prepareData() {\n    this.reset();\n\n    // Localize fields marked for localization\n    for (const [name, field] of Object.entries(this.constructor.schema.fields)) {\n      if (field instanceof fields.StringField && field.options.localize === true)\n        this[name] = game.i18n.localize(this[name]);\n    }\n  }\n}\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nconst fields = foundry.data.fields;\n\n/**\n * A single damage type entry in the {@link DamageTypes} registry.\n *\n * @group Damage Types\n */\nexport class DamageType extends RegistryEntry {\n  static defineSchema() {\n    return {\n      ...super.defineSchema(),\n      icon: new fields.StringField({ required: false, initial: \"\" }),\n      category: new fields.StringField({\n        required: true,\n        blank: false,\n        initial: \"misc\",\n        choices: DamageTypes.CATEGORIES,\n      }),\n      isModifier: new fields.BooleanField({ required: false, initial: false }),\n      color: new fields.StringField({ required: true, initial: \"black\" }),\n    };\n  }\n}\n/**\n * The singleton registry of damage types.\n * At runtime this registry is accessible as `ffd20.registry.damageTypes`.\n *\n * @group Damage Types\n * @see {@link Registry}\n * @see {@link DamageType}\n * @augments {Registry<DamageType>}\n */\nexport class DamageTypes extends Registry {\n  /** @inheritdoc */\n  static model = DamageType;\n\n  /**\n   * An array of allowed categories of damage types.\n   */\n  static CATEGORIES = /** @type {const} */ ([\"physical\", \"energy\", \"misc\"]);\n\n  /** @inheritdoc */\n  static _defaultData = [\n    {\n      _id: \"untyped\",\n      name: \"FFD20.DamageTypeUntyped\",\n      icon: \"ra ra-uncertainty\",\n      category: \"misc\",\n    },\n    {\n      _id: \"slashing\",\n      name: \"FFD20.DamageTypeSlashing\",\n      icon: \"ra ra-sword\",\n      color: \"yellow\",\n      category: \"physical\",\n    },\n    {\n      _id: \"piercing\",\n      name: \"FFD20.DamageTypePiercing\",\n      icon: \"ra ra-spear-head\",\n      color: \"blue\",\n      category: \"physical\",\n    },\n    {\n      _id: \"bludgeoning\",\n      name: \"FFD20.DamageTypeBludgeoning\",\n      icon: \"ra ra-large-hammer\",\n      color: \"red\",\n      category: \"physical\",\n    },\n    {\n      _id: \"fire\",\n      name: \"FFD20.DamageTypeFire\",\n      icon: \"ra ra-fire\",\n      color: \"orange\",\n      category: \"energy\",\n    },\n    {\n      _id: \"ice\",\n      name: \"FFD20.DamageTypeIce\",\n      icon: \"ra ra-frost-emblem\",\n      color: \"aqua\",\n      category: \"energy\",\n    },\n    {\n      _id: \"wind\",\n      name: \"FFD20.DamageTypeWind\",\n      icon: \"ra ra-slash-ring\",\n      color: \"#04e0ce\",\n      category: \"energy\",\n    },\n    {\n      _id: \"earth\",\n      name: \"FFD20.DamageTypeEarth\",\n      icon: \"ra ra-groundbreaker\",\n      color: \"#664a02\",\n      category: \"energy\",\n    },\n    {\n      _id: \"lightning\",\n      name: \"FFD20.DamageTypeLightning\",\n      icon: \"ra ra-lightning-bolt\",\n      color: \"yellow\",\n      category: \"energy\",\n    },\n    {\n      _id: \"water\",\n      name: \"FFD20.DamageTypeWater\",\n      icon: \"ra ra-droplet\",\n      color: \"blue\",\n      category: \"energy\",\n    },\n    {\n      _id: \"light\",\n      name: \"FFD20.DamageTypeLight\",\n      icon: \"ra ra-sunbeams\",\n      color: \"#defffc\",\n      category: \"energy\",\n    },\n    {\n      _id: \"dark\",\n      name: \"FFD20.DamageTypeDark\",\n      icon: \"ra ra-skull\",\n      color: \"#765898\",\n      category: \"energy\",\n    },\n    {\n      _id: \"nonelemental\",\n      name: \"FFD20.DamageTypeNonElemental\",\n      icon: \"ra ra-doubled\",\n      color: \"#a200ff\",\n      category: \"energy\",\n    },\n    {\n      _id: \"precision\",\n      name: \"FFD20.Precision\",\n      icon: \"ra ra-archery-target\",\n      isModifier: true,\n    },\n    {\n      _id: \"nonlethal\",\n      name: \"FFD20.Nonlethal\",\n      icon: \"ra ra-hand\",\n      isModifier: true,\n    },\n  ];\n}\n\n/**\n * {@inheritDoc DamageTypes}\n *\n * @group Damage Types\n * @type {DamageTypes}\n */\nexport let damageTypes;\n","export class DamageTypeSelector extends FormApplication {\n  constructor(object, dataPath, data, options = {}) {\n    super(object, options);\n    this._dataPath = dataPath;\n    this._data = deepClone(data);\n    if (!this._data) this._data = [];\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      width: 720,\n      height: 590,\n      template: \"systems/ffd20/templates/apps/damage-type-selector.hbs\",\n      closeOnSubmit: true,\n    });\n  }\n  get title() {\n    return game.i18n.localize(\"FFD20.DamageType\");\n  }\n  get id() {\n    return `action-${this.object.id}_${this._dataPath}`;\n  }\n\n  get damageCategorySortOrder() {\n    return [\"physical\", \"energy\", \"misc\"];\n  }\n\n  async getData(options) {\n    const data = await super.getData(options);\n\n    const damageTypes = ffd20.registry.damageTypes;\n    data.damageTypes = damageTypes.filter((damageType) => !damageType.isModifier);\n\n    // Add damage type categories\n    data.damageCategories = data.damageTypes.reduce((cur, o) => {\n      let categoryObj = cur.find((o2) => o2.key === o.category);\n      if (!categoryObj) {\n        categoryObj = { key: o.category, label: `FFD20.DamageTypeCategory.${o.category}`, data: [] };\n        cur.push(categoryObj);\n      }\n      categoryObj.data.push(o);\n      return cur;\n    }, []);\n    // Sort damage type categories\n    {\n      const sortOrder = this.damageCategorySortOrder;\n      data.damageCategories = data.damageCategories.sort((a, b) => {\n        const idxA = sortOrder.indexOf(a.key);\n        const idxB = sortOrder.indexOf(b.key);\n        if (idxA === -1 && idxB >= 0) return 1;\n        if (idxB === -1 && idxA >= 0) return -1;\n        if (idxA > idxB) return 1;\n        if (idxA < idxB) return -1;\n        return 0;\n      });\n    }\n\n    data.damageModifiers = damageTypes.filter((o) => o.isModifier);\n    data.data = this._data;\n\n    return data;\n  }\n\n  activateListeners(html) {\n    html.find(`.damage-type`).on(\"click\", this._toggleDamageType.bind(this));\n    html.find(`*[name]`).on(\"change\", this._onChangeData.bind(this));\n  }\n\n  _onChangeData(event) {\n    event.preventDefault();\n    const elem = event.currentTarget;\n    const dataPath = elem.name;\n\n    let value = elem.value;\n    if (elem.type === \"checkbox\") value = elem.checked;\n\n    switch (elem.dataset.dtype) {\n      case \"Boolean\":\n        value = Boolean(value);\n        break;\n      case \"Number\":\n        value = Number(value);\n        break;\n    }\n\n    setProperty(this._data, dataPath, value);\n  }\n\n  _toggleDamageType(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const dt = a.dataset.id;\n\n    if (this._data.values.includes(dt)) this._data.values.splice(this._data.values.indexOf(dt), 1);\n    else this._data.values.push(dt);\n    this.render();\n  }\n\n  async _updateObject(event, formData) {\n    formData = expandObject(formData);\n    const result = this._data;\n\n    return this.object.update({ [this._dataPath]: result });\n  }\n}\n","import { damageTypes } from \"module/registry/damage-types.mjs\";\nimport { DamageTypeSelector } from \"./damage-type-selector.mjs\";\n\n/**\n * Extend the FormApplication to handle creating, removing, and editing\n * and Actor's Damage Reduction and Energy Resistances.\n *\n */\nexport class ActorResistanceSelector extends FormApplication {\n  /** @override */\n  constructor(...args) {\n    super(...args);\n\n    /** Basic properties for handling operations */\n    // Prepare data and convert it into format compatible with the editor\n    this.isDR = this.options.isDR === true;\n\n    /** Working copy of our trait's data */\n    const resistances = deepClone(getProperty(this.object, this.attribute) ?? {});\n\n    /**\n     * Custom user input for damage sources\n     *\n     * @property\n     * @type {string}\n     */\n    this.custom = resistances.custom;\n\n    /**\n     * Original copy of the trait's entries\n     *\n     * @property\n     * @type {Object<string, any>}\n     */\n    this.originalEntries = resistances.value;\n    this.entries = resistances.value;\n\n    /** Processing Damage sources */\n    const damageOBJ = ffd20.registry.damageTypes.filter((dType) => !dType.isModifier);\n    const damages = {};\n\n    // Loop through the registry to filter not-applicable damage sources\n    Object.values(damageOBJ)\n      .sort()\n      .forEach((dType) => {\n        // If we are looking for DR, we want to exclude types that are energy or not untyped\n        if ((dType.category === \"energy\" || dType.category === \"misc\") && this.isDR) {\n          return;\n        }\n\n        // If we are looking for ERES, we want to exclude types that are physical or untyped\n        if ((dType.category === \"physical\" || (dType.category === \"misc\" && dType._id === \"untyped\")) && !this.isDR) {\n          return;\n        }\n\n        damages[dType._id] = dType.name;\n      });\n\n    /**\n     * A list of key-value pairs for dropdown damage types\n     *\n     * @property\n     * @type {Object<string, string>}\n     */\n    this.damages = damages;\n\n    /**\n     * A dropdown list of combination types for multiple damage types\n     *\n     * @property\n     * @type {Object<boolean, string>}\n     */\n    this.operators = {\n      true: \"FFD20.Application.DamageResistanceSelector.CombinationOr\",\n      false: \"FFD20.Application.DamageResistanceSelector.CombinationAnd\",\n    };\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      id: \"damage-resistance-selector\",\n      classes: [\"ffd20\", \"resistance\"],\n      template: \"systems/ffd20/templates/apps/damage-resistance-selector.hbs\",\n      width: 450,\n      height: \"auto\",\n      closeOnSubmit: true,\n      submitOnClose: false,\n    });\n  }\n\n  /** @override */\n  get title() {\n    return game.i18n.localize(\"FFD20.Application.DamageResistanceSelector.\" + (this.isDR ? \"DR\" : \"ER\") + \"Title\");\n  }\n\n  get attribute() {\n    return this.options.name;\n  }\n\n  get fields() {\n    return this.options.fields.split(\";\");\n  }\n\n  get dtypes() {\n    return this.options.dtypes.split(\";\");\n  }\n\n  get dataCount() {\n    return this.fields.length;\n  }\n\n  /**\n   * Fetches simple data for the interface\n   *\n   */\n  getData() {\n    return {\n      custom: this.custom,\n      damages: this.damages,\n      operators: this.operators,\n      entries: this.entries,\n      fields: this.fields,\n      dtypes: this.dtypes,\n      isDR: this.isDR,\n    };\n  }\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param html {HTML}   The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(html) {\n    html.find(\".resistance-control\").click(this._onResistanceControl.bind(this));\n\n    html.find(\"tr td input\").change(this._onResistanceChange.bind(this));\n    html.find(\"tr td select\").change(this._onResistanceChange.bind(this));\n    html.find(\"input[name=custom]\").change(this._onResistanceCustomChange.bind(this));\n  }\n\n  /**\n   * Updates the actor with the new resistances\n   *\n   * @override\n   * @param {Event} event\n   * @param {any} formData\n   * @returns  The updated actor\n   */\n  async _updateObject(event, formData) {\n    const updateData = {};\n\n    const entries = this.entries.map((value) => {\n      // Ensure no matter what, we have values\n      value.types[0] ??= \"\";\n      value.types[1] ??= \"\";\n\n      if (value.types[0] === \"\" && value.types[1] !== \"\") {\n        value.types[0] = value.types[1];\n        value.types[1] = \"\";\n      }\n      if (value.types[0] === value.types[1]) {\n        value.types[1] = \"\";\n      }\n\n      // Convert from string key to boolean value\n      value.operator = String(value.operator).toLowerCase() === \"true\";\n      return value;\n    });\n\n    updateData[this.attribute + \".value\"] = entries;\n    updateData[this.attribute + \".custom\"] = this.custom;\n\n    return this.object.update(updateData);\n  }\n\n  /**\n   * A trigger for an operation to add or delete a resistance entry\n   *\n   * @param {Event} event - The action and associated data that triggered the operation\n   * @returns A call to render (refresh) the UI\n   */\n  async _onResistanceControl(event) {\n    event.preventDefault();\n    const target = event.currentTarget;\n\n    // Add a new blank entry\n    if (target.classList.contains(\"add-resistance\")) {\n      const obj = {\n        amount: 0,\n        types: [this.isDR ? \"\" : \"fire\", \"\"],\n        operator: true,\n      };\n\n      this.entries.push(obj);\n\n      return this.render();\n    }\n\n    // Delete an existign entry instead\n    if (target.classList.contains(\"delete-resistance\")) {\n      const tr = target.closest(\"tr\");\n      const index = parseInt(tr.dataset.index);\n      this.entries.splice(index, 1);\n      return this.render();\n    }\n  }\n\n  /**\n   * A triggered operation when any inputs or dropdowns are interacted\n   * with to save the data from UI\n   *\n   * @param {Event} event\n   */\n  async _onResistanceChange(event) {\n    const target = event.currentTarget;\n\n    const tr = target.closest(\"tr.resistance\");\n    const index = parseInt(tr.dataset.index);\n    const index2 = target.dataset.index;\n    const value = target.value;\n    let updateValue = null;\n\n    // Sanity-check our updated value\n    if (target.dataset.dtype === \"Number\") {\n      let val = parseFloat(value);\n      if (isNaN(val)) val = 0;\n      updateValue = Math.floor(val * 100) / 100;\n    } else if (target.dataset.dtype === \"Boolean\") updateValue = value === \"true\";\n    else updateValue = value;\n\n    // Process the value into the types array or assign to an entry property\n    switch (index2) {\n      case \"types0\":\n        this.entries[index].types[0] = updateValue;\n        break;\n      case \"types1\":\n        this.entries[index].types[1] = updateValue;\n        break;\n      default:\n        this.entries[index][index2] = updateValue;\n        break;\n    }\n  }\n\n  /**\n   * A triggered operation when the user modifies the custom input section\n   *\n   * @param {Event} event\n   */\n  async _onResistanceCustomChange(event) {\n    const target = event.currentTarget;\n\n    this.custom = target.value;\n  }\n}\n","export class ActorRestDialog extends DocumentSheet {\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return mergeObject(options, {\n      classes: [\"ffd20\", \"actor-rest\"],\n      template: \"systems/ffd20/templates/apps/actor-rest.hbs\",\n      width: 500,\n      closeOnSubmit: true,\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the special traits selection window to include the Actor name\n   *\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Rest\")}: ${this.object.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the Actor using the configured options\n   * Remove/unset any flags which are no longer configured\n   *\n   * @param event\n   * @param formData\n   */\n  async _updateObject(event, formData) {\n    this.object.performRest({\n      /**\n       * add rest options\n       * Natural healing(8 hours rest, once per 24 hours): Restore HP equal to level plus con  and MP equal to caster level plus primary casting stat. Complete rest(24 hours of rest, no combat or hard training): Double natural healing Aided Healing(8 hours with someone trained in heal 5 ranks or more looking after you): double natural healing Aided Complete Rest(24 hours with someone trained in heal 5 ranks or more looking after you): 5x natural healing There are items that boost natural healing that can be found.\n       */\n      restoreHealth: formData.restoreHealth,\n      longTermCare: formData.longTermCare,\n      aidedcare: formData.aidedCare,\n      restoreDailyUses: formData.restoreDailyUses,\n      hours: formData.hours,\n    });\n  }\n}\n","export class PointBuyCalculator extends DocumentSheet {\n  constructor(...args) {\n    super(...args);\n\n    const actorAbl = this.actor.system.abilities;\n\n    this.abilities = [];\n    for (const [k, name] of Object.entries(ffd20.config.abilities)) {\n      this.abilities.push({\n        key: k,\n        name: name,\n        value: actorAbl[k]?.value ?? 10,\n      });\n    }\n\n    const ablValues = Object.keys(ffd20.config.abilityCost).map((i) => Number(i));\n    this.min = Math.min(...ablValues);\n    this.max = Math.max(...ablValues);\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"pointbuy-calculator\"],\n      template: \"systems/ffd20/templates/apps/point-buy-calculator.hbs\",\n      width: 320,\n      height: \"auto\",\n      closeOnSubmit: false,\n      submitOnClose: false,\n    });\n  }\n\n  get title() {\n    return `${game.i18n.localize(\"FFD20.PointBuyCalculator\")}: ${this.object.name}`;\n  }\n\n  get actor() {\n    return this.document;\n  }\n\n  getData() {\n    const usedPoints = this.getSpentPoints();\n\n    const pointBuy = ffd20.config.pointBuy;\n    const limitsArr = Object.entries(pointBuy).map(([key, ldata]) => ({ ...ldata, key }));\n    limitsArr.sort((a, b) => a.points - b.points);\n\n    // Find most relevant category\n    let closest = limitsArr[0].key;\n    for (const l of limitsArr) {\n      const prev = pointBuy[closest].points;\n      if (prev < usedPoints) closest = l.key;\n    }\n\n    return {\n      abilities: this.abilities,\n      points: usedPoints,\n      limits: limitsArr,\n      closest,\n      invalidPoints: pointBuy[closest].points !== usedPoints,\n    };\n  }\n\n  getSpentPoints() {\n    let result = 0;\n\n    for (const a of this.abilities) {\n      result += ffd20.config.abilityCost[a.value];\n    }\n\n    return result;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find(\".control\").click(this._onAbilityControl.bind(this));\n  }\n\n  _onAbilityControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const ablKey = a.closest(\".ability\").dataset.ability;\n    const abl = this.abilities.find((o) => o.key === ablKey);\n\n    if (a.classList.contains(\"add\")) {\n      abl.value = Math.min(this.max, abl.value + 1);\n    } else if (a.classList.contains(\"subtract\")) {\n      abl.value = Math.max(this.min, abl.value - 1);\n    }\n    this.render();\n  }\n\n  _updateObject() {\n    const updateData = {};\n    for (const a of this.abilities) {\n      updateData[`system.abilities.${a.key}.value`] = a.value;\n    }\n    this.actor.update(updateData);\n\n    this.close();\n  }\n}\n","export class Widget_ItemPicker {\r\n  constructor(callback, { items, columns = 3 } = {}) {\r\n    /**\r\n     * @property\r\n     * The HTML element that represents this widget.\r\n     */\r\n    this.element = null;\r\n\r\n    /**\r\n     * @property\r\n     * The callback to fire if an item is clicked.\r\n     */\r\n    this.callback = callback;\r\n\r\n    /**\r\n     * @typedef Widget_ItemPicker_Item\r\n     * @type {object}\r\n     * @property {string} value\r\n     * @property {string} label\r\n     */\r\n    /**\r\n     * @property\r\n     * @type Widget_ItemPicker_Item[]\r\n     * The items in this widget.\r\n     */\r\n    this._items = items;\r\n\r\n    /**\r\n     * @property\r\n     * @type {number}\r\n     * The maximum amount of columns shown.\r\n     */\r\n    this.columns = columns;\r\n  }\r\n\r\n  render(parentElem) {\r\n    // Generate widget\r\n    const rootElem = $($.parseHTML('<div class=\"widget item-picker\"></div>'));\r\n    // Add rows\r\n    let rowElem;\r\n    for (let a = 0; a < this._items.length; a++) {\r\n      const item = this._items[a];\r\n      if (a % this.columns === 0) {\r\n        rowElem = $($.parseHTML('<div class=\"row\"></div>'));\r\n        rootElem.append(rowElem);\r\n      }\r\n\r\n      const itemElem = $($.parseHTML(`<div class=\"item\" value=\"${item.value}\">${item.label}</div>`));\r\n      const widthRate = Math.floor(10000 / this.columns) / 100;\r\n      itemElem.css(\"flex\", `0 0 calc(${widthRate}% - 4px)`);\r\n      rowElem.append(itemElem);\r\n    }\r\n\r\n    // Replace parent element\r\n    if (!(parentElem instanceof jQuery)) parentElem = $(parentElem);\r\n    rootElem.css(\"position\", \"absolute\");\r\n    rootElem.css(\"left\", `${parentElem[0].offsetLeft}px`);\r\n    rootElem.css(\"position\", `${parentElem[0].offsetBottom}px`);\r\n    parentElem.parent().append(rootElem);\r\n\r\n    this.element = rootElem;\r\n\r\n    window.setTimeout(() => {\r\n      this.activateListeners(rootElem);\r\n    }, 10);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    // Click item callback\r\n    html.find(\".item\").click(this._onClickItem.bind(this));\r\n\r\n    // Cancel widget\r\n    this._cancelCallback = this._onCancel.bind(this);\r\n    document.addEventListener(\"click\", this._cancelCallback);\r\n  }\r\n\r\n  _onCancel(event) {\r\n    event.preventDefault();\r\n\r\n    // Don't cancel if this widget was clicked\r\n    const target = event.target;\r\n    let node = target;\r\n    if (node === this.element[0]) return;\r\n    while (node.parentNode) {\r\n      if (node === this.element[0]) return;\r\n      node = node.parentNode;\r\n    }\r\n\r\n    this.cancel();\r\n  }\r\n\r\n  _onClickItem(event) {\r\n    event.preventDefault();\r\n    const a = event.currentTarget;\r\n\r\n    this.callback($(a).attr(\"value\"));\r\n  }\r\n\r\n  cancel() {\r\n    document.removeEventListener(\"click\", this._cancelCallback);\r\n    this.element.remove();\r\n  }\r\n}\r\n","import { isGMActive } from \"./lib.mjs\";\n\n/**\n * @param root0\n * @param root0.title\n * @param root0.initial\n * @param root0.min\n * @param root0.max\n */\nexport function dialogGetNumber({\n  title = \"Input Number\",\n  initial = null,\n  min = Number.NEGATIVE_INFINITY,\n  max = Number.POSITIVE_INFINITY,\n} = {}) {\n  return new Promise((resolve) => {\n    let cancelled = true;\n\n    new Dialog(\n      {\n        title: title,\n        content: `<input type=\"number\" name=\"result\" min=\"${min}\" max=\"${max}\" value=\"${initial || 0}\">`,\n        buttons: {\n          ok: {\n            label: \"Submit\",\n            callback: (html) => {\n              cancelled = false;\n              const input = html.find('input[name=\"result\"]');\n              resolve(input.val());\n            },\n          },\n        },\n        close: () => {\n          if (!cancelled) {\n            resolve(initial);\n          }\n        },\n        default: \"ok\",\n        render: (htm) => {\n          htm.find(\"input\").select();\n        },\n      },\n      {\n        classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"get-number\"],\n      }\n    ).render(true);\n  });\n}\n\nexport const dialogGetActor = function (title = \"\", actors = []) {\n  return new Promise((resolve) => {\n    const cancelled = true;\n\n    let content = \"\";\n    actors.forEach((target) => {\n      if (target instanceof Actor) {\n        const gmActive = isGMActive();\n        const enabled = gmActive || target.testUserPermission(game.user, \"OWNER\");\n        const disabledClass = enabled ? \"\" : \"disabled\";\n        content += `<div class=\"dialog-get-actor flexrow ${disabledClass}\" data-actor-id=\"${target.id}\"><img src=\"${target.img}\"><h2>${target.name}</h2></div>`;\n      } else if (target instanceof Item) {\n        content += `<div class=\"dialog-get-actor flexrow\" data-item-id=\"${target.id}\"><img src=\"${target.img}\"><h2>${target.name}</h2></div>`;\n      }\n    });\n\n    new Dialog(\n      {\n        title: title,\n        content: content,\n        buttons: {},\n        close: () => {\n          if (cancelled) {\n            resolve(null);\n          }\n        },\n        render: function (html) {\n          html.find(\".dialog-get-actor:not(.disabled)\").click((event) => {\n            const elem = event.currentTarget;\n            const actorId = elem.dataset.actorId;\n            if (actorId) {\n              resolve({ type: \"actor\", id: actorId });\n            } else {\n              const itemId = elem.dataset.itemId;\n              if (itemId) {\n                resolve({ type: \"item\", id: itemId });\n              }\n            }\n            this.close();\n          });\n        },\n      },\n      {\n        classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"get-actor\"],\n      }\n    ).render(true);\n  });\n};\n","import { createInlineRollString } from \"../utils/chat.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\n\nexport class LevelUpForm extends FormApplication {\n  constructor(object, options = {}) {\n    super(object, options);\n\n    /**\n     * Relevant token if any.\n     */\n    this.token = options.token;\n\n    /**\n     * Tracks whether this form has already been submitted.\n     */\n    this._submitted = false;\n\n    /**\n     * Tracks the currently viewed section.\n     */\n    this._section = 0;\n\n    /**\n     * Tracks section data.\n     */\n    this._sections = this._addSections();\n\n    // Add summary section at the end\n    this._sections.push(this._addSummarySection());\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"level-up\"],\n      template: \"systems/ffd20/templates/apps/level-up.hbs\",\n      width: 720,\n      height: 480,\n      closeOnSubmit: true,\n    });\n  }\n\n  get section() {\n    return this._section;\n  }\n  get currentSection() {\n    return this._sections[this.section];\n  }\n\n  setSection(idx) {\n    this._section = idx;\n\n    return this._render();\n  }\n\n  get title() {\n    return game.i18n.format(\"FFD20.LevelUpForm_Title\", { className: this.object.name });\n  }\n\n  /** @type {Actor} */\n  get actor() {\n    return this.object.actor;\n  }\n\n  static async addClassWizard(actor, rawData) {\n    // Alter initial data\n    setProperty(rawData, \"system.hp\", 0);\n    setProperty(rawData, \"system.level\", 0);\n\n    // Add class item\n    let itemData = await actor.createEmbeddedDocuments(\"Item\", [rawData]);\n    itemData = itemData instanceof Array ? itemData : [itemData];\n    const item = actor.items.get(itemData[0].id);\n    if (!item) {\n      throw new Error(\"No class was created at class initialization wizard\");\n    }\n\n    // Add level up form for new class\n    return new Promise((resolve) => {\n      const _app = new LevelUpForm(item).render(true);\n      Hooks.on(\"closeLevelUpForm\", function _onClose(app) {\n        if (app === _app) {\n          if (item.system.level === 0) {\n            actor.deleteEmbeddedDocuments(\"Item\", [item.id]);\n          }\n          Hooks.off(\"closeLevelUpForm\", _onClose);\n          resolve();\n        }\n      });\n    });\n  }\n\n  getData() {\n    const result = {};\n\n    result.data = this.object.toObject();\n    result.actor = this.actor.toObject();\n    result.config = ffd20.config;\n\n    // Add sections\n    result.section = this.currentSection;\n    result.sections = this._sections;\n\n    // Add summary data\n    result.summary = this.getSummaryData();\n\n    result.uuid = this.object.uuid;\n\n    return result;\n  }\n\n  getSummaryData() {\n    const result = {};\n\n    for (const section of this._sections) {\n      if (section.name === \"summary\") continue;\n      const { summary } = this._parseSection(section);\n      result[section.name] = summary;\n    }\n\n    return result;\n  }\n\n  _addSections() {\n    const result = [];\n\n    // Add health section\n    const hpSettings = game.settings.get(\"ffd20\", \"healthConfig\");\n    const hpOptions = this.actor.type === \"character\" ? hpSettings.hitdice.PC : hpSettings.hitdice.NPC;\n    if (hpOptions.auto !== true) {\n      result.push({\n        name: \"health\",\n        label: \"FFD20.LevelUpForm_Health\",\n        choice: null,\n        manualValue: Math.ceil(1 + (this.object.system.hd - 1) / 2),\n        items: [\n          {\n            img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n            name: game.i18n.localize(\"FFD20.LevelUpForm_Health_Roll\"),\n            id: \"roll\",\n            type: \"html\",\n            target: \"systems/ffd20/templates/apps/level-up/health_roll.hbs\",\n          },\n          {\n            img: \"systems/ffd20/icons/skills/green_19.jpg\",\n            name: game.i18n.localize(\"FFD20.LevelUpForm_Health_Manual\"),\n            id: \"manual\",\n            type: \"html\",\n            target: \"systems/ffd20/templates/apps/level-up/health_manual.hbs\",\n          },\n        ],\n      });\n    }\n\n    // Add favoured class bonus\n    if (this.isFavouredClass()) {\n      result.push({\n        name: \"fc\",\n        label: \"FFD20.LevelUp.FC.Label\",\n        choice: null,\n        items: [\n          {\n            name: game.i18n.localize(\"FFD20.None\"),\n            id: \"none\",\n          },\n          {\n            img: \"systems/ffd20/icons/skills/green_19.jpg\",\n            name: game.i18n.localize(\"FFD20.FavouredClassBonus.HP\"),\n            id: \"hp\",\n            type: \"html\",\n            target: \"systems/ffd20/templates/apps/level-up/fc_hp.hbs\",\n          },\n          {\n            img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n            name: game.i18n.localize(\"FFD20.FavouredClassBonus.Skill\"),\n            id: \"skill\",\n            type: \"html\",\n            target: \"systems/ffd20/templates/apps/level-up/fc_skill.hbs\",\n          },\n          {\n            img: \"systems/ffd20/icons/skills/affliction_22.jpg\",\n            name: game.i18n.localize(\"FFD20.FavouredClassBonus.Alt\"),\n            id: \"alt\",\n            type: \"html\",\n            target: \"systems/ffd20/templates/apps/level-up/fc_alt.hbs\",\n          },\n        ],\n      });\n    }\n\n    // Add ability score\n    const newHD = this.actor.getRollData().attributes.hd.total + 1;\n    const newAbilityScores = ffd20.config.levelAbilityScores[newHD];\n    if (typeof newAbilityScores === \"number\" && newAbilityScores > 0) {\n      result.push({\n        name: \"ability\",\n        label: \"FFD20.LevelUp.AbilityScore.Label\",\n        template: \"systems/ffd20/templates/apps/level-up/ability-score.hbs\",\n        choice: null,\n        abilities: Object.keys(ffd20.config.abilities).reduce((cur, o) => {\n          cur[o] = {\n            value: this.actor.system.abilities[o].total,\n            name: ffd20.config.abilities[o],\n            added: 0,\n            isEnhanced: this.actor.system.abilities[o].total !== this.actor.system.abilities[o].base,\n          };\n          return cur;\n        }, {}),\n        value: newAbilityScores,\n      });\n    }\n\n    return result;\n  }\n\n  _addSummarySection() {\n    return {\n      name: \"summary\",\n      label: \"FFD20.LevelUp.Summary.Label\",\n      template: \"systems/ffd20/templates/apps/level-up/summary.hbs\",\n    };\n  }\n\n  /**\n   * @returns {boolean} Whether this form's associated class is a favoured class.\n   * @// TODO: Add better logic for determining this <26-01-22, Furyspark> //\n   */\n  isFavouredClass() {\n    return this.object.system.subType === \"base\";\n  }\n\n  async _updateObject(event, formData) {\n    const itemData = {};\n    const actorData = {};\n    const chatData = {\n      config: ffd20.config,\n    };\n    const newItems = [];\n    const callbacks = [];\n\n    for (const section of this._sections) {\n      const data = this._parseSection(section);\n      mergeObject(itemData, data.item);\n      mergeObject(actorData, data.actor);\n      mergeObject(chatData, data.chatData);\n      callbacks.push(...data.callbacks);\n      for (const item of data.newItems) {\n        const prevItem = newItems.find((o) => o._id === item._id);\n        if (prevItem != null) mergeObject(prevItem, item);\n        else newItems.push(item);\n      }\n    }\n\n    // Add level\n    chatData.level = {\n      previous: this.object.system.level,\n      new: this.object.system.level + 1,\n    };\n\n    // Update class\n    mergeObject(itemData, { \"system.level\": chatData.level.new });\n    const levelingClass = this.object;\n    const lvlwaiter = new Promise((resolve) => {\n      const hid = Hooks.on(\"pf1ClassLevelChange\", function _waiter(actor, item, curLevel, newLevel) {\n        if (item.id === levelingClass.id) {\n          Hooks.off(\"pf1ClassLevelChange\", hid);\n          resolve();\n        }\n      });\n    });\n    await levelingClass.update(itemData);\n    await lvlwaiter;\n\n    // Update actor\n    if (Object.keys(actorData).length) {\n      await this.actor.update(actorData);\n    }\n    // Add items\n    if (newItems.length > 0) {\n      await this.actor.createEmbeddedDocuments(\"Item\", newItems);\n    }\n    // Run callbacks\n    for (const cb of callbacks) {\n      await cb.call(this);\n    }\n\n    // Add new class features to chat data\n    {\n      const classAssociations = getProperty(this.object, \"flags.ffd20.links.classAssociations\") || {};\n      const newAssociations = Object.entries(classAssociations).filter((o) => {\n        return o[1] === chatData.level.new;\n      });\n      chatData.newFeatures = [];\n      for (const co of newAssociations) {\n        const item = this.actor.items.get(co[0]);\n        if (item) chatData.newFeatures.push(item.toObject());\n      }\n    }\n\n    // Add extra info (new feats, skill ranks, etc.)\n    {\n      const ex = {};\n      chatData.extra = ex;\n\n      // Show new feat count\n      const featCount = this.actor.getFeatCount();\n      featCount.new = Math.max(0, featCount.max - featCount.value);\n      ex.feats = featCount;\n      if (featCount.new > 0) {\n        ex.enabled = true;\n        if (featCount.new === 1) featCount.label = game.i18n.localize(\"FFD20.LevelUp.Chat.Extra.NewFeat\");\n        else featCount.label = game.i18n.format(\"FFD20.LevelUp.Chat.Extra.NewFeats\", { newValue: featCount.new });\n      }\n\n      // Show new ability score\n      const hd = this.actor.system.attributes.hd.total;\n      if (typeof hd === \"number\" && hd % 4 === 0) {\n        ex.enabled = true;\n        ex.newAbilityScore = {\n          label: game.i18n.localize(\"FFD20.LevelUp.Chat.Extra.NewAbilityScore\"),\n        };\n      }\n    }\n\n    // Create chat message\n    return this.createChatMessage(chatData);\n  }\n\n  /**\n   * @typedef {object} LevelUp_UpdateData\n   * @property {object} item - The update data for the leveling class item.\n   * @property {object} actor - The update data for the associated actor.\n   * @property {object} chatData - Data to add for the level up's chat card.\n   * @property {object[]} newItems - Items to add due to this update.\n   * @property {object[]} summary - Data for the summary to show.\n   * @property {Function[]} callbacks - Asynchronous callbacks to call upon submit.\n   */\n  /**\n   * Parses a section, and sets updateData as appropriate for a submit.\n   *\n   * @param {object} section - The given section.\n   * @returns {LevelUp_UpdateData}\n   */\n  _parseSection(section) {\n    const result = {\n      item: {},\n      actor: {},\n      chatData: {},\n      newItems: [],\n      summary: {},\n      callbacks: [],\n    };\n\n    const fn = this[`_parseSection_${section.name}`];\n    if (fn instanceof Function) return fn.call(this, section, result);\n\n    return result;\n  }\n\n  _parseSection_health(section, result) {\n    result.summary = {\n      label: \"FFD20.LevelUp.Chat.Health.Header\",\n      template: \"systems/ffd20/templates/apps/level-up/summary/health.hbs\",\n      type: section.choice,\n    };\n\n    // Manual health\n    if (section.choice === \"manual\") {\n      const hpValue = section.manualValue;\n      result.item[\"system.hp\"] = this.object.system.hp + hpValue;\n      result.chatData.hp = {\n        label: \"FFD20.LevelUp.Chat.Health.Manual\",\n        add: hpValue,\n        roll: RollPF.safeRoll(`${hpValue}`),\n      };\n      result.summary.hp = hpValue;\n    }\n    // Roll health\n    else if (section.choice === \"roll\") {\n      const formula = `1d${this.object.system.hd}`;\n      const roll = RollPF.safeRoll(formula);\n      result.chatData.hp = {\n        label: \"FFD20.LevelUp.Chat.Health.Roll\",\n        add: createInlineRollString(roll),\n        roll: roll,\n      };\n      if (!Number.isNaN(roll.total)) {\n        result.item[\"system.hp\"] = this.object.system.hp + roll.total;\n      }\n    }\n\n    return result;\n  }\n\n  _parseSection_fc(section, result) {\n    result.summary = {\n      label: \"FFD20.LevelUp.Chat.FC.Header\",\n      template: \"systems/ffd20/templates/apps/level-up/summary/fc.hbs\",\n      id: section.choice,\n    };\n\n    const id = section.choice;\n    if ([\"hp\", \"skill\", \"alt\"].includes(id)) {\n      const key = `system.fc.${section.choice}.value`;\n      result.item[key] = getProperty(this.object, key) + 1;\n\n      const fcKey = { hp: \"HP\", skill: \"Skill\", alt: \"Alt\" }[id];\n      result.chatData.fc = {\n        type: id,\n        label: `FFD20.FavouredClassBonus.${fcKey}`,\n      };\n\n      result.summary.desc = `FFD20.LevelUp.FC.${fcKey}.Desc`;\n    }\n\n    return result;\n  }\n\n  _parseSection_ability(section, result) {\n    const added = Object.entries(section.abilities).reduce((cur, o) => {\n      if (!(o[1].added > 0)) return cur;\n      cur[o[0]] = o[1].added;\n      return cur;\n    }, {});\n\n    // Add summary data\n    result.summary = {\n      label: \"FFD20.LevelUp.AbilityScore.Label\",\n      template: \"systems/ffd20/templates/apps/level-up/summary/ability-score.hbs\",\n      choices: added,\n    };\n\n    // Add chat data\n    if (Object.keys(added).length) {\n      result.chatData.ability = {\n        choices: added,\n      };\n    }\n\n    const item = this.actor.items.find((o) => o.getFlag(\"ffd20\", \"levelUp\") === true);\n    // Add level up ability score feature if it doesn't exist yet\n    if (!item) {\n      const newItem = mergeObject(\n        ffd20.config.levelAbilityScoreFeature,\n        {\n          flags: {\n            ffd20: {\n              levelUp: true,\n            },\n          },\n        },\n        { inplace: false }\n      );\n\n      // Add changes\n      setProperty(\n        newItem,\n        \"system.changes\",\n        Object.entries(added).reduce((cur, o) => {\n          const change = mergeObject(ffd20.components.ItemChange.defaultData, {\n            formula: `${o[1]}`,\n            subTarget: o[0],\n            modifier: \"untypedPerm\",\n          });\n\n          cur.push(change);\n          return cur;\n        }, [])\n      );\n\n      result.newItems.push(newItem);\n    }\n    // If a level up ability score feature already exists, update it\n    else {\n      const cb = async function () {\n        const changes = duplicate(item.system.changes ?? []);\n        for (const [key, value] of Object.entries(added)) {\n          const change = changes.find((o) => o.subTarget === key);\n\n          // Update previous change\n          if (change != null) {\n            const prevValue = parseInt(change.formula);\n            if (!Number.isNaN(prevValue)) {\n              const newValue = prevValue + value;\n              change.formula = `${newValue}`;\n              continue;\n            }\n          }\n\n          // Add new change\n          changes.push(\n            mergeObject(ffd20.components.ItemChange.defaultData, {\n              subTarget: key,\n              formula: `${value}`,\n              modifier: \"untypedPerm\",\n            })\n          );\n        }\n\n        await item.update({\n          \"system.changes\": changes,\n        });\n      };\n\n      result.callbacks.push(cb);\n    }\n\n    return result;\n  }\n\n  async createChatMessage(formData) {\n    const speaker = ChatMessage.getSpeaker({ actor: this.actor, token: this.token });\n\n    const templateData = {\n      formData,\n      config: ffd20.config,\n      item: this.object.toObject(),\n      actor: this.actor.toObject(),\n    };\n\n    return ChatMessage.create({\n      content: await renderTemplate(\"systems/ffd20/templates/chat/level-up.hbs\", templateData),\n      user: game.user.id,\n      type: CONST.CHAT_MESSAGE_TYPES.ROLL,\n      speaker,\n      roll: formData.hp?.roll ?? RollPF.safeRoll(\"0\"),\n    });\n  }\n\n  activateListeners(html) {\n    html.find(\".list-selector .item\").on(\"click\", this._onClickListItem.bind(this));\n    html.find(\"input.section-choice\").on(\"change\", this._onChangeSectionChoice.bind(this));\n\n    html.find(\".ability-scores .ability-score .operator\").on(\"click\", this._onClickAbilityScoreOperator.bind(this));\n\n    html.find(`button[data-type=\"previous\"]`).on(\"click\", this._onPreviousSection.bind(this));\n    html.find(`button[data-type=\"next\"]`).on(\"click\", this._onNextSection.bind(this));\n    html.find('button[name=\"submit\"]').on(\"click\", this._onSubmit.bind(this));\n  }\n\n  _onPreviousSection(event) {\n    event.preventDefault();\n\n    this.setSection(this.section - 1);\n  }\n\n  _onNextSection(event) {\n    event.preventDefault();\n\n    this.setSection(this.section + 1);\n  }\n\n  _onClickListItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Return if item already selected\n    if (a.classList.contains(\"active\")) return;\n\n    this.currentSection.currentItem = this.currentSection.items.find((o) => o.id === a.dataset.id);\n    setProperty(this.currentSection, \"choice\", a.dataset.id);\n    return this._render();\n  }\n\n  async _render(...args) {\n    await super._render(...args);\n    this._updateNavButtons();\n  }\n\n  _onChangeSectionChoice(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const [sectionName, key] = a.name.split(\":\");\n    const section = this._sections.find((o) => o.name === sectionName);\n\n    if (!section) return;\n\n    // Get value\n    let value = a.value;\n    switch (a.dataset.dtype) {\n      case \"Number\":\n        value = parseFloat(value);\n        break;\n      case \"Boolean\":\n        value = [\"true\", \"1\"].includes(value);\n        break;\n    }\n\n    // Change section choice\n    setProperty(section, key, value);\n  }\n\n  _onClickAbilityScoreOperator(event) {\n    event.preventDefault();\n\n    const a = event.currentTarget;\n    const operator = a.dataset.operator;\n    const ablKey = a.closest(\".ability-score\").dataset.key;\n    const section = this.currentSection;\n    const add = operator === \"add\" ? 1 : operator === \"subtract\" ? -1 : 0;\n\n    section.abilities[ablKey].value += add;\n    section.abilities[ablKey].added += add;\n    section.value -= add;\n\n    section.choice = section.value === 0 ? true : null;\n\n    this._render();\n  }\n\n  _updateNavButtons() {\n    const formDiv = this.element.find(\".nav-buttons\");\n\n    const buttons = {\n      previous: formDiv.find(`button[data-type=\"previous\"]`),\n      next: formDiv.find(`button[data-type=\"next\"]`),\n      submit: formDiv.find(`button[type=\"submit\"]`),\n    };\n    if (this._section > 0) {\n      buttons.previous.prop(\"disabled\", false);\n    } else {\n      buttons.previous.prop(\"disabled\", true);\n    }\n\n    const hasMadeChoice = !!this.currentSection.choice;\n    if (this.section < this._sections.length - 1 && hasMadeChoice) {\n      buttons.next.prop(\"disabled\", false);\n    } else {\n      buttons.next.prop(\"disabled\", true);\n    }\n\n    if (this.section === this._sections.length - 1) {\n      buttons.submit.prop(\"disabled\", false);\n    } else {\n      buttons.submit.prop(\"disabled\", true);\n    }\n  }\n\n  _onSubmit(event, ...args) {\n    event.preventDefault();\n    if (this._submitted) return;\n\n    this._submitted = true;\n    super._onSubmit(event, ...args);\n  }\n}\n","export class CurrencyTransfer extends FormApplication {\n  constructor(\n    source = { actor: null, container: null, amount: {}, alt: false },\n    dest = { actor: null, container: null, amount: {}, alt: false },\n    options = {}\n  ) {\n    super(options);\n\n    if (source.actor) {\n      if (typeof source.actor === \"string\") source.actor = game.actors.get(source.actor);\n      if (source.actor.type == \"npc\") source.alt = false;\n    }\n    if (source.container) {\n      source.alt = false;\n      if (typeof source.container === \"string\")\n        source.container = source.actor ? source.actor.items.get(source.container) : game.items.get(source.container);\n    }\n    if (dest.actor) {\n      if (typeof dest.actor === \"string\") dest.actor = game.actors.get(dest.actor);\n      if (dest.actor.type == \"npc\") dest.alt = false;\n      else if (dest.actor === source.actor && !source.container && !dest.container) dest.alt = !source.alt;\n    }\n    if (dest.container) {\n      if (typeof dest.container === \"string\")\n        dest.container = dest.actor ? dest.actor.items.get(dest.container) : game.items.get(dest.container);\n    }\n\n    // Currency checks\n    if (source.container) {\n      source.amount = mergeObject(source.container.system.currency, source.amount ?? {});\n    } else if (source.actor) {\n      source.amount = mergeObject(\n        source.alt ? source.actor.system.altCurrency : source.actor.system.currency,\n        source.amount ?? {}\n      );\n    } else if (game.user.isGM) {\n      source.amount = mergeObject({ pgil: \"\", gil: \"\", sgil: \"\", cgil: \"\" }, source.amount ?? {});\n    } else {\n      ui.notification.warning(\"Cannot use Infinite currency transfer as non-gm.\");\n      return undefined;\n    }\n\n    if (!dest.actor && !dest.container) return undefined;\n\n    this.source = source;\n    this.dest = dest;\n  }\n\n  get title() {\n    let title;\n    if (!this.source.actor) {\n      if (this.source.container) title = this.source.container.name + \" \";\n      else title = \" \";\n    } else {\n      title = this.source.actor.name + \" \";\n      if (this.source.container) title += `(${this.source.container.name}) `;\n    }\n    title += \" \";\n    if (this.source.actor == this.dest.actor && (this.source.alt || this.dest.alt))\n      title += this.dest.alt ? game.i18n.localize(\"FFD20.WeightlessCurrency\") : game.i18n.localize(\"FFD20.Currency\");\n    else {\n      if (!this.dest.actor) title += this.dest.container.name;\n      else {\n        title += this.dest.actor.name;\n        if (this.dest.container) title += ` (${this.dest.container.name})`;\n      }\n    }\n    return title;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"currency-transfer\"],\n      template: \"systems/ffd20/templates/apps/currency-transfer.hbs\",\n      width: 380,\n      height: 235,\n    });\n  }\n\n  static get order() {\n    return [\"pgil\", \"gil\", \"sgil\", \"cgil\"]; // Object conversion ordering cannot be trusted in js\n  }\n\n  activateListeners(html) {\n    html.find('button[type=\"submit\"]').click(this._onSubmit.bind(this));\n\n    html.find(\"button.cur-range\").click(this._curRange.bind(this));\n\n    html.find(\"input\").on(\"input\", this._calcTotal.bind(this));\n    $(html.find(\"input\")[0]).trigger(\"input\");\n  }\n\n  _updateObject(event, formData) {\n    this.dest.amount = {\n      pgil: formData.pgil ?? 0,\n      gil: formData.gil ?? 0,\n      sgil: formData.sgil ?? 0,\n      cgil: formData.cgil ?? 0,\n    };\n    this.constructor.transfer(\n      this.source.container ? this.source.container : this.source.actor,\n      this.dest.container ? this.dest.container : this.dest.actor,\n      this.dest.amount,\n      this.source.alt,\n      this.dest.alt,\n      2\n    );\n  }\n\n  getData(_options = {}) {\n    return {\n      source: this.source,\n      dest: this.dest,\n      options: this.options,\n      title: this.title,\n      total:\n        this.source.amount.gil === \"\"\n          ? \"\"\n          : this.constructor.order.reduce((acc, c, idx) => acc + this.source.amount[c] * 10 ** (1 - idx), 0),\n    };\n  }\n\n  _curRange(ev) {\n    ev.preventDefault();\n    const button = ev.target.closest(\"button\");\n    const formField = button.closest(\".form-fields\");\n    const min = button.classList.contains(\"down\");\n    const input = formField.querySelector(\"input\");\n\n    if (min) input.value = \"\";\n    else input.value = formField.querySelector(\"span\").textContent;\n    $(input).trigger(\"input\");\n  }\n\n  _calcTotal(ev) {\n    const form = ev.target.closest(\".currency-transfer\");\n    const amounts = Object.fromEntries(\n      [...form.querySelectorAll(\"input\")].map((o) => [o.name, parseInt(o.value || 0)])\n    );\n    const value = this.constructor.order.reduce((acc, c, idx) => acc + amounts[c] * 10 ** (1 - idx), 0);\n\n    form.querySelector(\".currency-total .form-fields label\").textContent = Math.round(value * 100) / 100 + \" gil\";\n  }\n\n  async close(...args) {\n    super.close(...args);\n  }\n\n  static _failed(i18nKey) {\n    return void ui.notifications.error(game.i18n.localize(\"FFD20.CurrencyFailed\") + game.i18n.localize(i18nKey));\n  }\n\n  static async _directoryDrop(docDestId, event) {\n    event.preventDefault();\n\n    // try to extract the data\n    let data;\n    try {\n      data = JSON.parse(event.dataTransfer.getData(\"text/plain\"));\n      if (data.type !== \"Currency\") return;\n    } catch (err) {\n      return false;\n    }\n\n    const destDoc = event.currentTarget.classList.contains(\"item\")\n      ? game.items.get(docDestId)\n      : game.actors.get(docDestId);\n\n    let sourceActor = await fromUuid(data.actorUuid || \"\");\n    if (!(sourceActor instanceof Actor)) sourceActor = sourceActor?.actor;\n\n    if (data.currency && sourceActor) {\n      return new CurrencyTransfer(\n        { actor: sourceActor, container: data.containerId, alt: data.alt },\n        {\n          actor: destDoc?.actor ?? destDoc,\n          container: destDoc.system.type === \"container\" ? destDoc.id : null,\n          amount: Object.fromEntries([[data.currency, parseInt(data.amount)]]),\n        }\n      ).render(true);\n    }\n  }\n\n  /**\n   * Transfer an amount of currency to a valid document\n   *\n   * @param {Document} sourceDoc ActorPF or ItemPF with currency\n   * @param {Document} destDoc ActorPF or ItemPF with currency\n   * @param {object|number} amount currency object containing transferred amount. Undefined keys will be assumed to be zero. Providing just a number will assume just gold\n   * @param {boolean} sourceAlt Use alt currency on source\n   * @param {boolean} destAlt Use alt currency on destination\n   * @param {number} [allowConversion=false] Attempts to make change with sourceDoc's currency limit\n   * @returns {boolean|object} false if failed, object containing amount transferred on success\n   */\n  static async transfer(sourceDoc, destDoc, amount, sourceAlt = false, destAlt = false, allowConversion = false) {\n    if ((!sourceDoc && !game.user.isGM) || !destDoc || !amount) return false;\n\n    if (typeof amount !== \"object\") amount = { gil: parseInt(amount) };\n\n    this.order.forEach((c) => (amount[c] = amount[c] ?? 0));\n    if (!Object.values(amount).find((a) => a > 0)) return this._failed(\"FFD20.CurrencyInsufficient\"), false;\n\n    let sourceCurrency = duplicate(sourceAlt ? sourceDoc?.system.altCurrency : sourceDoc?.system.currency);\n    const destCurrency = duplicate(destAlt ? destDoc.system.altCurrency : destDoc.system.currency);\n    if ((!sourceCurrency && !game.user.isGM) || !destCurrency) return false;\n    const originalSource = Object.assign(Object.fromEntries(this.order.map((o) => [o, Infinity])), sourceCurrency);\n\n    const totalAmount = this.order.reduce((acc, c, idx) => acc + amount[c] * 10 ** (1 - idx), 0);\n    const totalSource = this.order.reduce((acc, c, idx) => acc + sourceCurrency[c] * 10 ** (1 - idx), 0);\n\n    if (totalAmount > totalSource) return this._failed(\"FFD20.CurrencyInsufficient\"), false;\n\n    if (sourceCurrency) {\n      this.order.some((a) => {\n        const newSource = sourceCurrency[a] - amount[a];\n\n        if (newSource < 0 && allowConversion) {\n          amount = this.convert(originalSource, totalAmount, allowConversion);\n          sourceCurrency = Object.fromEntries(this.order.map((o) => [o, originalSource[o] - amount[o]]));\n          return true;\n        } else sourceCurrency[a] = newSource;\n      });\n    }\n\n    if (!amount || Object.values(sourceCurrency).find((c) => c < 0)) return false;\n\n    if (!sourceDoc.testUserPermission(game.user, 3) || !destDoc.testUserPermission(game.user, 3)) {\n      if (!game.users.find((o) => o.active && o.isGM)) return this._failed(\"FFD20.CurrencyGMRequired\"), false;\n      game.socket.emit(\"system.ffd20\", {\n        eventType: \"currencyTransfer\",\n        data: {\n          sourceActor: sourceDoc.actor?.uuid ?? sourceDoc.uuid,\n          destActor: destDoc.actor?.uuid ?? destDoc.uuid,\n          sourceContainer: sourceDoc.type === \"container\" ? sourceDoc.id : \"\",\n          destContainer: destDoc.type === \"container\" ? destDoc.id : \"\",\n          sourceAlt: sourceAlt,\n          destAlt: destAlt,\n          amount: amount,\n        },\n      });\n      return amount;\n    }\n\n    this.order.forEach((c) => (destCurrency[c] += amount[c]));\n    if (sourceDoc === destDoc)\n      return sourceDoc.update({\n        \"system.altCurrency\": sourceAlt ? sourceCurrency : destCurrency,\n        \"system.currency\": destAlt ? sourceCurrency : destCurrency,\n      });\n    if (sourceAlt) sourceDoc.update({ \"system.altCurrency\": sourceCurrency });\n    else sourceDoc.update({ \"system.currency\": sourceCurrency });\n    if (destAlt) destDoc.update({ \"system.altCurrency\": destCurrency });\n    else destDoc.update({ \"system.currency\": destCurrency });\n    return amount;\n  }\n\n  /**\n   * Convert totalAmount to a currency object containing\n   *\n   * @param {object} limit currency object containing max number of coins. Falsey values will assume infinity\n   * @param {number|object} totalAmount currency as gold pieces. If provided as a currency object, will convert to gold\n   * @returns {boolean|object} false if failed, currency object containing new amounts on conversion success\n   */\n  static convert(limit, totalAmount) {\n    if (!limit) limit = Object.fromEntries(this.order.map((o) => [o, Infinity]));\n    else limit = Object.assign({}, limit);\n    if (typeof totalAmount !== \"number\")\n      totalAmount = this.order.reduce((acc, cur, idx) => acc + totalAmount?.[cur] * 10 ** (1 - idx));\n    if (!totalAmount) return false;\n    const amount = {};\n    totalAmount =\n      this.order.reduce((acc, cur, idx) => {\n        const minRequired = Math.min(limit[cur], Math.floor((acc % 10000) / 10 ** (3 - idx))), //Start from left to allow clumping\n          inCopper = minRequired * 10 ** (3 - idx);\n        amount[cur] = minRequired;\n        limit[cur] -= minRequired;\n        return acc - inCopper;\n      }, totalAmount * 100) / 100; //Operate in copper pieces to avoid floating point errors\n    if (totalAmount < 0) return false;\n    return amount;\n  }\n}\n","import { ActorTraitSelector } from \"../trait-selector.mjs\";\nimport { ActorResistanceSelector } from \"../damage-resistance-selector.mjs\";\nimport { ActorRestDialog } from \"./actor-rest.mjs\";\nimport {\n  createTag,\n  CR,\n  createConsumableSpellDialog,\n  adjustNumberByStringCommand,\n  splitCurrency,\n} from \"../../utils/lib.mjs\";\nimport { getWeightSystem } from \"@utils\";\nimport { PointBuyCalculator } from \"../point-buy-calculator.mjs\";\nimport { Widget_ItemPicker } from \"../item-picker.mjs\";\nimport { getSkipActionPrompt } from \"../../documents/settings.mjs\";\nimport { ItemPF } from \"../../documents/item/item-pf.mjs\";\nimport { dialogGetActor } from \"../../utils/dialog.mjs\";\nimport { applyAccessibilitySettings } from \"../../utils/chat.mjs\";\nimport { LevelUpForm } from \"../level-up.mjs\";\nimport { CurrencyTransfer } from \"../currency-transfer.mjs\";\nimport { getHighestChanges } from \"../../documents/actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\n/**\n * Extend the basic ActorSheet class to do all the PF things!\n * This sheet is an Abstract layer which is not used.\n *\n * @type {ActorSheet}\n */\nexport class ActorSheetPF extends ActorSheet {\n  constructor(...args) {\n    super(...args);\n\n    /**\n     * Track the set of item filters which are applied\n     *\n     * @type {Set}\n     */\n    this._filters = {\n      inventory: new Set(),\n      \"spellbook-primary\": new Set(),\n      \"spellbook-secondary\": new Set(),\n      \"spellbook-tertiary\": new Set(),\n      \"spellbook-quaternary\": new Set(),\n      \"spellbook-spelllike\": new Set(),\n      features: new Set(),\n      buffs: new Set(),\n      attacks: new Set(),\n      search: {\n        inventory: \"\",\n        attacks: \"\",\n        feats: \"\",\n        buffs: \"\",\n        \"spellbook-primary\": \"\",\n        \"spellbook-secondary\": \"\",\n        \"spellbook-tertiary\": \"\",\n        \"spellbook-quaternary\": \"\",\n        \"spellbook-spelllike\": \"\",\n      },\n    };\n\n    /** Item search */\n    this.searchCompositioning = false; // for IME\n    this.searchRefresh = true; // Lock out same term search unless sheet also refreshes\n    this.searchDelay = 250; // arbitrary ?ms for arbitrarily decent reactivity; MMke this configurable?\n    this.searchDelayEvent = null; // setTimeout id\n    this.effectiveSearch = {}; // prevent searching the same thing\n\n    /**\n     * Track item updates from the actor sheet.\n     *\n     * @property\n     * @private\n     * @type {object[]}\n     */\n    this._itemUpdates = [];\n\n    /**\n     * Track hidden elements of the sheet.\n     *\n     * @property\n     */\n    this._hiddenElems = {};\n\n    /**\n     * Whether a submit has been queued in any way.\n     *\n     * @property\n     */\n    this._submitQueued = false;\n\n    /**\n     * Whether inner part of this sheet has been rendered already.\n     *\n     * @property\n     */\n    this._renderedInner = false;\n\n    /**\n     * A dictionary of additional queued updates, to be added on top of the form's data (and cleared afterwards).\n     *\n     * @property\n     * @private\n     */\n    this._pendingUpdates = {};\n\n    /**\n     * @type {boolean} Whether the skills are currently locked.\n     * @property\n     * @private\n     */\n    this._skillsLocked = true;\n\n    /**\n     * @type {string[]} IDs of expanded items.\n     * @private\n     */\n    this._expandedItems = [];\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      scrollY: [\n        \".combat-attacks\",\n        \".item-groups-list\",\n        \".skills-list\",\n        \".traits\",\n        \".actor-notes\",\n        \".editor-content[data-edit='system.details.biography.value']\",\n      ],\n      dragDrop: [\n        { dragSelector: \"li.item[data-item-id]\" },\n        { dragSelector: \"label.denomination\" },\n        { dragSelector: \".race-container.item[data-item-id]\" },\n        { dragSelector: \"li.skill[data-skill]\" },\n        { dragSelector: \"li.sub-skill[data-skill]\" },\n        { dragSelector: \"th.saving-throw[data-savingthrow]\" },\n        { dragSelector: \"th.attribute.cmb[data-attribute]\" },\n        { dragSelector: \"th.attribute.bab[data-attribute]\" },\n        { dragSelector: \"th.attribute.initiative[data-attribute]\" },\n        { dragSelector: \"li.generic-defenses[data-drag]\" },\n        { dragSelector: \".ability-scores .ability[data-ability]\" },\n        { dragSelector: \".attribute.attack[data-attack]\" },\n        { dragSelector: \".spellcasting-concentration[data-drag]\" },\n        { dragSelector: \".spellcasting-cl\" },\n      ],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"summary\",\n          group: \"primary\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='skillset']\",\n          contentSelector: \"section.skillset-body\",\n          initial: \"adventure\",\n          group: \"skills\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='spellbooks']\",\n          contentSelector: \"section.spellbooks-body\",\n          initial: \"primary\",\n          group: \"spellbooks\",\n        },\n      ],\n    });\n  }\n\n  /**\n   * Returns an object containing feature type specific data relevant to feature organization.\n   *\n   * @static\n   * @type {Object<string, any>}\n   */\n  static get featTypeData() {\n    return {\n      template: {\n        hasActions: false,\n      },\n    };\n  }\n\n  get currentPrimaryTab() {\n    const primaryElem = this.element.find('nav[data-group=\"primary\"] .item.active');\n    if (primaryElem.length !== 1) return null;\n    return primaryElem.attr(\"data-tab\");\n  }\n\n  get currentSpellbookKey() {\n    const elems = this.element.find(\"nav.spellbooks .item.active\");\n    if (elems.length === 1) return elems.attr(\"data-tab\");\n    else return \"primary\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   *\n   * @param options\n   */\n  async getData(options) {\n    const isOwner = this.document.isOwner;\n    const data = mergeObject(await super.getData(options), {\n      owner: isOwner,\n      limited: this.document.limited,\n      editable: this.isEditable,\n      cssClass: isOwner ? \"editable\" : \"locked\",\n      isCharacter: this.document.type === \"character\",\n      hasRace: false,\n      config: ffd20.config,\n      useBGSkills: game.settings.get(\"ffd20\", \"allowBackgroundSkills\"),\n      isGM: game.user.isGM,\n      race: this.document.race != null ? this.document.race.toObject() : null,\n      usesAnySpellbook: this.document.system.attributes.spells.usedSpellbooks?.length > 0 ?? false,\n      sourceData: {},\n      skillsLocked: this._skillsLocked,\n    });\n    const rollData = this.document.getRollData();\n    data.rollData = rollData;\n    data.system = deepClone(this.document.system);\n\n    data.inCharacterGeneration = this.inCharacterGeneration;\n\n    data.hasProficiencies = data.isCharacter || game.settings.get(\"ffd20\", \"npcProficiencies\");\n\n    // Show whether the item has currency\n    data.hasCurrency = Object.values(this.object.system.currency).some((o) => o > 0);\n    data.hasAltCurrency = Object.values(this.object.system.altCurrency).some((o) => o > 0);\n\n    // Enrich descriptions\n    data.biographyHTML = await TextEditor.enrichHTML(data.system.details.biography.value, {\n      secrets: isOwner,\n      rollData: data.rollData,\n      async: true,\n    });\n    data.notesHTML = await TextEditor.enrichHTML(data.system.details.notes.value, {\n      secrets: isOwner,\n      rollData: data.rollData,\n      async: true,\n    });\n\n    // The Actor and its Items\n    data.token = this.token;\n    data.items = this.document.items.map((item) => {\n      const i = deepClone(item.system);\n      i.document = item;\n      i.type = item.type;\n      i.id = item.id;\n      i.img = item.img;\n      i.isSingleUse = item.isSingleUse;\n      i.isCharged = item.isCharged;\n      i.hasResource = i.isCharged && !i.isSingleUse;\n      i.hasUses = i.uses?.max > 0;\n\n      const firstAction = item.firstAction;\n      const firstActionRollData = firstAction?.getRollData();\n\n      i.labels = item.getLabels({ actionId: firstAction?.id, rollData: firstActionRollData });\n      i.hasAttack = firstAction?.hasAttack;\n      i.hasMultiAttack = firstAction?.hasMultiAttack;\n      i.hasDamage = firstAction?.hasDamage;\n      i.hasRange = firstAction?.hasRange;\n      i.hasEffect = firstAction?.hasEffect;\n      i.hasAction = item.hasAction || item.getScriptCalls(\"use\").length > 0;\n      i.range = mergeObject(\n        firstAction?.data?.range ?? {},\n        {\n          min: firstAction?.getRange({ type: \"min\", rollData: firstActionRollData }),\n          max: firstAction?.getRange({ type: \"max\", rollData: firstActionRollData }),\n        },\n        { inplace: false }\n      );\n      i.sort = item.sort;\n      i.showUnidentifiedData = item.showUnidentifiedData;\n      i.name = item.name; // Copy name over from item to handle identified state correctly\n\n      i.isStack = i.quantity > 1;\n      i.price = item.getValue({ recursive: false, sellValue: 1 });\n\n      const itemQuantity = i.quantity != null ? i.quantity : 1;\n      const itemCharges = i.uses?.value != null ? i.uses.value : 1;\n      i.empty = itemQuantity <= 0 || (i.isCharged && !i.isSingleUse && itemCharges <= 0);\n\n      return i;\n    });\n    data.items.sort((a, b) => (a.sort || 0) - (b.sort || 0));\n    data.labels = this.document.getLabels();\n    data.filters = this._filters;\n\n    // Generic melee and ranged attack bonuses, only present for sheet.\n    {\n      const attributes = data.system.attributes,\n        abilities = data.system.abilities,\n        sizeModifier = ffd20.config.sizeMods[data.system.traits.size],\n        baseBonus = attributes.attack.shared + attributes.attack.general + sizeModifier,\n        meleeAbility = abilities[attributes.attack.meleeAbility]?.mod ?? 0,\n        rangedAbility = abilities[attributes.attack.rangedAbility]?.mod ?? 0;\n\n      data.genericAttacks = {\n        melee: {\n          ability: attributes.attack.meleeAbility,\n          abilityMod: meleeAbility,\n          modifier: baseBonus + attributes.attack.melee + meleeAbility,\n        },\n        ranged: {\n          ability: attributes.attack.rangedAbility,\n          abilityMod: rangedAbility,\n          modifier: baseBonus + attributes.attack.ranged + rangedAbility,\n        },\n      };\n    }\n\n    // Add inventory value\n    {\n      const cgilValue = this.calculateTotalItemValue({ inLowestDenomination: true });\n      const totalValue = splitCurrency(cgilValue);\n      data.labels.totalValue = game.i18n.format(\"FFD20.ItemContainerTotalItemValue\", {\n        gil: totalValue.gil,\n        sgil: totalValue.sgil,\n        cgil: totalValue.cgil,\n      });\n    }\n\n    // Hit point sources\n    if (this.document.sourceDetails != null) data.sourceDetails = expandObject(this.document.sourceDetails);\n    else data.sourceDetails = null;\n\n    // Ability Scores\n    for (const [a, abl] of Object.entries(data.system.abilities)) {\n      abl.label = ffd20.config.abilities[a];\n      abl.totalLabel = abl.total == null ? \"-\" : abl.total;\n\n      abl.sourceDetails = [\n        ...(data.sourceDetails?.system?.abilities?.[a]?.total ?? []),\n        ...(data.sourceDetails?.system?.abilities?.[a]?.penalty ?? []),\n      ];\n    }\n\n    // Armor Class\n    for (const [a, ac] of Object.entries(data.system.attributes.ac)) {\n      ac.label = ffd20.config.ac[a];\n      ac.sourceDetails = data.sourceDetails != null ? data.sourceDetails.system.attributes.ac[a].total : [];\n    }\n\n    // Saving Throws\n    for (const [a, savingThrow] of Object.entries(data.system.attributes.savingThrows)) {\n      savingThrow.label = ffd20.config.savingThrows[a];\n      savingThrow.sourceDetails =\n        data.sourceDetails != null ? data.sourceDetails.system.attributes.savingThrows[a].total : [];\n    }\n\n    // Update skill labels\n    const acp = this.document.system.attributes?.acp?.total;\n    for (const [s, skl] of Object.entries(data.system.skills ?? {})) {\n      skl.label = ffd20.config.skills[s];\n      skl.arbitrary = ffd20.config.arbitrarySkills.includes(s);\n      skl.sourceDetails = [];\n      skl.compendiumEntry = ffd20.config.skillCompendiumEntries[s] ?? skl.journal ?? null;\n\n      // Add skill rank source\n      if (skl.rank > 0) {\n        skl.sourceDetails.push({ name: game.i18n.localize(\"FFD20.SkillRankPlural\"), value: skl.rank });\n\n        // Add class skill bonus source\n        if (skl.cs) {\n          skl.sourceDetails.push({ name: game.i18n.localize(\"FFD20.CSTooltip\"), value: 3 });\n        }\n      }\n\n      // Add ACP source\n      if (skl.acp && acp > 0) {\n        skl.sourceDetails.push({ name: game.i18n.localize(\"FFD20.ACPLong\"), value: -acp });\n      }\n\n      // Add ability modifier source\n      if (skl.ability) {\n        skl.sourceDetails.push({\n          name: ffd20.config.abilities[skl.ability],\n          value: data.rollData.abilities[skl.ability]?.mod ?? 0,\n        });\n      }\n\n      // Add misc skill bonus source\n      if (data.sourceDetails != null && data.sourceDetails.system.skills[s] != null) {\n        skl.sourceDetails = skl.sourceDetails.concat(data.sourceDetails.system.skills[s].changeBonus);\n      }\n\n      skl.untrained = skl.rt === true && skl.rank <= 0;\n      if (skl.subSkills != null) {\n        for (const [s2, skl2] of Object.entries(skl.subSkills)) {\n          skl2.compendiumEntry = skl2.journal ?? null;\n          skl2.sourceDetails = [];\n          if (skl2.rank > 0) {\n            skl2.sourceDetails.push({ name: game.i18n.localize(\"FFD20.SkillRankPlural\"), value: skl2.rank });\n            if (skl2.cs) {\n              skl2.sourceDetails.push({ name: game.i18n.localize(\"FFD20.CSTooltip\"), value: 3 });\n            }\n          }\n          skl2.sourceDetails.push({\n            name: ffd20.config.abilities[skl2.ability],\n            value: data.system.abilities[skl2.ability]?.mod ?? 0,\n          });\n          if (\n            data.sourceDetails != null &&\n            data.sourceDetails.system.skills[s] != null &&\n            data.sourceDetails.system.skills[s].subSkills != null &&\n            data.sourceDetails.system.skills[s].subSkills[s2] != null\n          ) {\n            skl2.sourceDetails = skl2.sourceDetails.concat(\n              data.sourceDetails.system.skills[s].subSkills[s2].changeBonus\n            );\n          }\n          skl2.untrained = skl2.rt === true && skl2.rank <= 0;\n        }\n      }\n    }\n\n    // Update traits\n    this._prepareTraits(data.system.traits);\n    data.senses = this._prepareSenses(data.system.traits.senses);\n    data.dr = this._prepareResistance(data.system.traits.dr, \"dr\");\n    data.eres = this._prepareResistance(data.system.traits.eres, \"eres\");\n\n    // Prepare owned items\n    this._prepareItems(data);\n\n    // Compute encumbrance\n    data.encumbrance = this._computeEncumbrance(data.system);\n\n    // Prepare skillsets\n    data.skillsets = this._prepareSkillsets(data.system.skills);\n\n    // Skill rank counting\n    const skillRanks = { allowed: 0, used: 0, bgAllowed: 0, bgUsed: 0, sentToBG: 0 };\n    // Count used skill ranks\n    for (const skl of Object.values(data.rollData.skills)) {\n      if (skl.subSkills != null) {\n        for (const subSkl of Object.values(skl.subSkills)) {\n          if (data.useBGSkills && skl.background) {\n            skillRanks.bgUsed += subSkl.rank;\n          } else {\n            skillRanks.used += subSkl.rank;\n          }\n        }\n      } else if (data.useBGSkills && skl.background) {\n        skillRanks.bgUsed += skl.rank;\n      } else {\n        skillRanks.used += skl.rank;\n      }\n    }\n    // Count allowed skill ranks\n    const sourceData = [];\n    setProperty(data.sourceData, \"skillRanks\", sourceData);\n    this.document.items\n      .filter((obj) => {\n        return obj.type === \"class\" && obj.system.subType !== \"mythic\";\n      })\n      .forEach((cls) => {\n        const clsLevel = cls.system.hitDice;\n        const clsSkillsPerLevel = cls.system.skillsPerLevel;\n        const fcSkills = cls.system.fc.skill.value;\n        skillRanks.allowed +=\n          Math.max(1, clsSkillsPerLevel + this.document.system.abilities.int.mod) * clsLevel + fcSkills;\n        if (data.useBGSkills && ffd20.config.backgroundSkillClasses.includes(cls.system.subType))\n          skillRanks.bgAllowed += clsLevel * ffd20.config.backgroundSkillsPerLevel;\n\n        sourceData.push({\n          name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassBase\", { className: cls.name }),\n          value: clsSkillsPerLevel * clsLevel,\n        });\n        if (fcSkills > 0) {\n          sourceData.push({\n            name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassFC\", { className: cls.name }),\n            value: fcSkills,\n          });\n        }\n      });\n    // Count from intelligence\n    const intMod = this.actor.system.abilities?.int?.mod;\n    if (intMod !== 0) {\n      sourceData.push({\n        name: game.i18n.localize(\"FFD20.AbilityInt\"),\n        value: intMod * this.actor.system.attributes?.hd?.total,\n      });\n    }\n    // Count from bonus skill rank formula\n    if (this.actor.system.details.bonusSkillRankFormula !== \"\") {\n      const roll = RollPF.safeRoll(this.actor.system.details.bonusSkillRankFormula, rollData);\n      if (roll.err) console.error(`An error occurred in the Bonus Skill Rank formula of actor ${this.actor.name}.`);\n      skillRanks.allowed += roll.total;\n      sourceData.push({\n        name: game.i18n.localize(\"FFD20.SkillBonusRankFormula\"),\n        value: roll.total,\n      });\n    }\n    // Calculate from changes\n    this.actor.changes\n      .filter((o) => o.subTarget === \"bonusSkillRanks\")\n      .forEach((o) => {\n        if (!o.value) return;\n\n        skillRanks.allowed += o.value;\n        sourceData.push({\n          name: o.parent?.name ?? game.i18n.localize(\"FFD20.Change\"),\n          value: o.value,\n        });\n      });\n    // Calculate used background skills\n    if (data.useBGSkills) {\n      if (skillRanks.bgUsed > skillRanks.bgAllowed) {\n        skillRanks.sentToBG = skillRanks.bgUsed - skillRanks.bgAllowed;\n        skillRanks.allowed -= skillRanks.sentToBG;\n        skillRanks.bgAllowed += skillRanks.sentToBG;\n      }\n    }\n    data.skillRanks = skillRanks;\n\n    // Feat count\n    {\n      const sourceData = [];\n      setProperty(data.sourceData, \"bonusFeats\", sourceData);\n\n      // Feat count\n      // By level\n      data.featCount = {};\n      data.featCount.value = this.actor.items.filter(\n        (o) => o.type === \"feat\" && o.system.subType === \"feat\" && !o.system.disabled\n      ).length;\n      const totalLevels = this.document.items\n        .filter((o) => o.type === \"class\" && [\"base\", \"npc\", \"prestige\", \"racial\"].includes(o.system.subType))\n        .reduce((cur, o) => {\n          return cur + o.hitDice;\n        }, 0);\n      data.featCount.byLevel = Math.ceil(totalLevels / 2);\n      sourceData.push({\n        name: game.i18n.localize(\"FFD20.Level\"),\n        value: data.featCount.byLevel,\n      });\n\n      // Bonus feat formula\n      const featCountRoll = RollPF.safeRoll(this.document.system.details.bonusFeatFormula || \"0\", rollData);\n      const changes = this.document.changes.filter((c) => c.subTarget === \"bonusFeats\");\n      const changeBonus = getHighestChanges(\n        changes.filter((c) => {\n          c.applyChange(this.document);\n          if (c.parent || c.flavor) {\n            sourceData.push({\n              name: c.parent?.name ?? c.flavor,\n              value: c.value,\n            });\n          }\n          return ![\"set\", \"=\"].includes(c.operator);\n        }),\n        { ignoreTarget: true }\n      ).reduce((cur, c) => {\n        return cur + c.value;\n      }, 0);\n      data.featCount.byFormula = featCountRoll.total + changeBonus;\n      if (featCountRoll.err) {\n        ui.notifications.error(\n          game.i18n.format(\"FFD20.ErrorActorFormula\", {\n            error: game.i18n.localize(\"FFD20.BonusFeatFormula\"),\n            name: this.document.name,\n          })\n        );\n      }\n      if (featCountRoll.total !== 0) {\n        sourceData.push({\n          name: game.i18n.localize(\"FFD20.BonusFeatFormula\"),\n          value: featCountRoll.total,\n        });\n      }\n\n      // Count total\n      data.featCount.total = data.featCount.byLevel + data.featCount.byFormula;\n    }\n\n    // Fetch the game settings relevant to sheet rendering.\n    {\n      const actorType = { character: \"pc\", npc: \"npc\" }[this.document.type];\n      data.healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n      data.useWoundsAndVigor = data.healthConfig.variants[actorType].useWoundsAndVigor;\n    }\n\n    // Determine hidden elements\n    this._prepareHiddenElements();\n    data.hiddenElems = this._hiddenElems;\n\n    data.magicItems = {\n      identified: [],\n      unidentified: [],\n    };\n\n    // Create a table of magic items\n    this.document.items\n      .filter((o) => {\n        if (!o.isPhysical) return false;\n        if (o.showUnidentifiedData) return false;\n        if (!o.system.carried) return false;\n        if (o.system.quantity === 0) return false;\n\n        const school = o.system.aura?.school;\n        const cl = o.system.cl;\n        return school?.length > 0 && cl > 0;\n      })\n      .forEach((item) => {\n        const itemData = {};\n\n        itemData.name = item.name;\n        itemData.img = item.img;\n        itemData.id = item.id;\n        itemData.cl = item.system.cl;\n        itemData.school = item.system.aura?.school;\n        if (CONFIG.FFD20.spellSchools[itemData.school] != null) {\n          itemData.school = CONFIG.FFD20.spellSchools[itemData.school];\n        }\n        itemData.aura = {\n          strength: CONFIG.FFD20.auraStrengths[item.auraStrength],\n          school: itemData.school,\n        };\n        itemData.identifyDC = 15 + itemData.cl;\n        itemData.quantity = item.system.quantity || 0;\n        itemData.identified = item.system.identified === true;\n\n        itemData.unidentifiedName = game.user.isGM ? item.system.unidentified?.name : null;\n\n        if (itemData.identified) data.magicItems.identified.push(itemData);\n        else data.magicItems.unidentified.push(itemData);\n      });\n\n    // Prepare (interactive) labels\n    {\n      data.labels.firstClass = game.i18n\n        .format(\"FFD20.Info_FirstClass\", {\n          html: `<a data-action=\"compendium\" data-action-target=\"classes\" data-tooltip=\"FFD20.OpenCompendium\">${game.i18n.localize(\n            \"FFD20.Info_FirstClass_Compendium\"\n          )}</a>`,\n        })\n        .replace(/\\n+/, \"<br>\");\n    }\n\n    // Return data to the sheet\n    return data;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Determine if this actor is in character generation state.\n   *\n   * @private\n   * @returns {boolean} True if character generation guides are desirable.\n   */\n  get inCharacterGeneration() {\n    return (\n      this.actor.system.attributes.hd.total <= 1 ||\n      Object.values(this.actor.system.abilities).every((abl) => abl.value === 10)\n    );\n  }\n\n  _prepareHiddenElements() {\n    // Hide spellbook info\n    const spellbooks = this.document.system.attributes?.spells?.spellbooks ?? {};\n    for (const k of Object.keys(spellbooks)) {\n      const key = `spellbook-info_${k}`;\n      if (this._hiddenElems[key] == null) this._hiddenElems[key] = true;\n    }\n  }\n\n  _prepareTraits(traits) {\n    const damageTypes = ffd20.registry.damageTypes.getLabels();\n    const map = {\n      // \"dr\": FFD20.damageTypes,\n      di: damageTypes,\n      dv: damageTypes,\n      ci: ffd20.config.conditionTypes,\n      languages: ffd20.config.languages,\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n    };\n    for (const [t, choices] of Object.entries(map)) {\n      const trait = traits[t];\n      if (!trait) continue;\n      let values = [];\n      // Prefer total over value for dynamically collected proficiencies\n      if ([\"armorProf\", \"weaponProf\", \"languages\"].includes(t)) {\n        values = trait.total ?? trait.value;\n      } else if (trait.value) {\n        values = trait.value instanceof Array ? trait.value : [trait.value];\n      }\n      trait.selected = values.reduce((obj, t) => {\n        obj[t] = choices[t];\n        return obj;\n      }, {});\n\n      // Prefer total over value for dynamically collected proficiencies\n      if (trait.customTotal) {\n        trait.customTotal\n          .split(ffd20.config.re.traitSeparator)\n          .forEach((c, i) => (trait.selected[`custom${i + 1}`] = c.trim()));\n      } else if (trait.custom) {\n        // Add custom entry\n        trait.custom\n          .split(ffd20.config.re.traitSeparator)\n          .forEach((c, i) => (trait.selected[`custom${i + 1}`] = c.trim()));\n      }\n      trait.cssClass = !foundry.utils.isEmpty(trait.selected) ? \"\" : \"inactive\";\n    }\n  }\n\n  _prepareSenses(senses) {\n    const result = {};\n\n    for (const [k, v] of Object.entries(senses)) {\n      if (k === \"ll\" && senses[k].enabled) {\n        result[k] = ffd20.config.senses[k];\n        continue;\n      }\n\n      if (k === \"custom\" && v.length) {\n        v.split(ffd20.config.re.traitSeparator).forEach((c, i) => {\n          result[`custom${i + 1}`] = c.trim();\n        });\n        continue;\n      }\n\n      if (typeof v === \"number\" && v > 0) {\n        const converted = ffd20.utils.convertDistance(v);\n        result[k] = `${ffd20.config.senses[k]} ${converted[0]} ${converted[1]}`;\n        continue;\n      }\n\n      if (v === true) {\n        result[k] = ffd20.config.senses[k];\n        continue;\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   *\n   * @param {Object<string, any>} damages - The traits object containing both custom text input and more structured resistances\n   * @param {string} damageType  - The type of resistance to check (\"dr\" or \"eres\" for damage reduction or energy resistance, respectively)\n   * @returns {Object<string, string>} - An object of key-value pairs of string labels for the actor sheet\n   */\n  _prepareResistance(damages, damageType) {\n    const result = {};\n\n    const format = (amount, type, operator, type2) => {\n      let translatedType = type;\n      if (type2) {\n        switch (operator) {\n          case false: {\n            // Combine with AND\n            translatedType = game.i18n.format(\"FFD20.Application.DamageResistanceSelector.CombinationFormattedAnd\", {\n              type1: type,\n              type2: type2,\n            });\n            break;\n          }\n          default:\n          case true: {\n            // Combine with OR\n            translatedType = game.i18n.format(\"FFD20.Application.DamageResistanceSelector.CombinationFormattedOr\", {\n              type1: type,\n              type2: type2,\n            });\n            break;\n          }\n        }\n      }\n\n      return damageType === \"dr\" ? `${amount}/${translatedType}` : `${translatedType} ${amount}`;\n    };\n\n    for (const [key, value] of Object.entries(damages)) {\n      if (key === \"custom\") {\n        if (value.length) {\n          value.split(ffd20.config.re.traitSeparator).forEach((term, counter) => {\n            const split = term.split(damageType === \"dr\" ? /\\s*\\/\\s*/ : /\\s+/);\n            const type = split[damageType === \"dr\" ? 1 : 0];\n            const amount = split[damageType === \"dr\" ? 0 : 1];\n\n            result[`custom${counter + 1}`] = format(amount, type, null, \"\");\n          });\n        }\n        continue;\n      }\n\n      value.forEach((entry, counter) => {\n        const [amount, operator] = [entry.amount, entry.operator];\n        const type1 = ffd20.registry.damageTypes.get(entry.types[0]?.toLowerCase())?.name ?? \"-\";\n        const type2 = ffd20.registry.damageTypes.get(entry.types[1]?.toLowerCase())?.name ?? \"\";\n\n        result[`${counter + 1}`] = format(amount, type1, operator, type2);\n      });\n    }\n\n    return result;\n  }\n  /* -------------------------------------------- */\n\n  /**\n   * Insert a spell into the spellbook object when rendering the character sheet\n   *\n   * @param {object} data     The Actor data being prepared\n   * @param {Array} spells    The spell data being prepared\n   * @param {string} bookKey  The key of the spellbook being prepared\n   * @private\n   */\n  _prepareSpellbook(data, spells, bookKey) {\n    const owner = this.document.isOwner;\n    const book = this.document.system.attributes.spells.spellbooks[bookKey];\n\n    const min = book.hasCantrips ? 0 : 1;\n    let max = 9;\n    if (book.autoSpellLevelCalculation) {\n      const cl = book.cl.autoSpellLevelTotal;\n\n      const castsPerDay =\n        ffd20.config.casterProgression.castsPerDay[book.spellPreparationMode]?.[book.casterType]?.[cl - 1];\n      // Check against undefined protects against bad CL modifications.\n      max = castsPerDay !== undefined ? castsPerDay.length - 1 : 0;\n    }\n\n    // Reduce spells to the nested spellbook structure\n    const spellbook = {};\n    for (let level = 0; level < 10; level++) {\n      const spellLevel = book.spells?.[`spell${level}`];\n      if (!spellLevel) {\n        console.error(`Bad data for spell level ${level} in spellbook \"${bookKey}\" for actor \"${this.actor.name}\"`);\n        continue;\n      }\n      if (!isNaN(spellLevel.max)) {\n        spellbook[level] = {\n          level: level,\n          usesSlots: true,\n          spontaneous: book.spontaneous,\n          canCreate: owner === true,\n          canPrepare: data.actor.type === \"character\",\n          label: ffd20.config.spellLevels[level],\n          items: [],\n          uses: spellLevel.value || 0,\n          baseSlots: spellLevel.base || 0,\n          slots: spellLevel.max || 0,\n          dataset: { type: \"spell\", level: level, spellbook: bookKey },\n          name: game.i18n.localize(`FFD20.SpellLevel${level}`),\n          spellMessage: spellLevel.spellMessage,\n          lowAbilityScore: spellLevel.lowAbilityScore,\n          known: spellLevel.known,\n          preparation: spellLevel.preparation,\n        };\n      }\n    }\n    spells.forEach((spell) => {\n      const lvl = spell.level ?? min;\n      spellbook[lvl]?.items.push(spell);\n    });\n\n    for (let a = 0; a < 10; a++) {\n      if (spellbook[a]?.items.length === 0 && (a > max || a < min)) delete spellbook[a];\n    }\n\n    return spellbook;\n  }\n\n  _prepareSkillsets(skillset) {\n    const result = {\n      all: { skills: {} },\n      adventure: { skills: {} },\n      background: { skills: {} },\n    };\n\n    // sort skills by label\n    const keys = Object.keys(skillset).sort(function (a, b) {\n      if (skillset[a].custom && !skillset[b].custom) return 1;\n      if (!skillset[a].custom && skillset[b].custom) return -1;\n      return (\"\" + skillset[a].label).localeCompare(skillset[b].label);\n    });\n\n    keys.forEach((a) => {\n      const skl = skillset[a];\n      // Include all bute Lore and Artistry in all\n      if (!ffd20.config.backgroundOnlySkills.includes(a)) result.all.skills[a] = skl;\n      if (skl.background) result.background.skills[a] = skl;\n      else result.adventure.skills[a] = skl;\n    });\n\n    return result;\n  }\n\n  /**\n   * Returns the amount of type filters currently active.\n   *\n   * @param filters\n   * @returns {number}\n   * @private\n   */\n  _typeFilterCount(filters) {\n    return Array.from(filters).filter((s) => s.startsWith(\"type-\")).length;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Determine whether an Item will be shown based on the current set of filters\n   *\n   * @param {object[]} items - Raw data objects of items\n   * @param filters\n   * @returns {boolean}\n   * @private\n   */\n  _filterItems(items, filters) {\n    const hasTypeFilter = this._typeFilterCount(filters) > 0;\n\n    return items.filter((item) => {\n      if ([\"feat\", \"buff\", \"attack\"].includes(item.type)) {\n        if (hasTypeFilter && !filters.has(`type-${item.subType}`)) return false;\n      }\n\n      if (item.document.isPhysical) {\n        if (hasTypeFilter && item.type !== \"loot\" && !filters.has(`type-${item.type}`)) return false;\n        else if (hasTypeFilter && item.type === \"loot\" && !filters.has(`type-${item.subType}`)) return false;\n      }\n\n      if (item.type === \"spell\") {\n        if (hasTypeFilter && !filters.has(`type-${item.level}`)) return false;\n      }\n\n      return true;\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Compute the level and percentage of encumbrance for an Actor.\n   *\n   * @param {object} actorData      The data object for the Actor being rendered\n   * @returns {object}               An object describing the character's encumbrance level\n   * @private\n   */\n  _computeEncumbrance(actorData) {\n    const carriedWeight = actorData.attributes.encumbrance.carriedWeight;\n    const load = {\n      light: actorData.attributes.encumbrance.levels.light,\n      medium: actorData.attributes.encumbrance.levels.medium,\n      heavy: actorData.attributes.encumbrance.levels.heavy,\n    };\n    const usystem = getWeightSystem();\n    const carryLabel =\n      usystem === \"metric\"\n        ? game.i18n.format(\"FFD20.CarryLabelKg\", { kg: carriedWeight })\n        : game.i18n.format(\"FFD20.CarryLabel\", { lbs: carriedWeight });\n\n    const enc = {\n      pct: {\n        light: Math.clamped((carriedWeight * 100) / load.light, 0, 99.5),\n        medium: Math.clamped(((carriedWeight - load.light) * 100) / (load.medium - load.light), 0, 99.5),\n        heavy: Math.clamped(((carriedWeight - load.medium) * 100) / (load.heavy - load.medium), 0, 99.5),\n      },\n      encumbered: {\n        light: actorData.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.medium,\n        medium: actorData.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.heavy,\n        heavy: actorData.attributes.encumbrance.carriedWeight >= actorData.attributes.encumbrance.levels.heavy,\n      },\n      light: actorData.attributes.encumbrance.levels.light,\n      medium: actorData.attributes.encumbrance.levels.medium,\n      heavy: actorData.attributes.encumbrance.levels.heavy,\n      aboveHead: actorData.attributes.encumbrance.levels.heavy,\n      offGround: actorData.attributes.encumbrance.levels.heavy * 2,\n      dragPush: actorData.attributes.encumbrance.levels.heavy * 5,\n      value: actorData.attributes.encumbrance.carriedWeight,\n      carryLabel: carryLabel,\n    };\n\n    return enc;\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param html {HTML}   The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Tooltips\n    html.mousemove((ev) => this._moveTooltips(ev));\n\n    // Activate Item Filters\n    const filterLists = html.find(\".filter-list\");\n    filterLists.each(this._initializeFilterItemList.bind(this));\n    filterLists.on(\"click\", \".filter-item\", this._onToggleFilter.bind(this));\n\n    // Search boxes\n    {\n      const sb = html.find(\".search-input\");\n      sb.on(\"keyup change\", this._searchFilterChange.bind(this));\n      sb.on(\"compositionstart compositionend\", this._searchFilterCompositioning.bind(this)); // for IME\n      this.searchRefresh = true;\n      // Filter tabs on followup refreshes\n      sb.each(function () {\n        if (this.value.length > 0) $(this).change();\n      });\n      html.find(\".clear-search\").on(\"click\", this._clearSearch.bind(this));\n    }\n\n    // Item summaries\n    html.find(\".item .item-name\").click((event) => this._onItemSummary(event));\n\n    // Allow opening items even if the sheet isn't editable.\n\n    // Race item\n    html.find(\".race\").each((i, el) => {\n      if (el.closest(\".item\").dataset?.itemId) el.addEventListener(\"contextmenu\", (ev) => this._onItemEdit(ev));\n    });\n    // General items\n    html.find(\".item-edit\").on(\"click\", this._onItemEdit.bind(this));\n    // General items (right click)\n    html.find(\".item .item-name\").contextmenu(this._onItemEdit.bind(this));\n    // Quick items (right click)\n    html.find(\".quick-actions li\").contextmenu(this._onItemEdit.bind(this));\n    // Race controls (editable limitations done internally)\n    html.find(\".race-container .item-control\").click(this._onRaceControl.bind(this));\n\n    // Everything below here is only needed if the sheet is editable\n    if (!this.options.editable) {\n      html.find(\"span.text-box\").addClass(\"readonly\");\n      return;\n    }\n\n    // Remove default change handler\n    html.off(\"change\");\n    // Add alternative change handler\n    html.find(\"input,select,textarea\").on(\"change\", this._onChangeInput.bind(this));\n\n    // Add general text box (span) handler\n    html.find(\"span.text-box.direct\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n    });\n\n    // Click to change text input\n    html.find('*[data-action=\"input-text\"]').click((event) => this._onInputText(event));\n    html\n      .find('*[data-action=\"input-text\"].wheel-change')\n      .on(\"wheel\", (event) => this._onInputText(event.originalEvent));\n\n    // Trigger form submission from textarea elements.\n    html.find(\"textarea\").change(this._onSubmit.bind(this));\n\n    // Show configureable fields\n    html.find(\".config .config-control\").click(this._onConfigControl.bind(this));\n\n    // Select the whole text on click\n    html.find(\".select-on-click\").click(this._selectOnClick.bind(this));\n\n    // Submit on blur\n    html.find(\".submit-on-blur\").on(\"blur\", async (ev) => {\n      await this._onSubmit(ev, { preventRender: true });\n      this.render();\n    });\n\n    /* -------------------------------------------- */\n    /*  Abilities, Skills, Defenses and Traits\n    /* -------------------------------------------- */\n\n    // Submit hit points\n    html.find('input[name=\"system.attributes.hp.value\"]').keypress(this._onSubmitElement.bind(this));\n\n    // Submit mana points\n    html.find('input[name=\"system.attributes.mp.value\"]').keypress(this._onSubmitElement.bind(this));\n\n    // Ability Checks\n    html.find(\".ability-name\").click(this._onRollAbilityTest.bind(this));\n\n    // BAB Check\n    html.find(\".attribute.bab .rollable\").click(this._onRollBAB.bind(this));\n\n    // CMB Check\n    html.find(\".attribute.cmb .rollable\").click(this._onRollCMB.bind(this));\n\n    // Attack check\n    html.find(\".attribute.attack.melee .rollable\").click(this._onRollMelee.bind(this));\n    html.find(\".attribute.attack.ranged .rollable\").click(this._onRollRanged.bind(this));\n\n    // Initiative Check\n    html.find(\".attribute.initiative .rollable\").click(this._onRollInitiative.bind(this));\n\n    // Saving Throw\n    html.find(\".saving-throw .rollable\").click(this._onRollSavingThrow.bind(this));\n\n    // Adjust skill rank\n    html.find(\"span.text-box.skill-rank\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n    });\n\n    // Add arbitrary skill\n    html.find(\".skill.arbitrary .skill-create\").click((ev) => this._onArbitrarySkillCreate(ev));\n\n    // Delete arbitrary skill\n    html.find(\".sub-skill > .skill-controls > .skill-delete\").click((ev) => this._onArbitrarySkillDelete(ev));\n\n    // Add custom skill\n    html.find(\".skill-controls.skills .skill-create\").click((ev) => this._onSkillCreate(ev));\n\n    // Edit skill\n    html.find(\".sub-skill > .skill-controls > .skill-edit\").on(\"click\", (ev) => this._onSkillEdit(ev));\n    html.find(\".skill > .skill-controls > .skill-edit\").on(\"click\", (ev) => this._onSkillEdit(ev));\n    // Delete custom skill\n    html.find(\".skill > .skill-controls > .skill-delete\").click((ev) => this._onSkillDelete(ev));\n\n    // Item Action control\n    html.find(\".item-actions a.item-action\").click(this._itemActivationControl.bind(this));\n\n    // Roll Skill Checks\n    html.find(\".skill > .action.roll\").click(this._onRollSkillCheck.bind(this));\n    html.find(\".sub-skill > .action.roll\").click(this._onRollSubSkillCheck.bind(this));\n\n    // Open skill compendium entry\n    html.find(\"a.compendium-entry\").click(this._onOpenCompendiumEntry.bind(this));\n\n    // Trait Selector\n    html.find(\".trait-selector\").click(this._onTraitSelector.bind(this));\n\n    // Resistance Selector\n    html.find(\".resistance-selector\").click(this._onResistanceSelector.bind(this));\n\n    // Display defenses\n    html.find(\".generic-defenses .rollable\").click((ev) => {\n      this.document.displayDefenseCard({ token: this.token });\n    });\n\n    // Rest\n    html.find(\".rest\").click(this._onRest.bind(this));\n\n    // Point Buy Calculator\n    html.find(\"button.pointbuy-calculator\").click(this._onPointBuyCalculator.bind(this));\n\n    // Alignment\n    html.find(\".control.alignment\").click(this._onControlAlignment.bind(this));\n\n    // Edit senses\n    html.find(\".senses-selector\").on(\"click\", this._onSensesSelector.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Inventory\n    /* -------------------------------------------- */\n\n    // Owned Item management\n    html.find(\".item-create\").on(\"click\", (ev) => this._onItemCreate(ev));\n    html.find(\".item-delete\").on(\"click\", this._onItemDelete.bind(this));\n    html.find(\".item-give\").on(\"click\", this._onItemGive.bind(this));\n    html.find(\".item-split:not(.disabled)\").on(\"click\", this._onItemSplit.bind(this));\n\n    // Item Rolling\n    html.find(\".item .item-image\").click((event) => this._onItemRoll(event));\n\n    // Quick add item quantity\n    html.find(\"a.item-control.item-quantity-add\").click((ev) => {\n      this._quickChangeItemQuantity(ev, 1);\n    });\n    // Quick subtract item quantity\n    html.find(\"a.item-control.item-quantity-subtract\").click((ev) => {\n      this._quickChangeItemQuantity(ev, -1);\n    });\n\n    // Quick (un)equip item\n    html.find(\"a.item-control.item-equip\").click((ev) => {\n      this._quickEquipItem(ev);\n    });\n\n    // Quick carry item\n    html.find(\"a.item-control.item-carry\").click((ev) => {\n      this._quickCarryItem(ev);\n    });\n\n    // Quick (un)identify item\n    html.find(\"a.item-control.item-identify\").click((ev) => {\n      this._quickIdentifyItem(ev);\n    });\n\n    // Quick toggle item property\n    html.find(\"a.item-control.item-toggle-data\").click(this._itemToggleData.bind(this));\n\n    // Duplicate item\n    html.find(\"a.item-control.item-duplicate\").click(this._duplicateItem.bind(this));\n\n    // Quick Action\n    html.find(\".quick-actions li\").click(this._quickAction.bind(this));\n\n    // Convert currency\n    html.find(\"a.convert-currency\").click(this._convertCurrency.bind(this));\n\n    // Set item charges\n    html\n      .find(\".inventory-body .item-uses span.text-box.value\")\n      .on(\"wheel\", this._setFeatUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setFeatUses.bind(this));\n      });\n\n    // Set attack charges\n    html\n      .find(\".attacks-body .item-uses span.text-box.value\")\n      .on(\"wheel\", this._setFeatUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setFeatUses.bind(this));\n      });\n\n    /* -------------------------------------------- */\n    /*  Feats\n    /* -------------------------------------------- */\n\n    html\n      .find(\".feats-body .item-uses span.text-box.value\")\n      .on(\"wheel\", this._setFeatUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setFeatUses.bind(this));\n      });\n\n    /* -------------------------------------------- */\n    /*  Classes\n    /* -------------------------------------------- */\n\n    // Level Up\n    html.find(\".level-up\").click(this._onLevelUp.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Spells\n    /* -------------------------------------------- */\n\n    // Set specific spell's (max) uses\n    html\n      .find(\".item-list .spell-uses span.text-box[data-type='amount']\")\n      .on(\"wheel\", this._setSpellUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setSpellUses.bind(this));\n      });\n    html\n      .find(\".item-list .spell-uses span.text-box[data-type='max']\")\n      .on(\"wheel\", this._setMaxSpellUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setMaxSpellUses.bind(this));\n      });\n\n    // Set spell level uses for spontaneous spellbooks\n    html\n      .find(\".spell-uses .spell-slots.spontaneous span.text-box\")\n      .on(\"wheel\", this._adjustActorPropertyBySpan.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n      });\n    // Set base amount of spell uses for a given spell level\n    html.find(\".spell-uses .spell-max span.text-box\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._onSubmit.bind(this));\n    });\n\n    // Set spell point amount\n    html\n      .find(\".spell-points-current .value span.text-box\")\n      .on(\"wheel\", this._adjustActorPropertyBySpan.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n      });\n\n    html.find(\".spellcasting-concentration.rollable\").click(this._onRollConcentration.bind(this));\n\n    html.find(\".spellcasting-cl.rollable\").click(this._onRollCL.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Buffs\n    /* -------------------------------------------- */\n\n    html\n      .find(\".item-detail.item-active input[type='checkbox']\")\n      .off(\"change\")\n      .on(\"change\", this._setItemActive.bind(this));\n\n    html\n      .find(\".item-detail.item-level span.text-box\")\n      .on(\"wheel\", this._setBuffLevel.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setBuffLevel.bind(this));\n      });\n\n    html.find(\"a.hide-show\").click(this._hideShowElement.bind(this));\n\n    // Toggle condition\n    html.find(\".condition .checkbox\").click(this._onToggleCondition.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Skills\n    /* -------------------------------------------- */\n\n    html.find(\".skill-lock-button\").on(\"click\", this._onToggleSkillLock.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Links\n    /* -------------------------------------------- */\n\n    html.find('a[data-action=\"compendium\"]').click(this._onOpenCompendium.bind(this));\n  }\n\n  /* -------------------------------------------- */\n\n  _onSpanTextInput(event, callback = null) {\n    const el = event.currentTarget;\n    const parent = el.parentElement;\n\n    // Replace span element with an input (text) element\n    const newEl = document.createElement(`INPUT`);\n    newEl.type = \"text\";\n    if (el.dataset?.dtype) newEl.dataset.dtype = el.dataset.dtype;\n\n    // Set value of new input element\n    let prevValue = el.innerText;\n    if (el.classList.contains(\"placeholder\")) prevValue = \"\";\n\n    const noCap = el.classList.contains(\"no-value-cap\");\n\n    const name = el.getAttribute(\"name\");\n    let maxValue;\n    if (name) {\n      newEl.setAttribute(\"name\", name);\n      prevValue = getProperty(this.document, name) ?? \"\";\n      if (prevValue && typeof prevValue !== \"string\") prevValue = prevValue.toString();\n\n      if (name.endsWith(\".value\") && !noCap) {\n        const maxName = name.replace(/\\.value$/, \".max\");\n        maxValue = getProperty(this.document, maxName);\n      }\n    }\n    newEl.value = prevValue;\n\n    // Toggle classes\n    const forbiddenClasses = [\"placeholder\", \"direct\", \"allow-relative\"];\n    for (const cls of el.classList) {\n      if (!forbiddenClasses.includes(cls)) newEl.classList.add(cls);\n    }\n\n    // Replace span with input element\n    const allowRelative = el.classList.contains(\"allow-relative\"),\n      clearValue = parseFloat(el.dataset.clearValue || \"0\");\n    parent.replaceChild(newEl, el);\n    let changed = false;\n    newEl.addEventListener(\"keypress\", (event) => {\n      if (event.key !== \"Enter\") return;\n      changed = true;\n      if (allowRelative) {\n        const number = adjustNumberByStringCommand(parseFloat(prevValue), newEl.value, maxValue, clearValue);\n        newEl.value = number;\n      }\n\n      if (newEl.value.toString() === prevValue.toString()) {\n        this.render();\n      } else if (typeof callback === \"function\") {\n        callback.call(this, event);\n      }\n    });\n    newEl.addEventListener(\"focusout\", (event) => {\n      if (!changed) {\n        changed = true;\n        if (allowRelative && parseFloat(prevValue) !== parseFloat(newEl.value)) {\n          const number = adjustNumberByStringCommand(parseFloat(prevValue), newEl.value, maxValue, clearValue);\n          newEl.value = number;\n        }\n\n        if (newEl.value.toString() === prevValue.toString()) {\n          this.render();\n        } else if (typeof callback === \"function\") {\n          callback.call(this, event);\n        }\n      }\n    });\n\n    // Select text inside new element\n    newEl.focus();\n    newEl.select();\n  }\n\n  _moveTooltips(event) {\n    const elem = $(event.currentTarget);\n    const x = event.clientX;\n    const y = event.clientY + 24;\n    elem.find(\".tooltip:hover .tooltipcontent\").css(\"left\", `${x}px`).css(\"top\", `${y}px`);\n  }\n\n  _onDragSkillStart(event) {\n    const elem = event.currentTarget;\n    let skillElem = elem.closest(\".sub-skill\");\n    let mainSkill = null;\n    let subSkill = null;\n    let isSubSkill = true;\n    if (!skillElem) {\n      skillElem = elem.closest(\".skill\");\n      isSubSkill = false;\n    }\n    if (!skillElem) return;\n\n    if (isSubSkill) {\n      mainSkill = skillElem.dataset.mainSkill;\n      subSkill = skillElem.dataset.skill;\n    } else {\n      mainSkill = skillElem.dataset.skill;\n    }\n\n    const result = {\n      type: \"skill\",\n      uuid: this.document.uuid,\n      skill: subSkill ? `${mainSkill}.subSkills.${subSkill}` : mainSkill,\n    };\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  /**\n   * @param {DragEvent} event\n   * @param {\"bab\"|\"cmb\"|\"defenses\"|\"concentration\"|\"cl\"|\"initiative\"|\"abilityScore\"|\"attack\"} type\n   * @param {string} [subType] Type specific subtype\n   */\n  _onDragMiscStart(event, type, subType) {\n    const result = {\n      type: type,\n      uuid: this.document.uuid,\n    };\n\n    switch (type) {\n      case \"bab\":\n      case \"cmb\":\n      case \"initiative\":\n      case \"defenses\":\n        // No special handling\n        break;\n      case \"concentration\":\n      case \"cl\": {\n        const elem = event.currentTarget.closest(\".tab.spellbook-group\");\n        result.bookId = elem.dataset.tab;\n        break;\n      }\n      case \"abilityScore\":\n        result.ability = subType;\n        break;\n      case \"attack\":\n        result.attack = subType;\n        break;\n      default:\n        throw new Error(`Unrecognized drag source: ${type}`);\n    }\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  _onDragSaveStart(event, type) {\n    const result = {\n      type: \"save\",\n      save: type,\n      uuid: this.document.uuid,\n    };\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  /**\n   * Initialize Item list filters by activating the set of filters which are currently applied\n   *\n   * @param i\n   * @param ul\n   * @private\n   */\n  _initializeFilterItemList(i, ul) {\n    const set = this._filters[ul.dataset.filter];\n    const filters = ul.querySelectorAll(\".filter-item\");\n    for (const li of filters) {\n      if (set.has(li.dataset.filter)) li.classList.add(\"active\");\n    }\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  _onRest(event) {\n    event.preventDefault();\n    const app = Object.values(this.document.apps).find((o) => {\n      return o instanceof ActorRestDialog && o._element;\n    });\n    if (app) app.render(true, { focus: true });\n    else new ActorRestDialog(this.document).render(true);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle rolling of an item from the Actor sheet, obtaining the Item instance and dispatching to it's roll method\n   *\n   * @param event\n   * @private\n   */\n  _onItemRoll(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    if (item == null) return;\n    return item.displayCard(undefined, { token: this.token });\n  }\n\n  _mouseWheelAdd(event, el) {\n    const isInput = el.tagName === \"INPUT\";\n    const { originalEvent } = event;\n\n    if (originalEvent && originalEvent instanceof WheelEvent && originalEvent.ctrlKey) {\n      event.preventDefault();\n      const value = (isInput ? parseFloat(el.value) : parseFloat(el.innerText)) || 0;\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(originalEvent.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n\n      if (isInput) {\n        el.value = value + amount * increase;\n      } else {\n        el.innerText = (value + amount * increase).toString();\n      }\n    }\n  }\n\n  _setFeatUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setItemUpdate(item.id, \"system.uses.value\", value);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateItems();\n        });\n      }\n    } else this._updateItems();\n  }\n\n  _setSpellUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n\n    const prevValue = item.system.preparation?.preparedAmount;\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setItemUpdate(item.id, \"system.preparation.preparedAmount\", value);\n    if (prevValue < value) {\n      const maxValue = item.system.preparation.maxAmount;\n      this.setItemUpdate(item.id, \"system.preparation.maxAmount\", Math.max(maxValue, value));\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateItems();\n        });\n      }\n    } else this._updateItems();\n  }\n  _setMaxSpellUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n\n    const prevValue = item.system.preparation?.maxAmount;\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setItemUpdate(item.id, \"system.preparation.maxAmount\", Math.max(0, value));\n    if (prevValue > value) {\n      const curValue = item.system.preparation.preparedAmount;\n      this.setItemUpdate(item.id, \"system.preparation.preparedAmount\", Math.min(curValue, value));\n    }\n    if (value < 0) {\n      el.tagName === \"INPUT\" ? (el.value = 0) : (el.innerText = 0);\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateItems();\n        });\n      }\n    } else this._updateItems();\n  }\n\n  _adjustActorPropertyBySpan(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    this._mouseWheelAdd(event, el);\n\n    // Get base value\n    const rawValue = el.tagName === \"INPUT\" ? el.value : el.innerText;\n    let value = el.dataset.dtype === \"String\" ? rawValue : Number(rawValue);\n\n    // Adjust value if needed\n    const name = el.getAttribute(\"name\");\n    if (name.match(/^system\\.abilities\\.([a-zA-Z0-9]+)\\.value$/)) {\n      if (Number.isNaN(parseInt(value))) value = null;\n      else value = parseInt(value);\n    }\n\n    // Add pending update\n    if (name) {\n      this._pendingUpdates[name] = value;\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._onSubmit(event);\n        });\n      }\n    } else this._onSubmit(event);\n  }\n\n  _setBuffLevel(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    const name = el.getAttribute(\"name\");\n    if (name) {\n      this._pendingUpdates[name] = value;\n    }\n\n    this.setItemUpdate(item.id, \"system.level\", value);\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateItems();\n        });\n      }\n    } else this._updateItems();\n  }\n\n  _hideShowElement(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const target = this.element.find(`.${a.dataset.for}`);\n\n    if (target.hasClass(\"hidden\")) {\n      $(a).find(\"i\").removeClass(\"fa-arrow-circle-down\").addClass(\"fa-arrow-circle-up\");\n      target.removeClass(\"hidden\");\n      target.hide();\n      target.slideDown(200);\n\n      this._hiddenElems[a.dataset.for] = false;\n    } else {\n      $(a).find(\"i\").removeClass(\"fa-arrow-circle-up\").addClass(\"fa-arrow-circle-down\");\n      target.slideUp(200, () => target.addClass(\"hidden\"));\n\n      this._hiddenElems[a.dataset.for] = true;\n    }\n  }\n\n  _onToggleCondition(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const key = a.name;\n\n    // Delete the stored condition status if setting to false\n    const newStatus = !getProperty(this.actor, key);\n    const deleteKey = key.replace(/(\\w+)$/, (condition) => `-=${condition}`);\n    const updateData = newStatus ? { [key]: true } : { [deleteKey]: null };\n    this.actor.update(updateData);\n  }\n\n  /**\n   * Toggle skill lock.\n   *\n   * @param {MouseEvent} event\n   */\n  _onToggleSkillLock(event) {\n    event.preventDefault();\n    this._skillsLocked = !this._skillsLocked;\n\n    const target = event.currentTarget;\n    target.classList.toggle(\"unlocked\", !this._skillsLocked);\n\n    const tab = target.closest(\".tab\");\n    tab.classList.toggle(\"locked\", this._skillsLocked);\n\n    tab.querySelectorAll(\".lockable\").forEach((el) => {\n      if ([\"INPUT\", \"SELECT\"].includes(el.tagName)) {\n        el.disabled = this._skillsLocked;\n      } else {\n        el.classList.toggle(\"hide-contents\", this._skillsLocked);\n      }\n    });\n  }\n\n  _onOpenCompendium(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const target = a.dataset.actionTarget;\n\n    ffd20.applications.compendiums[target].render(true, { focus: true });\n  }\n\n  _onRollConcentration(event) {\n    event.preventDefault();\n\n    const spellbookKey = $(event.currentTarget).closest(\".spellbook-group\").data(\"tab\");\n    this.document.rollConcentration(spellbookKey, { token: this.token });\n  }\n\n  _onRollCL(event) {\n    event.preventDefault();\n\n    const spellbookKey = $(event.currentTarget).closest(\".spellbook-group\").data(\"tab\");\n    this.document.rollCL(spellbookKey, { token: this.token });\n  }\n\n  _setItemActive(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    const value = $(event.currentTarget).prop(\"checked\");\n    this.setItemUpdate(item.id, \"system.active\", value);\n    this._updateItems();\n  }\n\n  _onLevelUp(event) {\n    event.preventDefault;\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    const app = Object.values(this.actor.apps).find((o) => {\n      return o instanceof LevelUpForm && o._element && o.object === item;\n    });\n    if (app) app.render(true, { focus: true });\n    else new LevelUpForm(item, { token: this.token }).render(true);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {JQuery.ClickEvent<HTMLElement>} event - The click event on the item\n   * @private\n   */\n  _onItemSummary(event) {\n    event.preventDefault();\n    const li = $(event.currentTarget).parents(\".item\");\n    this.openItemSummary(li);\n  }\n\n  /**\n   * Toggle inline display of an item's summary/description by expanding or hiding info div\n   *\n   * @param {JQuery<HTMLElement>} elem - The element to open. Likely will have the `item` class in CSS.\n   * @param {boolean} [instant=false] - Whether to instantly show the expansion (true), or animate it (false)\n   */\n  openItemSummary(elem, { instant = false } = {}) {\n    // Check whether pseudo-item belongs to another collection\n    const collection = elem.attr(\"data-item-collection\") ?? \"items\";\n    const itemId = elem.attr(\"data-item-id\");\n    const item = this.document[collection].get(itemId);\n    const { description, properties } = item.getChatData({ chatcard: false });\n\n    // Toggle summary\n    this._expandedItems = this._expandedItems.filter((o) => o !== itemId);\n    if (elem.hasClass(\"expanded\")) {\n      const summary = elem.children(\".item-summary\");\n      if (instant) summary.remove();\n      else summary.slideUp(200, () => summary.remove());\n    } else {\n      const div = $(`<div class=\"item-summary\">${description}</div>`);\n      const props = $(`<div class=\"item-properties tag-list\"></div>`);\n      properties.forEach((p) => props.append(`<span class=\"tag\">${p}</span>`));\n      div.append(props);\n      if (instant) elem.append(div);\n      else {\n        elem.append(div.hide());\n        div.slideDown(200);\n      }\n      this._expandedItems.push(itemId);\n    }\n    elem.toggleClass(\"expanded\");\n  }\n\n  /**\n   * Makes a readonly text input editable, and focus it.\n   *\n   * @param event\n   * @private\n   */\n  _onInputText(event) {\n    event.preventDefault();\n    const forStr = event.currentTarget.dataset.for;\n    let elem;\n    if (forStr.match(/CHILD-([0-9]+)/)) {\n      const n = parseInt(RegExp.$1);\n      elem = $(event.currentTarget.children[n]);\n    } else {\n      elem = this.element.find(event.currentTarget.dataset.for);\n    }\n    if (!elem || (elem && elem.attr(\"disabled\"))) return;\n\n    elem.prop(\"readonly\", false);\n    elem.attr(\"name\", event.currentTarget.dataset.attrName);\n    const value = getProperty(this.document, event.currentTarget.dataset.attrName);\n    elem.attr(\"value\", value);\n\n    const wheelEvent = event && event instanceof WheelEvent;\n    if (wheelEvent) {\n      this._mouseWheelAdd(event, elem[0]);\n    } else {\n      elem.select();\n    }\n\n    const handler = (event) => {\n      if (wheelEvent) elem[0].removeEventListener(\"mouseout\", handler);\n      else {\n        elem[0].removeEventListener(\"focusout\", handler);\n        elem[0].removeEventListener(\"keydown\", keyHandler);\n      }\n      elem[0].removeEventListener(\"click\", handler);\n\n      if (\n        (typeof value === \"string\" && value !== elem[0].value) ||\n        (typeof value === \"number\" && value !== parseInt(elem[0].value))\n      ) {\n        changed = true;\n      }\n\n      if (changed) {\n        this._onSubmit(event);\n      } else {\n        this.render();\n      }\n    };\n    const keyHandler = (event) => {\n      if (event.key === \"Enter\") {\n        changed = true;\n        handler.call(this, event);\n      }\n    };\n\n    let changed = false;\n    if (wheelEvent) {\n      elem[0].addEventListener(\"mouseout\", handler);\n      changed = true;\n    } else {\n      elem[0].addEventListener(\"focusout\", handler);\n      elem[0].addEventListener(\"keydown\", keyHandler);\n    }\n    elem[0].addEventListener(\"click\", handler);\n  }\n\n  /* -------------------------------------------- */\n\n  async _onArbitrarySkillCreate(event) {\n    event.preventDefault();\n    const skillId = $(event.currentTarget).parents(\".skill\").attr(\"data-skill\");\n    const mainSkillData = this.document.system.skills[skillId];\n    const skillData = {\n      name: game.i18n.format(\"DOCUMENT.New\", { type: game.i18n.localize(\"FFD20.Skill\") }),\n      ability: mainSkillData.ability,\n      rank: 0,\n      rt: mainSkillData.rt,\n      cs: mainSkillData.cs,\n      acp: mainSkillData.acp,\n    };\n\n    // Get tag\n    let count = 1;\n    let tag = `${skillId}${count}`;\n    while (mainSkillData.subSkills[tag] != null) {\n      count++;\n      tag = `${skillId}${count}`;\n    }\n\n    const updateData = {};\n    updateData[`system.skills.${skillId}.subSkills.${tag}`] = skillData;\n    if (this.document.testUserPermission(game.user, \"OWNER\")) await this.document.update(updateData);\n\n    return this._editSkill(skillId, tag);\n  }\n\n  async _onSkillCreate(event) {\n    event.preventDefault();\n    const isBackground = $(event.currentTarget).parents(\".skills-list\").attr(\"data-background\") === \"true\";\n    const skillData = {\n      name: game.i18n.format(\"DOCUMENT.New\", { type: game.i18n.localize(\"FFD20.Skill\") }),\n      ability: \"int\",\n      rank: 0,\n      mod: 0,\n      rt: false,\n      cs: false,\n      acp: false,\n      background: isBackground,\n      custom: true,\n    };\n\n    let tag = createTag(skillData.name || \"skill\");\n    let count = 1;\n    while (this.document.system.skills[tag] != null) {\n      count++;\n      tag = createTag(skillData.name || \"skill\") + count.toString();\n    }\n\n    const updateData = {};\n    updateData[`system.skills.${tag}`] = skillData;\n    if (this.document.testUserPermission(game.user, \"OWNER\")) await this.document.update(updateData);\n\n    return this._editSkill(tag);\n  }\n\n  /**\n   * Opens a dialog to edit a skill.\n   *\n   * @param {string} skillId - The id of the skill in question.\n   * @param {string} [subSkillId] - The id of the subskill, if appropriate.\n   * @returns {Promise.<void>}\n   */\n  _editSkill(skillId, subSkillId) {\n    return new Promise((resolve) => {\n      const app = new ffd20.applications.SkillEditor(this.document, skillId, subSkillId);\n      app.addCallback(resolve);\n      app.render(true);\n    });\n  }\n\n  _onSkillEdit(event) {\n    event.preventDefault();\n    const mainSkillId =\n      $(event.currentTarget).parents(\".sub-skill\").attr(\"data-main-skill\") ??\n      $(event.currentTarget).parents(\".skill\").attr(\"data-skill\");\n    const subSkillId = $(event.currentTarget).parents(\".sub-skill\").attr(\"data-skill\");\n\n    return this._editSkill(mainSkillId, subSkillId);\n  }\n\n  _onArbitrarySkillDelete(event) {\n    event.preventDefault();\n    const mainSkillId = $(event.currentTarget).parents(\".sub-skill\").attr(\"data-main-skill\");\n    const skill = this.document.system.skills[mainSkillId];\n    const subSkillId = $(event.currentTarget).parents(\".sub-skill\").attr(\"data-skill\");\n    const subSkill = skill?.subSkills?.[subSkillId];\n    const skillName = `${ffd20.config.skills[mainSkillId] ?? skill.name} (${subSkill.name})`;\n\n    const deleteSkill = () => {\n      const updateData = {};\n      updateData[`system.skills.${mainSkillId}.subSkills.-=${subSkillId}`] = null;\n      this.document.update(updateData);\n    };\n\n    if (getSkipActionPrompt()) {\n      deleteSkill();\n    } else {\n      const msg = `<p>${game.i18n.localize(\"FFD20.DeleteSkillConfirmation\")}</p>`;\n      Dialog.confirm({\n        title: game.i18n.format(\"FFD20.DeleteSkillTitle\", { name: skillName }),\n        content: msg,\n        yes: () => {\n          deleteSkill();\n        },\n        rejectClose: true,\n      });\n    }\n  }\n\n  _onSkillDelete(event) {\n    event.preventDefault();\n    if (!this.document.testUserPermission(game.user, \"OWNER\")) return;\n    const skillId = $(event.currentTarget).parents(\".skill\").attr(\"data-skill\");\n    const skill = this.document.system.skills[skillId];\n    const skillName = ffd20.config.skills[skillId] ?? skill.name;\n\n    const deleteSkill = () => {\n      const updateData = {};\n      updateData[`system.skills.-=${skillId}`] = null;\n      this.document.update(updateData);\n    };\n\n    if (getSkipActionPrompt()) {\n      deleteSkill();\n    } else {\n      const msg = `<p>${game.i18n.localize(\"FFD20.DeleteSkillConfirmation\")}</p>`;\n      Dialog.confirm({\n        title: game.i18n.format(\"FFD20.DeleteSkillTitle\", { name: skillName }),\n        content: msg,\n        yes: () => {\n          deleteSkill();\n        },\n        rejectClose: true,\n      });\n    }\n  }\n\n  async _onRaceControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Edit race (allow opening without edit rights)\n    if (a.classList.contains(\"edit\")) {\n      this._onItemEdit(event);\n    }\n    // Add race\n    else if (this.isEditable) {\n      if (a.classList.contains(\"add\")) {\n        const itemData = {\n          name: \"New Race\",\n          type: \"race\",\n        };\n        this.document.createEmbeddedDocuments(\"Item\", [itemData]);\n      }\n      // Delete race\n      else if (a.classList.contains(\"delete\")) {\n        this._onItemDelete(event);\n      }\n    }\n  }\n\n  async _onPointBuyCalculator(event) {\n    event.preventDefault();\n\n    const app = Object.values(this.document.apps).find((o) => {\n      return o instanceof PointBuyCalculator && o._element;\n    });\n    if (app) app.render(true, { focus: true });\n    else new PointBuyCalculator(this.document).render(true);\n  }\n\n  async _onSensesSelector(event) {\n    event.preventDefault();\n\n    const app = Object.values(this.document.apps).find((o) => {\n      return o instanceof ffd20.applications.SensesSelector && o._element;\n    });\n    if (app) app.render(true, { focus: true });\n    else new ffd20.applications.SensesSelector(this.document).render(true);\n  }\n\n  async _onControlAlignment(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const items = Object.entries(ffd20.config.alignmentsShort).reduce((cur, o) => {\n      cur.push({ value: o[0], label: game.i18n.localize(o[1]) });\n      return cur;\n    }, []);\n    const w = new Widget_ItemPicker(\n      (alignment) => {\n        this.document.update({ \"system.details.alignment\": alignment });\n      },\n      { items: items, columns: 3 }\n    );\n    w.render($(a));\n  }\n\n  /**\n   * Activate an item from item control button.\n   *\n   * @param {MouseEvent} event Click event\n   */\n  _itemActivationControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.closest(\".item[data-item-id]\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    item.use({ ev: event, token: this.token });\n  }\n\n  async _quickChangeItemQuantity(event, add = 1) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.document.items.get(itemId);\n\n    const curQuantity = item.system.quantity || 0;\n    let newQuantity = Math.max(0, curQuantity + add);\n\n    if (item.type === \"container\") newQuantity = Math.min(newQuantity, 1);\n\n    this.setItemUpdate(item.id, \"system.quantity\", newQuantity);\n    this._updateItems();\n  }\n\n  async _quickEquipItem(event) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.document.items.get(itemId);\n\n    if (hasProperty(item, \"system.equipped\")) {\n      this.setItemUpdate(item.id, \"system.equipped\", !item.system.equipped);\n      this._updateItems();\n    }\n  }\n\n  async _quickCarryItem(event) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.document.items.get(itemId);\n\n    if (hasProperty(item, \"system.carried\")) {\n      item.update({ \"system.carried\": !item.system.carried });\n    }\n  }\n\n  async _quickIdentifyItem(event) {\n    event.preventDefault();\n    if (!game.user.isGM) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.ErrorCantIdentify\"));\n    }\n    // const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    if (hasProperty(item, \"system.identified\")) {\n      item.update({ \"system.identified\": !item.system.identified });\n    }\n  }\n\n  async _itemToggleData(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const itemId = $(a).parents(\".item\").attr(\"data-item-id\");\n    const item = this.document.items.get(itemId);\n    const property = $(a).attr(\"name\") || a.dataset.name;\n\n    const updateData = {};\n    updateData[property] = !getProperty(item, property);\n    item.update(updateData);\n  }\n\n  async _duplicateItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.closest(\".item[data-item-id]\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n    const itemData = item.toObject();\n\n    delete itemData._id;\n\n    if (itemData.system.links?.children) delete itemData.system.links.children;\n\n    // BUG: If unidentified item has same name, it won't be matched\n    const searchUnusedName = (name) => {\n      let iter = 1;\n      let newName;\n      do {\n        iter += 1;\n        newName = `${name} (${iter})`;\n      } while (this.actor.items.getName(newName));\n      return newName;\n    };\n\n    // Eliminate previous iterator\n    itemData.name = itemData.name.replace(/\\s+\\(\\d+\\)$/, \"\");\n\n    itemData.name = searchUnusedName(itemData.name);\n\n    // TODO: itemData.system.unidentified?.name;\n\n    this.document.createEmbeddedDocuments(\"Item\", [itemData]);\n  }\n\n  _quickAction(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.dataset.itemId;\n    const item = this.document.items.get(itemId);\n    if (!item) return;\n\n    return item.use({ token: this.token });\n  }\n\n  _convertCurrency(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const currencyType = a.dataset.type;\n    const category = a.dataset.category;\n\n    this.document.convertCurrency(category, currencyType);\n  }\n\n  /**\n   * Handle creating a new Owned Item for the actor using initial data defined in the HTML dataset\n   *\n   * @param event\n   * @private\n   */\n  _onItemCreate(event) {\n    event.preventDefault();\n    const header = event.currentTarget;\n\n    const type = header.dataset.type;\n    let subType = header.dataset.subType;\n    const typeName = header.dataset.typeName || game.i18n.localize(ffd20.config.itemTypes[type] || type);\n\n    const itemData = {\n      name: game.i18n.format(\"FFD20.NewItem\", { type: typeName }),\n      type,\n      system: duplicate(header.dataset),\n    };\n\n    delete itemData.system.type;\n    delete itemData.system.tooltip;\n    delete itemData.system.typeName;\n\n    // Ensure variable type is correct\n    if (type === \"spell\") {\n      if (typeof itemData.system?.level === \"string\") itemData.system.level = parseInt(itemData.system.level);\n    }\n\n    const newItem = new Item.implementation(itemData);\n\n    this._sortNewItem(newItem);\n\n    subType = newItem.subType;\n\n    // Get old items of same general category\n    const oldItems = this.actor.itemTypes[type]\n      .filter((oldItem) => this._isItemSameSubGroup(newItem, oldItem))\n      .sort((a, b) => b.sort - a.sort);\n\n    if (oldItems.length) {\n      // Ensure no duplicate names occur\n      const baseName = newItem.name;\n      let newName = baseName;\n      let i = 2;\n      const names = new Set(oldItems.map((i) => i.name));\n      while (names.has(newName)) {\n        newName = `${baseName} (${i++})`;\n      }\n\n      if (newName !== newItem.name) newItem.updateSource({ name: newName });\n    }\n\n    return this.document.createEmbeddedDocuments(\"Item\", [newItem.toObject()]);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle editing an existing Owned Item for the Actor\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onItemEdit(event) {\n    event.preventDefault();\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.document.items.get(li.dataset.itemId);\n\n    const app = Object.values(item.apps).find((o) => {\n      return o instanceof ItemSheet && o.document === item && o._element != null;\n    });\n    item.sheet.render(true, { focus: true });\n  }\n\n  /**\n   * Handle deleting an existing Owned Item for the Actor\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onItemDelete(event) {\n    event.preventDefault();\n\n    const button = event.currentTarget;\n    if (button.disabled) return;\n\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.document.items.get(li.dataset.itemId);\n\n    if (getSkipActionPrompt()) {\n      item.delete();\n    } else {\n      button.disabled = true;\n\n      const msg = `<p>${game.i18n.localize(\"FFD20.DeleteItemConfirmation\")}</p>`;\n      Dialog.confirm({\n        title: game.i18n.format(\"FFD20.DeleteItemTitle\", { name: item.name }),\n        content: msg,\n        yes: () => {\n          item.delete();\n          button.disabled = false;\n        },\n        no: () => (button.disabled = false),\n        rejectClose: true,\n      }).then(null, () => (button.disabled = false));\n    }\n  }\n\n  async _onItemGive(event) {\n    event.preventDefault();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    const targets = game.actors.contents.filter((o) => o.testUserPermission(game.user, \"OWNER\") && o !== this.document);\n    targets.push(...this.document.items.filter((o) => o.type === \"container\"));\n    targets.push(\n      ...game.items.contents.filter((o) => o.testUserPermission(game.user, \"OWNER\") && o.type === \"container\")\n    );\n    targets.push(\n      ...game.actors.contents.filter(\n        (o) => o.hasPlayerOwner && o !== this.document && !o.testUserPermission(game.user, \"OWNER\")\n      )\n    );\n    const targetData = await dialogGetActor(`Give item to actor`, targets);\n\n    if (!targetData) return;\n    let target;\n    if (targetData.type === \"actor\") {\n      target = game.actors.get(targetData.id);\n    } else if (targetData.type === \"item\") {\n      target = this.document.items.get(targetData.id);\n      if (!target) {\n        target = game.items.get(targetData.id);\n      }\n    }\n\n    if (target && target !== item) {\n      const itemData = item.toObject();\n      if (target instanceof Actor) {\n        if (target.testUserPermission(game.user, \"OWNER\")) {\n          await target.createEmbeddedDocuments(\"Item\", [itemData]);\n        } else {\n          game.socket.emit(\"system.ffd20\", {\n            eventType: \"giveItem\",\n            targetActor: target.uuid,\n            item: item.uuid,\n          });\n          // Deleting will be performed on the gm side as well to prevent race conditions\n          return;\n        }\n      } else if (target instanceof Item) {\n        await target.createContainerContent(itemData);\n      }\n\n      await this.document.deleteEmbeddedDocuments(\"Item\", [item.id]);\n    }\n  }\n\n  async _onItemSplit(event) {\n    event.preventDefault();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    new Dialog(\n      {\n        title: game.i18n.format(\"FFD20.Dialog.SplitItem.Title\", { name: item.name }),\n        content: `<p>${game.i18n.format(\"FFD20.Dialog.SplitItem.Desc\")}</p><input type=\"text\" name=\"value\" value=\"1\" />`,\n        buttons: {\n          split: {\n            // icon: `<i class=\"fas fa-people-arrows></i>`,\n            label: game.i18n.localize(\"FFD20.Split\"),\n            callback: async (html) => {\n              let splitValue = parseInt(html.find(`[name=\"value\"]`).val());\n              splitValue = Math.min(item.system.quantity - 1, Math.max(0, splitValue));\n              if (splitValue > 0) {\n                await item.update({ \"system.quantity\": Math.max(0, item.system.quantity - splitValue) });\n                const data = item.toObject();\n                data.system.quantity = splitValue;\n                await CONFIG.Item.documentClass.createDocuments([data], { parent: this.document });\n              }\n            },\n          },\n        },\n        default: \"split\",\n      },\n      {\n        classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"item-split\"],\n      }\n    ).render(true);\n  }\n\n  _onSubmitElement(event) {\n    if (event.key === \"Enter\") {\n      const elem = event.currentTarget;\n      if (elem.name) {\n        const attr = getProperty(this.document.system, elem.name);\n        if (typeof attr === \"number\" && attr === parseFloat(elem.value)) {\n          this._onSubmit(event);\n        } else if (typeof attr === \"string\" && attr === elem.value) {\n          this._onSubmit(event);\n        }\n      }\n    }\n  }\n\n  /**\n   * Handle rolling an Ability check, either a test or a saving throw\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onRollAbilityTest(event) {\n    event.preventDefault();\n    const ability = event.currentTarget.closest(\".ability\").dataset.ability;\n    this.document.rollAbilityTest(ability, { token: this.token });\n  }\n\n  _onRollBAB(event) {\n    event.preventDefault();\n    this.document.rollBAB({ token: this.token });\n  }\n\n  _onRollMelee(event) {\n    event.preventDefault();\n    this.document.rollAttack({ melee: true, token: this.token });\n  }\n\n  _onRollRanged(event) {\n    event.preventDefault();\n    this.document.rollAttack({ melee: false, token: this.token });\n  }\n\n  _onRollCMB(event) {\n    event.preventDefault();\n    this.document.rollCMB({ token: this.token });\n  }\n\n  _onRollInitiative(event) {\n    event.preventDefault();\n    this.document.rollInitiative({\n      createCombatants: true,\n      rerollInitiative: game.user.isGM,\n      token: this.token,\n    });\n  }\n\n  _onRollSavingThrow(event) {\n    event.preventDefault();\n    const savingThrow = event.currentTarget.parentElement.dataset.savingthrow;\n    this.document.rollSavingThrow(savingThrow, { token: this.token });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Organize and classify Owned Items\n   *\n   * @param data\n   * @private\n   */\n  _prepareItems(data) {\n    // Categorize items as inventory, spellbook, features, and classes\n    const inventory = {\n      weapon: {\n        label: game.i18n.localize(\"FFD20.InventoryWeapons\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: true,\n        dataset: { type: \"weapon\" },\n      },\n      equipment: {\n        label: game.i18n.localize(\"FFD20.InventoryArmorEquipment\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: true,\n        dataset: { type: \"equipment\" },\n        hasSlots: true,\n      },\n      consumable: {\n        label: game.i18n.localize(\"FFD20.InventoryConsumables\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"consumable\" },\n      },\n      gear: {\n        label: ffd20.config.lootTypes[\"gear\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: true,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.LootTypeGearSingle\"), \"sub-type\": \"gear\" },\n      },\n      ammo: {\n        label: ffd20.config.lootTypes[\"ammo\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.LootTypeAmmoSingle\"), \"sub-type\": \"ammo\" },\n      },\n      misc: {\n        label: ffd20.config.lootTypes[\"misc\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.Misc\"), \"sub-type\": \"misc\" },\n      },\n      tradeGoods: {\n        label: ffd20.config.lootTypes[\"tradeGoods\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: {\n          type: \"loot\",\n          \"type-name\": game.i18n.localize(\"FFD20.LootTypeTradeGoodsSingle\"),\n          \"sub-type\": \"tradeGoods\",\n        },\n      },\n      container: {\n        label: game.i18n.localize(\"FFD20.InventoryContainers\"),\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        dataset: { type: \"container\", \"type-name\": game.i18n.localize(\"ITEM.TypeContainer\") },\n      },\n    };\n\n    // Partition items by category\n    let [items, spells, feats, classes, attacks] = data.items.reduce(\n      (arr, item) => {\n        if (item.type === \"spell\") arr[1].push(item);\n        else if (item.type === \"feat\") arr[2].push(item);\n        else if (item.type === \"class\") arr[3].push(item);\n        else if (item.type === \"attack\") arr[4].push(item);\n        else if (item.document.isPhysical) arr[0].push(item);\n        return arr;\n      },\n      [[], [], [], [], []]\n    );\n\n    // Apply active item filters\n    items = this._filterItems(items, this._filters.inventory, this._filters.search.inventory);\n    feats = this._filterItems(feats, this._filters.features);\n\n    // Organize Spellbook\n    let hasASF = false;\n    const spellbookData = {};\n    const spellbooks = data.system.attributes.spells.spellbooks;\n    for (const [key, spellbook] of Object.entries(spellbooks)) {\n      // Required for spellbook selection in settings\n      spellbookData[key] = { orig: spellbook, inUse: spellbook.inUse };\n      // The rest are unnecssary processing if spellbook is not enabled\n      if (!spellbook.inUse) continue;\n      let spellbookSpells = spells.filter((obj) => obj.spellbook === key);\n      spellbookSpells = this._filterItems(spellbookSpells, this._filters[`spellbook-${key}`]);\n      spellbookData[key].data = this._prepareSpellbook(data, spellbookSpells, key);\n      spellbookData[key].prepared = spellbookSpells.filter(\n        (obj) => obj.preparation.mode === \"prepared\" && obj.preparation.prepared\n      ).length;\n      spellbookData[key].rollData = data.rollData.spells[key];\n      spellbookData[key].class = data.rollData.classes[spellbook.class];\n      if (spellbook.arcaneSpellFailure) hasASF = true;\n    }\n\n    if (hasASF) {\n      const asfSources = [];\n      const asf = this.actor.items\n        .filter((item) => item.type === \"equipment\" && item.system.equipped === true)\n        .reduce((cur, item) => {\n          const itemASF = item.system.spellFailure ?? 0;\n          if (itemASF > 0) {\n            asfSources.push({ item, asf: itemASF });\n            return cur + itemASF;\n          }\n          return cur;\n        }, 0);\n\n      data.asf = {\n        total: asf,\n        sources: asfSources,\n      };\n    }\n\n    // Organize Inventory\n    const usystem = getWeightSystem();\n\n    for (const i of items) {\n      const subType = i.type === \"loot\" ? i.subType || \"gear\" : i.subType;\n      i.quantity = i.quantity || 0;\n      i.totalWeight = Math.roundDecimals(i.weight.converted.total, 1);\n      i.units = usystem === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\");\n      if (inventory[i.type] != null) inventory[i.type].items.push(i);\n      // Only loot has subType specific sections\n      if (i.type === \"loot\") inventory[subType]?.items.push(i);\n    }\n\n    // Organize Features\n    const features = {};\n    const featureDefaults = { items: [], canCreate: true, hasActions: true };\n    const featData = this.constructor.featTypeData;\n    for (const [featKey, featValue] of Object.entries(ffd20.config.featTypes)) {\n      // Merge type specific data into common data template\n      features[featKey] = mergeObject(\n        featureDefaults,\n        {\n          // Fist generic data derived from the config object\n          label: ffd20.config.featTypesPlurals[featKey] ?? featValue,\n          dataset: { type: \"feat\", \"type-name\": game.i18n.localize(featValue), \"sub-type\": featKey },\n          // Then any specific data explicitly set to override defaults\n          ...featData[featKey],\n        },\n        { inplace: false }\n      );\n    }\n\n    for (const f of feats) {\n      const k = f.subType;\n      if (f.abilityType && f.abilityType !== \"none\") {\n        f.abilityTypeShort = ffd20.config.abilityTypes[f.abilityType].short;\n        f.abilityType = ffd20.config.abilityTypes[f.abilityType].long;\n      } else {\n        f.abilityTypeShort = \"\";\n        f.abilityType = \"\";\n      }\n      features[k]?.items?.push(f);\n    }\n    classes.sort((a, b) => b.level - a.level);\n    classes.forEach((item) => {\n      if (item.subType !== \"mythic\") item.canLevelUp = true;\n    });\n\n    // Buffs\n    let buffs = data.items.filter((obj) => obj.type === \"buff\");\n    buffs = this._filterItems(buffs, this._filters.buffs);\n    const buffSections = {};\n    Object.entries(ffd20.config.buffTypes).forEach(([buffId, label]) => {\n      buffSections[buffId] = {\n        label,\n        items: [],\n        hasActions: true,\n        dataset: { type: \"buff\", \"sub-type\": buffId },\n      };\n    });\n\n    for (const b of buffs) {\n      buffSections[b.subType]?.items.push(b);\n    }\n\n    // Attacks\n    attacks = this._filterItems(attacks, this._filters.attacks);\n    const attackSections = {\n      weapon: {\n        label: game.i18n.localize(\"FFD20.AttackTypeWeaponPlural\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"weapon\" },\n      },\n      natural: {\n        label: game.i18n.localize(\"FFD20.AttackTypeNaturalPlural\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"natural\" },\n      },\n      ability: {\n        label: game.i18n.localize(\"FFD20.AttackTypeAbilityPlural\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"ability\" },\n      },\n      racialAbility: {\n        label: game.i18n.localize(\"FFD20.AttackTypeRacialPlural\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"racialAbility\" },\n      },\n      item: {\n        label: game.i18n.localize(\"FFD20.Items\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"item\" },\n      },\n      misc: {\n        label: game.i18n.localize(\"FFD20.Misc\"),\n        items: [],\n        canCreate: true,\n        initial: false,\n        showTypes: false,\n        dataset: { type: \"attack\", \"sub-type\": \"misc\" },\n      },\n    };\n\n    for (const attack of attacks) {\n      const subType = attack.subType;\n      if (!attackSections[subType]) {\n        console.warn(`Attack for unrecognized subtype \"${subType}\"`);\n        continue;\n      }\n      attackSections[subType].items.push(attack);\n    }\n\n    // Apply type filters\n    {\n      const sections = [\n        { key: \"inventory\", section: inventory },\n        { key: \"features\", section: features },\n        { key: \"buffs\", section: buffSections },\n        { key: \"attacks\", section: attackSections },\n      ];\n      for (const [k, sb] of Object.entries(spellbookData)) {\n        if (!sb.inUse) continue;\n        sections.push({ key: `spellbook-${k}`, section: sb.data });\n      }\n\n      for (const section of sections) {\n        for (const [k, s] of Object.entries(section.section)) {\n          const typeFilterCount = this._typeFilterCount(this._filters[section.key]);\n          if (typeFilterCount > 0 && s.items.length === 0) {\n            s._hidden = true;\n          }\n          if (typeFilterCount === 1 && this._filters[section.key].has(`type-${k}`)) {\n            s._hidden = false;\n          }\n        }\n      }\n    }\n\n    // Assign and return\n    data.inventory = inventory;\n    data.spellbookData = spellbookData;\n    data.features = features;\n    data.buffs = buffSections;\n    data.attacks = attackSections;\n    data.classes = classes;\n    data.quickActions = this.document.getQuickActions();\n  }\n\n  /**\n   * Handle rolling a Skill check\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onRollSkillCheck(event) {\n    event.preventDefault();\n    const skill = event.currentTarget.parentElement.dataset.skill;\n    this.document.rollSkill(skill, { token: this.token });\n  }\n\n  _onRollSubSkillCheck(event) {\n    event.preventDefault();\n    const mainSkill = event.currentTarget.parentElement.dataset.mainSkill;\n    const skill = event.currentTarget.parentElement.dataset.skill;\n    this.document.rollSkill(`${mainSkill}.subSkills.${skill}`, { token: this.token });\n  }\n\n  /**\n   * Handle opening a skill's compendium entry\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  async _onOpenCompendiumEntry(event) {\n    const uuid = event.currentTarget.dataset.compendiumEntry;\n    const document = await fromUuid(uuid);\n\n    // Open document\n    if (document instanceof JournalEntryPage) {\n      document.parent.sheet.render(true, { pageId: document.id });\n    } else {\n      document.sheet.render(true);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle toggling of filters to display a different set of owned items\n   *\n   * @param {Event} event     The click event which triggered the toggle\n   * @private\n   */\n  _onToggleFilter(event) {\n    event.preventDefault();\n\n    const li = event.currentTarget;\n    const set = this._filters[li.parentElement.dataset.filter];\n    const filter = li.dataset.filter;\n    const typeFilterCount = this._typeFilterCount(set);\n\n    const tabLikeFilters = game.settings.get(\"ffd20\", \"invertSectionFilterShiftBehaviour\")\n      ? !event.shiftKey\n      : event.shiftKey;\n    if (tabLikeFilters) {\n      for (const f of Array.from(set)) {\n        if (f.startsWith(\"type-\") && (f !== filter || typeFilterCount > 1)) {\n          set.delete(f);\n        }\n      }\n    }\n\n    if (set.has(filter)) set.delete(filter);\n    else set.add(filter);\n    this.render();\n  }\n\n  _searchFilterCommit(event) {\n    const actor = this.actor;\n    const search = this._filters.search[event.target.dataset.category].toLowerCase();\n    const category = event.target.dataset.category;\n\n    // TODO: Do not refresh if same search term, unless the sheet has updated.\n    if (this.effectiveSearch[category] === search && !this.searchRefresh) return;\n    this.effectiveSearch[category] = search;\n    this.searchRefresh = false;\n\n    const matchSearch = (name) => name.toLowerCase().includes(search); // MKAhvi: Bad method for i18n support.\n\n    $(event.target)\n      .closest(\".tab\")\n      .find(\".item-list .item\")\n      .each(function () {\n        const jq = $(this);\n        if (search?.length > 0) {\n          const item = actor.items.get(this.dataset.itemId);\n          if (matchSearch(item.name)) jq.show();\n          else jq.hide();\n        } else jq.show();\n      });\n  }\n\n  _clearSearch(event) {\n    const sb = $(event.target).prev(\".search-input\");\n    this._filters.search[sb.get(0).dataset.category] = \"\";\n    sb.val(\"\").change();\n  }\n\n  // IME related\n  _searchFilterCompositioning(event) {\n    this.searchCompositioning = event.type === \"compositionstart\";\n  }\n\n  _searchFilterChange(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Accept input only while not compositioning\n\n    const search = event.target.value;\n    const category = event.target.dataset.category;\n    const changed = this._filters.search[category] !== search;\n\n    if (this.searchCompositioning || changed) clearTimeout(this.searchDelayEvent); // reset\n    if (this.searchCompositioning) return;\n\n    //if (unchanged) return; // nothing changed\n    this._filters.search[category] = search;\n\n    if (event.type === \"keyup\") {\n      // Delay search\n      if (changed) this.searchDelayEvent = setTimeout(() => this._searchFilterCommit(event), this.searchDelay);\n    } else {\n      this._searchFilterCommit(event);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle spawning the ActorTraitSelector application which allows a checkbox of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onTraitSelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const label = a.parentElement.querySelector(\"label\");\n    const choices =\n      a.dataset.options in ffd20.registry ? ffd20.registry[a.dataset.options].getLabels() : ffd20.config[a.dataset.options];\n    const options = {\n      name: label.getAttribute(\"for\"),\n      title: label.innerText,\n      subject: a.dataset.options,\n      choices: choices,\n    };\n\n    let app = Object.values(this.document.apps).find(\n      (app) => app instanceof ActorTraitSelector && app.options.name === options.name\n    );\n    app ??= new ActorTraitSelector(this.document, options);\n    app.render(true, { focus: true });\n  }\n\n  /**\n   * Handle spawning the ActorResistanceSelector application which allows a number entry of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onResistanceSelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const options = {\n      name: a.getAttribute(\"for\"),\n      title: a.innerText,\n      fields: a.dataset.fields,\n      dtypes: a.dataset.dtypes,\n      isDR: a.dataset.options === \"dr\" ? true : false,\n    };\n\n    const app = Object.values(this.document.apps).find((o) => {\n      return o instanceof ActorResistanceSelector && o.options.name === options.name && o._element;\n    });\n    if (app) app.render(true, { focus: true });\n    else new ActorResistanceSelector(this.document, options).render(true);\n  }\n\n  setItemUpdate(id, key, value) {\n    let obj = this._itemUpdates.filter((o) => {\n      return o._id === id;\n    })[0];\n    if (obj == null) {\n      obj = { _id: id };\n      this._itemUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  async _render(...args) {\n    // Trick to avoid error on elements with changing name\n    let focus = this.element.find(\":focus\");\n    focus = focus.length ? focus[0] : null;\n    if (focus?.name?.match(/^system\\.skills\\.(?:[a-zA-Z0-9]*)\\.name$/)) focus.blur();\n\n    const result = await super._render(...args);\n\n    // Create placeholders\n    this._createPlaceholders(this.element);\n\n    // Apply accessibility settings\n    applyAccessibilitySettings(this, this.element, {}, game.settings.get(\"ffd20\", \"accessibilityConfig\"));\n\n    return result;\n  }\n\n  async _renderInner(...args) {\n    const html = await super._renderInner(...args);\n\n    // Re-open item summaries\n    for (const itemId of this._expandedItems) {\n      // Only display summaries of items that are still present\n      if (this.object.items.has(itemId)) {\n        const elem = html.find(`.item-list>.item[data-item-id=\"${itemId}\"]`);\n        if (elem.length) this.openItemSummary(elem, { instant: true });\n      } else {\n        // Delete itemIds belonging to items no longer found in the actor\n        this._expandedItems.findSplice((o) => o === itemId);\n      }\n    }\n\n    return html;\n  }\n\n  async _onSubmit(event, { updateData = null, preventClose = false, preventRender = false } = {}) {\n    event.preventDefault();\n\n    this._submitQueued = false;\n\n    if (this._itemUpdates?.length) preventRender = true;\n\n    await super._onSubmit(event, { updateData, preventClose, preventRender });\n\n    // Update items\n    await this._updateItems();\n  }\n\n  async _updateItems() {\n    const promises = [];\n\n    const updates = this._itemUpdates;\n    this._itemUpdates = [];\n\n    // Memorize variables in document\n    for (const d of updates) {\n      const item = this.document.items.get(d._id);\n      if (!item) {\n        console.error(\"Item update for non-existing item:\", d._id, d);\n        continue;\n      }\n      item.memorizeVariables();\n      delete d._id;\n      await item.update(d);\n    }\n  }\n\n  async _onDropCurrency(event, data) {\n    let sourceActor = await fromUuid(data.actorUuid || \"\");\n    if (!(sourceActor instanceof Actor)) sourceActor = sourceActor?.actor;\n\n    const { currency, amount, containerId, alt } = data;\n\n    return new CurrencyTransfer(\n      { actor: sourceActor, container: containerId, alt },\n      { actor: this.actor, amount: Object.fromEntries([[currency, parseInt(amount)]]) }\n    ).render(true);\n  }\n\n  /**\n   * @override\n   */\n  async _onDropItem(event, data) {\n    if (!this.actor.isOwner) return false;\n\n    const item = await ItemPF.implementation.fromDropData(data);\n    const itemData = item.toObject();\n\n    let sourceActor = await fromUuid(data.actorUuid || \"\");\n    if (!(sourceActor instanceof Actor)) sourceActor = sourceActor?.actor;\n\n    // Handle item sorting within the same actor\n    const sameActor = item.actor === this.actor && !data.containerId;\n    if (sameActor) return this._onSortItem(event, itemData);\n\n    // Create the owned item\n    this._alterDropItemData(itemData);\n    const rv = await this._onDropItemCreate(itemData);\n\n    // Remove from container if item was successfully created\n    if (data.containerId && rv?.length && sourceActor === this.actor) {\n      const container = this.actor.allItems.find((o) => o.id === data.containerId);\n      if (container) container.deleteContainerContent(data.itemId);\n    }\n\n    return rv;\n  }\n\n  _alterDropItemData(data) {\n    if (data.type === \"spell\") {\n      data.system.spellbook = this.currentSpellbookKey;\n    }\n  }\n\n  /**\n   * Tests if two items in same sub-group.\n   *\n   * @private\n   * @param {ItemPF} item0\n   * @param {ItemPF} item1\n   * @returns {boolean}\n   */\n  _isItemSameSubGroup(item0, item1) {\n    if (item0.type === \"spell\") {\n      return item0.system.spellbook === item1.system.spellbook && item0.system.level === item1.system.level;\n    }\n\n    if (item0.subType) return item0.subType === item1.subType;\n\n    // Assume everything else is only categorized by main type\n    return true;\n  }\n\n  /**\n   * Sort item at the bottom of the list instead of seemingly random position\n   *\n   * @private\n   * @param {ItemPF} item - Temporary item to do sorting on.\n   */\n  _sortNewItem(item) {\n    const type = item.type;\n\n    // Get old items of same general category\n    const oldItems = this.actor.itemTypes[type]\n      .filter((oldItem) => this._isItemSameSubGroup(item, oldItem))\n      .sort((a, b) => b.sort - a.sort);\n\n    if (oldItems.length) {\n      item.updateSource({\n        sort: oldItems[0].sort + CONST.SORT_INTEGER_DENSITY,\n      });\n    }\n  }\n\n  async _onDropItemCreate(itemData) {\n    const itemDatas = itemData instanceof Array ? itemData : [itemData];\n\n    const creationData = [];\n    for (const itemData of itemDatas) {\n      delete itemData._id;\n\n      // Import spell as consumable\n      if (itemData.type === \"spell\" && this.currentPrimaryTab !== \"spellbook\") {\n        const resultData = await createConsumableSpellDialog(itemData);\n        if (resultData === \"spell\") {\n          // No action here.\n        } else if (resultData) return this.document.createEmbeddedDocuments(\"Item\", [resultData]);\n        else return false;\n      }\n      // Choose how to import class\n      if (itemData.type === \"class\" && itemData.system.subType !== \"mythic\" && !(event && event.shiftKey)) {\n        const doReturn = await new Promise((resolve) => {\n          new Dialog(\n            {\n              title: game.i18n.localize(\"FFD20.AddClass\"),\n              content: `<div class=\"ffd20\"><p>${game.i18n.localize(\n                \"FFD20.Info.AddClassDialog_Desc\"\n              )}</p><div class=\"help-text\"><i class=\"fas fa-info-circle\"></i> ${game.i18n.localize(\n                \"FFD20.Info.AddClassDialog\"\n              )}</div></div>`,\n              buttons: {\n                normal: {\n                  icon: '<i class=\"fas fa-hat-wizard\"></i>',\n                  label: game.i18n.localize(\"FFD20.Normal\"),\n                  callback: () => {\n                    LevelUpForm.addClassWizard(this.actor, itemData).then(() => {\n                      resolve(true);\n                    });\n                  },\n                },\n                raw: {\n                  icon: '<i class=\"fas fa-file\"></i>',\n                  label: game.i18n.localize(\"FFD20.Raw\"),\n                  callback: () => {\n                    resolve(false);\n                  },\n                },\n              },\n              close: () => {\n                resolve(true);\n              },\n            },\n            {\n              classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"add-character-class\"],\n            }\n          ).render(true);\n        });\n        if (doReturn) return false;\n      }\n\n      const newItem = new Item.implementation(itemData);\n\n      this._sortNewItem(newItem);\n\n      creationData.push(newItem.toObject());\n    }\n\n    return this.document.createEmbeddedDocuments(\"Item\", creationData);\n  }\n\n  /**\n   * Allow drag start always.\n   * Foundry blocks this if sheet is not editable, which blocks copying items.\n   *\n   * @override\n   * @param {string} selector Selector string\n   */\n  _canDragStart(selector) {\n    // Conditionally block currency transfer\n    if (selector.includes(\".denomination\")) return this.isEditable;\n    return true;\n  }\n\n  _onDragStart(event) {\n    const elem = event.target;\n    if (elem.classList.contains(\"denomination\")) {\n      const dragData = {\n        actorUuid: this.actor.uuid,\n        type: \"Currency\",\n        alt: elem.classList.contains(\"alt-currency\"),\n        currency: [...elem.classList].find((o) => /[pgsc]p/.test(o)),\n        amount: parseInt(elem.nextElementSibling.textContent || elem.nextElementSibling.value),\n      };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n    } else if (elem.dataset?.skill) {\n      this._onDragSkillStart(event);\n    } else if (elem.dataset?.attribute) {\n      this._onDragMiscStart(event, elem.dataset.attribute);\n    } else if (elem.dataset?.drag) {\n      this._onDragMiscStart(event, elem.dataset.drag);\n    } else if (elem.dataset?.savingthrow) {\n      this._onDragSaveStart(event, elem.dataset.savingthrow);\n    } else if (elem.dataset?.ability) {\n      this._onDragMiscStart(event, \"abilityScore\", elem.dataset.ability);\n    } else if (elem.dataset?.attack) {\n      this._onDragMiscStart(event, \"attack\", elem.dataset.attack);\n    } else {\n      super._onDragStart(event);\n    }\n  }\n\n  async _onConfigControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const f = $(a).attr(\"for\");\n    const html = this.element;\n\n    $(a).css(\"display\", \"none\");\n\n    // Show CR field\n    if (f === \"cr\") {\n      const elem = html.find('input[for=\"system.details.cr\"]');\n      elem.attr(\"value\", CR.fromNumber(this.document.system.details.cr.base));\n      elem.attr(\"name\", \"system.details.cr.base\");\n      elem.prop(\"disabled\", false);\n      elem.focus();\n      elem.select();\n    }\n\n    // Show base Spell Slots field\n    else if (f === \"spellSlots\") {\n      const elem = $(a).closest(\".spell-uses\").find(\".base\");\n      elem.css(\"display\", \"block\");\n      elem.focus();\n      elem.select();\n    }\n  }\n\n  _selectOnClick(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    el.select();\n  }\n\n  _updateObject(event, formData) {\n    // Translate CR\n    const cr = formData[\"system.details.cr.base\"];\n    if (typeof cr === \"string\") formData[\"system.details.cr.base\"] = CR.fromString(cr);\n\n    // Update from elements with 'data-name'\n    {\n      const elems = this.element.find(\"*[data-name]\");\n      const changedData = {};\n      for (const el of elems) {\n        const name = el.dataset.name;\n        let value;\n        if (el.nodeName === \"INPUT\") value = el.value;\n        else if (el.nodeName === \"SELECT\") value = el.options[el.selectedIndex].value;\n\n        if (el.dataset.dtype === \"Number\") value = Number(value);\n        else if (el.dataset.dtype === \"Boolean\") value = Boolean(value);\n\n        if (getProperty(this.document.system, name) !== value) {\n          changedData[name] = value;\n        }\n      }\n\n      for (const [k, v] of Object.entries(changedData)) {\n        formData[k] = v;\n      }\n    }\n\n    // Add pending updates\n    for (const [k, v] of Object.entries(this._pendingUpdates)) {\n      formData[k] = v;\n    }\n    this._pendingUpdates = {};\n\n    this.searchRefresh = true;\n\n    return super._updateObject(event, formData);\n  }\n\n  calculateTotalItemValue({ inLowestDenomination = false } = {}) {\n    const items = this.document.items.filter((o) => o.system.price != null);\n    const total = items.reduce((cur, i) => {\n      return cur + i.getValue({ sellValue: 1, inLowestDenomination: true });\n    }, 0);\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  calculateSellItemValue({ inLowestDenomination = false } = {}) {\n    const items = this.document.items.filter((o) => o.system.price != null);\n    const sellMultiplier = this.document.getFlag(\"ffd20\", \"sellMultiplier\") || 0.5;\n    const total = items.reduce((cur, i) => {\n      return cur + i.getValue({ sellValue: sellMultiplier, inLowestDenomination: true });\n    }, 0);\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  _createPlaceholders(html) {\n    const elems = html.find(\"span[data-placeholder]\");\n    for (const el of elems) {\n      if (!el.innerText) {\n        el.classList.add(\"placeholder\");\n        el.innerText = el.dataset.placeholder;\n      }\n    }\n  }\n}\n","/**\n * Default dead sheet when no other exist.\n */\nexport class ActorSheetPFBasic extends ActorSheet {}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\nimport { LevelUpForm } from \"../level-up.mjs\";\n\n/**\n * An Actor sheet for player character type actors in the PF system.\n * Extends the base ActorSheetPF class.\n *\n * @type {ActorSheetPF}\n */\nexport class ActorSheetPFCharacter extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"sheet\", \"actor\", \"character\"],\n      width: 800,\n      height: 840,\n    });\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/character-sheet.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   */\n  async getData() {\n    const data = await super.getData();\n    const xpSettings = game.settings.get(\"ffd20\", \"experienceConfig\");\n\n    // Experience Tracking\n    data.disableExperience = xpSettings.disableExperienceTracking;\n    data.minimumExperience = this.actor.getLevelExp(Math.max(0, (this.actor.system.details.level.value ?? 0) - 1));\n\n    data.hasClasses = this.actor.items.filter((o) => o.type === \"class\").length > 0;\n\n    const hpSettings = game.settings.get(\"ffd20\", \"healthConfig\");\n    data.woundThresholds = hpSettings.variants.pc;\n\n    // BAB iteratives\n    const iteratives = game.settings.get(\"ffd20\", \"displayIteratives\");\n    const bab = data.rollData.attributes.bab.total;\n    if (iteratives) {\n      const iters = [bab];\n      for (let i = bab - 5; i > 0; i -= 5) iters.push(i);\n      data.iteratives = `+${iters.join(\" / +\")}`;\n    }\n\n    // Add level up buttons to classes\n    if (\n      this.actor.type === \"character\" &&\n      game.settings.get(\"ffd20\", \"experienceConfig\").disableExperienceTracking !== true &&\n      data.hasClasses\n    ) {\n      const xp = this.actor.system.details?.xp;\n      if (xp && xp.value >= xp.max) {\n        data.levelUp = true;\n      }\n    } else {\n      data.levelUp = true;\n    }\n\n    // Return data for rendering\n    return data;\n  }\n}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\nimport { CR } from \"../../utils/lib.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\n/**\n * An Actor sheet for NPC type characters in the game system.\n * Extends the base ActorSheetPF class.\n *\n * @type {ActorSheetPF}\n */\nexport class ActorSheetPFNPC extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"sheet\", \"actor\", \"npc\"],\n      width: 800,\n      height: 840,\n    });\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/npc-sheet.hbs\";\n  }\n\n  // static get name() {\n  //   return game.i18n.localize(\"FFD20.ActorSheetPFNPC\");\n  // }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   */\n  async getData() {\n    const data = await super.getData();\n\n    // Challenge Rating\n    try {\n      data.labels.cr = CR.fromNumber(this.actor.system.details?.cr?.total);\n    } catch (e) {\n      try {\n        data.labels.cr = CR.fromNumber(this.actor.system.details?.cr);\n      } catch (e) {\n        data.labels.cr = CR.fromNumber(1);\n      }\n    }\n\n    const hpSettings = game.settings.get(\"ffd20\", \"healthConfig\");\n    data[\"woundThresholds\"] = hpSettings.variants.npc;\n\n    data.levelUp = true;\n\n    return data;\n  }\n\n  /* -------------------------------------------- */\n  /*  Object Updates                              */\n  /* -------------------------------------------- */\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param html {HTML}   The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Adjust CR\n    html.find(\"span.text-box.cr-input\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustCR.bind(this));\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  _adjustCR(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const value = CR.fromString(el.tagName === \"INPUT\" ? el.value : el.innerText);\n    const name = el.getAttribute(\"name\");\n    if (name) {\n      this._pendingUpdates[name] = value;\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._onSubmit(event);\n        });\n      }\n    } else this._onSubmit(event);\n  }\n}\n","import { ActorSheetPFNPC } from \"./npc-sheet.mjs\";\n\nexport class ActorSheetPFNPCLite extends ActorSheetPFNPC {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"sheet\", \"actor\", \"npc\", \"lite\"],\n      width: 440,\n      height: 640,\n      tabs: [\n        { navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"summary\", group: \"primary\" },\n      ],\n    });\n  }\n\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/npc-sheet-lite.hbs\";\n  }\n\n  _prepareItems(data) {\n    const attackSections = {\n      all: {\n        label: game.i18n.localize(\"FFD20.ActionPlural\"),\n        items: data.items.filter((i) => i.type === \"attack\"),\n        canCreate: true,\n        initial: true,\n        showTypes: true,\n        dataset: { type: \"attack\", \"sub-type\": \"weapon\" },\n      },\n    };\n\n    data.attacks = attackSections;\n  }\n}\n","import { ActorSheetPFNPC } from \"./npc-sheet.mjs\";\nimport { splitCurrency } from \"../../utils/lib.mjs\";\n\nexport class ActorSheetPFNPCLoot extends ActorSheetPFNPC {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"sheet\", \"actor\", \"npc\", \"loot\"],\n      tabs: [\n        { navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"inventory\", group: \"primary\" },\n      ],\n      width: 620,\n      height: 420,\n    });\n  }\n\n  get template() {\n    return \"systems/ffd20/templates/actors/npc-sheet-loot.hbs\";\n  }\n\n  get currentPrimaryTab() {\n    return \"inventory\";\n  }\n\n  async getData() {\n    const data = await super.getData();\n\n    data.isLootSheet = true;\n    data.sellMultiplier = this.actor.getFlag(\"ffd20\", \"sellMultiplier\");\n\n    // Get total value\n    const cgilValue =\n      this.calculateTotalItemValue({ inLowestDenomination: true }) +\n      this.actor.mergeCurrency({ inLowestDenomination: true });\n    const cgilSellValue =\n      this.calculateSellItemValue({ inLowestDenomination: true }) +\n      this.actor.mergeCurrency({ inLowestDenomination: true });\n\n    data.totalValue = splitCurrency(cgilValue);\n    data.sellValue = splitCurrency(cgilSellValue);\n\n    // Set labels\n    if (!data.labels) data.labels = {};\n    data.labels.totalValue = game.i18n.format(\"FFD20.ItemContainerTotalValue\", data.totalValue);\n    data.labels.sellValue = game.i18n.format(\"FFD20.ItemContainerSellValue\", data.sellValue);\n\n    // Alter inventory columns\n    for (const inv of Object.values(data.inventory)) {\n      inv.hasActions = false;\n      inv.canEquip = false;\n      inv.showValue = true;\n    }\n\n    return data;\n  }\n}\n","export class ActorSheetFlags extends DocumentSheet {\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return mergeObject(options, {\n      id: \"actor-flags\",\n      classes: [\"ffd20\"],\n      template: \"systems/ffd20/templates/apps/actor-flags.hbs\",\n      width: 500,\n      closeOnSubmit: true,\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the special traits selection window to include the Actor name\n   *\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.FlagsTitle\")}: ${this.object.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare data used to render the special Actor traits selection UI\n   *\n   * @returns {object}\n   */\n  getData() {\n    const data = super.getData();\n    data.flags = this._getFlags();\n    return data;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare an object of flags data which groups flags by section\n   * Add some additional data for rendering\n   *\n   * @returns {object}\n   */\n  _getFlags() {\n    const flags = {};\n    for (const [k, v] of Object.entries(ffd20.config.characterFlags)) {\n      if (!Object.prototype.hasOwnProperty.call(flags, v.section)) flags[v.section] = {};\n      const flag = duplicate(v);\n      flag.type = v.type.name;\n      flag.isCheckbox = v.type === Boolean;\n      flag.isSelect = Object.prototype.hasOwnProperty.call(v, \"choices\");\n      flag.value = this.document.getFlag(\"FFD20\", k);\n      flags[v.section][k] = flag;\n    }\n    return flags;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the Actor using the configured flags\n   * Remove/unset any flags which are no longer configured\n   *\n   * @param event\n   * @param formData\n   */\n  _updateObject(event, formData) {\n    const actor = this.object;\n\n    // Iterate over the flags which may be configured\n    const updateData = {};\n    for (const [k, v] of Object.entries(CONFIG.ffd20.characterFlags)) {\n      if ([undefined, null, \"\", false].includes(formData[k])) updateData[`-=${k}`] = null;\n      else if (v.type === Number && formData[k] === 0) updateData[`-=${k}`] = null;\n      else updateData[k] = formData[k];\n    }\n\n    // Set the new flags in bulk\n    actor.update({ \"flags.ffd20\": updateData });\n  }\n}\n","export class ScriptEditor extends FormApplication {\n  constructor(options = {}) {\n    super(options);\n\n    this.command = options.command || \"\";\n    this.name = options.name || null;\n\n    this.parent = options.parent;\n\n    this.isScriptCall = options.scriptCall === true;\n\n    // Add editor title\n    if (this.name) this.options.title = this.parent ? `${this.parent.name}: ${this.name}` : this.name;\n    else this.options.title = this.parent?.name ?? game.i18n.localize(\"FFD20.Unknown\");\n\n    this._promises = {\n      submit: [],\n    };\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"script-editor\"],\n      template: \"systems/ffd20/templates/apps/script-editor.hbs\",\n      width: 640,\n      height: 560,\n    });\n  }\n\n  getData() {\n    const data = {};\n\n    data.command = this.command || \"\";\n    data.name = this.name;\n\n    data.isScriptCall = this.isScriptCall;\n\n    data.canEdit = {\n      name: this.isScriptCall,\n    };\n\n    return data;\n  }\n\n  awaitResult() {\n    let callback;\n    const promise = new Promise((resolve) => {\n      callback = resolve;\n    });\n    this._promises.submit.push({ callback, promise, resolved: false });\n    return promise;\n  }\n\n  activateListeners(html) {\n    html.find('button[type=\"submit\"]').click(this._onSubmit.bind(this));\n\n    // Open help browser\n    html.find(\"a.help-browser[data-url]\").click(this._openHelpBrowser.bind(this));\n  }\n\n  _openHelpBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    ffd20.applications.helpBrowser.openUrl(a.dataset.url);\n  }\n\n  _updateObject(event, formData) {\n    this.command = formData[\"command\"];\n    this.name = formData[\"name\"] || null;\n\n    const result = {\n      command: this.command,\n      name: this.name,\n    };\n\n    this.resolvePromises(\"submit\", result);\n  }\n\n  resolvePromises(type, result) {\n    for (const p of this._promises[type]) {\n      if (!p.resolved) {\n        p.callback(result);\n        p.resolved = true;\n      }\n    }\n  }\n\n  async close(...args) {\n    super.close(...args);\n\n    this.resolvePromises(\"submit\", null);\n  }\n}\n","/**\n * @typedef {object} Widget_CategorizedItemPicker~Item\n * @property {string} key - The key of the item.\n * @property {string} [label] - The label of the item.\n * @property {string} [icon] - The icon of the item.\n */\n\n/**\n * @typedef {object} Widget_CategorizedItemPicker~Category\n * @property {string} key - The key of the category.\n * @property {string} label - The label of the category.\n * @property {Widget_CategorizedItemPicker~Item[]} items - All the items associated with this category.\n */\n\n/**\n * Item picker widget.\n */\nexport class Widget_CategorizedItemPicker extends Application {\n  constructor(options, categories, callback, selected) {\n    super(options);\n\n    /**\n     * Objects containing category and item data.\n     *\n     * @type {Widget_CategorizedItemPicker~Category[]}\n     */\n    this.categories = categories;\n\n    /**\n     * Previously selected category and item\n     *\n     * @type {object}\n     * @property {string} category Selected category.\n     * @property {string} item Selected item in that category.\n     */\n    this.selected = selected;\n\n    /**\n     * Callback fired when an item has been selected.\n     *\n     * @type {Function}\n     */\n    this.callback = callback;\n\n    /**\n     * Track hidden elements of the sheet.\n     *\n     * @property\n     * @type {Object<string, string>}\n     */\n    this._hiddenElems = {};\n\n    if (options.classes?.length) {\n      this.options.classes.push(...options.classes);\n    }\n  }\n\n  get template() {\n    return \"systems/ffd20/templates/widgets/categorized-item-picker.hbs\";\n  }\n\n  getData(options) {\n    const data = super.getData(options);\n\n    data.categories = [];\n    data.items = [];\n\n    for (const cat of this.categories) {\n      data.categories.push({\n        key: cat.key,\n        label: cat.label,\n      });\n\n      for (const item of cat.items) {\n        data.items.push(\n          mergeObject(\n            {\n              category: cat.key,\n            },\n            item\n          )\n        );\n      }\n    }\n\n    return data;\n  }\n\n  activateListeners(html) {\n    // Click an item\n    html.find(\".item\").click(this._onClickItem.bind(this));\n\n    // Expand/minimize category\n    html.find(\".category a\").click(this._onClickCategory.bind(this));\n\n    // Pre-select old category\n    if (this.selected?.category) {\n      html.find(`.category a[data-category=\"${this.selected.category}\"]`).click();\n      if (this.selected?.item) {\n        html\n          .find(`.item[data-category=\"${this.selected.category}\"][data-value=\"${this.selected.item}\"]`)\n          .first()\n          .addClass(\"pre-select\");\n      }\n    }\n\n    // Cancel widget\n    window.setTimeout(() => {\n      if (this._cancelCallback) document.removeEventListener(\"click\", this._cancelCallback);\n      this._cancelCallback = this._onCancel.bind(this);\n      document.addEventListener(\"click\", this._cancelCallback);\n    }, 10);\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      width: 480,\n      height: 480,\n      classes: [...options.classes, \"ffd20\", \"categorized-item-picker\"],\n    };\n  }\n\n  _onClickItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const result = a.dataset.value;\n    this.callback(result);\n    this.close();\n  }\n\n  _onClickCategory(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const html = $(this.element);\n\n    // Deactivate all categories\n    html.find(\".item-picker-categories\").children().removeClass(\"active\");\n\n    // Activate clicked category\n    $(a).closest(\".category\").addClass(\"active\");\n\n    // Hide all items\n    html.find(\".item-picker-items\").children().hide();\n\n    // Show items\n    html.find(`.item-picker-items .item[data-category=\"${a.dataset.category}\"]`).show();\n  }\n\n  _onCancel(event) {\n    event.preventDefault();\n\n    // Don't cancel if this widget was clicked\n    let node = event.target;\n    if (node === this.element[0]) return;\n    while (node.parentNode) {\n      if (node === this.element[0]) return;\n      node = node.parentNode;\n    }\n\n    this.close();\n  }\n\n  async close(...args) {\n    document.removeEventListener(\"click\", this._cancelCallback);\n    return super.close(...args);\n  }\n}\n\nHooks.on(\"renderWidget_CategorizedItemPicker\", (app, html, data) => {\n  html.find(\".pre-select\")[0]?.scrollIntoView({ block: \"nearest\" });\n});\n","import { adjustNumberByStringCommand, getBuffTargetDictionary, getBuffTargets } from \"@utils\";\nimport { ItemPF } from \"@item/item-pf.mjs\";\nimport { ScriptEditor } from \"../script-editor.mjs\";\nimport { ActorTraitSelector } from \"../trait-selector.mjs\";\nimport { Widget_CategorizedItemPicker } from \"../categorized-item-picker.mjs\";\nimport { getSkipActionPrompt } from \"../../documents/settings.mjs\";\n\n/**\n * Override and extend the core ItemSheet implementation to handle game system specific item types\n *\n * @type {ItemSheet}\n */\nexport class ItemSheetPF extends ItemSheet {\n  constructor(...args) {\n    super(...args);\n\n    this.items = [];\n\n    /**\n     * Track action updates from the item sheet.\n     *\n     * @property\n     * @private\n     * @type {object[]}\n     */\n    this._actionUpdates = [];\n  }\n\n  /* -------------------------------------------- */\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      width: 580,\n      classes: [\"ffd20\", \"sheet\", \"item\"],\n      scrollY: [\".tab\", \".buff-flags\", \".editor-content\"],\n      dragDrop: [\n        {\n          dragSelector: \"li.action-part\",\n          dropSelector: \".tab.details\",\n        },\n      ],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"description\",\n          group: \"primary\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='links']\",\n          contentSelector: \"section.links-body\",\n          initial: \"children\",\n          group: \"links\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='description']\",\n          contentSelector: \"section.description-body\",\n          initial: \"identified\",\n          group: \"description\",\n        },\n      ],\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Return a dynamic reference to the HTML template path used to render this Item Sheet\n   *\n   * @returns {string}\n   */\n  get template() {\n    const path = \"systems/ffd20/templates/items\";\n    return `${path}/${this.item.type}.hbs`;\n  }\n\n  get title() {\n    const actor = this.actor;\n    if (actor) return `${super.title}  ${actor.name}`;\n    return super.title;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare item sheet data\n   * Start with the base item data and extending with additional properties for rendering.\n   */\n  async getData() {\n    const context = await super.getData();\n    context.flags = { flags: context.flags };\n\n    /** @type {ItemPF} */\n    const item = this.item,\n      itemData = item.system;\n    context.system = itemData;\n\n    const actor = item.actor,\n      actorData = actor?.system;\n\n    const rollData = item.getRollData();\n    context.labels = item.getLabels();\n\n    // Include sub-items\n    context.items = item.items?.map((i) => i.toObject()) ?? [];\n\n    // Include CONFIG values\n    context.config = ffd20.config;\n\n    // Item Type, Status, and Details\n    context.itemType = this._getItemType(item);\n    context.itemStatus = this._getItemStatus(item);\n    context.itemProperties = this._getItemProperties();\n    context.itemName = item.name;\n    if (item.links.charges) context.inheritCharges = item.links.charges;\n    context.isCharged = [\"day\", \"week\", \"charges\"].includes(itemData.uses?.per);\n    context.defaultChargeFormula = item.getDefaultChargeFormula();\n    context.isPhysical = itemData.quantity !== undefined;\n    context.isNaturalAttack = itemData.subType === \"natural\";\n    context.isSpell = item.type === \"spell\";\n    context.owned = !!actor;\n    context.owner = item.isOwner;\n    context.isGM = game.user.isGM;\n    context.hasAction = item.hasAction;\n    context.showIdentifyDescription = context.isGM && context.isPhysical;\n    context.showUnidentifiedData = item.showUnidentifiedData;\n    context.unchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n    if (rollData.item.auraStrength != null) {\n      const auraStrength = rollData.item.auraStrength;\n      context.auraStrength = auraStrength;\n\n      if (ffd20.config.auraStrengths[auraStrength]) {\n        context.auraStrength_name = ffd20.config.auraStrengths[auraStrength];\n\n        context.labels.identify = game.i18n.format(\"FFD20.IdentifyDCNumber\", { dc: 15 + rollData.item.cl });\n      }\n    }\n\n    // Add spellcasting configuration\n    if (item.type === \"class\") {\n      context.casting = {\n        types: ffd20.config.spellcasting.type,\n        spells: ffd20.config.spellcasting.spells,\n        progression: {\n          high: \"FFD20.High\",\n          med: \"FFD20.Medium\",\n          low: \"FFD20.Low\",\n        },\n      };\n\n      if (!item.actor) context.hasSpellbook = true; // Not true, but avoids unwanted behaviour.\n      else {\n        context.hasSpellbook = Object.values(rollData.spells ?? {}).find(\n          (book) => !!book.class && book.class === itemData.tag && book.inUse\n        );\n      }\n    }\n\n    const description = this.document.getDescription();\n\n    // Add descriptions\n    context.descriptionHTML = {\n      identified: await TextEditor.enrichHTML(description, {\n        secrets: context.owner,\n        rollData: rollData,\n        async: true,\n      }),\n      unidentified: await TextEditor.enrichHTML(itemData.description.unidentified, {\n        secrets: context.owner,\n        rollData: rollData,\n        async: true,\n      }),\n    };\n\n    context.name = item.name;\n\n    // Override description attributes\n    if (context.isPhysical) {\n      /** @type {DescriptionAttribute[]} */\n      context.descriptionAttributes = [];\n\n      // Add quantity\n      context.descriptionAttributes.push({\n        isNumber: true,\n        name: \"system.quantity\",\n        label: game.i18n.localize(\"FFD20.Quantity\"),\n        value: itemData.quantity,\n        decimals: 0,\n        id: \"data-quantity\",\n      });\n\n      // Add weight\n      context.descriptionAttributes.push({\n        isNumber: true,\n        name: \"system.weight.value\",\n        fakeName: true,\n        label: game.i18n.localize(\"FFD20.Weight\"),\n        value: itemData.weight.converted.total,\n        inputValue: itemData.weight.converted.value,\n        decimals: 2,\n        id: \"data-weight-value\",\n      });\n\n      // Add price\n      if (context.showIdentifyDescription) {\n        context.descriptionAttributes.push(\n          {\n            isNumber: true,\n            name: \"system.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: item.getValue({ sellValue: 1 }),\n            decimals: 2,\n            id: \"data-price\",\n          },\n          {\n            isNumber: true,\n            name: \"system.unidentified.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.UnidentifiedPriceShort\"),\n            value: item.getValue({ sellValue: 1, forceUnidentified: true }),\n            decimals: 2,\n            id: \"data-unidentifiedPrice\",\n          }\n        );\n      } else {\n        if (context.showUnidentifiedData) {\n          context.descriptionAttributes.push({\n            isNumber: true,\n            name: \"system.unidentified.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: item.getValue({ sellValue: 1 }),\n            decimals: 2,\n            id: \"data-price\",\n          });\n        } else {\n          context.descriptionAttributes.push({\n            isNumber: true,\n            name: \"system.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: item.getValue({ sellValue: 1 }),\n            decimals: 2,\n            id: \"data-price\",\n          });\n        }\n      }\n\n      // Add hit points\n      context.descriptionAttributes.push({\n        isRange: true,\n        label: game.i18n.localize(\"FFD20.HPShort\"),\n        value: {\n          name: \"system.hp.value\",\n          value: itemData.hp.value,\n        },\n        max: {\n          name: \"system.hp.max\",\n          value: itemData.hp.max,\n        },\n      });\n\n      // Add hardness\n      context.descriptionAttributes.push({\n        isNumber: true,\n        label: game.i18n.localize(\"FFD20.Hardness\"),\n        name: \"system.hardness\",\n        decimals: 0,\n        value: itemData.hardness,\n      });\n\n      // Add equipped flag\n      context.descriptionAttributes.push({\n        isBoolean: true,\n        name: \"system.equipped\",\n        label: game.i18n.localize(\"FFD20.Equipped\"),\n        value: itemData.equipped,\n      });\n\n      // Add carried flag\n      context.descriptionAttributes.push({\n        isBoolean: true,\n        name: \"system.carried\",\n        label: game.i18n.localize(\"FFD20.Carried\"),\n        value: itemData.carried,\n      });\n    }\n\n    // Prepare feat specific stuff\n    if (item.type === \"feat\") {\n      context.isClassFeature = itemData.subType === \"classFeat\";\n      context.isTemplate = itemData.subType === \"template\";\n    }\n\n    if ([\"class\", \"feat\", \"race\"].includes(item.type)) {\n      // Add skill list\n      if (!actor) {\n        context.skills = Object.entries(ffd20.config.skills).reduce((cur, [skillId, label]) => {\n          cur[skillId] = { name: label, classSkill: itemData.classSkills?.[skillId] === true };\n          return cur;\n        }, {});\n      } else {\n        // Get sorted skill list from config, custom skills get appended to bottom of list\n        const skills = mergeObject(deepClone(ffd20.config.skills), actorData.skills ?? {});\n        context.skills = Object.entries(skills).reduce((cur, [skillId, skillIdata]) => {\n          const name = ffd20.config.skills[skillId] || skillIdata.name;\n          cur[skillId] = { name: name, classSkill: item.system.classSkills?.[skillId] === true };\n          return cur;\n        }, {});\n      }\n    }\n\n    // Prepare weapon specific stuff\n    if (item.type === \"weapon\") {\n      context.isRanged = itemData.weaponSubtype === \"ranged\" || itemData.properties[\"thr\"] === true;\n\n      // Prepare categories for weapons\n      context.weaponCategories = { types: {}, subTypes: {} };\n      for (const [k, v] of Object.entries(ffd20.config.weaponTypes)) {\n        if (typeof v === \"object\") context.weaponCategories.types[k] = v._label;\n      }\n      const type = itemData.subType;\n      if (type in ffd20.config.weaponTypes) {\n        for (const [k, v] of Object.entries(ffd20.config.weaponTypes[type])) {\n          // Add static targets\n          if (!k.startsWith(\"_\")) context.weaponCategories.subTypes[k] = v;\n        }\n      }\n    }\n\n    // Prepare equipment specific stuff\n    if (item.type === \"equipment\") {\n      // Prepare categories for equipment\n      context.equipmentCategories = { types: {}, subTypes: {} };\n      for (const [k, v] of Object.entries(ffd20.config.equipmentTypes)) {\n        if (typeof v === \"object\") context.equipmentCategories.types[k] = v._label;\n      }\n      const subType = itemData.subType;\n      if (subType in ffd20.config.equipmentTypes) {\n        for (const [k, v] of Object.entries(ffd20.config.equipmentTypes[subType])) {\n          // Add static targets\n          if (!k.startsWith(\"_\")) context.equipmentCategories.subTypes[k] = v;\n        }\n      }\n\n      // Prepare slots for equipment\n      context.equipmentSlots = ffd20.config.equipmentSlots.wondrous;\n\n      // Whether the current equipment type has multiple slots\n      context.hasMultipleSlots = item.hasSlots;\n\n      context.hasSubCategory = [\"armor\", \"shield\"].includes(subType);\n    }\n\n    // Prepare spell specific stuff\n    if (item.type === \"spell\") {\n      let spellbook = null;\n      if (actor) {\n        const bookId = itemData.spellbook;\n        spellbook = actorData?.attributes.spells?.spellbooks[bookId];\n      }\n\n      context.isPreparedSpell = spellbook != null ? !spellbook.spontaneous && !spellbook.spellPoints?.useSystem : false;\n      context.usesSpellpoints = spellbook != null ? spellbook.spellPoints?.useSystem ?? false : false;\n      context.isAtWill = itemData.atWill;\n      context.spellbooks = deepClone(actorData?.attributes.spells.spellbooks ?? {});\n\n      const desc = await renderTemplate(\n        \"systems/ffd20/templates/internal/spell-description.hbs\",\n        item.spellDescriptionData\n      );\n      const firstAction = item.firstAction;\n      context.topDescription = await TextEditor.enrichHTML(desc, {\n        rollData: firstAction?.getRollData() ?? rollData,\n        async: true,\n      });\n\n      // Enrich description\n      if (itemData.shortDescription != null) {\n        context.shortDescription = await TextEditor.enrichHTML(itemData.shortDescription, {\n          rollData: firstAction?.getRollData() ?? rollData,\n          secrets: context.owner,\n          async: true,\n        });\n      }\n    }\n\n    // Prepare class specific stuff\n    if (item.type === \"class\") {\n      context.isMythicPath = itemData.subType === \"mythic\";\n\n      for (const [a, s] of Object.entries(itemData.savingThrows)) {\n        s.label = ffd20.config.savingThrows[a];\n      }\n      for (const [a, s] of Object.entries(itemData.fc)) {\n        s.label = ffd20.config.favouredClassBonuses[a];\n      }\n\n      context.isBaseClass = itemData.subType === \"base\";\n      context.isRacialHD = itemData.subType === \"racial\";\n\n      if (actor) {\n        const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n        context.healthConfig = context.isRacialHD\n          ? healthConfig.hitdice.Racial\n          : actor.type === \"character\"\n          ? healthConfig.hitdice.PC\n          : healthConfig.hitdice.NPC;\n      } else context.healthConfig = { auto: false };\n\n      // Add skill list\n      if (!actor) {\n        context.skills = Object.entries(ffd20.config.skills).reduce((cur, [skillId, label]) => {\n          cur[skillId] = { name: label, classSkill: itemData.classSkills?.[skillId] === true };\n          return cur;\n        }, {});\n      } else {\n        // Get sorted skill list from config, custom skills get appended to bottom of list\n        const skills = mergeObject(deepClone(ffd20.config.skills), actorData.skills ?? {});\n        context.skills = Object.entries(skills).reduce((cur, [skillId, skillData]) => {\n          const name = ffd20.config.skills[skillId] != null ? ffd20.config.skills[skillId] : skillData.name;\n          cur[skillId] = { name: name, classSkill: itemData.classSkills?.[skillId] === true };\n          return cur;\n        }, {});\n      }\n    }\n\n    // Prepare proficiencies & languages\n    const profs = {\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      languages: ffd20.config.languages,\n      weaponGroups: ffd20.config.weaponGroups,\n    };\n\n    for (const [t, choices] of Object.entries(profs)) {\n      if (!itemData[t]) continue;\n\n      const trait = deepClone(itemData[t]);\n      context[t] = trait;\n\n      let values = [];\n      if (trait.value) {\n        values = trait.value instanceof Array ? trait.value : [trait.value];\n      }\n      trait.selected = values.reduce((obj, t) => {\n        obj[t] = choices[t];\n        return obj;\n      }, {});\n\n      // Add custom entry\n      if (trait.custom) {\n        trait.custom\n          .split(ffd20.config.re.traitSeparator)\n          .forEach((c, i) => (trait.selected[`custom${i + 1}`] = c.trim()));\n      }\n      trait.active = !foundry.utils.isEmpty(trait.selected);\n    }\n\n    // Prepare stuff for active effects on items\n    if (item.changes) {\n      context.changeGlobals = {\n        targets: {},\n        modifiers: ffd20.config.bonusModifiers,\n      };\n      for (const [k, v] of Object.entries(ffd20.config.buffTargets)) {\n        if (typeof v === \"object\") context.changeGlobals.targets[k] = v._label;\n      }\n\n      const buffTargets = getBuffTargets(actor);\n      context.changes =\n        itemData.changes?.map((o) => {\n          const target = buffTargets[o.subTarget];\n          return {\n            data: o,\n            isValid: !!target,\n            label: target?.label ?? o.subTarget,\n            isScript: o.operator === \"script\",\n          };\n        }) ?? [];\n    }\n\n    // Prepare stuff for items with context notes\n    if (itemData.contextNotes) {\n      context.contextNotes = deepClone(itemData.contextNotes);\n      const noteTargets = getBuffTargets(actor, \"contextNotes\");\n      context.contextNotes.forEach((o) => {\n        const target = noteTargets[o.subTarget];\n        o.isValid = !!target;\n        o.label = target?.label ?? o.subTarget;\n      });\n    }\n\n    // Add distance units\n    context.distanceUnits = deepClone(ffd20.config.distanceUnits);\n    if (item.type !== \"spell\") {\n      for (const d of [\"close\", \"medium\", \"long\"]) {\n        delete context.distanceUnits[d];\n      }\n    }\n\n    // Parse notes\n    if (itemData.attackNotes) {\n      const value = itemData.attackNotes;\n      setProperty(context, \"notes.attack\", value);\n    }\n\n    // Add item flags\n    this._prepareItemFlags(context);\n\n    // Add script calls\n    await this._prepareScriptCalls(context);\n\n    // Add links\n    await this._prepareLinks(context);\n\n    // Add actions\n    this._prepareActions(context);\n\n    return context;\n  }\n\n  _prepareLinks(data) {\n    data.links = {\n      list: [],\n    };\n\n    // Add children link type\n    data.links.list.push({\n      id: \"children\",\n      label: game.i18n.localize(\"FFD20.LinkTypeChildren\"),\n      help: game.i18n.localize(\"FFD20.LinkHelpChildren\"),\n      items: [],\n    });\n\n    // Add charges link type\n    if ([\"feat\", \"consumable\", \"attack\", \"equipment\"].includes(this.item.type)) {\n      data.links.list.push({\n        id: \"charges\",\n        label: game.i18n.localize(\"FFD20.LinkTypeCharges\"),\n        help: game.i18n.localize(\"FFD20.LinkHelpCharges\"),\n        items: [],\n      });\n    }\n\n    // Add class associations\n    if (this.item.type === \"class\") {\n      data.links.list.push({\n        id: \"classAssociations\",\n        label: game.i18n.localize(\"FFD20.LinkTypeClassAssociations\"),\n        help: game.i18n.localize(\"FFD20.LinkHelpClassAssociations\"),\n        fields: {\n          level: {\n            type: \"Number\",\n            label: game.i18n.localize(\"FFD20.Level\"),\n          },\n        },\n        items: [],\n      });\n    }\n\n    // Post process data\n    const item = this.item,\n      actor = item.actor;\n    for (const links of data.links.list) {\n      const items = item.system.links?.[links.id] || [];\n      for (let index = 0; index < items.length; index++) {\n        const linkData = deepClone(items[index]);\n        linkData.index = index; // Record index so sorted lists maintain data cohesion\n\n        const linkedItem = item.getLinkedItemSync(linkData);\n        if (!linkedItem) linkData.broken = true;\n        linkData.img = linkedItem?.img || ItemPF.DEFAULT_ICON;\n\n        // Add item to stack\n        links.items.push(linkData);\n      }\n    }\n  }\n\n  _prepareActions(data) {\n    if (!data.system.actions) return [];\n    const result = [];\n\n    for (const d of data.system.actions) {\n      const doc = this.object.actions.get(d._id);\n      const obj = {\n        data: d,\n        isSelfCharged: doc.isSelfCharged,\n      };\n\n      result.push(obj);\n    }\n\n    data.actions = result;\n  }\n\n  _prepareItemFlags(data) {\n    const flags = data.item.system.flags ?? {};\n    data.flags ??= {};\n    data.flags.boolean = flags.boolean ?? {};\n    data.flags.dictionary = flags.dictionary ?? {};\n  }\n\n  async _prepareScriptCalls(data) {\n    const categories = ffd20.registry.scriptCalls.filter((scriptCallCategory) => {\n      if (!scriptCallCategory.itemTypes.includes(this.document.type)) return false;\n      return !(scriptCallCategory.hidden === true && !game.user.isGM);\n    });\n    // Don't show the Script Calls section if there are no categories for this item type\n    if (!categories.length) {\n      data.scriptCalls = null;\n      return;\n    }\n    // Don't show the Script Calls section if players are not allowed to edit script macros\n    if (!game.user.can(\"MACRO_SCRIPT\")) {\n      data.scriptCalls = null;\n      return;\n    }\n\n    data.scriptCalls = {};\n\n    // Prepare data to add\n    const checkYes = '<i class=\"fas fa-check\"></i>';\n    const checkNo = '<i class=\"fas fa-times\"></i>';\n\n    // Iterate over all script calls, and adjust data\n    const scriptCalls = Object.hasOwnProperty.call(this.document, \"scriptCalls\")\n      ? deepClone(Array.from(this.document.scriptCalls).map((o) => o.data))\n      : [];\n    {\n      const promises = [];\n      for (const o of scriptCalls) {\n        promises.push(\n          (async () => {\n            // Obtain macro info\n            if (o.type === \"macro\") {\n              const m = await fromUuid(o.value);\n              if (m == null) {\n                o.name = `${game.i18n.localize(\"FFD20.Unknown\")} (${game.i18n.localize(\"DOCUMENT.Macro\")})`;\n                o.img = \"icons/svg/hazard.svg\";\n              } else {\n                o.name = m.data.name;\n                o.img = m.data.img;\n              }\n            }\n\n            // Add data\n            o.hiddenIcon = o.hidden ? checkYes : checkNo;\n            o.hide = o.hidden && !game.user.isGM;\n          })()\n        );\n      }\n      await Promise.all(promises);\n    }\n\n    // Create categories, and assign items to them\n    for (const c of categories) {\n      data.scriptCalls[c.id] = {\n        name: game.i18n.localize(c.name),\n        info: c.info ? game.i18n.localize(c.info) : null,\n        items: scriptCalls.filter((o) => o.category === c.id),\n        dataset: {\n          category: c.id,\n        },\n      };\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the text item type which is shown in the top-right corner of the sheet\n   *\n   * @param item\n   * @returns {string}\n   * @private\n   */\n  _getItemType(item) {\n    const typeKeys = Object.keys(ffd20.config.itemTypes);\n    let itemType = item.type;\n    if (!typeKeys.includes(itemType)) itemType = typeKeys[0];\n    return game.i18n.localize(ffd20.config.itemTypes[itemType]);\n  }\n\n  /**\n   * Get the text item status which is shown beneath the Item type in the top-right corner of the sheet\n   *\n   * @param item\n   * @returns {string}\n   * @private\n   */\n  _getItemStatus(item) {\n    const itemData = item.system;\n    if (item.type === \"spell\") {\n      const spellbook = this.item.spellbook;\n      if (itemData.preparation.mode === \"prepared\") {\n        if (spellbook?.spellPreparationMode === \"spontaneous\") {\n          if (itemData.preparation.spontaneousPrepared) return game.i18n.localize(\"FFD20.SpellPrepPrepared\");\n          else return game.i18n.localize(\"FFD20.Unprepared\");\n        } else if (itemData.preparation.preparedAmount > 0)\n          return game.i18n.format(\"FFD20.AmountPrepared\", { count: itemData.preparation.preparedAmount });\n        else return game.i18n.localize(\"FFD20.Unprepared\");\n      } else if (itemData.preparation.mode) {\n        return itemData.preparation.mode.titleCase();\n      }\n    } else if (itemData.equipped !== undefined) {\n      return itemData.equipped ? game.i18n.localize(\"FFD20.Equipped\") : game.i18n.localize(\"FFD20.NotEquipped\");\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get an array of item properties which are used in the small sidebar of the description tab\n   *\n   * @returns {string[]}\n   * @private\n   */\n  _getItemProperties() {\n    const props = [];\n    const item = this.item;\n    const labels = this.item.getLabels();\n\n    if (item.type === \"weapon\") {\n      props.push(\n        ...Object.entries(item.system.properties)\n          .filter((e) => e[1] === true)\n          .map((e) => ffd20.config.weaponProperties[e[0]])\n      );\n    } else if (item.type === \"spell\") {\n      props.push(labels.components, labels.materials);\n    } else if (item.type === \"equipment\") {\n      const subType = item.subType;\n      // Obfuscate wondrous item as clothing or other, if unidentified\n      if (subType === \"wondrous\") {\n        if (!item.showUnidentifiedData) {\n          props.push(ffd20.config.equipmentTypes.wondrous._label);\n        } else {\n          props.push(ffd20.config.equipmentTypes.other._label);\n        }\n      } else {\n        const subtypeLabels = ffd20.config.equipmentTypes[subType];\n        const typeLabel = subtypeLabels?.[item.system.equipmentSubtype] ?? subtypeLabels?._label;\n        if (typeLabel) props.push(typeLabel);\n      }\n      // Add AC\n      props.push(labels.armor);\n    } else if (item.type === \"feat\") {\n      props.push(labels.subType);\n    }\n\n    // Action type\n    const itemActionTypes = item.actionTypes;\n    if (itemActionTypes) {\n      props.push(...itemActionTypes.map((o) => ffd20.config.itemActionTypes[o]));\n    }\n\n    // Action usage\n    if (item.type !== \"weapon\" && item.system.activation && !foundry.utils.isEmpty(item.system.activation)) {\n      props.push(labels.activation, labels.range, labels.target, labels.duration);\n    }\n\n    // Tags\n    const tags = item.system.tags;\n    if (tags != null) {\n      props.push(...tags);\n    }\n\n    return props.filter((p) => !!p);\n  }\n\n  /* -------------------------------------------- */\n\n  /* -------------------------------------------- */\n  /*  Form Submission                             */\n  /* -------------------------------------------- */\n\n  /**\n   * Extend the parent class _updateObject method to ensure that damage ends up in an Array\n   *\n   * @param event\n   * @param formData\n   * @private\n   */\n  async _updateObject(event, formData) {\n    formData = expandObject(formData);\n\n    const system = formData.system;\n\n    const links = system.links;\n    if (links) {\n      const oldLinks = this.item.system?.links ?? {};\n      // Handle links arrays\n      for (const [linkType, typedLinks] of Object.entries(links)) {\n        // Maintain array and merge new data in\n        links[linkType] = deepClone(oldLinks[linkType] ?? []);\n        for (const [index, linkData] of Object.entries(typedLinks)) {\n          links[linkType][index] = mergeObject(links[linkType][index] ?? {}, linkData);\n        }\n      }\n    }\n\n    // Handle weight to ensure `weight.value` is in lbs\n    if (system.weight?.value !== undefined) {\n      system.weight.value = ffd20.utils.convertWeightBack(system.weight.value);\n    }\n\n    // Change currencies with relative values\n    // @TODO: Create a common relative input handler.\n    const relativeKeys = [\"currency.pgil\", \"currency.gil\", \"currency.sgil\", \"currency.cgil\"];\n    for (const key of relativeKeys) {\n      const value = getProperty(system, key);\n      if (typeof value !== \"string\") continue;\n\n      // Add or subtract values\n      let newValue;\n      if (value.match(/(\\+|-)(\\d+)/)) {\n        const operator = RegExp.$1;\n        let value = parseInt(RegExp.$2);\n        if (operator === \"-\") value = -value;\n        const originalValue = getProperty(this.item.system, key);\n        newValue = originalValue + value;\n      } else if (value.match(/^[0-9]+$/)) {\n        newValue = parseInt(value);\n      } else if (value === \"\") {\n        newValue = 0;\n      } else {\n        // Invalid strings\n        newValue = 0;\n      }\n\n      setProperty(system, key, Math.max(0, newValue));\n    }\n\n    // Update the Item\n    return super._updateObject(event, formData);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Activate listeners for interactive item sheet events\n   *\n   * @param html\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Tooltips\n    html.mousemove((ev) => this._moveTooltips(ev));\n\n    // Edit action\n    html.find(\".actions .item-list .item\").on(\"contextmenu\", this._onActionEdit.bind(this));\n\n    // Item summaries\n    html.find(\".item .item-name h4\").on(\"click\", (event) => this._onItemSummary(event));\n\n    // Action control\n    html.find(\".action-controls a\").on(\"click\", this._onActionControl.bind(this));\n\n    // Everything below here is only needed if the sheet is editable\n    if (!this.isEditable) {\n      html.find(\"span.text-box\").addClass(\"readonly\");\n      return;\n    }\n\n    // Trigger form submission from textarea elements.\n    html.find(\"textarea\").change(this._onSubmit.bind(this));\n\n    // Add drop handler to textareas\n    html.find(\"textarea, .notes input[type='text']\").on(\"drop\", this._onTextAreaDrop.bind(this));\n\n    // Open help browser\n    html.find(\"a.help-browser[data-url]\").click(this._openHelpBrowser.bind(this));\n\n    // Modify buff changes\n    html.find(\".change-control\").click(this._onBuffControl.bind(this));\n    html.find(\".change .change-target\").click(this._onChangeTargetControl.bind(this));\n\n    // Modify note changes\n    html.find(\".context-note-control\").click(this._onNoteControl.bind(this));\n    html.find(\".context-note .context-note-target\").click(this._onNoteTargetControl.bind(this));\n\n    // Create attack\n    if ([\"weapon\"].includes(this.item.type)) {\n      html.find(\"button[name='create-attack']\").click(this._createAttack.bind(this));\n    }\n\n    // Create spellbook\n    if (this.item.type === \"class\") {\n      html.find(\"button[name='create-spellbook']\").click(this._createSpellbook.bind(this));\n    }\n\n    // Listen to field entries\n    html.find(\".entry-selector\").click(this._onEntrySelector.bind(this));\n    html.find(\".entry-control a\").click(this._onEntryControl.bind(this));\n\n    // Add drop handler to link tabs\n    html.find('div[data-group=\"links\"],a.item[data-tab=\"links\"]').on(\"drop\", this._onLinksDrop.bind(this));\n\n    html.find(\".link-control\").click(this._onLinkControl.bind(this));\n\n    // Handle alternative file picker\n    html.find(\".file-picker-alt\").click(this._onFilePickerAlt.bind(this));\n\n    // Click to change text input\n    html.find('*[data-action=\"input-text\"]').click((event) => this._onInputText(event));\n\n    // Select the whole text on click\n    html.find(\".select-on-click\").click(this._selectOnClick.bind(this));\n\n    // Edit change script contents\n    html.find(\".edit-change-contents\").on(\"click\", this._onEditChangeScriptContents.bind(this));\n\n    // Trait Selector\n    html.find(\".trait-selector\").click(this._onTraitSelector.bind(this));\n\n    // Linked item clicks\n    html.find(\".tab[data-tab='links'] .links-item .links-item-name\").on(\"contextmenu\", this._openLinkedItem.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Actions\n    /* -------------------------------------------- */\n\n    // Modify action charges\n    html\n      .find(\".action-parts .item-uses span.text-box.value\")\n      .on(\"wheel\", this._setActionUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setActionUses.bind(this));\n      });\n\n    // Open charge source with right click\n    html.find(\".uses-source [data-item-id]\").on(\"contextmenu\", (event) => {\n      event.preventDefault();\n      const itemId = event.currentTarget.dataset.itemId;\n      const item = this.document.actor.items.get(itemId);\n      item?.sheet.render(true, { focus: true });\n    });\n\n    /* -------------------------------------------- */\n    /*  Links\n    /* -------------------------------------------- */\n\n    html.find('a[data-action=\"compendium\"]').click(this._onOpenCompendium.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Script Calls\n    /* -------------------------------------------- */\n\n    html.find(\".script-calls .item-control\").click(this._onScriptCallControl.bind(this));\n\n    html.find(\".script-calls .item-list .item\").contextmenu(this._onScriptCallEdit.bind(this));\n\n    html.find(\".script-calls .item-list[data-category]\").on(\"drop\", this._onScriptCallDrop.bind(this));\n  }\n\n  _onSpanTextInput(event, callback = null) {\n    const el = event.currentTarget;\n    const parent = el.parentElement;\n\n    // Replace span element with an input (text) element\n    const newEl = document.createElement(`INPUT`);\n    newEl.type = \"text\";\n    if (el.dataset?.dtype) newEl.dataset.dtype = el.dataset.dtype;\n\n    // Set value of new input element\n    let prevValue = el.innerText;\n    if (el.classList.contains(\"placeholder\")) prevValue = \"\";\n\n    const noCap = el.classList.contains(\"no-value-cap\");\n\n    const name = el.getAttribute(\"name\");\n    let maxValue;\n    if (name) {\n      newEl.setAttribute(\"name\", name);\n      prevValue = getProperty(this.document, name) ?? \"\";\n      if (prevValue && typeof prevValue !== \"string\") prevValue = prevValue.toString();\n\n      if (name.endsWith(\".value\") && !noCap) {\n        const maxName = name.replace(/\\.value$/, \".max\");\n        maxValue = getProperty(this.document, maxName);\n      }\n    }\n    newEl.value = prevValue;\n\n    // Toggle classes\n    const forbiddenClasses = [\"placeholder\", \"direct\", \"allow-relative\"];\n    for (const cls of el.classList) {\n      if (!forbiddenClasses.includes(cls)) newEl.classList.add(cls);\n    }\n\n    // Replace span with input element\n    const allowRelative = el.classList.contains(\"allow-relative\"),\n      clearValue = parseFloat(el.dataset.clearValue || \"0\");\n    parent.replaceChild(newEl, el);\n    let changed = false;\n    newEl.addEventListener(\"keypress\", (event) => {\n      if (event.key !== \"Enter\") return;\n      changed = true;\n      if (allowRelative) {\n        const number = adjustNumberByStringCommand(parseFloat(prevValue), newEl.value, maxValue, clearValue);\n        newEl.value = number;\n      }\n\n      if (newEl.value.toString() === prevValue.toString()) {\n        this.render();\n      } else if (typeof callback === \"function\") {\n        callback.call(this, event);\n      }\n    });\n    newEl.addEventListener(\"focusout\", (event) => {\n      if (!changed) {\n        changed = true;\n        if (allowRelative && parseFloat(prevValue) !== parseFloat(newEl.value)) {\n          const number = adjustNumberByStringCommand(parseFloat(prevValue), newEl.value, maxValue, clearValue);\n          newEl.value = number;\n        }\n\n        if (newEl.value.toString() === prevValue.toString()) {\n          this.render();\n        } else if (typeof callback === \"function\") {\n          callback.call(this, event);\n        }\n      }\n    });\n\n    // Select text inside new element\n    newEl.focus();\n    newEl.select();\n  }\n\n  _mouseWheelAdd(event, el) {\n    const isInput = el.tagName === \"INPUT\";\n    const { originalEvent } = event;\n\n    if (originalEvent && originalEvent instanceof WheelEvent && originalEvent.ctrlKey) {\n      event.preventDefault();\n      const value = (isInput ? parseFloat(el.value) : parseFloat(el.innerText)) || 0;\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(originalEvent.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n\n      if (isInput) {\n        el.value = value + amount * increase;\n      } else {\n        el.innerText = (value + amount * increase).toString();\n      }\n    }\n  }\n\n  _setActionUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const actionId = el.closest(\".item\").dataset.itemId;\n    const action = this.document.actions.get(actionId);\n\n    this._mouseWheelAdd(event, el);\n\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setActionUpdate(action.id, \"uses.self.value\", value);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      const hasEvent = ($._data(el, \"events\")?.mouseout?.length ?? 0) > 0;\n      if (!hasEvent) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateActions();\n        });\n      }\n    } else this._updateActions();\n  }\n\n  setActionUpdate(id, key, value) {\n    let obj = this._actionUpdates.filter((o) => {\n      return o._id === id;\n    })[0];\n    if (obj == null) {\n      obj = { _id: id };\n      this._actionUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  async _updateActions() {\n    const promises = [];\n\n    const updates = this._actionUpdates;\n    this._actionUpdates = [];\n\n    // Memorize variables in document\n    for (const d of updates) {\n      const action = this.document.actions.get(d._id);\n      if (!action) {\n        console.error(\"Item update for non-existing item:\", d._id, d);\n        continue;\n      }\n      await action.update(d);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  _onOpenCompendium(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const target = a.dataset.actionTarget;\n\n    ffd20.applications.compendiums[target].render(true, { focus: true });\n  }\n\n  async _onScriptCallControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const item = this.document.scriptCalls ? this.document.scriptCalls.get(a.closest(\".item\")?.dataset.itemId) : null;\n    const group = a.closest(\".item-list\");\n    const category = group.dataset.category;\n\n    // Create item\n    if (a.classList.contains(\"item-create\")) {\n      await this._onSubmit(event, { preventRender: true });\n      return ffd20.components.ItemScriptCall.create([{ category, type: \"script\" }], { parent: this.item });\n    }\n    // Delete item\n    else if (item && a.classList.contains(\"item-delete\")) {\n      const list = (this.document.system.scriptCalls || []).filter((o) => o._id !== item.id);\n      return this._onSubmit(event, { updateData: { \"system.scriptCalls\": list } });\n    }\n    // Edit item\n    else if (item && a.classList.contains(\"item-edit\")) {\n      item.edit();\n    }\n    // Toggle hidden\n    else if (item && a.classList.contains(\"item-hide\")) {\n      item.update({\n        hidden: !item.hidden,\n      });\n    }\n  }\n\n  _onScriptCallEdit(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const item = this.document.scriptCalls ? this.document.scriptCalls.get(a.dataset.itemId) : null;\n\n    if (item) {\n      item.edit();\n    }\n  }\n\n  _moveTooltips(event) {\n    const elem = $(event.currentTarget);\n    const x = event.clientX;\n    const y = event.clientY + 24;\n    elem.find(\".tooltip:hover .tooltipcontent\").css(\"left\", `${x}px`).css(\"top\", `${y}px`);\n  }\n\n  async _onTextAreaDrop(event) {\n    event.preventDefault();\n\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const elem = event.currentTarget;\n    const link = await TextEditor.getContentLink(eventData);\n\n    // Insert link\n    if (link) {\n      elem.value = !elem.value ? link : elem.value + \"\\n\" + link;\n    }\n    return this._onSubmit(event);\n  }\n\n  async _onScriptCallDrop(event) {\n    event.preventDefault();\n\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const { uuid, type } = eventData;\n    if (type !== \"Macro\") return;\n\n    // Submit data\n    if (uuid) {\n      const elem = event.currentTarget;\n      const category = elem.dataset.category;\n      const list = this.document.system.scriptCalls ?? [];\n      await this._onSubmit(event, { preventRender: true });\n      return ffd20.components.ItemScriptCall.create([{ type: \"macro\", value: uuid, category }], {\n        parent: this.item,\n      });\n    }\n  }\n\n  _openHelpBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    ffd20.applications.helpBrowser.openUrl(a.dataset.url);\n  }\n\n  async _onLinksDrop(event) {\n    const elem = event.currentTarget;\n    let linkType = elem.dataset.tab;\n\n    // Default selection for dropping on tab instead of body\n    if (linkType === \"links\") linkType = \"children\";\n\n    // Try to extract the data\n    const data = TextEditor.getDragEventData(event.originalEvent);\n    if (!data.type) return;\n\n    const targetItem = await fromUuid(data.uuid);\n    if (!targetItem) return;\n\n    let dataType,\n      itemLink = data.uuid;\n    // Case 1 - Import from a Compendium pack\n    if (targetItem.pack) {\n      dataType = \"compendium\";\n    }\n    // Case 2 - Import from same actor\n    else if (targetItem.actor === this.document.actor) {\n      dataType = \"data\";\n      itemLink = targetItem.id;\n    }\n\n    // Case 3 - Import from World Document\n    else {\n      dataType = \"world\";\n    }\n\n    await this.item.createItemLink(linkType, dataType, targetItem, itemLink);\n  }\n\n  /**\n   * By default, returns true only for GM\n   *\n   * @override\n   */\n  _canDragStart(selector) {\n    return true;\n  }\n\n  _onDragStart(event) {\n    const elem = event.currentTarget;\n\n    // Drag action\n    if (elem.dataset?.itemId) {\n      const action = this.object.actions.get(elem.dataset.itemId);\n      const obj = { type: \"action\", source: this.object.uuid, data: action.data };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(obj));\n    }\n  }\n\n  async _onDrop(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    let data, type;\n    try {\n      data = JSON.parse(event.dataTransfer.getData(\"text/plain\"));\n      // Surface-level check for action\n      if (data.type === \"action\" && data.source) type = \"action\";\n    } catch (e) {\n      return false;\n    }\n\n    const item = this.object;\n\n    // Handle actions\n    if (type === \"action\") {\n      const srcItem = await fromUuid(data.source);\n\n      // Re-order\n      if (srcItem === item) {\n        const targetActionID = event.target?.closest(\"li.action-part\")?.dataset?.itemId;\n        const prevActions = deepClone(item.system.actions);\n\n        let targetIdx;\n        if (!targetActionID) targetIdx = prevActions.length - 1;\n        else targetIdx = prevActions.indexOf(prevActions.find((o) => o._id === targetActionID));\n        const srcIdx = prevActions.indexOf(prevActions.find((o) => o._id === data.data._id));\n\n        prevActions.splice(srcIdx, 1);\n        prevActions.splice(targetIdx, 0, data.data);\n        await this.object.update({ \"system.actions\": prevActions });\n      }\n\n      // Add to another item\n      else {\n        const prevActions = deepClone(this.object.system.actions ?? []);\n        data.data._id = randomID(16);\n        prevActions.splice(prevActions.length, 0, data.data);\n        await this.object.update({ \"system.actions\": prevActions });\n      }\n    }\n  }\n\n  async _onEditChangeScriptContents(event) {\n    const elem = event.currentTarget;\n    const changeID = elem.closest(\".change\").dataset.change;\n    const change = this.item.changes.find((o) => o._id === changeID);\n\n    if (!change) return;\n\n    const scriptEditor = new ScriptEditor({ command: change.formula, parent: this.object }).render(true);\n    const result = await scriptEditor.awaitResult();\n    if (typeof result?.command === \"string\") {\n      return change.update({ formula: result.command });\n    }\n  }\n\n  /**\n   * Handle spawning the ActorTraitSelector application which allows a checkbox of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onTraitSelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const label = a.parentElement.querySelector(\"label\");\n    const options = {\n      name: label.getAttribute(\"for\"),\n      title: label.innerText,\n      subject: a.dataset.options,\n      choices: ffd20.config[a.dataset.options],\n    };\n    new ActorTraitSelector(this.object, options).render(true);\n  }\n\n  /**\n   * Toggle inline display of an item's summary/description by expanding or hiding info div\n   *\n   * @param {JQuery.ClickEvent<HTMLElement>} event - The click event on the item\n   * @private\n   */\n  _onItemSummary(event) {\n    event.preventDefault();\n    const li = $(event.currentTarget).closest(\".item:not(.sheet)\");\n    // Check whether pseudo-item belongs to another collection\n    const collection = li.attr(\"data-item-collection\") ?? \"items\";\n    const item = this.document[collection].get(li.attr(\"data-item-id\"));\n    // For actions (embedded into a parent item), show only the action's summary instead of a complete one\n    const isAction = collection === \"actions\";\n    const { description, actionDescription, properties } = item.getChatData({ chatcard: false });\n\n    // Toggle summary\n    if (li.hasClass(\"expanded\")) {\n      const summary = li.children(\".item-summary\");\n      summary.slideUp(200, () => summary.remove());\n    } else {\n      const div = $(`<div class=\"item-summary\">${isAction ? actionDescription : description}</div>`);\n      const props = $(`<div class=\"item-properties tag-list\"></div>`);\n      // Transform properties into a tag list containing HTML, and append to div\n      properties?.forEach((p) => props.append(`<span class=\"tag\">${p}</span>`));\n      div.append(props);\n      li.append(div.hide());\n      div.slideDown(200);\n    }\n    li.toggleClass(\"expanded\");\n  }\n\n  /**\n   * Open linked item sheet.\n   *\n   * @param {Event} event\n   */\n  async _openLinkedItem(event) {\n    event.preventDefault();\n    const el = event.target.closest(\".links-item[data-uuid],.links-item[data-item-id]\");\n    const { uuid, itemId } = el.dataset;\n\n    let item;\n    if (itemId) item = this.item.actor.items.get(itemId);\n    else item = await fromUuid(uuid);\n    item.sheet.render(true, { focus: true });\n  }\n\n  async _onActionControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Edit action\n    if (a.classList.contains(\"edit-action\")) {\n      return this._onActionEdit(event);\n    }\n\n    if (!this.isEditable) return;\n\n    // Add action\n    if (a.classList.contains(\"add-action\")) {\n      const newActionData = {\n        img: this.item.img,\n        name: [\"weapon\", \"attack\"].includes(this.item.type)\n          ? game.i18n.localize(\"FFD20.Attack\")\n          : game.i18n.localize(\"FFD20.Use\"),\n      };\n      await this._onSubmit(event, { preventRender: true });\n      return ffd20.components.ItemAction.create([newActionData], { parent: this.item });\n    }\n\n    // Remove action\n    if (a.classList.contains(\"delete-action\")) {\n      const li = a.closest(\".action-part\");\n      const action = this.item.actions.get(li.dataset.itemId);\n\n      const deleteItem = async () => {\n        return action.delete();\n      };\n\n      if (getSkipActionPrompt()) {\n        deleteItem();\n      } else {\n        const msg = `<p>${game.i18n.localize(\"FFD20.DeleteItemConfirmation\")}</p>`;\n        Dialog.confirm({\n          title: game.i18n.format(\"FFD20.DeleteItemTitle\", { name: action.name }),\n          content: msg,\n          yes: () => {\n            deleteItem();\n          },\n          rejectClose: true,\n        });\n      }\n    }\n\n    // Duplicate action\n    if (a.classList.contains(\"duplicate-action\")) {\n      const li = a.closest(\".action-part\");\n      const action = deepClone(this.item.actions.get(li.dataset.itemId).data);\n      action.name = `${action.name} (${game.i18n.localize(\"FFD20.Copy\")})`;\n      action._id = randomID(16);\n      const actionParts = deepClone(this.item.system.actions ?? []);\n      return this._onSubmit(event, { updateData: { \"system.actions\": actionParts.concat(action) } });\n    }\n  }\n\n  async _onActionEdit(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const li = a.closest(\".action-part\");\n    const action = this.item.actions.get(li.dataset.itemId);\n\n    // Find existing window\n    for (const app of Object.values(this.item.apps)) {\n      if (app.object === action) {\n        app.render(true, { focus: true });\n        return;\n      }\n    }\n\n    // Open new window\n    const app = new ffd20.applications.component.ItemActionSheet(action);\n    app.render(true);\n  }\n\n  async _onBuffControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Add new change\n    if (a.classList.contains(\"add-change\")) {\n      await this._onSubmit(event, { preventRender: true });\n      return ffd20.components.ItemChange.create([{}], { parent: this.item });\n    }\n\n    // Remove a change\n    if (a.classList.contains(\"delete-change\")) {\n      const li = a.closest(\".change\");\n      const changes = deepClone(this.item.system.changes);\n      const change = changes.find((o) => o._id === li.dataset.change);\n      changes.splice(changes.indexOf(change), 1);\n      return this._onSubmit(event, { updateData: { \"system.changes\": changes } });\n    }\n  }\n  _onChangeTargetControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Prepare categories and changes to display\n    const change = this.item.changes.get(a.closest(\".change\").dataset.change);\n    const categories = getBuffTargetDictionary(this.item.actor);\n\n    const part1 = change?.subTarget?.split(\".\")[0];\n    const category = ffd20.config.buffTargets[part1]?.category ?? part1;\n\n    // Show widget\n    const w = new Widget_CategorizedItemPicker(\n      { title: \"FFD20.Application.ChangeTargetSelector.Title\", classes: [\"change-target-selector\"] },\n      categories,\n      (key) => {\n        if (key) {\n          change.update({ subTarget: key });\n        }\n      },\n      { category, item: change?.subTarget }\n    );\n    w.render(true);\n  }\n\n  async _onNoteControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Add new note\n    if (a.classList.contains(\"add-note\")) {\n      const contextNotes = this.item.system.contextNotes || [];\n      await this._onSubmit(event, {\n        updateData: { \"system.contextNotes\": contextNotes.concat([ItemPF.defaultContextNote]) },\n      });\n    }\n\n    // Remove a note\n    if (a.classList.contains(\"delete-note\")) {\n      const li = a.closest(\".context-note\");\n      const contextNotes = duplicate(this.item.system.contextNotes);\n      contextNotes.splice(Number(li.dataset.note), 1);\n      await this._onSubmit(event, {\n        updateData: { \"system.contextNotes\": contextNotes },\n      });\n    }\n  }\n\n  _onNoteTargetControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Prepare categories and changes to display\n    const li = a.closest(\".context-note\");\n    const noteIndex = Number(li.dataset.note);\n    const note = this.item.system.contextNotes[noteIndex];\n    const categories = getBuffTargetDictionary(this.item.actor, \"contextNotes\");\n\n    const part1 = note?.subTarget?.split(\".\")[0];\n    const category = ffd20.config.contextNoteTargets[part1]?.category ?? part1;\n\n    // Show widget\n    const w = new Widget_CategorizedItemPicker(\n      { title: \"FFD20.Application.ContextNoteTargetSelector.Title\" },\n      categories,\n      (key) => {\n        if (key) {\n          const updateData = {};\n          updateData[`system.contextNotes.${noteIndex}.subTarget`] = key;\n          this.item.update(updateData);\n        }\n      },\n      { category, item: note?.subTarget }\n    );\n    w.render(true);\n  }\n\n  async _onLinkControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Delete link\n    if (a.classList.contains(\"delete-link\")) {\n      const li = a.closest(\".links-item\");\n      const group = a.closest('div[data-group=\"links\"]');\n      const linkType = group.dataset.tab;\n\n      await this._onSubmit(event, { preventRender: true });\n\n      let links = deepClone(this.item.system.links?.[linkType] ?? []);\n      const { uuid, itemId } = li.dataset;\n      const link = links.find((o) => {\n        if (uuid) return o.uuid === uuid;\n        if (itemId) return o.id === itemId;\n        return false;\n      });\n      links = links.filter((o) => o !== link);\n\n      const updateData = {};\n      updateData[`system.links.${linkType}`] = links;\n\n      // Call hook for deleting a link\n      Hooks.callAll(\"pf1DeleteItemLink\", this.item, link, linkType);\n\n      await this.document.update(updateData);\n    }\n  }\n\n  async _onFilePickerAlt(event) {\n    const button = event.currentTarget;\n    const attr = button.dataset.for;\n    const current = getProperty(this.item.system, attr);\n    const form = button.form;\n    const targetField = form[attr];\n    if (!targetField) return;\n\n    const fp = new FilePicker({\n      type: button.dataset.type,\n      current: current,\n      callback: (path) => {\n        targetField.value = path;\n        if (this.options.submitOnChange) {\n          this._onSubmit(event);\n        }\n      },\n      top: this.position.top + 40,\n      left: this.position.left + 10,\n    });\n    fp.browse(current);\n  }\n\n  /**\n   * Makes a readonly text input editable, and focus it.\n   *\n   * @param event\n   * @private\n   */\n  _onInputText(event) {\n    event.preventDefault();\n    const elem = this.element.find(event.currentTarget.dataset.for);\n\n    elem.removeAttr(\"readonly\");\n    elem.attr(\"name\", event.currentTarget.dataset.attrName);\n    const { inputValue } = event.currentTarget.dataset;\n    let value = inputValue ?? getProperty(this.item, event.currentTarget.dataset.attrName);\n    elem.attr(\"value\", value);\n    elem.select();\n\n    elem.focusout((event) => {\n      if (typeof value === \"number\") value = value.toString();\n      if (value !== elem.attr(\"value\")) {\n        this._onSubmit(event);\n      } else {\n        this.render();\n      }\n    });\n  }\n\n  async _createAttack(event) {\n    if (this.item.actor == null) throw new Error(game.i18n.localize(\"FFD20.ErrorItemNoOwner\"));\n\n    await this._onSubmit(event, { preventRender: true });\n\n    await this.item.actor.createAttackFromWeapon(this.item);\n  }\n\n  async _createSpellbook(event) {\n    event.preventDefault();\n    if (this.item.actor == null) throw new Error(game.i18n.localize(\"FFD20.ErrorItemNoOwner\"));\n    await this._onSubmit(event, { preventRender: true });\n\n    await this.item.actor.createSpellbook({ ...this.item.system.casting, class: this.item.system.tag });\n\n    // HACK: The above does not re-render the item sheet for some reason\n    this.render();\n  }\n\n  _onEntrySelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const options = {\n      name: a.getAttribute(\"for\"),\n      title: a.innerText,\n      flag: a.dataset.flag === \"true\",\n      boolean: a.dataset.boolean === \"true\",\n      flat: a.dataset.flat === \"true\",\n      fields: a.dataset.fields,\n      dtypes: a.dataset.dtypes,\n    };\n    new ffd20.applications.EntrySelector(this.item, options).render(true);\n  }\n\n  _onEntryControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const key = a.closest(\".notes\").dataset.name;\n\n    if (a.classList.contains(\"add-entry\")) {\n      const notes = getProperty(this.document, key) ?? [];\n      const updateData = {};\n      updateData[key] = notes.concat(\"\");\n      return this._onSubmit(event, { updateData });\n    } else if (a.classList.contains(\"delete-entry\")) {\n      const index = a.closest(\".entry\").dataset.index;\n      const notes = duplicate(getProperty(this.document, key));\n      notes.splice(index, 1);\n\n      const updateData = {};\n      updateData[key] = notes;\n      return this._onSubmit(event, { updateData });\n    }\n  }\n\n  _selectOnClick(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    el.select();\n  }\n}\n\n/**\n * @typedef {object} DescriptionAttribute\n * @property {string} name - Data path to which the input will be written\n * @property {boolean} [fakeName] - Whether to show a value different from the one the `name` points to\n * @property {string} id\n * @property {boolean} [isNumber] - Whether the input is a number (text input)\n * @property {boolean} [isBoolean] - Whether the input is a boolean (checkbox)\n * @property {boolean} [isRange] - Whether this is a dual input for a value and a maximum value\n * @property {string} label - The label for the input\n * @property {string | boolean | number | {value: string | number, name: string}} value - The value that is show in the sidebar.\n *   Ranges require an object with `value` and `name` properties.\n * @property {{value: string | number, name: string}} [max] - Maximum value for a range input\n * @property {number} [decimals] - Number of decimals to display for `number`s\n * @property {string} [inputValue] - Value that will appear in the input field when it is edited,\n *                                   overriding the default value retrieved from the item data\n *                                   using {@link DescriptionAttribute#name}\n */\n","import { ItemSheetPF } from \"./item-sheet.mjs\";\nimport { splitCurrency } from \"../../utils/lib.mjs\";\nimport { getSkipActionPrompt } from \"../../documents/settings.mjs\";\nimport { createConsumableSpellDialog } from \"../../utils/lib.mjs\";\nimport { CurrencyTransfer } from \"../currency-transfer.mjs\";\nimport { getWeightSystem } from \"@utils\";\n\nexport class ItemSheetPF_Container extends ItemSheetPF {\n  constructor(...args) {\n    super(...args);\n\n    /**\n     * Track the set of item filters which are applied\n     *\n     * @type {Set}\n     */\n    this._filters = {\n      search: { container: \"\" },\n    };\n\n    /** Item search */\n    this.searchCompositioning = false; // for IME\n    this.searchRefresh = true; // Lock out same term search unless sheet also refreshes\n    this.searchDelay = 250; // arbitrary ?ms for arbitrarily decent reactivity; MMke this configurable?\n    this.searchDelayEvent = null; // setTimeout id\n    this.effectiveSearch = \"\"; // prevent searching the same thing\n\n    /**\n     * Track item updates from the actor sheet.\n     *\n     * @type {object[]}\n     */\n    this._itemUpdates = [];\n\n    /**\n     * Override item sheet initial tab.\n     * Assumes first tab definitionis the main tab.\n     */\n    this.options.tabs[0].initial = \"contents\"; // Doesn't actually do anything\n    this._tabs[0].active = \"contents\"; // Actual override\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      width: 800,\n      classes: [\"ffd20\", \"sheet\", \"item\"],\n      scrollY: [\".item-groups-list\"],\n      dragDrop: [\n        { dragSelector: \"li.item[data-item-id]\", dropSelector: '.tab[data-tab=\"contents\"]' },\n        { dragSelector: \"label.denomination\" },\n      ],\n    });\n  }\n\n  /**\n   * Return a dynamic reference to the HTML template path used to render this Item Sheet\n   *\n   * @returns {string}\n   */\n  get template() {\n    return \"systems/ffd20/templates/items/container.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare item sheet data\n   * Start with the base item data and extending with additional properties for rendering.\n   */\n  async getData() {\n    const data = await super.getData();\n\n    // Add filters\n    data.filters = this._filters;\n\n    // The item's items\n    data.items = this.item.items.reduce((cur, item) => {\n      const data = item.toObject();\n      cur.push(data);\n      data.document = item;\n      data.labels = item.getLabels();\n      data.hasAttack = item.hasAttack;\n      data.hasMultiAttack = item.hasMultiAttack;\n      data.hasDamage = item.hasDamage;\n      data.hasRange = item.hasRange;\n      data.hasEffect = item.hasEffect;\n      data.hasAction = item.hasAction || item.isCharged;\n      data.showUnidentifiedData = item.showUnidentifiedData;\n      data.name = item.name;\n      return cur;\n    }, []);\n    data.items.sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    // Show whether the item has currency\n    data.hasCurrency = Object.values(this.object.system.currency).some((o) => o > 0);\n\n    // Prepare inventory\n    this._prepareContents(data);\n\n    // Override description attributes\n    {\n      data.descriptionAttributes = [];\n\n      // Add weight\n      data.descriptionAttributes.push({\n        isNumber: true,\n        name: \"system.weight.value\",\n        fakeName: true,\n        label: game.i18n.localize(\"FFD20.Weight\"),\n        value: data.item.system.weight.converted.total,\n        inputValue: data.item.system.weight.converted.value,\n        decimals: 2,\n        id: \"data-weight-value\",\n      });\n\n      // Add price\n      if (data.showIdentifyDescription) {\n        data.descriptionAttributes.push(\n          {\n            isNumber: true,\n            name: \"system.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: data.item.system.price,\n            id: \"data-price\",\n          },\n          {\n            isNumber: true,\n            name: \"system.unidentified.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.UnidentifiedPriceShort\"),\n            value: data.item.system.unidentified?.price,\n            id: \"data-unidentifiedPrice\",\n          }\n        );\n      } else {\n        if (data.showUnidentifiedData) {\n          data.descriptionAttributes.push({\n            isNumber: true,\n            name: \"system.unidentified.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: data.item.system.unidentified?.price,\n            id: \"data-price\",\n          });\n        } else {\n          data.descriptionAttributes.push({\n            isNumber: true,\n            name: \"system.price\",\n            fakeName: true,\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: data.item.system.price,\n            id: \"data-price\",\n          });\n        }\n      }\n\n      // Add hit points\n      data.descriptionAttributes.push({\n        isRange: true,\n        label: game.i18n.localize(\"FFD20.HPShort\"),\n        value: {\n          name: \"system.hp.value\",\n          value: data.item.system.hp?.value,\n        },\n        max: {\n          name: \"system.hp.max\",\n          value: data.item.system.hp?.max,\n        },\n      });\n\n      // Add hardness\n      data.descriptionAttributes.push({\n        isNumber: true,\n        label: game.i18n.localize(\"FFD20.Hardness\"),\n        name: \"system.hardness\",\n        value: data.item.system.hardness,\n      });\n\n      // Add carried flag\n      data.descriptionAttributes.push({\n        isBoolean: true,\n        name: \"system.carried\",\n        label: game.i18n.localize(\"FFD20.Carried\"),\n        value: data.item.system.carried,\n      });\n    }\n\n    // Get contents weight\n    const usystem = getWeightSystem();\n    data.weight = {\n      contents: this.item.system.weight.converted.contents,\n      units: usystem === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\"),\n    };\n\n    // Get contents value\n    const cgilValue =\n      this.item.getValue({ sellValue: 1, inLowestDenomination: true }) -\n      this.item.getValue({ recursive: false, sellValue: 1, inLowestDenomination: true });\n    const cgilSellValue =\n      this.item.getValue({ inLowestDenomination: true }) -\n      this.item.getValue({ recursive: false, inLowestDenomination: true });\n\n    data.totalValue = splitCurrency(cgilValue);\n    data.sellValue = splitCurrency(cgilSellValue);\n\n    // Set labels\n    if (!data.labels) data.labels = {};\n    data.labels.totalValue = game.i18n.format(\"FFD20.ItemContainerTotalValue\", data.totalValue);\n    data.labels.sellValue = game.i18n.format(\"FFD20.ItemContainerSellValue\", data.sellValue);\n\n    return data;\n  }\n\n  _prepareContents(data) {\n    // Categorize items as inventory, spellbook, features, and classes\n    const inventory = {\n      weapon: {\n        label: game.i18n.localize(\"FFD20.InventoryWeapons\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"weapon\" },\n      },\n      equipment: {\n        label: game.i18n.localize(\"FFD20.InventoryArmorEquipment\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"equipment\" },\n        hasSlots: true,\n      },\n      consumable: {\n        label: game.i18n.localize(\"FFD20.InventoryConsumables\"),\n        canCreate: true,\n        hasActions: true,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"consumable\" },\n      },\n      gear: {\n        label: ffd20.config.lootTypes[\"gear\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.LootTypeGearSingle\"), \"sub-type\": \"gear\" },\n      },\n      ammo: {\n        label: ffd20.config.lootTypes[\"ammo\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.LootTypeAmmoSingle\"), \"sub-type\": \"ammo\" },\n      },\n      misc: {\n        label: ffd20.config.lootTypes[\"misc\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: { type: \"loot\", \"type-name\": game.i18n.localize(\"FFD20.Misc\"), \"sub-type\": \"misc\" },\n      },\n      tradeGoods: {\n        label: ffd20.config.lootTypes[\"tradeGoods\"],\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        canEquip: false,\n        dataset: {\n          type: \"loot\",\n          \"type-name\": game.i18n.localize(\"FFD20.LootTypeTradeGoodsSingle\"),\n          \"sub-type\": \"tradeGoods\",\n        },\n      },\n      container: {\n        label: game.i18n.localize(\"FFD20.InventoryContainers\"),\n        canCreate: true,\n        hasActions: false,\n        items: [],\n        dataset: { type: \"container\" },\n      },\n    };\n\n    // Partition items by category\n    const items = data.items.reduce((arr, item) => {\n      item.img = item.img || DEFAULT_TOKEN;\n      item.isStack = item.system.quantity ? item.system.quantity > 1 : false;\n      item.hasUses = item.system.uses && item.system.uses.max > 0;\n      item.isCharged = [\"day\", \"week\", \"charges\"].includes(item.system.uses?.per);\n      item.price = item.system.identified === false ? item.system.unidentified.price : item.system.price;\n\n      const itemQuantity = item.system.quantity ?? 1;\n      const itemCharges = item.system.uses?.value ?? 1;\n      item.empty = itemQuantity <= 0 || (item.isCharged && itemCharges <= 0);\n      arr.push(item);\n      return arr;\n    }, []);\n\n    // Organize Inventory\n    const usystem = getWeightSystem();\n    const units = usystem === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\");\n    for (const i of items) {\n      const subType = i.type === \"loot\" ? i.system.subType || \"gear\" : i.system.subType;\n      i.system.quantity ??= 0;\n      i.totalWeight = Math.roundDecimals(i.document.system.weight.converted.total, 2);\n      i.units = units;\n      if (inventory[i.type] != null) inventory[i.type].items.push(i);\n      // Only loot has subType specific sections\n      if (i.type === \"loot\") inventory[subType]?.items.push(i);\n    }\n\n    data.inventory = Object.values(inventory);\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    /* -------------------------------------------- */\n    /*  Inventory\n    /* -------------------------------------------- */\n\n    // Owned Item management\n    html.find(`.tab[data-tab=\"contents\"] .item-create`).click((ev) => this._onItemCreate(ev));\n    html.find(`.tab[data-tab=\"contents\"] .item-edit`).click(this._onItemEdit.bind(this));\n    html.find(`.tab[data-tab=\"contents\"] .item-delete`).click(this._onItemDelete.bind(this));\n    html.find(`.tab[data-tab=\"contents\"] .item-take`).click(this._onItemTake.bind(this));\n\n    // Quick edit item\n    html.find(\".item .item-name\").contextmenu(this._onItemEdit.bind(this));\n\n    // Quick (un)identify item\n    html.find(\"a.item-control.item-identify\").click((ev) => {\n      this._quickIdentifyItem(ev);\n    });\n\n    // Duplicate item\n    html.find(\"a.item-control.item-duplicate\").click(this._duplicateItem.bind(this));\n\n    // Quick add item quantity\n    html.find(\"a.item-control.item-quantity-add\").click((ev) => {\n      this._quickChangeItemQuantity(ev, 1);\n    });\n    // Quick subtract item quantity\n    html.find(\"a.item-control.item-quantity-subtract\").click((ev) => {\n      this._quickChangeItemQuantity(ev, -1);\n    });\n\n    // Quick Item Action control\n    html.find(\".item-actions a\").click((ev) => this._quickItemActionControl(ev));\n\n    // Set item uses\n    html\n      .find(\".item-detail.item-uses input[type='text']:not(:disabled)\")\n      .off(\"change\")\n      .change(this._setItemUses.bind(this))\n      .on(\"wheel\", this._setItemUses.bind(this));\n\n    // Convert currency\n    html.find(\"a.convert-currency\").click(this._convertCurrency.bind(this));\n\n    // Item Rolling\n    html.find(\".item .item-image\").click((event) => this._onItemRoll(event));\n\n    // Search box\n    const sb = html.find(\".search-input\");\n    sb.on(\"keyup change\", this._searchFilterChange.bind(this));\n    sb.on(\"compositionstart compositionend\", this._searchFilterCompositioning.bind(this)); // for IME\n    this.searchRefresh = true;\n    // Filter following refresh\n    sb.each(function () {\n      if (this.value.length > 0) $(this).change();\n    });\n    html.find(\".clear-search\").on(\"click\", this._clearSearch.bind(this));\n  }\n\n  _onItemCreate(event) {\n    event.preventDefault();\n    const header = event.currentTarget;\n    const type = header.dataset.type;\n    const typeName = header.dataset.typeName || header.dataset.type;\n    const itemData = {\n      name: `New ${typeName.capitalize()}`,\n      type: type,\n      system: duplicate(header.dataset),\n    };\n    delete itemData.system.type;\n    delete itemData.system.typeName;\n\n    return this.item.createContainerContent(itemData);\n  }\n\n  _onItemEdit(event) {\n    event.preventDefault();\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.item.getContainerContent(li.dataset.itemId);\n\n    item.sheet.render(true, { focus: true, editable: this.isEditable });\n  }\n\n  _onItemDelete(event) {\n    event.preventDefault();\n\n    const button = event.currentTarget;\n    if (button.disabled) return;\n\n    const li = event.currentTarget.closest(\".item\");\n    if (getSkipActionPrompt()) {\n      this.item.deleteContainerContent(li.dataset.itemId);\n    } else {\n      button.disabled = true;\n\n      const item = this.document.items.get(li.dataset.itemId);\n\n      const msg = `<p>${game.i18n.localize(\"FFD20.DeleteItemConfirmation\")}</p>`;\n      Dialog.confirm({\n        title: game.i18n.format(\"FFD20.DeleteItemTitle\", { name: item.name }),\n        content: msg,\n        yes: () => {\n          this.item.deleteContainerContent(li.dataset.itemId);\n          button.disabled = false;\n        },\n        no: () => (button.disabled = false),\n        rejectClose: true,\n      }).then(null, () => (button.disabled = false));\n    }\n  }\n\n  async _onItemTake(event) {\n    event.preventDefault();\n\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.item.getContainerContent(li.dataset.itemId);\n\n    if (this.actor) {\n      await this.actor.createEmbeddedDocuments(\"Item\", [item.toObject()]);\n      await this.item.deleteContainerContent(item._id);\n    }\n  }\n\n  _onDragStart(event) {\n    // Skip document links, since they should be handled differently\n    if (event.target.classList.contains(\"entity-link\")) return;\n\n    // Create drag data for an owned item\n    const elem = event.currentTarget;\n    let dragData;\n    if (elem.classList.contains(\"denomination\")) {\n      if (!this.item.testUserPermission(game.user, 3)) return;\n      dragData = {\n        type: \"Currency\",\n        alt: elem.classList.contains(\"alt-currency\"),\n        currency: [...elem.classList].find((o) => /[pgsc]p/.test(o)),\n        containerId: this.item.id,\n        amount: parseInt(elem.nextElementSibling.textContent || elem.nextElementSibling.value),\n      };\n    } else {\n      const item = this.item.getContainerContent(elem.dataset.itemId);\n      dragData = {\n        type: \"Item\",\n        data: item.toObject(),\n        containerId: this.item.id,\n      };\n      dragData.itemId = item.id;\n      // Core bug: sidebar drop breaks in v10 without this, works fine in v11 without\n      delete dragData.data._id;\n    }\n\n    // Add actor to drag data\n    dragData.actorUuid = this.item.actor?.uuid;\n\n    // Set data transfer\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n  }\n\n  _onDrop(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Try to extract the data\n    let data;\n    try {\n      data = JSON.parse(event.dataTransfer.getData(\"text/plain\"));\n    } catch (err) {\n      return false;\n    }\n    const item = this.item;\n\n    // Handle the drop with a Hooked function\n    const allowed = Hooks.call(\"pf1DropContainerSheetData\", item, this, data);\n    if (allowed === false) return;\n\n    // Handle different data types\n    switch (data.type) {\n      case \"Item\":\n        return this._onDropItem(event, data);\n      case \"Currency\": {\n        return this._onDropCurrency(event, data);\n      }\n    }\n  }\n\n  async _onDropCurrency(event, data) {\n    let sourceActor = await fromUuid(data.actorUuid || \"\");\n    if (!(sourceActor instanceof Actor)) sourceActor = sourceActor?.actor;\n\n    return new CurrencyTransfer(\n      { actor: sourceActor, container: data.containerId, alt: data.alt },\n      {\n        actor: this.actor,\n        container: this.item.id,\n        amount: Object.fromEntries([[data.currency, parseInt(data.amount)]]),\n      }\n    ).render(true);\n  }\n\n  async _onDropItem(event, data) {\n    if (!this.item.isOwner) return false;\n\n    const { actorUuid, containerId } = data;\n    let sourceActor = await fromUuid(actorUuid || \"\");\n    if (!(sourceActor instanceof Actor)) sourceActor = sourceActor?.actor;\n\n    const item = await Item.implementation.fromDropData(data);\n    sourceActor ??= item.actor;\n\n    const itemData = item.toObject();\n\n    const sameActor = sourceActor && sourceActor === this.item.actor;\n\n    // Sort item\n    if (sameActor && containerId === this.item.id) {\n      return this._onSortItem(event, itemData);\n    }\n\n    // Create consumable from spell\n    if (itemData.type === \"spell\") {\n      const resultData = await createConsumableSpellDialog(itemData, { allowSpell: false });\n      if (resultData) return this.item.createContainerContent(resultData);\n      else return false;\n    }\n\n    // Create or transfer item\n    if (item.isPhysical) {\n      await this.item.createContainerContent(itemData);\n      // TODO: Verify item was created so we don't delete source item without reason\n\n      if (sameActor) {\n        if (containerId) {\n          sourceActor.containerItems\n            .find((i) => i.id === data.itemId && i.parentItem?.id === containerId)\n            ?.parentItem.deleteContainerContent(data.itemId);\n        } else {\n          sourceActor.items.get(item.id)?.delete();\n        }\n      }\n    }\n  }\n\n  async _quickIdentifyItem(event) {\n    event.preventDefault();\n    if (!game.user.isGM) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.ErrorCantIdentify\"));\n    }\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.getContainerContent(itemId);\n\n    const isIdentified = item.system.identified;\n    if (isIdentified !== undefined) {\n      return item.update({ \"system.identified\": !isIdentified });\n    }\n  }\n\n  async _duplicateItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const itemId = $(a).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.getContainerContent(itemId);\n    const data = duplicate(item.data);\n\n    delete data._id;\n    data.name = `${data.name} (${game.i18n.localize(\"FFD20.Copy\")})`;\n    if (item.isPhysical && !item.system.identified) {\n      data.system.unidentified.name = `${item.system.unidentified.name} (${game.i18n.localize(\"FFD20.Copy\")})`;\n    }\n    if (data.system.links?.children) delete data.system.links.children;\n\n    return this.item.createContainerContent(data);\n  }\n\n  async _quickChangeItemQuantity(event, add = 1) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.getContainerContent(itemId);\n\n    const curQuantity = item.system.quantity || 0;\n    const newQuantity = Math.max(0, curQuantity + add);\n    return item.update({ \"system.quantity\": newQuantity });\n  }\n\n  /**\n   * Handles click events to trigger the use of an item.\n   *\n   * @protected\n   * @param {MouseEvent} event - The originating click event\n   */\n  _quickItemActionControl(event) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest(\".item\").attr(\"data-item-id\");\n    const item = this.item.getContainerContent(itemId);\n    item.use({ ev: event });\n  }\n\n  async _setItemUses(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.item.getContainerContent(itemId);\n\n    this._mouseWheelAdd(event.originalEvent, el);\n\n    const value = Number(el.value);\n    this.setItemUpdate(item._id, \"system.uses.value\", value);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      if (!this._submitQueued) {\n        $(el).one(\"mouseleave\", (event) => {\n          this._updateItems();\n        });\n      }\n    } else this._updateItems();\n  }\n\n  async _updateItems() {\n    const promises = [];\n\n    const updates = duplicate(this._itemUpdates);\n    this._itemUpdates = [];\n\n    for (const data of updates) {\n      const item = this.item.items.filter((o) => {\n        return o._id === data._id;\n      })[0];\n      if (item == null) continue;\n\n      delete data._id;\n      if (item.testUserPermission(game.user, \"OWNER\")) promises.push(item.update(data));\n    }\n\n    return Promise.all(promises);\n  }\n\n  setItemUpdate(id, key, value) {\n    let obj = this._itemUpdates.filter((o) => {\n      return o._id === id;\n    })[0];\n    if (obj == null) {\n      obj = { _id: id };\n      this._itemUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  _mouseWheelAdd(event, el) {\n    if (event && event instanceof WheelEvent) {\n      const value = parseFloat(el.value);\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(event.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n      el.value = value + amount * increase;\n    }\n  }\n\n  _convertCurrency(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const currencyType = a.dataset.type;\n\n    this.item.convertCurrency(currencyType);\n  }\n\n  /**\n   * @override\n   */\n  _onSortItem(event, itemData) {\n    const items = this.document.items;\n\n    // Get the drag source and its siblings\n    const source = items.get(itemData._id);\n\n    // Get the drop target\n    const dropTarget = event.target.closest(\".item\");\n    const targetId = dropTarget ? dropTarget.dataset.itemId : null;\n    const target = items.get(targetId);\n\n    // Don't sort on yourself\n    if (targetId === source.id) return;\n\n    // Identify sibling items based on adjacent HTML elements\n    const siblings = [];\n    for (const el of dropTarget.parentElement.children) {\n      const siblingId = el.dataset.itemId;\n      if (siblingId && siblingId !== source.id) {\n        const item = items.get(el.dataset.itemId);\n        // Only take same typed siblings\n        if (item.type !== source.type) continue;\n        siblings.push(item);\n      }\n    }\n\n    // Don't sort if target has no siblings\n    if (siblings.length == 0) return;\n\n    // Perform the sort\n    const sortUpdates = SortingHelpers.performIntegerSort(source, { target, siblings });\n    const updateData = sortUpdates.map((u) => {\n      const update = u.update;\n      update._id = u.target._id;\n      return update;\n    });\n\n    // Perform the update\n    return this.item.updateContainerContents(updateData);\n  }\n\n  /**\n   * Handle rolling of an item from the Actor sheet, obtaining the Item instance and dispatching to it's roll method\n   *\n   * @param event\n   * @private\n   */\n  _onItemRoll(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.item.getContainerContent(itemId);\n\n    if (item == null) return;\n    return item.displayCard();\n  }\n\n  /** Item Search */\n\n  _searchFilterCommit(event) {\n    const container = this.item;\n    const search = this._filters.search.container.toLowerCase();\n\n    // TODO: Do not refresh if same search term, unless the sheet has updated.\n    if (this.effectiveSearch === search && !this.searchRefresh) return;\n\n    this.effectiveSearch = search;\n    this.searchRefresh = false;\n\n    const matchSearch = (name) => name.toLowerCase().includes(search); // MKAhvi: Bad method for i18n support.\n\n    $(event.target)\n      .closest(\".tab\")\n      .find(\".item-list .item\")\n      .each(function () {\n        const jq = $(this);\n        if (search?.length > 0) {\n          const item = container.items.get(this.dataset.itemId);\n          if (matchSearch(item.name)) jq.show();\n          else jq.hide();\n        } else jq.show();\n      });\n  }\n\n  _clearSearch(event) {\n    this._filters.search.container = \"\";\n    $(event.target).prev(\".search-input\").val(\"\").change();\n  }\n\n  // IME related\n  _searchFilterCompositioning(event) {\n    this.searchCompositioning = event.type === \"compositionstart\";\n  }\n\n  _searchFilterChange(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Accept input only while not compositioning\n\n    const search = event.target.value;\n    const changed = this._filters.search.container !== search;\n\n    if (this.searchCompositioning || changed) clearTimeout(this.searchDelayEvent); // reset\n    if (this.searchCompositioning) return;\n\n    this._filters.search.container = search;\n\n    if (event.type === \"keyup\") {\n      // Delay search\n      if (changed) this.searchDelayEvent = setTimeout(() => this._searchFilterCommit(event), this.searchDelay);\n    } else this._searchFilterCommit(event);\n  }\n}\n","import { createTag } from \"../../utils/lib.mjs\";\n\nexport class ItemActionSheet extends FormApplication {\n  constructor(...args) {\n    super(...args);\n\n    this.item.apps[this.appId] = this;\n    this.action.apps[this.appId] = this;\n    this.action.sheet = this;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/apps/item-action.hbs\",\n      classes: [\"ffd20\", \"item\", \"sheet\", \"item-action\"],\n      width: 580,\n      height: 720,\n      closeOnSubmit: false,\n      submitOnClose: true,\n      submitOnChange: true,\n      resizable: true,\n      scrollY: [\".tab\"],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"description\",\n          group: \"primary\",\n        },\n      ],\n      dragDrop: [\n        {\n          dragSelector: \"li.conditional\",\n          dropSelector: 'div[data-tab=\"conditionals\"]',\n        },\n      ],\n    });\n  }\n  get title() {\n    return `${this.item.name}: ${this.action.name}`;\n  }\n  get id() {\n    if (this.actor) return `actor-${this.actor.id}-item-${this.item.id}-action-${this.action.id}`;\n    return `item-${this.item.id}-action-${this.action.id}`;\n  }\n\n  get action() {\n    return this.object;\n  }\n  get item() {\n    return this.action.item;\n  }\n  get actor() {\n    return this.item.actor;\n  }\n\n  async getData() {\n    const data = await super.getData();\n    data.action = this.action;\n    data.item = this.item;\n    data.actor = this.actor;\n    data.data = foundry.utils.mergeObject(this.action.constructor.defaultData, deepClone(this.action.data), {\n      inplace: false,\n    });\n    data.damageTypes = ffd20.registry.damageTypes.toObject();\n    data.rollData = this.object.getRollData();\n\n    // Set tag\n    data.tag = createTag(data.action.name);\n\n    // Include CONFIG values\n    data.config = ffd20.config;\n\n    // Action Details\n    data.hasAttackRoll = this.action.hasAttack;\n    data.isHealing = data.data.actionType === \"heal\";\n    data.isCombatManeuver = [\"mcman\", \"rcman\"].includes(data.data.actionType);\n    data.hasAttack = [\"mwak\", \"rwak\", \"msak\", \"rsak\", \"mcman\", \"rcman\"].includes(data.data.actionType);\n    // Can have crit and non-crit damage, or simply show them if they've been defined.\n    data.hasCritDamage = data.hasAttack || data.data.damage?.critParts?.length > 0;\n    data.hasNonCritDamage = data.hasAttack || data.data.damage?.nonCritParts?.length > 0;\n\n    data.isCharged = this.action.isCharged;\n    data.isSelfCharged = this.action.isSelfCharged;\n    data.showMaxChargeFormula = [\"day\", \"week\", \"charges\"].includes(data.data.uses.self.per);\n    if (this.action.hasRange) {\n      data.canInputRange = [\"ft\", \"mi\", \"spec\"].includes(data.data.range.units);\n      data.canInputMinRange = [\"ft\", \"mi\", \"spec\"].includes(data.data.range.minUnits);\n    }\n    if (data.data.duration != null) {\n      data.canInputDuration = ![\"\", \"inst\", \"perm\", \"seeText\"].includes(data.data.duration.units);\n    }\n\n    // Action Details\n    data.itemName = data.item.name;\n    data.itemEnh = data.item.system.enh || 0;\n    data.isSpell = this.item.type === \"spell\";\n    data.usesSpellPoints = this.item.spellbook?.spellPoints.useSystem;\n    data.defaultChargeFormula = this.item.getDefaultChargeFormula();\n    data.canUseAmmo = this.action.data.usesAmmo !== undefined;\n    data.owned = this.item.actor != null;\n    data.parentOwned = this.actor != null;\n    data.owner = this.item.isOwner;\n    data.isGM = game.user.isGM;\n    data.unchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n    data.activation = this.action.activation;\n    data.hasActivationType = data.activation.type;\n    data.abilityActivationTypes = data.unchainedActionEconomy\n      ? ffd20.config.abilityActivationTypes_unchained\n      : ffd20.config.abilityActivationTypes;\n\n    // Add description\n    data.descriptionHTML = await TextEditor.enrichHTML(data.data.description, {\n      secrets: data.owner,\n      rollData: data.rollData,\n      async: true,\n    });\n\n    // Show additional ranged properties\n    data.showMaxRangeIncrements = data.data.range.units === \"ft\";\n\n    // Prepare attack specific stuff\n    if (data.item.type === \"attack\") {\n      data.isWeaponAttack = data.item.system.subType === \"weapon\";\n      data.isNaturalAttack = data.item.system.subType === \"natural\";\n    }\n\n    // Add distance units\n    data.distanceUnits = deepClone(ffd20.config.distanceUnits);\n    if (this.item.type !== \"spell\") {\n      for (const d of [\"close\", \"medium\", \"long\"]) {\n        delete data.distanceUnits[d];\n      }\n    }\n\n    // Prepare stuff for actions with conditionals\n    if (data.data.conditionals) {\n      for (const conditional of data.data.conditionals) {\n        for (const modifier of conditional.modifiers) {\n          modifier.targets = this.object.getConditionalTargets();\n          modifier.subTargets = this.object.getConditionalSubTargets(modifier.target);\n          modifier.conditionalModifierTypes = this.object.getConditionalModifierTypes(modifier.target);\n          modifier.conditionalCritical = this.object.getConditionalCritical(modifier.target);\n        }\n      }\n    }\n\n    return data;\n  }\n\n  /**\n   * Copy from core DocumentSheet#isEditable\n   */\n  get isEditable() {\n    const parentItem = this.object.item;\n    let editable = this.options.editable && parentItem.isOwner;\n    if (parentItem.pack) {\n      const pack = game.packs.get(parentItem.pack);\n      if (pack.locked) editable = false;\n    }\n    return editable;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    if (!this.isEditable) return;\n\n    // Modify action image\n    html.find(`img[data-edit=\"img\"]`).on(\"click\", this._onEditImage.bind(this));\n\n    // Add drop handler to textareas\n    html.find(\"textarea, .notes input[type='text']\").on(\"drop\", this._onTextAreaDrop.bind(this));\n\n    // Modify attack formula\n    html.find(\".attack-control\").click(this._onAttackControl.bind(this));\n\n    // Modify damage formula\n    html.find(\".damage-control\").click(this._onDamageControl.bind(this));\n    html.find(\".damage-type-visual\").on(\"click\", this._onClickDamageType.bind(this));\n\n    // Listen to field entries\n    html.find(\".entry-selector\").click(this._onEntrySelector.bind(this));\n    html.find(\".entry-control a\").click(this._onEntryControl.bind(this));\n\n    // Modify conditionals\n    html.find(\".conditional-control\").click(this._onConditionalControl.bind(this));\n\n    // Handle alternative file picker\n    html.find(\".file-picker-alt\").click(this._onFilePickerAlt.bind(this));\n  }\n\n  _onDragStart(event) {\n    const elem = event.currentTarget;\n\n    // Drag conditional\n    if (elem.dataset?.conditional) {\n      const conditional = this.object.conditionals.get(elem.dataset?.conditional);\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(conditional.data));\n    }\n  }\n\n  /**\n   * Foundry defauts to isGM check.\n   *\n   * @override\n   */\n  _canDragStart(selector) {\n    return this.isEditable;\n  }\n\n  /**\n   * Foundry defauts to isGM check.\n   *\n   * @override\n   */\n  _canDragDrop(selector) {\n    return this.isEditable;\n  }\n\n  async _onDrop(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    let data, type;\n    try {\n      data = JSON.parse(event.dataTransfer.getData(\"text/plain\"));\n      // Surface-level check for conditional\n      if (data.default != null && typeof data.name === \"string\" && Array.isArray(data.modifiers)) type = \"conditional\";\n    } catch (e) {\n      return false;\n    }\n\n    const action = this.object;\n    // Handle conditionals\n    if (type === \"conditional\") {\n      // Check targets and other fields for valid values, reset if necessary\n      for (const modifier of data.modifiers) {\n        if (!Object.keys(action.getConditionalTargets()).includes(modifier.target)) modifier.target = \"\";\n        let keys;\n        for (let [k, v] of Object.entries(modifier)) {\n          switch (k) {\n            case \"subTarget\":\n              keys = Object.keys(action.getConditionalSubTargets(modifier.target));\n              break;\n            case \"type\":\n              keys = Object.keys(action.getConditionalModifierTypes(modifier.target));\n              break;\n            case \"critical\":\n              keys = Object.keys(action.getConditionalCritical(modifier.target));\n              break;\n          }\n          if (!keys?.includes(v)) v = keys?.[0] ?? \"\";\n        }\n      }\n\n      // Renew conditional ID\n      data._id = randomID(16);\n\n      // Append conditional\n      const conditionals = deepClone(action.data.conditionals || []).concat(data);\n      await this.object.update({ conditionals: conditionals });\n    }\n  }\n\n  _onEntrySelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const options = {\n      name: a.getAttribute(\"for\"),\n      title: a.innerText,\n      flag: a.dataset.flag === \"true\",\n      boolean: a.dataset.boolean === \"true\",\n      flat: a.dataset.flat === \"true\",\n      fields: a.dataset.fields,\n      dtypes: a.dataset.dtypes,\n    };\n    new ffd20.applications.EntrySelector(this.object, options).render(true);\n  }\n\n  _onEntryControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const key = a.closest(\".notes\").dataset.name;\n\n    if (a.classList.contains(\"add-entry\")) {\n      const notes = deepClone(getProperty(this.object.data, key) ?? []);\n      const updateData = { [key]: notes.concat(\"\") };\n      return this._onSubmit(event, { updateData });\n    } else if (a.classList.contains(\"delete-entry\")) {\n      const index = a.closest(\".entry\").dataset.index;\n      const notes = deepClone(getProperty(this.object.data, key));\n      notes.splice(index, 1);\n\n      const updateData = {};\n      updateData[key] = notes;\n      return this._onSubmit(event, { updateData });\n    }\n  }\n\n  async _onConditionalControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Add new conditional\n    if (a.classList.contains(\"add-conditional\")) {\n      await this._onSubmit(event, { preventRender: true }); // Submit any unsaved changes\n      return ffd20.components.ItemConditional.create([{}], { parent: this.object });\n    }\n\n    // Remove a conditional\n    if (a.classList.contains(\"delete-conditional\")) {\n      await this._onSubmit(event, { preventRender: true }); // Submit any unsaved changes\n      const li = a.closest(\".conditional\");\n      const conditional = this.object.conditionals.get(li.dataset.conditional);\n      return conditional.delete();\n    }\n\n    // Add a new conditional modifier\n    if (a.classList.contains(\"add-conditional-modifier\")) {\n      await this._onSubmit(event, { preventRender: true });\n      const li = a.closest(\".conditional\");\n      const conditional = this.object.conditionals.get(li.dataset.conditional);\n      return ffd20.components.ItemConditionalModifier.create([{}], { parent: conditional });\n    }\n\n    // Remove a conditional modifier\n    if (a.classList.contains(\"delete-conditional-modifier\")) {\n      await this._onSubmit(event, { preventRender: true });\n      const li = a.closest(\".conditional-modifier\");\n      const conditional = this.object.conditionals.get(li.dataset.conditional);\n      const modifier = conditional.modifiers.get(li.dataset.modifier);\n      return modifier.delete();\n    }\n  }\n\n  /**\n   * Add or remove a damage part from the damage formula\n   *\n   * @param {Event} event     The original click event\n   * @returns {Promise}\n   * @private\n   */\n  async _onDamageControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const list = a.closest(\".damage\");\n    const path = list.dataset.key || \"damage.parts\";\n    const k2 = path.split(\".\").slice(0, -1).join(\".\");\n    const k3 = path.split(\".\").slice(-1).join(\".\");\n\n    // Add new damage component\n    if (a.classList.contains(\"add-damage\")) {\n      // Get initial data\n      const damageTypeBase = ffd20.components.ItemAction.defaultDamageType;\n      const initialData = {\n        formula: \"\",\n        type: damageTypeBase,\n      };\n\n      // Add data\n      const damage = getProperty(this.action.data, k2);\n      const updateData = {};\n      updateData[path] = getProperty(damage, k3).concat([initialData]);\n      return this._onSubmit(event, { updateData });\n    }\n\n    // Remove a damage component\n    if (a.classList.contains(\"delete-damage\")) {\n      const li = a.closest(\".damage-part\");\n      const damage = deepClone(getProperty(this.action.data, k2));\n      getProperty(damage, k3).splice(Number(li.dataset.damagePart), 1);\n      const updateData = {};\n      updateData[path] = getProperty(damage, k3);\n      return this._onSubmit(event, { updateData });\n    }\n  }\n\n  async _onClickDamageType(event) {\n    event.preventDefault();\n    const clickedElement = event.currentTarget;\n\n    // Check for normal damage part\n    const damageIndex = clickedElement.closest(\".damage-part\")?.dataset.damagePart;\n    const damagePart = clickedElement.closest(\".damage\")?.dataset.key;\n    if (damageIndex != null && damagePart != null) {\n      const app = new ffd20.applications.DamageTypeSelector(\n        this.object,\n        `${damagePart}.${damageIndex}.type`,\n        getProperty(this.object.data, damagePart)[damageIndex].type\n      );\n      return app.render(true);\n    }\n\n    // Check for conditional\n    const conditionalElement = clickedElement.closest(\".conditional\");\n    const modifierElement = clickedElement.closest(\".conditional-modifier\");\n    if (conditionalElement && modifierElement) {\n      const conditional = this.object.conditionals.get(conditionalElement.dataset.conditional);\n      const modifier = conditional.modifiers.get(modifierElement.dataset.modifier);\n      const app = new ffd20.applications.DamageTypeSelector(modifier, \"damageType\", modifier.data.damageType);\n      return app.render(true);\n    }\n  }\n\n  async _onAttackControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Add new attack component\n    if (a.classList.contains(\"add-attack\")) {\n      const attackParts = this.action.data.attackParts;\n      return this._onSubmit(event, { updateData: { attackParts: attackParts.concat([[\"\", \"\"]]) } });\n    }\n\n    // Remove an attack component\n    if (a.classList.contains(\"delete-attack\")) {\n      const li = a.closest(\".attack-part\");\n      const attackParts = deepClone(this.action.data.attackParts);\n      attackParts.splice(Number(li.dataset.attackPart), 1);\n      return this._onSubmit(event, { updateData: { attackParts: attackParts } });\n    }\n  }\n\n  async _onFilePickerAlt(event) {\n    const button = event.currentTarget;\n    const attr = button.dataset.for;\n    const current = getProperty(this.item.data, attr);\n    const form = button.form;\n    const targetField = form[attr];\n    if (!targetField) return;\n\n    const fp = new FilePicker({\n      type: button.dataset.type,\n      current: current,\n      callback: (path) => {\n        targetField.value = path;\n        if (this.options.submitOnChange) {\n          this._onSubmit(event);\n        }\n      },\n      top: this.position.top + 40,\n      left: this.position.left + 10,\n    });\n    fp.browse(current);\n  }\n\n  async _onEditImage(event) {\n    event.preventDefault();\n    const filePicker = new FilePicker({\n      type: \"image\",\n      current: this.action.data.img,\n      callback: async (path) => {\n        await this.action.update({ img: path });\n        return this.render();\n      },\n    });\n    filePicker.render();\n  }\n\n  async _onTextAreaDrop(event) {\n    event.preventDefault();\n\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const elem = event.currentTarget;\n    const link = await TextEditor.getContentLink(eventData);\n\n    // Insert link\n    if (link) {\n      elem.value = !elem.value ? link : elem.value + \"\\n\" + link;\n    }\n    return this._onSubmit(event);\n  }\n\n  async _updateObject(event, formData) {\n    // Handle conditionals array\n    const conditionalData = deepClone(this.object.data.conditionals);\n    Object.entries(formData)\n      .filter((o) => o[0].startsWith(\"conditionals\"))\n      .forEach((o) => {\n        let reResult;\n        // Handle conditional modifier\n        if ((reResult = o[0].match(/^conditionals.([0-9]+).modifiers.([0-9]+).(.+)$/))) {\n          const conditionalIdx = parseInt(reResult[1]);\n          const modifierIdx = parseInt(reResult[2]);\n          const conditional =\n            conditionalData[conditionalIdx] ?? deepClone(this.object.data.conditionals[conditionalIdx]);\n          const path = reResult[3];\n          setProperty(conditional.modifiers[modifierIdx], path, o[1]);\n        }\n        // Handle conditional\n        else if ((reResult = o[0].match(/^conditionals.([0-9]+).(.+)$/))) {\n          const conditionalIdx = parseInt(reResult[1]);\n          const conditional =\n            conditionalData[conditionalIdx] ?? deepClone(this.object.data.conditionals[conditionalIdx]);\n          const path = reResult[2];\n          setProperty(conditional, path, o[1]);\n        }\n      });\n    formData[\"conditionals\"] = conditionalData;\n\n    formData = expandObject(formData);\n    return this.action.update(formData);\n  }\n\n  async close(options) {\n    delete this.item.apps[this.appId];\n    delete this.action.apps[this.appId];\n    this.action.sheet = null;\n    return super.close(options);\n  }\n}\n","import * as baseFilter from \"./base.mjs\";\nimport { naturalSort } from \"@utils\";\nimport fuzzysort from \"fuzzysort\";\n\nexport class CheckboxFilter extends baseFilter.BaseFilter {\n  static TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs\";\n\n  /**\n   * The minimum number of choices that must be present before the filter will show a search box.\n   * Booleans can be used to override this check.\n   *\n   * @type {number | boolean}\n   */\n  static MIN_SEARCH_CHOICES = 10;\n\n  /**\n   * The boolean operator used to combine choices of this filter.\n   * If \"OR\", an entry will be included if at least one active choice matches.\n   * If \"AND\", an entry will only be included if all active choices match.\n   *\n   * @type {BooleanOperator}\n   */\n  booleanOperator = BOOLEAN_OPERATOR.NONE;\n\n  /**\n   * A string used to determine which choices are shown.\n   *\n   * @type {string}\n   * @private\n   */\n  _choiceQuery = \"\";\n\n  constructor(...args) {\n    super(...args);\n    this._debouncedFilterChoices = foundry.utils.debounce(this._onCustomSearchFilter, 100);\n  }\n\n  /**\n   * Generate a {@link Collection} of {@link FilterChoice}s from a {@link CONFIG} object.\n   *\n   * @param {Record<string, string> | Record<string, Record<string, string>>} configObject - The object to generate choices from; can be a Record<string, string> or\n   * @param {object} [options={}] - Options determining how the choices are generated.\n   * @param {string} [options.labelKey=\"_label\"] - The key to use to determine the label if the configObject is a Record<string, object>; will be ignored if the configObject is a Record<string, string>.\n   * @param {boolean} [options.innerSet=false] - Whether choices should be generated from direct properties of the configObject, or from the properties of the inner objects.\n   * @returns {Collection<FilterChoice>} - A Collection of {@link FilterChoice}s\n   */\n  static getChoicesFromConfig(configObject, { labelKey = \"_label\", innerSet = false } = {}) {\n    /** @type {Collection<FilterChoice>} */\n    const choices = new foundry.utils.Collection();\n    for (const [key, value] of Object.entries(configObject)) {\n      if (innerSet) {\n        for (const [innerKey, innerValue] of Object.entries(value)) {\n          if (innerKey === labelKey) continue;\n          choices.set(innerKey, { key: innerKey, label: innerValue });\n        }\n      } else {\n        if (typeof value === \"object\" && value[labelKey]) {\n          choices.set(key, { key, label: value[labelKey] });\n        } else if (typeof value === \"string\") {\n          choices.set(key, { key, label: value });\n        }\n      }\n    }\n    return choices;\n  }\n\n  /**\n   * Whether this filter provides controls in addition to its choices.\n   *\n   * @type {boolean}\n   */\n  get hasControls() {\n    return this.booleanOperator !== BOOLEAN_OPERATOR.NONE || this.choices.size >= this.constructor.MIN_SEARCH_CHOICES;\n  }\n\n  get hasSearch() {\n    if (this.choices.size >= this.constructor.MIN_SEARCH_CHOICES) return true;\n    return this.constructor.MIN_SEARCH_CHOICES ?? false;\n  }\n\n  /** @inheritDoc */\n  setup() {\n    super.setup();\n    this.prepareBooleanOperator();\n  }\n\n  /**\n   * Prepare the boolean operator for this filter.\n   */\n  prepareBooleanOperator() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    // Find the first entry that has data in the field and use its data\n    let fieldData;\n    entries.find((entry) => {\n      return (fieldData = getProperty(entry, this.constructor.indexField));\n    });\n    if ([\"Array\", \"Object\"].includes(foundry.utils.getType(fieldData))) this.booleanOperator = BOOLEAN_OPERATOR.AND;\n  }\n\n  /** @inheritDoc */\n  prepareChoices() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    const observedValues = new Set(\n      entries.flatMap((entry) => {\n        const data = getProperty(entry, this.constructor.indexField);\n        if (Array.isArray(data)) {\n          if (data.length === 0) return [];\n          else return data;\n        }\n        if (typeof data === \"object\" && data !== null) {\n          const keys = Object.keys(data);\n          if (keys.length === 0) return [];\n          else return keys;\n        }\n        if (data == null) return [];\n        if (typeof data === \"string\" && data.trim() === \"\") return [];\n        return [data];\n      })\n    );\n    this.choices = new foundry.utils.Collection(\n      naturalSort(\n        [...observedValues].map((value) => ({ key: value, label: game.i18n.localize(`${value}`) })),\n        \"label\"\n      ).map((choice) => [`${choice.key}`, choice])\n    );\n  }\n\n  /**\n   * Toggle the active state of a choice, or set it to a specific state.\n   *\n   * @param {string} key - The key of the choice to toggle\n   * @param {boolean | null} [state=null] - The state to set the choice to. If null, the choice will be toggled.\n   * @returns {boolean} - The new state of the choice\n   * @throws {Error} - If the choice does not exist in this filter\n   */\n  toggleChoice(key, state = null) {\n    const choice = this.choices?.get(key);\n    if (!choice) throw new Error(`Choice ${key} does not exist in this filter.`);\n    if (state === null) choice.active = !choice.active;\n    else choice.active = state;\n    return choice.active;\n  }\n\n  /** @inheritDoc */\n  reset() {\n    super.reset();\n    this.prepareBooleanOperator();\n    this._choiceQuery = \"\";\n    this.choices?.forEach((choice) => (choice.active = false));\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const activeChoices = this.choices.filter((choice) => choice.active);\n    // If no choices are active, this filter applies no conditions\n    if (activeChoices.length === 0) return true;\n\n    // If the filter is active, but the entry does not match the filter's types, the entry cannot match\n    const types = this.constructor.handledTypes;\n    if (types.size && !types.has(entry.type)) return false;\n\n    /** @type {string | string[] | Record<string, boolean>} */\n    const data = getProperty(entry, this.constructor.indexField);\n\n    const testMethod = this.booleanOperator === BOOLEAN_OPERATOR.OR ? \"some\" : \"every\";\n    if (Array.isArray(data)) {\n      return activeChoices[testMethod]((choice) => data.includes(choice.key));\n    } else if (typeof data === \"object\" && data !== null) {\n      return activeChoices[testMethod]((choice) => choice.key in data && data[choice.key] !== false);\n    } else {\n      return activeChoices.some((choice) => {\n        return data == choice.key;\n      });\n    }\n  }\n\n  /** @inheritDoc */\n  getData() {\n    return {\n      ...super.getData(),\n      hasControls: this.hasControls,\n      boolean: this.booleanOperator,\n      hasSearch: this.choices.size > this.constructor.MIN_SEARCH_CHOICES,\n      choiceQuery: this._choiceQuery,\n    };\n  }\n\n  /** @inheritDoc */\n  activateListeners(html) {\n    super.activateListeners(html);\n    this._onCustomSearchFilter(null, html);\n    html.querySelector(\"button.boolean\")?.addEventListener(\"click\", (event) => {\n      event.preventDefault();\n      if (this.booleanOperator === BOOLEAN_OPERATOR.OR) this.booleanOperator = BOOLEAN_OPERATOR.AND;\n      else this.booleanOperator = BOOLEAN_OPERATOR.OR;\n      this.compendiumBrowser.render();\n    });\n    html\n      .querySelector(\"input[name=choice-query]\")\n      ?.addEventListener(\"input\", (event) => this._debouncedFilterChoices(event, html));\n    html.addEventListener(\"change\", (event) => {\n      if (event.target.type === \"checkbox\") {\n        const checkbox = event.target;\n        const choiceKey = /filter.\\w*.choice.(?<choice>.*)/.exec(checkbox.name)?.groups?.choice;\n        if (choiceKey) {\n          this.toggleChoice(choiceKey, checkbox.checked);\n          this.compendiumBrowser.render();\n        }\n      }\n    });\n  }\n\n  /**\n   * Filter this filter's choices based on a string query.\n   *\n   * @protected\n   * @param {Event} event - The originating input event\n   * @param {HTMLElement} html - The rendered HTML of this filter\n   */\n  _onCustomSearchFilter(event, html) {\n    if (event) {\n      event.preventDefault();\n      this._choiceQuery = SearchFilter.cleanQuery(event.target.value);\n    }\n\n    const matchingChoices = fuzzysort\n      .go(this._choiceQuery, this.choices.contents, {\n        key: \"label\",\n        threshold: -10000,\n      })\n      .map((result) => `${result.obj.key}`);\n    const choiceSet = new Set(matchingChoices);\n\n    for (const li of html.querySelectorAll(\"li.filter-choice\")) {\n      const choiceKey = li.dataset.choice;\n      if (choiceKey) {\n        if (choiceSet.has(choiceKey) || !this._choiceQuery) li.classList.remove(\"hidden\");\n        else li.classList.add(\"hidden\");\n      }\n    }\n    if (this._choiceQuery && matchingChoices.length === 0)\n      html.querySelector(\"span.no-choices\")?.classList.remove(\"hidden\");\n    else html.querySelector(\"span.no-choices\")?.classList.add(\"hidden\");\n  }\n}\n\n/** @typedef {typeof BOOLEAN_OPERATOR[keyof typeof BOOLEAN_OPERATOR]} BooleanOperator */\n/**\n * States for the boolean operator of a filter.\n */\nexport const BOOLEAN_OPERATOR = /** @type {const} */ ({\n  AND: \"AND\",\n  OR: \"OR\",\n  NONE: false,\n});\n","import { BaseFilter } from \"./base.mjs\";\n\n/**\n * A filter that allows the user to input a minimum and maximum value.\n */\nexport class NumberRangeFilter extends BaseFilter {\n  static TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/minmax-filter.hbs\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    const inputs = [\n      { key: \"min\", label: \"FFD20.Minimum\", placeholder: \"0\" },\n      { key: \"max\", label: \"FFD20.Maximum\", placeholder: \"\" },\n    ];\n    this.choices = new foundry.utils.Collection(\n      inputs.map((input) => [input.key, { ...input, label: game.i18n.localize(input.label) }])\n    );\n  }\n\n  /** @inheritDoc */\n  reset() {\n    this.choices.forEach((choice) => {\n      choice.value = null;\n      choice.active = false;\n    });\n  }\n\n  /** @inheritDoc */\n  activateListeners(html) {\n    html.addEventListener(\"change\", (event) => {\n      const input = event.target;\n      const value = input.value;\n      const key = input.name.split(\"choice.\").pop();\n      const choice = this.choices.get(key);\n      if (choice) {\n        choice.value = Number(value) || null;\n        choice.active = Boolean(value);\n      }\n      this.compendiumBrowser.render();\n    });\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const value = foundry.utils.getProperty(entry, this.constructor.indexField) ?? 0;\n    const min = this.choices.get(\"min\").value ?? 0;\n    const max = this.choices.get(\"max\").value ?? Number.POSITIVE_INFINITY;\n    if (value < min) return false;\n    if (value > max) return false;\n    return true;\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\nimport { NumberRangeFilter } from \"./number-range.mjs\";\n\nexport class ItemTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static indexField = \"type\";\n  static types = [\"weapon\", \"equipment\", \"consumable\", \"container\", \"loot\"];\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = new foundry.utils.Collection(\n      [\n        { key: \"weapon\", label: game.i18n.localize(\"FFD20.ItemTypeWeapon\") },\n        { key: \"equipment\", label: game.i18n.localize(\"FFD20.ItemTypeEquipment\") },\n        { key: \"consumable\", label: game.i18n.localize(\"FFD20.ItemTypeConsumable\") },\n        { key: \"container\", label: game.i18n.localize(\"ITEM.TypeContainer\") },\n        { key: \"loot\", label: game.i18n.localize(\"FFD20.Misc\") },\n      ].map((choice) => [choice.key, choice])\n    );\n  }\n}\n\nexport class WeaponTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponType\";\n  static indexField = \"system.subType\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes);\n  }\n}\n\nexport class WeaponSubtypeFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponSubtype\";\n  static indexField = \"system.weaponSubtype\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes, { innerSet: true });\n  }\n}\n\nexport class WeaponPropertyFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponProperties\";\n  static indexField = \"system.properties\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponProperties);\n  }\n}\n\nexport class WeaponGroupFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponGroups\";\n  static indexField = \"system.weaponGroups.value\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponGroups);\n  }\n}\n\nexport class EquipmentTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.EquipmentType\";\n  static indexField = \"system.subType\";\n  static type = \"equipment\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes);\n  }\n}\n\nexport class EquipmentSubtypeFilter extends CheckboxFilter {\n  static label = \"FFD20.EquipmentSubtype\";\n  static indexField = \"system.equipmentSubtype\";\n  static type = \"equipment\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes, { innerSet: true });\n  }\n}\n\nexport class ItemSlotFilter extends CheckboxFilter {\n  static label = \"FFD20.Slot\";\n  static indexField = \"system.slot\";\n  static type = \"equipment\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentSlots, { innerSet: true });\n  }\n}\n\nexport class ConsumableTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ConsumableType\";\n  static indexField = \"system.subType\";\n  static type = \"consumable\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.consumableTypes);\n  }\n}\n\nexport class MiscItemTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Misc\";\n  static indexField = \"system.subType\";\n  static type = \"loot\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.lootTypes);\n  }\n}\n\nexport class ItemPriceFilter extends NumberRangeFilter {\n  static label = \"FFD20.Price\";\n  static indexField = \"system.price\";\n}\n\nexport class ItemCasterLevelFilter extends NumberRangeFilter {\n  static label = \"FFD20.CasterLevel\";\n  static indexField = \"system.cl\";\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\nimport { naturalSort } from \"@utils\";\n\nexport class PackFilter extends CheckboxFilter {\n  static label = \"FFD20.Compendium\";\n  static indexField = \"__pack\";\n\n  /** @override */\n  prepareChoices() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    const usedPacks = this.compendiumBrowser?.packs\n      ?.filter((pack) => entries.some((entry) => entry.__pack === pack.collection))\n      .map((pack) => ({ key: pack.collection, label: pack.metadata.label }));\n    const orderedPacks = naturalSort(usedPacks, \"label\").map((pack) => [pack.key, pack]);\n    this.choices = new foundry.utils.Collection(orderedPacks);\n  }\n}\n\nexport class TagFilter extends CheckboxFilter {\n  static label = \"FFD20.Tags\";\n  static indexField = \"system.tags\";\n}\n","import { BOOLEAN_OPERATOR, CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class SpellSchoolFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellSchool\";\n  static indexField = \"system.school\";\n  static type = \"spell\";\n\n  /** @override */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.spellSchools);\n  }\n}\n\nexport class SpellMultiSchoolFilter extends CheckboxFilter {\n  static label = \"FFD20.multiSchool\";\n  static indexField = \"system.school\";\n  static type = \"spell\";\n//add missing\n  /** @override */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.multiSchools);\n  }\n}\n\nexport class SpellSubSchoolFilter extends CheckboxFilter {\n  static label = \"FFD20.SubSchool\";\n  static indexField = \"system.subschool\";\n  static type = \"spell\";\n}\n\nexport class SpellDescriptorFilter extends CheckboxFilter {\n  static label = \"FFD20.Descriptor\";\n  static indexField = \"system.types\";\n  static type = \"spell\";\n}\n\nexport class SpellLearnedByClassFilter extends CheckboxFilter {\n  static label = \"FFD20.Classes\";\n  static indexField = \"system.learnedAt.class\";\n  static type = \"spell\";\n}\n\nexport class SpellLearnedByDomainFilter extends CheckboxFilter {\n  static label = \"FFD20.Domain\";\n  static indexField = \"system.learnedAt.domain\";\n  static type = \"spell\";\n}\n\nexport class SpellLearnedBySubdomainFilter extends CheckboxFilter {\n  static label = \"FFD20.SubDomain\";\n  static indexField = \"system.learnedAt.subDomain\";\n  static type = \"spell\";\n}\n\nexport class SpellLearnedByBloodlineFilter extends CheckboxFilter {\n  static label = \"FFD20.Bloodline\";\n  static indexField = \"system.learnedAt.bloodline\";\n  static type = \"spell\";\n}\n\nexport class SpellLevelFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellLevel\";\n  static indexField = \"system.level\";\n  static type = \"spell\";\n\n  /** @override */\n  prepareChoices() {\n    const choices = this.constructor.getChoicesFromConfig(ffd20.config.spellLevels);\n    choices.forEach((choice) => {\n      choice.key = Number(choice.key);\n    });\n    this.choices = choices;\n  }\n\n  /** @override */\n  applyFilter(entry) {\n    const activeLearnedAtFilters = this.compendiumBrowser.filters.filter(\n      (filter) => filter.active && filter.constructor.indexField.startsWith(\"system.learnedAt.\")\n    );\n\n    // Fall back to checking whether _anything_ can learn the spell at that level\n    if (activeLearnedAtFilters.length === 0) return super.applyFilter(entry);\n\n    // Otherwise, check whether active filters match the spell's learnedAt\n    const testMethod = this.booleanOperator === BOOLEAN_OPERATOR.OR ? \"some\" : \"every\";\n    const activeLevelChoices = this.choices.filter((choice) => choice.active);\n\n    // Require either any of the active filters to match if OR, or all filters to return a match if AND\n    return activeLearnedAtFilters[testMethod]((filter) => {\n      /** @type {Record<string, number>} */\n      const learnedAt = getProperty(entry, filter.constructor.indexField) ?? {};\n      const activeLearnedAtChoices = filter.choices.filter((choice) => choice.active);\n      // Require either one of the classes etc. to match if OR, or all classes etc. to match if AND\n      return activeLearnedAtChoices[testMethod]((learnedAtChoice) => {\n        const learnedAtLevel = learnedAt[learnedAtChoice.key];\n        return activeLevelChoices[testMethod]((levelChoice) => levelChoice.key === learnedAtLevel);\n      });\n    });\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class FeatTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static type = \"feat\";\n  static indexField = \"system.subType\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.featTypes);\n  }\n}\n\nexport class FeatClassFilter extends CheckboxFilter {\n  static label = \"FFD20.Classes\";\n  static type = \"feat\";\n  static indexField = \"system.associations.classes\";\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class ClassTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassType\";\n  static type = \"class\";\n  static indexField = \"system.subType\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classTypes);\n  }\n}\n\nexport class ClassHitDieFilter extends CheckboxFilter {\n  static label = \"FFD20.HitDie\";\n  static type = \"class\";\n  static indexField = \"system.hd\";\n}\n\nexport class ClassBaseAttackBonusFilter extends CheckboxFilter {\n  static label = \"FFD20.BAB\";\n  static type = \"class\";\n  static indexField = \"system.bab\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classBAB);\n  }\n}\n\nexport class ClassSkillPointsFilter extends CheckboxFilter {\n  static label = \"FFD20.SkillsPerLevel\";\n  static type = \"class\";\n  static indexField = \"system.skillsPerLevel\";\n}\n\nclass ClassSavingThrowFilter extends CheckboxFilter {\n  static type = \"class\";\n  static savingThrow = \"\";\n  static get label() {\n    return ffd20.config.savingThrows[this.savingThrow] ?? \"\";\n  }\n  static get indexField() {\n    return `system.savingThrows.${this.savingThrow}.value`;\n  }\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classSavingThrows);\n    this.choices.set(\"none\", { label: game.i18n.localize(\"FFD20.None\"), key: \"none\" });\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const result = super.applyFilter(entry);\n    const value = foundry.utils.getProperty(entry, this.constructor.indexField);\n    const noneFilterResult = this.choices.get(\"none\").active && value === \"\";\n    return result || noneFilterResult;\n  }\n}\n\nexport class ClassFortitudeFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"fort\";\n}\n\nexport class ClassReflexFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"ref\";\n}\n\nexport class ClassWillFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"will\";\n}\n//fix\nexport class ClassSubTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassSubType\";\n  static type = \"class\";\n  static indexField = \"system.classSubType\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classSubTypes);\n  }\n}\n\nexport class ClassParentFilter extends CheckboxFilter {\n  static label = \"FFD20.ParentClass\";\n  static type = \"class\";\n  static indexField = \"system.parentClass\";\n}\n\nexport class ClassMPFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassMPType\";\n  static type = \"class\";\n  static indexField = \"system.classBaseMPTypes\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classBaseMPTypes);\n  }\n}\n\nexport class ClassCastingStatFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellcastingAbility\";\n  static type = \"class\";\n  static indexField = \"system.classCastingStat\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classCastingStats);\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class CreatureTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.CreatureType\";\n  static type = \"race\";\n  static indexField = \"system.creatureType\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.creatureTypes);\n  }\n}\n\nexport class CreatureSubTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.RaceSubtypePlural\";\n  static type = \"race\";\n  static indexField = \"system.subTypes\";\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class BuffTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static type = \"buff\";\n  static indexField = \"system.subType\";\n\n  /** @override */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.buffTypes);\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\nimport { CR } from \"@utils\";\n\nexport class CreatureCRFilter extends CheckboxFilter {\n  static label = \"FFD20.ChallengeRatingShort\";\n  static indexField = \"system.details.cr.base\";\n  static types = [\"character\", \"npc\"];\n\n  /** @override */\n  prepareChoices() {\n    super.prepareChoices();\n    const choices = this.choices.contents\n      .map((choice) => Number(choice.key))\n      .sort((a, b) => a - b)\n      .map((cr) => {\n        const label = CR.fromNumber(cr);\n        return [cr.toString(), { key: cr, label: label }];\n      });\n    this.choices = new foundry.utils.Collection(choices);\n  }\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as buffFilters from \"./filters/buff.mjs\";\n\nexport class BuffBrowser extends CompendiumBrowser {\n  static documentName = \"Item\";\n  static typeName = \"FFD20.Buffs\";\n  static filterClasses = [commonFilters.PackFilter, buffFilters.BuffTypeFilter, commonFilters.TagFilter];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as classFilters from \"./filters/class.mjs\";\n\nexport class ClassBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Classes\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    classFilters.ClassTypeFilter,\n    classFilters.ClassSubTypeFilter,\n    classFilters.ClassParentFilter,\n    classFilters.ClassHitDieFilter,\n    classFilters.ClassMPFilter,\n    classFilters.ClassCastingStatFilter,\n    classFilters.ClassBaseAttackBonusFilter,\n    classFilters.ClassSkillPointsFilter,\n    classFilters.ClassFortitudeFilter,\n    classFilters.ClassReflexFilter,\n    classFilters.ClassWillFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport { PackFilter } from \"./filters/common.mjs\";\nimport * as creatureFilters from \"./filters/creature.mjs\";\n\nexport class CreatureBrowser extends CompendiumBrowser {\n  static documentName = \"Actor\";\n  static typeName = \"FFD20.Creatures\";\n  static filterClasses = [PackFilter, creatureFilters.CreatureCRFilter];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as featFilter from \"./filters/feat.mjs\";\n\nexport class FeatBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Feats\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    featFilter.FeatTypeFilter,\n    featFilter.FeatClassFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as itemFilters from \"./filters/item.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\n\nexport class ItemBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Items\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    itemFilters.ItemTypeFilter,\n    itemFilters.WeaponTypeFilter,\n    itemFilters.WeaponSubtypeFilter,\n    itemFilters.WeaponPropertyFilter,\n    itemFilters.WeaponGroupFilter,\n    itemFilters.EquipmentTypeFilter,\n    itemFilters.EquipmentSubtypeFilter,\n    itemFilters.ItemSlotFilter,\n    itemFilters.ConsumableTypeFilter,\n    itemFilters.MiscItemTypeFilter,\n    itemFilters.ItemPriceFilter,\n    itemFilters.ItemCasterLevelFilter,\n    commonFilters.TagFilter,\n  ];\n\n  /** @override */\n  static _mapEntry(entry, pack) {\n    const result = super._mapEntry(entry, pack);\n\n    // Remove equipmentSubtype if the item subtype should not have one\n    const { subType, equipmentSubtype } = result.system;\n    if (subType) {\n      const equipmentSubtypes = Object.keys(ffd20.config.equipmentTypes[subType] ?? {}).filter((o) => !o.startsWith(\"_\"));\n      if (equipmentSubtypes.length === 0) {\n        // Clear equipmentSubtype if subType has no equipmentSubtypes\n        result.system.equipmentSubtype = \"\";\n      } else if (!equipmentSubtypes.includes(equipmentSubtype)) {\n        // Default to first equipmentSubtype if current equipmentSubtype is invalid\n        result.system.equipmentSubtype = equipmentSubtypes.at(0);\n      }\n    }\n\n    return result;\n  }\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as raceFilters from \"./filters/race.mjs\";\n\nexport class RaceBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Races\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    raceFilters.CreatureTypeFilter,\n    raceFilters.CreatureSubTypeFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as spellFilter from \"./filters/spell.mjs\";\n\nexport class SpellBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Spells\";\n  static types = [\"spell\"];\n  static filterClasses = [\n    commonFilters.PackFilter,\n    spellFilter.SpellSchoolFilter,\n    spellFilter.SpellMultiSchoolFilter,\n    spellFilter.SpellSubSchoolFilter,\n    spellFilter.SpellDescriptorFilter,\n    spellFilter.SpellLearnedByClassFilter,\n    spellFilter.SpellLearnedByDomainFilter,\n    spellFilter.SpellLearnedBySubdomainFilter,\n    spellFilter.SpellLearnedByBloodlineFilter,\n    spellFilter.SpellLevelFilter,\n    commonFilters.TagFilter,\n  ];\n  /** @override */\n  static _mapEntry(entry, pack) {\n    const result = super._mapEntry(entry, pack);\n    // HACK: This transforms the string into an array.\n    // Tt's completely hardcoded for English; should be replaced with proper AI word recognition :)\n    for (const key of [\"subschool\", \"types\"]) {\n      result.system[key] =\n        entry.system[key]\n          ?.split(/,|\\Wor\\s/)\n          .map((type) => {\n            /** @type {string} */\n            let typeString = type.trim();\n            if (typeString.includes(\"see text\")) return \"see text\";\n            if (typeString.startsWith(\"or\")) typeString = typeString.replace(\"or\").trim();\n            return typeString;\n          })\n          .filter((typeString) => typeString.length) ?? [];\n    }\n\n    /** @type {Record<string, Record<string, number>>} */\n    const learnedAtData = entry.system.learnedAt ?? {};\n    const learnedAtLevels = Object.values(learnedAtData)\n      .map((learnedAtSource) => Object.values(learnedAtSource))\n      .flat();\n    if (entry.system.level) learnedAtLevels.push(entry.system.level);\n    // NOTE: This results in `level` being a number[] instead of a number like in the source data.\n    result.system.level = [...new Set(learnedAtLevels)];\n\n    return result;\n  }\n}\n","import { getSkipActionPrompt } from \"../documents/settings.mjs\";\n\nexport class ActionChooser extends Application {\n  /**\n   * @param {ItemPF} item - The item for which to choose an attack\n   * @param {any} [options]\n   */\n  constructor(item, options = {}) {\n    super(options);\n\n    this.item = item;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/apps/action-chooser.hbs\",\n      classes: [\"ffd20\", \"action-chooser\"],\n      width: 400,\n    });\n  }\n  get title() {\n    return game.i18n.format(\"FFD20.Application.ActionChooser.Title\", {\n      actor: this.item.actor.name ?? \"\",\n      item: this.item.name,\n    });\n  }\n\n  async getData(options) {\n    const result = await super.getData(options);\n\n    result.item = this.item.toObject();\n    result.actions = this.item.system.actions;\n\n    return result;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find(\".action\").on(\"click\", this._onClickAction.bind(this));\n  }\n\n  _onClickAction(event) {\n    event.preventDefault();\n\n    const id = event.currentTarget.dataset?.action;\n    this.item.use({ actionID: id, skipDialog: getSkipActionPrompt() });\n    this.close();\n  }\n}\n","import { ActionUse } from \"../action-use/action-use.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\n\nexport class AttackDialog extends Application {\n  constructor(object, rollData = null, options = {}, appOptions = {}) {\n    super(appOptions);\n\n    this.object = object;\n\n    this.rollData = rollData ? rollData : this.object.getRollData();\n\n    this.initAmmoUsage();\n    this.initAttacks();\n\n    this.base = {\n      cl: this.rollData.cl ?? 0,\n      sl: this.rollData.sl ?? 0,\n    };\n\n    const isNaturalAttack = this.object.item.system.attackType === \"natural\",\n      isPrimaryAttack = this.object.data.naturalAttack.primaryAttack === true;\n\n    this.flags = {\n      \"primary-attack\": isPrimaryAttack,\n      \"cl-check\": this.object.clCheck === true,\n      \"measure-template\": true,\n    };\n\n    let damageMult = this.rollData.action?.ability?.damageMult ?? 1;\n    if (isNaturalAttack && !isPrimaryAttack) {\n      damageMult = this.rollData.action.naturalAttack?.secondary?.damageMult ?? 0.5;\n    }\n\n    this.attributes = {\n      d20: this.rollData.d20 ?? \"\",\n      \"attack-bonus\": \"\",\n      \"damage-bonus\": \"\",\n      \"cl-offset\": \"0\",\n      \"sl-offset\": \"0\",\n      rollMode: options.rollMode || game.settings.get(\"core\", \"rollMode\"),\n      \"damage-ability-multiplier\": damageMult,\n      held: this.rollData.item?.held ?? \"normal\",\n    };\n    this.conditionals = {};\n    this.object.conditionals?.contents.forEach((conditional, idx) => {\n      this.conditionals[`conditional.${idx}`] = conditional.data.default === true;\n    });\n\n    // Callback for AttackDialog.show()\n    this._callbacks = {\n      resolve: null,\n      reject: null,\n    };\n  }\n\n  get title() {\n    return `Use: ${this.object.name}`;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/apps/attack-roll-dialog.hbs\",\n      classes: [\"ffd20\", \"attack-dialog\"],\n      width: 440,\n      height: \"auto\",\n      closeOnSubmit: true,\n      sheetConfig: false,\n      submitOnChange: false,\n      submitOnClose: false,\n    });\n  }\n\n  static get defaultAttack() {\n    return {\n      label: \"\",\n      attackBonus: 0,\n      attackBonusTotal: 0,\n      ammo: null,\n    };\n  }\n\n  getData() {\n    return {\n      data: this.rollData,\n      item: this.object.data,\n      config: ffd20.config,\n      rollMode: game.settings.get(\"core\", \"rollMode\"),\n      rollModes: CONFIG.Dice.rollModes,\n      hasAttack: this.object.hasAttack,\n      hasDamage: this.object.hasDamage,\n      hasDamageAbility: this.object.data.ability?.damage ?? \"\" !== \"\",\n      isNaturalAttack: this.object.item.system.subType === \"natural\",\n      isWeaponAttack: this.object.item.system.subType === \"weapon\",\n      isMeleeWeaponAttackAction: this.object.data.actionType === \"mwak\",\n      isRangedWeaponAttackAction: this.object.data.actionType === \"rwak\",\n      isAttack: this.object.item.type === \"attack\",\n      isWeapon: this.object.item.type === \"weapon\",\n      isSpell: this.object.item.type === \"spell\",\n      isFeat: this.object.item.type === \"feat\",\n      hasTemplate: this.object.hasTemplate,\n      attacks: this.attacks,\n      flags: this.flags,\n      attributes: this.attributes,\n      conditionals: this.conditionals,\n      usesAmmo: this.object.data.usesAmmo,\n      ammo: this.getAmmo(),\n    };\n  }\n\n  getAmmo() {\n    const actor = this.object.actor;\n    const ammo = actor.items.filter(this._filterAmmo.bind(this));\n\n    return ammo.map((o) => {\n      return {\n        data: o.toObject(),\n        isDefault: this.object.item.getFlag(\"ffd20\", \"defaultAmmo\") === o.id,\n      };\n    });\n  }\n\n  _filterAmmo(item) {\n    if (!(item.type === \"loot\" && item.system.subType === \"ammo\")) return false;\n    if (item.system.quantity <= 0) return false;\n\n    const weaponAmmoType = this.object.data.ammoType;\n    const ammoType = item.extraType;\n    if (!ammoType) return true;\n    if (weaponAmmoType === ammoType) return true;\n  }\n\n  activateListeners(html) {\n    // Form changing\n    html.find(`.flags input[type=\"checkbox\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input.attribute`).on(\"change\", this._onChangeAttribute.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"concentration\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"cl-check\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"measure-template\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`select`).on(\"change\", this._onSelectChange.bind(this));\n    html.find(`.conditionals input[type=\"checkbox\"]`).on(\"change\", this._onToggleConditional.bind(this));\n\n    // Dropdown menu\n    html.find(\".ammo-select\").on(\"click\", this._onAmmoSelectClick.bind(this));\n    html.find(\".ammo-select .ammo-item .controls a\").on(\"click\", this._onAmmoControlClick.bind(this));\n    html.find(\".ammo-select .ammo-item\").on(\"click\", this._onAmmoClick.bind(this));\n    html.on(\"click\", this._unfocusElements.bind(this));\n\n    // Button hover\n    html.find(`button[name=\"attack_single\"]`).on(\"mouseenter\", this._hideExtraAttacks.bind(this));\n    html.find(`button[name=\"attack_single\"]`).on(\"mouseleave\", this._showExtraAttacks.bind(this));\n\n    // Button press\n    html.find(`button[name=\"attack_single\"]`).on(\"click\", this._onAttackSingle.bind(this));\n    html.find(`button[name=\"attack_full\"]`).on(\"click\", this._onAttackFull.bind(this));\n  }\n\n  _onSelectChange(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.attributes[elem.name] = elem.options[elem.selectedIndex].value;\n    this.render();\n  }\n\n  _hideExtraAttacks(event) {\n    const elems = this.element.find(\".attacks .attack\").filter((index, elem) => parseInt(elem.dataset.index) > 0);\n    elems.addClass(\"disabled\");\n  }\n\n  _showExtraAttacks(event) {\n    this.element.find(\".attacks .attack\").removeClass(\"disabled\");\n  }\n\n  _onToggleFlag(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.flags[elem.name] = elem.checked === true;\n\n    // Add or remove haste, rapid-shot or manyshot attack\n    if ([\"haste-attack\", \"rapid-shot\", \"manyshot\"].includes(elem.name)) {\n      if (elem.checked) {\n        const translationString = {\n          \"haste-attack\": \"FFD20.Haste\",\n          \"rapid-shot\": \"FFD20.RapidShot\",\n          manyshot: \"FFD20.Manyshot\",\n        };\n\n        // Correlate manyshot with the first attack, add the others at the end\n        const place = elem.name === \"manyshot\" ? 1 : this.attacks.length;\n\n        this.attacks.splice(\n          place,\n          0,\n          mergeObject(this.constructor.defaultAttack, {\n            id: elem.name,\n            label: game.i18n.localize(translationString[elem.name]),\n            attackBonusTotal: \"\", // Don't show anything in the mod field, as the data is not updated live\n          })\n        );\n        this.setAttackAmmo(place, this.object.item.getFlag(\"ffd20\", \"defaultAmmo\"));\n      } else {\n        this.attacks = this.attacks.filter((o) => o.id !== elem.name);\n      }\n    }\n\n    this.render();\n  }\n\n  _onToggleConditional(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.conditionals[elem.name] = elem.checked === true;\n    this.render();\n  }\n\n  _onAmmoSelectClick(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    const listElem = elem.querySelector(\"ul\");\n\n    // Filter to NOT act when clicking on the list child element\n    if (!event.target.closest(\"ul\")) {\n      // Set classes for CSS\n      listElem.classList.toggle(\"open\");\n      const isOpen = listElem.classList.contains(\"open\");\n      if (isOpen) elem.classList.add(\"focus\");\n      else elem.classList.remove(\"focus\");\n    }\n  }\n\n  _onAmmoClick(event) {\n    const elem = event.target;\n    // Don't do anything if this click was actually on its controls\n    if (elem.closest(\".controls\") && !elem.classList.contains(\"controls\")) return;\n\n    event.preventDefault();\n    const ammoId = elem.closest(\".ammo-item\").dataset.id;\n    const attackIndex = parseInt(elem.closest(\".attack\").dataset.index);\n\n    // Set ammo\n    this.setAttackAmmo(attackIndex, ammoId === \"null\" ? null : ammoId);\n    this.render();\n  }\n\n  async _onAmmoControlClick(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    const ammoId = elem.closest(\".ammo-item\").dataset.id;\n    switch (elem.dataset.type) {\n      case \"set-default\":\n        if (ammoId === \"null\") await this.object.item.unsetFlag(\"ffd20\", \"defaultAmmo\");\n        else await this.object.item.setFlag(\"ffd20\", \"defaultAmmo\", ammoId);\n        // Apply CSS class, since we can't do a render in here and keep the dropdown menu open\n        elem\n          .closest(\"ul\")\n          .querySelectorAll(\".ammo-item\")\n          .forEach((o) => o.classList.remove(\"default\"));\n        if (ammoId !== \"null\") elem.closest(\".ammo-item\").classList.add(\"default\");\n        break;\n      case \"set-all\":\n        for (let a = 0; a < this.attacks.length; a++) {\n          this.setAttackAmmo(a, ammoId);\n        }\n        this.render();\n    }\n  }\n\n  _unfocusElements(event) {\n    // Close ammo select\n    if (this.element[0].querySelector(\".ammo-select\") != null && !event.target.closest(\".ammo-select\")) {\n      const elem = this.element[0].querySelector(\".ammo-select\");\n      elem.classList.remove(\"focus\");\n      elem.querySelector(\"ul\").classList.remove(\"open\");\n    }\n  }\n\n  _onChangeAttribute(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.attributes[elem.name] = elem.value;\n\n    // Also change roll data, if appropriate\n    switch (elem.name) {\n      case \"cl-offset\":\n        this.rollData.cl = this.base.cl + parseInt(elem.value);\n        break;\n      case \"sl-offset\":\n        this.rollData.sl = this.base.sl + parseInt(elem.value);\n        break;\n      case \"damage-ability-multiplier\":\n        setProperty(this.rollData, \"item.ability.damageMult\", elem.value);\n        break;\n      case \"held\":\n        setProperty(this.rollData, \"item.held\", elem.value);\n        break;\n    }\n\n    this.render();\n  }\n\n  initAttacks() {\n    this.attacks = new ActionUse({ rollData: this.rollData, item: this.object.item })\n      .generateAttacks(true)\n      .map(({ label, attackBonus }) => ({\n        label: label,\n        attackBonus: attackBonus,\n        // Reduce formula to a single number for easier display\n        attackBonusTotal: RollPF.safeTotal(attackBonus, this.rollData),\n        // Ammo data is discarded in favour of specialised handling via setAttackAmmo\n        ammo: null,\n      }));\n\n    // Set ammo usage\n    const ammoId = this.object.item.getFlag(\"ffd20\", \"defaultAmmo\");\n    if (ammoId != null) {\n      for (let a = 0; a < this.attacks.length; a++) {\n        this.setAttackAmmo(a, ammoId);\n      }\n    }\n  }\n\n  // Initializes ammo usage, which help avoid being able to overuse ammo\n  initAmmoUsage() {\n    this.ammoUsage = this.getAmmo().reduce((cur, o) => {\n      cur[o.data._id] = {\n        quantity: o.data.system.quantity,\n        used: 0,\n      };\n\n      return cur;\n    }, {});\n  }\n\n  getFormAttacks() {\n    return this.attacks.map((o) => {\n      return {\n        id: o.id,\n        label: o.label,\n        attackBonus: o.attackBonus,\n        ammo: o.ammo?.data._id,\n      };\n    });\n  }\n\n  setAttackAmmo(attackIndex, ammoId = null) {\n    if (!this.object.data.usesAmmo) return;\n\n    const atk = this.attacks[attackIndex];\n    const curAmmo = atk.ammo?.data._id;\n    const ammoItem = ammoId ? this.object.actor.items.get(ammoId) : null;\n    const abundant = ammoItem?.flags?.ffd20?.abundant ?? false;\n\n    // Check if ammo exists\n    if (ammoId && this.ammoUsage[ammoId] == null) ammoId = null;\n\n    if (!ammoId) {\n      atk.ammo = null;\n      // Remove from ammo usage tracker\n      if (curAmmo != null) {\n        this.ammoUsage[curAmmo].used--;\n      }\n      return;\n    }\n\n    // Don't allow overusage\n    if (!abundant && this.ammoUsage[ammoId].used >= this.ammoUsage[ammoId].quantity) return;\n\n    atk.ammo = this.getAmmo().find((o) => o.data._id === ammoId);\n    // Add to ammo usage tracker\n    if (curAmmo != null) {\n      this.ammoUsage[curAmmo].used--;\n    }\n    this.ammoUsage[ammoId].used++;\n  }\n\n  _onAttackSingle(event) {\n    event.preventDefault();\n\n    const attacks = this.getFormAttacks();\n    return this.doAttack(attacks.slice(0, 1), false);\n  }\n\n  _onAttackFull(event) {\n    event.preventDefault();\n\n    const attacks = this.getFormAttacks();\n    return this.doAttack(attacks, true);\n  }\n\n  doAttack(attacks, fullAttack = true) {\n    this._callbacks.resolve({ fullAttack, attacks, html: this.element });\n    this._callbacks.resolve = null;\n    this.close();\n  }\n\n  async close(options = {}) {\n    if (this._callbacks.resolve != null) this._callbacks.resolve();\n    return super.close(options);\n  }\n\n  show() {\n    return new Promise((resolve, reject) => {\n      this.render(true);\n\n      this._callbacks.resolve = (...args) => {\n        resolve(...args);\n      };\n      this._callbacks.reject = (...args) => {\n        reject(...args);\n      };\n    });\n  }\n}\n","// HTML5 entities map: { name -> utf16string }\n//\n'use strict';\n\n/*eslint quotes:0*/\nmodule.exports = require('entities/lib/maps/entities.json');\n","module.exports=/[!-#%-\\*,-\\/:;\\?@\\[-\\]_\\{\\}\\xA1\\xA7\\xAB\\xB6\\xB7\\xBB\\xBF\\u037E\\u0387\\u055A-\\u055F\\u0589\\u058A\\u05BE\\u05C0\\u05C3\\u05C6\\u05F3\\u05F4\\u0609\\u060A\\u060C\\u060D\\u061B\\u061E\\u061F\\u066A-\\u066D\\u06D4\\u0700-\\u070D\\u07F7-\\u07F9\\u0830-\\u083E\\u085E\\u0964\\u0965\\u0970\\u09FD\\u0A76\\u0AF0\\u0C84\\u0DF4\\u0E4F\\u0E5A\\u0E5B\\u0F04-\\u0F12\\u0F14\\u0F3A-\\u0F3D\\u0F85\\u0FD0-\\u0FD4\\u0FD9\\u0FDA\\u104A-\\u104F\\u10FB\\u1360-\\u1368\\u1400\\u166D\\u166E\\u169B\\u169C\\u16EB-\\u16ED\\u1735\\u1736\\u17D4-\\u17D6\\u17D8-\\u17DA\\u1800-\\u180A\\u1944\\u1945\\u1A1E\\u1A1F\\u1AA0-\\u1AA6\\u1AA8-\\u1AAD\\u1B5A-\\u1B60\\u1BFC-\\u1BFF\\u1C3B-\\u1C3F\\u1C7E\\u1C7F\\u1CC0-\\u1CC7\\u1CD3\\u2010-\\u2027\\u2030-\\u2043\\u2045-\\u2051\\u2053-\\u205E\\u207D\\u207E\\u208D\\u208E\\u2308-\\u230B\\u2329\\u232A\\u2768-\\u2775\\u27C5\\u27C6\\u27E6-\\u27EF\\u2983-\\u2998\\u29D8-\\u29DB\\u29FC\\u29FD\\u2CF9-\\u2CFC\\u2CFE\\u2CFF\\u2D70\\u2E00-\\u2E2E\\u2E30-\\u2E4E\\u3001-\\u3003\\u3008-\\u3011\\u3014-\\u301F\\u3030\\u303D\\u30A0\\u30FB\\uA4FE\\uA4FF\\uA60D-\\uA60F\\uA673\\uA67E\\uA6F2-\\uA6F7\\uA874-\\uA877\\uA8CE\\uA8CF\\uA8F8-\\uA8FA\\uA8FC\\uA92E\\uA92F\\uA95F\\uA9C1-\\uA9CD\\uA9DE\\uA9DF\\uAA5C-\\uAA5F\\uAADE\\uAADF\\uAAF0\\uAAF1\\uABEB\\uFD3E\\uFD3F\\uFE10-\\uFE19\\uFE30-\\uFE52\\uFE54-\\uFE61\\uFE63\\uFE68\\uFE6A\\uFE6B\\uFF01-\\uFF03\\uFF05-\\uFF0A\\uFF0C-\\uFF0F\\uFF1A\\uFF1B\\uFF1F\\uFF20\\uFF3B-\\uFF3D\\uFF3F\\uFF5B\\uFF5D\\uFF5F-\\uFF65]|\\uD800[\\uDD00-\\uDD02\\uDF9F\\uDFD0]|\\uD801\\uDD6F|\\uD802[\\uDC57\\uDD1F\\uDD3F\\uDE50-\\uDE58\\uDE7F\\uDEF0-\\uDEF6\\uDF39-\\uDF3F\\uDF99-\\uDF9C]|\\uD803[\\uDF55-\\uDF59]|\\uD804[\\uDC47-\\uDC4D\\uDCBB\\uDCBC\\uDCBE-\\uDCC1\\uDD40-\\uDD43\\uDD74\\uDD75\\uDDC5-\\uDDC8\\uDDCD\\uDDDB\\uDDDD-\\uDDDF\\uDE38-\\uDE3D\\uDEA9]|\\uD805[\\uDC4B-\\uDC4F\\uDC5B\\uDC5D\\uDCC6\\uDDC1-\\uDDD7\\uDE41-\\uDE43\\uDE60-\\uDE6C\\uDF3C-\\uDF3E]|\\uD806[\\uDC3B\\uDE3F-\\uDE46\\uDE9A-\\uDE9C\\uDE9E-\\uDEA2]|\\uD807[\\uDC41-\\uDC45\\uDC70\\uDC71\\uDEF7\\uDEF8]|\\uD809[\\uDC70-\\uDC74]|\\uD81A[\\uDE6E\\uDE6F\\uDEF5\\uDF37-\\uDF3B\\uDF44]|\\uD81B[\\uDE97-\\uDE9A]|\\uD82F\\uDC9F|\\uD836[\\uDE87-\\uDE8B]|\\uD83A[\\uDD5E\\uDD5F]/","\n'use strict';\n\n\nvar encodeCache = {};\n\n\n// Create a lookup array where anything but characters in `chars` string\n// and alphanumeric chars is percent-encoded.\n//\nfunction getEncodeCache(exclude) {\n  var i, ch, cache = encodeCache[exclude];\n  if (cache) { return cache; }\n\n  cache = encodeCache[exclude] = [];\n\n  for (i = 0; i < 128; i++) {\n    ch = String.fromCharCode(i);\n\n    if (/^[0-9a-z]$/i.test(ch)) {\n      // always allow unencoded alphanumeric characters\n      cache.push(ch);\n    } else {\n      cache.push('%' + ('0' + i.toString(16).toUpperCase()).slice(-2));\n    }\n  }\n\n  for (i = 0; i < exclude.length; i++) {\n    cache[exclude.charCodeAt(i)] = exclude[i];\n  }\n\n  return cache;\n}\n\n\n// Encode unsafe characters with percent-encoding, skipping already\n// encoded sequences.\n//\n//  - string       - string to encode\n//  - exclude      - list of characters to ignore (in addition to a-zA-Z0-9)\n//  - keepEscaped  - don't encode '%' in a correct escape sequence (default: true)\n//\nfunction encode(string, exclude, keepEscaped) {\n  var i, l, code, nextCode, cache,\n      result = '';\n\n  if (typeof exclude !== 'string') {\n    // encode(string, keepEscaped)\n    keepEscaped  = exclude;\n    exclude = encode.defaultChars;\n  }\n\n  if (typeof keepEscaped === 'undefined') {\n    keepEscaped = true;\n  }\n\n  cache = getEncodeCache(exclude);\n\n  for (i = 0, l = string.length; i < l; i++) {\n    code = string.charCodeAt(i);\n\n    if (keepEscaped && code === 0x25 /* % */ && i + 2 < l) {\n      if (/^[0-9a-f]{2}$/i.test(string.slice(i + 1, i + 3))) {\n        result += string.slice(i, i + 3);\n        i += 2;\n        continue;\n      }\n    }\n\n    if (code < 128) {\n      result += cache[code];\n      continue;\n    }\n\n    if (code >= 0xD800 && code <= 0xDFFF) {\n      if (code >= 0xD800 && code <= 0xDBFF && i + 1 < l) {\n        nextCode = string.charCodeAt(i + 1);\n        if (nextCode >= 0xDC00 && nextCode <= 0xDFFF) {\n          result += encodeURIComponent(string[i] + string[i + 1]);\n          i++;\n          continue;\n        }\n      }\n      result += '%EF%BF%BD';\n      continue;\n    }\n\n    result += encodeURIComponent(string[i]);\n  }\n\n  return result;\n}\n\nencode.defaultChars   = \";/?:@&=+$,-_.!~*'()#\";\nencode.componentChars = \"-_.!~*'()\";\n\n\nmodule.exports = encode;\n","\n'use strict';\n\n\n/* eslint-disable no-bitwise */\n\nvar decodeCache = {};\n\nfunction getDecodeCache(exclude) {\n  var i, ch, cache = decodeCache[exclude];\n  if (cache) { return cache; }\n\n  cache = decodeCache[exclude] = [];\n\n  for (i = 0; i < 128; i++) {\n    ch = String.fromCharCode(i);\n    cache.push(ch);\n  }\n\n  for (i = 0; i < exclude.length; i++) {\n    ch = exclude.charCodeAt(i);\n    cache[ch] = '%' + ('0' + ch.toString(16).toUpperCase()).slice(-2);\n  }\n\n  return cache;\n}\n\n\n// Decode percent-encoded string.\n//\nfunction decode(string, exclude) {\n  var cache;\n\n  if (typeof exclude !== 'string') {\n    exclude = decode.defaultChars;\n  }\n\n  cache = getDecodeCache(exclude);\n\n  return string.replace(/(%[a-f0-9]{2})+/gi, function(seq) {\n    var i, l, b1, b2, b3, b4, chr,\n        result = '';\n\n    for (i = 0, l = seq.length; i < l; i += 3) {\n      b1 = parseInt(seq.slice(i + 1, i + 3), 16);\n\n      if (b1 < 0x80) {\n        result += cache[b1];\n        continue;\n      }\n\n      if ((b1 & 0xE0) === 0xC0 && (i + 3 < l)) {\n        // 110xxxxx 10xxxxxx\n        b2 = parseInt(seq.slice(i + 4, i + 6), 16);\n\n        if ((b2 & 0xC0) === 0x80) {\n          chr = ((b1 << 6) & 0x7C0) | (b2 & 0x3F);\n\n          if (chr < 0x80) {\n            result += '\\ufffd\\ufffd';\n          } else {\n            result += String.fromCharCode(chr);\n          }\n\n          i += 3;\n          continue;\n        }\n      }\n\n      if ((b1 & 0xF0) === 0xE0 && (i + 6 < l)) {\n        // 1110xxxx 10xxxxxx 10xxxxxx\n        b2 = parseInt(seq.slice(i + 4, i + 6), 16);\n        b3 = parseInt(seq.slice(i + 7, i + 9), 16);\n\n        if ((b2 & 0xC0) === 0x80 && (b3 & 0xC0) === 0x80) {\n          chr = ((b1 << 12) & 0xF000) | ((b2 << 6) & 0xFC0) | (b3 & 0x3F);\n\n          if (chr < 0x800 || (chr >= 0xD800 && chr <= 0xDFFF)) {\n            result += '\\ufffd\\ufffd\\ufffd';\n          } else {\n            result += String.fromCharCode(chr);\n          }\n\n          i += 6;\n          continue;\n        }\n      }\n\n      if ((b1 & 0xF8) === 0xF0 && (i + 9 < l)) {\n        // 111110xx 10xxxxxx 10xxxxxx 10xxxxxx\n        b2 = parseInt(seq.slice(i + 4, i + 6), 16);\n        b3 = parseInt(seq.slice(i + 7, i + 9), 16);\n        b4 = parseInt(seq.slice(i + 10, i + 12), 16);\n\n        if ((b2 & 0xC0) === 0x80 && (b3 & 0xC0) === 0x80 && (b4 & 0xC0) === 0x80) {\n          chr = ((b1 << 18) & 0x1C0000) | ((b2 << 12) & 0x3F000) | ((b3 << 6) & 0xFC0) | (b4 & 0x3F);\n\n          if (chr < 0x10000 || chr > 0x10FFFF) {\n            result += '\\ufffd\\ufffd\\ufffd\\ufffd';\n          } else {\n            chr -= 0x10000;\n            result += String.fromCharCode(0xD800 + (chr >> 10), 0xDC00 + (chr & 0x3FF));\n          }\n\n          i += 9;\n          continue;\n        }\n      }\n\n      result += '\\ufffd';\n    }\n\n    return result;\n  });\n}\n\n\ndecode.defaultChars   = ';/?:@&=+$,#';\ndecode.componentChars = '';\n\n\nmodule.exports = decode;\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\n//\n// Changes from joyent/node:\n//\n// 1. No leading slash in paths,\n//    e.g. in `url.parse('http://foo?bar')` pathname is ``, not `/`\n//\n// 2. Backslashes are not replaced with slashes,\n//    so `http:\\\\example.org\\` is treated like a relative path\n//\n// 3. Trailing colon is treated like a part of the path,\n//    i.e. in `http://example.org:foo` pathname is `:foo`\n//\n// 4. Nothing is URL-encoded in the resulting object,\n//    (in joyent/node some chars in auth and paths are encoded)\n//\n// 5. `url.parse()` does not have `parseQueryString` argument\n//\n// 6. Removed extraneous result properties: `host`, `path`, `query`, etc.,\n//    which can be constructed using other parts of the url.\n//\n\n\nfunction Url() {\n  this.protocol = null;\n  this.slashes = null;\n  this.auth = null;\n  this.port = null;\n  this.hostname = null;\n  this.hash = null;\n  this.search = null;\n  this.pathname = null;\n}\n\n// Reference: RFC 3986, RFC 1808, RFC 2396\n\n// define these here so at least they only have to be\n// compiled once on the first module load.\nvar protocolPattern = /^([a-z0-9.+-]+:)/i,\n    portPattern = /:[0-9]*$/,\n\n    // Special case for a simple path URL\n    simplePathPattern = /^(\\/\\/?(?!\\/)[^\\?\\s]*)(\\?[^\\s]*)?$/,\n\n    // RFC 2396: characters reserved for delimiting URLs.\n    // We actually just auto-escape these.\n    delims = [ '<', '>', '\"', '`', ' ', '\\r', '\\n', '\\t' ],\n\n    // RFC 2396: characters not allowed for various reasons.\n    unwise = [ '{', '}', '|', '\\\\', '^', '`' ].concat(delims),\n\n    // Allowed by RFCs, but cause of XSS attacks.  Always escape these.\n    autoEscape = [ '\\'' ].concat(unwise),\n    // Characters that are never ever allowed in a hostname.\n    // Note that any invalid chars are also handled, but these\n    // are the ones that are *expected* to be seen, so we fast-path\n    // them.\n    nonHostChars = [ '%', '/', '?', ';', '#' ].concat(autoEscape),\n    hostEndingChars = [ '/', '?', '#' ],\n    hostnameMaxLen = 255,\n    hostnamePartPattern = /^[+a-z0-9A-Z_-]{0,63}$/,\n    hostnamePartStart = /^([+a-z0-9A-Z_-]{0,63})(.*)$/,\n    // protocols that can allow \"unsafe\" and \"unwise\" chars.\n    /* eslint-disable no-script-url */\n    // protocols that never have a hostname.\n    hostlessProtocol = {\n      'javascript': true,\n      'javascript:': true\n    },\n    // protocols that always contain a // bit.\n    slashedProtocol = {\n      'http': true,\n      'https': true,\n      'ftp': true,\n      'gopher': true,\n      'file': true,\n      'http:': true,\n      'https:': true,\n      'ftp:': true,\n      'gopher:': true,\n      'file:': true\n    };\n    /* eslint-enable no-script-url */\n\nfunction urlParse(url, slashesDenoteHost) {\n  if (url && url instanceof Url) { return url; }\n\n  var u = new Url();\n  u.parse(url, slashesDenoteHost);\n  return u;\n}\n\nUrl.prototype.parse = function(url, slashesDenoteHost) {\n  var i, l, lowerProto, hec, slashes,\n      rest = url;\n\n  // trim before proceeding.\n  // This is to support parse stuff like \"  http://foo.com  \\n\"\n  rest = rest.trim();\n\n  if (!slashesDenoteHost && url.split('#').length === 1) {\n    // Try fast path regexp\n    var simplePath = simplePathPattern.exec(rest);\n    if (simplePath) {\n      this.pathname = simplePath[1];\n      if (simplePath[2]) {\n        this.search = simplePath[2];\n      }\n      return this;\n    }\n  }\n\n  var proto = protocolPattern.exec(rest);\n  if (proto) {\n    proto = proto[0];\n    lowerProto = proto.toLowerCase();\n    this.protocol = proto;\n    rest = rest.substr(proto.length);\n  }\n\n  // figure out if it's got a host\n  // user@server is *always* interpreted as a hostname, and url\n  // resolution will treat //foo/bar as host=foo,path=bar because that's\n  // how the browser resolves relative URLs.\n  if (slashesDenoteHost || proto || rest.match(/^\\/\\/[^@\\/]+@[^@\\/]+/)) {\n    slashes = rest.substr(0, 2) === '//';\n    if (slashes && !(proto && hostlessProtocol[proto])) {\n      rest = rest.substr(2);\n      this.slashes = true;\n    }\n  }\n\n  if (!hostlessProtocol[proto] &&\n      (slashes || (proto && !slashedProtocol[proto]))) {\n\n    // there's a hostname.\n    // the first instance of /, ?, ;, or # ends the host.\n    //\n    // If there is an @ in the hostname, then non-host chars *are* allowed\n    // to the left of the last @ sign, unless some host-ending character\n    // comes *before* the @-sign.\n    // URLs are obnoxious.\n    //\n    // ex:\n    // http://a@b@c/ => user:a@b host:c\n    // http://a@b?@c => user:a host:c path:/?@c\n\n    // v0.12 TODO(isaacs): This is not quite how Chrome does things.\n    // Review our test case against browsers more comprehensively.\n\n    // find the first instance of any hostEndingChars\n    var hostEnd = -1;\n    for (i = 0; i < hostEndingChars.length; i++) {\n      hec = rest.indexOf(hostEndingChars[i]);\n      if (hec !== -1 && (hostEnd === -1 || hec < hostEnd)) {\n        hostEnd = hec;\n      }\n    }\n\n    // at this point, either we have an explicit point where the\n    // auth portion cannot go past, or the last @ char is the decider.\n    var auth, atSign;\n    if (hostEnd === -1) {\n      // atSign can be anywhere.\n      atSign = rest.lastIndexOf('@');\n    } else {\n      // atSign must be in auth portion.\n      // http://a@b/c@d => host:b auth:a path:/c@d\n      atSign = rest.lastIndexOf('@', hostEnd);\n    }\n\n    // Now we have a portion which is definitely the auth.\n    // Pull that off.\n    if (atSign !== -1) {\n      auth = rest.slice(0, atSign);\n      rest = rest.slice(atSign + 1);\n      this.auth = auth;\n    }\n\n    // the host is the remaining to the left of the first non-host char\n    hostEnd = -1;\n    for (i = 0; i < nonHostChars.length; i++) {\n      hec = rest.indexOf(nonHostChars[i]);\n      if (hec !== -1 && (hostEnd === -1 || hec < hostEnd)) {\n        hostEnd = hec;\n      }\n    }\n    // if we still have not hit it, then the entire thing is a host.\n    if (hostEnd === -1) {\n      hostEnd = rest.length;\n    }\n\n    if (rest[hostEnd - 1] === ':') { hostEnd--; }\n    var host = rest.slice(0, hostEnd);\n    rest = rest.slice(hostEnd);\n\n    // pull out port.\n    this.parseHost(host);\n\n    // we've indicated that there is a hostname,\n    // so even if it's empty, it has to be present.\n    this.hostname = this.hostname || '';\n\n    // if hostname begins with [ and ends with ]\n    // assume that it's an IPv6 address.\n    var ipv6Hostname = this.hostname[0] === '[' &&\n        this.hostname[this.hostname.length - 1] === ']';\n\n    // validate a little.\n    if (!ipv6Hostname) {\n      var hostparts = this.hostname.split(/\\./);\n      for (i = 0, l = hostparts.length; i < l; i++) {\n        var part = hostparts[i];\n        if (!part) { continue; }\n        if (!part.match(hostnamePartPattern)) {\n          var newpart = '';\n          for (var j = 0, k = part.length; j < k; j++) {\n            if (part.charCodeAt(j) > 127) {\n              // we replace non-ASCII char with a temporary placeholder\n              // we need this to make sure size of hostname is not\n              // broken by replacing non-ASCII by nothing\n              newpart += 'x';\n            } else {\n              newpart += part[j];\n            }\n          }\n          // we test again with ASCII char only\n          if (!newpart.match(hostnamePartPattern)) {\n            var validParts = hostparts.slice(0, i);\n            var notHost = hostparts.slice(i + 1);\n            var bit = part.match(hostnamePartStart);\n            if (bit) {\n              validParts.push(bit[1]);\n              notHost.unshift(bit[2]);\n            }\n            if (notHost.length) {\n              rest = notHost.join('.') + rest;\n            }\n            this.hostname = validParts.join('.');\n            break;\n          }\n        }\n      }\n    }\n\n    if (this.hostname.length > hostnameMaxLen) {\n      this.hostname = '';\n    }\n\n    // strip [ and ] from the hostname\n    // the host field still retains them, though\n    if (ipv6Hostname) {\n      this.hostname = this.hostname.substr(1, this.hostname.length - 2);\n    }\n  }\n\n  // chop off from the tail first.\n  var hash = rest.indexOf('#');\n  if (hash !== -1) {\n    // got a fragment string.\n    this.hash = rest.substr(hash);\n    rest = rest.slice(0, hash);\n  }\n  var qm = rest.indexOf('?');\n  if (qm !== -1) {\n    this.search = rest.substr(qm);\n    rest = rest.slice(0, qm);\n  }\n  if (rest) { this.pathname = rest; }\n  if (slashedProtocol[lowerProto] &&\n      this.hostname && !this.pathname) {\n    this.pathname = '';\n  }\n\n  return this;\n};\n\nUrl.prototype.parseHost = function(host) {\n  var port = portPattern.exec(host);\n  if (port) {\n    port = port[0];\n    if (port !== ':') {\n      this.port = port.substr(1);\n    }\n    host = host.substr(0, host.length - port.length);\n  }\n  if (host) { this.hostname = host; }\n};\n\nmodule.exports = urlParse;\n","'use strict';\n\n\nmodule.exports.encode = require('./encode');\nmodule.exports.decode = require('./decode');\nmodule.exports.format = require('./format');\nmodule.exports.parse  = require('./parse');\n","\n'use strict';\n\n\nmodule.exports = function format(url) {\n  var result = '';\n\n  result += url.protocol || '';\n  result += url.slashes ? '//' : '';\n  result += url.auth ? url.auth + '@' : '';\n\n  if (url.hostname && url.hostname.indexOf(':') !== -1) {\n    // ipv6 address\n    result += '[' + url.hostname + ']';\n  } else {\n    result += url.hostname || '';\n  }\n\n  result += url.port ? ':' + url.port : '';\n  result += url.pathname || '';\n  result += url.search || '';\n  result += url.hash || '';\n\n  return result;\n};\n","module.exports=/[\\0-\\uD7FF\\uE000-\\uFFFF]|[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]|[\\uD800-\\uDBFF](?![\\uDC00-\\uDFFF])|(?:[^\\uD800-\\uDBFF]|^)[\\uDC00-\\uDFFF]/","module.exports=/[\\0-\\x1F\\x7F-\\x9F]/","module.exports=/[ \\xA0\\u1680\\u2000-\\u200A\\u2028\\u2029\\u202F\\u205F\\u3000]/","'use strict';\n\nexports.Any = require('./properties/Any/regex');\nexports.Cc  = require('./categories/Cc/regex');\nexports.Cf  = require('./categories/Cf/regex');\nexports.P   = require('./categories/P/regex');\nexports.Z   = require('./categories/Z/regex');\n","module.exports=/[\\xAD\\u0600-\\u0605\\u061C\\u06DD\\u070F\\u08E2\\u180E\\u200B-\\u200F\\u202A-\\u202E\\u2060-\\u2064\\u2066-\\u206F\\uFEFF\\uFFF9-\\uFFFB]|\\uD804[\\uDCBD\\uDCCD]|\\uD82F[\\uDCA0-\\uDCA3]|\\uD834[\\uDD73-\\uDD7A]|\\uDB40[\\uDC01\\uDC20-\\uDC7F]/","// Utilities\n//\n'use strict';\n\n\nfunction _class(obj) { return Object.prototype.toString.call(obj); }\n\nfunction isString(obj) { return _class(obj) === '[object String]'; }\n\nvar _hasOwnProperty = Object.prototype.hasOwnProperty;\n\nfunction has(object, key) {\n  return _hasOwnProperty.call(object, key);\n}\n\n// Merge objects\n//\nfunction assign(obj /*from1, from2, from3, ...*/) {\n  var sources = Array.prototype.slice.call(arguments, 1);\n\n  sources.forEach(function (source) {\n    if (!source) { return; }\n\n    if (typeof source !== 'object') {\n      throw new TypeError(source + 'must be object');\n    }\n\n    Object.keys(source).forEach(function (key) {\n      obj[key] = source[key];\n    });\n  });\n\n  return obj;\n}\n\n// Remove element from array and put another array at those position.\n// Useful for some operations with tokens\nfunction arrayReplaceAt(src, pos, newElements) {\n  return [].concat(src.slice(0, pos), newElements, src.slice(pos + 1));\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nfunction isValidEntityCode(c) {\n  /*eslint no-bitwise:0*/\n  // broken sequence\n  if (c >= 0xD800 && c <= 0xDFFF) { return false; }\n  // never used\n  if (c >= 0xFDD0 && c <= 0xFDEF) { return false; }\n  if ((c & 0xFFFF) === 0xFFFF || (c & 0xFFFF) === 0xFFFE) { return false; }\n  // control codes\n  if (c >= 0x00 && c <= 0x08) { return false; }\n  if (c === 0x0B) { return false; }\n  if (c >= 0x0E && c <= 0x1F) { return false; }\n  if (c >= 0x7F && c <= 0x9F) { return false; }\n  // out of range\n  if (c > 0x10FFFF) { return false; }\n  return true;\n}\n\nfunction fromCodePoint(c) {\n  /*eslint no-bitwise:0*/\n  if (c > 0xffff) {\n    c -= 0x10000;\n    var surrogate1 = 0xd800 + (c >> 10),\n        surrogate2 = 0xdc00 + (c & 0x3ff);\n\n    return String.fromCharCode(surrogate1, surrogate2);\n  }\n  return String.fromCharCode(c);\n}\n\n\nvar UNESCAPE_MD_RE  = /\\\\([!\"#$%&'()*+,\\-.\\/:;<=>?@[\\\\\\]^_`{|}~])/g;\nvar ENTITY_RE       = /&([a-z#][a-z0-9]{1,31});/gi;\nvar UNESCAPE_ALL_RE = new RegExp(UNESCAPE_MD_RE.source + '|' + ENTITY_RE.source, 'gi');\n\nvar DIGITAL_ENTITY_TEST_RE = /^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))/i;\n\nvar entities = require('./entities');\n\nfunction replaceEntityPattern(match, name) {\n  var code = 0;\n\n  if (has(entities, name)) {\n    return entities[name];\n  }\n\n  if (name.charCodeAt(0) === 0x23/* # */ && DIGITAL_ENTITY_TEST_RE.test(name)) {\n    code = name[1].toLowerCase() === 'x' ?\n      parseInt(name.slice(2), 16) : parseInt(name.slice(1), 10);\n\n    if (isValidEntityCode(code)) {\n      return fromCodePoint(code);\n    }\n  }\n\n  return match;\n}\n\n/*function replaceEntities(str) {\n  if (str.indexOf('&') < 0) { return str; }\n\n  return str.replace(ENTITY_RE, replaceEntityPattern);\n}*/\n\nfunction unescapeMd(str) {\n  if (str.indexOf('\\\\') < 0) { return str; }\n  return str.replace(UNESCAPE_MD_RE, '$1');\n}\n\nfunction unescapeAll(str) {\n  if (str.indexOf('\\\\') < 0 && str.indexOf('&') < 0) { return str; }\n\n  return str.replace(UNESCAPE_ALL_RE, function (match, escaped, entity) {\n    if (escaped) { return escaped; }\n    return replaceEntityPattern(match, entity);\n  });\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nvar HTML_ESCAPE_TEST_RE = /[&<>\"]/;\nvar HTML_ESCAPE_REPLACE_RE = /[&<>\"]/g;\nvar HTML_REPLACEMENTS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;'\n};\n\nfunction replaceUnsafeChar(ch) {\n  return HTML_REPLACEMENTS[ch];\n}\n\nfunction escapeHtml(str) {\n  if (HTML_ESCAPE_TEST_RE.test(str)) {\n    return str.replace(HTML_ESCAPE_REPLACE_RE, replaceUnsafeChar);\n  }\n  return str;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nvar REGEXP_ESCAPE_RE = /[.?*+^$[\\]\\\\(){}|-]/g;\n\nfunction escapeRE(str) {\n  return str.replace(REGEXP_ESCAPE_RE, '\\\\$&');\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nfunction isSpace(code) {\n  switch (code) {\n    case 0x09:\n    case 0x20:\n      return true;\n  }\n  return false;\n}\n\n// Zs (unicode class) || [\\t\\f\\v\\r\\n]\nfunction isWhiteSpace(code) {\n  if (code >= 0x2000 && code <= 0x200A) { return true; }\n  switch (code) {\n    case 0x09: // \\t\n    case 0x0A: // \\n\n    case 0x0B: // \\v\n    case 0x0C: // \\f\n    case 0x0D: // \\r\n    case 0x20:\n    case 0xA0:\n    case 0x1680:\n    case 0x202F:\n    case 0x205F:\n    case 0x3000:\n      return true;\n  }\n  return false;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\n/*eslint-disable max-len*/\nvar UNICODE_PUNCT_RE = require('uc.micro/categories/P/regex');\n\n// Currently without astral characters support.\nfunction isPunctChar(ch) {\n  return UNICODE_PUNCT_RE.test(ch);\n}\n\n\n// Markdown ASCII punctuation characters.\n//\n// !, \", #, $, %, &, ', (, ), *, +, ,, -, ., /, :, ;, <, =, >, ?, @, [, \\, ], ^, _, `, {, |, }, or ~\n// http://spec.commonmark.org/0.15/#ascii-punctuation-character\n//\n// Don't confuse with unicode punctuation !!! It lacks some chars in ascii range.\n//\nfunction isMdAsciiPunct(ch) {\n  switch (ch) {\n    case 0x21/* ! */:\n    case 0x22/* \" */:\n    case 0x23/* # */:\n    case 0x24/* $ */:\n    case 0x25/* % */:\n    case 0x26/* & */:\n    case 0x27/* ' */:\n    case 0x28/* ( */:\n    case 0x29/* ) */:\n    case 0x2A/* * */:\n    case 0x2B/* + */:\n    case 0x2C/* , */:\n    case 0x2D/* - */:\n    case 0x2E/* . */:\n    case 0x2F/* / */:\n    case 0x3A/* : */:\n    case 0x3B/* ; */:\n    case 0x3C/* < */:\n    case 0x3D/* = */:\n    case 0x3E/* > */:\n    case 0x3F/* ? */:\n    case 0x40/* @ */:\n    case 0x5B/* [ */:\n    case 0x5C/* \\ */:\n    case 0x5D/* ] */:\n    case 0x5E/* ^ */:\n    case 0x5F/* _ */:\n    case 0x60/* ` */:\n    case 0x7B/* { */:\n    case 0x7C/* | */:\n    case 0x7D/* } */:\n    case 0x7E/* ~ */:\n      return true;\n    default:\n      return false;\n  }\n}\n\n// Hepler to unify [reference labels].\n//\nfunction normalizeReference(str) {\n  // Trim and collapse whitespace\n  //\n  str = str.trim().replace(/\\s+/g, ' ');\n\n  // In node v10 ''.toLowerCase() === '', which is presumed to be a bug\n  // fixed in v12 (couldn't find any details).\n  //\n  // So treat this one as a special case\n  // (remove this when node v10 is no longer supported).\n  //\n  if (''.toLowerCase() === '') {\n    str = str.replace(//g, '');\n  }\n\n  // .toLowerCase().toUpperCase() should get rid of all differences\n  // between letter variants.\n  //\n  // Simple .toLowerCase() doesn't normalize 125 code points correctly,\n  // and .toUpperCase doesn't normalize 6 of them (list of exceptions:\n  // , , , , ,  - those are already uppercased, but have differently\n  // uppercased versions).\n  //\n  // Here's an example showing how it happens. Lets take greek letter omega:\n  // uppercase U+0398 (), U+03f4 () and lowercase U+03b8 (), U+03d1 ()\n  //\n  // Unicode entries:\n  // 0398;GREEK CAPITAL LETTER THETA;Lu;0;L;;;;;N;;;;03B8;\n  // 03B8;GREEK SMALL LETTER THETA;Ll;0;L;;;;;N;;;0398;;0398\n  // 03D1;GREEK THETA SYMBOL;Ll;0;L;<compat> 03B8;;;;N;GREEK SMALL LETTER SCRIPT THETA;;0398;;0398\n  // 03F4;GREEK CAPITAL THETA SYMBOL;Lu;0;L;<compat> 0398;;;;N;;;;03B8;\n  //\n  // Case-insensitive comparison should treat all of them as equivalent.\n  //\n  // But .toLowerCase() doesn't change  (it's already lowercase),\n  // and .toUpperCase() doesn't change  (already uppercase).\n  //\n  // Applying first lower then upper case normalizes any character:\n  // '\\u0398\\u03f4\\u03b8\\u03d1'.toLowerCase().toUpperCase() === '\\u0398\\u0398\\u0398\\u0398'\n  //\n  // Note: this is equivalent to unicode case folding; unicode normalization\n  // is a different step that is not required here.\n  //\n  // Final result should be uppercased, because it's later stored in an object\n  // (this avoid a conflict with Object.prototype members,\n  // most notably, `__proto__`)\n  //\n  return str.toLowerCase().toUpperCase();\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\n// Re-export libraries commonly used in both markdown-it and its plugins,\n// so plugins won't have to depend on them explicitly, which reduces their\n// bundled size (e.g. a browser build).\n//\nexports.lib                 = {};\nexports.lib.mdurl           = require('mdurl');\nexports.lib.ucmicro         = require('uc.micro');\n\nexports.assign              = assign;\nexports.isString            = isString;\nexports.has                 = has;\nexports.unescapeMd          = unescapeMd;\nexports.unescapeAll         = unescapeAll;\nexports.isValidEntityCode   = isValidEntityCode;\nexports.fromCodePoint       = fromCodePoint;\n// exports.replaceEntities     = replaceEntities;\nexports.escapeHtml          = escapeHtml;\nexports.arrayReplaceAt      = arrayReplaceAt;\nexports.isSpace             = isSpace;\nexports.isWhiteSpace        = isWhiteSpace;\nexports.isMdAsciiPunct      = isMdAsciiPunct;\nexports.isPunctChar         = isPunctChar;\nexports.escapeRE            = escapeRE;\nexports.normalizeReference  = normalizeReference;\n","// Parse link destination\n//\n'use strict';\n\n\nvar unescapeAll = require('../common/utils').unescapeAll;\n\n\nmodule.exports = function parseLinkDestination(str, pos, max) {\n  var code, level,\n      lines = 0,\n      start = pos,\n      result = {\n        ok: false,\n        pos: 0,\n        lines: 0,\n        str: ''\n      };\n\n  if (str.charCodeAt(pos) === 0x3C /* < */) {\n    pos++;\n    while (pos < max) {\n      code = str.charCodeAt(pos);\n      if (code === 0x0A /* \\n */) { return result; }\n      if (code === 0x3C /* < */) { return result; }\n      if (code === 0x3E /* > */) {\n        result.pos = pos + 1;\n        result.str = unescapeAll(str.slice(start + 1, pos));\n        result.ok = true;\n        return result;\n      }\n      if (code === 0x5C /* \\ */ && pos + 1 < max) {\n        pos += 2;\n        continue;\n      }\n\n      pos++;\n    }\n\n    // no closing '>'\n    return result;\n  }\n\n  // this should be ... } else { ... branch\n\n  level = 0;\n  while (pos < max) {\n    code = str.charCodeAt(pos);\n\n    if (code === 0x20) { break; }\n\n    // ascii control characters\n    if (code < 0x20 || code === 0x7F) { break; }\n\n    if (code === 0x5C /* \\ */ && pos + 1 < max) {\n      if (str.charCodeAt(pos + 1) === 0x20) { break; }\n      pos += 2;\n      continue;\n    }\n\n    if (code === 0x28 /* ( */) {\n      level++;\n      if (level > 32) { return result; }\n    }\n\n    if (code === 0x29 /* ) */) {\n      if (level === 0) { break; }\n      level--;\n    }\n\n    pos++;\n  }\n\n  if (start === pos) { return result; }\n  if (level !== 0) { return result; }\n\n  result.str = unescapeAll(str.slice(start, pos));\n  result.lines = lines;\n  result.pos = pos;\n  result.ok = true;\n  return result;\n};\n","// Parse link title\n//\n'use strict';\n\n\nvar unescapeAll = require('../common/utils').unescapeAll;\n\n\nmodule.exports = function parseLinkTitle(str, pos, max) {\n  var code,\n      marker,\n      lines = 0,\n      start = pos,\n      result = {\n        ok: false,\n        pos: 0,\n        lines: 0,\n        str: ''\n      };\n\n  if (pos >= max) { return result; }\n\n  marker = str.charCodeAt(pos);\n\n  if (marker !== 0x22 /* \" */ && marker !== 0x27 /* ' */ && marker !== 0x28 /* ( */) { return result; }\n\n  pos++;\n\n  // if opening marker is \"(\", switch it to closing marker \")\"\n  if (marker === 0x28) { marker = 0x29; }\n\n  while (pos < max) {\n    code = str.charCodeAt(pos);\n    if (code === marker) {\n      result.pos = pos + 1;\n      result.lines = lines;\n      result.str = unescapeAll(str.slice(start + 1, pos));\n      result.ok = true;\n      return result;\n    } else if (code === 0x28 /* ( */ && marker === 0x29 /* ) */) {\n      return result;\n    } else if (code === 0x0A) {\n      lines++;\n    } else if (code === 0x5C /* \\ */ && pos + 1 < max) {\n      pos++;\n      if (str.charCodeAt(pos) === 0x0A) {\n        lines++;\n      }\n    }\n\n    pos++;\n  }\n\n  return result;\n};\n","// Just a shortcut for bulk export\n'use strict';\n\n\nexports.parseLinkLabel       = require('./parse_link_label');\nexports.parseLinkDestination = require('./parse_link_destination');\nexports.parseLinkTitle       = require('./parse_link_title');\n","// Parse link label\n//\n// this function assumes that first character (\"[\") already matches;\n// returns the end of the label\n//\n'use strict';\n\nmodule.exports = function parseLinkLabel(state, start, disableNested) {\n  var level, found, marker, prevPos,\n      labelEnd = -1,\n      max = state.posMax,\n      oldPos = state.pos;\n\n  state.pos = start + 1;\n  level = 1;\n\n  while (state.pos < max) {\n    marker = state.src.charCodeAt(state.pos);\n    if (marker === 0x5D /* ] */) {\n      level--;\n      if (level === 0) {\n        found = true;\n        break;\n      }\n    }\n\n    prevPos = state.pos;\n    state.md.inline.skipToken(state);\n    if (marker === 0x5B /* [ */) {\n      if (prevPos === state.pos - 1) {\n        // increase level if we find text `[`, which is not a part of any token\n        level++;\n      } else if (disableNested) {\n        state.pos = oldPos;\n        return -1;\n      }\n    }\n  }\n\n  if (found) {\n    labelEnd = state.pos;\n  }\n\n  // restore old state\n  state.pos = oldPos;\n\n  return labelEnd;\n};\n","/**\n * class Renderer\n *\n * Generates HTML from parsed token stream. Each instance has independent\n * copy of rules. Those can be rewritten with ease. Also, you can add new\n * rules if you create plugin and adds new token types.\n **/\n'use strict';\n\n\nvar assign          = require('./common/utils').assign;\nvar unescapeAll     = require('./common/utils').unescapeAll;\nvar escapeHtml      = require('./common/utils').escapeHtml;\n\n\n////////////////////////////////////////////////////////////////////////////////\n\nvar default_rules = {};\n\n\ndefault_rules.code_inline = function (tokens, idx, options, env, slf) {\n  var token = tokens[idx];\n\n  return  '<code' + slf.renderAttrs(token) + '>' +\n          escapeHtml(tokens[idx].content) +\n          '</code>';\n};\n\n\ndefault_rules.code_block = function (tokens, idx, options, env, slf) {\n  var token = tokens[idx];\n\n  return  '<pre' + slf.renderAttrs(token) + '><code>' +\n          escapeHtml(tokens[idx].content) +\n          '</code></pre>\\n';\n};\n\n\ndefault_rules.fence = function (tokens, idx, options, env, slf) {\n  var token = tokens[idx],\n      info = token.info ? unescapeAll(token.info).trim() : '',\n      langName = '',\n      langAttrs = '',\n      highlighted, i, arr, tmpAttrs, tmpToken;\n\n  if (info) {\n    arr = info.split(/(\\s+)/g);\n    langName = arr[0];\n    langAttrs = arr.slice(2).join('');\n  }\n\n  if (options.highlight) {\n    highlighted = options.highlight(token.content, langName, langAttrs) || escapeHtml(token.content);\n  } else {\n    highlighted = escapeHtml(token.content);\n  }\n\n  if (highlighted.indexOf('<pre') === 0) {\n    return highlighted + '\\n';\n  }\n\n  // If language exists, inject class gently, without modifying original token.\n  // May be, one day we will add .deepClone() for token and simplify this part, but\n  // now we prefer to keep things local.\n  if (info) {\n    i        = token.attrIndex('class');\n    tmpAttrs = token.attrs ? token.attrs.slice() : [];\n\n    if (i < 0) {\n      tmpAttrs.push([ 'class', options.langPrefix + langName ]);\n    } else {\n      tmpAttrs[i] = tmpAttrs[i].slice();\n      tmpAttrs[i][1] += ' ' + options.langPrefix + langName;\n    }\n\n    // Fake token just to render attributes\n    tmpToken = {\n      attrs: tmpAttrs\n    };\n\n    return  '<pre><code' + slf.renderAttrs(tmpToken) + '>'\n          + highlighted\n          + '</code></pre>\\n';\n  }\n\n\n  return  '<pre><code' + slf.renderAttrs(token) + '>'\n        + highlighted\n        + '</code></pre>\\n';\n};\n\n\ndefault_rules.image = function (tokens, idx, options, env, slf) {\n  var token = tokens[idx];\n\n  // \"alt\" attr MUST be set, even if empty. Because it's mandatory and\n  // should be placed on proper position for tests.\n  //\n  // Replace content with actual value\n\n  token.attrs[token.attrIndex('alt')][1] =\n    slf.renderInlineAsText(token.children, options, env);\n\n  return slf.renderToken(tokens, idx, options);\n};\n\n\ndefault_rules.hardbreak = function (tokens, idx, options /*, env */) {\n  return options.xhtmlOut ? '<br />\\n' : '<br>\\n';\n};\ndefault_rules.softbreak = function (tokens, idx, options /*, env */) {\n  return options.breaks ? (options.xhtmlOut ? '<br />\\n' : '<br>\\n') : '\\n';\n};\n\n\ndefault_rules.text = function (tokens, idx /*, options, env */) {\n  return escapeHtml(tokens[idx].content);\n};\n\n\ndefault_rules.html_block = function (tokens, idx /*, options, env */) {\n  return tokens[idx].content;\n};\ndefault_rules.html_inline = function (tokens, idx /*, options, env */) {\n  return tokens[idx].content;\n};\n\n\n/**\n * new Renderer()\n *\n * Creates new [[Renderer]] instance and fill [[Renderer#rules]] with defaults.\n **/\nfunction Renderer() {\n\n  /**\n   * Renderer#rules -> Object\n   *\n   * Contains render rules for tokens. Can be updated and extended.\n   *\n   * ##### Example\n   *\n   * ```javascript\n   * var md = require('markdown-it')();\n   *\n   * md.renderer.rules.strong_open  = function () { return '<b>'; };\n   * md.renderer.rules.strong_close = function () { return '</b>'; };\n   *\n   * var result = md.renderInline(...);\n   * ```\n   *\n   * Each rule is called as independent static function with fixed signature:\n   *\n   * ```javascript\n   * function my_token_render(tokens, idx, options, env, renderer) {\n   *   // ...\n   *   return renderedHTML;\n   * }\n   * ```\n   *\n   * See [source code](https://github.com/markdown-it/markdown-it/blob/master/lib/renderer.js)\n   * for more details and examples.\n   **/\n  this.rules = assign({}, default_rules);\n}\n\n\n/**\n * Renderer.renderAttrs(token) -> String\n *\n * Render token attributes to string.\n **/\nRenderer.prototype.renderAttrs = function renderAttrs(token) {\n  var i, l, result;\n\n  if (!token.attrs) { return ''; }\n\n  result = '';\n\n  for (i = 0, l = token.attrs.length; i < l; i++) {\n    result += ' ' + escapeHtml(token.attrs[i][0]) + '=\"' + escapeHtml(token.attrs[i][1]) + '\"';\n  }\n\n  return result;\n};\n\n\n/**\n * Renderer.renderToken(tokens, idx, options) -> String\n * - tokens (Array): list of tokens\n * - idx (Numbed): token index to render\n * - options (Object): params of parser instance\n *\n * Default token renderer. Can be overriden by custom function\n * in [[Renderer#rules]].\n **/\nRenderer.prototype.renderToken = function renderToken(tokens, idx, options) {\n  var nextToken,\n      result = '',\n      needLf = false,\n      token = tokens[idx];\n\n  // Tight list paragraphs\n  if (token.hidden) {\n    return '';\n  }\n\n  // Insert a newline between hidden paragraph and subsequent opening\n  // block-level tag.\n  //\n  // For example, here we should insert a newline before blockquote:\n  //  - a\n  //    >\n  //\n  if (token.block && token.nesting !== -1 && idx && tokens[idx - 1].hidden) {\n    result += '\\n';\n  }\n\n  // Add token name, e.g. `<img`\n  result += (token.nesting === -1 ? '</' : '<') + token.tag;\n\n  // Encode attributes, e.g. `<img src=\"foo\"`\n  result += this.renderAttrs(token);\n\n  // Add a slash for self-closing tags, e.g. `<img src=\"foo\" /`\n  if (token.nesting === 0 && options.xhtmlOut) {\n    result += ' /';\n  }\n\n  // Check if we need to add a newline after this tag\n  if (token.block) {\n    needLf = true;\n\n    if (token.nesting === 1) {\n      if (idx + 1 < tokens.length) {\n        nextToken = tokens[idx + 1];\n\n        if (nextToken.type === 'inline' || nextToken.hidden) {\n          // Block-level tag containing an inline tag.\n          //\n          needLf = false;\n\n        } else if (nextToken.nesting === -1 && nextToken.tag === token.tag) {\n          // Opening tag + closing tag of the same type. E.g. `<li></li>`.\n          //\n          needLf = false;\n        }\n      }\n    }\n  }\n\n  result += needLf ? '>\\n' : '>';\n\n  return result;\n};\n\n\n/**\n * Renderer.renderInline(tokens, options, env) -> String\n * - tokens (Array): list on block tokens to render\n * - options (Object): params of parser instance\n * - env (Object): additional data from parsed input (references, for example)\n *\n * The same as [[Renderer.render]], but for single token of `inline` type.\n **/\nRenderer.prototype.renderInline = function (tokens, options, env) {\n  var type,\n      result = '',\n      rules = this.rules;\n\n  for (var i = 0, len = tokens.length; i < len; i++) {\n    type = tokens[i].type;\n\n    if (typeof rules[type] !== 'undefined') {\n      result += rules[type](tokens, i, options, env, this);\n    } else {\n      result += this.renderToken(tokens, i, options);\n    }\n  }\n\n  return result;\n};\n\n\n/** internal\n * Renderer.renderInlineAsText(tokens, options, env) -> String\n * - tokens (Array): list on block tokens to render\n * - options (Object): params of parser instance\n * - env (Object): additional data from parsed input (references, for example)\n *\n * Special kludge for image `alt` attributes to conform CommonMark spec.\n * Don't try to use it! Spec requires to show `alt` content with stripped markup,\n * instead of simple escaping.\n **/\nRenderer.prototype.renderInlineAsText = function (tokens, options, env) {\n  var result = '';\n\n  for (var i = 0, len = tokens.length; i < len; i++) {\n    if (tokens[i].type === 'text') {\n      result += tokens[i].content;\n    } else if (tokens[i].type === 'image') {\n      result += this.renderInlineAsText(tokens[i].children, options, env);\n    } else if (tokens[i].type === 'softbreak') {\n      result += '\\n';\n    }\n  }\n\n  return result;\n};\n\n\n/**\n * Renderer.render(tokens, options, env) -> String\n * - tokens (Array): list on block tokens to render\n * - options (Object): params of parser instance\n * - env (Object): additional data from parsed input (references, for example)\n *\n * Takes token stream and generates HTML. Probably, you will never need to call\n * this method directly.\n **/\nRenderer.prototype.render = function (tokens, options, env) {\n  var i, len, type,\n      result = '',\n      rules = this.rules;\n\n  for (i = 0, len = tokens.length; i < len; i++) {\n    type = tokens[i].type;\n\n    if (type === 'inline') {\n      result += this.renderInline(tokens[i].children, options, env);\n    } else if (typeof rules[type] !== 'undefined') {\n      result += rules[tokens[i].type](tokens, i, options, env, this);\n    } else {\n      result += this.renderToken(tokens, i, options, env);\n    }\n  }\n\n  return result;\n};\n\nmodule.exports = Renderer;\n","/**\n * class Ruler\n *\n * Helper class, used by [[MarkdownIt#core]], [[MarkdownIt#block]] and\n * [[MarkdownIt#inline]] to manage sequences of functions (rules):\n *\n * - keep rules in defined order\n * - assign the name to each rule\n * - enable/disable rules\n * - add/replace rules\n * - allow assign rules to additional named chains (in the same)\n * - cacheing lists of active rules\n *\n * You will not need use this class directly until write plugins. For simple\n * rules control use [[MarkdownIt.disable]], [[MarkdownIt.enable]] and\n * [[MarkdownIt.use]].\n **/\n'use strict';\n\n\n/**\n * new Ruler()\n **/\nfunction Ruler() {\n  // List of added rules. Each element is:\n  //\n  // {\n  //   name: XXX,\n  //   enabled: Boolean,\n  //   fn: Function(),\n  //   alt: [ name2, name3 ]\n  // }\n  //\n  this.__rules__ = [];\n\n  // Cached rule chains.\n  //\n  // First level - chain name, '' for default.\n  // Second level - diginal anchor for fast filtering by charcodes.\n  //\n  this.__cache__ = null;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Helper methods, should not be used directly\n\n\n// Find rule index by name\n//\nRuler.prototype.__find__ = function (name) {\n  for (var i = 0; i < this.__rules__.length; i++) {\n    if (this.__rules__[i].name === name) {\n      return i;\n    }\n  }\n  return -1;\n};\n\n\n// Build rules lookup cache\n//\nRuler.prototype.__compile__ = function () {\n  var self = this;\n  var chains = [ '' ];\n\n  // collect unique names\n  self.__rules__.forEach(function (rule) {\n    if (!rule.enabled) { return; }\n\n    rule.alt.forEach(function (altName) {\n      if (chains.indexOf(altName) < 0) {\n        chains.push(altName);\n      }\n    });\n  });\n\n  self.__cache__ = {};\n\n  chains.forEach(function (chain) {\n    self.__cache__[chain] = [];\n    self.__rules__.forEach(function (rule) {\n      if (!rule.enabled) { return; }\n\n      if (chain && rule.alt.indexOf(chain) < 0) { return; }\n\n      self.__cache__[chain].push(rule.fn);\n    });\n  });\n};\n\n\n/**\n * Ruler.at(name, fn [, options])\n * - name (String): rule name to replace.\n * - fn (Function): new rule function.\n * - options (Object): new rule options (not mandatory).\n *\n * Replace rule by name with new function & options. Throws error if name not\n * found.\n *\n * ##### Options:\n *\n * - __alt__ - array with names of \"alternate\" chains.\n *\n * ##### Example\n *\n * Replace existing typographer replacement rule with new one:\n *\n * ```javascript\n * var md = require('markdown-it')();\n *\n * md.core.ruler.at('replacements', function replace(state) {\n *   //...\n * });\n * ```\n **/\nRuler.prototype.at = function (name, fn, options) {\n  var index = this.__find__(name);\n  var opt = options || {};\n\n  if (index === -1) { throw new Error('Parser rule not found: ' + name); }\n\n  this.__rules__[index].fn = fn;\n  this.__rules__[index].alt = opt.alt || [];\n  this.__cache__ = null;\n};\n\n\n/**\n * Ruler.before(beforeName, ruleName, fn [, options])\n * - beforeName (String): new rule will be added before this one.\n * - ruleName (String): name of added rule.\n * - fn (Function): rule function.\n * - options (Object): rule options (not mandatory).\n *\n * Add new rule to chain before one with given name. See also\n * [[Ruler.after]], [[Ruler.push]].\n *\n * ##### Options:\n *\n * - __alt__ - array with names of \"alternate\" chains.\n *\n * ##### Example\n *\n * ```javascript\n * var md = require('markdown-it')();\n *\n * md.block.ruler.before('paragraph', 'my_rule', function replace(state) {\n *   //...\n * });\n * ```\n **/\nRuler.prototype.before = function (beforeName, ruleName, fn, options) {\n  var index = this.__find__(beforeName);\n  var opt = options || {};\n\n  if (index === -1) { throw new Error('Parser rule not found: ' + beforeName); }\n\n  this.__rules__.splice(index, 0, {\n    name: ruleName,\n    enabled: true,\n    fn: fn,\n    alt: opt.alt || []\n  });\n\n  this.__cache__ = null;\n};\n\n\n/**\n * Ruler.after(afterName, ruleName, fn [, options])\n * - afterName (String): new rule will be added after this one.\n * - ruleName (String): name of added rule.\n * - fn (Function): rule function.\n * - options (Object): rule options (not mandatory).\n *\n * Add new rule to chain after one with given name. See also\n * [[Ruler.before]], [[Ruler.push]].\n *\n * ##### Options:\n *\n * - __alt__ - array with names of \"alternate\" chains.\n *\n * ##### Example\n *\n * ```javascript\n * var md = require('markdown-it')();\n *\n * md.inline.ruler.after('text', 'my_rule', function replace(state) {\n *   //...\n * });\n * ```\n **/\nRuler.prototype.after = function (afterName, ruleName, fn, options) {\n  var index = this.__find__(afterName);\n  var opt = options || {};\n\n  if (index === -1) { throw new Error('Parser rule not found: ' + afterName); }\n\n  this.__rules__.splice(index + 1, 0, {\n    name: ruleName,\n    enabled: true,\n    fn: fn,\n    alt: opt.alt || []\n  });\n\n  this.__cache__ = null;\n};\n\n/**\n * Ruler.push(ruleName, fn [, options])\n * - ruleName (String): name of added rule.\n * - fn (Function): rule function.\n * - options (Object): rule options (not mandatory).\n *\n * Push new rule to the end of chain. See also\n * [[Ruler.before]], [[Ruler.after]].\n *\n * ##### Options:\n *\n * - __alt__ - array with names of \"alternate\" chains.\n *\n * ##### Example\n *\n * ```javascript\n * var md = require('markdown-it')();\n *\n * md.core.ruler.push('my_rule', function replace(state) {\n *   //...\n * });\n * ```\n **/\nRuler.prototype.push = function (ruleName, fn, options) {\n  var opt = options || {};\n\n  this.__rules__.push({\n    name: ruleName,\n    enabled: true,\n    fn: fn,\n    alt: opt.alt || []\n  });\n\n  this.__cache__ = null;\n};\n\n\n/**\n * Ruler.enable(list [, ignoreInvalid]) -> Array\n * - list (String|Array): list of rule names to enable.\n * - ignoreInvalid (Boolean): set `true` to ignore errors when rule not found.\n *\n * Enable rules with given names. If any rule name not found - throw Error.\n * Errors can be disabled by second param.\n *\n * Returns list of found rule names (if no exception happened).\n *\n * See also [[Ruler.disable]], [[Ruler.enableOnly]].\n **/\nRuler.prototype.enable = function (list, ignoreInvalid) {\n  if (!Array.isArray(list)) { list = [ list ]; }\n\n  var result = [];\n\n  // Search by name and enable\n  list.forEach(function (name) {\n    var idx = this.__find__(name);\n\n    if (idx < 0) {\n      if (ignoreInvalid) { return; }\n      throw new Error('Rules manager: invalid rule name ' + name);\n    }\n    this.__rules__[idx].enabled = true;\n    result.push(name);\n  }, this);\n\n  this.__cache__ = null;\n  return result;\n};\n\n\n/**\n * Ruler.enableOnly(list [, ignoreInvalid])\n * - list (String|Array): list of rule names to enable (whitelist).\n * - ignoreInvalid (Boolean): set `true` to ignore errors when rule not found.\n *\n * Enable rules with given names, and disable everything else. If any rule name\n * not found - throw Error. Errors can be disabled by second param.\n *\n * See also [[Ruler.disable]], [[Ruler.enable]].\n **/\nRuler.prototype.enableOnly = function (list, ignoreInvalid) {\n  if (!Array.isArray(list)) { list = [ list ]; }\n\n  this.__rules__.forEach(function (rule) { rule.enabled = false; });\n\n  this.enable(list, ignoreInvalid);\n};\n\n\n/**\n * Ruler.disable(list [, ignoreInvalid]) -> Array\n * - list (String|Array): list of rule names to disable.\n * - ignoreInvalid (Boolean): set `true` to ignore errors when rule not found.\n *\n * Disable rules with given names. If any rule name not found - throw Error.\n * Errors can be disabled by second param.\n *\n * Returns list of found rule names (if no exception happened).\n *\n * See also [[Ruler.enable]], [[Ruler.enableOnly]].\n **/\nRuler.prototype.disable = function (list, ignoreInvalid) {\n  if (!Array.isArray(list)) { list = [ list ]; }\n\n  var result = [];\n\n  // Search by name and disable\n  list.forEach(function (name) {\n    var idx = this.__find__(name);\n\n    if (idx < 0) {\n      if (ignoreInvalid) { return; }\n      throw new Error('Rules manager: invalid rule name ' + name);\n    }\n    this.__rules__[idx].enabled = false;\n    result.push(name);\n  }, this);\n\n  this.__cache__ = null;\n  return result;\n};\n\n\n/**\n * Ruler.getRules(chainName) -> Array\n *\n * Return array of active functions (rules) for given chain name. It analyzes\n * rules configuration, compiles caches if not exists and returns result.\n *\n * Default chain name is `''` (empty string). It can't be skipped. That's\n * done intentionally, to keep signature monomorphic for high speed.\n **/\nRuler.prototype.getRules = function (chainName) {\n  if (this.__cache__ === null) {\n    this.__compile__();\n  }\n\n  // Chain can be empty, if rules disabled. But we still have to return Array.\n  return this.__cache__[chainName] || [];\n};\n\nmodule.exports = Ruler;\n","// Normalize input string\n\n'use strict';\n\n\n// https://spec.commonmark.org/0.29/#line-ending\nvar NEWLINES_RE  = /\\r\\n?|\\n/g;\nvar NULL_RE      = /\\0/g;\n\n\nmodule.exports = function normalize(state) {\n  var str;\n\n  // Normalize newlines\n  str = state.src.replace(NEWLINES_RE, '\\n');\n\n  // Replace NULL characters\n  str = str.replace(NULL_RE, '\\uFFFD');\n\n  state.src = str;\n};\n","// Replace link-like texts with link nodes.\n//\n// Currently restricted by `md.validateLink()` to http/https/ftp\n//\n'use strict';\n\n\nvar arrayReplaceAt = require('../common/utils').arrayReplaceAt;\n\n\nfunction isLinkOpen(str) {\n  return /^<a[>\\s]/i.test(str);\n}\nfunction isLinkClose(str) {\n  return /^<\\/a\\s*>/i.test(str);\n}\n\n\nmodule.exports = function linkify(state) {\n  var i, j, l, tokens, token, currentToken, nodes, ln, text, pos, lastPos,\n      level, htmlLinkLevel, url, fullUrl, urlText,\n      blockTokens = state.tokens,\n      links;\n\n  if (!state.md.options.linkify) { return; }\n\n  for (j = 0, l = blockTokens.length; j < l; j++) {\n    if (blockTokens[j].type !== 'inline' ||\n        !state.md.linkify.pretest(blockTokens[j].content)) {\n      continue;\n    }\n\n    tokens = blockTokens[j].children;\n\n    htmlLinkLevel = 0;\n\n    // We scan from the end, to keep position when new tags added.\n    // Use reversed logic in links start/end match\n    for (i = tokens.length - 1; i >= 0; i--) {\n      currentToken = tokens[i];\n\n      // Skip content of markdown links\n      if (currentToken.type === 'link_close') {\n        i--;\n        while (tokens[i].level !== currentToken.level && tokens[i].type !== 'link_open') {\n          i--;\n        }\n        continue;\n      }\n\n      // Skip content of html tag links\n      if (currentToken.type === 'html_inline') {\n        if (isLinkOpen(currentToken.content) && htmlLinkLevel > 0) {\n          htmlLinkLevel--;\n        }\n        if (isLinkClose(currentToken.content)) {\n          htmlLinkLevel++;\n        }\n      }\n      if (htmlLinkLevel > 0) { continue; }\n\n      if (currentToken.type === 'text' && state.md.linkify.test(currentToken.content)) {\n\n        text = currentToken.content;\n        links = state.md.linkify.match(text);\n\n        // Now split string to nodes\n        nodes = [];\n        level = currentToken.level;\n        lastPos = 0;\n\n        // forbid escape sequence at the start of the string,\n        // this avoids http\\://example.com/ from being linkified as\n        // http:<a href=\"//example.com/\">//example.com/</a>\n        if (links.length > 0 &&\n            links[0].index === 0 &&\n            i > 0 &&\n            tokens[i - 1].type === 'text_special') {\n          links = links.slice(1);\n        }\n\n        for (ln = 0; ln < links.length; ln++) {\n          url = links[ln].url;\n          fullUrl = state.md.normalizeLink(url);\n          if (!state.md.validateLink(fullUrl)) { continue; }\n\n          urlText = links[ln].text;\n\n          // Linkifier might send raw hostnames like \"example.com\", where url\n          // starts with domain name. So we prepend http:// in those cases,\n          // and remove it afterwards.\n          //\n          if (!links[ln].schema) {\n            urlText = state.md.normalizeLinkText('http://' + urlText).replace(/^http:\\/\\//, '');\n          } else if (links[ln].schema === 'mailto:' && !/^mailto:/i.test(urlText)) {\n            urlText = state.md.normalizeLinkText('mailto:' + urlText).replace(/^mailto:/, '');\n          } else {\n            urlText = state.md.normalizeLinkText(urlText);\n          }\n\n          pos = links[ln].index;\n\n          if (pos > lastPos) {\n            token         = new state.Token('text', '', 0);\n            token.content = text.slice(lastPos, pos);\n            token.level   = level;\n            nodes.push(token);\n          }\n\n          token         = new state.Token('link_open', 'a', 1);\n          token.attrs   = [ [ 'href', fullUrl ] ];\n          token.level   = level++;\n          token.markup  = 'linkify';\n          token.info    = 'auto';\n          nodes.push(token);\n\n          token         = new state.Token('text', '', 0);\n          token.content = urlText;\n          token.level   = level;\n          nodes.push(token);\n\n          token         = new state.Token('link_close', 'a', -1);\n          token.level   = --level;\n          token.markup  = 'linkify';\n          token.info    = 'auto';\n          nodes.push(token);\n\n          lastPos = links[ln].lastIndex;\n        }\n        if (lastPos < text.length) {\n          token         = new state.Token('text', '', 0);\n          token.content = text.slice(lastPos);\n          token.level   = level;\n          nodes.push(token);\n        }\n\n        // replace current node\n        blockTokens[j].children = tokens = arrayReplaceAt(tokens, i, nodes);\n      }\n    }\n  }\n};\n","// Simple typographic replacements\n//\n// (c) (C)  \n// (tm) (TM)  \n// (r) (R)  \n// +-  \n// (p) (P) -> \n// ...   (also ?....  ?.., !....  !..)\n// ????????  ???, !!!!!  !!!, `,,`  `,`\n// --  &ndash;, ---  &mdash;\n//\n'use strict';\n\n// TODO:\n// - fractionals 1/2, 1/4, 3/4 -> , , \n// - multiplications 2 x 4 -> 2  4\n\nvar RARE_RE = /\\+-|\\.\\.|\\?\\?\\?\\?|!!!!|,,|--/;\n\n// Workaround for phantomjs - need regex without /g flag,\n// or root check will fail every second time\nvar SCOPED_ABBR_TEST_RE = /\\((c|tm|r)\\)/i;\n\nvar SCOPED_ABBR_RE = /\\((c|tm|r)\\)/ig;\nvar SCOPED_ABBR = {\n  c: '',\n  r: '',\n  tm: ''\n};\n\nfunction replaceFn(match, name) {\n  return SCOPED_ABBR[name.toLowerCase()];\n}\n\nfunction replace_scoped(inlineTokens) {\n  var i, token, inside_autolink = 0;\n\n  for (i = inlineTokens.length - 1; i >= 0; i--) {\n    token = inlineTokens[i];\n\n    if (token.type === 'text' && !inside_autolink) {\n      token.content = token.content.replace(SCOPED_ABBR_RE, replaceFn);\n    }\n\n    if (token.type === 'link_open' && token.info === 'auto') {\n      inside_autolink--;\n    }\n\n    if (token.type === 'link_close' && token.info === 'auto') {\n      inside_autolink++;\n    }\n  }\n}\n\nfunction replace_rare(inlineTokens) {\n  var i, token, inside_autolink = 0;\n\n  for (i = inlineTokens.length - 1; i >= 0; i--) {\n    token = inlineTokens[i];\n\n    if (token.type === 'text' && !inside_autolink) {\n      if (RARE_RE.test(token.content)) {\n        token.content = token.content\n          .replace(/\\+-/g, '')\n          // .., ..., ....... -> \n          // but ?..... & !..... -> ?.. & !..\n          .replace(/\\.{2,}/g, '').replace(/([?!])/g, '$1..')\n          .replace(/([?!]){4,}/g, '$1$1$1').replace(/,{2,}/g, ',')\n          // em-dash\n          .replace(/(^|[^-])---(?=[^-]|$)/mg, '$1\\u2014')\n          // en-dash\n          .replace(/(^|\\s)--(?=\\s|$)/mg, '$1\\u2013')\n          .replace(/(^|[^-\\s])--(?=[^-\\s]|$)/mg, '$1\\u2013');\n      }\n    }\n\n    if (token.type === 'link_open' && token.info === 'auto') {\n      inside_autolink--;\n    }\n\n    if (token.type === 'link_close' && token.info === 'auto') {\n      inside_autolink++;\n    }\n  }\n}\n\n\nmodule.exports = function replace(state) {\n  var blkIdx;\n\n  if (!state.md.options.typographer) { return; }\n\n  for (blkIdx = state.tokens.length - 1; blkIdx >= 0; blkIdx--) {\n\n    if (state.tokens[blkIdx].type !== 'inline') { continue; }\n\n    if (SCOPED_ABBR_TEST_RE.test(state.tokens[blkIdx].content)) {\n      replace_scoped(state.tokens[blkIdx].children);\n    }\n\n    if (RARE_RE.test(state.tokens[blkIdx].content)) {\n      replace_rare(state.tokens[blkIdx].children);\n    }\n\n  }\n};\n","// Convert straight quotation marks to typographic ones\n//\n'use strict';\n\n\nvar isWhiteSpace   = require('../common/utils').isWhiteSpace;\nvar isPunctChar    = require('../common/utils').isPunctChar;\nvar isMdAsciiPunct = require('../common/utils').isMdAsciiPunct;\n\nvar QUOTE_TEST_RE = /['\"]/;\nvar QUOTE_RE = /['\"]/g;\nvar APOSTROPHE = '\\u2019'; /*  */\n\n\nfunction replaceAt(str, index, ch) {\n  return str.slice(0, index) + ch + str.slice(index + 1);\n}\n\nfunction process_inlines(tokens, state) {\n  var i, token, text, t, pos, max, thisLevel, item, lastChar, nextChar,\n      isLastPunctChar, isNextPunctChar, isLastWhiteSpace, isNextWhiteSpace,\n      canOpen, canClose, j, isSingle, stack, openQuote, closeQuote;\n\n  stack = [];\n\n  for (i = 0; i < tokens.length; i++) {\n    token = tokens[i];\n\n    thisLevel = tokens[i].level;\n\n    for (j = stack.length - 1; j >= 0; j--) {\n      if (stack[j].level <= thisLevel) { break; }\n    }\n    stack.length = j + 1;\n\n    if (token.type !== 'text') { continue; }\n\n    text = token.content;\n    pos = 0;\n    max = text.length;\n\n    /*eslint no-labels:0,block-scoped-var:0*/\n    OUTER:\n    while (pos < max) {\n      QUOTE_RE.lastIndex = pos;\n      t = QUOTE_RE.exec(text);\n      if (!t) { break; }\n\n      canOpen = canClose = true;\n      pos = t.index + 1;\n      isSingle = (t[0] === \"'\");\n\n      // Find previous character,\n      // default to space if it's the beginning of the line\n      //\n      lastChar = 0x20;\n\n      if (t.index - 1 >= 0) {\n        lastChar = text.charCodeAt(t.index - 1);\n      } else {\n        for (j = i - 1; j >= 0; j--) {\n          if (tokens[j].type === 'softbreak' || tokens[j].type === 'hardbreak') break; // lastChar defaults to 0x20\n          if (!tokens[j].content) continue; // should skip all tokens except 'text', 'html_inline' or 'code_inline'\n\n          lastChar = tokens[j].content.charCodeAt(tokens[j].content.length - 1);\n          break;\n        }\n      }\n\n      // Find next character,\n      // default to space if it's the end of the line\n      //\n      nextChar = 0x20;\n\n      if (pos < max) {\n        nextChar = text.charCodeAt(pos);\n      } else {\n        for (j = i + 1; j < tokens.length; j++) {\n          if (tokens[j].type === 'softbreak' || tokens[j].type === 'hardbreak') break; // nextChar defaults to 0x20\n          if (!tokens[j].content) continue; // should skip all tokens except 'text', 'html_inline' or 'code_inline'\n\n          nextChar = tokens[j].content.charCodeAt(0);\n          break;\n        }\n      }\n\n      isLastPunctChar = isMdAsciiPunct(lastChar) || isPunctChar(String.fromCharCode(lastChar));\n      isNextPunctChar = isMdAsciiPunct(nextChar) || isPunctChar(String.fromCharCode(nextChar));\n\n      isLastWhiteSpace = isWhiteSpace(lastChar);\n      isNextWhiteSpace = isWhiteSpace(nextChar);\n\n      if (isNextWhiteSpace) {\n        canOpen = false;\n      } else if (isNextPunctChar) {\n        if (!(isLastWhiteSpace || isLastPunctChar)) {\n          canOpen = false;\n        }\n      }\n\n      if (isLastWhiteSpace) {\n        canClose = false;\n      } else if (isLastPunctChar) {\n        if (!(isNextWhiteSpace || isNextPunctChar)) {\n          canClose = false;\n        }\n      }\n\n      if (nextChar === 0x22 /* \" */ && t[0] === '\"') {\n        if (lastChar >= 0x30 /* 0 */ && lastChar <= 0x39 /* 9 */) {\n          // special case: 1\"\" - count first quote as an inch\n          canClose = canOpen = false;\n        }\n      }\n\n      if (canOpen && canClose) {\n        // Replace quotes in the middle of punctuation sequence, but not\n        // in the middle of the words, i.e.:\n        //\n        // 1. foo \" bar \" baz - not replaced\n        // 2. foo-\"-bar-\"-baz - replaced\n        // 3. foo\"bar\"baz     - not replaced\n        //\n        canOpen = isLastPunctChar;\n        canClose = isNextPunctChar;\n      }\n\n      if (!canOpen && !canClose) {\n        // middle of word\n        if (isSingle) {\n          token.content = replaceAt(token.content, t.index, APOSTROPHE);\n        }\n        continue;\n      }\n\n      if (canClose) {\n        // this could be a closing quote, rewind the stack to get a match\n        for (j = stack.length - 1; j >= 0; j--) {\n          item = stack[j];\n          if (stack[j].level < thisLevel) { break; }\n          if (item.single === isSingle && stack[j].level === thisLevel) {\n            item = stack[j];\n\n            if (isSingle) {\n              openQuote = state.md.options.quotes[2];\n              closeQuote = state.md.options.quotes[3];\n            } else {\n              openQuote = state.md.options.quotes[0];\n              closeQuote = state.md.options.quotes[1];\n            }\n\n            // replace token.content *before* tokens[item.token].content,\n            // because, if they are pointing at the same token, replaceAt\n            // could mess up indices when quote length != 1\n            token.content = replaceAt(token.content, t.index, closeQuote);\n            tokens[item.token].content = replaceAt(\n              tokens[item.token].content, item.pos, openQuote);\n\n            pos += closeQuote.length - 1;\n            if (item.token === i) { pos += openQuote.length - 1; }\n\n            text = token.content;\n            max = text.length;\n\n            stack.length = j;\n            continue OUTER;\n          }\n        }\n      }\n\n      if (canOpen) {\n        stack.push({\n          token: i,\n          pos: t.index,\n          single: isSingle,\n          level: thisLevel\n        });\n      } else if (canClose && isSingle) {\n        token.content = replaceAt(token.content, t.index, APOSTROPHE);\n      }\n    }\n  }\n}\n\n\nmodule.exports = function smartquotes(state) {\n  /*eslint max-depth:0*/\n  var blkIdx;\n\n  if (!state.md.options.typographer) { return; }\n\n  for (blkIdx = state.tokens.length - 1; blkIdx >= 0; blkIdx--) {\n\n    if (state.tokens[blkIdx].type !== 'inline' ||\n        !QUOTE_TEST_RE.test(state.tokens[blkIdx].content)) {\n      continue;\n    }\n\n    process_inlines(state.tokens[blkIdx].children, state);\n  }\n};\n","// Token class\n\n'use strict';\n\n\n/**\n * class Token\n **/\n\n/**\n * new Token(type, tag, nesting)\n *\n * Create new token and fill passed properties.\n **/\nfunction Token(type, tag, nesting) {\n  /**\n   * Token#type -> String\n   *\n   * Type of the token (string, e.g. \"paragraph_open\")\n   **/\n  this.type     = type;\n\n  /**\n   * Token#tag -> String\n   *\n   * html tag name, e.g. \"p\"\n   **/\n  this.tag      = tag;\n\n  /**\n   * Token#attrs -> Array\n   *\n   * Html attributes. Format: `[ [ name1, value1 ], [ name2, value2 ] ]`\n   **/\n  this.attrs    = null;\n\n  /**\n   * Token#map -> Array\n   *\n   * Source map info. Format: `[ line_begin, line_end ]`\n   **/\n  this.map      = null;\n\n  /**\n   * Token#nesting -> Number\n   *\n   * Level change (number in {-1, 0, 1} set), where:\n   *\n   * -  `1` means the tag is opening\n   * -  `0` means the tag is self-closing\n   * - `-1` means the tag is closing\n   **/\n  this.nesting  = nesting;\n\n  /**\n   * Token#level -> Number\n   *\n   * nesting level, the same as `state.level`\n   **/\n  this.level    = 0;\n\n  /**\n   * Token#children -> Array\n   *\n   * An array of child nodes (inline and img tokens)\n   **/\n  this.children = null;\n\n  /**\n   * Token#content -> String\n   *\n   * In a case of self-closing tag (code, html, fence, etc.),\n   * it has contents of this tag.\n   **/\n  this.content  = '';\n\n  /**\n   * Token#markup -> String\n   *\n   * '*' or '_' for emphasis, fence string for fence, etc.\n   **/\n  this.markup   = '';\n\n  /**\n   * Token#info -> String\n   *\n   * Additional information:\n   *\n   * - Info string for \"fence\" tokens\n   * - The value \"auto\" for autolink \"link_open\" and \"link_close\" tokens\n   * - The string value of the item marker for ordered-list \"list_item_open\" tokens\n   **/\n  this.info     = '';\n\n  /**\n   * Token#meta -> Object\n   *\n   * A place for plugins to store an arbitrary data\n   **/\n  this.meta     = null;\n\n  /**\n   * Token#block -> Boolean\n   *\n   * True for block-level tokens, false for inline tokens.\n   * Used in renderer to calculate line breaks\n   **/\n  this.block    = false;\n\n  /**\n   * Token#hidden -> Boolean\n   *\n   * If it's true, ignore this element when rendering. Used for tight lists\n   * to hide paragraphs.\n   **/\n  this.hidden   = false;\n}\n\n\n/**\n * Token.attrIndex(name) -> Number\n *\n * Search attribute index by name.\n **/\nToken.prototype.attrIndex = function attrIndex(name) {\n  var attrs, i, len;\n\n  if (!this.attrs) { return -1; }\n\n  attrs = this.attrs;\n\n  for (i = 0, len = attrs.length; i < len; i++) {\n    if (attrs[i][0] === name) { return i; }\n  }\n  return -1;\n};\n\n\n/**\n * Token.attrPush(attrData)\n *\n * Add `[ name, value ]` attribute to list. Init attrs if necessary\n **/\nToken.prototype.attrPush = function attrPush(attrData) {\n  if (this.attrs) {\n    this.attrs.push(attrData);\n  } else {\n    this.attrs = [ attrData ];\n  }\n};\n\n\n/**\n * Token.attrSet(name, value)\n *\n * Set `name` attribute to `value`. Override old value if exists.\n **/\nToken.prototype.attrSet = function attrSet(name, value) {\n  var idx = this.attrIndex(name),\n      attrData = [ name, value ];\n\n  if (idx < 0) {\n    this.attrPush(attrData);\n  } else {\n    this.attrs[idx] = attrData;\n  }\n};\n\n\n/**\n * Token.attrGet(name)\n *\n * Get the value of attribute `name`, or null if it does not exist.\n **/\nToken.prototype.attrGet = function attrGet(name) {\n  var idx = this.attrIndex(name), value = null;\n  if (idx >= 0) {\n    value = this.attrs[idx][1];\n  }\n  return value;\n};\n\n\n/**\n * Token.attrJoin(name, value)\n *\n * Join value to existing attribute via space. Or create new attribute if not\n * exists. Useful to operate with token classes.\n **/\nToken.prototype.attrJoin = function attrJoin(name, value) {\n  var idx = this.attrIndex(name);\n\n  if (idx < 0) {\n    this.attrPush([ name, value ]);\n  } else {\n    this.attrs[idx][1] = this.attrs[idx][1] + ' ' + value;\n  }\n};\n\n\nmodule.exports = Token;\n","// Core state object\n//\n'use strict';\n\nvar Token = require('../token');\n\n\nfunction StateCore(src, md, env) {\n  this.src = src;\n  this.env = env;\n  this.tokens = [];\n  this.inlineMode = false;\n  this.md = md; // link to parser instance\n}\n\n// re-export Token class to use in core rules\nStateCore.prototype.Token = Token;\n\n\nmodule.exports = StateCore;\n","/** internal\n * class Core\n *\n * Top-level rules executor. Glues block/inline parsers and does intermediate\n * transformations.\n **/\n'use strict';\n\n\nvar Ruler  = require('./ruler');\n\n\nvar _rules = [\n  [ 'normalize',      require('./rules_core/normalize')      ],\n  [ 'block',          require('./rules_core/block')          ],\n  [ 'inline',         require('./rules_core/inline')         ],\n  [ 'linkify',        require('./rules_core/linkify')        ],\n  [ 'replacements',   require('./rules_core/replacements')   ],\n  [ 'smartquotes',    require('./rules_core/smartquotes')    ],\n  // `text_join` finds `text_special` tokens (for escape sequences)\n  // and joins them with the rest of the text\n  [ 'text_join',      require('./rules_core/text_join')      ]\n];\n\n\n/**\n * new Core()\n **/\nfunction Core() {\n  /**\n   * Core#ruler -> Ruler\n   *\n   * [[Ruler]] instance. Keep configuration of core rules.\n   **/\n  this.ruler = new Ruler();\n\n  for (var i = 0; i < _rules.length; i++) {\n    this.ruler.push(_rules[i][0], _rules[i][1]);\n  }\n}\n\n\n/**\n * Core.process(state)\n *\n * Executes core chain rules.\n **/\nCore.prototype.process = function (state) {\n  var i, l, rules;\n\n  rules = this.ruler.getRules('');\n\n  for (i = 0, l = rules.length; i < l; i++) {\n    rules[i](state);\n  }\n};\n\nCore.prototype.State = require('./rules_core/state_core');\n\n\nmodule.exports = Core;\n","'use strict';\n\n\nmodule.exports = function block(state) {\n  var token;\n\n  if (state.inlineMode) {\n    token          = new state.Token('inline', '', 0);\n    token.content  = state.src;\n    token.map      = [ 0, 1 ];\n    token.children = [];\n    state.tokens.push(token);\n  } else {\n    state.md.block.parse(state.src, state.md, state.env, state.tokens);\n  }\n};\n","'use strict';\n\nmodule.exports = function inline(state) {\n  var tokens = state.tokens, tok, i, l;\n\n  // Parse inlines\n  for (i = 0, l = tokens.length; i < l; i++) {\n    tok = tokens[i];\n    if (tok.type === 'inline') {\n      state.md.inline.parse(tok.content, state.md, state.env, tok.children);\n    }\n  }\n};\n","// Join raw text tokens with the rest of the text\n//\n// This is set as a separate rule to provide an opportunity for plugins\n// to run text replacements after text join, but before escape join.\n//\n// For example, `\\:)` shouldn't be replaced with an emoji.\n//\n'use strict';\n\n\nmodule.exports = function text_join(state) {\n  var j, l, tokens, curr, max, last,\n      blockTokens = state.tokens;\n\n  for (j = 0, l = blockTokens.length; j < l; j++) {\n    if (blockTokens[j].type !== 'inline') continue;\n\n    tokens = blockTokens[j].children;\n    max = tokens.length;\n\n    for (curr = 0; curr < max; curr++) {\n      if (tokens[curr].type === 'text_special') {\n        tokens[curr].type = 'text';\n      }\n    }\n\n    for (curr = last = 0; curr < max; curr++) {\n      if (tokens[curr].type === 'text' &&\n          curr + 1 < max &&\n          tokens[curr + 1].type === 'text') {\n\n        // collapse two adjacent text nodes\n        tokens[curr + 1].content = tokens[curr].content + tokens[curr + 1].content;\n      } else {\n        if (curr !== last) { tokens[last] = tokens[curr]; }\n\n        last++;\n      }\n    }\n\n    if (curr !== last) {\n      tokens.length = last;\n    }\n  }\n};\n","// GFM table, https://github.github.com/gfm/#tables-extension-\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\nfunction getLine(state, line) {\n  var pos = state.bMarks[line] + state.tShift[line],\n      max = state.eMarks[line];\n\n  return state.src.slice(pos, max);\n}\n\nfunction escapedSplit(str) {\n  var result = [],\n      pos = 0,\n      max = str.length,\n      ch,\n      isEscaped = false,\n      lastPos = 0,\n      current = '';\n\n  ch  = str.charCodeAt(pos);\n\n  while (pos < max) {\n    if (ch === 0x7c/* | */) {\n      if (!isEscaped) {\n        // pipe separating cells, '|'\n        result.push(current + str.substring(lastPos, pos));\n        current = '';\n        lastPos = pos + 1;\n      } else {\n        // escaped pipe, '\\|'\n        current += str.substring(lastPos, pos - 1);\n        lastPos = pos;\n      }\n    }\n\n    isEscaped = (ch === 0x5c/* \\ */);\n    pos++;\n\n    ch = str.charCodeAt(pos);\n  }\n\n  result.push(current + str.substring(lastPos));\n\n  return result;\n}\n\n\nmodule.exports = function table(state, startLine, endLine, silent) {\n  var ch, lineText, pos, i, l, nextLine, columns, columnCount, token,\n      aligns, t, tableLines, tbodyLines, oldParentType, terminate,\n      terminatorRules, firstCh, secondCh;\n\n  // should have at least two lines\n  if (startLine + 2 > endLine) { return false; }\n\n  nextLine = startLine + 1;\n\n  if (state.sCount[nextLine] < state.blkIndent) { return false; }\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[nextLine] - state.blkIndent >= 4) { return false; }\n\n  // first character of the second line should be '|', '-', ':',\n  // and no other characters are allowed but spaces;\n  // basically, this is the equivalent of /^[-:|][-:|\\s]*$/ regexp\n\n  pos = state.bMarks[nextLine] + state.tShift[nextLine];\n  if (pos >= state.eMarks[nextLine]) { return false; }\n\n  firstCh = state.src.charCodeAt(pos++);\n  if (firstCh !== 0x7C/* | */ && firstCh !== 0x2D/* - */ && firstCh !== 0x3A/* : */) { return false; }\n\n  if (pos >= state.eMarks[nextLine]) { return false; }\n\n  secondCh = state.src.charCodeAt(pos++);\n  if (secondCh !== 0x7C/* | */ && secondCh !== 0x2D/* - */ && secondCh !== 0x3A/* : */ && !isSpace(secondCh)) {\n    return false;\n  }\n\n  // if first character is '-', then second character must not be a space\n  // (due to parsing ambiguity with list)\n  if (firstCh === 0x2D/* - */ && isSpace(secondCh)) { return false; }\n\n  while (pos < state.eMarks[nextLine]) {\n    ch = state.src.charCodeAt(pos);\n\n    if (ch !== 0x7C/* | */ && ch !== 0x2D/* - */ && ch !== 0x3A/* : */ && !isSpace(ch)) { return false; }\n\n    pos++;\n  }\n\n  lineText = getLine(state, startLine + 1);\n\n  columns = lineText.split('|');\n  aligns = [];\n  for (i = 0; i < columns.length; i++) {\n    t = columns[i].trim();\n    if (!t) {\n      // allow empty columns before and after table, but not in between columns;\n      // e.g. allow ` |---| `, disallow ` ---||--- `\n      if (i === 0 || i === columns.length - 1) {\n        continue;\n      } else {\n        return false;\n      }\n    }\n\n    if (!/^:?-+:?$/.test(t)) { return false; }\n    if (t.charCodeAt(t.length - 1) === 0x3A/* : */) {\n      aligns.push(t.charCodeAt(0) === 0x3A/* : */ ? 'center' : 'right');\n    } else if (t.charCodeAt(0) === 0x3A/* : */) {\n      aligns.push('left');\n    } else {\n      aligns.push('');\n    }\n  }\n\n  lineText = getLine(state, startLine).trim();\n  if (lineText.indexOf('|') === -1) { return false; }\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n  columns = escapedSplit(lineText);\n  if (columns.length && columns[0] === '') columns.shift();\n  if (columns.length && columns[columns.length - 1] === '') columns.pop();\n\n  // header row will define an amount of columns in the entire table,\n  // and align row should be exactly the same (the rest of the rows can differ)\n  columnCount = columns.length;\n  if (columnCount === 0 || columnCount !== aligns.length) { return false; }\n\n  if (silent) { return true; }\n\n  oldParentType = state.parentType;\n  state.parentType = 'table';\n\n  // use 'blockquote' lists for termination because it's\n  // the most similar to tables\n  terminatorRules = state.md.block.ruler.getRules('blockquote');\n\n  token     = state.push('table_open', 'table', 1);\n  token.map = tableLines = [ startLine, 0 ];\n\n  token     = state.push('thead_open', 'thead', 1);\n  token.map = [ startLine, startLine + 1 ];\n\n  token     = state.push('tr_open', 'tr', 1);\n  token.map = [ startLine, startLine + 1 ];\n\n  for (i = 0; i < columns.length; i++) {\n    token          = state.push('th_open', 'th', 1);\n    if (aligns[i]) {\n      token.attrs  = [ [ 'style', 'text-align:' + aligns[i] ] ];\n    }\n\n    token          = state.push('inline', '', 0);\n    token.content  = columns[i].trim();\n    token.children = [];\n\n    token          = state.push('th_close', 'th', -1);\n  }\n\n  token     = state.push('tr_close', 'tr', -1);\n  token     = state.push('thead_close', 'thead', -1);\n\n  for (nextLine = startLine + 2; nextLine < endLine; nextLine++) {\n    if (state.sCount[nextLine] < state.blkIndent) { break; }\n\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n\n    if (terminate) { break; }\n    lineText = getLine(state, nextLine).trim();\n    if (!lineText) { break; }\n    if (state.sCount[nextLine] - state.blkIndent >= 4) { break; }\n    columns = escapedSplit(lineText);\n    if (columns.length && columns[0] === '') columns.shift();\n    if (columns.length && columns[columns.length - 1] === '') columns.pop();\n\n    if (nextLine === startLine + 2) {\n      token     = state.push('tbody_open', 'tbody', 1);\n      token.map = tbodyLines = [ startLine + 2, 0 ];\n    }\n\n    token     = state.push('tr_open', 'tr', 1);\n    token.map = [ nextLine, nextLine + 1 ];\n\n    for (i = 0; i < columnCount; i++) {\n      token          = state.push('td_open', 'td', 1);\n      if (aligns[i]) {\n        token.attrs  = [ [ 'style', 'text-align:' + aligns[i] ] ];\n      }\n\n      token          = state.push('inline', '', 0);\n      token.content  = columns[i] ? columns[i].trim() : '';\n      token.children = [];\n\n      token          = state.push('td_close', 'td', -1);\n    }\n    token = state.push('tr_close', 'tr', -1);\n  }\n\n  if (tbodyLines) {\n    token = state.push('tbody_close', 'tbody', -1);\n    tbodyLines[1] = nextLine;\n  }\n\n  token = state.push('table_close', 'table', -1);\n  tableLines[1] = nextLine;\n\n  state.parentType = oldParentType;\n  state.line = nextLine;\n  return true;\n};\n","// Block quotes\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\nmodule.exports = function blockquote(state, startLine, endLine, silent) {\n  var adjustTab,\n      ch,\n      i,\n      initial,\n      l,\n      lastLineEmpty,\n      lines,\n      nextLine,\n      offset,\n      oldBMarks,\n      oldBSCount,\n      oldIndent,\n      oldParentType,\n      oldSCount,\n      oldTShift,\n      spaceAfterMarker,\n      terminate,\n      terminatorRules,\n      token,\n      isOutdented,\n      oldLineMax = state.lineMax,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine];\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  // check the block quote marker\n  if (state.src.charCodeAt(pos++) !== 0x3E/* > */) { return false; }\n\n  // we know that it's going to be a valid blockquote,\n  // so no point trying to find the end of it in silent mode\n  if (silent) { return true; }\n\n  // set offset past spaces and \">\"\n  initial = offset = state.sCount[startLine] + 1;\n\n  // skip one optional space after '>'\n  if (state.src.charCodeAt(pos) === 0x20 /* space */) {\n    // ' >   test '\n    //     ^ -- position start of line here:\n    pos++;\n    initial++;\n    offset++;\n    adjustTab = false;\n    spaceAfterMarker = true;\n  } else if (state.src.charCodeAt(pos) === 0x09 /* tab */) {\n    spaceAfterMarker = true;\n\n    if ((state.bsCount[startLine] + offset) % 4 === 3) {\n      // '  >\\t  test '\n      //       ^ -- position start of line here (tab has width===1)\n      pos++;\n      initial++;\n      offset++;\n      adjustTab = false;\n    } else {\n      // ' >\\t  test '\n      //    ^ -- position start of line here + shift bsCount slightly\n      //         to make extra space appear\n      adjustTab = true;\n    }\n  } else {\n    spaceAfterMarker = false;\n  }\n\n  oldBMarks = [ state.bMarks[startLine] ];\n  state.bMarks[startLine] = pos;\n\n  while (pos < max) {\n    ch = state.src.charCodeAt(pos);\n\n    if (isSpace(ch)) {\n      if (ch === 0x09) {\n        offset += 4 - (offset + state.bsCount[startLine] + (adjustTab ? 1 : 0)) % 4;\n      } else {\n        offset++;\n      }\n    } else {\n      break;\n    }\n\n    pos++;\n  }\n\n  oldBSCount = [ state.bsCount[startLine] ];\n  state.bsCount[startLine] = state.sCount[startLine] + 1 + (spaceAfterMarker ? 1 : 0);\n\n  lastLineEmpty = pos >= max;\n\n  oldSCount = [ state.sCount[startLine] ];\n  state.sCount[startLine] = offset - initial;\n\n  oldTShift = [ state.tShift[startLine] ];\n  state.tShift[startLine] = pos - state.bMarks[startLine];\n\n  terminatorRules = state.md.block.ruler.getRules('blockquote');\n\n  oldParentType = state.parentType;\n  state.parentType = 'blockquote';\n\n  // Search the end of the block\n  //\n  // Block ends with either:\n  //  1. an empty line outside:\n  //     ```\n  //     > test\n  //\n  //     ```\n  //  2. an empty line inside:\n  //     ```\n  //     >\n  //     test\n  //     ```\n  //  3. another tag:\n  //     ```\n  //     > test\n  //      - - -\n  //     ```\n  for (nextLine = startLine + 1; nextLine < endLine; nextLine++) {\n    // check if it's outdented, i.e. it's inside list item and indented\n    // less than said list item:\n    //\n    // ```\n    // 1. anything\n    //    > current blockquote\n    // 2. checking this line\n    // ```\n    isOutdented = state.sCount[nextLine] < state.blkIndent;\n\n    pos = state.bMarks[nextLine] + state.tShift[nextLine];\n    max = state.eMarks[nextLine];\n\n    if (pos >= max) {\n      // Case 1: line is not inside the blockquote, and this line is empty.\n      break;\n    }\n\n    if (state.src.charCodeAt(pos++) === 0x3E/* > */ && !isOutdented) {\n      // This line is inside the blockquote.\n\n      // set offset past spaces and \">\"\n      initial = offset = state.sCount[nextLine] + 1;\n\n      // skip one optional space after '>'\n      if (state.src.charCodeAt(pos) === 0x20 /* space */) {\n        // ' >   test '\n        //     ^ -- position start of line here:\n        pos++;\n        initial++;\n        offset++;\n        adjustTab = false;\n        spaceAfterMarker = true;\n      } else if (state.src.charCodeAt(pos) === 0x09 /* tab */) {\n        spaceAfterMarker = true;\n\n        if ((state.bsCount[nextLine] + offset) % 4 === 3) {\n          // '  >\\t  test '\n          //       ^ -- position start of line here (tab has width===1)\n          pos++;\n          initial++;\n          offset++;\n          adjustTab = false;\n        } else {\n          // ' >\\t  test '\n          //    ^ -- position start of line here + shift bsCount slightly\n          //         to make extra space appear\n          adjustTab = true;\n        }\n      } else {\n        spaceAfterMarker = false;\n      }\n\n      oldBMarks.push(state.bMarks[nextLine]);\n      state.bMarks[nextLine] = pos;\n\n      while (pos < max) {\n        ch = state.src.charCodeAt(pos);\n\n        if (isSpace(ch)) {\n          if (ch === 0x09) {\n            offset += 4 - (offset + state.bsCount[nextLine] + (adjustTab ? 1 : 0)) % 4;\n          } else {\n            offset++;\n          }\n        } else {\n          break;\n        }\n\n        pos++;\n      }\n\n      lastLineEmpty = pos >= max;\n\n      oldBSCount.push(state.bsCount[nextLine]);\n      state.bsCount[nextLine] = state.sCount[nextLine] + 1 + (spaceAfterMarker ? 1 : 0);\n\n      oldSCount.push(state.sCount[nextLine]);\n      state.sCount[nextLine] = offset - initial;\n\n      oldTShift.push(state.tShift[nextLine]);\n      state.tShift[nextLine] = pos - state.bMarks[nextLine];\n      continue;\n    }\n\n    // Case 2: line is not inside the blockquote, and the last line was empty.\n    if (lastLineEmpty) { break; }\n\n    // Case 3: another tag found.\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n\n    if (terminate) {\n      // Quirk to enforce \"hard termination mode\" for paragraphs;\n      // normally if you call `tokenize(state, startLine, nextLine)`,\n      // paragraphs will look below nextLine for paragraph continuation,\n      // but if blockquote is terminated by another tag, they shouldn't\n      state.lineMax = nextLine;\n\n      if (state.blkIndent !== 0) {\n        // state.blkIndent was non-zero, we now set it to zero,\n        // so we need to re-calculate all offsets to appear as\n        // if indent wasn't changed\n        oldBMarks.push(state.bMarks[nextLine]);\n        oldBSCount.push(state.bsCount[nextLine]);\n        oldTShift.push(state.tShift[nextLine]);\n        oldSCount.push(state.sCount[nextLine]);\n        state.sCount[nextLine] -= state.blkIndent;\n      }\n\n      break;\n    }\n\n    oldBMarks.push(state.bMarks[nextLine]);\n    oldBSCount.push(state.bsCount[nextLine]);\n    oldTShift.push(state.tShift[nextLine]);\n    oldSCount.push(state.sCount[nextLine]);\n\n    // A negative indentation means that this is a paragraph continuation\n    //\n    state.sCount[nextLine] = -1;\n  }\n\n  oldIndent = state.blkIndent;\n  state.blkIndent = 0;\n\n  token        = state.push('blockquote_open', 'blockquote', 1);\n  token.markup = '>';\n  token.map    = lines = [ startLine, 0 ];\n\n  state.md.block.tokenize(state, startLine, nextLine);\n\n  token        = state.push('blockquote_close', 'blockquote', -1);\n  token.markup = '>';\n\n  state.lineMax = oldLineMax;\n  state.parentType = oldParentType;\n  lines[1] = state.line;\n\n  // Restore original tShift; this might not be necessary since the parser\n  // has already been here, but just to make sure we can do that.\n  for (i = 0; i < oldTShift.length; i++) {\n    state.bMarks[i + startLine] = oldBMarks[i];\n    state.tShift[i + startLine] = oldTShift[i];\n    state.sCount[i + startLine] = oldSCount[i];\n    state.bsCount[i + startLine] = oldBSCount[i];\n  }\n  state.blkIndent = oldIndent;\n\n  return true;\n};\n","// Horizontal rule\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\nmodule.exports = function hr(state, startLine, endLine, silent) {\n  var marker, cnt, ch, token,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine];\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  marker = state.src.charCodeAt(pos++);\n\n  // Check hr marker\n  if (marker !== 0x2A/* * */ &&\n      marker !== 0x2D/* - */ &&\n      marker !== 0x5F/* _ */) {\n    return false;\n  }\n\n  // markers can be mixed with spaces, but there should be at least 3 of them\n\n  cnt = 1;\n  while (pos < max) {\n    ch = state.src.charCodeAt(pos++);\n    if (ch !== marker && !isSpace(ch)) { return false; }\n    if (ch === marker) { cnt++; }\n  }\n\n  if (cnt < 3) { return false; }\n\n  if (silent) { return true; }\n\n  state.line = startLine + 1;\n\n  token        = state.push('hr', 'hr', 0);\n  token.map    = [ startLine, state.line ];\n  token.markup = Array(cnt + 1).join(String.fromCharCode(marker));\n\n  return true;\n};\n","// Lists\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\n// Search `[-+*][\\n ]`, returns next pos after marker on success\n// or -1 on fail.\nfunction skipBulletListMarker(state, startLine) {\n  var marker, pos, max, ch;\n\n  pos = state.bMarks[startLine] + state.tShift[startLine];\n  max = state.eMarks[startLine];\n\n  marker = state.src.charCodeAt(pos++);\n  // Check bullet\n  if (marker !== 0x2A/* * */ &&\n      marker !== 0x2D/* - */ &&\n      marker !== 0x2B/* + */) {\n    return -1;\n  }\n\n  if (pos < max) {\n    ch = state.src.charCodeAt(pos);\n\n    if (!isSpace(ch)) {\n      // \" -test \" - is not a list item\n      return -1;\n    }\n  }\n\n  return pos;\n}\n\n// Search `\\d+[.)][\\n ]`, returns next pos after marker on success\n// or -1 on fail.\nfunction skipOrderedListMarker(state, startLine) {\n  var ch,\n      start = state.bMarks[startLine] + state.tShift[startLine],\n      pos = start,\n      max = state.eMarks[startLine];\n\n  // List marker should have at least 2 chars (digit + dot)\n  if (pos + 1 >= max) { return -1; }\n\n  ch = state.src.charCodeAt(pos++);\n\n  if (ch < 0x30/* 0 */ || ch > 0x39/* 9 */) { return -1; }\n\n  for (;;) {\n    // EOL -> fail\n    if (pos >= max) { return -1; }\n\n    ch = state.src.charCodeAt(pos++);\n\n    if (ch >= 0x30/* 0 */ && ch <= 0x39/* 9 */) {\n\n      // List marker should have no more than 9 digits\n      // (prevents integer overflow in browsers)\n      if (pos - start >= 10) { return -1; }\n\n      continue;\n    }\n\n    // found valid marker\n    if (ch === 0x29/* ) */ || ch === 0x2e/* . */) {\n      break;\n    }\n\n    return -1;\n  }\n\n\n  if (pos < max) {\n    ch = state.src.charCodeAt(pos);\n\n    if (!isSpace(ch)) {\n      // \" 1.test \" - is not a list item\n      return -1;\n    }\n  }\n  return pos;\n}\n\nfunction markTightParagraphs(state, idx) {\n  var i, l,\n      level = state.level + 2;\n\n  for (i = idx + 2, l = state.tokens.length - 2; i < l; i++) {\n    if (state.tokens[i].level === level && state.tokens[i].type === 'paragraph_open') {\n      state.tokens[i + 2].hidden = true;\n      state.tokens[i].hidden = true;\n      i += 2;\n    }\n  }\n}\n\n\nmodule.exports = function list(state, startLine, endLine, silent) {\n  var ch,\n      contentStart,\n      i,\n      indent,\n      indentAfterMarker,\n      initial,\n      isOrdered,\n      itemLines,\n      l,\n      listLines,\n      listTokIdx,\n      markerCharCode,\n      markerValue,\n      max,\n      nextLine,\n      offset,\n      oldListIndent,\n      oldParentType,\n      oldSCount,\n      oldTShift,\n      oldTight,\n      pos,\n      posAfterMarker,\n      prevEmptyEnd,\n      start,\n      terminate,\n      terminatorRules,\n      token,\n      isTerminatingParagraph = false,\n      tight = true;\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  // Special case:\n  //  - item 1\n  //   - item 2\n  //    - item 3\n  //     - item 4\n  //      - this one is a paragraph continuation\n  if (state.listIndent >= 0 &&\n      state.sCount[startLine] - state.listIndent >= 4 &&\n      state.sCount[startLine] < state.blkIndent) {\n    return false;\n  }\n\n  // limit conditions when list can interrupt\n  // a paragraph (validation mode only)\n  if (silent && state.parentType === 'paragraph') {\n    // Next list item should still terminate previous list item;\n    //\n    // This code can fail if plugins use blkIndent as well as lists,\n    // but I hope the spec gets fixed long before that happens.\n    //\n    if (state.sCount[startLine] >= state.blkIndent) {\n      isTerminatingParagraph = true;\n    }\n  }\n\n  // Detect list type and position after marker\n  if ((posAfterMarker = skipOrderedListMarker(state, startLine)) >= 0) {\n    isOrdered = true;\n    start = state.bMarks[startLine] + state.tShift[startLine];\n    markerValue = Number(state.src.slice(start, posAfterMarker - 1));\n\n    // If we're starting a new ordered list right after\n    // a paragraph, it should start with 1.\n    if (isTerminatingParagraph && markerValue !== 1) return false;\n\n  } else if ((posAfterMarker = skipBulletListMarker(state, startLine)) >= 0) {\n    isOrdered = false;\n\n  } else {\n    return false;\n  }\n\n  // If we're starting a new unordered list right after\n  // a paragraph, first line should not be empty.\n  if (isTerminatingParagraph) {\n    if (state.skipSpaces(posAfterMarker) >= state.eMarks[startLine]) return false;\n  }\n\n  // We should terminate list on style change. Remember first one to compare.\n  markerCharCode = state.src.charCodeAt(posAfterMarker - 1);\n\n  // For validation mode we can terminate immediately\n  if (silent) { return true; }\n\n  // Start list\n  listTokIdx = state.tokens.length;\n\n  if (isOrdered) {\n    token       = state.push('ordered_list_open', 'ol', 1);\n    if (markerValue !== 1) {\n      token.attrs = [ [ 'start', markerValue ] ];\n    }\n\n  } else {\n    token       = state.push('bullet_list_open', 'ul', 1);\n  }\n\n  token.map    = listLines = [ startLine, 0 ];\n  token.markup = String.fromCharCode(markerCharCode);\n\n  //\n  // Iterate list items\n  //\n\n  nextLine = startLine;\n  prevEmptyEnd = false;\n  terminatorRules = state.md.block.ruler.getRules('list');\n\n  oldParentType = state.parentType;\n  state.parentType = 'list';\n\n  while (nextLine < endLine) {\n    pos = posAfterMarker;\n    max = state.eMarks[nextLine];\n\n    initial = offset = state.sCount[nextLine] + posAfterMarker - (state.bMarks[startLine] + state.tShift[startLine]);\n\n    while (pos < max) {\n      ch = state.src.charCodeAt(pos);\n\n      if (ch === 0x09) {\n        offset += 4 - (offset + state.bsCount[nextLine]) % 4;\n      } else if (ch === 0x20) {\n        offset++;\n      } else {\n        break;\n      }\n\n      pos++;\n    }\n\n    contentStart = pos;\n\n    if (contentStart >= max) {\n      // trimming space in \"-    \\n  3\" case, indent is 1 here\n      indentAfterMarker = 1;\n    } else {\n      indentAfterMarker = offset - initial;\n    }\n\n    // If we have more than 4 spaces, the indent is 1\n    // (the rest is just indented code block)\n    if (indentAfterMarker > 4) { indentAfterMarker = 1; }\n\n    // \"  -  test\"\n    //  ^^^^^ - calculating total length of this thing\n    indent = initial + indentAfterMarker;\n\n    // Run subparser & write tokens\n    token        = state.push('list_item_open', 'li', 1);\n    token.markup = String.fromCharCode(markerCharCode);\n    token.map    = itemLines = [ startLine, 0 ];\n    if (isOrdered) {\n      token.info = state.src.slice(start, posAfterMarker - 1);\n    }\n\n    // change current state, then restore it after parser subcall\n    oldTight = state.tight;\n    oldTShift = state.tShift[startLine];\n    oldSCount = state.sCount[startLine];\n\n    //  - example list\n    // ^ listIndent position will be here\n    //   ^ blkIndent position will be here\n    //\n    oldListIndent = state.listIndent;\n    state.listIndent = state.blkIndent;\n    state.blkIndent = indent;\n\n    state.tight = true;\n    state.tShift[startLine] = contentStart - state.bMarks[startLine];\n    state.sCount[startLine] = offset;\n\n    if (contentStart >= max && state.isEmpty(startLine + 1)) {\n      // workaround for this case\n      // (list item is empty, list terminates before \"foo\"):\n      // ~~~~~~~~\n      //   -\n      //\n      //     foo\n      // ~~~~~~~~\n      state.line = Math.min(state.line + 2, endLine);\n    } else {\n      state.md.block.tokenize(state, startLine, endLine, true);\n    }\n\n    // If any of list item is tight, mark list as tight\n    if (!state.tight || prevEmptyEnd) {\n      tight = false;\n    }\n    // Item become loose if finish with empty line,\n    // but we should filter last element, because it means list finish\n    prevEmptyEnd = (state.line - startLine) > 1 && state.isEmpty(state.line - 1);\n\n    state.blkIndent = state.listIndent;\n    state.listIndent = oldListIndent;\n    state.tShift[startLine] = oldTShift;\n    state.sCount[startLine] = oldSCount;\n    state.tight = oldTight;\n\n    token        = state.push('list_item_close', 'li', -1);\n    token.markup = String.fromCharCode(markerCharCode);\n\n    nextLine = startLine = state.line;\n    itemLines[1] = nextLine;\n    contentStart = state.bMarks[startLine];\n\n    if (nextLine >= endLine) { break; }\n\n    //\n    // Try to check if list is terminated or continued.\n    //\n    if (state.sCount[nextLine] < state.blkIndent) { break; }\n\n    // if it's indented more than 3 spaces, it should be a code block\n    if (state.sCount[startLine] - state.blkIndent >= 4) { break; }\n\n    // fail if terminating block found\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n    if (terminate) { break; }\n\n    // fail if list has another type\n    if (isOrdered) {\n      posAfterMarker = skipOrderedListMarker(state, nextLine);\n      if (posAfterMarker < 0) { break; }\n      start = state.bMarks[nextLine] + state.tShift[nextLine];\n    } else {\n      posAfterMarker = skipBulletListMarker(state, nextLine);\n      if (posAfterMarker < 0) { break; }\n    }\n\n    if (markerCharCode !== state.src.charCodeAt(posAfterMarker - 1)) { break; }\n  }\n\n  // Finalize list\n  if (isOrdered) {\n    token = state.push('ordered_list_close', 'ol', -1);\n  } else {\n    token = state.push('bullet_list_close', 'ul', -1);\n  }\n  token.markup = String.fromCharCode(markerCharCode);\n\n  listLines[1] = nextLine;\n  state.line = nextLine;\n\n  state.parentType = oldParentType;\n\n  // mark paragraphs tight if needed\n  if (tight) {\n    markTightParagraphs(state, listTokIdx);\n  }\n\n  return true;\n};\n","'use strict';\n\n\nvar normalizeReference   = require('../common/utils').normalizeReference;\nvar isSpace              = require('../common/utils').isSpace;\n\n\nmodule.exports = function reference(state, startLine, _endLine, silent) {\n  var ch,\n      destEndPos,\n      destEndLineNo,\n      endLine,\n      href,\n      i,\n      l,\n      label,\n      labelEnd,\n      oldParentType,\n      res,\n      start,\n      str,\n      terminate,\n      terminatorRules,\n      title,\n      lines = 0,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine],\n      nextLine = startLine + 1;\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  if (state.src.charCodeAt(pos) !== 0x5B/* [ */) { return false; }\n\n  // Simple check to quickly interrupt scan on [link](url) at the start of line.\n  // Can be useful on practice: https://github.com/markdown-it/markdown-it/issues/54\n  while (++pos < max) {\n    if (state.src.charCodeAt(pos) === 0x5D /* ] */ &&\n        state.src.charCodeAt(pos - 1) !== 0x5C/* \\ */) {\n      if (pos + 1 === max) { return false; }\n      if (state.src.charCodeAt(pos + 1) !== 0x3A/* : */) { return false; }\n      break;\n    }\n  }\n\n  endLine = state.lineMax;\n\n  // jump line-by-line until empty one or EOF\n  terminatorRules = state.md.block.ruler.getRules('reference');\n\n  oldParentType = state.parentType;\n  state.parentType = 'reference';\n\n  for (; nextLine < endLine && !state.isEmpty(nextLine); nextLine++) {\n    // this would be a code block normally, but after paragraph\n    // it's considered a lazy continuation regardless of what's there\n    if (state.sCount[nextLine] - state.blkIndent > 3) { continue; }\n\n    // quirk for blockquotes, this line should already be checked by that rule\n    if (state.sCount[nextLine] < 0) { continue; }\n\n    // Some tags can terminate paragraph without empty line.\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n    if (terminate) { break; }\n  }\n\n  str = state.getLines(startLine, nextLine, state.blkIndent, false).trim();\n  max = str.length;\n\n  for (pos = 1; pos < max; pos++) {\n    ch = str.charCodeAt(pos);\n    if (ch === 0x5B /* [ */) {\n      return false;\n    } else if (ch === 0x5D /* ] */) {\n      labelEnd = pos;\n      break;\n    } else if (ch === 0x0A /* \\n */) {\n      lines++;\n    } else if (ch === 0x5C /* \\ */) {\n      pos++;\n      if (pos < max && str.charCodeAt(pos) === 0x0A) {\n        lines++;\n      }\n    }\n  }\n\n  if (labelEnd < 0 || str.charCodeAt(labelEnd + 1) !== 0x3A/* : */) { return false; }\n\n  // [label]:   destination   'title'\n  //         ^^^ skip optional whitespace here\n  for (pos = labelEnd + 2; pos < max; pos++) {\n    ch = str.charCodeAt(pos);\n    if (ch === 0x0A) {\n      lines++;\n    } else if (isSpace(ch)) {\n      /*eslint no-empty:0*/\n    } else {\n      break;\n    }\n  }\n\n  // [label]:   destination   'title'\n  //            ^^^^^^^^^^^ parse this\n  res = state.md.helpers.parseLinkDestination(str, pos, max);\n  if (!res.ok) { return false; }\n\n  href = state.md.normalizeLink(res.str);\n  if (!state.md.validateLink(href)) { return false; }\n\n  pos = res.pos;\n  lines += res.lines;\n\n  // save cursor state, we could require to rollback later\n  destEndPos = pos;\n  destEndLineNo = lines;\n\n  // [label]:   destination   'title'\n  //                       ^^^ skipping those spaces\n  start = pos;\n  for (; pos < max; pos++) {\n    ch = str.charCodeAt(pos);\n    if (ch === 0x0A) {\n      lines++;\n    } else if (isSpace(ch)) {\n      /*eslint no-empty:0*/\n    } else {\n      break;\n    }\n  }\n\n  // [label]:   destination   'title'\n  //                          ^^^^^^^ parse this\n  res = state.md.helpers.parseLinkTitle(str, pos, max);\n  if (pos < max && start !== pos && res.ok) {\n    title = res.str;\n    pos = res.pos;\n    lines += res.lines;\n  } else {\n    title = '';\n    pos = destEndPos;\n    lines = destEndLineNo;\n  }\n\n  // skip trailing spaces until the rest of the line\n  while (pos < max) {\n    ch = str.charCodeAt(pos);\n    if (!isSpace(ch)) { break; }\n    pos++;\n  }\n\n  if (pos < max && str.charCodeAt(pos) !== 0x0A) {\n    if (title) {\n      // garbage at the end of the line after title,\n      // but it could still be a valid reference if we roll back\n      title = '';\n      pos = destEndPos;\n      lines = destEndLineNo;\n      while (pos < max) {\n        ch = str.charCodeAt(pos);\n        if (!isSpace(ch)) { break; }\n        pos++;\n      }\n    }\n  }\n\n  if (pos < max && str.charCodeAt(pos) !== 0x0A) {\n    // garbage at the end of the line\n    return false;\n  }\n\n  label = normalizeReference(str.slice(1, labelEnd));\n  if (!label) {\n    // CommonMark 0.20 disallows empty labels\n    return false;\n  }\n\n  // Reference can not terminate anything. This check is for safety only.\n  /*istanbul ignore if*/\n  if (silent) { return true; }\n\n  if (typeof state.env.references === 'undefined') {\n    state.env.references = {};\n  }\n  if (typeof state.env.references[label] === 'undefined') {\n    state.env.references[label] = { title: title, href: href };\n  }\n\n  state.parentType = oldParentType;\n\n  state.line = startLine + lines + 1;\n  return true;\n};\n","// Regexps to match html elements\n\n'use strict';\n\nvar attr_name     = '[a-zA-Z_:][a-zA-Z0-9:._-]*';\n\nvar unquoted      = '[^\"\\'=<>`\\\\x00-\\\\x20]+';\nvar single_quoted = \"'[^']*'\";\nvar double_quoted = '\"[^\"]*\"';\n\nvar attr_value  = '(?:' + unquoted + '|' + single_quoted + '|' + double_quoted + ')';\n\nvar attribute   = '(?:\\\\s+' + attr_name + '(?:\\\\s*=\\\\s*' + attr_value + ')?)';\n\nvar open_tag    = '<[A-Za-z][A-Za-z0-9\\\\-]*' + attribute + '*\\\\s*\\\\/?>';\n\nvar close_tag   = '<\\\\/[A-Za-z][A-Za-z0-9\\\\-]*\\\\s*>';\nvar comment     = '<!---->|<!--(?:-?[^>-])(?:-?[^-])*-->';\nvar processing  = '<[?][\\\\s\\\\S]*?[?]>';\nvar declaration = '<![A-Z]+\\\\s+[^>]*>';\nvar cdata       = '<!\\\\[CDATA\\\\[[\\\\s\\\\S]*?\\\\]\\\\]>';\n\nvar HTML_TAG_RE = new RegExp('^(?:' + open_tag + '|' + close_tag + '|' + comment +\n                        '|' + processing + '|' + declaration + '|' + cdata + ')');\nvar HTML_OPEN_CLOSE_TAG_RE = new RegExp('^(?:' + open_tag + '|' + close_tag + ')');\n\nmodule.exports.HTML_TAG_RE = HTML_TAG_RE;\nmodule.exports.HTML_OPEN_CLOSE_TAG_RE = HTML_OPEN_CLOSE_TAG_RE;\n","// HTML block\n\n'use strict';\n\n\nvar block_names = require('../common/html_blocks');\nvar HTML_OPEN_CLOSE_TAG_RE = require('../common/html_re').HTML_OPEN_CLOSE_TAG_RE;\n\n// An array of opening and corresponding closing sequences for html tags,\n// last argument defines whether it can terminate a paragraph or not\n//\nvar HTML_SEQUENCES = [\n  [ /^<(script|pre|style|textarea)(?=(\\s|>|$))/i, /<\\/(script|pre|style|textarea)>/i, true ],\n  [ /^<!--/,        /-->/,   true ],\n  [ /^<\\?/,         /\\?>/,   true ],\n  [ /^<![A-Z]/,     />/,     true ],\n  [ /^<!\\[CDATA\\[/, /\\]\\]>/, true ],\n  [ new RegExp('^</?(' + block_names.join('|') + ')(?=(\\\\s|/?>|$))', 'i'), /^$/, true ],\n  [ new RegExp(HTML_OPEN_CLOSE_TAG_RE.source + '\\\\s*$'),  /^$/, false ]\n];\n\n\nmodule.exports = function html_block(state, startLine, endLine, silent) {\n  var i, nextLine, token, lineText,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine];\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  if (!state.md.options.html) { return false; }\n\n  if (state.src.charCodeAt(pos) !== 0x3C/* < */) { return false; }\n\n  lineText = state.src.slice(pos, max);\n\n  for (i = 0; i < HTML_SEQUENCES.length; i++) {\n    if (HTML_SEQUENCES[i][0].test(lineText)) { break; }\n  }\n\n  if (i === HTML_SEQUENCES.length) { return false; }\n\n  if (silent) {\n    // true if this sequence can be a terminator, false otherwise\n    return HTML_SEQUENCES[i][2];\n  }\n\n  nextLine = startLine + 1;\n\n  // If we are here - we detected HTML block.\n  // Let's roll down till block end.\n  if (!HTML_SEQUENCES[i][1].test(lineText)) {\n    for (; nextLine < endLine; nextLine++) {\n      if (state.sCount[nextLine] < state.blkIndent) { break; }\n\n      pos = state.bMarks[nextLine] + state.tShift[nextLine];\n      max = state.eMarks[nextLine];\n      lineText = state.src.slice(pos, max);\n\n      if (HTML_SEQUENCES[i][1].test(lineText)) {\n        if (lineText.length !== 0) { nextLine++; }\n        break;\n      }\n    }\n  }\n\n  state.line = nextLine;\n\n  token         = state.push('html_block', '', 0);\n  token.map     = [ startLine, nextLine ];\n  token.content = state.getLines(startLine, nextLine, state.blkIndent, true);\n\n  return true;\n};\n","// List of valid html blocks names, accorting to commonmark spec\n// http://jgm.github.io/CommonMark/spec.html#html-blocks\n\n'use strict';\n\n\nmodule.exports = [\n  'address',\n  'article',\n  'aside',\n  'base',\n  'basefont',\n  'blockquote',\n  'body',\n  'caption',\n  'center',\n  'col',\n  'colgroup',\n  'dd',\n  'details',\n  'dialog',\n  'dir',\n  'div',\n  'dl',\n  'dt',\n  'fieldset',\n  'figcaption',\n  'figure',\n  'footer',\n  'form',\n  'frame',\n  'frameset',\n  'h1',\n  'h2',\n  'h3',\n  'h4',\n  'h5',\n  'h6',\n  'head',\n  'header',\n  'hr',\n  'html',\n  'iframe',\n  'legend',\n  'li',\n  'link',\n  'main',\n  'menu',\n  'menuitem',\n  'nav',\n  'noframes',\n  'ol',\n  'optgroup',\n  'option',\n  'p',\n  'param',\n  'section',\n  'source',\n  'summary',\n  'table',\n  'tbody',\n  'td',\n  'tfoot',\n  'th',\n  'thead',\n  'title',\n  'tr',\n  'track',\n  'ul'\n];\n","// heading (#, ##, ...)\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\nmodule.exports = function heading(state, startLine, endLine, silent) {\n  var ch, level, tmp, token,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine];\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  ch  = state.src.charCodeAt(pos);\n\n  if (ch !== 0x23/* # */ || pos >= max) { return false; }\n\n  // count heading level\n  level = 1;\n  ch = state.src.charCodeAt(++pos);\n  while (ch === 0x23/* # */ && pos < max && level <= 6) {\n    level++;\n    ch = state.src.charCodeAt(++pos);\n  }\n\n  if (level > 6 || (pos < max && !isSpace(ch))) { return false; }\n\n  if (silent) { return true; }\n\n  // Let's cut tails like '    ###  ' from the end of string\n\n  max = state.skipSpacesBack(max, pos);\n  tmp = state.skipCharsBack(max, 0x23, pos); // #\n  if (tmp > pos && isSpace(state.src.charCodeAt(tmp - 1))) {\n    max = tmp;\n  }\n\n  state.line = startLine + 1;\n\n  token        = state.push('heading_open', 'h' + String(level), 1);\n  token.markup = '########'.slice(0, level);\n  token.map    = [ startLine, state.line ];\n\n  token          = state.push('inline', '', 0);\n  token.content  = state.src.slice(pos, max).trim();\n  token.map      = [ startLine, state.line ];\n  token.children = [];\n\n  token        = state.push('heading_close', 'h' + String(level), -1);\n  token.markup = '########'.slice(0, level);\n\n  return true;\n};\n","// Parser state class\n\n'use strict';\n\nvar Token = require('../token');\nvar isSpace = require('../common/utils').isSpace;\n\n\nfunction StateBlock(src, md, env, tokens) {\n  var ch, s, start, pos, len, indent, offset, indent_found;\n\n  this.src = src;\n\n  // link to parser instance\n  this.md     = md;\n\n  this.env = env;\n\n  //\n  // Internal state vartiables\n  //\n\n  this.tokens = tokens;\n\n  this.bMarks = [];  // line begin offsets for fast jumps\n  this.eMarks = [];  // line end offsets for fast jumps\n  this.tShift = [];  // offsets of the first non-space characters (tabs not expanded)\n  this.sCount = [];  // indents for each line (tabs expanded)\n\n  // An amount of virtual spaces (tabs expanded) between beginning\n  // of each line (bMarks) and real beginning of that line.\n  //\n  // It exists only as a hack because blockquotes override bMarks\n  // losing information in the process.\n  //\n  // It's used only when expanding tabs, you can think about it as\n  // an initial tab length, e.g. bsCount=21 applied to string `\\t123`\n  // means first tab should be expanded to 4-21%4 === 3 spaces.\n  //\n  this.bsCount = [];\n\n  // block parser variables\n  this.blkIndent  = 0; // required block content indent (for example, if we are\n                       // inside a list, it would be positioned after list marker)\n  this.line       = 0; // line index in src\n  this.lineMax    = 0; // lines count\n  this.tight      = false;  // loose/tight mode for lists\n  this.ddIndent   = -1; // indent of the current dd block (-1 if there isn't any)\n  this.listIndent = -1; // indent of the current list block (-1 if there isn't any)\n\n  // can be 'blockquote', 'list', 'root', 'paragraph' or 'reference'\n  // used in lists to determine if they interrupt a paragraph\n  this.parentType = 'root';\n\n  this.level = 0;\n\n  // renderer\n  this.result = '';\n\n  // Create caches\n  // Generate markers.\n  s = this.src;\n  indent_found = false;\n\n  for (start = pos = indent = offset = 0, len = s.length; pos < len; pos++) {\n    ch = s.charCodeAt(pos);\n\n    if (!indent_found) {\n      if (isSpace(ch)) {\n        indent++;\n\n        if (ch === 0x09) {\n          offset += 4 - offset % 4;\n        } else {\n          offset++;\n        }\n        continue;\n      } else {\n        indent_found = true;\n      }\n    }\n\n    if (ch === 0x0A || pos === len - 1) {\n      if (ch !== 0x0A) { pos++; }\n      this.bMarks.push(start);\n      this.eMarks.push(pos);\n      this.tShift.push(indent);\n      this.sCount.push(offset);\n      this.bsCount.push(0);\n\n      indent_found = false;\n      indent = 0;\n      offset = 0;\n      start = pos + 1;\n    }\n  }\n\n  // Push fake entry to simplify cache bounds checks\n  this.bMarks.push(s.length);\n  this.eMarks.push(s.length);\n  this.tShift.push(0);\n  this.sCount.push(0);\n  this.bsCount.push(0);\n\n  this.lineMax = this.bMarks.length - 1; // don't count last fake line\n}\n\n// Push new token to \"stream\".\n//\nStateBlock.prototype.push = function (type, tag, nesting) {\n  var token = new Token(type, tag, nesting);\n  token.block = true;\n\n  if (nesting < 0) this.level--; // closing tag\n  token.level = this.level;\n  if (nesting > 0) this.level++; // opening tag\n\n  this.tokens.push(token);\n  return token;\n};\n\nStateBlock.prototype.isEmpty = function isEmpty(line) {\n  return this.bMarks[line] + this.tShift[line] >= this.eMarks[line];\n};\n\nStateBlock.prototype.skipEmptyLines = function skipEmptyLines(from) {\n  for (var max = this.lineMax; from < max; from++) {\n    if (this.bMarks[from] + this.tShift[from] < this.eMarks[from]) {\n      break;\n    }\n  }\n  return from;\n};\n\n// Skip spaces from given position.\nStateBlock.prototype.skipSpaces = function skipSpaces(pos) {\n  var ch;\n\n  for (var max = this.src.length; pos < max; pos++) {\n    ch = this.src.charCodeAt(pos);\n    if (!isSpace(ch)) { break; }\n  }\n  return pos;\n};\n\n// Skip spaces from given position in reverse.\nStateBlock.prototype.skipSpacesBack = function skipSpacesBack(pos, min) {\n  if (pos <= min) { return pos; }\n\n  while (pos > min) {\n    if (!isSpace(this.src.charCodeAt(--pos))) { return pos + 1; }\n  }\n  return pos;\n};\n\n// Skip char codes from given position\nStateBlock.prototype.skipChars = function skipChars(pos, code) {\n  for (var max = this.src.length; pos < max; pos++) {\n    if (this.src.charCodeAt(pos) !== code) { break; }\n  }\n  return pos;\n};\n\n// Skip char codes reverse from given position - 1\nStateBlock.prototype.skipCharsBack = function skipCharsBack(pos, code, min) {\n  if (pos <= min) { return pos; }\n\n  while (pos > min) {\n    if (code !== this.src.charCodeAt(--pos)) { return pos + 1; }\n  }\n  return pos;\n};\n\n// cut lines range from source.\nStateBlock.prototype.getLines = function getLines(begin, end, indent, keepLastLF) {\n  var i, lineIndent, ch, first, last, queue, lineStart,\n      line = begin;\n\n  if (begin >= end) {\n    return '';\n  }\n\n  queue = new Array(end - begin);\n\n  for (i = 0; line < end; line++, i++) {\n    lineIndent = 0;\n    lineStart = first = this.bMarks[line];\n\n    if (line + 1 < end || keepLastLF) {\n      // No need for bounds check because we have fake entry on tail.\n      last = this.eMarks[line] + 1;\n    } else {\n      last = this.eMarks[line];\n    }\n\n    while (first < last && lineIndent < indent) {\n      ch = this.src.charCodeAt(first);\n\n      if (isSpace(ch)) {\n        if (ch === 0x09) {\n          lineIndent += 4 - (lineIndent + this.bsCount[line]) % 4;\n        } else {\n          lineIndent++;\n        }\n      } else if (first - lineStart < this.tShift[line]) {\n        // patched tShift masked characters to look like spaces (blockquotes, list markers)\n        lineIndent++;\n      } else {\n        break;\n      }\n\n      first++;\n    }\n\n    if (lineIndent > indent) {\n      // partially expanding tabs in code blocks, e.g '\\t\\tfoobar'\n      // with indent=2 becomes '  \\tfoobar'\n      queue[i] = new Array(lineIndent - indent + 1).join(' ') + this.src.slice(first, last);\n    } else {\n      queue[i] = this.src.slice(first, last);\n    }\n  }\n\n  return queue.join('');\n};\n\n// re-export Token class to use in block rules\nStateBlock.prototype.Token = Token;\n\n\nmodule.exports = StateBlock;\n","/** internal\n * class ParserBlock\n *\n * Block-level tokenizer.\n **/\n'use strict';\n\n\nvar Ruler           = require('./ruler');\n\n\nvar _rules = [\n  // First 2 params - rule name & source. Secondary array - list of rules,\n  // which can be terminated by this one.\n  [ 'table',      require('./rules_block/table'),      [ 'paragraph', 'reference' ] ],\n  [ 'code',       require('./rules_block/code') ],\n  [ 'fence',      require('./rules_block/fence'),      [ 'paragraph', 'reference', 'blockquote', 'list' ] ],\n  [ 'blockquote', require('./rules_block/blockquote'), [ 'paragraph', 'reference', 'blockquote', 'list' ] ],\n  [ 'hr',         require('./rules_block/hr'),         [ 'paragraph', 'reference', 'blockquote', 'list' ] ],\n  [ 'list',       require('./rules_block/list'),       [ 'paragraph', 'reference', 'blockquote' ] ],\n  [ 'reference',  require('./rules_block/reference') ],\n  [ 'html_block', require('./rules_block/html_block'), [ 'paragraph', 'reference', 'blockquote' ] ],\n  [ 'heading',    require('./rules_block/heading'),    [ 'paragraph', 'reference', 'blockquote' ] ],\n  [ 'lheading',   require('./rules_block/lheading') ],\n  [ 'paragraph',  require('./rules_block/paragraph') ]\n];\n\n\n/**\n * new ParserBlock()\n **/\nfunction ParserBlock() {\n  /**\n   * ParserBlock#ruler -> Ruler\n   *\n   * [[Ruler]] instance. Keep configuration of block rules.\n   **/\n  this.ruler = new Ruler();\n\n  for (var i = 0; i < _rules.length; i++) {\n    this.ruler.push(_rules[i][0], _rules[i][1], { alt: (_rules[i][2] || []).slice() });\n  }\n}\n\n\n// Generate tokens for input range\n//\nParserBlock.prototype.tokenize = function (state, startLine, endLine) {\n  var ok, i,\n      rules = this.ruler.getRules(''),\n      len = rules.length,\n      line = startLine,\n      hasEmptyLines = false,\n      maxNesting = state.md.options.maxNesting;\n\n  while (line < endLine) {\n    state.line = line = state.skipEmptyLines(line);\n    if (line >= endLine) { break; }\n\n    // Termination condition for nested calls.\n    // Nested calls currently used for blockquotes & lists\n    if (state.sCount[line] < state.blkIndent) { break; }\n\n    // If nesting level exceeded - skip tail to the end. That's not ordinary\n    // situation and we should not care about content.\n    if (state.level >= maxNesting) {\n      state.line = endLine;\n      break;\n    }\n\n    // Try all possible rules.\n    // On success, rule should:\n    //\n    // - update `state.line`\n    // - update `state.tokens`\n    // - return true\n\n    for (i = 0; i < len; i++) {\n      ok = rules[i](state, line, endLine, false);\n      if (ok) { break; }\n    }\n\n    // set state.tight if we had an empty line before current tag\n    // i.e. latest empty line should not count\n    state.tight = !hasEmptyLines;\n\n    // paragraph might \"eat\" one newline after it in nested lists\n    if (state.isEmpty(state.line - 1)) {\n      hasEmptyLines = true;\n    }\n\n    line = state.line;\n\n    if (line < endLine && state.isEmpty(line)) {\n      hasEmptyLines = true;\n      line++;\n      state.line = line;\n    }\n  }\n};\n\n\n/**\n * ParserBlock.parse(str, md, env, outTokens)\n *\n * Process input string and push block tokens into `outTokens`\n **/\nParserBlock.prototype.parse = function (src, md, env, outTokens) {\n  var state;\n\n  if (!src) { return; }\n\n  state = new this.State(src, md, env, outTokens);\n\n  this.tokenize(state, state.line, state.lineMax);\n};\n\n\nParserBlock.prototype.State = require('./rules_block/state_block');\n\n\nmodule.exports = ParserBlock;\n","// Code block (4 spaces padded)\n\n'use strict';\n\n\nmodule.exports = function code(state, startLine, endLine/*, silent*/) {\n  var nextLine, last, token;\n\n  if (state.sCount[startLine] - state.blkIndent < 4) { return false; }\n\n  last = nextLine = startLine + 1;\n\n  while (nextLine < endLine) {\n    if (state.isEmpty(nextLine)) {\n      nextLine++;\n      continue;\n    }\n\n    if (state.sCount[nextLine] - state.blkIndent >= 4) {\n      nextLine++;\n      last = nextLine;\n      continue;\n    }\n    break;\n  }\n\n  state.line = last;\n\n  token         = state.push('code_block', 'code', 0);\n  token.content = state.getLines(startLine, last, 4 + state.blkIndent, false) + '\\n';\n  token.map     = [ startLine, state.line ];\n\n  return true;\n};\n","// fences (``` lang, ~~~ lang)\n\n'use strict';\n\n\nmodule.exports = function fence(state, startLine, endLine, silent) {\n  var marker, len, params, nextLine, mem, token, markup,\n      haveEndMarker = false,\n      pos = state.bMarks[startLine] + state.tShift[startLine],\n      max = state.eMarks[startLine];\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  if (pos + 3 > max) { return false; }\n\n  marker = state.src.charCodeAt(pos);\n\n  if (marker !== 0x7E/* ~ */ && marker !== 0x60 /* ` */) {\n    return false;\n  }\n\n  // scan marker length\n  mem = pos;\n  pos = state.skipChars(pos, marker);\n\n  len = pos - mem;\n\n  if (len < 3) { return false; }\n\n  markup = state.src.slice(mem, pos);\n  params = state.src.slice(pos, max);\n\n  if (marker === 0x60 /* ` */) {\n    if (params.indexOf(String.fromCharCode(marker)) >= 0) {\n      return false;\n    }\n  }\n\n  // Since start is found, we can report success here in validation mode\n  if (silent) { return true; }\n\n  // search end of block\n  nextLine = startLine;\n\n  for (;;) {\n    nextLine++;\n    if (nextLine >= endLine) {\n      // unclosed block should be autoclosed by end of document.\n      // also block seems to be autoclosed by end of parent\n      break;\n    }\n\n    pos = mem = state.bMarks[nextLine] + state.tShift[nextLine];\n    max = state.eMarks[nextLine];\n\n    if (pos < max && state.sCount[nextLine] < state.blkIndent) {\n      // non-empty line with negative indent should stop the list:\n      // - ```\n      //  test\n      break;\n    }\n\n    if (state.src.charCodeAt(pos) !== marker) { continue; }\n\n    if (state.sCount[nextLine] - state.blkIndent >= 4) {\n      // closing fence should be indented less than 4 spaces\n      continue;\n    }\n\n    pos = state.skipChars(pos, marker);\n\n    // closing code fence must be at least as long as the opening one\n    if (pos - mem < len) { continue; }\n\n    // make sure tail has spaces only\n    pos = state.skipSpaces(pos);\n\n    if (pos < max) { continue; }\n\n    haveEndMarker = true;\n    // found!\n    break;\n  }\n\n  // If a fence has heading spaces, they should be removed from its inner block\n  len = state.sCount[startLine];\n\n  state.line = nextLine + (haveEndMarker ? 1 : 0);\n\n  token         = state.push('fence', 'code', 0);\n  token.info    = params;\n  token.content = state.getLines(startLine + 1, nextLine, len, true);\n  token.markup  = markup;\n  token.map     = [ startLine, state.line ];\n\n  return true;\n};\n","// lheading (---, ===)\n\n'use strict';\n\n\nmodule.exports = function lheading(state, startLine, endLine/*, silent*/) {\n  var content, terminate, i, l, token, pos, max, level, marker,\n      nextLine = startLine + 1, oldParentType,\n      terminatorRules = state.md.block.ruler.getRules('paragraph');\n\n  // if it's indented more than 3 spaces, it should be a code block\n  if (state.sCount[startLine] - state.blkIndent >= 4) { return false; }\n\n  oldParentType = state.parentType;\n  state.parentType = 'paragraph'; // use paragraph to match terminatorRules\n\n  // jump line-by-line until empty one or EOF\n  for (; nextLine < endLine && !state.isEmpty(nextLine); nextLine++) {\n    // this would be a code block normally, but after paragraph\n    // it's considered a lazy continuation regardless of what's there\n    if (state.sCount[nextLine] - state.blkIndent > 3) { continue; }\n\n    //\n    // Check for underline in setext header\n    //\n    if (state.sCount[nextLine] >= state.blkIndent) {\n      pos = state.bMarks[nextLine] + state.tShift[nextLine];\n      max = state.eMarks[nextLine];\n\n      if (pos < max) {\n        marker = state.src.charCodeAt(pos);\n\n        if (marker === 0x2D/* - */ || marker === 0x3D/* = */) {\n          pos = state.skipChars(pos, marker);\n          pos = state.skipSpaces(pos);\n\n          if (pos >= max) {\n            level = (marker === 0x3D/* = */ ? 1 : 2);\n            break;\n          }\n        }\n      }\n    }\n\n    // quirk for blockquotes, this line should already be checked by that rule\n    if (state.sCount[nextLine] < 0) { continue; }\n\n    // Some tags can terminate paragraph without empty line.\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n    if (terminate) { break; }\n  }\n\n  if (!level) {\n    // Didn't find valid underline\n    return false;\n  }\n\n  content = state.getLines(startLine, nextLine, state.blkIndent, false).trim();\n\n  state.line = nextLine + 1;\n\n  token          = state.push('heading_open', 'h' + String(level), 1);\n  token.markup   = String.fromCharCode(marker);\n  token.map      = [ startLine, state.line ];\n\n  token          = state.push('inline', '', 0);\n  token.content  = content;\n  token.map      = [ startLine, state.line - 1 ];\n  token.children = [];\n\n  token          = state.push('heading_close', 'h' + String(level), -1);\n  token.markup   = String.fromCharCode(marker);\n\n  state.parentType = oldParentType;\n\n  return true;\n};\n","// Paragraph\n\n'use strict';\n\n\nmodule.exports = function paragraph(state, startLine/*, endLine*/) {\n  var content, terminate, i, l, token, oldParentType,\n      nextLine = startLine + 1,\n      terminatorRules = state.md.block.ruler.getRules('paragraph'),\n      endLine = state.lineMax;\n\n  oldParentType = state.parentType;\n  state.parentType = 'paragraph';\n\n  // jump line-by-line until empty one or EOF\n  for (; nextLine < endLine && !state.isEmpty(nextLine); nextLine++) {\n    // this would be a code block normally, but after paragraph\n    // it's considered a lazy continuation regardless of what's there\n    if (state.sCount[nextLine] - state.blkIndent > 3) { continue; }\n\n    // quirk for blockquotes, this line should already be checked by that rule\n    if (state.sCount[nextLine] < 0) { continue; }\n\n    // Some tags can terminate paragraph without empty line.\n    terminate = false;\n    for (i = 0, l = terminatorRules.length; i < l; i++) {\n      if (terminatorRules[i](state, nextLine, endLine, true)) {\n        terminate = true;\n        break;\n      }\n    }\n    if (terminate) { break; }\n  }\n\n  content = state.getLines(startLine, nextLine, state.blkIndent, false).trim();\n\n  state.line = nextLine;\n\n  token          = state.push('paragraph_open', 'p', 1);\n  token.map      = [ startLine, state.line ];\n\n  token          = state.push('inline', '', 0);\n  token.content  = content;\n  token.map      = [ startLine, state.line ];\n  token.children = [];\n\n  token          = state.push('paragraph_close', 'p', -1);\n\n  state.parentType = oldParentType;\n\n  return true;\n};\n","// Skip text characters for text token, place those to pending buffer\n// and increment current pos\n\n'use strict';\n\n\n// Rule to skip pure text\n// '{}$%@~+=:' reserved for extentions\n\n// !, \", #, $, %, &, ', (, ), *, +, ,, -, ., /, :, ;, <, =, >, ?, @, [, \\, ], ^, _, `, {, |, }, or ~\n\n// !!!! Don't confuse with \"Markdown ASCII Punctuation\" chars\n// http://spec.commonmark.org/0.15/#ascii-punctuation-character\nfunction isTerminatorChar(ch) {\n  switch (ch) {\n    case 0x0A/* \\n */:\n    case 0x21/* ! */:\n    case 0x23/* # */:\n    case 0x24/* $ */:\n    case 0x25/* % */:\n    case 0x26/* & */:\n    case 0x2A/* * */:\n    case 0x2B/* + */:\n    case 0x2D/* - */:\n    case 0x3A/* : */:\n    case 0x3C/* < */:\n    case 0x3D/* = */:\n    case 0x3E/* > */:\n    case 0x40/* @ */:\n    case 0x5B/* [ */:\n    case 0x5C/* \\ */:\n    case 0x5D/* ] */:\n    case 0x5E/* ^ */:\n    case 0x5F/* _ */:\n    case 0x60/* ` */:\n    case 0x7B/* { */:\n    case 0x7D/* } */:\n    case 0x7E/* ~ */:\n      return true;\n    default:\n      return false;\n  }\n}\n\nmodule.exports = function text(state, silent) {\n  var pos = state.pos;\n\n  while (pos < state.posMax && !isTerminatorChar(state.src.charCodeAt(pos))) {\n    pos++;\n  }\n\n  if (pos === state.pos) { return false; }\n\n  if (!silent) { state.pending += state.src.slice(state.pos, pos); }\n\n  state.pos = pos;\n\n  return true;\n};\n\n// Alternative implementation, for memory.\n//\n// It costs 10% of performance, but allows extend terminators list, if place it\n// to `ParcerInline` property. Probably, will switch to it sometime, such\n// flexibility required.\n\n/*\nvar TERMINATOR_RE = /[\\n!#$%&*+\\-:<=>@[\\\\\\]^_`{}~]/;\n\nmodule.exports = function text(state, silent) {\n  var pos = state.pos,\n      idx = state.src.slice(pos).search(TERMINATOR_RE);\n\n  // first char is terminator -> empty text\n  if (idx === 0) { return false; }\n\n  // no terminator -> text till end of string\n  if (idx < 0) {\n    if (!silent) { state.pending += state.src.slice(pos); }\n    state.pos = state.src.length;\n    return true;\n  }\n\n  if (!silent) { state.pending += state.src.slice(pos, pos + idx); }\n\n  state.pos += idx;\n\n  return true;\n};*/\n","// Process escaped chars and hardbreaks\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\nvar ESCAPED = [];\n\nfor (var i = 0; i < 256; i++) { ESCAPED.push(0); }\n\n'\\\\!\"#$%&\\'()*+,./:;<=>?@[]^_`{|}~-'\n  .split('').forEach(function (ch) { ESCAPED[ch.charCodeAt(0)] = 1; });\n\n\nmodule.exports = function escape(state, silent) {\n  var ch1, ch2, origStr, escapedStr, token, pos = state.pos, max = state.posMax;\n\n  if (state.src.charCodeAt(pos) !== 0x5C/* \\ */) return false;\n  pos++;\n\n  // '\\' at the end of the inline block\n  if (pos >= max) return false;\n\n  ch1 = state.src.charCodeAt(pos);\n\n  if (ch1 === 0x0A) {\n    if (!silent) {\n      state.push('hardbreak', 'br', 0);\n    }\n\n    pos++;\n    // skip leading whitespaces from next line\n    while (pos < max) {\n      ch1 = state.src.charCodeAt(pos);\n      if (!isSpace(ch1)) break;\n      pos++;\n    }\n\n    state.pos = pos;\n    return true;\n  }\n\n  escapedStr = state.src[pos];\n\n  if (ch1 >= 0xD800 && ch1 <= 0xDBFF && pos + 1 < max) {\n    ch2 = state.src.charCodeAt(pos + 1);\n\n    if (ch2 >= 0xDC00 && ch2 <= 0xDFFF) {\n      escapedStr += state.src[pos + 1];\n      pos++;\n    }\n  }\n\n  origStr = '\\\\' + escapedStr;\n\n  if (!silent) {\n    token = state.push('text_special', '', 0);\n\n    if (ch1 < 256 && ESCAPED[ch1] !== 0) {\n      token.content = escapedStr;\n    } else {\n      token.content = origStr;\n    }\n\n    token.markup = origStr;\n    token.info   = 'escape';\n  }\n\n  state.pos = pos + 1;\n  return true;\n};\n","// Process links like https://example.org/\n\n'use strict';\n\n\n// RFC3986: scheme = ALPHA *( ALPHA / DIGIT / \"+\" / \"-\" / \".\" )\nvar SCHEME_RE = /(?:^|[^a-z0-9.+-])([a-z][a-z0-9.+-]*)$/i;\n\n\nmodule.exports = function linkify(state, silent) {\n  var pos, max, match, proto, link, url, fullUrl, token;\n\n  if (!state.md.options.linkify) return false;\n  if (state.linkLevel > 0) return false;\n\n  pos = state.pos;\n  max = state.posMax;\n\n  if (pos + 3 > max) return false;\n  if (state.src.charCodeAt(pos) !== 0x3A/* : */) return false;\n  if (state.src.charCodeAt(pos + 1) !== 0x2F/* / */) return false;\n  if (state.src.charCodeAt(pos + 2) !== 0x2F/* / */) return false;\n\n  match = state.pending.match(SCHEME_RE);\n  if (!match) return false;\n\n  proto = match[1];\n\n  link = state.md.linkify.matchAtStart(state.src.slice(pos - proto.length));\n  if (!link) return false;\n\n  url = link.url;\n\n  // disallow '*' at the end of the link (conflicts with emphasis)\n  url = url.replace(/\\*+$/, '');\n\n  fullUrl = state.md.normalizeLink(url);\n  if (!state.md.validateLink(fullUrl)) return false;\n\n  if (!silent) {\n    state.pending = state.pending.slice(0, -proto.length);\n\n    token         = state.push('link_open', 'a', 1);\n    token.attrs   = [ [ 'href', fullUrl ] ];\n    token.markup  = 'linkify';\n    token.info    = 'auto';\n\n    token         = state.push('text', '', 0);\n    token.content = state.md.normalizeLinkText(url);\n\n    token         = state.push('link_close', 'a', -1);\n    token.markup  = 'linkify';\n    token.info    = 'auto';\n  }\n\n  state.pos += url.length - proto.length;\n  return true;\n};\n","// Proceess '\\n'\n\n'use strict';\n\nvar isSpace = require('../common/utils').isSpace;\n\n\nmodule.exports = function newline(state, silent) {\n  var pmax, max, ws, pos = state.pos;\n\n  if (state.src.charCodeAt(pos) !== 0x0A/* \\n */) { return false; }\n\n  pmax = state.pending.length - 1;\n  max = state.posMax;\n\n  // '  \\n' -> hardbreak\n  // Lookup in pending chars is bad practice! Don't copy to other rules!\n  // Pending string is stored in concat mode, indexed lookups will cause\n  // convertion to flat mode.\n  if (!silent) {\n    if (pmax >= 0 && state.pending.charCodeAt(pmax) === 0x20) {\n      if (pmax >= 1 && state.pending.charCodeAt(pmax - 1) === 0x20) {\n        // Find whitespaces tail of pending chars.\n        ws = pmax - 1;\n        while (ws >= 1 && state.pending.charCodeAt(ws - 1) === 0x20) ws--;\n\n        state.pending = state.pending.slice(0, ws);\n        state.push('hardbreak', 'br', 0);\n      } else {\n        state.pending = state.pending.slice(0, -1);\n        state.push('softbreak', 'br', 0);\n      }\n\n    } else {\n      state.push('softbreak', 'br', 0);\n    }\n  }\n\n  pos++;\n\n  // skip heading spaces for next line\n  while (pos < max && isSpace(state.src.charCodeAt(pos))) { pos++; }\n\n  state.pos = pos;\n  return true;\n};\n","// ~~strike through~~\n//\n'use strict';\n\n\n// Insert each marker as a separate text token, and add it to delimiter list\n//\nmodule.exports.tokenize = function strikethrough(state, silent) {\n  var i, scanned, token, len, ch,\n      start = state.pos,\n      marker = state.src.charCodeAt(start);\n\n  if (silent) { return false; }\n\n  if (marker !== 0x7E/* ~ */) { return false; }\n\n  scanned = state.scanDelims(state.pos, true);\n  len = scanned.length;\n  ch = String.fromCharCode(marker);\n\n  if (len < 2) { return false; }\n\n  if (len % 2) {\n    token         = state.push('text', '', 0);\n    token.content = ch;\n    len--;\n  }\n\n  for (i = 0; i < len; i += 2) {\n    token         = state.push('text', '', 0);\n    token.content = ch + ch;\n\n    state.delimiters.push({\n      marker: marker,\n      length: 0,     // disable \"rule of 3\" length checks meant for emphasis\n      token:  state.tokens.length - 1,\n      end:    -1,\n      open:   scanned.can_open,\n      close:  scanned.can_close\n    });\n  }\n\n  state.pos += scanned.length;\n\n  return true;\n};\n\n\nfunction postProcess(state, delimiters) {\n  var i, j,\n      startDelim,\n      endDelim,\n      token,\n      loneMarkers = [],\n      max = delimiters.length;\n\n  for (i = 0; i < max; i++) {\n    startDelim = delimiters[i];\n\n    if (startDelim.marker !== 0x7E/* ~ */) {\n      continue;\n    }\n\n    if (startDelim.end === -1) {\n      continue;\n    }\n\n    endDelim = delimiters[startDelim.end];\n\n    token         = state.tokens[startDelim.token];\n    token.type    = 's_open';\n    token.tag     = 's';\n    token.nesting = 1;\n    token.markup  = '~~';\n    token.content = '';\n\n    token         = state.tokens[endDelim.token];\n    token.type    = 's_close';\n    token.tag     = 's';\n    token.nesting = -1;\n    token.markup  = '~~';\n    token.content = '';\n\n    if (state.tokens[endDelim.token - 1].type === 'text' &&\n        state.tokens[endDelim.token - 1].content === '~') {\n\n      loneMarkers.push(endDelim.token - 1);\n    }\n  }\n\n  // If a marker sequence has an odd number of characters, it's splitted\n  // like this: `~~~~~` -> `~` + `~~` + `~~`, leaving one marker at the\n  // start of the sequence.\n  //\n  // So, we have to move all those markers after subsequent s_close tags.\n  //\n  while (loneMarkers.length) {\n    i = loneMarkers.pop();\n    j = i + 1;\n\n    while (j < state.tokens.length && state.tokens[j].type === 's_close') {\n      j++;\n    }\n\n    j--;\n\n    if (i !== j) {\n      token = state.tokens[j];\n      state.tokens[j] = state.tokens[i];\n      state.tokens[i] = token;\n    }\n  }\n}\n\n\n// Walk through delimiter list and replace text tokens with tags\n//\nmodule.exports.postProcess = function strikethrough(state) {\n  var curr,\n      tokens_meta = state.tokens_meta,\n      max = state.tokens_meta.length;\n\n  postProcess(state, state.delimiters);\n\n  for (curr = 0; curr < max; curr++) {\n    if (tokens_meta[curr] && tokens_meta[curr].delimiters) {\n      postProcess(state, tokens_meta[curr].delimiters);\n    }\n  }\n};\n","// Process *this* and _that_\n//\n'use strict';\n\n\n// Insert each marker as a separate text token, and add it to delimiter list\n//\nmodule.exports.tokenize = function emphasis(state, silent) {\n  var i, scanned, token,\n      start = state.pos,\n      marker = state.src.charCodeAt(start);\n\n  if (silent) { return false; }\n\n  if (marker !== 0x5F /* _ */ && marker !== 0x2A /* * */) { return false; }\n\n  scanned = state.scanDelims(state.pos, marker === 0x2A);\n\n  for (i = 0; i < scanned.length; i++) {\n    token         = state.push('text', '', 0);\n    token.content = String.fromCharCode(marker);\n\n    state.delimiters.push({\n      // Char code of the starting marker (number).\n      //\n      marker: marker,\n\n      // Total length of these series of delimiters.\n      //\n      length: scanned.length,\n\n      // A position of the token this delimiter corresponds to.\n      //\n      token:  state.tokens.length - 1,\n\n      // If this delimiter is matched as a valid opener, `end` will be\n      // equal to its position, otherwise it's `-1`.\n      //\n      end:    -1,\n\n      // Boolean flags that determine if this delimiter could open or close\n      // an emphasis.\n      //\n      open:   scanned.can_open,\n      close:  scanned.can_close\n    });\n  }\n\n  state.pos += scanned.length;\n\n  return true;\n};\n\n\nfunction postProcess(state, delimiters) {\n  var i,\n      startDelim,\n      endDelim,\n      token,\n      ch,\n      isStrong,\n      max = delimiters.length;\n\n  for (i = max - 1; i >= 0; i--) {\n    startDelim = delimiters[i];\n\n    if (startDelim.marker !== 0x5F/* _ */ && startDelim.marker !== 0x2A/* * */) {\n      continue;\n    }\n\n    // Process only opening markers\n    if (startDelim.end === -1) {\n      continue;\n    }\n\n    endDelim = delimiters[startDelim.end];\n\n    // If the previous delimiter has the same marker and is adjacent to this one,\n    // merge those into one strong delimiter.\n    //\n    // `<em><em>whatever</em></em>` -> `<strong>whatever</strong>`\n    //\n    isStrong = i > 0 &&\n               delimiters[i - 1].end === startDelim.end + 1 &&\n               // check that first two markers match and adjacent\n               delimiters[i - 1].marker === startDelim.marker &&\n               delimiters[i - 1].token === startDelim.token - 1 &&\n               // check that last two markers are adjacent (we can safely assume they match)\n               delimiters[startDelim.end + 1].token === endDelim.token + 1;\n\n    ch = String.fromCharCode(startDelim.marker);\n\n    token         = state.tokens[startDelim.token];\n    token.type    = isStrong ? 'strong_open' : 'em_open';\n    token.tag     = isStrong ? 'strong' : 'em';\n    token.nesting = 1;\n    token.markup  = isStrong ? ch + ch : ch;\n    token.content = '';\n\n    token         = state.tokens[endDelim.token];\n    token.type    = isStrong ? 'strong_close' : 'em_close';\n    token.tag     = isStrong ? 'strong' : 'em';\n    token.nesting = -1;\n    token.markup  = isStrong ? ch + ch : ch;\n    token.content = '';\n\n    if (isStrong) {\n      state.tokens[delimiters[i - 1].token].content = '';\n      state.tokens[delimiters[startDelim.end + 1].token].content = '';\n      i--;\n    }\n  }\n}\n\n\n// Walk through delimiter list and replace text tokens with tags\n//\nmodule.exports.postProcess = function emphasis(state) {\n  var curr,\n      tokens_meta = state.tokens_meta,\n      max = state.tokens_meta.length;\n\n  postProcess(state, state.delimiters);\n\n  for (curr = 0; curr < max; curr++) {\n    if (tokens_meta[curr] && tokens_meta[curr].delimiters) {\n      postProcess(state, tokens_meta[curr].delimiters);\n    }\n  }\n};\n","// Process [link](<to> \"stuff\")\n\n'use strict';\n\nvar normalizeReference   = require('../common/utils').normalizeReference;\nvar isSpace              = require('../common/utils').isSpace;\n\n\nmodule.exports = function link(state, silent) {\n  var attrs,\n      code,\n      label,\n      labelEnd,\n      labelStart,\n      pos,\n      res,\n      ref,\n      token,\n      href = '',\n      title = '',\n      oldPos = state.pos,\n      max = state.posMax,\n      start = state.pos,\n      parseReference = true;\n\n  if (state.src.charCodeAt(state.pos) !== 0x5B/* [ */) { return false; }\n\n  labelStart = state.pos + 1;\n  labelEnd = state.md.helpers.parseLinkLabel(state, state.pos, true);\n\n  // parser failed to find ']', so it's not a valid link\n  if (labelEnd < 0) { return false; }\n\n  pos = labelEnd + 1;\n  if (pos < max && state.src.charCodeAt(pos) === 0x28/* ( */) {\n    //\n    // Inline link\n    //\n\n    // might have found a valid shortcut link, disable reference parsing\n    parseReference = false;\n\n    // [link](  <href>  \"title\"  )\n    //        ^^ skipping these spaces\n    pos++;\n    for (; pos < max; pos++) {\n      code = state.src.charCodeAt(pos);\n      if (!isSpace(code) && code !== 0x0A) { break; }\n    }\n    if (pos >= max) { return false; }\n\n    // [link](  <href>  \"title\"  )\n    //          ^^^^^^ parsing link destination\n    start = pos;\n    res = state.md.helpers.parseLinkDestination(state.src, pos, state.posMax);\n    if (res.ok) {\n      href = state.md.normalizeLink(res.str);\n      if (state.md.validateLink(href)) {\n        pos = res.pos;\n      } else {\n        href = '';\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                ^^ skipping these spaces\n      start = pos;\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos);\n        if (!isSpace(code) && code !== 0x0A) { break; }\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                  ^^^^^^^ parsing link title\n      res = state.md.helpers.parseLinkTitle(state.src, pos, state.posMax);\n      if (pos < max && start !== pos && res.ok) {\n        title = res.str;\n        pos = res.pos;\n\n        // [link](  <href>  \"title\"  )\n        //                         ^^ skipping these spaces\n        for (; pos < max; pos++) {\n          code = state.src.charCodeAt(pos);\n          if (!isSpace(code) && code !== 0x0A) { break; }\n        }\n      }\n    }\n\n    if (pos >= max || state.src.charCodeAt(pos) !== 0x29/* ) */) {\n      // parsing a valid shortcut link failed, fallback to reference\n      parseReference = true;\n    }\n    pos++;\n  }\n\n  if (parseReference) {\n    //\n    // Link reference\n    //\n    if (typeof state.env.references === 'undefined') { return false; }\n\n    if (pos < max && state.src.charCodeAt(pos) === 0x5B/* [ */) {\n      start = pos + 1;\n      pos = state.md.helpers.parseLinkLabel(state, pos);\n      if (pos >= 0) {\n        label = state.src.slice(start, pos++);\n      } else {\n        pos = labelEnd + 1;\n      }\n    } else {\n      pos = labelEnd + 1;\n    }\n\n    // covers label === '' and label === undefined\n    // (collapsed reference link and shortcut reference link respectively)\n    if (!label) { label = state.src.slice(labelStart, labelEnd); }\n\n    ref = state.env.references[normalizeReference(label)];\n    if (!ref) {\n      state.pos = oldPos;\n      return false;\n    }\n    href = ref.href;\n    title = ref.title;\n  }\n\n  //\n  // We found the end of the link, and know for a fact it's a valid link;\n  // so all that's left to do is to call tokenizer.\n  //\n  if (!silent) {\n    state.pos = labelStart;\n    state.posMax = labelEnd;\n\n    token        = state.push('link_open', 'a', 1);\n    token.attrs  = attrs = [ [ 'href', href ] ];\n    if (title) {\n      attrs.push([ 'title', title ]);\n    }\n\n    state.linkLevel++;\n    state.md.inline.tokenize(state);\n    state.linkLevel--;\n\n    token        = state.push('link_close', 'a', -1);\n  }\n\n  state.pos = pos;\n  state.posMax = max;\n  return true;\n};\n","// Process ![image](<src> \"title\")\n\n'use strict';\n\nvar normalizeReference   = require('../common/utils').normalizeReference;\nvar isSpace              = require('../common/utils').isSpace;\n\n\nmodule.exports = function image(state, silent) {\n  var attrs,\n      code,\n      content,\n      label,\n      labelEnd,\n      labelStart,\n      pos,\n      ref,\n      res,\n      title,\n      token,\n      tokens,\n      start,\n      href = '',\n      oldPos = state.pos,\n      max = state.posMax;\n\n  if (state.src.charCodeAt(state.pos) !== 0x21/* ! */) { return false; }\n  if (state.src.charCodeAt(state.pos + 1) !== 0x5B/* [ */) { return false; }\n\n  labelStart = state.pos + 2;\n  labelEnd = state.md.helpers.parseLinkLabel(state, state.pos + 1, false);\n\n  // parser failed to find ']', so it's not a valid link\n  if (labelEnd < 0) { return false; }\n\n  pos = labelEnd + 1;\n  if (pos < max && state.src.charCodeAt(pos) === 0x28/* ( */) {\n    //\n    // Inline link\n    //\n\n    // [link](  <href>  \"title\"  )\n    //        ^^ skipping these spaces\n    pos++;\n    for (; pos < max; pos++) {\n      code = state.src.charCodeAt(pos);\n      if (!isSpace(code) && code !== 0x0A) { break; }\n    }\n    if (pos >= max) { return false; }\n\n    // [link](  <href>  \"title\"  )\n    //          ^^^^^^ parsing link destination\n    start = pos;\n    res = state.md.helpers.parseLinkDestination(state.src, pos, state.posMax);\n    if (res.ok) {\n      href = state.md.normalizeLink(res.str);\n      if (state.md.validateLink(href)) {\n        pos = res.pos;\n      } else {\n        href = '';\n      }\n    }\n\n    // [link](  <href>  \"title\"  )\n    //                ^^ skipping these spaces\n    start = pos;\n    for (; pos < max; pos++) {\n      code = state.src.charCodeAt(pos);\n      if (!isSpace(code) && code !== 0x0A) { break; }\n    }\n\n    // [link](  <href>  \"title\"  )\n    //                  ^^^^^^^ parsing link title\n    res = state.md.helpers.parseLinkTitle(state.src, pos, state.posMax);\n    if (pos < max && start !== pos && res.ok) {\n      title = res.str;\n      pos = res.pos;\n\n      // [link](  <href>  \"title\"  )\n      //                         ^^ skipping these spaces\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos);\n        if (!isSpace(code) && code !== 0x0A) { break; }\n      }\n    } else {\n      title = '';\n    }\n\n    if (pos >= max || state.src.charCodeAt(pos) !== 0x29/* ) */) {\n      state.pos = oldPos;\n      return false;\n    }\n    pos++;\n  } else {\n    //\n    // Link reference\n    //\n    if (typeof state.env.references === 'undefined') { return false; }\n\n    if (pos < max && state.src.charCodeAt(pos) === 0x5B/* [ */) {\n      start = pos + 1;\n      pos = state.md.helpers.parseLinkLabel(state, pos);\n      if (pos >= 0) {\n        label = state.src.slice(start, pos++);\n      } else {\n        pos = labelEnd + 1;\n      }\n    } else {\n      pos = labelEnd + 1;\n    }\n\n    // covers label === '' and label === undefined\n    // (collapsed reference link and shortcut reference link respectively)\n    if (!label) { label = state.src.slice(labelStart, labelEnd); }\n\n    ref = state.env.references[normalizeReference(label)];\n    if (!ref) {\n      state.pos = oldPos;\n      return false;\n    }\n    href = ref.href;\n    title = ref.title;\n  }\n\n  //\n  // We found the end of the link, and know for a fact it's a valid link;\n  // so all that's left to do is to call tokenizer.\n  //\n  if (!silent) {\n    content = state.src.slice(labelStart, labelEnd);\n\n    state.md.inline.parse(\n      content,\n      state.md,\n      state.env,\n      tokens = []\n    );\n\n    token          = state.push('image', 'img', 0);\n    token.attrs    = attrs = [ [ 'src', href ], [ 'alt', '' ] ];\n    token.children = tokens;\n    token.content  = content;\n\n    if (title) {\n      attrs.push([ 'title', title ]);\n    }\n  }\n\n  state.pos = pos;\n  state.posMax = max;\n  return true;\n};\n","// Process autolinks '<protocol:...>'\n\n'use strict';\n\n\n/*eslint max-len:0*/\nvar EMAIL_RE    = /^([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)$/;\nvar AUTOLINK_RE = /^([a-zA-Z][a-zA-Z0-9+.\\-]{1,31}):([^<>\\x00-\\x20]*)$/;\n\n\nmodule.exports = function autolink(state, silent) {\n  var url, fullUrl, token, ch, start, max,\n      pos = state.pos;\n\n  if (state.src.charCodeAt(pos) !== 0x3C/* < */) { return false; }\n\n  start = state.pos;\n  max = state.posMax;\n\n  for (;;) {\n    if (++pos >= max) return false;\n\n    ch = state.src.charCodeAt(pos);\n\n    if (ch === 0x3C /* < */) return false;\n    if (ch === 0x3E /* > */) break;\n  }\n\n  url = state.src.slice(start + 1, pos);\n\n  if (AUTOLINK_RE.test(url)) {\n    fullUrl = state.md.normalizeLink(url);\n    if (!state.md.validateLink(fullUrl)) { return false; }\n\n    if (!silent) {\n      token         = state.push('link_open', 'a', 1);\n      token.attrs   = [ [ 'href', fullUrl ] ];\n      token.markup  = 'autolink';\n      token.info    = 'auto';\n\n      token         = state.push('text', '', 0);\n      token.content = state.md.normalizeLinkText(url);\n\n      token         = state.push('link_close', 'a', -1);\n      token.markup  = 'autolink';\n      token.info    = 'auto';\n    }\n\n    state.pos += url.length + 2;\n    return true;\n  }\n\n  if (EMAIL_RE.test(url)) {\n    fullUrl = state.md.normalizeLink('mailto:' + url);\n    if (!state.md.validateLink(fullUrl)) { return false; }\n\n    if (!silent) {\n      token         = state.push('link_open', 'a', 1);\n      token.attrs   = [ [ 'href', fullUrl ] ];\n      token.markup  = 'autolink';\n      token.info    = 'auto';\n\n      token         = state.push('text', '', 0);\n      token.content = state.md.normalizeLinkText(url);\n\n      token         = state.push('link_close', 'a', -1);\n      token.markup  = 'autolink';\n      token.info    = 'auto';\n    }\n\n    state.pos += url.length + 2;\n    return true;\n  }\n\n  return false;\n};\n","// Process html tags\n\n'use strict';\n\n\nvar HTML_TAG_RE = require('../common/html_re').HTML_TAG_RE;\n\n\nfunction isLinkOpen(str) {\n  return /^<a[>\\s]/i.test(str);\n}\nfunction isLinkClose(str) {\n  return /^<\\/a\\s*>/i.test(str);\n}\n\n\nfunction isLetter(ch) {\n  /*eslint no-bitwise:0*/\n  var lc = ch | 0x20; // to lower case\n  return (lc >= 0x61/* a */) && (lc <= 0x7a/* z */);\n}\n\n\nmodule.exports = function html_inline(state, silent) {\n  var ch, match, max, token,\n      pos = state.pos;\n\n  if (!state.md.options.html) { return false; }\n\n  // Check start\n  max = state.posMax;\n  if (state.src.charCodeAt(pos) !== 0x3C/* < */ ||\n      pos + 2 >= max) {\n    return false;\n  }\n\n  // Quick fail on second char\n  ch = state.src.charCodeAt(pos + 1);\n  if (ch !== 0x21/* ! */ &&\n      ch !== 0x3F/* ? */ &&\n      ch !== 0x2F/* / */ &&\n      !isLetter(ch)) {\n    return false;\n  }\n\n  match = state.src.slice(pos).match(HTML_TAG_RE);\n  if (!match) { return false; }\n\n  if (!silent) {\n    token         = state.push('html_inline', '', 0);\n    token.content = state.src.slice(pos, pos + match[0].length);\n\n    if (isLinkOpen(token.content))  state.linkLevel++;\n    if (isLinkClose(token.content)) state.linkLevel--;\n  }\n  state.pos += match[0].length;\n  return true;\n};\n","// Process html entity - &#123;, &#xAF;, &quot;, ...\n\n'use strict';\n\nvar entities          = require('../common/entities');\nvar has               = require('../common/utils').has;\nvar isValidEntityCode = require('../common/utils').isValidEntityCode;\nvar fromCodePoint     = require('../common/utils').fromCodePoint;\n\n\nvar DIGITAL_RE = /^&#((?:x[a-f0-9]{1,6}|[0-9]{1,7}));/i;\nvar NAMED_RE   = /^&([a-z][a-z0-9]{1,31});/i;\n\n\nmodule.exports = function entity(state, silent) {\n  var ch, code, match, token, pos = state.pos, max = state.posMax;\n\n  if (state.src.charCodeAt(pos) !== 0x26/* & */) return false;\n\n  if (pos + 1 >= max) return false;\n\n  ch = state.src.charCodeAt(pos + 1);\n\n  if (ch === 0x23 /* # */) {\n    match = state.src.slice(pos).match(DIGITAL_RE);\n    if (match) {\n      if (!silent) {\n        code = match[1][0].toLowerCase() === 'x' ? parseInt(match[1].slice(1), 16) : parseInt(match[1], 10);\n\n        token         = state.push('text_special', '', 0);\n        token.content = isValidEntityCode(code) ? fromCodePoint(code) : fromCodePoint(0xFFFD);\n        token.markup  = match[0];\n        token.info    = 'entity';\n      }\n      state.pos += match[0].length;\n      return true;\n    }\n  } else {\n    match = state.src.slice(pos).match(NAMED_RE);\n    if (match) {\n      if (has(entities, match[1])) {\n        if (!silent) {\n          token         = state.push('text_special', '', 0);\n          token.content = entities[match[1]];\n          token.markup  = match[0];\n          token.info    = 'entity';\n        }\n        state.pos += match[0].length;\n        return true;\n      }\n    }\n  }\n\n  return false;\n};\n","// For each opening emphasis-like marker find a matching closing one\n//\n'use strict';\n\n\nfunction processDelimiters(state, delimiters) {\n  var closerIdx, openerIdx, closer, opener, minOpenerIdx, newMinOpenerIdx,\n      isOddMatch, lastJump,\n      openersBottom = {},\n      max = delimiters.length;\n\n  if (!max) return;\n\n  // headerIdx is the first delimiter of the current (where closer is) delimiter run\n  var headerIdx = 0;\n  var lastTokenIdx = -2; // needs any value lower than -1\n  var jumps = [];\n\n  for (closerIdx = 0; closerIdx < max; closerIdx++) {\n    closer = delimiters[closerIdx];\n\n    jumps.push(0);\n\n    // markers belong to same delimiter run if:\n    //  - they have adjacent tokens\n    //  - AND markers are the same\n    //\n    if (delimiters[headerIdx].marker !== closer.marker || lastTokenIdx !== closer.token - 1) {\n      headerIdx = closerIdx;\n    }\n\n    lastTokenIdx = closer.token;\n\n    // Length is only used for emphasis-specific \"rule of 3\",\n    // if it's not defined (in strikethrough or 3rd party plugins),\n    // we can default it to 0 to disable those checks.\n    //\n    closer.length = closer.length || 0;\n\n    if (!closer.close) continue;\n\n    // Previously calculated lower bounds (previous fails)\n    // for each marker, each delimiter length modulo 3,\n    // and for whether this closer can be an opener;\n    // https://github.com/commonmark/cmark/commit/34250e12ccebdc6372b8b49c44fab57c72443460\n    if (!openersBottom.hasOwnProperty(closer.marker)) {\n      openersBottom[closer.marker] = [ -1, -1, -1, -1, -1, -1 ];\n    }\n\n    minOpenerIdx = openersBottom[closer.marker][(closer.open ? 3 : 0) + (closer.length % 3)];\n\n    openerIdx = headerIdx - jumps[headerIdx] - 1;\n\n    newMinOpenerIdx = openerIdx;\n\n    for (; openerIdx > minOpenerIdx; openerIdx -= jumps[openerIdx] + 1) {\n      opener = delimiters[openerIdx];\n\n      if (opener.marker !== closer.marker) continue;\n\n      if (opener.open && opener.end < 0) {\n\n        isOddMatch = false;\n\n        // from spec:\n        //\n        // If one of the delimiters can both open and close emphasis, then the\n        // sum of the lengths of the delimiter runs containing the opening and\n        // closing delimiters must not be a multiple of 3 unless both lengths\n        // are multiples of 3.\n        //\n        if (opener.close || closer.open) {\n          if ((opener.length + closer.length) % 3 === 0) {\n            if (opener.length % 3 !== 0 || closer.length % 3 !== 0) {\n              isOddMatch = true;\n            }\n          }\n        }\n\n        if (!isOddMatch) {\n          // If previous delimiter cannot be an opener, we can safely skip\n          // the entire sequence in future checks. This is required to make\n          // sure algorithm has linear complexity (see *_*_*_*_*_... case).\n          //\n          lastJump = openerIdx > 0 && !delimiters[openerIdx - 1].open ?\n            jumps[openerIdx - 1] + 1 :\n            0;\n\n          jumps[closerIdx] = closerIdx - openerIdx + lastJump;\n          jumps[openerIdx] = lastJump;\n\n          closer.open  = false;\n          opener.end   = closerIdx;\n          opener.close = false;\n          newMinOpenerIdx = -1;\n          // treat next token as start of run,\n          // it optimizes skips in **<...>**a**<...>** pathological case\n          lastTokenIdx = -2;\n          break;\n        }\n      }\n    }\n\n    if (newMinOpenerIdx !== -1) {\n      // If match for this delimiter run failed, we want to set lower bound for\n      // future lookups. This is required to make sure algorithm has linear\n      // complexity.\n      //\n      // See details here:\n      // https://github.com/commonmark/cmark/issues/178#issuecomment-270417442\n      //\n      openersBottom[closer.marker][(closer.open ? 3 : 0) + ((closer.length || 0) % 3)] = newMinOpenerIdx;\n    }\n  }\n}\n\n\nmodule.exports = function link_pairs(state) {\n  var curr,\n      tokens_meta = state.tokens_meta,\n      max = state.tokens_meta.length;\n\n  processDelimiters(state, state.delimiters);\n\n  for (curr = 0; curr < max; curr++) {\n    if (tokens_meta[curr] && tokens_meta[curr].delimiters) {\n      processDelimiters(state, tokens_meta[curr].delimiters);\n    }\n  }\n};\n","// Inline parser state\n\n'use strict';\n\n\nvar Token          = require('../token');\nvar isWhiteSpace   = require('../common/utils').isWhiteSpace;\nvar isPunctChar    = require('../common/utils').isPunctChar;\nvar isMdAsciiPunct = require('../common/utils').isMdAsciiPunct;\n\n\nfunction StateInline(src, md, env, outTokens) {\n  this.src = src;\n  this.env = env;\n  this.md = md;\n  this.tokens = outTokens;\n  this.tokens_meta = Array(outTokens.length);\n\n  this.pos = 0;\n  this.posMax = this.src.length;\n  this.level = 0;\n  this.pending = '';\n  this.pendingLevel = 0;\n\n  // Stores { start: end } pairs. Useful for backtrack\n  // optimization of pairs parse (emphasis, strikes).\n  this.cache = {};\n\n  // List of emphasis-like delimiters for current tag\n  this.delimiters = [];\n\n  // Stack of delimiter lists for upper level tags\n  this._prev_delimiters = [];\n\n  // backtick length => last seen position\n  this.backticks = {};\n  this.backticksScanned = false;\n\n  // Counter used to disable inline linkify-it execution\n  // inside <a> and markdown links\n  this.linkLevel = 0;\n}\n\n\n// Flush pending text\n//\nStateInline.prototype.pushPending = function () {\n  var token = new Token('text', '', 0);\n  token.content = this.pending;\n  token.level = this.pendingLevel;\n  this.tokens.push(token);\n  this.pending = '';\n  return token;\n};\n\n\n// Push new token to \"stream\".\n// If pending text exists - flush it as text token\n//\nStateInline.prototype.push = function (type, tag, nesting) {\n  if (this.pending) {\n    this.pushPending();\n  }\n\n  var token = new Token(type, tag, nesting);\n  var token_meta = null;\n\n  if (nesting < 0) {\n    // closing tag\n    this.level--;\n    this.delimiters = this._prev_delimiters.pop();\n  }\n\n  token.level = this.level;\n\n  if (nesting > 0) {\n    // opening tag\n    this.level++;\n    this._prev_delimiters.push(this.delimiters);\n    this.delimiters = [];\n    token_meta = { delimiters: this.delimiters };\n  }\n\n  this.pendingLevel = this.level;\n  this.tokens.push(token);\n  this.tokens_meta.push(token_meta);\n  return token;\n};\n\n\n// Scan a sequence of emphasis-like markers, and determine whether\n// it can start an emphasis sequence or end an emphasis sequence.\n//\n//  - start - position to scan from (it should point at a valid marker);\n//  - canSplitWord - determine if these markers can be found inside a word\n//\nStateInline.prototype.scanDelims = function (start, canSplitWord) {\n  var pos = start, lastChar, nextChar, count, can_open, can_close,\n      isLastWhiteSpace, isLastPunctChar,\n      isNextWhiteSpace, isNextPunctChar,\n      left_flanking = true,\n      right_flanking = true,\n      max = this.posMax,\n      marker = this.src.charCodeAt(start);\n\n  // treat beginning of the line as a whitespace\n  lastChar = start > 0 ? this.src.charCodeAt(start - 1) : 0x20;\n\n  while (pos < max && this.src.charCodeAt(pos) === marker) { pos++; }\n\n  count = pos - start;\n\n  // treat end of the line as a whitespace\n  nextChar = pos < max ? this.src.charCodeAt(pos) : 0x20;\n\n  isLastPunctChar = isMdAsciiPunct(lastChar) || isPunctChar(String.fromCharCode(lastChar));\n  isNextPunctChar = isMdAsciiPunct(nextChar) || isPunctChar(String.fromCharCode(nextChar));\n\n  isLastWhiteSpace = isWhiteSpace(lastChar);\n  isNextWhiteSpace = isWhiteSpace(nextChar);\n\n  if (isNextWhiteSpace) {\n    left_flanking = false;\n  } else if (isNextPunctChar) {\n    if (!(isLastWhiteSpace || isLastPunctChar)) {\n      left_flanking = false;\n    }\n  }\n\n  if (isLastWhiteSpace) {\n    right_flanking = false;\n  } else if (isLastPunctChar) {\n    if (!(isNextWhiteSpace || isNextPunctChar)) {\n      right_flanking = false;\n    }\n  }\n\n  if (!canSplitWord) {\n    can_open  = left_flanking  && (!right_flanking || isLastPunctChar);\n    can_close = right_flanking && (!left_flanking  || isNextPunctChar);\n  } else {\n    can_open  = left_flanking;\n    can_close = right_flanking;\n  }\n\n  return {\n    can_open:  can_open,\n    can_close: can_close,\n    length:    count\n  };\n};\n\n\n// re-export Token class to use in block rules\nStateInline.prototype.Token = Token;\n\n\nmodule.exports = StateInline;\n","/** internal\n * class ParserInline\n *\n * Tokenizes paragraph content.\n **/\n'use strict';\n\n\nvar Ruler           = require('./ruler');\n\n\n////////////////////////////////////////////////////////////////////////////////\n// Parser rules\n\nvar _rules = [\n  [ 'text',            require('./rules_inline/text') ],\n  [ 'linkify',         require('./rules_inline/linkify') ],\n  [ 'newline',         require('./rules_inline/newline') ],\n  [ 'escape',          require('./rules_inline/escape') ],\n  [ 'backticks',       require('./rules_inline/backticks') ],\n  [ 'strikethrough',   require('./rules_inline/strikethrough').tokenize ],\n  [ 'emphasis',        require('./rules_inline/emphasis').tokenize ],\n  [ 'link',            require('./rules_inline/link') ],\n  [ 'image',           require('./rules_inline/image') ],\n  [ 'autolink',        require('./rules_inline/autolink') ],\n  [ 'html_inline',     require('./rules_inline/html_inline') ],\n  [ 'entity',          require('./rules_inline/entity') ]\n];\n\n// `rule2` ruleset was created specifically for emphasis/strikethrough\n// post-processing and may be changed in the future.\n//\n// Don't use this for anything except pairs (plugins working with `balance_pairs`).\n//\nvar _rules2 = [\n  [ 'balance_pairs',   require('./rules_inline/balance_pairs') ],\n  [ 'strikethrough',   require('./rules_inline/strikethrough').postProcess ],\n  [ 'emphasis',        require('./rules_inline/emphasis').postProcess ],\n  // rules for pairs separate '**' into its own text tokens, which may be left unused,\n  // rule below merges unused segments back with the rest of the text\n  [ 'fragments_join',  require('./rules_inline/fragments_join') ]\n];\n\n\n/**\n * new ParserInline()\n **/\nfunction ParserInline() {\n  var i;\n\n  /**\n   * ParserInline#ruler -> Ruler\n   *\n   * [[Ruler]] instance. Keep configuration of inline rules.\n   **/\n  this.ruler = new Ruler();\n\n  for (i = 0; i < _rules.length; i++) {\n    this.ruler.push(_rules[i][0], _rules[i][1]);\n  }\n\n  /**\n   * ParserInline#ruler2 -> Ruler\n   *\n   * [[Ruler]] instance. Second ruler used for post-processing\n   * (e.g. in emphasis-like rules).\n   **/\n  this.ruler2 = new Ruler();\n\n  for (i = 0; i < _rules2.length; i++) {\n    this.ruler2.push(_rules2[i][0], _rules2[i][1]);\n  }\n}\n\n\n// Skip single token by running all rules in validation mode;\n// returns `true` if any rule reported success\n//\nParserInline.prototype.skipToken = function (state) {\n  var ok, i, pos = state.pos,\n      rules = this.ruler.getRules(''),\n      len = rules.length,\n      maxNesting = state.md.options.maxNesting,\n      cache = state.cache;\n\n\n  if (typeof cache[pos] !== 'undefined') {\n    state.pos = cache[pos];\n    return;\n  }\n\n  if (state.level < maxNesting) {\n    for (i = 0; i < len; i++) {\n      // Increment state.level and decrement it later to limit recursion.\n      // It's harmless to do here, because no tokens are created. But ideally,\n      // we'd need a separate private state variable for this purpose.\n      //\n      state.level++;\n      ok = rules[i](state, true);\n      state.level--;\n\n      if (ok) { break; }\n    }\n  } else {\n    // Too much nesting, just skip until the end of the paragraph.\n    //\n    // NOTE: this will cause links to behave incorrectly in the following case,\n    //       when an amount of `[` is exactly equal to `maxNesting + 1`:\n    //\n    //       [[[[[[[[[[[[[[[[[[[[[foo]()\n    //\n    // TODO: remove this workaround when CM standard will allow nested links\n    //       (we can replace it by preventing links from being parsed in\n    //       validation mode)\n    //\n    state.pos = state.posMax;\n  }\n\n  if (!ok) { state.pos++; }\n  cache[pos] = state.pos;\n};\n\n\n// Generate tokens for input range\n//\nParserInline.prototype.tokenize = function (state) {\n  var ok, i,\n      rules = this.ruler.getRules(''),\n      len = rules.length,\n      end = state.posMax,\n      maxNesting = state.md.options.maxNesting;\n\n  while (state.pos < end) {\n    // Try all possible rules.\n    // On success, rule should:\n    //\n    // - update `state.pos`\n    // - update `state.tokens`\n    // - return true\n\n    if (state.level < maxNesting) {\n      for (i = 0; i < len; i++) {\n        ok = rules[i](state, false);\n        if (ok) { break; }\n      }\n    }\n\n    if (ok) {\n      if (state.pos >= end) { break; }\n      continue;\n    }\n\n    state.pending += state.src[state.pos++];\n  }\n\n  if (state.pending) {\n    state.pushPending();\n  }\n};\n\n\n/**\n * ParserInline.parse(str, md, env, outTokens)\n *\n * Process input string and push inline tokens into `outTokens`\n **/\nParserInline.prototype.parse = function (str, md, env, outTokens) {\n  var i, rules, len;\n  var state = new this.State(str, md, env, outTokens);\n\n  this.tokenize(state);\n\n  rules = this.ruler2.getRules('');\n  len = rules.length;\n\n  for (i = 0; i < len; i++) {\n    rules[i](state);\n  }\n};\n\n\nParserInline.prototype.State = require('./rules_inline/state_inline');\n\n\nmodule.exports = ParserInline;\n","// Parse backticks\n\n'use strict';\n\n\nmodule.exports = function backtick(state, silent) {\n  var start, max, marker, token, matchStart, matchEnd, openerLength, closerLength,\n      pos = state.pos,\n      ch = state.src.charCodeAt(pos);\n\n  if (ch !== 0x60/* ` */) { return false; }\n\n  start = pos;\n  pos++;\n  max = state.posMax;\n\n  // scan marker length\n  while (pos < max && state.src.charCodeAt(pos) === 0x60/* ` */) { pos++; }\n\n  marker = state.src.slice(start, pos);\n  openerLength = marker.length;\n\n  if (state.backticksScanned && (state.backticks[openerLength] || 0) <= start) {\n    if (!silent) state.pending += marker;\n    state.pos += openerLength;\n    return true;\n  }\n\n  matchStart = matchEnd = pos;\n\n  // Nothing found in the cache, scan until the end of the line (or until marker is found)\n  while ((matchStart = state.src.indexOf('`', matchEnd)) !== -1) {\n    matchEnd = matchStart + 1;\n\n    // scan marker length\n    while (matchEnd < max && state.src.charCodeAt(matchEnd) === 0x60/* ` */) { matchEnd++; }\n\n    closerLength = matchEnd - matchStart;\n\n    if (closerLength === openerLength) {\n      // Found matching closer length.\n      if (!silent) {\n        token     = state.push('code_inline', 'code', 0);\n        token.markup  = marker;\n        token.content = state.src.slice(pos, matchStart)\n          .replace(/\\n/g, ' ')\n          .replace(/^ (.+) $/, '$1');\n      }\n      state.pos = matchEnd;\n      return true;\n    }\n\n    // Some different length found, put it in cache as upper limit of where closer can be found\n    state.backticks[closerLength] = matchStart;\n  }\n\n  // Scanned through the end, didn't find anything\n  state.backticksScanned = true;\n\n  if (!silent) state.pending += marker;\n  state.pos += openerLength;\n  return true;\n};\n","// Clean up tokens after emphasis and strikethrough postprocessing:\n// merge adjacent text nodes into one and re-calculate all token levels\n//\n// This is necessary because initially emphasis delimiter markers (*, _, ~)\n// are treated as their own separate text tokens. Then emphasis rule either\n// leaves them as text (needed to merge with adjacent text) or turns them\n// into opening/closing tags (which messes up levels inside).\n//\n'use strict';\n\n\nmodule.exports = function fragments_join(state) {\n  var curr, last,\n      level = 0,\n      tokens = state.tokens,\n      max = state.tokens.length;\n\n  for (curr = last = 0; curr < max; curr++) {\n    // re-calculate levels after emphasis/strikethrough turns some text nodes\n    // into opening/closing tags\n    if (tokens[curr].nesting < 0) level--; // closing tag\n    tokens[curr].level = level;\n    if (tokens[curr].nesting > 0) level++; // opening tag\n\n    if (tokens[curr].type === 'text' &&\n        curr + 1 < max &&\n        tokens[curr + 1].type === 'text') {\n\n      // collapse two adjacent text nodes\n      tokens[curr + 1].content = tokens[curr].content + tokens[curr + 1].content;\n    } else {\n      if (curr !== last) { tokens[last] = tokens[curr]; }\n\n      last++;\n    }\n  }\n\n  if (curr !== last) {\n    tokens.length = last;\n  }\n};\n","'use strict';\n\n\n////////////////////////////////////////////////////////////////////////////////\n// Helpers\n\n// Merge objects\n//\nfunction assign(obj /*from1, from2, from3, ...*/) {\n  var sources = Array.prototype.slice.call(arguments, 1);\n\n  sources.forEach(function (source) {\n    if (!source) { return; }\n\n    Object.keys(source).forEach(function (key) {\n      obj[key] = source[key];\n    });\n  });\n\n  return obj;\n}\n\nfunction _class(obj) { return Object.prototype.toString.call(obj); }\nfunction isString(obj) { return _class(obj) === '[object String]'; }\nfunction isObject(obj) { return _class(obj) === '[object Object]'; }\nfunction isRegExp(obj) { return _class(obj) === '[object RegExp]'; }\nfunction isFunction(obj) { return _class(obj) === '[object Function]'; }\n\n\nfunction escapeRE(str) { return str.replace(/[.?*+^$[\\]\\\\(){}|-]/g, '\\\\$&'); }\n\n////////////////////////////////////////////////////////////////////////////////\n\n\nvar defaultOptions = {\n  fuzzyLink: true,\n  fuzzyEmail: true,\n  fuzzyIP: false\n};\n\n\nfunction isOptionsObj(obj) {\n  return Object.keys(obj || {}).reduce(function (acc, k) {\n    return acc || defaultOptions.hasOwnProperty(k);\n  }, false);\n}\n\n\nvar defaultSchemas = {\n  'http:': {\n    validate: function (text, pos, self) {\n      var tail = text.slice(pos);\n\n      if (!self.re.http) {\n        // compile lazily, because \"host\"-containing variables can change on tlds update.\n        self.re.http =  new RegExp(\n          '^\\\\/\\\\/' + self.re.src_auth + self.re.src_host_port_strict + self.re.src_path, 'i'\n        );\n      }\n      if (self.re.http.test(tail)) {\n        return tail.match(self.re.http)[0].length;\n      }\n      return 0;\n    }\n  },\n  'https:':  'http:',\n  'ftp:':    'http:',\n  '//':      {\n    validate: function (text, pos, self) {\n      var tail = text.slice(pos);\n\n      if (!self.re.no_http) {\n      // compile lazily, because \"host\"-containing variables can change on tlds update.\n        self.re.no_http =  new RegExp(\n          '^' +\n          self.re.src_auth +\n          // Don't allow single-level domains, because of false positives like '//test'\n          // with code comments\n          '(?:localhost|(?:(?:' + self.re.src_domain + ')\\\\.)+' + self.re.src_domain_root + ')' +\n          self.re.src_port +\n          self.re.src_host_terminator +\n          self.re.src_path,\n\n          'i'\n        );\n      }\n\n      if (self.re.no_http.test(tail)) {\n        // should not be `://` & `///`, that protects from errors in protocol name\n        if (pos >= 3 && text[pos - 3] === ':') { return 0; }\n        if (pos >= 3 && text[pos - 3] === '/') { return 0; }\n        return tail.match(self.re.no_http)[0].length;\n      }\n      return 0;\n    }\n  },\n  'mailto:': {\n    validate: function (text, pos, self) {\n      var tail = text.slice(pos);\n\n      if (!self.re.mailto) {\n        self.re.mailto =  new RegExp(\n          '^' + self.re.src_email_name + '@' + self.re.src_host_strict, 'i'\n        );\n      }\n      if (self.re.mailto.test(tail)) {\n        return tail.match(self.re.mailto)[0].length;\n      }\n      return 0;\n    }\n  }\n};\n\n/*eslint-disable max-len*/\n\n// RE pattern for 2-character tlds (autogenerated by ./support/tlds_2char_gen.js)\nvar tlds_2ch_src_re = 'a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]';\n\n// DON'T try to make PRs with changes. Extend TLDs with LinkifyIt.tlds() instead\nvar tlds_default = 'biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|'.split('|');\n\n/*eslint-enable max-len*/\n\n////////////////////////////////////////////////////////////////////////////////\n\nfunction resetScanCache(self) {\n  self.__index__ = -1;\n  self.__text_cache__   = '';\n}\n\nfunction createValidator(re) {\n  return function (text, pos) {\n    var tail = text.slice(pos);\n\n    if (re.test(tail)) {\n      return tail.match(re)[0].length;\n    }\n    return 0;\n  };\n}\n\nfunction createNormalizer() {\n  return function (match, self) {\n    self.normalize(match);\n  };\n}\n\n// Schemas compiler. Build regexps.\n//\nfunction compile(self) {\n\n  // Load & clone RE patterns.\n  var re = self.re = require('./lib/re')(self.__opts__);\n\n  // Define dynamic patterns\n  var tlds = self.__tlds__.slice();\n\n  self.onCompile();\n\n  if (!self.__tlds_replaced__) {\n    tlds.push(tlds_2ch_src_re);\n  }\n  tlds.push(re.src_xn);\n\n  re.src_tlds = tlds.join('|');\n\n  function untpl(tpl) { return tpl.replace('%TLDS%', re.src_tlds); }\n\n  re.email_fuzzy      = RegExp(untpl(re.tpl_email_fuzzy), 'i');\n  re.link_fuzzy       = RegExp(untpl(re.tpl_link_fuzzy), 'i');\n  re.link_no_ip_fuzzy = RegExp(untpl(re.tpl_link_no_ip_fuzzy), 'i');\n  re.host_fuzzy_test  = RegExp(untpl(re.tpl_host_fuzzy_test), 'i');\n\n  //\n  // Compile each schema\n  //\n\n  var aliases = [];\n\n  self.__compiled__ = {}; // Reset compiled data\n\n  function schemaError(name, val) {\n    throw new Error('(LinkifyIt) Invalid schema \"' + name + '\": ' + val);\n  }\n\n  Object.keys(self.__schemas__).forEach(function (name) {\n    var val = self.__schemas__[name];\n\n    // skip disabled methods\n    if (val === null) { return; }\n\n    var compiled = { validate: null, link: null };\n\n    self.__compiled__[name] = compiled;\n\n    if (isObject(val)) {\n      if (isRegExp(val.validate)) {\n        compiled.validate = createValidator(val.validate);\n      } else if (isFunction(val.validate)) {\n        compiled.validate = val.validate;\n      } else {\n        schemaError(name, val);\n      }\n\n      if (isFunction(val.normalize)) {\n        compiled.normalize = val.normalize;\n      } else if (!val.normalize) {\n        compiled.normalize = createNormalizer();\n      } else {\n        schemaError(name, val);\n      }\n\n      return;\n    }\n\n    if (isString(val)) {\n      aliases.push(name);\n      return;\n    }\n\n    schemaError(name, val);\n  });\n\n  //\n  // Compile postponed aliases\n  //\n\n  aliases.forEach(function (alias) {\n    if (!self.__compiled__[self.__schemas__[alias]]) {\n      // Silently fail on missed schemas to avoid errons on disable.\n      // schemaError(alias, self.__schemas__[alias]);\n      return;\n    }\n\n    self.__compiled__[alias].validate =\n      self.__compiled__[self.__schemas__[alias]].validate;\n    self.__compiled__[alias].normalize =\n      self.__compiled__[self.__schemas__[alias]].normalize;\n  });\n\n  //\n  // Fake record for guessed links\n  //\n  self.__compiled__[''] = { validate: null, normalize: createNormalizer() };\n\n  //\n  // Build schema condition\n  //\n  var slist = Object.keys(self.__compiled__)\n                      .filter(function (name) {\n                        // Filter disabled & fake schemas\n                        return name.length > 0 && self.__compiled__[name];\n                      })\n                      .map(escapeRE)\n                      .join('|');\n  // (?!_) cause 1.5x slowdown\n  self.re.schema_test     = RegExp('(^|(?!_)(?:[><\\uff5c]|' + re.src_ZPCc + '))(' + slist + ')', 'i');\n  self.re.schema_search   = RegExp('(^|(?!_)(?:[><\\uff5c]|' + re.src_ZPCc + '))(' + slist + ')', 'ig');\n  self.re.schema_at_start = RegExp('^' + self.re.schema_search.source, 'i');\n\n  self.re.pretest = RegExp(\n    '(' + self.re.schema_test.source + ')|(' + self.re.host_fuzzy_test.source + ')|@',\n    'i'\n  );\n\n  //\n  // Cleanup\n  //\n\n  resetScanCache(self);\n}\n\n/**\n * class Match\n *\n * Match result. Single element of array, returned by [[LinkifyIt#match]]\n **/\nfunction Match(self, shift) {\n  var start = self.__index__,\n      end   = self.__last_index__,\n      text  = self.__text_cache__.slice(start, end);\n\n  /**\n   * Match#schema -> String\n   *\n   * Prefix (protocol) for matched string.\n   **/\n  this.schema    = self.__schema__.toLowerCase();\n  /**\n   * Match#index -> Number\n   *\n   * First position of matched string.\n   **/\n  this.index     = start + shift;\n  /**\n   * Match#lastIndex -> Number\n   *\n   * Next position after matched string.\n   **/\n  this.lastIndex = end + shift;\n  /**\n   * Match#raw -> String\n   *\n   * Matched string.\n   **/\n  this.raw       = text;\n  /**\n   * Match#text -> String\n   *\n   * Notmalized text of matched string.\n   **/\n  this.text      = text;\n  /**\n   * Match#url -> String\n   *\n   * Normalized url of matched string.\n   **/\n  this.url       = text;\n}\n\nfunction createMatch(self, shift) {\n  var match = new Match(self, shift);\n\n  self.__compiled__[match.schema].normalize(match, self);\n\n  return match;\n}\n\n\n/**\n * class LinkifyIt\n **/\n\n/**\n * new LinkifyIt(schemas, options)\n * - schemas (Object): Optional. Additional schemas to validate (prefix/validator)\n * - options (Object): { fuzzyLink|fuzzyEmail|fuzzyIP: true|false }\n *\n * Creates new linkifier instance with optional additional schemas.\n * Can be called without `new` keyword for convenience.\n *\n * By default understands:\n *\n * - `http(s)://...` , `ftp://...`, `mailto:...` & `//...` links\n * - \"fuzzy\" links and emails (example.com, foo@bar.com).\n *\n * `schemas` is an object, where each key/value describes protocol/rule:\n *\n * - __key__ - link prefix (usually, protocol name with `:` at the end, `skype:`\n *   for example). `linkify-it` makes shure that prefix is not preceeded with\n *   alphanumeric char and symbols. Only whitespaces and punctuation allowed.\n * - __value__ - rule to check tail after link prefix\n *   - _String_ - just alias to existing rule\n *   - _Object_\n *     - _validate_ - validator function (should return matched length on success),\n *       or `RegExp`.\n *     - _normalize_ - optional function to normalize text & url of matched result\n *       (for example, for @twitter mentions).\n *\n * `options`:\n *\n * - __fuzzyLink__ - recognige URL-s without `http(s):` prefix. Default `true`.\n * - __fuzzyIP__ - allow IPs in fuzzy links above. Can conflict with some texts\n *   like version numbers. Default `false`.\n * - __fuzzyEmail__ - recognize emails without `mailto:` prefix.\n *\n **/\nfunction LinkifyIt(schemas, options) {\n  if (!(this instanceof LinkifyIt)) {\n    return new LinkifyIt(schemas, options);\n  }\n\n  if (!options) {\n    if (isOptionsObj(schemas)) {\n      options = schemas;\n      schemas = {};\n    }\n  }\n\n  this.__opts__           = assign({}, defaultOptions, options);\n\n  // Cache last tested result. Used to skip repeating steps on next `match` call.\n  this.__index__          = -1;\n  this.__last_index__     = -1; // Next scan position\n  this.__schema__         = '';\n  this.__text_cache__     = '';\n\n  this.__schemas__        = assign({}, defaultSchemas, schemas);\n  this.__compiled__       = {};\n\n  this.__tlds__           = tlds_default;\n  this.__tlds_replaced__  = false;\n\n  this.re = {};\n\n  compile(this);\n}\n\n\n/** chainable\n * LinkifyIt#add(schema, definition)\n * - schema (String): rule name (fixed pattern prefix)\n * - definition (String|RegExp|Object): schema definition\n *\n * Add new rule definition. See constructor description for details.\n **/\nLinkifyIt.prototype.add = function add(schema, definition) {\n  this.__schemas__[schema] = definition;\n  compile(this);\n  return this;\n};\n\n\n/** chainable\n * LinkifyIt#set(options)\n * - options (Object): { fuzzyLink|fuzzyEmail|fuzzyIP: true|false }\n *\n * Set recognition options for links without schema.\n **/\nLinkifyIt.prototype.set = function set(options) {\n  this.__opts__ = assign(this.__opts__, options);\n  return this;\n};\n\n\n/**\n * LinkifyIt#test(text) -> Boolean\n *\n * Searches linkifiable pattern and returns `true` on success or `false` on fail.\n **/\nLinkifyIt.prototype.test = function test(text) {\n  // Reset scan cache\n  this.__text_cache__ = text;\n  this.__index__      = -1;\n\n  if (!text.length) { return false; }\n\n  var m, ml, me, len, shift, next, re, tld_pos, at_pos;\n\n  // try to scan for link with schema - that's the most simple rule\n  if (this.re.schema_test.test(text)) {\n    re = this.re.schema_search;\n    re.lastIndex = 0;\n    while ((m = re.exec(text)) !== null) {\n      len = this.testSchemaAt(text, m[2], re.lastIndex);\n      if (len) {\n        this.__schema__     = m[2];\n        this.__index__      = m.index + m[1].length;\n        this.__last_index__ = m.index + m[0].length + len;\n        break;\n      }\n    }\n  }\n\n  if (this.__opts__.fuzzyLink && this.__compiled__['http:']) {\n    // guess schemaless links\n    tld_pos = text.search(this.re.host_fuzzy_test);\n    if (tld_pos >= 0) {\n      // if tld is located after found link - no need to check fuzzy pattern\n      if (this.__index__ < 0 || tld_pos < this.__index__) {\n        if ((ml = text.match(this.__opts__.fuzzyIP ? this.re.link_fuzzy : this.re.link_no_ip_fuzzy)) !== null) {\n\n          shift = ml.index + ml[1].length;\n\n          if (this.__index__ < 0 || shift < this.__index__) {\n            this.__schema__     = '';\n            this.__index__      = shift;\n            this.__last_index__ = ml.index + ml[0].length;\n          }\n        }\n      }\n    }\n  }\n\n  if (this.__opts__.fuzzyEmail && this.__compiled__['mailto:']) {\n    // guess schemaless emails\n    at_pos = text.indexOf('@');\n    if (at_pos >= 0) {\n      // We can't skip this check, because this cases are possible:\n      // 192.168.1.1@gmail.com, my.in@example.com\n      if ((me = text.match(this.re.email_fuzzy)) !== null) {\n\n        shift = me.index + me[1].length;\n        next  = me.index + me[0].length;\n\n        if (this.__index__ < 0 || shift < this.__index__ ||\n            (shift === this.__index__ && next > this.__last_index__)) {\n          this.__schema__     = 'mailto:';\n          this.__index__      = shift;\n          this.__last_index__ = next;\n        }\n      }\n    }\n  }\n\n  return this.__index__ >= 0;\n};\n\n\n/**\n * LinkifyIt#pretest(text) -> Boolean\n *\n * Very quick check, that can give false positives. Returns true if link MAY BE\n * can exists. Can be used for speed optimization, when you need to check that\n * link NOT exists.\n **/\nLinkifyIt.prototype.pretest = function pretest(text) {\n  return this.re.pretest.test(text);\n};\n\n\n/**\n * LinkifyIt#testSchemaAt(text, name, position) -> Number\n * - text (String): text to scan\n * - name (String): rule (schema) name\n * - position (Number): text offset to check from\n *\n * Similar to [[LinkifyIt#test]] but checks only specific protocol tail exactly\n * at given position. Returns length of found pattern (0 on fail).\n **/\nLinkifyIt.prototype.testSchemaAt = function testSchemaAt(text, schema, pos) {\n  // If not supported schema check requested - terminate\n  if (!this.__compiled__[schema.toLowerCase()]) {\n    return 0;\n  }\n  return this.__compiled__[schema.toLowerCase()].validate(text, pos, this);\n};\n\n\n/**\n * LinkifyIt#match(text) -> Array|null\n *\n * Returns array of found link descriptions or `null` on fail. We strongly\n * recommend to use [[LinkifyIt#test]] first, for best speed.\n *\n * ##### Result match description\n *\n * - __schema__ - link schema, can be empty for fuzzy links, or `//` for\n *   protocol-neutral  links.\n * - __index__ - offset of matched text\n * - __lastIndex__ - index of next char after mathch end\n * - __raw__ - matched text\n * - __text__ - normalized text\n * - __url__ - link, generated from matched text\n **/\nLinkifyIt.prototype.match = function match(text) {\n  var shift = 0, result = [];\n\n  // Try to take previous element from cache, if .test() called before\n  if (this.__index__ >= 0 && this.__text_cache__ === text) {\n    result.push(createMatch(this, shift));\n    shift = this.__last_index__;\n  }\n\n  // Cut head if cache was used\n  var tail = shift ? text.slice(shift) : text;\n\n  // Scan string until end reached\n  while (this.test(tail)) {\n    result.push(createMatch(this, shift));\n\n    tail = tail.slice(this.__last_index__);\n    shift += this.__last_index__;\n  }\n\n  if (result.length) {\n    return result;\n  }\n\n  return null;\n};\n\n\n/**\n * LinkifyIt#matchAtStart(text) -> Match|null\n *\n * Returns fully-formed (not fuzzy) link if it starts at the beginning\n * of the string, and null otherwise.\n **/\nLinkifyIt.prototype.matchAtStart = function matchAtStart(text) {\n  // Reset scan cache\n  this.__text_cache__ = text;\n  this.__index__      = -1;\n\n  if (!text.length) return null;\n\n  var m = this.re.schema_at_start.exec(text);\n  if (!m) return null;\n\n  var len = this.testSchemaAt(text, m[2], m[0].length);\n  if (!len) return null;\n\n  this.__schema__     = m[2];\n  this.__index__      = m.index + m[1].length;\n  this.__last_index__ = m.index + m[0].length + len;\n\n  return createMatch(this, 0);\n};\n\n\n/** chainable\n * LinkifyIt#tlds(list [, keepOld]) -> this\n * - list (Array): list of tlds\n * - keepOld (Boolean): merge with current list if `true` (`false` by default)\n *\n * Load (or merge) new tlds list. Those are user for fuzzy links (without prefix)\n * to avoid false positives. By default this algorythm used:\n *\n * - hostname with any 2-letter root zones are ok.\n * - biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|\n *   are ok.\n * - encoded (`xn--...`) root zones are ok.\n *\n * If list is replaced, then exact match for 2-chars root zones will be checked.\n **/\nLinkifyIt.prototype.tlds = function tlds(list, keepOld) {\n  list = Array.isArray(list) ? list : [ list ];\n\n  if (!keepOld) {\n    this.__tlds__ = list.slice();\n    this.__tlds_replaced__ = true;\n    compile(this);\n    return this;\n  }\n\n  this.__tlds__ = this.__tlds__.concat(list)\n                                  .sort()\n                                  .filter(function (el, idx, arr) {\n                                    return el !== arr[idx - 1];\n                                  })\n                                  .reverse();\n\n  compile(this);\n  return this;\n};\n\n/**\n * LinkifyIt#normalize(match)\n *\n * Default normalizer (if schema does not define it's own).\n **/\nLinkifyIt.prototype.normalize = function normalize(match) {\n\n  // Do minimal possible changes by default. Need to collect feedback prior\n  // to move forward https://github.com/markdown-it/linkify-it/issues/1\n\n  if (!match.schema) { match.url = 'http://' + match.url; }\n\n  if (match.schema === 'mailto:' && !/^mailto:/i.test(match.url)) {\n    match.url = 'mailto:' + match.url;\n  }\n};\n\n\n/**\n * LinkifyIt#onCompile()\n *\n * Override to modify basic RegExp-s.\n **/\nLinkifyIt.prototype.onCompile = function onCompile() {\n};\n\n\nmodule.exports = LinkifyIt;\n","'use strict';\n\n\nmodule.exports = function (opts) {\n  var re = {};\n  opts = opts || {};\n\n  // Use direct extract instead of `regenerate` to reduse browserified size\n  re.src_Any = require('uc.micro/properties/Any/regex').source;\n  re.src_Cc  = require('uc.micro/categories/Cc/regex').source;\n  re.src_Z   = require('uc.micro/categories/Z/regex').source;\n  re.src_P   = require('uc.micro/categories/P/regex').source;\n\n  // \\p{\\Z\\P\\Cc\\CF} (white spaces + control + format + punctuation)\n  re.src_ZPCc = [ re.src_Z, re.src_P, re.src_Cc ].join('|');\n\n  // \\p{\\Z\\Cc} (white spaces + control)\n  re.src_ZCc = [ re.src_Z, re.src_Cc ].join('|');\n\n  // Experimental. List of chars, completely prohibited in links\n  // because can separate it from other part of text\n  var text_separators = '[><\\uff5c]';\n\n  // All possible word characters (everything without punctuation, spaces & controls)\n  // Defined via punctuation & spaces to save space\n  // Should be something like \\p{\\L\\N\\S\\M} (\\w but without `_`)\n  re.src_pseudo_letter       = '(?:(?!' + text_separators + '|' + re.src_ZPCc + ')' + re.src_Any + ')';\n  // The same as abothe but without [0-9]\n  // var src_pseudo_letter_non_d = '(?:(?![0-9]|' + src_ZPCc + ')' + src_Any + ')';\n\n  ////////////////////////////////////////////////////////////////////////////////\n\n  re.src_ip4 =\n\n    '(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)';\n\n  // Prohibit any of \"@/[]()\" in user/pass to avoid wrong domain fetch.\n  re.src_auth    = '(?:(?:(?!' + re.src_ZCc + '|[@/\\\\[\\\\]()]).)+@)?';\n\n  re.src_port =\n\n    '(?::(?:6(?:[0-4]\\\\d{3}|5(?:[0-4]\\\\d{2}|5(?:[0-2]\\\\d|3[0-5])))|[1-5]?\\\\d{1,4}))?';\n\n  re.src_host_terminator =\n\n    '(?=$|' + text_separators + '|' + re.src_ZPCc + ')' +\n    '(?!' + (opts['---'] ? '-(?!--)|' : '-|') + '_|:\\\\d|\\\\.-|\\\\.(?!$|' + re.src_ZPCc + '))';\n\n  re.src_path =\n\n    '(?:' +\n      '[/?#]' +\n        '(?:' +\n          '(?!' + re.src_ZCc + '|' + text_separators + '|[()[\\\\]{}.,\"\\'?!\\\\-;]).|' +\n          '\\\\[(?:(?!' + re.src_ZCc + '|\\\\]).)*\\\\]|' +\n          '\\\\((?:(?!' + re.src_ZCc + '|[)]).)*\\\\)|' +\n          '\\\\{(?:(?!' + re.src_ZCc + '|[}]).)*\\\\}|' +\n          '\\\\\"(?:(?!' + re.src_ZCc + '|[\"]).)+\\\\\"|' +\n          \"\\\\'(?:(?!\" + re.src_ZCc + \"|[']).)+\\\\'|\" +\n          \"\\\\'(?=\" + re.src_pseudo_letter + '|[-])|' +  // allow `I'm_king` if no pair found\n          '\\\\.{2,}[a-zA-Z0-9%/&]|' + // google has many dots in \"google search\" links (#66, #81).\n                                     // github has ... in commit range links,\n                                     // Restrict to\n                                     // - english\n                                     // - percent-encoded\n                                     // - parts of file path\n                                     // - params separator\n                                     // until more examples found.\n          '\\\\.(?!' + re.src_ZCc + '|[.]|$)|' +\n          (opts['---'] ?\n            '\\\\-(?!--(?:[^-]|$))(?:-*)|' // `---` => long dash, terminate\n            :\n            '\\\\-+|'\n          ) +\n          ',(?!' + re.src_ZCc + '|$)|' +       // allow `,,,` in paths\n          ';(?!' + re.src_ZCc + '|$)|' +       // allow `;` if not followed by space-like char\n          '\\\\!+(?!' + re.src_ZCc + '|[!]|$)|' +  // allow `!!!` in paths, but not at the end\n          '\\\\?(?!' + re.src_ZCc + '|[?]|$)' +\n        ')+' +\n      '|\\\\/' +\n    ')?';\n\n  // Allow anything in markdown spec, forbid quote (\") at the first position\n  // because emails enclosed in quotes are far more common\n  re.src_email_name =\n\n    '[\\\\-;:&=\\\\+\\\\$,\\\\.a-zA-Z0-9_][\\\\-;:&=\\\\+\\\\$,\\\\\"\\\\.a-zA-Z0-9_]*';\n\n  re.src_xn =\n\n    'xn--[a-z0-9\\\\-]{1,59}';\n\n  // More to read about domain names\n  // http://serverfault.com/questions/638260/\n\n  re.src_domain_root =\n\n    // Allow letters & digits (http://test1)\n    '(?:' +\n      re.src_xn +\n      '|' +\n      re.src_pseudo_letter + '{1,63}' +\n    ')';\n\n  re.src_domain =\n\n    '(?:' +\n      re.src_xn +\n      '|' +\n      '(?:' + re.src_pseudo_letter + ')' +\n      '|' +\n      '(?:' + re.src_pseudo_letter + '(?:-|' + re.src_pseudo_letter + '){0,61}' + re.src_pseudo_letter + ')' +\n    ')';\n\n  re.src_host =\n\n    '(?:' +\n    // Don't need IP check, because digits are already allowed in normal domain names\n    //   src_ip4 +\n    // '|' +\n      '(?:(?:(?:' + re.src_domain + ')\\\\.)*' + re.src_domain/*_root*/ + ')' +\n    ')';\n\n  re.tpl_host_fuzzy =\n\n    '(?:' +\n      re.src_ip4 +\n    '|' +\n      '(?:(?:(?:' + re.src_domain + ')\\\\.)+(?:%TLDS%))' +\n    ')';\n\n  re.tpl_host_no_ip_fuzzy =\n\n    '(?:(?:(?:' + re.src_domain + ')\\\\.)+(?:%TLDS%))';\n\n  re.src_host_strict =\n\n    re.src_host + re.src_host_terminator;\n\n  re.tpl_host_fuzzy_strict =\n\n    re.tpl_host_fuzzy + re.src_host_terminator;\n\n  re.src_host_port_strict =\n\n    re.src_host + re.src_port + re.src_host_terminator;\n\n  re.tpl_host_port_fuzzy_strict =\n\n    re.tpl_host_fuzzy + re.src_port + re.src_host_terminator;\n\n  re.tpl_host_port_no_ip_fuzzy_strict =\n\n    re.tpl_host_no_ip_fuzzy + re.src_port + re.src_host_terminator;\n\n\n  ////////////////////////////////////////////////////////////////////////////////\n  // Main rules\n\n  // Rude test fuzzy links by host, for quick deny\n  re.tpl_host_fuzzy_test =\n\n    'localhost|www\\\\.|\\\\.\\\\d{1,3}\\\\.|(?:\\\\.(?:%TLDS%)(?:' + re.src_ZPCc + '|>|$))';\n\n  re.tpl_email_fuzzy =\n\n      '(^|' + text_separators + '|\"|\\\\(|' + re.src_ZCc + ')' +\n      '(' + re.src_email_name + '@' + re.tpl_host_fuzzy_strict + ')';\n\n  re.tpl_link_fuzzy =\n      // Fuzzy link can't be prepended with .:/\\- and non punctuation.\n      // but can start with > (markdown blockquote)\n      '(^|(?![.:/\\\\-_@])(?:[$+<=>^`|\\uff5c]|' + re.src_ZPCc + '))' +\n      '((?![$+<=>^`|\\uff5c])' + re.tpl_host_port_fuzzy_strict + re.src_path + ')';\n\n  re.tpl_link_no_ip_fuzzy =\n      // Fuzzy link can't be prepended with .:/\\- and non punctuation.\n      // but can start with > (markdown blockquote)\n      '(^|(?![.:/\\\\-_@])(?:[$+<=>^`|\\uff5c]|' + re.src_ZPCc + '))' +\n      '((?![$+<=>^`|\\uff5c])' + re.tpl_host_port_no_ip_fuzzy_strict + re.src_path + ')';\n\n  return re;\n};\n","'use strict';\n\n/** Highest positive signed 32-bit float value */\nconst maxInt = 2147483647; // aka. 0x7FFFFFFF or 2^31-1\n\n/** Bootstring parameters */\nconst base = 36;\nconst tMin = 1;\nconst tMax = 26;\nconst skew = 38;\nconst damp = 700;\nconst initialBias = 72;\nconst initialN = 128; // 0x80\nconst delimiter = '-'; // '\\x2D'\n\n/** Regular expressions */\nconst regexPunycode = /^xn--/;\nconst regexNonASCII = /[^\\0-\\x7F]/; // Note: U+007F DEL is excluded too.\nconst regexSeparators = /[\\x2E\\u3002\\uFF0E\\uFF61]/g; // RFC 3490 separators\n\n/** Error messages */\nconst errors = {\n\t'overflow': 'Overflow: input needs wider integers to process',\n\t'not-basic': 'Illegal input >= 0x80 (not a basic code point)',\n\t'invalid-input': 'Invalid input'\n};\n\n/** Convenience shortcuts */\nconst baseMinusTMin = base - tMin;\nconst floor = Math.floor;\nconst stringFromCharCode = String.fromCharCode;\n\n/*--------------------------------------------------------------------------*/\n\n/**\n * A generic error utility function.\n * @private\n * @param {String} type The error type.\n * @returns {Error} Throws a `RangeError` with the applicable error message.\n */\nfunction error(type) {\n\tthrow new RangeError(errors[type]);\n}\n\n/**\n * A generic `Array#map` utility function.\n * @private\n * @param {Array} array The array to iterate over.\n * @param {Function} callback The function that gets called for every array\n * item.\n * @returns {Array} A new array of values returned by the callback function.\n */\nfunction map(array, callback) {\n\tconst result = [];\n\tlet length = array.length;\n\twhile (length--) {\n\t\tresult[length] = callback(array[length]);\n\t}\n\treturn result;\n}\n\n/**\n * A simple `Array#map`-like wrapper to work with domain name strings or email\n * addresses.\n * @private\n * @param {String} domain The domain name or email address.\n * @param {Function} callback The function that gets called for every\n * character.\n * @returns {String} A new string of characters returned by the callback\n * function.\n */\nfunction mapDomain(domain, callback) {\n\tconst parts = domain.split('@');\n\tlet result = '';\n\tif (parts.length > 1) {\n\t\t// In email addresses, only the domain name should be punycoded. Leave\n\t\t// the local part (i.e. everything up to `@`) intact.\n\t\tresult = parts[0] + '@';\n\t\tdomain = parts[1];\n\t}\n\t// Avoid `split(regex)` for IE8 compatibility. See #17.\n\tdomain = domain.replace(regexSeparators, '\\x2E');\n\tconst labels = domain.split('.');\n\tconst encoded = map(labels, callback).join('.');\n\treturn result + encoded;\n}\n\n/**\n * Creates an array containing the numeric code points of each Unicode\n * character in the string. While JavaScript uses UCS-2 internally,\n * this function will convert a pair of surrogate halves (each of which\n * UCS-2 exposes as separate characters) into a single code point,\n * matching UTF-16.\n * @see `punycode.ucs2.encode`\n * @see <https://mathiasbynens.be/notes/javascript-encoding>\n * @memberOf punycode.ucs2\n * @name decode\n * @param {String} string The Unicode input string (UCS-2).\n * @returns {Array} The new array of code points.\n */\nfunction ucs2decode(string) {\n\tconst output = [];\n\tlet counter = 0;\n\tconst length = string.length;\n\twhile (counter < length) {\n\t\tconst value = string.charCodeAt(counter++);\n\t\tif (value >= 0xD800 && value <= 0xDBFF && counter < length) {\n\t\t\t// It's a high surrogate, and there is a next character.\n\t\t\tconst extra = string.charCodeAt(counter++);\n\t\t\tif ((extra & 0xFC00) == 0xDC00) { // Low surrogate.\n\t\t\t\toutput.push(((value & 0x3FF) << 10) + (extra & 0x3FF) + 0x10000);\n\t\t\t} else {\n\t\t\t\t// It's an unmatched surrogate; only append this code unit, in case the\n\t\t\t\t// next code unit is the high surrogate of a surrogate pair.\n\t\t\t\toutput.push(value);\n\t\t\t\tcounter--;\n\t\t\t}\n\t\t} else {\n\t\t\toutput.push(value);\n\t\t}\n\t}\n\treturn output;\n}\n\n/**\n * Creates a string based on an array of numeric code points.\n * @see `punycode.ucs2.decode`\n * @memberOf punycode.ucs2\n * @name encode\n * @param {Array} codePoints The array of numeric code points.\n * @returns {String} The new Unicode string (UCS-2).\n */\nconst ucs2encode = codePoints => String.fromCodePoint(...codePoints);\n\n/**\n * Converts a basic code point into a digit/integer.\n * @see `digitToBasic()`\n * @private\n * @param {Number} codePoint The basic numeric code point value.\n * @returns {Number} The numeric value of a basic code point (for use in\n * representing integers) in the range `0` to `base - 1`, or `base` if\n * the code point does not represent a value.\n */\nconst basicToDigit = function(codePoint) {\n\tif (codePoint >= 0x30 && codePoint < 0x3A) {\n\t\treturn 26 + (codePoint - 0x30);\n\t}\n\tif (codePoint >= 0x41 && codePoint < 0x5B) {\n\t\treturn codePoint - 0x41;\n\t}\n\tif (codePoint >= 0x61 && codePoint < 0x7B) {\n\t\treturn codePoint - 0x61;\n\t}\n\treturn base;\n};\n\n/**\n * Converts a digit/integer into a basic code point.\n * @see `basicToDigit()`\n * @private\n * @param {Number} digit The numeric value of a basic code point.\n * @returns {Number} The basic code point whose value (when used for\n * representing integers) is `digit`, which needs to be in the range\n * `0` to `base - 1`. If `flag` is non-zero, the uppercase form is\n * used; else, the lowercase form is used. The behavior is undefined\n * if `flag` is non-zero and `digit` has no uppercase form.\n */\nconst digitToBasic = function(digit, flag) {\n\t//  0..25 map to ASCII a..z or A..Z\n\t// 26..35 map to ASCII 0..9\n\treturn digit + 22 + 75 * (digit < 26) - ((flag != 0) << 5);\n};\n\n/**\n * Bias adaptation function as per section 3.4 of RFC 3492.\n * https://tools.ietf.org/html/rfc3492#section-3.4\n * @private\n */\nconst adapt = function(delta, numPoints, firstTime) {\n\tlet k = 0;\n\tdelta = firstTime ? floor(delta / damp) : delta >> 1;\n\tdelta += floor(delta / numPoints);\n\tfor (/* no initialization */; delta > baseMinusTMin * tMax >> 1; k += base) {\n\t\tdelta = floor(delta / baseMinusTMin);\n\t}\n\treturn floor(k + (baseMinusTMin + 1) * delta / (delta + skew));\n};\n\n/**\n * Converts a Punycode string of ASCII-only symbols to a string of Unicode\n * symbols.\n * @memberOf punycode\n * @param {String} input The Punycode string of ASCII-only symbols.\n * @returns {String} The resulting string of Unicode symbols.\n */\nconst decode = function(input) {\n\t// Don't use UCS-2.\n\tconst output = [];\n\tconst inputLength = input.length;\n\tlet i = 0;\n\tlet n = initialN;\n\tlet bias = initialBias;\n\n\t// Handle the basic code points: let `basic` be the number of input code\n\t// points before the last delimiter, or `0` if there is none, then copy\n\t// the first basic code points to the output.\n\n\tlet basic = input.lastIndexOf(delimiter);\n\tif (basic < 0) {\n\t\tbasic = 0;\n\t}\n\n\tfor (let j = 0; j < basic; ++j) {\n\t\t// if it's not a basic code point\n\t\tif (input.charCodeAt(j) >= 0x80) {\n\t\t\terror('not-basic');\n\t\t}\n\t\toutput.push(input.charCodeAt(j));\n\t}\n\n\t// Main decoding loop: start just after the last delimiter if any basic code\n\t// points were copied; start at the beginning otherwise.\n\n\tfor (let index = basic > 0 ? basic + 1 : 0; index < inputLength; /* no final expression */) {\n\n\t\t// `index` is the index of the next character to be consumed.\n\t\t// Decode a generalized variable-length integer into `delta`,\n\t\t// which gets added to `i`. The overflow checking is easier\n\t\t// if we increase `i` as we go, then subtract off its starting\n\t\t// value at the end to obtain `delta`.\n\t\tconst oldi = i;\n\t\tfor (let w = 1, k = base; /* no condition */; k += base) {\n\n\t\t\tif (index >= inputLength) {\n\t\t\t\terror('invalid-input');\n\t\t\t}\n\n\t\t\tconst digit = basicToDigit(input.charCodeAt(index++));\n\n\t\t\tif (digit >= base) {\n\t\t\t\terror('invalid-input');\n\t\t\t}\n\t\t\tif (digit > floor((maxInt - i) / w)) {\n\t\t\t\terror('overflow');\n\t\t\t}\n\n\t\t\ti += digit * w;\n\t\t\tconst t = k <= bias ? tMin : (k >= bias + tMax ? tMax : k - bias);\n\n\t\t\tif (digit < t) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst baseMinusT = base - t;\n\t\t\tif (w > floor(maxInt / baseMinusT)) {\n\t\t\t\terror('overflow');\n\t\t\t}\n\n\t\t\tw *= baseMinusT;\n\n\t\t}\n\n\t\tconst out = output.length + 1;\n\t\tbias = adapt(i - oldi, out, oldi == 0);\n\n\t\t// `i` was supposed to wrap around from `out` to `0`,\n\t\t// incrementing `n` each time, so we'll fix that now:\n\t\tif (floor(i / out) > maxInt - n) {\n\t\t\terror('overflow');\n\t\t}\n\n\t\tn += floor(i / out);\n\t\ti %= out;\n\n\t\t// Insert `n` at position `i` of the output.\n\t\toutput.splice(i++, 0, n);\n\n\t}\n\n\treturn String.fromCodePoint(...output);\n};\n\n/**\n * Converts a string of Unicode symbols (e.g. a domain name label) to a\n * Punycode string of ASCII-only symbols.\n * @memberOf punycode\n * @param {String} input The string of Unicode symbols.\n * @returns {String} The resulting Punycode string of ASCII-only symbols.\n */\nconst encode = function(input) {\n\tconst output = [];\n\n\t// Convert the input in UCS-2 to an array of Unicode code points.\n\tinput = ucs2decode(input);\n\n\t// Cache the length.\n\tconst inputLength = input.length;\n\n\t// Initialize the state.\n\tlet n = initialN;\n\tlet delta = 0;\n\tlet bias = initialBias;\n\n\t// Handle the basic code points.\n\tfor (const currentValue of input) {\n\t\tif (currentValue < 0x80) {\n\t\t\toutput.push(stringFromCharCode(currentValue));\n\t\t}\n\t}\n\n\tconst basicLength = output.length;\n\tlet handledCPCount = basicLength;\n\n\t// `handledCPCount` is the number of code points that have been handled;\n\t// `basicLength` is the number of basic code points.\n\n\t// Finish the basic string with a delimiter unless it's empty.\n\tif (basicLength) {\n\t\toutput.push(delimiter);\n\t}\n\n\t// Main encoding loop:\n\twhile (handledCPCount < inputLength) {\n\n\t\t// All non-basic code points < n have been handled already. Find the next\n\t\t// larger one:\n\t\tlet m = maxInt;\n\t\tfor (const currentValue of input) {\n\t\t\tif (currentValue >= n && currentValue < m) {\n\t\t\t\tm = currentValue;\n\t\t\t}\n\t\t}\n\n\t\t// Increase `delta` enough to advance the decoder's <n,i> state to <m,0>,\n\t\t// but guard against overflow.\n\t\tconst handledCPCountPlusOne = handledCPCount + 1;\n\t\tif (m - n > floor((maxInt - delta) / handledCPCountPlusOne)) {\n\t\t\terror('overflow');\n\t\t}\n\n\t\tdelta += (m - n) * handledCPCountPlusOne;\n\t\tn = m;\n\n\t\tfor (const currentValue of input) {\n\t\t\tif (currentValue < n && ++delta > maxInt) {\n\t\t\t\terror('overflow');\n\t\t\t}\n\t\t\tif (currentValue === n) {\n\t\t\t\t// Represent delta as a generalized variable-length integer.\n\t\t\t\tlet q = delta;\n\t\t\t\tfor (let k = base; /* no condition */; k += base) {\n\t\t\t\t\tconst t = k <= bias ? tMin : (k >= bias + tMax ? tMax : k - bias);\n\t\t\t\t\tif (q < t) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tconst qMinusT = q - t;\n\t\t\t\t\tconst baseMinusT = base - t;\n\t\t\t\t\toutput.push(\n\t\t\t\t\t\tstringFromCharCode(digitToBasic(t + qMinusT % baseMinusT, 0))\n\t\t\t\t\t);\n\t\t\t\t\tq = floor(qMinusT / baseMinusT);\n\t\t\t\t}\n\n\t\t\t\toutput.push(stringFromCharCode(digitToBasic(q, 0)));\n\t\t\t\tbias = adapt(delta, handledCPCountPlusOne, handledCPCount === basicLength);\n\t\t\t\tdelta = 0;\n\t\t\t\t++handledCPCount;\n\t\t\t}\n\t\t}\n\n\t\t++delta;\n\t\t++n;\n\n\t}\n\treturn output.join('');\n};\n\n/**\n * Converts a Punycode string representing a domain name or an email address\n * to Unicode. Only the Punycoded parts of the input will be converted, i.e.\n * it doesn't matter if you call it on a string that has already been\n * converted to Unicode.\n * @memberOf punycode\n * @param {String} input The Punycoded domain name or email address to\n * convert to Unicode.\n * @returns {String} The Unicode representation of the given Punycode\n * string.\n */\nconst toUnicode = function(input) {\n\treturn mapDomain(input, function(string) {\n\t\treturn regexPunycode.test(string)\n\t\t\t? decode(string.slice(4).toLowerCase())\n\t\t\t: string;\n\t});\n};\n\n/**\n * Converts a Unicode string representing a domain name or an email address to\n * Punycode. Only the non-ASCII parts of the domain name will be converted,\n * i.e. it doesn't matter if you call it with a domain that's already in\n * ASCII.\n * @memberOf punycode\n * @param {String} input The domain name or email address to convert, as a\n * Unicode string.\n * @returns {String} The Punycode representation of the given domain name or\n * email address.\n */\nconst toASCII = function(input) {\n\treturn mapDomain(input, function(string) {\n\t\treturn regexNonASCII.test(string)\n\t\t\t? 'xn--' + encode(string)\n\t\t\t: string;\n\t});\n};\n\n/*--------------------------------------------------------------------------*/\n\n/** Define the public API */\nconst punycode = {\n\t/**\n\t * A string representing the current Punycode.js version number.\n\t * @memberOf punycode\n\t * @type String\n\t */\n\t'version': '2.1.0',\n\t/**\n\t * An object of methods to convert from JavaScript's internal character\n\t * representation (UCS-2) to Unicode code points, and back.\n\t * @see <https://mathiasbynens.be/notes/javascript-encoding>\n\t * @memberOf punycode\n\t * @type Object\n\t */\n\t'ucs2': {\n\t\t'decode': ucs2decode,\n\t\t'encode': ucs2encode\n\t},\n\t'decode': decode,\n\t'encode': encode,\n\t'toASCII': toASCII,\n\t'toUnicode': toUnicode\n};\n\nexport { ucs2decode, ucs2encode, decode, encode, toASCII, toUnicode };\nexport default punycode;\n","// markdown-it default options\n\n'use strict';\n\n\nmodule.exports = {\n  options: {\n    html:         false,        // Enable HTML tags in source\n    xhtmlOut:     false,        // Use '/' to close single tags (<br />)\n    breaks:       false,        // Convert '\\n' in paragraphs into <br>\n    langPrefix:   'language-',  // CSS language prefix for fenced blocks\n    linkify:      false,        // autoconvert URL-like texts to links\n\n    // Enable some language-neutral replacements + quotes beautification\n    typographer:  false,\n\n    // Double + single quotes replacement pairs, when typographer enabled,\n    // and smartquotes on. Could be either a String or an Array.\n    //\n    // For example, you can use '' for Russian, '' for German,\n    // and ['\\xA0', '\\xA0', '\\xA0', '\\xA0'] for French (including nbsp).\n    quotes: '\\u201c\\u201d\\u2018\\u2019', /*  */\n\n    // Highlighter function. Should return escaped HTML,\n    // or '' if the source string is not changed and should be escaped externaly.\n    // If result starts with <pre... internal wrapper is skipped.\n    //\n    // function (/*str, lang*/) { return ''; }\n    //\n    highlight: null,\n\n    maxNesting:   100            // Internal protection, recursion limit\n  },\n\n  components: {\n\n    core: {},\n    block: {},\n    inline: {}\n  }\n};\n","// Main parser class\n\n'use strict';\n\n\nvar utils        = require('./common/utils');\nvar helpers      = require('./helpers');\nvar Renderer     = require('./renderer');\nvar ParserCore   = require('./parser_core');\nvar ParserBlock  = require('./parser_block');\nvar ParserInline = require('./parser_inline');\nvar LinkifyIt    = require('linkify-it');\nvar mdurl        = require('mdurl');\nvar punycode     = require('punycode');\n\n\nvar config = {\n  default: require('./presets/default'),\n  zero: require('./presets/zero'),\n  commonmark: require('./presets/commonmark')\n};\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// This validator can prohibit more than really needed to prevent XSS. It's a\n// tradeoff to keep code simple and to be secure by default.\n//\n// If you need different setup - override validator method as you wish. Or\n// replace it with dummy function and use external sanitizer.\n//\n\nvar BAD_PROTO_RE = /^(vbscript|javascript|file|data):/;\nvar GOOD_DATA_RE = /^data:image\\/(gif|png|jpeg|webp);/;\n\nfunction validateLink(url) {\n  // url should be normalized at this point, and existing entities are decoded\n  var str = url.trim().toLowerCase();\n\n  return BAD_PROTO_RE.test(str) ? (GOOD_DATA_RE.test(str) ? true : false) : true;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\n\nvar RECODE_HOSTNAME_FOR = [ 'http:', 'https:', 'mailto:' ];\n\nfunction normalizeLink(url) {\n  var parsed = mdurl.parse(url, true);\n\n  if (parsed.hostname) {\n    // Encode hostnames in urls like:\n    // `http://host/`, `https://host/`, `mailto:user@host`, `//host/`\n    //\n    // We don't encode unknown schemas, because it's likely that we encode\n    // something we shouldn't (e.g. `skype:name` treated as `skype:host`)\n    //\n    if (!parsed.protocol || RECODE_HOSTNAME_FOR.indexOf(parsed.protocol) >= 0) {\n      try {\n        parsed.hostname = punycode.toASCII(parsed.hostname);\n      } catch (er) { /**/ }\n    }\n  }\n\n  return mdurl.encode(mdurl.format(parsed));\n}\n\nfunction normalizeLinkText(url) {\n  var parsed = mdurl.parse(url, true);\n\n  if (parsed.hostname) {\n    // Encode hostnames in urls like:\n    // `http://host/`, `https://host/`, `mailto:user@host`, `//host/`\n    //\n    // We don't encode unknown schemas, because it's likely that we encode\n    // something we shouldn't (e.g. `skype:name` treated as `skype:host`)\n    //\n    if (!parsed.protocol || RECODE_HOSTNAME_FOR.indexOf(parsed.protocol) >= 0) {\n      try {\n        parsed.hostname = punycode.toUnicode(parsed.hostname);\n      } catch (er) { /**/ }\n    }\n  }\n\n  // add '%' to exclude list because of https://github.com/markdown-it/markdown-it/issues/720\n  return mdurl.decode(mdurl.format(parsed), mdurl.decode.defaultChars + '%');\n}\n\n\n/**\n * class MarkdownIt\n *\n * Main parser/renderer class.\n *\n * ##### Usage\n *\n * ```javascript\n * // node.js, \"classic\" way:\n * var MarkdownIt = require('markdown-it'),\n *     md = new MarkdownIt();\n * var result = md.render('# markdown-it rulezz!');\n *\n * // node.js, the same, but with sugar:\n * var md = require('markdown-it')();\n * var result = md.render('# markdown-it rulezz!');\n *\n * // browser without AMD, added to \"window\" on script load\n * // Note, there are no dash.\n * var md = window.markdownit();\n * var result = md.render('# markdown-it rulezz!');\n * ```\n *\n * Single line rendering, without paragraph wrap:\n *\n * ```javascript\n * var md = require('markdown-it')();\n * var result = md.renderInline('__markdown-it__ rulezz!');\n * ```\n **/\n\n/**\n * new MarkdownIt([presetName, options])\n * - presetName (String): optional, `commonmark` / `zero`\n * - options (Object)\n *\n * Creates parser instanse with given config. Can be called without `new`.\n *\n * ##### presetName\n *\n * MarkdownIt provides named presets as a convenience to quickly\n * enable/disable active syntax rules and options for common use cases.\n *\n * - [\"commonmark\"](https://github.com/markdown-it/markdown-it/blob/master/lib/presets/commonmark.js) -\n *   configures parser to strict [CommonMark](http://commonmark.org/) mode.\n * - [default](https://github.com/markdown-it/markdown-it/blob/master/lib/presets/default.js) -\n *   similar to GFM, used when no preset name given. Enables all available rules,\n *   but still without html, typographer & autolinker.\n * - [\"zero\"](https://github.com/markdown-it/markdown-it/blob/master/lib/presets/zero.js) -\n *   all rules disabled. Useful to quickly setup your config via `.enable()`.\n *   For example, when you need only `bold` and `italic` markup and nothing else.\n *\n * ##### options:\n *\n * - __html__ - `false`. Set `true` to enable HTML tags in source. Be careful!\n *   That's not safe! You may need external sanitizer to protect output from XSS.\n *   It's better to extend features via plugins, instead of enabling HTML.\n * - __xhtmlOut__ - `false`. Set `true` to add '/' when closing single tags\n *   (`<br />`). This is needed only for full CommonMark compatibility. In real\n *   world you will need HTML output.\n * - __breaks__ - `false`. Set `true` to convert `\\n` in paragraphs into `<br>`.\n * - __langPrefix__ - `language-`. CSS language class prefix for fenced blocks.\n *   Can be useful for external highlighters.\n * - __linkify__ - `false`. Set `true` to autoconvert URL-like text to links.\n * - __typographer__  - `false`. Set `true` to enable [some language-neutral\n *   replacement](https://github.com/markdown-it/markdown-it/blob/master/lib/rules_core/replacements.js) +\n *   quotes beautification (smartquotes).\n * - __quotes__ - ``, String or Array. Double + single quotes replacement\n *   pairs, when typographer enabled and smartquotes on. For example, you can\n *   use `''` for Russian, `''` for German, and\n *   `['\\xA0', '\\xA0', '\\xA0', '\\xA0']` for French (including nbsp).\n * - __highlight__ - `null`. Highlighter function for fenced code blocks.\n *   Highlighter `function (str, lang)` should return escaped HTML. It can also\n *   return empty string if the source was not changed and should be escaped\n *   externaly. If result starts with <pre... internal wrapper is skipped.\n *\n * ##### Example\n *\n * ```javascript\n * // commonmark mode\n * var md = require('markdown-it')('commonmark');\n *\n * // default mode\n * var md = require('markdown-it')();\n *\n * // enable everything\n * var md = require('markdown-it')({\n *   html: true,\n *   linkify: true,\n *   typographer: true\n * });\n * ```\n *\n * ##### Syntax highlighting\n *\n * ```js\n * var hljs = require('highlight.js') // https://highlightjs.org/\n *\n * var md = require('markdown-it')({\n *   highlight: function (str, lang) {\n *     if (lang && hljs.getLanguage(lang)) {\n *       try {\n *         return hljs.highlight(str, { language: lang, ignoreIllegals: true }).value;\n *       } catch (__) {}\n *     }\n *\n *     return ''; // use external default escaping\n *   }\n * });\n * ```\n *\n * Or with full wrapper override (if you need assign class to `<pre>`):\n *\n * ```javascript\n * var hljs = require('highlight.js') // https://highlightjs.org/\n *\n * // Actual default values\n * var md = require('markdown-it')({\n *   highlight: function (str, lang) {\n *     if (lang && hljs.getLanguage(lang)) {\n *       try {\n *         return '<pre class=\"hljs\"><code>' +\n *                hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +\n *                '</code></pre>';\n *       } catch (__) {}\n *     }\n *\n *     return '<pre class=\"hljs\"><code>' + md.utils.escapeHtml(str) + '</code></pre>';\n *   }\n * });\n * ```\n *\n **/\nfunction MarkdownIt(presetName, options) {\n  if (!(this instanceof MarkdownIt)) {\n    return new MarkdownIt(presetName, options);\n  }\n\n  if (!options) {\n    if (!utils.isString(presetName)) {\n      options = presetName || {};\n      presetName = 'default';\n    }\n  }\n\n  /**\n   * MarkdownIt#inline -> ParserInline\n   *\n   * Instance of [[ParserInline]]. You may need it to add new rules when\n   * writing plugins. For simple rules control use [[MarkdownIt.disable]] and\n   * [[MarkdownIt.enable]].\n   **/\n  this.inline = new ParserInline();\n\n  /**\n   * MarkdownIt#block -> ParserBlock\n   *\n   * Instance of [[ParserBlock]]. You may need it to add new rules when\n   * writing plugins. For simple rules control use [[MarkdownIt.disable]] and\n   * [[MarkdownIt.enable]].\n   **/\n  this.block = new ParserBlock();\n\n  /**\n   * MarkdownIt#core -> Core\n   *\n   * Instance of [[Core]] chain executor. You may need it to add new rules when\n   * writing plugins. For simple rules control use [[MarkdownIt.disable]] and\n   * [[MarkdownIt.enable]].\n   **/\n  this.core = new ParserCore();\n\n  /**\n   * MarkdownIt#renderer -> Renderer\n   *\n   * Instance of [[Renderer]]. Use it to modify output look. Or to add rendering\n   * rules for new token types, generated by plugins.\n   *\n   * ##### Example\n   *\n   * ```javascript\n   * var md = require('markdown-it')();\n   *\n   * function myToken(tokens, idx, options, env, self) {\n   *   //...\n   *   return result;\n   * };\n   *\n   * md.renderer.rules['my_token'] = myToken\n   * ```\n   *\n   * See [[Renderer]] docs and [source code](https://github.com/markdown-it/markdown-it/blob/master/lib/renderer.js).\n   **/\n  this.renderer = new Renderer();\n\n  /**\n   * MarkdownIt#linkify -> LinkifyIt\n   *\n   * [linkify-it](https://github.com/markdown-it/linkify-it) instance.\n   * Used by [linkify](https://github.com/markdown-it/markdown-it/blob/master/lib/rules_core/linkify.js)\n   * rule.\n   **/\n  this.linkify = new LinkifyIt();\n\n  /**\n   * MarkdownIt#validateLink(url) -> Boolean\n   *\n   * Link validation function. CommonMark allows too much in links. By default\n   * we disable `javascript:`, `vbscript:`, `file:` schemas, and almost all `data:...` schemas\n   * except some embedded image types.\n   *\n   * You can change this behaviour:\n   *\n   * ```javascript\n   * var md = require('markdown-it')();\n   * // enable everything\n   * md.validateLink = function () { return true; }\n   * ```\n   **/\n  this.validateLink = validateLink;\n\n  /**\n   * MarkdownIt#normalizeLink(url) -> String\n   *\n   * Function used to encode link url to a machine-readable format,\n   * which includes url-encoding, punycode, etc.\n   **/\n  this.normalizeLink = normalizeLink;\n\n  /**\n   * MarkdownIt#normalizeLinkText(url) -> String\n   *\n   * Function used to decode link url to a human-readable format`\n   **/\n  this.normalizeLinkText = normalizeLinkText;\n\n\n  // Expose utils & helpers for easy acces from plugins\n\n  /**\n   * MarkdownIt#utils -> utils\n   *\n   * Assorted utility functions, useful to write plugins. See details\n   * [here](https://github.com/markdown-it/markdown-it/blob/master/lib/common/utils.js).\n   **/\n  this.utils = utils;\n\n  /**\n   * MarkdownIt#helpers -> helpers\n   *\n   * Link components parser functions, useful to write plugins. See details\n   * [here](https://github.com/markdown-it/markdown-it/blob/master/lib/helpers).\n   **/\n  this.helpers = utils.assign({}, helpers);\n\n\n  this.options = {};\n  this.configure(presetName);\n\n  if (options) { this.set(options); }\n}\n\n\n/** chainable\n * MarkdownIt.set(options)\n *\n * Set parser options (in the same format as in constructor). Probably, you\n * will never need it, but you can change options after constructor call.\n *\n * ##### Example\n *\n * ```javascript\n * var md = require('markdown-it')()\n *             .set({ html: true, breaks: true })\n *             .set({ typographer, true });\n * ```\n *\n * __Note:__ To achieve the best possible performance, don't modify a\n * `markdown-it` instance options on the fly. If you need multiple configurations\n * it's best to create multiple instances and initialize each with separate\n * config.\n **/\nMarkdownIt.prototype.set = function (options) {\n  utils.assign(this.options, options);\n  return this;\n};\n\n\n/** chainable, internal\n * MarkdownIt.configure(presets)\n *\n * Batch load of all options and compenent settings. This is internal method,\n * and you probably will not need it. But if you will - see available presets\n * and data structure [here](https://github.com/markdown-it/markdown-it/tree/master/lib/presets)\n *\n * We strongly recommend to use presets instead of direct config loads. That\n * will give better compatibility with next versions.\n **/\nMarkdownIt.prototype.configure = function (presets) {\n  var self = this, presetName;\n\n  if (utils.isString(presets)) {\n    presetName = presets;\n    presets = config[presetName];\n    if (!presets) { throw new Error('Wrong `markdown-it` preset \"' + presetName + '\", check name'); }\n  }\n\n  if (!presets) { throw new Error('Wrong `markdown-it` preset, can\\'t be empty'); }\n\n  if (presets.options) { self.set(presets.options); }\n\n  if (presets.components) {\n    Object.keys(presets.components).forEach(function (name) {\n      if (presets.components[name].rules) {\n        self[name].ruler.enableOnly(presets.components[name].rules);\n      }\n      if (presets.components[name].rules2) {\n        self[name].ruler2.enableOnly(presets.components[name].rules2);\n      }\n    });\n  }\n  return this;\n};\n\n\n/** chainable\n * MarkdownIt.enable(list, ignoreInvalid)\n * - list (String|Array): rule name or list of rule names to enable\n * - ignoreInvalid (Boolean): set `true` to ignore errors when rule not found.\n *\n * Enable list or rules. It will automatically find appropriate components,\n * containing rules with given names. If rule not found, and `ignoreInvalid`\n * not set - throws exception.\n *\n * ##### Example\n *\n * ```javascript\n * var md = require('markdown-it')()\n *             .enable(['sub', 'sup'])\n *             .disable('smartquotes');\n * ```\n **/\nMarkdownIt.prototype.enable = function (list, ignoreInvalid) {\n  var result = [];\n\n  if (!Array.isArray(list)) { list = [ list ]; }\n\n  [ 'core', 'block', 'inline' ].forEach(function (chain) {\n    result = result.concat(this[chain].ruler.enable(list, true));\n  }, this);\n\n  result = result.concat(this.inline.ruler2.enable(list, true));\n\n  var missed = list.filter(function (name) { return result.indexOf(name) < 0; });\n\n  if (missed.length && !ignoreInvalid) {\n    throw new Error('MarkdownIt. Failed to enable unknown rule(s): ' + missed);\n  }\n\n  return this;\n};\n\n\n/** chainable\n * MarkdownIt.disable(list, ignoreInvalid)\n * - list (String|Array): rule name or list of rule names to disable.\n * - ignoreInvalid (Boolean): set `true` to ignore errors when rule not found.\n *\n * The same as [[MarkdownIt.enable]], but turn specified rules off.\n **/\nMarkdownIt.prototype.disable = function (list, ignoreInvalid) {\n  var result = [];\n\n  if (!Array.isArray(list)) { list = [ list ]; }\n\n  [ 'core', 'block', 'inline' ].forEach(function (chain) {\n    result = result.concat(this[chain].ruler.disable(list, true));\n  }, this);\n\n  result = result.concat(this.inline.ruler2.disable(list, true));\n\n  var missed = list.filter(function (name) { return result.indexOf(name) < 0; });\n\n  if (missed.length && !ignoreInvalid) {\n    throw new Error('MarkdownIt. Failed to disable unknown rule(s): ' + missed);\n  }\n  return this;\n};\n\n\n/** chainable\n * MarkdownIt.use(plugin, params)\n *\n * Load specified plugin with given params into current parser instance.\n * It's just a sugar to call `plugin(md, params)` with curring.\n *\n * ##### Example\n *\n * ```javascript\n * var iterator = require('markdown-it-for-inline');\n * var md = require('markdown-it')()\n *             .use(iterator, 'foo_replace', 'text', function (tokens, idx) {\n *               tokens[idx].content = tokens[idx].content.replace(/foo/g, 'bar');\n *             });\n * ```\n **/\nMarkdownIt.prototype.use = function (plugin /*, params, ... */) {\n  var args = [ this ].concat(Array.prototype.slice.call(arguments, 1));\n  plugin.apply(plugin, args);\n  return this;\n};\n\n\n/** internal\n * MarkdownIt.parse(src, env) -> Array\n * - src (String): source string\n * - env (Object): environment sandbox\n *\n * Parse input string and return list of block tokens (special token type\n * \"inline\" will contain list of inline tokens). You should not call this\n * method directly, until you write custom renderer (for example, to produce\n * AST).\n *\n * `env` is used to pass data between \"distributed\" rules and return additional\n * metadata like reference info, needed for the renderer. It also can be used to\n * inject data in specific cases. Usually, you will be ok to pass `{}`,\n * and then pass updated object to renderer.\n **/\nMarkdownIt.prototype.parse = function (src, env) {\n  if (typeof src !== 'string') {\n    throw new Error('Input data should be a String');\n  }\n\n  var state = new this.core.State(src, this, env);\n\n  this.core.process(state);\n\n  return state.tokens;\n};\n\n\n/**\n * MarkdownIt.render(src [, env]) -> String\n * - src (String): source string\n * - env (Object): environment sandbox\n *\n * Render markdown string into html. It does all magic for you :).\n *\n * `env` can be used to inject additional metadata (`{}` by default).\n * But you will not need it with high probability. See also comment\n * in [[MarkdownIt.parse]].\n **/\nMarkdownIt.prototype.render = function (src, env) {\n  env = env || {};\n\n  return this.renderer.render(this.parse(src, env), this.options, env);\n};\n\n\n/** internal\n * MarkdownIt.parseInline(src, env) -> Array\n * - src (String): source string\n * - env (Object): environment sandbox\n *\n * The same as [[MarkdownIt.parse]] but skip all block rules. It returns the\n * block tokens list with the single `inline` element, containing parsed inline\n * tokens in `children` property. Also updates `env` object.\n **/\nMarkdownIt.prototype.parseInline = function (src, env) {\n  var state = new this.core.State(src, this, env);\n\n  state.inlineMode = true;\n  this.core.process(state);\n\n  return state.tokens;\n};\n\n\n/**\n * MarkdownIt.renderInline(src [, env]) -> String\n * - src (String): source string\n * - env (Object): environment sandbox\n *\n * Similar to [[MarkdownIt.render]] but for single paragraph content. Result\n * will NOT be wrapped into `<p>` tags.\n **/\nMarkdownIt.prototype.renderInline = function (src, env) {\n  env = env || {};\n\n  return this.renderer.render(this.parseInline(src, env), this.options, env);\n};\n\n\nmodule.exports = MarkdownIt;\n","// \"Zero\" preset, with nothing enabled. Useful for manual configuring of simple\n// modes. For example, to parse bold/italic only.\n\n'use strict';\n\n\nmodule.exports = {\n  options: {\n    html:         false,        // Enable HTML tags in source\n    xhtmlOut:     false,        // Use '/' to close single tags (<br />)\n    breaks:       false,        // Convert '\\n' in paragraphs into <br>\n    langPrefix:   'language-',  // CSS language prefix for fenced blocks\n    linkify:      false,        // autoconvert URL-like texts to links\n\n    // Enable some language-neutral replacements + quotes beautification\n    typographer:  false,\n\n    // Double + single quotes replacement pairs, when typographer enabled,\n    // and smartquotes on. Could be either a String or an Array.\n    //\n    // For example, you can use '' for Russian, '' for German,\n    // and ['\\xA0', '\\xA0', '\\xA0', '\\xA0'] for French (including nbsp).\n    quotes: '\\u201c\\u201d\\u2018\\u2019', /*  */\n\n    // Highlighter function. Should return escaped HTML,\n    // or '' if the source string is not changed and should be escaped externaly.\n    // If result starts with <pre... internal wrapper is skipped.\n    //\n    // function (/*str, lang*/) { return ''; }\n    //\n    highlight: null,\n\n    maxNesting:   20            // Internal protection, recursion limit\n  },\n\n  components: {\n\n    core: {\n      rules: [\n        'normalize',\n        'block',\n        'inline',\n        'text_join'\n      ]\n    },\n\n    block: {\n      rules: [\n        'paragraph'\n      ]\n    },\n\n    inline: {\n      rules: [\n        'text'\n      ],\n      rules2: [\n        'balance_pairs',\n        'fragments_join'\n      ]\n    }\n  }\n};\n","// Commonmark default options\n\n'use strict';\n\n\nmodule.exports = {\n  options: {\n    html:         true,         // Enable HTML tags in source\n    xhtmlOut:     true,         // Use '/' to close single tags (<br />)\n    breaks:       false,        // Convert '\\n' in paragraphs into <br>\n    langPrefix:   'language-',  // CSS language prefix for fenced blocks\n    linkify:      false,        // autoconvert URL-like texts to links\n\n    // Enable some language-neutral replacements + quotes beautification\n    typographer:  false,\n\n    // Double + single quotes replacement pairs, when typographer enabled,\n    // and smartquotes on. Could be either a String or an Array.\n    //\n    // For example, you can use '' for Russian, '' for German,\n    // and ['\\xA0', '\\xA0', '\\xA0', '\\xA0'] for French (including nbsp).\n    quotes: '\\u201c\\u201d\\u2018\\u2019', /*  */\n\n    // Highlighter function. Should return escaped HTML,\n    // or '' if the source string is not changed and should be escaped externaly.\n    // If result starts with <pre... internal wrapper is skipped.\n    //\n    // function (/*str, lang*/) { return ''; }\n    //\n    highlight: null,\n\n    maxNesting:   20            // Internal protection, recursion limit\n  },\n\n  components: {\n\n    core: {\n      rules: [\n        'normalize',\n        'block',\n        'inline',\n        'text_join'\n      ]\n    },\n\n    block: {\n      rules: [\n        'blockquote',\n        'code',\n        'fence',\n        'heading',\n        'hr',\n        'html_block',\n        'lheading',\n        'list',\n        'reference',\n        'paragraph'\n      ]\n    },\n\n    inline: {\n      rules: [\n        'autolink',\n        'backticks',\n        'emphasis',\n        'entity',\n        'escape',\n        'html_inline',\n        'image',\n        'link',\n        'newline',\n        'text'\n      ],\n      rules2: [\n        'balance_pairs',\n        'emphasis',\n        'fragments_join'\n      ]\n    }\n  }\n};\n","import MarkdownIt from \"markdown-it\";\nimport { SemanticVersion } from \"../utils/semver.mjs\";\n\nexport class ChangeLogWindow extends FormApplication {\n  constructor(lastVersion) {\n    super({}, {});\n\n    this.lastVersion = lastVersion;\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return mergeObject(options, {\n      id: \"changelog\",\n      classes: [\"ffd20\", \"changelog\"],\n      template: \"systems/ffd20/templates/apps/changelog.hbs\",\n      width: 500,\n      submitOnChange: true,\n      closeOnSubmit: false,\n    });\n  }\n\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Title\")} ~ ${game.i18n.localize(\"FFD20.Changelog\")}`;\n  }\n\n  async getData() {\n    const data = await super.getData();\n\n    data.dontShowAgain = game.settings.get(\"ffd20\", \"dontShowChangelog\");\n\n    const xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", \"systems/ffd20/CHANGELOG.md\");\n\n    const promise = new Promise((resolve) => {\n      xhr.onload = () => {\n        if (xhr.status === 200) {\n          data.changelog = this._processChangelog(xhr.response);\n          resolve(data);\n        }\n      };\n    });\n    xhr.send(null);\n\n    return promise;\n  }\n\n  _processChangelog(md) {\n    const MD = new MarkdownIt();\n\n    // Cut off irrelevant changelog entries\n    let lines = md.split(/[\\n\\r]/);\n    if (this.lastVersion) {\n      for (let a = 0; a < lines.length; a++) {\n        const line = lines[a];\n        if (line.match(/##\\s+([0-9]+\\.[0-9]+\\.[0-9]+)/)) {\n          const version = SemanticVersion.fromString(RegExp.$1);\n          if (!version.isHigherThan(this.lastVersion)) {\n            lines = lines.slice(0, a);\n            break;\n          }\n        }\n      }\n    }\n\n    return MD.render(lines.join(\"\\n\"));\n  }\n\n  async _updateObject(event, formData) {\n    if (formData.dontShowAgain != null) {\n      await game.settings.set(\"ffd20\", \"dontShowChangelog\", formData.dontShowAgain);\n    }\n  }\n}\n","export class EntrySelector extends FormApplication {\n  constructor(...args) {\n    super(...args);\n\n    // Prepare data and convert it into format compatible with the editor\n    this.isFlag = this.options.flag === true;\n    this.isBoolean = this.options.boolean === true;\n    this.isFlat = this.options.flat === true;\n    const data = deepClone(getProperty(this.object, this.attribute) ?? (this.isFlag ? {} : []));\n\n    this.originalEntries = data;\n    this.entries = this.isFlag ? (this.isBoolean ? Object.keys(data).map((d) => [d]) : Object.entries(data)) : data;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      id: \"entry-selector\",\n      classes: [\"ffd20\", \"entry\"],\n      template: \"systems/ffd20/templates/apps/entry-selector.hbs\",\n      width: 320,\n      height: \"auto\",\n      closeOnSubmit: false,\n      submitOnClose: false,\n    });\n  }\n\n  get title() {\n    return game.i18n.localize(\"FFD20.Application.EntrySelector.Title\");\n  }\n\n  get attribute() {\n    return this.options.name;\n  }\n\n  get fields() {\n    return this.options.fields.split(\";\");\n  }\n\n  get dtypes() {\n    return this.options.dtypes.split(\";\");\n  }\n\n  get dataCount() {\n    return this.fields.length;\n  }\n\n  getData() {\n    const entries = this.entries.map((entry) =>\n      this.isFlat ? [entry, this.dtypes[entry]] : entry.map((o2, a) => [o2, this.dtypes[a]])\n    );\n\n    return {\n      entries: entries,\n      fields: this.fields,\n      isFlat: this.isFlat,\n    };\n  }\n\n  activateListeners(html) {\n    html.find(\".entry-control\").click(this._onEntryControl.bind(this));\n\n    html.find('tr td input[type=\"text\"]').change(this._onEntryChange.bind(this));\n\n    html.find('button[type=\"submit\"]').click(this._submitAndClose.bind(this));\n  }\n\n  async _updateObject(event, formData) {\n    const updateData = {};\n\n    if (this.isFlag) {\n      // Convert editor data for flags\n      const newKeys = new Set(); // Needed for deletion detection\n      const entries = this.entries.forEach(([key, value]) => {\n        newKeys.add(key);\n        updateData[`${this.attribute}.${key}`] = this.isBoolean ? true : value;\n      });\n      // Handle deletions\n      const oldKeys = Object.keys(this.originalEntries);\n      oldKeys.forEach((key) => {\n        if (!newKeys.has(key)) updateData[`${this.attribute}.-=${key}`] = null;\n      });\n    } else {\n      console.log(deepClone(this.attribute), deepClone(this.entries));\n      updateData[this.attribute] = this.entries;\n    }\n\n    return this.object.update(updateData);\n  }\n\n  async _onEntryControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    if (a.classList.contains(\"add-entry\")) {\n      if (this.isFlat) {\n        const dataType = this.dtypes[a];\n        if (dataType === \"Number\") this.entries.push(0);\n        else this.entries.push(\"\");\n      } else {\n        const obj = [];\n        for (let a = 0; a < this.dataCount; a++) {\n          const dataType = this.dtypes[a];\n          if (dataType === \"Number\") obj.push(0);\n          else obj.push(\"\");\n        }\n        this.entries.push(obj);\n      }\n      return this.render();\n    }\n\n    if (a.classList.contains(\"delete-entry\")) {\n      const tr = a.closest(\"tr\");\n      const index = parseInt(tr.dataset.index);\n      this.entries.splice(index, 1);\n      return this.render();\n    }\n  }\n\n  async _onEntryChange(event) {\n    const a = event.currentTarget;\n\n    const tr = a.closest(\"tr.entry\");\n    const index = parseInt(tr.dataset.index);\n    const index2 = parseInt(a.dataset.index);\n    const value = a.value;\n\n    if (a.dataset.dtype === \"Number\") {\n      let v = parseFloat(value);\n      if (isNaN(v)) v = 0;\n      if (this.isFlat) this.entries[index] = Math.floor(v * 100) / 100;\n      else this.entries[index][index2] = Math.floor(v * 100) / 100;\n    } else {\n      if (this.isFlat) this.entries[index] = value;\n      else this.entries[index][index2] = value;\n    }\n  }\n\n  async _submitAndClose(event) {\n    event.preventDefault();\n    await this._onSubmit(event);\n    this.close();\n  }\n}\n","var e=!1,n={false:\"push\",true:\"unshift\",after:\"push\",before:\"unshift\"},t={isPermalinkSymbol:!0};function r(r,a,i,l){var o;if(!e){var c=\"Using deprecated markdown-it-anchor permalink option, see https://github.com/valeriangalliat/markdown-it-anchor#permalinks\";\"object\"==typeof process&&process&&process.emitWarning?process.emitWarning(c):console.warn(c),e=!0}var s=[Object.assign(new i.Token(\"link_open\",\"a\",1),{attrs:[].concat(a.permalinkClass?[[\"class\",a.permalinkClass]]:[],[[\"href\",a.permalinkHref(r,i)]],Object.entries(a.permalinkAttrs(r,i)))}),Object.assign(new i.Token(\"html_block\",\"\",0),{content:a.permalinkSymbol,meta:t}),new i.Token(\"link_close\",\"a\",-1)];a.permalinkSpace&&i.tokens[l+1].children[n[a.permalinkBefore]](Object.assign(new i.Token(\"text\",\"\",0),{content:\" \"})),(o=i.tokens[l+1].children)[n[a.permalinkBefore]].apply(o,s)}function a(e){return\"#\"+e}function i(e){return{}}var l={class:\"header-anchor\",symbol:\"#\",renderHref:a,renderAttrs:i};function o(e){function n(t){return t=Object.assign({},n.defaults,t),function(n,r,a,i){return e(n,t,r,a,i)}}return n.defaults=Object.assign({},l),n.renderPermalinkImpl=e,n}var c=o(function(e,r,a,i,l){var o,c=[Object.assign(new i.Token(\"link_open\",\"a\",1),{attrs:[].concat(r.class?[[\"class\",r.class]]:[],[[\"href\",r.renderHref(e,i)]],r.ariaHidden?[[\"aria-hidden\",\"true\"]]:[],Object.entries(r.renderAttrs(e,i)))}),Object.assign(new i.Token(\"html_inline\",\"\",0),{content:r.symbol,meta:t}),new i.Token(\"link_close\",\"a\",-1)];if(r.space){var s=\"string\"==typeof r.space?r.space:\" \";i.tokens[l+1].children[n[r.placement]](Object.assign(new i.Token(\"string\"==typeof r.space?\"html_inline\":\"text\",\"\",0),{content:s}))}(o=i.tokens[l+1].children)[n[r.placement]].apply(o,c)});Object.assign(c.defaults,{space:!0,placement:\"after\",ariaHidden:!1});var s=o(c.renderPermalinkImpl);s.defaults=Object.assign({},c.defaults,{ariaHidden:!0});var u=o(function(e,n,t,r,a){var i=[Object.assign(new r.Token(\"link_open\",\"a\",1),{attrs:[].concat(n.class?[[\"class\",n.class]]:[],[[\"href\",n.renderHref(e,r)]],Object.entries(n.renderAttrs(e,r)))})].concat(n.safariReaderFix?[new r.Token(\"span_open\",\"span\",1)]:[],r.tokens[a+1].children,n.safariReaderFix?[new r.Token(\"span_close\",\"span\",-1)]:[],[new r.Token(\"link_close\",\"a\",-1)]);r.tokens[a+1]=Object.assign(new r.Token(\"inline\",\"\",0),{children:i})});Object.assign(u.defaults,{safariReaderFix:!1});var d=o(function(e,r,a,i,l){var o;if(![\"visually-hidden\",\"aria-label\",\"aria-describedby\",\"aria-labelledby\"].includes(r.style))throw new Error(\"`permalink.linkAfterHeader` called with unknown style option `\"+r.style+\"`\");if(![\"aria-describedby\",\"aria-labelledby\"].includes(r.style)&&!r.assistiveText)throw new Error(\"`permalink.linkAfterHeader` called without the `assistiveText` option in `\"+r.style+\"` style\");if(\"visually-hidden\"===r.style&&!r.visuallyHiddenClass)throw new Error(\"`permalink.linkAfterHeader` called without the `visuallyHiddenClass` option in `visually-hidden` style\");var c=i.tokens[l+1].children.filter(function(e){return\"text\"===e.type||\"code_inline\"===e.type}).reduce(function(e,n){return e+n.content},\"\"),s=[],u=[];if(r.class&&u.push([\"class\",r.class]),u.push([\"href\",r.renderHref(e,i)]),u.push.apply(u,Object.entries(r.renderAttrs(e,i))),\"visually-hidden\"===r.style){if(s.push(Object.assign(new i.Token(\"span_open\",\"span\",1),{attrs:[[\"class\",r.visuallyHiddenClass]]}),Object.assign(new i.Token(\"text\",\"\",0),{content:r.assistiveText(c)}),new i.Token(\"span_close\",\"span\",-1)),r.space){var d=\"string\"==typeof r.space?r.space:\" \";s[n[r.placement]](Object.assign(new i.Token(\"string\"==typeof r.space?\"html_inline\":\"text\",\"\",0),{content:d}))}s[n[r.placement]](Object.assign(new i.Token(\"span_open\",\"span\",1),{attrs:[[\"aria-hidden\",\"true\"]]}),Object.assign(new i.Token(\"html_inline\",\"\",0),{content:r.symbol,meta:t}),new i.Token(\"span_close\",\"span\",-1))}else s.push(Object.assign(new i.Token(\"html_inline\",\"\",0),{content:r.symbol,meta:t}));\"aria-label\"===r.style?u.push([\"aria-label\",r.assistiveText(c)]):[\"aria-describedby\",\"aria-labelledby\"].includes(r.style)&&u.push([r.style,e]);var f=[Object.assign(new i.Token(\"link_open\",\"a\",1),{attrs:u})].concat(s,[new i.Token(\"link_close\",\"a\",-1)]);(o=i.tokens).splice.apply(o,[l+3,0].concat(f)),r.wrapper&&(i.tokens.splice(l,0,Object.assign(new i.Token(\"html_block\",\"\",0),{content:r.wrapper[0]+\"\\n\"})),i.tokens.splice(l+3+f.length+1,0,Object.assign(new i.Token(\"html_block\",\"\",0),{content:r.wrapper[1]+\"\\n\"})))});function f(e,n,t,r){var a=e,i=r;if(t&&Object.prototype.hasOwnProperty.call(n,a))throw new Error(\"User defined `id` attribute `\"+e+\"` is not unique. Please fix it in your Markdown to continue.\");for(;Object.prototype.hasOwnProperty.call(n,a);)a=e+\"-\"+i,i+=1;return n[a]=!0,a}function p(e,n){n=Object.assign({},p.defaults,n),e.core.ruler.push(\"anchor\",function(e){for(var t,a={},i=e.tokens,l=Array.isArray(n.level)?(t=n.level,function(e){return t.includes(e)}):function(e){return function(n){return n>=e}}(n.level),o=0;o<i.length;o++){var c=i[o];if(\"heading_open\"===c.type&&l(Number(c.tag.substr(1)))){var s=n.getTokensText(i[o+1].children),u=c.attrGet(\"id\");u=null==u?f(n.slugify(s),a,!1,n.uniqueSlugStartIndex):f(u,a,!0,n.uniqueSlugStartIndex),c.attrSet(\"id\",u),!1!==n.tabIndex&&c.attrSet(\"tabindex\",\"\"+n.tabIndex),\"function\"==typeof n.permalink?n.permalink(u,n,e,o):(n.permalink||n.renderPermalink&&n.renderPermalink!==r)&&n.renderPermalink(u,n,e,o),o=i.indexOf(c),n.callback&&n.callback(c,{slug:u,title:s})}}})}Object.assign(d.defaults,{style:\"visually-hidden\",space:!0,placement:\"after\",wrapper:null}),p.permalink={__proto__:null,legacy:r,renderHref:a,renderAttrs:i,makePermalink:o,linkInsideHeader:c,ariaHidden:s,headerLink:u,linkAfterHeader:d},p.defaults={level:1,slugify:function(e){return encodeURIComponent(String(e).trim().toLowerCase().replace(/\\s+/g,\"-\"))},uniqueSlugStartIndex:1,tabIndex:\"-1\",getTokensText:function(e){return e.filter(function(e){return[\"text\",\"code_inline\"].includes(e.type)}).map(function(e){return e.content}).join(\"\")},permalink:!1,renderPermalink:r,permalinkClass:s.defaults.class,permalinkSpace:s.defaults.space,permalinkSymbol:\"\",permalinkBefore:\"before\"===s.defaults.placement,permalinkHref:s.defaults.renderHref,permalinkAttrs:s.defaults.renderAttrs},p.default=p;export{p as default};\n//# sourceMappingURL=markdownItAnchor.mjs.map\n","import MarkdownIt from \"markdown-it\";\nimport MarkDownItAnchor from \"markdown-it-anchor\";\n\n/**\n * An {@link Application} displaying documentation for the Pathfinder 1e system within Foundry.\n *\n * @augments Application\n */\nexport class HelpBrowserPF extends Application {\n  /**\n   * @type {HistoryEntry[]}\n   * @private\n   */\n  _backwardHistory = [];\n  /**\n   * @type {HistoryEntry[]}\n   * @private\n   */\n  _forwardHistory = [];\n  /**\n   * The currently shown entry.\n   *\n   * @type {HistoryEntry}\n   * @private\n   */\n  _currentPage = { url: \"\" };\n\n  /**\n   * The Markdown parser instance for this application.\n   *\n   * @type {MarkdownIt}\n   * @private\n   */\n  _md;\n\n  /** @inheritdoc */\n  constructor(...args) {\n    super(...args);\n    this._initMarkdown();\n    return this;\n  }\n\n  /** @inheritdoc */\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"help-browser\"],\n      template: \"systems/ffd20/templates/apps/help-browser.hbs\",\n      minWidth: 800,\n      minHeight: 450,\n      width: 960,\n      height: 600,\n      resizable: true,\n      id: \"ffd20-help-browser\",\n    });\n  }\n\n  /** @inheritdoc */\n  get title() {\n    return game.i18n.localize(\"FFD20.Help.Label\");\n  }\n\n  /**\n   * The URL of the page currently displayed\n   *\n   * @type {string}\n   */\n  get currentUrl() {\n    return this._currentPage.url;\n  }\n\n  /**\n   * Initializes this help browser's {@link MarkdownIt} instance, adjusting rules as necessary.\n   *\n   * @private\n   */\n  _initMarkdown() {\n    const md = new MarkdownIt().use(MarkDownItAnchor, {\n      tabIndex: false,\n      slugify: (url) => `ffd20-help-browser.${url.slugify()}`,\n    });\n    const defaultImageRenderRule = md.renderer.rules.image;\n    md.renderer.rules.image = pf1HelpImageRenderer(defaultImageRenderRule);\n    this._md = md;\n  }\n\n  /** @override */\n  async getData() {\n    const data = await super.getData();\n\n    // Nav element only needs to get rendered once\n    this.nav ??= this._md.render(game.i18n.localize(\"FFD20.Help/Home\"));\n\n    data.hasHistoryBack = this._backwardHistory.length > 0;\n    data.hasHistoryForward = this._forwardHistory.length > 0;\n    data.nav = this.nav;\n\n    // Get markdown string from localisation, and parse it\n    data.pageContent = this._md.render(game.i18n.localize(`FFD20.${this.currentUrl}`));\n\n    return data;\n  }\n\n  /**\n   * Opens a specific page in the help browser.\n   *\n   * @param {string} url - The help URL to open\n   */\n  openUrl(url) {\n    // Remove leading `/`, which are okay in the wiki, but not present in localisation files\n    if (url.startsWith(\"/\")) url = url.slice(1);\n    let header;\n    // Extract header from URL\n    [url, header] = url.split(\"#\");\n    if (this.currentUrl && url !== this.currentUrl) {\n      // Add new page to history\n      this._backwardHistory.push(this.getCurrentHistoryObject());\n      this._forwardHistory.splice(0, this._forwardHistory.length);\n    }\n    this._currentPage = { url };\n    this.render(true, { header: header });\n  }\n\n  /** @inheritdoc */\n  async _render(force, options) {\n    await super._render(options);\n    const contentElement = this.element.find(\".content\")[0];\n\n    if (this._currentPage.scrollTop) {\n      // Dirty timeout to wait for loading of images with unknown height\n      setTimeout(() => {\n        contentElement.scrollTop = this._currentPage.scrollTop;\n      }, 0);\n    } else if (options.header) {\n      const headerElement = document.getElementById(`ffd20-help-browser.${options.header}`);\n      if (headerElement) {\n        setTimeout(() => {\n          const emHeight = Number.parseFloat(getComputedStyle(headerElement).fontSize);\n          contentElement.scrollTop = headerElement.offsetTop - (45 + 1.5 * emHeight);\n        }, 0);\n      }\n    }\n  }\n\n  /**\n   * Returns a {@link HistoryEntry} containing a snapshot of the currently rendered state.\n   *\n   * @returns {HistoryEntry} The current state\n   */\n  getCurrentHistoryObject() {\n    const elem = this.element.find(\".content\")[0];\n    const scrollTop = elem?.scrollTop ?? 0;\n    return {\n      url: this.currentUrl,\n      scrollTop: scrollTop,\n    };\n  }\n\n  /** Go back one page in history. */\n  backInHistory() {\n    if (!this._backwardHistory.length) return;\n    this._forwardHistory.push(this.getCurrentHistoryObject());\n    this._currentPage = this._backwardHistory.pop();\n    this.render();\n  }\n\n  /** Go forward one page in history. */\n  forwardInHistory() {\n    if (!this._forwardHistory.length) return;\n    this._backwardHistory.push(this.getCurrentHistoryObject());\n    this._currentPage = this._forwardHistory.pop();\n    this.render();\n  }\n\n  /** @param {JQuery<HTMLElement>} html - This application's HTML element */\n  activateListeners(html) {\n    // Remove href attributes to avoid actual browser page changes\n    const links = html.find(\"a[href]\");\n    for (const l of links) {\n      const href = l.getAttribute(\"href\");\n      l.removeAttribute(\"href\");\n      // Store target in dataset\n      l.dataset.url = href;\n    }\n    html.on(\"click\", \"a\", (event) => {\n      event.preventDefault();\n      const url = event.currentTarget.dataset.url;\n      if (url) this.openUrl(url);\n    });\n\n    // History buttons\n    html.find(\".history-back\").on(\"click\", this.backInHistory.bind(this));\n    html.find(\".history-forward\").on(\"click\", this.forwardInHistory.bind(this));\n  }\n}\n\n/** @type {(defaultRenderer: Renderer.RenderRule) => Renderer.RenderRule} */\nconst pf1HelpImageRenderer = (defaultRenderer) => (tokens, idx, options, env, self) => {\n  const token = tokens[idx];\n  let src = token.attrGet(\"src\");\n  if (src.startsWith(\"/\")) src = src.slice(1);\n  const foundrySrc = game.i18n.localize(`FFD20.${src}`);\n  token.attrSet(\"src\", foundry.utils.getRoute(`systems/ffd20/${foundrySrc}`));\n  return defaultRenderer(tokens, idx, options, env, self);\n};\n\nexport const helpBrowser = new HelpBrowserPF();\n\n/**\n * @typedef {object} HistoryEntry\n * @property {string} url - URL of this history entry\n * @property {number} [scrollTop] - Scroll position of this history entry\n */\n","import { LinkFunctions as LinksApp } from \"../utils/links.mjs\";\n\nexport class LinkOptions extends FormApplication {\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      id: \"link-options\",\n      classes: [\"ffd20\"],\n      title: game.i18n.localize(\"FFD20.LinkOptionsTitle\"),\n      template: \"systems/ffd20/templates/apps/link-options.hbs\",\n      width: 320,\n      height: \"auto\",\n      submitOnClose: true,\n      closeOnSubmit: true,\n    });\n  }\n\n  getData() {\n    const e = this.object;\n\n    const linkTypes = LinksApp.getLinkTypes(e.source(), e.target());\n    const linkTypesObj = linkTypes.reduce((cur, o) => {\n      cur[o] = `Link_${o}`;\n      return cur;\n    }, {});\n\n    const options = this._getLinkTypeCommandOptions(e, linkTypes[0]);\n    const result = {\n      linkTypes: linkTypesObj,\n      options: options,\n      isNumber: options != null && options.type === \"number\",\n      isString: options != null && options.type === \"string\",\n    };\n\n    return result;\n  }\n\n  /**\n   * @typedef CommandOptions\n   * @type {object}\n   * @property {string} type             - Either \"number\" or \"string\".\n   * @property {number} [min]            - A minimum value for numbers.\n   * @property {number} [max]            - A maximum value for numbers.\n   * @property {string} title            - The title for the dialog.\n   * @property {string|number} [initial] - The initial value.\n   * @param {object} e           - The edge connecting two nodes.\n   * @param {string} defaultType - The default type if `e` has no type yet.\n   * @returns {CommandOptions} The resulting options.\n   */\n  _getLinkTypeCommandOptions(e, defaultType) {\n    const type = e.data(\"type\") || defaultType;\n\n    if (type === \"minLevel\") {\n      return {\n        type: \"number\",\n        min: 1,\n        max: 20,\n        initial: e.data(\"value\") || 1,\n      };\n    }\n\n    return null;\n  }\n}\n","import { getDistanceSystem } from \"@utils\";\n\nexport class SensesSelector extends DocumentSheet {\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return mergeObject(options, {\n      classes: [\"ffd20\", \"senses-selector\"],\n      template: \"systems/ffd20/templates/apps/senses-selector.hbs\",\n      width: 500,\n      closeOnSubmit: true,\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the special traits selection window to include the Actor name\n   *\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Senses\")}: ${this.object.name}`;\n  }\n\n  /**\n   * Returns which keys to convert in distance or weight\n   */\n  get convertKeys() {\n    return {\n      \"system.traits.senses.dv\": \"distance\",\n      \"system.traits.senses.ts\": \"distance\",\n      \"system.traits.senses.bse\": \"distance\",\n      \"system.traits.senses.bs\": \"distance\",\n      \"system.traits.senses.sc\": \"distance\",\n    };\n  }\n\n  async getData() {\n    const data = {\n      system: this.document.system,\n      converted: Object.entries(this.convertKeys).reduce((cur, [path, type]) => {\n        if (type === \"distance\") setProperty(cur, path, ffd20.utils.convertDistance(getProperty(this.document, path))[0]);\n        return cur;\n      }, {}),\n      gridUnits: getDistanceSystem() === \"imperial\" ? \"ft\" : \"m\",\n    };\n    return data;\n  }\n\n  async _updateObject(event, formData) {\n    // Convert data back\n    Object.entries(this.convertKeys).forEach((o) => {\n      if (o[1] === \"distance\") formData[o[0]] = ffd20.utils.convertDistanceBack(formData[o[0]])[0];\n    });\n\n    // Update document\n    const result = await super._updateObject(event, formData);\n\n    return result;\n  }\n}\n","import { createTag } from \"../utils/lib.mjs\";\n\nexport class SkillEditor extends FormApplication {\n  constructor(actor, skillId, subSkillId, options = {}) {\n    super(actor, options);\n    this.skillId = skillId;\n    this.subSkillId = subSkillId;\n\n    this._callbacks = [];\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      width: 380,\n      template: \"systems/ffd20/templates/apps/skill-editor.hbs\",\n      closeOnSubmit: false,\n      dragDrop: [{ dragSelector: null, dropSelector: \"*\" }],\n      classes: [...options.classes, \"ffd20\", \"skill-editor\"],\n    };\n  }\n\n  get title() {\n    return `${game.i18n.localize(\"FFD20.EditSkill\")}: ${this.skillName}`;\n  }\n\n  get actor() {\n    return this.object;\n  }\n\n  get isSubSkill() {\n    return this.subSkillId != null;\n  }\n  get isStaticSkill() {\n    return ffd20.config.skills[this.skillId] != null && !this.isSubSkill;\n  }\n\n  get skill() {\n    if (this.isSubSkill) return this.actor.system.skills[this.skillId]?.subSkills[this.subSkillId];\n    return this.actor.system.skills[this.skillId];\n  }\n  get skillName() {\n    return this.isStaticSkill ? ffd20.config.skills[this.skillId] : this.skill.name;\n  }\n  get skillTag() {\n    if (this.isStaticSkill) return this.skillId;\n    return this.isSubSkill ? this.subSkillId : this.skillId;\n  }\n\n  async getData(options) {\n    const data = await super.getData(options);\n\n    // Configuration\n    data.config = ffd20.config;\n\n    // Skill data\n    data.skill = mergeObject(\n      this.skill,\n      {\n        skillId: this.skillId,\n        subSkillId: this.subSkillId,\n        isSubSkill: this.isSubSkill,\n        name: this.skillName,\n        static: this.isStaticSkill,\n        tag: this.skillTag,\n      },\n      { inplace: false }\n    );\n\n    // Actor data\n    data.actorData = this.actor.toObject();\n\n    // Referenced documents\n    try {\n      const document = await fromUuid(data.skill.journal);\n      data.journal = document.toObject();\n      data.journal.uuid = data.skill.journal;\n      data.journal.documentType = document instanceof JournalEntryPage ? \"JournalEntryPage\" : \"JournalEntry\";\n    } catch (err) {\n      data.journal = null;\n    }\n\n    return data;\n  }\n\n  addCallback(fn) {\n    this._callbacks.push(fn);\n  }\n\n  async _updateObject(event, formData) {\n    event.preventDefault();\n\n    // Setup base update data\n    const updateData = { system: { skills: {} } };\n    const skillCoreUpdateData = updateData.system.skills;\n\n    formData = expandObject(formData);\n    // Forcibly slugify provided tag to ensure it is not invalid (e.g. contain periods)\n    const tag = formData.tag?.slugify({ strict: true });\n    const newData = formData.skill;\n\n    // Track old IDs for rename related data deletion\n    const oldSubSkillId = this.subSkillId,\n      oldSkillId = this.skillId;\n\n    // Preserve some data\n    newData.journal ??= this.skill.journal;\n    newData.custom ??= this.skill.custom;\n    if (!this.isStaticSkill) {\n      newData.background ??= this.skill.background;\n    }\n\n    // Basic sanity check\n    if (!this.isStaticSkill && !tag) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.ErrorEmptySkillTag\"));\n    }\n\n    // Change application's id by tag\n    if (tag) {\n      if (this.isSubSkill) this.subSkillId = tag;\n      else this.skillId = tag;\n    }\n\n    if (this.isSubSkill) {\n      skillCoreUpdateData[this.skillId] = { subSkills: { [this.subSkillId]: newData } };\n      if (!this.isStaticSkill && oldSubSkillId !== this.subSkillId) {\n        // Delete old skill\n        skillCoreUpdateData[this.skillId].subSkills[`-=${oldSubSkillId}`] = null;\n        // Check for attempts to overwrite skills\n        if (this.subSkillId in this.object.system.skills[this.skillId].subSkills) {\n          return void ui.notifications.error(\n            game.i18n.format(\"FFD20.ErrorSkillTagAlreadyExists\", { tag: `${this.skillId}.subSkills.${this.subSkillId}` })\n          );\n        }\n      }\n    } else {\n      skillCoreUpdateData[this.skillId] = newData;\n      if (!this.isStaticSkill && oldSkillId !== this.skillId) {\n        // Delete old skill\n        skillCoreUpdateData[`-=${oldSkillId}`] = null;\n        // Check for attempts to overwrite skills\n        if (this.skillId in this.object.system.skills) {\n          return void ui.notifications.error(game.i18n.format(\"FFD20.ErrorSkillTagAlreadyExists\", { tag: this.skillId }));\n        }\n      }\n    }\n\n    await this.object.update(updateData);\n  }\n\n  async close(...args) {\n    await super.close(...args);\n\n    this._callbacks.forEach((fn) => fn());\n  }\n\n  async _onDrop(event) {\n    event.preventDefault();\n\n    // Retrieve the dropped Journal Entry Page\n    const data = TextEditor.getDragEventData(event);\n    if (data.type !== \"JournalEntryPage\" && data.type !== \"JournalEntry\") return;\n    const document = await CONFIG[data.type].documentClass.implementation.fromDropData(data);\n    if (!document) return;\n\n    // Add Journal Entry Page reference\n    await this._onSubmit(event, { updateData: { \"skill.journal\": document.uuid } });\n    await this.render();\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Open compendium page\n    html.find(\".compendium-page\").on(\"click\", this._openCompendiumEntry.bind(this));\n    html.find(\".compendium-controls a\").on(\"click\", this._onCompendiumControls.bind(this));\n\n    // Submit\n    html.find(`button[type=\"submit\"]`).on(\"click\", (event) => {\n      event.preventDefault();\n      const valid = this.element[0].querySelector(\"form\").reportValidity();\n      if (valid) this.close({ submit: true });\n    });\n  }\n\n  async _openCompendiumEntry(event) {\n    event.preventDefault();\n    const elem = event.currentTarget.closest(\".compendium-entry\");\n\n    // Gather data\n    const uuid = elem.dataset.compendiumEntry;\n    const document = await fromUuid(uuid);\n\n    // Open document\n    if (document instanceof JournalEntryPage) {\n      document.parent.sheet.render(true, { pageId: document.id });\n    } else {\n      document.sheet.render(true);\n    }\n  }\n\n  async _onCompendiumControls(event) {\n    event.preventDefault();\n    const elem = event.currentTarget;\n\n    if (elem.classList.contains(\"delete\")) {\n      await this._onSubmit(event, { updateData: { \"skill.journal\": null } });\n      await this.render();\n    }\n  }\n}\n","export class ExperienceDistributor extends FormApplication {\n  /**\n   * @constructs ExperienceDistributor\n   * @param {ActorPF[]} [actors] - Actors to add to this distributor.\n   * @param {object} [options] - Options for this application.\n   */\n  constructor(actors = [], options = {}) {\n    actors = actors\n      .map((o) => {\n        return ExperienceDistributor.getActorData(o);\n      })\n      .filter((o) => o != null);\n    super(actors, options);\n    this.bonusXP = 0;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"xp-distributor\"],\n      title: game.i18n.localize(\"FFD20.Application.XPDistributor.Title\"),\n      template: \"systems/ffd20/templates/apps/xp-distributor.hbs\",\n      width: 430,\n      height: 794,\n      resizable: true,\n      scrollY: [\".selectors\"],\n    });\n  }\n\n  getData() {\n    const result = super.getData();\n\n    // Add combatants\n    result.actors = {\n      characters: this.getCharacters(),\n      npcs: this.getNPCs(),\n    };\n\n    // Add labels\n    result.labels = {\n      xp: {\n        total: `+ ${this.getTotalExperience().toLocaleString()}`,\n        split: `+ ${this.getSplitExperience().toLocaleString()}`,\n      },\n    };\n\n    result.bonusXP = this.bonusXP;\n\n    return result;\n  }\n\n  getCharacters() {\n    return this.object.filter((o) => o.actor.type === \"character\");\n  }\n\n  getNPCs() {\n    return this.object.filter((o) => o.actor.type === \"npc\");\n  }\n\n  activateListeners(html) {\n    if (jQuery != null && html instanceof jQuery) html = html[0];\n    const addListener = (query, ev, callback) =>\n      html.querySelectorAll(query).forEach((elem) => elem.addEventListener(ev, callback));\n\n    addListener(\".character-selector .actor, .npc-selector .actor\", \"click\", this._onClickActor.bind(this));\n\n    addListener(\".bonus-xp input\", \"change\", (event) => {\n      event.preventDefault();\n\n      this.bonusXP = parseInt(event.currentTarget.value);\n      if (isNaN(this.bonusXP)) this.bonusXP = 0;\n\n      this.render();\n    });\n\n    // Allow dropping actors from the sidebar to add them to the list\n    html.addEventListener(\"drop\", this._onDrop.bind(this));\n\n    addListener('button[name=\"split-evenly\"], button[name=\"give-to-all\"]', \"click\", this._onSubmit.bind(this));\n    addListener('button[name=\"cancel\"]', \"click\", this._onCancel.bind(this));\n  }\n\n  async _onDrop(event) {\n    event.preventDefault();\n    const data = TextEditor.getDragEventData(event);\n\n    // Add actor\n    if (data.type === \"Actor\") {\n      const actor = await Actor.implementation.fromDropData(data);\n\n      // Prevent duplicate characters (not NPCs)\n      if (actor.type !== \"character\" || this.object.find((o) => o.actor === actor) == null) {\n        // Add actor to list\n        this.object.push(mergeObject(this.constructor.getActorData(actor), { toggled: true }));\n        this.render(true);\n      }\n    }\n  }\n\n  _onClickActor(event) {\n    event.preventDefault();\n\n    const a = event.currentTarget;\n    const actorID = event.currentTarget.dataset.id;\n    const actor = this.object.find((o) => o.id === actorID);\n\n    if (!actor) return;\n\n    if (actor.toggled) {\n      actor.toggled = false;\n      a.classList.remove(\"toggled\");\n    } else {\n      actor.toggled = true;\n      a.classList.add(\"toggled\");\n    }\n\n    this.render();\n  }\n\n  async _onSubmit(event) {\n    event.preventDefault();\n\n    const type = event.currentTarget.name;\n\n    const value = type === \"split-evenly\" ? this.getSplitExperience() : this.getTotalExperience();\n\n    if (value > 0) {\n      const characters = this.getCharacters().filter((o) => o.toggled);\n\n      for (const actorData of characters) {\n        const result = { value: value };\n        Hooks.callAll(\"pf1GainXp\", actorData.actor, result);\n        actorData.value = result.value;\n      }\n\n      const updates = characters\n        .map((o) => {\n          if (o.value === 0 || !Number.isFinite(o.value)) return null;\n          return {\n            _id: o.actor.id,\n            \"system.details.xp.value\": o.actor.system.details.xp.value + Math.floor(o.value),\n          };\n        })\n        .filter((o) => o != null);\n      Actor.implementation.updateDocuments(updates);\n    }\n\n    this.close();\n  }\n\n  _onCancel(event) {\n    event.preventDefault();\n\n    this.close();\n  }\n\n  getTotalExperience() {\n    const npcs = this.getNPCs().filter((o) => o.toggled);\n\n    return npcs.reduce((cur, o) => {\n      return cur + o.xp;\n    }, this.bonusXP);\n  }\n\n  getSplitExperience() {\n    const characters = this.getCharacters().filter((o) => o.toggled);\n    const xp = this.getTotalExperience();\n\n    const hasAnyCharacters = characters.length > 0;\n\n    if (hasAnyCharacters) return Math.floor(xp / characters.length);\n    return 0;\n  }\n\n  static getActorData(actor) {\n    if (!(actor instanceof Actor)) return null;\n    const type = actor.type;\n    const xp = type === \"npc\" ? actor.system.details.xp.value ?? 0 : 0;\n\n    return {\n      id: randomID(16),\n      actor: actor,\n      toggled: this.shouldActorBeToggled(actor),\n      xp,\n      xpString: xp.toLocaleString(),\n    };\n  }\n\n  static shouldActorBeToggled(actor) {\n    const isPC = actor.type === \"character\";\n    const isDefeated = actor.system.attributes.hp.value < 0;\n\n    if (!isPC && !isDefeated) return false;\n\n    return true;\n  }\n}\n","export class ItemDirectoryPF extends ItemDirectory {\n  /**\n   * Enrich default options for detecting identified/unidentified name changes\n   *\n   * @override\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    options.renderUpdateKeys.push(\"system.unidentified.name\", \"system.identified\");\n    return options;\n  }\n\n  /**\n   * Override Foundry's render to catch unidentified name changes (Foundry's \"k in d\" doesn't work).\n   *\n   * @override\n   */\n  async _render(force = false, context = {}) {\n    // Only re-render the sidebar directory for certain types of updates\n    const { action, data, documentType } = context;\n    if (action && ![\"create\", \"update\", \"delete\"].includes(action)) return this;\n    if (\n      documentType !== \"Folder\" &&\n      action === \"update\" &&\n      !data.some((d) => this.options.renderUpdateKeys.some((k) => getProperty(d, k) !== undefined))\n    )\n      return;\n\n    // Re-build the tree and render\n    this.initialize();\n    // Skip ItemDirectory & SidebarDirectory _render, both of which use k in d culling\n    return SidebarTab.prototype._render.call(this, force, context);\n  }\n}\n","export class Troubleshooter extends Application {\n  get title() {\n    return game.i18n.localize(\"FFD20.Troubleshooter.Title\");\n  }\n\n  get template() {\n    return \"systems/ffd20/templates/apps/troubleshooter.hbs\";\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"ffd20\", \"troubleshooter\"],\n      id: \"ffd20-troubleshooter\",\n      width: 460,\n    };\n  }\n\n  getData() {\n    return {\n      isGM: game.user.isGM,\n      links: {\n        help: `<a data-action='help'>${game.i18n.localize(\"FFD20.Troubleshooter.Steps.HelpLink\")}</a>`,\n        report: `<a href=\"https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/issues\">${game.i18n.localize(\n          \"FFD20.Troubleshooter.Steps.ReportLinkText\"\n        )}</a>`,\n        foundry: {\n          discord: `<a href=\"https://discord.gg/foundryvtt\">Foundry VTT</a>`,\n          channel: \"#pf1\",\n        },\n        faq: \"https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/wikis/FAQs\",\n        helpmodule: `<a href=\"https://foundryvtt.com/packages/find-the-culprit\">Find the Culprit</a>`,\n      },\n    };\n  }\n\n  /**\n   * @param {Event} event\n   */\n  async _runMigration(event) {\n    if (!game.user.isGM) return;\n\n    /** @type {Element} */\n    const el = event.target;\n    el.classList.remove(\"finished\");\n    el.disabled = true;\n\n    const target = el.dataset.target;\n    switch (target) {\n      case \"world\":\n        await ffd20.migrations.migrateWorld();\n        break;\n      case \"modules\":\n        await ffd20.migrations.migrateModules({ unlock: false });\n        break;\n      default:\n        throw new Error(`Unrecognized migration target: \"${target}\"`);\n    }\n\n    el.disabled = false;\n    el.classList.add(\"finished\");\n  }\n\n  _openHelp(event) {\n    ffd20.applications.helpBrowser.openUrl(\"Help/Home\");\n  }\n\n  /**\n   * @param {JQuery} jq\n   * @override\n   */\n  activateListeners(jq) {\n    super.activateListeners(jq);\n\n    const [html] = jq;\n\n    const migrationButtons = html.querySelectorAll(\"button[data-action='migrate']\");\n\n    for (const button of migrationButtons) {\n      button.addEventListener(\"click\", this._runMigration.bind(this));\n    }\n\n    // React to external migration to minimal degree\n    if (ffd20.migrations.isMigrating) {\n      for (const button of migrationButtons) {\n        button.disabled = true;\n      }\n\n      Hooks.once(\"pf1MigrationFinished\", () => {\n        for (const button of migrationButtons) {\n          button.disabled = false;\n        }\n      });\n    }\n\n    html.querySelector(\"a[data-action='help']\").addEventListener(\"click\", this._openHelp.bind(this));\n  }\n\n  static open() {\n    new Troubleshooter().render(true, { focus: true });\n  }\n}\n","/**\n * The various {@link Application}s used by the Pathfinder 1e system.\n *\n * @module\n */\n\nimport { CompendiumBrowser } from \"./compendium-browser/compendium-browser.mjs\";\n\nexport * as actor from \"./actor/_module.mjs\";\nexport * as item from \"./item/_module.mjs\";\nexport * as component from \"./component/_module.mjs\";\nexport * as settings from \"./settings/_module.mjs\";\nexport * as compendiumBrowser from \"./compendium-browser/_module.mjs\";\n\nexport { ActionChooser } from \"./action-chooser.mjs\";\nexport { AttackDialog } from \"./attack-dialog.mjs\";\nexport { Widget_CategorizedItemPicker } from \"./categorized-item-picker.mjs\";\nexport { ChangeLogWindow } from \"./change-log.mjs\";\nexport { CurrencyTransfer } from \"./currency-transfer.mjs\";\nexport { DamageTypeSelector } from \"./damage-type-selector.mjs\";\nexport { EntrySelector } from \"./entry-selector.mjs\";\nexport { HelpBrowserPF } from \"./help-browser.mjs\";\nexport { Widget_ItemPicker } from \"./item-picker.mjs\";\nexport { LevelUpForm } from \"./level-up.mjs\";\nexport { LinkOptions } from \"./link-options.mjs\";\nexport { PointBuyCalculator } from \"./point-buy-calculator.mjs\";\nexport { ScriptEditor } from \"./script-editor.mjs\";\nexport { SensesSelector } from \"./senses-selector.mjs\";\nexport { SkillEditor } from \"./skill-editor.mjs\";\nexport { TooltipPF } from \"./tooltip.mjs\";\nexport { ActorTraitSelector } from \"./trait-selector.mjs\";\nexport { VisionPermissionSheet } from \"./vision-permission.mjs\";\nexport { ExperienceDistributor } from \"./xp-distributor.mjs\";\n\nexport { ItemDirectoryPF } from \"./sidebar/items-directory.mjs\";\nexport { Troubleshooter } from \"./troubleshooter.mjs\";\n\n/**\n * {@link CompendiumBrowser}s for the various compendiums.\n *\n * @type {Record<string, CompendiumBrowser>}\n */\nexport const compendiums = {};\nexport { helpBrowser } from \"./help-browser.mjs\";\n","export class ActiveEffectPF extends ActiveEffect {\n  async create(data, context = {}) {\n    const statusId = this.flags?.core?.statusId,\n      origin = this.origin,\n      updates = {};\n    if (statusId && this.parent?.system.attributes.conditions[statusId] === false) {\n      updates[`system.attributes.conditions.${statusId}`] = true;\n      await this.parent.update(updates);\n      const created = this.parent.effects.find((e) => e.getFlag(\"core\", \"statusId\") === statusId);\n      if (created) return created;\n    }\n    if (origin) {\n      const buffItem = this.parent.items.get(origin.split(\".\")[3]);\n      if (buffItem && !buffItem.system.active) await buffItem.setActive(true);\n    }\n    return super.create(data, context);\n  }\n\n  async delete(context = {}) {\n    const statusId = this.getFlag(\"core\", \"statusId\"),\n      re = this.origin?.match(/Item\\.(?<itemId>\\w+)/),\n      origin = re?.groups.itemId,\n      parentActor = this.parent,\n      secondaryContext = statusId || origin ? { render: false } : {},\n      returnVal = await super.delete(mergeObject(secondaryContext, context));\n    if (statusId && parentActor.system.attributes.conditions[statusId]) {\n      const updates = { [`system.attributes.conditions.${statusId}`]: false };\n      await parentActor.update(updates, context);\n    } else if (origin) {\n      const item = parentActor.items.get(origin);\n      // Avoid looping\n      if (context.ffd20?.delete !== item.uuid) {\n        item?.setActive(false, context);\n      }\n    }\n    return returnVal;\n  }\n\n  get isTemporary() {\n    const duration = this.duration.seconds ?? (this.duration.rounds || this.duration.turns) ?? 0;\n    return (\n      duration > 0 || this.statuses?.size || this.getFlag(\"core\", \"statusId\") || this.getFlag(\"ffd20\", \"show\") || false\n    );\n  }\n}\n","import { ActorPF } from \"./actor/actor-pf.mjs\";\nimport { getSkipActionPrompt } from \"./settings.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\n\n/* -------------------------------------------- */\n\n/**\n * This function is used to hook into the Chat Log context menu to add additional options to each message\n * These options make it easy to conveniently apply damage to controlled tokens based on the value of a Roll\n *\n * @param {HTMLElement} html    The Chat Message being rendered\n * @param {Array} options       The Array of Context Menu options\n * @returns {Array}              The extended options Array including new context choices\n */\nexport const addChatMessageContextOptions = function (html, options) {\n  const canApply = (li) => canvas.tokens.controlled.length && li.find(\".damage-roll .dice-total\").length;\n  const canApplyCritical = (li) => canvas.tokens.controlled.length && li.find(\".crit-damage-roll .dice-total\").length;\n  options.push(\n    {\n      name: game.i18n.localize(\"FFD20.ApplyDamage\"),\n      icon: '<i class=\"fas fa-user-minus\"></i>',\n      condition: canApply,\n      callback: (li) => ActorPF.applyDamage(li, 1),\n    },\n    {\n      name: game.i18n.localize(\"FFD20.ApplyHealing\"),\n      icon: '<i class=\"fas fa-user-plus\"></i>',\n      condition: canApply,\n      callback: (li) => ActorPF.applyDamage(li, -1),\n    },\n    {\n      name: game.i18n.localize(\"FFD20.ApplyCriticalDamage\"),\n      icon: '<i class=\"fas fa-user-minus\"></i>',\n      condition: canApplyCritical,\n      callback: (li) => ActorPF.applyDamage(li, 1, true),\n    },\n    {\n      name: game.i18n.localize(\"FFD20.ApplyCriticalHealing\"),\n      icon: '<i class=\"fas fa-user-minus\"></i>',\n      condition: canApplyCritical,\n      callback: (li) => ActorPF.applyDamage(li, -1, true),\n    }\n  );\n  return options;\n};\n\nconst duplicateCombatantInitiativeDialog = function (combats, combatantId) {\n  const combat = combats.find((c) => c.combatants.get(combatantId) !== undefined);\n  if (!combat) {\n    ui.notifications.warn(game.i18n.localize(\"FFD20.WarningNoCombatantFound\"));\n    return;\n  }\n  const combatant = combat.combatants.filter((o) => o.id === combatantId)[0];\n  if (!combatant) {\n    ui.notifications.warn(game.i18n.localize(\"FFD20.WarningNoCombatantFound\"));\n    return;\n  }\n\n  new Dialog(\n    {\n      title: `${game.i18n.localize(\"FFD20.DuplicateInitiative\")}: ${combatant.name}`,\n      content: `<div class=\"flexrow form-group\">\n      <label>${game.i18n.localize(\"FFD20.InitiativeOffset\")}</label>\n      <input type=\"number\" name=\"initiativeOffset\" value=\"0\"/>\n    </div>`,\n      buttons: {\n        confirm: {\n          label: game.i18n.localize(\"FFD20.Confirm\"),\n          callback: (html) => {\n            const offset = parseFloat(html.find('input[name=\"initiativeOffset\"]').val());\n            const prevInitiative = combatant.initiative != null ? combatant.initiative : 0;\n            const newInitiative = prevInitiative + offset;\n            duplicateCombatantInitiative(combat, combatant, newInitiative);\n          },\n        },\n        cancel: {\n          label: game.i18n.localize(\"Cancel\"),\n        },\n      },\n      default: \"confirm\",\n    },\n    {\n      classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"duplicate-initiative\"],\n    }\n  ).render(true);\n};\n\nexport const duplicateCombatantInitiative = function (combat, combatant, initiative) {\n  console.debug(\"Duplicating combatant:\", combatant);\n  combat.createEmbeddedDocuments(\"Combatant\", [\n    mergeObject(combatant.toObject(), { initiative: initiative }, { inplace: false }),\n  ]);\n};\n\nHooks.on(\"getCombatTrackerEntryContext\", function addCombatTrackerContextOptions(html, menuItems) {\n  menuItems.push({\n    name: \"FFD20.DuplicateInitiative\",\n    icon: '<i class=\"fas fa-dice-d20\"></i>',\n    callback: (li) => duplicateCombatantInitiativeDialog.call(game.combat, game.combats, li.data(\"combatant-id\")),\n  });\n});\n\nexport class CombatPF extends Combat {\n  /**\n   * @override\n   * @param {string[]} ids Combatant IDs to roll initiative for.\n   * @param {object} [options={}] - Additional options\n   * @param {string} [options.bonus=null] - Formula for bonus to initiative\n   * @param {string} [options.rollMode] - Roll mode override\n   * @param {boolean} [options.skipDialog=null] - Skip roll dialog\n   */\n  async rollInitiative(\n    ids,\n    { formula = null, bonus = null, rollMode, updateTurn = true, messageOptions = {}, skipDialog = null } = {}\n  ) {\n    skipDialog ??= getSkipActionPrompt();\n    // Structure input data\n    ids = typeof ids === \"string\" ? [ids] : ids;\n    const currentId = this.combatant?.id;\n\n    const firstCombatant = this.combatants.get(ids[0]);\n    const rollerName =\n      (ids.length > 1 ? firstCombatant?.actor?.name : firstCombatant?.token?.name) ?? firstCombatant?.name;\n\n    // Show initiative dialog\n    if (!skipDialog) {\n      const dialogData = await Combat.implementation.showInitiativeDialog({\n        formula,\n        bonus,\n        rollMode,\n        name: rollerName,\n      });\n      rollMode = dialogData.rollMode;\n      bonus = dialogData.bonus || \"\";\n      formula = dialogData.d20;\n      if (dialogData.stop) return this;\n    }\n\n    // Iterate over Combatants, performing an initiative roll for each\n    const [updates, messages] = await ids.reduce(\n      async (results, id, i) => {\n        const result = await results;\n        const [updates, messages] = result;\n\n        // Get Combatant data (non-strictly)\n        const combatant = this.combatants.get(id);\n        if (!combatant?.isOwner) return results;\n\n        // Produce an initiative roll for the Combatant\n        const roll = combatant.getInitiativeRoll(formula, bonus);\n        await roll.evaluate({ async: true });\n        updates.push({ _id: id, initiative: roll.total });\n\n        // Produce an initiative roll for the Combatant\n        const isHidden = combatant.token?.hidden || combatant.hidden;\n        if (isHidden) rollMode = messageOptions.rollMode ?? \"gmroll\";\n\n        if (roll.err) ui.notifications.warn(roll.err.message);\n\n        const [notes, notesHTML] = combatant.actor?.getInitiativeContextNotes?.() ?? [];\n\n        // Create card template data\n        const hasNotes = notes?.length > 0;\n        const templateData = {\n          user: game.user.id,\n          formula: roll.formula,\n          tooltip: await roll.getTooltip(),\n          total: roll.total,\n          hasExtraText: hasNotes,\n          extraText: hasNotes ? notesHTML : undefined,\n        };\n\n        // Ensure roll mode is not lost\n        if (rollMode) messageOptions.rollMode = rollMode;\n\n        // Create chat card data\n        const chatData = mergeObject(\n          {\n            user: game.user.id,\n            type: CONST.CHAT_MESSAGE_TYPES.ROLL,\n            sound: CONFIG.sounds.dice,\n            speaker: {\n              scene: combatant.sceneId,\n              actor: combatant.actorId,\n              token: combatant.tokenId,\n              alias: combatant.name,\n            },\n            flags: { ffd20: { subject: { core: \"init\" } } },\n            flavor: game.i18n.format(\"FFD20.RollsForInitiative\", { name: combatant.name }),\n            rolls: [roll.toJSON()],\n            content: await renderTemplate(\"systems/ffd20/templates/chat/roll-ext.hbs\", templateData),\n          },\n          messageOptions\n        );\n\n        // Handle different roll modes\n        ChatMessage.applyRollMode(chatData, rollMode);\n\n        if (i > 0) chatData.sound = null; // Only play 1 sound for the whole set\n        messages.push(chatData);\n\n        // Return the Roll and the chat data\n        return results;\n      },\n      [[], []]\n    );\n    if (!updates.length) return this;\n\n    // Update multiple combatants\n    await this.updateEmbeddedDocuments(\"Combatant\", updates);\n\n    // Ensure the turn order remains with the same combatant\n    if (updateTurn && currentId) await this.update({ turn: this.turns.findIndex((t) => t.id === currentId) });\n\n    // Create multiple chat messages\n    const chatMessages = await ChatMessage.implementation.create(messages);\n    return { combat: this, messages: chatMessages };\n  }\n\n  /**\n   * @param {object} options\n   * @param {string} options.formula Formula override\n   * @param {string} options.bonus Bonus formula override\n   * @param {string} options.name Name of the roller\n   * @returns {object}\n   */\n  static async showInitiativeDialog({ formula = null, bonus = null, name } = {}) {\n    const rollMode = game.settings.get(\"core\", \"rollMode\");\n\n    const template = \"systems/ffd20/templates/chat/roll-dialog.hbs\";\n    const dialogData = { d20: formula, bonus, rollMode, rollModes: CONFIG.Dice.rollModes };\n\n    // Show dialog\n    return Dialog.wait(\n      {\n        title: game.i18n.format(\"FFD20.InitiativeCheck\", { name }),\n        content: await renderTemplate(template, dialogData),\n        buttons: {\n          normal: {\n            label: game.i18n.localize(\"FFD20.Roll\"),\n            callback: (html) => new FormDataExtended(html.querySelector(\"form\")).object,\n          },\n        },\n        default: \"normal\",\n        close: (html) => ({ stop: true }),\n      },\n      {\n        subject: { core: \"init\" },\n        classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"roll-initiative\"],\n        jQuery: false,\n      },\n      {\n        focus: true,\n      }\n    );\n  }\n\n  /**\n   * Expire active effects & buffs.\n   *\n   * @param {object} data Update data\n   * @param {options} options Context options\n   * @param {string} userId Triggering user ID\n   */\n  async _expireEffectsOnUpdate(data, options, userId) {\n    if (data.turn === undefined && data.round === undefined) return;\n\n    const actor = this.combatant?.actor;\n    if (!actor) return;\n\n    const timeOffset = options.advanceTime ?? 0;\n\n    // Attempt to perform expiration on owning active user\n    const firstOwner = Object.entries(actor.ownership)\n      .filter(([_, level]) => level >= CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)\n      .map(([userId, _]) => game.users.get(userId))\n      .filter((u) => u?.active)\n      .sort((a, b) => a.id.localeCompare(b.id))[0];\n\n    if (firstOwner) {\n      if (firstOwner.id !== game.user.id) return;\n    } else if (!game.user.isGM) return;\n\n    actor.expireActiveEffects({ timeOffset, combat: this });\n  }\n\n  /**\n   * @override\n   * @param {object} data Update data\n   * @param {options} options Context options\n   * @param {string} userId Triggering user ID\n   */\n  _onUpdate(data, options, userId) {\n    super._onUpdate(data, options, userId);\n    try {\n      this._expireEffectsOnUpdate(data, options, userId);\n    } catch (error) {\n      console.error(error);\n    }\n  }\n}\n","import { RollPF } from \"module/dice/roll.mjs\";\n\n/**\n * Combatant extension.\n */\nexport class CombatantPF extends Combatant {\n  /**\n   * Combat tracker resource update.\n   * Required to deal with 0 values disappearing with core implementation\n   *\n   * Synchronized with Foundry 10.291\n   *\n   * @override\n   * @returns {*} Resource value.\n   */\n  updateResource() {\n    if (!this.actor || !this.combat) return (this.resource = null);\n    return (this.resource = foundry.utils.getProperty(this.actor.system, this.parent.settings.resource) ?? null);\n  }\n\n  /**\n   * Get unevaluated initiative roll instance.\n   *\n   * @override\n   * @param {string} [formula] Initiative formula override\n   * @param {number} [bonus=0] Bonus to initiative\n   * @returns {RollPF} Initiative roll instance\n   *\n   * Synchronized with Foundry VTT 10.291\n   */\n  getInitiativeRoll(formula, bonus = 0) {\n    formula ||= this._getInitiativeFormula();\n    const rollData = this.actor?.getRollData() || {};\n    if (bonus) {\n      rollData.bonus = bonus;\n      formula += \" + @bonus\";\n    }\n\n    return RollPF.create(formula, rollData);\n  }\n\n  /**\n   * Override the default Initiative formula to customize special behaviors of the game system.\n   * Apply tiebreaker if desired\n   * See Combat._getInitiativeFormula for more detail.\n   *\n   * @override\n   * @param {string} [d20=\"1d20\"] Default check roll\n   * @returns {string} Initiative formula\n   */\n  _getInitiativeFormula(d20) {\n    d20 ||= \"1d20\";\n    const defaultParts = [d20, `@attributes.init.total[${game.i18n.localize(\"FFD20.Initiative\")}]`];\n    const actor = this.actor;\n    if (actor && game.settings.get(\"ffd20\", \"initiativeTiebreaker\"))\n      defaultParts.push(`(@attributes.init.total / 100)[${game.i18n.localize(\"FFD20.Tiebreaker\")}]`);\n    const parts = CONFIG.Combat.initiative.formula ? CONFIG.Combat.initiative.formula.split(/\\s*\\+\\s*/) : defaultParts;\n    if (!actor) return parts[0] || \"0\";\n    return parts.filter((p) => p !== null).join(\" + \");\n  }\n}\n","/**\n * Transforms a key input into an array of objects for the keybinding API\n *\n * @param {string} key - A key string\n * @returns {{\"key\": string}[]} Keybinding objects\n */\nconst getLeftRight = (key) => [`${key}Left`, `${key}Right`].map((k) => ({ key: k }));\n\nconst SHIFT_KEYS = getLeftRight(\"Shift\");\nconst CTRL_KEYS = getLeftRight(\"Control\");\n\n/**\n * Registers the system's keybindings\n */\nexport const registerSystemControls = () => {\n  game.keybindings.register(\"ffd20\", \"skipConfirmPrompt\", {\n    name: \"FFD20.KEYBINDINGS.SkipConfirmPrompt.Name\",\n    uneditable: SHIFT_KEYS,\n    onDown: () => {\n      ffd20.skipConfirmPrompt = true;\n    },\n    onUp: () => {\n      ffd20.skipConfirmPrompt = false;\n    },\n  });\n\n  game.keybindings.register(\"ffd20\", \"forceShowItem\", {\n    name: \"FFD20.KEYBINDINGS.ForceShowItem.Name\",\n    hint: game.i18n.localize(\"FFD20.KEYBINDINGS.ForceShowItem.Hint\"),\n    uneditable: CTRL_KEYS,\n    onDown: () => {\n      ffd20.forceShowItem = true;\n    },\n    onUp: () => {\n      ffd20.forceShowItem = false;\n    },\n  });\n\n  game.keybindings.register(\"ffd20\", \"hideTokenTooltip\", {\n    name: \"FFD20.KEYBINDINGS.HideTokenTooltip.Name\",\n    hint: game.i18n.localize(\"FFD20.KEYBINDINGS.HideTokenTooltip.Hint\"),\n    uneditable: CTRL_KEYS,\n    onDown: () => ffd20.documents.controls._hideTokenTooltip(true),\n    onUp: () => ffd20.documents.controls._hideTokenTooltip(false),\n  });\n\n  game.keybindings.register(\"ffd20\", \"hideTokenTooltipGMInfo\", {\n    name: \"FFD20.KEYBINDINGS.HideTokenTooltipGMInfo.Name\",\n    uneditable: SHIFT_KEYS,\n    restricted: true,\n    onDown: () => ffd20.documents.controls._hideTokenTooltipGMInfo(true),\n    onUp: () => ffd20.documents.controls._hideTokenTooltipGMInfo(false),\n  });\n};\n\n/**\n * Toggle the display of GM/Player info in the token tooltip\n *\n * @param {boolean} keyDown - Whether the key is pressed down\n * @returns {Promise<void>|void} A Promise that is resolved when the tooltip render handling is done\n */\nexport const _hideTokenTooltipGMInfo = (keyDown) => {\n  if (!ffd20.tooltip) return;\n  ffd20.tooltip.forceHideGMInfo = keyDown;\n  return ffd20.tooltip?.refresh();\n};\n\n/**\n * Toggle the display of the token tooltip\n *\n * @param {boolean} keyDown - Whether the key is pressed down\n * @returns {Promise<void>|void} A Promise that is resolved when the tooltip render handling is done\n */\nexport const _hideTokenTooltip = (keyDown) => {\n  if (!ffd20.tooltip) return;\n  if (game.settings.get(\"ffd20\", \"tooltipConfig\")?.hideWithoutKey === true) ffd20.tooltip.forceHide = !keyDown;\n  else ffd20.tooltip.forceHide = keyDown;\n  return ffd20.tooltip?.refresh();\n};\n","export class TokenDocumentPF extends TokenDocument {\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    this._preCreateSetSize();\n  }\n\n  /**\n   * @override\n   * @param {object} changed\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    const flags = changed.flags?.ffd20;\n    if (flags) {\n      // Delete flags instead of turning them false\n      const deleteFlags = [\"staticSize\", \"disableLowLight\", \"customVisionRules\"];\n      for (const flag of deleteFlags) {\n        if (flags[flag] === false) {\n          flags[`-=${flag}`] = null;\n          delete flags[flag];\n        }\n      }\n    }\n  }\n\n  /**\n   * Handle actor size during token creation.\n   */\n  _preCreateSetSize() {\n    if (!this.actor) return;\n\n    // Apply token size\n    if (this.getFlag(\"ffd20\", \"staticSize\")) return;\n    const sizeConf = ffd20.config.tokenSizes[this.actor.system.traits?.size];\n    if (!sizeConf) return;\n\n    this.updateSource({\n      width: sizeConf.w,\n      height: sizeConf.h,\n      texture: {\n        scaleY: sizeConf.scale,\n        scaleX: sizeConf.scale,\n      },\n    });\n  }\n\n  // Todo: Declare this in TokenDocumentPF when/ if TokenDocument.getData calls the constructor's method\n  getTrackedAttributes(data, path = []) {\n    const attr = super.getTrackedAttributes(data, path);\n    if (path.length === 0) attr.value.push([\"attributes\", \"hp\", \"temp\"], [\"attributes\", \"hp\", \"nonlethal\"]);\n    return attr;\n  }\n\n  /**\n   * Hijack Token health bar rendering to include temporary and temp-max health in the bar display\n   *\n   * @param barName\n   * @param root0\n   * @param root0.alternative\n   */\n  getBarAttribute(barName, { alternative = null } = {}) {\n    let data;\n    try {\n      data = super.getBarAttribute(barName, { alternative: alternative });\n    } catch (e) {\n      data = null;\n    }\n\n    // Make resources editable\n    if (data?.attribute.startsWith(\"resources.\")) data.editable = true;\n\n    return data;\n  }\n\n  prepareBaseData() {\n    this.detectionModes = [];\n\n    this._syncSenses();\n\n    super.prepareBaseData();\n  }\n\n  /**\n   * Synchronize senses from actor.\n   */\n  _syncSenses() {\n    if (!this.actor) return;\n    if (this.getFlag(\"ffd20\", \"customVisionRules\")) return;\n    if (!this.sight.enabled) return;\n\n    // Get base range from source data\n    const baseRange = this._source.sight.range;\n\n    this.detectionModes = [];\n\n    this.sight.visionMode = \"basic\";\n\n    // Basic detection\n    const basicMode = { id: DetectionMode.BASIC_MODE_ID, enabled: true, range: baseRange };\n    this.detectionModes.push(basicMode);\n\n    const senses = this.actor?.system?.traits?.senses ?? {};\n\n    // Darkvision\n    const darkvision = senses.dv ?? 0;\n    if (darkvision > 0) {\n      this.sight.visionMode = \"darkvision\";\n      // Upgrade basic mode range if greater\n      basicMode.range = Math.max(baseRange, ffd20.utils.convertDistance(darkvision)[0]);\n    }\n\n    this.sight.range = Math.max(baseRange, basicMode.range);\n\n    // -----------------------\n    // See invisibility or Truesight\n    if (senses.si || senses.tr) {\n      this.detectionModes.push({ id: \"seeInvisibility\", enabled: true, range: basicMode.range });\n    }\n\n    // Tremor sense\n    if (senses.ts) {\n      this.detectionModes.push({ id: \"feelTremor\", enabled: true, range: senses.ts });\n    }\n\n    // Blind sense\n    if (senses.bse) {\n      this.detectionModes.push({ id: \"blindSense\", enabled: true, range: senses.bse });\n    }\n\n    // Blind sight\n    if (senses.bs) {\n      this.detectionModes.push({ id: \"blindSight\", enabled: true, range: senses.bs });\n    }\n\n    // Sort detection modes\n    this.detectionModes.sort(this.constructor._sortDetectionModes);\n\n    // Update vision advanced fields with current mode's defaults\n    const visionDefaults = CONFIG.Canvas.visionModes[this.sight.visionMode]?.vision?.defaults || {};\n    for (const fieldName of [\"attenuation\", \"brightness\", \"saturation\", \"contrast\"]) {\n      if (fieldName in visionDefaults) {\n        this.sight[fieldName] = visionDefaults[fieldName];\n      }\n    }\n  }\n\n  static _sortDetectionModes(a, b) {\n    if (a.id === DetectionMode.BASIC_MODE_ID) return -1;\n    if (b.id === DetectionMode.BASIC_MODE_ID) return 1;\n\n    const src = { a: CONFIG.Canvas.detectionModes[a.id], b: CONFIG.Canvas.detectionModes[b.id] };\n    return (src.a?.constructor.PRIORITY ?? 0) - (src.b?.constructor.PRIORITY ?? 0);\n  }\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\n\n/**\n * Basic actor with no built-in functionality.\n *\n * @deprecated Obsolete with Foundry v11\n */\nexport class BasicActorPF extends Actor {\n  constructor(...args) {\n    foundry.utils.logCompatibilityWarning(\"Basic actor type will be obsolete with Foundry v11\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v11\",\n    });\n    super(...args);\n  }\n\n  _resetInherentTotals() {}\n\n  _setSourceDetails() {}\n\n  prepareBaseData() {}\n\n  prepareDerivedData() {}\n\n  applyActiveEffects() {}\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\nexport class ActorCharacterPF extends ActorPF {\n  /**\n   * @override\n   * @param {object} data\n   * @param {object} context\n   * @param {User} user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const tokenUpdate = {};\n\n    // Link token data by default\n    if (data.prototypeToken?.actorLink === undefined) {\n      tokenUpdate.actorLink = true;\n    }\n\n    // Enable vision by default\n    if (game.settings.get(\"ffd20\", \"characterVision\") && data.prototypeToken?.sight?.enabled === undefined) {\n      tokenUpdate.sight = { enabled: true };\n    }\n\n    if (!foundry.utils.isEmpty(tokenUpdate)) {\n      this.prototypeToken.updateSource(tokenUpdate);\n    }\n  }\n\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    const actorData = this.system;\n\n    const maxExp = this.getLevelExp(actorData.details.level.value);\n    actorData.details.xp.max = maxExp;\n\n    if (!hasProperty(this, \"system.details.level.value\")) return;\n\n    // Experience bar\n    const prior = this.getLevelExp(actorData.details.level.value - 1 || 0),\n      max = this.getLevelExp(actorData.details.level.value || 1);\n\n    actorData.details.xp.pct =\n      ((Math.max(prior, Math.min(max, actorData.details.xp.value)) - prior) / (max - prior)) * 100 || 0;\n  }\n\n  _updateExp(updateData) {\n    const xpData = updateData.details?.xp;\n    if (xpData?.value == undefined) return;\n\n    // Get total level\n    const classes = this.items.filter((o) => o.type === \"class\");\n    const level = classes.filter((o) => o.system.subType !== \"mythic\").reduce((cur, o) => cur + o.system.level, 0);\n\n    const oldData = this.system;\n\n    // Translate update exp value to number\n    let newExp = xpData.value,\n      resetExp = false;\n    if (typeof newExp === \"string\") {\n      const curExp = Number(oldData.details.xp.value);\n      if (newExp.match(/^\\+([0-9]+)$/)) {\n        newExp = curExp + parseInt(RegExp.$1);\n      } else if (newExp.match(/^-([0-9]+)$/)) {\n        newExp = curExp - parseInt(RegExp.$1);\n      } else if (newExp === \"\") {\n        resetExp = true;\n      } else if (newExp.match(/^([0-9]+)$/)) {\n        newExp = parseInt(newExp);\n      } else {\n        newExp = curExp;\n      }\n\n      xpData.value = newExp;\n    }\n    const maxExp = this.getLevelExp(level);\n    xpData.max = maxExp;\n\n    if (resetExp) {\n      const minExp = level > 0 ? this.getLevelExp(level - 1) : 0;\n      xpData.value = minExp;\n    }\n  }\n\n  /**\n   * Return the amount of experience required to gain a certain character level.\n   *\n   * @param level {number}  The desired level\n   * @returns {number}       The XP required\n   */\n  getLevelExp(level) {\n    const expConfig = game.settings.get(\"ffd20\", \"experienceConfig\");\n    const expTrack = expConfig.track;\n    // Preset experience tracks\n    if ([\"fast\", \"medium\", \"slow\"].includes(expTrack)) {\n      const levels = ffd20.config.CHARACTER_EXP_LEVELS[expTrack];\n      return levels[Math.min(level, levels.length - 1)];\n    }\n    // Custom formula experience track\n    let totalXP = 0;\n    if (expConfig.custom.formula.length > 0) {\n      for (let a = 0; a < level; a++) {\n        const rollData = this.getRollData();\n        rollData.level = a + 1;\n        const roll = RollPF.safeRoll(expConfig.custom.formula, rollData);\n        totalXP += roll.total;\n      }\n    }\n    return Math.max(1, totalXP);\n  }\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\nexport class ActorNPCPF extends ActorPF {\n  prepareBaseData() {\n    super.prepareBaseData();\n    this.system.details.cr.total = this.getCR(this.system);\n\n    // Add base initiative (for NPC Lite sheets)\n    this.system.attributes.init.total = this.system.attributes.init.value;\n  }\n\n  prepareSpecificDerivedData() {\n    super.prepareSpecificDerivedData();\n\n    // Reset CR\n    setProperty(this.system, \"details.cr.total\", this.getCR());\n\n    // Reset experience value\n    let newXP = 0;\n    try {\n      const crTotal = this.system.details?.cr?.total || 0;\n      newXP = this.getCRExp(crTotal);\n    } catch (e) {\n      newXP = this.getCRExp(1);\n    }\n    setProperty(this.system, \"details.xp.value\", newXP);\n  }\n\n  hasArmorProficiency(item, proficiencyName) {\n    // Assume NPCs to be proficient with their armor\n    return game.settings.get(\"ffd20\", \"npcProficiencies\") ? super.hasArmorProficiency(item, proficiencyName) : true;\n  }\n\n  /* Not used by NPCs */\n  _updateExp() {}\n\n  /**\n   * Get challegne rating.\n   * Applies CR offset modifications from templates.\n   *\n   * @returns {number}\n   */\n  getCR() {\n    const base = this.system.details?.cr?.base ?? 0;\n\n    // Gather CR from templates\n    const templates = this.items.filter((item) => item.type === \"feat\" && item.subType === \"template\" && item.isActive);\n\n    return templates.reduce((cur, item) => {\n      const crOffset = item.system.crOffset;\n      if (crOffset) {\n        cur += RollPF.safeRoll(crOffset, item.getRollData()).total;\n      }\n      return cur;\n    }, base);\n  }\n\n  /**\n   * Return the amount of experience granted by killing a creature of a certain CR.\n   *\n   * @param cr {null | number}     The creature's challenge rating\n   * @returns {number}       The amount of experience granted per kill\n   */\n  getCRExp(cr) {\n    if (cr < 1.0) return Math.max(400 * cr, 0);\n    return ffd20.config.CR_EXP_LEVELS[cr];\n  }\n}\n","import { degtorad, measureDistance } from \"../utils/lib.mjs\";\n\nconst withinAngle = (min, max, value) => {\n  min = Math.normalizeDegrees(min);\n  max = Math.normalizeDegrees(max);\n  value = Math.normalizeDegrees(value);\n\n  if (min < max) return value >= min && value <= max;\n  return value >= min || value <= max;\n};\n\nconst withinRect = (point, rect) => {\n  return point.x >= rect.x && point.x < rect.x + rect.width && point.y >= rect.y && point.y < rect.y + rect.height;\n};\n\n/**\n * Applies patches to core functions to integrate Pathfinder specific measurements.\n */\nexport class TemplateLayerPF extends TemplateLayer {\n  // Foundry does not respect CONFIG.MeasuredTemplate.documentClass and CONFIG.MeasuredTemplate.objectClass\n  async _onDragLeftStart(event) {\n    if (!game.settings.get(\"ffd20\", \"measureStyle\")) return super._onDragLeftStart(event);\n\n    const v11 = game.release.generation >= 11; // for v10/v11 cross-compatibility\n\n    const interaction = v11 ? event.interactionData : event.data;\n\n    // Call placeables layer super instead of templatelayer\n    await PlaceablesLayer.prototype._onDragLeftStart.call(this, event);\n\n    const { origin } = interaction;\n\n    // Snap to grid\n    if (!event.shiftKey) {\n      const pos = canvas.grid.getSnappedPosition(origin.x, origin.y, this.gridPrecision);\n      origin.x = pos.x;\n      origin.y = pos.y;\n    }\n\n    // Create a pending MeasuredTemplateDocument\n    const tool = game.activeTool;\n    const previewData = {\n      user: game.user.id,\n      t: tool,\n      x: origin.x,\n      y: origin.y,\n      distance: 1,\n      direction: 0,\n      fillColor: game.user.color || \"#FF0000\",\n      hidden: event.altKey,\n    };\n\n    // Apply some type-specific defaults\n    const defaults = CONFIG.MeasuredTemplate.defaults;\n    if (tool === \"cone\") previewData.angle = defaults.angle;\n    else if (tool === \"ray\") previewData.width = defaults.width * canvas.dimensions.distance;\n\n    const cls = getDocumentClass(\"MeasuredTemplate\");\n    const doc = new cls(previewData, { parent: canvas.scene });\n\n    // Create a preview template\n    const template = new CONFIG.MeasuredTemplate.objectClass(doc);\n    interaction.preview = this.preview.addChild(template);\n    return template.draw();\n  }\n\n  _onDragLeftMove(event) {\n    if (!game.settings.get(\"ffd20\", \"measureStyle\")) return super._onDragLeftMove(event);\n\n    const v11 = game.release.generation >= 11; // for v10/v11 cross-compatibility\n\n    const interaction = v11 ? event.interactionData : event.data;\n    const { destination, preview, origin } = interaction;\n    const layerDragState = v11 ? interaction.layerDragState : interaction.createState;\n\n    if (layerDragState === 0) return;\n\n    // Snap the destination to the grid\n    const snapToGrid = !event.shiftKey;\n    if (snapToGrid) {\n      interaction.destination = canvas.grid.getSnappedPosition(destination.x, destination.y, this.gridPrecision);\n    }\n\n    // Compute the ray\n    const ray = new Ray(origin, destination);\n    const dist = canvas.dimensions.distance;\n    const ratio = canvas.dimensions.size / dist;\n\n    // Update the preview object\n    const type = preview.document.t;\n    const cellSize = canvas.dimensions.distance;\n    // Set direction\n    const baseDirection = Math.normalizeDegrees(Math.toDegrees(ray.angle));\n    if (snapToGrid && [\"cone\", \"circle\"].includes(type)) {\n      const halfAngle = CONFIG.MeasuredTemplate.defaults.angle / 2;\n      preview.document.direction = Math.floor((baseDirection + halfAngle / 2) / halfAngle) * halfAngle;\n    } else if (snapToGrid && type === \"ray\") {\n      preview.document.direction = Math.floor((baseDirection + cellSize / 2) / cellSize) * cellSize;\n    } else {\n      preview.document.direction = baseDirection;\n    }\n    // Set distance\n    const baseDistance = ray.distance / ratio;\n    if (snapToGrid && [\"cone\", \"circle\", \"ray\"].includes(type)) {\n      preview.document.distance = Math.floor(baseDistance / dist) * dist;\n    } else {\n      preview.document.distance = baseDistance;\n    }\n\n    if (v11) preview.renderFlags.set({ refreshShape: true });\n    else preview.refresh();\n\n    // Confirm the creation state\n    if (v11) interaction.layerDragState = 2;\n    else interaction.createState = 2;\n  }\n}\n\nexport class MeasuredTemplatePF extends MeasuredTemplate {\n  getHighlightedSquares() {\n    if (!this.id || !this.shape) return [];\n\n    const templateType = this.document.t;\n    if (!game.settings.get(\"ffd20\", \"measureStyle\") || ![\"circle\", \"cone\", \"ray\"].includes(templateType)) return [];\n\n    const grid = canvas.grid,\n      // Size of each cell in pixels\n      gridSizePxBase = canvas.dimensions.size,\n      // Offset for uneven grids\n      gridSizePxOffset = gridSizePxBase % 2,\n      // Final grid size\n      gridSizePx = gridSizePxBase + gridSizePxOffset,\n      gridSizeUnits = canvas.dimensions.distance; // feet, meters, etc.\n\n    const templateDirection = this.document.direction,\n      templateAngle = this.document.angle;\n\n    // Parse rays as per Bresenham's algorithm\n    if (templateType === \"ray\") {\n      const result = [];\n\n      const line = (x0, y0, x1, y1) => {\n        x0 = Math.floor(Math.floor(x0) / gridSizePx);\n        x1 = Math.floor(Math.floor(x1) / gridSizePx);\n        y0 = Math.floor(Math.floor(y0) / gridSizePx);\n        y1 = Math.floor(Math.floor(y1) / gridSizePx);\n\n        const dx = Math.abs(x1 - x0);\n        const dy = Math.abs(y1 - y0);\n        const sx = x0 < x1 ? 1 : -1;\n        const sy = y0 < y1 ? 1 : -1;\n        let err = dx - dy;\n\n        while (!(x0 === x1 && y0 === y1)) {\n          result.push({ x: x0 * gridSizePx, y: y0 * gridSizePx });\n          const e2 = err << 1;\n          if (e2 > -dy) {\n            err -= dy;\n            x0 += sx;\n          }\n          if (e2 < dx) {\n            err += dx;\n            y0 += sy;\n          }\n        }\n      };\n\n      // Extend ray by half a square for better highlight calculation\n      const ray = Ray.fromAngle(this.ray.A.x, this.ray.A.y, this.ray.angle, this.ray.distance + gridSizePx / 2);\n\n      // Get resulting squares\n      line(ray.A.x, ray.A.y, ray.B.x, ray.B.y);\n\n      return result;\n    }\n\n    // Get number of rows and columns\n    const nr = Math.ceil((this.document.distance * 1.5) / gridSizeUnits / (gridSizePx / grid.h)),\n      nc = Math.ceil((this.document.distance * 1.5) / gridSizeUnits / (gridSizePx / grid.w));\n\n    // Get the center of the grid position occupied by the template\n    const { x, y } = this.document;\n\n    const [cx, cy] = grid.getCenter(x, y),\n      [col0, row0] = grid.grid.getGridPositionFromPixels(cx, cy),\n      minAngle = Math.normalizeDegrees(templateDirection - templateAngle / 2),\n      maxAngle = Math.normalizeDegrees(templateDirection + templateAngle / 2);\n\n    // Origin offset multiplier\n    const offsetMult = { x: 0, y: 0 };\n    // Offset measurement for cones\n    // Offset is to ensure that cones only start measuring from cell borders, as in https://www.d20pfsrd.com/magic/#Aiming_a_Spell\n    if (templateType === \"cone\") {\n      // Degrees anticlockwise from pointing right. In 45-degree increments from 0 to 360\n      const dir = (templateDirection >= 0 ? 360 - templateDirection : -templateDirection) % 360;\n      // If we're not on a border for X, offset by 0.5 or -0.5 to the border of the cell in the direction we're looking on X axis\n      // /2 turns from 1/0/-1 to 0.5/0/-0.5\n      offsetMult.x = x % gridSizePxBase != 0 ? Math.sign(Math.round(Math.cos(degtorad(dir)))) / 2 : 0;\n      // Same for Y, but cos Y goes down on screens, we invert\n      offsetMult.y = y % gridSizePxBase != 0 ? -Math.sign(Math.round(Math.sin(degtorad(dir)))) / 2 : 0;\n    }\n\n    const result = [];\n    for (let a = -nc; a < nc; a++) {\n      for (let b = -nr; b < nr; b++) {\n        // Position of cell's top-left corner, in pixels\n        const [gx, gy] = canvas.grid.grid.getPixelsFromGridPosition(col0 + a, row0 + b);\n        // Position of cell's center, in pixels\n        const [cellCenterX, cellCenterY] = [gx + gridSizePx * 0.5, gy + gridSizePx * 0.5];\n\n        // Determine point of origin\n        const origin = {\n          x: x + offsetMult.x * gridSizePxBase,\n          y: y + offsetMult.y * gridSizePxBase,\n        };\n\n        // Determine point we're measuring the distance to - always in the center of a grid square\n        const destination = { x: cellCenterX, y: cellCenterY };\n\n        if (templateType === \"cone\") {\n          const ray = new Ray(origin, destination);\n          const rayAngle = Math.normalizeDegrees(ray.angle / (Math.PI / 180));\n          if (ray.distance > 0 && !withinAngle(minAngle, maxAngle, rayAngle)) {\n            continue;\n          }\n        }\n\n        const distance = measureDistance(destination, origin);\n        if (distance <= this.document.distance) {\n          result.push({ x: gx, y: gy });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Determine tokens residing within the template bounds, based on either grid higlight logic or token center.\n   *\n   * @public\n   * @returns {Token[]} Tokens sufficiently within the template.\n   */\n  getTokensWithin() {\n    const shape = this.document.t,\n      dimensions = this.scene.dimensions,\n      gridSizePx = dimensions.size,\n      gridSizeUnits = dimensions.distance;\n\n    const maxDistance = Math.max(this.height, this.width);\n    // Get tokens within max potential distance from the template\n    const relevantTokens = new Set(\n      canvas.tokens.placeables.filter((t) => new Ray(t.center, this.center).distance + t.sizeErrorMargin <= maxDistance)\n    );\n\n    const result = new Set();\n    // Special handling for gridless\n    if (canvas.grid.type === CONST.GRID_TYPES.GRIDLESS && [\"circle\", \"cone\", \"rect\"].includes(shape)) {\n      // TODO: Test against vision points and ensure ~third of them are inside the template instead.\n      // BUG: Behaves incorrectly with large tokens\n      for (const t of relevantTokens) {\n        switch (shape) {\n          case \"circle\": {\n            const ray = new Ray(this.center, t.center);\n            // Calculate ray length in relation to circle radius\n            const raySceneLength = (ray.distance / gridSizePx) * gridSizeUnits;\n            // Include this token if its center is within template radius\n            if (raySceneLength <= this.document.distance) result.add(t);\n            break;\n          }\n          case \"cone\": {\n            const templateDirection = this.document.direction;\n            const templateAngle = this.document.angle,\n              minAngle = Math.normalizeDegrees(templateDirection - templateAngle / 2),\n              maxAngle = Math.normalizeDegrees(templateDirection + templateAngle / 2);\n\n            const ray = new Ray(this.center, t.center);\n            const rayAngle = Math.normalizeDegrees(Math.toDegrees(ray.angle));\n\n            const rayWithinAngle = withinAngle(minAngle, maxAngle, rayAngle);\n            // Calculate ray length in relation to circle radius\n            const raySceneLength = (ray.distance / gridSizePx) * gridSizeUnits;\n            // Include token if its within template distance and within the cone's angle\n            if (rayWithinAngle && raySceneLength <= this.document.distance) result.add(t);\n            break;\n          }\n          case \"rect\": {\n            const rect = {\n              x: this.x,\n              y: this.y,\n              width: this.width,\n              height: this.width,\n            };\n            if (withinRect(t.center, rect)) result.add(t);\n            break;\n          }\n        }\n      }\n    }\n    // Non-gridless\n    else {\n      const highlightSquares = this.getHighlightLayer().positions.map((p) => {\n        const [x, y] = p.split(\".\");\n        return { x: Number(x), y: Number(y), width: gridSizePx, height: gridSizePx };\n      });\n\n      for (const square of highlightSquares) {\n        for (const t of relevantTokens) {\n          if (withinRect(t.center, square)) {\n            result.add(t);\n            relevantTokens.delete(t);\n          }\n        }\n      }\n    }\n\n    return Array.from(result);\n  }\n\n  // Highlight grid in PF1 style\n  highlightGrid() {\n    if (\n      !game.settings.get(\"ffd20\", \"measureStyle\") ||\n      ![\"circle\", \"cone\", \"ray\"].includes(this.document.t) ||\n      canvas.grid.type !== CONST.GRID_TYPES.SQUARE\n    )\n      return super.highlightGrid();\n\n    const grid = canvas.grid,\n      bc = this.borderColor,\n      fc = this.fillColor;\n\n    // Only highlight for objects which have a defined shape\n    if (!this.id || !this.shape) return;\n\n    // Clear existing highlight\n    const hl = this.getHighlightLayer();\n    hl.clear();\n    if (!this.isVisible) return;\n\n    // Get grid squares to highlight\n    const highlightSquares = this.getHighlightedSquares();\n    for (const s of highlightSquares) {\n      grid.grid.highlightGridPosition(hl, { x: s.x, y: s.y, color: fc, border: bc });\n    }\n  }\n\n  getHighlightLayer() {\n    return canvas.grid.getHighlightLayer(this.highlightId);\n  }\n}\n","import Color from \"color\";\nimport { colorToInt, convertDistance, measureDistance, calculateRangeFormula } from \"../utils/lib.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\n\nconst rangeColor = {\n  fill: Color(\"#ff0000\"),\n  border: Color(\"#ff0000\").darken(0.1),\n};\nconst reachColor = {\n  fill: Color(\"#ffff00\"),\n  border: Color(\"#ffff00\").darken(0.1),\n};\n\nexport class SquareHighlight {\n  constructor(origin, fillColor = 0x00ff00, borderColor = 0x000000) {\n    this.origin = origin;\n    this.borderColor = borderColor;\n    this.fillColor = fillColor;\n    this._squares = [];\n\n    this._id = randomID();\n\n    canvas.grid.addHighlightLayer(`AttackHighlight.${this._id}`);\n  }\n\n  addSquare(x, y) {\n    this._squares.push({ x: x, y: y });\n  }\n\n  clear(permanent = false) {\n    const hl = canvas.grid.getHighlightLayer(`AttackHighlight.${this._id}`);\n    if (!hl) return;\n    hl.clear();\n\n    if (permanent) canvas.grid.destroyHighlightLayer(`AttackHighlight.${this._id}`);\n  }\n\n  render() {\n    const grid = canvas.grid;\n    const gridSize = grid.size;\n    const hl = canvas.grid.getHighlightLayer(`AttackHighlight.${this._id}`);\n\n    this.clear();\n\n    // Highlight squares\n    for (const s of this._squares) {\n      const x = Math.floor(this.origin.x - s.x) * gridSize;\n      const y = Math.floor(this.origin.y - s.y) * gridSize;\n      grid.grid.highlightGridPosition(hl, { x: x, y: y, border: this.borderColor, color: this.fillColor });\n    }\n  }\n}\n\n/**\n * @typedef {object} AttackReachHighlight\n * An object containing highlights belonging to a specific attack\n * @property {SquareHighlight} normal - Highlight for normal range\n * @property {SquareHighlight} reach - Highlight for reach range\n * @property {SquareHighlight[]} extra - Additional highlights\n */\n\n/** @type {AttackReachHighlight|undefined} */\nlet currentHighlight;\n\n/**\n * Calculates the {@link AttackReachHighlight} for a token's attack.\n *\n * @param {Token} token - The token to calculate the attack reach for\n * @param {import(\"../documents/item/item-pf.mjs\").ItemPF} attack - The attack to calculate the reach for\n * @param {import(\"../components/action.mjs\").ItemAction} action - The action to calculate the reach for\n * @returns {AttackReachHighlight | undefined} Highlights for this attack, if any\n */\nconst getAttackReach = function (token, attack, action) {\n  const grid = canvas.grid;\n  const gridSize = grid.size;\n  const tw = token.document.width;\n  const th = token.document.height;\n  const origin = {\n    x: Math.floor((token.x + tw * gridSize - 0.5 * gridSize) / gridSize),\n    y: Math.floor((token.y + th * gridSize - 0.5 * gridSize) / gridSize),\n  };\n\n  if (!action) return;\n  const rollData = action.getRollData();\n\n  // Determine whether reach\n  const rangeKey = action.data.range.units;\n  if (![\"melee\", \"touch\", \"reach\", \"ft\", \"close\", \"medium\"].includes(rangeKey)) return;\n  const isReach = rangeKey === \"reach\";\n  const range = rollData.range;\n\n  // Determine minimum range\n  const minRangeKey = action.data.range.minUnits;\n  let minRange = null;\n  if ([\"melee\", \"touch\"].includes(minRangeKey)) minRange = range.melee;\n  if (minRangeKey === \"reach\") minRange = range.reach;\n  if (minRangeKey === \"ft\") {\n    minRange = RollPF.safeRoll(action.data.range.minValue || \"0\", rollData).total;\n  }\n\n  const squares = {\n    normal: [],\n    reach: [],\n    extra: [],\n  };\n  const useReachRule = game.settings.get(\"ffd20\", \"alternativeReachCornerRule\") !== true;\n\n  if ([\"melee\", \"touch\", \"reach\"].includes(rangeKey)) {\n    squares.normal = getReachSquares(token, range.melee, minRange, null, { useReachRule });\n    squares.reach = getReachSquares(token, range.reach, range.melee, null, { useReachRule });\n  } else if (rangeKey === \"ft\") {\n    const r = calculateRangeFormula(action.data.range.value || \"0\", \"ft\", rollData);\n    squares.normal = getReachSquares(token, r, minRange, null, { useReachRule: true });\n\n    // Add range increments\n    const maxSquareRange = Math.min(\n      60, // arbitrary limit to enhance performance on large canvases\n      Math.max(\n        (canvas.dimensions.width / canvas.dimensions.size) * canvas.dimensions.distance,\n        (canvas.dimensions.height / canvas.dimensions.size) * canvas.dimensions.distance\n      ) + convertDistance(r)[0]\n    );\n    const rangeIncrements = action.data.range.maxIncrements;\n    for (let a = 1; a < rangeIncrements; a++) {\n      if ((a + 1) * convertDistance(r)[0] <= maxSquareRange) {\n        squares.extra.push(getReachSquares(token, (a + 1) * r, a * r, null, { useReachRule }));\n      }\n    }\n  } else if ([\"close\", \"medium\"].includes(rangeKey) && attack.type === \"spell\") {\n    const range = calculateRangeFormula(null, rangeKey, rollData);\n    squares.normal = getReachSquares(token, range, minRange, null, { useReachRule });\n  }\n\n  const result = {\n    normal: new SquareHighlight(origin, colorToInt(rangeColor.fill), colorToInt(rangeColor.border)),\n    reach: new SquareHighlight(origin, colorToInt(reachColor.fill), colorToInt(reachColor.border)),\n    extra: [],\n  };\n  for (const s of squares.normal) {\n    result.normal.addSquare(s[0], s[1]);\n  }\n  if (isReach) {\n    for (const s of squares.reach) {\n      result.reach.addSquare(s[0], s[1]);\n    }\n  }\n\n  // Add extra range squares\n  {\n    for (let a = 0; a < squares.extra.length; a++) {\n      const squaresExtra = squares.extra[a];\n\n      const color = {\n        fill: a % 2 === 1 ? rangeColor.fill : reachColor.fill,\n        border: a % 2 === 1 ? rangeColor.border : reachColor.border,\n      };\n\n      const hl = new SquareHighlight(origin, colorToInt(color.fill), colorToInt(color.border));\n      for (const s of squaresExtra) {\n        hl.addSquare(s[0], s[1]);\n      }\n      result.extra.push(hl);\n    }\n  }\n\n  return result;\n};\n\n/**\n * Calculates and renders the {@link AttackReachHighlight} for a token's attack.\n * If a highlight already exists, it will be removed.\n *\n * @param {Token} token - The token to calculate the attack reach for\n * @param {import(\"../documents/item/item-pf.mjs\").ItemPF} attack - The attack to calculate the reach for\n * @param {import(\"../components/action.mjs\").ItemAction} action - The action to calculate the reach for\n */\nexport const showAttackReach = function (token, attack, action) {\n  // Clear previous highlight\n  clearHighlight();\n\n  const highlight = getAttackReach(token, attack, action);\n\n  // If a highlight could be created, make it the current highlight and render it\n  if (!highlight) return;\n  currentHighlight = highlight;\n  renderHighlight();\n};\n\nexport const clearHighlight = function () {\n  if (currentHighlight) {\n    currentHighlight.normal.clear();\n    currentHighlight.reach.clear();\n    for (const h of currentHighlight.extra) {\n      h.clear();\n    }\n    currentHighlight = undefined;\n  }\n};\n\nconst renderHighlight = function () {\n  if (currentHighlight) {\n    currentHighlight.normal.render();\n    currentHighlight.reach.render();\n    for (const h of currentHighlight.extra) {\n      h.render();\n    }\n  }\n};\n\n/**\n * Returns a token belonging to either an actor's UUID or a token's UUID\n *\n * @async\n * @param {string} uuid - UUID of an actor or token\n * @returns {Promise<Token|null>} A Token, if one can be found\n */\nconst _getTokenByUuid = async function (uuid) {\n  if (!uuid) return;\n  /** @type {TokenDocument | Actor} */\n  const actor = await fromUuid(uuid);\n  if (actor instanceof TokenDocument) return actor.object;\n  return actor?.token ?? (actor != null ? canvas.tokens.placeables.find((o) => o.actor === actor) : null);\n};\n\n/**\n * Add listeners on the {@link ChatLog}'s HTML element, checking for hover events involving\n * chat cards' range element using event delegation.\n *\n * @param {JQuery<HTMLElement>} html - The chat log\n */\nexport function addReachListeners(html) {\n  html.on(\"mouseenter\", \".card-range\", onMouseEnterReach);\n  html.on(\"mouseleave\", \".card-range\", onMouseLeaveReach);\n}\n\n/**\n * Handle display of reach when a chat card's reach element is hovered\n *\n * @param {JQuery.MouseEnterEvent<HTMLElement>} event - A `mouseEnter` event\n */\nconst onMouseEnterReach = (event) => {\n  event.preventDefault();\n\n  const reachElement = event.currentTarget;\n  const card = reachElement.closest(\".chat-card\");\n  const { tokenUuid, actionId, itemId } = card.dataset;\n  if (!(itemId && actionId && tokenUuid)) return;\n\n  _getTokenByUuid(tokenUuid).then((token) => {\n    if (!token) return;\n    const item = token.actor.allItems.find((item) => item.id === itemId);\n    if (!item) return;\n    if (!game.settings.get(\"ffd20\", \"hideReachMeasurements\")) showAttackReach(token, item, item.actions.get(actionId));\n  });\n};\n\n/**\n * Handle clearing of reach highlights created by {@link onMouseEnterReach}\n *\n * @param {JQuery.MouseLeaveEvent} event - A `mouseLeave` event\n */\nconst onMouseLeaveReach = (event) => {\n  event.preventDefault();\n  clearHighlight();\n};\n\nconst getReachSquares = function (token, range, minRange = 0, addSquareFunction = null, options) {\n  range = convertDistance(range)[0];\n  if (typeof minRange === \"number\") minRange = convertDistance(minRange)[0];\n\n  const result = [];\n\n  if (canvas.grid.type !== CONST.GRID_TYPES.SQUARE) return result;\n  if (!addSquareFunction) addSquareFunction = shouldAddReachSquare;\n\n  // Initialize variables\n  const gridDist = canvas.scene.grid.distance;\n  const gridSize = canvas.grid.size;\n\n  // Determine token squares\n  const tokenSquares = [];\n  for (let a = 0; a < Math.floor(token.w / gridSize); a++) {\n    for (let b = 0; b < Math.floor(token.h / gridSize); b++) {\n      const x = Math.floor((token.x + gridSize * 0.5) / gridSize + a);\n      const y = Math.floor((token.y + gridSize * 0.5) / gridSize + b);\n      tokenSquares.push([x, y]);\n    }\n  }\n\n  // Determine token-based variables\n  const tokenRect = [\n    Math.floor((token.x + gridSize * 0.5) / gridSize),\n    Math.floor((token.y + gridSize * 0.5) / gridSize),\n    Math.floor(token.w / gridSize),\n    Math.floor(token.h / gridSize),\n  ];\n\n  // Create function to determine closest token square\n  const getClosestTokenSquare = function (pos) {\n    const lowest = { square: null, dist: null };\n    for (const s of tokenSquares) {\n      const dist = Math.sqrt((s[0] - pos[0]) ** 2 + (s[1] - pos[1]) ** 2);\n      if (lowest.dist == null || dist < lowest.dist) {\n        lowest.square = s;\n        lowest.dist = dist;\n      }\n    }\n\n    return lowest.square;\n  };\n\n  // Gather potential squares\n  const squareRange = Math.round(range / gridDist);\n  const wMax = squareRange * 2 + tokenRect[2];\n  const hMax = squareRange * 2 + tokenRect[3];\n  const tl = [tokenRect[0] - squareRange, tokenRect[1] - squareRange];\n  for (let a = tl[0]; a < tl[0] + wMax; a++) {\n    for (let b = tl[1]; b < tl[1] + hMax; b++) {\n      const closestSquare = getClosestTokenSquare([a, b]);\n\n      const offset = [a - tokenRect[0], b - tokenRect[1]];\n      if (\n        !(\n          a >= tokenRect[0] &&\n          a < tokenRect[0] + tokenRect[2] &&\n          b >= tokenRect[1] &&\n          b < tokenRect[1] + tokenRect[2] &&\n          minRange != null\n        )\n      ) {\n        if (addSquareFunction(token, [a, b], closestSquare, range, minRange, tokenRect, options)) {\n          result.push(offset);\n        }\n      }\n    }\n  }\n\n  return result;\n};\n\nconst shouldAddReachSquare = function (\n  token,\n  pos,\n  closestTokenSquare,\n  range,\n  minRange,\n  tokenRect,\n  options = { useReachRule: false }\n) {\n  const gridDist = canvas.scene.grid.distance;\n  const gridSize = canvas.grid.size;\n  const p0 = { x: closestTokenSquare[0] * gridSize, y: closestTokenSquare[1] * gridSize };\n  const p1 = { x: pos[0] * gridSize, y: pos[1] * gridSize };\n\n  const dist = measureDistance(p0, p1);\n  const dist2 = options.useReachRule ? measureDistance(p0, p1, { diagonalRule: \"555\" }) : null;\n  const reachRuleRange = convertDistance(10)[0];\n  if (dist > range) {\n    // Special rule for 10-ft. reach\n    if (!(options.useReachRule && range === reachRuleRange)) {\n      return false;\n    }\n  }\n\n  if (minRange != null && dist <= minRange) {\n    return false;\n  }\n\n  // Special rule for minimum ranges >= 10-ft.\n  if (options.useReachRule && minRange >= reachRuleRange && dist2 <= reachRuleRange) {\n    return false;\n  }\n\n  return true;\n};\n","import { hasTokenVision } from \"../applications/vision-permission.mjs\";\n\nexport class TokenPF extends Token {\n  async toggleEffect(effect, { active, overlay = false, midUpdate } = {}) {\n    let call;\n    if (typeof effect == \"string\") {\n      const buffItem = this.actor.items.get(effect);\n      if (buffItem) {\n        call = await buffItem.setActive(!buffItem.isActive);\n      } else call = await super.toggleEffect(effect, { active, overlay });\n    } else if (effect && !midUpdate && Object.keys(ffd20.config.conditions).includes(effect.id)) {\n      const updates = {};\n      updates[\"system.attributes.conditions.\" + effect.id] = !this.actor.system.attributes.conditions[effect.id];\n      call = await this.actor.update(updates);\n    } else if (effect) {\n      call = await super.toggleEffect(effect, { active, overlay });\n    }\n    if (this.hasActiveHUD) canvas.tokens.hud.refreshStatusIcons();\n    return call;\n  }\n\n  get actorVision() {\n    const ll = this.actor.system.traits?.senses?.ll ?? {};\n    return {\n      lowLight: ll.enabled,\n      lowLightMultiplier: ll.multiplier?.dim,\n      lowLightMultiplierBright: ll.multiplier?.bright,\n    };\n  }\n\n  get disableLowLight() {\n    return this.document.getFlag(\"ffd20\", \"disableLowLight\") === true;\n  }\n\n  // Token#observer patch to make use of vision permission settings\n  get observer() {\n    return game.user.isGM || hasTokenVision(this);\n  }\n\n  /**\n   * @param {object} data         Resource data for this bar\n   * @returns {number|null}       The number to boost the bar by, if any.\n   * @protected\n   */\n  _getBarBoost(data) {\n    if (data.attribute === \"attributes.hp\") return { value: this.actor.system.attributes.hp.temp, color: 0xc0d6e4 };\n    if (data.attribute === \"attributes.vigor\")\n      return { value: this.actor.system.attributes.vigor.temp, color: 0xc0d6e4 };\n    return null;\n  }\n\n  /**\n   * Determines the length of the underline (bottom half-height bar overlay) on a token bar.\n   *\n   * @param {object} data         Resource data for this bar\n   * @returns {number|null}       The value of the bar underline, if any.\n   * @protected\n   */\n  _getBarUnderline(data) {\n    if (data.attribute === \"attributes.hp\")\n      return { value: this.actor.system.attributes.hp.nonlethal, color: 0x7d2828 };\n    return null;\n  }\n\n  /**\n   * Draw a single resource bar, given provided data.\n   *\n   * @param {number} number       The Bar number>\n   * @param {PIXI.Graphics} bar   The Bar container.\n   * @param {object} data         Resource data for this bar.\n   * @protected\n   */\n  _drawBar(number, bar, data) {\n    // Get boost value (such as temporary hit points\n    const boost = this._getBarBoost(data);\n    const underline = this._getBarUnderline(data);\n    const boostlessMax = data.max;\n\n    const val = Number(data.value);\n    data.max = Math.max(data.max, (boost?.value ?? 0) + val);\n    const pct = Math.clamped(val, 0, data.max) / data.max;\n    const boostlessPct = Math.clamped(val, 0, boostlessMax) / boostlessMax;\n\n    // Determine sizing\n    let h = Math.max(canvas.dimensions.size / 12, 8);\n    const w = this.w;\n    const bs = Math.clamped(h / 8, 1, 2);\n    if (this.document.height >= 2) h *= 1.6; // Enlarge the bar for large tokens\n\n    // Determine the color to use\n    const blk = 0x000000;\n    let color;\n    if (number === 0) color = PIXI.utils.rgb2hex([1 - boostlessPct / 2, boostlessPct, 0]);\n    else color = PIXI.utils.rgb2hex([0.5 * boostlessPct, 0.7 * boostlessPct, 0.5 + boostlessPct / 2]);\n\n    // Draw the bar\n    bar.clear();\n    // Draw background of bar\n    bar.beginFill(blk, 0.5).lineStyle(bs, blk, 1.0).drawRoundedRect(0, 0, this.w, h, 3);\n    // Draw bar boost\n    if (boost?.value > 0) {\n      const pct = Math.clamped(val + boost.value, 0, data.max) / data.max;\n      bar\n        .beginFill(boost.color, 1.0)\n        .lineStyle(bs, blk, 1.0)\n        .drawRoundedRect(0, 0, pct * w, h, 2);\n    }\n    // Draw normal value\n    bar\n      .beginFill(color, 1.0)\n      .lineStyle(bs, blk, 1.0)\n      .drawRoundedRect(0, 0, pct * w, h, 2);\n    // Draw bar underline\n    if (underline?.value > 0) {\n      const pct = Math.clamped(underline.value, 0, data.max) / data.max;\n      bar\n        .beginFill(underline.color, 1.0)\n        .lineStyle(bs, blk, 1.0)\n        .drawRoundedRect(0, h / 2, pct * w, h / 2, 2);\n    }\n\n    // Set position\n    const posY = number === 0 ? this.h - h : 0;\n    bar.position.set(0, posY);\n  }\n\n  /**\n   * Returns error margin, in pixels, for measuring to and from token center.\n   *\n   * Defined as larger of half the token's width and height.\n   *\n   * @type {number}\n   */\n  get sizeErrorMargin() {\n    return Math.max(this.w / 2, this.h / 2);\n  }\n}\n","import { clearHighlight, showAttackReach } from \"./attack-reach.mjs\";\nimport { getSkipActionPrompt } from \"module/documents/settings.mjs\";\n\nexport class TokenQuickActions {\n  /**\n   * Add quick action buttons to token HUD.\n   *\n   * @param {TokenHUD} app\n   * @param {JQuery} html\n   */\n  static async addQuickActions(app, html) {\n    const token = app.object;\n    const actor = token.actor;\n\n    const items = actor?.getQuickActions?.();\n    if (!items) return;\n\n    const quickActions = $('<div class=\"col actions\">');\n    const quickActionsList = $('<div class=\"below\">');\n\n    items.forEach(({ item }) => {\n      const action = item.firstAction;\n      const icon = item.img ?? CONST.DEFAULT_TOKEN;\n      let title = \"\";\n      if ([\"attack\", \"weapon\"].includes(item.type)) title = game.i18n.format(\"FFD20.AttackWith\", { name: item.name });\n      else if (item.type === \"spell\") title = game.i18n.format(\"FFD20.AttackWithSpell\", { name: item.name });\n      else if (item.type === \"feat\") title = game.i18n.format(\"FFD20.AttackWithFeat\", { name: item.name });\n      else title = game.i18n.format(\"FFD20.QuickActionUseAny\", { name: item.name });\n      const type = item.type;\n\n      const actionHTML = [];\n      actionHTML.push(\n        `<div data-item-id=\"${item.id}\" data-item-type=\"${type}\" class=\"control-icon token-quick-action type-${type}\">`,\n        `<img src=\"${icon}\" width=\"36\" height=\"36\" data-tooltip=\"${title}\">`\n      );\n      if (action && (item.isCharged || action?.data.usesAmmo)) {\n        actionHTML.push(this.createChargeElement(action));\n      }\n      actionHTML.push(\"</div>\");\n\n      const actionEl = document.createElement(\"div\");\n      actionEl.innerHTML = actionHTML.join(\"\");\n      const el = actionEl.firstChild;\n\n      this.activateElementListeners(el, item, action, token);\n\n      quickActionsList.append(el);\n    });\n\n    quickActions.append(quickActionsList);\n\n    html.find(\".col.middle\").after(quickActions);\n  }\n\n  /**\n   * Generate charge display element for an action.\n   *\n   * @param {ffd20.components.ItemAction} action Action\n   * @returns {Element} HTML element with charge information.\n   */\n  static createChargeElement(action) {\n    const item = action.item,\n      usesAmmo = action.data.usesAmmo ?? false,\n      chargeCost = action.getChargeCost(),\n      isSingleUse = item.isSingleUse;\n\n    const actualChargeCost = (action) => Math.floor(item.charges / chargeCost),\n      actualMaxCharge = (action) => Math.floor(item.maxCharges / chargeCost);\n\n    // TODO: Move HTML generation to a precompiled HBS partial\n    const htmlparts = [\"<charges>\"],\n      isCharged = action.isCharged,\n      max = isSingleUse ? 0 : isCharged ? actualMaxCharge(action) : 0,\n      recharging = isCharged && chargeCost < 0;\n\n    let uses = 0;\n    if (usesAmmo) {\n      uses = item.defaultAmmo?.system.quantity ?? 0;\n    } else if (isSingleUse) {\n      uses = item.system.quantity;\n    } else if (isCharged) {\n      if (!recharging) {\n        uses = actualChargeCost(action);\n      } else {\n        uses = -chargeCost;\n      }\n    }\n\n    if (!recharging) htmlparts.push(`<span class='remaining'>${uses}</span >`);\n    else htmlparts.push(`<span class='recharge'>+${uses}</span>`);\n    if (!recharging && max !== 0) htmlparts.push(`<span class='delimiter' >/</span ><span class='max'>${max}</span>`);\n    htmlparts.push(\"</charges>\");\n    return htmlparts.join(\"\");\n  }\n\n  /**\n   * Add listeners to token HUD quick action element.\n   *\n   * @param {Element} el Quick action element\n   * @param {Item} item\n   * @param {ffd20.components.ItemAction} action\n   * @param {Token} token\n   */\n  static activateElementListeners(el, item, action, token) {\n    el.addEventListener(\"click\", (event) => {\n      event.preventDefault();\n      if (!event.ctrlKey) {\n        item.use({ ev: event, token: token.document, skipDialog: getSkipActionPrompt() });\n      } else {\n        item.displayCard({ token: token.document });\n      }\n    });\n\n    el.addEventListener(\"contextmenu\", (event) => {\n      event.preventDefault();\n      item.sheet.render(true, { focus: true });\n    });\n\n    // Reach highlight on mouse hover\n    if (!game.settings.get(\"ffd20\", \"hideReachMeasurements\")) {\n      el.addEventListener(\"mouseenter\", () => showAttackReach(token, item, action), { passive: true });\n      el.addEventListener(\"mouseleave\", () => clearHighlight(), { passive: true });\n    }\n  }\n}\n","export class DetectionModeInvisibilityPF extends DetectionModeInvisibility {\n  static ID = \"seeInvisibility\";\n  static LABEL = \"DETECTION.SeeInvisibility\";\n  static PRIORITY = 100000;\n\n  /** @override */\n  _testPoint(visionSource, mode, target, test) {\n    if (!this._testLOS(visionSource, mode, target, test)) return false;\n    if (this._testRange(visionSource, mode, target, test)) return true;\n    for (const lightSource of canvas.effects.lightSources.values()) {\n      if (!lightSource.active || lightSource.disabled) continue;\n      if (lightSource.los.contains(test.point.x, test.point.y)) return true;\n    }\n    return false;\n  }\n}\n\nexport class DetectionModeBlindSensePF extends DetectionMode {\n  static ID = \"blindSense\";\n  static LABEL = \"FFD20.SenseBSense\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.OTHER;\n  static PRIORITY = 200100;\n\n  constructor(data = {}, ...args) {\n    data.walls = true;\n    super(data, ...args);\n  }\n\n  /** @override */\n  static getDetectionFilter() {\n    return (this._detectionFilter ??= OutlineOverlayFilter.create({\n      outlineColor: [0, 0.33, 0.6, 1],\n      knockout: false,\n      wave: this.ID === \"blindSense\",\n    }));\n  }\n\n  /** @override */\n  _canDetect(visionSource, target) {\n    return true;\n  }\n}\n\nexport class DetectionModeBlindSightPF extends DetectionModeBlindSensePF {\n  static ID = \"blindSight\";\n  static LABEL = \"FFD20.SenseBS\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.OTHER;\n  static PRIORITY = 200000;\n\n  /** @override */\n  static getDetectionFilter() {\n    return (this._detectionFilter ??= OutlineOverlayFilter.create({\n      outlineColor: [0, 0.33, 0.6, 1],\n      knockout: false,\n      wave: false,\n    }));\n  }\n}\n\nexport class DetectionModeTremorPF extends DetectionModeTremor {\n  static ID = \"feelTremor\";\n  static LABEL = \"DETECTION.FeelTremor\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.MOVE;\n  static PRIORITY = 201000;\n\n  constructor(data = {}, ...args) {\n    data.walls = false;\n    super(data, ...args);\n  }\n}\n","const darkVisionShader = CONFIG.Canvas.visionModes.darkvision.shader;\n\nexport const darkvision = new VisionMode({\n  id: \"darkvision\",\n  label: \"VISION.ModeDarkvision\",\n  canvas: {\n    shader: darkVisionShader,\n    uniforms: { contrast: 0, saturation: -1.0, brightness: 0 },\n  },\n  lighting: {\n    //levels: {[VisionMode.LIGHTING_LEVELS.DIM]: VisionMode.LIGHTING_LEVELS.BRIGHT}, // Foundry sets dim to bright by default\n    background: { visibility: VisionMode.LIGHTING_VISIBILITY.REQUIRED },\n  },\n  vision: {\n    darkness: { adaptive: false },\n    defaults: { attenuation: 0, contrast: 0, saturation: -1.0, brightness: 0 },\n  },\n});\n","import { MeasuredTemplatePF } from \"./measure.mjs\";\n\n/**\n * A helper class for building MeasuredTemplates for PF1 spells and abilities\n *\n * @augments {MeasuredTemplate}\n */\nexport class AbilityTemplate extends MeasuredTemplatePF {\n  /**\n   * A factory method to create an AbilityTemplate instance using provided data\n   *\n   * @param {string} type -             The type of template (\"cone\", \"circle\", \"rect\" or \"ray\")\n   * @param {number} distance -         The distance/size of the template\n   * @param options\n   * @returns {AbilityTemplate|null}     The template object, or null if the data does not produce a template\n   */\n  static fromData(options) {\n    const type = options.type;\n    const distance = options.distance;\n    if (!type) return null;\n    if (!distance) return null;\n    if (!canvas.scene) return null;\n    if (![\"cone\", \"circle\", \"rect\", \"ray\"].includes(type)) return null;\n\n    // Prepare template data\n    const templateData = {\n      t: type,\n      user: game.user.id,\n      distance: distance || 5,\n      direction: 0,\n      x: 0,\n      y: 0,\n      fillColor: options.color ? options.color : game.user.color,\n      texture: options.texture ? options.texture : null,\n      _id: randomID(16),\n    };\n\n    // Additional type-specific data\n    switch (type) {\n      case \"cone\":\n        if (game.settings.get(\"ffd20\", \"measureStyle\") === true)\n          templateData.angle = CONFIG.MeasuredTemplate.defaults.angle;\n        else templateData.angle = CONFIG.MeasuredTemplate.defaults.originalAngle;\n        break;\n      case \"rect\":\n        templateData.distance = Math.sqrt(Math.pow(distance, 2) + Math.pow(distance, 2));\n        templateData.direction = 45;\n        break;\n      case \"ray\":\n        templateData.width = CONFIG.MeasuredTemplate.defaults.width;\n        break;\n      default:\n        break;\n    }\n\n    // Return the template constructed from the item data\n    const cls = CONFIG.MeasuredTemplate.documentClass;\n    const template = new cls(templateData, { parent: canvas.scene });\n    const object = new this(template);\n    return object;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Creates a preview of the spell template\n   *\n   * @param {Event} event   The initiating click event\n   */\n  async drawPreview(event) {\n    const initialLayer = canvas.activeLayer;\n    await this.draw();\n    this.active = true;\n    this.layer.activate();\n    this.layer.preview.addChild(this);\n    return this.activatePreviewListeners(initialLayer);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Activate listeners for the template preview\n   *\n   * @param {CanvasLayer} initialLayer  The initially active CanvasLayer to re-activate after the workflow is complete\n   * @returns {Promise<boolean>} Returns true if placed, or false if cancelled\n   */\n  activatePreviewListeners(initialLayer) {\n    return new Promise((resolve) => {\n      const handlers = {};\n      let moveTime = 0;\n\n      const pfStyle = game.settings.get(\"ffd20\", \"measureStyle\") === true;\n\n      const _clear = () => {\n        if (this.destroyed) return;\n        this.destroy();\n      };\n\n      // Update placement (mouse-move)\n      handlers.mm = (event) => {\n        event.stopPropagation();\n        const now = Date.now(); // Apply a 20ms throttle\n        if (now - moveTime <= 20) return;\n        const center = event.data.getLocalPosition(this.layer);\n        const pos = canvas.grid.getSnappedPosition(center.x, center.y, 2);\n        this.document.x = pos.x;\n        this.document.y = pos.y;\n        this.refresh();\n        canvas.app.render();\n        moveTime = now;\n      };\n\n      // Cancel the workflow (right-click)\n      handlers.rc = (event, canResolve = true) => {\n        this.layer.preview.removeChildren();\n        canvas.stage.off(\"mousemove\", handlers.mm);\n        canvas.stage.off(\"mousedown\", handlers.lc);\n        canvas.app.view.oncontextmenu = null;\n        canvas.app.view.onwheel = null;\n        // Clear highlight\n        this.active = false;\n        const hl = canvas.grid.getHighlightLayer(this.highlightId);\n        hl.clear();\n        _clear();\n\n        initialLayer.activate();\n        if (canResolve)\n          resolve({\n            result: false,\n          });\n      };\n\n      // Confirm the workflow (left-click)\n      handlers.lc = async (event) => {\n        handlers.rc(event, false);\n\n        // Create the template\n        const result = {\n          result: true,\n          place: async () => {\n            const doc = (\n              await canvas.scene.createEmbeddedDocuments(\"MeasuredTemplate\", [this.document.toObject(false)])\n            )[0];\n            this.document = doc;\n            return doc;\n          },\n          delete: () => {\n            return this.document.delete();\n          },\n        };\n        _clear();\n        resolve(result);\n      };\n\n      // Rotate the template by 3 degree increments (mouse-wheel)\n      handlers.mw = (event) => {\n        if (event.ctrlKey) event.preventDefault(); // Avoid zooming the browser window\n        event.stopPropagation();\n        let delta, snap;\n        if (event.ctrlKey) {\n          if (this.document.t === \"rect\") {\n            delta = Math.sqrt(canvas.dimensions.distance * canvas.dimensions.distance);\n          } else {\n            delta = canvas.dimensions.distance;\n          }\n          this.document.distance += delta * -Math.sign(event.deltaY);\n        } else {\n          if (pfStyle && this.document.t === \"cone\") {\n            delta = 90;\n            snap = event.shiftKey ? delta : 45;\n          } else {\n            delta = canvas.grid.type > CONST.GRID_TYPES.SQUARE ? 30 : 15;\n            snap = event.shiftKey ? delta : 5;\n          }\n          if (this.document.t === \"rect\") {\n            snap = Math.sqrt(Math.pow(5, 2) + Math.pow(5, 2));\n            this.document.distance += snap * -Math.sign(event.deltaY);\n          } else {\n            this.document.direction += snap * Math.sign(event.deltaY);\n          }\n        }\n        this.refresh();\n      };\n\n      // Activate listeners\n      if (this.controlIcon) this.controlIcon.removeAllListeners();\n      canvas.stage.on(\"mousemove\", handlers.mm);\n      canvas.stage.on(\"mousedown\", handlers.lc);\n      canvas.app.view.oncontextmenu = handlers.rc;\n      canvas.app.view.onwheel = handlers.mw;\n      this.hitArea = new PIXI.Polygon([]);\n    });\n  }\n\n  refresh() {\n    if (!this.template) return;\n    if (!canvas.scene) return;\n\n    return super.refresh();\n  }\n}\n","import { RollPF } from \"../roll.mjs\";\n\n/**\n * RollTerm for sizeRoll() function\n */\nexport class SizeRollTerm extends RollTerm {\n  constructor({ terms = [], roll, options, modifiers = [] }) {\n    super({ options });\n\n    if (terms) {\n      if (terms[0] instanceof RollTerm) this.terms = terms;\n      else if (typeof terms[0] === \"string\") {\n        this._terms = terms;\n        this.terms = terms.reduce((all, t) => {\n          const ts = RollPF.parse(t);\n          if (ts.length > 1) all.push(ParentheticalTerm.fromTerms(ts));\n          else all.push(ts[0]);\n          return all;\n        }, []);\n      } else this.terms = terms.map((t) => RollTerm.fromData(t));\n    }\n\n    this.modifiers = modifiers;\n\n    if (roll) {\n      if (roll instanceof Roll) this.roll = roll;\n      else {\n        roll.modifiers = modifiers;\n        this.roll = Roll.fromData(roll);\n      }\n    }\n  }\n\n  _terms = [];\n\n  terms = [];\n\n  roll = undefined;\n\n  isIntermediate = false;\n\n  static SERIALIZE_ATTRIBUTES = [\"terms\", \"roll\", \"modifiers\"];\n\n  /**\n   * Regexp for identifying flavor and modifiers\n   */\n  static TRAILER_REGEXP = new RegExp(`${DiceTerm.MODIFIERS_REGEXP_STRING}?${DiceTerm.FLAVOR_REGEXP_STRING}?$`);\n\n  get total() {\n    return this.roll.total;\n  }\n\n  get dice() {\n    return this.roll?.dice;\n  }\n\n  get formula() {\n    return this.simplify ?? super.formula;\n  }\n\n  get expression() {\n    return `sizeRoll(${this.terms.map((t) => t.formula).join(\", \")})${this.modifiers.join(\"\")}`;\n  }\n\n  /**\n   * Return simpler representation of the sizeRoll (e.g. 3d6 instead of sizeRoll(3, 6)).\n   */\n  get simplify() {\n    return this.roll?.formula;\n  }\n\n  get isDeterministic() {\n    return false;\n  }\n\n  _prepareRoll() {\n    const noRoll = !this.roll;\n    // Map terms to sizeRoll params\n    const sizeDice = noRoll ? ffd20.utils.rollPreProcess.sizeRoll(...this.terms.map((r) => r.total)) : null;\n    if (sizeDice) {\n      // Copy flavor to die roll\n      if (this.flavor) sizeDice[0].options.flavor = this.flavor;\n      // Copy modifiers to die roll\n      if (this.modifiers.length) sizeDice[0].modifiers = this.modifiers;\n    }\n    // Generate final roll\n    const roll = noRoll ? RollPF.fromTerms(sizeDice) : this.roll;\n    // Copy flavor to roll\n    if (this.flavor) roll.options.flavor = this.flavor;\n\n    return roll;\n  }\n\n  _evaluateSync({ minimize = false, maximize = false } = {}) {\n    const rollOpts = { minimize, maximize, async: false };\n    for (const term of this.terms) {\n      if (term._evaluated) continue;\n      term.evaluate(rollOpts);\n    }\n\n    const roll = this._prepareRoll();\n\n    this.roll = roll._evaluated ? roll : roll.evaluate(rollOpts);\n\n    return this;\n  }\n\n  async _evaluate({ minimize = false, maximize = false } = {}) {\n    const rollOpts = { minimize, maximize, async: true };\n    for (const term of this.terms) {\n      if (term._evaluated) continue;\n      await term.evaluate(rollOpts);\n    }\n\n    const roll = this._prepareRoll();\n\n    this.roll = roll._evaluated ? roll : await roll.evaluate(rollOpts);\n\n    return this;\n  }\n\n  /** @inheritDoc */\n  toJSON() {\n    return {\n      ...super.toJSON(),\n      roll: this.roll?.toJSON(),\n    };\n  }\n}\n","import { ScriptEditor } from \"../applications/script-editor.mjs\";\n\nexport class ItemScriptCall {\n  static AsyncFunction = Object.getPrototypeOf(async function () {}).constructor;\n\n  constructor(data, parent) {\n    this.data = mergeObject(this.constructor.defaultData, data);\n    this.parent = parent;\n  }\n\n  /**\n   * Creates a script call.\n   *\n   * @param {object[]} data - Data to initialize the script call(s) with.\n   * @param {object} context - An object containing context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the script call within.\n   * @returns The resulting script calls, or an empty array if nothing was created.\n   */\n  static async create(data, context) {\n    const { parent } = context;\n\n    if (parent instanceof ffd20.documents.item.ItemPF) {\n      // Prepare data\n      data = data.map((dataObj) => mergeObject(this.defaultData, dataObj));\n      const newScriptCallData = deepClone(parent.system.scriptCalls || []);\n      newScriptCallData.push(...data);\n\n      // Update parent\n      await parent.update({ \"system.scriptCalls\": newScriptCallData });\n\n      // Return results\n      return data.map((o) => parent.scriptCalls.get(o._id));\n    }\n\n    return [];\n  }\n\n  static get defaultData() {\n    return {\n      _id: randomID(16),\n      name: game.i18n.localize(\"FFD20.ScriptCalls.NewName\"),\n      img: \"icons/svg/dice-target.svg\",\n      type: \"script\",\n      value: \"\",\n      category: \"\",\n      hidden: false,\n    };\n  }\n\n  get id() {\n    return this.data._id;\n  }\n  get type() {\n    return this.data.type;\n  }\n  get value() {\n    return this.data.value;\n  }\n  get category() {\n    return this.data.category;\n  }\n  get name() {\n    return this.data.name;\n  }\n  get hidden() {\n    return this.data.hidden;\n  }\n\n  async getScriptBody() {\n    return this.type === \"script\" ? this.value : (await fromUuid(this.value))?.data.command ?? \"\";\n  }\n\n  async update(data, options = {}) {\n    if (this.parent != null) {\n      const rawChange = this.parent.system.scriptCalls.find((o) => o._id === this.id);\n      const idx = this.parent.system.scriptCalls.indexOf(rawChange);\n      if (idx >= 0) {\n        data = Object.entries(data).reduce((cur, o) => {\n          cur[`system.scriptCalls.${idx}.${o[0]}`] = o[1];\n          return cur;\n        }, {});\n        return this.parent.update(data, options);\n      }\n    }\n  }\n\n  // Opens up the editor for this script call\n  async edit() {\n    // For Macros\n    if (this.type === \"macro\") {\n      const macro = await fromUuid(this.value);\n      let err;\n      if (macro) {\n        if (macro.testUserPermission(game.user, \"OBSERVER\")) {\n          macro.sheet.render(true, { focus: true });\n        } else {\n          err = game.i18n.format(\"DOCUMENT.SheetPermissionWarn\", { document: macro.documentName });\n        }\n      } else {\n        err = game.i18n.format(\"FFD20.ErrorNoMacroID\", { id: this.value });\n      }\n\n      if (err) {\n        console.error(err);\n        ui.notifications.error(err);\n      }\n    }\n    // For regular script calls\n    else {\n      const scriptEditor = new ScriptEditor({\n        command: this.value,\n        name: this.name,\n        parent: this.parent,\n        scriptCall: true,\n      }).render(true);\n      const result = await scriptEditor.awaitResult();\n      if (result) {\n        return this.update({ value: result.command, name: result.name });\n      }\n    }\n  }\n\n  /**\n   * Executes the script.\n   *\n   * @param {object} shared - An object passed between script calls, and which is passed back as a result of ItemPF.executeScriptCalls.\n   * @param {Object<string, object>} extraParams - A dictionary containing extra parameters to pass on to the call.\n   */\n  async execute(shared, extraParams = {}) {\n    // Add variables to the evaluation scope\n    const item = this.parent;\n    const actor = item.actor;\n    const token =\n      actor?.token?.object ?? (actor ? canvas.tokens.placeables.find((t) => t.actor?.id === actor.id) : null);\n\n    // Attempt script execution\n    const body = `await (async () => {\n      ${await this.getScriptBody()}\n    })()`;\n    const fn = this.constructor.AsyncFunction(\"item\", \"actor\", \"token\", \"shared\", ...Object.keys(extraParams), body);\n    try {\n      return await fn.call(this, item, actor, token, shared, ...Object.values(extraParams));\n    } catch (err) {\n      ui.notifications.error(`There was an error in your script/macro syntax. See the console (F12) for details`);\n      console.error(err);\n    }\n  }\n}\n","import { keepUpdateArray } from \"../utils/lib.mjs\";\n\nexport class ItemConditional {\n  constructor(data, parent) {\n    this.data = data;\n    this.parent = parent;\n\n    this.prepareData();\n  }\n\n  static async create(data, context = {}) {\n    const { parent } = context;\n\n    if (parent instanceof ffd20.components.ItemAction) {\n      // Prepare data\n      data = data.map((dataObj) => mergeObject(this.defaultData, dataObj));\n      const newConditionalData = deepClone(parent.data.conditionals || []);\n      newConditionalData.push(...data);\n\n      // Update parent\n      await parent.update({ conditionals: newConditionalData });\n\n      // Return results\n      return data.map((o) => parent.conditionals.get(o._id));\n    }\n\n    return [];\n  }\n\n  static get defaultData() {\n    return {\n      _id: randomID(16),\n      default: false,\n      name: \"\",\n      modifiers: [],\n    };\n  }\n\n  /** @type {string} */\n  get id() {\n    return this.data._id;\n  }\n\n  /** @type {string} */\n  get name() {\n    return this.data.name;\n  }\n\n  prepareData() {\n    // Update modifiers\n    if (this.data.modifiers instanceof Array) {\n      this.modifiers = this._prepareModifiers(this.data.modifiers);\n    }\n  }\n\n  _prepareModifiers(modifiers) {\n    const prior = this.modifiers;\n    const collection = new Collection();\n    for (const o of modifiers) {\n      let modifier = null;\n      if (prior && prior.has(o._id)) {\n        modifier = prior.get(o._id);\n        modifier.data = o;\n        modifier.prepareData();\n      } else modifier = new ffd20.components.ItemConditionalModifier(o, this);\n      collection.set(o._id || modifier.data._id, modifier);\n    }\n    return collection;\n  }\n\n  async update(updateData, options = {}) {\n    const idx = this.parent.data.conditionals.indexOf(this.data);\n    const prevData = deepClone(this.data);\n    const newUpdateData = mergeObject(prevData, updateData);\n\n    // Make sure modifiers remain in an array\n    keepUpdateArray(this.data, newUpdateData, \"modifiers\");\n\n    if (options.dryRun) return newUpdateData;\n    await this.parent.update({ [`conditionals.${idx}`]: newUpdateData });\n  }\n\n  async delete() {\n    const conditionals = foundry.utils.deepClone(this.parent.data.conditionals);\n    conditionals.findSplice((c) => c._id === this.id);\n    return this.parent.update({ conditionals });\n  }\n}\n\nexport class ItemConditionalModifier {\n  /**\n   * @param {object} data\n   * @param {ItemConditional} parent\n   */\n  constructor(data, parent) {\n    this.data = data;\n    this.parent = parent;\n\n    this.prepareData();\n  }\n\n  static async create(data, context = {}) {\n    const { parent } = context;\n\n    if (parent instanceof ffd20.components.ItemConditional) {\n      // Prepare data\n      data = data.map((dataObj) => mergeObject(this.defaultData, dataObj));\n      const newConditionalModifierData = deepClone(parent.data.modifiers || []);\n      newConditionalModifierData.push(...data);\n\n      // Update parent\n      await parent.update({ modifiers: newConditionalModifierData });\n\n      // Return results\n      return data.map((o) => parent.modifiers.get(o._id));\n    }\n\n    return [];\n  }\n\n  static get defaultData() {\n    return {\n      _id: randomID(16),\n      formula: \"\",\n      target: \"\",\n      subTarget: \"\",\n      type: \"\",\n      damageType: ffd20.components.ItemAction.defaultDamageType,\n      critical: \"\",\n    };\n  }\n\n  /** @type {string} */\n  get id() {\n    return this.data._id;\n  }\n\n  prepareData() {}\n\n  async update(updateData, options = {}) {\n    const idx = this.parent.data.modifiers.indexOf(this.data);\n    const prevData = deepClone(this.data);\n    const newUpdateData = flattenObject(mergeObject(prevData, updateData));\n\n    if (options.dryRun) return newUpdateData;\n    await this.parent.update({ [`modifiers.${idx}`]: expandObject(newUpdateData) });\n  }\n\n  async delete() {\n    const idx = this.parent.data.modifiers.indexOf(this.data);\n    if (idx < 0) throw new Error(`Modifier not found in parent ${this.parent.name}`);\n\n    const modifiers = duplicate(this.parent.data.modifiers);\n    modifiers.splice(idx, 1);\n    return this.parent.update({ modifiers });\n  }\n}\n","import { convertDistance, calculateRange, simplifyFormula } from \"../lib.mjs\";\nimport { RollPF } from \"../../dice/roll.mjs\";\n\nexport const registerHandlebarsHelpers = function () {\n  Handlebars.registerHelper(\"convertDistance\", (value) => (Number.isFinite(value) ? convertDistance(value)[0] : value));\n  Handlebars.registerHelper(\"distanceUnit\", (type) => convertDistance(0, type)[1]);\n\n  Handlebars.registerHelper(\"itemRange\", (item, rollData) => {\n    foundry.utils.logCompatibilityWarning(\"{{itemRange}} helper is deprecated, please use {{actionRange}} instead.\", {\n      since: \"PF1 v9\",\n      until: \"PF1 v10\",\n    });\n\n    if (!item.document?.firstAction?.hasRange) return null;\n    const action = item.document.firstAction;\n\n    const range = action.data.range.value;\n    const rangeType = action.data.range.units;\n\n    if (rangeType == null) return null;\n\n    const ft = calculateRange(range, rangeType, rollData);\n    if (ft && typeof ft !== \"string\") {\n      const rv = convertDistance(range);\n      return `${ft} ${rv[1]}`;\n    } else {\n      return \"\" + (ft ?? \"\");\n    }\n  });\n\n  Handlebars.registerHelper(\"actionRange\", (action, rollData) => {\n    if (!action?.hasRange) return null;\n\n    const range = action.data.range.value;\n    const rangeType = action.data.range.units;\n\n    if (rangeType == null) return null;\n\n    const ft = calculateRange(range, rangeType, rollData);\n    if (ft && typeof ft !== \"string\") {\n      const units = convertDistance(range)[1];\n      return `${ft} ${units}`;\n    } else {\n      return ft || \"\";\n    }\n  });\n\n  /**\n   *\n   * @param {ItemAction} action\n   * @param {object} rollData\n   * @param {object} [options]\n   */\n  function actionDamage(action, rollData, options) {\n    if (!action.hasDamage) return null;\n\n    const actor = action.actor,\n      item = action.item,\n      actorData = actor?.system,\n      actionData = action.data,\n      combine = options.hash.combine ?? true;\n\n    const parts = [];\n\n    const handleFormula = (formula, change) => {\n      try {\n        switch (typeof formula) {\n          case \"string\": {\n            // Ensure @item.level and similar gets parsed correctly\n            const rd = formula.indexOf(\"@\") >= 0 ? change?.parent?.getRollData() ?? rollData : {};\n            const newformula = simplifyFormula(formula, rd, { combine });\n            if (newformula != 0) parts.push(newformula);\n            break;\n          }\n          case \"number\":\n            if (formula != 0) parts.push(`${formula}`);\n            break;\n        }\n      } catch (err) {\n        console.error(`Formula parsing error with \"${formula}\"`);\n        parts.push(\"NaN\");\n      }\n    };\n\n    const handleParts = (parts) => parts.forEach(({ formula }) => handleFormula(formula));\n\n    // Normal damage parts\n    handleParts(actionData.damage.parts);\n\n    // Include ability score only if the string isn't too long yet\n    const dmgAbl = actionData.ability.damage;\n    const dmgAblMod = Math.floor((actorData?.abilities[dmgAbl]?.mod ?? 0) * (actionData.ability.damageMult || 1));\n    if (dmgAblMod != 0) parts.push(dmgAblMod);\n\n    // Include damage parts that don't happen on crits\n    handleParts(actionData.damage.nonCritParts);\n\n    // Include general sources. Item enhancement bonus is among these.\n    action.allDamageSources.forEach((s) => {\n      if (s.operator === \"script\") return;\n      handleFormula(s.formula, s);\n    });\n\n    if (parts.length === 0) parts.push(\"NaN\"); // Something probably went wrong\n\n    const simplifyMath = (formula) =>\n      formula\n        .replace(/\\s+/g, \"\") // remove whitespaces\n        .replace(/\\+-/g, \"-\") // + -n = -n\n        .replace(/--/g, \"+\") // - -n = +n\n        .replace(/-\\+/g, \"-\") // - +n = -n\n        .replace(/\\+\\++/g, \"+\"); // + +n = +n\n\n    const semiFinal = simplifyMath(parts.join(\"+\"));\n    if (semiFinal === \"NaN\") return semiFinal;\n    if (!combine) return semiFinal;\n    // With combine enabled, the following turns 1d12+1d8+6-8+3-2 into 1d12+1d8-1\n    const final = simplifyFormula(semiFinal, null, { combine });\n    return simplifyMath(final);\n  }\n\n  Handlebars.registerHelper(\"actionDamage\", actionDamage);\n\n  Handlebars.registerHelper(\"damageTypes\", (typeInfo) => {\n    const rv = [];\n    const { custom, values } = typeInfo;\n    if (custom) rv.push(custom);\n    values.forEach((dtId) => rv.push(game.i18n.localize(ffd20.registry.damageTypes.get(dtId)?.name ?? \"FFD20.Undefined\")));\n    return rv.join(\", \");\n  });\n\n  Handlebars.registerHelper(\"itemDamage\", (item, rollData) => {\n    console.warn(\"{{itemDamage}} handlebars helper is deprecated, use {{actionDamage}} instead\");\n    const action = item.document?.firstAction;\n    return actionDamage(action, rollData);\n  });\n\n  Handlebars.registerHelper(\"itemAttacks\", (item) => {\n    foundry.utils.logCompatibilityWarning(\n      \"{{itemAttacks}} helper is deprecated, please use {{actionAttacks}} instead.\",\n      {\n        since: \"PF1 v9\",\n        until: \"PF1 v10\",\n      }\n    );\n\n    const attacks = item.document.attackArray;\n    const highest = Math.max(...attacks); // Highest bonus, with assumption the first might not be that.\n    return `${attacks.length} (${highest < 0 ? highest : `+${highest}`}${attacks.length > 1 ? \"/\" : \"\"})`;\n  });\n\n  Handlebars.registerHelper(\"actionAttacks\", (action) => {\n    const attacks = action.item.getAttackArray(action.id);\n    const highest = Math.max(...attacks); // Highest bonus, with assumption the first might not be that.\n    return `${attacks.length} (${highest < 0 ? highest : `+${highest}`}${attacks.length > 1 ? \"/\" : \"\"})`;\n  });\n\n  /**\n   * Returns true if there are conditionals disabled by default.\n   */\n  Handlebars.registerHelper(\"optionalConditionals\", (item) => {\n    return item.firstAction?.data.conditionals.find((c) => !c.default);\n  });\n\n  // Fetches ability mod value based on ability key.\n  // Avoids contaminating rollData or item data with excess strings.\n  Handlebars.registerHelper(\"abilityMod\", (abl, rollData, multiplier) => {\n    return Math.floor(rollData.abilities[abl]?.mod * multiplier ?? 1);\n  });\n\n  Handlebars.registerHelper(\"hasContextNotes\", (actor, context) => {\n    return !!actor.getContextNotes(context).find((n) => n.notes.length);\n  });\n\n  Handlebars.registerHelper(\"contextNotes\", (actor, context, options) => {\n    const rollData = options.data.root.rollData;\n    const roll = options.hash[\"roll\"] ?? false;\n    const noteObjs = actor.getContextNotes(context);\n    return actor.formatContextNotes(noteObjs, rollData, { roll });\n  });\n\n  Handlebars.registerHelper(\"enrich\", (content, options) => {\n    const owner = Boolean(options.hash[\"owner\"]);\n    const rollData = options.hash[\"rollData\"];\n    return new Handlebars.SafeString(TextEditor.enrichHTML(content, { secrets: owner, rollData, async: false }));\n  });\n\n  Handlebars.registerHelper(\"json-string\", (obj) => {\n    return new Handlebars.SafeString(escape(JSON.stringify(obj)));\n  });\n\n  Handlebars.registerHelper(\"halfNumber\", (value) => {\n    value = typeof value === \"number\" ? value : parseFloat(value);\n    return new Handlebars.SafeString(Math.floor(value / 2).toString());\n  });\n\n  Handlebars.registerHelper(\"arrayHas\", (options) => {\n    const array = options.hash[\"array\"];\n    const value = options.hash[\"value\"];\n    return array.includes(value);\n  });\n};\n","/**\n * Returns the result of a roll of die, which changes based on different sizes.\n *\n * @param {number} origCount - The original number of die to roll.\n * @param {number} origSides - The original number of sides per die to roll.\n * @param {string|number} [targetSize=\"M\"] - The target size to change the die to.\n *   Can be a string of values \"F\", \"D\", \"T\", \"S\", \"M\", \"L\", \"H\", \"G\" or \"C\" for the different sizes.\n *   Can also be a number in the range of 0 to 8, where 4 is Medium.\n * @param {string|number} [initialSize=\"M\"] - The initial size of the creature. See targetSize above.\n * @returns {number} The result of the new roll.\n */\nexport const sizeRoll = function (origCount, origSides, targetSize = \"M\", initialSize = \"M\") {\n  const _getSizeIndex = function (size) {\n    if (typeof size === \"string\") return Object.values(ffd20.config.sizeChart).indexOf(size.toUpperCase());\n    return size;\n  };\n  targetSize = _getSizeIndex(targetSize);\n  initialSize = _getSizeIndex(initialSize);\n  let skipWarning = false;\n\n  // D10 special rule: https://paizo.com/paizo/faq/v5748nruor1fm#v5748eaic9t3f\n  if (origCount > 1 && origSides === 10 && (origCount % 2 === 0 || origCount === 3)) {\n    skipWarning = true;\n    const d10Arr = [\n      { orig: [2, 10], larger: [4, 8], smaller: [2, 8] },\n      { orig: [3, 10], larger: [6, 8], smaller: [3, 8] },\n      { orig: [4, 10], larger: [8, 8], smaller: [4, 8] },\n      { orig: [6, 10], larger: [12, 8], smaller: [6, 8] },\n      { orig: [8, 10], larger: [16, 8], smaller: [8, 8] },\n    ];\n    for (const v of d10Arr) {\n      if (v.orig[0] === origCount && v.orig[1] === origSides) {\n        if (targetSize < initialSize) {\n          initialSize--;\n          origCount = v.smaller[0];\n          origSides = v.smaller[1];\n        } else if (targetSize > initialSize) {\n          initialSize++;\n          origCount = v.larger[0];\n          origSides = v.larger[1];\n        }\n      }\n    }\n  }\n\n  // Get initial die type\n  const mediumDie = `${origCount}d${origSides}`;\n  const mediumDieMax = origCount * origSides;\n  let c = duplicate(ffd20.config.sizeDie);\n  {\n    if (c.indexOf(mediumDie) === -1) {\n      c = c.map((d) => {\n        if (d.match(/^([0-9]+)d([0-9]+)$/)) {\n          const dieCount = parseInt(RegExp.$1);\n          const dieSides = parseInt(RegExp.$2);\n          const dieMaxValue = dieCount * dieSides;\n\n          if (dieMaxValue === mediumDieMax) return mediumDie;\n        }\n\n        return d;\n      });\n    }\n  }\n\n  // Pick an index from the chart\n  let index = c.indexOf(mediumDie),\n    formula = mediumDie;\n  if (index >= 0) {\n    const d6Index = c.indexOf(\"1d6\");\n    let d8Index = c.indexOf(\"1d8\");\n    if (d8Index === -1) d8Index = c.indexOf(\"2d4\");\n    let sizeOffset = initialSize - targetSize;\n    let curSize = initialSize;\n\n    // When decreasing in size (e.g. from medium to small)\n    while (sizeOffset > 0) {\n      if (curSize <= 4 || index <= d8Index) {\n        index--;\n        sizeOffset--;\n        curSize--;\n      } else {\n        index -= 2;\n        sizeOffset--;\n        curSize--;\n      }\n    }\n    // When increasing in size (e.g. from medium to large)\n    while (sizeOffset < 0) {\n      if (curSize <= 3 || index <= d6Index) {\n        index++;\n        sizeOffset++;\n        curSize++;\n      } else {\n        index += 2;\n        sizeOffset++;\n        curSize++;\n      }\n    }\n\n    index = Math.clamped(index, 0, c.length - 1);\n    formula = c[index];\n  }\n\n  if (index === -1 && !skipWarning) {\n    ui.notifications.warn(game.i18n.localize(\"FFD20.WarningNoSizeDie\", { baseline: mediumDie, fallback: formula }));\n  }\n\n  const result = formula.split(\"d\");\n  if (result.length === 1) {\n    return [new NumericTerm({ number: parseInt(result[0]) })];\n  }\n  return [new Die({ number: parseInt(result[0]), faces: parseInt(result[1]) })];\n};\n\nexport const sizeReach = function (size = \"M\", reach = false, stature = \"tall\") {\n  if (typeof size === \"number\") size = Object.values(ffd20.config.sizeChart)[size];\n  size = Object.entries(ffd20.config.sizeChart).find((o) => o[1] === size)[0];\n\n  return [\n    new NumericTerm({\n      number: Actor.implementation.getReach(size, stature)[reach ? \"reach\" : \"melee\"],\n    }),\n  ];\n};\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nconst fields = foundry.data.fields;\n\n/**\n * A single script call category/trigger.\n *\n * @group Script Call Categories\n */\nexport class ScriptCallCategory extends RegistryEntry {\n  static defineSchema() {\n    return {\n      ...super.defineSchema(),\n      itemTypes: new fields.ArrayField(new fields.StringField({})),\n      info: new fields.StringField({ required: true, blank: false, initial: \"\" }, { localize: true }),\n    };\n  }\n}\n\n/**\n * The singleton registry of script call categories/trigger events.\n * At runtime this registry is accessible as `ffd20.registry.scriptCalls`.\n *\n * @group Script Call Categories\n * @see {@link Registry}\n * @see {@link ScriptCallCategory}\n * @augments {Registry<ScriptCallCategory>}\n */\nexport class ScriptCalls extends Registry {\n  /** @inheritdoc */\n  static model = ScriptCallCategory;\n\n  /** @inheritdoc */\n  static _defaultData = [\n    // Use\n    {\n      _id: \"use\",\n      itemTypes: [\"attack\", \"buff\", \"feat\", \"equipment\", \"consumable\", \"spell\", \"weapon\"],\n      name: \"FFD20.ScriptCalls.Use.Name\",\n      info: \"FFD20.ScriptCalls.Use.Info\",\n    },\n    // Equip\n    {\n      _id: \"equip\",\n      itemTypes: [\"weapon\", \"equipment\", \"loot\"],\n      name: \"FFD20.ScriptCalls.Equip.Name\",\n      info: \"FFD20.ScriptCalls.Equip.Info\",\n    },\n    // Toggle\n    {\n      _id: \"toggle\",\n      itemTypes: [\"buff\", \"feat\"],\n      name: \"FFD20.ScriptCalls.Toggle.Name\",\n      info: \"FFD20.ScriptCalls.Toggle.Info\",\n    },\n    // Change Quantity\n    {\n      _id: \"changeQuantity\",\n      itemTypes: [\"loot\", \"equipment\", \"weapon\", \"consumable\", \"container\"],\n      name: \"FFD20.ScriptCalls.ChangeQuantity.Name\",\n      info: \"FFD20.ScriptCalls.ChangeQuantity.Info\",\n    },\n    // Change Level\n    {\n      _id: \"changeLevel\",\n      itemTypes: [\"buff\", \"class\"],\n      name: \"FFD20.ScriptCalls.ChangeLevel.Name\",\n      info: \"FFD20.ScriptCalls.ChangeLevel.Info\",\n    },\n  ];\n}\n\n/**\n * {@inheritDoc ScriptCalls}\n *\n * @group Script Call Categories\n * @type {ScriptCalls}\n */\nexport let scriptCalls;\n","import { ItemPF } from \"./documents/item/item-pf.mjs\";\nimport { createTag } from \"./utils/lib.mjs\";\nimport { ItemChange } from \"./components/change.mjs\";\n\n/**\n * An indicator for whether the system is currently migrating the world.\n *\n * @type {boolean}\n */\n// As the `pf1` global does not use this ES module but a cloned copy, this value\n// only exists for the documentation. Always use `ffd20.migrations.isMigrating` instead!\nexport let isMigrating = false; // eslint-disable-line prefer-const -- ffd20.migrations.isMigrating is changed at runtime\n\n/**\n * Perform a system migration for the entire World,\n * applying migrations for Actors, Items, Scenes, Tokens and Compendium packs\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock=false] - If false, locked compendiums are ignored.\n * @param {boolean} [options.systemPacks=false] - Migrate system packs.\n * @returns {Promise<void>} - A Promise which resolves once the migration is completed\n */\nexport const migrateWorld = async function ({ unlock = false, systemPacks = false } = {}) {\n  if (!game.user.isGM) {\n    return void ui.notifications.error(game.i18n.localize(\"FFD20.ErrorUnauthorizedAction\"));\n  }\n\n  if (ffd20.migrations.isMigrating) {\n    return void ui.notifications.error(game.i18n.localize(\"FFD20.Migration.AlreadyInProgress\"));\n  } else {\n    ffd20.migrations.isMigrating = true;\n    Hooks.callAll(\"pf1MigrationStarted\");\n  }\n\n  const startMessage = game.i18n.format(\"FFD20.Migration.Start\", { version: game.system.version });\n  ui.notifications.info(startMessage, {\n    permanent: true,\n  });\n  console.log(\"System Migration starting.\");\n  // Overloaded. Can be jQuery notification or queue object\n  const removeNotification = function (li) {\n    if (li.fadeOut) {\n      li.fadeOut(66, () => li.remove());\n      ui.notifications.active = ui.notifications.active.filter((o) => o != li);\n      ui.notifications.fetch();\n    } else ui.notifications.queue = ui.notifications.queue.filter((o) => o != li);\n  };\n\n  await _migrateWorldSettings();\n\n  // Migrate World Actors\n  await migrateActors();\n\n  // Migrate World Items\n  await migrateItems();\n\n  // Migrate Actor Override Tokens\n  await migrateScenes();\n\n  // Migrate Compendium Packs\n  const packs = game.packs.filter((p) => {\n    // Ingore locked unless we're allowed to unlock them\n    if (p.locked && !unlock) return false;\n\n    const source = p.metadata.packageType;\n    // Ignore modules, adventures, etc.\n    if (![\"world\", \"system\"].includes(source)) return false;\n    // Ignore system packs unless configured to include them\n    if (source === \"system\" && !systemPacks) return false;\n    // Ignore unsupported pack types\n    return [\"Actor\", \"Item\", \"Scene\"].includes(p.metadata.type);\n  });\n\n  await migrateCompendiums(packs, { unlock });\n\n  // Set the migration as complete\n  await game.settings.set(\"ffd20\", \"systemMigrationVersion\", game.system.version);\n  const infoElem =\n    ui.notifications.queue.find((o) => o.permanent && o.message == startMessage) ||\n    ui.notifications.active.find((o) => o.hasClass(\"permanent\") && o[0].innerText === startMessage);\n  if (infoElem) removeNotification(infoElem);\n\n  // Remove migration notification\n  ui.notifications.info(game.i18n.format(\"FFD20.Migration.End\", { version: game.system.version }), { console: false });\n  console.log(\"System Migration completed.\");\n  ffd20.migrations.isMigrating = false;\n\n  Hooks.callAll(\"pf1MigrationFinished\");\n};\n\n/**\n * Migrate actors directory.\n *\n * @returns {Promise<void>}\n */\nexport async function migrateActors() {\n  console.log(\"Actors directory migration starting...\");\n  for (const actor of game.actors) {\n    try {\n      const updateData = migrateActorData(actor.toObject());\n      if (!foundry.utils.isEmpty(updateData)) {\n        console.log(`Migrating Actor document ${actor.name}`);\n        await actor.update(updateData);\n      }\n    } catch (err) {\n      console.error(`Error migrating actor document ${actor.name}`, err);\n    }\n  }\n  console.log(\"Actors directory migration complete!\");\n}\n\n/**\n * Migrate items directory.\n *\n * @returns {Promise<void>}\n */\nexport const migrateItems = async () => {\n  console.log(\"Items directory migration starting...\");\n  for (const item of game.items) {\n    try {\n      const updateData = migrateItemData(item.toObject());\n      if (!foundry.utils.isEmpty(updateData)) {\n        console.log(`Migrating Item document ${item.name}`);\n        await item.update(updateData);\n      }\n    } catch (err) {\n      console.error(`Error migrating item document ${item.name}`, err);\n    }\n  }\n  console.log(\"Items directory migation complete!\");\n};\n\n/**\n * Migrate all scenes.\n *\n * @see {@link migrateScene}\n *\n * @returns {Promise<void>}\n */\nexport const migrateScenes = async () => {\n  console.log(\"Scene migration starting...\");\n  for (const scene of game.scenes) {\n    console.log(`Migrating Scene document \"${scene.name}\"`);\n    await migrateScene(scene);\n  }\n  console.log(\"Scene migration finished!\");\n};\n\n/**\n * Migrate compendiums.\n *\n * @see {@link migrateCompendium}\n *\n * @param {Array<string|WorldCollection>|null} [packIds=null] - Array of pack IDs or packs to migrate. If null, all packs will be migrated.\n * @param {object} [options={}] - Additional options to pass along.\n * @param {boolean} [options.unlock=false] - If false, locked compendiums are ignored.\n * @returns {Promise<void>} - Promise that resolves once all migrations are complete.\n * @throws {Error} - If defined pack is not found.\n */\nexport const migrateCompendiums = async (packIds = null, { unlock = false } = {}) => {\n  if (packIds === null) packIds = [...game.packs];\n  for (const pack of packIds) {\n    try {\n      await migrateCompendium(pack, { unlock });\n    } catch (error) {\n      console.error(error);\n    }\n  }\n};\n\n/**\n * Migrate system compendia.\n *\n * Convenience wrapper for migrateCompendiums.\n *\n * @see {@link migrateCompendiums}\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock] - Unlock compendiums\n * @returns {Promise<void>}\n */\nexport const migrateSystem = async ({ unlock = true } = {}) => {\n  const packs = game.packs.filter((p) => p.metadata.packageType === \"system\");\n  return migrateCompendiums(packs, { unlock });\n};\n\n/**\n * Migrate module compendia.\n *\n * Convenience wrapper for migrateCompendiums.\n *\n * @see {@link migrateCompendiums}\n *\n * @param {object} [options={}] Additional options\n * @param {boolean} [options.unlock] Unlock compendiums\n * @returns {Promise<void>}\n */\nexport const migrateModules = ({ unlock = true } = {}) => {\n  const packs = game.packs.filter((p) => p.metadata.packageType === \"module\");\n  return migrateCompendiums(packs, { unlock });\n};\n\n/* -------------------------------------------- */\n\n/**\n * Apply migration rules to all Documents within a single Compendium pack\n *\n * @param {CompendiumCollection|string} pack - Compendium (or its ID) to migrate\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock=false] - If false, locked compendium will be ignored.\n * @returns {Promise<void>} - Promise that resolves once migration is complete.\n * @throws {Error} - If defined pack is not found.\n */\nexport const migrateCompendium = async function (pack, { unlock = false } = {}) {\n  if (typeof pack === \"string\") {\n    pack = game.packs.get(pack);\n    if (!pack) throw new Error(`Compendium \"${pack}\" not found.`);\n  }\n\n  if (pack.locked && !unlock) return;\n\n  const docType = pack.metadata.type;\n  if (![\"Actor\", \"Item\", \"Scene\"].includes(docType)) return;\n\n  const wasLocked = pack.locked;\n  if (wasLocked) await pack.configure({ locked: false });\n\n  // Begin by requesting server-side data model migration and get the migrated content\n  await pack.migrate();\n\n  // Iterate over compendium entries - applying fine-tuned migration functions\n  console.log(`Migrating ${docType} documents in Compendium ${pack.collection}`);\n\n  try {\n    switch (docType) {\n      case \"Item\":\n        await pack.updateAll((item) => migrateItemData(item.toObject()));\n        break;\n      case \"Actor\":\n        await pack.updateAll((actor) => migrateActorData(actor.toObject()));\n        break;\n      case \"Scene\": {\n        await pack.updateAll((scene) => migrateSceneData(scene.toObject()));\n        break;\n      }\n    }\n  } catch (err) {\n    console.error(`Error migrating Compendium ${pack.collection}`, err);\n  }\n\n  if (wasLocked) await pack.configure({ locked: true });\n\n  console.log(`Compendium \"${pack.collection}\" migration complete!`);\n};\n\n/**\n * Migrates world settings.\n */\nconst _migrateWorldSettings = async function () {\n  const tooltipWorldConfig = game.settings.get(\"ffd20\", \"tooltipWorldConfig\");\n  if (tooltipWorldConfig.hideActorName !== undefined) {\n    // 1 (All) for true, -2 (None) for false\n    tooltipWorldConfig.hideActorNameByDisposition == tooltipWorldConfig.hideActorName ? 1 : -2;\n    game.settings.set(\"ffd20\", \"tooltipWorldConfig\", tooltipWorldConfig);\n  }\n};\n\n/* -------------------------------------------- */\n/*  Document Type Migration Helpers               */\n/* -------------------------------------------- */\n\n/**\n * Migrate data in tokens that is no longer used.\n *\n * @param {object} token Token data\n */\nexport const migrateTokenData = function (token) {\n  const flags = token.flags?.ffd20 ?? {};\n\n  // Remove obsolete flags\n  if (flags.lowLightVision !== undefined) {\n    token[\"flags.ffd20.-=lowLightVision\"] = null;\n  }\n  if (flags.lowLightVisionMultiplier !== undefined) {\n    token[\"flags.ffd20.-=lowLightVisionMultiplier\"] = null;\n  }\n  if (flags.lowLightVisionMultiplierBright !== undefined) {\n    token[\"flags.ffd20.-=lowLightVisionMultiplierBright\"] = null;\n  }\n\n  // Remove disabled but still in use flags\n  if (flags.disableLowLight === false) {\n    token[\"flags.ffd20.-=disableLowLight\"] = null;\n  }\n  if (flags.staticSize === false) {\n    token[\"flags.ffd20.-=staticSize\"] = null;\n  }\n  if (flags.customVisionRules === false) {\n    token[\"flags.ffd20.-=customVisionRules\"] = null;\n  }\n\n  // Remove data from v9 vision handling\n  // Added with PF1 v9.4\n  if (!flags.customVisionRules) {\n    // Attempt to preserve vision range after migration\n    if (token.sight.visionMode !== \"basic\") {\n      if (token.sight.range !== 0) token[\"sight.range\"] = 0;\n      token[\"sight.visionMode\"] = \"basic\";\n    }\n    if (\"saturation\" in token.sight) token[\"sight.-=saturation\"] = null;\n    if (\"brightness\" in token.sight) token[\"sight.-=brightness\"] = null;\n    if (\"attenuation\" in token.sight) token[\"sight.-=attenuation\"] = null;\n    if (\"contrast\" in token.sight) token[\"sight.-=contrast\"] = null;\n    if (token.detectionModes?.length) token[\"detectionModes\"] = [];\n  }\n};\n\n/**\n * Migrate token.\n *\n * @param {TokenDocument} token - Token to migrate\n * @returns {Promise<TokenDocument|null>} - Promise to updated document,. or null if no update was done.\n */\nexport async function migrateToken(token) {\n  const tokenData = token.toObject();\n  migrateTokenData(tokenData);\n  return token.update(tokenData);\n}\n\n/**\n * Migrate singular actor document.\n *\n * @param {Actor} actor - Actor to migrate.\n * @returns {Promise<Actor|null>}\n */\nexport async function migrateActor(actor) {\n  const updateData = migrateActorData(actor.toObject(), actor.token);\n  if (!foundry.utils.isEmpty(updateData)) {\n    return actor.update(updateData);\n  }\n  return null;\n}\n\n/**\n * Migrate a single Actor document to incorporate latest data model changes\n * Return an Object of updateData to be applied\n *\n * @param {ActorData} actor   The actor data to derive an update from\n * @param {TokenDocument} token\n * @returns {object}          The updateData to apply\n */\nexport function migrateActorData(actor, token) {\n  // Ignore basic actor type\n  if (actor.type === \"basic\") return {};\n\n  const updateData = {};\n  const linked = token?.isLinked ?? true;\n  _migrateCharacterLevel(actor, updateData, linked);\n  _migrateActorEncumbrance(actor, updateData, linked);\n  _migrateActorNoteArrays(actor, updateData);\n  _migrateActorSpeed(actor, updateData, linked);\n  _migrateSpellDivineFocus(actor, updateData);\n  _migrateActorConcentration(actor, updateData);\n  _migrateActorSpellbookCL(actor, updateData);\n  _migrateActorSpellbookSlots(actor, updateData, linked);\n  _migrateActorConcentration(actor, updateData);\n  _migrateActorBaseStats(actor, updateData);\n  _migrateUnusedActorCreatureType(actor, updateData);\n  _migrateActorSpellbookDCFormula(actor, updateData, linked);\n  _migrateActorHPAbility(actor, updateData);\n  _migrateActorCR(actor, updateData, linked);\n  _migrateAttackAbility(actor, updateData, linked);\n  _migrateActorDefenseAbility(actor, updateData);\n  _migrateActorSpellbookUsage(actor, updateData, linked);\n  _migrateActorNullValues(actor, updateData);\n  _migrateActorSpellbookDomainSlots(actor, updateData);\n  _migrateActorStatures(actor, updateData, linked);\n  _migrateActorInitAbility(actor, updateData, linked);\n  _migrateActorChangeRevamp(actor, updateData, linked);\n  _migrateActorCMBRevamp(actor, updateData, linked);\n  _migrateActorConditions(actor, updateData, linked);\n  _migrateActorSkillRanks(actor, updateData, linked);\n  _migrateCarryBonus(actor, updateData, linked);\n  _migrateBuggedValues(actor, updateData, linked);\n  _migrateSpellbookUsage(actor, updateData, linked);\n  _migrateActorHP(actor, updateData, linked);\n  _migrateActorSenses(actor, updateData, linked, token);\n  _migrateActorSkillJournals(actor, updateData, linked);\n  _migrateActorSubskillData(actor, updateData);\n  _migrateActorUnusedData(actor, updateData);\n  _migrateActorDRandER(actor, updateData);\n\n  // Migrate Owned Items\n  if (!actor.items) return updateData;\n  const items = actor.items.reduce((arr, i) => {\n    // Migrate the Owned Item\n    const itemData = i instanceof CONFIG.Item.documentClass ? i.toObject() : i;\n    const itemUpdate = migrateItemData(itemData, actor);\n\n    // Update the Owned Item\n    if (!foundry.utils.isEmpty(itemUpdate)) {\n      itemUpdate._id = itemData._id;\n      arr.push(expandObject(itemUpdate));\n    }\n\n    return arr;\n  }, []);\n  if (items.length > 0) updateData.items = items;\n  return updateData;\n}\n\n/* -------------------------------------------- */\n\n/**\n *  Migrate singular item document.\n *\n * @param {Item} item - Item document to update.\n * @returns {Promise<Item|null>} - Promise to updated item document, or null if no update was performed.\n */\nexport async function migrateItem(item) {\n  const updateData = migrateItemData(item.toObject(), item.actor);\n  if (!foundry.utils.isEmpty(updateData)) {\n    return item.update(updateData);\n  }\n  return null;\n}\n\n/**\n * Migrate a single Item document to incorporate latest data model changes\n *\n * @param {object} item    The item data to derive an update from\n * @param actor\n * @param _d\n * @returns {object}       The updateData to apply\n */\nexport const migrateItemData = function (item, actor = null, _d = 0) {\n  const updateData = {};\n\n  // Migrate data to system\n  if (item.system == null && item.data != null) {\n    item = deepClone(item);\n    item.system = item.data;\n    delete item.data;\n  }\n\n  _migrateItemArrayTypes(item, updateData);\n  _migrateItemSpellUses(item, updateData);\n  _migrateFlagsArrayToObject(item, updateData);\n  _migrateWeaponImprovised(item, updateData);\n  _migrateSpellDescription(item, updateData);\n  _migrateClassDynamics(item, updateData);\n  _migrateClassType(item, updateData);\n  _migrateWeaponCategories(item, updateData);\n  _migrateArmorCategories(item, updateData);\n  _migrateItemSize(item, updateData);\n  _migrateAbilityTypes(item, updateData);\n  _migrateClassLevels(item, updateData);\n  _migrateSavingThrowTypes(item, updateData);\n  _migrateCR(item, updateData);\n  _migrateItemChanges(item, updateData);\n  _migrateEquipmentSize(item, updateData);\n  _migrateTags(item, updateData);\n  _migrateSpellCosts(item, updateData);\n  _migrateLootEquip(item, updateData);\n  _migrateItemLinks(item, updateData);\n  _migrateProficiencies(item, updateData);\n  _migrateItemNotes(item, updateData);\n  _migrateSpellData(item, updateData);\n  _migrateItemActions(item, updateData, actor);\n  _migrateItemChargeCost(item, updateData);\n  _migrateItemWeight(item, updateData);\n  _migrateItemHealth(item, updateData);\n  _migrateContainerPrice(item, updateData);\n  _migrateItemType(item, updateData);\n  _migrateItemLearnedAt(item, updateData);\n  _migrateItemTuples(item, updateData);\n  _migrateEquipmentCategories(item, updateData);\n  _migrateItemUnusedData(item, updateData);\n\n  // Migrate action data\n  const alreadyHasActions = item.system.actions instanceof Array && item.system.actions.length > 0;\n  const itemActionData = alreadyHasActions ? item.system.actions : updateData[\"system.actions\"];\n  if (itemActionData instanceof Array) {\n    updateData[\"system.actions\"] = itemActionData.map((action) => migrateItemActionData(action, item));\n  }\n\n  // Migrate container items\n  if (item.system?.inventoryItems instanceof Array) {\n    updateData[\"system.inventoryItems\"] = item.system.inventoryItems.map((subItem) => {\n      subItem.system ??= {}; // HACK: For corrupt container items\n\n      const data = mergeObject(subItem, migrateItemData(subItem, actor, _d + 1), {\n        inplace: false,\n        performDeletions: true,\n      });\n\n      // Migrate data to system\n      if (data.data != null) {\n        data.system = mergeObject(data.data, data.system);\n        delete data.data;\n      }\n\n      return data;\n    });\n  }\n\n  // Return the migrated update data\n  return updateData;\n};\n\n/**\n * Older actors incorrectly has .range.value as number instead of string\n *\n * @param action\n * @param item\n */\nconst _migrateActionRange = (action, item) => {\n  const range = action.range?.value;\n  if (range === null || range === \"\") {\n    delete action.range.value;\n  } else if (range !== undefined && typeof range !== \"string\") {\n    action.range.value = String(range);\n  }\n};\n\n/**\n * Migrates a single action within an item.\n *\n * @param {object} action - The action's data, which also serves as the update data to pass on.\n * @param {object} item - The item data this action is in.\n * @returns {object} The resulting action data.\n */\nexport const migrateItemActionData = function (action, item) {\n  action = foundry.utils.mergeObject(ffd20.components.ItemAction.defaultData, action);\n\n  _migrateActionRange(action, item);\n  _migrateActionDamageParts(action, item);\n  _migrateUnchainedActionEconomy(action, item);\n  _migrateActionDamageType(action, item);\n  _migrateActionConditionals(action, item);\n  _migrateActionEnhOverride(action, item);\n  _migrateActionPrimaryAttack(action, item);\n  _migrateActionChargeUsage(action, item);\n\n  // Return the migrated update data\n  return action;\n};\n\n/* -------------------------------------------- */\n\n/**\n * Migrate singular scene document.\n *\n * @param {Scene} scene - Scene document to update.\n * @returns {Promise<void>}\n */\nexport async function migrateScene(scene) {\n  try {\n    await migrateSceneTokens(scene);\n    await migrateSceneActors(scene);\n  } catch (err) {\n    console.error(`Error migrating scene document \"${scene.name}\"`, err);\n  }\n}\n\n/**\n * Migrate a single Scene data object to incorporate changes to the data model of it's actor data overrides\n *\n * @param {object} scene - Scene data to Update\n * @returns {object} Update data to apply\n */\nexport const migrateSceneData = async function (scene) {\n  const tokens = [];\n  for (const token of scene.tokens) {\n    if (token.actorLink) continue;\n    const actorId = token.actorId;\n    const actor = game.actors.get(token.actorId);\n    if (!actor) continue;\n\n    const t = deepClone(token);\n\n    const mergedData = foundry.utils.mergeObject(actor.toObject(), t.delta ?? t.actorData);\n\n    const actorUpdate = migrateActorData(mergedData, token);\n    [\"items\", \"effects\"].forEach((embeddedName) => {\n      if (!actorUpdate[embeddedName]?.length) return;\n      const updates = new Map(actorUpdate[embeddedName].map((u) => [u._id, u]));\n      mergedData[embeddedName].forEach((original) => {\n        const update = updates.get(original._id);\n        if (update) foundry.utils.mergeObject(original, update);\n      });\n      delete actorUpdate[embeddedName];\n    });\n\n    if (game.release.generation >= 11) foundry.utils.mergeObject(t.delta, actorUpdate);\n    else foundry.utils.mergeObject(t.actorData, actorUpdate);\n\n    migrateTokenData(t);\n\n    tokens.push(t);\n  }\n  return { tokens };\n};\n\n/**\n * Migrate tokens in a single scene.\n *\n * @param {Scene} scene - The Scene to Update\n */\nexport async function migrateSceneTokens(scene) {\n  for (const token of scene.tokens) {\n    await migrateToken(token);\n  }\n}\n\n/**\n * Migrate unlinked actors on a single scene.\n *\n * @param {Scene} scene - Scene to migrate actors in.\n * @returns {Promise<void>}\n */\nexport async function migrateSceneActors(scene) {\n  for (const token of scene.tokens) {\n    if (token.isLinked) continue;\n    const actor = token.actor;\n    if (!actor) continue;\n\n    const updateData = migrateActorData(actor.toObject(), token);\n    if (!foundry.utils.isEmpty(updateData)) {\n      const items = updateData.items;\n      delete updateData.items;\n      const effects = updateData.effects;\n      delete updateData.effects;\n      if (!foundry.utils.isEmpty(updateData)) await actor.update(updateData);\n      if (items?.length) await actor.updateEmbeddedDocuments(\"Item\", items);\n      if (effects?.length) await actor.updateEmbeddedDocuments(\"ActiveEffect\", effects);\n    }\n  }\n}\n\n/* -------------------------------------------- */\n\nconst _migrateCharacterLevel = function (ent, updateData, linked) {\n  const arr = [\"details.level.value\", \"details.level.min\", \"details.level.max\", \"details.mythicTier\"];\n  if (!linked) return; // skip unlinked tokens\n  for (const k of arr) {\n    const value = getProperty(ent.system, k);\n    if (value == null) {\n      updateData[\"system.\" + k] = 0;\n    }\n  }\n};\n\nconst _migrateActorEncumbrance = function (ent, updateData, linked) {\n  const arr = {\n    \"system.attributes.encumbrance.level\": \"attributes.encumbrance.-=level\",\n    \"system.attributes.encumbrance.levels.light\": \"attributes.encumbrance.levels.-=light\",\n    \"system.attributes.encumbrance.levels.medium\": \"attributes.encumbrance.levels.-=medium\",\n    \"system.attributes.encumbrance.levels.heavy\": \"attributes.encumbrance.levels.-=heavy\",\n    \"system.attributes.encumbrance.levels.carry\": \"attributes.encumbrance.levels.-=carry\",\n    \"system.attributes.encumbrance.levels.drag\": \"attributes.encumbrance.levels.-=drag\",\n    \"system.attributes.encumbrance.carriedWeight\": \"attributes.encumbrance.-=carriedWeight\",\n  };\n  for (const [key, updateKey] of Object.entries(arr)) {\n    const value = getProperty(ent, key);\n    if (value !== undefined) {\n      updateData[\"system.\" + updateKey] = null;\n    }\n  }\n};\n\n/**\n * Convert array based flags into object.\n *\n * @param ent\n * @param updateData\n * @param linked\n */\nconst _migrateFlagsArrayToObject = function (ent, updateData) {\n  const flags = ent.system.flags;\n  if (!flags) return;\n  const bflags = flags.boolean,\n    dflags = flags.dictionary;\n\n  if (Array.isArray(bflags)) {\n    // Compatibility with old data: Convert old array into actual dictionary.\n    updateData[\"system.flags.boolean\"] = bflags.reduce((flags, flag) => {\n      flags[flag] = true;\n      return flags;\n    }, {});\n  }\n\n  if (Array.isArray(dflags)) {\n    updateData[\"system.flags.dictionary\"] = dflags.reduce((flags, [key, value]) => {\n      flags[key] = value;\n      return flags;\n    }, {});\n  }\n};\n\nconst _migrateActorNoteArrays = function (ent, updateData) {\n  const list = [\"system.attributes.acNotes\", \"system.attributes.cmdNotes\", \"system.attributes.srNotes\"];\n  for (const k of list) {\n    const value = getProperty(ent, k);\n    const hasValue = hasProperty(ent, k);\n    if (hasValue && value instanceof Array) {\n      updateData[k] = value.join(\"\\n\");\n    }\n  }\n};\n\nconst _migrateActorSpeed = function (ent, updateData, linked) {\n  const arr = [\n    \"attributes.speed.land\",\n    \"attributes.speed.climb\",\n    \"attributes.speed.swim\",\n    \"attributes.speed.fly\",\n    \"attributes.speed.burrow\",\n  ];\n  for (const k of arr) {\n    let value = getProperty(ent.system, k);\n    if (!linked && value === undefined) continue; // skip with unlinked tokens\n    if (typeof value === \"string\") value = parseInt(value);\n    if (typeof value === \"number\") {\n      updateData[`system.${k}.base`] = value;\n    } else if (value === null) {\n      updateData[`system.${k}.base`] = 0;\n    } else if (value?.total !== undefined) {\n      // Delete derived data\n      updateData[`system.${k}.-=total`] = null;\n    }\n\n    // Add maneuverability\n    if (k === \"attributes.speed.fly\" && getProperty(ent.system, `${k}.maneuverability`) === undefined) {\n      updateData[`system.${k}.maneuverability`] = \"average\";\n    }\n  }\n};\n\nconst _migrateActorSpellbookSlots = function (ent, updateData, linked) {\n  for (const spellbookSlot of Object.keys(getProperty(ent, \"system.attributes.spells.spellbooks\") || {})) {\n    if (getProperty(ent, `system.attributes.spells.spellbooks.${spellbookSlot}.autoSpellLevels`) == null) {\n      updateData[`system.attributes.spells.spellbooks.${spellbookSlot}.autoSpellLevels`] = true;\n    }\n\n    for (let a = 0; a < 10; a++) {\n      const baseKey = `system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.base`;\n      const maxKey = `system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.max`;\n      const base = getProperty(ent, baseKey);\n      const max = getProperty(ent, maxKey);\n\n      if (base === undefined) {\n        if (!linked) continue; // skip with unlinked tokens\n        if (typeof max === \"number\" && max > 0) {\n          updateData[baseKey] = max.toString();\n        }\n      } else {\n        const newBase = parseInt(base);\n        if (newBase > 0) {\n          if (newBase !== base) updateData[baseKey] = newBase;\n        } else {\n          // Remove pointless default value not present in new actors either\n          updateData[`system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.-=base`] = null;\n        }\n      }\n    }\n  }\n};\n\nconst _migrateActorBaseStats = function (ent, updateData) {\n  const keys = [\n    \"system.attributes.hp.base\",\n    \"system.attributes.hd.base\",\n    \"system.attributes.mp.base\",\n    \"system.attributes.savingThrows.fort.value\",\n    \"system.attributes.savingThrows.ref.value\",\n    \"system.attributes.savingThrows.will.value\",\n  ];\n  for (const k of keys) {\n    if (\n      k === \"system.attributes.hp.base\" &&\n      !(getProperty(ent, \"items\") || []).filter((o) => o.type === \"class\").length\n    )\n      continue;\n    if (\n      k === \"system.attributes.mp.base\" &&\n      !(getProperty(ent, \"items\") || []).filter((o) => o.type === \"class\").length\n    )\n      continue;\n    if (getProperty(ent, k) !== undefined) {\n      const kList = k.split(\".\");\n      kList[kList.length - 1] = `-=${kList[kList.length - 1]}`;\n      updateData[kList.join(\".\")] = null;\n    }\n  }\n};\n\nconst _migrateUnusedActorCreatureType = function (ent, updateData) {\n  const type = getProperty(ent, \"system.attributes.creatureType\");\n  if (type != undefined) updateData[\"system.attributes.-=creatureType\"] = null;\n};\n\nconst _migrateActorSpellbookDCFormula = function (ent, updateData, linked) {\n  const spellbooks = Object.keys(getProperty(ent, \"system.attributes.spells.spellbooks\") || {});\n\n  for (const k of spellbooks) {\n    const key = `system.attributes.spells.spellbooks.${k}.baseDCFormula`;\n    const curFormula = getProperty(ent, key);\n    if (!linked && curFormula === undefined) continue; // skip with unlinked tokens\n    if (curFormula == null) updateData[key] = \"10 + @sl + @ablMod\";\n  }\n};\n\nconst _migrateActorSpellbookName = function (ent, updateData) {\n  const spellbooks = Object.entries(getProperty(ent, \"system.attributes.spells.spellbooks\") || {});\n  for (const [bookId, book] of spellbooks) {\n    if (book.altName !== undefined) {\n      const key = `system.attributes.spells.spellbooks.${bookId}`;\n      updateData[`${key}.-=altName`] = null;\n      if (book.altName.length) updateData[`${key}.name`] = book.altName;\n    }\n  }\n};\n\nconst _migrateActorSpellbookCL = function (ent, updateData) {\n  const spellbooks = Object.keys(getProperty(ent, \"system.attributes.spells.spellbooks\") || {});\n\n  for (const k of spellbooks) {\n    const key = `system.attributes.spells.spellbooks.${k}.cl`;\n    const curBase = parseInt(getProperty(ent, key + \".base\"));\n    const curFormula = getProperty(ent, key + \".formula\");\n    if (curBase > 0) {\n      if (curFormula.length > 0) updateData[`${key}.formula`] = curFormula + \" + \" + curBase;\n      else updateData[`${key}.formula`] = curFormula + curBase;\n      updateData[`${key}.base`] = 0;\n    }\n  }\n};\n\nconst _migrateActorConcentration = function (ent, updateData) {\n  const spellbooks = Object.keys(getProperty(ent, \"system.attributes.spells.spellbooks\") || {});\n  for (const k of spellbooks) {\n    // Delete unused .concentration from old actors\n    const key = `system.attributes.spells.spellbooks.${k}`;\n    const oldValue = getProperty(ent, `${key}.concentration`);\n    const isString = typeof oldValue === \"string\";\n    if (Number.isFinite(oldValue) || isString) updateData[`${key}.-=concentration`] = null;\n    if (isString) {\n      // Assume erroneous bonus formula location and combine it with existing bonus formula.\n      const formulaKey = `${key}.concentrationFormula`;\n      const formula = [oldValue];\n      formula.push(getProperty(ent, formulaKey) || \"\");\n      updateData[formulaKey] = formula.filter((f) => f !== 0 && f?.toString().trim().length).join(\" + \");\n    }\n  }\n};\n\nconst _migrateActorHPAbility = function (ent, updateData) {\n  // Set HP ability\n  if (getProperty(ent, \"system.attributes.hpAbility\") === undefined) {\n    updateData[\"system.attributes.hpAbility\"] = \"con\";\n  }\n\n  // Set Fortitude save ability\n  if (getProperty(ent, \"system.attributes.savingThrows.fort.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.fort.ability\"] = \"con\";\n  }\n\n  // Set Reflex save ability\n  if (getProperty(ent, \"system.attributes.savingThrows.ref.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.ref.ability\"] = \"dex\";\n  }\n\n  // Set Will save ability\n  if (getProperty(ent, \"system.attributes.savingThrows.will.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.will.ability\"] = \"wis\";\n  }\n};\n\nconst _migrateItemArrayTypes = function (ent, updateData) {\n  const conditionals = getProperty(ent, \"system.conditionals\");\n  if (conditionals != null && !(conditionals instanceof Array)) {\n    updateData[\"system.conditionals\"] = [];\n  }\n\n  const contextNotes = getProperty(ent, \"system.contextNotes\");\n  if (contextNotes != null && !(contextNotes instanceof Array)) {\n    if (contextNotes instanceof Object) updateData[\"system.contextNotes\"] = Object.values(contextNotes);\n    else updateData[\"system.contextNotes\"] = [];\n  }\n};\n\nconst _migrateItemSpellUses = function (ent, updateData) {\n  if (getProperty(ent.system, \"preparation\") === undefined) return;\n\n  const value = getProperty(ent.system, \"preparation.maxAmount\");\n  if (typeof value !== \"number\") updateData[\"system.preparation.maxAmount\"] = 0;\n};\n\nconst _migrateWeaponImprovised = function (ent, updateData) {\n  if (ent.type !== \"weapon\") return;\n\n  const value = getProperty(ent.system, \"weaponType\");\n  if (value === \"improv\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.properties.imp\"] = true;\n  }\n};\n\nconst _migrateSpellDescription = function (ent, updateData) {\n  if (ent.type !== \"spell\") return;\n\n  const curValue = getProperty(ent, \"system.shortDescription\");\n  if (curValue != null) return;\n\n  const obj = getProperty(ent, \"system.description.value\");\n  if (typeof obj !== \"string\") return;\n  const html = $(`<div>${obj}</div>`);\n  const elem = html.find(\"h2\").next();\n  if (elem.length === 1) updateData[\"system.shortDescription\"] = elem.prop(\"outerHTML\");\n  else updateData[\"system.shortDescription\"] = html.prop(\"innerHTML\");\n};\n\nconst _migrateSpellDivineFocus = function (ent, updateData) {\n  if (ent.type !== \"spell\") return;\n\n  const value = getProperty(ent, \"system.components.divineFocus\");\n  if (typeof value === \"boolean\") updateData[\"system.components.divineFocus\"] = value === true ? 1 : 0;\n};\n\nconst _migrateClassDynamics = function (ent, updateData) {\n  if (ent.type !== \"class\") return;\n\n  const bab = getProperty(ent, \"system.bab\");\n  if (typeof bab === \"number\") updateData[\"system.bab\"] = \"low\";\n\n  const stKeys = [\"system.savingThrows.fort.value\", \"system.savingThrows.ref.value\", \"system.savingThrows.will.value\"];\n  for (const key of stKeys) {\n    const value = getProperty(ent, key);\n    if (typeof value === \"number\") updateData[key] = \"low\";\n  }\n};\n\nconst _migrateClassType = function (ent, updateData) {\n  if (ent.type !== \"class\") return;\n\n  if (getProperty(ent, \"system.classType\") == null) updateData[\"system.classType\"] = \"base\";\n};\n\nconst _migrateWeaponCategories = function (ent, updateData) {\n  if (ent.type !== \"weapon\") return;\n\n  // Change category\n  const type = getProperty(ent, \"system.weaponType\");\n  if (type === \"misc\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.weaponSubtype\"] = \"other\";\n  } else if (type === \"splash\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.weaponSubtype\"] = \"splash\";\n  }\n\n  const changeProp = [\"simple\", \"martial\", \"exotic\", \"chef\", \"power\"].includes(type);\n  if (changeProp && getProperty(ent, \"system.weaponSubtype\") == null) {\n    updateData[\"system.weaponSubtype\"] = \"1h\";\n  }\n\n  // Change light property\n  const lgt = getProperty(ent, \"system.properties.lgt\");\n  if (lgt != null) {\n    updateData[\"system.properties.-=lgt\"] = null;\n    if (lgt === true && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"light\";\n    }\n  }\n\n  // Change two-handed property\n  const two = getProperty(ent, \"system.properties.two\");\n  if (two != null) {\n    updateData[\"system.properties.-=two\"] = null;\n    if (two === true && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"2h\";\n    }\n  }\n\n  // Change melee property\n  const melee = getProperty(ent, \"system.weaponData.isMelee\");\n  if (melee != null) {\n    updateData[\"system.weaponData.-=isMelee\"] = null;\n    if (melee === false && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"ranged\";\n    }\n  }\n};\n\nconst _migrateArmorCategories = function (ent, updateData) {\n  if (ent.type !== \"equipment\") return;\n\n  const oldType = getProperty(ent, \"system.armor.type\");\n  if (oldType == null) return;\n\n  if (oldType === \"clothing\") {\n    updateData[\"system.equipmentType\"] = \"misc\";\n    updateData[\"system.equipmentSubtype\"] = \"clothing\";\n  } else if (oldType === \"shield\") {\n    updateData[\"system.equipmentType\"] = \"shield\";\n    updateData[\"system.equipmentSubtype\"] = \"lightShield\";\n  } else if (oldType === \"misc\") {\n    updateData[\"system.equipmentType\"] = \"misc\";\n    updateData[\"system.equipmentSubtype\"] = \"wondrous\";\n  } else if ([\"light\", \"medium\", \"heavy\"].includes(oldType)) {\n    updateData[\"system.equipmentType\"] = \"armor\";\n    updateData[\"system.equipmentSubtype\"] = `${oldType}Armor`;\n  }\n\n  updateData[\"system.armor.-=type\"] = null;\n};\n\nconst _migrateEquipmentCategories = (item, updateData) => {\n  if (item.type !== \"equipment\") return;\n\n  const subtype = updateData[\"system.subType\"] ?? item.system.subType;\n  if (subtype !== \"misc\") return;\n\n  switch (item.system.equipmentSubtype) {\n    case \"wondrous\":\n      updateData[\"system.subType\"] = \"wondrous\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n    case \"clothing\":\n      updateData[\"system.subType\"] = \"clothing\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n    case \"other\":\n      updateData[\"system.subType\"] = \"other\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n  }\n};\n\nconst _migrateItemSize = function (ent, updateData, linked) {\n  // Convert custom sizing in weapons\n  if (ent.type === \"weapon\") {\n    const wdSize = getProperty(ent, \"system.weaponData.size\");\n    if (wdSize) {\n      // Move old\n      updateData[\"system.size\"] = wdSize;\n      updateData[\"system.weaponData.-=size\"] = null;\n      return;\n    }\n  }\n\n  const oldSize = getProperty(ent, \"system.size\");\n  if ([\"spell\", \"class\", \"buff\", \"feat\"].includes(ent.type)) {\n    // Remove size from abstract items\n    if (oldSize !== undefined) {\n      updateData[\"system.-=size\"] = null;\n    }\n  } else {\n    // Add default size to everything else if not present\n    if (oldSize === undefined) {\n      updateData[\"system.size\"] = \"med\";\n    }\n  }\n};\n\nconst _migrateAbilityTypes = function (ent, updateData) {\n  if (ent.type !== \"feat\") return;\n\n  if (getProperty(ent, \"system.abilityType\") == null) {\n    updateData[\"system.abilityType\"] = \"none\";\n  }\n  // Fix buggy value\n  if (getProperty(ent, \"system.abilityType\") === \"n/a\") {\n    updateData[\"system.abilityType\"] = \"none\";\n  }\n};\n\nconst _migrateClassLevels = function (ent, updateData) {\n  const level = getProperty(ent, \"system.levels\");\n  if (typeof level === \"number\" && getProperty(ent, \"system.level\") == null) {\n    updateData[\"system.level\"] = level;\n    updateData[\"system.-=levels\"] = null;\n  }\n};\n\nconst _migrateSavingThrowTypes = function (ent, updateData) {\n  if (getProperty(ent, \"system.save.type\") == null && typeof getProperty(ent, \"system.save.description\") === \"string\") {\n    const desc = getProperty(ent, \"system.save.description\");\n    if (desc.match(/REF/i)) updateData[\"system.save.type\"] = \"ref\";\n    else if (desc.match(/FORT/i)) updateData[\"system.save.type\"] = \"fort\";\n    else if (desc.match(/WILL/i)) updateData[\"system.save.type\"] = \"will\";\n  }\n};\n\nconst _migrateCR = function (ent, updateData) {\n  // Migrate CR offset\n  const crOffset = getProperty(ent, \"system.crOffset\");\n  if (typeof crOffset === \"number\") {\n    updateData[\"system.crOffset\"] = crOffset.toString();\n  }\n};\n\nconst _migrateItemChanges = function (ent, updateData) {\n  // Migrate changes\n  const changes = getProperty(ent, \"system.changes\");\n  if (changes != null && changes instanceof Array) {\n    const newChanges = [];\n    for (const c of changes) {\n      if (c instanceof Array) {\n        const newChange = new ItemChange(\n          {\n            formula: c[0],\n            target: c[1],\n            subTarget: c[2],\n            modifier: c[3],\n            value: c[4],\n          },\n          null\n        );\n        newChanges.push(newChange.data);\n      } else {\n        const newChange = new ItemChange(c, null);\n        newChanges.push(newChange.data);\n      }\n    }\n\n    // Alter the changes list, but only if at least one of them is nonzero length\n    if (newChanges.length !== 0 && changes.length !== 0) {\n      updateData[\"system.changes\"] = newChanges;\n    }\n  }\n\n  // Migrate context notes\n  const notes = getProperty(ent, \"system.contextNotes\");\n  if (notes != null && notes instanceof Array) {\n    const newNotes = [];\n    for (const n of notes) {\n      if (n instanceof Array) {\n        newNotes.push(\n          foundry.utils.mergeObject(ItemPF.defaultContextNote, { text: n[0], subTarget: n[2] }, { inplace: false })\n        );\n      } else {\n        newNotes.push(n);\n      }\n\n      // Migrate old note targets\n      if (n.target === \"spell\" && n.subTarget === \"effect\") {\n        n.subTarget = \"spellEffect\";\n      }\n    }\n\n    // Alter the context note list, but only if at least one of them is nonzero length\n    if (newNotes.length !== 0 && notes.length !== 0) {\n      updateData[\"system.contextNotes\"] = newNotes;\n    }\n  }\n};\n\nconst _migrateEquipmentSize = function (ent, updateData) {\n  if (ent.type !== \"equipment\") return;\n\n  const size = getProperty(ent, \"system.size\");\n  if (!size) {\n    updateData[\"system.size\"] = \"med\";\n  }\n};\n\n// Migrate .weight number to .weight.value\n// Migrate .baseWeight that was briefly introduced in 0.81\nconst _migrateItemWeight = function (ent, updateData) {\n  const baseWeight = getProperty(ent, \"system.baseWeight\"),\n    weight = getProperty(ent, \"system.weight\");\n\n  // Skip items of inappropriate type\n  if (!game.system.template.Item[ent.type].templates.includes(\"physicalItem\")) {\n    if (weight !== undefined) {\n      // Ensure inappropriate items don't have spurious weight, which breaks data prep\n      updateData[\"system.-=weight\"] = null;\n    }\n    return;\n  }\n\n  if (Number.isFinite(weight)) {\n    updateData[\"system.weight.value\"] = weight;\n  } else if (weight == null || typeof weight !== \"object\") {\n    // Convert any other values to just 0 weight, e.g. null\n    updateData[\"system.weight.value\"] = 0;\n  }\n\n  // If baseWeight exists and looks reasonable, use it for base weight instead\n  if (baseWeight !== undefined) {\n    if (Number.isFinite(baseWeight) && baseWeight > 0) {\n      updateData[\"system.weight.value\"] = baseWeight;\n    }\n    updateData[\"system.-=baseWeight\"] = null;\n  }\n};\n\nconst _migrateItemHealth = function (item, updateData) {\n  const isPhysical = CONFIG.Item.documentClasses[item.type]?.isPhysical;\n\n  const hp = item.system.hp;\n  if (isPhysical) {\n    if (hp) {\n      // Fix invalid data type\n      if (typeof hp.max === \"string\") updateData[\"system.hp.max\"] = parseInt(hp.max);\n      if (typeof hp.value === \"string\") updateData[\"system.hp.value\"] = parseInt(hp.value);\n    } else {\n      // Restore missing HP data\n      updateData[\"system.hp.value\"] = 10;\n      updateData[\"system.hp.max\"] = 10;\n    }\n  } else if (item.type !== \"class\" && hp !== undefined) {\n    updateData[\"system.-=hp\"] = null;\n  }\n};\n\nconst _migrateTags = function (ent, updateData) {\n  if (![\"class\"].includes(ent.type)) return;\n\n  const tag = getProperty(ent, \"system.tag\");\n  if (!tag && ent.name) {\n    updateData[\"system.tag\"] = createTag(ent.name);\n  }\n};\n\nconst _migrateSpellCosts = function (ent, updateData) {\n  if (ent.type !== \"spell\") return;\n\n  const spellPointCost = getProperty(ent, \"system.spellPoints.cost\");\n  if (spellPointCost == null) {\n    updateData[\"system.spellPoints.cost\"] = \"1 + @sl\";\n  }\n\n  const slotCost = getProperty(ent, \"system.slotCost\");\n  if (slotCost == null) {\n    updateData[\"system.slotCost\"] = 1;\n  }\n\n  const autoDeduct = ent.system.preparation?.autoDeductCharges;\n  if (autoDeduct !== undefined) {\n    if (autoDeduct === false) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n    updateData[\"system.preparation.-=autoDeductCharges\"] = null;\n  }\n};\n\nconst _migrateLootEquip = function (ent, updateData) {\n  if (ent.type === \"loot\" && !hasProperty(ent, \"system.equipped\")) {\n    updateData[\"system.equipped\"] = false;\n  }\n};\n\nconst _migrateUnchainedActionEconomy = (action, item) => {\n  action.activation ??= {};\n  // Migrate .unchainedAction.activation to .activation.unchained\n  if (action.unchainedAction?.activation) {\n    action.activation.unchained = action.unchainedAction.activation;\n    delete action.unchainedAction;\n  }\n};\n\nconst _migrateItemLinks = function (ent, updateData) {\n  if ([\"attack\", \"consumable\", \"equipment\"].includes(ent.type) && !hasProperty(ent, \"system.links.charges\")) {\n    updateData[\"system.links.charges\"] = [];\n  }\n\n  const linkData = ent.system.links ?? {};\n  for (const [linkType, oldLinks] of Object.entries(linkData)) {\n    let updated = false;\n    const links = deepClone(oldLinks);\n    for (const link of links) {\n      const type = link.dataType;\n      if (type !== undefined) {\n        if (type === \"data\") {\n          delete link.dataType;\n        } else if (type === \"world\") {\n          // Reconstruct world item UUID\n          link.uuid = link.id.replace(/^world\\./, \"Item.\");\n          delete link.id;\n          delete link.dataType;\n        } else if (type === \"compendium\") {\n          // Reconstruct compendium UUID\n          link.uuid = `Compendium.${link.id}`;\n          delete link.id;\n          delete link.dataType;\n        }\n        delete link.img;\n        updated = true;\n      }\n\n      if (link._index !== undefined) {\n        delete link._index;\n        updated = true;\n      }\n\n      if (link.hiddenLinks !== undefined) {\n        delete link.hiddenLinks;\n        updated = true;\n      }\n    }\n\n    if (updated) {\n      updateData[`system.links.${linkType}`] = links;\n    }\n  }\n};\n\nconst _migrateProficiencies = function (ent, updateData) {\n  // Add proficiency objects to items able to grant proficiencies\n  if ([\"feat\", \"class\", \"race\"].includes(ent.type)) {\n    for (const prof of [\"armorProf\", \"weaponProf\"]) {\n      if (!hasProperty(ent, `system.${prof}`))\n        updateData[`system.${prof}`] = {\n          value: [],\n          custom: \"\",\n        };\n    }\n  }\n};\n\nconst _migrateItemNotes = function (ent, updateData) {\n  const list = [\"system.attackNotes\", \"system.effectNotes\"];\n  for (const k of list) {\n    const value = getProperty(ent, k);\n    const hasValue = hasProperty(ent, k);\n    if (hasValue && !(value instanceof Array)) {\n      updateData[k] = [];\n      if (typeof value === \"string\" && value.length > 0) {\n        updateData[k] = value.trim().split(/[\\n\\r]/);\n      }\n    }\n  }\n};\n\n/**\n * @param item\n * @param updateData\n */\nconst _migrateSpellData = function (item, updateData) {\n  if (item.type === \"spell\") {\n    if (item.system.description?.value !== undefined) {\n      updateData[\"system.description.-=value\"] = null;\n    }\n  }\n};\n\nconst _migrateItemActions = function (item, updateData, actor = null) {\n  const hasOldAction =\n    !!item.system.actionType || !!item.system.activation?.type || !!item.system.measureTemplate?.type;\n  const alreadyHasActions = item.system.actions instanceof Array && item.system.actions.length > 0;\n  if ((!hasOldAction && item.type !== \"spell\") || alreadyHasActions) return;\n\n  // Transfer data to an action\n  const actionData = ffd20.components.ItemAction.defaultData;\n  const removeKeys = [\"_id\", \"name\", \"img\"];\n  for (const k of Object.keys(actionData)) {\n    if (!removeKeys.includes(k)) {\n      if (item.system[k] != null) actionData[k] = deepClone(item.system[k]);\n    }\n  }\n\n  // Transfer name and image\n  if ([\"weapon\", \"attack\"].includes(item.type)) {\n    actionData.name = game.i18n.localize(\"FFD20.Attack\");\n  } else {\n    actionData.name = game.i18n.localize(\"FFD20.Use\");\n  }\n  actionData.img = item.img;\n  // Clear description\n  actionData.description = \"\";\n  // Add spell data\n  if (item.type === \"spell\") {\n    // Make sure it has an activation type\n    actionData.activation.type ||= \"standard\";\n\n    // Transfer spell duration\n    actionData.duration.value = item.system.spellDuration;\n\n    // Transfer spell point cost\n    if (actor != null) {\n      const spellbookKey = item.system.spellbook;\n      const spellbook = actor.system.attributes?.spells?.spellbooks?.[spellbookKey];\n      if (spellbook.spellPoints?.useSystem) {\n        const oldSpellPointCostFormula = item.system.spellPoints?.cost;\n        if (oldSpellPointCostFormula) actionData.uses.autoDeductChargesCost = oldSpellPointCostFormula;\n      }\n    }\n  }\n\n  // Fix power attack multiplier being non-number\n  const paMult = actionData.powerAttack?.multiplier;\n  if (typeof paMult === \"string\") {\n    if (paMult === \"\") delete actionData.powerAttack.multiplier;\n    else actionData.powerAttack.multiplier = parseInt(paMult);\n  }\n\n  // Clean out old attack and effect notes\n  updateData[\"system.attackNotes\"] = [];\n  updateData[\"system.effectNotes\"] = [];\n\n  updateData[\"system.actions\"] = [actionData];\n};\n\n/**\n * Convert tuple learnedAt values into key:value pairs directly in the object.\n *\n * @param item\n * @param updateData\n */\nconst _migrateItemLearnedAt = (item, updateData) => {\n  const learnedAt = item.system.learnedAt ?? {};\n  for (const [category, value] of Object.entries(learnedAt)) {\n    if (Array.isArray(value)) {\n      updateData[`system.learnedAt.${category}`] = value.reduce((learned, [classId, level]) => {\n        for (let clsId of classId.split(\"/\")) {\n          clsId = clsId.trim().replace(\".\", \"-\"); // Sanitize\n          if (clsId) learned[clsId] = level;\n        }\n        return learned;\n      }, {});\n    }\n  }\n};\n\nconst _migrateActionChargeUsage = function (action, item) {\n  if (action.uses?.autoDeductCharges !== undefined) {\n    if (action.uses.autoDeductCharges === false) {\n      action.uses.autoDeductChargesCost = \"0\";\n    } else if (action.uses.autoDeductChargesCost === \"1\") action.uses.autoDeductChargesCost = \"\";\n    delete action.uses.autoDeductCharges;\n  }\n};\n\nconst _migrateItemChargeCost = function (item, updateData) {\n  const toggle = item.system.uses?.autoDeductCharges;\n  if (toggle !== undefined) {\n    // Mimic old setting by setting cost to 0\n    if (toggle === false) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n    updateData[\"system.uses.-=autoDeductCharges\"] = null;\n  }\n  // Special handling for cantrips if the above didn't match\n  else if (item.system.level === 0 && item.system.uses?.autoDeductChargesCost === undefined) {\n    const defaultAction = item.system.actions?.[0];\n    // Check for presence of obsoleted autoDeductCharges in first action\n    if (\n      defaultAction?.uses.autoDeductCharges === true &&\n      updateData[\"system.uses.autoDeductChargesCost\"] === undefined\n    ) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n  }\n};\n\n/**\n * Migrate damage part tuples into objects\n *\n * Introduced with PF1 v9\n *\n * @param {*} action\n * @param {*} item\n */\nconst _migrateActionDamageParts = function (action, item) {\n  const categories = action.damage;\n  for (const part of [\"parts\", \"critParts\", \"nonCritParts\"]) {\n    const category = categories[part];\n    if (!category) continue;\n\n    category.forEach((damage, index) => {\n      if (Array.isArray(damage)) {\n        const [formula, type] = damage;\n        category[index] = { formula, type };\n      }\n    });\n  }\n};\n\nconst _migrateActionDamageType = function (action, item) {\n  // Determine data paths using damage types\n  const damageGroupPaths = [\"damage.parts\", \"damage.critParts\", \"damage.nonCritParts\"];\n  for (const damageGroupPath of damageGroupPaths) {\n    const damageGroup = getProperty(action, damageGroupPath);\n    for (const damagePart of damageGroup) {\n      // Convert damage types\n      const damageType = damagePart.type;\n      if (typeof damageType === \"string\") {\n        const damageTypeData = ffd20.components.ItemAction.defaultDamageType;\n        damageTypeData.values = _Action_ConvertDamageType(damageType);\n        if (damageTypeData.values.length === 0) damageTypeData.custom = damageType;\n        damagePart.type = damageTypeData;\n      }\n      // Convert array to object\n      else if (damageType instanceof Array) {\n        const damageTypeData = ffd20.components.ItemAction.defaultDamageType;\n        damageTypeData.values = damageType;\n        damagePart.type = damageTypeData;\n      }\n    }\n  }\n};\n\nconst _migrateActionConditionals = function (action, item) {\n  for (const conditional of action.conditionals ?? []) {\n    // Create conditional ID\n    if (!conditional._id) conditional._id = randomID(16);\n\n    if (!Array.isArray(conditional.modifiers)) {\n      conditional.modifiers = Object.values(conditional.modifiers);\n    }\n\n    for (const modifier of conditional.modifiers) {\n      // Create modifier ID\n      if (!modifier._id) modifier._id = randomID(16);\n\n      // Ensure subTarget exists\n      modifier.subTarget ??= \"\";\n\n      let reResult;\n      // Convert modifier subtarget\n      if ((reResult = modifier.subTarget.match(/^attack\\.([0-9]+)/))) {\n        modifier.subTarget = `attack_${reResult[1]}`;\n      }\n\n      // Remove excess sheet data that was previously incorretly added\n      delete modifier.targets;\n      delete modifier.subTargets;\n      delete modifier.conditionalModifierTypes;\n      delete modifier.conditionalCritical;\n\n      // Convert modifier damage type\n      if (modifier.target === \"damage\" && !modifier.damageType) {\n        const damageTypeData = ffd20.components.ItemAction.defaultDamageType;\n        damageTypeData.values = _Action_ConvertDamageType(modifier.type);\n        if (damageTypeData.values.length === 0) damageTypeData.custom = modifier.type;\n        modifier.damageType = damageTypeData;\n        modifier.type = \"\";\n      }\n    }\n  }\n};\n\nconst _migrateActionEnhOverride = function (action, item) {\n  if (typeof action.enh !== \"object\") {\n    action.enh = { value: action.enh ?? null };\n  }\n\n  // Set to null if disabled.\n  if (action.enh.override == false) {\n    action.enh.value = null;\n  }\n  // Reset odd values to null, too.\n  else if (action.enh.value !== null && typeof action.enh.value !== \"number\") {\n    action.enh.value = null;\n  }\n  // Delete now unused .override toggle\n  delete action.enh.override;\n};\n\nconst _migrateActionPrimaryAttack = function (action, item) {\n  if (action.naturalAttack?.primaryAttack === undefined) {\n    setProperty(action, \"naturalAttack.primaryAttack\", item.system.primaryAttack);\n  }\n};\n\nconst _migrateActorCR = function (ent, updateData, linked) {\n  // Migrate base CR\n  const cr = getProperty(ent, \"system.details.cr\");\n  if (!linked && cr === undefined) return; // skip with unlinked tokens\n  if (typeof cr === \"number\") {\n    updateData[\"system.details.cr.base\"] = cr;\n  } else if (cr == null) {\n    updateData[\"system.details.cr.base\"] = 1;\n  }\n\n  // Remove derived data if present\n  if (getProperty(ent, \"system.details.cr.total\") !== undefined) {\n    updateData[\"system.details.cr.-=total\"] = null;\n  }\n};\n\nconst _migrateAttackAbility = function (ent, updateData, linked) {\n  const cmbAbl = getProperty(ent, \"system.attributes.cmbAbility\");\n  if (cmbAbl === undefined && linked) updateData[\"system.attributes.cmbAbility\"] = \"str\";\n\n  const meleeAbl = getProperty(ent, \"system.attributes.attack.meleeAbility\");\n  if (meleeAbl === undefined && linked) updateData[\"system.attributes.attack.meleeAbility\"] = \"str\";\n\n  const rangedAbl = getProperty(ent, \"system.attributes.attack.rangedAbility\");\n  if (rangedAbl === undefined && linked) updateData[\"system.attributes.attack.rangedAbility\"] = \"dex\";\n};\n\nconst _migrateActorSpellbookUsage = function (ent, updateData, linked) {\n  const spellbookUsage = getProperty(ent, \"system.attributes.spells.usedSpellbooks\");\n  if (spellbookUsage !== undefined) {\n    updateData[\"system.attributes.spells.-=usedSpellbooks\"] = null;\n  }\n};\n\nconst _migrateActorNullValues = function (ent, updateData) {\n  // Prepare test data\n  const entries = { \"system.attributes.energyDrain\": getProperty(ent, \"system.attributes.energyDrain\") };\n  for (const [k, a] of Object.entries(getProperty(ent, \"system.abilities\") || {})) {\n    entries[`system.abilities.${k}.damage`] = a.damage;\n    entries[`system.abilities.${k}.drain`] = a.drain;\n    entries[`system.abilities.${k}.penalty`] = a.penalty;\n  }\n\n  // Set null values to 0\n  for (const [k, v] of Object.entries(entries)) {\n    if (v === null) {\n      updateData[k] = 0;\n    }\n  }\n};\n\nconst _migrateActorSpellbookDomainSlots = function (ent, updateData) {\n  const spellbooks = getProperty(ent, \"system.attributes.spells.spellbooks\") || {};\n\n  for (const [k, b] of Object.entries(spellbooks)) {\n    if (b.domainSlotValue !== undefined) continue;\n    const key = `system.attributes.spells.spellbooks.${k}.domainSlotValue`;\n    updateData[key] = 1;\n  }\n};\n\nconst _migrateActorStatures = function (ent, updateData) {\n  const stature = getProperty(ent, \"system.traits.stature\");\n\n  if (stature === undefined) {\n    updateData[\"system.traits.stature\"] = \"tall\";\n  }\n};\n\nconst _migrateActorDefenseAbility = function (ent, updateData) {\n  const normalACAbl = getProperty(ent, \"system.attributes.ac.normal.ability\");\n  if (normalACAbl === undefined) updateData[\"system.attributes.ac.normal.ability\"] = \"dex\";\n  const touchACAbl = getProperty(ent, \"system.attributes.ac.touch.ability\");\n  if (touchACAbl === undefined) updateData[\"system.attributes.ac.touch.ability\"] = \"dex\";\n\n  // CMD\n  const cmdDexAbl = getProperty(ent, \"system.attributes.cmd.dexAbility\");\n  if (cmdDexAbl === undefined) updateData[\"system.attributes.cmd.dexAbility\"] = \"dex\";\n  const cmdStrAbl = getProperty(ent, \"system.attributes.cmd.strAbility\");\n  if (cmdStrAbl === undefined) updateData[\"system.attributes.cmd.strAbility\"] = \"str\";\n};\n\nconst _migrateActorInitAbility = function (ent, updateData) {\n  const abl = getProperty(ent, \"system.attributes.init.ability\");\n\n  if (abl === undefined) {\n    updateData[\"system.attributes.init.ability\"] = \"dex\";\n  }\n};\n\nconst _migrateActorCMBRevamp = function (ent, updateData, linked) {\n  if (getProperty(ent, \"system.attributes.cmb.total\") !== undefined) {\n    updateData[\"system.attributes.cmb.-=total\"] = null;\n  }\n};\n\nconst _migrateActorChangeRevamp = function (ent, updateData) {\n  // Skills\n  Object.keys(getProperty(ent, \"system.skills\") ?? {}).forEach((s) => {\n    const path = `system.skills.${s}.`;\n    if (getProperty(ent, path + \"changeBonus\") !== undefined) {\n      updateData[path + \"-=changeBonus\"] = null;\n    }\n\n    // Check for subskill\n    Object.keys(getProperty(ent, `system.skills.${s}.subSkills`) ?? {}).forEach((s2) => {\n      const subPath = `system.skills.${s}.subSkills.${s2}.`;\n      if (getProperty(ent, subPath + \"changeBonus\") !== undefined) {\n        updateData[subPath + \"-=changeBonus\"] = null;\n      }\n    });\n  });\n\n  // Remove derived data\n  const derivedKeys = {\n    \"system.attributes.hp.max\": \"attributes.hp.-=max\",\n    \"system.attributes.mp.max\": \"attributes.mp.-=max\",\n    \"system.attributes.ac.normal.total\": \"attributes.ac.normal.-=total\",\n    \"system.attributes.ac.touch.total\": \"attributes.ac.touch.-=total\",\n    \"system.attributes.ac.flatFooted.total\": \"attributes.ac.flatFooted.-=total\",\n    \"system.attributes.cmd.total\": \"attributes.cmd.-=total\",\n    \"system.attributes.cmd.flatFootedTotal\": \"attributes.cmd.-=flatFootedTotal\",\n    \"system.attributes.sr.total\": \"attributes.sr.-=total\",\n    \"system.attributes.init.total\": \"attributes.init.-=total\",\n  };\n\n  Object.entries(derivedKeys).forEach(([key, updateKey]) => {\n    if (getProperty(ent, key) !== undefined) {\n      updateData[\"system.\" + updateKey] = null;\n    }\n  });\n};\n\nconst _migrateActorConditions = function (ent, updateData) {\n  // Migrate fear to shaken\n  {\n    const cond = getProperty(ent, \"system.conditions.fear\");\n    if (cond !== undefined) {\n      if (cond === true) updateData[\"system.attributes.conditions.shaken\"] = true;\n      updateData[\"system.conditions.-=fear\"] = null;\n    }\n    const condAlt = getProperty(ent, \"system.attributes.conditions.fear\");\n    if (condAlt !== undefined) {\n      if (condAlt === true) updateData[\"system.attributes.conditions.shaken\"] = true;\n      updateData[\"system.attributes.conditions.-=fear\"] = null;\n    }\n  }\n};\n\n/**\n * Migrate abnormal skill rank values to 0.\n * Primarily changing nulls to 0 to match new actors.\n *\n * @param ent\n * @param updateData\n * @param linked\n */\nconst _migrateActorSkillRanks = function (ent, updateData, linked) {\n  const skills = getProperty(ent, \"system.skills\");\n  if (!skills) return; // Unlinked with no skill overrides of any kind\n  for (const [key, data] of Object.entries(skills)) {\n    if (!linked && data.rank === undefined) continue; // Unlinked with no override\n    if (!Number.isFinite(data.rank)) updateData[`system.skills.${key}.rank`] = 0;\n    for (const [subKey, subData] of Object.entries(data.subSkills ?? {})) {\n      if (!linked && subData.rank === undefined) continue; // Unlinked with no override\n      if (!Number.isFinite(subData.rank)) updateData[`system.skills.${key}.subSkills.${subKey}.rank`] = 0;\n    }\n  }\n};\n\nconst _migrateCarryBonus = function (ent, updateData, linked) {\n  if (getProperty(ent, \"system.details.carryCapacity.bonus.user\") === undefined) {\n    let bonus = getProperty(ent, \"system.abilities.str.carryBonus\");\n    if (bonus !== undefined || linked) {\n      bonus = bonus || 0;\n      updateData[\"system.details.carryCapacity.bonus.user\"] = bonus;\n    }\n    updateData[\"system.abilities.str.-=carryBonus\"] = null;\n  }\n  if (getProperty(ent, \"system.details.carryCapacity.multiplier.user\") === undefined) {\n    let mult = getProperty(ent, \"system.abilities.str.carryMultiplier\");\n    if (mult !== undefined || linked) {\n      mult = mult || 1;\n      updateData[\"system.details.carryCapacity.multiplier.user\"] = mult - 1;\n    }\n    updateData[\"system.abilities.str.-=carryMultiplier\"] = null;\n  }\n};\n\nconst _migrateBuggedValues = function (ent, updateData, linked) {\n  // Convert to integers\n  const convertToInt = [\n    \"system.details.xp.value\",\n    \"system.currency.pgil\",\n    \"system.currency.gil\",\n    \"system.currency.sgil\",\n    \"system.currency.cgil\",\n    \"system.altCurrency.pgil\",\n    \"system.altCurrency.gil\",\n    \"system.altCurrency.sgil\",\n    \"system.altCurrency.cgil\",\n  ];\n  for (const key of convertToInt) {\n    const oldValue = getProperty(ent, key),\n      value = parseInt(oldValue ?? 0);\n    if (oldValue !== value) {\n      updateData[key] = value;\n    }\n  }\n};\n\nconst _migrateSpellbookUsage = function (ent, updateData, linked) {\n  const usedSpellbooks = ent.items\n    .filter((i) => i.type === \"spell\")\n    .reduce((cur, i) => {\n      if (!i.system.spellbook) return cur;\n      if (cur.includes(i.system.spellbook)) return cur;\n      cur.push(i.system.spellbook);\n      return cur;\n    }, []);\n\n  for (const bookKey of usedSpellbooks) {\n    const path = `system.attributes.spells.spellbooks.${bookKey}.inUse`;\n    if (getProperty(ent, path) !== true) {\n      updateData[path] = true;\n    }\n  }\n};\n\nconst _migrateActorHP = function (ent, updateData, linked) {\n  // Migrate HP, Wounds and Vigor values from absolutes to relatives, which is a change in 0.80.16\n  for (const k of [\"system.attributes.hp\", \"system.attributes.wounds\", \"system.attributes.vigor\", \"system.attributes.mp\"]) {\n    if (getProperty(ent, `${k}.offset`) == null) {\n      const max = getProperty(ent, `${k}.max`) ?? 0;\n      const value = getProperty(ent, `${k}.value`) ?? 0;\n      updateData[`${k}.offset`] = value - max;\n    }\n  }\n};\n\nconst _migrateActorSenses = function (ent, updateData, linked, token) {\n  const oldSenses = ent.system.traits?.senses;\n  if (typeof oldSenses === \"string\") {\n    const tokenData = token ?? ent.prototypeToken;\n\n    updateData[\"system.traits.senses\"] = {\n      dv: tokenData.brightSight,\n      ts: 0,\n      bs: 0,\n      bse: 0,\n      ll: {\n        enabled: tokenData.flags?.ffd20?.lowLightVision,\n        multiplier: {\n          dim: tokenData.flags?.ffd20?.lowLightVisionMultiplier ?? 2,\n          bright: tokenData.flags?.ffd20?.lowLightVisionMultiplierBright ?? 2,\n        },\n      },\n      sid: false,\n      tr: false,\n      si: false,\n      sc: 0,\n      custom: oldSenses,\n    };\n  }\n\n  // Migrate boolean Scent sense to number\n  if (typeof oldSenses?.sc === \"boolean\") {\n    updateData[\"system.traits.senses.sc\"] = oldSenses.sc ? 30 : 0;\n  }\n};\n\nconst _migrateActorSkillJournals = function (ent, updateData, linked) {\n  const reOldJournalFormat = /^[a-zA-Z0-9]+$/;\n  for (const [skillKey, skill] of Object.entries(ent.system.skills ?? {})) {\n    for (const [subSkillKey, subSkill] of Object.entries(skill.subSkills ?? {})) {\n      if (subSkill.journal?.match(reOldJournalFormat)) {\n        updateData[`system.skills.${skillKey}.subSkills.${subSkillKey}.journal`] = `JournalEntry.${subSkill.journal}`;\n      }\n    }\n\n    if (skill.journal?.match(reOldJournalFormat)) {\n      updateData[`system.skills.${skillKey}.journal`] = `JournalEntry.${skill.journal}`;\n    }\n  }\n};\n\nconst _migrateActorSubskillData = (actor, updateData) => {\n  for (const [skillId, skillData] of Object.entries(actor.system.skills ?? {})) {\n    for (const [subSkillId, subSkillData] of Object.entries(skillData.subSkills ?? {})) {\n      if (subSkillData.mod !== undefined) {\n        // Remove permanently stored .mod which is derived value\n        // Added with PF1 v9\n        updateData[`system.skills.${skillId}.subSkills.${subSkillId}.-=mod`] = null;\n      }\n    }\n  }\n};\n\nconst _migrateActorDRandER = function (ent, updateData) {\n  const oldDR = ent.system.traits?.dr;\n  const oldER = ent.system.traits?.eres;\n\n  if (typeof oldDR === \"string\") {\n    updateData[\"system.traits.dr\"] = {\n      value: [],\n      custom: oldDR,\n    };\n  }\n\n  if (typeof oldER === \"string\") {\n    updateData[\"system.traits.eres\"] = {\n      value: [],\n      custom: oldER,\n    };\n  }\n};\n\nconst _Action_ConvertDamageType = function (damageTypeString) {\n  const separator = /(?:\\s*\\/\\s*|\\s+and\\s+|\\s+or\\s+)/i;\n  const damageTypeList = [\n    {\n      tests: [\"b\", \"blunt\", \"bludgeoning\"],\n      result: \"bludgeoning\",\n    },\n    {\n      tests: [\"p\", \"pierce\", \"piercing\"],\n      result: \"piercing\",\n    },\n    {\n      tests: [\"s\", \"slash\", \"slashing\"],\n      result: \"slashing\",\n    },\n    {\n      tests: [\"f\", \"fire\"],\n      result: \"fire\",\n    },\n    {\n      tests: [\"ice\", \"i\"],\n      result: \"ice\",\n    },\n    {\n      tests: [\"e\", \"l\", \"lightning\", \"electricity\", \"electrical\"],\n      result: \"lightning\",\n    },\n    {\n      tests: [\"wind\"],\n      result: \"wind\",\n    },\n    {\n      tests: [\"earth\"],\n      result: \"earth\",\n    },\n    {\n      tests: [\"water\"],\n      result: \"water\",\n    },\n    {\n      tests: [\"force\"],\n      result: \"force\",\n    },\n    {\n      tests: [\"dark\", \"neg\", \"negative\"],\n      result: \"dark\",\n    },\n    {\n      tests: [\"light\", \"pos\", \"positive\"],\n      result: \"light\",\n    },\n    {\n      tests: [\"u\", \"untyped\", \"untype\"],\n      result: \"untyped\",\n    },\n    {\n      tests: [\"n\", \"nonelemental\", \"non\"],\n      result: \"nonelemental\",\n    },\n  ];\n\n  const damageTypes = damageTypeString.split(separator).map((o) => o.toLowerCase());\n  const result = [];\n  for (const damageTest of damageTypeList) {\n    for (const testString of damageTest.tests) {\n      if (damageTypes.includes(testString)) {\n        result.push(damageTest.result);\n      }\n    }\n  }\n\n  if (result.length > 0) return result;\n  return [];\n};\n\n/**\n * Filters out actions during migration.\n *\n * @param {object} action - The data of the action in question.\n * @returns {boolean} `true` to keep action, `false` to discard action.\n */\nexport const filterItemActions = function (action) {\n  if (action.activation?.type) return true;\n  if (action.actionType) return true;\n\n  return false;\n};\n\nconst _migrateContainerPrice = (item, updateData) => {\n  if (item.type !== \"container\") return;\n\n  // .basePrice was merged into .price with PF1 v9\n  if (item.system.basePrice !== undefined) {\n    updateData[\"system.price\"] = item.system.basePrice;\n    updateData[\"system.-=basePrice\"] = null;\n  }\n  if (item.system.unidentified?.basePrice !== undefined) {\n    updateData[\"system.unidentified.price\"] = item.system.unidentified.basePrice;\n    updateData[\"system.unidentified.-=basePrice\"] = null;\n  }\n};\n\nconst _migrateItemType = function (ent, updateData) {\n  const type = ent.type;\n  const oldType = ent.system[`${type}Type`];\n  if (oldType == null) return;\n  updateData[\"system.subType\"] = oldType;\n  updateData[`system.-=${type}Type`] = null;\n};\n\n/**\n * Removes data that the system has added to items that is now unused with no new location.\n *\n * @param item\n * @param updateData\n */\nconst _migrateItemUnusedData = (item, updateData) => {\n  // .priceUnits was never used, removal added with PF1 v9\n  if (item.system.priceUnits !== undefined) {\n    updateData[\"system.-=priceUnits\"] = null;\n  }\n\n  // .description.chat was never used\n  if (item.system.description?.chat !== undefined) {\n    updateData[\"system.description.-=chat\"] = null;\n  }\n\n  // .identifiedName was made obsolete with PF1 v9\n  if (item.system.identifiedName !== undefined) {\n    updateData[\"system.-=identifiedName\"] = null;\n  }\n\n  // Creating items in containers added typeName for no reason (in 0.82.5 and older)\n  if (item.system.typeName !== undefined) {\n    updateData[\"system.-=typeName\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.weaponData !== undefined) {\n    updateData[\"system.-=weaponData\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.range !== undefined) {\n    updateData[\"system.-=range\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.primaryAttack !== undefined) {\n    updateData[\"system.-=primaryAttack\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.activation !== undefined) {\n    updateData[\"system.-=activation\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.unchainedAction !== undefined) {\n    updateData[\"system.-=unchainedAction\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.measureTemplate !== undefined) {\n    updateData[\"system.-=measureTemplate\"] = null;\n  }\n};\n\nconst _migrateActorUnusedData = (actor, updateData) => {\n  // Obsolete vision\n  if (getProperty(actor.system, \"attributes.vision\") !== undefined) {\n    updateData[\"system.attributes.-=vision\"] = null;\n  }\n\n  if (getProperty(actor.prototypeToken, \"flags.ffd20.lowLightVision\") !== undefined) {\n    updateData[\"prototypeToken.flags.ffd20.-=lowLightVision\"] = null;\n  }\n\n  // XP max is purely derived value\n  if (actor.system.details?.xp?.max !== undefined) {\n    updateData[\"system.details.xp.-=max\"] = null;\n  }\n\n  // Actor resources have always been derived data\n  if (actor.system.resources !== undefined) {\n    updateData[\"system.-=resources\"] = null;\n  }\n};\n\n/**\n * Flatten item tuple arrays\n * Since PF1 v9\n *\n * @param item\n * @param updateData\n */\nconst _migrateItemTuples = (item, updateData) => {\n  // Race subtypes\n  if (item.type === \"race\") {\n    if (item.system.subTypes?.length) {\n      if (typeof item.system.subTypes[0] !== \"string\") {\n        updateData[\"system.subTypes\"] = item.system.subTypes.flat();\n      }\n    }\n  }\n\n  // Tags\n  if (item.system.tags?.length) {\n    if (typeof item.system.tags[0] !== \"string\") {\n      updateData[\"system.tags\"] = item.system.tags.flat();\n    }\n  }\n\n  // Feat class associations\n  const classAssociations = item.system.associations?.classes;\n  if (classAssociations?.length) {\n    if (typeof classAssociations[0] !== \"string\") {\n      updateData[\"system.associations.classes\"] = classAssociations.flat();\n    }\n  }\n};\n","/**\n * The core API provided by the system, available via the global `ffd20`.\n *\n * @module\n */\n\n// Imports for side effects\nimport \"./less/ffd20.less\";\nimport \"./module/hmr.mjs\";\nimport \"./module/patch-core.mjs\";\nimport \"module/compendium-directory.mjs\";\n\n// Import Modules\nimport { tinyMCEInit } from \"./module/mce/mce.mjs\";\nimport { measureDistances, getConditions } from \"./module/utils/canvas.mjs\";\nimport { getFirstActiveGM, moduleToObject, setDefaultSceneScaling } from \"./module/utils/lib.mjs\";\nimport { initializeSocket } from \"./module/socket.mjs\";\nimport { SemanticVersion } from \"./module/utils/semver.mjs\";\nimport * as chat from \"./module/utils/chat.mjs\";\nimport * as macros from \"./module/documents/macros.mjs\";\nimport { initializeModules } from \"./module/modules.mjs\";\nimport { ActorPFProxy } from \"@actor/actor-proxy.mjs\";\nimport { ItemPFProxy } from \"@item/item-proxy.mjs\";\n\n// New API\nimport * as FFD20 from \"./module/config.mjs\";\nimport * as applications from \"./module/applications/_module.mjs\";\nimport * as documents from \"./module/documents/_module.mjs\";\nimport * as actionUse from \"./module/action-use/_module.mjs\";\nimport * as _canvas from \"./module/canvas/_module.mjs\";\nimport * as dice from \"./module/dice/_module.mjs\";\nimport * as components from \"./module/components/_module.mjs\";\nimport * as utils from \"./module/utils/_module.mjs\";\nimport * as registry from \"./module/registry/_module.mjs\";\nimport * as migrations from \"./module/migration.mjs\";\n\n// ESM exports, to be kept in sync with globalThis.ffd20\nexport {\n  actionUse,\n  applications,\n  _canvas as canvas,\n  components,\n  FFD20 as config,\n  dice,\n  documents,\n  migrations,\n  registry,\n  utils,\n};\n\nglobalThis.ffd20 = moduleToObject({\n  actionUse,\n  applications,\n  canvas: _canvas,\n  components,\n  config: FFD20,\n  dice,\n  documents,\n  migrations,\n  registry,\n  /** @type {TooltipPF|null} */\n  tooltip: null,\n  utils,\n  // Initialize skip confirm prompt value\n  skipConfirmPrompt: false,\n});\n\n/* -------------------------------------------- */\n/*  Foundry VTT Initialization                  */\n/* -------------------------------------------- */\nHooks.once(\"init\", function () {\n  console.log(`FFD20 | Initializing Final Fantasy D20 System`);\n\n  // Redirect notifications to console before Notifications is ready\n  ui.notifications = {\n    info: (msg, opts = {}) => (opts.console !== false ? console.log(msg) : undefined),\n    warn: (msg, opts = {}) => (opts.console !== false ? console.warn(msg) : undefined),\n    error: (msg, opts = {}) => (opts.console !== false ? console.error(msg) : undefined),\n  };\n\n  // Global exports\n  globalThis.RollPF = dice.RollPF;\n\n  // Record Configuration Values\n  CONFIG.FFD20 = ffd20.config;\n\n  // Canvas object classes and configuration\n  CONFIG.Canvas.layers.templates.layerClass = _canvas.TemplateLayerPF;\n  CONFIG.MeasuredTemplate.objectClass = _canvas.MeasuredTemplatePF;\n  CONFIG.MeasuredTemplate.defaults.originalAngle = CONFIG.MeasuredTemplate.defaults.angle;\n  CONFIG.MeasuredTemplate.defaults.angle = 90; // FFD20 uses 90 degree angles\n  CONFIG.Token.objectClass = _canvas.TokenPF;\n\n  // Document classes\n  CONFIG.Actor.documentClass = ActorPFProxy;\n  CONFIG.Actor.documentClasses = {\n    character: documents.actor.ActorCharacterPF,\n    npc: documents.actor.ActorNPCPF,\n    basic: documents.actor.BasicActorPF,\n  };\n  CONFIG.Item.documentClass = ItemPFProxy;\n  CONFIG.Item.documentClasses = {\n    attack: documents.item.ItemAttackPF,\n    buff: documents.item.ItemBuffPF,\n    class: documents.item.ItemClassPF,\n    consumable: documents.item.ItemConsumablePF,\n    container: documents.item.ItemContainerPF,\n    equipment: documents.item.ItemEquipmentPF,\n    feat: documents.item.ItemFeatPF,\n    loot: documents.item.ItemLootPF,\n    race: documents.item.ItemRacePF,\n    spell: documents.item.ItemSpellPF,\n    weapon: documents.item.ItemWeaponPF,\n  };\n\n  CONFIG.Token.documentClass = documents.TokenDocumentPF;\n  CONFIG.ActiveEffect.documentClass = documents.ActiveEffectPF;\n  CONFIG.ActiveEffect.legacyTransferral = false; // TODO: Remove once legacy transferral is no longer default.\n  CONFIG.Combat.documentClass = documents.CombatPF;\n  CONFIG.Combatant.documentClass = documents.CombatantPF;\n  CONFIG.ChatMessage.documentClass = documents.ChatMessagePF;\n\n  // UI classes\n  CONFIG.ui.items = applications.ItemDirectoryPF;\n\n  // Dice config\n  CONFIG.Dice.rolls.splice(0, 0, dice.RollPF);\n  CONFIG.Dice.termTypes.SizeRollTerm = dice.terms.SizeRollTerm;\n  CONFIG.Dice.RollPF = dice.RollPF;\n  CONFIG.Dice.rolls.push(dice.D20RollPF);\n  CONFIG.Dice.rolls.D20RollPF = dice.D20RollPF;\n  CONFIG.Dice.rolls.push(dice.DamageRoll);\n  CONFIG.Dice.rolls.DamageRoll = dice.DamageRoll;\n\n  CONFIG.time.roundTime = 6;\n\n  // Register System Settings\n  documents.settings.registerSystemSettings();\n  documents.settings.registerClientSettings();\n  setDefaultSceneScaling();\n\n  //Calculate conditions for world\n  CONFIG.statusEffects = getConditions();\n\n  // Preload Handlebars Templates\n  utils.handlebars.preloadHandlebarsTemplates();\n  utils.handlebars.registerHandlebarsHelpers();\n\n  // Register sheet application classes\n  Actors.unregisterSheet(\"core\", ActorSheet);\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFCharacter, {\n    label: \"FFD20.Sheet.PC\",\n    types: [\"character\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPC, {\n    label: \"FFD20.Sheet.NPC\",\n    types: [\"npc\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPCLite, {\n    label: \"FFD20.Sheet.NPCLite\",\n    types: [\"npc\"],\n    makeDefault: false,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPCLoot, {\n    label: \"FFD20.Sheet.NPCLoot\",\n    types: [\"npc\"],\n    makeDefault: false,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFBasic, {\n    label: \"FFD20.Sheet.Basic\",\n    types: [\"basic\"],\n    makeDefault: true,\n  });\n  Items.unregisterSheet(\"core\", ItemSheet);\n  Items.registerSheet(\"ffd20\", applications.item.ItemSheetPF, {\n    label: \"FFD20.Sheet.Item\",\n    types: [\"class\", \"feat\", \"spell\", \"consumable\", \"equipment\", \"loot\", \"weapon\", \"buff\", \"attack\", \"race\"],\n    makeDefault: true,\n  });\n  Items.registerSheet(\"ffd20\", applications.item.ItemSheetPF_Container, {\n    label: \"FFD20.Sheet.Container\",\n    types: [\"container\"],\n    makeDefault: true,\n  });\n\n  // Alter configuration\n  CONFIG.specialStatusEffects.BLIND = \"pf1_blind\";\n\n  // Register detection modes\n  for (const mode of Object.values(ffd20.canvas.detectionModes)) {\n    CONFIG.Canvas.detectionModes[mode.ID] = new mode({\n      id: mode.ID,\n      label: mode.LABEL,\n      type: mode.DETECTION_TYPE || DetectionMode.DETECTION_TYPES.SIGHT,\n    });\n  }\n\n  // Register vision modes\n  CONFIG.Canvas.visionModes.darkvision = ffd20.canvas.visionModes.darkvision;\n\n  // Initialize socket listener\n  initializeSocket();\n\n  // Initialize module integrations\n  initializeModules();\n\n  // Initialize registries with initial/built-in data\n  const registries = /** @type {const} */ ([\n    [\"damageTypes\", registry.DamageTypes],\n    [\"scriptCalls\", registry.ScriptCalls],\n  ]);\n  for (const [registryName, registryClass] of registries) {\n    ffd20.registry[registryName] = new registryClass();\n  }\n\n  // Define getter for config properties moved into registries\n  Object.defineProperty(ffd20.config, \"damageTypes\", {\n    get: () => {\n      foundry.utils.logCompatibilityWarning(\n        \"Damage types have been moved into the DamageTypes registry. \" +\n          \"Use ffd20.registry.damageTypes.getLabels() for the old format, or access the collection for full damage type data.\",\n        { since: \"FFD20 v1.1.0\", until: \"FFD20 v2.0.0\" }\n      );\n      return ffd20.registry.damageTypes.getLabels();\n    },\n  });\n\n  // Call post-init hook\n  Hooks.callAll(\"pf1PostInit\");\n});\n\n// Load Quench test in development environment\nif (import.meta.env.DEV) {\n  await import(\"./module/test/index.mjs\");\n}\n\n/* -------------------------------------------- */\n/*  Foundry VTT Setup                           */\n/* -------------------------------------------- */\n\n/**\n * This function runs after game data has been requested and loaded from the servers, so documents exist\n */\nHooks.once(\"setup\", function () {\n  // Localize CONFIG objects once up-front\n  const toLocalize = [\n    \"abilities\",\n    \"abilitiesShort\",\n    \"alignments\",\n    \"currencies\",\n    \"distanceUnits\",\n    \"itemActionTypes\",\n    \"senses\",\n    \"skills\",\n    \"targetTypes\",\n    \"timePeriods\",\n    \"timePeriodsShort\",\n    \"savingThrows\",\n    \"ac\",\n    \"featTypes\",\n    \"featTypesPlurals\",\n    \"traitTypes\",\n    \"conditions\",\n    \"lootTypes\",\n    \"flyManeuverabilities\",\n    \"abilityTypes\",\n    \"spellPreparationModes\",\n    \"weaponGroups\",\n    \"weaponTypes\",\n    \"weaponProperties\",\n    \"spellComponents\",\n    \"spellSchools\",\n    \"multiSchools\",\n    \"spellLevels\",\n    \"conditionTypes\",\n    \"favouredClassBonuses\",\n    \"armorProficiencies\",\n    \"weaponProficiencies\",\n    \"actorSizes\",\n    \"abilityActivationTypes\",\n    \"abilityActivationTypesPlurals\",\n    \"limitedUsePeriods\",\n    \"equipmentTypes\",\n    \"equipmentSlots\",\n    \"consumableTypes\",\n    \"attackTypes\",\n    \"buffTypes\",\n    \"healingTypes\",\n    \"divineFocus\",\n    \"classSavingThrows\",\n    \"classBAB\",\n    \"classTypes\",\n    \"measureTemplateTypes\",\n    \"creatureTypes\",\n    \"measureUnits\",\n    \"measureUnitsShort\",\n    \"languages\",\n    \"weaponHoldTypes\",\n    \"auraStrengths\",\n    \"conditionalTargets\",\n    \"bonusModifiers\",\n    \"abilityActivationTypes_unchained\",\n    \"abilityActivationTypesPlurals_unchained\",\n    \"actorStatures\",\n    \"ammoTypes\",\n    \"classBaseMPTypes\",\n    \"classSubTypes\",\n    \"classBaseMPauto\",\n    \"classCastingStats\",\n    \"countforexp\",\n    \"materiaRarity\",\n  ];\n\n  // Config (sub-)objects to be sorted\n  const toSort = [\n    \"skills\",\n    \"conditions\",\n    \"conditionTypes\",\n    \"consumableTypes\",\n    \"creatureTypes\",\n    \"featTypes\",\n    \"weaponProperties\",\n    \"spellSchools\",\n    \"languages\",\n    \"multiSchools\",\n  ];\n\n  /**\n   * Helper function to recursively localize object entries\n   *\n   * @param {object} obj - The object to be localized\n   * @param {string} cat - The object's name\n   * @returns {object} The localized object\n   */\n  const doLocalize = (obj, cat) => {\n    // Create tuples of (key, localized object/string)\n    const localized = Object.entries(obj).reduce((arr, e) => {\n      if (typeof e[1] === \"string\") arr.push([e[0], game.i18n.localize(e[1])]);\n      else if (typeof e[1] === \"object\") arr.push([e[0], doLocalize(e[1], `${cat}.${e[0]}`)]);\n      return arr;\n    }, []);\n    if (toSort.includes(cat)) {\n      // Sort simple strings, fall back to sorting by label for objects/categories\n      localized.sort((a, b) => {\n        const localA = typeof a?.[1] === \"string\" ? a[1] : a[1]?._label;\n        const localB = typeof b?.[1] === \"string\" ? b[1] : b[1]?._label;\n        // Move misc to bottom of every list\n        if (a[0] === \"misc\") return 1;\n        else if (b[0] === \"misc\") return -1;\n        // Regular sorting of localized strings\n        return localA.localeCompare(localB);\n      });\n    }\n    // Get the localized and sorted object out of tuple\n    return localized.reduce((obj, e) => {\n      obj[e[0]] = e[1];\n      return obj;\n    }, {});\n  };\n\n  // Localize and sort CONFIG objects\n  for (const o of toLocalize) {\n    ffd20.config[o] = doLocalize(ffd20.config[o], o);\n  }\n\n  // Localize buff targets\n  const localizeLabels = [\"buffTargets\", \"buffTargetCategories\", \"contextNoteTargets\", \"contextNoteCategories\"];\n  for (const l of localizeLabels) {\n    for (const [k, v] of Object.entries(ffd20.config[l])) {\n      ffd20.config[l][k].label = game.i18n.localize(v.label);\n    }\n  }\n\n  // Prepare registry data\n  for (const registry of Object.values(ffd20.registry)) {\n    if (registry instanceof ffd20.registry.Registry) registry.setup();\n  }\n\n  // TinyMCE variables and commands\n  tinyMCEInit();\n\n  // Register controls\n  documents.controls.registerSystemControls();\n\n  Hooks.callAll(\"pf1PostSetup\");\n});\n\n/* -------------------------------------------- */\n\n/**\n * Once the entire VTT framework is initialized, check to see if we should perform a data migration\n */\nHooks.once(\"ready\", async function () {\n  // Create tooltip\n  const ttconf = game.settings.get(\"ffd20\", \"tooltipConfig\");\n  const ttwconf = game.settings.get(\"ffd20\", \"tooltipWorldConfig\");\n  if (!ttconf.disable && !ttwconf.disable) ffd20.applications.TooltipPF.toggle(true);\n\n  window.addEventListener(\"resize\", () => {\n    ffd20.tooltip?.setPosition();\n  });\n\n  // Migrate data\n  const NEEDS_MIGRATION_VERSION = \"9.4\";\n  let PREVIOUS_MIGRATION_VERSION = game.settings.get(\"ffd20\", \"systemMigrationVersion\");\n  if (typeof PREVIOUS_MIGRATION_VERSION === \"number\") {\n    PREVIOUS_MIGRATION_VERSION = PREVIOUS_MIGRATION_VERSION.toString() + \".0\";\n  } else if (\n    typeof PREVIOUS_MIGRATION_VERSION === \"string\" &&\n    PREVIOUS_MIGRATION_VERSION.match(/^([0-9]+)\\.([0-9]+)$/)\n  ) {\n    PREVIOUS_MIGRATION_VERSION = `${PREVIOUS_MIGRATION_VERSION}.0`;\n  }\n  const needMigration = SemanticVersion.fromString(NEEDS_MIGRATION_VERSION).isHigherThan(\n    SemanticVersion.fromString(PREVIOUS_MIGRATION_VERSION)\n  );\n  if (needMigration && game.user.isGM) {\n    await migrations.migrateWorld();\n  }\n\n  // Migrate system settings\n  await documents.settings.migrateSystemSettings();\n\n  // Populate `ffd20.applications.compendiums`\n  ffd20.applications.compendiumBrowser.CompendiumBrowser.initializeBrowsers();\n\n  // Show changelog\n  if (!game.settings.get(\"ffd20\", \"dontShowChangelog\")) {\n    const v = game.settings.get(\"ffd20\", \"changelogVersion\") || \"0.0.1\";\n    const changelogVersion = SemanticVersion.fromString(v);\n    const curVersion = SemanticVersion.fromString(game.system.version);\n\n    if (curVersion.isHigherThan(changelogVersion)) {\n      const app = new ffd20.applications.ChangeLogWindow(changelogVersion);\n      app.render(true, { focus: true });\n      game.settings.set(\"ffd20\", \"changelogVersion\", curVersion.toString());\n    }\n  }\n\n  // Create permanent warning if script changes are allowed\n  if (game.settings.get(\"ffd20\", \"allowScriptChanges\")) {\n    ui.notifications.warn(\"SETTINGS.pf1AllowScriptChangesD\", { localize: true, permanent: true });\n  }\n\n  Hooks.callAll(\"pf1PostReady\");\n});\n\n/* -------------------------------------------- */\n/*  Canvas Initialization                       */\n/* -------------------------------------------- */\n\nHooks.on(\"canvasInit\", function () {\n  // Extend Diagonal Measurement\n  canvas.grid.diagonalRule = game.settings.get(\"ffd20\", \"diagonalMovement\");\n  SquareGrid.prototype.measureDistances = measureDistances;\n});\n\n/* -------------------------------------------- */\n/*  Other Hooks                                 */\n/* -------------------------------------------- */\n\nHooks.on(\"renderChatMessage\", (app, html, data) => {\n  // Hide roll info\n  chat.hideRollInfo(app, html, data);\n\n  // Hide GM sensitive info\n  chat.hideGMSensitiveInfo(app, html, data);\n\n  // Hide non-visible targets for players\n  if (!game.user.isGM) chat.hideInvisibleTargets(app, html);\n\n  // Create target callbacks\n  chat.addTargetCallbacks(app, html);\n\n  // Alter target defense options\n  chat.alterTargetDefense(app, html);\n\n  // Optionally collapse the content\n  if (game.settings.get(\"ffd20\", \"autoCollapseItemCards\")) html.find(\".card-content\").hide();\n\n  // Optionally hide chat buttons\n  if (game.settings.get(\"ffd20\", \"hideChatButtons\")) html.find(\".card-buttons\").hide();\n\n  // Apply accessibility settings to chat message\n  chat.applyAccessibilitySettings(app, html, data, game.settings.get(\"ffd20\", \"accessibilityConfig\"));\n\n  // Alter ammo recovery options\n  chat.alterAmmoRecovery(app, html);\n\n  // Handle chat tooltips\n  html.find(\".tooltip\").on(\"mousemove\", (ev) => handleChatTooltips(ev));\n});\n\nHooks.on(\"renderChatPopout\", (app, html, data) => {\n  // Optionally collapse the content\n  if (game.settings.get(\"ffd20\", \"autoCollapseItemCards\")) html.find(\".card-content\").hide();\n\n  // Optionally hide chat buttons\n  if (game.settings.get(\"ffd20\", \"hideChatButtons\")) html.find(\".card-buttons\").hide();\n});\n\nHooks.on(\"renderChatLog\", (_, html) => documents.item.ItemPF.chatListeners(html));\nHooks.on(\"renderChatLog\", (_, html) => documents.actor.ActorPF.chatListeners(html));\nHooks.on(\"renderChatLog\", (_, html) => _canvas.attackReach.addReachListeners(html));\n\nHooks.on(\"renderChatPopout\", (_, html) => documents.item.ItemPF.chatListeners(html));\nHooks.on(\"renderChatPopout\", (_, html) => documents.actor.ActorPF.chatListeners(html));\n\nHooks.on(\"renderAmbientLightConfig\", (app, html) => {\n  _canvas.lowLightVision.addLowLightVisionToLightConfig(app, html);\n});\n\nHooks.on(\"renderTokenHUD\", (app, html, data) => {\n  _canvas.TokenQuickActions.addQuickActions(app, html, data);\n});\n\nHooks.on(\"updateActor\", (actor, data, options, userId) => {\n  // Call hook for toggling conditions\n  {\n    const conditions = data.system?.attributes?.conditions || {};\n    for (const [k, v] of Object.entries(conditions)) {\n      Hooks.callAll(\"pf1ToggleActorCondition\", actor, k, v);\n    }\n  }\n});\n\nHooks.on(\"createToken\", (token, options, userId) => {\n  if (game.user.id !== userId) return;\n  // Re-associate imported Active Effects which are sourced to Items owned by this same Actor\n  if (token.actor.effects?.size) {\n    const updates = [];\n    for (const effect of token.actor.effects) {\n      if (!effect.origin) continue;\n      const effectItemId = effect.origin.match(/Item\\.(\\w+)/)?.pop();\n      const foundItem = token.actor.items.get(effectItemId);\n      if (foundItem) {\n        updates.push({ _id: effect.id, origin: foundItem.uuid });\n      }\n    }\n    token.actor.updateEmbeddedDocuments(\"ActiveEffect\", updates, { render: false });\n  }\n});\n\nHooks.on(\"deleteToken\", (token, options, userId) => {\n  // Hide token tooltip on token deletion\n  ffd20.tooltip?.unbind(token.object);\n});\n\nHooks.on(\"updateToken\", function (token, updateData, options, userId) {\n  // Hide token tooltip on token update\n  ffd20.tooltip?.unbind(token);\n});\n\n/**\n * HACK: Fixes unlinked token updating not working correctly in _preCreate (in v10)\n * Remove when upstream issue is solved and brought live: https://github.com/foundryvtt/foundryvtt/issues/8761\n */\nHooks.on(\"preCreateToken\", (token, initialData, options, userId) => {\n  // Apply token size\n  if (token.getFlag(\"ffd20\", \"staticSize\")) return;\n  const sizeConf = FFD20.tokenSizes[token.actor?.system.traits?.size];\n  if (!sizeConf) return;\n\n  // token.updateSource() doesn't work here\n  initialData.width = sizeConf.w;\n  initialData.height = sizeConf.h;\n  initialData.texture ??= {};\n  initialData.texture.scaleY = sizeConf.scale;\n  initialData.texture.scaleX = sizeConf.scale;\n});\n\nHooks.on(\"createItem\", (item, options, userId) => {\n  const actor = item.actor;\n  if (userId !== game.user.id) return;\n\n  // Show buff if active\n  if (item.type === \"buff\" && item.system.active === true) {\n    // Call hook\n    if (actor) {\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, item, true);\n    }\n\n    // Execute script calls\n    item.executeScriptCalls(\"toggle\", { state: true });\n  }\n  // Simulate toggling a feature on\n  if (item.type === \"feat\") {\n    const disabled = item.system.disabled;\n    if (disabled === false) {\n      item.executeScriptCalls(\"toggle\", { state: true });\n    }\n  }\n  // Simulate equipping items\n  {\n    const equipped = item.system.equipped;\n    if (equipped === true) {\n      item.executeScriptCalls(\"equip\", { equipped: true });\n    }\n  }\n  // Quantity change\n  {\n    const quantity = item.system.quantity;\n    if (typeof quantity === \"number\" && quantity > 0) {\n      item.executeScriptCalls(\"changeQuantity\", { quantity: { previous: 0, new: quantity } });\n    }\n  }\n});\n\nHooks.on(\"preDeleteItem\", (item, options, userId) => {\n  if (!item.actor) return;\n  if (options.handledChildren) return;\n\n  const visited = new Set();\n\n  // Remove linked children with item\n  const _getChildren = (item) => {\n    if (visited.has(item.id)) return [];\n    visited.add(item.id);\n\n    const result = [];\n    const links = item.system.links?.children ?? [];\n    for (const link of links) {\n      if (visited.has(link.id)) continue;\n\n      const child = item.actor.items.get(link.id);\n      if (child) {\n        result.push(child.id);\n        result.push(..._getChildren(child));\n      }\n    }\n    return result;\n  };\n\n  const children = _getChildren(item);\n\n  if (children.length > 0) {\n    const toRemove = [item.id, ...children]\n      .reduce((cur, o) => {\n        if (!cur.includes(o)) cur.push(o);\n        return cur;\n      }, [])\n      .filter((o) => item.actor.items.has(o));\n\n    item.actor.deleteEmbeddedDocuments(\"Item\", toRemove, { handledChildren: true });\n    return false;\n  }\n});\n\nHooks.on(\"deleteItem\", async (item, options, userId) => {\n  if (userId !== game.user.id) return;\n  const actor = item.actor;\n\n  if (actor) {\n    // Remove links\n    const itemLinks = item.system.links;\n    if (itemLinks) {\n      for (const [linkType, links] of Object.entries(itemLinks)) {\n        for (const link of links) {\n          const item = actor.items.get(link.id);\n          const otherItemLinks = item?.links || {};\n          if (otherItemLinks[linkType]) {\n            delete otherItemLinks[linkType];\n          }\n        }\n      }\n    }\n\n    // Call buff removal hook\n    if (item.type === \"buff\" && item.system.active === true) {\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, item, false);\n    }\n  }\n});\n\nHooks.on(\"updateItem\", async (item, changedData, options, userId) => {\n  if (userId !== game.user.id) return;\n  const actor = item.actor;\n\n  if (actor) {\n    // Toggle buff\n    const isActive = changedData.system?.active;\n    if (item.type === \"buff\" && isActive !== undefined) {\n      // Call hook\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, item, isActive);\n    }\n  }\n});\n\nHooks.on(\"chatMessage\", (log, message, chatData) => {\n  const result = documents.customRolls(message, chatData.speaker);\n  return !result;\n});\n\nHooks.on(\"renderActorDirectory\", (app, html, data) => {\n  html.find(\"li.actor\").each((i, li) => {\n    li.addEventListener(\n      \"drop\",\n      applications.CurrencyTransfer._directoryDrop.bind(undefined, li.getAttribute(\"data-document-id\"))\n    );\n  });\n});\n\nHooks.on(\"renderItemDirectory\", (app, html, data) => {\n  html.find(\"li.item\").each((i, li) => {\n    li.addEventListener(\n      \"drop\",\n      applications.CurrencyTransfer._directoryDrop.bind(undefined, li.getAttribute(\"data-document-id\"))\n    );\n  });\n});\n\nHooks.on(\"dropActorSheetData\", (act, sheet, data) => {\n  if (data.type === \"Currency\") sheet._onDropCurrency(event, data);\n});\n\n/* -------------------------------------------- */\n/*  Hotbar Macros                               */\n/* -------------------------------------------- */\n\n// Delay hotbarDrop handler registration to allow modules to override it.\nHooks.once(\"ready\", () => {\n  Hooks.on(\"hotbarDrop\", (bar, data, slot) => {\n    let macro;\n    const { type, uuid } = data;\n    switch (type) {\n      case \"Item\":\n        macro = macros.createItemMacro(uuid, slot);\n        break;\n      case \"action\":\n        macro = macros.createActionMacro(data.data?._id, uuid, slot);\n        break;\n      case \"skill\":\n        macro = macros.createSkillMacro(data.skill, uuid, slot);\n        break;\n      case \"save\":\n        macro = macros.createSaveMacro(data.save, uuid, slot);\n        break;\n      case \"defenses\":\n      case \"cmb\":\n      case \"concentration\":\n      case \"cl\":\n      case \"attack\":\n      case \"abilityScore\":\n      case \"initiative\":\n      case \"bab\":\n        macro = macros.createMiscActorMacro(type, uuid, slot, data);\n        break;\n      default:\n        return true;\n    }\n\n    if (macro == null || macro instanceof Promise) return false;\n  });\n});\n\n// Render TokenConfig\nHooks.on(\"renderTokenConfig\", async (app, html) => {\n  // Add vision inputs\n  let token = app.object;\n  // Prototype token\n  if (token instanceof Actor) token = token.prototypeToken;\n\n  const flags = token.flags?.ffd20;\n\n  // Add static size checkbox\n  let newHTML = `<div class=\"form-group\"><label>${game.i18n.localize(\n    \"FFD20.StaticSize\"\n  )}</label><input type=\"checkbox\" name=\"flags.ffd20.staticSize\" data-dtype=\"Boolean\"`;\n  if (flags?.staticSize) newHTML += \" checked\";\n  newHTML += \"/></div>\";\n  html.find('.tab[data-tab=\"appearance\"] > *:nth-child(3)').after(newHTML);\n\n  // Disable vision elements if custom vision is disabled\n  const enableCustomVision = flags?.customVisionRules === true;\n  if (!enableCustomVision) {\n    const tabElem = html.find(`.tab[data-tab=\"vision\"]`);\n    // Disable vision mode selection\n    tabElem.find(\"select[name='sight.visionMode']\").prop(\"disabled\", true);\n    // Disable detection mode tab entirely\n    const dmTab = tabElem.find(\".tab[data-tab='detection']\");\n    dmTab.find(\"input,select\").prop(\"disabled\", true);\n    dmTab.find(\"a.action-button\").unbind();\n  }\n  // Add custom vision checkbox\n  newHTML = `<div class=\"form-group\" data-tooltip=\"FFD20.CustomVisionRules.Description\"><label>${game.i18n.localize(\n    \"FFD20.CustomVisionRules.Label\"\n  )}</label><input type=\"checkbox\" name=\"flags.ffd20.customVisionRules\" data-dtype=\"Boolean\"`;\n  if (enableCustomVision) newHTML += \" checked\";\n  newHTML += \"/></div>\";\n  html.find(`.tab[data-tab=\"vision\"]`).append(newHTML);\n  // Add listener for custom vision rules checkbox\n  html.find(`.tab[data-tab=\"vision\"] input[name=\"flags.ffd20.customVisionRules\"]`).on(\"change\", async (event) => {\n    await app._onSubmit(event, { preventClose: true });\n    return app.render();\n  });\n\n  // Add disable low-light vision checkbox\n  _canvas.lowLightVision.addLowLightVisionToTokenConfig(app, html);\n\n  // Resize windows\n  app.setPosition();\n});\n\n// Render Sidebar\nHooks.on(\"renderSidebarTab\", (app, html) => {\n  if (app instanceof Settings) {\n    // Add buttons\n    const chlogButton = $(`<button>${game.i18n.localize(\"FFD20.Changelog\")}</button>`);\n    const helpButton = $(`<button>${game.i18n.localize(\"FFD20.Help.Label\")}</button>`);\n    const tshooterButton = $(`<button>${game.i18n.localize(\"FFD20.Troubleshooter.Button\")}</button>`);\n    html\n      .find(\"#game-details\")\n      .after(\n        $(`<h2>${game.i18n.localize(\"FFD20.Title\")}</h2>`),\n        $(\"<div id='ffd20-details'>\").append(chlogButton, helpButton, tshooterButton)\n      );\n\n    chlogButton.click(() => {\n      const chlog = Object.values(ui.windows).find((o) => o.id == \"changelog\") ?? new applications.ChangeLogWindow();\n      chlog.render(true, { focus: true });\n    });\n    helpButton.click(() => ffd20.applications.helpBrowser.openUrl(\"Help/Home\"));\n    tshooterButton.click(() => ffd20.applications.Troubleshooter.open());\n  }\n});\n\n// Show experience distributor after combat\nHooks.on(\"deleteCombat\", (combat, options, userId) => {\n  if (game.user.id !== userId) return;\n\n  const skipPrompt = documents.settings.getSkipActionPrompt();\n  const { disableExperienceTracking, openXpDistributor } = game.settings.get(\"ffd20\", \"experienceConfig\");\n  if (\n    !disableExperienceTracking &&\n    combat.started &&\n    ((openXpDistributor && !skipPrompt) || (!openXpDistributor && skipPrompt))\n  ) {\n    const combatants = combat.combatants.map((o) => o.actor);\n    const app = new applications.ExperienceDistributor(combatants);\n\n    if (app.getCharacters().length > 0) {\n      app.render(true);\n    } else {\n      app.close();\n    }\n  }\n});\n\nHooks.on(\"controlToken\", () => {\n  // Refresh lighting to (un)apply low-light vision parameters to them\n  canvas.perception.update(\n    {\n      initializeLighting: true,\n    },\n    true\n  );\n});\n\n/* ------------------------------- */\n/* Expire active effects\n/* ------------------------------- */\n{\n  const expireFromTokens = function () {\n    if (game.users.activeGM?.isSelf) {\n      for (const t of canvas.tokens.placeables) {\n        // Skip tokens in combat to avoid too early expiration\n        if (t.combatant?.combat?.started) continue;\n        // Don't do anything for actors without this function (e.g. basic actors)\n        if (!t.actor?.expireActiveEffects) continue;\n        t.actor.expireActiveEffects();\n      }\n    }\n  };\n\n  // On game time change\n  Hooks.on(\"updateWorldTime\", () => {\n    expireFromTokens();\n  });\n\n  // On canvas render\n  Hooks.on(\"canvasReady\", () => {\n    expireFromTokens();\n  });\n}\n\n// Handle chat tooltips\nconst handleChatTooltips = function (event) {\n  const elem = $(event.currentTarget);\n  const rect = event.currentTarget.getBoundingClientRect();\n  // const x = event.pageX;\n  // const y = event.pageY;\n  const x = rect.x;\n  const y = rect.y;\n  const w = rect.width;\n  elem.find(\".tooltipcontent\").css(\"left\", `${x}px`).css(\"top\", `${y}px`).css(\"width\", `${w}px`);\n};\n\n// Refresh skip state (alleviates sticky modifier issue #1572)\nwindow.addEventListener(\"focus\", () => (ffd20.skipConfirmPrompt = false), { passive: true });\n","import { convertDistance } from \"./utils/lib.mjs\";\n\n/**\n * Initialize module compatibility/integration code.\n *\n * Currently integrated modules:\n * - Drag Ruler\n */\nexport function initializeModules() {\n  // Drag Ruler\n  {\n    Hooks.once(\"dragRuler.ready\", (SpeedProvider) => {\n      const enhancedTerrain = game.modules.get(\"enhanced-terrain-layer\")?.active;\n\n      class Pf1SpeedProvider extends SpeedProvider {\n        get colors() {\n          return [\n            { id: \"walk\", default: 0x00ff00, name: \"SETTINGS.pf1DragRulerWalk\" },\n            { id: \"dash\", default: 0xffff00, name: \"SETTINGS.pf1DragRulerDash\" },\n            { id: \"run\", default: 0xff8000, name: \"SETTINGS.pf1DragRulerRun\" },\n          ];\n        }\n\n        getRanges(token) {\n          const baseSpeed = convertDistance(this.getBaseSpeed(token))[0];\n          const rollData = token.actor.getRollData(),\n            inHeavyArmor = rollData.armor.type >= ffd20.config.armorTypes.heavy,\n            inHeavyLoad = rollData.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.heavy;\n\n          let runMultiplier = 4;\n          if (inHeavyArmor || inHeavyLoad) runMultiplier = 3;\n          return [\n            { range: baseSpeed, color: \"walk\" },\n            { range: baseSpeed * 2, color: \"dash\" },\n            { range: baseSpeed * runMultiplier, color: \"run\" },\n          ];\n        }\n\n        getBaseSpeed(token) {\n          const [y, x] = canvas.grid.grid.getGridPositionFromPixels(token.x, token.y);\n          const useElevation = this.getSetting(\"useElevation\");\n          const speeds = token.actor.system.attributes.speed;\n\n          if (useElevation && token.document.elevation > 0) {\n            const flySpeed = speeds.fly.total;\n            if (flySpeed > 0) {\n              return flySpeed;\n            }\n          }\n\n          if (\n            enhancedTerrain &&\n            canvas.terrain.terrainFromGrid(x, y).some((terrain) => terrain.data.environment === \"water\")\n          ) {\n            const swimSpeed = speeds.swim.total;\n            if (swimSpeed > 0) {\n              return swimSpeed;\n            }\n          }\n\n          if (useElevation && token.document.elevation < 0) {\n            const burrowSpeed = speeds.burrow.total;\n            if (burrowSpeed > 0) {\n              return burrowSpeed;\n            }\n          }\n\n          return speeds.land.total;\n        }\n\n        get settings() {\n          return [\n            {\n              id: \"useElevation\",\n              name: \"SETTINGS.pf1DragRulerUseElevationName\",\n              hint: \"SETTINGS.pf1DragRulerUseElevationHint\",\n              scope: \"world\",\n              type: Boolean,\n              default: true,\n            },\n          ];\n        }\n      }\n      dragRuler.registerSystem(\"ffd20\", Pf1SpeedProvider);\n    });\n  }\n}\n"],"names":["ChatMessagePF","ChatMessage","static","maybeRollObject","Array","isArray","map","o","this","_initRollObject","Roll","fromData","k","v","Object","entries","isRoll","type","CONST","CHAT_MESSAGE_TYPES","ROLL","getFlag","itemSource","itemId","flags","ffd20","metadata","item","actor","constructor","getSpeakerActor","speaker","items","get","hasItemSource","measureTemplate","templateId","system","template","canvas","templates","targets","targetIds","tokens","placeables","filter","includes","id","prepareDerivedData","super","systemRolls","rolls","customRolls","message","rollData","match","RegExp","$1","toUpperCase","value","$2","flavor","$3","cMsg","CONFIG","documentClass","getSpeaker","scene","game","scenes","tokenDocument","token","tokenUuid","uuid","getRollData","create","evaluate","async","then","roll","total","isHealing","content","renderTemplate","tokenId","css","chatOptions","sound","sounds","dice","rollMode","settings","subject","health","SemanticVersion","major","minor","patch","preRelease","buildMetaData","str","re","result","parseInt","$4","$5","toString","isHigherThan","otherVersion","isLowerThan","RollPF","totalHalved","Math","floor","terms","reduce","t","DiceTerm","push","PoolTerm","SizeRollTerm","concat","_dice","formula","data","context","options","suppressError","err","warning","Error","console","error","debug","isNaN","safeRoll","simplified","term","prior","length","OperatorTerm","StringTerm","foundry","utils","mergeObject","priorNumeric","NumericTerm","priorSizeRoll","TRAILER_REGEXP","modifiers","from","matchAll","MODIFIER_REGEXP","m","priorOperator","String","_classifyStringTerm","intermediate","inplace","operator","shift","pop","_formula","_splitGroup","openRegexp","ParentheticalTerm","OPEN_REGEXP","closeRegexp","CLOSE_REGEXP","openSymbol","closeSymbol","onClose","group","fn","open","slice","expression","join","args","_splitMathArgs","rollPreProcess","fnParams","cur","s","split","startsWith","endsWith","parseRollStringVariable","MathTerm","replace","parts","d","getTooltipData","numericParts","idx","arr","i18n","localize","parseFloat","createTag","a","toLowerCase","substring","degtorad","degrees","PI","fractionalToString","base","f","roundDecimals","rv","CR","fromString","fromNumber","Number","isNumeric","getActorFromId","actors","convertDistance","getDistanceSystem","round","getWeightSystem","measureDistance","p0","p1","ray","diagonalRule","state","diagonals","cells","Ray","gs","dimensions","size","nx","ceil","abs","dx","ny","dy","nDiagonal","min","nStraight","nd10","distance","naturalSort","propertyKey","numeric","ignorePunctuation","collator","Intl","Collator","sort","b","propA","getProperty","propB","compare","createConsumableSpellDialog","itemData","allowSpell","sl","cl","Item","documentClasses","spell","getMinimumCasterLevelBySpellData","name","isGM","user","getFormData","html","formData","expandObject","FormDataExtended","querySelector","object","identified","unidentifiedName","buttons","potion","icon","label","callback","createConsumableSpell","scroll","wand","Dialog","wait","title","format","close","default","classes","jQuery","toConsumable","_id","adjustNumberByStringCommand","initialValue","cmdStr","maxValue","clearValue","isAbsolute","isNegative","rawValue","colorToInt","color","rgb","getBuffTargets","buffTargets","duplicate","buffs","config","contextNotes","contextNoteTargets","_skillTargets","sId","skill","getSkillInfo","category","skills","getBuffTargetDictionary","targetCategories","buffTargetCategories","contextNoteCategories","categories","key","sortArrayByName","inputArr","deepClone","elem","toLocaleLowerCase","binarySearch","searchArr","el","compare_fn","n","cmp","uniquePermutations","perm","Set","warn","i","rest","j","add","stripRollFlairs","simplifyFormula","combine","originalTerms","parse","semiEvalTerms","fromTerms","number","Dice","termTypes","isDeterministic","evl","safeTotal","combinedTerms","prev","next","falseVal","resulting","test","subterms","simpler","safeEval","tt","enrichHTMLUnrolled","secrets","documents","pcontent","TextEditor","enrichHTML","document","createElement","innerHTML","text","_getTextNodes","rgx","_replaceTextContent","createInlineFormula","command","closing","cls","chatCommand","parsedCommand","ChatLog","cmd","matches","raw","rollType","fml","flv","dataset","mode","trim","defaultImplementation","replaceFormulaData","classList","tooltip","splitCurrency","cgil","gil","sgil","max","calculateRangeFormula","range","melee","reach","spellRangeFormulas","medium","long","calculateRange","keepUpdateArray","sourceObj","targetObj","keepPath","newValue","newArray","getType","subData","setProperty","diffObjectAndArray","original","other","inner","keepLength","keys","obj","isDifferent","difference","_difference","v0","v1","t0","d2","isEmpty","getAbilityModifier","score","penalty","damage","setDefaultSceneScaling","gridUnits","gridDistance","addLowLightVisionToLightConfig","app","light","checkboxStr","checkbox","$","find","append","addLowLightVisionToTokenConfig","patchCore","LightSource_initialize","LightSource","prototype","initialize","dim","bright","getRadius","call","multiplier","requiresSelection","relevantTokens","testUserPermission","controlled","lowLightTokens","actorVision","lowLight","tokenVision","lowLightMultiplier","lowLightMultiplierBright","Hooks","once","release","generation","defineProperty","Users","activeGMs","users","u","active","origParse","origClick","_onClickInlineRoll","event","preventDefault","currentTarget","contains","chatMessage","sheet","closest","ui","windows","appid","documentName","_data","click","selector","off","on","KeyboardManager","_onAlt","up","lock","new","src","evalFn","Function","_total","MATH_PROXY","RollTerm","FLAVOR_REGEXP_STRING","REGEXP","OPERATORS","origFunc","CompendiumCollection","getIndex","fields","index","fuzzyIndex","_createContentLink","relativeTo","target","hash","indexOf","forEach","firstChild","className","setAttribute","lastChild","textContent","KeybindingsConfig","_detectConflictingActions","actionId","action","binding","uneditable","class","original_handleShareImage","ImagePopout","_handleShareImage","image","caption","showTitle","doc","fromUuidSync","_onFocusIn","formElements","HTMLInputElement","HTMLSelectElement","HTMLTextAreaElement","HTMLOptionElement","isContentEditable","some","releaseKeys","querySelectorAll","patchLowLightVision","spells","bestiary","feats","races","wide","compendiumButtonClick","applications","compendiums","_render","focus","element","info","button","innerText","addEventListener","entryOptions","unshift","condition","li","pack","packs","disabled","configure","tinyMCEInit","TinyMCE","content_css","style_formats","inline","attributes","remove","formats","assign","removeFormat","tinyMCE","ev","registerContextMenu","editor","isInfoElement","node","nodeName","parentNode","getInfoElement","selection","getNode","registry","addContextForm","launch","predicate","initValue","elm","commands","onSetup","buttonApi","setActive","nodeChangeHandler","readonly","onAction","formApi","getValue","setDirty","dom","setAttribs","hide","measureDistances","segments","gridSpaces","BaseGrid","parent","unifiedMeasureDistance","getConditions","core","statusEffects","sys","conditions","c","conditionTextures","localeCompare","_TokenHUD_getStatusEffectChoices","TokenHUD","_getStatusEffectChoices","buff","values","_calcBuffActiveEffects","isActive","isOverlay","cssClass","_onToggleEffect","overlay","img","effect","statusId","e","getAttribute","toggleEffect","runSocketFunction","senderId","isFirstGM","activeGM","isSelf","sender","eventType","source","fromUuid","sourceActor","dest","destActor","sourceContainer","destContainer","amount","CurrencyTransfer","transfer","sourceAlt","destAlt","alterChatTargetAttribute","targetActor","toObject","createEmbeddedDocuments","deleteEmbeddedDocuments","refreshActors","renderOnly","log","messages","contentHTML","save","valueElem","targetUuid","isFailure","addClass","removeClass","isSuccess","update","prop","colorName","aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkgrey","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dimgrey","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","grey","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgray","lightgreen","lightgrey","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightslategrey","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","rebeccapurple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","slategrey","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen","isArrayish","splice","getOwnPropertyDescriptor","swizzle","simpleSwizzleModule","exports","results","len","arg","wrap","arguments","colorNames","require$$0","require$$1","hasOwnProperty","reverseNames","cs","colorStringModule","to","clamp","num","hexDouble","string","val","model","hsl","hwb","hexAlpha","i2","alpha","hex","rgba","percent","r","g","hsla","hwba","keyword","cssKeywords","reverseKeywords","convert","channels","labels","hsv","cmyk","xyz","lab","lch","ansi16","ansi256","hcg","apple","conversions","delta","h","l","rdif","gdif","bdif","diff","diffc","w","reversed","currentClosestKeyword","currentClosestDistance","Infinity","y","x","z","t2","t3","t1","smin","lmin","hi","p","q","vmin","wh","bl","ratio","y2","x2","z2","hr","atan2","sqrt","cos","sin","saturation","ansi","mult","rem","colorString","char","integer","chroma","grayscale","hue","pure","mg","deriveBFS","fromModel","graph","buildGraph","models","queue","current","adjacents","adjacent","link","wrapConversion","toModel","path","conversion","route","convert$1","routes","wrapRounded","wrappedFn","arg0","wrapRaw","skippedModels","hashedModelKeys","limiters","Color","valpha","zeroArray","hashedKeys","JSON","stringify","limit","freeze","toJSON","places","self","percentString","array","unitArray","unitObject","roundToPlace","getset","maxfn","saturationl","lightness","saturationv","wblack","hexa","rgbArray","alphaHex","rgbNumber","luminosity","lum","chan","contrast","color2","lum1","lum2","level","contrastRatio","isDark","isLight","negate","lighten","darken","saturate","desaturate","whiten","blacken","fade","opaquer","rotate","mix","mixinColor","weight","color1","w1","w2","roundTo","toFixed","channel","modifier","createCustomChatMessage","chatTemplate","chatTemplateData","chatData","CHAT","implementation","applyRollMode","dice3d","isEnabled","showForRoll","whisper","blind","hideRollInfo","isBlind","isAuthor","hideGMSensitiveInfo","identifiedInfo","hasCombinedName","actionName","actionDescription","_templateCache","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","getIdentifiedBlock","each","Token","TokenDocument","show","removeData","fromJSON","unescape","insertBefore","removeChild","alterAmmoRecovery","recoveryData","attackIndex","ammoId","ia","recovered","failed","alterTargetDefense","defenseData","actorUUID","savingThrow","applyAccessibilitySettings","conf","createInlineRollString","hide3d","escape","hideInvisibleTargets","toArray","visible","addTargetCallbacks","targetElems","_getTokenByElem","_getRootTargetElement","_mouseEnterCallback","_onHoverIn","hoverOutOthers","_mouseLeaveCallback","_onHoverOut","_imageClickCallback","_controlled","shiftKey","control","releaseOthers","imgElem","chat","targetACClick","targetSavingThrowClick","displayDefenseCard","rollSavingThrow","setFlag","formulaHasDice","applyChanges","changeOverrides","changes","priority","getSortChangePriority","_sortChanges","typeA","types","subTarget","typeB","modA","modB","prioA","prioB","changeItems","changeFlags","k2","getSourceInfo","sourceInfo","negative","refreshDerivedData","continuousChanges","continuous","change","flats","getChangeFlat","createOverride","_safeApplyChange","applySourceInfo","cc","resetSkills","set","bonusModifiers","aSort","bSort","modifierType","curData","skl","subSkills","skillId","subSkillId","subskill","rank","ability","subSkl","init","speedKey","speed","sklKey","skillData","subSklKey","callAll","getBabTotal","bab","getNegativeEnergyDrain","energyDrain","getAbilityMod","abilities","mod","addDefaultChanges","actorData","tempChanges","components","ItemChange","allClasses","racialHD","all","subType","healthConfig","classOptions","hitdice","PC","NPC","raceOptions","Racial","nearest","down","rounding","discrete","continuity","pushHealth","autoHealth","healthSource","maximized","hpPerHD","hd","hpPerTier","tiers","dieHealth","rate","hitDice","fc","hp","computeHealth","healthSources","auto","race","manualHealth","pushMana","computeMana","manaSources","mpsource","classBaseMPauto","manaSource","mana","mp","manualMana","classBaseMPTypes","manaChart","classMPlevels","level_mana","autoMana","useFractional","savingThrows","hasGoodSave","good","goodSaveFormula","classFractionalSavingThrowFormulas","goodSaveBonus","hpAbility","wounds","drain","mp_source","mpAbility","classCastingStat","spellMath","ClassSpellLvlProgression","currentSpellLvl","mpProg","classMPStatsBonus","arrayStr","acp","attackPenalty","strAbl","strAbility","abl","fort","ref","will","sr","cStr","details","carryCapacity","bonus","cMultBase","cMult","ac","naturalAC","equipped","armorTarget","armor","enh","baseAC","broken","enhAC","flyKey","fly","maneuverability","flyValue","flyManeuverabilityValues","climb","swim","sizeKey","traits","sizeMods","sizeStealthMods","sizeFlyMods","sizeSpecialMods","con","mechanic","conditionMechanics","changeData","changeObj","flag","resetSkill","acpPenalty","abilityModifier","changeModifiers","changeBonus","classSkillBonus","skillKey","subSkillKey","subSkill","positive","setSourceInfoByName","getHighestChanges","ignoreTarget","highestTemplate","ids","highestID","highest","filterFunc","stackingBonusModifiers","defaultData","updateTime","Date","ItemPF","dataObj","newChangeData","randomID","isDeferred","getSourceInfoTargets","prepareData","preUpdate","changeSubTargets","getChangeSubTargets","rawChange","applyChange","isOwner","msgSourceReference","errorMessage","errorData","onError","msg","notifications","refresh","overrides","override","modifierChanger","isModifierChanger","abilityTarget","createFunction","missing","newAbility","sourceInfoTargets","infoEntryData","sourceInfoGroup","si","infoTarget","sInfo","doAdd","sumValue","existingInfoEntry","infoEntry","hasSameParent","isEnh","hasSameTarget","hasHighestValue","isSameModifier","isSameTarget","hasHigherValue","findSplice","entry","funcDef","funcArgs","preDef","postDef","fullDef","DamageRoll","damageType","custom","NORMAL","CRITICAL","NON_CRITICAL","isCritical","TYPES","HealthConfig","FormApplication","defaultSettings","defaultOptions","width","height","tabs","navSelector","contentSelector","initial","hitdieOptions","variants","pc","useWoundsAndVigor","useWoundThresholds","allowWoundThresholdOverride","npc","activateListeners","_onReset","bind","_onSubmit","render","clamped","ExperienceConfig","_init","_settings","hasCustomFormula","track","disableExperienceTracking","openXpDistributor","_onButtonSubmit","_onChangeInput","_updateApplicationSettings","_getSubmitData","AccessibilityConfig","TooltipWorldConfig","_cachedData","getData","permissions","DOCUMENT_OWNERSHIP_LEVELS","NONE","LIMITED","OBSERVER","OWNER","disable","portrait","hideHeld","hideArmor","hideBuffs","hideConditions","hideClothing","hideActorNameByDisposition","minimumPermission","hideActorNameReplacement","TooltipConfig","canvasRect","view","getBoundingClientRect","screen","halfWidth","halfHeight","r1","r2","preview","hideKey","anchor","offset","onMouse","maxSize","hideWithoutKey","_handleImmediateChange","_openWorldSettings","tagName","checked","dtype","can","TooltipPF","Application","mousePos","clientX","clientY","hidden","_setPosition","forceHideGMInfo","forceHide","old","popOut","worldConfig","style","visibility","unbind","clearBind","stringContent","getTokenData","Actor","getActorData","tooltipName","hideName","disposition","getPortrait","conditionId","itemTypes","hideFromToken","held","getName","equipment","clothing","url","maxWidth","maxHeight","elSize","position","left","top","sb","sidebar","mw","mh","minPos","maxPos","pos","TOKEN_DISPOSITIONS","SECRET","force","loadableContent","loadableContentCount","loadedContentCount","one","tokenHover","hovering","elementFromPoint","enable","setPosition","registerSystemSettings","register","scope","Boolean","registerMenu","hint","restricted","onChange","toggle","choices","rule","grid","imperial","metric","perception","initializeLighting","initializeVision","refreshLighting","refreshVision","refreshSheets","reset","requiresReload","promises","prototypeToken","actorLink","toggleConditionStatusIcons","Promise","confirm","defaultYes","migrateSystemSettings","storage","removeItem","getSkipActionPrompt","skipConfirmPrompt","D20RollPF","Die","staticRoll","faces","getFormula","critical","fumble","TEN","TWENTY","d20","isCrit","_evaluated","isFumble","logCompatibilityWarning","since","until","isNat20","isNat1","natural","bonusTerms","DIALOG_TEMPLATE","renderData","rollModes","dialogOptions","resolve","normal","_onDialogSubmit","takeTen","STATIC_ROLL","takeTwenty","form","baseDice","messageData","CHAT_TEMPLATE","getTooltip","compendiumEntry","compendium","compendiumEntryType","noSound","messageClass","messageObject","_applyBonus","_evaluate","_applyStaticRoll","_evaluateSync","newTotal","ItemAction","apps","description","isCombatManeuver","actionType","activation","unchained","newActionData","actions","defaultDamageType","tag","hasAction","hasAttack","hasMultiAttack","attackParts","formulaicAttacks","count","autoDeductCharges","getChargeCost","isCharged","isSelfCharged","uses","per","useSpellPoints","spellPointCost","autoDeductChargesCost","getDefaultChargeFormula","cost","isSingleUse","getRange","minRange","maxRange","minValue","rangeType","minUnits","units","singleIncrementRange","maxIncrements","hasTemplate","hasDamage","hasRange","hasEffect","effectNotes","hasSave","getDC","dcBonus","dcFormula","dc","spellbook","baseDCFormula","hasSound","soundEffect","enhancementBonus","damageSources","isSpell","isWeapon","getContextChanges","allDamageSources","conds","conditionals","mods","fakeCondChanges","isModifier","allChanges","events","duration","maxFormula","overrideColor","customColor","overrideTexture","customTexture","attackName","attackBonus","critConfirmBonus","critParts","nonCritParts","attack","damageMult","critRange","critMult","attackNotes","powerAttack","damageBonus","critMultiplier","naturalAttack","primaryAttack","secondary","nonlethal","touch","usesAmmo","spellEffect","spellArea","parseFormulaicAttacks","_prepareConditionals","maxUses","collection","Collection","conditional","has","ItemConditional","updateData","findIndex","prevData","newUpdateData","keepPaths","getChatData","htmlOptions","chatDataOptions","getLabels","actionData","isUnchainedActionEconomy","activationTypes","abilityActivationTypes_unchained","abilityActivationTypes","activationTypesPlural","abilityActivationTypesPlurals_unchained","abilityActivationTypesPlurals","filterJoin","totalDC","threshold","sourceUnits","rangeLabel","distanceUnits","rangeUnit","exAtkCountFormula","xaroll","extraAttacks","exAtkBonusFormula","attackCount","extraParts","isRanged","isCMB","sizeBonus","proficiencyPenalty","sourceDetails","reverse","masterwork","cleanFlavor","proficient","rollEffect","ablMult","getContextNotes","notes","cur2","effectContent","fx","toMessage","chatFlavor","conditionalParts","extra","isExtra","ablDamage","ablLabel","part","rollParts","getConditionalTargets","conditionalTargets","_label","getConditionalSubTargets","misc","hasProperty","getConditionalModifierTypes","damageTypes","getConditionalCritical","crit","nonCrit","actionID","use","ChatAttack","setAction","critConfirm","hasCritConfirm","critDamage","damageRows","notesOnly","cards","hasCards","attackNotesHTML","effectNotesHTML","ammo","setAmmo","ammoItem","setRollData","critCount","setAttackNotesHTML","setEffectNotesHTML","noAttack","ccKeys","ccKey","rollAttack","addAttack","addAttackNotes","typeMap","rsak","rwak","rcman","mwak","msak","mcman","getContextNotesParsed","repeatCount","repeat","rollDamage","tooltips","totalDamage","properties","nnl","addEffectNotes","finalize","ERR_REQUIREMENT","NO_ACTOR_PERM","DISABLED","INSUFFICIENT_QUANTITY","INSUFFICIENT_CHARGES","MISSING_AMMO","INSUFFICIENT_AMMO","ActionUse","shared","defineProperties","checkRequirements","itemQuantity","quantity","createAttackDialog","AttackDialog","alterRollData","atkBonus","dmgBonus","pointBlankShot","fullAttack","manyShot","useMeasureTemplate","abilityDamageMultOverride","basePowerAttackBonus","powerAttackBonus","powerAttackMultiplier","powerAttackPenalty","casterLevelCheck","concentrationCheck","generateAttacks","forceFullAttack","unnamedAttackIndex","allAttacks","exAtkCount","formulaicAttack","abundant","atk","ammoUsage","attacks","currentValue","updateEmbeddedDocuments","handleConditionals","conditionalData","conditionalRoll","partString","flavoredFormula","conditionalPartsCommon","chargeCostBonus","checkAttackRequirements","chargeCost","charges","getSpellUses","addAttacks","addDamage","chatAttack","saveDC","_getConditionalParts","conditionalTemplates","addPart","templateKey","templateStr","parsedStr","powerAttackCritBonus","chatAttacks","dist","templateOptions","texture","AbilityTemplate","actorSheet","sheetRendered","_element","minimize","drawPreview","maximize","place","mergeRolls","skipRolls","showRoll","pools","pool","attackPool","critPool","getMessageData","templateData","OTHER","alias","props","extraText","itemChatData","chatcard","addGenericPropertyLabels","header","combat","combatProps","addCombatPropertyLabels","clNotes","identifiedDescription","unidentifiedDescription","hasExtraText","hasProperties","gmSensitiveLabel","usystem","rangeUnits","spellFailure","somatic","arcaneSpellFailure","spellFailureRoll","spellFailureSuccess","generateChatMetadata","tokenData","_source","atWill","woundThresholds","woundThresholdConditions","getTokensWithin","combatant","isDefeated","attackRolls","damageIndex","damageRoll","scriptData","executeScriptCalls","attackData","skipDialog","hideChat","descriptionOnly","links","_rollData","isPhysical","_preCreate","DEFAULT_ICON","defaultIcons","updateSource","updated","updates","preCreateData","changed","_preUpdate","_chargePreUpdate","maxCharges","memoryVariables","firstAction","isOwned","parentItem","getDefaultChargeCost","period","exact","commit","rechargeFormula","isFinite","totalDurationSeconds","totalSeconds","auraStrength","parentActor","limited","forcePlayerPerspective","unidentified","permission","fullDescription","getDescription","effects","origin","exec","groups","actionTypes","defaultContextNote","addCharges","prevValue","defaultAmmo","showUnidentifiedData","prepareWeight","sourceData","sourceWeight","baseWeight","weightReduction","currency","converted","convertWeight","prepareLinks","_prepareChanges","_prepareActions","scriptCalls","_prepareScriptCalls","prepareDerivedItemData","prepareBaseData","itemTemplate","taggedTypes","useCustomTag","_updateMaxUses","checkYes","checkNo","carried","hasSlots","slot","equipmentSlots","wondrous","getLinkedItemsSync","scriptCall","ItemScriptCall","_prepareInventory","inventory","extraParams","scripts","execute","recursive","memorizeVariables","diffObject","inventoryItems","_memoryVariables","memKeys","_onUpdate","userId","oldQuantity","previous","oldLevel","itemUpdateData","memoryItemData","diffData","getRawEffectData","getScriptCalls","altChatData","isVersatile","hasExtraProperties","extraProperties","pfFlags","canPopout","enrichOptions","shortDescription","dynamicLabels","distanceValues","saveDesc","timePeriods","enhBonus","getTypeChatData","reject","displayCard","originalEvent","ActionChooser","writable","enumerable","actionUse","measureResult","reqErr","code","generateChatAttacks","promptMeasureTemplate","handleDiceSoNice","subtractAmmo","postMessage","updateTokenTargets","broadcastActivity","delete","subTargetList","dFlags","_onChatCardButton","_onChatCardToggleContent","card","messageId","_getChatCardActor","_onChatCardAction","asNonlethal","tags","applyDamage","ammoRecovery","chance","recoverChance","random","rollConcentration","rollCL","display","popout","actorId","canCreateItemLink","linkType","dataType","targetItem","itemLink","sameActor","targetLinks","deeptarget","generateInitialLinkData","newItem","createItemLink","extraData","getLinkItem","linkData","getLinkedItemSync","linkItems","actorSkills","s2","skl2","getTotalCurrency","sellValue","inLowestDenomination","forceUnidentified","price","pricePerUse","getActualValue","convertCurrency","flagName","boolean","hasItemBooleanFlag","getItemBooleanFlags","dictionary","getItemDictionaryFlag","getItemDictionaryFlags","getAttackArray","appendAttack","fmAtk","fmAtkBonus","condBonuses","fill","sc","bonusRoll","totalBonus","getAttackSources","attackArray","sources","isMelee","weaponSubtype","isManeuver","describePart","srcDetails","changeSources","effectiveChanges","ic","ablMod","virtualEnh","secondaryModifier","attackSources","getAllDamageSources","ItemAttackPF","ItemBuffPF","start","time","worldTime","_preDelete","buffTypes","unit","timePeriodsShort","_prepareDuration","seconds","roundTime","noCreate","existing","createData","ActiveEffect","hideIcon","turns","rounds","recharge","ItemClassPF","_prevLevel","classLinks","classAssociations","_onCreate","casting","bookData","createSpellbook","_onDelete","books","spellbooks","usedBook","bookId","book","inUse","newLevel","prevLevel","_onLevelChange","curLevel","Map","newItems","fromCompendium","itemsCreationData","_typeSorting","SORT_INTEGER_DENSITY","associations","itemIds","deleteDocuments","mythicTier","progression","domainSlots","cantrips","saveFormulas","classSavingThrowFormulas","classType","saveData","saveType","goodSave","babFormulas","classFractionalBABFormulas","classBABFormulas","babType","babFormula","babBase","classData","hasPlayerOwner","isBaseClass","alt","customHD","ItemConsumablePF","ItemContainerPF","_calculateCoinWeight","contents","embeddedName","itemOptions","temporary","renderSheet","noHook","vtt","newItemIds","getContainerContent","pending","pgil","totalValue","coinWeightDivisor","ItemEquipmentPF","subtype","equipmentSubtype","subtypes","equipmentTypes","slotTypes","eType","typeKeys","eSubtype","subtypeKeys","subtypeLabels","equipmentType","dex","shieldTypes","armorTypes","shieldType","shield","heavy","tower","armorType","ItemFeatPF","abilityType","featType","featTypes","abilityTypes","short","traitType","traitTypes","ItemLootPF","extraType","ItemRacePF","oldRace","actorSize","newSize","oldSize","_pf1SizeChanged","templatePaths","preloadHandlebarsTemplates","loadTemplates","renderCachedTemplate","Handlebars","partials","preventIndent","ItemSpellPF","_assignLevelOnCreate","_preparationPreUpdate","prep","preparation","maxAmount","preparedAmount","learnedAt","spellLevels","school","spellSchools","getSpellComponents","getEffectiveSpellLevel","slOffset","spellLevel","getEffectiveCasterLevel","clOffset","casterLevel","psychic","verbal","spellAbility","classLevel","isSpontaneous","spontaneous","spellbookKey","curUses","tempMP","curMP","leftMP","newCharges","actorUpdateData","spellPoints","useSystem","temp","spontaneousPrepared","srcData","reSplit","traitSeparator","srcComponents","srcMaterials","materials","thought","emotion","material","divineFocus","df","dfVariants","classId","tc","classCasterType","origData","capitalize","minLevel","minCl","materialPrice","gilValue","_replaceConsumableConversionString","arrKey","note","isWand","isPotion","isScroll","canCast","isDomain","domain","spellDescriptionData","multi","multischool","multiSchools","subschool","srinfo","act","activationCost","activationType","activationTypesPlurals","castingTime","rangeValue","area","savingThrowDescription","useDCandSR","slotCost","ItemWeaponPF","newWeaponType","weaponTypes","wType","wSubtype","weaponType","LinkFunctions","otherItem","Spellbook","bookKey","addSpell","SpellbookLevel","SpellbookSlots","domainMax","domainUnused","used","SpellRanges","SpellbookMode","isHybrid","isPrestige","isPrepared","usesSpellpoints","isSemiSpontaneous","spellPreparationMode","sharedVision","menuItems","visionPermissionSheet","rendered","_minimized","VisionPermissionSheet","appId","closeOnSubmit","submitOnClose","submitOnChange","isLinkedToken","defaultLevels","levels","ActorPF","itemFlags","_queuedUpdates","_runningFunctions","containerItems","_states","_itemTypes","_visionPermissionSheet","_onChatCardButtonAction","saveId","JournalEntryPage","pageId","actorName","_race","creatureType","humanoid","typeColor","_prepareContainerItems","getContainerContents","_prepareItemFlags","bFlags","applyActiveEffects","allItems","timeOffset","temporaryEffects","ae","startTime","startRound","disableActiveEffects","deleteActiveEffects","disableBuffs","actorUpdate","reason","hasActorUpdates","deleteAEContext","disableAEContext","disableBuffContext","none","resources","_resetInherentTotals","ab","baseMod","userPenalty","refreshAbilityModifiers","_prepareClassSkills","skillSet","actorItems","relevantActorItems","classSkillName","isClassSkill","classSkills","hasArmorProficiency","proficiencyName","customProficiencies","armorProf","customTotal","prof","_updateSpellBook","cache","bookClassId","bookClass","_generateSpellbookCache","bookInfo","spellbookAbility","spellSlotAbilityScoreBonus","spellSlotAbilityBonusFormula","spellSlotAbilityMod","clTotal","autoSpellLevelCalculation","autoFormula","autoSpellLevelCalculationFormula","autoBonus","autoTotal","autoSpellLevelTotal","clBonus","concentration","concFormula","concentrationFormula","formulaRoll","classAbilityMod","prevTotal","getAbilityBonus","getSpellSlotIncrease","useAuto","casterType","castsForLevels","casterProgression","isSafeInteger","allLevelModFormula","allLevelMod","levelData","spellsForLevel","spellsPreparedPerDay","offsetFormula","hasCantrips","autoSpellLevels","oldval","slots","domainSlotValue","levelSpells","lvlSlots","subtract","maxLevelByAblScore","preparedAllOffsetFormula","spellLevelData","lowAbilityScore","remaining","known","unused","available","preparedOffsetFormula","dSlots","acc","spellMessage","spellRemainingMsg","unusedKnown","spellClass","bookKeys","allSpells","updateSpellbookInfo","usedSpellbooks","maxDexBonus","maxBonus","encPen","_computeEncumbrance","gearPen","_applyArmorPenalties","encumbrance","gear","prepareProficiencies","updateItemResources","prepareSpecificDerivedData","prepareCMB","prepareItemLinks","_initialized","_setSourceDetails","proficiencies","armorProficiencies","weaponProf","weaponProficiencies","languages","translations","profs","hasInfo","proficiency","customProfs","shrAtk","genAtk","general","cmbAbl","cmbAbility","cmbAblMod","cmb","totalAtk","updateWoundThreshold","arbitrarySkills","backgroundSkills","background","acAbl","acTouchAbl","cmdDexAbl","dexAbility","acAblMod","acTouchAblMod","cmdDexAblMod","maxDex","flatFooted","acAblKey","flatFootedTotal","armorItems","reducedSpeed","encumbranceLevels","speedValue","getReducedMovementSpeed","alignment","alignments","measureUnitsShort","proficiencyMaps","lightArmor","mediumArmor","heavyArmor","lightShield","heavyShield","towerShield","attackACPPenalty","mdex","eqType","isShieldOrArmor","itemACP","brokenACP","mDex","isInteger","itemMDex","ignoreNull","brokenId","totalACP","bt","hpconf","wtData","getWoundThresholdData","changeFlatKeys","fk","changeTarget","changeGrp","grp","srcInfo","_translateSourceInfo","srcValue","_getInherentTotalsKeys","vigor","armorBonus","shieldBonus","skillKeys","getLevelExp","_syncTokenImage","oldData","tokenSizes","isToken","staticSize","scale","absoluteKeys","absKey","conditionGroup","conditionTracks","conditionKey","_updateExp","sourceUser","senses","ll","visionPermissions","visionUpdate","getActiveTokens","_syncSenses","FFD20","scaleX","scaleY","_onCreateEmbeddedDocuments","_onUpdateEmbeddedDocuments","ri","itemTag","res","attackItem","baseTypes","weaponGroups","oldBook","_","skillName","parentSkill","mainSkillId","subSkillDelim","isSubSkill","mainSkill","dataSkill","skillMatch","haveParentSkill","noteObjects","formatContextNotes","rt","cf","rollOptions","skillCompendiumEntries","journal","d20Roll","ranged","grappled","attackTargets","attackChanges","atkAbl","wT","valid","formulaBonus","getDefenseHeaders","damageResistances","damageVulnerabilities","headers","dr","eres","dv","cres","di","ci","conditionTypes","getInitiativeContextNotes","notesHTML","notesHTMLParts","createCombatants","rerollInitiative","initiativeOptions","getDocumentClass","toCreate","inCombat","sceneId","combatants","initiative","rollInitiative","savingThrowId","abilityId","checkMod","acNoteObjects","acNotes","cmdNoteObjects","cmdNotes","srNoteObjects","srNotes","drNotes","energyResistance","immunity","vulnerability","wTlabel","fastHealing","regen","newStatus","deleteKey","enabled","hasCondition","forceDialog","reductionDefault","asWounds","healingInvert","numReg","sliceReg","sliceReg2","_submit","dR","tok","actorType","character","tmp","currentHealth","woundAdjust","dt","newHP","nld","buildResistances","resistances","type2","translatedType","type1","dialogData","healing","damageReduction","half","inp","swapSelected","chk","setReduction","mouseWheelAdd","increase","sign","deltaY","getWoundThresholdMultiplier","woundMult","woundLevel","usage","wt","penaltyBase","curHP","tempHP","maxHP","wtMult","wtMod","woundThresholdChangeTargets","curValue","allSkills","allNotes","saveKey","saveNotes","ablKey","miscKey","spellbookNotes","concentrationNotes","noteObj","subnote","carry","getCarryCapacity","drag","carriedWeight","getCarriedWeight","encLevel","carryStr","carryMultiplier","quadruped","encumbranceMultipliers","table","encumbranceLoads","multiplierCount","pow","mergeCurrency","currencies","NaN","largestType","sp","_prepareArmorData","armorData","skipRefresh","clearFields","temporaryRollDataFields","k3","combats","viewed","loseDexToAC","sizeChart","eqData","abilityMod","getReach","stature","_addChildren","children","getLinkedItems","child","removeItemLink","getQuickActions","showInQuickbar","haveAnyCharges","maxCharge","togglingStatusIcons","buffTextures","toDelete","toUpdate","existingData","mergedData","condKey","hasEffectIcon","autoDelete","removeEffects","deleteContext","createContext","newMod","migrations","isMigrating","_prevAbilityScores","diffMod","json","getFeatCount","totalLevels","featCountRoll","bonusFeatFormula","restorePoints","restoreFormula","restoreRoll","itemUpdates","getPathData","itemUpdate","sbUses","_changed","_restingHeal","hours","longTermCare","aidedCare","heal","recover","dmg","restoreHealth","restoreDailyUses","healUpdate","spellbookUpdates","resetSpellbookUsage","rechargeItems","attribute","isDelta","isBar","resourceMatch","getItemByTag","getActorShim","createItemMacro","macro","macros","Macro","displaySheet","assignHotbarMacro","createActionMacro","actionMacro","createSkillMacro","skillInfo","createSaveMacro","saveName","createMiscActorMacro","getBookLabel","getActiveActor","altType","rollCMB","rollBAB","itemName","itemType","forceShowItem","rollSkill","ActorPFProxy","Proxy","construct","ItemPFProxy","fine","tiny","sm","med","lg","huge","grg","col","slow","fast","noncaster","halfCaster","dimPacman","pacman","dimFullCaster","fullCaster","advFullCaster","int","wis","cha","passive","free","nonaction","swift","immediate","move","standard","full","aoo","minute","hour","special","reaction","ex","su","tall","ng","cg","ln","tn","cn","le","ne","ce","arrow","bolt","repeatingBolt","slingBullet","gunBullet","dragoonBullet","dart","lgt","hvy","shl","twr","weapon","racialAbility","untyped","untypedPerm","dodge","haste","inherent","deflection","morale","luck","sacred","insight","resist","profane","trait","racial","competence","circumstance","alchemical","defense","abilityChecks","acpA","acpS","mDexA","mDexS","strMod","dexMod","conMod","intMod","wisMod","chaMod","unskills","carryMult","strSkills","dexSkills","conSkills","intSkills","wisSkills","chaSkills","allChecks","strChecks","dexChecks","conChecks","intChecks","wisChecks","chaChecks","landSpeed","climbSpeed","swimSpeed","burrowSpeed","flySpeed","allSpeeds","aac","sac","nac","tac","ffac","mattack","rattack","wdamage","sdamage","allSavingThrows","ffcmd","mhp","mmp","spellResist","bonusFeats","bonusSkillRanks","castsPerDay","prepared","low","high","hybrid","prestige","no","yes","astrologian","blackmage","bluemage","geomancer","illusionist","necromancer","summoner","timemage","whitemage","bard","cleric","redmage","scholar","darkknight","holyknight","intAndWis","mythic","coreArc","baseArc","hybridArc","pf1_blind","dazzled","pf1_deaf","entangled","helpless","pf1_sleep","paralyzed","pf1_prone","pinned","cowering","shaken","frightened","panicked","sickened","nauseated","stunned","exhausted","fatigued","squeezing","antagonized","berserk","bleed","burning","charmed","confused","cursed","dazed","deprotect","deshell","dimmed","diseased","doom","drenched","energyDrained","fascinated","frog","frozen","immobilized","imperil","incorporeal","invisible","mini","petrified","poisoned","sapped","silenced","squalled","staggered","stop","unlucky","weighted","zombie","fear","lethargy","allAttack","hasteAttack","rapidShotAttack","allDamage","hasteDamage","rapidShotDamage","oil","poison","drug","alchContact","alchIngested","alchInhaled","rod","staff","meleeWeapon","meleeSpell","rangedWeapon","rangedSpell","exp","noExp","aberration","animal","dragon","fey","magicalBeast","monstrousHumanoid","ooze","outsider","plant","undead","vermin","consumable","container","feat","loot","basic","personal","ft","mi","spec","seeText","unlimited","slotless","head","headband","eyes","shoulders","neck","chest","body","belt","wrists","hands","ring","feet","materia","any","weaponarmor","armorShield","independent","summon","support","classFeat","clumsy","poor","average","perfect","temphp","spellsave","common","dwarven","elvaan","galkan","lalafellan","mithran","moogle","aegyllan","albhedian","banganese","burmecian","draconic","garif","guado","hypello","lupin","mandragoran","numish","qiqirn","queran","roegadyn","ronsaur","seeq","tonberry","vieran","celestial","infernal","abyssal","aquan","auran","auroran","enochian","ignan","terran","thorian","umbran","amaljaa","antican","goblin","kojin","orcish","quadav","sahagin","sylvan","undercommon","vanu","yagudo","single","day","week","tradeGoods","power","uncommon","rare","legendary","unslotted","cone","circle","rect","km","blank","sumhealenc","sumheal","sumenfdrk","sumenflit","sumenfele","sumenf","sumenc","sumdrk","sumlit","sumele","sumnel","crnheal","crnnec","crnenf","crnenc","healenf","healenc","illenf","illenc","necenc","necenf","necele","necnel","enfenc","enfdrkele","enfdrknel","enfdrk","enflit","enfele","enfnel","encdrk","enclit","encele","encnel","drkele","drknel","litele","litnel","points","epic","bs","bse","ts","tr","sid","acr","apr","blf","clm","crf","dip","dev","dis","dri","esc","han","hea","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","kte","lin","nav","prf","pil","pro","rep","rid","sen","slt","spl","ste","sur","swm","umd","V","S","T","E","M","F","DF","atwill","crn","drk","div","ele","enc","enf","ill","lit","nec","nel","sum","uni","creature","ally","enemy","space","radius","sphere","cylinder","square","cube","line","wall","inst","turn","month","year","magic","faith","social","campaign","cosmic","exemplar","faction","family","mount","region","religion","drawback","axes","bladesHeavy","bladesLight","bows","crossbows","double","firearms","flails","hammers","monk","polearms","siegeEngines","spears","thrown","tribal","oh","sim","mar","exo","che","ato","blc","brc","dea","dst","dbl","fin","frg","imp","mnk","rch","sct","snd","spc","thr","trp","simple","martial","exotic","chef","splash","BaseFilter","compendiumBrowser","configurable","registerIndexFields","handledTypes","choice","activeChoiceCount","indexField","compendiumIndexFields","setup","prepareChoices","hasChoices","applyFilter","TEMPLATE","activeCount","field","root","UMD","highlightCallback","cb","NULL","targetLen","indexes","_indexes","highlighted","matchI","indexesI","opened","substr","prepare","prepareLowerInfo","_targetLower","_lower","_targetLowerCodes","lowerCodes","_nextBeginningIndexes","_bitflags","bitflags","prepareSearch","search","spaceSearches","containsSpace","searches","_info","getPrepared","targetPrepared","preparedCache","getPreparedSearch","searchPrepared","preparedSearchCache","INT_MAX","isObj","INT_MIN","objResults","keyI","algorithm","preparedSearch","allowSpaces","algorithmSpaces","searchLower","searchLowerCodes","searchLowerCode","targetLowerCodes","searchLen","searchI","targetI","matchesSimpleLen","matchesSimple","successStrict","matchesStrictLen","nextBeginningIndexes","prepareNextBeginningIndexes","backtrackCount","matchesStrict","substringIndex","isSubstring","isSubstringBeginning","matchesBest","matchesBestLen","extraMatchGroupCount","uniqueBeginningIndexes","seen_indexes","first_seen_index_last_search","allowSpacesResult","strLen","lower","lowerCode","charCodeAt","beginningIndexes","beginningIndexesLen","wasUpper","wasAlphanum","targetCode","isUpper","isAlphanum","isBeginning","prepareBeginningIndexes","lastIsBeginning","lastIsBeginningI","defaultScoreFn","segs","noResults","poll","peek","replaceTop","searchBitflags","go","resultsLen","limitedCount","targetsLen","scoreFn","keysLen","highlight","hOpen","hClose","matchesIndex","cleanup","clear","module","CompendiumBrowser","filters","expandedFilters","_query","_loadingInfo","_debouncedRender","debounce","window","innerHeight","resizable","scrollY","dragDrop","dragSelector","dropSelector","compendiumClasses","ItemBrowser","FeatBrowser","SpellBrowser","ClassBrowser","RaceBrowser","CreatureBrowser","BuffBrowser","packNames","resultPromise","indexingPromises","finally","__pack","__packLabel","__uuid","__name","fuzzysort","normalize","ENTRY_TEMPLATE","typeName","filterClasses","isPackIncluded","indexCount","entryCount","private","getIndexes","unorderedEntries","loadPackIndex","flat","indexed","_mapEntry","getFilteredEntries","activeFilters","every","selectionStart","input","selectionEnd","query","collapsed","_entries","itemCount","filteredItemCount","loading","loadingInfo","_initLazyScrolling","filterContent","filterId","_onClickEntry","_onRefresh","_onResetFilters","_onFilterHeaderClick","_onCustomSearchFilter","ContextMenu","_getEntryContextOptions","editable","locked","canUserCreate","collections","importFromCompendium","clipboard","copyPlainText","_canDragStart","_onDragStart","dataTransfer","setData","_event","filterContents","listEnd","IntersectionObserver","observer","isIntersecting","currentCount","newEntries","unobserve","newHtml","_renderEntries","insertAdjacentHTML","rootMargin","observe","ActorTraitSelector","DocumentSheet","sheetConfig","attr","chosen","updateButton","_updateObject","Registry","_initialize","_defaultData","namespace","unregister","fromEntries","registryObject","RegistryEntry","abstract","DataModel","StringField","required","ObjectField","schema","DamageType","defineSchema","DamageTypes","CATEGORIES","BooleanField","DamageTypeSelector","dataPath","_dataPath","damageCategorySortOrder","damageCategories","categoryObj","o2","sortOrder","idxA","idxB","damageModifiers","_toggleDamageType","_onChangeData","ActorResistanceSelector","isDR","originalEntries","damageOBJ","dType","damages","operators","true","false","dtypes","dataCount","_onResistanceControl","_onResistanceChange","_onResistanceCustomChange","index2","updateValue","ActorRestDialog","performRest","aidedcare","PointBuyCalculator","actorAbl","ablValues","abilityCost","usedPoints","getSpentPoints","pointBuy","limitsArr","ldata","limits","invalidPoints","_onAbilityControl","Widget_ItemPicker","columns","_items","parentElem","rootElem","parseHTML","rowElem","itemElem","widthRate","offsetLeft","offsetBottom","setTimeout","_onClickItem","_cancelCallback","_onCancel","cancel","removeEventListener","dialogGetActor","dialogGetNumber","cancelled","ok","htm","select","LevelUpForm","_submitted","_section","_sections","_addSections","_addSummarySection","section","currentSection","setSection","rawData","_app","_onClose","sections","summary","getSummaryData","_parseSection","hpSettings","manualValue","isFavouredClass","newHD","newAbilityScores","levelAbilityScores","added","isEnhanced","callbacks","prevItem","levelingClass","lvlwaiter","hid","_waiter","newAssociations","newFeatures","co","featCount","newAbilityScore","createChatMessage","_parseSection_health","hpValue","_parseSection_fc","fcKey","desc","_parseSection_ability","levelAbilityScoreFeature","levelUp","_onClickListItem","_onChangeSectionChoice","_onClickAbilityScoreOperator","_onPreviousSection","_onNextSection","currentItem","_updateNavButtons","sectionName","formDiv","submit","hasMadeChoice","altCurrency","notification","order","_curRange","_calcTotal","trigger","_options","formField","amounts","i18nKey","docDestId","destDoc","actorUuid","containerId","sourceDoc","allowConversion","_failed","sourceCurrency","destCurrency","originalSource","totalAmount","totalSource","newSource","socket","emit","minRequired","inCopper","ActorSheetPF","ActorSheet","_filters","features","searchCompositioning","searchRefresh","searchDelay","searchDelayEvent","effectiveSearch","_itemUpdates","_hiddenElems","_submitQueued","_renderedInner","_pendingUpdates","_skillsLocked","_expandedItems","featTypeData","hasActions","currentPrimaryTab","primaryElem","currentSpellbookKey","elems","owner","isEditable","isCharacter","hasRace","useBGSkills","usesAnySpellbook","skillsLocked","inCharacterGeneration","hasProficiencies","hasCurrency","hasAltCurrency","biographyHTML","biography","hasResource","hasUses","firstActionRollData","isStack","itemCharges","empty","sizeModifier","baseBonus","meleeAbility","rangedAbility","genericAttacks","cgilValue","calculateTotalItemValue","totalLabel","arbitrary","untrained","_prepareTraits","_prepareSenses","_prepareResistance","_prepareItems","skillsets","_prepareSkillsets","skillRanks","allowed","bgAllowed","bgUsed","sentToBG","clsLevel","clsSkillsPerLevel","skillsPerLevel","fcSkills","backgroundSkillClasses","backgroundSkillsPerLevel","bonusSkillRankFormula","byLevel","byFormula","_prepareHiddenElements","hiddenElems","magicItems","aura","strength","auraStrengths","identifyDC","firstClass","selected","counter","_prepareSpellbook","usesSlots","canCreate","canPrepare","baseSlots","lvl","skillset","adventure","backgroundOnlySkills","_typeFilterCount","_filterItems","hasTypeFilter","load","carryLabel","kg","lbs","pct","encumbered","aboveHead","offGround","dragPush","mousemove","_moveTooltips","filterLists","_initializeFilterItemList","_onToggleFilter","_searchFilterChange","_searchFilterCompositioning","_clearSearch","_onItemSummary","_onItemEdit","contextmenu","_onRaceControl","_onSpanTextInput","_adjustActorPropertyBySpan","_onInputText","_onConfigControl","_selectOnClick","preventRender","keypress","_onSubmitElement","_onRollAbilityTest","_onRollBAB","_onRollCMB","_onRollMelee","_onRollRanged","_onRollInitiative","_onRollSavingThrow","_onArbitrarySkillCreate","_onArbitrarySkillDelete","_onSkillCreate","_onSkillEdit","_onSkillDelete","_itemActivationControl","_onRollSkillCheck","_onRollSubSkillCheck","_onOpenCompendiumEntry","_onTraitSelector","_onResistanceSelector","_onRest","_onPointBuyCalculator","_onControlAlignment","_onSensesSelector","_onItemCreate","_onItemDelete","_onItemGive","_onItemSplit","_onItemRoll","_quickChangeItemQuantity","_quickEquipItem","_quickCarryItem","_quickIdentifyItem","_itemToggleData","_duplicateItem","_quickAction","_convertCurrency","_setFeatUses","_onLevelUp","_setSpellUses","_setMaxSpellUses","_onRollConcentration","_onRollCL","_setItemActive","_setBuffLevel","_hideShowElement","_onToggleCondition","_onToggleSkillLock","_onOpenCompendium","parentElement","newEl","noCap","maxName","forbiddenClasses","allowRelative","replaceChild","_onDragSkillStart","skillElem","_onDragMiscStart","tab","_onDragSaveStart","ul","stopPropagation","_mouseWheelAdd","isInput","WheelEvent","ctrlKey","wheelStep","MouseEvent","setItemUpdate","_updateItems","for","hasClass","slideDown","slideUp","actionTarget","parents","openItemSummary","instant","toggleClass","attrName","wheelEvent","handler","keyHandler","mainSkillData","_editSkill","isBackground","SkillEditor","addCallback","deleteSkill","rejectClose","SensesSelector","alignmentsShort","curQuantity","newQuantity","property","newName","iter","searchUnusedName","currencyType","_sortNewItem","oldItems","oldItem","_isItemSameSubGroup","baseName","names","ItemSheet","targetData","createContainerContent","splitValue","createDocuments","rollAbilityTest","savingthrow","canEquip","lootTypes","hasASF","spellbookData","orig","spellbookSpells","asfSources","asf","itemASF","totalWeight","featureDefaults","featData","featKey","featValue","featTypesPlurals","abilityTypeShort","canLevelUp","buffSections","buffId","attackSections","showTypes","typeFilterCount","_hidden","quickActions","_searchFilterCommit","jq","matchSearch","clearTimeout","blur","_createPlaceholders","_renderInner","preventClose","fromDropData","_onSortItem","_alterDropItemData","_onDropItemCreate","deleteContainerContent","item0","item1","itemDatas","creationData","resultData","addClassWizard","dragData","nextElementSibling","cr","changedData","selectedIndex","calculateSellItemValue","sellMultiplier","placeholder","ActorSheetPFBasic","ActorSheetPFCharacter","xpSettings","disableExperience","minimumExperience","hasClasses","iteratives","iters","xp","ActorSheetPFNPC","_adjustCR","ActorSheetPFNPCLite","ActorSheetPFNPCLoot","isLootSheet","cgilSellValue","inv","showValue","ActorSheetFlags","_getFlags","characterFlags","isCheckbox","isSelect","ScriptEditor","isScriptCall","_promises","canEdit","awaitResult","promise","resolved","_openHelpBrowser","helpBrowser","openUrl","resolvePromises","Widget_CategorizedItemPicker","cat","_onClickCategory","first","scrollIntoView","block","ItemSheetPF","_actionUpdates","_getItemType","itemStatus","_getItemStatus","itemProperties","_getItemProperties","inheritCharges","defaultChargeFormula","isNaturalAttack","owned","showIdentifyDescription","unchainedActionEconomy","auraStrength_name","identify","spellcasting","hasSpellbook","descriptionHTML","descriptionAttributes","isNumber","decimals","fakeName","inputValue","isRange","hardness","isBoolean","isClassFeature","isTemplate","skillIdata","classSkill","weaponCategories","subTypes","equipmentCategories","hasMultipleSlots","hasSubCategory","isPreparedSpell","isAtWill","topDescription","isMythicPath","favouredClassBonuses","isRacialHD","changeGlobals","isValid","isScript","noteTargets","_prepareLinks","list","help","linkedItem","scriptCallCategory","hiddenIcon","titleCase","weaponProperties","typeLabel","itemActionTypes","oldLinks","typedLinks","convertWeightBack","relativeKeys","_onActionEdit","_onActionControl","_onTextAreaDrop","_onBuffControl","_onChangeTargetControl","_onNoteControl","_onNoteTargetControl","_createAttack","_createSpellbook","_onEntrySelector","_onEntryControl","_onLinksDrop","_onLinkControl","_onFilePickerAlt","_onEditChangeScriptContents","_openLinkedItem","_setActionUses","_onScriptCallControl","_onScriptCallEdit","_onScriptCallDrop","setActionUpdate","mouseout","_updateActions","edit","eventData","getDragEventData","getContentLink","targetActionID","prevActions","targetIdx","srcIdx","changeID","scriptEditor","isAction","deleteItem","actionParts","component","ItemActionSheet","part1","noteIndex","targetField","FilePicker","browse","removeAttr","focusout","createAttackFromWeapon","EntrySelector","ItemSheetPF_Container","_tabs","_prepareContents","DEFAULT_TOKEN","_onItemTake","_quickItemActionControl","_setItemUses","_onDrop","_onDropItem","_onDropCurrency","isIdentified","dropTarget","targetId","siblings","siblingId","SortingHelpers","performIntegerSort","updateContainerContents","hasAttackRoll","hasCritDamage","hasNonCritDamage","showMaxChargeFormula","canInputRange","canInputMinRange","canInputDuration","itemEnh","usesSpellPoints","canUseAmmo","parentOwned","hasActivationType","showMaxRangeIncrements","isWeaponAttack","subTargets","conditionalModifierTypes","conditionalCritical","_onEditImage","_onAttackControl","_onDamageControl","_onClickDamageType","_onConditionalControl","_canDragDrop","ItemConditionalModifier","initialData","damagePart","clickedElement","conditionalElement","modifierElement","attackPart","reResult","conditionalIdx","modifierIdx","CheckboxFilter","baseFilter.BaseFilter","booleanOperator","BOOLEAN_OPERATOR","_choiceQuery","_debouncedFilterChoices","configObject","labelKey","innerSet","innerKey","innerValue","hasControls","MIN_SEARCH_CHOICES","hasSearch","prepareBooleanOperator","fieldData","AND","observedValues","flatMap","toggleChoice","activeChoices","testMethod","OR","choiceQuery","choiceKey","SearchFilter","cleanQuery","matchingChoices","choiceSet","NumberRangeFilter","ItemTypeFilter","WeaponTypeFilter","getChoicesFromConfig","WeaponSubtypeFilter","WeaponPropertyFilter","WeaponGroupFilter","EquipmentTypeFilter","EquipmentSubtypeFilter","ItemSlotFilter","ConsumableTypeFilter","consumableTypes","MiscItemTypeFilter","ItemPriceFilter","ItemCasterLevelFilter","PackFilter","usedPacks","orderedPacks","TagFilter","SpellSchoolFilter","SpellMultiSchoolFilter","SpellSubSchoolFilter","SpellDescriptorFilter","SpellLearnedByClassFilter","SpellLearnedByDomainFilter","SpellLearnedBySubdomainFilter","SpellLearnedByBloodlineFilter","SpellLevelFilter","activeLearnedAtFilters","activeLevelChoices","learnedAtChoice","learnedAtLevel","levelChoice","FeatTypeFilter","FeatClassFilter","ClassTypeFilter","classTypes","ClassHitDieFilter","ClassBaseAttackBonusFilter","classBAB","ClassSkillPointsFilter","ClassSavingThrowFilter","classSavingThrows","noneFilterResult","ClassFortitudeFilter","ClassReflexFilter","ClassWillFilter","ClassSubTypeFilter","classSubTypes","ClassParentFilter","ClassMPFilter","ClassCastingStatFilter","classCastingStats","CreatureTypeFilter","creatureTypes","CreatureSubTypeFilter","BuffTypeFilter","CreatureCRFilter","commonFilters.PackFilter","buffFilters.BuffTypeFilter","commonFilters.TagFilter","classFilters.ClassTypeFilter","classFilters.ClassSubTypeFilter","classFilters.ClassParentFilter","classFilters.ClassHitDieFilter","classFilters.ClassMPFilter","classFilters.ClassCastingStatFilter","classFilters.ClassBaseAttackBonusFilter","classFilters.ClassSkillPointsFilter","classFilters.ClassFortitudeFilter","classFilters.ClassReflexFilter","classFilters.ClassWillFilter","creatureFilters.CreatureCRFilter","featFilter.FeatTypeFilter","featFilter.FeatClassFilter","itemFilters.ItemTypeFilter","itemFilters.WeaponTypeFilter","itemFilters.WeaponSubtypeFilter","itemFilters.WeaponPropertyFilter","itemFilters.WeaponGroupFilter","itemFilters.EquipmentTypeFilter","itemFilters.EquipmentSubtypeFilter","itemFilters.ItemSlotFilter","itemFilters.ConsumableTypeFilter","itemFilters.MiscItemTypeFilter","itemFilters.ItemPriceFilter","itemFilters.ItemCasterLevelFilter","equipmentSubtypes","at","raceFilters.CreatureTypeFilter","raceFilters.CreatureSubTypeFilter","spellFilter.SpellSchoolFilter","spellFilter.SpellMultiSchoolFilter","spellFilter.SpellSubSchoolFilter","spellFilter.SpellDescriptorFilter","spellFilter.SpellLearnedByClassFilter","spellFilter.SpellLearnedByDomainFilter","spellFilter.SpellLearnedBySubdomainFilter","spellFilter.SpellLearnedByBloodlineFilter","spellFilter.SpellLevelFilter","typeString","learnedAtData","learnedAtLevels","learnedAtSource","_onClickAction","appOptions","initAmmoUsage","initAttacks","attackType","isPrimaryAttack","clCheck","_callbacks","defaultAttack","attackBonusTotal","hasDamageAbility","isMeleeWeaponAttackAction","isRangedWeaponAttackAction","isAttack","isFeat","getAmmo","_filterAmmo","isDefault","weaponAmmoType","ammoType","_onToggleFlag","_onChangeAttribute","_onSelectChange","_onToggleConditional","_onAmmoSelectClick","_onAmmoControlClick","_onAmmoClick","_unfocusElements","_hideExtraAttacks","_showExtraAttacks","_onAttackSingle","_onAttackFull","translationString","manyshot","setAttackAmmo","listElem","unsetFlag","getFormAttacks","curAmmo","doAttack","entities","regex","encodeCache","encode","exclude","keepEscaped","nextCode","defaultChars","getEncodeCache","ch","fromCharCode","encodeURIComponent","componentChars","encode_1","decodeCache","decode","getDecodeCache","seq","b1","b2","b3","b4","chr","decode_1","Url","protocol","slashes","auth","port","hostname","pathname","protocolPattern","portPattern","simplePathPattern","unwise","autoEscape","nonHostChars","hostEndingChars","hostnamePartPattern","hostnamePartStart","hostlessProtocol","javascript","slashedProtocol","http","https","ftp","gopher","file","slashesDenoteHost","lowerProto","hec","simplePath","proto","atSign","hostEnd","lastIndexOf","host","parseHost","ipv6Hostname","hostparts","newpart","validParts","notHost","bit","qm","urlParse","mdurl","require$$3","regex$3","regex$2","uc_micro","Any","Cc","Cf","regex$1","require$$2","P","Z","require$$4","_hasOwnProperty","isValidEntityCode","fromCodePoint","UNESCAPE_MD_RE","UNESCAPE_ALL_RE","DIGITAL_ENTITY_TEST_RE","HTML_ESCAPE_TEST_RE","HTML_ESCAPE_REPLACE_RE","HTML_REPLACEMENTS","replaceUnsafeChar","REGEXP_ESCAPE_RE","UNICODE_PUNCT_RE","lib","ucmicro","TypeError","isString","_class","unescapeMd","unescapeAll","escaped","entity","replaceEntityPattern","escapeHtml","arrayReplaceAt","newElements","isSpace","isWhiteSpace","isMdAsciiPunct","isPunctChar","escapeRE","normalizeReference","helpers","parseLinkLabel","disableNested","found","marker","prevPos","labelEnd","posMax","oldPos","md","skipToken","parseLinkDestination","lines","parseLinkTitle","default_rules","Renderer","rules","code_inline","env","slf","renderAttrs","code_block","fence","tmpAttrs","tmpToken","langName","langAttrs","attrIndex","attrs","langPrefix","renderInlineAsText","renderToken","hardbreak","xhtmlOut","softbreak","breaks","html_block","html_inline","nextToken","needLf","nesting","renderInline","renderer","Ruler","__rules__","__cache__","__find__","__compile__","chains","altName","chain","opt","before","beforeName","ruleName","after","afterName","ignoreInvalid","enableOnly","getRules","chainName","ruler","NEWLINES_RE","NULL_RE","isLinkClose","RARE_RE","SCOPED_ABBR_TEST_RE","SCOPED_ABBR_RE","SCOPED_ABBR","tm","replaceFn","replace_scoped","inlineTokens","inside_autolink","replace_rare","QUOTE_TEST_RE","QUOTE_RE","replaceAt","process_inlines","thisLevel","lastChar","nextChar","isLastPunctChar","isNextPunctChar","isLastWhiteSpace","isNextWhiteSpace","canOpen","canClose","isSingle","stack","openQuote","closeQuote","OUTER","lastIndex","quotes","markup","meta","attrPush","attrData","attrSet","attrGet","attrJoin","StateCore","inlineMode","state_core","_rules","linkify","currentToken","nodes","lastPos","htmlLinkLevel","fullUrl","urlText","blockTokens","pretest","normalizeLink","validateLink","normalizeLinkText","blkIdx","typographer","smartquotes","text_join","curr","last","Core","process","State","require$$8","parser_core","getLine","bMarks","tShift","eMarks","escapedSplit","isEscaped","skipBulletListMarker","startLine","skipOrderedListMarker","open_tag","close_tag","HTML_TAG_RE","HTML_OPEN_CLOSE_TAG_RE","html_re","block_names","HTML_SEQUENCES","StateBlock","indent","indent_found","sCount","bsCount","blkIndent","lineMax","tight","ddIndent","listIndent","parentType","skipEmptyLines","skipSpaces","skipSpacesBack","skipChars","skipCharsBack","getLines","begin","end","keepLastLF","lineIndent","lineStart","state_block","endLine","silent","lineText","nextLine","columnCount","aligns","tableLines","tbodyLines","oldParentType","terminate","terminatorRules","firstCh","secondCh","params","mem","haveEndMarker","blockquote","adjustTab","lastLineEmpty","oldBMarks","oldBSCount","oldIndent","oldSCount","oldTShift","spaceAfterMarker","isOutdented","oldLineMax","tokenize","cnt","contentStart","indentAfterMarker","isOrdered","itemLines","listLines","listTokIdx","markerCharCode","markerValue","oldListIndent","oldTight","posAfterMarker","prevEmptyEnd","isTerminatingParagraph","markTightParagraphs","reference","_endLine","destEndPos","destEndLineNo","href","references","heading","lheading","paragraph","ParserBlock","hasEmptyLines","maxNesting","outTokens","require$$12","parser_block","isTerminatorChar","SCHEME_RE","ESCAPED","postProcess","delimiters","startDelim","endDelim","loneMarkers","strikethrough","scanned","scanDelims","can_open","can_close","tokens_meta","postProcess$1","isStrong","emphasis","EMAIL_RE","AUTOLINK_RE","DIGITAL_RE","NAMED_RE","processDelimiters","closerIdx","openerIdx","closer","opener","minOpenerIdx","newMinOpenerIdx","isOddMatch","lastJump","openersBottom","headerIdx","lastTokenIdx","jumps","StateInline","pendingLevel","_prev_delimiters","backticks","backticksScanned","linkLevel","pushPending","token_meta","canSplitWord","left_flanking","right_flanking","state_inline","matchAtStart","newline","pmax","ws","ch1","ch2","origStr","escapedStr","backtick","matchStart","matchEnd","openerLength","closerLength","require$$6","require$$7","labelStart","parseReference","autolink","isLetter","lc","isLinkOpen","_rules2","link_pairs","fragments_join","ParserInline","ruler2","require$$15","parser_inline","isFunction","fuzzyLink","fuzzyEmail","fuzzyIP","defaultSchemas","validate","tail","src_auth","src_host_port_strict","src_path","no_http","src_domain","src_domain_root","src_port","src_host_terminator","mailto","src_email_name","src_host_strict","tlds_2ch_src_re","tlds_default","compile","opts","src_Any","src_Cc","src_Z","src_P","src_ZPCc","src_ZCc","text_separators","src_pseudo_letter","src_ip4","src_xn","src_host","tpl_host_fuzzy","tpl_host_no_ip_fuzzy","tpl_host_fuzzy_strict","tpl_host_port_fuzzy_strict","tpl_host_port_no_ip_fuzzy_strict","tpl_host_fuzzy_test","tpl_email_fuzzy","tpl_link_fuzzy","tpl_link_no_ip_fuzzy","__opts__","tlds","__tlds__","untpl","tpl","src_tlds","onCompile","__tlds_replaced__","email_fuzzy","link_fuzzy","link_no_ip_fuzzy","host_fuzzy_test","aliases","schemaError","__compiled__","__schemas__","compiled","isObject","isRegExp","createValidator","slist","schema_test","schema_search","schema_at_start","resetScanCache","__index__","__text_cache__","Match","__last_index__","__schema__","createMatch","LinkifyIt","schemas","isOptionsObj","definition","ml","me","tld_pos","testSchemaAt","keepOld","linkifyIt","maxInt","regexPunycode","regexNonASCII","regexSeparators","errors","overflow","stringFromCharCode","RangeError","mapDomain","encoded","ucs2decode","output","ucs2encode","codePoints","digitToBasic","digit","adapt","numPoints","firstTime","baseMinusTMin","inputLength","bias","oldi","codePoint","baseMinusT","out","basicLength","handledCPCount","handledCPCountPlusOne","qMinusT","toUnicode","toASCII","version","ucs2","ParserCore","require$$5","punycode","zero","rules2","commonmark","BAD_PROTO_RE","GOOD_DATA_RE","RECODE_HOSTNAME_FOR","parsed","er","MarkdownIt","presetName","utils$1","presets","missed","plugin","apply","parseInline","ChangeLogWindow","lastVersion","dontShowAgain","xhr","XMLHttpRequest","onload","status","changelog","_processChangelog","response","send","MD","isFlag","isFlat","_onEntryChange","_submitAndClose","newKeys","isPermalinkSymbol","emitWarning","permalinkClass","permalinkHref","permalinkAttrs","permalinkSymbol","permalinkSpace","permalinkBefore","symbol","renderHref","defaults","renderPermalinkImpl","ariaHidden","placement","safariReaderFix","assistiveText","visuallyHiddenClass","wrapper","getTokensText","slugify","uniqueSlugStartIndex","tabIndex","permalink","renderPermalink","slug","__proto__","legacy","makePermalink","linkInsideHeader","headerLink","linkAfterHeader","HelpBrowserPF","_backwardHistory","_forwardHistory","_currentPage","_md","_initMarkdown","minWidth","minHeight","currentUrl","MarkDownItAnchor","defaultImageRenderRule","pf1HelpImageRenderer","hasHistoryBack","hasHistoryForward","pageContent","getCurrentHistoryObject","contentElement","scrollTop","headerElement","getElementById","emHeight","getComputedStyle","fontSize","offsetTop","backInHistory","forwardInHistory","removeAttribute","defaultRenderer","foundrySrc","getRoute","LinkOptions","linkTypes","LinksApp","getLinkTypes","linkTypesObj","_getLinkTypeCommandOptions","defaultType","convertKeys","convertDistanceBack","isStaticSkill","skillTag","documentType","skillCoreUpdateData","strict","newData","oldSubSkillId","oldSkillId","_openCompendiumEntry","_onCompendiumControls","reportValidity","ExperienceDistributor","bonusXP","characters","getCharacters","npcs","getNPCs","getTotalExperience","toLocaleString","getSplitExperience","addListener","_onClickActor","toggled","actorID","updateDocuments","shouldActorBeToggled","xpString","isPC","ItemDirectoryPF","ItemDirectory","renderUpdateKeys","SidebarTab","Troubleshooter","report","discord","faq","helpmodule","migrateWorld","migrateModules","unlock","_openHelp","migrationButtons","_runMigration","ActiveEffectPF","created","buffItem","secondaryContext","returnVal","isTemporary","statuses","duplicateCombatantInitiativeDialog","combatantId","prevInitiative","duplicateCombatantInitiative","addCombatTrackerContextOptions","CombatPF","Combat","updateTurn","messageOptions","currentId","firstCombatant","rollerName","showInitiativeDialog","getInitiativeRoll","hasNotes","advanceTime","firstOwner","ownership","expireActiveEffects","_expireEffectsOnUpdate","CombatantPF","Combatant","updateResource","resource","_getInitiativeFormula","defaultParts","getLeftRight","SHIFT_KEYS","CTRL_KEYS","registerSystemControls","keybindings","onDown","onUp","controls","_hideTokenTooltip","_hideTokenTooltipGMInfo","keyDown","TokenDocumentPF","_preCreateSetSize","deleteFlags","sizeConf","getTrackedAttributes","getBarAttribute","barName","alternative","detectionModes","sight","baseRange","visionMode","basicMode","DetectionMode","BASIC_MODE_ID","darkvision","_sortDetectionModes","visionDefaults","Canvas","visionModes","vision","fieldName","PRIORITY","BasicActorPF","ActorCharacterPF","tokenUpdate","maxExp","xpData","newExp","resetExp","curExp","minExp","expConfig","expTrack","CHARACTER_EXP_LEVELS","totalXP","ActorNPCPF","getCR","newXP","crTotal","getCRExp","crOffset","CR_EXP_LEVELS","canApply","canApplyCritical","withinAngle","normalizeDegrees","withinRect","point","TemplateLayerPF","TemplateLayer","_onDragLeftStart","interaction","interactionData","PlaceablesLayer","getSnappedPosition","gridPrecision","tool","activeTool","previewData","direction","fillColor","altKey","MeasuredTemplate","angle","objectClass","addChild","draw","_onDragLeftMove","v11","destination","layerDragState","createState","snapToGrid","cellSize","baseDirection","toDegrees","halfAngle","baseDistance","renderFlags","refreshShape","MeasuredTemplatePF","getHighlightedSquares","shape","templateType","gridSizePxBase","gridSizePx","gridSizeUnits","templateDirection","templateAngle","x0","y0","x1","y1","sx","sy","e2","fromAngle","A","B","nr","nc","cx","cy","getCenter","col0","row0","getGridPositionFromPixels","minAngle","maxAngle","offsetMult","dir","gx","gy","getPixelsFromGridPosition","cellCenterX","cellCenterY","rayAngle","maxDistance","center","sizeErrorMargin","GRID_TYPES","GRIDLESS","rayWithinAngle","raySceneLength","highlightSquares","getHighlightLayer","positions","highlightGrid","SQUARE","bc","borderColor","hl","isVisible","highlightGridPosition","border","highlightId","rangeColor","reachColor","SquareHighlight","_squares","addHighlightLayer","addSquare","permanent","destroyHighlightLayer","gridSize","currentHighlight","showAttackReach","tw","th","rangeKey","isReach","minRangeKey","squares","useReachRule","getReachSquares","maxSquareRange","rangeIncrements","squaresExtra","getAttackReach","clearHighlight","renderHighlight","addReachListeners","onMouseEnterReach","onMouseLeaveReach","_getTokenByUuid","addSquareFunction","shouldAddReachSquare","gridDist","tokenSquares","tokenRect","getClosestTokenSquare","lowest","squareRange","wMax","hMax","tl","closestSquare","closestTokenSquare","dist2","reachRuleRange","TokenPF","midUpdate","hasActiveHUD","hud","refreshStatusIcons","disableLowLight","visionFlag","hasTokenVision","_getBarBoost","_getBarUnderline","_drawBar","bar","boost","underline","boostlessMax","boostlessPct","PIXI","rgb2hex","beginFill","lineStyle","drawRoundedRect","posY","TokenQuickActions","quickActionsList","actionHTML","createChargeElement","actionEl","activateElementListeners","htmlparts","recharging","DetectionModeInvisibilityPF","DetectionModeInvisibility","_testPoint","visionSource","_testLOS","_testRange","lightSource","lightSources","los","DetectionModeBlindSensePF","DETECTION_TYPES","walls","_detectionFilter","OutlineOverlayFilter","outlineColor","knockout","wave","ID","_canDetect","DetectionModeBlindSightPF","DetectionModeTremorPF","DetectionModeTremor","MOVE","darkVisionShader","shader","VisionMode","uniforms","brightness","lighting","LIGHTING_VISIBILITY","REQUIRED","darkness","adaptive","attenuation","originalAngle","initialLayer","activeLayer","layer","activate","activatePreviewListeners","handlers","moveTime","pfStyle","_clear","destroyed","destroy","mm","now","getLocalPosition","rc","canResolve","removeChildren","stage","oncontextmenu","onwheel","snap","controlIcon","removeAllListeners","hitArea","Polygon","_terms","isIntermediate","MODIFIERS_REGEXP_STRING","simplify","_prepareRoll","noRoll","sizeDice","sizeRoll","rollOpts","promptDialog","getPrototypeOf","newScriptCallData","getScriptBody","AsyncFunction","newConditionalData","_prepareModifiers","dryRun","newConditionalModifierData","flattenObject","registerHandlebarsHelpers","actionDamage","handleFormula","rd","newformula","handleParts","dmgAbl","dmgAblMod","simplifyMath","semiFinal","registerHelper","typeInfo","dtId","noteObjs","SafeString","origCount","origSides","targetSize","initialSize","_getSizeIndex","skipWarning","d10Arr","larger","smaller","mediumDie","mediumDieMax","sizeDie","d6Index","d8Index","sizeOffset","curSize","baseline","fallback","searchTerm","foundDoc","foundPack","it","searchMutations","mut","coreVersion","compareVersion","renderForEveryone","_state","Document","ScriptCallCategory","ArrayField","ScriptCalls","systemPacks","startMessage","_migrateWorldSettings","migrateActors","migrateItems","migrateScenes","packageType","migrateCompendiums","infoElem","fadeOut","fetch","migrateActorData","migrateItemData","migrateScene","packIds","migrateCompendium","docType","wasLocked","migrate","updateAll","migrateSceneData","tooltipWorldConfig","hideActorName","migrateTokenData","lowLightVision","lowLightVisionMultiplier","lowLightVisionMultiplierBright","customVisionRules","migrateToken","linked","isLinked","_migrateCharacterLevel","_migrateActorEncumbrance","_migrateActorNoteArrays","_migrateActorSpeed","_migrateSpellDivineFocus","_migrateActorConcentration","_migrateActorSpellbookCL","_migrateActorSpellbookSlots","_migrateActorBaseStats","_migrateUnusedActorCreatureType","_migrateActorSpellbookDCFormula","_migrateActorHPAbility","_migrateActorCR","_migrateAttackAbility","_migrateActorDefenseAbility","_migrateActorSpellbookUsage","_migrateActorNullValues","_migrateActorSpellbookDomainSlots","_migrateActorStatures","_migrateActorInitAbility","_migrateActorChangeRevamp","_migrateActorCMBRevamp","_migrateActorConditions","_migrateActorSkillRanks","_migrateCarryBonus","_migrateBuggedValues","_migrateSpellbookUsage","_migrateActorHP","_migrateActorSenses","_migrateActorSkillJournals","_migrateActorSubskillData","_migrateActorUnusedData","_migrateActorDRandER","_d","_migrateItemArrayTypes","_migrateItemSpellUses","_migrateFlagsArrayToObject","_migrateWeaponImprovised","_migrateSpellDescription","_migrateClassDynamics","_migrateClassType","_migrateWeaponCategories","_migrateArmorCategories","_migrateItemSize","_migrateAbilityTypes","_migrateClassLevels","_migrateSavingThrowTypes","_migrateCR","_migrateItemChanges","_migrateEquipmentSize","_migrateTags","_migrateSpellCosts","_migrateLootEquip","_migrateItemLinks","_migrateProficiencies","_migrateItemNotes","_migrateSpellData","_migrateItemChargeCost","_migrateItemWeight","_migrateItemHealth","_migrateContainerPrice","_migrateItemType","_migrateItemLearnedAt","_migrateItemTuples","_migrateEquipmentCategories","_migrateItemUnusedData","itemActionData","migrateItemActionData","subItem","performDeletions","_migrateActionRange","_migrateActionDamageParts","_migrateUnchainedActionEconomy","_migrateActionDamageType","_migrateActionConditionals","_migrateActionEnhOverride","_migrateActionPrimaryAttack","_migrateActionChargeUsage","migrateSceneTokens","migrateSceneActors","ent","updateKey","bflags","dflags","spellbookSlot","baseKey","maxKey","newBase","kList","curFormula","curBase","oldValue","formulaKey","stKeys","changeProp","two","oldType","wdSize","newChanges","newChange","newNotes","autoDeduct","unchainedAction","_index","hiddenLinks","_migrateItemActions","hasOldAction","alreadyHasActions","removeKeys","spellDuration","oldSpellPointCostFormula","paMult","learned","clsId","defaultAction","damageGroupPaths","damageGroupPath","damageGroup","damageTypeData","_Action_ConvertDamageType","subPath","cond","condAlt","subKey","convertToInt","oldSenses","brightSight","reOldJournalFormat","subSkillData","oldDR","oldER","damageTypeString","damageTypeList","tests","damageTest","testString","basePrice","priceUnits","identifiedName","weaponData","migrateActor","migrateItem","globalThis","moduleToObject","_canvas","dice.RollPF","layers","layerClass","_canvas.TemplateLayerPF","_canvas.MeasuredTemplatePF","_canvas.TokenPF","documents.actor.ActorCharacterPF","documents.actor.ActorNPCPF","documents.actor.BasicActorPF","documents.item.ItemAttackPF","documents.item.ItemBuffPF","documents.item.ItemClassPF","documents.item.ItemConsumablePF","documents.item.ItemContainerPF","documents.item.ItemEquipmentPF","documents.item.ItemFeatPF","documents.item.ItemLootPF","documents.item.ItemRacePF","documents.item.ItemSpellPF","documents.item.ItemWeaponPF","documents.TokenDocumentPF","documents.ActiveEffectPF","legacyTransferral","documents.CombatPF","documents.CombatantPF","documents.ChatMessagePF","applications.ItemDirectoryPF","dice.terms.SizeRollTerm","dice.D20RollPF","dice.DamageRoll","Actors","unregisterSheet","registerSheet","applications.actor.ActorSheetPFCharacter","makeDefault","applications.actor.ActorSheetPFNPC","applications.actor.ActorSheetPFNPCLite","applications.actor.ActorSheetPFNPCLoot","applications.actor.ActorSheetPFBasic","Items","applications.item.ItemSheetPF","applications.item.ItemSheetPF_Container","specialStatusEffects","BLIND","LABEL","DETECTION_TYPE","SIGHT","initializeSocket","initializeModules","SpeedProvider","enhancedTerrain","modules","dragRuler","registerSystem","Pf1SpeedProvider","colors","getRanges","baseSpeed","getBaseSpeed","inHeavyArmor","inHeavyLoad","runMultiplier","useElevation","getSetting","speeds","elevation","terrain","terrainFromGrid","environment","burrow","land","registries","registry.DamageTypes","registry.ScriptCalls","registryName","registryClass","toLocalize","toSort","doLocalize","localized","localA","localB","localizeLabels","ttconf","ttwconf","PREVIOUS_MIGRATION_VERSION","migrations.migrateWorld","documents.settings.migrateSystemSettings","initializeBrowsers","changelogVersion","curVersion","SquareGrid","chat.hideRollInfo","chat.hideGMSensitiveInfo","chat.hideInvisibleTargets","chat.addTargetCallbacks","chat.alterTargetDefense","chat.alterAmmoRecovery","handleChatTooltips","documents.item.ItemPF","chatListeners","documents.actor.ActorPF","_canvas.attackReach.addReachListeners","_canvas.lowLightVision.addLowLightVisionToLightConfig","addQuickActions","effectItemId","foundItem","FFD20.tokenSizes","handledChildren","visited","_getChildren","toRemove","itemLinks","otherItemLinks","documents.customRolls","applications.CurrencyTransfer","_directoryDrop","macros.createItemMacro","macros.createActionMacro","macros.createSkillMacro","macros.createSaveMacro","macros.createMiscActorMacro","newHTML","enableCustomVision","tabElem","dmTab","_canvas.lowLightVision.addLowLightVisionToTokenConfig","Settings","chlogButton","helpButton","tshooterButton","applications.ChangeLogWindow","skipPrompt","documents.settings.getSkipActionPrompt","started","applications.ExperienceDistributor","expireFromTokens"],"mappings":"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MACA,KACA,MACA,MACA,MACA,MACA,KACA,KACA,MACA,MACA,MACA,OACA,OACA,OACA,OACA,QACA,QACA,QACA,SACA,UAEFv4E,OAAQ,CACN,EACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,KACA,MACA,MACA,MACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,MACA,MACA,MACA,OACA,OACA,OACA,QACA,SAEFw4E,KAAM,CACJ,EACA,KACA,KACA,IACA,IACA,KACA,KACA,KACA,IACA,KACA,MACA,MACA,KACA,MACA,MACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,OACA,OACA,OACA,2BAqL0B,CAC9B,6BAA8B,EAC9B,cAAc,EACd,kBAAkB,iBAhLU,CAC1B,IACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,MACA,MACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,QACA,QACA,QACA,QACA,QACA,QACA,kCAwEoC,CACtCC,UAAW,IACXC,WAAY,uCACZC,UAAW,iCACXC,OAAQ,iCACRC,cAAe,iCACfC,WAAY,iCACZC,cAAe,4CApyFQ,CACvBvsF,IAAK,mBACLwjE,IAAK,mBACL16B,IAAK,mBACL0jD,IAAK,mBACLC,IAAK,mBACLC,IAAK,mCAMuB,CAC5B1sF,IAAK,wBACLwjE,IAAK,wBACL16B,IAAK,wBACL0jD,IAAK,wBACLC,IAAK,wBACLC,IAAK,gDAqQ+B,CACpCC,QAAS,8BACTC,KAAM,2BACNC,UAAW,gCACXC,MAAO,4BACPC,UAAW,gCACXC,KAAM,2BACNC,SAAU,+BACVC,KAAM,gCACN3sC,OAAQ,6BACR4sC,IAAK,0BACL3lF,MAAO,4BACP4lF,OAAQ,6BACRC,KAAM,2BACNC,QAAS,6DAMkC,CAC3CV,KAAM,iCACNE,MAAO,kCACPC,UAAW,sCACXC,KAAM,iCACNC,SAAU,qCACVC,KAAM,sCACN3sC,OAAQ,mCACR/4C,MAAO,kCACP4lF,OAAQ,m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","x_google_ignoreList":[10,11,12,13,14,15,16,17,56,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,169]}