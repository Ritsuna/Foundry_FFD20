{"version":3,"file":"ffd20.js","sources":["../module/patch-core.mjs","../module/compendium-directory.mjs","../module/chatlog.mjs","../module/utils/internal.mjs","../module/socket.mjs","../module/utils/semver.mjs","../module/documents/macros.mjs","../module/utils/chat.mjs","../module/documents/actor/actor-base.mjs","../module/documents/actor/actor-proxy.mjs","../module/documents/item/item-base.mjs","../module/documents/item/item-proxy.mjs","../module/tours/base-tours.mjs","../module/tours/actor-sheet-tour.mjs","../module/tours.mjs","../module/config.mjs","../module/const.mjs","../module/applications/compendium-browser/filters/base.mjs","../node_modules/fuzzysort/fuzzysort.js","../module/applications/compendium-browser/compendium-browser.mjs","../module/applications/mixins/no-autocomplete.mjs","../module/applications/trait-selector.mjs","../module/applications/mixins/drag-drop.mjs","../module/applications/abstract-list-selector.mjs","../module/applications/damage-resistance-selector.mjs","../module/applications/actor/actor-rest.mjs","../module/applications/point-buy-calculator.mjs","../module/applications/item-picker.mjs","../module/applications/settings/abstract-settings.mjs","../module/dice/roll.mjs","../module/models/fields/formula-field.mjs","../module/applications/settings/experience.mjs","../module/applications/settings/health.mjs","../module/applications/settings/integration.mjs","../module/applications/settings/performance.mjs","../module/documents/settings.mjs","../module/applications/level-up.mjs","../module/applications/currency-transfer.mjs","../module/utils/handlebars/templates.mjs","../module/applications/actor/actor-sheet.mjs","../module/applications/actor/character-sheet.mjs","../module/applications/actor/npc-sheet.mjs","../module/applications/actor/npc-lite-sheet.mjs","../module/applications/actor/npc-loot-sheet.mjs","../module/applications/actor/haunt-sheet.mjs","../module/applications/actor/trap-sheet.mjs","../module/applications/actor/vehicle-sheet.mjs","../module/applications/speed-editor.mjs","../module/applications/categorized-item-picker.mjs","../module/applications/flag-selector.mjs","../module/applications/item/item-sheet.mjs","../module/applications/item/container-sheet.mjs","../module/applications/item/item-create.mjs","../module/applications/component/action-sheet.mjs","../module/applications/compendium-browser/filters/checkbox.mjs","../module/applications/compendium-browser/filters/text.mjs","../module/applications/compendium-browser/filters/number-range.mjs","../module/applications/compendium-browser/filters/item.mjs","../module/applications/compendium-browser/filters/common.mjs","../module/applications/compendium-browser/filters/spell.mjs","../module/applications/compendium-browser/filters/feat.mjs","../module/applications/compendium-browser/filters/class.mjs","../module/applications/compendium-browser/filters/race.mjs","../module/applications/compendium-browser/filters/buff.mjs","../module/applications/compendium-browser/filters/creature.mjs","../module/applications/compendium-browser/buff-browser.mjs","../module/applications/compendium-browser/class-browser.mjs","../module/applications/compendium-browser/creature-browser.mjs","../module/applications/compendium-browser/feat-browser.mjs","../module/applications/compendium-browser/item-browser.mjs","../module/applications/compendium-browser/race-browser.mjs","../module/applications/compendium-browser/spell-browser.mjs","../module/applications/journal/journal-text-sheet.mjs","../module/applications/utils/co-edit.mjs","../module/applications/action-selector.mjs","../module/action-use/chat-attack.mjs","../module/action-use/action-use.mjs","../module/applications/attack-dialog.mjs","../module/applications/change-log.mjs","../module/applications/damage-type-selector.mjs","../module/applications/abstract-document-selector.mjs","../module/applications/item-selector.mjs","../module/applications/help-browser.mjs","../module/applications/script-editor.mjs","../module/applications/senses-selector.mjs","../module/applications/skill-editor.mjs","../module/applications/content-source-editor.mjs","../module/applications/vision-sharing.mjs","../module/applications/experience-distributor.mjs","../module/applications/change-editor.mjs","../module/applications/sidebar/items-directory.mjs","../module/applications/troubleshooter.mjs","../module/applications/actor-selector.mjs","../module/applications/split-stack.mjs","../module/applications/html-editor.mjs","../module/applications/apply-damage.mjs","../module/applications/_module.mjs","../module/applications/entry-selector.mjs","../module/documents/active-effect.mjs","../module/documents/chat-message.mjs","../module/documents/combat.mjs","../module/documents/combatant.mjs","../module/documents/controls.mjs","../module/documents/token.mjs","../module/documents/actor/utils/apply-changes.mjs","../module/documents/actor/utils/spellbook.mjs","../module/documents/actor/components/resource.mjs","../module/documents/actor/actor-pf.mjs","../module/documents/actor/abstract/base-character.mjs","../module/documents/actor/actor-character.mjs","../module/documents/actor/actor-npc.mjs","../module/documents/actor/actor-haunt.mjs","../module/documents/actor/actor-trap.mjs","../module/documents/actor/actor-vehicle.mjs","../module/documents/item/item-pf.mjs","../module/documents/item/item-attack.mjs","../module/documents/item/item-buff.mjs","../module/documents/item/item-class.mjs","../module/documents/item/item-physical.mjs","../module/documents/item/item-consumable.mjs","../module/documents/item/item-container.mjs","../module/documents/item/item-equipment.mjs","../module/documents/item/item-feat.mjs","../module/documents/item/item-loot.mjs","../module/documents/item/item-race.mjs","../module/documents/item/item-spell.mjs","../module/documents/item/item-weapon.mjs","../module/documents/item/item-implant.mjs","../module/models/fields/id-field.mjs","../module/models/abstract/prepared-model.mjs","../module/models/abstract/document-like-model.mjs","../module/models/ae/ae-base.mjs","../module/models/ae/ae-buff.mjs","../module/models/mixins/compacting-mixin.mjs","../module/models/action/damage-part-model.mjs","../module/models/action/extra-attack-model.mjs","../module/models/mixins/replaceable-source.mjs","../module/models/chat/base-message.mjs","../module/models/chat/item-message.mjs","../module/models/chat/action-message.mjs","../module/models/chat/check-message.mjs","../module/models/actor/haunt-model.mjs","../module/models/actor/trap-model.mjs","../module/models/actor/vehicle-model.mjs","../module/chat/text-enrichers.mjs","../module/chat/chat-commands.mjs","../module/canvas/measure.mjs","../module/canvas/attack-reach.mjs","../module/canvas/low-light-vision.mjs","../module/canvas/token.mjs","../module/canvas/detection-modes.mjs","../module/canvas/vision-modes.mjs","../module/canvas/token-hud.mjs","../module/canvas/ability-template.mjs","../module/dice/d20roll.mjs","../module/dice/damage-roll.mjs","../module/dice/terms/function-term.mjs","../module/dice/terms/string-term.mjs","../module/components/action.mjs","../module/components/change.mjs","../module/components/conditionals.mjs","../module/components/script-call.mjs","../module/components/context-note.mjs","../module/utils/handlebars/helpers.mjs","../module/utils/canvas.mjs","../module/utils/dialog.mjs","../module/utils/currency.mjs","../module/utils/formulas.mjs","../module/utils/roll-functions.mjs","../module/utils/initialization.mjs","../module/utils/roll-data.mjs","../module/utils/i18n.mjs","../module/utils/packs.mjs","../module/utils/party.mjs","../module/utils/lib.mjs","../module/registry/base-registry.mjs","../module/registry/damage-types.mjs","../module/registry/materials.mjs","../module/registry/script-call.mjs","../module/registry/conditions.mjs","../module/registry/sources.mjs","../module/migration/migration-category.mjs","../module/migration/migration-state.mjs","../module/applications/migration/migration-issues-dialog.mjs","../module/applications/migration/migration-dialog.mjs","../module/migration/asset-moves.mjs","../module/migration.mjs","../ffd20.mjs","../module/modules.mjs"],"sourcesContent":["// Document link attribute stuffing\n{\n  const origFunc = TextEditor._createContentLink;\n  TextEditor._createContentLink = async function (match, { relativeTo } = {}) {\n    const name = match[4];\n    const a = await origFunc.call(this, match, { relativeTo });\n    if (name?.indexOf(\"::\") > -1) {\n      const args = name.split(\"::\"),\n        label = args.pop();\n      if (args.length) {\n        args.forEach((o) => {\n          let [key, value] = o.split(/(?<!\\\\):/);\n          if (!(key && value)) {\n            value = key;\n            key = \"extra\";\n          }\n          switch (key) {\n            case \"icon\":\n              a.firstChild.className = \"fa-solid fa-\" + value;\n              break;\n            case \"class\":\n              a.classList.add(...value.split(\" \"));\n              break;\n            default:\n              a.setAttribute(\"data-\" + key, value);\n          }\n        });\n        a.lastChild.textContent = label;\n      }\n    }\n    return a;\n  };\n}\n\n// Patch the `fromData` method used by Foundry to allow rolls from builds with a renamed roll class\n// to still be created from JSON for tooltips etc.\n// Introduced in v0.81.1 for Foundry v9.269\n// RollPF2 added with PF1 v11.1 for Foundry v12.331\n{\n  const origFunc = Roll.fromData;\n  Roll.fromData = function (data, ...args) {\n    if ([\"RollPF$1\", \"RollPF2\"].includes(data.class)) data.class = \"RollPF\";\n    return origFunc.call(this, data, ...args);\n  };\n}\n\n/**\n * Patch ImagePopout image share handling function to respect identified status of items\n *\n * Synchronized with Foundry VTT v12.331\n *\n * HACK: This breaks Foundry API by turning it into async function, but since this is a socket handler, that should not matter.\n *\n * @see https://github.com/foundryvtt/foundryvtt/issues/8953\n */\n{\n  const original_handleShareImage = ImagePopout._handleShareImage;\n  ImagePopout._handleShareImage = async function ({ image, title, caption, uuid, showTitle } = {}) {\n    const doc = await fromUuid(uuid);\n    if (doc instanceof Item) {\n      title = doc.name;\n    }\n\n    return original_handleShareImage.call(this, { image, title, caption, uuid, showTitle });\n  };\n}\n\n/**\n * Stop releasing modifiers on HTMLButtonElement. Check again on proper support of popouts. How blur is handled will have to be reevaluated\n *\n * Introduced Foundry VTT v10.291\n * Still needed with v12.331\n */\n{\n  KeyboardManager.prototype._onFocusIn = function (event) {\n    const formElements = [HTMLInputElement, HTMLSelectElement, HTMLTextAreaElement, HTMLOptionElement];\n\n    if (event.target.isContentEditable || formElements.some((cls) => event.target instanceof cls)) {\n      this.releaseKeys();\n    }\n  };\n\n  Object.defineProperty(KeyboardManager.prototype, \"hasFocus\", {\n    get() {\n      // Pulled from https://www.w3schools.com/html/html_form_elements.asp\n      const formElements = [\"input\", \"select\", \"textarea\", \"option\", \"[contenteditable]\"];\n      const selector = formElements.map((el) => `${el}:focus`).join(\", \");\n      return document.querySelectorAll(selector).length > 0;\n    },\n  });\n}\n","const buttons = {\n  spells: { label: \"FFD20.BrowseSpells\" },\n  items: { label: \"FFD20.BrowseItems\" },\n  bestiary: { label: \"FFD20.BrowseBestiary\" },\n  feats: { label: \"FFD20.BrowseFeats\" },\n  classes: { label: \"FFD20.BrowseClasses\" },\n  races: { label: \"FFD20.BrowseRaces\" },\n  buffs: { label: \"FFD20.BrowseBuffs\", wide: true },\n};\n\n/**\n * @param {Event} event - Triggering event\n */\nfunction compendiumButtonClick(event) {\n  event.preventDefault();\n  const type = event.target.dataset.category;\n  ffd20.applications.compendiums[type]._render(true, { focus: true });\n}\n\n/**\n * Render compendium browser buttons.\n *\n * @param {CompendiumDirectory} app\n * @param {HTMLElement|JQuery} html\n * @param {object} options\n */\nHooks.on(\"renderCompendiumDirectory\", async (app, html) => {\n  if (html instanceof jQuery) html = html[0]; // v12/v13 cross compatibility\n\n  let element;\n  if (game.release.generation >= 13) {\n    element = document.createElement(\"section\");\n    html.append(element);\n  } else {\n    element = html.querySelector(\"footer.directory-footer\");\n  }\n  element.classList.add(\"ffd20\", \"action-buttons\");\n\n  for (const [category, info] of Object.entries(buttons)) {\n    const button = document.createElement(\"button\");\n    button.type = \"button\";\n    button.dataset.category = category;\n    button.classList.add(\"compendium\", category);\n    button.innerText = game.i18n.localize(info.label);\n    if (info.wide) button.classList.add(\"colspan-2\");\n    element.append(button);\n    button.addEventListener(\"click\", compendiumButtonClick);\n  }\n});\n\n// Add compendium sidebar context options\nHooks.on(\"getCompendiumDirectoryEntryContext\", (html, entryOptions) => {\n  // Add option to enable & disable pack\n  entryOptions.unshift(\n    {\n      name: game.i18n.localize(\"FFD20.CompendiumBrowser.HidePack\"),\n      icon: '<i class=\"fa-solid fa-low-vision\"></i>',\n      condition: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        return pack.config.ffd20?.disabled !== true;\n      },\n      callback: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        pack.configure({ ffd20: { disabled: true } });\n      },\n    },\n    {\n      name: game.i18n.localize(\"FFD20.CompendiumBrowser.ShowPack\"),\n      icon: '<i class=\"fa-solid fa-eye\"></i>',\n      condition: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        return pack.config.ffd20?.disabled === true;\n      },\n      callback: ([li]) => {\n        const pack = game.packs.get(li.dataset.pack);\n        pack.configure({ ffd20: { disabled: false } });\n      },\n    }\n  );\n});\n","const getMessage = (html) => game.messages.get(html.dataset.messageId);\nconst isOwnedSpellCard = (msg) => {\n  const item = msg.itemSource;\n  return item && item.type === \"spell\" && item.isOwner && !!item.actor;\n};\n\n/**\n * @param _\n * @param {object[]} entries - Context menu entries\n */\nfunction spellCardContextMenu(_, entries) {\n  entries.unshift(\n    {\n      name: \"FFD20.Chat.FocusReference\",\n      id: \"pf1-focus-reference\", // made up ID field so modules can recognize this\n      icon: '<i class=\"fa-solid fa-magnifying-glass context-icon ffd20 focus-reference\"></i>',\n      condition: ([html]) => fromUuidSync(getMessage(html)?.system.reference) instanceof ChatMessage,\n      callback: ([html]) => {\n        /** @type {ChatMessage} */\n        const msg = fromUuidSync(getMessage(html).system.reference);\n        /** @type {HTMLElement} */\n        const log = html.closest(\".chat-message[data-message-id]\").parentElement;\n        log.querySelector(`.chat-message[data-message-id='${msg.id}']`).scrollIntoView({ block: \"start\" });\n      },\n    },\n    {\n      name: \"FFD20.ConcentrationCheck\",\n      id: \"pf1-roll-concentration\",\n      icon: '<i class=\"fa-solid fa-brain context-icon ffd20 concentration\"></i>',\n      condition: ([html]) => isOwnedSpellCard(getMessage(html)),\n      callback: ([html]) => {\n        const msg = getMessage(html);\n        const item = msg.itemSource;\n        const actor = item?.actor;\n        actor.rollConcentration(item.system.spellbook, { messageId: msg.id, reference: msg.uuid });\n      },\n    },\n    {\n      name: \"FFD20.CasterLevelCheck\",\n      id: \"pf1-roll-caster-level\",\n      icon: '<i class=\"fa-solid fa-wand-magic-sparkles context-icon ffd20 caster-level\"></i>',\n      condition: ([html]) => isOwnedSpellCard(getMessage(html)),\n      callback: ([html]) => {\n        const msg = getMessage(html);\n        const item = msg.itemSource;\n        const actor = item?.actor;\n        actor.rollCL(item.system.spellbook, { messageId: msg.id, reference: msg.uuid });\n      },\n    }\n    // TODO: Roll ASF option\n  );\n}\n\nHooks.on(\"getChatLogEntryContext\", spellCardContextMenu);\n","/**\n * Adjusts a string to a number, allowing relative adjustments.\n *\n * @internal\n * @param {number} initialValue - The initial number to use for relative operations.\n * @param {string} cmdStr - The exact string inputted by the user.\n * @param {number} [maxValue=null] - The maximum allowed value for this variable.\n * @param {number} [clearValue=null] - What to change the variable to if the user simply erased the value.\n * @returns {number} The resulting new value.\n */\nexport const adjustNumberByStringCommand = (initialValue, cmdStr, maxValue = null, clearValue = null) => {\n  let result = initialValue;\n  const re = cmdStr.match(/(?<abs>=)?(?<op>[+-]+)?(?<value>\\d+)/);\n  if (re) {\n    const { op: operator, abs, value: rawValue } = re.groups;\n    const isAbsolute = abs == \"=\" || [\"--\", \"++\"].includes(operator) || (!abs && !operator);\n    const isNegative = [\"-\", \"--\"].includes(operator);\n    let value = parseInt(rawValue);\n    if (isNegative) value = -value;\n    result = isAbsolute ? value : initialValue + value;\n  } else if (cmdStr === \"\" && clearValue !== null) {\n    result = clearValue;\n  } else {\n    result = parseFloat(cmdStr || \"0\");\n  }\n\n  if (Number.isFinite(maxValue)) result = Math.min(result, maxValue);\n\n  if (Number.isNaN(result)) {\n    console.warn(\"Input resulted in NaN\", { initial: initialValue, command: cmdStr });\n    result = initialValue;\n  }\n\n  return result;\n};\n\n/**\n * Determine if buff target or buff target category is valid for the defined actor and item.\n *\n * @internal\n * @param {object} data - Buff target or category data\n * @param {object} options - Additional options\n * @param {Actor} [options.actor] - Actor to test\n * @param {Item} [options.item] - Item to test\n * @returns {{actor:boolean,item:boolean,valid:boolean}} - Validity statement\n */\nexport function isValidChangeTarget(data, { actor, item } = {}) {\n  const { filters } = data;\n  if (!filters) return { actor: true, item: true, valid: true };\n\n  let ar = true;\n  if (filters.actor && actor) {\n    const { include, exclude, fn } = filters.actor;\n    if (exclude && exclude.includes(actor.type)) ar = false;\n    else if (include && !include.includes(actor.type)) ar = false;\n    else if (typeof fn === \"function\") ar = fn(data, { actor, item });\n  }\n\n  let ir = true;\n  if (filters.item && item) {\n    const { include, exclude, fn } = filters.item;\n    if (exclude && exclude.includes(item.type)) ir = false;\n    else if (include && !include.includes(item.type)) ir = false;\n    else if (typeof fn === \"function\") ir = fn(data, { actor, item });\n  }\n\n  return {\n    actor: actor ? ar : undefined,\n    item: item ? ir : undefined,\n    valid: ar && ir,\n  };\n}\n\n/**\n * @typedef {object} BuffTargetItem\n * @property {string} [label] - The buff target's label.\n * @property {string} category - The buff target's category.\n * @property {string} [icon] - The URL to an icon.\n */\n/**\n * Assembles an array of all possible buff targets.\n *\n * @internal\n * @param {\"buffs\"|\"contextNotes\"} type - Type of targets to fetch\n * @param {object} context - Additional context\n * @param {Actor} [context.actor] - Actor for which to specifically get buff targets.\n * @param {Item} [context.item] - Item on which this change is on.\n * @returns {Record<string, BuffTargetItem>} The resulting array of buff targets.\n */\nexport function getBuffTargets(type, { actor, item } = {}) {\n  const buffTargets = foundry.utils.deepClone(\n    {\n      buffs: ffd20.config.buffTargets,\n      contextNotes: ffd20.config.contextNoteTargets,\n    }[type]\n  );\n\n  // Append individual skills to buff targets\n  const allowSkills = isValidChangeTarget(ffd20.config.buffTargetCategories.skills, { actor, item }).valid;\n\n  if (actor) {\n    const skillTargets = actor._skillTargets ?? [];\n    for (const s of skillTargets) {\n      const skillId = s.split(\".\").slice(1).join(\".\");\n      if (skillId.startsWith(\"~\")) continue; // Skip secondary targets that affect only the parent skill\n      const skill = actor.getSkillInfo(skillId);\n      buffTargets[s] = { label: skill.fullName, category: \"skill\", valid: allowSkills };\n    }\n  } else {\n    for (const [key, label] of Object.entries(ffd20.config.skills)) {\n      buffTargets[`skill.${key}`] = { label, category: \"skill\", valid: allowSkills };\n    }\n  }\n\n  // Append spell targets\n  const allowSpells = isValidChangeTarget(ffd20.config.buffTargetCategories.spell, { actor, item }).valid;\n\n  const books = actor?.system.attributes?.spells?.spellbooks ?? {\n    primary: { label: game.i18n.localize(\"FFD20.SpellBookPrimary\") },\n    secondary: { label: game.i18n.localize(\"FFD20.SpellBookSecondary\") },\n    tertiary: { label: game.i18n.localize(\"FFD20.SpellBookTertiary\") },\n    quaternary: { label: game.i18n.localize(\"FFD20.SpellBookQuaternary\") },\n    spelllike: { label: game.i18n.localize(\"FFD20.SpellBookSpelllike\") },\n  };\n\n  // Get actor specific spell targets\n  const spellTargets = actor?._spellbookTargets ?? [];\n\n  // Add spell school DCs and CLs\n  for (const schoolId of Object.keys(ffd20.config.spellSchools)) {\n    spellTargets.push(`dc.school.${schoolId}`, `cl.school.${schoolId}`);\n  }\n\n  for (const s of spellTargets) {\n    const re = /^(?<key>\\w+)(?:\\.(?<category>\\w+))?\\.(?<subKey>\\w+)$/.exec(s);\n    if (!re) continue;\n    const { key, category, subKey } = re.groups;\n\n    let subLabel;\n    if (category === \"school\") subLabel = ffd20.config.spellSchools[subKey];\n    else subLabel = books[subKey]?.label || subKey;\n\n    const fullKey = category ? `${key}.${category}` : key;\n    const mainLabel = game.i18n.localize(\n      {\n        \"dc.school\": \"FFD20.DC\",\n        concn: \"FFD20.Concentration\",\n        \"cl.book\": \"FFD20.CasterLevel\",\n        \"cl.school\": \"FFD20.CasterLevelAbbr\",\n      }[fullKey]\n    );\n\n    buffTargets[s] = {\n      label: `${mainLabel} (${subLabel})`,\n      category: \"spell\",\n      valid: allowSpells,\n    };\n  }\n\n  return buffTargets;\n}\n\n/**\n * @typedef {object} BuffTargetCategory\n * @property {string} label - The category's label.\n */\n/**\n * Assembles an array of buff targets and their categories, ready to be inserted into a Widget_CategorizedItemPicker.\n *\n * @internal\n * @param {\"buffs\"|\"contextNotes\"} type - Type of targets to retrieve\n * @param {object} context - Additional context\n * @param {Actor} [context.actor] - Actor for which to specifically get buff targets.\n * @param {Item} [context.item] - Item on which this change is on.\n * @returns {Widget_CategorizedItemPicker~Category[]}\n */\nexport function getBuffTargetDictionary(type = \"buffs\", { actor, item } = {}) {\n  const buffTargets = getBuffTargets(type, { actor, item });\n\n  // Assemble initial categories and items\n  const targetCategories = foundry.utils.deepClone(\n    {\n      buffs: ffd20.config.buffTargetCategories,\n      contextNotes: ffd20.config.contextNoteCategories,\n    }[type]\n  );\n\n  const categories = Object.values(\n    Object.entries(buffTargets).reduce((cur, [key, { label, category, icon, ...options }]) => {\n      if (!key.startsWith(\"~\")) {\n        cur[category] ??= {\n          key: category,\n          label: targetCategories[category].label,\n          items: [],\n          validity: isValidChangeTarget(targetCategories[category], { actor, item }),\n        };\n\n        cur[category].items.push({\n          key,\n          label,\n          icon,\n          validity: isValidChangeTarget({ key, label, category, icon, ...options }, { actor, item }),\n        });\n      }\n      return cur;\n    }, {})\n  );\n\n  ffd20.utils.naturalSort(categories, \"label\");\n\n  // Return result\n  return categories;\n}\n\n/**\n * A locale-safe insertion sort of an Array of Objects, not in place. Ignores punctuation and capitalization.\n * `name` properties in objects will be lowercased.\n *\n * @internal\n * @template T\n * @param {Array.<T & {name: string}>} inputArr - Array to be sorted. Each element must have a name property set\n * @returns {T[]} - New sorted Array\n */\nexport const sortArrayByName = (inputArr) => {\n  inputArr = foundry.utils.deepClone(inputArr);\n  for (const elem of inputArr) {\n    elem.name = elem.name.toLocaleLowerCase();\n  }\n  return ffd20.utils.naturalSort(inputArr, \"name\", { numeric: true, ignorePunctuation: true });\n};\n\n/**\n * Variant of TextEditor._createInlineRoll for creating unrolled inline rolls.\n *\n * Synchronized with Foundry VTT v12.331\n *\n * {@inheritDoc TextEditor._createInlineRoll}\n *\n * @internal\n * @experimental\n * @param {string[]} match - RegExp match\n * @param {object} rollData - Roll data\n * @param {object} _options - Parser options\n */\nexport function createInlineFormula(match, rollData, _options) {\n  let [command, formula, closing, label] = match.slice(1, 5);\n\n  if (command) return TextEditor._createInlineRoll(match, rollData);\n\n  // Handle the possibility of the roll formula ending with a closing bracket\n  if (closing.length === 3) formula += \"]\";\n\n  const rollCls = Roll.defaultImplementation;\n\n  // Extract components of the matched command\n  const resolvedFormula = rollCls.replaceFormulaData(formula.trim() || \"0\", rollData || {});\n\n  let pLabel;\n  if (!label) {\n    /** @type {ffd20.dice.RollPF} */\n    const roll = new rollCls(resolvedFormula);\n    if (roll.isDeterministic) {\n      roll.evaluateSync();\n      pLabel = roll.total;\n    } else {\n      pLabel = ffd20.utils.formula.simplify(resolvedFormula);\n    }\n  }\n\n  // Construct the roll element\n  const a = document.createElement(\"a\");\n  a.classList.add(\"inline-preroll\", \"inline-formula\");\n  a.dataset.formula = resolvedFormula;\n  a.dataset.tooltip = formula;\n  a.innerHTML = `<i class=\"fa-solid fa-dice-d20\"></i>${label || pLabel || resolvedFormula}`;\n\n  return a;\n}\n\n/**\n * Recursively transforms an ES module to a regular, writable object.\n *\n * @internal\n * @template T\n * @param {T} module - The ES module to transform.\n * @returns {T} The transformed module.\n */\nexport function moduleToObject(module) {\n  const result = {};\n  for (const key in module) {\n    if (Object.prototype.toString.call(module[key]) === \"[object Module]\") {\n      result[key] = moduleToObject(module[key]);\n    } else {\n      result[key] = module[key];\n    }\n  }\n  return result;\n}\n\n/**\n * Set default scene scaling and default template scaling in scenes.\n *\n * `imperial` sets scaling to 5 ft, `metric` sets scaling to 1.5 m\n *\n * @internal\n * @param {UnitSystem | undefined} [system] System of units. Pull current setting if undefined.\n */\nexport function setDefaultSceneScaling(system) {\n  system ??= ffd20.utils.getDistanceSystem();\n\n  let scaling, units;\n  if (system == \"metric\") {\n    units = \"m\";\n    scaling = 1.5;\n  } else {\n    units = \"ft\";\n    scaling = 5;\n  }\n\n  game.system.grid.units = units;\n  game.system.grid.distance = scaling;\n  CONFIG.MeasuredTemplate.defaults.width = scaling;\n}\n\n/**\n * Turns dictionaries with numbered keys into arrays.\n *\n * @internal\n * @param {object} sourceObj The source object which contains the full array in the same path as targetObj.\n * @param {object} targetObj The target object to alter. The array doesn't have to be immediately in this object.\n * @param {string} keepPath A path to the array to keep, separated with dots. e.g. \"system.damageParts\".\n */\nexport function keepUpdateArray(sourceObj, targetObj, keepPath) {\n  const newValue = foundry.utils.getProperty(targetObj, keepPath);\n  if (newValue == null) return;\n  if (Array.isArray(newValue)) return;\n\n  const newArray = foundry.utils.deepClone(foundry.utils.getProperty(sourceObj, keepPath) || []);\n\n  for (const [key, value] of Object.entries(newValue)) {\n    if (foundry.utils.getType(value) === \"Object\") {\n      const subData = foundry.utils.expandObject(value);\n      newArray[key] = foundry.utils.mergeObject(newArray[key], subData);\n    } else {\n      newArray[key] = value;\n    }\n  }\n\n  foundry.utils.setProperty(targetObj, keepPath, newArray);\n}\n\n/**\n * Resolve UUID by fastest means possible\n *\n * This is partial implementation to sidestep fromUuidSync() not supporting items embedded in compendium actors that you have document for.\n *\n * @remarks\n * - Does not support retrieval of other than Item documents\n * - May or may not return an actual document.\n *\n * @internal\n * @param {string} uuid - UUID\n * @param {Actor} [parent] - Parent actor\n * @returns {object|Item}\n */\nexport function fromUuid(uuid, parent) {\n  if (!parent?.pack) return fromUuidSync(uuid, { relative: parent });\n  const result = foundry.utils.parseUuid(uuid, { relative: parent });\n  if (result.embedded.length) {\n    const [type, itemId] = result.embedded;\n    if (type === \"Item\") return parent.items.get(itemId);\n    throw new Error(`Unsupported embedded document type \"${type}\" for UUID: ${uuid}`);\n  }\n  return fromUuidSync(uuid, { relative: parent });\n}\n\n/**\n * Transform UUID into its long form\n *\n * Converts relative UUIDs to full and old format UUIDs to current format.\n *\n * @param {string} uuid - UUID\n * @param {Actor|Item} [parent] - Parent document\n * @returns {string} - Long for UUID\n */\nexport function uniformUuid(uuid, parent) {\n  return foundry.utils.parseUuid(uuid, { relative: parent }).uuid;\n}\n\n/**\n * Return map of template ID to label.\n *\n * @internal\n * @returns {Record<string,string>}\n */\nexport function getTemplateTypes() {\n  if (game.release.generation >= 13)\n    return Object.fromEntries(\n      Object.values(CONST.MEASURED_TEMPLATE_TYPES).map((id) => [id, game.i18n.localize(`TEMPLATE.TYPES.${id}`)])\n    );\n  else return CONFIG.MeasuredTemplate.types;\n}\n","export function initializeSocket() {\n  game.socket.on(\"system.ffd20\", runSocketFunction);\n}\n\n/**\n * Handle socket message\n *\n * @param {object} msg - Message data\n * @param {string} senderId - User ID\n */\nasync function runSocketFunction(msg, senderId) {\n  const isFirstGM = game.users.activeGM?.isSelf;\n  const sender = game.users.get(senderId);\n  try {\n    switch (msg.eventType) {\n      case \"currencyTransfer\": {\n        if (!isFirstGM) return;\n        let source = await fromUuid(msg.data.sourceActor);\n        let dest = await fromUuid(msg.data.destActor);\n\n        if (msg.data.sourceContainer) source = source.items.get(msg.data.sourceContainer);\n        if (msg.data.destContainer) dest = dest.items.get(msg.data.destContainer);\n        const amount = msg.data.amount;\n\n        ffd20.applications.CurrencyTransfer.transfer(source, dest, amount, msg.data.sourceAlt, msg.data.destAlt, false);\n        break;\n      }\n      case \"alterChatTargetAttribute\":\n        if (isFirstGM) alterChatTargetAttribute(msg);\n        break;\n      case \"giveItem\": {\n        if (!isFirstGM) return;\n        const item = await fromUuid(msg.item);\n        const sourceActor = item.actor;\n        if (!sourceActor.testUserPermission(sender, \"OWNER\")) return;\n        const targetActor = await fromUuid(msg.targetActor);\n        const itemData = item.toObject();\n        const newItem = await Item.implementation.create(itemData, { parent: targetActor });\n        if (newItem) {\n          await sourceActor.deleteEmbeddedDocuments(\"Item\", [item.id]);\n        }\n        break;\n      }\n      case \"refreshActorSheets\":\n        if (sender.hasPermission(CONST.USER_PERMISSIONS.SETTINGS_MODIFY)) {\n          ffd20.utils.refreshActors({ renderOnly: true });\n        }\n        break;\n    }\n  } catch (err) {\n    console.log(\"FFD20 | Socket Error:\", err);\n  }\n}\n\nexport function alterChatTargetAttribute(args) {\n  const message = game.messages.get(args.message);\n  const contentHTML = $(message.content);\n\n  // Alter saving throw\n  if (args.save != null) {\n    const targetElem = contentHTML.find(\n      `div.attack-targets .target[data-uuid=\"${args.targetUuid}\"] .saving-throws .${args.save}`\n    );\n    const valueElem = targetElem.find(\".value\");\n    valueElem.html(`${args.value}`);\n\n    // Add classes based off extra data\n    if (args.isFailure) valueElem.addClass(\"failure\");\n    else valueElem.removeClass(\"failure\");\n    if (args.isSuccess) valueElem.addClass(\"success\");\n    else valueElem.removeClass(\"success\");\n\n    return message.update({\n      content: contentHTML.prop(\"outerHTML\"),\n    });\n  }\n}\n","export class SemanticVersion {\n  static re = /^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?)?$/\n\n  constructor() {\n    this.fversion = 0;\n    this.major = 0;\n    this.minor = 0;\n    this.patch = 0;\n    this.preRelease = \"\";\n    this.buildMetaData = \"\";\n  }\n\n  static fromString(str) {\n    if (str.match(this.re)) {\n      const result = new this();\n      result.fversion = parseInt(RegExp.$1);\n      result.major = parseInt(RegExp.$2);\n      result.minor = parseInt(RegExp.$3);\n      result.patch = parseInt(RegExp.$4 || 0);\n      result.preRelease = RegExp.$5 || \"\";\n      result.buildMetaData = RegExp.$6 || \"\";\n      return result;\n    }\n    return null;\n  }\n\n  toString() {\n    return `${this.fversion}.${this.major}.${this.minor}.${this.patch}`;\n  }\n\n  isHigherThan(otherVersion) {\n    if (this.fversion > otherVersion.fversion) return true;\n    if (this.major > otherVersion.major) return true;\n    if (this.major === otherVersion.major && this.minor > otherVersion.minor) return true;\n    if (this.major === otherVersion.major\n      && this.minor === otherVersion.minor\n      && this.patch > otherVersion.patch) return true;\n    return false;\n  }\n\n  isLowerThan(otherVersion) {\n    if (this.fversion < otherVersion.fversion) return true;\n    if (this.major < otherVersion.major) return true;\n    if (this.major === otherVersion.major && this.minor < otherVersion.minor) return true;\n    if (this.major === otherVersion.major\n      && this.minor === otherVersion.minor\n      && this.patch < otherVersion.patch) return true;\n    return false;\n  }\n\n  isSame(otherVersion) {\n    return this.fversion == otherVersion.fversion && this.major == otherVersion.major && this.minor == otherVersion.minor && this.patch == otherVersion.patch;\n  }\n}\n","/**\n * Finds old macro with same name and command that user can execute and see.\n *\n * @param {string} name - Macro name\n * @param {string} command - Macro command\n * @returns {Macro|undefined} - Old macro\n */\nfunction findOldMacro(name, command) {\n  return game.macros.find((m) => m.name === name && m.command === command && m.canExecute && m.visible && m.isAuthor);\n}\n\n/**\n * Various functions dealing with the creation and usage of macros.\n *\n * @module macros\n */\n\n/**\n * Create a Macro from an Item drop, or get an existing one.\n *\n * @param {object} uuid - UUID\n * @param {number} slot The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createItemMacro = async (uuid, slot) => {\n  const item = fromUuidSync(uuid);\n  const command = `fromUuidSync(\"${uuid}\").use();`;\n  let macro = findOldMacro(item.name, command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name: item.name,\n        type: \"script\",\n        img: item.img,\n        command,\n        flags: { \"ffd20.itemMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create action use macro from dropped action.\n *\n * @param {string} actionId Action ID\n * @param {string} uuid UUID to parent item\n * @param {number} slot Hotbar slot to assign to\n * @param _slot\n * @returns {Promise<User>} The updated User\n */\nexport const createActionMacro = async (uuid, slot, _slot) => {\n  /** @type {ffd20.components.ItemAction} */\n  let action;\n  // @deprecated\n  if (typeof _slot === \"number\") {\n    foundry.utils.logCompatibilityWarning(\n      \"ffd20.documents.macros.createActionMacro() parameters have changed to (uuid, slot).\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n    const item = fromUuidSync(slot);\n    action = item?.actions.get(uuid);\n    uuid = action.uuid;\n    slot = _slot;\n  } else {\n    action = fromUuidSync(uuid);\n  }\n\n  if (!action) return void ui.notifications.error(game.i18n.format(\"FFD20.Error.UUIDNotFound\", { uuid }));\n\n  /** @type {ItemPF} */\n  const item = action.parent;\n\n  const command = `fromUuidSync(\"${uuid}\")\\n\\t.use();`;\n\n  const name = `${action.name} (${item.name})`;\n\n  let macro = findOldMacro(name, command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name,\n        type: \"script\",\n        img: action.img,\n        command,\n        flags: { ffd20: { actionMacro: { uuid: action.uuid } } },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro from skill data to roll an actor's skill, or get an existing one.\n *\n * @param {string} skillId - The skill's identifier\n * @param {string} uuid - The actor's UUID\n * @param {number} slot - The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createSkillMacro = async (skillId, uuid, slot) => {\n  const actor = fromUuidSync(uuid);\n  if (!actor) return;\n\n  const skillInfo = actor.getSkillInfo(skillId);\n  const command = `fromUuidSync(\"${actor.uuid}\")\\n\\t.rollSkill(\"${skillId}\");`;\n  const name = game.i18n.format(\"FFD20.RollSkillMacroName\", { actor: actor.name, skill: skillInfo.fullName });\n  let macro = findOldMacro(name, command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name,\n        type: \"script\",\n        img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n        command,\n        flags: { \"ffd20.skillMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro from save data to roll an actor's save, or get an existing one.\n *\n * @param {string} saveId - The save's identifier\n * @param {string} uuid - The actor's UUID\n * @param {number} slot - The hotbar slot to use\n * @returns {Promise<User>} The updated User\n */\nexport const createSaveMacro = async (saveId, uuid, slot) => {\n  const actor = fromUuidSync(uuid);\n  if (!actor) return;\n\n  const saveName = game.i18n.localize(\"FFD20.SavingThrow\" + saveId.capitalize());\n\n  const command = `fromUuidSync(\"${actor.uuid}\")\\n\\t.rollSavingThrow(\"${saveId}\");`;\n  const name = game.i18n.format(\"FFD20.RollSaveMacroName\", { actor: actor.name, type: saveName });\n  let macro = findOldMacro(name, command);\n  if (!macro) {\n    macro = await Macro.create(\n      {\n        name,\n        type: \"script\",\n        img: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n        command,\n        flags: { \"ffd20.saveMacro\": true },\n      },\n      { displaySheet: false }\n    );\n  }\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n\n/**\n * Create a Macro to roll one of various checks for an actor\n *\n * @param {string} type The type of macro to create\n * @param {string} uuid The actor's UUID\n * @param {number} slot The hotbar slot to use\n * @param {object} [data] Additional context data\n * @returns {Promise<User|void>} The updated User, if an update is triggered\n */\nexport const createMiscActorMacro = async (type, uuid, slot, data) => {\n  const actor = fromUuidSync(uuid);\n  if (!actor) return;\n\n  const getBookLabel = (bookId) => actor.system.attributes?.spells?.spellbooks?.[bookId]?.label;\n\n  let name,\n    img,\n    command = `fromUuidSync(\"${actor.uuid}\")\\n\\t`;\n  switch (type) {\n    case \"defenses\":\n      command += `.displayDefenseCard();`;\n      name = game.i18n.format(\"FFD20.DisplayDefensesMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/items/armor/shield-light-metal.png\";\n      break;\n    case \"cmb\":\n      command += `.rollAttack({maneuver:true});`;\n      name = game.i18n.format(\"FFD20.RollCMBMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/feats/improved-grapple.jpg\";\n      break;\n    case \"cl\": {\n      const { bookId } = data;\n      command += `.rollCL(\"${bookId}\");`;\n      name = game.i18n.format(\"FFD20.RollCLMacroName\", { actor: actor.name, book: getBookLabel(bookId) });\n      img = \"systems/ffd20/icons/spells/wind-grasp-eerie-3.jpg\";\n      break;\n    }\n    case \"concentration\": {\n      const { bookId } = data;\n      command += `.rollConcentration(\"${bookId}\");`;\n      name = game.i18n.format(\"FFD20.RollConcentrationMacroName\", { actor: actor.name, book: getBookLabel(bookId) });\n      img = \"systems/ffd20/icons/skills/light_01.jpg\";\n      break;\n    }\n    case \"bab\":\n      command += `.rollBAB();`;\n      name = game.i18n.format(\"FFD20.RollBABMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/skills/yellow_08.jpg\";\n      break;\n    case \"initiative\":\n      command += \".rollInitiative({ createCombatants: true });\";\n      name = game.i18n.format(\"FFD20.RollInitiativeMacroName\", { actor: actor.name });\n      img = \"systems/ffd20/icons/skills/weapon_41.jpg\";\n      break;\n    case \"attack\": {\n      const { attack } = data;\n      const isMelee = attack === \"melee\";\n      command += `.rollAttack({ ranged: ${isMelee ? \"false\" : \"true\"}});`;\n      name = game.i18n.format(isMelee ? \"FFD20.RollMeleeMacroName\" : \"FFD20.RollRangedMacroName\", { actor: actor.name });\n      img = isMelee ? \"systems/ffd20/icons/skills/weapon_23.jpg\" : \"systems/ffd20/icons/skills/arrow_07.jpg\";\n      break;\n    }\n    case \"abilityScore\": {\n      const { ability } = data;\n      command += `.rollAbilityTest(\"${ability}\");`;\n      name = game.i18n.format(\"FFD20.RollAbilityMacroName\", {\n        actor: actor.name,\n        ability: ffd20.config.abilities[ability],\n      });\n      img = \"systems/ffd20/icons/skills/blue_35.jpg\";\n      break;\n    }\n  }\n\n  if (!name) return;\n\n  let macro = findOldMacro(name, command);\n  macro ??= await Macro.create(\n    {\n      name,\n      type: \"script\",\n      img,\n      command,\n      flags: { ffd20: { type, actor: uuid } },\n    },\n    { displaySheet: false }\n  );\n\n  return game.user.assignHotbarMacro(macro, slot);\n};\n","/**\n * @param {ChatMessage} cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n */\nexport function hideRollInfo(cm, jq) {\n  const whisper = cm.whisper || [];\n  const isBlind = whisper.length && cm.blind;\n  const isVisible = whisper.length ? whisper.includes(game.user.id) || (cm.isAuthor && !isBlind) : true;\n  if (!isVisible) {\n    jq.find(\".dice-formula\").text(\"???\");\n    jq.find(\".dice-total\").text(\"?\");\n    jq.find(\".dice\").text(\"\");\n    jq.find(\".success\").removeClass(\"success\");\n    jq.find(\".failure\").removeClass(\"failure\");\n  }\n}\n\n/**\n * @deprecated\n * @typedef {object} ChatMessagePFIdentifiedInfo\n * @property {boolean} identified - True if item was identified when rolled.\n * @property {string} name - Name of the identified item.\n * @property {string} description - Description of the identified item.\n * @property {string} [actionName] - Name of the action that was used\n * @property {string} [actionDescription] - Description of the action that was used\n */\n\n/**\n * Generates an info block containing an item's identified info for GMs\n *\n * @remarks This HTML has to be generated in a synchronous way, as adding to a rendered chat message's content\n *          will cause erratic scrolling behaviour.\n * @param {ChatMessagePFIdentifiedInfo} info - An object containing the item's identified info\n * @returns {string} HTML string containing the info block\n */\nfunction getIdentifiedBlock(info) {\n  const hasUniqueActionName = info.action?.name && info.item.name !== info.action?.name;\n  return renderTemplate(\"systems/ffd20/templates/chat/parts/gm-description.hbs\", { ...info, hasUniqueActionName });\n}\n\nexport async function addExtraGMInfo(cm, html) {\n  if (!game.user.isGM) return;\n\n  if (![\"item\", \"action\"].includes(cm.type)) return;\n\n  // Show identified info box for GM if item was unidentified when rolled\n  const metadata = cm.system;\n  const { identified, id: itemId } = metadata.item;\n\n  if (identified === false && itemId) {\n    const cardContent = html.querySelector(\".card-content\");\n    if (!cardContent) return;\n    cardContent.insertAdjacentHTML(\"beforeEnd\", await getIdentifiedBlock(metadata));\n  }\n}\n\n/**\n * Add GM-sensitive info for GMs and hide GM-sensitive info for players\n *\n * @param {ChatMessagePF} cm - Chat message\n * @param {HTMLElement} html - Chat message content\n */\nexport function hideGMSensitiveInfo(cm, html) {\n  // Handle adding of GM-sensitive info. No other processing for GM\n  if (game.user.isGM) return addExtraGMInfo(cm, html);\n\n  // Hide info about unowned tokens\n  for (const elem of html.querySelectorAll(\"[data-gm-sensitive-uuid]\")) {\n    // Quickly hide element\n    elem.classList.add(\"hidden\");\n\n    // Then check for stuff\n    const uuid = elem.dataset.gmSensitiveUuid;\n    if (!uuid) continue;\n\n    let obj = fromUuidSync(uuid);\n    // If token or token document, get actor for testing user permissions\n    // TODO: This should no longer be necessary with Foundry v11, unlinked actors give actor directly.\n    if (obj instanceof Token || obj instanceof TokenDocument) obj = obj.actor;\n\n    //  Show element again, since we have permission\n    if (obj?.testUserPermission && obj.testUserPermission(game.user, \"OBSERVER\")) {\n      elem.classList.remove(\"hidden\");\n    }\n    // Remove element completely, since we don't have permission\n    else {\n      elem.remove();\n    }\n  }\n\n  const showDCs = !game.settings.get(\"ffd20\", \"obscureSaveDCs\");\n  if (!showDCs) for (const elem of html.querySelectorAll(\".difficulty-class .threshold.sensitive\")) elem.remove();\n\n  // Message author, regardless of actor ownership, sees the rest\n  if (cm.isAuthor) return;\n\n  const actor = ChatMessage.getSpeakerActor(cm.speaker);\n  // Exit if allowed to see, followup is for hiding info\n  if (actor?.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)) return;\n\n  // Hide text enricher DCs\n  for (const elem of html.querySelectorAll(\".pf1-link[data-dc][data-sensitive-label]\")) {\n    for (const node of elem.childNodes) if (node.nodeName === \"#text\") node.remove();\n    if (elem.children.length) elem.append(\"Â \");\n    elem.append(elem.dataset.sensitiveLabel);\n    delete elem.dataset.sensitiveLabel;\n  }\n\n  // Hide info\n  for (const elem of html.querySelectorAll(\".gm-sensitive\")) elem.remove();\n\n  // Alter GM inner texts\n  for (const elem of html.querySelectorAll(\"[data-gm-sensitive-inner]\")) {\n    if (showDCs && elem.dataset.action === \"save\") continue;\n\n    elem.textContent = elem.dataset.gmSensitiveInner;\n    delete elem.dataset[\"gm-sensitive-inner\"];\n  }\n\n  if (game.settings.get(\"ffd20\", \"obscureInlineRolls\")) {\n    // Turn rolls into raw strings\n    /** @type {HTMLElement[]} */\n    const inlineEls = html.querySelectorAll(\".inline-roll\");\n    for (const elem of inlineEls) {\n      if (!elem.dataset.roll) continue;\n\n      let roll;\n      try {\n        roll = Roll.fromJSON(unescape(elem.dataset.roll));\n      } catch (err) {\n        console.error(`Inline roll in chat message ${cm.id} had invalid data`, err);\n        return;\n      }\n\n      const nroll = Roll.defaultImplementation.safeRollSync(`${roll.total}`);\n      elem.dataset.roll = escape(JSON.stringify(nroll));\n      delete elem.dataset.tooltip;\n      elem.classList.add(\"obfuscated\");\n    }\n\n    /** @type {HTMLElement[]} */\n    const results = html.querySelectorAll(\".dice-roll .dice-result\");\n    for (const result of results) {\n      // Hide natural roll and bonus, leaving only total\n      /** @type {HTMLElement[]} */\n      const rollEls = result.querySelectorAll(\".roll-total\");\n      for (const elem of rollEls) {\n        elem.replaceChildren(\n          ...[...elem.children].filter((el) => el.classList.contains(\"total\") || el.tagName === \"I\")\n        );\n        elem.classList.add(\"obfuscated\");\n        elem.classList.remove(\"has-details\");\n      }\n\n      /** @type {HTMLElement[]} */\n      const detailEls = result.querySelectorAll(\".dice-tooltip\");\n      for (const elem of detailEls) {\n        elem.remove();\n      }\n    }\n  }\n}\n\n/**\n * @param {ChatMessage} cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n */\nexport function alterAmmoRecovery(cm, jq) {\n  const recoveryData = cm.getFlag(\"ffd20\", \"ammoRecovery\");\n  if (!recoveryData) return;\n\n  jq.find(\".chat-attack .ammo[data-ammo-id]\").each((a, el) => {\n    const attackIndex = el.closest(\".chat-attack\").dataset.index;\n    const ammoId = el.dataset.ammoId;\n    const data = recoveryData[attackIndex]?.[ammoId];\n    if (!data) return;\n    const { recovered } = data;\n    $(el)\n      .find(\".inline-action\")\n      .each((i, ia) => {\n        // TODO: Disable button & track proper quantities\n        // TODO: Mark partial recovery\n        if (recovered === undefined) return;\n        else if (recovered > 0) ia.classList.add(\"recovered\");\n        else ia.classList.add(\"recovery-failed\");\n      });\n  });\n}\n\n/**\n * @param {ChatMessage} cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n */\nexport function alterTargetDefense(cm, jq) {\n  const defenseData = cm.getFlag(\"ffd20\", \"targetDefense\");\n  if (!defenseData) return;\n\n  const html = jq[0];\n\n  for (const targetEl of html.querySelectorAll(\".attack-targets .target[data-uuid]\")) {\n    const uuid = targetEl.dataset.uuid;\n    const targetDefense = foundry.utils.getProperty(defenseData, uuid)?.save;\n    if (!targetDefense) continue;\n\n    // data-saving-throw is obsolete\n    for (const saveEl of targetEl.querySelectorAll(\"[data-save],[data-saving-throw]\")) {\n      const save = saveEl.dataset.save || saveEl.dataset.savingThrow;\n      const value = targetDefense[save];\n      if (Number.isFinite(value)) {\n        saveEl.querySelector(\".value\").textContent = value;\n      }\n    }\n  }\n}\n\n/**\n * @param {ChatMessage} cm - Chat message instance\n * @param {HTMLElement} html - HTML element\n * @param {boolean} recursive - Is this recursive call?\n */\nexport function hideInvisibleTargets(cm, html, recursive = false) {\n  const targetsElem = html.querySelector(\".ffd20.chat-card .attack-targets\");\n  if (!targetsElem) return; // No targets\n\n  // Delay until canvas ready if it's not yet so.\n  if (!canvas.ready) {\n    if (recursive) return;\n    targetsElem.classList.add(\"hidden\");\n    if (!game.settings.get(\"core\", \"noCanvas\")) {\n      Hooks.once(\"canvasReady\", () => hideInvisibleTargets(cm, html, true));\n    } else {\n      // Canvas disabled, remove targets\n      targetsElem.remove();\n    }\n    return;\n  }\n\n  const targetElems = targetsElem.querySelectorAll(\".target\");\n  const targets = Array.from(targetElems).map((elem) => ({ uuid: elem.dataset.uuid, elem }));\n\n  let hasVisible = false;\n  for (const t of targets) {\n    /** @type {TokenDocumentPF} */\n    const token = fromUuidSync(t.uuid);\n    if (!token) continue;\n    t.token = token.object;\n\n    const isVisible = t.token?.isVisible;\n    const isObserver = token.actor?.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER) ?? false;\n\n    // Hide if token invisible and user isn't observer of token\n    if ((!isVisible && !isObserver) || token.isSecret) t.elem.remove();\n    else hasVisible = true;\n  }\n\n  // Hide targets if there's none visible to not reveal presence of invisible targets\n  if (!hasVisible) targetsElem.remove();\n  else targetsElem.classList.remove(\"hidden\");\n}\n\nconst getTokenByUuid = (uuid) => fromUuidSync(uuid)?.object;\n\n/**\n * Pan to defined token\n *\n * Provided here to allow overriding the behaviour.\n *\n * @internal\n * @param {Token} token - Token to pan to\n * @param {number} [duration=250] - Animation duration\n */\nexport function panToToken(token, duration = 250) {\n  canvas.animatePan({ ...token.center, duration });\n}\n\n/**\n * @param {ChatMessage} cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n */\nexport function addTargetCallbacks(cm, jq) {\n  const targetElems = jq[0].querySelectorAll(\".attack-targets .target[data-uuid]\");\n\n  const _mouseEnterCallback = (event, uuid) => getTokenByUuid(uuid)?._onHoverIn(event, { hoverOutOthers: false });\n\n  const _mouseLeaveCallback = (event, uuid) => getTokenByUuid(uuid)?._onHoverOut(event);\n\n  const _imageClickCallback = (event, uuid) => {\n    event.preventDefault();\n\n    const token = getTokenByUuid(uuid);\n    if (!token?.actor.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER)) return;\n\n    const toggle = event.shiftKey;\n\n    if (!toggle || (!token.controlled && toggle)) ffd20.utils.chat.panToToken(token);\n\n    if (token.actor.isOwner) {\n      if (token.controlled) {\n        if (toggle) token.release();\n      } else {\n        token.control({ releaseOthers: !toggle });\n      }\n    }\n  };\n\n  // Add callbacks\n  for (let elem of targetElems) {\n    const uuid = elem.dataset.uuid;\n    const t = fromUuidSync(uuid);\n    if (!t) continue;\n\n    // Image element events\n    const imgElem = elem.querySelector(\".target-image\");\n    imgElem.addEventListener(\"pointerenter\", (ev) => _mouseEnterCallback(ev, uuid), { passive: true });\n    imgElem.addEventListener(\"pointerleave\", (ev) => _mouseLeaveCallback(ev, uuid), { passive: true });\n    imgElem.addEventListener(\"click\", (ev) => _imageClickCallback(ev, uuid));\n\n    // Misc element events\n    elem = $(elem);\n    elem.find(\".ac\").on(\"click\", (event) => {\n      event.preventDefault();\n\n      const t = fromUuidSync(uuid);\n      if (!t?.actor) return;\n      ffd20.utils.chat.targetACClick(cm, jq, t.actor, event);\n    });\n\n    elem.find(\".saving-throws .click\").on(\"click\", (event) => {\n      event.preventDefault();\n\n      const t = fromUuidSync(uuid);\n      if (!t?.actor) return;\n      ffd20.utils.chat.targetSavingThrowClick(cm, jq, t, t.actor, event);\n    });\n  }\n}\n\n/**\n * @param {ChatMessage}  cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n * @param {Actor} actor - Actor instance\n * @param {Event} _event - Triggering event\n */\nexport async function targetACClick(cm, jq, actor, _event) {\n  try {\n    await actor.displayDefenseCard({ rollMode: \"selfroll\" });\n  } catch (err) {\n    ui.notifications.error(\"FFD20.Error.NoDefenseCard\", { localize: true, console: false });\n    throw new Error(\"Could not display defense card\", { cause: err });\n  }\n}\n\n/**\n * @param {ChatMessage}  cm - Chat message instance\n * @param {JQuery<HTMLElement>} jq - JQuery instance\n * @param {Token} token - Target token\n * @param {Actor} actor - Actor instance\n * @param {Event} event - Triggering event\n */\nexport async function targetSavingThrowClick(cm, jq, token, actor, event) {\n  const elem = event.currentTarget;\n  const save = elem.dataset.save || elem.dataset.savingThrow;\n  const dc = cm.system.save?.dc;\n\n  actor.rollSavingThrow(save, { event, dc, reference: cm.uuid });\n}\n\n/* Card Listeners */\n\n/**\n * @internal\n * @param {ChatMessagePF} cm\n * @param {HTMLElement} html\n */\nexport function addListeners(cm, html) {\n  // Header click to expand description\n  html.querySelector(\".item-name\")?.addEventListener(\"click\", (event) => ffd20.utils.chat.onToggleDescription(cm, event));\n\n  for (const elem of html.querySelectorAll(\"button[data-action], a[data-action]\")) {\n    elem.addEventListener(\"click\", (event) => ffd20.utils.chat.onButton(cm, event));\n  }\n}\n\n/**\n * Handle toggling the visibility of chat card content when the name is clicked\n *\n * @internal\n * @param {ChatMessagePF} cm - Chat message\n * @param {Event} event - Triggering event\n */\nexport function onToggleDescription(cm, event) {\n  event.preventDefault();\n\n  /** @type {HTMLElement} */\n  const content = event.currentTarget.closest(\".message-content\");\n  const desc = content.querySelector(\".card-content\");\n  cm._collapsedDescription = desc.classList.toggle(\"hidden\");\n\n  // Update chat popout size\n  const popout = content.closest(\".chat-popout\");\n  ui.windows[popout?.dataset.appid]?.setPosition();\n}\n\n/**\n * Handle `<a data-action>` buttons.\n *\n * @internal\n * @param {ChatMessagePF} cm\n * @param {Event} event - Button event\n */\nexport async function onButton(cm, event) {\n  event.preventDefault();\n\n  // Extract card data\n  const button = event.currentTarget;\n  const buttonActionId = button.dataset.action;\n\n  const getLinkedItem = () => {\n    const item = cm.itemSource;\n    if (!item) throw new Error(\"Associated item not found\");\n    return item;\n  };\n\n  switch (buttonActionId) {\n    case \"applyDamage\": {\n      let asNonlethal;\n      if (cm.system.config?.nonlethal) asNonlethal = true;\n\n      let asManaDamage;\n      if (cm.system.config?.manadamage) asManaDamage = true;\n\n      const value = parseInt(button.dataset.value);\n      if (isNaN(value)) return void console.warn(\"Invalid damage value:\", value, { button });\n\n      const attackIndex = parseInt(button.closest(\"[data-index]\")?.dataset.index);\n      const attackType = button.dataset.type;\n\n      const attack = cm.systemRolls?.attacks?.[attackIndex];\n      const isCritical = attackType === \"critical\";\n\n      const instances = [];\n      const addInstances = (damageRolls) => {\n        if (!damageRolls) return;\n        for (const dmg of damageRolls) {\n          const d = new ffd20.models.action.DamagePartModel(dmg.damageType.toObject());\n          d.value = dmg.total;\n          instances.push(d);\n        }\n      };\n\n      if (attack) {\n        addInstances(attack.damage);\n        if (isCritical) addInstances(attack.critDamage);\n      }\n\n      ffd20.documents.actor.ActorPF.applyDamage(value, {\n        asNonlethal,\n        asManaDamage,\n        event,\n        element: button,\n        message: cm,\n        reference: cm.uuid,\n        isCritical,\n        critMult: isCritical ? (cm.system.config.critMult ?? 0) : 0,\n        instances,\n      });\n      button.disabled = false;\n      break;\n    }\n    // Recover ammunition\n    case \"recoverAmmo\":\n    case \"forceRecoverAmmo\": {\n      const item = cm.itemSource;\n      if (!item?.isOwner) return;\n\n      // Check for recovery state\n      const attackIndex = button.closest(\".chat-attack\").dataset.index;\n      if (!attackIndex) throw new Error(\"Attack index not found\");\n\n      // Find ammo item\n      const ammoId = button.dataset.ammoId || button.closest(\".ammo\")?.dataset.ammoId;\n      const ammoItem = item.actor.items.get(ammoId);\n      if (!ammoItem) return void ui.notifications.error(game.i18n.format(\"FFD20.Error.ItemNotFound\", { id: ammoId }));\n      if (ammoItem.getFlag(\"ffd20\", \"abundant\")) return; // Abundant is unrecoverable\n\n      const ammoQuantity = button.dataset.ammoQuantity || button.closest(\".ammo\")?.dataset.ammoQuantity || 1;\n      if (ammoQuantity == 0) return; // Zero ammo used\n      const recoveryData = cm.getFlag(\"ffd20\", \"ammoRecovery\");\n      const ammoRecovery = recoveryData?.[attackIndex]?.[ammoId];\n      // Backwards compatibility (PF1 v10) with old messages\n      if (ammoRecovery?.failed === true) return;\n      // Recovered is the number recovered, the rest failed\n      if (ammoRecovery?.recovered !== undefined) return;\n\n      let chance = 100; // Force recover\n      if (buttonActionId === \"recoverAmmo\") {\n        chance = ammoItem.system.recoverChance ?? 50;\n      }\n\n      // (Try to) recover ammo\n      let recovered = 0;\n      if (chance > 0) {\n        for (let i = 0; i < ammoQuantity; i++) {\n          const rngResult = Math.random() * 100;\n          if (rngResult <= chance) {\n            recovered += 1;\n          }\n        }\n      }\n\n      const promises = [];\n\n      // Update ammo if any were recovered\n      if (recovered > 0) promises.push(ammoItem.addCharges(recovered));\n\n      // Update chat card\n      promises.push(cm.setFlag(\"ffd20\", \"ammoRecovery\", { [attackIndex]: { [ammoId]: { recovered } } }));\n\n      await Promise.all(promises);\n\n      ui.notifications.info(game.i18n.format(\"FFD20.RecoveredAmmo\", { count: recovered }));\n\n      return true;\n    }\n    case \"save\": {\n      // .dataset.type is deprecated\n      const saveId = button.dataset.save || button.dataset.type;\n      const as = button.dataset.as;\n      const dc = cm.system.save?.dc ?? (button.dataset.dc ? parseInt(button.dataset.dc) : undefined);\n\n      /** @type {ActorPF[]} */\n      let actors;\n      // Defense cards want only speaker\n      if (as === \"speaker\") actors = [ChatMessage.getSpeakerActor(cm.speaker)];\n      // Otherwise use controlled or configured actor\n      else {\n        actors = canvas.tokens.controlled.map((t) => t.actor);\n        if (actors.length == 0 && game.user.character) actors = [game.user.character];\n      }\n      actors = actors.filter((t) => !!t);\n\n      if (!actors.length) return void ui.notifications.warn(\"FFD20.Warning.NoActorSelected\", { localize: true });\n\n      let noSound = false,\n        errored = false;\n      for (const actor of actors) {\n        actor?.rollSavingThrow(saveId, { event, noSound, dc, reference: cm.uuid }).catch((err) => {\n          if (!errored) {\n            ui.notifications.error(\"FFD20.Error.NoSave\", { localize: true, console: false });\n            errored = true;\n          }\n          throw new Error(\"Failed to roll saving throw\", { cause: err });\n        });\n        // TODO: Update card targets if they exist\n        noSound = true;\n      }\n      break;\n    }\n    case \"concentration\": {\n      const item = getLinkedItem();\n      // TODO: Apply bonuses on card if any\n      item.actor.rollConcentration(item.system.spellbook, {\n        item,\n        reference: cm.uuid,\n        dc: item.getConcentrationDC(\"defensive\"),\n      });\n      break;\n    }\n    case \"caster-level-check\": {\n      const item = getLinkedItem();\n      // TODO: Apply bonuses on card (e.g. CL increase in dialog, conditional modifiers, etc.)\n      item.actor.rollCL(item.system.spellbook, { item, reference: cm.uuid });\n      break;\n    }\n    // Show journal entry\n    case \"journal\":\n    case \"open-compendium-entry\": {\n      // .dataset.compendiumEntry is deprecated\n      const uuid = button.dataset.uuid || button.dataset.compendiumEntry;\n      // .dataset.type is defined sometimes, but we only use journals\n      ffd20.utils.openJournal(uuid);\n      break;\n    }\n  }\n}\n","/**\n * Base actor class with minimal functionality.\n *\n * Provides only caching of .itemTypes and nothing else.\n */\nexport class ActorBasePF extends Actor {\n  /**\n   * Add default artwork.\n   *\n   * @see {@link ffd20.config.defaultIcons.actors}\n   *\n   * @internal\n   * @override\n   * @param {object} [actorData] - Actor data to guide creation if any\n   * @returns {object} - Resulting data alterations\n   */\n  static getDefaultArtwork(actorData) {\n    const result = super.getDefaultArtwork(actorData);\n    const image = ffd20.config.defaultIcons.actors[actorData?.type];\n    if (image) {\n      result.img = image;\n      result.texture.src = image;\n    }\n    return result;\n  }\n\n  /**\n   * @override\n   */\n  reset() {\n    // Reset item types cache\n    this._itemTypes = null;\n    // Reset roll data cache if it exists.\n    this._rollData = null;\n\n    this._initialized = false; // For preventing items initializing certain data too early\n\n    super.reset();\n  }\n\n  /** @override */\n  _initialize(options) {\n    super._initialize(options);\n    this._initialized = true;\n  }\n\n  /**\n   * Get item by its identifier tag.\n   *\n   * @param {string} tag - Desired tag.\n   * @returns {Item|undefined} - Matching item or undefined if no item is found.\n   */\n  getItemByTag(tag) {\n    return this.items.find((o) => o.system.tag === tag);\n  }\n\n  /**\n   * Cached result of .itemTypes\n   *\n   * @internal\n   * @type {ItemTypesMap}\n   */\n  _itemTypes;\n\n  /**\n   * Cached override\n   *\n   * @override\n   * @type {ItemTypesMap}\n   */\n  get itemTypes() {\n    if (!this._itemTypes) {\n      this._itemTypes = super.itemTypes;\n\n      // Enrich the arrays with getName() and getId()\n      for (const items of Object.values(this._itemTypes)) {\n        Object.defineProperties(items, {\n          getName: {\n            value: function (name) {\n              return this.find((i) => i.name === name);\n            },\n          },\n          getId: {\n            value: function (identifier) {\n              return this.find((i) => i.system.tag === identifier);\n            },\n          },\n        });\n      }\n    }\n    return this._itemTypes;\n  }\n\n  /**\n   * Returns first active owner, favoring players and GM as fallback.\n   *\n   * @type {User|null}\n   */\n  get activeOwner() {\n    const firstOwner =\n      game.users\n        .filter((u) => u.active && !u.isGM)\n        .filter((u) => this.testUserPermission(u, \"OWNER\"))\n        .sort((a, b) => (a.id > b.id ? 1 : -1))[0] ?? null;\n\n    return firstOwner ?? game.users.activeGM;\n  }\n\n  /**\n   * Get related combatants.\n   *\n   * @param {Combat} [combat=game.combat] Combat instance\n   * @returns {Combatant[]} Related combatants.\n   */\n  getCombatants(combat = game.combat) {\n    return combat?.combatants.filter((c) => c.actor === this) ?? [];\n  }\n\n  /**\n   * Whether current user can see through this actor.\n   *\n   * @type {boolean}\n   */\n  get sharesVision() {\n    const visionFlag = this.getFlag(\"ffd20\", \"visionSharing\");\n    if (!visionFlag) return false;\n\n    const shared = visionFlag.users[game.user.id] ?? null;\n    if (shared === true) return true;\n    else if (shared === false) return false;\n    // Else handle by default rule\n    return visionFlag.default ?? false;\n  }\n\n  /**\n   * Temporary solution until Foundry v12 where visibility of AE no longer controls if it's temporary.\n   *\n   * @internal\n   * @returns {ActiveEffectPF[]}\n   */\n  get _effectsWithDuration() {\n    const effects = [];\n    for (const effect of this.allApplicableEffects()) {\n      if (effect.active && effect._hasDuration) effects.push(effect);\n    }\n    return effects;\n  }\n\n  /**\n   * Override to support toggling buffs from token HUD\n   *\n   * Called by {@link ffd20.canvas.TokenHUDPF TokenHUD}\n   *\n   * @todo Add separate listener for buffs\n   * @override\n   * @param {string} statusId - Status effect ID\n   * @param {object} options - Additional options\n   *\n   * Synced with Foundry v12.331\n   */\n  async toggleStatusEffect(statusId, { active, overlay = false } = {}) {\n    // Support toggling buffs via token  HUD\n    const [_, buffId] = statusId?.split(\"buff-\") ?? [];\n    if (buffId) {\n      const buff = this.items.get(buffId);\n      if (!buff) throw new Error(`Buff not found to toggle: ${buffId}`);\n      const isActive = buff.isActive;\n      const state = active ?? !isActive;\n      if (state === isActive) return;\n\n      await buff.setActive(state);\n      // Slight deviation from API, we do not return created AE here.\n      return state;\n    }\n\n    return super.toggleStatusEffect(statusId, { active, overlay });\n  }\n\n  /**\n   * Condition immunities\n   *\n   * @internal\n   * @returns {Set<string>} - Set of immunity IDs.\n   */\n  getConditionImmunities() {\n    const ci = this.system.traits?.ci?.total ?? [];\n    const list = new Set([...ci]);\n\n    // Map immunities to actual conditions\n    // TODO: Unify the IDs where possible\n    const condToImmMap = {\n      confuse: [\"confused\"],\n      daze: [\"dazed\"],\n      dazzle: [\"dazzled\"],\n      fatigue: [\"fatigued\"],\n      fear: ffd20.registry.conditions.conditionsInTrack(\"fear\"),\n      sicken: [\"sickened\"],\n      paralyze: [\"paralyzed\"],\n      petrify: [\"petrified\"],\n      stun: [\"stunned\"],\n    };\n    for (const [key, conditions] of Object.entries(condToImmMap)) {\n      if (list.has(key)) {\n        for (const cond of conditions) list.add(cond);\n      }\n    }\n\n    return list;\n  }\n\n  /**\n   * Per-actor type initiative options\n   *\n   * @abstract\n   * @returns {object} - Options object\n   */\n  getInitiativeOptions() {\n    // TODO: Pull these from system model if possible\n    return {};\n  }\n\n  /**\n   * @abstract\n   */\n  expireActiveEffects() {}\n}\n\n/**\n * All items sorted by type.\n *\n * Also includes any module introduced types.\n *\n * @typedef ItemTypesMap\n * @property {ItemAttackPF[]} attack - Attacks\n * @property {ItemBuffPF[]} buff - Buffs\n * @property {ItemClassPF[]} class - Classes\n * @property {ItemConsumablePF[]} consumable - Consumables\n * @property {ItemContainerPF[]} container - Containers\n * @property {ItemEquipmentPF[]} equipment - Equipment\n * @property {ItemImplantPF[]} implant - Implants\n * @property {ItemFeatPF[]} feat - Features\n * @property {ItemLootPF[]} loot - Loot\n * @property {ItemRacePF[]} race - Race\n * @property {ItemSpellPF[]} spell - Spells\n * @property {ItemWeaponPF[]} weapon - Weapons\n */\n","import { ActorBasePF } from \"./actor-base.mjs\";\n\nconst actorHandler = {\n  construct(_, args) {\n    const type = args[0]?.type;\n    const cls = CONFIG.Actor.documentClasses[type] ?? ActorBasePF;\n    return new cls(...args);\n  },\n};\n\nexport const ActorPFProxy = new Proxy(ActorBasePF, actorHandler);\n","/**\n * Base item\n *\n * From which all other item documents inherit from.\n */\nexport class ItemBasePF extends Item {\n  /**\n   * Add default artwork.\n   *\n   * @see {@link ffd20.config.defaultIcons.items}\n   *\n   * @internal\n   * @override\n   * @param {object} [itemData] - Item data\n   * @returns {{img:string}} - Default image\n   */\n  static getDefaultArtwork(itemData) {\n    const result = super.getDefaultArtwork(itemData);\n    const image = ffd20.config.defaultIcons.items[itemData?.type];\n    if (image) result.img = image;\n    return result;\n  }\n\n  /**\n   * Item create dialog.\n   *\n   * @override\n   * @param {object} data Initial form data\n   * @param {object} [context] Additional options.\n   * @param {Actor|null} [context.parent=null] Parent parameter passed to Item.create() options\n   * @param {string|null} [context.pack=null] Pack ID parameter passed to Item.create() options\n   * @param {Array<string>} [context.types] Item types to limit creation choices to.\n   * @param {object} [context.options] Dialog context options.\n   * @returns {Promise<Item|null>}\n   *\n   * Synchronized with Foundry VTT v12.331\n   */\n  static async createDialog(data = {}, { parent = null, pack = null, types, ...options } = {}) {\n    // Transform AppV1 position to AppV2\n    const { width, left, top } = options;\n    const position = { width, left, top };\n    return ffd20.applications.item.CreateDialog.waitPrompt({ data, parent, pack, types, position, options });\n  }\n\n  /**\n   * Override to provide naming by subType potential.\n   *\n   * @override\n   * @param {object} context - Context where the name would be used\n   * @param {string} [context.type] - Type\n   * @param {string} [context.subType] - Document subtype. Nonstandard option.\n   * @param {Document|null} [context.parent] - Parent document\n   * @param {string|null} [context.pack] - Pack this would be within\n   * @returns {string}\n   * Synced with Foundry v12.331\n   */\n  static defaultName({ type, subType, parent, pack } = {}) {\n    const documentName = this.metadata.name;\n    let collection;\n    if (parent) collection = parent.getEmbeddedCollection(documentName);\n    else if (pack) collection = game.packs.get(pack);\n    else collection = game.collections.get(documentName);\n    const takenNames = new Set();\n    for (const document of collection) takenNames.add(document.name);\n    let baseNameKey = this.metadata.label;\n    if (type && this.hasTypeData) {\n      let typeNameKey;\n      if (subType && CONFIG.Item.documentClasses[type]?.system?.subtypeName) {\n        const key = `FFD20.Subtypes.Item.${type}.${subType}.Single`;\n        if (game.i18n.has(key)) typeNameKey = key;\n      }\n      typeNameKey ||= CONFIG[documentName].typeLabels?.[type];\n      if (typeNameKey && game.i18n.has(typeNameKey)) baseNameKey = typeNameKey;\n    }\n    const baseName = game.i18n.localize(baseNameKey);\n    let name = baseName;\n    let index = 1;\n    while (takenNames.has(name)) name = `${baseName} (${++index})`;\n    return name;\n  }\n\n  /**\n   * On-Create Operation\n   *\n   * Post-create processing so awaiting the original operation has all secondary updates completed when it returns.\n   *\n   * @override\n   * @param {Document[]} documents - Documents\n   * @param {*} operation  - Operations and context data\n   * @param {User} user - Triggering user\n   */\n  static async _onCreateOperation(documents, operation, user) {\n    await super._onCreateOperation(documents, operation, user);\n\n    if (!user.isSelf) return;\n\n    // Operation parent can be ActorDelta, so we try to get the synthetic actor if it exists.\n    /** @type {Actor} */\n    const actor = operation.parent?.syntheticActor ?? operation.parent;\n    if (!(actor instanceof Actor)) return;\n\n    // Create spellbook if the class has spellcasting defined\n    const promises = [];\n\n    for (const item of documents) {\n      // Creation data\n      const data = operation.data.find((i) => i._id === item.id);\n      if (!data) continue; // Shouldn't happen\n\n      // Class added\n      switch (item.type) {\n        case \"class\": {\n          // Has casting\n          if (item.system.casting?.type) {\n            // Create spellbook entry\n            const bookData = { ...item.system.casting, class: item.system.tag };\n            const p = actor.createSpellbook(bookData);\n            promises.push(p);\n          }\n\n          // Adjust associations if any exist\n          const level = item.system.level ?? 0;\n          if (level > 0) {\n            const p = item._onLevelChange(0, level, { event: \"create\" });\n            promises.push(p);\n          }\n          break;\n        }\n        case \"buff\": {\n          if (item.isActive) {\n            const p = item._updateTrackingEffect(data);\n            promises.push(p);\n          }\n          break;\n        }\n        case \"race\": {\n          // Update owning actor speed to match racial speed.\n          // TODO: Make this derived data on the actor instead, eliminating the update.\n          if (item.system.speeds) {\n            const speedUpdates = {};\n            for (const key of ffd20.const.movementKeys) {\n              speedUpdates[key] = { base: item.system.speeds[key] ?? null };\n            }\n            if (speedUpdates.fly) {\n              speedUpdates.fly.maneuverability = item.system.speeds.flyManeuverability || \"average\";\n            }\n            const p = actor.update({ \"system.attributes.speed\": speedUpdates });\n            promises.push(p);\n          }\n          break;\n        }\n      }\n    }\n\n    // Supplements\n    if (operation._pf1NoSupplements !== true) {\n      const p = this._createSupplements(documents, actor);\n      promises.push(p);\n    }\n\n    await Promise.all(promises);\n  }\n\n  /**\n   * On-Update Operation\n   *\n   * Post-update processing so awaiting the original operation has all secondary updates completed when it returns.\n   *\n   * @override\n   * @param {Document[]} documents - Documents\n   * @param {*} operation  - Operations and context data\n   * @param {User} user - Triggering user\n   */\n  static async _onUpdateOperation(documents, operation, user) {\n    await super._onUpdateOperation(documents, operation, user);\n\n    if (!user.isSelf) return;\n\n    // Operation parent can be ActorDelta, so we try to get the synthetic actor if it exists.\n    /** @type {Actor} */\n    const actor = operation.parent?.syntheticActor ?? operation.parent;\n    if (!(actor instanceof Actor)) return;\n\n    const promises = [];\n\n    for (const item of documents) {\n      const changed = operation.updates.find((i) => i._id === item.id);\n      if (!changed) continue; // Shouldn't happen\n\n      switch (item.type) {\n        case \"class\": {\n          // Update class associations if level changed\n          const oldLevel = operation.ffd20?.item?.[item.id]?.oldLevel ?? 0;\n          const newLevel = changed.system?.level ?? 0;\n          if (newLevel !== oldLevel) {\n            const p = item._onLevelChange(oldLevel, newLevel, { event: \"update\" });\n            promises.push(p);\n          }\n          break;\n        }\n        case \"buff\": {\n          const p = item._updateTrackingEffect(changed);\n          promises.push(p);\n          break;\n        }\n        case \"race\": {\n          // Change actor size if the old size is same as old race size.\n          if (operation._pf1SizeChanged) {\n            const p = actor.update({ \"system.traits.size\": item.system.size });\n            promises.push(p);\n          }\n          break;\n        }\n      }\n    }\n\n    await Promise.all(promises);\n  }\n\n  /**\n   * On-Delete Operation\n   *\n   * Post-delete processing so awaiting the original operation has all secondary updates completed when it returns.\n   *\n   * @override\n   * @param {Document[]} documents - Documents\n   * @param {*} operation  - Operations and context data\n   * @param {User} user - Triggering user\n   */\n  static async _onDeleteOperation(documents, operation, user) {\n    await super._onDeleteOperation(documents, operation, user);\n\n    if (!user.isSelf) return;\n\n    // Operation parent can be ActorDelta, so we try to get the synthetic actor if it exists.\n    /** @type {Actor} */\n    const actor = operation.parent?.syntheticActor ?? operation.parent;\n    if (!(actor instanceof Actor)) return;\n\n    const promises = [];\n\n    for (const item of documents) {\n      switch (item.type) {\n        case \"class\": {\n          // Adjust associations if any exist\n          const prevLevel = item.system.level ?? 0;\n          if (prevLevel > 0) {\n            const p = item._onLevelChange(prevLevel, 0, { event: \"delete\" });\n            promises.push(p);\n          }\n\n          // Disable spellbook associated with this class, if it has spellcasting defined\n          const tag = item.system.tag;\n          if (!tag || !item.system.casting?.type) continue;\n\n          const books = actor.system.attributes.spells.spellbooks ?? {};\n          const usedBook = Object.entries(books).find(([_, book]) => !!book.class && book.class === tag);\n          if (usedBook === undefined) continue;\n\n          const [bookId, book] = usedBook;\n          if (!book.inUse) continue;\n\n          const p = actor.update({ [`system.attributes.spells.spellbooks.${bookId}.inUse`]: false });\n          promises.push(p);\n          break;\n        }\n        case \"race\": {\n          if (actor.itemTypes.race.length === 0) {\n            // Reset some race dependant details\n            // TODO: Make this derived data\n            const p = actor.update({\n              \"system.attributes.speed\": {\n                \"land.base\": 30,\n                \"fly.base\": 0,\n                \"fly.maneuverability\": \"average\",\n                \"swim.base\": 0,\n                \"climb.base\": 0,\n                \"burrow.base\": 0,\n              },\n            });\n            promises.push(p);\n          }\n          break;\n        }\n      }\n    }\n\n    await Promise.all(promises);\n  }\n\n  /**\n   * Collect Data on supplements\n   *\n   * @internal\n   * @param {Array<Item>} items - Array of items to draw supplemental data from\n   * @param {Actor} actor - Owner\n   */\n  static async _createSupplements(items, actor) {\n    const allSupplements = new Collection();\n\n    let t0 = performance.now();\n    const collect = async (item, classLink, _depth = 0) => {\n      const supplements = item.system.links?.supplements ?? [];\n      classLink ??= item.system.class;\n\n      // Log slow fetches occasionally\n      const t1 = performance.now();\n      if (t1 - t0 >= 2_000) {\n        console.debug(\"Fetching\", supplements.length, \"supplements for\", item.name);\n        t0 = t1;\n      }\n\n      // Collect supplements\n      const newItemData = [];\n      for (const supplement of supplements) {\n        const { uuid } = supplement;\n        if (!uuid) continue; // Erroneous supplement data\n        const extraItem = await fromUuid(uuid);\n        if (!extraItem) {\n          // TODO: Display notification instead when this is from UI interaction.\n          console.warn(\"Supplement\", uuid, \"not found for\", item.name, item);\n          continue;\n        }\n\n        const itemData = game.items.fromCompendium(extraItem, { clearFolder: true });\n        foundry.utils.setProperty(itemData, \"flags.ffd20.source\", uuid);\n\n        const old = allSupplements.get(uuid);\n        if (old) old.count += 1;\n        else {\n          allSupplements.set(uuid, { parent: item, item: extraItem, data: itemData, count: 1, classLink, uuid });\n          newItemData.push(itemData);\n        }\n      }\n\n      if (!newItemData.length) return;\n\n      // TODO: Make the limits here configurable?\n      if (_depth > 3) {\n        return void console.warn(\"Stopping collecting supplements deeper than 3 layers\");\n      }\n      if (allSupplements.size > 100 && newItemData.length) {\n        return void console.warn(`Too many supplements (${allSupplements.size}), stopping collecting more`);\n      }\n\n      for (const newItem of newItemData) {\n        // TODO: Somehow add child relation to the children\n        await collect(newItem, classLink, _depth + 1);\n      }\n    };\n\n    // Collect supplements for all items\n    for (const item of items) {\n      await collect(item);\n    }\n\n    // Do additional preparation on collected data\n    const lastSortOrder = {};\n\n    const createData = [];\n    for (const supplement of allSupplements) {\n      const { item, data: itemData, count } = supplement;\n\n      // Adjust quantity of physical items if more than one was added of the same item\n      if (item.isPhysical && itemData.system.quantity > 0) {\n        itemData.system.quantity *= count;\n      }\n      // Inherit class link\n      if (supplement.classLink && item.type === \"feat\" && item.system.subType === \"classFeat\") {\n        itemData.system.class = supplement.classLink;\n      }\n\n      // Sort to end of the item list of their type\n      const oldItemsOfSameType = actor.itemTypes[itemData.type] ?? [];\n      lastSortOrder[itemData.type] ??= oldItemsOfSameType.length\n        ? oldItemsOfSameType.reduce((max, i) => Math.max(i.sort || 0, max), -Number.MIN_SAFE_INTEGER) +\n          CONST.SORT_INTEGER_DENSITY\n        : 0;\n      itemData.sort = lastSortOrder[itemData.type];\n      lastSortOrder[itemData.type] += CONST.SORT_INTEGER_DENSITY;\n\n      // Create item\n      createData.push(itemData);\n    }\n\n    // Create supplements\n    const newItems = await actor.createEmbeddedDocuments(\"Item\", createData, {\n      _pf1NoSupplements: true,\n      render: false, // Following child link creation causes render again\n    });\n\n    // Add child links\n    const updates = new Collection();\n    const allItems = [...items, ...newItems];\n\n    /** @type {Collection<Item>} */\n    for (const item of newItems) {\n      const source = ffd20.utils.internal.uniformUuid(item.getFlag(\"ffd20\", \"source\"));\n      const parent = allItems.find((i) =>\n        i.system.links?.supplements?.some((si) => ffd20.utils.internal.uniformUuid(si.uuid) === source)\n      );\n      if (!parent) {\n        console.warn(item.name, \"parent not found!\", source, allItems);\n        continue;\n      }\n\n      let update = updates.get(parent.id);\n      if (!update) {\n        update = { system: { links: { children: [] } } };\n        update._id = parent.id;\n        updates.set(parent.id, update);\n      }\n      update.system.links.children.push({ uuid: item.getRelativeUUID(actor) });\n    }\n\n    await actor.updateEmbeddedDocuments(\"Item\", Array.from(updates));\n  }\n\n  /**\n   * Item name\n   *\n   * @param {boolean} [forcePlayerPerspective=false] - If true, return value players see.\n   * @returns {string} - Item name\n   */\n  // eslint-disable-next-line no-unused-vars\n  getName(forcePlayerPerspective = false) {\n    return this.name;\n  }\n\n  /**\n   * Is the item is fully functional.\n   *\n   * This returns composite result of if the item is equipped, has quantity, is not disabled, is not out of charges, etc.\n   * and is not representative if the item can be set active or not via {@link setActive}.\n   *\n   * @see {@link activeState}\n   *\n   * @abstract\n   * @type {boolean}\n   */\n  get isActive() {\n    return true;\n  }\n\n  /**\n   * If the item can be activated via {@link setActive}.\n   *\n   * {@link isActive} can return variable state independent of the toggle that {@link setActive} controls, this returns .\n   *\n   * @abstract\n   * @type {boolean}\n   */\n  get activeState() {\n    return this.isActive;\n  }\n\n  /**\n   * Set item's active state.\n   *\n   * @abstract\n   * @param {boolean} active - Active state\n   * @param {object} [context] - Optional update context\n   * @returns {Promise<this>} - Update promise if item type supports the operation.\n   * @throws {Error} - If item does not support the operation.\n   */\n  // eslint-disable-next-line no-unused-vars\n  async setActive(active, context) {\n    throw new Error(`Item type ${this.type} does not support ItemBasePF#setActive`);\n  }\n\n  /**\n   * Is this item usable at base level, disregarding per-action details.\n   *\n   * @abstract\n   * @type {boolean}\n   */\n  get canUse() {\n    return this.isActive;\n  }\n\n  /**\n   * For supporting actions and changes in fromUuid()\n   *\n   * @override\n   *\n   * Synced with Foundry v12.331\n   */\n  getEmbeddedDocument(embeddedName, id, options) {\n    switch (embeddedName) {\n      case \"Action\":\n        return this.actions?.get(id);\n      case \"Change\":\n        return this.changes?.get(id);\n    }\n    return super.getEmbeddedDocument(embeddedName, id, options);\n  }\n}\n","import { ItemBasePF } from \"./item-base.mjs\";\n\nconst itemHandler = {\n  construct(_, args) {\n    const type = args[0]?.type;\n    const cls = CONFIG.Item.documentClasses[type] ?? ItemBasePF;\n    return new cls(...args);\n  },\n};\n\nexport const ItemPFProxy = new Proxy(ItemBasePF, itemHandler);\n","export class PF1Tour extends Tour {\n  /**\n   * An array of {@link Application}s that are currently open.\n   * This needs manual tracking from the classes that inherit from `PF1Tour` and\n   * render the applications themselves.\n   *\n   * @type {Array<Application>}\n   */\n  apps = [];\n\n  /**\n   * @returns {TourStep} The previous step.\n   */\n  get previousStep() {\n    return this.hasPrevious ? this.steps[this.stepIndex - 1] : undefined;\n  }\n\n  /**\n   * Gets the current sheet based on if it's displayed or not.\n   * WARNING: This won't work if the actor sheet is not displayed or there are multiple actor sheets open at once.\n   *\n   * @returns {ffd20.applications.actor.ActorSheetPF | undefined} The current actor sheet if found.\n   */\n  get sheetInDisplay() {\n    // We need to Actor ID to find the sheet. The actor ID is in the ID of the sheet element but needs some formatting\n    return Object.values(ui.windows).find((app) => app instanceof ActorSheet);\n  }\n\n  /**\n   * Based on the `steps` variable, it returns an object with the normalized step IDs as keys and the step IDs as values.\n   * The formatting will take `step-1` and return `STEP_1`.\n   *\n   * @returns {Record<string, string>} An object with the normalized step IDs as keys and the step IDs as values.\n   */\n  get StepsEnum() {\n    return this.steps.reduce((steps, step) => {\n      const stepKey = step.id.replaceAll(/-/g, \"_\").toUpperCase();\n      steps[stepKey] = step.id;\n      return steps;\n    }, {});\n  }\n\n  /**\n   * Given the ID of a step, returns the step index associated with it.\n   *\n   * @param {string} id The ID of the step.\n   * @returns {number} The step index with the given ID (-1 if not found).\n   */\n  getStepIndexById(id) {\n    return this.steps.findIndex((step) => step.id === id);\n  }\n\n  /**\n   * In many steps we might need an specific {@link ffd20.applications.compendiumBrowser.CompendiumBrowser} to be opened\n   * to continue. This function opens the given type of compendium and stores it for later closing or referencing.\n   *\n   * @param {string} compendium - The compendium to open.\n   * @param {object} [options={}] - Additional options to pass to the render function.\n   * @see {@link ffd20.applications.compendiumBrowser.CompendiumBrowser.initializeBrowsers}\n   * @see {@link Application._render}\n   *\n   * @returns {Promise<ffd20.applications.compendiumBrowser.CompendiumBrowser>} The opened compendium.\n   */\n  async openCompendiumBrowser(compendium, options = {}) {\n    // Open compendium\n    const comp = ffd20.applications.compendiums[compendium];\n    if (!comp) {\n      throw new Error(`Compendium \"${compendium}\" not found`);\n    }\n    // Set current compendium\n    await comp._render(true, { focus: true, ...options });\n    // Add CompendiumBrowser to apps\n    this.apps.push(comp);\n\n    return comp;\n  }\n\n  /**\n   * Same as {@link openCompendiumBrowser} but for {@link CompendiumCollection}.\n   *\n   * @param {string} compendium - The compendium to open.\n   * @param {object} [options={}] - Additional options to pass to the render function.\n   * @see {@link openCompendiumBrowser}\n   * @see {@link Application._render}\n   * @see {@link Compendium}\n   *\n   * @returns {Promise<CompendiumCollection>} The opened compendium.\n   */\n  async openCompendium(compendium, options = {}) {\n    /** @type {CompendiumCollection} */\n    const comp = game.packs.get(compendium, { strict: true });\n\n    // Open compendium\n    const compApp = comp.apps.find((app) => app instanceof comp.applicationClass);\n    // Render and add to apps\n    await compApp._render(true, { focus: true, ...options });\n    // Add Compendium to apps\n    this.apps.push(compApp);\n\n    return comp;\n  }\n\n  /**\n   * Closes the currently opened {@link ffd20.applications.compendiumBrowser.CompendiumBrowser} or {@link Compendium} either\n   * by referencing the variable or checking if the active window is the compendium.\n   *\n   * @see {@link openCompendiumBrowser}\n   * @see {@link Application.close}\n   *\n   * @returns {Promise<void>}\n   */\n  async closeCompendium() {\n    const compApps = this.apps.filter(\n      (app) => app instanceof ffd20.applications.compendiumBrowser.CompendiumBrowser || app instanceof Compendium\n    );\n\n    for (const app of compApps) {\n      this._debug(`Closing \\`${app.constructor.name}\\` ${app.id}`);\n      await app.close();\n    }\n  }\n\n  /**\n   * This log functions outputs the given text to the console with Tour ID in the log message.\n   *\n   * @param {string} text The text to log.\n   * @param {\"log\"|\"debug\"|\"warn\"} loglevel The log level to use.\n   * @param {...any} args Extra arguments to pass to {@link console.info}.\n   */\n  _log(text, loglevel = \"log\", ...args) {\n    console[loglevel](`[Tour Step \"%s.%s.%s\"]: ${text}`, ...[this.namespace, this.id, this.currentStep?.id, ...args]);\n  }\n\n  /**\n   * @param {string} text The text to log.\n   * @param  {...any} args Extra arguments to pass to {@link console.info}.\n   * @see {@link _log}\n   */\n  _debug(text, ...args) {\n    this._log(text, \"debug\", ...args);\n  }\n\n  /**\n   * @param {string} text The text to log.\n   * @param  {...any} args Extra arguments to pass to {@link console.info}.\n   * @see {@link _log}\n   */\n  _warn(text, ...args) {\n    this._log(text, \"warn\", ...args);\n  }\n\n  /**\n   * Expands a compendium folder and parent folders if found in the Compendium tab.\n   * Ultimately returns the direct compendium folder.\n   *\n   * @param {string} pack - The name of the compendium from which to get the folder.\n   *\n   * @returns {Folder | null} The actors folder.\n   */\n  expandCompendiumFolder(pack) {\n    // We'll retrieve the element based on the ID and for that we'll need the folder object from compendium\n    const compendium = game.packs.get(pack, { strict: true });\n    /** @type {Folder} */\n    const folder = compendium.folder;\n\n    if (!folder) {\n      this._debug(\n        \"Couldn't find the folder ID for the Basic Monsters compendium. It could be that the compendium isn't in a folder.\"\n      );\n      return null;\n    }\n\n    /**\n     * Given a folder it removes the `collapse` tag expanding it and searches for a parent folder in order to to the same.\n     *\n     * @param {Folder} folder - The folder to expand.\n     */\n    const clickFolder = (folder) => {\n      if (!folder.expanded) {\n        /** @type {HTMLLIElement | null} */\n        const folderEl = document.querySelector(`li.directory-item.folder[data-uuid=\"Folder.${folder.id}\"]`);\n        // The one that triggers the click is the header\n        folderEl?.querySelector(\"header\")?.click();\n      }\n\n      // If this folder is child of another folder we want to expand it as well\n      if (folder.folder) {\n        clickFolder(folder.folder);\n      }\n    };\n\n    clickFolder(folder);\n\n    return folder;\n  }\n\n  /** @override */\n  async _preStep() {\n    if (this.currentStep.sheetTab) {\n      this._debug(\n        `(${this._preStep.name}) Activating ${this.currentStep.sheetTab.tabName} (${this.currentStep.sheetTab.group}) tab`\n      );\n      this.sheetInDisplay?.activateTab(this.currentStep.sheetTab.tabName, this.currentStep.sheetTab.group);\n    }\n\n    await super._preStep();\n  }\n}\n","import { PF1Tour } from \"./base-tours.mjs\";\n\nexport class PF1ActorSheetTour extends PF1Tour {\n  /**\n   * Opens the sheet of the actor used for the tour and assigns it to `this.sheetInDisplay`.\n   *\n   * @param {object} [options={}] - Options to pass to the render function.\n   *\n   * @returns {Promise<ActorSheet>} The opened sheet.\n   */\n  async openSheet(options = {}) {\n    const comp = game.packs.get(this.config.compendiumId, { strict: true });\n\n    /** @type {ffd20.documents.actor.ActorPF | undefined} */\n    const actor = await comp.getDocument(this.config.actorId);\n    if (!actor) {\n      throw new Error(`Actor with ID ${this.config.actorId} not found in compendium ${this.config.compendiumId}`);\n    }\n\n    /** @type {ActorSheet | undefined} */\n    const sheet = actor.sheet;\n    await sheet._render(true, { focus: true, options });\n    // Add sheet to apps\n    this.apps.push(sheet);\n    return sheet;\n  }\n\n  /** @override */\n  async start() {\n    ui.sidebar.tabs.compendium.activate();\n\n    await super.start();\n  }\n\n  /** @override */\n  async previous() {\n    switch (this.previousStep?.id) {\n      // Returning to the Compendium tab after opening the compendium\n      case this.StepsEnum.GO_TO_BASIC_MONSTERS:\n        this._debug(`(${this.previous.name}) Closing Basic Monsters compendium to return to the compendium tab`);\n        await this.closeCompendium();\n        // FIXME: Since the compendium is closed we need to remove manually the tooltips otherwise they will still be visible\n        // and tour stuck\n        // This will cause to `_postStep` to be called twice but it *should* be fine\n        await this._postStep();\n        break;\n      case this.StepsEnum.HIGHLIGHT_STREET_MAGICIAN_IN_COMPENDIUM:\n        this._debug(`(${this.previous.name}) Closing sheet to return to the compendium`);\n        await this.sheetInDisplay?.close();\n        break;\n      default:\n        if (!this.previousStep) {\n          this._warn(`(${this.previous.name}) The previous step to ${this.currentStep?.id} doesn't seem exist.`);\n        }\n        break;\n    }\n\n    await super.previous();\n  }\n\n  /** @override */\n  exit() {\n    this.apps.forEach((app) => app.close());\n\n    super.exit();\n  }\n\n  /** @override */\n  async _preStep() {\n    // Based on the current step index we'll know if the character sheet needs to be opened\n    // From HIGHLIGHT_SHEET onwards we'll be overseeing the character sheet\n    if (this.stepIndex >= this.getStepIndexById(this.StepsEnum.HIGHLIGHT_SHEET)) {\n      this._debug(`(${this._preStep.name}) Opening character sheet for overview`);\n      await this.openSheet(this.config.actorId);\n    }\n\n    // Actions for *specific* steps\n    switch (this.currentStep?.id) {\n      case this.StepsEnum.GO_TO_BASIC_MONSTERS:\n        // We need to expand the Actors folder for the selector of this step to work\n        this._debug(`(${this._preStep.name}) Expanding Actors folder`);\n        this.expandCompendiumFolder(this.config.compendiumId);\n        break;\n      case this.StepsEnum.HIGHLIGHT_STREET_MAGICIAN_IN_COMPENDIUM:\n        // We need to open the Basic Monsters compendium\n        this._debug(`(${this._preStep.name}) Rendering Basic Monsters compendium`);\n        await this.openCompendium(this.config.compendiumId);\n        break;\n      case this.StepsEnum.SPELLBOOKS_CONFIGURATION:\n        // Expand the Configuration section\n        this._debug(`(${this._preStep.name}) Opening primary spellbook configuration`);\n        // At this point we don't have a targetElement so we need to find it by selector\n        document.querySelector(this.currentStep?.selector)?.click();\n        break;\n      default:\n        if (!this.currentStep?.id) {\n          this._warn(`(${this._preStep.name}) The current step doesn't seem to have an ID.`);\n          return;\n        }\n        break;\n    }\n\n    await super._preStep();\n  }\n\n  /** @override */\n  async _postStep() {\n    await super._postStep();\n\n    switch (this.currentStep?.id) {\n      // After highlighting the entry in the compendium, we need to open the sheet\n      case this.StepsEnum.HIGHLIGHT_STREET_MAGICIAN_IN_COMPENDIUM:\n        this._debug(`(${this._postStep.name}) Closing Basic Monsters compendium`);\n        this.closeCompendium();\n        break;\n      case this.StepsEnum.SPELLBOOKS_CONFIGURATION:\n        this._debug(`(${this._postStep.name}) Closing primary spellbook configuration`);\n        this.targetElement?.click();\n        break;\n      default:\n        if (!this.currentStep?.id) {\n          this._warn(`(${this._postStep.name}) The current step doesn't seem to have an ID.`);\n          return;\n        }\n        break;\n    }\n  }\n\n  /** @override */\n  async complete() {\n    this._debug(`(${this.complete.name}) Completing tour`);\n    this.apps.forEach((app) => app.close());\n\n    await super.complete();\n  }\n}\n","import { PF1ActorSheetTour } from \"./tours/actor-sheet-tour.mjs\";\n\nHooks.once(\"ready\", async function registerPF1Tours() {\n  // Actor Sheet Tour\n  game.tours.register(\"ffd20\", \"actorSheet\", await PF1ActorSheetTour.fromJSON(\"systems/ffd20/tours/actor-sheet-tour.json\"));\n});\n","/**\n * PF1 Configuration Values\n *\n * A dictionary of dictionaries providing configuration data like formulae,\n * translation keys, and other configuration values. Translations keys are\n * assumed to get replaced by their proper translation when the system is loaded.\n *\n * These may be adjusted to influence the system's behaviour during runtime.\n * It is available as `ffd20.config` as well as through `CONFIG.PF1`.\n *\n * @module\n */\n\n/**\n * @internal\n */\nexport const re = {\n  traitSeparator: /\\s*[;]\\s*/g,\n};\n\n/**\n * The set of Ability Scores used within the system\n *\n * @enum {string}\n */\nexport const abilities = /** @type {const} */ ({\n  str: \"FFD20.AbilityStr\",\n  dex: \"FFD20.AbilityDex\",\n  con: \"FFD20.AbilityCon\",\n  int: \"FFD20.AbilityInt\",\n  wis: \"FFD20.AbilityWis\",\n  cha: \"FFD20.AbilityCha\",\n});\n\n/**\n * The set of Ability Scores used within the system in short form\n */\nexport const abilitiesShort = /** @type {const} */ ({\n  str: \"FFD20.AbilityShortStr\",\n  dex: \"FFD20.AbilityShortDex\",\n  con: \"FFD20.AbilityShortCon\",\n  int: \"FFD20.AbilityShortInt\",\n  wis: \"FFD20.AbilityShortWis\",\n  cha: \"FFD20.AbilityShortCha\",\n});\n\n/**\n * The point cost to increase an ability score using Point Buy\n */\nexport const abilityCost = /** @type {const} */ ({\n  7: -4,\n  8: -2,\n  9: -1,\n  10: 0,\n  11: 1,\n  12: 2,\n  13: 3,\n  14: 5,\n  15: 7,\n  16: 10,\n  17: 13,\n  18: 17,\n});\n\n/**\n * Point buy calculator.\n */\nexport const pointBuy = /** @type {const} */ ({\n  low: { label: \"FFD20.Application.PointBuy.Type.low\", points: 10 },\n  standard: { label: \"FFD20.Application.PointBuy.Type.standard\", points: 15 },\n  high: { label: \"FFD20.Application.PointBuy.Type.high\", points: 20 },\n  epic: { label: \"FFD20.Application.PointBuy.Type.epic\", points: 25 },\n});\n\n/**\n * At which levels you receive how many new ability points.\n */\nexport const levelAbilityScores = /** @type {const} */ ({\n  4: 1,\n  8: 1,\n  12: 1,\n  16: 1,\n  20: 1,\n});\n\n/**\n * How many points are assigned per choice.\n *\n * For homebrew support.\n *\n * @type {number}\n */\nexport const levelAbilityScoreMult = 1;\n\n/**\n * At which mythic tiers you receive how many new ability points.\n */\nexport const tierAbilityScores = /** @type {const} */ ({\n  2: 2,\n  4: 2,\n  6: 2,\n  8: 2,\n  10: 2,\n});\n\n/**\n * How many points are assigned per choice.\n *\n * @type {number}\n */\nexport const tierAbilityScoreMult = 2;\n\n/**\n * Valid hit die sizes.\n */\nexport const hitDieSizes = /** @type {const} */ ([6, 8, 10, 12]);\n\n/**\n * Item data for the feature associated with ability scores gained from leveling.\n */\nexport const levelAbilityScoreFeature = /** @type {const} */ ({\n  img: \"systems/ffd20/icons/skills/affliction_10.jpg\",\n  name: \"FFD20.LevelUp.AbilityScore.Item.Name\",\n  system: {\n    description: {\n      value: \"FFD20.LevelUp.AbilityScore.Item.Desc\",\n    },\n    subType: \"misc\",\n  },\n  type: \"feat\",\n});\n\n/**\n * The set of Saving Throws\n */\nexport const savingThrows = /** @type {const} */ ({\n  fort: \"FFD20.SavingThrowFort\",\n  ref: \"FFD20.SavingThrowRef\",\n  will: \"FFD20.SavingThrowWill\",\n});\n\n/**\n * The types of classes\n */\nexport const classTypes = /** @type {const} */ ({\n  base: \"FFD20.Subtypes.Item.class.base.Single\",\n  prestige: \"FFD20.Subtypes.Item.class.prestige.Single\",\n  npc: \"FFD20.Subtypes.Item.class.npc.Single\",\n  racial: \"FFD20.Subtypes.Item.class.racial.Single\",\n  mythic: \"FFD20.Subtypes.Item.class.mythic.Single\",\n});\n\n/**\n * Valid options for a class's BAB progression\n */\nexport const classBAB = /** @type {const} */ ({\n  low: \"FFD20.Low\",\n  med: \"FFD20.Medium\",\n  high: \"FFD20.High\",\n  custom: \"FFD20.Custom\",\n});\n\n/**\n * Valid options for a class's saving throw bonus progression\n */\nexport const classSavingThrows = /** @type {const} */ ({\n  low: \"FFD20.Poor\",\n  high: \"FFD20.Good\",\n  custom: \"FFD20.Custom\",\n});\n\n/**\n * The formulae for BAB progressions\n */\nexport const classBABFormulas = /** @type {const} */ ({\n  low: \"floor(@hitDice * 0.5)\",\n  med: \"floor(@hitDice * 0.75)\",\n  high: \"@hitDice\",\n  custom: \"0\",\n});\n\nexport const classFractionalBABFormulas = /** @type {const} */ ({\n  low: \"@hitDice * 0.5\", // 1/2\n  med: \"@hitDice * 0.75\", // 3/4\n  high: \"@hitDice\", // 1/1\n  custom: \"0\",\n});\n\n/**\n * The formulae for saving throw progressions by class type\n */\nexport const classSavingThrowFormulas = /** @type {const} */ ({\n  base: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  prestige: {\n    low: \"floor((1 + @hitDice) / 3)\",\n    high: \"floor((1 + @hitDice) / 2)\",\n  },\n  npc: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  racial: {\n    low: \"floor(@hitDice / 3)\",\n    high: \"2 + floor(@hitDice / 2)\",\n  },\n  mythic: {\n    low: \"0\",\n    high: \"0\",\n  },\n  custom: {\n    low: \"0\",\n    high: \"0\",\n  },\n});\n\nexport const classFractionalSavingThrowFormulas = /** @type {const} */ ({\n  goodSaveBonus: \"2\",\n  base: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  prestige: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  npc: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  racial: {\n    low: \"@hitDice / 3\",\n    high: \"@hitDice / 2\",\n    goodSave: true,\n  },\n  mythic: {\n    low: \"0\",\n    high: \"0\",\n  },\n  custom: {\n    low: \"0\",\n    high: \"0\",\n  },\n});\n\n/**\n * Item types that can have class associations.\n *\n * @todo\n * - Move this to item metadata.\n */\nexport const classAssociations = /** @type {const} */ ([\"feat\", \"attack\"]);\n\n/**\n * The choices available for favoured class bonuses\n */\nexport const favouredClassBonuses = /** @type {const} */ ({\n  hp: \"FFD20.FavouredClass.Bonuses.hp\",\n  skill: \"FFD20.FavouredClass.Bonuses.skill\",\n  alt: \"FFD20.FavouredClass.Bonuses.alt\",\n});\n\n/**\n * Icons used for favoured class bonus choices\n */\nexport const favouredClassBonusIcons = /** @type {const} */ ({\n  hp: \"fa-heartbeat\",\n  skill: \"fa-wrench\",\n  alt: \"fa-tag\",\n});\n\n/**\n * The set of Armor Classes\n */\nexport const ac = /** @type {const} */ ({\n  normal: \"FFD20.ACNormal\",\n  touch: \"FFD20.ACTouch\",\n  flatFooted: \"FFD20.ACFlatFooted\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Character alignment options\n */\nexport const alignments = /** @type {const} */ ({\n  lg: \"FFD20.Alignments.lg\",\n  ng: \"FFD20.Alignments.ng\",\n  cg: \"FFD20.Alignments.cg\",\n  ln: \"FFD20.Alignments.ln\",\n  tn: \"FFD20.Alignments.tn\",\n  cn: \"FFD20.Alignments.cn\",\n  le: \"FFD20.Alignments.le\",\n  ne: \"FFD20.Alignments.ne\",\n  ce: \"FFD20.Alignments.ce\",\n});\n\n/**\n * Character alignment options in their short form\n */\nexport const alignmentsShort = /** @type {const} */ ({\n  lg: \"FFD20.Alignments.Short.lg\",\n  ng: \"FFD20.Alignments.Short.ng\",\n  cg: \"FFD20.Alignments.Short.cg\",\n  ln: \"FFD20.Alignments.Short.ln\",\n  tn: \"FFD20.Alignments.Short.tn\",\n  cn: \"FFD20.Alignments.Short.cn\",\n  le: \"FFD20.Alignments.Short.le\",\n  ne: \"FFD20.Alignments.Short.ne\",\n  ce: \"FFD20.Alignments.Short.ce\",\n});\n\n/**\n * Extra damage reduction types\n *\n * @alpha\n */\nexport const damageResistances = /** @type {const} */ ({\n  lawful: \"FFD20.Alignments.l\",\n  chaotic: \"FFD20.Alignments.c\",\n  good: \"FFD20.Alignments.g\",\n  evil: \"FFD20.Alignments.e\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * The set of Armor Proficiencies which a character may have\n */\nexport const armorProficiencies = /** @type {const} */ ({\n  lgt: \"FFD20.Proficiency.Armor.light\",\n  med: \"FFD20.Proficiency.Armor.medium\",\n  hvy: \"FFD20.Proficiency.Armor.heavy\",\n  shl: \"FFD20.Proficiency.Armor.shield\",\n  twr: \"FFD20.Proficiency.Armor.tower\",\n});\n\n/**\n * The set of broad Weapon Proficiencies a character may have\n */\nexport const weaponProficiencies = /** @type {const} */ ({\n  simple: \"FFD20.Proficiency.Weapon.simple\",\n  martial: \"FFD20.Proficiency.Weapon.martial\",\n  exotic: \"FFD20.Proficiency.Weapon.exotic\",\n  firearm: \"FFD20.Proficiency.Weapon.firearm\",\n  siege: \"FFD20.Proficiency.Weapon.siege\",\n  heavy: \"FFD20.Proficiency.Weapon.heavy\",\n  chef: \"FFD20.Proficiency.Weapon.chef\",\n  power: \"FFD20.Proficiency.Weapon.power\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * This describes the ways that an ability can be activated.\n */\nexport const abilityActivationTypes = /** @type {const} */ ({\n  nonaction: \"FFD20.Activation.nonaction.Single\",\n  passive: \"FFD20.Activation.passive.Single\",\n  free: \"FFD20.Activation.free.Single\",\n  swift: \"FFD20.Activation.swift.Single\",\n  immediate: \"FFD20.Activation.immediate.Single\",\n  move: \"FFD20.Activation.move.Single\",\n  standard: \"FFD20.Activation.standard.Single\",\n  full: \"FFD20.Activation.fullRound.Single\",\n  attack: \"FFD20.Activation.attack.Single\",\n  aoo: \"FFD20.Activation.aoo.Single\",\n  round: \"FFD20.Activation.round.Single\",\n  minute: \"FFD20.Activation.minute.Single\",\n  hour: \"FFD20.Activation.hour.Single\",\n  special: \"FFD20.Activation.special.Single\",\n});\n\n/**\n * This describes plurals for activation types.\n */\nexport const abilityActivationTypesPlurals = /** @type {const} */ ({\n  free: \"FFD20.Activation.free.Plural\",\n  swift: \"FFD20.Activation.swift.Plural\",\n  immediate: \"FFD20.Activation.immediate.Plural\",\n  move: \"FFD20.Activation.move.Plural\",\n  standard: \"FFD20.Activation.standard.Plural\",\n  full: \"FFD20.Activation.fullRound.Plural\",\n  attack: \"FFD20.Activation.attack.Plural\",\n  round: \"FFD20.Activation.round.Plural\",\n  minute: \"FFD20.Activation.minute.Plural\",\n  hour: \"FFD20.Activation.hour.Plural\",\n});\n\n/**\n * This describes the ways that an ability can be activated when using\n * Unchained rules.\n */\nexport const abilityActivationTypes_unchained = /** @type {const} */ ({\n  nonaction: \"FFD20.Activation.nonaction.Single\",\n  passive: \"FFD20.Activation.passive.Single\",\n  free: \"FFD20.Activation.free.Single\",\n  reaction: \"FFD20.Activation.reaction.Single\",\n  action: \"FFD20.Activation.action.Single\",\n  attack: \"FFD20.Activation.attack.Single\",\n  aoo: \"FFD20.Activation.aoo.Single\",\n  minute: \"FFD20.Activation.minute.Single\",\n  hour: \"FFD20.Activation.hour.Single\",\n  special: \"FFD20.Activation.special.Single\",\n});\n\n/**\n * This describes plurals for the ways that an ability can be activated when\n * using Unchained rules.\n */\nexport const abilityActivationTypesPlurals_unchained = /** @type {const} */ ({\n  passive: \"FFD20.Activation.passive.Plural\",\n  free: \"FFD20.Activation.free.Plural\",\n  reaction: \"FFD20.Activation.reaction.Plural\",\n  action: \"FFD20.Activation.action.Plural\",\n  minute: \"FFD20.Activation.minute.Plural\",\n  hour: \"FFD20.Activation.hour.Plural\",\n  special: \"FFD20.Activation.special.Plural\",\n});\n\n/**\n * Activation types that have no meaningful cost\n */\nexport const costlessActivation = /** @type {const} */ (\n  new Set([\n    \"special\",\n    \"full\",\n    \"free\",\n    \"aoo\",\n    \"attack\",\n    \"move\",\n    \"nonaction\",\n    \"passive\",\n    \"standard\",\n    \"swift\",\n    \"reaction\",\n    \"immediate\",\n  ])\n);\n\n/**\n * The possible conditions when using Wound Threshold rules\n */\nexport const woundThresholdConditions = /** @type {const} */ ({\n  0: \"FFD20.WoundLevel.healthy\",\n  1: \"FFD20.WoundLevel.grazed\",\n  2: \"FFD20.WoundLevel.wounded\",\n  3: \"FFD20.WoundLevel.critical\",\n});\n\n/**\n * Change targets affected by Wound Thresholds.\n */\nexport const woundThresholdChangeTargets = /** @type {const} */ ([\n  \"~attackCore\",\n  \"cl\",\n  \"allSavingThrows\",\n  \"ac\",\n  //\"cmd\", // valid target but is inherited from \"ac\"\n  \"skills\",\n  \"allChecks\",\n  //\"init\", // inherited from allChecks\n  //\"abilityChecks\", // inherited from allChecks\n]);\n\nexport const divineFocus = /** @type {const} */ ({\n  0: \"\",\n  1: \"FFD20.SpellComponents.DFVariants.DF\",\n  2: \"FFD20.SpellComponents.DFVariants.MDF\",\n  3: \"FFD20.SpellComponents.DFVariants.FDF\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * The possible creature sizes\n */\nexport const actorSizes = /** @type {const} */ ({\n  fine: \"FFD20.ActorSize.fine\",\n  dim: \"FFD20.ActorSize.dim\",\n  tiny: \"FFD20.ActorSize.tiny\",\n  sm: \"FFD20.ActorSize.sm\",\n  med: \"FFD20.ActorSize.med\",\n  lg: \"FFD20.ActorSize.lg\",\n  huge: \"FFD20.ActorSize.huge\",\n  grg: \"FFD20.ActorSize.grg\",\n  col: \"FFD20.ActorSize.col\",\n});\n\n/**\n * Possible creature age categories\n */\nexport const ageCategories = /** @type {const} */ ({\n  young: {\n    label: \"FFD20.AgeCategories.young\",\n    modifiers: { str: -2, dex: 2, con: -2, int: 0, wis: -2, cha: 0 },\n  },\n  adult: {\n    label: \"FFD20.AgeCategories.adult\",\n    modifiers: { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 },\n  },\n  middleAge: {\n    label: \"FFD20.AgeCategories.middleAge\",\n    modifiers: { str: -1, dex: -1, con: -1, int: 1, wis: 1, cha: 1 },\n  },\n  old: {\n    label: \"FFD20.AgeCategories.old\",\n    modifiers: { str: -3, dex: -3, con: -3, int: 2, wis: 2, cha: 2 },\n  },\n  venerable: {\n    label: \"FFD20.AgeCategories.venerable\",\n    modifiers: { str: -6, dex: -6, con: -6, int: 3, wis: 3, cha: 3 },\n  },\n});\n\n/**\n * Armor & shield cost multipliers for different creature sizes.\n *\n * @see https://aonprd.com/Rules.aspx?Name=Armor%20for%20Unusual%20Creatures&Category=Armor\n */\nexport const armorCost = /** @type {const} */ ({\n  humanoid: {\n    fine: 0.5,\n    dim: 0.5,\n    tiny: 0.5,\n    sm: 1,\n    med: 1,\n    lg: 2,\n    huge: 4,\n    grg: 8,\n    col: 16,\n  },\n  nonhumanoid: {\n    fine: 1,\n    dim: 1,\n    tiny: 1,\n    sm: 2,\n    med: 2,\n    lg: 4,\n    huge: 8,\n    grg: 16,\n    col: 32,\n  },\n});\n\n/**\n * Armor weight multipliers for different creature sizes.\n *\n * The values are same for both humanoid and non-humanoid.\n *\n * @see https://aonprd.com/Rules.aspx?Name=Armor%20for%20Unusual%20Creatures&Category=Armor\n */\nexport const armorWeight = /** @type {const} */ ({\n  fine: 0.1,\n  dim: 0.1,\n  tiny: 0.1,\n  sm: 0.5,\n  med: 1,\n  lg: 2,\n  huge: 5,\n  grg: 8,\n  col: 12,\n});\n\n/**\n * The possible creature sizes in their one-letter form\n */\nexport const sizeChart = /** @type {const} */ ({\n  fine: \"F\",\n  dim: \"D\",\n  tiny: \"T\",\n  sm: \"S\",\n  med: \"M\",\n  lg: \"L\",\n  huge: \"H\",\n  grg: \"G\",\n  col: \"C\",\n});\n\n/**\n * @typedef {object} TokenSize\n * @property {number} w - Width, in cells\n * @property {number} h - Height, in cells\n * @property {number} scale - Scale ratio\n */\n\n/**\n * The size values for Tokens according to the creature's size\n *\n * @type {Record<string,TokenSize>}\n */\nexport const tokenSizes = /** @type {const} */ ({\n  fine: { w: 1, h: 1, scale: 0.25 },\n  dim: { w: 1, h: 1, scale: 0.4 },\n  tiny: { w: 1, h: 1, scale: 0.55 },\n  sm: { w: 1, h: 1, scale: 0.75 },\n  med: { w: 1, h: 1, scale: 1 },\n  lg: { w: 2, h: 2, scale: 1 },\n  huge: { w: 3, h: 3, scale: 1 },\n  grg: { w: 4, h: 4, scale: 1 },\n  col: { w: 6, h: 6, scale: 1 },\n});\n\n/**\n * The size modifier applied to creatures not of medium size\n */\nexport const sizeMods = /** @type {const} */ ({\n  fine: 8,\n  dim: 4,\n  tiny: 2,\n  sm: 1,\n  med: 0,\n  lg: -1,\n  huge: -2,\n  grg: -4,\n  col: -8,\n});\n\n/**\n * The size modifier applied to creatures not of medium size\n */\nexport const sizeSpecialMods = /** @type {const} */ ({\n  fine: -8,\n  dim: -4,\n  tiny: -2,\n  sm: -1,\n  med: 0,\n  lg: 1,\n  huge: 2,\n  grg: 4,\n  col: 8,\n});\n\n/**\n * The size modifier applied to fly checks of creatures not of medium size\n */\nexport const sizeFlyMods = /** @type {const} */ ({\n  fine: 8,\n  dim: 6,\n  tiny: 4,\n  sm: 2,\n  med: 0,\n  lg: -2,\n  huge: -4,\n  grg: -6,\n  col: -8,\n});\n\n/**\n * The size modifier applied to stealth checks of creatures not of medium size\n */\nexport const sizeStealthMods = /** @type {const} */ ({\n  fine: 16,\n  dim: 12,\n  tiny: 8,\n  sm: 4,\n  med: 0,\n  lg: -4,\n  huge: -8,\n  grg: -12,\n  col: -16,\n});\n\n/**\n * Vehicle properties based on size and type\n */\nexport const vehicles = /** @type {const} */ ({\n  size: {\n    lg: {\n      label: \"FFD20.ActorSize.lg\",\n      space: \"FFD20.Vehicles.Space.Large\",\n    },\n    huge: {\n      label: \"FFD20.ActorSize.huge\",\n      space: \"FFD20.Vehicles.Space.Huge\",\n    },\n    grg: {\n      label: \"FFD20.ActorSize.grg\",\n      space: \"FFD20.Vehicles.Space.Gargantuan\",\n    },\n    col: {\n      label: \"FFD20.ActorSize.col\",\n      space: \"FFD20.Vehicles.Space.Colossal\",\n    },\n  },\n  type: {\n    land: \"FFD20.Vehicles.Types.Land\",\n    sea: \"FFD20.Vehicles.Types.Sea\",\n    air: \"FFD20.Vehicles.Types.Air\",\n  },\n});\n\nexport const vehicleMaterials = /** @type {const} */ ({\n  leather: {\n    label: \"FFD20.Materials.Types.leather\",\n    hp: 10,\n    hardness: 0,\n  },\n  wood: {\n    label: \"FFD20.Materials.Types.wood\",\n    hp: 15,\n    hardness: 5,\n  },\n  stone: {\n    label: \"FFD20.Materials.Types.stone\",\n    hp: 20,\n    hardness: 8,\n  },\n  metal: {\n    label: \"FFD20.Vehicles.Metal\",\n    hp: 20,\n    hardness: 10,\n  },\n});\n\n/**\n * Haunt templates with CR and journal link\n */\nexport const hauntTemplates = /** @type {const} */ ({\n  belligerent: {\n    cr: 3,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.ViD7x7D2AEIUp2dQ\",\n  },\n  itemBound: {\n    cr: -1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.GgK76mqrJm8iPitI\",\n  },\n  chained: {\n    cr: -1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.xRk4w3d0k9a3XfoR\",\n  },\n  elusive: {\n    cr: 1,\n    crBonus: 1,\n    crBonusTag: \"persistent\",\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.FeZDtjPSyxxqtvSP\",\n  },\n  fast: {\n    cr: 2,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.gOUBR4eNOqKZrQbe\",\n  },\n  freeRoaming: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.70TeCwEEWNTqet9j\",\n  },\n  increasedArea: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.7bujYFyTIngbWcC7\",\n  },\n  latent: {\n    cr: 0,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.LBvgVviZKigP49TT\",\n  },\n  persistent: {\n    cr: 2,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.UJplPnsAXORwc0wG\",\n  },\n  possessing: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.POoYy22lWnkNtlrG\",\n  },\n  spiteful: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.bt61t3hOagcnoXzF\",\n  },\n  tenacious: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.NQsW2HGccyOeVFt0\",\n  },\n  unyielding: {\n    cr: 2,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.F9mLugVUBaIUtU0g\",\n  },\n  vaporous: {\n    cr: 1,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.eEur8JYjiDBCcpv6\",\n  },\n  variant: {\n    cr: 0,\n    uuid: \"Compendium.ffd20.pf1e-rules.JournalEntry.LLIvEvZp2mWlJi72.JournalEntryPage.wo4WlQIj0hd4zYgn\",\n  },\n});\n\n/**\n * Haunt template labels\n */\nexport const hauntTemplateLabels = /** @type {const} */ ({\n  belligerent: \"FFD20.Haunt.Template.belligerent\",\n  itemBound: \"FFD20.Haunt.Template.itemBound\",\n  chained: \"FFD20.Haunt.Template.chained\",\n  elusive: \"FFD20.Haunt.Template.elusive\",\n  fast: \"FFD20.Haunt.Template.fast\",\n  freeRoaming: \"FFD20.Haunt.Template.freeRoaming\",\n  increasedArea: \"FFD20.Haunt.Template.increasedArea\",\n  latent: \"FFD20.Haunt.Template.latent\",\n  persistent: \"FFD20.Haunt.Template.persistent\",\n  possessing: \"FFD20.Haunt.Template.possessing\",\n  spiteful: \"FFD20.Haunt.Template.spiteful\",\n  tenacious: \"FFD20.Haunt.Template.tenacious\",\n  unyielding: \"FFD20.Haunt.Template.unyielding\",\n  vaporous: \"FFD20.Haunt.Template.vaporous\",\n  variant: \"FFD20.Haunt.Template.variant\",\n});\n\n/**\n * Trap properties with labels\n */\nexport const traps = /** @type {const} */ ({\n  bypass: {\n    lock: \"FFD20.Trap.Bypass.Lock\",\n    hiddenSwitch: \"FFD20.Trap.Bypass.HiddenSwitch\",\n    hiddenLock: \"FFD20.Trap.Bypass.HiddenLock\",\n  },\n  reset: {\n    automatic: \"FFD20.Trap.Reset.Automatic\",\n    manual: \"FFD20.Trap.Reset.Manual\",\n    repair: \"FFD20.Trap.Reset.Repair\",\n  },\n  trigger: {\n    electricEyes: \"FFD20.Trap.Triggers.ElectricEyes\",\n    genetic: \"FFD20.Trap.Triggers.Genetic\",\n    location: \"FFD20.Trap.Triggers.Location\",\n    proximity: \"FFD20.Trap.Triggers.Proximity\",\n    sound: \"FFD20.Trap.Triggers.Sound\",\n    spell: \"FFD20.Trap.Triggers.Spell\",\n    timed: \"FFD20.Trap.Triggers.Timed\",\n    touch: \"FFD20.Trap.Triggers.Touch\",\n    visual: \"FFD20.Trap.Triggers.Visual\",\n  },\n  types: {\n    magic: \"FFD20.Trap.Types.Magic\",\n    mechanical: \"FFD20.Trap.Types.Mechanical\",\n  },\n  vision: {\n    arcaneEye: \"FFD20.Trap.Vision.ArcaneEye\",\n    clairvoyance: \"FFD20.Trap.Vision.Clairvoyance\",\n    darkvision: \"FFD20.Sense.darkvision\",\n    seeInDarkness: \"FFD20.Sense.seeInDark\",\n    trueSeeing: \"FFD20.Trap.Vision.TrueSeeing\",\n  },\n});\n\n/**\n * Perception Modifiers for Trap's trigger detections\n */\nexport const trapPerceptionModifiers = /** @type {const} */ ({\n  electricEyes: 15,\n  sound: 15,\n  vision: {\n    arcaneEye: 20,\n    clairvoyance: 15,\n    trueSeeing: 30,\n  },\n});\n\n/**\n * The possible options for a creature's flight maneuverability\n */\nexport const flyManeuverabilities = /** @type {const} */ ({\n  clumsy: \"FFD20.Movement.FlyManeuverability.Quality.clumsy\",\n  poor: \"FFD20.Movement.FlyManeuverability.Quality.poor\",\n  average: \"FFD20.Movement.FlyManeuverability.Quality.average\",\n  good: \"FFD20.Movement.FlyManeuverability.Quality.good\",\n  perfect: \"FFD20.Movement.FlyManeuverability.Quality.perfect\",\n});\n\n/**\n * The bonus values for a creature's maneuverability\n */\nexport const flyManeuverabilityValues = /** @type {const} */ ({\n  clumsy: -8,\n  poor: -4,\n  average: 0,\n  good: 4,\n  perfect: 8,\n});\n\n/**\n * Overland speeds\n */\nexport const overlandSpeed = /** @type {const} */ ({\n  imperial: {\n    // Default\n    // 1 mi per 10 ft\n    default: {\n      per: 10,\n      out: 1,\n      unit: \"mi\",\n    },\n  },\n  metric: {\n    // Metric system, used by German translation\n    // 1.5 km per 3 m\n    rounded: {\n      per: 3,\n      out: 1.5,\n      unit: \"km\",\n    },\n    // Exact metric system, used by Spanish translation\n    // 1.6 km per 3 m\n    exact: {\n      per: 3,\n      out: 1.6,\n      unit: \"km\",\n    },\n  },\n});\n\n/* -------------------------------------------- */\n\n/**\n * An array of maximum carry capacities, where the index is the ability/strength score.\n */\n// prettier-ignore\nexport const encumbranceLoads = /** @type {const} */ ([\n  0,\n  10,\n  20,\n  30,\n  40,\n  50,\n  60,\n  70,\n  80,\n  90,\n  100,\n  115,\n  130,\n  150,\n  175,\n  200,\n  230,\n  260,\n  300,\n  350,\n  400,\n  460,\n  520,\n  600,\n  700,\n  800,\n  920,\n  1040,\n  1200,\n  1400,\n  1600,\n  1840,\n  2080,\n  2400,\n  2800,\n  3200,\n  3680,\n  4160,\n  4800,\n  5600,\n  6400,\n  7360,\n  8320,\n  9600,\n  11200,\n  12800,\n  14720,\n  16640,\n  19200,\n  22400,\n  25600,\n]);\n\n/**\n * Encumbrance levels for light, medium, and heavy loads.\n *\n * @see {@link ActorPF._computeEncumbrance ActorPF.system.encumbrance.level}\n * @readonly\n * @enum {number}\n */\nexport const encumbranceLevels = /** @type {const} */ ({\n  light: 0,\n  medium: 1,\n  heavy: 2,\n});\n\n/**\n * Encumbrance multipliers applied due to a creature's size for bi- and\n * quadrupedal creatures.\n */\nexport const encumbranceMultipliers = /** @type {const} */ ({\n  normal: {\n    fine: 0.125,\n    dim: 0.25,\n    tiny: 0.5,\n    sm: 0.75,\n    med: 1,\n    lg: 2,\n    huge: 4,\n    grg: 8,\n    col: 16,\n  },\n  quadruped: {\n    fine: 0.25,\n    dim: 0.5,\n    tiny: 0.75,\n    sm: 1,\n    med: 1.5,\n    lg: 3,\n    huge: 6,\n    grg: 12,\n    col: 24,\n  },\n});\n\n/**\n * Item Modifiers based on their enhancement bonus\n */\nexport const itemEnhancementMods = /** @type {const} */ ({\n  hp: 10,\n  hardness: 2,\n});\n\n/**\n * Group Resting information\n *\n * Hours declares how many hours total rest are needed with single person watching.\n *\n * Double is for same as hours, but with two people watching at the same time.\n */\nexport const partyRest = /** @type {const} */ ({\n  1: {\n    hours: 8, // No watches\n    double: null,\n  },\n  2: {\n    hours: 16,\n    double: null,\n  },\n  3: {\n    hours: 12,\n    double: null,\n  },\n  4: {\n    hours: 10.667,\n    double: 16,\n  },\n  5: {\n    hours: 10,\n    double: 16,\n  },\n  6: {\n    hours: 9.6,\n    double: 12,\n  },\n  7: {\n    hours: 9.332,\n    double: 12,\n  },\n  8: {\n    hours: 9,\n    double: 10.667,\n  },\n  // Higher party numbers do not reduce total rest time but can reduce watch time or allow more people to watch\n});\n\n/**\n * Damage multipliers from ability score.\n */\nexport const abilityDamageMultipliers = /** @type {const} */ ([\n  { value: 0.5, label: \"Ã0.5\" },\n  { value: 1, label: \"Ã1\" },\n  { value: 1.5, label: \"Ã1.5\" },\n  { value: 2, label: \"Ã2\" },\n  { value: 2.5, label: \"Ã2.5\" },\n]);\n\n/**\n * Ability damage multipliers inherited from held options\n */\nexport const abilityDamageHeldMultipliers = /** @type {const} */ ({\n  oh: 0.5,\n  \"1h\": 1,\n  \"2h\": 1.5,\n});\n\n/**\n * Weapon hold types\n */\nexport const weaponHoldTypes = /** @type {const} */ ({\n  \"1h\": \"FFD20.WeaponHoldTypeOneHanded\",\n  \"2h\": \"FFD20.WeaponHoldTypeTwoHanded\",\n  oh: \"FFD20.WeaponHoldTypeOffhand\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Classification types for item action types\n */\nexport const itemActionTypes = /** @type {const} */ ({\n  mwak: \"FFD20.ActionTypes.mwak\",\n  rwak: \"FFD20.ActionTypes.rwak\",\n  twak: \"FFD20.ActionTypes.twak\",\n  msak: \"FFD20.ActionTypes.msak\",\n  rsak: \"FFD20.ActionTypes.rsak\",\n  mcman: \"FFD20.ActionTypes.mcman\",\n  rcman: \"FFD20.ActionTypes.rcman\",\n  spellsave: \"FFD20.ActionTypes.spellSave\",\n  save: \"FFD20.ActionTypes.save\",\n  heal: \"FFD20.ActionTypes.heal\",\n  other: \"FFD20.ActionTypes.other\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Enumerate the lengths of time over which an item can have limited use ability\n */\nexport const limitedUsePeriods = /** @type {const} */ ({\n  single: \"FFD20.LimitedUses.Periods.single\",\n  round: \"FFD20.LimitedUses.Periods.round\",\n  minute: \"FFD20.LimitedUses.Periods.minute\",\n  hour: \"FFD20.LimitedUses.Periods.hour\",\n  day: \"FFD20.LimitedUses.Periods.day\",\n  week: \"FFD20.LimitedUses.Periods.week\",\n  charges: \"FFD20.LimitedUses.Periods.charges\",\n});\n\n/**\n * Order of limited use periods from smallest to biggest, omitting periods with no relation to time.\n */\nexport const limitedUsePeriodOrder = /** @type {const} */ ([\"round\", \"minute\", \"hour\", \"day\", \"week\"]);\n\n/* -------------------------------------------- */\n\n/**\n * The various equipment types and their subtypes\n */\nexport const equipmentTypes = /** @type {const} */ ({\n  armor: {\n    _label: \"FFD20.Subtypes.Item.equipment.armor.Single\",\n    lightArmor: \"FFD20.Subtypes.Item.equipment.armor.Types.light\",\n    mediumArmor: \"FFD20.Subtypes.Item.equipment.armor.Types.medium\",\n    heavyArmor: \"FFD20.Subtypes.Item.equipment.armor.Types.heavy\",\n  },\n  shield: {\n    _label: \"FFD20.Subtypes.Item.equipment.shield.Single\",\n    lightShield: \"FFD20.Subtypes.Item.equipment.shield.Types.light\",\n    heavyShield: \"FFD20.Subtypes.Item.equipment.shield.Types.heavy\",\n    towerShield: \"FFD20.Subtypes.Item.equipment.shield.Types.tower\",\n    other: \"FFD20.Subtypes.Item.equipment.shield.Types.misc\",\n  },\n  wondrous: {\n    _label: \"FFD20.Subtypes.Item.equipment.wondrous.Single\",\n  },\n  clothing: {\n    _label: \"FFD20.Subtypes.Item.equipment.clothing.Single\",\n  },\n  materia: {\n    _label: \"FFD20.Subtypes.Item.equipment.materia.Single\",\n    ability: \"FFD20.Subtypes.Item.equipment.materia.Types.ability\",\n    independent: \"FFD20.Subtypes.Item.equipment.materia.Types.independent\",\n    spell: \"FFD20.Subtypes.Item.equipment.materia.Types.spell\",\n    summon: \"FFD20.Subtypes.Item.equipment.materia.Types.summon\",\n    support: \"FFD20.Subtypes.Item.equipment.materia.Types.support\",\n  },\n  other: {\n    _label: \"FFD20.Other\",\n  },\n});\n\n/**\n * The slots equipment can occupy, sorted by category\n */\nexport const equipmentSlots = /** @type {const} */ ({\n  armor: {\n    armor: \"FFD20.EquipSlots.armor\",\n  },\n  shield: {\n    shield: \"FFD20.EquipSlots.shield\",\n  },\n  wondrous: {\n    slotless: \"FFD20.EquipSlots.none\",\n    head: \"FFD20.EquipSlots.head\",\n    headband: \"FFD20.EquipSlots.headband\",\n    eyes: \"FFD20.EquipSlots.eyes\",\n    shoulders: \"FFD20.EquipSlots.shoulders\",\n    neck: \"FFD20.EquipSlots.neck\",\n    chest: \"FFD20.EquipSlots.chest\",\n    body: \"FFD20.EquipSlots.body\",\n    belt: \"FFD20.EquipSlots.belt\",\n    wrists: \"FFD20.EquipSlots.wrists\",\n    hands: \"FFD20.EquipSlots.hands\",\n    ring: \"FFD20.EquipSlots.ring\",\n    feet: \"FFD20.EquipSlots.feet\",\n  },\n  clothing: {\n    clothing: \"FFD20.EquipSlots.clothing\",\n  },\n  materia: {\n    any: \"FFD20.EquipSlots.anySlot\",\n    weapon: \"FFD20.EquipSlots.weaponSlot\",\n    shield: \"FFD20.EquipSlots.shieldSlot\",\n    armor: \"FFD20.EquipSlots.armorSlot\",\n    weaponarmor: \"FFD20.EquipSlots.weaponArmorSlot\",\n    armorShield: \"FFD20.EquipSlots.armorShieldSlot\",\n    other: \"FFD20.EquipSlots.otherSlot\",\n  },\n  other: {\n    other: \"FFD20.Other\",\n  },\n});\n\nexport const implantTypes = /** @type {const} */ ({\n  cybertech: \"FFD20.Subtypes.Item.implant.cybertech.Single\",\n});\n\n/**\n * The slots implants can occupy.\n */\nexport const implantSlots = /** @type {const} */ ({\n  cybertech: {\n    none: \"FFD20.Cybertech.Slots.none\",\n    arm: \"FFD20.Cybertech.Slots.arm\",\n    body: \"FFD20.Cybertech.Slots.body\",\n    brain: \"FFD20.Cybertech.Slots.brain\",\n    ears: \"FFD20.Cybertech.Slots.ears\",\n    eyes: \"FFD20.Cybertech.Slots.eyes\",\n    head: \"FFD20.Cybertech.Slots.head\",\n    legs: \"FFD20.Cybertech.Slots.legs\",\n  },\n});\n\n/**\n * The subtypes for loot items\n */\nexport const lootTypes = /** @type {const} */ ({\n  gear: \"FFD20.Subtypes.Item.loot.gear.Plural\",\n  tool: \"FFD20.Subtypes.Item.loot.tool.Plural\",\n  ammo: \"FFD20.Subtypes.Item.loot.ammo.Plural\",\n  food: \"FFD20.Subtypes.Item.loot.food.Plural\",\n  herb: \"FFD20.Subtypes.Item.loot.herb.Plural\",\n  adventuring: \"FFD20.Subtypes.Item.loot.adventuring.Plural\",\n  animal: \"FFD20.Subtypes.Item.loot.animal.Plural\",\n  animalGear: \"FFD20.Subtypes.Item.loot.animalGear.Plural\",\n  reagent: \"FFD20.Subtypes.Item.loot.reagent.Plural\",\n  remedy: \"FFD20.Subtypes.Item.loot.remedy.Plural\",\n  treasure: \"FFD20.Subtypes.Item.loot.treasure.Plural\",\n  tradeGoods: \"FFD20.Subtypes.Item.loot.tradeGoods.Plural\",\n  vehicle: \"FFD20.Subtypes.Item.loot.vehicle.Plural\",\n  entertainment: \"FFD20.Subtypes.Item.loot.entertainment.Plural\",\n  misc: \"FFD20.Subtypes.Item.loot.misc.Plural\",\n});\n\n/**\n * Loot subtypes that should not be equippable.\n */\nexport const unequippableLoot = /** @type {const} */ ([\n  \"food\",\n  \"herb\",\n  \"reagent\",\n  \"treasure\",\n  \"tradeGoods\",\n  \"vehicle\",\n  \"entertainment\",\n  \"ammo\",\n]);\n\n/**\n * The subtypes for ammo type loot items\n */\nexport const ammoTypes = /** @type {const} */ ({\n  arrow: \"FFD20.AmmoType.arrow\",\n  bolt: \"FFD20.AmmoType.bolt\",\n  repeatingBolt: \"FFD20.AmmoType.repeatingBolt\",\n  slingBullet: \"FFD20.AmmoType.slingBullet\",\n  gunBullet: \"FFD20.AmmoType.gunBullet\",\n  dragoonBullet: \"FFD20.AmmoType.dragoonBullet\",\n  dart: \"FFD20.AmmoType.dart\",\n  siege: \"FFD20.AmmoType.siege\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Enumerate the valid consumable types which are recognized by the system\n */\nexport const consumableTypes = /** @type {const} */ ({\n  potion: \"FFD20.Subtypes.Item.consumable.potion.Single\",\n  oil: \"FFD20.Subtypes.Item.consumable.oil.Single\",\n  poison: \"FFD20.Subtypes.Item.consumable.poison.Single\",\n  drug: \"FFD20.Subtypes.Item.consumable.drug.Single\",\n  alchContact: \"FFD20.Subtypes.Item.consumable.alchContact.Single\",\n  alchIngested: \"FFD20.Subtypes.Item.consumable.alchIngested.Single\",\n  alchInhaled: \"FFD20.Subtypes.Item.consumable.alchInhaled.Single\",\n  scroll: \"FFD20.Subtypes.Item.consumable.scroll.Single\",\n  wand: \"FFD20.Subtypes.Item.consumable.wand.Single\",\n  rod: \"FFD20.Subtypes.Item.consumable.rod.Single\",\n  staff: \"FFD20.Subtypes.Item.consumable.staff.Single\",\n  pharmaceutical: \"FFD20.Subtypes.Item.consumable.pharmaceutical.Single\",\n  misc: \"FFD20.Misc\",\n});\n\nexport const attackTypes = /** @type {const} */ ({\n  weapon: \"FFD20.Subtypes.Item.attack.weapon.Single\",\n  natural: \"FFD20.Subtypes.Item.attack.natural.Single\",\n  ability: \"FFD20.Subtypes.Item.attack.ability.Single\",\n  racialAbility: \"FFD20.Subtypes.Item.attack.racialAbility.Single\",\n  item: \"FFD20.Item\",\n  misc: \"FFD20.Misc\",\n});\n\nexport const featTypes = /** @type {const} */ ({\n  feat: \"FFD20.Subtypes.Item.feat.feat.Single\",\n  classFeat: \"FFD20.Subtypes.Item.feat.classFeat.Single\",\n  trait: \"FFD20.Subtypes.Item.feat.trait.Single\",\n  racial: \"FFD20.Subtypes.Item.feat.racial.Single\",\n  misc: \"FFD20.Misc\",\n  template: \"FFD20.Subtypes.Item.feat.template.Single\",\n});\n\nexport const featTypesPlurals = /** @type {const} */ ({\n  feat: \"FFD20.Subtypes.Item.feat.feat.Plural\",\n  classFeat: \"FFD20.Subtypes.Item.feat.classFeat.Plural\",\n  trait: \"FFD20.Subtypes.Item.feat.trait.Plural\",\n  racial: \"FFD20.Subtypes.Item.feat.racial.Plural\",\n  template: \"FFD20.Subtypes.Item.feat.template.Plural\",\n});\n\nexport const traitTypes = /** @type {const} */ ({\n  combat: \"FFD20.Trait.combat\",\n  magic: \"FFD20.Trait.magic\",\n  faith: \"FFD20.Trait.faith\",\n  social: \"FFD20.Trait.social\",\n  campaign: \"FFD20.Trait.campaign\",\n  cosmic: \"FFD20.Trait.cosmic\",\n  equipment: \"FFD20.Trait.equipment\",\n  exemplar: \"FFD20.Trait.exemplar\",\n  faction: \"FFD20.Trait.faction\",\n  family: \"FFD20.Trait.family\",\n  mount: \"FFD20.Trait.mount\",\n  race: \"FFD20.Trait.race\",\n  region: \"FFD20.Trait.region\",\n  religion: \"FFD20.Trait.religion\",\n  drawback: \"FFD20.Trait.drawback\",\n});\n\nexport const racialTraitCategories = /** @type {const} */ ({\n  standard: \"FFD20.RacialTraitCategories.standard\",\n  defense: \"FFD20.RacialTraitCategories.defense\",\n  featSkills: \"FFD20.RacialTraitCategories.featSkills\",\n  magical: \"FFD20.RacialTraitCategories.magical\",\n  movement: \"FFD20.RacialTraitCategories.movement\",\n  senses: \"FFD20.RacialTraitCategories.senses\",\n  offense: \"FFD20.RacialTraitCategories.offense\",\n  other: \"FFD20.RacialTraitCategories.other\",\n  weakness: \"FFD20.RacialTraitCategories.weakness\",\n  alternate: \"FFD20.RacialTraitCategories.alternate\",\n});\n\nexport const raceTypes = /** @type {const} */ ({\n  core: \"FFD20.RaceTypes.core\",\n  base: \"FFD20.RaceTypes.base\",\n  beastman: \"FFD20.RaceTypes.beastman\",\n  monstrous: \"FFD20.RaceTypes.monstrous\",\n});\n\n/**\n * Ability types, each with their short and their long form\n */\nexport const abilityTypes = /** @type {const} */ ({\n  na: {\n    long: \"FFD20.AbilityTypes.na.Label\",\n    short: \"FFD20.AbilityTypes.na.Short\",\n  },\n  ex: {\n    long: \"FFD20.AbilityTypes.ex.Label\",\n    short: \"FFD20.AbilityTypes.ex.Short\",\n  },\n  su: {\n    long: \"FFD20.AbilityTypes.su.Label\",\n    short: \"FFD20.AbilityTypes.su.Short\",\n  },\n  sp: {\n    long: \"FFD20.AbilityTypes.sp.Label\",\n    short: \"FFD20.AbilityTypes.sp.Short\",\n  },\n});\n\n/* -------------------------------------------- */\n\n/**\n * The valid currency denominations supported by the game system\n */\nexport const currencies = /** @type {const} */ ({\n  pp: \"FFD20.Currency.Abbr.pp\",\n  gp: \"FFD20.Currency.Abbr.gp\",\n  sp: \"FFD20.Currency.Abbr.sp\",\n  cp: \"FFD20.Currency.Abbr.cp\",\n});\n\n/**\n * Currency\n */\nexport const currency = /** @type {const} */ ({\n  /**\n   * Conversion rates in relation to {@link currency.base base currency}.\n   */\n  rate: {\n    pp: 1_000,\n    gp: 100,\n    sp: 10,\n  },\n\n  /**\n   * Standard currency.\n   *\n   * Most things are valued in this unit.\n   */\n  standard: \"gp\",\n\n  /**\n   * Baseline currency.\n   *\n   * This should always be the lowest valued and most compatible currency, as otherwise rounding errors are likely to occur.\n   */\n  base: \"cp\",\n\n  /**\n   * Standard rate.\n   *\n   * @remarks\n   * - Equivalent of `rate[standard] || 1`\n   *\n   * @type {number}\n   */\n  get standardRate() {\n    return this.rate[this.standard] || 1;\n  },\n});\n\n/**\n * Resultant armor types for an actor's worn armor as per their roll data\n *\n * @see {@link ActorPF.getRollData ActorRollData.armor.type}\n * @readonly\n * @enum {number}\n */\nexport const armorTypes = /** @type {const} */ ({\n  none: 0,\n  light: 1,\n  medium: 2,\n  heavy: 3,\n});\n\n/**\n * Resultant shield types for an actor's worn shield\n *\n * @see {@link ActorPF.getRollData ActorRollData.shield.type}\n * @readonly\n * @enum {number}\n */\nexport const shieldTypes = /** @type {const} */ ({\n  none: 0,\n  other: 1, // buckler\n  light: 2,\n  heavy: 3,\n  tower: 4,\n});\n\n/**\n * The types of bonus modifiers\n */\nexport const bonusTypes = /** @type {const} */ ({\n  untyped: \"FFD20.ModifierType.untyped\",\n  untypedPerm: \"FFD20.ModifierType.untypedPerm\",\n  base: \"FFD20.ModifierType.base\",\n  enh: \"FFD20.ModifierType.enhancement\",\n  dodge: \"FFD20.ModifierType.dodge\",\n  haste: \"FFD20.ModifierType.haste\",\n  inherent: \"FFD20.ModifierType.inherent\",\n  deflection: \"FFD20.ModifierType.deflection\",\n  morale: \"FFD20.ModifierType.morale\",\n  luck: \"FFD20.ModifierType.luck\",\n  sacred: \"FFD20.ModifierType.sacred\",\n  insight: \"FFD20.ModifierType.insight\",\n  resist: \"FFD20.ModifierType.resistance\",\n  profane: \"FFD20.ModifierType.profane\",\n  trait: \"FFD20.ModifierType.trait\",\n  racial: \"FFD20.ModifierType.racial\",\n  size: \"FFD20.ModifierType.size\",\n  competence: \"FFD20.ModifierType.competence\",\n  circumstance: \"FFD20.ModifierType.circumstance\",\n  alchemical: \"FFD20.ModifierType.alchemical\",\n});\n\n/**\n * An array of stacking bonus types by their keys for {@link bonusTypes}\n */\nexport const stackingBonusTypes = /** @type {const} */ ([\"untyped\", \"untypedPerm\", \"dodge\", \"racial\", \"circumstance\"]);\n\n/* -------------------------------------------- */\n\n/* -------------------------------------------- */\n\n/**\n * Valid options for the range of abilities and spells\n */\nexport const distanceUnits = /** @type {const} */ ({\n  none: \"FFD20.None\",\n  personal: \"FFD20.Distance.personal\",\n  touch: \"FFD20.Distance.touch\",\n  melee: \"FFD20.Distance.melee\",\n  reach: \"FFD20.Distance.reach\",\n  close: \"FFD20.Distance.close\",\n  medium: \"FFD20.Distance.medium\",\n  long: \"FFD20.Distance.long\",\n  ft: \"FFD20.Distance.ft\",\n  mi: \"FFD20.Distance.mi\",\n  spec: \"FFD20.Special\",\n  seeText: \"FFD20.SeeText\",\n  unlimited: \"FFD20.Unlimited\",\n});\n\nexport const measureUnits = /** @type {const} */ ({\n  ft: \"FFD20.Distance.ft\",\n  mi: \"FFD20.Distance.mi\",\n  m: \"FFD20.Distance.m\",\n  km: \"FFD20.Distance.km\",\n});\n\nexport const measureUnitsShort = /** @type {const} */ ({\n  ft: \"FFD20.Distance.ftShort\",\n  mi: \"FFD20.Distance.miShort\",\n  m: \"FFD20.Distance.mShort\",\n  km: \"FFD20.Distance.kmShort\",\n});\n\nexport const actorStatures = /** @type {const} */ ({\n  tall: \"FFD20.StatureTall\",\n  long: \"FFD20.StatureLong\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * This Object defines the various lengths of time which can occur in PF1\n */\nexport const timePeriods = /** @type {const} */ ({\n  inst: \"FFD20.Time.Period.inst.Label\",\n  turn: \"FFD20.Time.Period.turn.Label\",\n  round: \"FFD20.Time.Period.round.Label\",\n  minute: \"FFD20.Time.Period.minute.Label\",\n  hour: \"FFD20.Time.Period.hour.Label\",\n  day: \"FFD20.Time.Period.day.Label\",\n  month: \"FFD20.Time.Period.month.Label\",\n  year: \"FFD20.Time.Period.year.Label\",\n  perm: \"FFD20.Time.Period.perm.Label\",\n  seeText: \"FFD20.SeeText\",\n  spec: \"FFD20.Special\",\n});\n\n/**\n * Short form labels for time periods, and valid options for buff durations.\n */\nexport const timePeriodsShort = /** @type {const} */ ({\n  turn: \"FFD20.Time.Period.turn.Short\",\n  round: \"FFD20.Time.Period.round.Short\",\n  minute: \"FFD20.Time.Period.minute.Short\",\n  hour: \"FFD20.Time.Period.hour.Short\",\n});\n\n/**\n * Duration end events\n *\n * Used by buffs to decide when exactly their duration ends.\n */\nexport const durationEndEvents = /** @type {const} */ ({\n  turnStart: \"FFD20.Time.Turn.Start\",\n  initiative: \"FFD20.Initiative\",\n  turnEnd: \"FFD20.Time.Turn.End\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Caster types.\n *\n * Keys match options in {@link casterProgression}\n */\nexport const caster = /** @type {const} */ ({\n  /**\n   * Preparation types.\n   */\n  type: {\n    prepared: {\n      label: \"FFD20.SpellPrepPrepared\",\n      spontaneous: false,\n      prepared: true,\n    },\n    spontaneous: {\n      label: \"FFD20.SpellPrepSpontaneous\",\n      spontaneous: true,\n      prepared: false,\n    },\n    hybrid: {\n      label: \"FFD20.SpellPrepHybrid\",\n      spontaneous: true,\n      prepared: true,\n    },\n  },\n  /**\n   * Progression choices.\n   */\n  progression: {\n    high: {\n      label: \"FFD20.High\",\n    },\n    med: {\n      label: \"FFD20.Medium\",\n    },\n    low: {\n      label: \"FFD20.Low\",\n    },\n  },\n});\n\n/**\n * This Object determines spells gained and cast per level\n */\nexport const casterProgression = /** @type {const} */ ({\n  castsPerDay: {\n    prepared: {\n      low: [\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY, 0],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1, 0],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 0],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 0],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 3],\n      ],\n      med: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 4],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2],\n        [Number.POSITIVE_INFINITY, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 3, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    spontaneous: {\n      low: [\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 1, 1],\n        [Number.POSITIVE_INFINITY, 3, 2, 2, 1],\n        [Number.POSITIVE_INFINITY, 3, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 1],\n        [Number.POSITIVE_INFINITY, 4, 3, 2, 2],\n        [Number.POSITIVE_INFINITY, 4, 3, 3, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3, 2],\n      ],\n      med: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 4],\n        [Number.POSITIVE_INFINITY, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 4],\n        [Number.POSITIVE_INFINITY, 5],\n        [Number.POSITIVE_INFINITY, 6, 3],\n        [Number.POSITIVE_INFINITY, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 5, 3],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 6, 4],\n        [Number.POSITIVE_INFINITY, 6, 6, 6, 6, 6, 6, 6, 6, 6],\n      ],\n    },\n    hybrid: {\n      high: [\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 4],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    prestige: {\n      low: [\n        [Number.POSITIVE_INFINITY, 1],\n        [Number.POSITIVE_INFINITY, 2],\n        [Number.POSITIVE_INFINITY, 3],\n        [Number.POSITIVE_INFINITY, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 2],\n        [Number.POSITIVE_INFINITY, 4, 3],\n        [Number.POSITIVE_INFINITY, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 4, 4, 2],\n        [Number.POSITIVE_INFINITY, 5, 4, 3],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n        [Number.POSITIVE_INFINITY, 5, 4, 3, 1],\n      ],\n    },\n  },\n  spellsPreparedPerDay: {\n    prepared: {\n      low: [\n        [null],\n        [null],\n        [null],\n        [null, 0],\n        [null, 1],\n        [null, 1],\n        [null, 1, 0],\n        [null, 1, 1],\n        [null, 2, 1],\n        [null, 2, 1, 0],\n        [null, 2, 1, 1],\n        [null, 2, 2, 1],\n        [null, 3, 2, 1, 0],\n        [null, 3, 2, 1, 1],\n        [null, 3, 2, 2, 1],\n        [null, 3, 3, 2, 1],\n        [null, 4, 3, 2, 1],\n        [null, 4, 3, 2, 2],\n        [null, 4, 3, 3, 2],\n        [null, 4, 4, 3, 3],\n      ],\n      med: [\n        [3, 1],\n        [4, 2],\n        [4, 3],\n        [4, 3, 1],\n        [4, 4, 2],\n        [5, 4, 3],\n        [5, 4, 3, 1],\n        [5, 4, 4, 2],\n        [5, 5, 4, 3],\n        [5, 5, 4, 3, 1],\n        [5, 5, 4, 4, 2],\n        [5, 5, 5, 4, 3],\n        [5, 5, 5, 4, 3, 1],\n        [5, 5, 5, 4, 4, 2],\n        [5, 5, 5, 5, 4, 3],\n        [5, 5, 5, 5, 4, 3, 1],\n        [5, 5, 5, 5, 4, 4, 2],\n        [5, 5, 5, 5, 5, 4, 3],\n        [5, 5, 5, 5, 5, 5, 4],\n        [5, 5, 5, 5, 5, 5, 5],\n      ],\n      high: [\n        [3, 1],\n        [4, 2],\n        [4, 2, 1],\n        [4, 3, 2],\n        [4, 3, 2, 1],\n        [4, 3, 3, 2],\n        [4, 4, 3, 2, 1],\n        [4, 4, 3, 3, 2],\n        [4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 4, 3, 2, 1],\n        [4, 4, 4, 4, 4, 4, 4, 3, 3, 2],\n        [4, 4, 4, 4, 4, 4, 4, 4, 3, 3],\n        [4, 4, 4, 4, 4, 4, 4, 4, 4, 4],\n      ],\n    },\n    spontaneous: {\n      low: [\n        [2],\n        [3],\n        [4],\n        [4, 2],\n        [5, 3],\n        [5, 4],\n        [6, 4, 2],\n        [6, 4, 3],\n        [6, 5, 4],\n        [6, 5, 4, 2],\n        [6, 5, 4, 3],\n        [6, 6, 5, 4],\n        [6, 6, 5, 4, 2],\n        [6, 6, 5, 4, 3],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 5, 4],\n        [6, 6, 6, 6, 5],\n        [6, 6, 6, 6, 5],\n        [6, 6, 6, 6, 5],\n      ],\n      med: [\n        [4, 2],\n        [5, 3],\n        [6, 4],\n        [6, 4, 2],\n        [6, 4, 3],\n        [6, 4, 4],\n        [6, 5, 4, 2],\n        [6, 5, 4, 3],\n        [6, 5, 4, 4],\n        [6, 5, 5, 4, 2],\n        [6, 6, 5, 4, 3],\n        [6, 6, 5, 4, 4],\n        [6, 6, 5, 5, 4, 2],\n        [6, 6, 6, 5, 4, 3],\n        [6, 6, 6, 5, 4, 4],\n        [6, 6, 6, 5, 5, 4, 2],\n        [6, 6, 6, 6, 5, 4, 3],\n        [6, 6, 6, 6, 5, 4, 4],\n        [6, 6, 6, 6, 5, 5, 4],\n        [6, 6, 6, 6, 6, 5, 5],\n      ],\n      high: [\n        [4, 2],\n        [5, 2],\n        [5, 3],\n        [6, 3, 1],\n        [6, 4, 2],\n        [7, 4, 2, 1],\n        [7, 5, 3, 2],\n        [8, 5, 3, 2, 1],\n        [8, 5, 4, 3, 2],\n        [9, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 3, 2],\n        [9, 5, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 3],\n      ],\n    },\n    hybrid: {\n      high: [\n        [4, 2],\n        [5, 2],\n        [5, 3],\n        [6, 3, 1],\n        [6, 4, 2],\n        [7, 4, 2, 1],\n        [7, 5, 3, 2],\n        [8, 5, 3, 2, 1],\n        [8, 5, 4, 3, 2],\n        [9, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 3, 2],\n        [9, 5, 5, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 2, 1],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 2],\n        [9, 5, 5, 4, 4, 4, 3, 3, 3, 3],\n      ],\n    },\n    prestige: {\n      low: [\n        [null, 2],\n        [null, 3],\n        [null, 4],\n        [null, 4, 2],\n        [null, 4, 3],\n        [null, 4, 4],\n        [null, 5, 4, 2],\n        [null, 5, 4, 3],\n        [null, 5, 4, 4],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n        [null, 5, 5, 4, 2],\n      ],\n    },\n  },\n});\n\n/* -------------------------------------------- */\n\n/**\n * Character senses options\n */\nexport const senses = /** @type {const} */ ({\n  bs: \"FFD20.Sense.blindsight\",\n  bse: \"FFD20.Sense.blindsense\",\n  dv: \"FFD20.Sense.darkvision\",\n  ts: \"FFD20.Sense.tremorsense\",\n  tr: \"FFD20.Sense.trueseeing\",\n  ll: \"FFD20.Sense.lowlight\",\n  ls: \"FFD20.Sense.lifesense\",\n  si: \"FFD20.Sense.seeInvis\",\n  sid: \"FFD20.Sense.seeInDark\",\n  sc: \"FFD20.Sense.scent\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * The set of skill which can be trained in PF1\n */\nexport const skills = /** @type {const} */ ({\n  acr: \"FFD20.SkillAcr\" /* Acrobatics */,\n  apr: \"FFD20.SkillApr\" /* Appraise */,\n  blf: \"FFD20.SkillBlf\" /* Bluff */,\n  clm: \"FFD20.SkillClm\" /* Climb */,\n  crf: \"FFD20.SkillCrf\" /* craft skills */,\n  dip: \"FFD20.SkillDip\" /* Diplomacy */,\n  dev: \"FFD20.SkillDev\" /* Disable Device */,\n  dis: \"FFD20.SkillDis\" /* Disguise */,\n  dri: \"FFD20.SkillDri\" /* Drive */,\n  esc: \"FFD20.SkillEsc\" /* Escape Artist */,\n  fly: \"FFD20.SkillFly\" /* Fly */,\n  han: \"FFD20.SkillHan\" /* Handle Animal */,\n  hea: \"FFD20.SkillHea\" /* Heal */,\n  int: \"FFD20.SkillInt\" /* Intimidate */,\n  kar: \"FFD20.SkillKAr\" /* Knowledge (arcana) */,\n  kdu: \"FFD20.SkillKDu\" /* Knowledge (dungeoneering) */,\n  ken: \"FFD20.SkillKEn\" /* Knowledge (engineering) */,\n  kge: \"FFD20.SkillKGe\" /* Knowledge (geography) */,\n  khi: \"FFD20.SkillKHi\" /* Knowledge (history) */,\n  klo: \"FFD20.SkillKLo\" /* Knowledge (local) */,\n  kna: \"FFD20.SkillKNa\" /* Knowledge (nature) */,\n  kno: \"FFD20.SkillKNo\" /* Knowledge (nobility) */,\n  kpl: \"FFD20.SkillKPl\" /* Knowledge (planes) */,\n  kre: \"FFD20.SkillKRe\" /* Knowledge (religion) */,\n  kte: \"FFD20.SkillKTe\" /* Knowledge (technology) */,\n  lin: \"FFD20.SkillLin\" /* Linguistics */,\n  nav: \"FFD20.SkillNav\" /* Navigate */,\n  per: \"FFD20.SkillPer\" /* Perception */,\n  prf: \"FFD20.SkillPrf\" /* Perform */,\n  pil: \"FFD20.SkillPil\" /* Pilot */,\n  pro: \"FFD20.SkillPro\" /* Profession */,\n  rep: \"FFD20.SkillRep\" /* Repair */,\n  rid: \"FFD20.SkillRid\" /* Ride */,\n  sen: \"FFD20.SkillSen\" /* Sense Motive */,\n  slt: \"FFD20.SkillSlt\" /* Sleight of Hand */,\n  spl: \"FFD20.SkillSpl\" /* Spellcraft */,\n  ste: \"FFD20.SkillSte\" /* Stealth */,\n  sur: \"FFD20.SkillSur\" /* Survival */,\n  swm: \"FFD20.SkillSwm\" /* Swim */,\n  umd: \"FFD20.SkillUMD\" /* Use Magic Device */,\n});\n\n/**\n * Compendium journal entries containing details about {@link skills}\n */\nexport const skillCompendiumEntries = /** @type {const} */ ({\n  acr: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.gGfJO90ZuRT4sZ9X\", // Acrobatics\n  apr: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.QGxoGsSIAOoe5dTW\", // Appraise\n  blf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.kRK5XwVBvcMi35w2\", // Bluff\n  clm: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ZAwjVOTwsBpZRgw4\", // Climb\n  crf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.3E8pxbjI8MD3JbfQ\", // craft skills\n  dip: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.uB9Fy36RUjibxqvt\", // Diplomacy\n  dev: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.cSdUATLHBFfw3v4s\", // Disable Device\n  dis: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xg25z3GIpS590NDW\", // Disguise\n  dri: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.EiaJIZVdGDvLxVll\", // Drive\n  esc: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DTNlXXg77s3178WJ\", // Escape Artist\n  fly: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.iH69GIwm8BjecrPN\", // Fly\n  han: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.IrVgSeMcAM8rAh2B\", // Handle Animal\n  hea: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.nHbYSOoe1SzqEO9w\", // Heal\n  int: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.KNn8uxHu23phKC0y\", // Intimidate\n  kar: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (arcana)\n  kdu: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (dungeoneering)\n  ken: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (engineering)\n  kge: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (geography)\n  khi: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (history)\n  klo: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (local)\n  kna: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (nature)\n  kno: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (nobility)\n  kpl: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (planes)\n  kre: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.BWeqgXSZvUQl68vt\", // Knowledge (religion)\n  kte: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ki0QvL0K7u4YuK0O\", // Knowledge (technology)\n  lin: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.SqLm3Deag2FpP8ty\", // Linguistics\n  nav: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.qtwTUimJjHnSjLkp\", // Navigate\n  per: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.2h6hz5AkTDxKPFxr\", // Perception\n  prf: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.emzBKDFNkNnC7N8u\", // Perform\n  pil: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.rVqzliJeSlYj7ewt\", // Pilot\n  pro: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.224EaK0K72NhCeRi\", // Profession\n  rep: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.DWB0xZqtaxOwfd2S\", // Repair\n  rid: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xQbTtefpEfEaOYo7\", // Ride\n  sen: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.ka0VQGItdrWw3paO\", // Sense Motive\n  slt: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.joza8kAIiImrPft7\", // Sleight of Hand\n  spl: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.VRD7jxiIAxKPt6EF\", // Spellcraft\n  ste: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.wRWHk7tCUHR99PzD\", // Stealth\n  sur: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.pLdYavy4nssLEoGV\", // Survival\n  swm: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.xhmDhOXuBbfVcD0Q\", // Swim\n  umd: \"Compendium.ffd20.pf1e-rules.x175kVqUfLGPt8tC.JournalEntryPage.A8j7nF6qHwuGEC2E\", // Use Magic Device\n});\n\n/**\n * An array of {@link skills} that can have arbitrary subskills\n */\nexport const arbitrarySkills = /** @type {const} */ ([\"crf\", \"prf\", \"pro\"]);\n\n/**\n * An array of {@link skills} that are considered background skills.\n */\nexport const backgroundSkills = /** @type {const} */ ([\n  \"apr\",\n  \"crf\",\n  \"han\",\n  \"ken\",\n  \"kge\",\n  \"khi\",\n  \"kno\",\n  \"lin\",\n  \"prf\",\n  \"pro\",\n  \"slt\",\n]);\n\n/**\n * Array of skills that are only shown with background skills optional rule enabled.\n */\nexport const backgroundOnlySkills = /** @type {const} */ ([\"lor\", \"art\"]);\n\n/**\n * Number of background skills per level gained from valid classes.\n *\n * @type {number}\n */\nexport const backgroundSkillsPerLevel = 2;\n\n/**\n * Valid class types to grant background skills.\n */\nexport const backgroundSkillClasses = /** @type {const} */ ([\"base\", \"prestige\"]);\n\n/**\n * Valid class types to grant favored class bonuses.\n *\n * @remarks\n * - Prestige is included due to Favored Prestige Class feat.\n * - NPC is also valid as it is not omitted by any rules about favored class.\n * - Only mythic paths and racial HD are omitted.\n * @see https://www.aonprd.com/Rules.aspx?ID=344\n */\nexport const favoredClassTypes = /** @type {const} */ ([\"base\", \"prestige\", \"npc\"]);\n\n/**\n * Bonus modifier granted to class skills.\n *\n * @type {number}\n */\nexport const classSkillBonus = 3;\n\n/* -------------------------------------------- */\n\nexport const classCasterType = /** @type {const} */ ({\n  astrologian: \"high\",\n  blackmage: \"high\",\n  bluemage: \"high\",\n  geomancer: \"high\",\n  illusionist: \"high\",\n  necromancer: \"high\",\n  summoner: \"high\",\n  timemage: \"high\",\n  whitemage: \"high\",\n  bard: \"med\",\n  cleric: \"med\",\n  redmage: \"med\",\n  scholar: \"med\",\n  darkknight: \"low\",\n  holyknight: \"low\",\n});\n\nexport const spellcasting = /** @type {const} */ ({\n  type: {\n    spontaneous: \"FFD20.UseSpellPoints\",\n    prepared: \"FFD20.SpellPrepPrepared\",\n    hybrid: \"FFD20.SpellPrepHybrid\",\n  },\n  spells: {\n    astrologian: \"FFD20.Spellcasting.Type.Astrologian\",\n    blackmage: \"FFD20.Spellcasting.Type.BlackMage\",\n    bluemage: \"FFD20.Spellcasting.Type.BlueMage\",\n    geomancer: \"FFD20.Spellcasting.Type.Geomancer\",\n    illusionist: \"FFD20.Spellcasting.Type.Illusionist\",\n    necromancer: \"FFD20.Spellcasting.Type.Necromancer\",\n    summoner: \"FFD20.Spellcasting.Type.Summoner\",\n    timemage: \"FFD20.Spellcasting.Type.TimeMage\",\n    whitemage: \"FFD20.Spellcasting.Type.WhiteMage\",\n    bard: \"FFD20.Spellcasting.Type.Bard\",\n    cleric: \"FFD20.Spellcasting.Type.Cleric\",\n    redmage: \"FFD20.Spellcasting.Type.RedMage\",\n    scholar: \"FFD20.Spellcasting.Type.Scholar\",\n    darkknight: \"FFD20.Spellcasting.Type.DarkKnight\",\n    holyknight: \"FFD20.Spellcasting.Type.HolyKnight\",\n  },\n});\n\nexport const spellDescriptors = /** @type {const} */ ({\n  acid: \"FFD20.SpellDescriptors.acid\",\n  air: \"FFD20.SpellDescriptors.air\",\n  chaotic: \"FFD20.SpellDescriptors.chaotic\",\n  cold: \"FFD20.SpellDescriptors.cold\",\n  curse: \"FFD20.SpellDescriptors.curse\",\n  darkness: \"FFD20.SpellDescriptors.darkness\",\n  death: \"FFD20.SpellDescriptors.death\",\n  disease: \"FFD20.SpellDescriptors.disease\",\n  draconic: \"FFD20.SpellDescriptors.draconic\",\n  earth: \"FFD20.SpellDescriptors.earth\",\n  electricity: \"FFD20.SpellDescriptors.electricity\",\n  emotion: \"FFD20.SpellDescriptors.emotion\",\n  evil: \"FFD20.SpellDescriptors.evil\",\n  fear: \"FFD20.SpellDescriptors.fear\",\n  fire: \"FFD20.SpellDescriptors.fire\",\n  force: \"FFD20.SpellDescriptors.force\",\n  good: \"FFD20.SpellDescriptors.good\",\n  languageDependent: \"FFD20.SpellDescriptors.languageDependent\",\n  lawful: \"FFD20.SpellDescriptors.lawful\",\n  light: \"FFD20.SpellDescriptors.light\",\n  meditative: \"FFD20.SpellDescriptors.meditative\",\n  mindAffecting: \"FFD20.SpellDescriptors.mindAffecting\",\n  pain: \"FFD20.SpellDescriptors.pain\",\n  poison: \"FFD20.SpellDescriptors.poison\",\n  ruse: \"FFD20.SpellDescriptors.ruse\",\n  shadow: \"FFD20.SpellDescriptors.shadow\",\n  sonic: \"FFD20.SpellDescriptors.sonic\",\n  water: \"FFD20.SpellDescriptors.water\",\n});\n\nexport const magicAuraByLevel = /** @type {const} */ ({\n  spell: [\n    { power: \"faint\", level: 1 },\n    { power: \"moderate\", level: 4 },\n    { power: \"strong\", level: 7 },\n    { power: \"overwhelming\", level: 10 },\n  ],\n  item: [\n    { power: \"faint\", level: 1 },\n    { power: \"moderate\", level: 6 },\n    { power: \"strong\", level: 12 },\n    { power: \"overwhelming\", level: 21 },\n  ],\n});\n\nexport const auraStrengths = /** @type {const} */ ({\n  1: \"FFD20.Aura.Strength.faint\",\n  2: \"FFD20.Aura.Strength.moderate\",\n  3: \"FFD20.Aura.Strength.strong\",\n  4: \"FFD20.Aura.Strength.overwhelming\",\n});\n\n/* -------------------------------------------- */\n\n/* -------------------------------------------- */\n\n// Weapon Types\nexport const weaponTypes = /** @type {const} */ ({\n  simple: {\n    _label: \"FFD20.Subtypes.Item.weapon.simple.Single\",\n    light: \"FFD20.WeaponSubtypeLight\",\n    \"1h\": \"FFD20.WeaponSubtypeOneHanded\",\n    \"2h\": \"FFD20.WeaponSubtypeTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  martial: {\n    _label: \"FFD20.Subtypes.Item.weapon.martial.Single\",\n    light: \"FFD20.WeaponSubtypeLight\",\n    \"1h\": \"FFD20.WeaponSubtypeOneHanded\",\n    \"2h\": \"FFD20.WeaponSubtypeTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  exotic: {\n    _label: \"FFD20.Subtypes.Item.weapon.exotic.Single\",\n    light: \"FFD20.WeaponSubtypeLight\",\n    \"1h\": \"FFD20.WeaponSubtypeOneHanded\",\n    \"2h\": \"FFD20.WeaponSubtypeTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  firearm: {\n    _label: \"FFD20.Subtypes.Item.weapon.firearm.Single\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  siege: {\n    _label: \"FFD20.Subtypes.Item.weapon.siege.Single\",\n    assault: \"FFD20.WeaponSubtypeAssault\",\n    indirect: \"FFD20.WeaponSubtypeIndirect\",\n    direct: \"FFD20.WeaponSubtypeDirect\",\n  },\n  heavy: {\n    _label: \"FFD20.Subtypes.Item.weapon.heavy.Single\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  chef: {\n    _label: \"FFD20.Subtypes.Item.weapon.chef.Single\",\n    light: \"FFD20.WeaponSubtypeLight\",\n    \"1h\": \"FFD20.WeaponSubtypeOneHanded\",\n    \"2h\": \"FFD20.WeaponSubtypeTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  power: {\n    _label: \"FFD20.Subtypes.Item.weapon.power.Single\",\n    light: \"FFD20.WeaponSubtypeLight\",\n    \"1h\": \"FFD20.WeaponSubtypeOneHanded\",\n    \"2h\": \"FFD20.WeaponSubtypeTwoHanded\",\n    ranged: \"FFD20.WeaponSubtypeRanged\",\n  },\n  misc: {\n    _label: \"FFD20.Subtypes.Item.weapon.misc.Single\",\n    splash: \"FFD20.WeaponTypeSplash\",\n    other: \"FFD20.Other\",\n  },\n});\n\n/**\n * Weapon groups that a weapon can belong to\n */\nexport const weaponGroups = /** @type {const} */ ({\n  axes: \"FFD20.WeaponGroup.axes\",\n  bladesHeavy: \"FFD20.WeaponGroup.bladesHeavy\",\n  bladesLight: \"FFD20.WeaponGroup.bladesLight\",\n  bows: \"FFD20.WeaponGroup.bows\",\n  close: \"FFD20.WeaponGroup.close\",\n  crossbows: \"FFD20.WeaponGroup.crossbows\",\n  double: \"FFD20.WeaponGroup.double\",\n  firearms: \"FFD20.WeaponGroup.firearms\",\n  flails: \"FFD20.WeaponGroup.flails\",\n  hammers: \"FFD20.WeaponGroup.hammers\",\n  monk: \"FFD20.WeaponGroup.monk\",\n  natural: \"FFD20.WeaponGroup.natural\",\n  polearms: \"FFD20.WeaponGroup.polearms\",\n  siegeEngines: \"FFD20.WeaponGroup.siegeEngines\",\n  spears: \"FFD20.WeaponGroup.spears\",\n  thrown: \"FFD20.WeaponGroup.thrown\",\n  tribal: \"FFD20.WeaponGroup.tribal\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Define the set of weapon property flags which can exist on a weapon\n */\nexport const weaponProperties = /** @type {const} */ ({\n  ato: \"FFD20.WeaponProperty.Automatic\",\n  blc: \"FFD20.WeaponProperty.Blocking\",\n  brc: \"FFD20.WeaponProperty.Brace\",\n  dea: \"FFD20.WeaponProperty.Deadly\",\n  dst: \"FFD20.WeaponProperty.Distracting\",\n  dbl: \"FFD20.WeaponProperty.Double\",\n  dis: \"FFD20.WeaponProperty.Disarm\",\n  fin: \"FFD20.WeaponProperty.Finesse\",\n  frg: \"FFD20.WeaponProperty.Fragile\",\n  grp: \"FFD20.WeaponProperty.Grapple\",\n  imp: \"FFD20.WeaponProperty.Improvised\",\n  mnk: \"FFD20.WeaponProperty.Monk\",\n  nnl: \"FFD20.WeaponProperty.NonLethal\",\n  prf: \"FFD20.WeaponProperty.Performance\",\n  rch: \"FFD20.WeaponProperty.Reach\",\n  sct: \"FFD20.WeaponProperty.Scatter\",\n  sma: \"FFD20.WeaponProperty.SemiAutomatic\",\n  slf: \"FFD20.WeaponProperty.SlowFiring\",\n  snd: \"FFD20.WeaponProperty.Sunder\",\n  spc: \"FFD20.WeaponProperty.Special\",\n  thr: \"FFD20.WeaponProperty.Thrown\",\n  trp: \"FFD20.WeaponProperty.Trip\",\n});\n\n/**\n * The components required for casting a spell\n */\nexport const spellComponents = /** @type {const} */ ({\n  verbal: \"FFD20.SpellComponents.Type.verbal.Abbr\",\n  somatic: \"FFD20.SpellComponents.Type.somatic.Abbr\",\n  thought: \"FFD20.SpellComponents.Type.thought.Abbr\",\n  emotion: \"FFD20.SpellComponents.Type.emotion.Abbr\",\n  material: \"FFD20.SpellComponents.Type.material.Abbr\",\n  focus: \"FFD20.SpellComponents.Type.focus.Abbr\",\n  divineFocus: \"FFD20.SpellComponents.Type.divineFocus.Abbr\",\n});\n\n/**\n * Spell schools\n */\nexport const spellSchools = /** @type {const} */ ({\n  crn: \"FFD20.SpellSchools.core.Chronomancy\",\n  drk: \"FFD20.SpellSchools.core.Dark\",\n  ele: \"FFD20.SpellSchools.core.Elemental\",\n  enf: \"FFD20.SpellSchools.core.Enfeebling\",\n  enh: \"FFD20.SpellSchools.core.Enhancing\",\n  heal: \"FFD20.SpellSchools.core.Healing\",\n  ill: \"FFD20.SpellSchools.core.Illusion\",\n  lit: \"FFD20.SpellSchools.core.Light\",\n  nec: \"FFD20.SpellSchools.core.Necromancy\",\n  nel: \"FFD20.SpellSchools.core.NonElemental\",\n  sum: \"FFD20.SpellSchools.core.Summoning\",\n  uni: \"FFD20.SpellSchools.core.Universal\",\n  misc: \"FFD20.SpellSchools.core.Misc\",\n  multi: \"FFD20.SpellSchools.core.multiSchool\"\n});\n/**\n * Spell multi schools\n */\nexport const spellMultischools = /** @type {const} */ ({\n  crn: \"FFD20.SpellSchools.core.Chronomancy\",\n  drk: \"FFD20.SpellSchools.core.Dark\",\n  ele: \"FFD20.SpellSchools.core.Elemental\",\n  enf: \"FFD20.SpellSchools.core.Enfeebling\",\n  enh: \"FFD20.SpellSchools.core.Enhancing\",\n  heal: \"FFD20.SpellSchools.core.Healing\",\n  ill: \"FFD20.SpellSchools.core.Illusion\",\n  lit: \"FFD20.SpellSchools.core.Light\",\n  nec: \"FFD20.SpellSchools.core.Necromancy\",\n  nel: \"FFD20.SpellSchools.core.NonElemental\",\n  sum: \"FFD20.SpellSchools.core.Summoning\",\n  uni: \"FFD20.SpellSchools.core.Universal\",\n  misc: \"FFD20.SpellSchools.core.Misc\",\n});\n\n/**\n * Dictionary of multischools per school\n *\n * @satisfies {Record<keyof typeof spellSchools, Array<keyof typeof spellMultischools>>}\n */\nexport const spellMultischoolsMap = /** @type {const} */ ({\n  crn:  [],\n  drk:  [],\n  ele:  [],\n  enf:  [],\n  enh:  [],\n  heal: [],\n  ill:  [],\n  lit:  [],\n  nec:  [],\n  nel:  [],\n  sum:  [],\n  uni:  [],\n  misc: [],\n  multi: Object.keys(spellMultischools),\n});\n\n\n/**\n * Spell subschools\n */\nexport const spellSubschools = /** @type {const} */ ({\n  charm: \"FFD20.SpellSubschools.charm\",\n  compulsion: \"FFD20.SpellSubschools.compulsion\",\n  divination: \"FFD20.SpellSubschools.divination\",\n  figment: \"FFD20.SpellSubschools.figment\",\n  glamer: \"FFD20.SpellSubschools.glamer\",\n  pattern: \"FFD20.SpellSubschools.pattern\",\n  phantasm: \"FFD20.SpellSubschools.phantasm\",\n  polymorph: \"FFD20.SpellSubschools.polymorph\",\n  scrying: \"FFD20.SpellSubschools.scrying\",\n  shadow: \"FFD20.SpellSubschools.shadow\",\n  teleportation: \"FFD20.SpellSubschools.teleportation\",\n});\n\n/**\n * Dictionary of subschools per school\n *\n * @satisfies {Record<keyof typeof spellSchools, Array<keyof typeof spellSubschools>>}\n */\nexport const spellSubschoolsMap = /** @type {const} */ ({\n  crn:  Object.keys(spellSubschools),\n  drk:  Object.keys(spellSubschools),\n  ele:  Object.keys(spellSubschools),\n  enf:  Object.keys(spellSubschools),\n  enh:  Object.keys(spellSubschools),\n  heal: Object.keys(spellSubschools),\n  ill:  Object.keys(spellSubschools),\n  lit:  Object.keys(spellSubschools),\n  nec:  Object.keys(spellSubschools),\n  nel:  Object.keys(spellSubschools),\n  sum:  Object.keys(spellSubschools),\n  uni:  Object.keys(spellSubschools),\n  misc:  Object.keys(spellSubschools),\n  multi: Object.keys(spellSubschools),\n});\n\n/**\n * Spell levels\n */\nexport const spellLevels = /** @type {const} */ ({\n  0: \"FFD20.SpellLevels.0\",\n  1: \"FFD20.SpellLevels.1\",\n  2: \"FFD20.SpellLevels.2\",\n  3: \"FFD20.SpellLevels.3\",\n  4: \"FFD20.SpellLevels.4\",\n  5: \"FFD20.SpellLevels.5\",\n  6: \"FFD20.SpellLevels.6\",\n  7: \"FFD20.SpellLevels.7\",\n  8: \"FFD20.SpellLevels.8\",\n  9: \"FFD20.SpellLevels.9\",\n});\n\n/* -------------------------------------------- */\n\n/**\n * Condition types for condition immunities and resistances selection\n */\nexport const conditionTypes = /** @type {const} */ ({\n  antagonized: \"FFD20.Condition.antagonized\",\n  berserk: \"FFD20.Condition.berserk\",\n  bleed: \"FFD20.Condition.bleed\",\n  blind: \"FFD20.Condition.blind\",\n  burning: \"FFD20.Condition.burning\",\n  charmed: \"FFD20.Condition.charmed\",\n  confuse: \"FFD20.Condition.confused\",\n  cowering: \"FFD20.Condition.cowering\",\n  cursed: \"FFD20.Condition.cursed\",\n  daze: \"FFD20.Condition.dazed\",\n  dazzle: \"FFD20.Condition.dazzled\",\n  deaf: \"FFD20.Condition.deaf\",\n  deathEffects: \"FFD20.Condition.deathEffects\",\n  deprotect: \"FFD20.Condition.deprotect\",\n  deshell: \"FFD20.Condition.deshell\",\n  dimmed: \"FFD20.Condition.dimmed\",\n  disabled: \"FFD20.Condition.disabled\",\n  disease: \"FFD20.Condition.disease\",\n  doom: \"FFD20.Condition.doom\",\n  drenched: \"FFD20.Condition.drenched\",\n  energyDrain: \"FFD20.Condition.energyDrain\",\n  entangled: \"FFD20.Condition.entangled\",\n  exhausted: \"FFD20.Condition.exhausted\",\n  fascinated: \"FFD20.Condition.fascinated\",\n  fatigue: \"FFD20.Condition.fatigued\",\n  fear: \"FFD20.Condition.fear\",\n  frightened: \"FFD20.Condition.frightened\",\n  frog: \"FFD20.Condition.frog\",\n  frozen: \"FFD20.Condition.frozen\",\n  immobilized: \"FFD20.Condition.immobilized\",\n  imperil: \"FFD20.Condition.imperil\",\n  invisible: \"FFD20.Condition.invisible\",\n  moraleEffects: \"FFD20.Condition.moraleEffects\",\n  mindAffecting: \"FFD20.Condition.mindAffecting\",\n  mini: \"FFD20.Condition.mini\",\n  nauseated: \"FFD20.Condition.nauseated\",\n  panicked: \"FFD20.Condition.panicked\",\n  paralyze: \"FFD20.Condition.paralyzed\",\n  petrify: \"FFD20.Condition.petrified\",\n  poison: \"FFD20.Condition.poison\",\n  polymorph: \"FFD20.Condition.polymorph\",\n  prone: \"FFD20.Condition.prone\",\n  sapped: \"FFD20.Condition.sapped\",\n  shaken: \"FFD20.Condition.shaken\",\n  sicken: \"FFD20.Condition.sickened\",\n  silenced: \"FFD20.Condition.silenced\",\n  sleep: \"FFD20.Condition.sleep\",\n  slow: \"FFD20.Condition.slow\",\n  squalled: \"FFD20.Condition.squalled\",\n  staggered: \"FFD20.Condition.staggered\",\n  static: \"FFD20.Condition.static\",\n  stop: \"FFD20.Condition.stop\",\n  stun: \"FFD20.Condition.stunned\",\n  weighted: \"FFD20.Condition.weighted\",\n  unlucky: \"FFD20.Condition.unlucky\",\n  zombie: \"FFD20.Condition.zombie\",\n});\n\nexport const buffTypes = /** @type {const} */ ({\n  temp: \"FFD20.Subtypes.Item.buff.temp.Single\",\n  spell: \"FFD20.Subtypes.Item.buff.spell.Single\",\n  feat: \"FFD20.Subtypes.Item.buff.feat.Single\",\n  perm: \"FFD20.Subtypes.Item.buff.perm.Single\",\n  item: \"FFD20.Subtypes.Item.buff.item.Single\",\n  misc: \"FFD20.Subtypes.Item.buff.misc.Single\",\n});\n\n/**\n * Formula for determining extra attacks for BAB iteratives\n *\n * @type {string}\n */\nexport const iterativeExtraAttacks = \"min(3, ceil(@bab / 5) - 1)\";\n\n/**\n * Formula for determining attack modifier for BAB iteratives\n *\n * @type {string}\n */\nexport const iterativeAttackModifier = \"@attackCount * -5\";\n\n/**\n * Natural attack configuration.\n *\n * @todo Move more hardcoded definitions here.\n */\nexport const naturalAttacks = /** @type {const} */ ({\n  secondary: {\n    penalty: \"-5\",\n  },\n});\n\n/**\n * Extra Attacks configurations\n *\n * @example\n * Custom additional option\n * ```js\n * ffd20.config.extraAttacks.turboMonk = {\n *   label: \"Turbo Monk\",\n *   iteratives: true,\n *   count: \"floor(@bab / 3)\",\n *   bonus: \"@attackCount * -2\",\n *   manual: true,\n * };\n * ```\n */\nexport const extraAttacks = /** @type {const} */ ({\n  // Standard: BAB iteratives\n  standard: {\n    label: \"FFD20.ExtraAttacks.Standard\",\n    iteratives: true,\n    manual: false,\n    formula: false,\n  },\n  // Advanced: BAB iteratives + manual extra attacks and custom formula\n  advanced: {\n    label: \"FFD20.ExtraAttacks.Advanced\",\n    iteratives: true,\n    manual: true,\n    formula: true,\n  },\n  // Chained Monk's Flurry of Blows\n  // Requires BAB override and class association\n  flurry: {\n    label: \"FFD20.ExtraAttacks.Flurry\",\n    count: \"ceil(@class.level / 7)\",\n    bonus: \"-(@attackSetCount * 5)\",\n    attackName: \"FFD20.ExtraAttacks.FlurryAttack\",\n    flavor: \"FFD20.ExtraAttacks.FlurryFlavor\",\n    modToAll: \"-(@fullAttack * 2)\",\n    iteratives: true,\n    manual: false,\n    formula: false,\n  },\n  // Unchained Monk's Flurry of Blows\n  // Requires class association\n  unflurry: {\n    label: \"FFD20.ExtraAttacks.UnFlurry\",\n    count: \"floor((@class.level + 9) / 10)\",\n    //bonus: \"0\",\n    flavor: \"FFD20.ExtraAttacks.FlurryFlavor\",\n    attackName: \"FFD20.ExtraAttacks.FlurryAttack\",\n    iteratives: true,\n    manual: false,\n    formula: false,\n  },\n  // Custom: No BAB iteratives but with manual extra attacks and custom formula\n  custom: {\n    label: \"FFD20.ExtraAttacks.Custom\",\n    iteratives: false,\n    manual: true,\n    formula: true,\n  },\n});\n\n/**\n * Conditional modifier targets\n *\n * Dictionaries of conditional modifier targets, each with a label and sub-categories\n */\nexport const conditionalTargets = /** @type {const} */ ({\n  attack: {\n    _label: \"FFD20.AttackRollPlural\",\n    allAttack: \"FFD20.All\",\n    hasteAttack: \"FFD20.Haste\",\n    rapidShotAttack: \"FFD20.RapidShot\",\n  },\n  damage: {\n    _label: \"FFD20.Damage\",\n    allDamage: \"FFD20.All\",\n    hasteDamage: \"FFD20.Haste\",\n    rapidShotDamage: \"FFD20.RapidShot\",\n  },\n  size: {\n    _label: \"FFD20.Size\",\n  },\n  critMult: {\n    _label: \"FFD20.CriticalMultiplier\",\n  },\n  effect: {\n    _label: \"FFD20.Effects\",\n  },\n  misc: {\n    _label: \"FFD20.MiscShort\",\n  },\n});\n\n// Default filters to exclude secondary actors\nconst baseActorFilters = () => ({ actor: { exclude: [\"haunt\", \"vehicle\", \"trap\"] } });\n\n/**\n * Change targets\n *\n * Dictionaries of change/buff targets, each with a label and a category it belongs to,\n * as well as a sort value that determines this buffTarget's priority when Changes are applied.\n */\nexport const buffTargets = /** @type {const} */ ({\n  acpA: { label: \"FFD20.ACPArmor\", category: \"misc\", sort: 10000, filters: { ...baseActorFilters() } },\n  acpS: { label: \"FFD20.ACPShield\", category: \"misc\", sort: 11000, filters: { ...baseActorFilters() } },\n  mDexA: { label: \"FFD20.MaxDexArmor\", category: \"misc\", sort: 20000 },\n  mDexS: { label: \"FFD20.MaxDexShield\", category: \"misc\", sort: 21000 },\n  // Ability scores\n  str: { label: \"FFD20.AbilityStr\", category: \"ability\", sort: 30000 },\n  dex: { label: \"FFD20.AbilityDex\", category: \"ability\", sort: 31000 },\n  con: { label: \"FFD20.AbilityCon\", category: \"ability\", sort: 32000 },\n  int: { label: \"FFD20.AbilityInt\", category: \"ability\", sort: 33000 },\n  wis: { label: \"FFD20.AbilityWis\", category: \"ability\", sort: 34000 },\n  cha: { label: \"FFD20.AbilityCha\", category: \"ability\", sort: 35000 },\n  strMod: { label: \"FFD20.AbilityStrMod\", category: \"ability\", sort: 40000 },\n  dexMod: { label: \"FFD20.AbilityDexMod\", category: \"ability\", sort: 41000 },\n  conMod: { label: \"FFD20.AbilityConMod\", category: \"ability\", sort: 42000 },\n  intMod: { label: \"FFD20.AbilityIntMod\", category: \"ability\", sort: 43000 },\n  wisMod: { label: \"FFD20.AbilityWisMod\", category: \"ability\", sort: 44000 },\n  chaMod: { label: \"FFD20.AbilityChaMod\", category: \"ability\", sort: 45000 },\n  strPen: { label: \"FFD20.AbilityStrPen\", category: \"ability\", sort: 50000 },\n  dexPen: { label: \"FFD20.AbilityDexPen\", category: \"ability\", sort: 51000 },\n  conPen: { label: \"FFD20.AbilityConPen\", category: \"ability\", sort: 52000 },\n  intPen: { label: \"FFD20.AbilityIntPen\", category: \"ability\", sort: 53000 },\n  wisPen: { label: \"FFD20.AbilityWisPen\", category: \"ability\", sort: 54000 },\n  chaPen: { label: \"FFD20.AbilityChaPen\", category: \"ability\", sort: 55000 },\n  // Carrying\n  carryStr: { label: \"FFD20.CarryStrength\", category: \"misc\", sort: 60000, filters: { ...baseActorFilters() } },\n  carryMult: { label: \"FFD20.CarryMultiplier\", category: \"misc\", sort: 61000, filters: { ...baseActorFilters() } },\n  // Size\n  size: { label: \"FFD20.Size\", category: \"misc\", sort: 63000, filters: { ...baseActorFilters() }, simple: true },\n  reach: { label: \"FFD20.BuffTarReach\", category: \"misc\", sort: 65000 },\n  // Age\n  ageCategory: { label: \"FFD20.AgeCategory.Base\", category: \"misc\", sort: 62000, filters: { ...baseActorFilters() } },\n  ageCategoryPhysical: {\n    label: \"FFD20.AgeCategory.Physical\",\n    category: \"misc\",\n    sort: 62250,\n    filters: { ...baseActorFilters() },\n  },\n  ageCategoryMental: {\n    label: \"FFD20.AgeCategory.Mental\",\n    category: \"misc\",\n    sort: 62500,\n    filters: { ...baseActorFilters() },\n  },\n  // Skills\n  skills: {\n    label: \"FFD20.BuffTarAllSkills\",\n    category: \"skills\",\n    sort: 75_000, // Specific skills inherit this number and go up from there\n    deferred: true,\n    filters: { ...baseActorFilters() },\n  },\n  unskills: {\n    label: \"FFD20.BuffTarUntrainedSkills\",\n    category: \"skills\",\n    sort: 75_010,\n    deferred: true,\n    filters: { ...baseActorFilters() },\n  },\n  // Ability skills\n  strSkills: { label: \"FFD20.BuffTarStrSkills\", category: \"skills\", sort: 80_100, deferred: true },\n  dexSkills: { label: \"FFD20.BuffTarDexSkills\", category: \"skills\", sort: 80_200, deferred: true },\n  conSkills: { label: \"FFD20.BuffTarConSkills\", category: \"skills\", sort: 80_300, deferred: true },\n  intSkills: { label: \"FFD20.BuffTarIntSkills\", category: \"skills\", sort: 80_400, deferred: true },\n  wisSkills: { label: \"FFD20.BuffTarWisSkills\", category: \"skills\", sort: 80_500, deferred: true },\n  chaSkills: { label: \"FFD20.BuffTarChaSkills\", category: \"skills\", sort: 80_600, deferred: true },\n  // Ability checks\n  allChecks: { label: \"FFD20.BuffTarAllAbilityChecks\", category: \"abilityChecks\", sort: 81_000, deferred: true },\n  strChecks: { label: \"FFD20.BuffTarStrChecks\", category: \"abilityChecks\", sort: 81_100, deferred: true },\n  dexChecks: { label: \"FFD20.BuffTarDexChecks\", category: \"abilityChecks\", sort: 81_200, deferred: true },\n  conChecks: { label: \"FFD20.BuffTarConChecks\", category: \"abilityChecks\", sort: 81_300, deferred: true },\n  intChecks: { label: \"FFD20.BuffTarIntChecks\", category: \"abilityChecks\", sort: 81_400, deferred: true },\n  wisChecks: { label: \"FFD20.BuffTarWisChecks\", category: \"abilityChecks\", sort: 81_500, deferred: true },\n  chaChecks: { label: \"FFD20.BuffTarChaChecks\", category: \"abilityChecks\", sort: 81_600, deferred: true },\n  // Movement\n  landSpeed: { label: \"FFD20.Movement.Mode.land\", category: \"speed\", sort: 90000 },\n  climbSpeed: { label: \"FFD20.Movement.Mode.climb\", category: \"speed\", sort: 91000 },\n  swimSpeed: { label: \"FFD20.Movement.Mode.swim\", category: \"speed\", sort: 92000 },\n  burrowSpeed: { label: \"FFD20.Movement.Mode.burrow\", category: \"speed\", sort: 93000 },\n  flySpeed: { label: \"FFD20.Movement.Mode.fly\", category: \"speed\", sort: 94000 },\n  allSpeeds: { label: \"FFD20.BuffTarAllSpeeds\", category: \"speed\", sort: 95000 },\n  // Defenses\n  ac: { label: \"FFD20.BuffTarACGeneric\", category: \"defense\", sort: 100000 },\n  aac: { label: \"FFD20.BuffTarACArmor\", category: \"defense\", sort: 101000 },\n  sac: { label: \"FFD20.BuffTarACShield\", category: \"defense\", sort: 102000 },\n  nac: { label: \"FFD20.BuffTarACNatural\", category: \"defense\", sort: 103000 },\n  tac: { label: \"FFD20.BuffTarACTouch\", category: \"defense\", sort: 104000 },\n  ffac: { label: \"FFD20.BuffTarACFlatFooted\", category: \"defense\", sort: 105000 },\n  // Offense\n  bab: { label: \"FFD20.BAB\", category: \"attack\", sort: 111000 },\n  \"~attackCore\": { label: \"\", category: \"attack\", sort: 112000 },\n  attack: { label: \"FFD20.BuffTarAllAttackRolls\", category: \"attack\", sort: 110000, deferred: true },\n  wattack: { label: \"FFD20.BuffTarWeaponAttack\", category: \"attack\", sort: 111000, deferred: true },\n  sattack: { label: \"FFD20.BuffTarSpellAttack\", category: \"attack\", sort: 112000, deferred: true },\n  mattack: { label: \"FFD20.BuffTarMeleeAttack\", category: \"attack\", sort: 113000, deferred: true },\n  nattack: { label: \"FFD20.BuffTarNaturalAttack\", category: \"attack\", sort: 114000, deferred: true },\n  rattack: { label: \"FFD20.BuffTarRangedAttack\", category: \"attack\", sort: 115000, deferred: true },\n  tattack: { label: \"FFD20.BuffTarThrownAttack\", category: \"attack\", sort: 116000, deferred: true },\n  // Damage\n  damage: { label: \"FFD20.BuffTarAllDamageRolls\", category: \"damage\", sort: 120000, deferred: true },\n  wdamage: { label: \"FFD20.WeaponDamage\", category: \"damage\", sort: 121000, deferred: true },\n  mwdamage: { label: \"FFD20.MeleeWeaponDamage\", category: \"damage\", sort: 121100, deferred: true },\n  rwdamage: { label: \"FFD20.RangedWeaponDamage\", category: \"damage\", sort: 121200, deferred: true },\n  twdamage: { label: \"FFD20.ThrownWeaponDamage\", category: \"damage\", sort: 121300, deferred: true },\n  rdamage: { label: \"FFD20.AllRangedDamage\", category: \"damage\", sort: 122100, deferred: true },\n  mdamage: { label: \"FFD20.AllMeleeDamage\", category: \"damage\", sort: 122200, deferred: true },\n  ndamage: { label: \"FFD20.NaturalAttackDamage\", category: \"damage\", sort: 123000, deferred: true },\n  sdamage: { label: \"FFD20.SpellDamage\", category: \"damage\", sort: 124000, deferred: true },\n  critConfirm: { label: \"FFD20.CriticalConfirmation\", category: \"attack\", sort: 130000, deferred: true },\n  allSavingThrows: { label: \"FFD20.BuffTarAllSavingThrows\", category: \"savingThrows\", sort: 140000, deferred: true },\n  // Saves\n  fort: { label: \"FFD20.SavingThrowFort\", category: \"savingThrows\", sort: 141000, deferred: true },\n  ref: { label: \"FFD20.SavingThrowRef\", category: \"savingThrows\", sort: 142000, deferred: true },\n  will: { label: \"FFD20.SavingThrowWill\", category: \"savingThrows\", sort: 143000, deferred: true },\n  // Misc\n  cmb: { label: \"FFD20.CMB\", category: \"attack\", sort: 150000 },\n  cmd: { label: \"FFD20.CMD\", category: \"defense\", sort: 151000 },\n  ffcmd: { label: \"FFD20.CMDFlatFooted\", category: \"defense\", sort: 152000 },\n  init: { label: \"FFD20.Initiative\", category: \"misc\", sort: 160000 }, // TODO: Should be deferred\n  mhp: { label: \"FFD20.HitPoints\", category: \"health\", sort: 170000 },\n  wounds: { label: \"FFD20.Wounds\", category: \"health\", sort: 180000, filters: { ...baseActorFilters() } },\n  vigor: { label: \"FFD20.Vigor\", category: \"health\", sort: 181000, filters: { ...baseActorFilters() } },\n  mmp: { label: \"FFD20.ManaPoints\", category: \"health\", sort: 171000 },\n  mprec: { label: \"FFD20.mpRecovery\", category: \"health\", sort: 172000 },\n  spellResist: { label: \"FFD20.SpellResistance\", category: \"defense\", sort: 190000 },\n  bonusFeats: { label: \"FFD20.BuffTarBonusFeats\", category: \"misc\", sort: 200000, filters: { ...baseActorFilters() } },\n  bonusSkillRanks: {\n    label: \"FFD20.BuffTarBonusSkillRanks\",\n    category: \"skills\",\n    sort: 210000,\n    filters: { ...baseActorFilters() },\n  },\n  concentration: {\n    label: \"FFD20.Concentration\",\n    category: \"spell\",\n    sort: 220000,\n    deferred: true,\n    filters: { ...baseActorFilters() },\n  },\n  cl: { label: \"FFD20.CasterLevel\", category: \"spell\", sort: 230000 },\n  dc: { label: \"FFD20.SpellDC\", category: \"spell\", sort: 240000 },\n  // Senses\n  sensedv: { label: \"FFD20.Sense.darkvision\", category: \"senses\", sort: 250000 },\n  sensets: { label: \"FFD20.Sense.tremorsense\", category: \"senses\", sort: 250100 },\n  sensebse: { label: \"FFD20.Sense.blindsense\", category: \"senses\", sort: 250200 },\n  sensebs: { label: \"FFD20.Sense.blindsight\", category: \"senses\", sort: 250300 },\n  sensels: { label: \"FFD20.Sense.lifesense\", category: \"senses\", sort: 250400 },\n  sensesc: { label: \"FFD20.Sense.scent\", category: \"senses\", sort: 250500 },\n  sensetr: { label: \"FFD20.Sense.trueseeing\", category: \"senses\", sort: 250600 },\n});\n\n/**\n * Change target categories\n *\n * Categories grouping related {@link BuffTarget change targets} in the selector UI.\n */\nexport const buffTargetCategories = /** @type {const} */ ({\n  defense: { label: \"FFD20.Defense\" },\n  savingThrows: { label: \"FFD20.SavingThrowPlural\" },\n  attack: { label: \"FFD20.Attack\" },\n  damage: { label: \"FFD20.Damage\" },\n  ability: { label: \"FFD20.AbilityScore\", filters: { ...baseActorFilters() } },\n  abilityChecks: { label: \"FFD20.BuffTarAbilityChecks\", filters: { ...baseActorFilters() } },\n  health: { label: \"FFD20.Health\", filters: { ...baseActorFilters() } },\n  skills: { label: \"FFD20.Skills\", filters: { ...baseActorFilters() } },\n  skill: { label: \"FFD20.BuffTarSpecificSkill\", filters: { ...baseActorFilters() } },\n  speed: { label: \"FFD20.Movement.Speed\" },\n  spell: { label: \"FFD20.BuffTarSpells\", filters: { ...baseActorFilters() } },\n  misc: { label: \"FFD20.Misc\" },\n  senses: { label: \"FFD20.Senses\" },\n});\n\n/**\n * Context Note targets\n */\nexport const contextNoteTargets = /** @type {const} */ ({\n  attack: { label: \"FFD20.AttackRollPlural\", category: \"attacks\" },\n  critical: { label: \"FFD20.CriticalHitPlural\", category: \"attacks\" },\n  effect: { label: \"FFD20.Effects\", category: \"attacks\" },\n  melee: { label: \"FFD20.Melee\", category: \"attacks\" },\n  meleeWeapon: { label: \"FFD20.MeleeWeapon\", category: \"attacks\" },\n  meleeSpell: { label: \"FFD20.MeleeSpell\", category: \"attacks\" },\n  ranged: { label: \"FFD20.Ranged\", category: \"attacks\" },\n  rangedWeapon: { label: \"FFD20.RangedWeapon\", category: \"attacks\" },\n  rangedSpell: { label: \"FFD20.RangedSpell\", category: \"attacks\" },\n  cmb: { label: \"FFD20.CMB\", category: \"attacks\" },\n  allSavingThrows: { label: \"FFD20.BuffTarAllSavingThrows\", category: \"savingThrows\" },\n  fort: { label: \"FFD20.SavingThrowFort\", category: \"savingThrows\" },\n  ref: { label: \"FFD20.SavingThrowRef\", category: \"savingThrows\" },\n  will: { label: \"FFD20.SavingThrowWill\", category: \"savingThrows\" },\n  skills: { label: \"FFD20.BuffTarAllSkills\", category: \"skills\" },\n  strSkills: { label: \"FFD20.BuffTarStrSkills\", category: \"skills\" },\n  dexSkills: { label: \"FFD20.BuffTarDexSkills\", category: \"skills\" },\n  conSkills: { label: \"FFD20.BuffTarConSkills\", category: \"skills\" },\n  intSkills: { label: \"FFD20.BuffTarIntSkills\", category: \"skills\" },\n  wisSkills: { label: \"FFD20.BuffTarWisSkills\", category: \"skills\" },\n  chaSkills: { label: \"FFD20.BuffTarChaSkills\", category: \"skills\" },\n  allChecks: { label: \"FFD20.BuffTarAllAbilityChecks\", category: \"abilityChecks\" },\n  strChecks: { label: \"FFD20.BuffTarStrChecks\", category: \"abilityChecks\" },\n  dexChecks: { label: \"FFD20.BuffTarDexChecks\", category: \"abilityChecks\" },\n  conChecks: { label: \"FFD20.BuffTarConChecks\", category: \"abilityChecks\" },\n  intChecks: { label: \"FFD20.BuffTarIntChecks\", category: \"abilityChecks\" },\n  wisChecks: { label: \"FFD20.BuffTarWisChecks\", category: \"abilityChecks\" },\n  chaChecks: { label: \"FFD20.BuffTarChaChecks\", category: \"abilityChecks\" },\n  spellEffect: { label: \"FFD20.BuffTarSpellEffect\", category: \"spell\" },\n  concentration: { label: \"FFD20.Concentration\", category: \"spell\" },\n  cl: { label: \"FFD20.CasterLevel\", category: \"spell\" },\n  ac: { label: \"FFD20.ACNormal\", category: \"defense\" },\n  cmd: { label: \"FFD20.CMD\", category: \"defense\" },\n  sr: { label: \"FFD20.SpellResistance\", category: \"defense\" },\n  init: { label: \"FFD20.Initiative\", category: \"misc\" },\n  // Speeds\n  landSpeed: { label: \"FFD20.Movement.Mode.land\", category: \"speed\" },\n  climbSpeed: { label: \"FFD20.Movement.Mode.climb\", category: \"speed\" },\n  swimSpeed: { label: \"FFD20.Movement.Mode.swim\", category: \"speed\" },\n  burrowSpeed: { label: \"FFD20.Movement.Mode.burrow\", category: \"speed\" },\n  flySpeed: { label: \"FFD20.Movement.Mode.fly\", category: \"speed\" },\n  allSpeeds: { label: \"FFD20.BuffTarAllSpeeds\", category: \"speed\" },\n});\n\n/**\n * Context Note categories\n */\nexport const contextNoteCategories = /** @type {const} */ ({\n  attacks: { label: \"FFD20.Attacks\" },\n  savingThrows: { label: \"FFD20.SavingThrowPlural\" },\n  skills: { label: \"FFD20.Skills\", filters: { ...baseActorFilters() } },\n  skill: { label: \"FFD20.BuffTarSpecificSkill\", filters: { ...baseActorFilters() } },\n  abilityChecks: { label: \"FFD20.BuffTarAbilityChecks\" },\n  spell: { label: \"FFD20.BuffTarSpells\", filters: { ...baseActorFilters() } },\n  defense: { label: \"FFD20.Defense\" },\n  speed: { label: \"FFD20.Movement.Speed\" },\n  misc: { label: \"FFD20.Misc\" },\n});\n\n/**\n * Change Flag labels\n */\nexport const changeFlags = /** @type {const} */ ({\n  lowLightVision: \"FFD20.ChangeFlags.LowLightVision\",\n  seeInDarkness: \"FFD20.ChangeFlags.SeeInDarkness\",\n  seeInvisibility: \"FFD20.ChangeFlags.SeeInvisibility\",\n  immuneToMorale: \"FFD20.ChangeFlags.ImmuneToMoraleEffects\",\n  loseDexToAC: \"FFD20.ChangeFlags.LoseDexToAC\",\n  noMediumEncumbrance: \"FFD20.ChangeFlags.NoMediumEncumbrance\",\n  noHeavyEncumbrance: \"FFD20.ChangeFlags.NoHeavyEncumbrance\",\n  mediumArmorFullSpeed: \"FFD20.ChangeFlags.MediumArmorFullSpeed\",\n  heavyArmorFullSpeed: \"FFD20.ChangeFlags.HeavyArmorFullSpeed\",\n});\n\n/**\n * A list of Golarion's languages\n */\nexport const languages = /** @type {const} */ ({\n  common: \"FFD20.Language.common\",\n  dwarven: \"FFD20.Language.dwarven\",\n  elvaan: \"FFD20.Language.elvaan\",\n  galkan: \"FFD20.Language.galkan\",\n  lalafellan: \"FFD20.Language.lalafellan\",\n  mithran: \"FFD20.Language.mithran\",\n  moogle: \"FFD20.Language.moogle\",\n  aegyllan: \"FFD20.Language.aegyllan\",\n  albhedian: \"FFD20.Language.albhedian\",\n  banganese: \"FFD20.Language.banganese\",\n  burmecian: \"FFD20.Language.burmecian\",\n  draconic: \"FFD20.Language.draconic\",\n  garif: \"FFD20.Language.garif\",\n  guado: \"FFD20.Language.guado\",\n  hypello: \"FFD20.Language.hypello\",\n  lupin: \"FFD20.Language.lupin\",\n  mandragoran: \"FFD20.Language.mandragoran\",\n  numish: \"FFD20.Language.numish\",\n  qiqirn: \"FFD20.Language.qiqirn\",\n  queran: \"FFD20.Language.queran\",\n  roegadyn: \"FFD20.Language.roegadyn\",\n  ronsaur: \"FFD20.Language.ronsaur\",\n  seeq: \"FFD20.Language.seeq\",\n  tonberry: \"FFD20.Language.tonberry\",\n  vieran: \"FFD20.Language.vieran\",\n  celestial: \"FFD20.Language.celestial\",\n  infernal: \"FFD20.Language.infernal\",\n  abyssal: \"FFD20.Language.abyssal\",\n  aquan: \"FFD20.Language.aquan\",\n  auran: \"FFD20.Language.auran\",\n  auroran: \"FFD20.Language.auroran\",\n  enochian: \"FFD20.Language.enochian\",\n  ignan: \"FFD20.Language.ignan\",\n  terran: \"FFD20.Language.terran\",\n  thorian: \"FFD20.Language.thorian\",\n  umbran: \"FFD20.Language.umbran\",\n  amaljaa: \"FFD20.Language.amaljaa\",\n  antican: \"FFD20.Language.antican\",\n  goblin: \"FFD20.Language.goblin\",\n  kojin: \"FFD20.Language.kojin\",\n  orcish: \"FFD20.Language.orcish\",\n  quadav: \"FFD20.Language.quadav\",\n  sahagin: \"FFD20.Language.sahagin\",\n  sylvan: \"FFD20.Language.sylvan\",\n  undercommon: \"FFD20.Language.undercommon\",\n  vanu: \"FFD20.Language.vanu\",\n  yagudo: \"FFD20.Language.yagudo\",\n});\n\n/**\n * Creature types\n *\n * @type {Record<type, string>}\n */\nexport const creatureTypes = /** @type {const} */ ({\n  aberration: \"FFD20.CreatureTypes.aberration\",\n  animal: \"FFD20.CreatureTypes.animal\",\n  construct: \"FFD20.CreatureTypes.construct\",\n  dragon: \"FFD20.CreatureTypes.dragon\",\n  fey: \"FFD20.CreatureTypes.fey\",\n  humanoid: \"FFD20.CreatureTypes.humanoid\",\n  magicalBeast: \"FFD20.CreatureTypes.magicalBeast\",\n  monstrousHumanoid: \"FFD20.CreatureTypes.monstrousHumanoid\",\n  ooze: \"FFD20.CreatureTypes.ooze\",\n  outsider: \"FFD20.CreatureTypes.outsider\",\n  plant: \"FFD20.CreatureTypes.plant\",\n  undead: \"FFD20.CreatureTypes.undead\",\n  vermin: \"FFD20.CreatureTypes.vermin\",\n});\n\n/**\n * Creature subtypes\n *\n * @type {Record<subtype, string>}\n */\nexport const creatureSubtypes = /** @type {const} */ ({\n  aegyl: \"FFD20.CreatureSubTypes.aegyl\",\n  albhed: \"FFD20.CreatureSubTypes.albhed\",\n  amaljaa: \"FFD20.CreatureSubTypes.amaljaa\",\n  antica: \"FFD20.CreatureSubTypes.antica\",\n  aquatic: \"FFD20.CreatureSubTypes.aquatic\",\n  archfiend: \"FFD20.CreatureSubTypes.archfiend\",\n  aura: \"FFD20.CreatureSubTypes.aura\",\n  avian: \"FFD20.CreatureSubTypes.avian\",\n  bangaa: \"FFD20.CreatureSubTypes.bangaa\",\n  bomb: \"FFD20.CreatureSubTypes.bomb\",\n  boss: \"FFD20.CreatureSubTypes.boss\",\n  burmecian: \"FFD20.CreatureSubTypes.burmecian\",\n  centaur: \"FFD20.CreatureSubTypes.centaur\",\n  cieth: \"FFD20.CreatureSubTypes.cieth\",\n  clockwork: \"FFD20.CreatureSubTypes.clockwork\",\n  daemon: \"FFD20.CreatureSubTypes.daemon\",\n  demon: \"FFD20.CreatureSubTypes.demon\",\n  devil: \"FFD20.CreatureSubTypes.devil\",\n  dracobaltian: \"FFD20.CreatureSubTypes.dracobaltian\",\n  dwarf: \"FFD20.CreatureSubTypes.dwarf\",\n  earth: \"FFD20.CreatureSubTypes.earth\",\n  elemental: \"FFD20.CreatureSubTypes.elemental\",\n  elvaan: \"FFD20.CreatureSubTypes.elvaan\",\n  extraplanar: \"FFD20.CreatureSubTypes.extraplanar\",\n  fire: \"FFD20.CreatureSubTypes.fire\",\n  forgiven: \"FFD20.CreatureSubTypes.forgiven\",\n  galka: \"FFD20.CreatureSubTypes.galka\",\n  garif: \"FFD20.CreatureSubTypes.garif\",\n  garlean: \"FFD20.CreatureSubTypes.garlean\",\n  genome: \"FFD20.CreatureSubTypes.genome\",\n  giant: \"FFD20.CreatureSubTypes.giant\",\n  gnath: \"FFD20.CreatureSubTypes.gnath\",\n  goblin: \"FFD20.CreatureSubTypes.goblin\",\n  goblinoid: \"FFD20.CreatureSubTypes.goblinoid\",\n  gria: \"FFD20.CreatureSubTypes.gria\",\n  guado: \"FFD20.CreatureSubTypes.guado\",\n  halfbreed: \"FFD20.CreatureSubTypes.halfbreed\",\n  halfgigas: \"FFD20.CreatureSubTypes.halfgigas\",\n  holy: \"FFD20.CreatureSubTypes.holy\",\n  humanoid: \"FFD20.CreatureSubTypes.humanoid\",\n  hume: \"FFD20.CreatureSubTypes.hume\",\n  hypello: \"FFD20.CreatureSubTypes.hypello\",\n  ice: \"FFD20.CreatureSubTypes.ice\",\n  immortal: \"FFD20.CreatureSubTypes.immortal\",\n  incorporeal: \"FFD20.CreatureSubTypes.incorporeal\",\n  ixal: \"FFD20.CreatureSubTypes.ixal\",\n  kindred: \"FFD20.CreatureSubTypes.kindred\",\n  kobold: \"FFD20.CreatureSubTypes.kobold\",\n  kojin: \"FFD20.CreatureSubTypes.kojin\",\n  lambkin: \"FFD20.CreatureSubTypes.lambkin\",\n  lamia: \"FFD20.CreatureSubTypes.lamia\",\n  lightning: \"FFD20.CreatureSubTypes.lightning\",\n  livingconstruct: \"FFD20.CreatureSubTypes.livingconstruct\",\n  lizardman: \"FFD20.CreatureSubTypes.lizardman\",\n  loporrit: \"FFD20.CreatureSubTypes.loporrit\",\n  machina: \"FFD20.CreatureSubTypes.machina\",\n  mandragora: \"FFD20.CreatureSubTypes.mandragora\",\n  matanga: \"FFD20.CreatureSubTypes.matanga\",\n  merfolk: \"FFD20.CreatureSubTypes.merfolk\",\n  miniboss: \"FFD20.CreatureSubTypes.miniboss\",\n  mithra: \"FFD20.CreatureSubTypes.mithra\",\n  moogle: \"FFD20.CreatureSubTypes.moogle\",\n  moomba: \"FFD20.CreatureSubTypes.moomba\",\n  namazu: \"FFD20.CreatureSubTypes.namazu\",\n  native: \"FFD20.CreatureSubTypes.native\",\n  nonelemental: \"FFD20.CreatureSubTypes.nonelemental\",\n  numou: \"FFD20.CreatureSubTypes.numou\",\n  orc: \"FFD20.CreatureSubTypes.orc\",\n  palico: \"FFD20.CreatureSubTypes.palico\",\n  primal: \"FFD20.CreatureSubTypes.Primal\",\n  pupu: \"FFD20.CreatureSubTypes.pupu\",\n  qiqirn: \"FFD20.CreatureSubTypes.qiqirn\",\n  qu: \"FFD20.CreatureSubTypes.qu\",\n  quadav: \"FFD20.CreatureSubTypes.quadav\",\n  reptilian: \"FFD20.CreatureSubTypes.reptilian\",\n  roegadyn: \"FFD20.CreatureSubTypes.roegadyn\",\n  ronso: \"FFD20.CreatureSubTypes.ronso\",\n  sahagin: \"FFD20.CreatureSubTypes.sahagin\",\n  seeq: \"FFD20.CreatureSubTypes.seeq\",\n  setolion: \"FFD20.CreatureSubTypes.setolion\",\n  shadow: \"FFD20.CreatureSubTypes.shadow\",\n  shindroid: \"FFD20.CreatureSubTypes.shindroid\",\n  sineater: \"FFD20.CreatureSubTypes.sineater\",\n  superboss: \"FFD20.CreatureSubTypes.superboss\",\n  sylph: \"FFD20.CreatureSubTypes.sylph\",\n  syricta: \"FFD20.CreatureSubTypes.syricta\",\n  tarutaru: \"FFD20.CreatureSubTypes.tarutaru\",\n  tonkin: \"FFD20.CreatureSubTypes.tonkin\",\n  vanuvanu: \"FFD20.CreatureSubTypes.vanuvanu\",\n  varg: \"FFD20.CreatureSubTypes.varg\",\n  viera: \"FFD20.CreatureSubTypes.viera\",\n  water: \"FFD20.CreatureSubTypes.water\",\n  wind: \"FFD20.CreatureSubTypes.wind\",\n  yagudo: \"FFD20.CreatureSubTypes.yagudo\"\n});\n\nexport const spellRangeFormulas = /** @type {const} */ ({\n  close: \"25 + floor(@cl / 2) * 5\",\n  medium: \"100 + @cl * 10\",\n  long: \"400 + @cl * 40\",\n});\n\n/**\n * An array containing the damage dice progression for size adjustments\n *\n * @see {@link ffd20.utils.roll.sizeRoll sizeRoll} function.\n */\nexport const sizeDie = /** @type {const} */ ([\n  \"1\",\n  \"1d2\",\n  \"1d3\",\n  \"1d4\",\n  \"1d6\",\n  \"1d8\",\n  \"1d10\",\n  \"2d6\",\n  \"2d8\",\n  \"3d6\",\n  \"3d8\",\n  \"4d6\",\n  \"4d8\",\n  \"6d6\",\n  \"6d8\",\n  \"8d6\",\n  \"8d8\",\n  \"12d6\",\n  \"12d8\",\n  \"16d6\",\n  \"16d8\",\n]);\n\n/**\n * Arrays of Character Level XP Requirements by XP track\n */\n// prettier-ignore\nexport const CHARACTER_EXP_LEVELS = /** @type {const} */ ({\n  slow: [\n    0,\n    3000,\n    7500,\n    14000,\n    23000,\n    35000,\n    53000,\n    77000,\n    115000,\n    160000,\n    235000,\n    330000,\n    475000,\n    665000,\n    955000,\n    1350000,\n    1900000,\n    2700000,\n    3850000,\n    5350000,\n    8350000,\n    14350000,\n    26350000,\n    50350000,\n    98350000,\n    194350000,\n    386350000,\n    770350000,\n    1538350000,\n    3074350000,\n  ],\n  medium: [\n    0,\n    2000,\n    5000,\n    9000,\n    15000,\n    23000,\n    35000,\n    51000,\n    75000,\n    105000,\n    155000,\n    220000,\n    315000,\n    445000,\n    635000,\n    890000,\n    1300000,\n    1800000,\n    2550000,\n    3600000,\n    5700000,\n    9900000,\n    18300000,\n    35100000,\n    68700000,\n    135900000,\n    270300000,\n    539100000,\n    1076700000,\n    2151900000,\n  ],\n  fast: [\n    0,\n    1300,\n    3300,\n    6000,\n    10000,\n    15000,\n    23000,\n    34000,\n    50000,\n    71000,\n    105000,\n    145000,\n    210000,\n    295000,\n    425000,\n    600000,\n    850000,\n    1200000,\n    1700000,\n    2400000,\n    3800000,\n    6600000,\n    12200000,\n    23400000,\n    45800000,\n    90600000,\n    180200000,\n    359400000,\n    717800000,\n    1434600000,\n  ],\n});\n\n/**\n * An array of Challenge Rating XP Levels\n */\n// prettier-ignore\nexport const CR_EXP_LEVELS = /** @type {const} */ ([\n  200,\n  400,\n  600,\n  800,\n  1200,\n  1600,\n  2400,\n  3200,\n  4800,\n  6400,\n  9600,\n  12800,\n  19200,\n  25600,\n  38400,\n  51200,\n  76800,\n  102400,\n  153600,\n  204800,\n  307200,\n  409600,\n  614400,\n  819200,\n  1228800,\n  1638400,\n  2457600,\n  3276800,\n  4915200,\n  6553600,\n  9830400,\n]);\n\nexport const temporaryRollDataFields = /** @type {const} */ ({\n  actor: [\n    \"d20\",\n    \"attackBonus\",\n    \"attackCount\",\n    \"formulaicAttack\",\n    \"damageBonus\",\n    \"pointBlankBonus\",\n    \"rapidShotPenalty\",\n    \"powerAttackBonus\",\n    \"powerAttackPenalty\",\n    \"conditionals\",\n    \"concentrationBonus\",\n    \"formulaBonus\",\n    \"dcBonus\",\n    \"chargeCostBonus\",\n    \"chargeCost\",\n    \"sizeBonus\",\n    \"bonus\",\n    \"critMult\",\n    \"ablMult\",\n    \"ablDamage\",\n    \"cl\",\n    \"sl\",\n    \"class\",\n    \"ablMod\",\n    \"item\",\n    \"action\",\n    \"level\",\n    \"mod\",\n  ],\n});\n\nexport const traitSelector = /** @type {const} */ ({\n  minChoicesForSearch: 6,\n});\n\nexport const classSubTypes = /** @type {const} */ ({\n  none: \"FFD20.None\",\n  core: \"FFD20.ClassSubType.Core\",\n  coreArc: \"FFD20.ClassSubType.CoreArc\",\n  base: \"FFD20.ClassSubType.Base\",\n  baseArc: \"FFD20.ClassSubType.BaseArc\",\n  hybrid: \"FFD20.ClassSubType.Hybrid\",\n  hybridArc: \"FFD20.ClassSubType.HybridArc\",\n});\n\nexport const countforexp = /** @type {const} */ ({\n  exp: \"FFD20.ClassExp\",\n  noExp: \"FFD20.ClassNoExp\",\n});\n\nexport const classCastingStats = /** @type {const} */ ({\n  noncaster: \"FFD20.ClassMPType.Progression.NonCaster\",\n  int: \"FFD20.AbilityShortInt\",\n  wis: \"FFD20.AbilityShortWis\",\n  cha: \"FFD20.AbilityShortCha\",\n  intAndWis: \"FFD20.AbilityShortIntAndWis\",\n});\n\nexport const classBaseMPTypes = /** @type {const} */ ({\n  noncaster: \"FFD20.ClassMPType.Progression.NonCaster\",\n  halfCaster: \"FFD20.ClassMPType.Progression.HalfCaster\",\n  dimPacman: \"FFD20.ClassMPType.Progression.DimPacman\",\n  pacman: \"FFD20.ClassMPType.Progression.Pacman\",\n  dimFullCaster: \"FFD20.ClassMPType.Progression.DimFullCaster\",\n  fullCaster: \"FFD20.ClassMPType.Progression.FullCaster\",\n  advFullCaster: \"FFD20.ClassMPType.Progression.AdvFullCaster\",\n});\n\n// Current Max Spell Level based on lvl\nexport const ClassSpellLvlProgression = /** @type {const} */ ({\n  noncaster: \"0\",\n  halfCaster: \"min(floor(((@level)-1)/3),4)\",\n  dimPacman: \"min(floor(((@level)+2)/3),6)\",\n  pacman: \"min(floor(((@level)+2)/3),6)\",\n  dimFullCaster: \"min(floor(((@level)+1)/2),9)\",\n  fullCaster: \"min(floor(((@level)+1)/2),9)\",\n  advFullCaster: \"min(floor(((@level)+1)/2),9)\",\n});\n\n// Character MP from levels TODO add other mp bases\n// level        1 2 3 4 5  6  7  8  9 10 11 12 13 14 15 16 17  18  19  20\nexport const classMPlevels = /** @type {const} */ ({\n  noncaster: [0],\n  halfCaster: [0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 14, 16, 19, 22, 25, 29, 33],\n  dimPacman: [1, 2, 3, 4, 5, 6, 8, 10, 12, 15, 18, 21, 25, 29, 33, 38, 43, 48, 53, 58],\n  pacman: [2, 3, 4, 5, 6, 8, 10, 13, 16, 20, 24, 29, 34, 39, 45, 51, 57, 64, 71, 79],\n  dimFullCaster: [2, 3, 4, 5, 6, 8, 11, 15, 20, 24, 29, 35, 42, 49, 56, 65, 74, 83, 92, 101],\n  fullCaster: [3, 4, 5, 6, 8, 11, 15, 20, 26, 32, 39, 47, 56, 65, 75, 86, 98, 110, 122, 135],\n  advFullCaster: [4, 6, 8, 9, 14, 17, 25, 30, 41, 47, 60, 68, 84, 93, 111, 124, 143, 155, 167, 180],\n});\n\n// Character MP from stat\n// stat mod 0 1 2 3  4  5  6  7  8  9 10 11 12  13  14  15  16  17\nexport const classMPStatsBonus = /** @type {const} */ ({\n  1: [0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5],\n  2: [0, 1, 3, 3, 3, 4, 6, 6, 6, 7, 9, 9, 9, 10, 12, 12, 12, 13],\n  3: [0, 1, 3, 6, 6, 7, 9, 12, 12, 13, 15, 18, 18, 19, 21, 24, 24, 25],\n  4: [0, 1, 3, 6, 10, 11, 13, 16, 20, 21, 23, 26, 30, 31, 33, 36, 40, 41],\n  5: [0, 1, 3, 6, 10, 16, 18, 21, 25, 31, 33, 36, 40, 46, 48, 51, 55, 61],\n  6: [0, 1, 3, 6, 10, 16, 24, 27, 31, 37, 45, 48, 52, 58, 66, 69, 73, 79],\n  7: [0, 1, 3, 6, 10, 16, 24, 34, 38, 44, 52, 62, 66, 72, 80, 90, 94, 100],\n  8: [0, 1, 3, 6, 10, 16, 24, 34, 46, 52, 60, 70, 82, 88, 96, 106, 118, 124],\n  9: [0, 1, 3, 6, 10, 16, 24, 34, 46, 61, 69, 79, 91, 106, 114, 124, 136, 151],\n});\n\nexport const bonusMPtest = /** @type {const} */ ({\n  1: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)\",\n  2: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)\",\n  3: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)\",\n  4: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)\",\n  5: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)+max(roundup((@attributes.mpAbility.mod-4)/4)*5,0)\",\n  6: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)+max(roundup((@attributes.mpAbility.mod-4)/4)*5,0)+max(roundup((@attributes.mpAbility.mod-5)/4)*6,0)\",\n  7: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)+max(roundup((@attributes.mpAbility.mod-4)/4)*5,0)+max(roundup((@attributes.mpAbility.mod-5)/4)*6,0)+max(roundup((@attributes.mpAbility.mod-6)/4)*7,0)\",\n  8: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)+max(roundup((@attributes.mpAbility.mod-4)/4)*5,0)+max(roundup((@attributes.mpAbility.mod-5)/4)*6,0)+max(roundup((@attributes.mpAbility.mod-6)/4)*7,0)+max(roundup((@attributes.mpAbility.mod-7)/4)*8,0)\",\n  9: \"max(roundup((@attributes.mpAbility.mod-0)/4)*1,0)+max(roundup((@attributes.mpAbility.mod-1)/4)*2,0)+max(roundup((@attributes.mpAbility.mod-2)/4)*3,0)+max(roundup((@attributes.mpAbility.mod-3)/4)*4,0)+max(roundup((@attributes.mpAbility.mod-4)/4)*5,0)+max(roundup((@attributes.mpAbility.mod-5)/4)*6,0)+max(roundup((@attributes.mpAbility.mod-6)/4)*7,0)+max(roundup((@attributes.mpAbility.mod-7)/4)*8,0)+max(roundup((@attributes.mpAbility.mod-8)/4)*9,0)\",\n});\n\n// to calculate auto mp\nexport const classBaseMPauto = /** @type {const} */ ({\n  no: \"FFD20.No\",\n  yes: \"FFD20.Yes\",\n  half: \"FFD20.Half\",\n});\n\nexport const materia = /** @type {const} */ ({\n  Rarity: {\n    common: \"FFD20.Materia.Rarity.Common\",\n    uncommon: \"FFD20.Materia.Rarity.Uncommon\",\n    rare: \"FFD20.Materia.Rarity.Rare\",\n    legendary: \"FFD20.Materia.Rarity.Legendary\",\n  },\n  RarityMath: {\n    common: 1,\n    uncommon: 2,\n    rare: 3,\n    legendary: 4,\n  },\n  Slot: {\n    unslotted: \"FFD20.Materia.Slot.Unslotted\",\n    weapon: \"FFD20.Materia.Slot.Weapon\",\n    shield: \"FFD20.Materia.Slot.Shield\",\n    armor: \"FFD20.Materia.Slot.Armor\",\n    other: \"FFD20.Materia.Slot.Other\",\n  },\n  Attuned: {\n    unattuned:\"\",\n    attuned: \"\",\n  },\n});\n\n/**\n * Default Item and Actor icons\n *\n * These are returned by `Document.getDefaultArtwork()`\n */\nexport const defaultIcons = /** @type {const} */ ({\n  items: {\n    attack: \"icons/svg/explosion.svg\",\n    buff: \"icons/svg/ice-aura.svg\",\n    class: \"icons/svg/paralysis.svg\",\n    consumable: \"icons/svg/tankard.svg\",\n    container: \"icons/svg/barrel.svg\",\n    equipment: \"icons/svg/combat.svg\",\n    feat: \"icons/svg/book.svg\",\n    loot: \"icons/svg/item-bag.svg\",\n    race: \"icons/svg/wing.svg\",\n    spell: \"icons/svg/daze.svg\",\n    weapon: \"icons/svg/sword.svg\",\n  },\n  actors: {\n    character: \"icons/svg/mystery-man.svg\",\n    npc: \"icons/svg/terror.svg\",\n    haunt: \"icons/svg/stoned.svg\",\n    basic: \"icons/svg/castle.svg\",\n    trap: \"icons/svg/net.svg\",\n    vehicle: \"icons/svg/stone-path.svg\",\n  },\n});\n\n/**\n * Feedback configuration\n *\n * @todo Move this into an actual setting.\n */\nexport const feedback = {\n  /**\n   * Deltas\n   */\n  deltas: {\n    // Hit Points\n    hp: {\n      positive: \"#00FF00\",\n      negative: \"#FF0000\",\n    },\n    // Temporary HP and Temp. Vigor\n    temp: {\n      positive: \"#55FF00\",\n      negative: \"#FF3300\",\n    },\n    // Nonlethal\n    nonlethal: {\n      positive: \"#AA0077\",\n      negative: \"#00AA33\",\n    },\n    // Vigor\n    vigor: {\n      positive: \"#00FF00\",\n      negative: \"#FF0000\",\n    },\n    // Wounds\n    wounds: {\n      positive: \"#00FF00\",\n      negative: \"#FF0000\",\n    },\n    // Negative Levels\n    energyDrain: {\n      positive: \"#00FF00\",\n      negative: \"#FF0000\",\n    },\n    // All ability score changes\n    abilityScore: {\n      positive: \"#00FF00\",\n      negative: \"#FF0000\",\n    },\n  },\n};\n\n/**\n * Sheet item section configuration.\n */\nexport const sheetSections = /** @type {const} */ ({\n  classes: {\n    class: {\n      label: \"FFD20.ClassPlural\",\n      filters: [{ type: \"class\" }],\n      interface: {\n        types: true,\n        level: true,\n        create: true,\n      },\n      browse: { category: \"classes\", classType: \"base\" },\n      create: { type: \"class\", system: { subType: \"base\" } },\n      sort: 1_000,\n    },\n  },\n  combat: {\n    weapon: {\n      label: \"FFD20.InventoryWeapons\",\n      hideEmpty: true,\n      sort: 1_000,\n    },\n    weaponLike: {\n      label: \"FFD20.Subtypes.Item.attack.weapon.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"weapon\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"weapon\", proficient: true } },\n      sort: 1_100,\n    },\n    natural: {\n      label: \"FFD20.Subtypes.Item.attack.natural.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"natural\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"natural\" } },\n      sort: 2_000,\n    },\n    classFeat: {\n      label: \"FFD20.Subtypes.Item.feat.classFeat.Plural\",\n      hideEmpty: true,\n      sort: 3_000,\n    },\n    ability: {\n      label: \"FFD20.Subtypes.Item.attack.ability.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"ability\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"ability\" } },\n      sort: 3_100,\n    },\n    feat: {\n      label: \"FFD20.Subtypes.Item.feat.feat.Plural\",\n      hideEmpty: true,\n      sort: 3_200,\n    },\n    racial: {\n      label: \"FFD20.Subtypes.Item.feat.racial.Plural\",\n      hideEmpty: true,\n      sort: 4_000,\n    },\n    racialAbility: {\n      label: \"FFD20.Subtypes.Item.attack.racialAbility.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"racialAbility\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"racialAbility\" } },\n      sort: 4_100,\n    },\n    spell: {\n      label: \"FFD20.Spells\",\n      hideEmpty: true,\n      sort: 8_000,\n    },\n    item: {\n      label: \"FFD20.Subtypes.Item.attack.item.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"item\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"item\" } },\n      sort: 10_000,\n    },\n    equipment: {\n      label: \"FFD20.InventoryEquipment\",\n      hideEmpty: true,\n      sort: 10_500,\n    },\n    consumable: {\n      label: \"FFD20.InventoryConsumables\",\n      hideEmpty: true,\n      sort: 10_700,\n    },\n    misc: {\n      label: \"FFD20.Subtypes.Item.attack.misc.Plural\",\n      filters: [{ type: \"attack\", subTypes: [\"misc\"] }],\n      interface: {\n        create: true,\n      },\n      create: { type: \"attack\", system: { subType: \"misc\" } },\n      sort: 16_000,\n    },\n  },\n  inventory: {\n    weapon: {\n      label: \"FFD20.InventoryWeapons\",\n      filters: [{ type: \"weapon\" }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: true,\n      },\n      browse: { category: \"items\", type: \"weapon\" },\n      create: { type: \"weapon\", system: { subType: \"simple\" } },\n      sort: 1_000,\n    },\n    armor: {\n      label: \"FFD20.ArmorOrShield\",\n      filters: [{ type: \"equipment\", subTypes: [\"armor\", \"shield\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: true,\n        slots: true,\n      },\n      browse: { category: \"items\", type: \"equipment\", equipmentType: [\"armor\", \"shield\"] },\n      create: { type: \"equipment\", system: { subType: \"armor\", equipmentSubtype: \"lightArmor\", slot: \"\" } },\n      sort: 2_000,\n    },\n    equipment: {\n      label: \"FFD20.InventoryEquipment\",\n      filters: [{ type: \"equipment\", subTypes: [\"wondrous\", \"other\", \"clothing\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: true,\n        slots: true,\n      },\n      browse: { category: \"items\", type: \"equipment\", equipmentType: [\"wondrous\"] },\n      create: { type: \"equipment\", system: { subType: \"wondrous\", slot: \"slotless\" } },\n      sort: 3_000,\n    },\n    materia: {\n      label: \"FFD20.Materia.Label\",\n      filters: [{ type: \"equipment\", subTypes: \"materia\" }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: true,\n        slots: true,\n      },\n      browse: { category: \"items\", type: \"equipment\", equipmentType: [\"materia\"] },\n      create: { type: \"equipment\", system: { subType: \"materia\", equipmentSubtype: \"ability\", slot: \"any\", slotted: \"unslotted\", rarity: \"common\" } },\n      sort: 4_000,\n    },\n    implants: {\n      label: \"FFD20.InventoryImplants\",\n      filters: [{ type: \"implant\" }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: true,\n        slots: true,\n      },\n      labels: {\n        equip: \"FFD20.Implanted\",\n      },\n      browse: { category: \"items\", type: \"implant\" },\n      create: { type: \"implant\", system: { subType: \"cybertech\" } },\n      sort: 4_000,\n    },\n    consumable: {\n      label: \"FFD20.InventoryConsumables\",\n      filters: [{ type: \"consumable\" }],\n      interface: {\n        create: true,\n        actions: true,\n        equip: false,\n      },\n      browse: { category: \"items\", type: \"consumable\" },\n      create: { type: \"consumable\" },\n      sort: 5_000,\n    },\n    gear: {\n      label: \"FFD20.Subtypes.Item.loot.gear.Plural\",\n      filters: [\n        {\n          type: \"loot\",\n          subTypes: [\"gear\", \"adventuring\", \"tool\", \"reagent\", \"remedy\", \"herb\", \"animal\", \"animalGear\"],\n        },\n      ],\n      interface: {\n        create: true,\n        actions: true,\n        equip: () => !ffd20.config.unequippableLoot.includes(\"gear\"),\n      },\n      browse: { category: \"items\", type: \"loot\" },\n      create: { type: \"loot\", system: { subType: \"gear\" } },\n      sort: 6_000,\n    },\n    ammo: {\n      label: \"FFD20.Subtypes.Item.loot.ammo.Plural\",\n      filters: [{ type: \"loot\", subTypes: [\"ammo\"] }],\n      interface: {\n        create: true,\n        actions: false,\n        equip: () => !ffd20.config.unequippableLoot.includes(\"ammo\"),\n      },\n      browse: { category: \"items\", type: \"loot\", lootType: [\"ammo\"] },\n      create: { type: \"loot\", system: { subType: \"ammo\" } },\n      sort: 8_000,\n    },\n    misc: {\n      label: \"FFD20.Subtypes.Item.loot.misc.Plural\",\n      filters: [{ type: \"loot\", subTypes: [\"misc\", \"food\", \"entertainment\", \"vehicle\"] }],\n      interface: {\n        create: true,\n        actions: false,\n        equip: true, // Misc covers more than just misc loot\n      },\n      browse: { category: \"items\", type: \"loot\" },\n      create: { type: \"loot\", system: { subType: \"misc\" } },\n      sort: 9_000,\n    },\n    tradeGoods: {\n      label: \"FFD20.Subtypes.Item.loot.tradeGoods.Plural\",\n      filters: [{ type: \"loot\", subTypes: [\"tradeGoods\", \"treasure\"] }],\n      interface: {\n        create: true,\n        actions: false,\n        equip: () => !ffd20.config.unequippableLoot.includes(\"tradeGoods\"),\n      },\n      browse: { category: \"items\", type: \"loot\", lootType: [\"tradeGoods\"] },\n      create: { type: \"loot\", system: { subType: \"tradeGoods\" } },\n      sort: 15_000,\n    },\n    container: {\n      label: \"FFD20.InventoryContainers\",\n      filters: [{ type: \"container\" }],\n      interface: {\n        create: true,\n        actions: false,\n        equip: true,\n      },\n      browse: { category: \"items\", type: \"container\" },\n      create: { type: \"container\" },\n      sort: 20_000,\n    },\n  },\n  features: {\n    feat: {\n      label: \"FFD20.Subtypes.Item.feat.feat.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"feat\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        types: true,\n      },\n      browse: { category: \"feats\", featType: [\"feat\"] },\n      create: { type: \"feat\", system: { subType: \"feat\" } },\n      sort: 2_000,\n    },\n    classFeat: {\n      label: \"FFD20.Subtypes.Item.feat.classFeat.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"classFeat\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        types: true,\n      },\n      browse: { category: \"feats\", featType: [\"classFeat\"] },\n      create: { type: \"feat\", system: { subType: \"classFeat\" } },\n      sort: 1_000,\n    },\n    trait: {\n      label: \"FFD20.Subtypes.Item.feat.trait.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"trait\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        types: true,\n      },\n      browse: { category: \"feats\", featType: [\"trait\"] },\n      create: { type: \"feat\", system: { subType: \"trait\" } },\n      sort: 3_000,\n    },\n    racial: {\n      label: \"FFD20.Subtypes.Item.feat.racial.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"racial\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        types: true,\n      },\n      browse: { category: \"feats\", featType: [\"racial\"] },\n      create: { type: \"feat\", system: { subType: \"racial\" } },\n      sort: 4_000,\n    },\n    misc: {\n      label: \"FFD20.Subtypes.Item.feat.misc.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"misc\"] }],\n      interface: {\n        create: true,\n        actions: true,\n        types: true,\n      },\n      browse: { category: \"feats\", featType: [\"misc\"] },\n      create: { type: \"feat\", system: { subType: \"misc\" } },\n      sort: 15_000,\n    },\n    template: {\n      label: \"FFD20.Subtypes.Item.feat.template.Plural\",\n      filters: [{ type: \"feat\", subTypes: [\"template\"] }],\n      interface: {\n        create: true,\n        actions: false,\n      },\n      browse: { category: \"feats\", featType: [\"template\"] },\n      create: { type: \"feat\", system: { subType: \"template\" } },\n      sort: 6_000,\n    },\n  },\n  buffs: {\n    feat: {\n      label: \"FFD20.Subtypes.Item.buff.feat.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"feat\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", buffType: [\"feat\"] },\n      create: { type: \"buff\", system: { subType: \"feat\" } },\n      sort: 5_000,\n    },\n    item: {\n      label: \"FFD20.Subtypes.Item.buff.item.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"item\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", buffType: [\"item\"] },\n      create: { type: \"buff\", system: { subType: \"item\" } },\n      sort: 4_000,\n    },\n    misc: {\n      label: \"FFD20.Subtypes.Item.buff.misc.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"misc\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", subTypes: [\"misc\"] },\n      create: { type: \"buff\", system: { subType: \"misc\" } },\n      sort: 10_000,\n    },\n    perm: {\n      label: \"FFD20.Subtypes.Item.buff.perm.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"perm\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", buffType: [\"perm\"] },\n      create: { type: \"buff\", system: { subType: \"perm\" } },\n      sort: 6_000,\n    },\n    spell: {\n      label: \"FFD20.Subtypes.Item.buff.spell.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"spell\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", buffType: [\"spell\"] },\n      create: { type: \"buff\", system: { subType: \"spell\" } },\n      sort: 2_000,\n    },\n    temp: {\n      label: \"FFD20.Subtypes.Item.buff.temp.Plural\",\n      filters: [{ type: \"buff\", subTypes: [\"temp\"] }],\n      interface: {\n        create: true,\n        actions: true,\n      },\n      browse: { category: \"buffs\", buffType: [\"temp\"] },\n      create: { type: \"buff\", system: { subType: \"temp\" } },\n      sort: 1_000,\n    },\n  },\n  // Spells section is not used quite like the others\n  spells: {\n    spell: {\n      interface: {\n        create: true,\n      },\n      browse: { category: \"spells\", level: true },\n      create: { type: \"spell\", system: { school: \"abj\" } },\n    },\n  },\n  // Lite sheet and secondary sheet items\n  combatlite: {\n    attacks: {\n      label: \"FFD20.AbilityPlural\",\n      filters: [{ type: \"attack\" }],\n      interface: {\n        create: true,\n        types: true,\n      },\n      create: { type: \"attack\", system: { subType: \"weapon\", proficient: true } },\n    },\n  },\n  // Misc section is only informal for sheet handling of special cases\n  misc: {\n    race: {\n      create: { type: \"race\" },\n    },\n  },\n});\n\n// Prepare sheet sections with data available later\n// ... allowing module modification also.\nHooks.once(\"setup\", () => {\n  for (const [catKey, category] of Object.entries(sheetSections)) {\n    for (const [sectKey, section] of Object.entries(category)) {\n      section.category = catKey;\n      section.id = sectKey;\n      section.path = `${catKey}.${sectKey}`;\n\n      section.label = game.i18n.localize(section.label);\n\n      const iface = section.interface;\n      if (typeof iface?.equip === \"function\") {\n        iface.equip = iface.equip();\n      }\n    }\n  }\n});\n","/**\n * Action type to change context mapping.\n *\n * @see {@link ffd20.documents.item.ItemPF.prototype.getContextChanges}\n */\nexport const actionTypeToContext = /** @type {const} */ ({\n  mwak: \"mwdamage\",\n  twak: \"twdamage\",\n  rwak: \"rwdamage\",\n  msak: \"sdamage\",\n  rsak: \"sdamage\",\n  spellsave: \"sdamage\",\n});\n\n/**\n * Message visibility\n *\n * Message visibility mode (roll mode) to non-roll message mapping.\n *\n * This will be obsoleted by Foundry ~v13\n */\nexport const messageVisibility = /** @type {const} */ ({\n  publicroll: \"FFD20.Chat.Visibility.Public\",\n  gmroll: \"FFD20.Chat.Visibility.Private\",\n  blindroll: \"FFD20.Chat.Visibility.Blind\",\n  selfroll: \"FFD20.Chat.Visibility.Self\",\n});\n\n/**\n * Movement speed keys\n */\nexport const movementKeys = /** @type {const} */ ([\"land\", \"swim\", \"fly\", \"climb\", \"burrow\"]);\n","/**\n * @typedef {object} FilterChoice\n * @property {string} label - The label for this choice visible to the user; will be localized\n * @property {string} key - The key for this choice used to identify it\n * @property {boolean} [active] - Whether this choice is currently active\n */\n\n/**\n * A basic filter class containing common functionality for all filters.\n *\n * Inheriting classes should define the following static properties: {@link label}, {@link indexField}.\n * Inheriting classes may define the following static properties: {@link type}.\n *\n * @abstract\n */\nexport class BaseFilter {\n  /**\n   * Auto-localize choices.\n   *\n   * Defaults to false due to pre-translation.\n   *\n   * @type {boolean}\n   */\n  static localizeChoices = false;\n\n  /**\n   * Auto-localize filter label\n   *\n   * @type {boolean}\n   */\n  static localizeLabel = true;\n\n  /**\n   * Prefix to add to choices before localization.\n   *\n   * @type {string}\n   */\n  static localizePrefix = \"\";\n\n  /**\n   * The label for this filter visible to the user.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static label = \"\";\n\n  /**\n   * The field this filter checks against its choices.\n   * Will also be added to the `compendiumIndexFields` of the document's `CONFIG` object.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static indexField = \"\";\n\n  /**\n   * A convenience property to define a single `type` this filter applies to.\n   *\n   * @see {@link types}\n   * @see {@link handledTypes}\n   */\n  static type = \"\";\n\n  /**\n   * The `type`s of document this filter applies to.\n   *\n   * @see {Actor#type}\n   * @see {Item#type}\n   * @see {@link handledTypes}\n   * @type {string[]}\n   */\n  static types = [];\n\n  /**\n   * The handlebars template used to render this filter.\n   *\n   * @type {string}\n   */\n  static TEMPLATE = \"\";\n\n  /**\n   * The ID of this filter used to identify it in its browser's filters.\n   *\n   * @type {string}\n   */\n  id;\n\n  /**\n   * A {@link Collection} of {@link FilterChoice}s for this filter.\n   *\n   * @type {Collection<FilterChoice> | null}\n   */\n  choices = null;\n\n  /**\n   * A reference to the {@link CompendiumBrowser} this filter is used in.\n   *\n   * @type {ffd20.applications.compendiumBrowser.CompendiumBrowser | null}\n   */\n  compendiumBrowser = null;\n\n  /**\n   * @param {ffd20.applications.compendiumBrowser.CompendiumBrowser} compendiumBrowser - The compendium browser this filter is used in.\n   */\n  constructor(compendiumBrowser) {\n    this.compendiumBrowser = compendiumBrowser;\n    Object.defineProperty(this, \"id\", { value: foundry.utils.randomID(), writable: false, configurable: false });\n    this.registerIndexFields();\n  }\n\n  /**\n   * The authoritative `Set` of `type`s this filter applies to.\n   *\n   * @type {Set<string>}\n   */\n  static get handledTypes() {\n    return new Set([this.type, ...this.types].filter((type) => type));\n  }\n\n  /**\n   * Whether this filter has any active choices.\n   *\n   * @type {boolean}\n   */\n  get active() {\n    return this.choices?.some((choice) => choice.active) ?? false;\n  }\n\n  /**\n   * The number of active choices.\n   *\n   * @type {number}\n   */\n  get activeChoiceCount() {\n    return this.choices?.filter((choice) => choice.active).length ?? 0;\n  }\n\n  /**\n   * Adds the index fields checked by this filter to the document's `CONFIG` object,\n   * so that {@link CompendiumCollection#getIndex} will include them.\n   */\n  registerIndexFields() {\n    if (!this.compendiumBrowser) return;\n    const documentName = this.compendiumBrowser.constructor.documentName;\n\n    // Fields with double underscore are added in the mapping process and not part of Foundry's index\n    if (this.constructor.indexField.startsWith(\"__\")) return;\n\n    const compendiumIndexFields = CONFIG[documentName]?.compendiumIndexFields;\n    if (\n      compendiumIndexFields &&\n      this.constructor.indexField &&\n      !compendiumIndexFields.includes(this.constructor.indexField)\n    ) {\n      compendiumIndexFields?.push(this.constructor.indexField);\n    }\n  }\n\n  /**\n   * Prepare the filter for use.\n   * This step expects the compendium browser to have gathered its entries.\n   */\n  async setup() {\n    await this.prepareChoices();\n  }\n\n  /**\n   * Prepare the choices for this filter. This is called after the compendium browser has gathered its entries.\n   * By default, this will generate a list of choices from the index field of all entries in the compendium.\n   */\n  prepareChoices() {\n    this.choices = new foundry.utils.Collection();\n  }\n\n  /**\n   * Returns whether this filter has _more than_ the given number of choices.\n   * Defaults to 1, as a single choice allows for no real filtering.\n   *\n   * @param {number} [number=1] - The number of choices to check for\n   * @returns {boolean} - Whether this filter has more than the given number of choices\n   */\n  hasChoices(number = 1) {\n    return this.choices?.size > number;\n  }\n\n  /**\n   * Reset all choices and controls to their default state (inactive)\n   *\n   * @abstract\n   */\n  reset() {}\n\n  /**\n   * Check whether an entry matches this filter.\n   * If the filter is not active, this will always return true.\n   *\n   * @abstract\n   * @param {object} entry - The entry to check against this filter\n   * @returns {boolean} - Whether the entry matches this filter\n   */\n  applyFilter(entry) {}\n\n  /**\n   * Provide data necessary to render this filter.\n   * The data object generated by {@link BaseFilter#getData} contains the minimum data not only required\n   * by the filter itself, but also by the rendering {@link CompendiumBrowser}.\n   *\n   * @returns {object}} The data object for this filter\n   */\n  getData() {\n    return {\n      id: this.id,\n      template: this.constructor.TEMPLATE,\n      label: this.constructor.localizeLabel ? game.i18n.localize(this.constructor.label) : this.constructor.label,\n      active: this.active,\n      activeCount: this.activeChoiceCount,\n      choices: this.choices?.contents ?? [],\n      field: this.constructor.indexField,\n    };\n  }\n\n  /**\n   * Activate event listeners for this filter.\n   *\n   * @abstract\n   * @param {HTMLElement} html - The rendered HTML element for this filter only\n   */\n  activateListeners(html) {}\n}\n","// https://github.com/farzher/fuzzysort v3.0.2\r\n\r\n// UMD (Universal Module Definition) for fuzzysort\r\n;((root, UMD) => {\r\n  if(typeof define === 'function' && define.amd) define([], UMD)\r\n  else if(typeof module === 'object' && module.exports) module.exports = UMD()\r\n  else root['fuzzysort'] = UMD()\r\n})(this, _ => {\r\n  'use strict'\r\n\r\n  var single = (search, target) => {\r\n    if(!search || !target) return NULL\r\n\r\n    var preparedSearch = getPreparedSearch(search)\r\n    if(!isPrepared(target)) target = getPrepared(target)\r\n\r\n    var searchBitflags = preparedSearch.bitflags\r\n    if((searchBitflags & target._bitflags) !== searchBitflags) return NULL\r\n\r\n    return algorithm(preparedSearch, target)\r\n  }\r\n\r\n  var go = (search, targets, options) => {\r\n    if(!search) return options?.all ? all(targets, options) : noResults\r\n\r\n    var preparedSearch = getPreparedSearch(search)\r\n    var searchBitflags = preparedSearch.bitflags\r\n    var containsSpace  = preparedSearch.containsSpace\r\n\r\n    var threshold = denormalizeScore( options?.threshold || 0 )\r\n    var limit     = options?.limit || INFINITY\r\n\r\n    var resultsLen = 0; var limitedCount = 0\r\n    var targetsLen = targets.length\r\n\r\n    function push_result(result) {\r\n      if(resultsLen < limit) { q.add(result); ++resultsLen }\r\n      else {\r\n        ++limitedCount\r\n        if(result._score > q.peek()._score) q.replaceTop(result)\r\n      }\r\n    }\r\n\r\n    // This code is copy/pasted 3 times for performance reasons [options.key, options.keys, no keys]\r\n\r\n    // options.key\r\n    if(options?.key) {\r\n      var key = options.key\r\n      for(var i = 0; i < targetsLen; ++i) { var obj = targets[i]\r\n        var target = getValue(obj, key)\r\n        if(!target) continue\r\n        if(!isPrepared(target)) target = getPrepared(target)\r\n\r\n        if((searchBitflags & target._bitflags) !== searchBitflags) continue\r\n        var result = algorithm(preparedSearch, target)\r\n        if(result === NULL) continue\r\n        if(result._score < threshold) continue\r\n\r\n        result.obj = obj\r\n        push_result(result)\r\n      }\r\n\r\n    // options.keys\r\n    } else if(options?.keys) {\r\n      var keys = options.keys\r\n      var keysLen = keys.length\r\n\r\n      outer: for(var i = 0; i < targetsLen; ++i) { var obj = targets[i]\r\n\r\n        { // early out based on bitflags\r\n          var keysBitflags = 0\r\n          for (var keyI = 0; keyI < keysLen; ++keyI) {\r\n            var key = keys[keyI]\r\n            var target = getValue(obj, key)\r\n            if(!target) { tmpTargets[keyI] = noTarget; continue }\r\n            if(!isPrepared(target)) target = getPrepared(target)\r\n            tmpTargets[keyI] = target\r\n\r\n            keysBitflags |= target._bitflags\r\n          }\r\n\r\n          if((searchBitflags & keysBitflags) !== searchBitflags) continue\r\n        }\r\n\r\n        if(containsSpace) for(let i=0; i<preparedSearch.spaceSearches.length; i++) keysSpacesBestScores[i] = NEGATIVE_INFINITY\r\n\r\n        for (var keyI = 0; keyI < keysLen; ++keyI) {\r\n          target = tmpTargets[keyI]\r\n          if(target === noTarget) { tmpResults[keyI] = noTarget; continue }\r\n\r\n          tmpResults[keyI] = algorithm(preparedSearch, target, /*allowSpaces=*/false, /*allowPartialMatch=*/containsSpace)\r\n          if(tmpResults[keyI] === NULL) { tmpResults[keyI] = noTarget; continue }\r\n\r\n          // todo: this seems weird and wrong. like what if our first match wasn't good. this should just replace it instead of averaging with it\r\n          // if our second match isn't good we ignore it instead of averaging with it\r\n          if(containsSpace) for(let i=0; i<preparedSearch.spaceSearches.length; i++) {\r\n            if(allowPartialMatchScores[i] > -1000) {\r\n              if(keysSpacesBestScores[i] > NEGATIVE_INFINITY) {\r\n                var tmp = (keysSpacesBestScores[i] + allowPartialMatchScores[i]) / 4/*bonus score for having multiple matches*/\r\n                if(tmp > keysSpacesBestScores[i]) keysSpacesBestScores[i] = tmp\r\n              }\r\n            }\r\n            if(allowPartialMatchScores[i] > keysSpacesBestScores[i]) keysSpacesBestScores[i] = allowPartialMatchScores[i]\r\n          }\r\n        }\r\n\r\n        if(containsSpace) {\r\n          for(let i=0; i<preparedSearch.spaceSearches.length; i++) { if(keysSpacesBestScores[i] === NEGATIVE_INFINITY) continue outer }\r\n        } else {\r\n          var hasAtLeast1Match = false\r\n          for(let i=0; i < keysLen; i++) { if(tmpResults[i]._score !== NEGATIVE_INFINITY) { hasAtLeast1Match = true; break } }\r\n          if(!hasAtLeast1Match) continue\r\n        }\r\n\r\n        var objResults = new KeysResult(keysLen)\r\n        for(let i=0; i < keysLen; i++) { objResults[i] = tmpResults[i] }\r\n\r\n        if(containsSpace) {\r\n          var score = 0\r\n          for(let i=0; i<preparedSearch.spaceSearches.length; i++) score += keysSpacesBestScores[i]\r\n        } else {\r\n          // todo could rewrite this scoring to be more similar to when there's spaces\r\n          // if we match multiple keys give us bonus points\r\n          var score = NEGATIVE_INFINITY\r\n          for(let i=0; i<keysLen; i++) {\r\n            var result = objResults[i]\r\n            if(result._score > -1000) {\r\n              if(score > NEGATIVE_INFINITY) {\r\n                var tmp = (score + result._score) / 4/*bonus score for having multiple matches*/\r\n                if(tmp > score) score = tmp\r\n              }\r\n            }\r\n            if(result._score > score) score = result._score\r\n          }\r\n        }\r\n\r\n        objResults.obj = obj\r\n        objResults._score = score\r\n        if(options?.scoreFn) {\r\n          score = options.scoreFn(objResults)\r\n          if(!score) continue\r\n          score = denormalizeScore(score)\r\n          objResults._score = score\r\n        }\r\n\r\n        if(score < threshold) continue\r\n        push_result(objResults)\r\n      }\r\n\r\n    // no keys\r\n    } else {\r\n      for(var i = 0; i < targetsLen; ++i) { var target = targets[i]\r\n        if(!target) continue\r\n        if(!isPrepared(target)) target = getPrepared(target)\r\n\r\n        if((searchBitflags & target._bitflags) !== searchBitflags) continue\r\n        var result = algorithm(preparedSearch, target)\r\n        if(result === NULL) continue\r\n        if(result._score < threshold) continue\r\n\r\n        push_result(result)\r\n      }\r\n    }\r\n\r\n    if(resultsLen === 0) return noResults\r\n    var results = new Array(resultsLen)\r\n    for(var i = resultsLen - 1; i >= 0; --i) results[i] = q.poll()\r\n    results.total = resultsLen + limitedCount\r\n    return results\r\n  }\r\n\r\n\r\n  // this is written as 1 function instead of 2 for minification. perf seems fine ...\r\n  // except when minified. the perf is very slow\r\n  var highlight = (result, open='<b>', close='</b>') => {\r\n    var callback = typeof open === 'function' ? open : undefined\r\n\r\n    var target      = result.target\r\n    var targetLen   = target.length\r\n    var indexes     = result.indexes\r\n    var highlighted = ''\r\n    var matchI      = 0\r\n    var indexesI    = 0\r\n    var opened      = false\r\n    var parts       = []\r\n\r\n    for(var i = 0; i < targetLen; ++i) { var char = target[i]\r\n      if(indexes[indexesI] === i) {\r\n        ++indexesI\r\n        if(!opened) { opened = true\r\n          if(callback) {\r\n            parts.push(highlighted); highlighted = ''\r\n          } else {\r\n            highlighted += open\r\n          }\r\n        }\r\n\r\n        if(indexesI === indexes.length) {\r\n          if(callback) {\r\n            highlighted += char\r\n            parts.push(callback(highlighted, matchI++)); highlighted = ''\r\n            parts.push(target.substr(i+1))\r\n          } else {\r\n            highlighted += char + close + target.substr(i+1)\r\n          }\r\n          break\r\n        }\r\n      } else {\r\n        if(opened) { opened = false\r\n          if(callback) {\r\n            parts.push(callback(highlighted, matchI++)); highlighted = ''\r\n          } else {\r\n            highlighted += close\r\n          }\r\n        }\r\n      }\r\n      highlighted += char\r\n    }\r\n\r\n    return callback ? parts : highlighted\r\n  }\r\n\r\n\r\n  var prepare = (target) => {\r\n    if(typeof target === 'number') target = ''+target\r\n    else if(typeof target !== 'string') target = ''\r\n    var info = prepareLowerInfo(target)\r\n    return new_result(target, {_targetLower:info._lower, _targetLowerCodes:info.lowerCodes, _bitflags:info.bitflags})\r\n  }\r\n\r\n  var cleanup = () => { preparedCache.clear(); preparedSearchCache.clear() }\r\n\r\n\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n  // Below this point is only internal code\r\n\r\n\r\n  class Result {\r\n    get ['indexes']() { return this._indexes.slice(0, this._indexes.len).sort((a,b)=>a-b) }\r\n    set ['indexes'](indexes) { return this._indexes = indexes }\r\n    ['highlight'](open, close) { return highlight(this, open, close) }\r\n    get ['score']() { return normalizeScore(this._score) }\r\n    set ['score'](score) { this._score = denormalizeScore(score) }\r\n  }\r\n\r\n  class KeysResult extends Array {\r\n    get ['score']() { return normalizeScore(this._score) }\r\n    set ['score'](score) { this._score = denormalizeScore(score) }\r\n  }\r\n\r\n  var new_result = (target, options) => {\r\n    const result = new Result()\r\n    result['target']             = target\r\n    result['obj']                = options.obj                   ?? NULL\r\n    result._score                = options._score                ?? NEGATIVE_INFINITY\r\n    result._indexes              = options._indexes              ?? []\r\n    result._targetLower          = options._targetLower          ?? ''\r\n    result._targetLowerCodes     = options._targetLowerCodes     ?? NULL\r\n    result._nextBeginningIndexes = options._nextBeginningIndexes ?? NULL\r\n    result._bitflags             = options._bitflags             ?? 0\r\n    return result\r\n  }\r\n\r\n\r\n  var normalizeScore = score => {\r\n    if(score === NEGATIVE_INFINITY) return 0\r\n    if(score > 1) return score\r\n    return Math.E ** ( ((-score + 1)**.04307 - 1) * -2)\r\n  }\r\n  var denormalizeScore = normalizedScore => {\r\n    if(normalizedScore === 0) return NEGATIVE_INFINITY\r\n    if(normalizedScore > 1) return normalizedScore\r\n    return 1 - Math.pow((Math.log(normalizedScore) / -2 + 1), 1 / 0.04307)\r\n  }\r\n\r\n\r\n  var prepareSearch = (search) => {\r\n    if(typeof search === 'number') search = ''+search\r\n    else if(typeof search !== 'string') search = ''\r\n    search = search.trim()\r\n    var info = prepareLowerInfo(search)\r\n\r\n    var spaceSearches = []\r\n    if(info.containsSpace) {\r\n      var searches = search.split(/\\s+/)\r\n      searches = [...new Set(searches)] // distinct\r\n      for(var i=0; i<searches.length; i++) {\r\n        if(searches[i] === '') continue\r\n        var _info = prepareLowerInfo(searches[i])\r\n        spaceSearches.push({lowerCodes:_info.lowerCodes, _lower:searches[i].toLowerCase(), containsSpace:false})\r\n      }\r\n    }\r\n\r\n    return {lowerCodes: info.lowerCodes, _lower: info._lower, containsSpace: info.containsSpace, bitflags: info.bitflags, spaceSearches: spaceSearches}\r\n  }\r\n\r\n\r\n\r\n  var getPrepared = (target) => {\r\n    if(target.length > 999) return prepare(target) // don't cache huge targets\r\n    var targetPrepared = preparedCache.get(target)\r\n    if(targetPrepared !== undefined) return targetPrepared\r\n    targetPrepared = prepare(target)\r\n    preparedCache.set(target, targetPrepared)\r\n    return targetPrepared\r\n  }\r\n  var getPreparedSearch = (search) => {\r\n    if(search.length > 999) return prepareSearch(search) // don't cache huge searches\r\n    var searchPrepared = preparedSearchCache.get(search)\r\n    if(searchPrepared !== undefined) return searchPrepared\r\n    searchPrepared = prepareSearch(search)\r\n    preparedSearchCache.set(search, searchPrepared)\r\n    return searchPrepared\r\n  }\r\n\r\n\r\n  var all = (targets, options) => {\r\n    var results = []; results.total = targets.length // this total can be wrong if some targets are skipped\r\n\r\n    var limit = options?.limit || INFINITY\r\n\r\n    if(options?.key) {\r\n      for(var i=0;i<targets.length;i++) { var obj = targets[i]\r\n        var target = getValue(obj, options.key)\r\n        if(target == NULL) continue\r\n        if(!isPrepared(target)) target = getPrepared(target)\r\n        var result = new_result(target.target, {_score: target._score, obj: obj})\r\n        results.push(result); if(results.length >= limit) return results\r\n      }\r\n    } else if(options?.keys) {\r\n      for(var i=0;i<targets.length;i++) { var obj = targets[i]\r\n        var objResults = new KeysResult(options.keys.length)\r\n        for (var keyI = options.keys.length - 1; keyI >= 0; --keyI) {\r\n          var target = getValue(obj, options.keys[keyI])\r\n          if(!target) { objResults[keyI] = noTarget; continue }\r\n          if(!isPrepared(target)) target = getPrepared(target)\r\n          target._score = NEGATIVE_INFINITY\r\n          target._indexes.len = 0\r\n          objResults[keyI] = target\r\n        }\r\n        objResults.obj = obj\r\n        objResults._score = NEGATIVE_INFINITY\r\n        results.push(objResults); if(results.length >= limit) return results\r\n      }\r\n    } else {\r\n      for(var i=0;i<targets.length;i++) { var target = targets[i]\r\n        if(target == NULL) continue\r\n        if(!isPrepared(target)) target = getPrepared(target)\r\n        target._score = NEGATIVE_INFINITY\r\n        target._indexes.len = 0\r\n        results.push(target); if(results.length >= limit) return results\r\n      }\r\n    }\r\n\r\n    return results\r\n  }\r\n\r\n\r\n  var algorithm = (preparedSearch, prepared, allowSpaces=false, allowPartialMatch=false) => {\r\n    if(allowSpaces===false && preparedSearch.containsSpace) return algorithmSpaces(preparedSearch, prepared, allowPartialMatch)\r\n\r\n    var searchLower      = preparedSearch._lower\r\n    var searchLowerCodes = preparedSearch.lowerCodes\r\n    var searchLowerCode  = searchLowerCodes[0]\r\n    var targetLowerCodes = prepared._targetLowerCodes\r\n    var searchLen        = searchLowerCodes.length\r\n    var targetLen        = targetLowerCodes.length\r\n    var searchI          = 0 // where we at\r\n    var targetI          = 0 // where you at\r\n    var matchesSimpleLen = 0\r\n\r\n    // very basic fuzzy match; to remove non-matching targets ASAP!\r\n    // walk through target. find sequential matches.\r\n    // if all chars aren't found then exit\r\n    for(;;) {\r\n      var isMatch = searchLowerCode === targetLowerCodes[targetI]\r\n      if(isMatch) {\r\n        matchesSimple[matchesSimpleLen++] = targetI\r\n        ++searchI; if(searchI === searchLen) break\r\n        searchLowerCode = searchLowerCodes[searchI]\r\n      }\r\n      ++targetI; if(targetI >= targetLen) return NULL // Failed to find searchI\r\n    }\r\n\r\n    var searchI = 0\r\n    var successStrict = false\r\n    var matchesStrictLen = 0\r\n\r\n    var nextBeginningIndexes = prepared._nextBeginningIndexes\r\n    if(nextBeginningIndexes === NULL) nextBeginningIndexes = prepared._nextBeginningIndexes = prepareNextBeginningIndexes(prepared.target)\r\n    targetI = matchesSimple[0]===0 ? 0 : nextBeginningIndexes[matchesSimple[0]-1]\r\n\r\n    // Our target string successfully matched all characters in sequence!\r\n    // Let's try a more advanced and strict test to improve the score\r\n    // only count it as a match if it's consecutive or a beginning character!\r\n    var backtrackCount = 0\r\n    if(targetI !== targetLen) for(;;) {\r\n      if(targetI >= targetLen) {\r\n        // We failed to find a good spot for this search char, go back to the previous search char and force it forward\r\n        if(searchI <= 0) break // We failed to push chars forward for a better match\r\n\r\n        ++backtrackCount; if(backtrackCount > 200) break // exponential backtracking is taking too long, just give up and return a bad match\r\n\r\n        --searchI\r\n        var lastMatch = matchesStrict[--matchesStrictLen]\r\n        targetI = nextBeginningIndexes[lastMatch]\r\n\r\n      } else {\r\n        var isMatch = searchLowerCodes[searchI] === targetLowerCodes[targetI]\r\n        if(isMatch) {\r\n          matchesStrict[matchesStrictLen++] = targetI\r\n          ++searchI; if(searchI === searchLen) { successStrict = true; break }\r\n          ++targetI\r\n        } else {\r\n          targetI = nextBeginningIndexes[targetI]\r\n        }\r\n      }\r\n    }\r\n\r\n    // check if it's a substring match\r\n    var substringIndex = searchLen <= 1 ? -1 : prepared._targetLower.indexOf(searchLower, matchesSimple[0]) // perf: this is slow\r\n    var isSubstring = !!~substringIndex\r\n    var isSubstringBeginning = !isSubstring ? false : substringIndex===0 || prepared._nextBeginningIndexes[substringIndex-1] === substringIndex\r\n\r\n    // if it's a substring match but not at a beginning index, let's try to find a substring starting at a beginning index for a better score\r\n    if(isSubstring && !isSubstringBeginning) {\r\n      for(var i=0; i<nextBeginningIndexes.length; i=nextBeginningIndexes[i]) {\r\n        if(i <= substringIndex) continue\r\n\r\n        for(var s=0; s<searchLen; s++) if(searchLowerCodes[s] !== prepared._targetLowerCodes[i+s]) break\r\n        if(s === searchLen) { substringIndex = i; isSubstringBeginning = true; break }\r\n      }\r\n    }\r\n\r\n    // tally up the score & keep track of matches for highlighting later\r\n    // if it's a simple match, we'll switch to a substring match if a substring exists\r\n    // if it's a strict match, we'll switch to a substring match only if that's a better score\r\n\r\n    var calculateScore = matches => {\r\n      var score = 0\r\n\r\n      var extraMatchGroupCount = 0\r\n      for(var i = 1; i < searchLen; ++i) {\r\n        if(matches[i] - matches[i-1] !== 1) {score -= matches[i]; ++extraMatchGroupCount}\r\n      }\r\n      var unmatchedDistance = matches[searchLen-1] - matches[0] - (searchLen-1)\r\n\r\n      score -= (12+unmatchedDistance) * extraMatchGroupCount // penality for more groups\r\n\r\n      if(matches[0] !== 0) score -= matches[0]*matches[0]*.2 // penality for not starting near the beginning\r\n\r\n      if(!successStrict) {\r\n        score *= 1000\r\n      } else {\r\n        // successStrict on a target with too many beginning indexes loses points for being a bad target\r\n        var uniqueBeginningIndexes = 1\r\n        for(var i = nextBeginningIndexes[0]; i < targetLen; i=nextBeginningIndexes[i]) ++uniqueBeginningIndexes\r\n\r\n        if(uniqueBeginningIndexes > 24) score *= (uniqueBeginningIndexes-24)*10 // quite arbitrary numbers here ...\r\n      }\r\n\r\n      score -= (targetLen - searchLen)/2 // penality for longer targets\r\n\r\n      if(isSubstring)          score /= 1+searchLen*searchLen*1 // bonus for being a full substring\r\n      if(isSubstringBeginning) score /= 1+searchLen*searchLen*1 // bonus for substring starting on a beginningIndex\r\n\r\n      score -= (targetLen - searchLen)/2 // penality for longer targets\r\n\r\n      return score\r\n    }\r\n\r\n    if(!successStrict) {\r\n      if(isSubstring) for(var i=0; i<searchLen; ++i) matchesSimple[i] = substringIndex+i // at this point it's safe to overwrite matchehsSimple with substr matches\r\n      var matchesBest = matchesSimple\r\n      var score = calculateScore(matchesBest)\r\n    } else {\r\n      if(isSubstringBeginning) {\r\n        for(var i=0; i<searchLen; ++i) matchesSimple[i] = substringIndex+i // at this point it's safe to overwrite matchehsSimple with substr matches\r\n        var matchesBest = matchesSimple\r\n        var score = calculateScore(matchesSimple)\r\n      } else {\r\n        var matchesBest = matchesStrict\r\n        var score = calculateScore(matchesStrict)\r\n      }\r\n    }\r\n\r\n    prepared._score = score\r\n\r\n    for(var i = 0; i < searchLen; ++i) prepared._indexes[i] = matchesBest[i]\r\n    prepared._indexes.len = searchLen\r\n\r\n    const result    = new Result()\r\n    result.target   = prepared.target\r\n    result._score   = prepared._score\r\n    result._indexes = prepared._indexes\r\n    return result\r\n  }\r\n  var algorithmSpaces = (preparedSearch, target, allowPartialMatch) => {\r\n    var seen_indexes = new Set()\r\n    var score = 0\r\n    var result = NULL\r\n\r\n    var first_seen_index_last_search = 0\r\n    var searches = preparedSearch.spaceSearches\r\n    var searchesLen = searches.length\r\n    var changeslen = 0\r\n\r\n    // Return _nextBeginningIndexes back to its normal state\r\n    var resetNextBeginningIndexes = () => {\r\n      for(let i=changeslen-1; i>=0; i--) target._nextBeginningIndexes[nextBeginningIndexesChanges[i*2 + 0]] = nextBeginningIndexesChanges[i*2 + 1]\r\n    }\r\n\r\n    var hasAtLeast1Match = false\r\n    for(var i=0; i<searchesLen; ++i) {\r\n      allowPartialMatchScores[i] = NEGATIVE_INFINITY\r\n      var search = searches[i]\r\n\r\n      result = algorithm(search, target)\r\n      if(allowPartialMatch) {\r\n        if(result === NULL) continue\r\n        hasAtLeast1Match = true\r\n      } else {\r\n        if(result === NULL) {resetNextBeginningIndexes(); return NULL}\r\n      }\r\n\r\n      // if not the last search, we need to mutate _nextBeginningIndexes for the next search\r\n      var isTheLastSearch = i === searchesLen - 1\r\n      if(!isTheLastSearch) {\r\n        var indexes = result._indexes\r\n\r\n        var indexesIsConsecutiveSubstring = true\r\n        for(let i=0; i<indexes.len-1; i++) {\r\n          if(indexes[i+1] - indexes[i] !== 1) {\r\n            indexesIsConsecutiveSubstring = false; break;\r\n          }\r\n        }\r\n\r\n        if(indexesIsConsecutiveSubstring) {\r\n          var newBeginningIndex = indexes[indexes.len-1] + 1\r\n          var toReplace = target._nextBeginningIndexes[newBeginningIndex-1]\r\n          for(let i=newBeginningIndex-1; i>=0; i--) {\r\n            if(toReplace !== target._nextBeginningIndexes[i]) break\r\n            target._nextBeginningIndexes[i] = newBeginningIndex\r\n            nextBeginningIndexesChanges[changeslen*2 + 0] = i\r\n            nextBeginningIndexesChanges[changeslen*2 + 1] = toReplace\r\n            changeslen++\r\n          }\r\n        }\r\n      }\r\n\r\n      score += result._score / searchesLen\r\n      allowPartialMatchScores[i] = result._score / searchesLen\r\n\r\n      // dock points based on order otherwise \"c man\" returns Manifest.cpp instead of CheatManager.h\r\n      if(result._indexes[0] < first_seen_index_last_search) {\r\n        score -= (first_seen_index_last_search - result._indexes[0]) * 2\r\n      }\r\n      first_seen_index_last_search = result._indexes[0]\r\n\r\n      for(var j=0; j<result._indexes.len; ++j) seen_indexes.add(result._indexes[j])\r\n    }\r\n\r\n    if(allowPartialMatch && !hasAtLeast1Match) return NULL\r\n\r\n    resetNextBeginningIndexes()\r\n\r\n    // allows a search with spaces that's an exact substring to score well\r\n    var allowSpacesResult = algorithm(preparedSearch, target, /*allowSpaces=*/true)\r\n    if(allowSpacesResult !== NULL && allowSpacesResult._score > score) {\r\n      if(allowPartialMatch) {\r\n        for(var i=0; i<searchesLen; ++i) {\r\n          allowPartialMatchScores[i] = allowSpacesResult._score / searchesLen\r\n        }\r\n      }\r\n      return allowSpacesResult\r\n    }\r\n\r\n    if(allowPartialMatch) result = target\r\n    result._score = score\r\n\r\n    var i = 0\r\n    for (let index of seen_indexes) result._indexes[i++] = index\r\n    result._indexes.len = i\r\n\r\n    return result\r\n  }\r\n\r\n  // we use this instead of just .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') because that screws with japanese characters\r\n  var remove_accents = (str) => str.replace(/\\p{Script=Latin}+/gu, match => match.normalize('NFD')).replace(/[\\u0300-\\u036f]/g, '')\r\n\r\n  var prepareLowerInfo = (str) => {\r\n    str = remove_accents(str)\r\n    var strLen = str.length\r\n    var lower = str.toLowerCase()\r\n    var lowerCodes = [] // new Array(strLen)    sparse array is too slow\r\n    var bitflags = 0\r\n    var containsSpace = false // space isn't stored in bitflags because of how searching with a space works\r\n\r\n    for(var i = 0; i < strLen; ++i) {\r\n      var lowerCode = lowerCodes[i] = lower.charCodeAt(i)\r\n\r\n      if(lowerCode === 32) {\r\n        containsSpace = true\r\n        continue // it's important that we don't set any bitflags for space\r\n      }\r\n\r\n      var bit = lowerCode>=97&&lowerCode<=122 ? lowerCode-97 // alphabet\r\n              : lowerCode>=48&&lowerCode<=57  ? 26           // numbers\r\n                                                             // 3 bits available\r\n              : lowerCode<=127                ? 30           // other ascii\r\n              :                                 31           // other utf8\r\n      bitflags |= 1<<bit\r\n    }\r\n\r\n    return {lowerCodes:lowerCodes, bitflags:bitflags, containsSpace:containsSpace, _lower:lower}\r\n  }\r\n  var prepareBeginningIndexes = (target) => {\r\n    var targetLen = target.length\r\n    var beginningIndexes = []; var beginningIndexesLen = 0\r\n    var wasUpper = false\r\n    var wasAlphanum = false\r\n    for(var i = 0; i < targetLen; ++i) {\r\n      var targetCode = target.charCodeAt(i)\r\n      var isUpper = targetCode>=65&&targetCode<=90\r\n      var isAlphanum = isUpper || targetCode>=97&&targetCode<=122 || targetCode>=48&&targetCode<=57\r\n      var isBeginning = isUpper && !wasUpper || !wasAlphanum || !isAlphanum\r\n      wasUpper = isUpper\r\n      wasAlphanum = isAlphanum\r\n      if(isBeginning) beginningIndexes[beginningIndexesLen++] = i\r\n    }\r\n    return beginningIndexes\r\n  }\r\n  var prepareNextBeginningIndexes = (target) => {\r\n    target = remove_accents(target)\r\n    var targetLen = target.length\r\n    var beginningIndexes = prepareBeginningIndexes(target)\r\n    var nextBeginningIndexes = [] // new Array(targetLen)     sparse array is too slow\r\n    var lastIsBeginning = beginningIndexes[0]\r\n    var lastIsBeginningI = 0\r\n    for(var i = 0; i < targetLen; ++i) {\r\n      if(lastIsBeginning > i) {\r\n        nextBeginningIndexes[i] = lastIsBeginning\r\n      } else {\r\n        lastIsBeginning = beginningIndexes[++lastIsBeginningI]\r\n        nextBeginningIndexes[i] = lastIsBeginning===undefined ? targetLen : lastIsBeginning\r\n      }\r\n    }\r\n    return nextBeginningIndexes\r\n  }\r\n\r\n  var preparedCache       = new Map()\r\n  var preparedSearchCache = new Map()\r\n\r\n  // the theory behind these being globals is to reduce garbage collection by not making new arrays\r\n  var matchesSimple = []; var matchesStrict = []\r\n  var nextBeginningIndexesChanges = [] // allows straw berry to match strawberry well, by modifying the end of a substring to be considered a beginning index for the rest of the search\r\n  var keysSpacesBestScores = []; var allowPartialMatchScores = []\r\n  var tmpTargets = []; var tmpResults = []\r\n\r\n  // prop = 'key'                  2.5ms optimized for this case, seems to be about as fast as direct obj[prop]\r\n  // prop = 'key1.key2'            10ms\r\n  // prop = ['key1', 'key2']       27ms\r\n  // prop = obj => obj.tags.join() ??ms\r\n  var getValue = (obj, prop) => {\r\n    var tmp = obj[prop]; if(tmp !== undefined) return tmp\r\n    if(typeof prop === 'function') return prop(obj) // this should run first. but that makes string props slower\r\n    var segs = prop\r\n    if(!Array.isArray(prop)) segs = prop.split('.')\r\n    var len = segs.length\r\n    var i = -1\r\n    while (obj && (++i < len)) obj = obj[segs[i]]\r\n    return obj\r\n  }\r\n\r\n  var isPrepared = (x) => { return typeof x === 'object' && typeof x._bitflags === 'number' }\r\n  var INFINITY = Infinity; var NEGATIVE_INFINITY = -INFINITY\r\n  var noResults = []; noResults.total = 0\r\n  var NULL = null\r\n\r\n  var noTarget = prepare('')\r\n\r\n  // Hacked version of https://github.com/lemire/FastPriorityQueue.js\r\n  var fastpriorityqueue=r=>{var e=[],o=0,a={},v=r=>{for(var a=0,v=e[a],c=1;c<o;){var s=c+1;a=c,s<o&&e[s]._score<e[c]._score&&(a=s),e[a-1>>1]=e[a],c=1+(a<<1)}for(var f=a-1>>1;a>0&&v._score<e[f]._score;f=(a=f)-1>>1)e[a]=e[f];e[a]=v};return a.add=(r=>{var a=o;e[o++]=r;for(var v=a-1>>1;a>0&&r._score<e[v]._score;v=(a=v)-1>>1)e[a]=e[v];e[a]=r}),a.poll=(r=>{if(0!==o){var a=e[0];return e[0]=e[--o],v(),a}}),a.peek=(r=>{if(0!==o)return e[0]}),a.replaceTop=(r=>{e[0]=r,v()}),a}\r\n  var q = fastpriorityqueue() // reuse this\r\n\r\n  // fuzzysort is written this way for minification. all names are mangeled unless quoted\r\n  return {'single':single, 'go':go, 'prepare':prepare, 'cleanup':cleanup}\r\n}) // UMD\r\n","import { BaseFilter } from \"./filters/base.mjs\";\nimport fuzzysort from \"fuzzysort\";\n\n/**\n * The basic compendium browser class allowing the browsing of compendiums by utilising their indexes.\n *\n * Extending classes must define the following static properties if the browser is not meant to browse Item documents: {@link documentName}.\n * Extending classes should define the following static properties: {@link typeName}, {@link filterClasses}.\n *\n * @abstract\n */\nexport class CompendiumBrowser extends Application {\n  /**\n   * The document name of entries this browser displays.\n   *\n   * @abstract\n   * @type {\"Actor\" | \"Item\"}\n   */\n  static documentName = \"Item\";\n\n  /**\n   * A localisation string used in the browser's title.\n   *\n   * @abstract\n   * @type {string}\n   */\n  static typeName;\n\n  /**\n   * An array of classes extending {@link BaseFilter} that should be used for this browser.\n   *\n   * @type {Array<typeof BaseFilter>}\n   */\n  static filterClasses = [];\n\n  /**\n   * The template used to render individual entries in the browser.\n   *\n   * @type {string}\n   */\n  static ENTRY_TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/entries.hbs\";\n\n  /**\n   * A `Promise` that resolves once all pack indexes have been loaded.\n   *\n   * @internal\n   * @type {Map<string, Promise<void>>}\n   */\n  static #indexingPromises = new Map();\n\n  /**\n   * The set of filters to apply to the compendium index.\n   *\n   * @type {Collection<BaseFilter>}\n   */\n  filters = new foundry.utils.Collection();\n\n  /**\n   * The types of entries this browser handles, as per a document's `type` property.\n   *\n   * @type {Set<string>}\n   */\n  handledTypes = new Set();\n\n  /**\n   * Compendium packs this browser gets entries from.\n   *\n   * @type {CompendiumCollection[]}\n   */\n  packs = [];\n\n  /**\n   * A set of filters that were expanded by the user, and should stay expanded upon re-render.\n   *\n   * @type {Set<string>}\n   */\n  expandedFilters = new Set();\n\n  /**\n   * The {@link Collection} of index entries this browser is aware of.\n   *\n   * @readonly\n   * @type {Collection<IndexEntry>}\n   */\n  entries;\n\n  /**\n   * The current search query entered by the user.\n   *\n   * @private\n   * @type {string}\n   */\n  _query = \"\";\n\n  /**\n   * An object containing data used to render the loading spinner and related text.\n   *\n   * @private\n   * @type {object | null}\n   */\n  _loadingInfo = null;\n\n  /**\n   * Whether the browser and its data have been set up using {@link CompendiumBrowser.setup}.\n   *\n   * @private\n   * @internal\n   * @type {boolean}\n   */\n  #setup = false;\n\n  constructor(options = {}) {\n    super(options);\n    /**\n     * All index entries this compendium browser is aware of.\n     *\n     * @type {Collection<object>}\n     */\n    Object.defineProperty(this, \"entries\", { value: new Collection() });\n    this.initialize();\n    this._debouncedRender = foundry.utils.debounce(this.render, 300);\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      template: \"systems/ffd20/templates/apps/compendium-browser/compendium-browser.hbs\",\n      classes: [\"ffd20\", \"app\", \"compendium-browser\"],\n      id: `pf1-compendium-browser-${this.name}`,\n      width: 800,\n      height: window.innerHeight - 60,\n      top: 30,\n      left: 40,\n      resizable: true,\n      scrollY: [\".filter-container\"],\n      dragDrop: [{ dragSelector: \".directory-item\", dropSelector: null }],\n    });\n  }\n\n  /**\n   * Known browsers.\n   *\n   * Initialized in {@link initializeBrowsers}\n   *\n   * @internal\n   */\n  static BROWSERS = {};\n\n  /**\n   * Fill {@link BROWSERS}\n   *\n   * Called in `init` hook.\n   *\n   * @internal\n   */\n  static registerDefault() {\n    this.BROWSERS.items = ffd20.applications.compendiumBrowser.ItemBrowser;\n    this.BROWSERS.feats = ffd20.applications.compendiumBrowser.FeatBrowser;\n    this.BROWSERS.spells = ffd20.applications.compendiumBrowser.SpellBrowser;\n    this.BROWSERS.classes = ffd20.applications.compendiumBrowser.ClassBrowser;\n    this.BROWSERS.races = ffd20.applications.compendiumBrowser.RaceBrowser;\n    this.BROWSERS.bestiary = ffd20.applications.compendiumBrowser.CreatureBrowser;\n    this.BROWSERS.buffs = ffd20.applications.compendiumBrowser.BuffBrowser;\n  }\n\n  /**\n   * Initialize all {@link CompendiumBrowser}s found in {@link ffd20.applications.compendiumBrowser}\n   * and register them in {@link ffd20.applications.compendiums}.\n   */\n  static initializeBrowsers() {\n    const compendiums = ffd20.applications.compendiums;\n    for (const [id, cls] of Object.entries(this.BROWSERS)) {\n      compendiums[id] = new cls();\n    }\n  }\n\n  /**\n   * Request indexes of all packs of a document type to be loaded.\n   * This method should only ever be called as {@link CompendiumBrowser.getIndexes} to ensure Promises are properly bundled.\n   *\n   * @param {string[]} packNames - The names of the packs to load indexes for\n   * @see {@link CompendiumBrowser.#indexingPromise}\n   * @returns {Promise<void>} A `Promise` that resolves once all indexes have been loaded\n   */\n  static getIndexes(packNames = []) {\n    const packs = packNames.map((name) => game.packs.get(name));\n    const resultPromise = [];\n    for (const pack of packs) {\n      if (!this.#indexingPromises.has(pack.collection)) {\n        this.#indexingPromises.set(pack.collection, pack.getIndex());\n      }\n      resultPromise.push(this.#indexingPromises.get(pack.collection));\n    }\n    return Promise.all(resultPromise).finally(() => {\n      for (const pack of packs) {\n        this.#indexingPromises.delete(pack.collection);\n      }\n    });\n  }\n\n  /**\n   * Map an entry from a compendium to the format used by the browser.\n   *\n   * @param {object} entry - The entry to map\n   * @param {CompendiumCollection} pack - The compendium the entry is from\n   * @returns {IndexEntry} The mapped entry\n   */\n  static _mapEntry(entry, pack) {\n    // NOTE: This decouples the entry from the compendium; it will no longer be refreshed automatically, but changes will stick\n    const result = foundry.utils.deepClone(entry);\n    // Add default `system` data for the entry's type, as pruned compendium data omits default values\n    result.system = foundry.utils.mergeObject(game.model[this.documentName][entry.type], result.system, {\n      inplace: false,\n    });\n    // Add `pack` related fields to allow filtering by pack and label display\n    result.__pack = pack.collection;\n    result.__packLabel = pack.metadata.label;\n\n    result.__uuid = pack.getUuid(entry._id);\n    // Prepare `__name` field for fuzzy search optimisation\n    result.__name = fuzzysort.prepare(entry.name.normalize(\"NFKD\"));\n    return result;\n  }\n\n  /**\n   * Renders an array of {@link IndexEntry} objects into HTML.\n   *\n   * @private\n   * @param {IndexEntry[]} entries - The entries to render\n   * @returns {Promise<string>} The rendered HTML\n   */\n  static async _renderEntries(entries) {\n    return renderTemplate(this.ENTRY_TEMPLATE, { entries });\n  }\n\n  /** @inheritDoc */\n  get title() {\n    return game.i18n.format(\"FFD20.CompendiumBrowserTitle\", { type: game.i18n.localize(this.constructor.typeName) });\n  }\n\n  /**\n   * Perform minimal preparation steps to initialize the compendium browser.\n   * Add filters and determine which compendiums include data relevant to this browser.\n   *\n   * @protected\n   */\n  initialize() {\n    this.filters?.clear();\n    for (const cls of this.constructor.filterClasses) {\n      if (!(cls.prototype instanceof BaseFilter)) {\n        throw new Error(`Filter class ${cls.name} does not extend BaseFilter`);\n      }\n      const filter = new cls(this);\n      this.filters.set(filter.id, filter);\n      // Add all types handled by that filter to the browser's list of handled types\n      cls.handledTypes.forEach((type) => this.handledTypes.add(type));\n    }\n    this.packs = game.packs.filter((pack) => this.isPackIncluded(pack));\n    this._loadingInfo = {\n      indexCount: this.packs.length,\n      entryCount: this.packs.reduce(\n        (acc, pack) => acc + pack.index.contents.filter((entry) => this.handledTypes.has(entry.type)).length,\n        0\n      ),\n    };\n  }\n\n  /**\n   * Enable queued filters\n   *\n   * @internal\n   * @experimental\n   */\n  _activateFilterQueue() {\n    if (!this.#setup) return;\n\n    if (!this.#filterQueue) return;\n\n    // Disable existing filters\n    for (const filter of this.filters) {\n      for (const choice of filter.choices) choice.active = false;\n    }\n\n    const idToFilter = {\n      type: \"ItemTypeFilter\",\n      level: \"SpellLevelFilter\",\n      class: \"SpellLearnedByClassFilter\",\n      classType: \"ClassTypeFilter\",\n      buffType: \"BuffTypeFilter\",\n      featType: \"FeatTypeFilter\",\n      lootType: \"MiscItemTypeFilter\",\n      equipmentType: \"EquipmentTypeFilter\",\n      tags: \"TagFilter\",\n    };\n\n    for (const [filterId, choices] of Object.entries(this.#filterQueue)) {\n      const filterName = idToFilter[filterId];\n      const filter = this.filters.find((f) => f.constructor.name === filterName);\n      if (!filter) {\n        console.warn(`Filter \"${filterId}\" not found.`);\n        continue;\n      }\n\n      for (const [key, choice] of filter.choices.entries()) {\n        choice.active = choices.includes(key);\n        if (choice.active) this.expandedFilters.add(filter.id);\n      }\n    }\n\n    this.#filterQueue = null;\n  }\n\n  #filterQueue;\n  /**\n   * Queue filters to be processed by {@link _activateFilterQueue}\n   *\n   * Only one filter bundle is ever queued.\n   *\n   * @internal\n   * @param {object} filters\n   * @experimental\n   */\n  _queueFilters(filters) {\n    this.#filterQueue = filters;\n  }\n\n  /**\n   * Check whether a compendium should be included in the browser.\n   *\n   * @param {CompendiumCollection} pack - The compendium to test\n   * @returns {boolean} Whether the compendium should be included\n   */\n  isPackIncluded(pack) {\n    // Only include enabled packs with the right document type made for FFD20\n    if (pack.config.ffd20?.disabled) return false;\n    if (pack.documentName !== this.constructor.documentName) return false;\n    if (pack.metadata.system !== game.system.id) return false;\n\n    // Skip if pack is not visible to current user\n    if (!pack.visible) return false;\n\n    // Avoid unnecessarily adding packs that don't contain any relevant entries\n    if (pack.index.contents.filter((entry) => this.handledTypes.has(entry.type)).length === 0) return false;\n\n    // Don't skip the compendium\n    return true;\n  }\n\n  /**\n   * Perform the initial setup of the compendium browser.\n   * This includes requesting the index of all relevant compendiums if necessary and preparing the filters.\n   *\n   * @returns {Promise<void>}\n   */\n  async setup() {\n    this.#setup = false;\n    this.entries?.clear();\n    await CompendiumBrowser.getIndexes(this.packs.map((pack) => pack.collection));\n    const unorderedEntries = await Promise.all(this.packs.map((pack) => this.loadPackIndex(pack)));\n    ffd20.utils\n      .naturalSort(unorderedEntries.flat(), \"name\")\n      .forEach((entry) => this.entries.set(`${entry.__uuid}`, entry));\n    await Promise.all(this.filters.map((filter) => filter.setup()));\n    this.#setup = true;\n  }\n\n  /**\n   * Load a compendium's index to prepare it for browsing.\n   *\n   * @param {CompendiumCollection} pack - The compendium to load\n   * @returns {Promise<IndexEntry[]>} The loaded index entries\n   */\n  async loadPackIndex(pack) {\n    if (pack.indexed === false) await CompendiumBrowser.getIndexes(pack.collection);\n    const index = pack.index;\n    return index\n      .filter((entry) => this.handledTypes.has(entry.type))\n      .map((entry) => {\n        try {\n          return this.constructor._mapEntry(entry, pack);\n        } catch (err) {\n          Hooks.onError(`CompendiumBrowser#_mapEntry`, err, {\n            msg: `${this.constructor.name} failed to map entry ${entry.name} [${entry._id}] from pack ${pack.collection}`,\n            log: \"error\",\n            entry,\n            pack,\n          });\n          return null;\n        }\n      })\n      .filter((entry) => entry !== null);\n  }\n\n  /**\n   * Get the current set of entries allowed by the filters.\n   *\n   * @returns {IndexEntry[]} The filtered entries\n   */\n  getFilteredEntries() {\n    let entries = this.entries.contents;\n\n    const activeFilters = this.filters.filter((filter) => filter.active);\n    if (activeFilters.length)\n      entries = entries.filter((entry) => activeFilters.every((filter) => filter.applyFilter(entry)));\n\n    if (this._query) {\n      const collator = new Intl.Collator(game.settings.get(\"core\", \"language\"), {\n        numeric: true,\n        ignorePunctuation: true,\n      });\n      entries = fuzzysort\n        .go(this._query.normalize(\"NFKD\"), entries, { key: \"__name\", threshold: -10000 })\n        .sort((a, b) => {\n          // Sort by score first, then alphabetically by name\n          if (a.score !== b.score) return b.score - a.score;\n          else return collator.compare(a.obj.name, b.obj.name);\n        })\n        .map((match) => match.obj);\n    }\n\n    return entries;\n  }\n\n  /** @inheritdoc */\n  async _render(force, options) {\n    // Identify the focused element\n    const focus = this.element?.[0]?.querySelector(\":focus\");\n    const selectionStart = focus?.selectionStart;\n\n    // Render the application and restore focus\n    await super._render(force, options);\n    if (focus && focus.name) {\n      const input = this._element[0].querySelector(`[name=\"${focus.name}\"]`);\n      if (input && input.focus instanceof Function) {\n        input.focus();\n        if (selectionStart) input.selectionStart = input.selectionEnd = selectionStart;\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  async getData() {\n    const context = await super.getData();\n\n    this._activateFilterQueue();\n\n    context.id = this.options.id;\n    context.query = this._query ?? \"\";\n    context.filters = this.filters\n      .filter((filter) => filter.hasChoices())\n      .map((filter) => ({\n        ...filter.getData(),\n        collapsed: this.expandedFilters.has(filter.id) ? \"\" : \"collapsed\",\n      }));\n\n    if (this.#setup) {\n      // Browser is set up, so we can render the entries\n      this._entries = this.getFilteredEntries();\n      context.entries = this._entries.slice(0, 100);\n      context.itemCount = this.entries.size;\n      context.filteredItemCount = this._entries.length;\n    } else {\n      // Browser is not set up, display a loading spinner\n      context.loading = true;\n      context.loadingInfo = this._loadingInfo;\n    }\n    return context;\n  }\n\n  _refocus = true;\n  /** @inheritDoc */\n  activateListeners(html) {\n    super.activateListeners(html);\n    /** @type {HTMLElement} */\n    const el = html[0];\n\n    if (this._priorState <= this.constructor.RENDER_STATES.NONE) this._refocus = true;\n\n    // If the browser is not set up yet, start the process and render again once it is done\n    if (!this.#setup) {\n      this.setup().then(() => this.render());\n      // No listeners have to be activated yet, so we can return here\n      return;\n    }\n\n    // Fix autofocus (the above re-render breaks it)\n    if (this._refocus) {\n      el.querySelector(\"[autofocus]\")?.focus();\n      this._refocus = false;\n    }\n\n    this._initLazyScrolling(el);\n\n    // Activate listeners for filters, allowing them to define their own\n    el.querySelectorAll(\".filter-content\").forEach((filterContent) => {\n      const filter = this.filters.get(filterContent.closest(\".filter\").dataset.filterId);\n      filter.activateListeners(filterContent);\n    });\n\n    el.querySelector(\".directory-list\").addEventListener(\"click\", (event) => {\n      this._onClickEntry(event);\n    });\n\n    el.querySelector(\"button.reload\").addEventListener(\"click\", (event) => {\n      this._onReload(event);\n    });\n\n    el.querySelector(\"button.clear-filters\").addEventListener(\"click\", (event) => {\n      this._onClearFilters(event);\n    });\n\n    el.querySelectorAll(\".filter>h3\").forEach((header) => {\n      header.addEventListener(\"click\", (event) => {\n        this._onFilterHeaderClick(event);\n      });\n    });\n\n    el.querySelector(\"input[name=filter]\")?.addEventListener(\"input\", (event) => {\n      this._onCustomSearchFilter(event);\n    });\n\n    ContextMenu.create(this, html, \".directory-item\", this._getEntryContextOptions());\n  }\n\n  /**\n   * Store the current search filter query and re-render the application.\n   *\n   * @private\n   * @param {Event} event - The originating change event\n   */\n  _onCustomSearchFilter(event) {\n    event.preventDefault();\n    this._query = event.target.value;\n    this._debouncedRender();\n  }\n\n  /**\n   * Handle a click on an entry in the compendium browser.\n   *\n   * @private\n   * @param {Event} event - The originating click Event\n   */\n  async _onClickEntry(event) {\n    const li = event.target.closest(\".directory-item\");\n    if (!li) return;\n    const { uuid } = li.dataset;\n    const document = await fromUuid(uuid);\n    const collection = game.packs.get(document.pack);\n    return document.sheet.render(true, { editable: game.user.isGM && !collection.locked, focus: true });\n  }\n\n  /**\n   * Get the set of ContextMenu options which should be used for the compendium browser's entries.\n   *\n   * @protected\n   * @returns {object[]} - The Array of ContextMenu options\n   */\n  _getEntryContextOptions() {\n    return [\n      {\n        name: \"COMPENDIUM.ImportEntry\",\n        icon: '<i class=\"fa-solid fa-download\"></i>',\n        condition: () => getDocumentClass(this.constructor.documentName).canUserCreate(game.user),\n        callback: async (li) => {\n          const collection = game.collections.get(this.constructor.documentName);\n          const uuid = li.data(\"uuid\");\n          const entry = this.entries.get(uuid);\n          return collection.importFromCompendium(game.packs.get(entry.__pack), entry._id, {}, { renderSheet: true });\n        },\n      },\n      {\n        name: \"FFD20.CopyUuidToClipboard\",\n        icon: '<i class=\"fa-solid fa-id-badge\"></i>',\n        callback: (li) => {\n          const uuid = li.data(\"uuid\");\n          game.clipboard.copyPlainText(uuid);\n          const label = game.i18n.localize(getDocumentClass(this.constructor.documentName).metadata.label);\n          ui.notifications.info(game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label, type: \"uuid\", id: uuid }));\n        },\n      },\n    ];\n  }\n\n  /** @inheritDoc */\n  _canDragStart(selector) {\n    return true;\n  }\n\n  /** @inheritDoc */\n  _onDragStart(event) {\n    const { uuid } = event.currentTarget.dataset;\n    event.dataTransfer.setData(\n      \"text/plain\",\n      JSON.stringify({\n        type: this.constructor.documentName,\n        uuid,\n      })\n    );\n\n    const html = this.element[0];\n    // Without the delay the following blocks the drag start\n    setTimeout(() => html.classList.add(\"active-drag\"), 0);\n    document.body.addEventListener(\"dragend\", () => html.classList.remove(\"active-drag\"), {\n      once: true,\n      passive: true,\n    });\n  }\n\n  /**\n   * Handle a click on the reset filters button, resetting all filters to their default state.\n   *\n   * @private\n   * @param {Event} _event - The originating click event\n   */\n  _onClearFilters(_event) {\n    for (const filter of this.filters) {\n      filter.reset();\n    }\n    this._query = \"\";\n    this.expandedFilters.clear();\n    this.render();\n  }\n\n  /**\n   * Handle a click on the refresh button, re-running the setup process,\n   * and re-rendering the compendium browser afterwards.\n   *\n   * @private\n   * @param {Event} _event - The originating click event\n   */\n  async _onReload(_event) {\n    this.#setup = false;\n    this.initialize();\n    this.render();\n  }\n\n  /**\n   * Handle a click on a filter's title to collapse or expand it.\n   *\n   * @private\n   * @param {Event} event - The originating click event\n   */\n  _onFilterHeaderClick(event) {\n    const { filterId } = event.target.closest(\".filter\").dataset;\n    const filterContents = event.target.closest(\".filter\").querySelector(\".filter-content\");\n    if (this.expandedFilters.has(filterId)) {\n      this.expandedFilters.delete(filterId);\n      filterContents.classList.add(\"collapsed\");\n    } else {\n      this.expandedFilters.add(filterId);\n      filterContents.classList.remove(\"collapsed\");\n    }\n  }\n\n  /**\n   * Initializes lazy loading of entries so that they are only rendered when close-ish to being visible.\n   *\n   * @private\n   * @param {HTMLElement} html - The HTML element to initialize lazy loading for\n   */\n  _initLazyScrolling(html) {\n    const listEnd = html.querySelector(\".directory-bottom\");\n    if (listEnd) {\n      new IntersectionObserver(\n        async ([entry], observer) => {\n          if (entry.isIntersecting) {\n            // Append more entries to the list\n            const currentCount = html.querySelectorAll(\".directory-item\").length;\n            const newEntries = this._entries.slice(currentCount, currentCount + 50);\n            if (newEntries.length === 0) {\n              // No more entries to load with current filters\n              observer.unobserve(listEnd);\n            } else {\n              const newHtml = await this.constructor._renderEntries(newEntries);\n              listEnd.insertAdjacentHTML(\"beforebegin\", newHtml);\n              this._dragDrop[0].bind(html);\n            }\n          }\n        },\n        { root: html.querySelector(\".directory-list\"), rootMargin: \"300px\" }\n      ).observe(listEnd);\n    }\n  }\n}\n\n/**\n * @typedef {object} IndexEntry\n * @property {string} _id - The entry's ID\n * @property {string} name - The entry's name\n * @property {string} type - The entry's type\n * @property {string} img - The entry's image\n * @property {string} __pack - The {@link CompendiumCollection} this entry is from\n * @property {string} __packLabel - The label of the {@link CompendiumCollection} this entry is from\n * @property {string} __uuid - The UUID of this entry\n */\n","/**\n * No Autocomplete mixin\n *\n * Ref: https://github.com/foundryvtt/foundryvtt/issues/12008\n *\n * @todo\n * - Review continued need for this with Foundry v13\n *\n * @param {*} Base\n */\nexport const NoAutocomplete = (Base) =>\n  class extends Base {\n    /** @override */\n    async _renderFrame(options) {\n      const frame = await super._renderFrame(options);\n      frame.autocomplete = \"off\";\n      return frame;\n    }\n  };\n","import fuzzysort from \"fuzzysort\";\nimport { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * A specialized form used to select types.\n *\n * @property {object} attributes - The currently stored values for this trait selector\n * @property {string[]} attributes.standard - Standard choices\n * @property {string[]} attributes.custom - Custom choices\n */\nexport class ActorTraitSelector extends HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: ActorTraitSelector._updateDocument,\n      submitOnClose: false,\n      submitOnChange: false,\n      closeOnSubmit: false,\n    },\n    classes: [\"pf1-v2\", \"trait-selector\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    position: {\n      width: 320,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/trait-selector.hbs\",\n      scrollable: [\".trait-list\"],\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /**\n   * Current search filter\n   *\n   * @internal\n   */\n  _searchFilter = \"\";\n\n  /**\n   * Include language agnostic ID in search.\n   *\n   * @type {boolean}\n   */\n  static SEARCH_INCLUDE_ID = true;\n\n  /**\n   * Collator for sorting\n   *\n   * @internal\n   */\n  _collator = new Intl.Collator(game.i18n.lang, {\n    numeric: true,\n    ignorePunctuation: true,\n  });\n\n  constructor(options) {\n    // Ensure uniqueness to target for trait selector\n    options.id ??= `trait-selector-${options.document.uuid.replaceAll(\".\", \"-\")}-${options.subject}`;\n\n    super(options);\n\n    // Enrich dialog identity\n    this.options.classes.push(options.subject);\n\n    // Get current values\n    const keys = foundry.utils.getProperty(options.document.toObject(), this.attribute) ?? [];\n\n    this.attributes = {\n      standard: new Set(),\n      custom: new Set(),\n    };\n\n    if (Array.isArray(keys)) {\n      for (const key of keys) {\n        if (this.options.choices[key]) this.attributes.standard.add(key);\n        else this.attributes.custom.add(key);\n      }\n    }\n\n    const searchIndex = [];\n    for (const [id, label] of Object.entries(this.options.choices)) {\n      searchIndex.push({\n        id,\n        _id: fuzzysort.prepare(id.normalize(\"NFKD\")),\n        _name: fuzzysort.prepare(label.normalize(\"NFKD\")),\n      });\n    }\n    this._searchIndex = searchIndex;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _preparePartContext(partId) {\n    const editable = this.isEditable;\n\n    switch (partId) {\n      case \"form\": {\n        const { standard, custom } = this.attributes;\n\n        // Populate choices\n        const choices = foundry.utils.deepClone(this.options.choices);\n        for (const [k, v] of Object.entries(choices)) {\n          choices[k] = {\n            label: v,\n            chosen: standard.has(k),\n          };\n        }\n\n        return {\n          editable,\n          cssClass: editable ? \"\" : \"locked\",\n          choices,\n          hideSearch: Object.keys(choices).length < ffd20.config.traitSelector.minChoicesForSearch,\n          custom: Array.from(new Set(custom)),\n          search: this._searchFilter,\n          hasCustom: this.options.hasCustom,\n        };\n      }\n      case \"footer\": {\n        if (!editable) return {}; // No update button if not editable\n\n        return {\n          buttons: [\n            {\n              type: \"submit\",\n              label: this.document instanceof Actor ? \"FFD20.UpdateActor\" : \"FFD20.UpdateItem\",\n              icon: \"far fa-save\",\n            },\n          ],\n        };\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the trait selector window\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    return `${this.options.title}: ${this.document.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Return a reference to the target attribute\n   *\n   * @type {string}\n   */\n  get attribute() {\n    return this.options.name;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Split a given value based on the configured separator\n   *\n   * @param {string} value      The value to split\n   * @returns {string[]}         The split values, with empty values filtered out\n   */\n  splitCustom(value) {\n    return value\n      .split(ffd20.config.re.traitSeparator)\n      .map((c) => c.trim())\n      .filter((c) => !!c);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    const html = this.element.querySelector(\".window-content\");\n\n    // Search handling\n    const search = html.querySelector(\"input[type='search']\");\n    if (search) {\n      search.addEventListener(\"input\", (ev) => this._onSearch(ev.currentTarget.value), { passive: true });\n      search.addEventListener(\"change\", (ev) => this._onSearch(ev.currentTarget.value), { passive: true });\n      this._onSearch(this._searchFilter);\n    }\n\n    const editable = this.isEditable;\n\n    // Disable form if not editable\n    if (!editable) {\n      for (const el of html.querySelectorAll(\":is(input,button)\")) {\n        el.disabled = true;\n      }\n    }\n\n    // Custom tag handling\n    const customInput = html.querySelector(\"input[name='custom']\");\n    if (customInput && editable) {\n      customInput.addEventListener(\"input\", this._onCustomInput.bind(this), { passive: true });\n      customInput.addEventListener(\"keydown\", this._onActiveCustomInput.bind(this));\n      this.element.querySelectorAll(\".custom-tags .custom-tag > a[data-action='delete']\").forEach((el) => {\n        el.addEventListener(\"click\", this._deleteCustomTag.bind(this), { passive: true });\n      });\n    }\n\n    // Mark choices gained form other sources as indeterminate\n    const attrib = foundry.utils.getProperty(this.options.document, this.attribute);\n    if (attrib?.total) {\n      const keys = new Set(attrib.base ?? []);\n      for (const key of attrib.total) {\n        if (!keys.has(key)) {\n          /** @type {HTMLInputElement} */\n          const el = html.querySelector(`input[name=\"choices.${key}\"]`);\n          if (!el.checked) el.indeterminate = true;\n        }\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for custom field input.\n   *\n   * @internal\n   * @param {Event} event         The originating input event\n   * @returns {void}\n   */\n  _onCustomInput(event) {\n    // Consume input if semicolon is inserted\n    if (/;/.test(event.currentTarget.value)) {\n      this._onChangeForm();\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for active keystrokes on the input field.\n   *\n   * @internal\n   * @param {Event} event         The originating keydown event\n   * @returns {void}\n   */\n  _onActiveCustomInput(event) {\n    if (event.isComposing) return;\n\n    switch (event.key) {\n      case \"Enter\": {\n        event.preventDefault();\n        this._onChangeForm();\n        break;\n      }\n\n      case \"Backspace\": {\n        if (event.currentTarget.value !== \"\") return;\n        if (event.repeat) return; // Ignore when backspace is held down\n\n        const last = this.element.querySelector(\".custom-tags .custom-tag:last-of-type\");\n        if (!last) return;\n\n        if (last.classList.contains(\"pre-delete\")) {\n          const tag = last.dataset.customTag;\n          this.attributes.custom = new Set(this.attributes.custom.filter((t) => t !== tag));\n          this.render();\n        } else {\n          last.classList.add(\"pre-delete\");\n        }\n        break;\n      }\n\n      default:\n        this.element.querySelector(\".custom-tags .custom-tag:last-of-type\")?.classList.remove(\"pre-delete\");\n        break;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for deleting a custom tag.\n   *\n   * @internal\n   * @param {Event} event         The originating click event\n   * @returns {void}\n   */\n  _deleteCustomTag(event) {\n    const elem = event.currentTarget;\n    const tag = elem.dataset.customTag;\n    this.attributes.custom.delete(tag);\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Run a search on the provided list of options.\n   *\n   * @internal\n   * @param {string} query        The search string\n   * @returns {void}\n   */\n  _onSearch(query) {\n    query = query?.normalize(\"NFKD\");\n    this._searchFilter = query;\n\n    const keys = [\"_name\"];\n    if (this.constructor.SEARCH_INCLUDE_ID) keys.push(\"_id\");\n\n    const matches = query\n      ? fuzzysort\n          .go(query, this._searchIndex, { keys, threshold: -10000 })\n          .sort((a, b) => {\n            // Sort by score first, then alphabetically by name\n            if (a.score !== b.score) return b.score - a.score;\n            else return this._collator.compare(a.obj.name, b.obj.name);\n          })\n          .map((r) => r.obj.id)\n      : null;\n\n    const els = this.element.querySelectorAll(\".trait-list li\");\n    for (const el of els) {\n      el.classList.toggle(\"search-mismatch\", query && !matches.includes(el.dataset.choice));\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for changes to form input elements\n   *\n   * @internal\n   * @param {ApplicationFormConfiguration} formConfig   The configuration of the form being changed\n   * @param {Event} event                               The triggering event\n   * @returns {void}\n   */\n  _onChangeForm(formConfig, event) {\n    const formData = {};\n    new FormData(this.element).forEach((value, key) => (formData[key] = value));\n\n    let { choices, custom, search } = foundry.utils.expandObject(formData);\n    choices ??= {};\n\n    this._searchFilter = search;\n\n    choices = Object.entries(choices)\n      .filter(([_, v]) => v)\n      .map(([k]) => k);\n\n    if (custom?.length) this.attributes.custom.add(...this.splitCustom(custom));\n\n    this.attributes.standard = new Set(choices);\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the Actor object with new trait data processed from the form\n   *\n   * @private\n   * @this {ActorTraitSelector}\n   * @param {SubmitEvent} event                   The originating form submission event\n   * @param {HTMLFormElement} form                The form element that was submitted\n   * @param {FormDataExtended} formData           Processed data for the submitted form\n   * @returns {Promise<void>}\n   */\n  static async _updateDocument(event, form, formData) {\n    // Unregister this app from doc to avoid re-renders\n    delete this.document.apps[this.appId];\n    const { standard, custom } = this.attributes;\n    const updateData = {\n      [this.attribute]: [...standard.union(custom)],\n    };\n    this.document.update(updateData);\n    this.close({ force: true });\n  }\n}\n","export function DragDropApplicationMixin(BaseApplication) {\n  return class DragDropApplication extends BaseApplication {\n    static DEFAULT_OPTIONS = {\n      dragDrop: [],\n    };\n\n    constructor(options = {}) {\n      super(options);\n      this.#dragDrop = this.#createDragDropHandlers();\n    }\n\n    /* -------------------------------------------- */\n\n    /**\n     * Create drag-and-drop workflow handlers for this Application\n     *\n     * @returns {DragDrop[]}     An array of DragDrop handlers\n     * @private\n     */\n    #createDragDropHandlers() {\n      return this.options.dragDrop.map((d) => {\n        d.permissions = {\n          dragstart: this._canDragStart.bind(this),\n          drop: this._canDragDrop.bind(this),\n        };\n        d.callbacks = {\n          dragstart: this._onDragStart.bind(this),\n          dragover: this._onDragOver.bind(this),\n          drop: this._onDrop.bind(this),\n        };\n        return new DragDrop(d);\n      });\n    }\n\n    #dragDrop;\n\n    /* -------------------------------------------- */\n\n    /**\n     * Actions performed after any render of the Application.\n     * Post-render steps are not awaited by the render process.\n     *\n     * @param {ApplicationRenderContext} context      Prepared context data\n     * @param {RenderOptions} options                 Provided render options\n     * @protected\n     */\n    _onRender(context, options) {\n      this.#dragDrop.forEach((d) => d.bind(this.element));\n    }\n\n    /* -------------------------------------------- */\n\n    /**\n     * Define whether a user is able to begin a dragstart workflow for a given drag selector\n     *\n     * @param {string} selector       The candidate HTML selector for dragging\n     * @returns {boolean}             Can the current user drag this selector?\n     * @protected\n     */\n    _canDragStart(selector) {\n      return true;\n    }\n\n    /* -------------------------------------------- */\n\n    /**\n     * Define whether a user is able to conclude a drag-and-drop workflow for a given drop selector\n     *\n     * @param {string} selector       The candidate HTML selector for the drop target\n     * @returns {boolean}             Can the current user drop on this selector?\n     * @protected\n     */\n    _canDragDrop(selector) {\n      return true;\n    }\n\n    /* -------------------------------------------- */\n\n    /**\n     * Callback actions which occur at the beginning of a drag start workflow.\n     *\n     * @param {DragEvent} event       The originating DragEvent\n     * @protected\n     */\n    _onDragStart(event) {}\n\n    /* -------------------------------------------- */\n\n    /**\n     * Callback actions which occur when a dragged element is over a drop target.\n     *\n     * @param {DragEvent} event       The originating DragEvent\n     * @protected\n     */\n    _onDragOver(event) {}\n\n    /* -------------------------------------------- */\n\n    /**\n     * Callback actions which occur when a dragged element is dropped on a target.\n     *\n     * @param {DragEvent} event       The originating DragEvent\n     * @protected\n     */\n    async _onDrop(event) {}\n  };\n}\n","import { DragDropApplicationMixin } from \"@app/mixins/drag-drop.mjs\";\nimport { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Offers a dynamic list selector that allows the user to add new entries and delete existing entries\n *\n * @abstract\n */\nexport class AbstractListSelector extends DragDropApplicationMixin(\n  HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2))\n) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: AbstractListSelector._save,\n      closeOnSubmit: true,\n      submitOnClose: false,\n    },\n    classes: [\"pf1-v2\", \"list-selector\", \"no-padding\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: true,\n    },\n    actions: {\n      addEntry: AbstractListSelector._onAddEntry,\n      deleteEntry: AbstractListSelector._onDeleteEntry,\n    },\n    position: {\n      width: 600,\n    },\n    sheetConfig: false,\n    dragDrop: [{ dragSelector: \"[data-drag]\", dropSelector: \"[data-drop]\" }],\n  };\n\n  constructor(options = {}) {\n    super(options);\n    this.dragDropHighlightTimeout = null;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Return the dragdrop element type for this application\n   *\n   * @returns {string}\n   */\n  get dragDropType() {\n    return \"pf1Entry-\" + this.options.name;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare drag-drop data and highlight dragged element\n   *\n   * @param {DragEvent} event       The originating DragEvent\n   * @protected\n   */\n  _onDragStart(event) {\n    const el = event.currentTarget;\n    if (\"link\" in event.target.dataset) return;\n\n    // Extract the data you need\n    const row = el.closest(\"[data-index]\");\n    const dragData = {\n      type: this.dragDropType,\n      index: row?.dataset?.index,\n      appId: this.id,\n      entry: this.entries[parseInt(row.dataset.index)],\n    };\n    if (!row || !dragData.index) return;\n    row.classList.add(\"is-dragged\");\n\n    // Set data transfer\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n    event.dataTransfer.setDragImage(row, 0, 0);\n\n    ffd20._temp.dragDropData = dragData;\n    event.target.addEventListener(\"dragend\", () => delete ffd20._temp.dragDropData);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Highlight position that the element will be inserted to on drop\n   *\n   * @param {DragEvent} event       The originating DragEvent\n   * @protected\n   */\n  _onDragOver(event) {\n    this.clearDragHighlights();\n\n    if (ffd20._temp?.dragDropData?.type !== this.dragDropType) return;\n    event.target.closest(\"[data-drop]\").classList.add(\"drag-over\");\n\n    clearTimeout(this.dragDropHighlightTimeout);\n    this.dragDropHighlightTimeout = setTimeout(() => this.clearDragHighlights(), 150);\n  }\n\n  /* -------------------------------------------- */\n\n  clearDragHighlights() {\n    this.element.querySelectorAll(\"[data-drop]\").forEach((el) => el.classList.remove(\"drag-over\", \"is-dragged\"));\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Inject dragged element into its new position\n   *\n   * @param {DragEvent} event       The originating DragEvent\n   * @protected\n   */\n  async _onDrop(event) {\n    const dragEventData = TextEditor.getDragEventData(event);\n    const moveToBeforeId = event.target.closest(\"[data-index]\").dataset.index;\n\n    this.clearDragHighlights();\n    if (dragEventData?.type !== this.dragDropType) return;\n\n    const movedId = dragEventData?.index;\n    if (!movedId) return;\n\n    let entry = dragEventData?.entry;\n    if (dragEventData?.appId === this.id) {\n      entry = this.entries.splice(dragEventData.index, 1)[0];\n    }\n\n    this.entries.splice(moveToBeforeId, 0, entry);\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  async _preparePartContext(partId) {\n    const editable = this.isEditable;\n\n    switch (partId) {\n      case \"form\": {\n        return {\n          editable,\n          cssClass: editable ? \"\" : \"locked\",\n          document: this.document,\n          id: this.name,\n          entries: this.entries,\n          fields: this.fields,\n          dtypes: this.dtypes,\n        };\n      }\n      case \"footer\": {\n        if (!editable) return {};\n        return {\n          buttons: [{ type: \"submit\", label: \"FFD20.Save\", icon: \"far fa-save\" }],\n        };\n      }\n    }\n\n    return {};\n  }\n\n  /**\n   * @override\n   */\n  _onRender() {\n    // Disable form if not editable\n    if (!this.isEditable) {\n      for (const el of this.element.querySelectorAll(\".window-content :is(input,button,select)\")) {\n        el.disabled = true;\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Alias the name property\n   *\n   * @type {string}\n   */\n  get attribute() {\n    return this.options.name;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the list of fields\n   *\n   * @type {string[]}\n   */\n  get fields() {\n    return this.options.fields.split(\";\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the list of data types\n   *\n   * @type {string[]}\n   */\n  get dtypes() {\n    return this.options.dtypes.split(\";\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the data entry length\n   *\n   * @type {number}\n   */\n  get dataCount() {\n    return this.fields.length;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides default data for a new list entry\n   *\n   * @abstract\n   * @param event\n   * @protected\n   * @returns {object}\n   */\n  _getNewEntry(event) {\n    return {};\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add a new entry to the list\n   *\n   * @internal\n   * @param event\n   * @this {AbstractListSelector}\n   * @returns {Promise<void>}\n   */\n  static async _onAddEntry(event) {\n    event.preventDefault();\n    this.entries.push(this._getNewEntry(event));\n    return this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Delete an existing entry from the list\n   *\n   * @internal\n   * @param event\n   * @this {AbstractListSelector}\n   * @returns {Promise<void>}\n   */\n  static async _onDeleteEntry(event) {\n    event.preventDefault();\n    const a = event.target;\n\n    const tr = a.closest(\"tr\");\n    const index = parseInt(tr.dataset.index);\n    this.entries.splice(index, 1);\n    return this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update internal data snapshot on form change\n   *\n   * @param formConfig\n   * @param event\n   * @override\n   * @protected\n   * @this {AbstractListSelector}\n   * @returns {Promise<void>}\n   */\n  async _onChangeForm(formConfig, event) {}\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides update data for saves\n   *\n   * @abstract\n   * @protected\n   * @returns {object}\n   */\n  _getUpdateData() {\n    return {};\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Save the new data back to the document.\n   *\n   * @internal\n   * @this {AbstractListSelector}\n   * @param {SubmitEvent} event               The originating form submission event\n   * @param {HTMLFormElement} form            The form element that was submitted\n   * @param {FormDataExtended} formData       Processed data for the submitted form\n   * @param {object} formData.object          The object of the form\n   * @returns {Promise<void>}\n   */\n  static async _save(event, form, formData) {\n    this.document.update(this._getUpdateData());\n  }\n}\n","import { AbstractListSelector } from \"@app/abstract-list-selector.mjs\";\n\n/**\n * Extend the FormApplication to handle creating, removing, and editing\n * and Actor's Damage Reduction and Energy Resistances.\n */\nexport class DamageResistanceSelector extends AbstractListSelector {\n  static DEFAULT_OPTIONS = {\n    classes: [\"damage-resistance-selector\"],\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/damage-resistance-selector.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /** @override */\n  constructor(options) {\n    super(options);\n\n    /** Basic properties for handling operations */\n    // Prepare data and convert it into format compatible with the editor\n    this.isDR = options.isDR === true;\n\n    /** Working copy of our trait's data */\n    const resistances = foundry.utils.deepClone(foundry.utils.getProperty(this.document, this.attribute) ?? {});\n\n    /**\n     * Custom user input for damage sources\n     *\n     * @property\n     * @type {string}\n     */\n    this.custom = resistances.custom;\n\n    /**\n     * Original copy of the trait's entries\n     *\n     * @property\n     * @type {Object<string, any>}\n     */\n    this.originalEntries = resistances.value;\n    this.entries = resistances.value;\n\n    /** Processing Damage sources */\n    const damageOBJ = ffd20.utils.naturalSort([...ffd20.registry.damageTypes], \"name\").filter((dType) => !dType.isModifier);\n    const damages = {};\n\n    // Loop through the registry to filter not-applicable damage sources\n    Object.values(damageOBJ)\n      .sort()\n      .forEach((dType) => {\n        // If we are looking for DR, we want to exclude types that are energy or not untyped\n        if ((dType.category === \"energy\" || dType.category === \"misc\") && this.isDR) {\n          return;\n        }\n\n        // If we are looking for ERES, we want to exclude types that are physical or untyped\n        if ((dType.category === \"physical\" || (dType.category === \"misc\" && dType.id === \"untyped\")) && !this.isDR) {\n          return;\n        }\n\n        damages[dType.id] = dType.name;\n      });\n\n    if (this.isDR) {\n      Object.keys(ffd20.config.damageResistances).forEach((dType) => {\n        damages[dType] = ffd20.config.damageResistances[dType];\n      });\n\n      ffd20.utils.naturalSort([...ffd20.registry.materials], \"name\").forEach((material) => {\n        if (\n          material.dr &&\n          !material.treatedAs &&\n          (material.allowed.lightBlade ||\n            material.allowed.oneHandBlade ||\n            material.allowed.twoHandBlade ||\n            material.allowed.rangedWeapon)\n        ) {\n          damages[material.id] = material.shortName || material.name;\n        }\n      });\n    }\n\n    /**\n     * A list of key-value pairs for dropdown damage types\n     *\n     * @property\n     * @type {Object<string, string>}\n     */\n    this.damages = damages;\n\n    /**\n     * A dropdown list of combination types for multiple damage types\n     *\n     * @property\n     * @type {Object<boolean, string>}\n     */\n    this.operators = {\n      true: \"FFD20.Application.DamageResistanceSelector.CombinationOr\",\n      false: \"FFD20.Application.DamageResistanceSelector.CombinationAnd\",\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Initialize the configuration for this application. Override the default ID to be unique to this\n   * entry selector instance based on document and attribute that is being edited.\n   *\n   * @override\n   * @param {ApplicationConfiguration} options    The provided configuration options for the Application\n   * @returns {ApplicationConfiguration}           The final configuration values for the application\n   */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n\n    const type = options.isDR ? \"DR\" : \"ER\";\n    options.id = `DamageResistanceSelector-${type}-${options.document.uuid.replaceAll(\".\", \"-\")}`;\n\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _preparePartContext(partId, context, options) {\n    const rv = await super._preparePartContext(partId, context, options);\n    if (partId === \"form\") {\n      rv.custom = this.custom;\n      rv.damages = this.damages;\n      rv.operators = this.operators;\n      rv.isDR = this.isDR;\n    }\n\n    return rv;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Alias the document property to actor\n   *\n   * @type {ActorPF}\n   */\n  get actor() {\n    return this.document;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the window to include the Actor name\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Application.DamageResistanceSelector.\" + (this.isDR ? \"DR\" : \"ER\") + \"Title\")}: ${\n      this.actor.name\n    }`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides default data for a new list entry\n   *\n   * @override\n   * @param event\n   * @protected\n   * @returns {object}\n   */\n  _getNewEntry(event) {\n    return {\n      amount: 0,\n      types: [this.isDR ? \"\" : \"fire\", \"\"],\n      operator: true,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update internal data snapshot on form change\n   *\n   * @param formConfig\n   * @param event\n   * @override\n   * @protected\n   * @this {EntrySelector}\n   * @returns {Promise<void>}\n   */\n  async _onChangeForm(formConfig, event) {\n    const target = event.target;\n\n    if (target.matches(\"[name=custom]\")) {\n      this._onResistanceCustomChange(event);\n    } else {\n      this._onResistanceChange(event);\n    }\n\n    super._onChangeForm(formConfig, event);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * A triggered operation when any inputs or dropdowns are interacted\n   * with to save the data from UI\n   *\n   * @param {Event} event\n   */\n  async _onResistanceChange(event) {\n    const target = event.target;\n\n    const tr = target.closest(\"tr.resistance\");\n    const index = parseInt(tr.dataset.index);\n    const index2 = target.dataset.index;\n    const value = target.value;\n    let updateValue = null;\n\n    // Sanity-check our updated value\n    if (target.dataset.dtype === \"Number\") {\n      let val = parseFloat(value);\n      if (isNaN(val)) val = 0;\n      updateValue = Math.floor(val * 100) / 100;\n    } else if (target.dataset.dtype === \"Boolean\") updateValue = value === \"true\";\n    else updateValue = value;\n\n    // Process the value into the types array or assign to an entry property\n    switch (index2) {\n      case \"types0\":\n        this.entries[index].types[0] = updateValue;\n        break;\n      case \"types1\":\n        this.entries[index].types[1] = updateValue;\n        break;\n      default:\n        this.entries[index][index2] = updateValue;\n        break;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * A triggered operation when the user modifies the custom input section\n   *\n   * @param {Event} event\n   */\n  async _onResistanceCustomChange(event) {\n    const target = event.target;\n    this.custom = target.value;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides update data for saves\n   *\n   * @override\n   * @protected\n   * @returns {object}\n   */\n  _getUpdateData() {\n    const updateData = {};\n\n    updateData[this.attribute + \".value\"] = this.entries.map((value) => {\n      // Ensure no matter what, we have values\n      value.types[0] ??= \"\";\n      value.types[1] ??= \"\";\n\n      if (value.types[0] === \"\" && value.types[1] !== \"\") {\n        value.types[0] = value.types[1];\n        value.types[1] = \"\";\n      }\n      if (value.types[0] === value.types[1]) {\n        value.types[1] = \"\";\n      }\n\n      // Clear out empty choices\n      value.types = value.types.filter((v) => v);\n\n      // Convert from string key to boolean value\n      value.operator = String(value.operator).toLowerCase() === \"true\";\n      return value;\n    });\n    updateData[this.attribute + \".custom\"] = this.custom;\n\n    return updateData;\n  }\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An application that renders a form to configure the resting behavior of an Actor\n *\n * @param {ActorPF} actor     The Actor instance for which to configure resting\n */\nexport class ActorRestDialog extends HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: ActorRestDialog._rest,\n      submitOnChange: false,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"actor-rest\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    position: {\n      width: 500,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/actor-rest.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    return {\n      buttons: [{ type: \"submit\", label: \"FFD20.Rest\", icon: \"fa-solid fa-bed\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Alias the document property to actor\n   *\n   * @type {ActorPF}\n   */\n  get actor() {\n    return this.document;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the actor rest window to include the Actor name\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Rest\")}: ${this.actor.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Trigger the actor rest with the provided form input as options.\n   *\n   * @internal\n   * @this {ActorRestDialog}\n   * @param {SubmitEvent} event                                     The originating form submission event\n   * @param {HTMLFormElement} form                                  The form element that was submitted\n   * @param {FormDataExtended} formData                             Processed data for the submitted form\n   * @param {Partial<ActorRestOptions>} formData.object             The resting configuration\n   * @returns {Promise<void>}\n   */\n  static async _rest(event, form, formData) {\n    await this.actor.performRest(formData.object);\n  }\n}\n","const { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An application offering the user an interface to use the point-buy rules\n * described in the Pathfinder CRB to determine their characters ability\n * scores.\n */\nexport class PointBuyCalculator extends HandlebarsApplicationMixin(DocumentSheetV2) {\n  /**\n   * Minimum possible ability score value.\n   */\n  min;\n  /**\n   * Maximum possible ability score value.\n   */\n  max;\n  /**\n   * The actors current ability scores.\n   *\n   * @type {{key: string, name: string, value: number}[]}\n   */\n  abilities;\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: PointBuyCalculator._save,\n      submitOnChange: false,\n      submitOnClose: false,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"pointbuy-calculator\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    actions: {\n      control: PointBuyCalculator._onAbilityControl,\n    },\n    position: {\n      width: 320,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/point-buy-calculator.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  constructor(options) {\n    super(options);\n\n    const ablValues = Object.keys(ffd20.config.abilityCost).map((i) => Number(i));\n\n    this.abilities = Object.entries(ffd20.config.abilities).map(([k, name]) => ({\n      key: k,\n      name,\n      value: this.actor.system.abilities[k]?.value ?? 10,\n    }));\n    this.min = Math.min(...ablValues);\n    this.max = Math.max(...ablValues);\n  }\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    const usedPoints = this.spentPoints;\n\n    const pointBuy = ffd20.config.pointBuy;\n    const limitsArr = Object.entries(pointBuy).map(([key, ldata]) => ({ ...ldata, key }));\n    limitsArr.sort((a, b) => a.points - b.points);\n\n    // Find most relevant category\n    let closest = limitsArr[0].key;\n    for (const l of limitsArr) {\n      const prev = pointBuy[closest].points;\n      if (prev < usedPoints) closest = l.key;\n    }\n\n    return {\n      min: this.min,\n      max: this.max,\n      abilities: this.abilities,\n      points: usedPoints,\n      limits: limitsArr,\n      closest,\n      invalidPoints: pointBuy[closest].points !== usedPoints,\n      buttons: [{ type: \"submit\", label: \"FFD20.Confirm\", icon: \"far fa-save\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Alias the document property to actor\n   *\n   * @type {ActorPF}\n   */\n  get actor() {\n    return this.document;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the point buy calculator window to include the actors name.\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Application.PointBuy.Title\")}: ${this.actor.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the number of points spent on ability scores.\n   *\n   * @type {number}\n   */\n  get spentPoints() {\n    let result = 0;\n\n    for (const a of this.abilities) {\n      result += ffd20.config.abilityCost[a.value];\n    }\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update ability score value display and remaining points on\n   * subtract/add operations.\n   *\n   * @internal\n   * @param event\n   * @param target\n   * @this {PointBuyCalculator}\n   * @returns {Promise<void>}\n   */\n  static async _onAbilityControl(event, target) {\n    event.preventDefault();\n    const ablKey = target.closest(\".ability\").dataset.ability;\n    const abl = this.abilities.find((o) => o.key === ablKey);\n\n    if (target.classList.contains(\"add\")) {\n      abl.value = Math.min(this.max, abl.value + 1);\n    } else if (target.classList.contains(\"subtract\")) {\n      abl.value = Math.max(this.min, abl.value - 1);\n    }\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the actors ability scores based on the current input values.\n   *\n   * @internal\n   * @this {PointBuyCalculator}\n   * @returns {Promise<void>}\n   */\n  static async _save() {\n    const updateData = {};\n    for (const a of this.abilities) {\n      updateData[`system.abilities.${a.key}.value`] = a.value;\n    }\n    await this.actor.update(updateData);\n  }\n}\n","export class Widget_ItemPicker {\r\n  constructor(callback, { items, columns = 3 } = {}) {\r\n    /**\r\n     * @property\r\n     * The HTML element that represents this widget.\r\n     */\r\n    this.element = null;\r\n\r\n    /**\r\n     * @property\r\n     * The callback to fire if an item is clicked.\r\n     */\r\n    this.callback = callback;\r\n\r\n    /**\r\n     * @typedef Widget_ItemPicker_Item\r\n     * @type {object}\r\n     * @property {string} value\r\n     * @property {string} label\r\n     */\r\n    /**\r\n     * @property\r\n     * @type Widget_ItemPicker_Item[]\r\n     * The items in this widget.\r\n     */\r\n    this._items = items;\r\n\r\n    /**\r\n     * @property\r\n     * @type {number}\r\n     * The maximum amount of columns shown.\r\n     */\r\n    this.columns = columns;\r\n  }\r\n\r\n  render(parentElem) {\r\n    // Generate widget\r\n    const rootElem = $($.parseHTML('<div class=\"widget item-picker\"></div>'));\r\n    // Add rows\r\n    let rowElem;\r\n    for (let a = 0; a < this._items.length; a++) {\r\n      const item = this._items[a];\r\n      if (a % this.columns === 0) {\r\n        rowElem = $($.parseHTML('<div class=\"row\"></div>'));\r\n        rootElem.append(rowElem);\r\n      }\r\n\r\n      const itemElem = $($.parseHTML(`<div class=\"item\" value=\"${item.value}\">${item.label}</div>`));\r\n      const widthRate = Math.floor(10000 / this.columns) / 100;\r\n      itemElem.css(\"flex\", `0 0 calc(${widthRate}% - 4px)`);\r\n      rowElem.append(itemElem);\r\n    }\r\n\r\n    // Replace parent element\r\n    if (!(parentElem instanceof jQuery)) parentElem = $(parentElem);\r\n    rootElem.css(\"position\", \"absolute\");\r\n    rootElem.css(\"left\", `${parentElem[0].offsetLeft}px`);\r\n    rootElem.css(\"position\", `${parentElem[0].offsetBottom}px`);\r\n    parentElem.parent().append(rootElem);\r\n\r\n    this.element = rootElem;\r\n\r\n    window.setTimeout(() => {\r\n      this.activateListeners(rootElem);\r\n    }, 10);\r\n  }\r\n\r\n  activateListeners(html) {\r\n    // Click item callback\r\n    html.find(\".item\").click(this._onClickItem.bind(this));\r\n\r\n    // Cancel widget\r\n    this._cancelCallback = this._onCancel.bind(this);\r\n    document.addEventListener(\"click\", this._cancelCallback);\r\n  }\r\n\r\n  _onCancel(event) {\r\n    event.preventDefault();\r\n\r\n    // Don't cancel if this widget was clicked\r\n    const target = event.target;\r\n    let node = target;\r\n    if (node === this.element[0]) return;\r\n    while (node.parentNode) {\r\n      if (node === this.element[0]) return;\r\n      node = node.parentNode;\r\n    }\r\n\r\n    this.cancel();\r\n  }\r\n\r\n  _onClickItem(event) {\r\n    event.preventDefault();\r\n    const a = event.currentTarget;\r\n\r\n    this.callback($(a).attr(\"value\"));\r\n  }\r\n\r\n  cancel() {\r\n    document.removeEventListener(\"click\", this._cancelCallback);\r\n    this.element.remove();\r\n  }\r\n}\r\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * A generic application to render a settings modal.\n *\n * @abstract\n */\nexport class AbstractSettingsApplication extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._save,\n      submitOnChange: false,\n      closeOnSubmit: true,\n      submitOnClose: false,\n    },\n    classes: [\"pf1-v2\", \"settings\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    actions: {\n      resetForm: this._onFormReset,\n    },\n    position: {\n      width: 520,\n    },\n    sheetConfig: false,\n  };\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  get title() {\n    return game.i18n.localize(this.options.phraseKey + \".Title\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Initialize the configuration for this application. Override the default ID to be unique to this\n   * settings app instance and tack on extra class.\n   *\n   * @override\n   * @param {ApplicationConfiguration} options    The provided configuration options for the Application\n   * @returns {ApplicationConfiguration}           The final configuration values for the application\n   */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n\n    options.id = options.configKey.replace(\"Config\", \"\").toLowerCase() + \"-config\";\n    options.classes = options.classes || [];\n    options.classes.push(options.id);\n\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  async _prepareContext() {\n    if (!this.settings) {\n      const settings = game.settings.get(\"ffd20\", this.options.configKey);\n      this.settings = new this.options.model(settings.toObject());\n      this.fields = this.settings.fields;\n    }\n\n    return {};\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   * @param {string} partId - Part ID\n   * @param {ApplicationRenderContext} context - Context\n   */\n  async _preparePartContext(partId, context) {\n    switch (partId) {\n      case \"form\":\n        {\n          Object.assign(context, {\n            activeTab: this.tabGroups.primary,\n            settings: this.settings,\n            fields: this.settings.schema.fields,\n            model: this.options.model,\n            config: ffd20.config,\n            const: ffd20.const,\n          });\n        }\n        break;\n\n      case \"footer\":\n        {\n          context.buttons = [\n            { type: \"button\", label: \"SETTINGS.Reset\", icon: \"fa-solid fa-sync\", action: \"resetForm\" },\n            { type: \"submit\", label: \"SETTINGS.Save\", icon: \"fa-solid fa-save\" },\n          ];\n        }\n        break;\n\n      default:\n        break;\n    }\n\n    if ([\"form\", \"tabs\"].includes(partId)) {\n      context.tabs = this.tabs?.primary || {};\n      for (const [id, tab] of Object.entries(context.tabs)) {\n        const active = this.tabGroups.primary === id;\n        Object.assign(tab, {\n          id,\n          group: \"primary\",\n          active,\n          cssClass: active ? \"active\" : \"\",\n        });\n      }\n    }\n\n    return context;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for changes to form input elements\n   *\n   * @internal\n   * @param {ApplicationFormConfiguration} formConfig   The configuration of the form being changed\n   * @param {Event} event                               The triggering event\n   * @returns {void}\n   */\n  _onChangeForm(formConfig, event) {\n    const input = event.target.closest(\"[name]\");\n    this.settings.updateSource({ [input.name]: input.type === \"checkbox\" ? input.checked : input.value });\n    this.render({ parts: [\"form\"] });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler that is fired when the form is reset to its original values\n   *\n   * @internal\n   * @param {Event} event - The triggering event\n   * @returns {Promise<void>}\n   */\n  static async _onFormReset(event) {\n    this.settings = new this.options.model();\n    ui.notifications.info(game.i18n.localize(this.options.phraseKey + \".Reset\"));\n    this.render({ parts: [\"form\"] });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the game settings with the new configuration\n   *\n   * @internal\n   * @this {ActorRestDialog}\n   * @param {SubmitEvent} event                                     The originating form submission event\n   * @param {HTMLFormElement} form                                  The form element that was submitted\n   * @param {FormDataExtended} formData                             Processed data for the submitted form\n   * @param {Partial<ActorRestOptions>} formData.object             The form data in object form\n   * @returns {Promise<void>}\n   */\n  static async _save(event, form, formData) {\n    formData = foundry.utils.expandObject(formData.object);\n    await game.settings.set(\"ffd20\", this.options.configKey, formData);\n  }\n}\n\n/**\n * A generic application to render a settings modal with a \"Player\" and a \"World\" tab.\n *\n * @abstract\n */\nexport class AbstractSplitSettingsApplication extends AbstractSettingsApplication {\n  static DEFAULT_OPTIONS = {\n    form: {\n      handler: this._save,\n    },\n    actions: {\n      resetForm: this._onFormReset,\n    },\n  };\n\n  tabGroups = { primary: \"player\" };\n\n  tabs = {\n    primary: {\n      player: {\n        icon: \"fa-solid fa-user\",\n        label: \"FFD20.Application.Settings.Player\",\n      },\n      world: {\n        icon: \"fa-solid fa-globe\",\n        label: \"FFD20.Application.Settings.World\",\n      },\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  _configureRenderOptions(options) {\n    super._configureRenderOptions(options);\n    if (!game.user.isGM) {\n      // If we're not a GM, remove the tabs part\n      options.parts.shift();\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   * @param {string} partId\n   * @param {ApplicationRenderContext} context\n   */\n  async _preparePartContext(partId, context) {\n    context = await super._preparePartContext(partId, context);\n    if (partId !== \"form\") return context;\n\n    delete context.settings;\n    delete context.model;\n    delete context.fields;\n\n    Object.assign(context, {\n      player: this.playerSettings,\n      playerModel: this.options.playerModel,\n      playerSchema: this.options.playerModel.defineSchema(),\n      world: this.worldSettings,\n      worldModel: this.options.worldModel,\n      worldSchema: this.options.worldModel.defineSchema(),\n      isGM: game.user.isGM,\n    });\n\n    return context;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   */\n  async _prepareContext(options) {\n    if (!this.settings) {\n      const playerSettings = game.settings.get(\"ffd20\", this.options.configKey);\n      this.playerSettings = new this.options.playerModel(playerSettings.toObject());\n      if (game.user.isGM) {\n        const worldSettings = game.settings.get(\"ffd20\", this.options.worldConfigKey);\n        this.worldSettings = new this.options.worldModel(worldSettings.toObject());\n      }\n      this.settings = true;\n    }\n\n    return super._prepareContext(options);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler that is fired when the form is reset to its original values\n   *\n   * @internal\n   * @param {Event} event - The triggering event\n   * @returns {Promise<void>}\n   */\n  async _onFormReset(event) {\n    this.playerSettings = new this.options.playerModel();\n    if (game.user.isGM) {\n      this.worldSettings = new this.options.worldModel();\n    }\n    ui.notifications.info(game.i18n.localize(this.options.phraseKey + \".Reset\"));\n    this.render({ parts: [\"form\"] });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the game settings with the new configuration\n   *\n   * @internal\n   * @this {ActorRestDialog}\n   * @param {SubmitEvent} event                                     The originating form submission event\n   * @param {HTMLFormElement} form                                  The form element that was submitted\n   * @param {FormDataExtended} formData                             Processed data for the submitted form\n   * @param {Partial<ActorRestOptions>} formData.object             The form data in object form\n   * @returns {Promise<void>}\n   */\n  static async _save(event, form, formData) {\n    formData = foundry.utils.expandObject(formData.object);\n\n    await game.settings.set(\"ffd20\", this.options.configKey, formData.player);\n    if (game.user.isGM) {\n      await game.settings.set(\"ffd20\", this.options.worldConfigKey, formData.world);\n    }\n  }\n}\n","export class RollPF extends Roll {\n  static CHAT_TEMPLATE = \"systems/ffd20/templates/chat/roll.hbs\";\n\n  get totalHalved() {\n    foundry.utils.logCompatibilityWarning(\"RollPF.totalHalved is deprecated with no replacement\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n    return Math.floor(this.total / 2);\n  }\n\n  /**\n   * Synchronous and thrown error consuming roll evaluation.\n   *\n   * @remarks\n   * - Returned roll has `.err` set if an error occurred during evaluation.\n   * - If error occurs, the returned roll will have its formula replaced.\n   * @param {string} formula - Roll formula\n   * @param {object} rollData - Data supplied to roll\n   * @param {object} context - If error occurs, this will be included in the error message.\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.suppressError=false] - If true, no error will be printed even if one occurs.\n   * @param {object} [evalOpts] - Additional options to pass to Roll.evaluate()\n   * @returns {Promise<RollPF>} - Evaluated roll, or placeholder if error occurred.\n   */\n  static async safeRoll(formula, rollData = {}, context, { suppressError = false } = {}, evalOpts = {}) {\n    let roll;\n    try {\n      roll = await this.create(formula, rollData).evaluate({ ...evalOpts });\n    } catch (err) {\n      roll = this.create(\"0\", rollData).evaluateSync({ ...evalOpts });\n      roll.err = err;\n    }\n    if (roll.warning) roll.err = Error(\"This formula had a value replaced with null.\");\n    if (roll.err) {\n      if (context && !suppressError) console.error(context, roll.err);\n      else if (CONFIG.debug.roll) console.error(roll.err);\n    }\n    return roll;\n  }\n\n  /**\n   * Synchronous version of {@link safeRoll safeRoll()}\n   *\n   * {@inheritDoc safeRoll}\n   *\n   * @param {string} formula - Formula to evaluate\n   * @param {object} [rollData] - Roll data\n   * @param {*} [context] - Context data to log if error occurs\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.suppressError] - If true, no error will be printed\n   * @param {object} [evalOpts] - Options to pass to Roll.evaluate()\n   * @returns {ffd20.dice.RollPF} - Evaluated roll\n   */\n  static safeRollSync(formula, rollData = {}, context, { suppressError = false } = {}, evalOpts = {}) {\n    let roll;\n    try {\n      roll = new this(formula, rollData).evaluateSync({ ...evalOpts });\n    } catch (err) {\n      roll = new this(\"0\", rollData).evaluateSync({ ...evalOpts });\n      roll.err = err;\n    }\n    if (roll.warning) roll.err = Error(\"This formula had a value replaced with null.\");\n    if (roll.err) {\n      if (context && !suppressError) console.error(context, roll.err);\n      else if (CONFIG.debug.roll) console.error(roll.err);\n    }\n    return roll;\n  }\n\n  static cleanFlavor(flavor) {\n    return flavor.replace(/\\[\\];/g, \"\");\n  }\n\n  static getTermTooltipData(term) {\n    if (typeof term.total !== \"number\") return null; // Ignore terms that don't result in numbers\n\n    const ttdata = term.getTooltipData?.() ?? {\n      formula: term.expression,\n      total: term.total,\n      flavor: term.flavor,\n      css: term.flavor ? \"\" : \"placeholder\",\n    };\n\n    return ttdata;\n  }\n\n  /**\n   * Render the tooltip HTML for a RollPF instance\n   *\n   * @returns {Promise<string>} The rendered HTML tooltip as a string\n   */\n  async getTooltip() {\n    const parts = this.dice.filter((d) => d.results.some((r) => r.active)).map(this.constructor.getTermTooltipData);\n    const numericParts = this.terms.reduce((cur, t, idx, arr) => {\n      if (t instanceof foundry.dice.terms.DiceTerm) return cur; // Ignore dice already handled above\n      if (t instanceof foundry.dice.terms.FunctionTerm && t.dice.length) return cur; // Ignore function terms with dice\n\n      const ttdata = this.constructor.getTermTooltipData(t);\n      if (!ttdata) return cur;\n\n      const prior = arr[idx - 1];\n      if (\n        t instanceof foundry.dice.terms.NumericTerm &&\n        prior &&\n        prior instanceof foundry.dice.terms.OperatorTerm &&\n        prior.operator === \"-\"\n      ) {\n        ttdata.total = -ttdata.total;\n      }\n\n      cur.push(ttdata);\n\n      return cur;\n    }, []);\n\n    // Add in flavor for base check if missing\n    if (this.dice[0]?.constructor.name === \"Die\") {\n      parts[0].flavor ||= game.i18n.localize(\"FFD20.Rolls.Check.Label\");\n    }\n\n    return renderTemplate(\"systems/ffd20/templates/dice/tooltip.hbs\", { parts, numericParts });\n  }\n\n  /**\n   * @override\n   *\n   * Synced with Foundry v12.331\n   */\n  async render({ flavor, template = this.constructor.CHAT_TEMPLATE, isPrivate = false } = {}) {\n    if (!this._evaluated) await this.evaluate({ allowInteractive: !isPrivate });\n\n    const templateData = {\n      formula: isPrivate ? \"???\" : this.formula,\n      flavor: isPrivate ? null : (flavor ?? this.options.flavor),\n      user: game.user.id,\n      details: isPrivate ? \"\" : await this.getTooltip(),\n      get tooltip() {\n        return this.details;\n      },\n      total: isPrivate ? \"?\" : ffd20.utils.limitPrecision(this.total, 2),\n      hasDetails: isPrivate ? false : true,\n    };\n\n    return renderTemplate(template, templateData);\n  }\n}\n","import { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * Formula Field\n */\nexport class FormulaField extends foundry.data.fields.StringField {\n  constructor(options = {}, context) {\n    if (options.choices) throw new Error(\"choices is not valid option for FormulaField\");\n    super(options, context);\n  }\n\n  /**\n   * @override\n   * @param {object} config\n   * @returns {HTMLInputElement}\n   */\n  _toInput(config) {\n    /** @type {HTMLInputElement} */\n    const input = super._toInput(config);\n\n    input.classList.add(\"formula\");\n\n    const formula = config?.value;\n    if (formula) {\n      try {\n        RollPF.parse(formula);\n      } catch (err) {\n        console.warn(err.message, { path: config.name, formula });\n        input.classList.add(\"error\");\n      }\n    }\n\n    return input;\n  }\n}\n","import { AbstractSettingsApplication } from \"@app/settings/abstract-settings.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\nexport class ExperienceConfigModel extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      disable: new fields.BooleanField({ initial: false }),\n      track: new fields.StringField({ initial: \"medium\", choices: [\"fast\", \"medium\", \"slow\", \"custom\"] }),\n      custom: new fields.SchemaField({\n        formula: new FormulaField(),\n      }),\n      openDistributor: new fields.BooleanField({ initial: true }),\n    };\n  }\n\n  static migrateData(source) {\n    source.disable ??= source.disableExperienceTracking;\n    if (source.track === \"customFormula\") source.track = \"custom\";\n    source.openDistributor ??= source.openXpDistributor;\n\n    return super.migrateData(source);\n  }\n\n  static get progressionOptions() {\n    return {\n      slow: \"FFD20.Application.Settings.Experience.Track.Options.Slow\",\n      medium: \"FFD20.Application.Settings.Experience.Track.Options.Medium\",\n      fast: \"FFD20.Application.Settings.Experience.Track.Options.Fast\",\n      custom: \"FFD20.Application.Settings.Experience.Track.Options.Custom\",\n    };\n  }\n}\n\n/**\n * An application that lets the user configure experience related settings.\n */\nexport class ExperienceConfig extends AbstractSettingsApplication {\n  static DEFAULT_OPTIONS = {\n    configKey: \"experienceConfig\",\n    phraseKey: \"FFD20.Application.Settings.Experience\",\n    model: ExperienceConfigModel,\n    window: {\n      icon: \"fa-solid fa-book\",\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/settings/experience.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   * @param {string} partId\n   * @param {ApplicationRenderContext} context\n   */\n  async _preparePartContext(partId, context) {\n    context = await super._preparePartContext(partId, context);\n    if (partId !== \"form\") return context;\n\n    Object.assign(context, {\n      enabled: this.settings.disable !== true,\n      hasCustomFormula: this.settings.track === \"custom\",\n    });\n\n    return context;\n  }\n}\n","import { AbstractSettingsApplication } from \"@app/settings/abstract-settings.mjs\";\n\nexport class HealthConfigModel extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    const classType = (max = false) =>\n      new fields.SchemaField({\n        auto: new fields.BooleanField({ initial: false }),\n        rate: new fields.NumberField({ positive: true, initial: 0.5, max: 1, step: 0.01, min: 0.01 }),\n        maximized: new fields.BooleanField({ initial: max }),\n      });\n\n    const variantRules = () =>\n      new fields.SchemaField({\n        useWoundsAndVigor: new fields.BooleanField({ initial: false }),\n        useWoundThresholds: new fields.NumberField({ initial: 0, choices: () => this.woundThresholdOptions }),\n      });\n\n    return {\n      pc: new fields.SchemaField({\n        classes: new fields.SchemaField({\n          base: classType(true),\n          racial: classType(),\n          npc: classType(),\n        }),\n        rules: variantRules(),\n      }),\n      npc: new fields.SchemaField({\n        classes: new fields.SchemaField({\n          base: classType(true),\n          racial: classType(),\n          npc: classType(),\n        }),\n        rules: variantRules(),\n      }),\n      maximized: new fields.NumberField({ integer: true, min: 0, initial: 1, step: 1 }),\n      rounding: new fields.StringField({\n        blank: false,\n        nullable: false,\n        initial: \"up\",\n        choices: () => this.healthRoundingOptions,\n      }),\n      continuous: new fields.BooleanField({ initial: false }),\n    };\n  }\n\n  /**\n   * Retrieve hit die configuration relevant to given class.\n   *\n   * @param {ItemClassPF} item\n   * @param {string} [actorType] - Actor type. If not provided, will be retrieved from the item parent or fall back to `character`.\n   * @returns {object} -\n   */\n  getClassHD(item, actorType) {\n    actorType ||= item.actor?.type || \"character\";\n\n    const config = this.getActorConfig(actorType);\n\n    switch (item.system.subType) {\n      case \"npc\":\n        return config.classes.npc;\n      case \"racial\":\n        return config.classes.racial;\n      default:\n        return config.classes.base;\n    }\n  }\n\n  /**\n   * Get actor type specific config\n   *\n   * @param {Actor|string} actor - Actor document or type string\n   * @returns {object}\n   */\n  getActorConfig(actor) {\n    const type = actor?.type || actor;\n\n    switch (type) {\n      case \"character\":\n        return this.pc;\n      case \"npc\":\n        return this.npc;\n      default:\n        return {\n          rules: { useWoundThresholds: false, useWoundsAndVigor: false },\n          get useWoundThresholds() {\n            foundry.utils.logCompatibilityWarning(\"useWoundThresholds is in rules.useWoundThresholds\", {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            });\n            return false;\n          },\n          get useWoundsAndVigor() {\n            foundry.utils.logCompatibilityWarning(\"useWoundsAndVigor is in rules.useWoundsAndVigor\", {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            });\n            return false;\n          },\n        };\n    }\n  }\n\n  static migrateData(source) {\n    if (!source) return;\n\n    if (source.continuity) {\n      source.continuous ??= source.continuity === \"continuous\";\n      delete source.continuity;\n    }\n\n    if (source.hitdice) {\n      // PCs\n      source.pc ??= {};\n      source.pc.classes ??= {};\n      source.pc.classes.base ??= source.hitdice.PC;\n      source.pc.classes.npc ??= source.hitdice.NPC;\n      source.pc.classes.racial ??= source.hitdice.Racial;\n\n      // NPCs\n      source.npc ??= {};\n      source.npc.classes ??= {};\n      source.npc.classes.base ??= source.hitdice.PC;\n      source.npc.classes.npc ??= source.hitdice.NPC;\n      source.npc.classes.racial ??= source.hitdice.Racial;\n\n      delete source.hitdice;\n    }\n\n    if (source.variants) {\n      source.pc ??= {};\n      source.pc.rules ??= {};\n      source.pc.rules.useWoundsAndVigor ??= source.variants.pc?.useWoundsAndVigor;\n      source.pc.rules.useWoundThresholds ??= source.variants.pc?.useWoundThresholds;\n\n      source.npc ??= {};\n      source.npc.rules ??= {};\n      source.npc.rules.useWoundsAndVigor ??= source.variants.npc?.useWoundsAndVigor;\n      source.npc.rules.useWoundThresholds ??= source.variants.npc?.useWoundThresholds;\n\n      delete source.variants;\n    }\n  }\n\n  /**\n   * @deprecated\n   */\n  get hitdice() {\n    foundry.utils.logCompatibilityWarning(\"HealthConfigModel.hitdice is deprecated with no direct replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    // Hand over PC settings\n    return {\n      PC: this.pc.classes.base,\n      Racial: this.pc.classes.racial,\n      NPC: this.pc.classes.npc,\n    };\n  }\n\n  /**\n   * @deprecated\n   */\n  get variants() {\n    foundry.utils.logCompatibilityWarning(\"HealthConfigModel.variants is deprecated with no direct replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    // Collect variant rules\n    return {\n      pc: {\n        useWoundsAndVigor: this.pc.rules.useWoundsAndVigor,\n        useWoundThresholds: this.pc.rules.useWoundThresholds,\n      },\n      npc: {\n        useWoundsAndVigor: this.npc.rules.useWoundsAndVigor,\n        useWoundThresholds: this.npc.rules.useWoundThresholds,\n      },\n    };\n  }\n\n  static get woundThresholdOptions() {\n    return {\n      0: game.i18n.localize(\"FFD20.Application.Settings.Health.WoundThresholds.Disabled\"),\n      1: game.i18n.localize(\"FFD20.Application.Settings.Health.WoundThresholds.Normal\"),\n      2: game.i18n.localize(\"FFD20.Application.Settings.Health.WoundThresholds.Gritty\"),\n    };\n  }\n\n  static get healthRoundingOptions() {\n    return {\n      up: \"FFD20.Application.Settings.Health.RoundingUp\",\n      nearest: \"FFD20.Application.Settings.Health.RoundingNearest\",\n      down: \"FFD20.Application.Settings.Health.RoundingDown\",\n    };\n  }\n\n  static get healthContinuityOptions() {\n    return {\n      true: \"FFD20.Application.Settings.Health.Continuous\",\n      false: \"FFD20.Application.Settings.Health.Discrete\",\n    };\n  }\n\n  prepareDerivedData() {\n    for (const config of [this.pc, this.npc]) {\n      Object.defineProperties(config, {\n        useWoundsAndVigor: {\n          get() {\n            foundry.utils.logCompatibilityWarning(\"useWoundsAndVigor is in rules.useWoundsAndVigor\", {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            });\n            return this.rules.useWoundsAndVigor;\n          },\n        },\n        useWoundThresholds: {\n          get() {\n            foundry.utils.logCompatibilityWarning(\"useWoundThresholds is in rules.useWoundThresholds\", {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            });\n            return this.rules.useWoundThresholds;\n          },\n        },\n      });\n    }\n  }\n}\n\nexport class HealthConfig extends AbstractSettingsApplication {\n  static DEFAULT_OPTIONS = {\n    configKey: \"healthConfig\",\n    phraseKey: \"FFD20.Application.Settings.Health\",\n    model: HealthConfigModel,\n    window: {\n      icon: \"fa-solid fa-heartbeat\",\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/settings/health.hbs\",\n      templates: [\"systems/ffd20/templates/settings/health.hbs\", \"templates/generic/tab-navigation.hbs\"],\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  tabGroups = { actor: \"pc\" };\n\n  tabs = {\n    actor: {\n      pc: {\n        icon: \"fa-solid fa-heartbeat\",\n        label: \"FFD20.PCs\",\n      },\n      npc: {\n        icon: \"fa-solid fa-prescription-bottle-alt\",\n        label: \"FFD20.NPCs\",\n      },\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   * @param {string} partId\n   */\n  async _preparePartContext(partId, context) {\n    context = await super._preparePartContext(partId, context);\n    if (partId !== \"form\") return context;\n\n    Object.assign(context, {\n      showWoundsVigorWarning: {\n        pc: this.settings.pc.rules.useWoundsAndVigor && this.settings.pc.rules.useWoundThresholds !== 0,\n        npc: this.settings.npc.rules.useWoundsAndVigor && this.settings.npc.rules.useWoundThresholds !== 0,\n      },\n    });\n\n    for (const actorType of [\"pc\", \"npc\"]) {\n      for (const [hdId, hdData] of Object.entries(context.settings[actorType].classes)) {\n        hdData.label = `FFD20.Application.Settings.Health.Class.${hdId}`;\n        hdData.fields = context.fields[actorType].fields.classes.fields[hdId].fields;\n      }\n    }\n\n    context.settings.pc.label = \"PC\";\n    context.settings.npc.label = \"NPC\";\n\n    // Prepare tabs\n    context.activeTab = this.tabGroups.actor;\n    context.tabs = this.tabs?.actor || {};\n    for (const [id, tab] of Object.entries(context.tabs)) {\n      const active = this.tabGroups.actor === id;\n      Object.assign(tab, {\n        id,\n        group: \"actor\",\n        active,\n        cssClass: active ? \"active\" : \"\",\n      });\n    }\n\n    return context;\n  }\n}\n","import { AbstractSettingsApplication } from \"@app/settings/abstract-settings.mjs\";\n\nexport class IntegrationConfigModel extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      diceSoNice: new fields.BooleanField({ initial: true }),\n      dragRuler: new fields.BooleanField({ initial: true }),\n      babele: new fields.BooleanField({ initial: true }),\n    };\n  }\n}\n\n/**\n * An application that lets the user configure module integration related settings.\n */\nexport class IntegrationConfig extends AbstractSettingsApplication {\n  static DEFAULT_OPTIONS = {\n    configKey: \"integration\",\n    phraseKey: \"FFD20.Application.Settings.Integration\",\n    model: IntegrationConfigModel,\n    window: {\n      icon: \"fa-solid fa-check-to-slot\",\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/settings/integration.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @protected\n   * @param {string} partId\n   * @param {ApplicationRenderContext} context\n   */\n  async _preparePartContext(partId, context) {\n    context = await super._preparePartContext(partId, context);\n    if (partId !== \"form\") return context;\n\n    Object.assign(context, {\n      dsnFound: game.modules.get(\"dice-so-nice\")?.active,\n      drFound: game.modules.get(\"drag-ruler\")?.active,\n      bFound: game.modules.get(\"babele\")?.active,\n    });\n\n    context.appId = this.id;\n\n    return context;\n  }\n}\n","import { AbstractSettingsApplication } from \"@app/settings/abstract-settings.mjs\";\n\nexport class PerformanceConfigModel extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      reachLimit: new fields.NumberField({ integer: true, min: 0, initial: 60, max: 300, step: 1 }),\n    };\n  }\n}\n\n/**\n * An application that lets the user configure performance-related settings.\n */\nexport class PerformanceConfig extends AbstractSettingsApplication {\n  static DEFAULT_OPTIONS = {\n    configKey: \"performance\",\n    phraseKey: \"FFD20.Application.Settings.Performance\",\n    model: PerformanceConfigModel,\n    window: {\n      icon: \"fa-solid fa-gauge\",\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/settings/performance.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n}\n","import {\n  ExperienceConfig,\n  ExperienceConfigModel,\n  HealthConfig,\n  HealthConfigModel,\n  IntegrationConfig,\n  IntegrationConfigModel,\n  PerformanceConfig,\n  PerformanceConfigModel,\n} from \"@app/settings/_module.mjs\";\n\n/**\n * Register System Settings\n */\nexport function registerSystemSettings() {\n  /**\n   * Track the system version upon which point a migration was last applied\n   */\n  game.settings.register(\"ffd20\", \"systemMigrationVersion\", {\n    scope: \"world\",\n    config: false,\n    type: String,\n    default: \"0.0.0.0\",\n  });\n\n  // Migration is in progress\n  game.settings.register(\"ffd20\", \"migrating\", {\n    scope: \"world\",\n    config: false,\n    type: Boolean,\n    default: false,\n    onChange: (value) => (ffd20.migrations.isMigrating = value),\n  });\n\n  /**\n   * Track when the last changelog was shown\n   */\n  game.settings.register(\"ffd20\", \"changelogVersion\", {\n    scope: \"client\",\n    config: false,\n    type: String,\n    default: \"0.74.9\",\n  });\n  /**\n   * Don't automatically show changelog\n   */\n  game.settings.register(\"ffd20\", \"dontShowChangelog\", {\n    scope: \"client\",\n    config: false,\n    type: Boolean,\n    default: false,\n  });\n\n  // Health configuration\n  game.settings.registerMenu(\"ffd20\", \"healthConfig\", {\n    name: \"FFD20.Application.Settings.Health.Title\",\n    label: \"FFD20.Application.Settings.Health.Label\",\n    hint: \"FFD20.Application.Settings.Health.Hint\",\n    icon: \"fa-solid fa-heartbeat\",\n    type: HealthConfig,\n    restricted: true,\n  });\n  game.settings.register(\"ffd20\", \"healthConfig\", {\n    scope: \"world\",\n    default: new HealthConfigModel(),\n    type: HealthConfigModel,\n    config: false,\n    requiresReload: true,\n    //onChange: () => ffd20.utils.refreshActors(), // Excessive if reloading instantly\n  });\n\n  // Experience configuration\n  game.settings.registerMenu(\"ffd20\", \"experienceConfig\", {\n    name: \"FFD20.Application.Settings.Experience.Title\",\n    label: \"FFD20.Application.Settings.Experience.Label\",\n    hint: \"FFD20.Application.Settings.Experience.Hint\",\n    icon: \"fa-solid fa-book\",\n    type: ExperienceConfig,\n    restricted: true,\n  });\n  game.settings.register(\"ffd20\", \"experienceConfig\", {\n    scope: \"world\",\n    default: new ExperienceConfigModel(),\n    type: ExperienceConfigModel,\n    config: false,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  game.settings.register(\"ffd20\", \"integration\", {\n    type: IntegrationConfigModel,\n    default: new IntegrationConfigModel(),\n    scope: \"world\",\n    config: false,\n    requiresReload: true,\n  });\n\n  game.settings.registerMenu(\"ffd20\", \"integration\", {\n    name: \"FFD20.Application.Settings.Integration.Title\",\n    label: \"FFD20.Application.Settings.Integration.Label\",\n    hint: \"FFD20.Application.Settings.Integration.Hint\",\n    restricted: true,\n    icon: \"fa-solid fa-check-to-slot\",\n    type: IntegrationConfig,\n  });\n\n  game.settings.register(\"ffd20\", \"performance\", {\n    scope: \"client\",\n    default: new PerformanceConfigModel(),\n    type: PerformanceConfigModel,\n    config: false,\n  });\n\n  game.settings.registerMenu(\"ffd20\", \"performance\", {\n    name: \"FFD20.Application.Settings.Performance.Title\",\n    label: \"FFD20.Application.Settings.Performance.Button\",\n    hint: \"FFD20.Application.Settings.Performance.Hint\",\n    restricted: false,\n    icon: \"fa-solid fa-gauge\",\n    type: PerformanceConfig,\n  });\n\n  // MEASURING\n\n  /**\n   * Option to change measure style\n   */\n  game.settings.register(\"ffd20\", \"measureStyle\", {\n    name: \"FFD20.SETTINGS.Canvas.MeasureStyle\",\n    hint: \"FFD20.SETTINGS.Canvas.MeasureStyleHint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  /**\n   * System of Units\n   */\n  game.settings.register(\"ffd20\", \"units\", {\n    name: \"FFD20.SETTINGS.Units.System\",\n    hint: \"FFD20.SETTINGS.Units.SystemHint\",\n    scope: \"world\",\n    config: true,\n    default: \"imperial\",\n    type: String,\n    choices: {\n      imperial: \"FFD20.SETTINGS.Units.Imperial\",\n      metric: \"FFD20.SETTINGS.Units.Metric\",\n    },\n    requiresReload: true,\n  });\n\n  /**\n   * System of units override for distances.\n   */\n  game.settings.register(\"ffd20\", \"distanceUnits\", {\n    name: \"FFD20.SETTINGS.Units.Distance\",\n    hint: \"FFD20.SETTINGS.Units.DistanceHint\",\n    scope: \"world\",\n    config: true,\n    default: \"default\",\n    type: String,\n    choices: {\n      default: \"FFD20.Default\",\n      imperial: \"FFD20.SETTINGS.Units.ImperialDistance\",\n      metric: \"FFD20.SETTINGS.Units.MetricDistance\",\n    },\n    requiresReload: true,\n  });\n\n  /**\n   * System of units override for weights.\n   */\n  game.settings.register(\"ffd20\", \"weightUnits\", {\n    name: \"FFD20.SETTINGS.Units.Weight\",\n    hint: \"FFD20.SETTINGS.Units.WeightHint\",\n    scope: \"world\",\n    config: true,\n    default: \"default\",\n    type: String,\n    choices: {\n      default: \"FFD20.Default\",\n      imperial: \"FFD20.SETTINGS.Units.ImperialWeight\",\n      metric: \"FFD20.SETTINGS.Units.MetricWeight\",\n    },\n    requiresReload: true,\n  });\n\n  /**\n   * Overland speed variant for metric.\n   */\n  game.settings.register(\"ffd20\", \"overlandMetricVariant\", {\n    name: \"FFD20.SETTINGS.OverlandVariantN\",\n    hint: \"FFD20.SETTINGS.OverlandVariantL\",\n    scope: \"world\",\n    config: true,\n    default: \"rounded\",\n    choices: {\n      rounded: \"FFD20.SETTINGS.OverlandMetricRounded\",\n      exact: \"FFD20.SETTINGS.OverlandMetricExact\",\n    },\n  });\n\n  // OPTIONAL RULES\n\n  /**\n   * Option to allow the background skills optional ruleset.\n   */\n  game.settings.register(\"ffd20\", \"allowBackgroundSkills\", {\n    name: \"FFD20.SETTINGS.VariantRules.BackgroundSkills\",\n    hint: \"FFD20.SETTINGS.VariantRules.BackgroundSkillsHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  /**\n   * Option to use the Fractional Base Bonuses optional ruleset.\n   */\n  game.settings.register(\"ffd20\", \"useFractionalBaseBonuses\", {\n    name: \"FFD20.SETTINGS.VariantRules.FractionalBaseBonuses\",\n    hint: \"FFD20.SETTINGS.VariantRules.FractionalBaseBonusesHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  /**\n   * Unchained action economy\n   */\n  game.settings.register(\"ffd20\", \"unchainedActionEconomy\", {\n    name: \"FFD20.SETTINGS.UnchainedActionEconomyN\",\n    hint: \"FFD20.SETTINGS.UnchainedActionEconomyH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  /**\n   * Cybertech\n   */\n  game.settings.register(\"ffd20\", \"cybertech\", {\n    name: \"FFD20.SETTINGS.Cybertech\",\n    hint: \"FFD20.SETTINGS.CybertechHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ffd20.utils.refreshActors({ renderOnly: true }),\n  });\n\n  // Armor as DR\n\n  /**\n   * Critical confirmation rolls\n   */\n  game.settings.register(\"ffd20\", \"critConfirm\", {\n    name: \"FFD20.SETTINGS.CriticalConfirm\",\n    hint: \"FFD20.SETTINGS.CriticalConfirmHint\",\n    scope: \"world\",\n    type: Boolean,\n    default: true,\n    config: true,\n  });\n\n  /**\n   * Scrolling health required permission\n   */\n  game.settings.register(\"ffd20\", \"healthPermission\", {\n    name: \"FFD20.SETTINGS.HealthDisplay.Label\",\n    hint: \"FFD20.SETTINGS.HealthDisplay.Hint\",\n    scope: \"world\",\n    config: true,\n    default: \"OBSERVER\",\n    type: String,\n    choices: {\n      NONE: \"FFD20.SETTINGS.HealthDisplay.AnyPermission\",\n      LIMITED: \"OWNERSHIP.LIMITED\",\n      OBSERVER: \"OWNERSHIP.OBSERVER\",\n      OWNER: \"OWNERSHIP.OWNER\",\n    },\n  });\n\n  // VISION\n\n  /**\n   * Special Vision Needs Selection\n   *\n   * Formerly: \"Low-light Vision Mode\"\n   */\n  game.settings.register(\"ffd20\", \"lowLightVisionMode\", {\n    name: \"FFD20.SETTINGS.Vision.RequiresSelection\",\n    hint: \"FFD20.SETTINGS.Vision.RequiresSelectionHint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    onChange: () => {\n      // Refresh canvas sight\n      canvas.perception.update(\n        { initializeLighting: true, initializeVision: true, refreshLighting: true, refreshVision: true },\n        true\n      );\n    },\n  });\n\n  /**\n   * Shared Vision sharing style.\n   */\n  game.settings.register(\"ffd20\", \"sharedVisionMode\", {\n    name: \"FFD20.SETTINGS.Vision.Sharing\",\n    hint: \"FFD20.SETTINGS.Vision.SharingHint\",\n    scope: \"world\",\n    config: false, // Hidden as it is unused; TODO: Re-implement #187's setting usage or remove setting/feature completely\n    default: 0,\n    type: Number,\n    choices: {\n      0: \"FFD20.SETTINGS.Vision.SharingWithoutSelection\",\n      1: \"FFD20.SETTINGS.Vision.SharingWithSelection\",\n    },\n    onChange: () => canvas.perception.update({ refreshLighting: true, refreshVision: true }, true),\n  });\n\n  game.settings.register(\"ffd20\", \"guaranteedVision\", {\n    name: \"FFD20.SETTINGS.Vision.Guaranteed\",\n    hint: \"FFD20.SETTINGS.Vision.GuaranteedHint\",\n    scope: \"world\",\n    config: true,\n    default: \"OBSERVER\",\n    type: String,\n    choices: {\n      OBSERVER: \"OWNERSHIP.OBSERVER\",\n      OWNER: \"OWNERSHIP.OWNER\",\n    },\n    onChange: () => canvas.perception.update({ refreshLighting: true, refreshVision: true }, true),\n  });\n\n  /**\n   * Enable vision for player characters by default.\n   */\n  game.settings.register(\"ffd20\", \"characterVision\", {\n    name: \"FFD20.SETTINGS.Vision.PCDefault\",\n    hint: \"FFD20.SETTINGS.Vision.PCDefaultHint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  game.settings.register(\"ffd20\", \"pcDisposition\", {\n    name: \"FFD20.SETTINGS.Token.PCDisposition\",\n    hint: \"FFD20.SETTINGS.Token.PCDispositionHint\",\n    type: String,\n    choices: {\n      NONE: \"FFD20.NoOverride\",\n      FRIENDLY: \"TOKEN.DISPOSITION.FRIENDLY\",\n      NEUTRAL: \"TOKEN.DISPOSITION.NEUTRAL\",\n    },\n    default: \"FRIENDLY\",\n    scope: \"world\",\n    config: true,\n  });\n\n  game.settings.register(\"ffd20\", \"npcDisposition\", {\n    name: \"FFD20.SETTINGS.Token.NPCDisposition\",\n    hint: \"FFD20.SETTINGS.Token.NPCDispositionHint\",\n    type: String,\n    choices: {\n      NONE: \"FFD20.NoOverride\",\n      NEUTRAL: \"TOKEN.DISPOSITION.NEUTRAL\",\n      HOSTILE: \"TOKEN.DISPOSITION.HOSTILE\",\n    },\n    default: \"NONE\",\n    scope: \"world\",\n    config: true,\n  });\n\n  game.settings.register(\"ffd20\", \"systemVision\", {\n    name: \"FFD20.SETTINGS.Vision.SystemControl\",\n    hint: \"FFD20.SETTINGS.Vision.SystemControlHint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    onChange: () => {\n      Object.values(ui.windows)\n        .filter((app) => app instanceof TokenConfig)\n        .forEach((app) => app.render());\n\n      // Initialize lighting is required for LLV to take effect\n      canvas.perception.update({ initializeLighting: true, refreshLighting: true, refreshVision: true }, true);\n    },\n  });\n\n  // CHAT CARDS\n\n  /**\n   * Option to automatically collapse Item Card descriptions\n   */\n  game.settings.register(\"ffd20\", \"autoCollapseItemCards\", {\n    name: \"FFD20.SETTINGS.Chat.AutoCollapse\",\n    hint: \"FFD20.SETTINGS.Chat.AutoCollapseHint\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ui.chat.render(),\n  });\n\n  /**\n   * Option to hide chat buttons\n   */\n  game.settings.register(\"ffd20\", \"hideChatButtons\", {\n    name: \"FFD20.SETTINGS.Chat.HideButtons\",\n    hint: \"FFD20.SETTINGS.Chat.HideButtonsHint\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => ui.chat.render(),\n  });\n\n  // HOMEBREW\n\n  /**\n   * Set coin weight\n   */\n  game.settings.register(\"ffd20\", \"coinWeight\", {\n    name: \"FFD20.SETTINGS.Houserules.CoinDivisor\",\n    hint: \"FFD20.SETTINGS.Houserules.CoinDivisorHint\",\n    scope: \"world\",\n    config: true,\n    default: 50,\n    type: Number,\n    requiresReload: true,\n  });\n\n  /**\n   * Default spellpoint cost\n   */\n  game.settings.register(\"ffd20\", \"spellPointCost\", {\n    name: \"FFD20.SETTINGS.Houserules.SpellPointCost\",\n    hint: \"FFD20.SETTINGS.Houserules.SpellPointCostHint\",\n    scope: \"world\",\n    config: true,\n    default: \"@sl\",\n    type: String,\n    onChange: () => ffd20.utils.refreshSheets({ reset: false }),\n  });\n\n  /**\n   * Use Dual Heal by default\n   */\n  game.settings.register(\"ffd20\", \"dualHeal\", {\n    name: \"FFD20.SETTINGS.DualHealDefault\",\n    hint: \"FFD20.SETTINGS.DualHealDefaultHint\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Alternative reach corner rule\n   */\n  game.settings.register(\"ffd20\", \"alternativeReachCornerRule\", {\n    name: \"FFD20.SETTINGS.Houserules.AltReach\",\n    hint: \"FFD20.SETTINGS.Houserules.AltReachHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Allow proficiencies on NPCs.\n   */\n  game.settings.register(\"ffd20\", \"npcProficiencies\", {\n    name: \"FFD20.SETTINGS.Houserules.NPCProficiencies\",\n    hint: \"FFD20.SETTINGS.Houserules.NPCProficienciesHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    onChange: () => ffd20.utils.refreshSheets({ reset: false }),\n    type: Boolean,\n  });\n\n  // TOKENS / CONDITIONS\n\n  /**\n   * Display default token conditions alongside system ones\n   */\n  game.settings.register(\"ffd20\", \"coreEffects\", {\n    name: \"FFD20.SETTINGS.CoreEffectsN\",\n    hint: \"FFD20.SETTINGS.CoreEffectsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  /**\n   * Hide token conditions\n   */\n  game.settings.register(\"ffd20\", \"hideTokenConditions\", {\n    name: \"FFD20.SETTINGS.HideTokenConditionsN\",\n    hint: \"FFD20.SETTINGS.HideTokenConditionsH\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    onChange: () => canvas.tokens?.placeables?.forEach((t) => t._applyRenderFlags({ redrawEffects: true })),\n  });\n\n  // TRANSPARENCY\n\n  /**\n   * Obfuscate roll details from non-observers.\n   */\n  game.settings.register(\"ffd20\", \"obscureInlineRolls\", {\n    name: \"FFD20.SETTINGS.Chat.ObscureInlineRolls\",\n    hint: \"FFD20.SETTINGS.Chat.ObscureInlineRollsHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  /**\n   * Hide DCs.\n   */\n  game.settings.register(\"ffd20\", \"obscureSaveDCs\", {\n    name: \"FFD20.SETTINGS.Chat.ObscureSaveDCs\",\n    hint: \"FFD20.SETTINGS.Chat.ObscureSaveDCsHint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  // COMBAT\n\n  game.settings.register(\"ffd20\", \"initiativeTiebreaker\", {\n    name: \"FFD20.SETTINGS.InitTiebreaker.Label\",\n    hint: \"FFD20.SETTINGS.InitTiebreaker.Hint\",\n    scope: \"world\",\n    config: true,\n    default: true,\n    type: Boolean,\n    requiresReload: true,\n  });\n\n  // USER INTERFACE\n\n  /**\n   * Skip action dialog prompts\n   */\n  game.settings.register(\"ffd20\", \"skipActionDialogs\", {\n    name: \"FFD20.SETTINGS.SkipActionDialogsN\",\n    hint: \"FFD20.SETTINGS.SkipActionDialogsH\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /*\n   * When skipping an action dialog prompt still place the template if one is configured\n   */\n  game.settings.register(\"ffd20\", \"placeMeasureTemplateOnQuickRolls\", {\n    name: \"FFD20.SETTINGS.MeasureOnQuickUse\",\n    hint: \"FFD20.SETTINGS.MeasureOnQuickUseHint\",\n    scope: \"client\",\n    config: true,\n    default: true,\n    type: Boolean,\n  });\n\n  /**\n   * Invert filter Shift-clicking\n   */\n  game.settings.register(\"ffd20\", \"invertSectionFilterShiftBehaviour\", {\n    name: \"FFD20.SETTINGS.Sheet.InvertFilters\",\n    hint: \"FFD20.SETTINGS.Sheet.InvertFiltersHint\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  // TARGETING\n\n  /**\n   * Disable targets for attack cards\n   */\n  game.settings.register(\"ffd20\", \"disableAttackCardTargets\", {\n    name: \"FFD20.SETTINGS.Chat.NoTargets\",\n    hint: \"FFD20.SETTINGS.Chat.NoTargetsHint\",\n    scope: \"world\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n\n  /**\n   * Clear targets after attack\n   */\n  game.settings.register(\"ffd20\", \"clearTargetsAfterAttack\", {\n    name: \"FFD20.SETTINGS.Chat.ClearTargets\",\n    hint: \"FFD20.SETTINGS.Chat.ClearTargetsHint\",\n    scope: \"client\",\n    config: true,\n    default: false,\n    type: Boolean,\n  });\n}\n\n/**\n * Migrate system settings.\n */\nexport function migrateSystemSettings() {\n  // Delete now unused compendium browser cache\n  game.settings.storage.get(\"client\").removeItem(\"ffd20.compendiumItems\");\n\n  if (!game.user.isGM) return;\n\n  // Currently empty, since the last option was removed (2022-06-06)\n}\n\n/**\n * Returns whether the user's settings and key presses signal that dialogs should be skipped.\n *\n * @returns {boolean} - True if prompt should be skipped\n */\nexport const getSkipActionPrompt = () => {\n  return (\n    (game.settings.get(\"ffd20\", \"skipActionDialogs\") && !ffd20.skipConfirmPrompt) ||\n    (!game.settings.get(\"ffd20\", \"skipActionDialogs\") && ffd20.skipConfirmPrompt)\n  );\n};\n","/**\n * Level-up and class addition handler.\n */\nexport class LevelUpForm extends FormApplication {\n  /**\n   * @internal\n   * @type {ActorPF}\n   */\n  actor;\n\n  /**\n   * Relevant token if any.\n   *\n   * @internal\n   * @type {TokenDocument}\n   */\n  token;\n\n  /**\n   * Temporary clone of the actor for seeing the results of various modifications with.\n   *\n   * @internal\n   * @type {ActorPF}\n   */\n  simulacra;\n\n  /**\n   * Temporary clone of the class to simulate changes.\n   *\n   * @type {ffd20.documents.item.ItemClassPF}\n   */\n  mold;\n\n  config = {\n    health: { manual: null, type: null, value: 0 },\n    fcb: { choice: \"none\", unavailable: false, available: true },\n    visibility: null,\n    feats: 0,\n    abilityScore: {\n      new: 0,\n      used: 0,\n      get available() {\n        return this.new - this.used;\n      },\n    },\n  };\n\n  static ICONS = {\n    fcb: {\n      none: \"\",\n      hp: \"systems/ffd20/icons/skills/green_19.jpg\",\n      skill: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n      alt: \"systems/ffd20/icons/skills/affliction_22.jpg\",\n    },\n    health: {\n      auto: \"\",\n      manual: \"systems/ffd20/icons/skills/green_19.jpg\",\n      roll: \"systems/ffd20/icons/items/inventory/dice.jpg\",\n    },\n  };\n\n  useBackgroundSkills = game.settings.get(\"ffd20\", \"allowBackgroundSkills\");\n\n  /**\n   * @internal\n   * @param {Actor} actor\n   * @param {Item} item\n   * @param {object} options\n   */\n  constructor(actor, item = null, options = {}) {\n    super(item, options);\n\n    if (item?.type !== \"class\") throw new Error(\"Can not level-up non-class items.\");\n\n    this.actor = actor ?? item?.actor ?? options.actor;\n\n    if (!this.actor) throw new Error(\"LevelUpForm needs an actor\");\n\n    this.token = this.actor?.token ?? options.token;\n\n    delete this.options.actor;\n    delete this.options.token;\n\n    this.config.isMythic = item.subType === \"mythic\";\n\n    this.config.level = {\n      old: item.system.level,\n      new: item.system.level + 1,\n      levelUp: item.system.level > 0,\n      hd: {\n        old: this.actor.system.attributes.hd.total,\n        new: null,\n      },\n    };\n\n    const config = this.config;\n    this.config.abilityScore.upgrades = Object.fromEntries(\n      Object.entries(ffd20.config.abilities).map(([key, label]) => [\n        key,\n        {\n          ...this.actor.system.abilities[key],\n          key,\n          label,\n          added: 0,\n          bonus: 0,\n          get isEnhanced() {\n            return this.total !== this.base;\n          },\n          get isNull() {\n            return this.base === null;\n          },\n          get isValid() {\n            return !this.isNull;\n          },\n          get isAvailable() {\n            return this.isValid && config.abilityScore.available > 0;\n          },\n          get isModified() {\n            return this.added != 0;\n          },\n        },\n      ])\n    );\n\n    // By default hide NPCs for GMs\n    if (!this.actor.hasPlayerOwner) this.config.visibility = CONST.DICE_ROLL_MODES.PRIVATE;\n\n    this._initData();\n    this._initChoices();\n  }\n\n  /**\n   * @type {ffd20.documents.item.ItemClassPF}\n   */\n  get item() {\n    return this.object;\n  }\n\n  set item(cls) {\n    this.object = cls;\n  }\n\n  get id() {\n    const parent = this.actor.uuid.replaceAll(\".\", \"-\");\n    const tag = this.item.system.tag || ffd20.utils.createTag(this.item.name);\n    return `level-up-${parent}-class-${tag}`;\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"level-up\"],\n      template: \"systems/ffd20/templates/apps/level-up.hbs\",\n      scrollY: [\"section\"],\n      width: 820,\n      height: \"auto\",\n      submitOnChange: true,\n      submitOnClose: false,\n      closeOnSubmit: false,\n      resizable: true,\n    });\n  }\n\n  get title() {\n    if (this.isLevelUp)\n      return game.i18n.format(\"FFD20.LevelUp.Increase\", { class: this.item.name }) + ` â ${this.actor.name}`;\n    else return game.i18n.format(\"FFD20.LevelUp.Add\", { class: this.item.name }) + ` â ${this.actor.name}`;\n  }\n\n  get isLevelUp() {\n    return this.item.system.level > 0;\n  }\n\n  get isNewClass() {\n    return !this.isLevelUp;\n  }\n\n  /**\n   * @param {Actor} actor - Owning actor\n   * @param {Item} item - Class item\n   * @param {object} [options={}] - Additional options\n   * @param {TokenDocument} [options.token] - Associated token\n   * @returns {Promise<Item|null|undefined>} - Updated class item if updated or null if process was cancelled. Undefined if this re-opened existing dialog.\n   */\n  static async increaseLevel(actor, item, { token } = {}) {\n    const app = Object.values(actor.apps).find((o) => o instanceof LevelUpForm && o._element && o.item === item);\n\n    if (app) app.render(true, { focus: true });\n    else return new Promise((resolve) => new this(actor, item, { token, resolve }).render(true, { focus: true }));\n  }\n\n  /**\n   * @param {Actor} actor - Owning actor\n   * @param {object} itemData - Class item data\n   * @param {object} [options={}] - Additional options\n   * @param {TokenDocument} [options.token] - Associated token\n   * @returns {Promise<Item | null>}\n   */\n  static async addClassWizard(actor, itemData, { token } = {}) {\n    // Add class item\n    const item = new Item.implementation(itemData, { parent: actor });\n    // Alter initial data\n    item.updateSource({ system: { hp: 0, level: 0 } });\n    item.reset();\n\n    // Add level up form for new class\n    return new Promise((resolve) => new this(actor, item, { token, resolve }).render(true, { focus: true }));\n  }\n\n  _prepareAssociations() {\n    if (this.config.associations) return;\n\n    const newLevel = this.config.level.new;\n\n    const assocs =\n      this.item.system.links?.classAssociations\n        ?.filter((a) => a.level === newLevel)\n        ?.map((a) => ({ ...fromUuidSync(a.uuid || \"\"), uuid: a.uuid })) ?? [];\n\n    this.config.associations = assocs;\n  }\n\n  async getData() {\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const hpOptions = hpConfig.getClassHD(this.item);\n\n    const itemData = this.item.toObject();\n\n    const fcb = this.config.fcb;\n    fcb.hp = itemData.system.fc?.hp?.value || 0;\n    fcb.skill = itemData.system.fc?.skill?.value || 0;\n    fcb.alt = itemData.system.fc?.alt?.value || 0;\n\n    const result = {\n      ...this.config,\n      item: itemData,\n      document: this.item,\n      actor: this.actor,\n      config: ffd20.config,\n      labels: {\n        fcb: {\n          skill: \"FFD20.LevelUp.FC.Skill.Label\",\n          hp: \"FFD20.LevelUp.FC.HP.Label\",\n          none: \"FFD20.LevelUp.FC.None.Label\",\n          alt: \"FFD20.LevelUp.FC.Alt.Label\",\n        },\n      },\n      fcb,\n      abilityScore: this.config.abilityScore,\n      icons: this.constructor.ICONS,\n      visibilityOptions: ffd20.const.messageVisibility,\n      useBackgroundSkills: this.useBackgroundSkills,\n    };\n\n    // Disallow self roll for non-GMs.\n    if (!game.user.isGM) delete result.visibilityOptions.selfroll;\n\n    result.health.rate = Math.round(hpOptions.rate * 100);\n\n    const hd = this.config.level.hd.total;\n    const tier = this.config.level.tier.total;\n\n    result.abilityScore.new = 0;\n    if (this.config.isMythic) {\n      result.abilityScore.new = ffd20.config.tierAbilityScores[tier] ?? 0;\n    } else {\n      result.abilityScore.new = ffd20.config.levelAbilityScores[hd] ?? 0;\n    }\n\n    result.health.value = result.health.delta;\n    switch (result.health.type) {\n      case \"manual\":\n        result.health.value += result.health.raw;\n        break;\n      case \"auto\":\n        result.health.value = result.health.raw;\n        break;\n      case \"roll\":\n        result.health.value = result.health.raw;\n        break;\n    }\n\n    result.skills.delta.ranks = result.skills.delta.adv;\n\n    // Apply FCB\n    result.health.bonus = 0;\n    switch (result.fcb.choice) {\n      case \"hp\":\n        result.health.value += 1;\n        result.health.bonus += 1;\n        break;\n      case \"skill\":\n        result.skills.delta.ranks += 1;\n        break;\n    }\n\n    // Apply abl mod\n    //result.health.value += result.health.ability.mod;\n\n    // Next ability score\n    result.abilityScore.next = this._getNextAbilityScoreLandmark();\n\n    result.ready = this.isReady();\n\n    return result;\n  }\n\n  /**\n   * Determine if this level-up is finalized.\n   *\n   * @returns {boolean}\n   */\n  isReady() {\n    if (!this.config.health.type) return false;\n    return this.config.abilityScore.available == 0;\n  }\n\n  /**\n   * Get level at which next ability score is gained.\n   *\n   * @internal\n   * @returns {number|null}\n   */\n  _getNextAbilityScoreLandmark() {\n    // Progression table\n    const table = this.config.isMythic ? ffd20.config.tierAbilityScores : ffd20.config.levelAbilityScores;\n\n    // HD or tier\n    const hdt = this.config.isMythic ? this.config.level.tier.total : this.config.level.hd.total;\n\n    const current = table[hdt] ?? 0;\n    if (current > 0) return null;\n\n    // Next ability score\n    const gains = Object.entries(table)\n      .map(([level, gained]) => Number(level))\n      .filter((level) => level > hdt);\n\n    return gains[0] ?? null;\n  }\n\n  /**\n   * Default health selection if auto health is not used.\n   *\n   * @internal\n   * @returns {string}\n   */\n  _getDefaultHealthOption() {\n    if (this.item.subType === \"mythic\") return \"static\";\n    if (this.config.health.auto) return \"auto\";\n    if (this.config.health.maximized) return \"max\";\n    return \"roll\";\n  }\n\n  /**\n   * Default hit points.\n   *\n   * @internal\n   * @returns {number}\n   */\n  _getDefaultHitPoints() {\n    return Math.ceil(1 + (this.item.system.hd - 1) / 2);\n  }\n\n  _prepareHealthData() {\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const clsConf = hpConfig.getClassHD(this.item);\n    const { auto, rate } = clsConf;\n\n    this.config.health.auto = auto;\n    this.config.health.manual ??= this._getDefaultHitPoints();\n    this.config.health.hitDie = this.item.system.hd || 8;\n\n    let delta = 0;\n    if (this.config.isMythic) {\n      delta = this.item.system.hd;\n    }\n    // Calculate auto health\n    else if (auto) {\n      const round = { up: Math.ceil, nearest: Math.round, down: Math.floor }[hpConfig.rounding];\n      const dieHealth = 1 + (this.item.system.hd - 1) * rate;\n      // Continuous\n      if (hpConfig.continuous) {\n        const { new: newHD, old: oldHD } = this.config.level.hd;\n        const newHP = newHD + round(newHD * dieHealth);\n        const oldHP = oldHD + round(oldHD * dieHealth);\n        delta = newHP - oldHP;\n      }\n      // Discrete\n      else {\n        delta = round(dieHealth);\n      }\n    }\n    // Manual health\n    else {\n      delta += this.config.health.manual;\n    }\n\n    this.config.health.delta = delta;\n\n    // Con mod\n    const hpAbl = this.simulacra.system.attributes?.hpAbility;\n    const hpMod = this.simulacra.system.abilities[hpAbl]?.mod ?? 0;\n    this.config.health.ability = { key: hpAbl, mod: hpMod };\n  }\n\n  _initData() {\n    this._prepareAssociations();\n\n    const cfg = this.config;\n\n    cfg.fcb.available = this.isFavouredClass();\n    cfg.fcb.unavailable = !cfg.fcb.available;\n\n    // Create temporary actor to get correct values for the new level\n    if (!this.simulacra) {\n      const actorData = this.actor.toObject();\n      const id = this.item.id ?? \"MOLD000000000000\";\n      // New items don't yet exist on actor, so we add simulation of one to the simulacra\n      if (!this.item.id) {\n        const itemData = this.item.toObject();\n        itemData._id = id;\n        actorData.items.push(itemData);\n      }\n      this.simulacra = new Actor.implementation(actorData);\n      this.mold = this.simulacra.items.get(id);\n    }\n\n    // Determine differences between current and new level\n    this.oldLevel ??= this.getLevelData(cfg.level.old);\n    const newLevel = this.getLevelData(cfg.level.new);\n    this.newLevel = newLevel;\n    cfg.level.hd = {\n      new: newLevel.hd,\n      old: this.oldLevel.hd,\n      total: newLevel.totalHD,\n    };\n    cfg.level.tier = {\n      new: newLevel.mythicTier,\n      old: this.oldLevel.mythicTier,\n      total: newLevel.totalMythicTier,\n    };\n    cfg.level.feats = newLevel.feats - this.oldLevel.feats;\n    // Saves\n    const oldSaves = this.actor.system.attributes?.savingThrows;\n    if (oldSaves) {\n      const newSaves = this.simulacra.system.attributes?.savingThrows;\n      cfg.level.fort = newSaves.fort.total - oldSaves.fort.total;\n      cfg.level.ref = newSaves.ref.total - oldSaves.ref.total;\n      cfg.level.will = newSaves.will.total - oldSaves.will.total;\n    }\n    cfg.level.bab = this.simulacra.system.attributes?.bab?.total - this.actor.system.attributes?.bab?.total;\n\n    cfg.health.raw = newLevel.hp - this.oldLevel.hp;\n\n    cfg.skills = {\n      new: newLevel.skills,\n      old: this.oldLevel.skills,\n    };\n\n    cfg.skills.delta = {\n      adv: cfg.skills.new.value - cfg.skills.old.value,\n      bg: cfg.skills.new.bg - cfg.skills.old.bg,\n    };\n    cfg.level.skills = cfg.skills.delta.adv + cfg.skills.delta.bg;\n\n    this._prepareHealthData();\n  }\n\n  getLevelData(level) {\n    const tempActor = this.simulacra;\n    const cls = this.mold;\n    cls.updateSource({ \"system.level\": level });\n    tempActor.reset();\n\n    let rollData = {};\n\n    const isMindless = tempActor.system.abilities?.int?.value === null;\n\n    // Rank counting\n    let advSkillRanks = 0;\n    let bgSkillRanks = 0;\n\n    const intMod = !isMindless ? (tempActor.system.abilities?.int?.mod ?? 0) : 0;\n\n    tempActor.itemTypes.class\n      .filter((cls) => cls.subType !== \"mythic\")\n      .forEach((cls) => {\n        const hd = cls.hitDice;\n        if (hd === 0) return;\n\n        const perLevel = cls.system.skillsPerLevel || 0;\n\n        if (perLevel > 0) advSkillRanks += Math.max(1, perLevel + intMod) * hd;\n\n        // Background skills\n        if (this.useBackgroundSkills && ffd20.config.backgroundSkillClasses.includes(cls.subType)) {\n          const bgranks = hd * ffd20.config.backgroundSkillsPerLevel;\n          if (bgranks > 0) bgSkillRanks += bgranks;\n        }\n      });\n\n    if (tempActor.system.details?.bonusSkillRankFormula) {\n      rollData = tempActor.getRollData();\n      const roll = Roll.defaultImplementation.safeRollSync(tempActor.system.details.bonusSkillRankFormula, rollData);\n      if (roll.err) console.error(`An error occurred in the Bonus Skill Rank formula of actor ${tempActor.name}.`);\n      advSkillRanks += roll.total || 0;\n    }\n\n    advSkillRanks += tempActor.system.details?.skills?.bonus || 0;\n\n    const feats = tempActor.getFeatCount().max;\n\n    return {\n      skills: { value: advSkillRanks, bg: bgSkillRanks },\n      feats,\n      hd: cls.hitDice,\n      totalHD: tempActor.system.attributes.hd.total,\n      mythicTier: cls.mythicTier,\n      totalMythicTier: tempActor.system.details.mythicTier,\n      hp: tempActor.system.attributes.hp.max,\n      bab: cls.system.babBase,\n      fort: cls.system.savingThrows?.fort?.base || 0,\n      ref: cls.system.savingThrows?.ref?.base || 0,\n      will: cls.system.savingThrows?.will?.base || 0,\n    };\n  }\n\n  /**\n   * @returns {boolean} Whether this form's associated class is a favoured class.\n   * @todo Add better logic for determining this <26-01-22, Furyspark>\n   */\n  isFavouredClass() {\n    return ffd20.config.favoredClassTypes.includes(this.item.subType);\n  }\n\n  async _updateObject(event, formData) {\n    const mhp = this.config.health.manual;\n\n    foundry.utils.mergeObject(this.config, foundry.utils.expandObject(formData));\n\n    if (mhp !== this.config.health.manual) {\n      this._prepareHealthData();\n      // Assume adjusting manual health means user wants to use it\n      this.config.health.type = \"manual\";\n    }\n\n    return this.render();\n  }\n\n  /**\n   * @override\n   * @param {JQuery<HTMLElement>} html\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find(\".ability-scores .ability-score .operator\").on(\"click\", this._onClickAbilityScoreOperator.bind(this));\n\n    // Allow opening class association items for inspection\n    html.find(\".item-list .item\").on(\"click\", this._openItemSheet.bind(this));\n\n    // Save button\n    html.find('button[data-action=\"commit\"]').on(\"click\", this._onCommit.bind(this));\n\n    // Manual/raw button\n    html.find('button[data-action=\"skip\"]').on(\"click\", this._onSkip.bind(this));\n  }\n\n  async _openItemSheet(event) {\n    const el = event.currentTarget;\n    const uuid = el.dataset.itemUuid;\n    const item = await fromUuid(uuid);\n    item.sheet.render(true, { focus: true });\n  }\n\n  _onClickAbilityScoreOperator(event) {\n    event.preventDefault();\n\n    const a = event.currentTarget;\n    const operator = a.dataset.operator;\n    const ablKey = a.closest(\".ability-score\").dataset.key;\n\n    // Determine how to adjust ability score\n    const add = this._adjustAbilityScore(ablKey, operator);\n    // Determine by how much\n    const value = this._adjustAbilityScoreValue(ablKey, add);\n\n    const abls = this.config.abilityScore;\n    const upgrades = abls.upgrades[ablKey];\n\n    const cost = this._adjustAbilityScoreCost(ablKey, value);\n\n    upgrades.value += value;\n    upgrades.added += cost;\n    abls.used += cost;\n\n    this.simulacra.updateSource({ system: { abilities: { [ablKey]: { value: upgrades.value } } } });\n\n    // Cross-pollinate new data\n    foundry.utils.mergeObject(upgrades, this.simulacra.system.abilities[ablKey]);\n    this._initData();\n\n    this.render();\n  }\n\n  /**\n   * @internal\n   * @param {string} key - Ability score key\n   * @param {string} op - Operator clicked\n   * @returns {-1|0|1} - Direction of adjustment\n   */\n  _adjustAbilityScore(key, op = null) {\n    switch (op) {\n      case \"add\":\n        return 1;\n      default:\n        return 0;\n      case \"subtract\":\n        return -1;\n    }\n  }\n\n  /**\n   * Determine actual ability score adjustment value.\n   *\n   * By default 1 for normal level-ups, 2 for mythic tiers.\n   *\n   * Uses {@link ffd20.config.levelAbilityScoreMult} and {@link ffd20.config.tierAbilityScoreMult} as multipliers.\n   *\n   * @param {string} key\n   * @param {number} value\n   * @returns {number}\n   */\n  _adjustAbilityScoreValue(key, value) {\n    return value * (this.config.isMythic ? ffd20.config.tierAbilityScoreMult : ffd20.config.levelAbilityScoreMult);\n  }\n\n  /**\n   * Return cost of the adjustment.\n   *\n   * For homebrew support.\n   *\n   * @param {string} key\n   * @param {number} value\n   * @returns {number}\n   */\n  _adjustAbilityScoreCost(key, value) {\n    return value;\n  }\n\n  _initChoices() {\n    this._initFCBChoices();\n    this._initHPChoices();\n  }\n\n  _initFCBChoices() {\n    if (!this.config.fcb.available) return;\n\n    // Pre-select highest FCB\n    const { hp, skill, alt } = this.item.system.fc;\n    const fcb = [\n      { id: \"hp\", value: hp?.value || 0 },\n      { id: \"skill\", value: skill?.value || 0 },\n      { id: \"alt\", value: alt?.value || 0 },\n    ].sort((a, b) => b.value - a.value);\n\n    const highest = fcb[0];\n    if (highest.value > 0) this.config.fcb.choice = highest.id;\n  }\n\n  _initHPChoices() {\n    this.config.health.type = this._getDefaultHealthOption();\n\n    if (this.config.isMythic) return;\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const clsConf = hpConfig.getClassHD(this.item);\n\n    if (clsConf.maximized) {\n      const maxHDlimit = hpConfig.maximized;\n\n      const maximized = this.actor.itemTypes.class.reduce((maximized, cls) => {\n        if (!hpConfig.getClassHD(this.item).maximized) return maximized;\n        return maximized + cls.hitDice;\n      }, 0);\n\n      const maxLeft = hpConfig.maximized - maximized;\n      this.config.health.maximized = Math.max(0, maxLeft);\n\n      // Maximize auto health, too.\n      if (maxLeft > 0) {\n        this.config.health.delta = this.config.health.hitDie;\n        this.config.health.type = \"max\";\n      }\n    }\n  }\n\n  /**\n   * @protected\n   * @override\n   */\n  async close(options) {\n    this.resolve?.(null);\n    return super.close(options);\n  }\n\n  /**\n   * Get effective health roll formula.\n   *\n   * @internal\n   * @param {string} type\n   * @returns {string}\n   */\n  _getHealthFormula(type) {\n    const dieSize = this.item.system.hd;\n    switch (type) {\n      case \"static\":\n        return `${dieSize}`;\n      default:\n        return `1d${dieSize}`;\n    }\n  }\n\n  /**\n   * Spoof roll, for maximized, auto and manual health.\n   *\n   * @internal\n   * @param {Roll} roll\n   * @param {number} value\n   * @returns {Roll}\n   */\n  _spoofHealthRoll(roll, value) {\n    const data = roll.toJSON();\n    data.total = value;\n    data.terms[0].results[0].result = value;\n    return Roll.defaultImplementation.fromData(data);\n  }\n\n  /**\n   * Generate roll instance for the health gain.\n   *\n   * @internal\n   * @param {string} type\n   * @param {string} formula\n   * @returns {Promise<ffd20.dice.RollPF>}\n   */\n  async _getHealthRoll(type, formula) {\n    const roll = await Roll.defaultImplementation.safeRoll(formula);\n    switch (type) {\n      case \"auto\":\n      case \"max\":\n        return this._spoofHealthRoll(roll, this.config.health.delta);\n      case \"manual\":\n        return this._spoofHealthRoll(roll, this.config.health.manual);\n      default:\n        return roll;\n    }\n  }\n\n  /**\n   * Commit level-up\n   *\n   * @internal\n   * @param {Event} event\n   */\n  async _onCommit(event) {\n    this._disableSheet();\n\n    const cfg = this.config;\n    const itemData = this.item.toObject().system;\n    const updateData = {};\n\n    const newLevel = itemData.level + 1;\n    const cardData = {\n      isMythic: this.config.isMythic,\n      level: {\n        previous: itemData.level,\n        new: newLevel,\n      },\n      newFeatures: this.config.associations,\n      hp: {},\n    };\n\n    const formula = this._getHealthFormula(cfg.health.type);\n    const roll = await this._getHealthRoll(cfg.health.type, formula);\n\n    const labels = {\n      manual: \"FFD20.LevelUp.Chat.Health.Manual\",\n      roll: \"FFD20.LevelUp.Chat.Health.Roll\",\n      max: \"FFD20.LevelUp.Chat.Health.Auto\",\n      auto: \"FFD20.LevelUp.Chat.Health.Auto\",\n      static: \"FFD20.LevelUp.Chat.Health.Static\",\n    };\n\n    cardData.hp = {\n      label: labels[cfg.health.type],\n      roll,\n      add: roll.toAnchor({ classes: [\"inline-dsn-hidden\"] }).outerHTML,\n    };\n\n    const hpValue = roll.total || 0;\n    updateData.hp = (itemData.hp || 0) + hpValue;\n\n    // Apply FCB\n    if (cfg.fcb.choice in itemData.fc) {\n      const key = cfg.fcb.choice;\n      const value = itemData.fc?.[key]?.value ?? 0;\n      foundry.utils.setProperty(updateData, `fc.${key}.value`, value + 1);\n\n      const fcKey = { hp: \"HP\", skill: \"Skill\", alt: \"Alt\" }[key];\n      cardData.fc = { type: key, label: `FFD20.FavouredClassBonus.${fcKey}` };\n    }\n\n    // Gather information\n    const oldFeatCount = this.actor.getFeatCount();\n\n    const itemUpdates = [],\n      newItems = [];\n\n    // Apply ability score changes\n    const ablUpdate = this._updateAbilityScore();\n    if (ablUpdate) {\n      if (ablUpdate.update) itemUpdates.push(ablUpdate.itemData);\n      else newItems.push(ablUpdate.itemData);\n\n      cardData.ability = Object.entries(this.config.abilityScore.upgrades).reduce((rv, [key, { added }]) => {\n        if (added == 0) return rv;\n        rv[key] = added;\n        return rv;\n      }, {});\n    }\n\n    updateData.level = newLevel;\n    let cls = this.item;\n    // Update existing class item\n    if (cls.actor && cls.id) {\n      itemUpdates.unshift({ system: updateData, _id: cls.id });\n    }\n    // Create new class item\n    else {\n      cls.updateSource({ system: updateData });\n      newItems.unshift(cls.toObject());\n    }\n\n    // Add items\n    if (newItems.length) {\n      await this.actor.createEmbeddedDocuments(\"Item\", newItems, { render: itemUpdates.length == 0 });\n    }\n\n    if (itemUpdates.length) {\n      const newItems = await this.actor.updateEmbeddedDocuments(\"Item\", itemUpdates);\n      cls = newItems.find((i) => i.type === \"class\");\n      if (cls) this.item = cls;\n    }\n\n    // Prepare remaining chat card info\n\n    // Add extra info (new feats, skill ranks, etc.)\n    const ex = {};\n    cardData.extra = ex;\n\n    // Show new feat count\n    const featCount = this.actor.getFeatCount();\n    featCount.new = Math.max(0, featCount.max - oldFeatCount.max);\n    ex.feats = featCount;\n    ex.enabled = featCount.new > 0;\n\n    // Create chat message\n    await this.createChatMessage(cardData);\n\n    // Resolve promise and close interface\n    this.resolve?.(cls);\n    this.close();\n  }\n\n  async _onSkip(event) {\n    event.preventDefault();\n\n    this._disableSheet();\n\n    const updateData = { system: { level: this.config.level.new } };\n\n    let cls = this.item;\n\n    // Old class\n    if (cls.id && cls.actor === this.actor) {\n      await cls.update(updateData);\n    }\n    // New class item\n    else {\n      cls.updateSource(updateData);\n      cls = await Item.implementation.create(cls.toObject(), { parent: this.actor });\n    }\n\n    // Open class sheet for manual adjustment\n    cls.sheet.render(true, { focus: true });\n\n    this.resolve?.(null);\n    this.close();\n  }\n\n  // Disable all buttons and inputs and set progress indicator\n  _disableSheet() {\n    const html = this.element[0];\n    const form = html.querySelector(\"form\");\n    form.style.cursor = \"progress\";\n    form.querySelectorAll(\"button,input,select\").forEach((button) => {\n      button.disabled = true;\n      button.style.cursor = \"progress\";\n    });\n  }\n\n  _updateAbilityScore() {\n    // No ability score upgrades this level\n    if (!this.config.abilityScore.upgrades) return;\n\n    const choices = Object.entries(this.config.abilityScore.upgrades).reduce((rv, [key, { added }]) => {\n      if (added == 0) return rv;\n      rv[key] = added;\n      return rv;\n    }, {});\n\n    if (Object.keys(choices).length === 0) return;\n\n    const result = { choices };\n\n    const item = this.actor.itemTypes.feat.find((o) => o.getFlag(\"ffd20\", \"levelUp\") === true);\n\n    // Add level up ability score feature if it doesn't exist yet\n    if (!item) {\n      let itemData = ffd20.config.levelAbilityScoreFeature;\n      itemData = foundry.utils.mergeObject(\n        itemData,\n        {\n          system: {\n            changes: Object.entries(choices).reduce((cur, [target, formula]) => {\n              const change = new ffd20.components.ItemChange({\n                target,\n                formula: `${formula}`,\n                type: \"untypedPerm\",\n              }).toObject();\n\n              cur.push(change);\n              return cur;\n            }, []),\n          },\n          flags: {\n            ffd20: {\n              levelUp: true,\n            },\n          },\n        },\n        { inplace: false }\n      );\n\n      return { itemData, update: false };\n    }\n    // If a level up ability score feature already exists, update it\n    else {\n      const changes = item.toObject().system.changes ?? [];\n      for (const [target, formula] of Object.entries(choices)) {\n        const change = changes.find((o) => o.target === target);\n\n        // Update previous change\n        if (change) {\n          const prevValue = parseInt(change.formula);\n          if (!Number.isNaN(prevValue)) {\n            const newValue = prevValue + formula;\n            change.formula = `${newValue}`;\n            continue;\n          }\n        }\n\n        // Add new change\n        changes.push(\n          new ffd20.components.ItemChange({\n            target,\n            formula: `${formula}`,\n            type: \"untypedPerm\",\n          }).toObject()\n        );\n      }\n\n      return { itemData: { \"system.changes\": changes, _id: item.id }, update: true };\n    }\n  }\n\n  async createChatMessage(cardData) {\n    const templateData = {\n      ...cardData,\n      config: ffd20.config,\n      item: this.item,\n      actor: this.actor,\n    };\n\n    const rolls = cardData.hp?.roll ? [cardData.hp.roll] : [];\n\n    const messageData = {\n      content: await renderTemplate(\"systems/ffd20/templates/chat/level-up.hbs\", templateData),\n      style: CONST.CHAT_MESSAGE_STYLES.OOC,\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this.actor, token: this.token }),\n      rolls,\n      system: {\n        subject: { class: \"levelUp\" },\n      },\n    };\n\n    let rollMode = this.config.visibility || game.settings.get(\"core\", \"rollMode\");\n    // Prevent self message from non-GMs.\n    if (!game.user.isGM && rollMode === CONST.DICE_ROLL_MODES.SELF) rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\n\n    ChatMessage.implementation.applyRollMode(messageData, rollMode); // rollMode here sometimes has no effect?\n    return ChatMessage.create(messageData, { rollMode }); // rollMode here has no effect?\n  }\n}\n","export class CurrencyTransfer extends FormApplication {\n  constructor(\n    source = { actor: null, container: null, amount: {}, alt: false },\n    dest = { actor: null, container: null, amount: {}, alt: false },\n    options = {}\n  ) {\n    super(options);\n\n    if (source.actor) {\n      if (typeof source.actor === \"string\") source.actor = game.actors.get(source.actor);\n      if (source.actor.type == \"npc\") source.alt = false;\n    }\n    if (source.container) {\n      source.alt = false;\n      if (typeof source.container === \"string\")\n        source.container = source.actor ? source.actor.items.get(source.container) : game.items.get(source.container);\n    }\n    if (dest.actor) {\n      if (typeof dest.actor === \"string\") dest.actor = game.actors.get(dest.actor);\n      if (dest.actor.type == \"npc\") dest.alt = false;\n      else if (dest.actor === source.actor && !source.container && !dest.container) dest.alt = !source.alt;\n    }\n    if (dest.container) {\n      if (typeof dest.container === \"string\")\n        dest.container = dest.actor ? dest.actor.items.get(dest.container) : game.items.get(dest.container);\n    }\n\n    // Currency checks\n    if (source.container) {\n      source.amount = foundry.utils.mergeObject(source.container.system.currency, source.amount ?? {});\n    } else if (source.actor) {\n      source.amount = foundry.utils.mergeObject(\n        source.alt ? source.actor.system.altCurrency : source.actor.system.currency,\n        source.amount ?? {}\n      );\n    } else if (game.user.isGM) {\n      source.amount = foundry.utils.mergeObject({ pp: \"â\", gp: \"â\", sp: \"â\", cp: \"â\" }, source.amount ?? {});\n    } else {\n      ui.notification.warning(\"Cannot use Infinite currency transfer as non-gm.\");\n      return undefined;\n    }\n\n    if (!dest.actor && !dest.container) return undefined;\n\n    this.source = source;\n    this.dest = dest;\n  }\n\n  get title() {\n    let title;\n    if (!this.source.actor) {\n      if (this.source.container) title = this.source.container.name + \" \";\n      else title = \"â \";\n    } else {\n      title = this.source.actor.name + \" \";\n      if (this.source.container) title += `(${this.source.container.name}) `;\n    }\n    title += \"â¤ \";\n    if (this.source.actor == this.dest.actor && (this.source.alt || this.dest.alt))\n      title += this.dest.alt ? game.i18n.localize(\"FFD20.Currency.Weightless\") : game.i18n.localize(\"FFD20.Currency.Label\");\n    else {\n      if (!this.dest.actor) title += this.dest.container.name;\n      else {\n        title += this.dest.actor.name;\n        if (this.dest.container) title += ` (${this.dest.container.name})`;\n      }\n    }\n    return title;\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: [\"ffd20\", \"currency-transfer\"],\n      template: \"systems/ffd20/templates/apps/currency-transfer.hbs\",\n      width: 380,\n      height: 235,\n    });\n  }\n\n  /**\n   * Order of coin types, descending in value\n   *\n   * @type {CoinType[]}\n   */\n  static get order() {\n    return [\"pp\", \"gp\", \"sp\", \"cp\"]; // Object conversion ordering cannot be trusted in js\n  }\n\n  activateListeners(html) {\n    html.find(\"button.cur-range\").click(this._curRange.bind(this));\n\n    html.find(\"input\").on(\"input\", this._calcTotal.bind(this));\n    $(html.find(\"input\")[0]).trigger(\"input\");\n  }\n\n  _updateObject(event, formData) {\n    this.dest.amount = {\n      pp: formData.pp ?? 0,\n      gp: formData.gp ?? 0,\n      sp: formData.sp ?? 0,\n      cp: formData.cp ?? 0,\n    };\n    this.constructor.transfer(\n      this.source.container ? this.source.container : this.source.actor,\n      this.dest.container ? this.dest.container : this.dest.actor,\n      this.dest.amount,\n      this.source.alt,\n      this.dest.alt,\n      2\n    );\n  }\n\n  getData(_options = {}) {\n    return {\n      source: this.source,\n      dest: this.dest,\n      options: this.options,\n      title: this.title,\n      total:\n        this.source.amount.gp === \"â\"\n          ? \"â\"\n          : this.constructor.order.reduce((acc, c, idx) => acc + this.source.amount[c] * 10 ** (1 - idx), 0),\n    };\n  }\n\n  _curRange(ev) {\n    ev.preventDefault();\n    const button = ev.target.closest(\"button\");\n    const formField = button.closest(\".form-fields\");\n    const min = button.classList.contains(\"down\");\n    const input = formField.querySelector(\"input\");\n\n    if (min) input.value = \"\";\n    else input.value = formField.querySelector(\"span\").textContent;\n    $(input).trigger(\"input\");\n  }\n\n  _calcTotal(ev) {\n    const form = ev.target.closest(\".currency-transfer\");\n    const amounts = Object.fromEntries(\n      [...form.querySelectorAll(\"input\")].map((o) => [o.name, parseInt(o.value || 0)])\n    );\n    const value = this.constructor.order.reduce((acc, c, idx) => acc + amounts[c] * 10 ** (1 - idx), 0);\n\n    form.querySelector(\".currency-total .form-fields label\").textContent = Math.round(value * 100) / 100 + \" gp\";\n  }\n\n  static _failed(i18nKey) {\n    return void ui.notifications.error(\n      game.i18n.localize(\"FFD20.Application.CurrencyTransfer.Failed\") + game.i18n.localize(i18nKey)\n    );\n  }\n\n  static async _directoryDrop(docDestId, event) {\n    event.preventDefault();\n\n    // try to extract the data\n    const data = TextEditor.getDragEventData(event);\n    if (data.type !== \"Currency\") return;\n\n    const destDoc = event.currentTarget.classList.contains(\"item\")\n      ? game.items.get(docDestId)\n      : game.actors.get(docDestId);\n\n    const sourceActor = await fromUuid(data.actorUuid || \"\");\n\n    if (data.currency && sourceActor) {\n      return new CurrencyTransfer(\n        { actor: sourceActor, container: data.containerId, alt: data.alt },\n        {\n          actor: destDoc?.actor ?? destDoc,\n          container: destDoc.system.type === \"container\" ? destDoc.id : null,\n          amount: Object.fromEntries([[data.currency, parseInt(data.amount)]]),\n        }\n      ).render(true);\n    }\n  }\n\n  /**\n   * Transfer an amount of currency to a valid document\n   *\n   * @param {Document} sourceDoc ActorPF or ItemPF with currency\n   * @param {Document} destDoc ActorPF or ItemPF with currency\n   * @param {object|number} amount currency object containing transferred amount. Undefined keys will be assumed to be zero. Providing just a number will assume just gold\n   * @param {boolean} sourceAlt Use alt currency on source\n   * @param {boolean} destAlt Use alt currency on destination\n   * @param {number} [allowConversion=false] Attempts to make change with sourceDoc's currency limit\n   * @returns {Promise<boolean|object>} false if failed, object containing amount transferred on success\n   */\n  static async transfer(sourceDoc, destDoc, amount, sourceAlt = false, destAlt = false, allowConversion = false) {\n    if ((!sourceDoc && !game.user.isGM) || !destDoc || !amount) return false;\n\n    if (typeof amount !== \"object\") amount = { gp: parseInt(amount) };\n\n    this.order.forEach((c) => (amount[c] = amount[c] ?? 0));\n    if (!Object.values(amount).find((a) => a > 0))\n      return this._failed(\"FFD20.Application.CurrencyTransfer.Insufficient\"), false;\n\n    let sourceCurrency = foundry.utils.deepClone(\n      sourceAlt ? sourceDoc?.system.altCurrency : sourceDoc?.system.currency\n    );\n    const destCurrency = foundry.utils.deepClone(destAlt ? destDoc.system.altCurrency : destDoc.system.currency);\n    if ((!sourceCurrency && !game.user.isGM) || !destCurrency) return false;\n    const originalSource = Object.assign(Object.fromEntries(this.order.map((o) => [o, Infinity])), sourceCurrency);\n\n    const totalAmount = this.order.reduce((acc, c, idx) => acc + amount[c] * 10 ** (1 - idx), 0);\n    const totalSource = this.order.reduce((acc, c, idx) => acc + sourceCurrency[c] * 10 ** (1 - idx), 0);\n\n    if (totalAmount > totalSource) return this._failed(\"FFD20.Application.CurrencyTransfer.Insufficient\"), false;\n\n    if (sourceCurrency) {\n      this.order.some((a) => {\n        const newSource = sourceCurrency[a] - amount[a];\n\n        if (newSource < 0 && allowConversion) {\n          amount = this.convert(originalSource, totalAmount, allowConversion);\n          sourceCurrency = Object.fromEntries(this.order.map((o) => [o, originalSource[o] - amount[o]]));\n          return true;\n        } else sourceCurrency[a] = newSource;\n      });\n    }\n\n    if (!amount || Object.values(sourceCurrency).find((c) => c < 0)) return false;\n\n    if (!sourceDoc.isOwner || !destDoc.isOwner) {\n      if (!game.users.find((o) => o.active && o.isGM))\n        return this._failed(\"FFD20.Application.CurrencyTransfer.GMRequired\"), false;\n\n      game.socket.emit(\"system.ffd20\", {\n        eventType: \"currencyTransfer\",\n        data: {\n          sourceActor: sourceDoc.actor?.uuid ?? sourceDoc.uuid,\n          destActor: destDoc.actor?.uuid ?? destDoc.uuid,\n          sourceContainer: sourceDoc.type === \"container\" ? sourceDoc.id : \"\",\n          destContainer: destDoc.type === \"container\" ? destDoc.id : \"\",\n          sourceAlt,\n          destAlt,\n          amount,\n        },\n      });\n      return amount;\n    }\n\n    this.order.forEach((c) => (destCurrency[c] += amount[c]));\n    if (sourceDoc === destDoc)\n      return sourceDoc.update({\n        \"system.altCurrency\": sourceAlt ? sourceCurrency : destCurrency,\n        \"system.currency\": destAlt ? sourceCurrency : destCurrency,\n      });\n    if (sourceAlt) sourceDoc.update({ \"system.altCurrency\": sourceCurrency });\n    else sourceDoc.update({ \"system.currency\": sourceCurrency });\n    if (destAlt) destDoc.update({ \"system.altCurrency\": destCurrency });\n    else destDoc.update({ \"system.currency\": destCurrency });\n    return amount;\n  }\n\n  /**\n   * Convert totalAmount to a currency object containing\n   *\n   * @param {object} limit currency object containing max number of coins. Falsey values will assume infinity\n   * @param {number|object} totalAmount currency as gold pieces. If provided as a currency object, will convert to gold\n   * @returns {boolean|object} false if failed, currency object containing new amounts on conversion success\n   */\n  static convert(limit, totalAmount) {\n    if (!limit) limit = Object.fromEntries(this.order.map((o) => [o, Infinity]));\n    else limit = Object.assign({}, limit);\n    if (typeof totalAmount !== \"number\")\n      totalAmount = this.order.reduce((acc, cur, idx) => acc + totalAmount?.[cur] * 10 ** (1 - idx));\n    if (!totalAmount) return false;\n    const amount = {};\n    totalAmount =\n      this.order.reduce((acc, cur, idx) => {\n        const minRequired = Math.min(limit[cur], Math.floor((acc % 10000) / 10 ** (3 - idx))), //Start from left to allow clumping\n          inCopper = minRequired * 10 ** (3 - idx);\n        amount[cur] = minRequired;\n        limit[cur] -= minRequired;\n        return acc - inCopper;\n      }, totalAmount * 100) / 100; //Operate in copper pieces to avoid floating point errors\n    if (totalAmount < 0) return false;\n    return amount;\n  }\n}\n","/**\n * @typedef {typeof templatePaths[number]} CachedTemplatePath\n * A path to a template that has been cached as part of the partial preloading process.\n */\n\n/**\n * A list of template paths to pre-load\n *\n * @private\n */\nconst templatePaths = /** @type {const} */ ([\n  // Actor Sheet Partials\n  \"systems/ffd20/templates/actors/parts/actor-summary.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-level.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-traits.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-inventory.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-item-nav-filters.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-features.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-spellbook-front.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-spellbook.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-skills-front.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-skills.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-combat.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-defenses_tables.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-buffs.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-attributes.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-settings.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-settings-ability-scores.hbs\",\n  \"systems/ffd20/templates/actors/parts/actor-item-summary.hbs\",\n\n  \"systems/ffd20/templates/internal/item-search.hbs\",\n\n  \"systems/ffd20/templates/internal/table_magic-items.hbs\",\n\n  // Item Sheet Partials\n  \"systems/ffd20/templates/items/parts/item-actions.hbs\",\n  \"systems/ffd20/templates/items/parts/item-advanced.hbs\",\n  \"systems/ffd20/templates/items/parts/item-alignments.hbs\",\n  \"systems/ffd20/templates/items/parts/item-ammo.hbs\",\n  \"systems/ffd20/templates/items/parts/item-aura.hbs\",\n  \"systems/ffd20/templates/items/parts/item-base-types.hbs\",\n  \"systems/ffd20/templates/items/parts/item-changes.hbs\",\n  \"systems/ffd20/templates/items/parts/item-class-link.hbs\",\n  \"systems/ffd20/templates/items/parts/item-contents.hbs\",\n  \"systems/ffd20/templates/items/parts/item-description.hbs\",\n  \"systems/ffd20/templates/items/parts/item-instructions.hbs\",\n  \"systems/ffd20/templates/items/parts/item-sidebar-inputs.hbs\",\n  \"systems/ffd20/templates/items/parts/item-sidebar-tags.hbs\",\n  \"systems/ffd20/templates/items/parts/item-sidebar-conditions.hbs\",\n  \"systems/ffd20/templates/items/parts/item-sidebar-aura.hbs\",\n  \"systems/ffd20/templates/items/parts/item-links.hbs\",\n  \"systems/ffd20/templates/items/parts/item-materials-addon.hbs\",\n  \"systems/ffd20/templates/items/parts/item-materials.hbs\",\n  \"systems/ffd20/templates/items/parts/item-name.hbs\",\n  \"systems/ffd20/templates/items/parts/item-notes.hbs\",\n  \"systems/ffd20/templates/items/parts/item-proficiencies.hbs\",\n  \"systems/ffd20/templates/items/parts/item-class-skills.hbs\",\n  \"systems/ffd20/templates/items/parts/item-creature-type.hbs\",\n  \"systems/ffd20/templates/items/parts/item-conditions.hbs\",\n  \"systems/ffd20/templates/items/parts/item-size.hbs\",\n  \"systems/ffd20/templates/items/parts/item-tag.hbs\",\n  \"systems/ffd20/templates/items/parts/item-tags.hbs\",\n  \"systems/ffd20/templates/items/parts/item-weapon-groups.hbs\",\n  \"systems/ffd20/templates/items/parts/spell-descriptors.hbs\",\n  \"systems/ffd20/templates/items/parts/spell-multischool.hbs\",\n  \"systems/ffd20/templates/items/parts/spell-subschool.hbs\",\n  \"systems/ffd20/templates/items/parts/item-action-summary.hbs\",\n\n  \"systems/ffd20/templates/internal/content-source-view.hbs\",\n\n  // Apps\n  \"systems/ffd20/templates/apps/attack-roll-dialog.hbs\",\n  \"systems/ffd20/templates/apps/vision-sharing.hbs\",\n  \"systems/ffd20/templates/apps/help-browser.hbs\",\n  \"systems/ffd20/templates/apps/action-select.hbs\",\n\n  // Item Action Partials\n  \"systems/ffd20/templates/apps/item-action/action.hbs\",\n  \"systems/ffd20/templates/apps/item-action/activation.hbs\",\n  \"systems/ffd20/templates/apps/item-action/template.hbs\",\n  \"systems/ffd20/templates/apps/item-action/conditionals.hbs\",\n\n  // Compendium browser partials\n  \"systems/ffd20/templates/apps/compendium-browser/entries.hbs\",\n  \"systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs\",\n  \"systems/ffd20/templates/apps/compendium-browser/text-filter.hbs\",\n\n  // Chat\n  \"systems/ffd20/templates/chat/roll-ext.hbs\",\n  \"systems/ffd20/templates/chat/defenses.hbs\",\n  \"systems/ffd20/templates/chat/defenses-vehicle.hbs\",\n  \"systems/ffd20/templates/chat/parts/gm-description.hbs\",\n\n  // Chat card partials\n  \"systems/ffd20/templates/chat/parts/attack-roll-header.hbs\",\n  \"systems/ffd20/templates/chat/parts/attack-roll-footer.hbs\",\n  \"systems/ffd20/templates/chat/parts/attack-roll-targets.hbs\",\n\n  \"systems/ffd20/templates/chat/parts/item-notes.hbs\",\n\n  // Item description headers\n  \"systems/ffd20/templates/items/headers/spell-header.hbs\",\n\n  // Internal Rendering Partials\n  \"systems/ffd20/templates/internal/token-config_vision.hbs\",\n  \"systems/ffd20/templates/internal/damage-type-visual.hbs\",\n\n  \"systems/ffd20/templates/hud/quick-actions.hbs\",\n\n  // Level Up sections\n  \"systems/ffd20/templates/apps/level-up/health.hbs\",\n  \"systems/ffd20/templates/apps/level-up/ability-score.hbs\",\n  \"systems/ffd20/templates/apps/level-up/fcb.hbs\",\n  \"systems/ffd20/templates/apps/level-up/summary.hbs\",\n\n  // Dynamic tooltips\n  \"systems/ffd20/templates/extended-tooltip.hbs\",\n]);\n\n/**\n * Define a set of template paths to pre-load\n * Pre-loaded templates are compiled and cached for fast access when rendering\n *\n * @internal\n * @private\n * @returns {Promise<void>} - A Promise resolving once the templates are loaded.\n */\nexport const preload = async () => void loadTemplates(templatePaths);\n\n/**\n * Synchronously render a cached Handlebars template using provided data.\n *\n * @internal\n * @private\n * @see {renderTemplate}\n * @param {CachedTemplatePath} path - The template identifier\n * @param {object} [data={}] - The data provided to the template\n * @returns {string} The rendered HTML\n * @throws {Error} If the requested template could not be found in the cache\n */\nexport const renderCachedTemplate = (path, data = {}) => {\n  /** @type {Handlebars.TemplateDelegate|undefined} */\n  const template = Handlebars.partials[path];\n  if (!template) throw new Error(`Template ${path} not found in cache`);\n\n  return template(data, {\n    allowProtoMethodsByDefault: true,\n    allowProtoPropertiesByDefault: true,\n    preventIndent: true,\n  });\n};\n","import { ActorTraitSelector } from \"@app/trait-selector.mjs\";\nimport { DamageResistanceSelector } from \"@app/damage-resistance-selector.mjs\";\nimport { ActorRestDialog } from \"./actor-rest.mjs\";\nimport { PointBuyCalculator } from \"@app/point-buy-calculator.mjs\";\nimport { Widget_ItemPicker } from \"@app/item-picker.mjs\";\nimport { getSkipActionPrompt } from \"@documents/settings.mjs\";\nimport { LevelUpForm } from \"@app/level-up.mjs\";\nimport { CurrencyTransfer } from \"@app/currency-transfer.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\nimport { renderCachedTemplate } from \"@utils/handlebars/templates.mjs\";\n\n/** @import {AbilityScoreData} from \"@documents/actor/actor.d.ts\" */\n\n/**\n * Extend the basic ActorSheet class to do all the PF things!\n * This sheet is an Abstract layer which is not used.\n */\nexport class ActorSheetPF extends ActorSheet {\n  /**\n   * Track the set of item filters which are applied\n   *\n   * @protected\n   * @internal\n   * @type {Record<string, Record<string, Set<string>>>}\n   */\n  _filters = {\n    sections: {},\n    search: {},\n  };\n\n  /** Item search */\n  searchCompositioning = false; // for IME\n  searchRefresh = true; // Lock out same term search unless sheet also refreshes\n  searchDelay = 250; // arbitrary ?ms for arbitrarily decent reactivity; MMke this configurable?\n  searchDelayEvent = null; // setTimeout id\n  effectiveSearch = {}; // prevent searching the same thing\n\n  /**\n   * Track item updates from the actor sheet.\n   *\n   * @internal\n   * @private\n   * @type {object[]}\n   */\n  _itemUpdates = [];\n\n  /**\n   * Track hidden elements of the sheet.\n   *\n   * @internal\n   * @private\n   * @type {Record<string, boolean>}\n   */\n  _hiddenElems = {};\n\n  /**\n   * Whether the skills are currently locked.\n   *\n   * @private\n   * @internal\n   * @type {boolean}\n   */\n  _skillsLocked = true;\n\n  /**\n   * IDs of expanded items.\n   *\n   * @internal\n   * @private\n   * @type {Set<string>}\n   */\n  _expandedItems = new Set();\n\n  /**\n   * @internal\n   * @type {Record<string,string>}\n   */\n  _activeEdits = {};\n\n  /**\n   * Which fields to track edits for\n   *\n   * @internal\n   */\n  static EDIT_TRACKING = [\"system.details.biography.value\", \"system.details.notes.value\"];\n\n  /** @override */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"ffd20\", \"actor\"],\n      scrollY: [\n        \".combat-attacks\",\n        \".item-groups-list\",\n        \".skills-list\",\n        \".traits\",\n        \".actor-notes\",\n        \".editor-content[data-edit='system.details.biography.value']\",\n      ],\n      dragDrop: [\n        { dragSelector: \".item[data-item-id]\" },\n        { dragSelector: \".currency .denomination\" },\n        { dragSelector: \"li.skill[data-skill]\" },\n        { dragSelector: \".saving-throw[data-savingthrow]\" },\n        { dragSelector: \".attribute[data-attribute]\" },\n        { dragSelector: \".attribute[data-attack]\" },\n        { dragSelector: \"li.generic-defenses[data-drag]\" },\n        { dragSelector: \".ability-scores .ability[data-ability]\" },\n        { dragSelector: \".spellcasting-concentration[data-drag]\" },\n        { dragSelector: \".spellcasting-cl\" },\n      ],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"summary\",\n          group: \"primary\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='skillset']\",\n          contentSelector: \"section.skillset-body\",\n          initial: \"adventure\",\n          group: \"skills\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='spellbooks']\",\n          contentSelector: \"section.spellbooks-body\",\n          initial: \"primary\",\n          group: \"spellbooks\",\n        },\n      ],\n    };\n  }\n\n  get currentPrimaryTab() {\n    return this._tabs.find((t) => t.group === \"primary\")?.active || null;\n  }\n\n  get currentSpellbookKey() {\n    return this._tabs.find((t) => t.group === \"spellbooks\")?.active || \"primary\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   */\n  async getData() {\n    const isOwner = this.actor.isOwner;\n\n    const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n\n    const context = {\n      actor: this.actor,\n      document: this.actor,\n      effects: this.actor.effects,\n      options: this.options,\n      owner: isOwner,\n      itemTypes: this.actor.itemTypes,\n      limited: this.actor.limited,\n      editable: this.isEditable,\n      cssClass: isOwner ? \"editable\" : \"locked\",\n      isCharacter: this.actor.type === \"character\",\n      hasHD: true,\n      config: ffd20.config,\n      isGM: game.user.isGM,\n      race: this.actor.race != null ? this.actor.race.toObject() : null,\n      usesAnySpellbook: Object.values(this.actor.system.attributes.spells.spellbooks).some((book) => book.inUse),\n      sourceData: {},\n      skillsLocked: this._skillsLocked,\n      units: {\n        weight:\n          ffd20.utils.getWeightSystem() === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\"),\n        distance: {\n          tactical: isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft,\n          overland: isMetricDist ? ffd20.config.measureUnitsShort.km : ffd20.config.measureUnitsShort.mi,\n        },\n      },\n      unchainedActions: game.settings.get(\"ffd20\", \"unchainedActionEconomy\"),\n      choices: {},\n    };\n\n    if (context.usesAnySpellbook) {\n      context.choices.casterProgression = Object.fromEntries(\n        Object.entries(ffd20.config.caster.progression).map(([key, data]) => [key, data.label])\n      );\n      context.choices.casterPreparation = Object.fromEntries(\n        Object.entries(ffd20.config.caster.type).map(([key, data]) => [key, data.label])\n      );\n    }\n\n    Object.values(context.itemTypes).forEach((items) => items.sort((a, b) => (a.sort ?? 0) - (b.sort ?? 0)));\n\n    const rollData = this.actor.getRollData();\n    context.rollData = rollData;\n    context.system = foundry.utils.deepClone(this.actor.system);\n\n    context.inCharacterGeneration = this.inCharacterGeneration;\n\n    context.hasProficiencies = context.isCharacter || game.settings.get(\"ffd20\", \"npcProficiencies\");\n\n    // BAB iteratives\n    if (!context.unchainedActions) {\n      const bab = context.rollData.attributes?.bab?.total;\n      if (bab > 0) {\n        const numAttacks = 1 + RollPF.safeRollSync(ffd20.config.iterativeExtraAttacks, { bab }).total || 0;\n        const iters = Array.fromRange(numAttacks).map(\n          (attackCount) => bab + RollPF.safeRollSync(ffd20.config.iterativeAttackModifier, { attackCount }).total\n        );\n        context.iteratives = `+${iters.join(\" / +\")}`;\n      }\n    }\n\n    // Show whether the item has currency\n    context.hasCurrency = Object.values(this.actor.system.currency).some((o) => o > 0);\n    context.hasAltCurrency = Object.values(this.actor.system.altCurrency).some((o) => o > 0);\n\n    // Enrich descriptions\n    const enrichHTMLOptions = {\n      secrets: isOwner,\n      rollData: context.rollData,\n      relativeTo: this.actor,\n    };\n    const bio = context.system.details?.biography?.value;\n    const pBio = bio ? ffd20.utils.enrichHTMLUnrolled(bio, enrichHTMLOptions) : Promise.resolve();\n    pBio.then((html) => (context.biographyHTML = html));\n    const notes = context.system.details?.notes?.value;\n    const pNotes = notes ? ffd20.utils.enrichHTMLUnrolled(notes, enrichHTMLOptions) : Promise.resolve();\n    pNotes.then((html) => (context.notesHTML = html));\n    await Promise.all([pBio, pNotes]);\n\n    // The Actor and its Items\n    context.token = this.token;\n\n    context.items = this.actor.items.map((item) => this._prepareItem(item));\n    context.items.sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    context.labels = this.actor.getLabels();\n    context.filters = this._filters;\n\n    // Generic melee and ranged attack bonuses, only present for sheet.\n    {\n      const attributes = context.system.attributes,\n        /** @type {Record<string, AbilityScoreData>} */\n        abilities = context.system.abilities,\n        sizeModifier = Object.values(ffd20.config.sizeMods)[context.system.traits.size.value],\n        baseBonus = attributes.attack.shared + attributes.attack.general + sizeModifier,\n        meleeAbility = abilities[attributes.attack.meleeAbility]?.mod ?? 0,\n        rangedAbility = abilities[attributes.attack.rangedAbility]?.mod ?? 0;\n\n      context.genericAttacks = {\n        melee: {\n          ability: attributes.attack.meleeAbility,\n          abilityMod: meleeAbility,\n          modifier: baseBonus + attributes.attack.melee + meleeAbility,\n        },\n        ranged: {\n          ability: attributes.attack.rangedAbility,\n          abilityMod: rangedAbility,\n          modifier: baseBonus + attributes.attack.ranged + rangedAbility,\n        },\n      };\n    }\n\n    // Add inventory value\n    {\n      const cpValue = this.calculateTotalItemValue({ inLowestDenomination: true, recursive: true });\n      const totalValue = ffd20.utils.currency.split(cpValue, { pad: true });\n      context.labels.totalValue = game.i18n.format(\"FFD20.TotalItemValue\", totalValue);\n    }\n\n    // Ability Scores\n    for (const [a, abl] of Object.entries(context.system.abilities)) {\n      abl.label = ffd20.config.abilities[a];\n      abl.enabled = abl.value !== null;\n      abl.totalLabel = abl.enabled ? abl.total : \"â\";\n    }\n\n    // Armor Class\n    for (const [a, ac] of Object.entries(context.system.attributes.ac)) {\n      ac.label = ffd20.config.ac[a];\n    }\n\n    // Saving Throws\n    for (const [a, savingThrow] of Object.entries(context.system.attributes.savingThrows)) {\n      savingThrow.label = ffd20.config.savingThrows[a];\n    }\n\n    // Update skill labels\n    for (const [skillId, skill] of Object.entries(context.system.skills ?? {})) {\n      skill.key = skillId;\n      skill.path = skillId;\n      skill.skillId = skillId;\n      skill.label = ffd20.config.skills[skillId] || skill.name;\n      skill.arbitrary = ffd20.config.arbitrarySkills.includes(skillId);\n      skill.compendiumEntry = ffd20.config.skillCompendiumEntries[skillId] || skill.journal || null;\n      skill.untrained = skill.rt === true && !(skill.rank > 0);\n\n      if (skill.subSkills != null) {\n        for (const [subSkillId, subSkill] of Object.entries(skill.subSkills)) {\n          subSkill.key = `${skillId}.${subSkillId}`;\n          subSkill.path = `${skillId}.subSkills.${subSkillId}`;\n          subSkill.skillId = skillId;\n          subSkill.subSkillId = subSkillId;\n          subSkill.label ||= subSkill.name;\n          subSkill.compendiumEntry = subSkill.journal || null;\n          subSkill.untrained = subSkill.rt === true && !(subSkill.rank > 0);\n          subSkill.custom = true; // All subskills are custom\n        }\n      }\n    }\n\n    // Feat count\n    {\n      // Feat count\n      const feats = this.actor.getFeatCount();\n      // Additional values\n      feats.bonus = feats.formula + feats.changes;\n      feats.issues = 0;\n      if (feats.missing > 0 || feats.excess) feats.issues += 1;\n      if (feats.disabled > 0) feats.issues += 1;\n      context.featCount = feats;\n    }\n\n    // Update traits\n    this._prepareTraits(context.system.traits);\n    context.labels.senses = this._prepareSenseLabels();\n    context.dr = this.actor.parseResistances(\"dr\");\n    context.eres = this.actor.parseResistances(\"eres\");\n\n    // Prepare owned items\n    this._prepareItems(context);\n\n    // Compute encumbrance\n    context.encumbrance = this._computeEncumbrance();\n\n    // Prepare skillsets\n    this._prepareSkillsets(context);\n\n    this._prepareSkills(context);\n\n    // Fetch the game settings relevant to sheet rendering.\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    context.healthConfig = hpConfig.getActorConfig(this.actor);\n    context.useWoundsAndVigor = context.healthConfig.rules.useWoundsAndVigor;\n\n    // Determine hidden elements\n    this._prepareHiddenElements();\n    context.hiddenElems = this._hiddenElems;\n\n    // Create a table of magic items, only for GM\n    if (game.user.isGM) {\n      context.magicItems = {\n        identified: [],\n        unidentified: [],\n      };\n      this.actor.items\n        .filter((o) => {\n          if (!o.isPhysical) return false;\n          if (!o.system.carried) return false;\n          if (o.system.quantity === 0) return false;\n\n          const school = o.system.aura?.school;\n          const cl = o.system.cl;\n          return school?.length > 0 && cl > 0;\n        })\n        .forEach((item) => {\n          const itemData = {\n            name: item.name,\n            unidentifiedName: item.system.unidentified?.name,\n            img: item.img,\n            id: item.id,\n            cl: item.system.cl,\n            aura: {\n              strength: ffd20.config.auraStrengths[item.auraStrength],\n              school: ffd20.config.spellSchools[item.system.aura?.school] || item.system.aura?.school,\n            },\n            identifyDC: 15 + item.system.cl,\n            identified: item.system.identified === true,\n            quantity: item.system.quantity || 0,\n          };\n\n          if (itemData.identified) context.magicItems.identified.push(itemData);\n          else context.magicItems.unidentified.push(itemData);\n        });\n    }\n\n    // Prepare (interactive) labels\n    if (this.actor.itemTypes.class.length === 0) {\n      const dataFilters = `classType=base${this.actor.type === \"npc\" ? \",npc,racial\" : \"\"}`;\n      context.labels.firstClass = game.i18n.format(\"FFD20.Info_FirstClass\", {\n        browser: `<a data-action=\"browse\" data-category=\"classes\" data-filters=\"${dataFilters}\" data-tooltip=\"FFD20.BrowseClasses\"><i class=\"fa-solid fa-folder-plus\"></i> ${game.i18n.localize(\n          \"FFD20.Info_FirstClass_Compendium\"\n        )}</a>`,\n        create: `<i class=\"fa-solid fa-plus\"></i>`,\n      });\n    }\n\n    // Conditions\n    const conditions = this.actor.system.conditions;\n    // Get conditions that are inherited from items\n    const inheritedEffects = this.actor.appliedEffects.filter((ae) => ae.parent instanceof Item && ae.statuses.size);\n    const condImmunities = this.actor.getConditionImmunities();\n\n    const racial = {};\n    if (this.actor.statuses.has(\"incorporeal\")) {\n      if (this.actor.system.traits.creatureSubtypes.standard.has(\"incorporeal\"))\n        racial[\"incorporeal\"] = game.i18n.localize(\"FFD20.Race\");\n    }\n\n    context.conditions = ffd20.utils.naturalSort(\n      ffd20.registry.conditions\n        .filter((cond) => cond.showInBuffsTab)\n        .map((cond) => ({\n          id: cond.id,\n          img: cond.texture,\n          immune: condImmunities.has(cond.id),\n          active: conditions[cond.id] ?? false,\n          items: new Set(inheritedEffects.filter((ae) => ae.statuses.has(cond.id)).map((ae) => ae.parent)),\n          get inherited() {\n            return this.items.size > 0;\n          },\n          racial: racial[cond.id],\n          label: cond.name,\n          compendium: cond.journal,\n        })),\n      \"label\"\n    );\n\n    context._editorState = ffd20.applications.utils.restoreEditState(this, context);\n\n    // Return data to the sheet\n    return context;\n  }\n\n  /**\n   * Prepare item data for display.\n   *\n   * @protected\n   * @param {ffd20.documents.item.ItemPF} item - Original document\n   * @returns {object} - Data fed to the sheet\n   */\n  _prepareItem(item) {\n    const type = item.type;\n    const subType = item.subType;\n\n    const result = foundry.utils.deepClone(item.system);\n    result.document = item;\n    result.type = type;\n    result.id = item.id;\n    result.img = item.img;\n    result.isActive = item.isActive;\n    result.isPhysical = item.isPhysical ?? false;\n    result.isPhysicalLike = item.isQuasiPhysical ?? false;\n    result.isSingleUse = item.isSingleUse;\n    result.isCharged = item.isCharged;\n    result.hasResource = result.isCharged && !result.isSingleUse;\n    result.charges = item.charges;\n    result.maxCharges = item.maxCharges;\n    result.noMaxCharges = !Number.isFinite(result.maxCharges);\n    result.hasUses = result.maxCharges > 0;\n\n    const defaultAction = item.defaultAction;\n    const rollData = defaultAction?.getRollData() ?? item.getRollData();\n\n    result.labels = item.getLabels({ actionId: defaultAction?.id, rollData });\n    result.hasAction =\n      item.hasAction || item.getScriptCalls(\"use\").length > 0 || item.getScriptCalls(\"postUse\").length > 0;\n    if (defaultAction) {\n      result.hasAttack = defaultAction.hasAttack;\n      result.hasMultiAttack = defaultAction.hasMultiAttack;\n      result.hasDamage = defaultAction.hasDamage;\n      result.hasRange = defaultAction.hasRange;\n      result.hasEffect = defaultAction.hasEffect;\n      if (this._canShowRange(item)) {\n        result.range = foundry.utils.mergeObject(\n          defaultAction?.range ?? {},\n          {\n            min: defaultAction?.getRange({ type: \"min\", rollData }),\n            max: defaultAction?.getRange({ type: \"max\", rollData }),\n          },\n          { inplace: false }\n        );\n      }\n\n      if (result.hasAttack) {\n        const attacks = defaultAction.getAttacks({\n          full: true,\n          resolve: true,\n          conditionals: true,\n          bonuses: true,\n          rollData,\n        });\n        const attackBonuses = attacks.map((atk) => atk.bonus);\n        result.attackArray = attackBonuses;\n        const highest = Math.max(...attackBonuses); // Highest bonus, with assumption the first might not be that.\n        result.attackSummary = `${attackBonuses.length} (${highest < 0 ? highest : `+${highest}`}${\n          attacks.length > 1 ? \"/â¦\" : \"\"\n        })`;\n      }\n\n      result.usesAmmo = !!defaultAction.ammo?.type;\n      if (result.usesAmmo && defaultAction.ammo?.cost > 0) {\n        result.ammoRemaining = this.actor.items.get(defaultAction.item.system.ammo?.default)?.system.quantity ?? 0;\n      }\n    }\n\n    result.sort = item.sort;\n    result.showUnidentifiedData = item.showUnidentifiedData;\n    result.name = item.name; // Copy name over from item to handle identified state correctly\n\n    result.isEmpty = false;\n    if (result.isPhysical) {\n      result.quantity ||= 0;\n      result.isStack = result.quantity > 1;\n      result.destroyed = result.hp?.value <= 0;\n      result.isEmpty = result.quantity == 0;\n      result.disabled ||= result.destroyed;\n    }\n\n    // Some non-physical items simulate broken state\n    result.isBroken = item.isBroken ?? false;\n\n    result.uncharged = false;\n    if (result.isActive && result.isCharged && !result.isSingleUse) {\n      // TODO: Do charge test in action selection instead of here\n      //const smallestUsage = Math.min(...item.actions.map((a) => a.getChargeCost()));\n      //const itemCharges = result.uses?.value != null ? result.uses.value : 1;\n      //if (itemCharges < smallestUsage) result.empty = true;\n    }\n\n    result.disabled = result.destroyed || result.uncharged || (!result.isActive && !result.isEmpty);\n\n    if (result.isPhysical) {\n      // Do not count unequipped physical items as disabled\n      if (item.system.equipped === false) result.disabled = false;\n      // Do not count unimplanted implants as disabled\n      else if (item.system.implanted === false) result.disabled = false;\n    }\n\n    result.typeLabel = subType ? game.i18n.localize(`FFD20.Subtypes.Item.${type}.${subType}.Single`) : undefined;\n\n    if (item.type === \"class\") {\n      if ([\"mythic\", \"racial\"].includes(item.subType)) {\n        result.xpUnbound = true;\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Determine if the item can have its range shown on this sheet.\n   *\n   * @protected\n   * @param {Item} item\n   * @returns {boolean}\n   */\n  _canShowRange(item) {\n    return item.type === \"attack\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Determine if this actor is in character generation state.\n   *\n   * @private\n   * @returns {boolean} True if character generation guides are desirable.\n   */\n  get inCharacterGeneration() {\n    return (\n      this.actor.system.attributes.hd.total <= 1 ||\n      Object.values(this.actor.system.abilities).every((abl) => abl.value === 10)\n    );\n  }\n\n  _prepareHiddenElements() {\n    // Hide spellbook info\n    const spellbooks = this.actor.system.attributes?.spells?.spellbooks ?? {};\n    for (const k of Object.keys(spellbooks)) {\n      const key = `spellbook-info_${k}`;\n      if (this._hiddenElems[key] == null) this._hiddenElems[key] = true;\n    }\n  }\n\n  _prepareTraits(traits) {\n    const damageTypes = ffd20.registry.damageTypes.getLabels();\n    const map = {\n      // \"dr\": FFD20.damageTypes,\n      di: damageTypes,\n      dv: damageTypes,\n      ci: ffd20.config.conditionTypes,\n      languages: ffd20.config.languages,\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      creatureTypes: ffd20.config.creatureTypes,\n      creatureSubtypes: ffd20.config.creatureSubtypes,\n    };\n\n    for (const [key, choices] of Object.entries(map)) {\n      const trait = traits[key];\n      if (!trait) continue;\n      const values = trait.total;\n\n      trait.selected = values.reduce((obj, t) => {\n        obj[t] = choices[t] || t;\n        return obj;\n      }, {});\n\n      trait.cssClass = !foundry.utils.isEmpty(trait.selected) ? \"\" : \"inactive\";\n    }\n  }\n\n  _prepareSenseLabels() {\n    const result = {};\n\n    const senses = this.actor.system.traits.senses ?? {};\n\n    for (const [key, value] of Object.entries(senses)) {\n      switch (key) {\n        case \"ll\":\n          if (senses[key].enabled) {\n            result[key] = ffd20.config.senses[key];\n          }\n          break;\n\n        case \"si\":\n        case \"sid\":\n          if (senses[key]) {\n            result[key] = ffd20.config.senses[key];\n          }\n          break;\n\n        case \"custom\":\n          if (value.length) {\n            value\n              .split(ffd20.config.re.traitSeparator)\n              .map((c) => c.trim())\n              .filter((c) => c)\n              .forEach((svalue, idx) => (result[`custom${idx + 1}`] = svalue));\n          }\n          break;\n\n        default:\n          if (value.total > 0) {\n            const converted = ffd20.utils.convertDistance(value.total);\n            result[key] = `${ffd20.config.senses[key]} ${converted[0]} ${converted[1]}`;\n          }\n          break;\n      }\n    }\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Insert a spell into the spellbook object when rendering the character sheet\n   *\n   * @internal\n   * @param {object} data - The Actor data being prepared\n   * @param {Array} spells - The spell data being prepared\n   * @param {string} bookKey - The key of the spellbook being prepared\n   * @returns {object} - Spellbook data\n   */\n  _prepareSpellbook(data, spells, bookKey) {\n    const book = this.actor.system.attributes?.spells?.spellbooks?.[bookKey];\n    if (!book) return;\n\n    const min = book.hasCantrips ? 0 : 1;\n    let max = 9;\n    if (book.autoSpellLevelCalculation) {\n      const cl = book.cl.autoSpellLevelTotal;\n\n      const castsPerDay =\n        ffd20.config.casterProgression.castsPerDay[book.spellPreparationMode]?.[book.casterType]?.[cl - 1];\n      // Check against undefined protects against bad CL modifications.\n      max = castsPerDay !== undefined ? castsPerDay.length - 1 : 0;\n    } else {\n      if (book.casterType === \"low\") max = 4;\n      else if (book.casterType === \"med\") max = 6;\n    }\n\n    // Reduce spells to the nested spellbook structure\n    const spellbook = [];\n    for (let level = 0; level < 10; level++) {\n      const spellLevel = book.spells?.[`spell${level}`];\n      if (!spellLevel) {\n        console.error(`Bad data for spell level ${level} in spellbook \"${bookKey}\" for actor \"${this.actor.name}\"`);\n        continue;\n      }\n\n      const valid = !isNaN(spellLevel.max);\n\n      spellbook[level] = {\n        ...ffd20.config.sheetSections.spells.spell,\n        id: `level-${level}`,\n        level,\n        valid,\n        usesSlots: true,\n        spontaneous: book.spontaneous,\n        prepared: book.prepared,\n        canPrepare: data.actor.type === \"character\",\n        label: ffd20.config.spellLevels[level],\n        items: [],\n        uses: spellLevel.value || 0,\n        slots: spellLevel.slots,\n        hasIssues: valid && spellLevel.hasIssues,\n        lowAbilityScore: spellLevel.lowAbilityScore,\n        lowLevel: spellLevel.lowLevel,\n        known: spellLevel.known,\n        preparation: spellLevel.preparation,\n        invalidSlots: spellLevel.invalidSlots,\n        mismatchSlots: spellLevel.mismatchSlots,\n        invalidKnown: spellLevel.invalidKnown,\n        mismatchKnown: spellLevel.mismatchKnown,\n        domain: spellLevel.domain,\n        data: spellLevel,\n        isSchool: book.isSchool,\n      };\n    }\n\n    // Add arbitrary high level for collecting invalid spells\n    const invalidLevel = 99;\n    spellbook[invalidLevel] = {\n      id: `level-invalid`,\n      level: invalidLevel,\n      label: game.i18n.localize(\"FFD20.Unknown\"),\n      valid: false,\n      items: [],\n    };\n\n    // Sort spells into their respective levels\n    for (const spell of spells) {\n      const lvl = spell.level ?? min;\n      const levelData = spellbook[lvl] ?? spellbook[invalidLevel];\n\n      levelData.items.push(spell);\n    }\n\n    // Mark cantrips as invalid if it shouldn't exist\n    if (!book.hasCantrips) spellbook[0].valid = false;\n\n    // Delete levels that have nothing\n    for (const levelData of spellbook) {\n      if (!levelData) continue;\n\n      if (levelData.items.length > 0) continue;\n\n      const { level } = levelData;\n      if (level > max || level < min) {\n        delete spellbook[level];\n      }\n    }\n\n    return spellbook;\n  }\n\n  /**\n   * Prepare adventure/background skill distinction if needed.\n   *\n   * @internal\n   * @param {object} context\n   */\n  _prepareSkillsets(context) {\n    const skills = context.system.skills;\n\n    const sets = {\n      all: { skills: {} },\n      adventure: { skills: {} },\n      background: { skills: {} },\n    };\n\n    // sort skills by label\n    const keys = Object.keys(skills).sort(function (a, b) {\n      if (skills[a].custom && !skills[b].custom) return 1;\n      if (!skills[a].custom && skills[b].custom) return -1;\n      return (\"\" + skills[a].label).localeCompare(skills[b].label);\n    });\n\n    keys.forEach((a) => {\n      const skl = skills[a];\n      // Include all but Lore and Artistry in all\n      if (!ffd20.config.backgroundOnlySkills.includes(a)) sets.all.skills[a] = skl;\n      if (skl.background) sets.background.skills[a] = skl;\n      else sets.adventure.skills[a] = skl;\n    });\n\n    context.skillsets = sets;\n  }\n\n  /**\n   * Calculate used and available skill ranks.\n   *\n   * @internal\n   * @param {object} context - HBS context\n   */\n  _prepareSkills(context) {\n    context.useBGSkills = game.settings.get(\"ffd20\", \"allowBackgroundSkills\");\n\n    const abilities = context.system.abilities;\n\n    const isMindless = abilities?.int?.value === null;\n    const intMod = isMindless ? 0 : (abilities?.int?.mod ?? 0);\n\n    // Rank counting\n    const skillRanks = { allowed: 0, used: 0, bgAllowed: 0, bgUsed: 0, sentToBG: 0 };\n\n    // Count used skill ranks\n    for (const skl of Object.values(context.rollData.skills)) {\n      if (skl.subSkills != null) {\n        for (const subSkl of Object.values(skl.subSkills)) {\n          if (context.useBGSkills && skl.background) {\n            skillRanks.bgUsed += subSkl.rank;\n          } else {\n            skillRanks.used += subSkl.rank;\n          }\n        }\n      } else if (context.useBGSkills && skl.background) {\n        skillRanks.bgUsed += skl.rank;\n      } else {\n        skillRanks.used += skl.rank;\n      }\n    }\n\n    // Allowed skill ranks from HD, classes, intelligence, FCB, etc.\n    this.actor.itemTypes.class\n      .filter((cls) => cls.system.subType !== \"mythic\")\n      .forEach((cls) => {\n        // Favoured Class Bonus\n        if (ffd20.config.favoredClassTypes.includes(cls.subType)) {\n          skillRanks.allowed += cls.system.fc?.skill?.value || 0;\n        }\n\n        // Mindless get nothing else\n        if (isMindless) return;\n\n        const hd = cls.hitDice;\n        if (hd === 0) return;\n\n        const perLevel = cls.system.skillsPerLevel || 0;\n\n        // Int from HD still applies even if skills per level is zero.\n        skillRanks.allowed += Math.max(1, perLevel + intMod) * hd;\n\n        // Background skills\n        if (context.useBGSkills && ffd20.config.backgroundSkillClasses.includes(cls.subType)) {\n          const bgranks = hd * ffd20.config.backgroundSkillsPerLevel;\n          if (bgranks > 0) skillRanks.bgAllowed += bgranks;\n        }\n      });\n\n    // Calculate from changes\n    skillRanks.allowed += this.actor.system.details?.skills?.bonus || 0;\n\n    // Adventure skills transferred to background skills\n    if (context.useBGSkills && skillRanks.bgUsed > skillRanks.bgAllowed) {\n      skillRanks.sentToBG = skillRanks.bgUsed - skillRanks.bgAllowed;\n      skillRanks.allowed -= skillRanks.sentToBG;\n      skillRanks.bgAllowed += skillRanks.sentToBG;\n    }\n\n    context.skillRanks = skillRanks;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Compute the level and percentage of encumbrance for an Actor.\n   *\n   * @returns {object}               An object describing the character's encumbrance level\n   * @private\n   */\n  _computeEncumbrance() {\n    const system = this.actor.system;\n    const carriedWeight = system.attributes.encumbrance.carriedWeight;\n    const load = {\n      light: system.attributes.encumbrance.levels.light,\n      medium: system.attributes.encumbrance.levels.medium,\n      heavy: system.attributes.encumbrance.levels.heavy,\n    };\n    const usystem = ffd20.utils.getWeightSystem();\n    const carryLabel =\n      usystem === \"metric\"\n        ? game.i18n.format(\"FFD20.CarryLabelKg\", { kg: carriedWeight })\n        : game.i18n.format(\"FFD20.CarryLabel\", { lbs: carriedWeight });\n\n    const enc = {\n      pct: {\n        light: Math.clamp((carriedWeight * 100) / load.light, 0, 99.5),\n        medium: Math.clamp(((carriedWeight - load.light) * 100) / (load.medium - load.light), 0, 99.5),\n        heavy: Math.clamp(((carriedWeight - load.medium) * 100) / (load.heavy - load.medium), 0, 99.5),\n      },\n      encumbered: {\n        light: system.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.medium,\n        medium: system.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.heavy,\n        heavy: system.attributes.encumbrance.carriedWeight >= system.attributes.encumbrance.levels.heavy,\n      },\n      light: system.attributes.encumbrance.levels.light,\n      medium: system.attributes.encumbrance.levels.medium,\n      heavy: system.attributes.encumbrance.levels.heavy,\n      aboveHead: system.attributes.encumbrance.levels.heavy,\n      offGround: system.attributes.encumbrance.levels.heavy * 2,\n      dragPush: system.attributes.encumbrance.levels.heavy * 5,\n      value: system.attributes.encumbrance.carriedWeight,\n      carryLabel,\n    };\n\n    return enc;\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param {JQuery} html The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Activate Item Filters\n    const filterLists = html.find(\".filter-list\");\n    filterLists.each(this._initializeFilterItemList.bind(this));\n    filterLists.on(\"click\", \".filter-rule\", this._onToggleFilter.bind(this));\n\n    // Search boxes\n    {\n      const sb = html.find(\".search-input\");\n      sb.on(\"change input\", this._searchFilterChange.bind(this));\n      sb.on(\"compositionstart compositionend\", this._searchFilterCompositioning.bind(this)); // for IME\n      this.searchRefresh = true;\n      // Filter tabs on followup refreshes\n      sb.each(function () {\n        if (this.value.length > 0) $(this).change();\n      });\n    }\n\n    // Item summaries\n    html.find(\".item .item-name\").click((event) => this._onItemSummary(event));\n\n    // Allow opening items even if the sheet isn't editable.\n\n    // General items\n    html.find(\".item-edit\").on(\"click\", this._onItemEdit.bind(this));\n    // General items (right click)\n    html.find(\".item .item-name\").contextmenu(this._onItemEdit.bind(this));\n    // Quick items (right click)\n    html.find(\".quick-actions li\").contextmenu(this._onItemEdit.bind(this));\n    // Race item special right-click handler\n    html.find(\".race.item\").contextmenu(this._onItemEdit.bind(this));\n\n    // Spellbook config toggle\n    html.find(\"a.hide-show\").click(this._hideShowElement.bind(this));\n\n    // Open skill compendium entry\n    html.find(\"a.compendium-entry\").click(this._onOpenCompendiumEntry.bind(this));\n\n    // Open compendium browser\n    html.find('a[data-action=\"browse\"]').click(this._onOpenCompendiumBrowser.bind(this));\n\n    html\n      // \"pointerenter\" would be better, but Foundry tooltip behaves unpredictably with it.\n      .on(\"pointerover\", \"[data-tooltip-extended]\", this._activateExtendedTooltip.bind(this))\n      .on(\"pointerleave\", \"[data-tooltip-extended]\", () => game.tooltip.deactivate());\n\n    // Everything below here is only needed if the sheet is editable\n    if (!this.isEditable) {\n      html.find(\"span.text-box\").addClass(\"readonly\");\n      return;\n    }\n\n    // Add general text box (span) handler\n    html.find(\"span.text-box.direct\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n    });\n\n    // Click to change text input\n    html.find('*[data-action=\"input-text\"]').click((event) => this._onInputText(event));\n    html\n      .find('*[data-action=\"input-text\"].wheel-change')\n      .on(\"wheel\", (event) => this._onInputText(event.originalEvent));\n\n    // Select the whole text on click\n    html.find(\".select-on-click\").click(this._selectOnClick.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Abilities, Skills, Defenses and Traits\n    /* -------------------------------------------- */\n\n    // Ability Checks\n    html.find(\".ability-name\").click(this._onRollAbilityTest.bind(this));\n\n    // BAB Check\n    html.find(\".attribute.bab .rollable\").click(this._onRollBAB.bind(this));\n\n    // Generic attack weapon and CMB checks\n    html.find(\".attribute.attack .rollable\").click(this._onRollAttack.bind(this));\n\n    // Initiative Check\n    html.find(\".attribute.initiative .rollable\").click(this._onRollInitiative.bind(this));\n\n    // Saving Throw\n    html.find(\".saving-throw .rollable\").click(this._onRollSavingThrow.bind(this));\n\n    // Adjust skill rank\n    html.find(\"span.text-box.skill-rank\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n    });\n\n    // Add arbitrary skill\n    html.find(\".skills .skill.arbitrary .skill-create\").click((ev) => this._onArbitrarySkillCreate(ev));\n\n    // Add custom skill\n    html.find(\".skills .controls > .skill-create\").click((ev) => this._onSkillCreate(ev));\n\n    // Edit skill\n    html.find(\".skills .skill > .controls > .skill-edit\").on(\"click\", (ev) => this._onSkillEdit(ev));\n    // Delete custom skill\n    html.find(\".skills .skill > .controls > .skill-delete\").click((ev) => this._onSkillDelete(ev));\n\n    // Item Action control\n    html.find(\".item-actions a.item-action\").click(this._itemActivationControl.bind(this));\n\n    // Roll Skill Checks\n    html.find(\".tab.skills .skill > .action.roll\").click(this._onRollSkillCheck.bind(this));\n\n    // Trait Selector\n    html.find(\".trait-selector\").click(this._onTraitSelector.bind(this));\n\n    // Resistance Selector\n    html.find(\".resistance-selector\").click(this._onResistanceSelector.bind(this));\n\n    // Display defenses\n    html.find(\".generic-defenses .rollable\").click((ev) => {\n      ev.preventDefault();\n      this.actor.displayDefenseCard({ token: this.token });\n    });\n\n    // Rest\n    html.find(\".rest\").click(this._onRest.bind(this));\n\n    // Point Buy Calculator\n    html.find(\"button.pointbuy-calculator\").click(this._onPointBuyCalculator.bind(this));\n\n    // Alignment\n    html.find(\".control.alignment\").click(this._onControlAlignment.bind(this));\n\n    // Edit senses\n    html.find(\".senses-selector\").on(\"click\", this._onSensesSelector.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Inventory\n    /* -------------------------------------------- */\n\n    // Owned Item management\n    html.find(\".item-create\").on(\"click\", (ev) => this._onItemCreate(ev));\n    html.find(\".item-delete\").on(\"click\", this._onItemDelete.bind(this));\n    html.find(\".item-give\").on(\"click\", this._onItemGive.bind(this));\n    html.find(\".item-split:not(.disabled)\").on(\"click\", this._onItemSplit.bind(this));\n\n    // Item Rolling\n    html.find(\".item .item-image\").on(\"click\", (event) => this._onItemCard(event));\n\n    // Quick add item quantity\n    html.find(\"a.item-control.item-quantity-add\").click((ev) => {\n      this._quickChangeItemQuantity(ev, 1);\n    });\n    // Quick subtract item quantity\n    html.find(\"a.item-control.item-quantity-subtract\").click((ev) => {\n      this._quickChangeItemQuantity(ev, -1);\n    });\n\n    // Quick (un)equip item\n    html.find(\"a.item-control.item-equip\").click((ev) => {\n      this._quickEquipItem(ev);\n    });\n\n    // Quick carry item\n    html.find(\"a.item-control.item-carry\").click((ev) => {\n      this._quickCarryItem(ev);\n    });\n\n    // Quick (un)identify item\n    html.find(\"a.item-control.item-identify\").click((ev) => {\n      this._quickIdentifyItem(ev);\n    });\n\n    // Quick toggle item property\n    html.find(\"a.item-control.item-toggle-prepared\").click(this._itemPreparedToggle.bind(this));\n\n    // Duplicate item\n    html.find(\"a.item-control.item-duplicate\").click(this._duplicateItem.bind(this));\n\n    // Quick Action\n    html.find(\".quick-actions li\").click(this._quickAction.bind(this));\n\n    // Convert currency\n    html.find(\"a.convert-currency\").click(this._convertCurrency.bind(this));\n\n    // Set item charges\n    html\n      .find(\".item-detail.item-uses span.text-box.value\")\n      .on(\"wheel\", this._setItemUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setItemUses.bind(this));\n      });\n\n    // Dynamic tooltips\n\n    // Weight details tooltip\n    // TODO: Move to extended tooltip handling?\n    html[0].querySelectorAll(\".item-list .item[data-item-id] .item-detail.item-weight\").forEach((el) => {\n      el.addEventListener(\n        \"pointerenter\",\n        (ev) => {\n          const el0 = ev.currentTarget;\n          const item = this.actor.items.get(el0.closest(\"[data-item-id]\").dataset.itemId);\n          const weight = item?.system.weight?.converted;\n\n          if (weight && weight.total > 0) {\n            const contents = [];\n            const quantity = item.system.quantity || 0;\n            contents.push(game.i18n.format(\"FFD20.StackDetails.Base\", { value: weight.value }));\n            if (quantity > 1)\n              contents.push(\n                game.i18n.format(\"FFD20.StackDetails.Stack\", { value: Math.floor(weight.value * 100 * quantity) / 100 })\n              );\n            if (weight.contents > 0) {\n              contents.push(game.i18n.format(\"FFD20.StackDetails.Contents\", { value: weight.contents }));\n              contents.push(game.i18n.format(\"FFD20.StackDetails.Total\", { value: weight.total }));\n            }\n\n            game.tooltip.activate(el0, {\n              text: contents.join(\"<br>\"),\n              direction: TooltipManager.TOOLTIP_DIRECTIONS.LEFT,\n              cssClass: \"ffd20\",\n            });\n          }\n        },\n        { passive: true }\n      );\n      el.addEventListener(\"pointerleave\", () => game.tooltip.deactivate(), { passive: true });\n    });\n\n    /* -------------------------------------------- */\n    /*  Classes\n    /* -------------------------------------------- */\n\n    // Level Up\n    html.find(\".level-up\").click(this._onLevelUp.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Spells\n    /* -------------------------------------------- */\n\n    // Set specific spell's (max) uses\n    html\n      .find(\".item-list .spell-uses span.text-box[data-type='amount']\")\n      .on(\"wheel\", this._setSpellUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setSpellUses.bind(this));\n      });\n    html\n      .find(\".item-list .spell-uses span.text-box[data-type='max']\")\n      .on(\"wheel\", this._setMaxSpellUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setMaxSpellUses.bind(this));\n      });\n\n    // Set spell level uses for spontaneous spellbooks\n    html\n      .find(\".spell-uses .spell-slots.spontaneous span.text-box\")\n      .on(\"wheel\", this._adjustActorPropertyBySpan.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n      });\n    // Set base amount of spell uses for a given spell level\n    html.find(\".spell-uses .spell-max span.text-box\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n    });\n\n    // Set spell point amount\n    html\n      .find(\".spell-points-current .value span.text-box\")\n      .on(\"wheel\", this._adjustActorPropertyBySpan.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._adjustActorPropertyBySpan.bind(this));\n      });\n\n    html.find(\".spellcasting-concentration.rollable\").click(this._onRollConcentration.bind(this));\n\n    html.find(\".spellcasting-cl.rollable\").click(this._onRollCL.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Buffs\n    /* -------------------------------------------- */\n\n    html\n      .find(\".item-detail.item-active input[type='checkbox']\")\n      .off(\"change\")\n      .on(\"change\", this._setItemActive.bind(this));\n\n    html\n      .find(\".item-detail.item-level span.text-box\")\n      .on(\"wheel\", this._setBuffLevel.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setBuffLevel.bind(this));\n      });\n\n    // Toggle condition\n    html.find(\".condition .checkbox\").click(this._onToggleCondition.bind(this));\n    html.find(\".condition .checkbox\").on(\"contextmenu\", this._onEditCondition.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Skills\n    /* -------------------------------------------- */\n\n    html.find(\".skill-lock-button\").on(\"click\", this._onToggleSkillLock.bind(this));\n  }\n\n  /**\n   * Handle extended tooltip on hover activation.\n   *\n   * Async to reduce UX impact.\n   *\n   * @private\n   * @param {Event} event\n   */\n  async _activateExtendedTooltip(event) {\n    const el = event.currentTarget;\n    const id = el.dataset.tooltipExtended;\n    if (!id) return;\n\n    const context = { actor: this.actor, bonusTypes: ffd20.config.bonusTypes, config: ffd20.config };\n    await this._getTooltipContext(id, context);\n\n    context.sources = context.sources?.filter((list) => list.sources?.length > 0);\n\n    if (\n      !(\n        context.header ||\n        context?.paths?.length > 0 ||\n        context?.sources?.length > 0 ||\n        context?.details?.length > 0 ||\n        context?.notes?.length > 0\n      )\n    )\n      return;\n\n    for (const src of context.sources) {\n      src.sources = src.sources.map((s) => ({\n        ...s,\n        type: s.type || ffd20.config.bonusTypes[s.modifier || \"untyped\"] || s.modifier,\n      }));\n    }\n\n    const template = document.createElement(\"template\");\n    template.innerHTML = renderCachedTemplate(\"systems/ffd20/templates/extended-tooltip.hbs\", context);\n\n    Hooks.callAll(\"renderPF1ExtendedTooltip\", this, id, template);\n\n    game.tooltip.activate(el, {\n      content: template.content,\n      cssClass: \"ffd20 extended\",\n      direction: el.dataset.tooltipDirection || undefined,\n    });\n  }\n\n  /**\n   * @protected\n   * @param {string} fullId - Target ID\n   * @param {object} context - Context object to store data into\n   * @throws {Error} - If provided ID is invalid.\n   */\n  async _getTooltipContext(fullId, context) {\n    /** @type {ActorPF} */\n    const actor = this.actor,\n      system = actor.system;\n\n    // Lazy roll data\n    const lazy = {\n      get rollData() {\n        this._cache ??= actor.getRollData();\n        return this._cache;\n      },\n    };\n\n    const getNotes = async (context, all = true) =>\n      (await actor.getContextNotesParsed(context, { all, rollData: lazy.rollData, roll: false })).map((n) => n.text);\n\n    let header, subHeader;\n    const details = [];\n    const paths = [];\n    const sources = [];\n    let notes;\n\n    const re = /^(?<id>[\\w-]+)(?:\\.(?<detail>.*))?$/.exec(fullId);\n    const { id, detail } = re?.groups ?? {};\n\n    switch (id) {\n      case \"level\": {\n        const hd = lazy.rollData.attributes?.hd?.total ?? NaN;\n        if (hd > 0) {\n          paths.push({ path: \"@attributes.hd.total\", value: hd });\n          const mythic = lazy.rollData.details?.mythicTier ?? NaN;\n          if (mythic > 0) {\n            paths.push({ path: \"@details.mythicTier\", value: mythic });\n          }\n        }\n        const level = lazy.rollData.details?.level?.value ?? NaN;\n        if (level) {\n          paths.push({ path: \"@details.level.value\", value: lazy.rollData.details?.level?.value ?? NaN });\n        }\n        const cr = lazy.rollData.details?.cr?.total ?? NaN;\n        if (cr > 0) paths.push({ path: \"@details.cr.total\", value: ffd20.utils.CR.fromNumber(cr) });\n        break;\n      }\n      case \"hit-points\": {\n        const hp = system.attributes.hp;\n        paths.push(\n          { path: \"@attributes.hp.value\", value: hp.value },\n          { path: \"@attributes.hp.offset\", value: hp.offset },\n          { path: \"@attributes.hp.max\", value: hp.max },\n          { path: \"@attributes.hp.temp\", value: hp.temp },\n          { path: \"@attributes.hp.nonlethal\", value: hp.nonlethal }\n        );\n        if (hp.base > 0) {\n          // npc lite sheet forced max\n          paths.push({ path: \"@attributes.hp.base\", value: hp.base });\n        }\n\n        sources.push({ sources: actor.getSourceDetails(\"system.attributes.hp.max\"), untyped: true });\n        break;\n      }\n      case \"vigor\": {\n        // Wounds & Vigor\n        const vigor = system.attributes.vigor;\n        paths.push(\n          { path: \"@attributes.vigor.value\", value: vigor.value },\n          { path: \"@attributes.vigor.offset\", value: vigor.offset },\n          { path: \"@attributes.vigor.temp\", value: vigor.temp },\n          { path: \"@attributes.vigor.max\", value: vigor.max }\n        );\n        if (vigor.base) {\n          // npc lite sheet forced max\n          paths.push({ path: \"@attributes.vigor.base\", value: vigor.base });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(\"system.attributes.vigor.max\"),\n          untyped: true,\n        });\n        break;\n      }\n      case \"wounds\": {\n        // Wounds & Vigor\n        const wounds = system.attributes.wounds;\n        paths.push(\n          { path: \"@attributes.wounds.value\", value: wounds.value },\n          { path: \"@attributes.wounds.offset\", value: wounds.offset },\n          { path: \"@attributes.wounds.max\", value: wounds.max },\n          { path: \"@attributes.wounds.threshold\", value: wounds.threshold }\n        );\n        if (wounds.base) {\n          // npc lite sheet forced max\n          paths.push({ path: \"@attributes.wounds.base\", value: wounds.base });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(\"system.attributes.wounds.max\"),\n          untyped: true,\n        });\n        break;\n      }\n      case \"mana-points\": {\n        const mp = system.attributes.mp;\n        paths.push(\n          { path: \"@attributes.mp.value\", value: mp.value },\n          { path: \"@attributes.mp.offset\", value: mp.offset },\n          { path: \"@attributes.mp.max\", value: mp.max },\n          { path: \"@attributes.mp.temp\", value: mp.temp },\n          { path: \"@attributes.mp.recover\", value: mp.recover }\n        );\n\n        sources.push({ sources: actor.getSourceDetails(\"system.attributes.mp.max\"), untyped: true });\n        sources.push({ sources: actor.getSourceDetails(\"system.attributes.mp.recover\"), untyped: true });\n\n        break;\n      }\n      case \"speed\": {\n        const mode = detail;\n\n        sources.push(\n          { sources: actor.getSourceDetails(`system.attributes.speed.${mode}.base`) },\n          { sources: actor.getSourceDetails(`system.attributes.speed.${mode}.total`) }\n        );\n\n        // Add base speed\n        const speed = system.attributes.speed[mode];\n        const [tD] = ffd20.utils.convertDistance(speed.total);\n        const [tB] = ffd20.utils.convertDistance(speed.base);\n        const [tR] = ffd20.utils.convertDistance(speed.unhindered);\n\n        const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n        const tU = isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n        paths.push(\n          { path: `@attributes.speed.${mode}.total`, value: tD, unit: tU },\n          { path: `@attributes.speed.${mode}.base`, value: tB, unit: tU },\n          { path: `@attributes.speed.${mode}.unhindered`, value: tR, unit: tU }\n        );\n        // Add overland speed\n        const [oD] = ffd20.utils.convertDistance(speed.overland);\n        const oU = isMetricDist ? ffd20.config.measureUnitsShort.km : ffd20.config.measureUnitsShort.mi;\n        paths.push({ path: `@attributes.speed.${mode}.overland`, value: oD, unit: oU });\n\n        notes = [...(await getNotes(`${mode}Speed`)), ...(await getNotes(\"allSpeeds\"))];\n        break;\n      }\n      case \"flyManeuverability\":\n        paths.push({\n          path: \"@attributes.speed.fly.maneuverability\",\n          value: system.attributes.speed.fly.maneuverability,\n        });\n        break;\n      case \"ac\": {\n        const ac = system.attributes.ac[detail];\n        if (!ac) return;\n        paths.push({ path: `@attributes.ac.${detail}.total`, value: ac.total });\n        if (ac.value) {\n          // lite sheet forced value\n          paths.push({ path: `@attributes.ac.${detail}.value`, value: ac.value });\n        }\n        paths.push(\n          { path: \"@armor.type\", value: lazy.rollData.armor?.type },\n          { path: \"@shield.type\", value: lazy.rollData.shield?.type }\n        );\n        sources.push({\n          sources: actor.getSourceDetails(`system.attributes.ac.${detail}.total`),\n        });\n\n        notes = await getNotes(\"ac\");\n        break;\n      }\n      case \"cmd\":\n        paths.push({\n          path: `@attributes.cmd.${detail}`,\n          value: system.attributes.cmd[detail],\n        });\n\n        sources.push({\n          sources: actor.getSourceDetails(`system.attributes.cmd.${detail}`),\n        });\n\n        notes = await getNotes(\"cmd\");\n        break;\n      case \"save\": {\n        const save = system.attributes.savingThrows[detail];\n        if (!save) return;\n        paths.push({\n          path: `@attributes.savingThrows.${detail}.total`,\n          value: save.total,\n        });\n        if (save.base) {\n          // npc lite sheet forced value\n          paths.push({ path: `@attributes.savingThrows.${detail}.base`, value: save.base });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(`system.attributes.savingThrows.${detail}.total`),\n        });\n\n        notes = await getNotes(`savingThrow.${detail}`);\n        break;\n      }\n      case \"sr\":\n        paths.push({\n          path: \"@attributes.sr.total\",\n          value: system.attributes.sr.total,\n        });\n\n        sources.push({\n          sources: actor.getSourceDetails(\"system.attributes.sr.total\"),\n          untyped: true,\n        });\n\n        notes = await getNotes(\"sr\");\n        break;\n      case \"bab\": {\n        const bab = system.attributes.bab;\n        paths.push({\n          path: \"@attributes.bab.total\",\n          value: bab.total,\n        });\n\n        // lite sheet forced value\n        if (bab.value) {\n          paths.push({ path: \"@attributes.bab.value\", value: bab.value });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(\"system.attributes.bab.total\"),\n          untyped: true,\n        });\n        break;\n      }\n      case \"cmb\":\n        paths.push({\n          path: \"@attributes.cmb.total\",\n          value: system.attributes.cmb.total,\n          // omit: + @attributes.attack.shared\n          // omit: + @attributes.attack.general\n        });\n\n        sources.push({\n          sources: [\n            {\n              name: game.i18n.localize(\"FFD20.Size\"),\n              value: Object.values(ffd20.config.sizeSpecialMods)[system.traits.size.value],\n            },\n          ],\n        });\n\n        if (system.attributes.cmbAbility) {\n          sources.push({\n            sources: [\n              {\n                name: ffd20.config.abilities[system.attributes.cmbAbility],\n                value: system.abilities?.[system.attributes.cmbAbility]?.mod,\n              },\n            ],\n          });\n        }\n\n        sources.push(\n          { sources: actor.getSourceDetails(\"system.attributes.attack.general\") },\n          { sources: actor.getSourceDetails(\"system.attributes.cmb.bonus\") },\n          { sources: actor.getSourceDetails(\"system.attributes.attack.shared\") }\n        );\n\n        notes = [...(await getNotes(\"attack\")), ...(await getNotes(\"melee\")), ...(await getNotes(\"cmb\"))];\n        break;\n      case \"init\": {\n        const init = system.attributes.init;\n        paths.push({ path: \"@attributes.init.total\", value: init.total });\n        if (init.value) {\n          // npc lite sheet forced value\n          paths.push({ path: \"@attributes.init.value\", value: init.value });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(\"system.attributes.init.total\"),\n        });\n\n        notes = await getNotes(\"init\");\n        break;\n      }\n      case \"abilityScore\": {\n        const abl = detail;\n        const ability = system.abilities[detail] ?? {};\n\n        const hasAbility = ability.base !== null;\n\n        paths.push(\n          { path: `@abilities.${abl}.total`, value: ability.total, sign: false },\n          { path: `@abilities.${abl}.value`, value: ability.value, sign: false },\n          { path: `@abilities.${abl}.mod`, value: ability.mod, sign: true }\n        );\n\n        if (hasAbility) {\n          paths.push(\n            { path: `@abilities.${abl}.damage`, value: ability.damage, sign: false },\n            { path: `@abilities.${abl}.drain`, value: ability.drain, sign: false },\n            { path: `@abilities.${abl}.undrained`, value: ability.undrained, sign: false },\n            { path: `@abilities.${abl}.penalty`, value: ability.penalty, sign: false },\n            { path: `@abilities.${abl}.base`, value: ability.base, sign: false },\n            { path: `@abilities.${abl}.baseMod`, value: ability.baseMod, sign: true },\n            { path: `@abilities.${abl}.unmod`, value: ability.unmod, sign: true }\n          );\n        }\n\n        if (hasAbility) {\n          sources.push(\n            { sources: actor.getSourceDetails(`system.abilities.${abl}.total`) },\n            { sources: actor.getSourceDetails(`system.abilities.${abl}.penalty`) },\n            {\n              label: game.i18n.localize(\"FFD20.ModifierOnly\"),\n              sources: actor.getSourceDetails(`system.abilities.${abl}.mod`),\n            },\n            {\n              label: game.i18n.localize(\"FFD20.CheckOnly\"),\n              sources: actor.getSourceDetails(`system.abilities.${abl}.checkMod`),\n            }\n          );\n        }\n\n        notes = await getNotes(`abilityChecks.${abl}`);\n        break;\n      }\n      case \"acp\":\n        paths.push(\n          {\n            path: \"@attributes.acp.total\",\n            value: system.attributes.acp.total,\n          },\n          {\n            path: \"@attributes.acp.skill\",\n            value: system.attributes.acp.skill,\n          },\n          {\n            path: \"@attributes.acp.encumbrance\",\n            value: system.attributes.acp.encumbrance,\n          },\n          {\n            path: \"@attributes.acp.gear\",\n            value: system.attributes.acp.gear,\n          }\n        );\n\n        sources.push(\n          {\n            sources: actor.getSourceDetails(\"system.attributes.acp.total\"),\n            untyped: true,\n          },\n          {\n            label: game.i18n.localize(\"FFD20.EquipSlots.armor\"),\n            sources: actor.getSourceDetails(\"system.attributes.acp.armorBonus\"),\n            untyped: true,\n          },\n          {\n            label: game.i18n.localize(\"FFD20.EquipSlots.shield\"),\n            sources: actor.getSourceDetails(\"system.attributes.acp.shieldBonus\"),\n            untyped: true,\n          }\n        );\n        break;\n      case \"max-dex\": {\n        const mdex = system.attributes.maxDexBonus;\n        paths.push({\n          path: \"@attributes.maxDexBonus\",\n          value: Number.isFinite(mdex) ? mdex : \"null\",\n        });\n\n        sources.push(\n          {\n            sources: actor.getSourceDetails(\"system.attributes.maxDexBonus\"),\n            untyped: true,\n          },\n          {\n            label: game.i18n.localize(\"FFD20.EquipSlots.armor\"),\n            sources: actor.getSourceDetails(\"system.attributes.mDex.armorBonus\"),\n            untyped: true,\n          },\n          {\n            label: game.i18n.localize(\"FFD20.EquipSlots.shield\"),\n            sources: actor.getSourceDetails(\"system.attributes.mDex.shieldBonus\"),\n            untyped: true,\n          }\n        );\n        break;\n      }\n      case \"asf\": {\n        // TODO: Make ASF proper change target\n        const asfSources = [];\n        this.actor.itemTypes.equipment\n          .filter((item) => item.isActive)\n          .reduce((cur, item) => {\n            const itemASF = item.system.spellFailure || 0;\n            if (itemASF > 0) asfSources.push({ name: item.name, value: `${itemASF}%` });\n            return cur + itemASF;\n          }, 0);\n\n        if (asfSources.length) {\n          sources.push({ sources: asfSources, untyped: true });\n        }\n        break;\n      }\n      case \"implants\": {\n        const cybertech = this.actor.itemTypes.implant.filter((i) => i.subType === \"cybertech\" && i.system.implanted);\n        paths.push(\n          { path: \"@abilities.int.total\", value: lazy.rollData.abilities.int.total },\n          { path: \"@abilities.con.total\", value: lazy.rollData.abilities.con.total }\n        );\n        sources.push({\n          untyped: true,\n          sources: cybertech.map((item) => ({\n            name: item.name,\n            value: item.system.implant,\n          })),\n        });\n        break;\n      }\n      case \"size\":\n        paths.push(\n          { path: \"@traits.size.base\", value: system.traits.size.base },\n          { path: \"@size\", value: lazy.rollData.size }\n        );\n        sources.push({\n          sources: actor.getSourceDetails(\"system.traits.size.value\"),\n        });\n        break;\n      case \"age-category\":\n        paths.push(\n          { path: \"@traits.ageCategory.base\", value: system.traits.ageCategory.base },\n          { path: \"@ageCategory.value\", value: lazy.rollData.ageCategory.value },\n          { path: \"@ageCategory.physical\", value: lazy.rollData.ageCategory.physical },\n          { path: \"@ageCategory.mental\", value: lazy.rollData.ageCategory.mental }\n        );\n        break;\n      case \"stature\":\n        paths.push({ path: \"@traits.stature\", value: lazy.rollData.traits.stature });\n        break;\n      case \"reach\":\n        paths.push(\n          { path: \"@traits.reach.total.melee\", value: lazy.rollData.traits.reach.total.melee },\n          { path: \"@traits.reach.total.reach\", value: lazy.rollData.traits.reach.total.reach },\n          { path: \"@traits.reach.natural.melee\", value: lazy.rollData.traits.reach.natural.melee },\n          { path: \"@traits.reach.natural.reach\", value: lazy.rollData.traits.reach.natural.reach }\n        );\n        sources.push({ sources: actor.getSourceDetails(\"system.traits.reach.total.melee\") });\n        break;\n      case \"senses\":\n        for (const i of [\"dv\", \"ts\", \"ls\", \"bse\", \"bs\", \"sc\", \"tr\"]) {\n          const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n          paths.push({\n            path: `@traits.senses.${i}.total`,\n            value: ffd20.utils.convertDistance(system.traits.senses[i]?.total)[0],\n            unit: isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft,\n            signed: false,\n          });\n          sources.push({\n            label: ffd20.config.senses[i],\n            sources: actor.getSourceDetails(`system.traits.senses.${i}.total`),\n            left: true,\n            untyped: true,\n          });\n        }\n        break;\n      case \"aura\":\n        paths.push({ path: \"@traits.aura.custom\", empty: true });\n        break;\n      case \"fastHeal\":\n        paths.push({ path: \"@traits.fastHealing\", empty: true });\n        break;\n      case \"regen\":\n        paths.push({ path: \"@traits.regen\", empty: true });\n        break;\n      case \"conditionResistance\":\n        paths.push({ path: \"@traits.cres\", empty: true });\n        break;\n      case \"conditionImmunity\":\n        paths.push({ path: \"@traits.ci.total\", empty: true });\n        break;\n      case \"energyResistance\":\n        paths.push({ path: \"@traits.eres.total\", empty: true });\n        break;\n      case \"hardness\":\n        paths.push({ path: \"@traits.hardness\", empty: true });\n        break;\n      case \"damageReduction\":\n        paths.push({ path: \"@traits.dr.total\", empty: true });\n        break;\n      case \"damageImmunity\":\n        paths.push({ path: \"@traits.di.total\", empty: true });\n        break;\n      case \"damageVulnerability\":\n        paths.push({ path: \"@traits.dv.total\", empty: true });\n        break;\n      case \"proficiency\":\n        switch (detail) {\n          case \"language\":\n            paths.push({ path: \"@traits.languages.total\", empty: true });\n            sources.push({ sources: actor.getSourceDetails(\"system.traits.languages\"), left: true, untyped: true });\n            break;\n          case \"weapon\":\n            paths.push({ path: \"@traits.weaponProf.total\", empty: true });\n            sources.push({ sources: actor.getSourceDetails(\"system.traits.weaponProf\"), left: true, untyped: true });\n            break;\n          case \"armor\":\n            paths.push({ path: \"@traits.armorProf.total\", empty: true });\n            sources.push({ sources: actor.getSourceDetails(\"system.traits.armorProf\"), left: true, untyped: true });\n            break;\n        }\n        break;\n      case \"quadruped\": {\n        paths.push({ path: \"@attributes.quadruped\", value: String(system.attributes.quadruped) });\n        const race = this.actor.race;\n        if (race) {\n          sources.push({\n            untyped: true,\n            sources: [{ name: race.name, value: race.system.quadruped ?? false, isBoolean: true }],\n          });\n        }\n        break;\n      }\n      case \"negativeLevels\":\n        paths.push({ path: \"@attributes.energyDrain\", value: system.attributes.energyDrain, signed: false });\n        break;\n      case \"item\": {\n        const [itemId, target] = detail.split(\".\");\n        const item = this.actor.items.get(itemId);\n        if (!item) return;\n        switch (target) {\n          case \"level\":\n            paths.push({\n              path: `@classes.${item.system.tag}.level`,\n              value: lazy.rollData.classes[item.system.tag].level,\n            });\n            if (item.subType === \"mythic\") {\n              paths.push({\n                path: `@classes.${item.system.tag}.mythicTier`,\n                value: lazy.rollData.classes[item.system.tag].mythicTier,\n              });\n            } else {\n              paths.push({\n                path: `@classes.${item.system.tag}.unlevel`,\n                value: lazy.rollData.classes[item.system.tag].unlevel,\n              });\n            }\n            break;\n          case \"resources\": {\n            if (!item.isCharged || item.isSingleUse) return;\n\n            paths.push({ path: `@resources.${item.system.tag}.value`, value: item.system.uses?.value });\n            if (item.system.uses?.max > 0) {\n              paths.push({ path: `@resources.${item.system.tag}.max`, value: item.system.uses?.max });\n            }\n            break;\n          }\n          case \"attacks\": {\n            const action = item.defaultAction;\n            if (!action?.hasAttack) return;\n            const attacks =\n              action\n                ?.getAttacks({ full: true, resolve: true, conditionals: true, bonuses: true })\n                ?.map((atk) => atk.bonus)\n                .sort((a, b) => b - a) ?? [];\n\n            if (attacks.length == 0) return;\n\n            const formatter = new Intl.NumberFormat(undefined, { signDisplay: \"always\" });\n            header = attacks.map((n) => formatter.format(n)).join(\"/\");\n\n            sources.push({\n              sources: item.attackSources,\n            });\n            break;\n          }\n          case \"damage\": {\n            const action = item.defaultAction;\n            if (!action?.hasDamage) return;\n\n            const rollData = action.getRollData();\n\n            //header = dmgformula; // No different than on sheet\n\n            const dmgSources = [];\n\n            subHeader = game.i18n.localize(\"FFD20.Details\");\n\n            const damage = action.damage;\n            for (const dmg of damage.parts ?? []) {\n              dmgSources.push({\n                name: dmg.formula,\n                value: ffd20.utils.formula.simplify(dmg.formula || \"0\", rollData, { strict: false }),\n                type: ffd20.utils.i18n.join(dmg.names),\n                //unvalued: true,\n              });\n            }\n            for (const dmg of damage.nonCritParts ?? []) {\n              dmgSources.push({\n                name: dmg.formula,\n                value: ffd20.utils.formula.simplify(dmg.formula || \"0\", rollData, { strict: false }),\n                type: ffd20.utils.i18n.join(dmg.names),\n                //unvalued: true,\n              });\n            }\n\n            const held = rollData.action?.held || rollData.item?.held || \"1h\";\n\n            const ablKey = action.ability?.damage;\n            if (ablKey) {\n              const abl = rollData.abilities?.[ablKey];\n              if (abl) {\n                const max = action.ability?.max ?? Infinity;\n                const mod = Math.min(abl.mod || 0, max);\n                const mult = action.ability?.damageMult ?? ffd20.config.abilityDamageHeldMultipliers[held] ?? 1;\n                dmgSources.push({\n                  value: mod >= 0 ? Math.floor(mod * mult) : mod,\n                  type: ffd20.config.abilities[ablKey],\n                });\n              }\n            }\n\n            sources.push({ sources: dmgSources });\n\n            sources.push({\n              sources: action.allDamageSources.map((s) => ({\n                name: s.flavor,\n                ...s,\n                type: ffd20.config.bonusTypes[s.type] || s.type,\n              })),\n            });\n\n            /*\n            const hasOptionalConditionals = action?.conditionals.find((c) => !c.default);\n            if (hasOptionalConditionals) {\n              // <span class=\"span3\">+ {{localize \"FFD20.Conditionals\"}}</span>\n            }\n            */\n\n            /*\n            if (damage.critParts?.length) {\n              // <span class=\"span3\">+ {{localize \"FFD20.OnCritBonusFormula\"}}</span>\n            }\n            */\n            break;\n          }\n          case \"range\": {\n            const action = item.defaultAction;\n            if (!action?.hasRange) return;\n\n            const maxIncr = action.range?.maxIncrements ?? 1;\n            if (maxIncr <= 1) return;\n\n            details.push({\n              key: game.i18n.localize(\"FFD20.MaximumRangeIncrements\"),\n              value: action.range.maxIncrements,\n              left: true,\n            });\n\n            const rollData = action.getRollData();\n            const range = {\n              ...(action.range ?? {}),\n              min: action.getRange({ type: \"min\", rollData }),\n              max: action.getRange({ type: \"max\", rollData }),\n            };\n\n            const u = ffd20.utils.convertDistance(0, \"ft\")[1];\n            const mu = ffd20.utils.convertDistance(0, range.units)[1];\n\n            details.push({\n              key: game.i18n.localize(\"FFD20.Range\"),\n              value: `${range.min} ${u} â ${range.max} ${mu}`,\n              left: true,\n            });\n            break;\n          }\n          default:\n            throw new Error(`Invalid extended tooltip identifier \"${fullId}\"`);\n        }\n        break;\n      }\n      case \"carryCapacity\": {\n        paths.push(\n          { path: \"@attributes.encumbrance.level\", value: system.attributes.encumbrance.level },\n          { path: \"@details.carryCapacity.bonus.total\", value: system.details.carryCapacity.bonus.total },\n          {\n            path: \"@details.carryCapacity.multiplier.total\",\n            value: ffd20.utils.limitPrecision(system.details.carryCapacity.multiplier.total, 2),\n          }\n        );\n\n        const bonusMults = [];\n        const size = this.actor.system.traits?.size?.base || \"med\";\n        if (size) {\n          const isQuadruped = this.actor.system.attributes?.quadruped || false;\n          const mults = isQuadruped\n            ? ffd20.config.encumbranceMultipliers.quadruped\n            : ffd20.config.encumbranceMultipliers.normal;\n          const smult = mults[size];\n          bonusMults.push({\n            name: game.i18n.localize(\"FFD20.Size\") + (isQuadruped ? ` (${game.i18n.localize(\"FFD20.Quadruped\")})` : \"\"),\n            value: `Ã${smult}`,\n          });\n        }\n\n        sources.push({\n          label: game.i18n.localize(\"FFD20.CarryStrength\"),\n          sources: actor.getSourceDetails(\"system.details.carryCapacity.bonus.total\"),\n          untyped: true,\n        });\n        sources.push({\n          label: game.i18n.localize(\"FFD20.CarryMultiplier\"),\n          sources: [...actor.getSourceDetails(\"system.details.carryCapacity.multiplier.total\"), ...bonusMults],\n          decimals: 1,\n          untyped: true,\n        });\n        break;\n      }\n      case \"feats\": {\n        const feats = this.actor.getFeatCount();\n\n        if (feats.levels > 0) {\n          sources.push({\n            sources: [{ name: game.i18n.localize(\"FFD20.FromLevels\"), value: feats.levels }],\n            untyped: true,\n          });\n        }\n        if (feats.mythic > 0) {\n          sources.push({\n            sources: [{ name: game.i18n.localize(\"FFD20.FromMythic\"), value: feats.mythic }],\n            untyped: true,\n          });\n        }\n\n        // Generate fake sources\n        const featSources = [];\n        // TODO: Move this to the real source info generation\n        this.actor.changes\n          .filter((c) => c.target === \"bonusFeats\")\n          .forEach((c) => {\n            if (c.parent || c.flavor) {\n              featSources.push({\n                name: c.parent?.name ?? c.flavor,\n                value: c.value,\n              });\n            }\n          });\n\n        if (feats.formula !== 0) {\n          featSources.push({\n            name: game.i18n.localize(\"FFD20.BonusFeatFormula\"),\n            value: feats.formula,\n          });\n        }\n        sources.push({ sources: featSources, untyped: true });\n        break;\n      }\n      case \"skills\": {\n        const useBGSkills = game.settings.get(\"ffd20\", \"allowBackgroundSkills\");\n        const isMindless = system.abilities?.int?.value === null;\n\n        const skillSources = [];\n        const isBG = detail === \"background\";\n\n        let bgAllowed = 0;\n\n        this.actor.itemTypes.class\n          .filter((cls) => cls.system.subType !== \"mythic\")\n          .forEach((cls) => {\n            // Favoured Class Bonus\n            // Apply FCB regardless if mindless if user applied such\n            if (ffd20.config.favoredClassTypes.includes(cls.subType)) {\n              const fcSkills = cls.system.fc?.skill?.value || 0;\n              if (fcSkills > 0 && !isBG) {\n                skillSources.push({\n                  name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassFC\", { className: cls.name }),\n                  value: fcSkills,\n                  untyped: true,\n                });\n              }\n            }\n\n            // Mindless get nothing else\n            if (isMindless) return;\n\n            const hd = cls.hitDice;\n            if (hd === 0) return;\n\n            // Background skills\n            if (useBGSkills && ffd20.config.backgroundSkillClasses.includes(cls.subType)) {\n              const bgranks = hd * ffd20.config.backgroundSkillsPerLevel;\n              bgAllowed += bgranks;\n              if (bgranks > 0 && isBG) {\n                skillSources.push({\n                  name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassBase\", { className: cls.name }),\n                  value: bgranks,\n                  untyped: true,\n                });\n              }\n            }\n\n            if (!isBG) {\n              const perLevel = cls.system.skillsPerLevel || 0;\n              skillSources.push({\n                name: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassBase\", { className: cls.name }),\n                value: perLevel * hd,\n                untyped: true,\n              });\n            }\n          });\n\n        // Ability ability score\n        if (!isBG && !isMindless) {\n          const intMod = system.abilities?.int?.mod;\n          if (intMod !== 0) {\n            skillSources.push({\n              name: game.i18n.localize(\"FFD20.AbilityInt\"),\n              value: intMod * system.attributes?.hd?.total,\n            });\n          }\n        }\n\n        // Count transfers for background skills\n        if (useBGSkills) {\n          let bgUsed = 0;\n\n          // Count used skill ranks\n          for (const skl of Object.values(lazy.rollData.skills)) {\n            if (skl.subSkills) {\n              for (const subSkl of Object.values(skl.subSkills)) {\n                if (skl.background) {\n                  bgUsed += subSkl.rank;\n                }\n              }\n            } else if (skl.background) {\n              bgUsed += skl.rank;\n            }\n          }\n\n          // Adventure skills transferred to background skills\n          const sentToBG = bgUsed - bgAllowed;\n          if (sentToBG > 0) {\n            skillSources.push({\n              name: game.i18n.localize(\"FFD20.Transferred\"),\n              value: isBG ? sentToBG : -sentToBG,\n            });\n          }\n        }\n\n        sources.push(\n          {\n            sources: actor.getSourceDetails(\"system.details.skills.bonus\"),\n            untyped: true,\n          },\n          {\n            sources: skillSources,\n            untyped: true,\n          }\n        );\n        break;\n      }\n      case \"skill\": {\n        const fullSkillId = detail,\n          skillIdParts = fullSkillId.split(\".\"),\n          mainId = skillIdParts.shift(),\n          subSkillId = skillIdParts.pop(),\n          skill = this.actor.getSkillInfo(fullSkillId, { rollData: lazy.rollData });\n\n        header = `<code>${skill.id}</code>`;\n\n        const path = subSkillId ? `${mainId}.subSkills.${subSkillId}` : mainId;\n\n        paths.push(\n          { path: `@skills.${path}.mod`, value: skill.mod },\n          { path: `@skills.${path}.rank`, value: skill.rank }\n        );\n\n        sources.push({ sources: actor.getSourceDetails(`system.skills.${path}.mod`) });\n\n        notes = await getNotes(`skill.${fullSkillId}`);\n        if (subSkillId) notes.push(...(await getNotes(`skill.${mainId}`, false)));\n        break;\n      }\n      case \"spellbook\": {\n        const [bookId, target, subTarget] = detail.split(\".\");\n        const spellbook = system.attributes?.spells?.spellbooks?.[bookId];\n        switch (target) {\n          case \"class\": {\n            paths.push(\n              { path: \"@cl\", value: spellbook.cl.total },\n              { path: `@spells.${bookId}.cl.total`, value: spellbook.cl.total }\n            );\n\n            let cls;\n            // TODO: get proper spellbook roll data\n            if (spellbook.class === \"_hd\") cls = { level: lazy.rollData.attributes?.hd?.total };\n            cls = lazy.rollData.classes?.[spellbook.class];\n            if (cls) paths.push({ path: \"@class.level\", value: cls.level });\n\n            sources.push({\n              sources: actor.getSourceDetails(`system.attributes.spells.spellbooks.${bookId}.cl.total`),\n            });\n            break;\n          }\n          case \"ability\": {\n            const ablMod = lazy.rollData.abilities[spellbook.ability]?.mod;\n            paths.push(\n              {\n                path: `@spells.${bookId}.abilityMod`,\n                value: ablMod,\n              },\n              {\n                path: \"@ablMod\",\n                value: ablMod,\n              }\n            );\n            break;\n          }\n          case \"level\":\n            paths.push({\n              path: `@spells.${bookId}.cl.total`,\n              value: spellbook.cl?.total,\n            });\n            sources.push({\n              sources: actor.getSourceDetails(`system.attributes.spells.spellbooks.${bookId}.cl.total`),\n              untyped: true,\n            });\n            break;\n          case \"concentration\": {\n            paths.push({\n              path: `@spells.${bookId}.concentration.total`,\n              value: spellbook.concentration?.total,\n            });\n            sources.push({\n              sources: actor.getSourceDetails(`system.attributes.spells.spellbooks.${bookId}.concentration.total`),\n              untyped: true,\n            });\n            break;\n          }\n          case \"range\": {\n            const unit = subTarget;\n            paths.push({\n              path: `@spells.${bookId}.range.${unit}`,\n              value: spellbook.range?.[unit],\n              unit:\n                ffd20.utils.getDistanceSystem() === \"metric\"\n                  ? ffd20.config.measureUnitsShort.m\n                  : ffd20.config.measureUnitsShort.ft,\n            });\n            break;\n          }\n          case \"spellPoints\":\n            paths.push(\n              { path: `@spells.${bookId}.spellPoints.value`, value: spellbook.spellPoints.value },\n              { path: `@spells.${bookId}.spellPoints.max`, value: spellbook.spellPoints.max }\n            );\n\n            break;\n        }\n        break;\n      }\n      case \"spell\": {\n        const [itemId, target] = detail.split(\".\");\n        const item = this.actor.items.get(itemId);\n        switch (target) {\n          case \"material\": {\n            const materials = item.system.materials ?? {};\n            if (materials.focus) {\n              details.push({\n                key: game.i18n.localize(\"FFD20.SpellComponents.Type.focus.Label\"),\n                value: materials.focus,\n              });\n            }\n            if (materials.value) {\n              details.push({\n                key: game.i18n.localize(\"FFD20.SpellComponents.Type.material.Label\"),\n                value: materials.value,\n              });\n            }\n            break;\n          }\n          case \"school\": {\n            if (item.system.multischool) {\n              details.push({\n                key: game.i18n.localize(\"FFD20.SpellMultischool\"),\n                value: ffd20.utils.i18n.join([...(item.system.multischool.names ?? [])]),\n              });\n            }\n            if (item.system.subschool) {\n              details.push({\n                key: game.i18n.localize(\"FFD20.Subschool\"),\n                value: ffd20.utils.i18n.join([...(item.system.subschool.names ?? [])]),\n              });\n            }\n\n            if (item.system.descriptors?.total?.size) {\n              details.push({\n                key: game.i18n.localize(\"FFD20.DescriptorPlural\"),\n                value: ffd20.utils.i18n.join([...(item.system.descriptors.names ?? [])], \"conjunction\", false),\n              });\n            }\n\n            const action = item.defaultAction;\n\n            if (action?.hasDamage) {\n              const types = action.damage?.parts?.map((d) => d.names).flat() ?? [];\n\n              if (types.length) {\n                details.push({\n                  key: game.i18n.localize(\"FFD20.Damage\"),\n                  value: ffd20.utils.i18n.join(types),\n                });\n              }\n            }\n            break;\n          }\n        }\n        break;\n      }\n      // Generics\n      case \"generic\": {\n        const [target, subTarget] = detail.split(\".\");\n        switch (target) {\n          case \"attack\": {\n            paths.push(\n              { path: \"@attributes.attack.shared\", value: system.attributes.attack.shared },\n              { path: \"@attributes.attack.general\", value: system.attributes.attack.general },\n              { path: `@attributes.attack.${subTarget}`, value: system.attributes.attack[subTarget] }\n            );\n\n            const abl = system.attributes.attack[`${subTarget}Ability`];\n\n            sources.push(\n              { sources: actor.getSourceDetails(\"system.attributes.attack.shared\") },\n              {\n                sources: [\n                  {\n                    name: ffd20.config.abilities[abl] || abl,\n                    value: lazy.rollData.abilities?.[abl]?.mod ?? 0,\n                  },\n                ],\n              }\n            );\n\n            sources.push({\n              sources: [\n                {\n                  name: game.i18n.localize(\"FFD20.Size\"),\n                  value: Object.values(ffd20.config.sizeMods)[system.traits.size.value],\n                },\n              ],\n            });\n\n            sources.push({ sources: actor.getSourceDetails(\"system.attributes.attack.general\") });\n            sources.push({ sources: actor.getSourceDetails(`system.attributes.attack.${subTarget}`) });\n\n            notes = [...(await getNotes(\"attack\")), ...(await getNotes(subTarget))];\n\n            break;\n          }\n        }\n        break;\n      }\n      default:\n        throw new Error(`Invalid extended tooltip identifier \"${fullId}\"`);\n    }\n\n    context.header = header;\n    context.subHeader = subHeader;\n    context.details = details;\n    context.paths = paths;\n    context.sources = sources;\n    context.notes = notes ?? [];\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @protected\n   * @param {Event} event - Triggering event\n   * @param {Function} callback - Submission handler\n   */\n  _onSpanTextInput(event, callback) {\n    const el = event.target;\n    const parent = el.parentElement;\n\n    const isNumber = el.dataset.dtype === \"Number\" || el.type === \"number\";\n\n    // Replace span element with an input (text) element\n    const newEl = document.createElement(\"INPUT\");\n    newEl.type = \"text\";\n    if (el.dataset?.dtype) {\n      newEl.dataset.dtype = el.dataset.dtype;\n      if (isNumber) newEl.size = 12; // HTML defaults to 20\n    }\n\n    const noCap = el.classList.contains(\"no-value-cap\");\n    const name = el.getAttribute(\"name\"); // span has no .name attribute even if name=\"\" is used\n\n    let prevValue = 0,\n      maxValue;\n\n    if (name) {\n      newEl.setAttribute(\"name\", name);\n      prevValue = foundry.utils.getProperty(this.actor, name) || 0;\n      if (name.endsWith(\".value\") && !noCap && isNumber) {\n        const maxName = name.replace(/\\.value$/, \".max\");\n        maxValue = foundry.utils.getProperty(this.actor, maxName);\n      }\n    } else {\n      if (!el.classList.contains(\"placeholder\")) {\n        prevValue = isNumber ? parseFloat(el.innerText || \"0\") : el.innerText || \"\";\n      }\n    }\n\n    // Add constraints if they exist\n    if (el.dataset.min) newEl.min = el.dataset.min;\n    if (el.dataset.step) newEl.step = el.dataset.step;\n    if (el.dataset.max) newEl.max = el.dataset.max;\n\n    // Set value of new input element\n    newEl.value = `${prevValue || 0}`;\n\n    // Toggle classes\n    const forbiddenClasses = [\"placeholder\", \"direct\", \"allow-relative\"];\n    for (const cls of el.classList) {\n      if (!forbiddenClasses.includes(cls)) newEl.classList.add(cls);\n    }\n\n    const allowRelative = el.classList.contains(\"allow-relative\"),\n      clearValue = isNumber ? parseFloat(el.dataset.clearValue || \"0\") : \"\";\n\n    // Replace span with input element\n    parent.replaceChild(newEl, el);\n\n    let changed;\n    newEl.addEventListener(\n      \"change\",\n      (event) => {\n        event.preventDefault();\n        event.stopPropagation(); // Prevent Foundry acting on this\n        changed = true;\n\n        let newValue;\n        if (allowRelative) {\n          newValue = ffd20.utils.internal.adjustNumberByStringCommand(prevValue, newEl.value, maxValue, clearValue);\n          newEl.value = newValue;\n        } else {\n          newValue = parseFloat(newEl.value || \"0\");\n        }\n\n        // Reset if nothing changed\n        if (newValue === prevValue) {\n          parent.replaceChild(el, newEl);\n        }\n        // Pass it to callback\n        else {\n          newEl.readOnly = true;\n          callback(event, el);\n        }\n      },\n      { once: true }\n    );\n\n    newEl.addEventListener(\n      \"focusout\",\n      (event) => {\n        if (changed) return;\n\n        const newValue = parseFloat(newEl.value || \"0\");\n        if (newValue === prevValue) {\n          parent.replaceChild(el, newEl);\n        }\n      },\n      { passive: true, once: true }\n    );\n\n    // Select text inside new element\n    newEl.focus();\n    newEl.select();\n  }\n\n  /**\n   * @internal\n   * @param {DragEvent} event - Drag start event\n   */\n  _onDragSkillStart(event) {\n    const elem = event.currentTarget;\n    const skillElem = elem.closest(\".skill\");\n    const mainSkill = skillElem.dataset.skill;\n    const subSkill = skillElem.dataset.subSkill;\n\n    const result = {\n      type: \"skill\",\n      uuid: this.actor.uuid,\n      skill: subSkill ? `${mainSkill}.${subSkill}` : mainSkill,\n    };\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  /**\n   * @param {DragEvent} event - Drag start event\n   * @param {\"bab\"|\"cmb\"|\"defenses\"|\"concentration\"|\"cl\"|\"initiative\"|\"abilityScore\"|\"attack\"} type\n   * @param {string} [subType] Type specific subtype\n   */\n  _onDragMiscStart(event, type, subType) {\n    const result = {\n      type,\n      uuid: this.actor.uuid,\n    };\n\n    switch (type) {\n      case \"bab\":\n      case \"cmb\":\n      case \"initiative\":\n      case \"defenses\":\n        // No special handling\n        break;\n      case \"concentration\":\n      case \"cl\": {\n        const elem = event.currentTarget.closest(\".tab.spellbook-group\");\n        result.bookId = elem.dataset.tab;\n        break;\n      }\n      case \"abilityScore\":\n        result.ability = subType;\n        break;\n      case \"attack\":\n        result.attack = subType;\n        break;\n      default:\n        throw new Error(`Unrecognized drag source: ${type}`);\n    }\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  _onDragSaveStart(event, type) {\n    const result = {\n      type: \"save\",\n      save: type,\n      uuid: this.actor.uuid,\n    };\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(result));\n  }\n\n  /**\n   * Initialize Item list filters by activating the set of filters which are currently applied\n   *\n   * @private\n   * @param _i\n   * @param {Element} ul\n   */\n  _initializeFilterItemList(_i, ul) {\n    const filters = ul.querySelectorAll(\".filter-rule\");\n    for (const li of filters) {\n      const set = (this._filters.sections[li.dataset.category] ??= new Set());\n      if (set.has(li.dataset.filter)) li.classList.add(\"active\");\n    }\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  async _onRest(event) {\n    event.preventDefault();\n\n    const skipDialog = ffd20.documents.settings.getSkipActionPrompt();\n    if (skipDialog) {\n      const button = event.currentTarget;\n      button.disabled = true;\n      try {\n        await this.actor.performRest({ verbose: true });\n      } finally {\n        button.disabled = false;\n      }\n    } else {\n      const app = Object.values(this.actor.apps).find((app) => app instanceof ActorRestDialog);\n      if (app) {\n        app.render(true);\n        app.bringToFront();\n      } else new ActorRestDialog({ document: this.actor }).render({ force: true });\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle rolling of an item from the Actor sheet, obtaining the Item instance and dispatching to it's roll method\n   *\n   * @param event\n   * @private\n   */\n  _onItemCard(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    if (item == null) return;\n    return item.displayCard(undefined, { token: this.token });\n  }\n\n  _mouseWheelAdd(event, el) {\n    const isInput = el.tagName === \"INPUT\";\n    const { originalEvent } = event;\n\n    if (originalEvent && originalEvent instanceof WheelEvent && originalEvent.ctrlKey) {\n      event.preventDefault();\n      const value = (isInput ? parseFloat(el.value) : parseFloat(el.innerText)) || 0;\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(originalEvent.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n\n      if (isInput) {\n        el.value = value + amount * increase;\n      } else {\n        el.innerText = (value + amount * increase).toString();\n      }\n    }\n  }\n\n  _setItemUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n\n    this._mouseWheelAdd(event, el);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", this._commitItemUsesBound, { passive: true, once: true });\n    } else {\n      this._commitItemUses(event);\n    }\n  }\n\n  /**\n   * Commit changes from {@link _setItemUses}\n   *\n   * @internal\n   * @param {Event} event\n   * @returns {Promise}\n   */\n  async _commitItemUses(event) {\n    const el = event.currentTarget;\n    /** @type {string} */\n    const itemId = el.closest(\".item\").dataset.itemId;\n    /** @type {ItemPF} */\n    const item = this.actor.items.get(itemId);\n\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n\n    return item.addCharges(value - item.charges);\n  }\n  _commitItemUsesBound = this._commitItemUses.bind(this); // To avoid multiple anonymous function registrations\n\n  _setSpellUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n\n    const prevValue = item.system.preparation?.value ?? 0;\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n\n    this.setItemUpdate(item.id, \"system.preparation.value\", value);\n    if (prevValue < value) {\n      const maxValue = item.system.preparation.max ?? 0;\n      this.setItemUpdate(item.id, \"system.preparation.max\", Math.max(maxValue, value));\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", () => this._updateItems(), { passive: true, once: true });\n    } else this._updateItems();\n  }\n\n  _setMaxSpellUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n\n    const prevValue = item.system.preparation?.max ?? 0;\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setItemUpdate(item.id, \"system.preparation.max\", Math.max(0, value));\n    if (prevValue > value) {\n      const curValue = item.system.preparation.value ?? 0;\n      this.setItemUpdate(item.id, \"system.preparation.value\", Math.min(curValue, value));\n    }\n    if (value < 0) {\n      el.tagName === \"INPUT\" ? (el.value = 0) : (el.innerText = 0);\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", () => this._updateItems(), { passive: true, once: true });\n    } else this._updateItems();\n  }\n\n  async _adjustActorPropertyBySpan(event, oldEl) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    this._mouseWheelAdd(event, el);\n\n    // Get base value\n    const rawValue = el.tagName === \"INPUT\" ? el.value : el.innerText;\n    let value = el.dataset.dtype === \"String\" ? rawValue : Number(rawValue);\n\n    // Adjust value if needed\n    const name = el.getAttribute(\"name\"); // .name is not available on non-inputs\n    if (name.match(/^system\\.abilities\\.([a-zA-Z0-9]+)\\.value$/)) {\n      if (Number.isNaN(parseInt(value))) value = null;\n      else value = parseInt(value);\n    }\n\n    // Add constraints if any\n    if (el.min) value = Math.max(Number(el.min), value);\n    if (el.max) value = Math.min(Number(el.max), value);\n    if (el.step) value = value.toNearest(Number(el.step));\n\n    let updateData;\n    if (name) {\n      if (value === foundry.utils.getProperty(this.actor, name)) {\n        // Restore input\n        if (oldEl) el.parentElement.replaceChild(oldEl, el);\n        return;\n      }\n      updateData = { [name]: value };\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", async (event) => this._updateObject(event, this._getSubmitData(updateData)), {\n        once: true,\n      });\n    } else {\n      this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n\n  _setBuffLevel(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    this._mouseWheelAdd(event, el);\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n\n    this.setItemUpdate(item.id, \"system.level\", value);\n\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", () => this._updateItems(), { passive: true, once: true });\n    } else this._updateItems();\n  }\n\n  _hideShowElement(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const target = this.element.find(`.${a.dataset.for}`);\n\n    if (target.hasClass(\"hidden\")) {\n      $(a).find(\"i\").removeClass(\"fa-arrow-circle-down\").addClass(\"fa-arrow-circle-up\");\n      target.removeClass(\"hidden\");\n      target.hide();\n      target.slideDown(200);\n\n      this._hiddenElems[a.dataset.for] = false;\n    } else {\n      $(a).find(\"i\").removeClass(\"fa-arrow-circle-up\").addClass(\"fa-arrow-circle-down\");\n      target.slideUp(200, () => target.addClass(\"hidden\"));\n\n      this._hiddenElems[a.dataset.for] = true;\n    }\n  }\n\n  _onToggleCondition(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const conditionId = a.dataset.conditionId;\n\n    const immunities = this.actor.getConditionImmunities();\n\n    if (immunities.has(conditionId)) {\n      if (!this.actor.statuses.has(conditionId)) {\n        return void ui.notifications.warn(\n          game.i18n.format(\"FFD20.Warning.ImmuneToCondition\", {\n            name: this.actor.name,\n            condition: ffd20.registry.conditions.get(conditionId)?.name || conditionId,\n          })\n        );\n      }\n    }\n\n    this.actor.toggleCondition(conditionId);\n  }\n\n  async _onEditCondition(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const conditionId = a.dataset.conditionId;\n    const cond = ffd20.registry.conditions.get(conditionId);\n    if (!cond) throw new Error(`Invalid condition ID: ${conditionId}`);\n\n    const immunities = this.actor.getConditionImmunities();\n\n    if (immunities.has(conditionId)) {\n      if (!this.actor.statuses.has(conditionId)) {\n        return void ui.notifications.warn(\n          game.i18n.format(\"FFD20.Warning.ImmuneToCondition\", {\n            name: this.actor.name,\n            condition: ffd20.registry.conditions.get(conditionId)?.name || conditionId,\n          })\n        );\n      }\n    }\n\n    let ae;\n\n    if (this.actor.statuses.has(conditionId)) {\n      const relevantAEs = [];\n      for (const ae of this.actor.allApplicableEffects()) {\n        if (!ae.active) continue;\n        if (ae.statuses.has(conditionId)) relevantAEs.push(ae);\n      }\n\n      // TODO: Add selector and remove this error message\n      if (relevantAEs.length > 1) {\n        return void ui.notifications.warn(\"FFD20.Error.TooManyConditionSources\", { localize: true });\n      }\n\n      ae = relevantAEs[0];\n    }\n\n    const { bottom, left } = a.getBoundingClientRect();\n\n    const rounds = await ffd20.utils.dialog.getNumber({\n      title: cond.name + \" â \" + game.i18n.localize(\"FFD20.Duration\"),\n      initial: Math.floor((ae?.duration?.seconds ?? 0) / CONFIG.time.roundTime),\n      hint: game.i18n.localize(\"FFD20.Time.Period.round.Label\"),\n      min: 0,\n      step: 1,\n      dialog: {\n        position: {\n          top: bottom + 20,\n          left: left - 20,\n        },\n      },\n    });\n\n    if (!Number.isFinite(rounds)) return;\n\n    const updateData = { \"duration.seconds\": rounds * CONFIG.time.roundTime };\n    if (ae) ae.update(updateData);\n    else this.actor.setCondition(conditionId, updateData);\n  }\n\n  /**\n   * Toggle skill lock.\n   *\n   * @param {MouseEvent} event\n   */\n  _onToggleSkillLock(event) {\n    event.preventDefault();\n    this._skillsLocked = !this._skillsLocked;\n\n    const target = event.currentTarget;\n    target.classList.toggle(\"unlocked\", !this._skillsLocked);\n\n    const tab = target.closest(\".tab\");\n    tab.classList.toggle(\"locked\", this._skillsLocked);\n\n    tab.querySelectorAll(\".lockable\").forEach((el) => {\n      if ([\"INPUT\", \"SELECT\"].includes(el.tagName)) {\n        el.disabled = this._skillsLocked;\n      } else {\n        el.classList.toggle(\"hide-contents\", this._skillsLocked);\n      }\n    });\n  }\n\n  /**\n   * Handle opening a compendium browser\n   *\n   * @private\n   * @param {Event} event   The originating click event\n   */\n  _onOpenCompendiumBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const [cat0, cat1] = a.dataset.source?.split(\".\") ?? [];\n\n    const cfg = ffd20.config.sheetSections[cat0]?.[cat1]?.browse ?? {\n      category: a.dataset.category || cat0,\n      type: a.dataset.type,\n    };\n\n    const browser = ffd20.applications.compendiums[cfg.category];\n    if (!browser) throw new Error(`Could not find \"${cfg.category}\" browser`);\n\n    const filters = {};\n\n    // Basic filters\n    for (const [key, value] of Object.entries(cfg)) {\n      if ([\"level\", \"category\"].includes(key)) continue;\n      filters[key] = (Array.isArray(value) ? value : [value]).filter((i) => i);\n      if (key === \"classType\" && this.actor.type === \"npc\") {\n        filters[key] = [...filters[key], \"npc\", \"racial\"];\n      }\n    }\n\n    // Inline filter customization\n    const custom = a.dataset.filters;\n    if (custom) {\n      const parts = custom.split(\";\");\n      for (const part of parts) {\n        const [key, value] = part.split(\"=\");\n        filters[key] = value.split(\",\");\n      }\n    }\n\n    // Special handling for level\n    if (cfg.level && a.dataset.level) {\n      filters.level = a.dataset.level;\n      const bookId = a.closest(\"[data-group][data-tab]\")?.dataset.tab;\n      if (bookId) {\n        const clsId = this.actor.system.attributes?.spells?.spellbooks?.[bookId]?.class;\n        if (clsId && clsId !== \"_hd\") {\n          filters.class = clsId;\n        }\n      }\n    }\n\n    browser._queueFilters(filters);\n    browser._render(true, { focus: true });\n  }\n\n  /**\n   * Handle opening a skill's compendium entry\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  async _onOpenCompendiumEntry(event) {\n    const uuid = event.currentTarget.dataset.compendiumEntry;\n\n    ffd20.utils.openJournal(uuid);\n  }\n\n  _onRollConcentration(event) {\n    event.preventDefault();\n\n    const spellbookKey = $(event.currentTarget).closest(\".spellbook-group\").data(\"tab\");\n    this.actor.rollConcentration(spellbookKey, { token: this.token });\n  }\n\n  _onRollCL(event) {\n    event.preventDefault();\n\n    const spellbookKey = $(event.currentTarget).closest(\".spellbook-group\").data(\"tab\");\n    this.actor.rollCL(spellbookKey, { token: this.token });\n  }\n\n  _setItemActive(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    const state = el.checked;\n    const itemId = el.closest(\".item\").dataset.itemId;\n\n    this.actor.items.get(itemId).setActive(state);\n  }\n\n  _onLevelUp(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    return LevelUpForm.increaseLevel(this.actor, item, { token: this.token });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {JQuery.ClickEvent<HTMLElement>} event - The click event on the item\n   * @private\n   */\n  _onItemSummary(event) {\n    event.preventDefault();\n    const li = event.target.closest(\".item[data-item-id]\");\n    this.openItemSummary(li);\n  }\n\n  /**\n   * Toggle inline display of an item's summary/description by expanding or hiding info div\n   *\n   * @protected\n   * @param {JQuery<HTMLElement>} elem - The element to open. Likely will have the `item` class in CSS.\n   * @param {boolean} [instant=false] - Whether to instantly show the expansion (true), or animate it (false)\n   */\n  async openItemSummary(elem, { instant = false, rollData } = {}) {\n    // Check whether pseudo-item belongs to another collection\n    const itemId = elem.dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    const listEl = elem.closest(\".item-list[data-list]\");\n    const list = listEl?.dataset.list;\n    const tab = listEl?.closest(\".tab[data-tab]\").dataset.tab;\n    const expandedId = `${tab}.${list}.${itemId}`;\n\n    rollData ??= item.defaultAction?.getRollData() ?? item.getRollData();\n\n    // Toggle summary\n    if (elem.classList.contains(\"expanded\")) {\n      this._expandedItems.delete(expandedId);\n      const summary = elem.querySelector(\".item-summary\");\n      summary.inert = true;\n      if (instant) summary.remove();\n      else $(summary).slideUp(200, () => summary.remove());\n    } else {\n      const chatData = await item.getChatData({ chatcard: false, rollData });\n      const templateData = chatData;\n\n      const content = await renderTemplate(\"systems/ffd20/templates/actors/parts/actor-item-summary.hbs\", templateData);\n      let div = document.createElement(\"div\");\n      div.innerHTML = await ffd20.utils.enrichHTMLUnrolled(content, { rollData, secrets: this.actor.isOwner });\n      div = div.firstElementChild; // The template has only one root element\n\n      if (!instant) $(div).hide();\n      elem.append(div);\n      if (!instant) $(div).slideDown(200);\n\n      this._expandedItems.add(expandedId);\n    }\n    elem.classList.toggle(\"expanded\");\n  }\n\n  /**\n   * Makes a readonly text input editable, and focus it.\n   *\n   * @private\n   * @param {Event} event\n   */\n  _onInputText(event) {\n    event.preventDefault();\n    const elem = event.target;\n\n    if (!elem || elem?.disabled) return;\n\n    elem.readOnly = false;\n    const value = foundry.utils.getProperty(this.actor, elem.name);\n\n    const origValue = elem.value;\n    elem.value = value;\n\n    let changed = false;\n\n    const wheelEvent = event instanceof WheelEvent;\n    if (wheelEvent) {\n      this._mouseWheelAdd(event, elem);\n    } else {\n      elem.select();\n    }\n\n    const handler = (event) => {\n      // Clear selection if any\n      const s = document.getSelection();\n      if (s.anchorNode === elem || s.anchorNode === elem.parentElement) s.removeAllRanges();\n\n      if (wheelEvent) elem.removeEventListener(\"pointerout\", handler);\n      else {\n        elem.removeEventListener(\"focusout\", handler);\n        elem.removeEventListener(\"keydown\", keyHandler);\n      }\n      elem.removeEventListener(\"click\", handler);\n\n      changed ||= `${value}` !== elem.value;\n\n      if (changed) {\n        this._onSubmit(event);\n      } else {\n        elem.readOnly = true;\n        elem.value = origValue;\n      }\n    };\n    const keyHandler = (event) => {\n      if (event.key === \"Enter\") {\n        changed = true;\n        handler(event);\n      }\n    };\n\n    if (wheelEvent) {\n      elem.addEventListener(\"pointerout\", handler, { passive: true });\n      changed = true;\n    } else {\n      elem.addEventListener(\"focusout\", handler, { passive: true });\n      elem.addEventListener(\"keydown\", keyHandler, { passive: true });\n    }\n    elem.addEventListener(\"click\", handler, { passive: true });\n  }\n\n  /* -------------------------------------------- */\n\n  async _onArbitrarySkillCreate(event) {\n    event.preventDefault();\n    const skillId = $(event.currentTarget).parents(\".skill\").attr(\"data-skill\");\n    const mainSkillData = this.actor.system.skills[skillId];\n    const skillData = {\n      name: game.i18n.format(\"DOCUMENT.New\", { type: game.i18n.localize(\"FFD20.Skill\") }),\n      ability: mainSkillData.ability,\n      rank: 0,\n      rt: mainSkillData.rt,\n      cs: mainSkillData.cs,\n      acp: mainSkillData.acp,\n    };\n\n    // Get tag\n    let count = 1;\n    let tag = `${skillId}${count}`;\n    while (mainSkillData.subSkills[tag] != null) {\n      count++;\n      tag = `${skillId}${count}`;\n    }\n\n    const updateData = {};\n    updateData[`system.skills.${skillId}.subSkills.${tag}`] = skillData;\n    await this.actor.update(updateData);\n\n    return this._editSkill(skillId, tag);\n  }\n\n  async _onSkillCreate(event) {\n    event.preventDefault();\n    const isBackground = $(event.currentTarget).parents(\".skills-list\").attr(\"data-background\") === \"true\";\n    const skillData = {\n      name: game.i18n.format(\"DOCUMENT.New\", { type: game.i18n.localize(\"FFD20.Skill\") }),\n      ability: \"int\",\n      rank: 0,\n      mod: 0,\n      rt: false,\n      cs: false,\n      acp: false,\n      background: isBackground,\n      custom: true,\n    };\n\n    const baseName = skillData.name || \"skill\";\n    const baseTag = ffd20.utils.createTag(baseName, { allowUnderScore: false });\n    let tag = baseTag;\n    let count = 1;\n    while (this.actor.system.skills[tag] != null) {\n      count++;\n      tag = baseTag + count.toString();\n    }\n\n    const updateData = {};\n    updateData[`system.skills.${tag}`] = skillData;\n    await this.actor.update(updateData);\n\n    return this._editSkill(tag);\n  }\n\n  /**\n   * Opens a dialog to edit a skill.\n   *\n   * @param {string} skillId - The id of the skill in question.\n   * @param {string} [subSkillId] - The id of the subskill, if appropriate.\n   * @returns {Promise.<void>}\n   */\n  _editSkill(skillId, subSkillId) {\n    return new Promise((resolve) => {\n      const app = new ffd20.applications.SkillEditor(this.actor, skillId, subSkillId);\n      app.addCallback(resolve);\n      app.render(true);\n    });\n  }\n\n  _onSkillEdit(event) {\n    event.preventDefault();\n    const el = event.target.closest(\".skill\");\n    const mainSkillId = el.dataset.skill;\n    const subSkillId = el.dataset.subSkill;\n\n    return this._editSkill(mainSkillId, subSkillId);\n  }\n\n  async _onSkillDelete(event) {\n    event.preventDefault();\n    const el = event.target.closest(\".skill\");\n    const mainSkillId = el.dataset.skill;\n    const subSkillId = el.dataset.subSkill;\n    const skillId = subSkillId ? `${mainSkillId}.${subSkillId}` : mainSkillId;\n\n    const info = this.actor.getSkillInfo(skillId);\n\n    const deleteSkill = () => {\n      const updateData = {};\n      // Delete subskill\n      if (subSkillId) updateData[`system.skills.${mainSkillId}.subSkills.-=${subSkillId}`] = null;\n      // Delete main skill\n      else updateData[`system.skills.-=${mainSkillId}`] = null;\n      this.actor.update(updateData);\n    };\n\n    let confirm = true;\n    if (!getSkipActionPrompt()) {\n      confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: game.i18n.format(\"FFD20.DeleteSkillTitle\", { name: info.fullName }) },\n        content: `<p>${game.i18n.localize(\"FFD20.DeleteSkillConfirmation\")}</p>`,\n        rejectClose: false,\n        modal: true, // Prevent other interactions until this dialog is resolved,\n      });\n    }\n    if (confirm) deleteSkill();\n  }\n\n  async _onPointBuyCalculator(event) {\n    event.preventDefault();\n\n    const app = Object.values(this.actor.apps).find((app) => app instanceof PointBuyCalculator);\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else new PointBuyCalculator({ document: this.actor }).render({ force: true });\n  }\n\n  async _onSensesSelector(event) {\n    event.preventDefault();\n\n    const app = Object.values(this.actor.apps).find((app) => app instanceof ffd20.applications.SensesSelector);\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else {\n      new ffd20.applications.SensesSelector({ document: this.actor }).render({ force: true });\n    }\n  }\n\n  async _onControlAlignment(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const items = Object.entries(ffd20.config.alignmentsShort).map(([value, label]) => ({ value, label }));\n    const w = new Widget_ItemPicker(\n      (alignment) => {\n        this.actor.update({ \"system.details.alignment\": alignment });\n      },\n      { items, columns: 3 }\n    );\n    w.render($(a));\n  }\n\n  /**\n   * Activate an item from item control button.\n   *\n   * @param {MouseEvent} event Click event\n   */\n  _itemActivationControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.closest(\".item[data-item-id]\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    item.use({ ev: event, token: this.token });\n  }\n\n  async _quickChangeItemQuantity(event, add = 1) {\n    event.preventDefault();\n    if (event.shiftKey) add *= 5;\n    if (event.ctrlKey) add *= 10;\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    const curQuantity = item.system.quantity || 0;\n    let newQuantity = Math.max(0, curQuantity + add);\n\n    if (item.type === \"container\") newQuantity = Math.min(newQuantity, 1);\n\n    item.update({ \"system.quantity\": newQuantity });\n  }\n\n  async _quickEquipItem(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    item.setActive(!item.activeState);\n  }\n\n  async _quickCarryItem(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    if (item.isPhysical) {\n      item.update({ \"system.carried\": !item.system.carried });\n    }\n  }\n\n  async _quickIdentifyItem(event) {\n    event.preventDefault();\n\n    if (!game.user.isGM) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.Error.CantIdentify\"));\n    }\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    if (item.isPhysical) {\n      item.update({ \"system.identified\": !item.system.identified });\n    }\n  }\n\n  async _itemPreparedToggle(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n    const property = el.dataset.name;\n\n    const updateData = { system: {} };\n    foundry.utils.setProperty(updateData.system, property, foundry.utils.getProperty(item.system, property) ? 0 : 1);\n    item.update(updateData);\n  }\n\n  /**\n   * Prepare duplicate item data\n   *\n   * @param {object} itemData\n   * @param {object} options\n   * @param {boolean} [options.rename]\n   * @param {ItemPF} [options.original]\n   */\n  _prepareDuplicateItem(itemData, { rename = true, original } = {}) {\n    delete itemData._id;\n\n    delete itemData.system.links?.children;\n    delete itemData.system.links?.charges;\n\n    itemData.sort = itemData.sort + 1_000;\n\n    if (original) {\n      itemData._stats ??= {};\n      itemData._stats.duplicateSource ||= original.uuid;\n    }\n\n    if (rename) {\n      // Build list of visible names in same general category.\n      const subType = itemData.system?.subType;\n      const relatedItems = this.actor.items.filter(\n        (i) =>\n          i.type === itemData.type &&\n          (subType ? subType === i.system?.subType : true) &&\n          (itemData.type === \"spell\" ? itemData.system.level === i.system.level : true)\n      );\n\n      const searchUnusedName = (name, existingNames) => {\n        name = name.replace(/\\s+\\(\\d+\\)$/, \"\");\n        let iter = 1;\n        let newName;\n        do {\n          iter += 1;\n          newName = `${name} (${iter})`;\n        } while (existingNames.has(newName));\n        return newName;\n      };\n\n      // Alter identified name\n      const identNames = new Set(relatedItems.map((i) => i.name)); // Explicit real name\n      itemData.name = searchUnusedName(itemData.name, identNames);\n\n      // Alter unidentified name if it exists\n      const unidentified = itemData.system.unidentified;\n      if (unidentified?.name && CONFIG.Item.documentClasses[itemData.type]?.isPhysical) {\n        const unidentNames = new Set(relatedItems.map((i) => i.getName(true))); // Player visible names instead of unidentified names\n        unidentified.name = searchUnusedName(unidentified.name, unidentNames);\n      }\n    }\n  }\n\n  async _duplicateItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.closest(\".item[data-item-id]\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n    const itemData = item.toObject();\n\n    this._prepareDuplicateItem(itemData, { original: item });\n\n    await Item.implementation.create(itemData, { parent: this.actor, renderSheet: true });\n  }\n\n  _quickAction(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const itemId = a.dataset.itemId;\n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n\n    return item.use({ token: this.token });\n  }\n\n  _convertCurrency(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const currencyType = a.dataset.type;\n    const category = a.dataset.category;\n\n    this.actor.convertCurrency(category, currencyType);\n  }\n\n  /**\n   * Handle creating a new Owned Item for the actor using initial data defined in the HTML dataset\n   *\n   * @private\n   * @param {Event} event\n   */\n  _onItemCreate(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const [categoryId, sectionId] = el.dataset.create?.split(\".\") ?? [];\n    const createData = foundry.utils.deepClone(ffd20.config.sheetSections[categoryId]?.[sectionId]?.create);\n    if (!createData) throw new Error(`No creation data found for \"${categoryId}.${sectionId}\"`);\n\n    const type = createData.type || el.dataset.type;\n    const subType = createData.system?.subType;\n\n    createData.name = Item.implementation.defaultName({ type, subType, parent: this.actor });\n    const newItem = new Item.implementation(createData);\n\n    // Add type specific data\n    switch (type) {\n      case \"spell\": {\n        newItem.updateSource({\n          system: {\n            level: parseInt(el.dataset.level),\n            spellbook: el.dataset.book,\n          },\n        });\n        break;\n      }\n      case \"feat\":\n        // Add class association to class features\n        if (newItem.subType === \"classFeat\" && !newItem.system.class) {\n          const classes = [...this.actor.itemTypes.class].sort((a, b) => (b.system.level || 0) - (a.system.level || 0));\n          if (classes.length > 0) {\n            newItem.updateSource({ system: { class: classes[0].system.tag } });\n          }\n        }\n        break;\n    }\n\n    this._sortNewItem(newItem);\n\n    // Get old items of same general category\n    const oldItems = this.actor.itemTypes[type]\n      .filter((oldItem) => ffd20.utils.isItemSameSubGroup(newItem, oldItem))\n      .sort((a, b) => b.sort - a.sort);\n\n    if (oldItems.length) {\n      // Ensure no duplicate names occur\n      const baseName = newItem.name;\n      let newName = baseName;\n      let i = 2;\n      const names = new Set(oldItems.map((i) => i.name));\n      while (names.has(newName)) {\n        newName = `${baseName} (${i++})`;\n      }\n\n      if (newName !== newItem.name) newItem.updateSource({ name: newName });\n    }\n\n    return Item.implementation.create(newItem.toObject(), { parent: this.actor, renderSheet: true });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle editing an existing Owned Item for the Actor\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onItemEdit(event) {\n    event.preventDefault();\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.actor.items.get(li.dataset.itemId);\n\n    item.sheet.render(true, { focus: true });\n  }\n\n  /**\n   * Handle deleting an existing Owned Item for the Actor\n   *\n   * @private\n   * @param {Event} event   The originating click event\n   * @returns {Promise<*>} - Promise for when the interaction completes\n   */\n  async _onItemDelete(event) {\n    event.preventDefault();\n\n    const button = event.currentTarget;\n    if (button.disabled) return;\n\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.actor.items.get(li.dataset.itemId);\n\n    button.disabled = true;\n\n    if (getSkipActionPrompt()) return item.delete();\n\n    // Find linked items that would be deleted with this\n    const linked = new Set();\n    /**\n     * @param {ItemPF} item\n     */\n    const findAllLinks = (item) => {\n      linked.add(item);\n      const links = item.getLinkedItemsSync(\"children\");\n      for (const i of links) {\n        if (linked.has(i)) continue;\n        findAllLinks(i);\n      }\n    };\n    findAllLinks(item);\n    // Find class associations\n    if (item.type === \"class\") {\n      const associations = item.getFlag(\"ffd20\", \"links.classAssociations\") ?? {};\n      for (const itemId of Object.keys(associations)) {\n        const item = this.actor.items.get(itemId);\n        if (item) linked.add(item);\n      }\n    }\n    linked.delete(item); // Don't notify about self\n\n    const templateData = {\n      linked: [...linked].map((i) => ({\n        name: i.name,\n        uuid: i.uuid,\n        type: game.i18n.localize(CONFIG.Item.typeLabels[i.type]),\n      })),\n    };\n\n    const msg = await renderTemplate(\"systems/ffd20/templates/internal/delete-item.hbs\", templateData);\n\n    const confirm = await foundry.applications.api.DialogV2.confirm({\n      window: { title: game.i18n.format(\"FFD20.DeleteItemTitle\", { name: item.name }) },\n      classes: [\"pf1-v2\", \"delete-item\"],\n      content: msg,\n      rejectClose: false,\n      modal: true, // Require dialog to be resolved\n    });\n\n    if (confirm) item.delete();\n\n    button.disabled = false;\n  }\n\n  async _onItemGive(event) {\n    event.preventDefault();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    const targets = game.actors.filter(\n      (a) => a !== this.actor && a.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED)\n    );\n    if (targets.length === 0) ui.notifications.warn(\"FFD20.Error.NoGiftTargets\", { localize: true });\n\n    const targetActorId = await ffd20.utils.dialog.getActor({\n      window: {\n        title: game.i18n.localize(\"FFD20.GiveItemToActor\"),\n      },\n      actors: targets,\n    });\n\n    const target = game.actors.get(targetActorId);\n    if (!target) throw new Error(`Invalid actor ID as gift target: \"${targetActorId}\"`);\n\n    if (target.isOwner) {\n      const itemData = item.toObject();\n      delete itemData.system?.links?.children;\n      const newItem = await Item.implementation.create(itemData, { parent: target });\n      // Delete only if item was successfully created\n      if (newItem) await item.delete();\n    } else {\n      game.socket.emit(\"system.ffd20\", {\n        eventType: \"giveItem\",\n        targetActor: target.uuid,\n        item: item.uuid,\n      });\n      // Deleting will be performed on the gm side as well to prevent race conditions\n    }\n  }\n\n  async _onItemSplit(event) {\n    event.preventDefault();\n\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.actor.items.get(itemId);\n\n    const quantity = item.system.quantity;\n    if (quantity < 2) throw new Error(\"Can't split stack with less than 2 items\");\n\n    const options = {\n      total: quantity,\n      title: game.i18n.format(\"FFD20.Dialog.SplitItem.Title\", { name: item.name }),\n    };\n\n    // Position the dialog near click location\n    const clickEl = event.target.getBoundingClientRect();\n    const renderOpts = {\n      position: {\n        width: 320,\n        left: clickEl.left - 350,\n        top: clickEl.top - 80,\n      },\n    };\n\n    const result = await ffd20.applications.SplitStack.wait(options, renderOpts);\n    if (!result) return;\n\n    const [keep, split] = result;\n\n    const itemData = item.toObject();\n    itemData.system.quantity = split;\n\n    this._prepareDuplicateItem(itemData, { rename: false, original: item });\n\n    await Item.implementation.createDocuments([itemData], { parent: this.actor });\n    await item.update({ \"system.quantity\": keep });\n  }\n\n  /**\n   * Handle rolling an Ability check, either a test or a saving throw\n   *\n   * @protected\n   * @param {Event} event   The originating click event\n   */\n  _onRollAbilityTest(event) {\n    event.preventDefault();\n\n    /** @type {AbilityId} */\n    const ability = event.currentTarget.closest(\".ability\").dataset.ability;\n    this.actor.rollAbilityTest(ability, { token: this.token });\n  }\n\n  /**\n   * Roll basic BAB check\n   *\n   * @protected\n   * @param {Event} event\n   */\n  _onRollBAB(event) {\n    event.preventDefault();\n\n    this.actor.rollBAB({ token: this.token });\n  }\n\n  /**\n   * Roll generic attack\n   *\n   * @protected\n   * @param {Event} event\n   */\n  _onRollAttack(event) {\n    event.preventDefault();\n    /** @type {HTMLElement} */\n    let el = event.target;\n    if (!el.classList.contains(\"rollable\")) el = el.closest(\".rollable\");\n\n    const maneuver = el.dataset.type !== \"weapon\";\n    const ranged = el.dataset.ranged === \"true\";\n\n    this.actor.rollAttack({ maneuver, ranged, token: this.token });\n  }\n\n  /**\n   * Roll initiative\n   *\n   * @protected\n   * @param {Event} event\n   */\n  _onRollInitiative(event) {\n    event.preventDefault();\n\n    this.actor.rollInitiative({\n      createCombatants: true,\n      rerollInitiative: game.user.isGM,\n      token: this.token,\n    });\n  }\n\n  /**\n   * Roll saving throw\n   *\n   * @protected\n   * @param {Event} event\n   */\n  _onRollSavingThrow(event) {\n    event.preventDefault();\n\n    /** @type {SaveId} */\n    const saveId = event.currentTarget.closest(\".saving-throw\").dataset.savingthrow;\n    this.actor.rollSavingThrow(saveId, { token: this.token });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Filters item by {@link ffd20.config.sheetSections sheet section} config.\n   *\n   * @internal\n   * @param {Item} item - Item to filter\n   * @param {object} section - Section to filter by\n   * @returns {boolean}\n   */\n  _applySectionFilter(item, section) {\n    if (!section.filters) return false;\n    return section.filters.some((filter) => {\n      if (filter.type === item.type) {\n        return filter.subTypes?.includes(item.subType) ?? true;\n      }\n      return false;\n    });\n  }\n\n  /**\n   * Organize and classify Owned Items\n   *\n   * @param data\n   * @private\n   */\n  _prepareItems(data) {\n    // Categorize items as inventory, spellbook, features, and classes\n    const inventory = Object.values(ffd20.config.sheetSections.inventory)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    // Partition items by category\n    const [items, spells, other] = data.items.reduce(\n      (arr, item) => {\n        if (item.type === \"spell\") arr[1].push(item);\n        else if (item.isPhysical) arr[0].push(item);\n        else arr[2].push(item);\n        return arr;\n      },\n      [[], [], []]\n    );\n\n    // Organize Spellbook\n    let hasASF = false;\n    let hasSpellbooks = false;\n    const spellbookSections = {};\n    const spellbooks = data.system.attributes.spells.spellbooks;\n    for (const [bookId, spellbook] of Object.entries(spellbooks)) {\n      // Required for spellbook selection in settings\n      spellbookSections[bookId] = { ...spellbook };\n      // The rest are unnecessary processing if spellbook is not enabled\n      if (!spellbook.inUse) continue;\n      hasSpellbooks = true;\n      const book = spellbookSections[bookId];\n      const spellbookSpells = spells.filter((obj) => obj.spellbook === bookId);\n      book.sections = this._prepareSpellbook(data, spellbookSpells, bookId);\n      book.prepared = spellbookSpells.filter(\n        (obj) => obj.preparation.mode === \"prepared\" && obj.preparation.prepared\n      ).length;\n      book.rollData = data.rollData.spells[bookId];\n      book.classId = spellbook.class;\n      book.class = data.rollData.classes[spellbook.class];\n      if (spellbook.arcaneSpellFailure) hasASF = true;\n    }\n\n    if (hasASF) {\n      // TODO: Make ASF proper change target\n      const asf = this.actor.itemTypes.equipment\n        .filter((item) => item.isActive)\n        .reduce((cur, item) => {\n          const itemASF = item.system.spellFailure || 0;\n          return cur + itemASF;\n        }, 0);\n\n      data.asf = {\n        total: asf,\n      };\n    }\n\n    // Class selection list, only used by spellbooks\n    if (hasSpellbooks) {\n      const lang = game.settings.get(\"core\", \"language\");\n      const allClasses = this.actor.itemTypes.class\n        .map((cls) => [cls.system.tag, cls.name])\n        .sort(([_0, a], [_1, b]) => a.localeCompare(b, lang));\n      allClasses.unshift([\"_hd\", game.i18n.localize(\"FFD20.HitDie\")]);\n      data.classList = Object.fromEntries(allClasses);\n    }\n\n    // Implant capacity\n    const ct = game.settings.get(\"ffd20\", \"cybertech\");\n    // All implanted cybertech applies, even disabled as long as they're implanted\n    const cybertech = this.actor.itemTypes.implant.filter((i) => i.subType === \"cybertech\" && i.system.implanted);\n    if (ct || cybertech.length) {\n      const load = cybertech.reduce((total, item) => total + (item.system.implant || 0), 0);\n      const abilities = this.actor.system.abilities ?? {};\n      data.implants = {\n        load,\n        max: Math.min(abilities.int?.total, abilities.con?.total),\n      };\n    }\n\n    // Organize Inventory\n    for (const i of items) {\n      const section = inventory.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    // Remove implant section if cybertech is disabled and no implants are present\n    if (!ct && this.actor.itemTypes.implant.length === 0) {\n      inventory.findSplice((cat) => cat.id === \"implants\");\n    }\n\n    // Organize Features\n    const featureSections = Object.values(ffd20.config.sheetSections.features)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    for (const i of other) {\n      const ablType = i.abilityType;\n      i.typelabel = ffd20.config.abilityTypes[ablType]?.short || ffd20.config.abilityTypes.na.short;\n\n      const section = featureSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    if (this.actor.itemTypes.feat.length) {\n      const section = featureSections.find((f) => f.path === \"features.feat\");\n      section.issues = {\n        found: data.featCount?.issues > 0,\n        missing: data.featCount?.missing || 0,\n        excess: data.featCount?.excess || 0,\n        get discrepancy() {\n          return Math.abs(this.missing - this.excess);\n        },\n      };\n    }\n\n    // Buffs\n    const buffSections = Object.values(ffd20.config.sheetSections.buffs)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n    for (const i of other) {\n      const section = buffSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    // Attacks\n    let attackSections = Object.values(ffd20.config.sheetSections.combat)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    // TODO: Support weapons in combat tab\n    for (const i of other) {\n      const section = attackSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    // Add secondary references to items in certain sections\n    // Unlike others, these are in addition to the normal locations instead of exclusive\n    // TODO: Refactor this to be controlled by the sections config\n    const cweapons = attackSections.find((c) => c.id === \"weapon\");\n    if (cweapons) cweapons.items = items.filter((i) => i.type === \"weapon\" && i.document.system.showInCombat);\n    const cspells = attackSections.find((c) => c.id === \"spell\");\n    if (cspells) cspells.items = spells.filter((i) => i.document.system.showInCombat);\n    const feats = other.filter((i) => i.type === \"feat\" && i.document.system.showInCombat);\n    const cfeat = attackSections.find((c) => c.id === \"feat\");\n    if (cfeat) cfeat.items = feats.filter((i) => i.subType === \"feat\");\n    const classfeat = attackSections.find((c) => c.id === \"classFeat\");\n    if (classfeat) classfeat.items = feats.filter((i) => i.subType === \"classFeat\");\n    const racefeat = attackSections.find((c) => c.id === \"racial\");\n    if (racefeat) racefeat.items = feats.filter((i) => i.subType === \"racial\");\n    const cequipment = attackSections.find((c) => c.id === \"equipment\");\n    if (cequipment) cequipment.items = items.filter((i) => i.type === \"equipment\" && i.document.system.showInCombat);\n    const cconsumables = attackSections.find((c) => c.id === \"consumable\");\n    if (cconsumables)\n      cconsumables.items = items.filter((i) => i.type === \"consumable\" && i.document.system.showInCombat);\n\n    // Hide empty sections if they're marked to be hidden\n    attackSections = attackSections.filter((i) => !(i.hideEmpty && !(i.items?.length > 0)));\n\n    // Classes\n    const classSections = Object.values(ffd20.config.sheetSections.classes)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    for (const i of other) {\n      const section = classSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    const categories = [\n      { key: \"inventory\", sections: inventory },\n      { key: \"features\", sections: featureSections },\n      { key: \"buffs\", sections: buffSections },\n      { key: \"attacks\", sections: attackSections },\n    ];\n\n    for (const [bookId, sb] of Object.entries(spellbookSections)) {\n      if (!sb.inUse) continue;\n      if (!sb.sections) console.warn(bookId, sb);\n      categories.push({ key: `spellbook-${bookId}`, sections: sb.sections });\n    }\n\n    // Apply section filters\n    for (const cat of categories) {\n      const set = this._filters.sections[cat.key];\n      if (!set) continue;\n\n      for (const section of cat.sections) {\n        if (!section) continue;\n\n        this._filterSection(cat, section, set);\n      }\n    }\n\n    // Assign and return\n    data.inventory = inventory;\n    data.spellbookData = spellbookSections;\n    data.features = featureSections;\n    data.buffs = buffSections;\n    data.attacks = attackSections;\n    data.classes = classSections;\n    data.quickActions = this.actor.getQuickActions();\n  }\n\n  /**\n   * Filter inventory section\n   *\n   * Called in {@link _prepareItems()}\n   *\n   * @internal\n   * @param {object} category - Category data\n   * @param {object} section - Section data\n   * @param {Set<string>} filters - Active filters\n   */\n  _filterSection(category, section, filters) {\n    // Prepare special filters\n    let min = 0;\n    section._preparedOnly = filters.has(\"prepared\");\n    section._hideEmpty = filters.has(\"empty\");\n    if (section._preparedOnly) min += 1;\n    if (section._hideEmpty) min += 1;\n\n    const inFilters = filters.has(section.id);\n\n    section._hidden = filters.size > min && !inFilters;\n\n    // Special handling for prepared filter\n    if (section._preparedOnly) {\n      section.items = section.items.filter((i) => i.maxCharges > 0);\n    }\n    // Hide empty section if filtered for it\n    if (section._hideEmpty && !inFilters && !(section.items?.length > 0)) {\n      section._hidden = true;\n    }\n  }\n\n  /**\n   * Handle rolling a Skill check\n   *\n   * @param {Event} event   The originating click event\n   * @private\n   */\n  _onRollSkillCheck(event) {\n    event.preventDefault();\n    const el = event.target;\n    const skill = el.dataset.skill;\n    const subSkill = el.dataset.subSkill;\n    const skillId = subSkill ? `${skill}.${subSkill}` : skill;\n\n    this.actor.rollSkill(skillId, { token: this.token });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle toggling of filters to display a different set of owned items\n   *\n   * @param {Event} event     The click event which triggered the toggle\n   * @private\n   */\n  _onToggleFilter(event) {\n    event.preventDefault();\n\n    const li = event.currentTarget;\n    const { category, filter } = li.dataset;\n    const set = (this._filters.sections[category] ??= new Set());\n\n    const tabLikeFilters = game.settings.get(\"ffd20\", \"invertSectionFilterShiftBehaviour\")\n      ? !event.shiftKey\n      : event.shiftKey;\n\n    if (tabLikeFilters) {\n      for (const f of Array.from(set)) {\n        if (f !== filter) {\n          set.delete(f);\n        }\n      }\n    }\n\n    if (set.has(filter)) set.delete(filter);\n    else set.add(filter);\n    this.render();\n  }\n\n  _searchFilterCommit(event) {\n    const actor = this.actor;\n    const search = this._filters.search[event.target.dataset.category].toLowerCase();\n    const category = event.target.dataset.category;\n\n    // TODO: Do not refresh if same search term, unless the sheet has updated.\n    if (this.effectiveSearch[category] === search && !this.searchRefresh) return;\n    this.effectiveSearch[category] = search;\n    this.searchRefresh = false;\n\n    const matchSearch = (name) => name.toLowerCase().includes(search); // MKAhvi: Bad method for i18n support.\n\n    $(event.target)\n      .closest(\".tab\")\n      .find(\".item-list .item\")\n      .each(function () {\n        const jq = $(this);\n        if (search?.length > 0) {\n          const item = actor.items.get(this.dataset.itemId);\n          if (matchSearch(item.name)) jq.show();\n          else jq.hide();\n        } else jq.show();\n      });\n  }\n\n  // IME related\n  _searchFilterCompositioning(event) {\n    this.searchCompositioning = event.type === \"compositionstart\";\n  }\n\n  _searchFilterChange(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Accept input only while not compositioning\n\n    const search = event.target.value;\n    const category = event.target.dataset.category;\n    const changed = this._filters.search[category] !== search;\n\n    if (this.searchCompositioning || changed) clearTimeout(this.searchDelayEvent); // reset\n    if (this.searchCompositioning) return;\n\n    //if (unchanged) return; // nothing changed\n    this._filters.search[category] = search;\n\n    if (event.type === \"input\") {\n      // Delay search\n      if (changed) this.searchDelayEvent = setTimeout(() => this._searchFilterCommit(event), this.searchDelay);\n    } else {\n      this._searchFilterCommit(event);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle spawning the ActorTraitSelector application which allows a checkbox of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onTraitSelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const label = a.parentElement.querySelector(\"label\");\n    let choices;\n    if (a.dataset.options in ffd20.registry) {\n      let entries = ffd20.registry[a.dataset.options];\n      if (a.dataset.resist) entries = entries.filter((e) => e.resist);\n      choices = Object.fromEntries(entries.map((e) => [e.id, e.name]));\n    } else {\n      choices = ffd20.config[a.dataset.options];\n    }\n\n    const path = a.dataset.for;\n\n    const options = {\n      name: path,\n      title: label.innerText,\n      subject: a.dataset.options,\n      hasCustom: a.dataset.hasCustom !== \"false\",\n      choices,\n    };\n\n    const app = Object.values(this.actor.apps).find(\n      (app) => app instanceof ActorTraitSelector && app.options.name === options.name\n    );\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else new ActorTraitSelector({ ...options, document: this.actor }).render({ force: true });\n  }\n\n  /**\n   * Handle spawning the ActorResistanceSelector application which allows a number entry of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onResistanceSelector(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const options = {\n      name: a.dataset.for,\n      title: a.innerText,\n      fields: a.dataset.fields,\n      dtypes: a.dataset.dtypes,\n      width: a.dataset.options === \"dr\" ? 575 : 450,\n      isDR: a.dataset.options === \"dr\",\n    };\n\n    const app = Object.values(this.actor.apps).find(\n      (app) => app instanceof DamageResistanceSelector && app.options.name === options.name\n    );\n\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else {\n      new DamageResistanceSelector({ document: this.actor, ...options }).render(true);\n    }\n  }\n\n  setItemUpdate(id, key, value) {\n    let obj = this._itemUpdates.find((o) => o._id === id);\n    if (!obj) {\n      obj = { _id: id };\n      this._itemUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  /** @override */\n  _render(force, options = {}) {\n    ffd20.applications.utils.saveEditState(this, options);\n\n    return super._render(force, options);\n  }\n\n  /** @override */\n  async _renderInner(...args) {\n    const jq = await super._renderInner(...args);\n\n    const html = jq[0];\n\n    // Re-open item summaries\n    for (const expandedId of this._expandedItems) {\n      const [tab, listId, itemId] = expandedId.split(\".\");\n      // Only display summaries of items that are still present\n      let elem;\n      if (this.actor.items.has(itemId)) {\n        let parent = html.querySelector(`.tab[data-tab='${tab}']`);\n        if (listId) parent = parent.querySelector(`.item-list[data-list='${listId}']`);\n        elem = parent?.querySelector(`.item[data-item-id=\"${itemId}\"]`);\n      }\n\n      if (elem) this.openItemSummary(elem, { instant: true });\n      // Delete IDs belonging to items no longer found in the actor\n      else this._expandedItems.delete(expandedId);\n    }\n\n    return jq;\n  }\n\n  async _onSubmit(event, { updateData = null, preventClose = false, preventRender = false } = {}) {\n    event.preventDefault();\n\n    if (this._itemUpdates?.length) preventRender = true;\n\n    await super._onSubmit(event, { updateData, preventClose, preventRender });\n\n    // Update items\n    await this._updateItems();\n  }\n\n  async _updateItems() {\n    const updates = this._itemUpdates;\n    this._itemUpdates = [];\n\n    // Memorize variables in document\n    for (const d of updates) {\n      const item = this.actor.items.get(d._id);\n      if (!item) {\n        console.error(\"Item update for non-existing item:\", d._id, d);\n        continue;\n      }\n      delete d._id;\n      await item.update(d);\n    }\n  }\n\n  async _onDropCurrency(event, data) {\n    const sourceActor = await fromUuid(data.actorUuid || \"\");\n\n    const { currency, amount, containerId, alt } = data;\n\n    return new CurrencyTransfer(\n      { actor: sourceActor, container: containerId, alt },\n      { actor: this.actor, amount: Object.fromEntries([[currency, parseInt(amount)]]) }\n    ).render(true);\n  }\n\n  /**\n   * @override\n   */\n  async _onDropItem(event, data) {\n    if (!this.actor.isOwner) return void ui.notifications.warn(\"FFD20.Error.NoActorPermission\", { localize: true });\n\n    const sourceItem = await Item.implementation.fromDropData(data);\n\n    const sourceActor = await fromUuid(data.actorUuid || \"\");\n    const sameActor = sourceItem.actor === this.actor && !data.containerId;\n\n    const itemData = game.items.fromCompendium(sourceItem, {\n      clearFolder: true,\n      keepId: sameActor,\n      clearSort: !sameActor,\n    });\n\n    // Handle item sorting within the same actor\n    if (sameActor) return this._onSortItem(event, itemData);\n\n    // Make item unidentified if ALT is held\n    // Alt is used for this as it also hides tokens when placed on scene\n    if (sourceItem.isPhysical && game.user.isGM && event.altKey) {\n      if (itemData.system.identified !== false) {\n        console.debug(\"FFD20 | User Input: Alt | Force unidentifying added item:\", itemData.name);\n        itemData.system.identified = false;\n      }\n    }\n\n    // Create the owned item\n    this._alterDropItemData(itemData, sourceItem);\n    const rv = await this._onDropItemCreate(itemData);\n\n    // Remove from container if item was successfully created\n    if (data.containerId && rv?.length && sourceActor === this.actor) {\n      const container = this.actor.allItems.find((o) => o.id === data.containerId);\n      if (container) container.deleteContainerContent(data.itemId);\n    }\n\n    return rv;\n  }\n\n  /**\n   * @internal\n   * @param {object} data - Item data\n   * @param {ffd20.documents.item.ItemPF} source - Source item\n   */\n  _alterDropItemData(data, source) {\n    // Identify source location\n    const fromCompendium = !!source.pack;\n    const fromActor = !!source.parent;\n    const fromItemsDir = !fromCompendium && !fromActor && !!source.id;\n\n    // Certain items for NPC should be unidentified by default\n    if (\n      game.user.isGM && // Only do this as GM\n      !this.actor.hasPlayerOwner && // Only if the target sheet is not owned by player\n      this.actor.type !== \"character\" && // It's an NPC actor\n      source.isPhysical && // Physical item\n      fromCompendium && // From compendium, dragging between actors should be ignored\n      data.system.identified !== false && // Is not already unidentifed\n      // We need to check if the item either have Caster Level beyond 0 or it's a drug or poison\n      (source.system?.cl > 0 || [\"drug\", \"poison\"].includes(source.system.subType))\n    ) {\n      console.debug(\"FFD20 | Force unidentifying magical/drug/poison item:\", data.name);\n      data.system.identified = false;\n    }\n\n    // Set spellbook to currently viewed one\n    if (data.type === \"spell\") {\n      data.system.spellbook = this.currentSpellbookKey;\n    }\n\n    // Apply actor size to physical items, assuming they're appropriately sized for them\n    // But do so only when the drop originates from compendium or items directory\n    if (source.isPhysical) {\n      if (fromCompendium || fromItemsDir) {\n        data.system.size = this.actor.system.traits?.size?.base || \"med\";\n      }\n    }\n  }\n\n  /**\n   * Sort item at the bottom of the list instead of seemingly random position\n   *\n   * @private\n   * @param {ItemPF} item - Temporary item to do sorting on.\n   */\n  _sortNewItem(item) {\n    const type = item.type;\n\n    const isClass = type === \"class\";\n\n    // Get old items of same general category\n    const oldItems = this.actor.itemTypes[type]\n      .filter((oldItem) => (isClass ? true : ffd20.utils.isItemSameSubGroup(item, oldItem)))\n      .sort((a, b) => b.sort - a.sort);\n\n    if (oldItems.length) {\n      item._source.sort = oldItems[0].sort + CONST.SORT_INTEGER_DENSITY;\n    }\n  }\n\n  /**\n   * Adjust item before addition, overriding data\n   *\n   * @internal\n   * @param data\n   * @param {ItemPF} item - Temporary item document before creation\n   */\n  _adjustNewItem(item, data) {\n    item.constructor._adjustNewItem?.(item, data, true);\n  }\n\n  async _onDropItemCreate(itemData) {\n    const itemDatas = itemData instanceof Array ? itemData : [itemData];\n\n    const creationData = [];\n    for (const itemData of itemDatas) {\n      delete itemData._id;\n\n      // Assign associated class if actor has only one class\n      if (itemData.type === \"feat\" && itemData.system?.subType === \"classFeat\") {\n        // Available classes ordered by level\n        const classes = [...this.actor.itemTypes.class].sort((a, b) => (b.system.level || 0) - (a.system.level || 0));\n        if (classes.length === 0) {\n          // Nothing to do\n        }\n        // Only one choice\n        else if (classes.length === 1) {\n          itemData.system.class = classes[0].system.tag;\n        }\n        // Query which class to associate with\n        else {\n          const options = {\n            window: {\n              title: `${game.i18n.format(\"FFD20.SelectSpecific\", {\n                specifier: game.i18n.localize(\"TYPES.Item.class\"),\n              })} - ${itemData.name} - ${this.actor.name}`,\n            },\n            actor: this.actor,\n            empty: true,\n            items: classes,\n            selected: classes[0]?.id, // Default to highest level class\n          };\n\n          // Test if there's more appropriate default class\n          if (classes.length > 1) {\n            const cls = classes.find((cls) => itemData.system?.associations?.classes?.includes(cls.name));\n            if (cls) options.selected = cls.id;\n          }\n\n          const clsId = await ffd20.utils.dialog.getItem(options);\n          if (clsId) {\n            const cls = this.actor.items.get(clsId);\n            itemData.system.class = cls.system.tag;\n          }\n          // TODO: Cancel if dialog was closed or no class was selected?\n        }\n      }\n\n      // Import spell as consumable\n      if (itemData.type === \"spell\" && this.currentPrimaryTab !== \"spellbook\") {\n        const spells = this.actor.system.attributes?.spells?.spellbooks ?? {};\n        const spellType = spells[this.currentSpellbookKey]?.kind || \"arcane\";\n\n        const resultData = await ffd20.documents.item.ItemSpellPF.toConsumablePrompt(itemData, {\n          spellType,\n          actor: this.actor,\n          allowSpell: Object.values(spells).some((s) => s.inUse),\n        });\n\n        if (resultData) {\n          creationData.push(resultData);\n          continue;\n        } else if (resultData === null) continue;\n        // else continue with regular spell creation\n      }\n\n      const newItem = new Item.implementation(itemData, { parent: this.actor });\n      this._sortNewItem(newItem);\n      this._adjustNewItem(newItem, itemData);\n\n      // Choose how to import class\n      if (itemData.type === \"class\") {\n        if (!(event && event.shiftKey)) {\n          // Set new class to be always level 1\n          newItem.updateSource({ system: { level: 1 } });\n\n          const cls = await LevelUpForm.addClassWizard(this.actor, newItem.toObject(), { token: this.token });\n          if (cls && itemDatas.length === 1) this._focusTabByItem(cls);\n          continue;\n        }\n      }\n\n      creationData.push(newItem.toObject());\n    }\n\n    if (creationData.length === 1) this._focusTabByItem(creationData[0]);\n\n    return this.actor.createEmbeddedDocuments(\"Item\", creationData);\n  }\n\n  /**\n   * Focuses certain tab based on provided item.\n   *\n   * @internal\n   * @param {*} item\n   */\n  _focusTabByItem(item) {\n    let tabId;\n    switch (item.type) {\n      case \"race\":\n      case \"class\":\n        tabId = \"summary\";\n        break;\n      case \"spell\":\n        tabId = \"spellbook\";\n        break;\n      case \"buff\":\n        tabId = \"buffs\";\n        break;\n      case \"feat\":\n        tabId = \"feats\";\n        break;\n      case \"weapon\":\n      case \"equipment\":\n      case \"consumable\":\n      case \"loot\":\n      case \"container\":\n        tabId = \"inventory\";\n        break;\n      case \"attack\":\n        tabId = \"combat\";\n        break;\n    }\n\n    if (tabId) this.activateTab(tabId, \"primary\");\n  }\n\n  /**\n   * Allow drag start always.\n   * Foundry blocks this if sheet is not editable, which blocks copying items.\n   *\n   * @override\n   * @param {string} selector Selector string\n   */\n  _canDragStart(selector) {\n    // Conditionally block currency transfer\n    if (selector.includes(\".denomination\")) return this.isEditable;\n    return true;\n  }\n\n  _onDragStart(event) {\n    const elem = event.target;\n    if (elem.classList.contains(\"denomination\")) {\n      const isAlt = elem.classList.contains(\"alt-currency\");\n      const denomination = elem.dataset.denomination;\n      const currency = isAlt ? this.actor.system.altCurrency : this.actor.system.currency;\n      const dragData = {\n        actorUuid: this.actor.uuid,\n        type: \"Currency\",\n        alt: isAlt,\n        currency: denomination,\n        amount: currency[denomination],\n      };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n    } else if (elem.dataset?.skill) {\n      this._onDragSkillStart(event);\n    } else if (elem.dataset?.attribute) {\n      this._onDragMiscStart(event, elem.dataset.attribute);\n    } else if (elem.dataset?.drag) {\n      this._onDragMiscStart(event, elem.dataset.drag);\n    } else if (elem.dataset?.savingthrow) {\n      this._onDragSaveStart(event, elem.dataset.savingthrow);\n    } else if (elem.dataset?.ability) {\n      this._onDragMiscStart(event, \"abilityScore\", elem.dataset.ability);\n    } else if (elem.dataset?.attack) {\n      this._onDragMiscStart(event, \"attack\", elem.dataset.attack);\n    } else {\n      super._onDragStart(event);\n    }\n  }\n\n  _selectOnClick(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    el.select();\n  }\n\n  _updateObject(event, formData) {\n    this.searchRefresh = true;\n\n    return super._updateObject(event, formData);\n  }\n\n  calculateTotalItemValue({ inLowestDenomination = false, recursive = false } = {}) {\n    const items = this.actor.items.filter((item) => item.isPhysical && item.system.price != null);\n    const total = items.reduce((cur, i) => {\n      return cur + i.getValue({ recursive, sellValue: 1, inLowestDenomination: true });\n    }, 0);\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  calculateSellItemValue({ inLowestDenomination = false, recursive = false } = {}) {\n    const items = this.actor.items.filter((o) => o.system.price != null);\n    const sellMultiplier = this.actor.getFlag(\"ffd20\", \"sellMultiplier\") || 0.5;\n    const total = items.reduce((cur, i) => {\n      return cur + i.getValue({ recursive, sellValue: sellMultiplier, inLowestDenomination: true });\n    }, 0);\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  /**\n   * @override\n   * @param {HTMLElement} form\n   */\n  _disableFields(form) {\n    super._disableFields(form);\n\n    // Ensure search inputs are always functional\n    for (const el of form.getElementsByTagName(\"INPUT\")) {\n      if (el.type === \"search\") el.disabled = false;\n    }\n  }\n}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\n\n/**\n * An Actor sheet for player character type actors in the PF system.\n * Extends the base ActorSheetPF class.\n *\n * @type {ActorSheetPF}\n */\nexport class ActorSheetPFCharacter extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return { ...options, classes: [...options.classes, \"character\"], width: 800, height: 840 };\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/character-sheet.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   */\n  async getData() {\n    const context = await super.getData();\n    const xpSettings = game.settings.get(\"ffd20\", \"experienceConfig\");\n\n    // Experience Tracking\n    context.disableExperience = xpSettings.disable;\n    context.showXpBar = !xpSettings.disable;\n    if (!xpSettings.disable) {\n      context.minimumExperience = this.actor.getLevelExp(\n        Math.max(0, (this.actor.system.details.level.value ?? 0) - 1),\n        {\n          rollData: context.rollData,\n        }\n      );\n    }\n\n    context.hasClasses = this.actor.itemTypes.class.length > 0;\n\n    // Add level up buttons to classes\n    if (xpSettings.disable !== true && context.hasClasses) {\n      const xp = this.actor.system.details?.xp;\n      if (xp && xp.value >= xp.max) {\n        context.levelUp = true;\n\n        // Max level check\n        const xpTrack = xpSettings.track;\n        if ([\"fast\", \"medium\", \"slow\"].includes(xpTrack)) {\n          const level = this.actor.system.details.level.value;\n          const levels = ffd20.config.CHARACTER_EXP_LEVELS[xpTrack];\n          if (level >= levels.length) {\n            context.levelUp = false;\n          }\n        }\n      }\n    } else {\n      context.levelUp = true;\n    }\n\n    // Return data for rendering\n    return context;\n  }\n}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\n\n/**\n * An Actor sheet for NPC type characters in the game system.\n * Extends the base ActorSheetPF class.\n *\n * @type {ActorSheetPF}\n */\nexport class ActorSheetPFNPC extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return { ...options, classes: [...options.classes, \"npc\"], width: 800, height: 840 };\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/npc-sheet.hbs\";\n  }\n\n  // static get name() {\n  //   return game.i18n.localize(\"FFD20.ActorSheetPFNPC\");\n  // }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   */\n  async getData() {\n    const data = await super.getData();\n\n    // Challenge Rating\n    data.labels.cr = ffd20.utils.CR.fromNumber(this.actor.system.details?.cr?.total ?? 0);\n\n    data.levelUp = true;\n\n    return data;\n  }\n\n  /* -------------------------------------------- */\n  /*  Object Updates                              */\n  /* -------------------------------------------- */\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param html {HTML}   The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Adjust CR\n    html.find(\"span.text-box.cr-input\").on(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustCR.bind(this));\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  async _adjustCR(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const value = ffd20.utils.CR.fromString(el.tagName === \"INPUT\" ? el.value : el.innerText);\n    const name = el.getAttribute(\"name\");\n    let updateData;\n    if (name) {\n      updateData = { [name]: value };\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", async (ev) => this._updateObject(event, this._getSubmitData(updateData)), {\n        //passive: true, // Causes Foundry to error\n        once: true,\n      });\n    } else {\n      this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n}\n","import { ActorSheetPFNPC } from \"./npc-sheet.mjs\";\n\nexport class ActorSheetPFNPCLite extends ActorSheetPFNPC {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"lite\"],\n      width: 440,\n      height: 640,\n      tabs: [\n        { navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"summary\", group: \"primary\" },\n      ],\n    };\n  }\n\n  get template() {\n    if (!game.user.isGM && this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/npc-sheet-lite.hbs\";\n  }\n\n  async getData() {\n    const context = await super.getData();\n    context.hasHD = false;\n    return context;\n  }\n\n  _prepareItems(data) {\n    const attackSections = Object.values(ffd20.config.sheetSections.combatlite)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n    for (const i of data.items) {\n      const section = attackSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      } else {\n        console.warn(\"Could not find a sheet section for\", i.name);\n      }\n    }\n\n    data.attacks = attackSections;\n  }\n}\n","import { ActorSheetPFNPC } from \"./npc-sheet.mjs\";\n\nexport class ActorSheetPFNPCLoot extends ActorSheetPFNPC {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object}\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"loot\"],\n      tabs: [\n        { navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"inventory\", group: \"primary\" },\n      ],\n      width: 620,\n      height: 420,\n    };\n  }\n\n  get template() {\n    return \"systems/ffd20/templates/actors/npc-sheet-loot.hbs\";\n  }\n\n  get currentPrimaryTab() {\n    return \"inventory\";\n  }\n\n  /** @type {CoinType} */\n  get itemValueDenomination() {\n    return \"gp\";\n  }\n\n  async getData() {\n    const data = await super.getData();\n\n    data.isLootSheet = true;\n    data.sellMultiplier = this.actor.getFlag(\"ffd20\", \"sellMultiplier\");\n\n    const baseCurrency = this.actor.getTotalCurrency({ inLowestDenomination: true });\n\n    // Get total value\n    const cpValue = this.calculateTotalItemValue({ inLowestDenomination: true, recursive: true }) + baseCurrency;\n    const cpSellValue = this.calculateSellItemValue({ inLowestDenomination: true, recursive: true }) + baseCurrency;\n\n    data.totalValue = ffd20.utils.currency.split(cpValue, { pad: true });\n    data.sellValue = ffd20.utils.currency.split(cpSellValue, { pad: true });\n\n    // Set labels\n    if (!data.labels) data.labels = {};\n    data.labels.totalValue = game.i18n.format(\"FFD20.Containers.TotalValue\", data.totalValue);\n    data.labels.sellValue = game.i18n.format(\"FFD20.Containers.SellValue\", data.sellValue);\n\n    // Alter inventory columns\n    for (const section of data.inventory) {\n      section.interface = { ...section.interface, value: true, actions: false, noEquip: true };\n    }\n\n    data.labels.currency = `FFD20.Currency.Inline.${this.itemValueDenomination}`;\n\n    return data;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  _prepareItem(item) {\n    const result = super._prepareItem(item);\n\n    if (item.isPhysical) {\n      result.price = item.getValue({ recursive: false, sellValue: 1, inLowestDenomination: true }) / 100;\n    }\n\n    return result;\n  }\n}\n","import { ActorSheetPFNPC } from \"./npc-sheet.mjs\";\n\n/**\n * An Actor sheet for Vehicle type characters in the game system.\n * Extends the base ActorSheetPF class.\n */\nexport class ActorSheetPFHaunt extends ActorSheetPFNPC {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object} The default rendering options\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"haunt\"],\n      width: 880,\n      height: 700,\n      tabs: [{ navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"summary\" }],\n      scrollY: [\".tab.summary\"],\n    };\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/haunt-sheet.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  static EDIT_TRACKING = [\"system.details.notes\", \"system.details.effect\", \"system.details.destruction\"];\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   *\n   * @returns {Promise<object>} The data object to render the sheet\n   */\n  async getData() {\n    const isOwner = this.document.isOwner;\n    const context = {\n      owner: isOwner,\n      limited: this.document.limited,\n      editable: this.isEditable,\n      cssClass: isOwner ? \"editable\" : \"locked\",\n      config: ffd20.config,\n      isGM: game.user.isGM,\n      system: this.actor.system,\n      measureTemplateTypes: ffd20.utils.internal.getTemplateTypes(),\n      hasHD: false,\n      fields: this.actor.system.schema.fields,\n      units: game.i18n.localize(\n        ffd20.utils.getDistanceSystem() === \"imperial\" ? \"FFD20.Distance.ftShort\" : \"FFD20.Distance.mShort\"\n      ),\n    };\n\n    const rollData = this.actor.getRollData();\n    context.rollData = rollData;\n\n    // Labels\n    context.labels = {\n      cr: ffd20.utils.CR.fromNumber(context.system.details.cr.total),\n      alignment: context.config.alignments[context.system.details.alignment],\n    };\n\n    const auraStrength = context.rollData.auraStrength;\n    if (auraStrength) {\n      context.labels.auraStrength = ffd20.config.auraStrengths[auraStrength];\n    }\n\n    // Enrich description and notes\n    const enrichHTMLOptions = {\n      secrets: isOwner,\n      rollData: context.rollData,\n      relativeTo: this.actor,\n    };\n\n    const noDesc = \"<p class='placeholder'>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n\n    const destruction = context.system.details?.destruction;\n    const pDestruction = destruction ? ffd20.utils.enrichHTMLUnrolled(destruction, enrichHTMLOptions) : Promise.resolve();\n    pDestruction.then((html) => (context.destructionHTML = html || noDesc));\n    const effect = context.system.details?.effect;\n    const pEffect = effect ? ffd20.utils.enrichHTMLUnrolled(effect, enrichHTMLOptions) : Promise.resolve();\n    pEffect.then((html) => (context.effectHTML = html || noDesc));\n    const notes = context.system.details?.notes;\n    const pNotes = notes ? ffd20.utils.enrichHTMLUnrolled(notes, enrichHTMLOptions) : Promise.resolve();\n    pNotes.then((html) => (context.notesHTML = html));\n    await Promise.all([pDestruction, pEffect, pNotes]);\n\n    // The Actor and its Items\n    context.actor = this.actor;\n    context.token = this.token;\n    context.items = this.document.items\n      .map((item) => this._prepareItem(item))\n      .sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    // Prepare owned items\n    this._prepareItems(context);\n\n    // Prepare Templates\n    const trait = context.system.templates;\n    const values = trait.total;\n\n    const pTemplates = values.reduce((arr, t) => {\n      arr.push(\n        context.config.hauntTemplates[t]\n          ? TextEditor.enrichHTML(`@UUID[${context.config.hauntTemplates[t].uuid}]`)\n          : TextEditor.enrichHTML(`@UUID[${t}]{${t}}`)\n      );\n      return arr;\n    }, []);\n    const templateLinks = await Promise.all(pTemplates);\n    trait.selected = await values.reduce((obj, t, index) => {\n      const link = templateLinks[index];\n      obj[t] = {\n        name: context.config.hauntTemplateLabels[t] || t,\n        link,\n        broken: link === t,\n      };\n\n      return obj;\n    }, {});\n\n    context._editorState = ffd20.applications.utils.restoreEditState(this, context);\n\n    return context;\n  }\n\n  /**\n   * @protected\n   * @param {string} fullId - Target ID\n   * @param {object} context - Context object to store data into\n   * @throws {Error} - If provided ID is invalid.\n   * @override\n   * @returns {Promise<void>}\n   */\n  async _getTooltipContext(fullId, context) {\n    const actor = this.actor;\n\n    // Lazy roll data\n    const lazy = {\n      get rollData() {\n        this._cache ??= actor.getRollData();\n        return this._cache;\n      },\n    };\n\n    let header, subHeader;\n    const details = [];\n    const paths = [];\n    const sources = [];\n    let notes;\n\n    const re = /^(?<id>[\\w-]+)(?:\\.(?<detail>.*))?$/.exec(fullId);\n    const { id } = re?.groups ?? {};\n\n    switch (id) {\n      case \"cl\":\n        paths.push({ path: \"@details.cl\", value: lazy.rollData.details.cl }, { path: \"@cl\", value: lazy.rollData.cl });\n        break;\n      case \"health\":\n        paths.push(\n          { path: \"@attributes.hp.value\", value: lazy.rollData.attributes.hp.value },\n          { path: \"@attributes.hp.max\", value: lazy.rollData.attributes.hp.max }\n        );\n        break;\n      default:\n        return super._getTooltipContext(fullId, context);\n    }\n\n    context.header = header;\n    context.subHeader = subHeader;\n    context.details = details;\n    context.paths = paths;\n    context.sources = sources;\n    context.notes = notes ?? [];\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  /**\n   * Organize and classify Owned Items - We just need attacks\n   *\n   * @param {object} context - The data object to render the sheet\n   * @private\n   * @override\n   * @returns {void}\n   */\n  _prepareItems(context) {\n    const attacks = context.items.filter((i) => i.type === \"attack\");\n\n    const attackSections = Object.values(ffd20.config.sheetSections.combatlite)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n    for (const i of attacks) {\n      const section = attackSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      } else {\n        console.warn(\"Could not find a sheet section for\", i.name);\n      }\n    }\n\n    context.attacks = attackSections;\n  }\n\n  _updateObject(event, formData) {\n    formData = foundry.utils.expandObject(formData);\n\n    // Convert distances back to backend imperial format\n    const value = formData.system.details.area?.size;\n    if (Number.isFinite(value)) {\n      formData.system.details.area.size = ffd20.utils.convertDistanceBack(value)[0];\n    }\n\n    return super._updateObject(event, formData);\n  }\n}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\n\n/**\n * An Actor sheet for Vehicle type characters in the game system.\n * Extends the base ActorSheetPF class.\n *\n * @type {ActorSheetPF}\n */\nexport class ActorSheetPFTrap extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object} The default rendering options\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"trap\"],\n      width: 600,\n      height: 700,\n      tabs: [{ navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"summary\" }],\n      scrollY: [\".tab.summary\"],\n    };\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/trap-sheet.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  static EDIT_TRACKING = [\"system.notes\", \"system.effect\"];\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   *\n   * @override\n   * @returns {Promise<object>} The data object to render the sheet with\n   */\n  async getData() {\n    const isOwner = this.document.isOwner;\n    const context = {\n      owner: isOwner,\n      system: this.actor.system,\n      limited: this.document.limited,\n      editable: this.isEditable,\n      cssClass: isOwner ? \"editable\" : \"locked\",\n      config: ffd20.config,\n      isGM: game.user.isGM,\n      hasHD: false,\n      fields: this.actor.system.schema.fields,\n      rollData: this.actor.getRollData(),\n      perception: this.actor.getPerceptionModifier(),\n    };\n\n    // Trigger Types\n    if (!(context.system.type in ffd20.config.traps.types)) {\n      context.trapTypes = foundry.utils.mergeObject(\n        { [`${context.system.type}`]: context.system.type },\n        ffd20.config.traps.types\n      );\n    } else {\n      context.trapTypes = ffd20.config.traps.types;\n    }\n\n    // Challenge Rating\n    context.labels = {\n      cr: ffd20.utils.CR.fromNumber(context.system.cr.total),\n    };\n\n    // Trigger info\n    if ([\"proximity\", \"visual\", \"timed\"].includes(context.system.trigger.type)) {\n      context.hasTriggerRange = true;\n\n      if (context.system.trigger.type === \"timed\") context.hasTriggerTime = true;\n    }\n    context.hasPerceptionTrigger = [\"electricEyes\", \"genetic\", \"sound\", \"visual\"].includes(context.system.trigger.type);\n\n    // Enrich effects and notes\n    const enrichHTMLOptions = {\n      secrets: isOwner,\n      rollData: context.rollData,\n      relativeTo: this.actor,\n    };\n\n    const noDesc = \"<p class='placeholder'>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n\n    const effect = context.system.effect;\n    const pEffect = effect ? ffd20.utils.enrichHTMLUnrolled(effect, enrichHTMLOptions) : Promise.resolve();\n    pEffect.then((html) => (context.effectHTML = html || noDesc));\n    const notes = context.system.notes;\n    const pNotes = notes ? ffd20.utils.enrichHTMLUnrolled(notes, enrichHTMLOptions) : Promise.resolve();\n    pNotes.then((html) => (context.notesHTML = html));\n    await Promise.all([pEffect, pNotes]);\n\n    // The Actor and its Items\n    context.actor = this.actor;\n    context.token = this.token;\n    context.items = this.document.items\n      .map((item) => this._prepareItem(item))\n      .sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    // Prepare owned items\n    this._prepareItems(context);\n\n    context._editorState = ffd20.applications.utils.restoreEditState(this, context);\n\n    return context;\n  }\n\n  /**\n   * @protected\n   * @param {string} fullId - Target ID\n   * @param {object} context - Context object to store data into\n   * @throws {Error} - If provided ID is invalid.\n   * @override\n   * @returns {Promise<void>}\n   */\n  async _getTooltipContext(fullId, context) {\n    /** @type {ffd20.documents.actor.ActorTrapPF} */\n    const actor = this.actor;\n\n    // Lazy roll data\n    const lazy = {\n      get rollData() {\n        this._cache ??= actor.getRollData();\n        return this._cache;\n      },\n    };\n\n    let header, subHeader;\n    const details = [];\n    const paths = [];\n    const sources = [];\n    let notes;\n\n    const re = /^(?<id>[\\w-]+)(?:\\.(?<detail>.*))?$/.exec(fullId);\n    const { id } = re?.groups ?? {};\n\n    switch (id) {\n      case \"detect\":\n        paths.push({ path: \"@perception\", value: lazy.rollData.perception });\n        break;\n      case \"disarm\":\n        paths.push({ path: \"@disarm\", value: lazy.rollData.disarm });\n        break;\n      default:\n        return super._getTooltipContext(fullId, context);\n    }\n\n    context.header = header;\n    context.subHeader = subHeader;\n    context.details = details;\n    context.paths = paths;\n    context.sources = sources;\n    context.notes = notes ?? [];\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param {JQuery<HTMLElement>} jq   The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(jq) {\n    super.activateListeners(jq);\n\n    /** @type {Document} */\n    const html = jq[0];\n\n    // Adjust CR\n    html.querySelector(\"span.cr-input\")?.addEventListener(\"click\", (event) => {\n      this._onSpanTextInput(event, this._adjustCR.bind(this));\n    });\n\n    html.querySelector(\".trigger .rollable[data-dtype='per']\")?.addEventListener(\"click\", (ev) => {\n      ev.preventDefault();\n\n      this.actor.rollPerception({ token: this.token });\n    });\n\n    html.querySelectorAll(\"input[name='system.trigger.value'], input[name='system.reset.value']\").forEach((el) => {\n      el.addEventListener(\"click\", (ev) => {\n        ev.target.select();\n      });\n    });\n  }\n\n  /**\n   * Adjust the CR of the trap\n   *\n   * @param {Event} event   The originating click event\n   */\n  async _adjustCR(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const value = ffd20.utils.CR.fromString(el.tagName === \"INPUT\" ? el.value : el.innerText);\n    const name = el.getAttribute(\"name\");\n    let updateData;\n    if (name) {\n      updateData = { [name]: value };\n    }\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", async (ev) => this._updateObject(event, this._getSubmitData(updateData)), {\n        //passive: true, // Causes Foundry to error\n        once: true,\n      });\n    } else {\n      this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n\n  /**\n   * Organize and classify Owned Items - We just need attacks\n   *\n   * @param {object} context The rendering context\n   * @private\n   * @override\n   */\n  _prepareItems(context) {\n    const attacks = context.items.filter((i) => i.type === \"attack\");\n\n    const attackSections = Object.values(ffd20.config.sheetSections.combatlite)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n    for (const i of attacks) {\n      const section = attackSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      } else {\n        console.warn(\"Could not find a sheet section for\", i.name);\n      }\n    }\n\n    context.attacks = attackSections;\n  }\n\n  _updateObject(event, formData) {\n    formData = foundry.utils.expandObject(formData);\n\n    // Convert distances back to backend imperial format\n    if (formData.system.trigger.value && [\"proximity\", \"visual\"].includes(this.actor.system.trigger.type)) {\n      const value = formData.system.trigger.value;\n      if (Number.isFinite(value)) {\n        formData.system.trigger.value = ffd20.utils.convertDistanceBack(value)[0];\n      }\n    }\n\n    return super._updateObject(event, formData);\n  }\n}\n","import { ActorSheetPF } from \"./actor-sheet.mjs\";\n\n/**\n * An Actor sheet for Vehicle type characters in the game system.\n * Extends the base ActorSheetPF class.\n */\nexport class ActorSheetPFVehicle extends ActorSheetPF {\n  /**\n   * Define default rendering options for the NPC sheet\n   *\n   * @returns {object} The default rendering options\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      classes: [...options.classes, \"vehicle\"],\n      width: 800,\n      height: 680,\n      tabs: [{ navSelector: \"nav.tabs\", contentSelector: \"section.primary-body\", initial: \"summary\" }],\n      scrollY: [\".tab.summary\"],\n    };\n  }\n\n  /* -------------------------------------------- */\n  /*  Rendering                                   */\n  /* -------------------------------------------- */\n\n  /**\n   * Get the correct HTML template path to use for rendering this particular sheet\n   *\n   * @type {string}\n   */\n  get template() {\n    if (this.actor.limited) return \"systems/ffd20/templates/actors/limited-sheet.hbs\";\n    return \"systems/ffd20/templates/actors/vehicle-sheet.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  static EDIT_TRACKING = [\"system.details.description\", \"system.details.notes\"];\n\n  /**\n   * Add some extra data when rendering the sheet to reduce the amount of logic required within the template.\n   *\n   * @override\n   * @returns {Promise<object>} The data object to render the sheet with\n   */\n  async getData() {\n    const isOwner = this.document.isOwner;\n    const context = {\n      owner: isOwner,\n      appId: this.appId,\n      system: this.actor.system,\n      limited: this.document.limited,\n      editable: this.isEditable,\n      cssClass: isOwner ? \"editable\" : \"locked\",\n      config: ffd20.config,\n      isGM: game.user.isGM,\n      labels: {\n        currency: `FFD20.Currency.Inline.${this.itemValueDenomination}`,\n      },\n      isLootSheet: true, // inventory include unwanted data otherwise,\n      fields: this.actor.system.schema.fields,\n    };\n\n    context.vehicleSizes = Object.fromEntries(\n      Object.entries(ffd20.config.vehicles.size).map(([key, data]) => [key, data.label])\n    );\n\n    // Enrich descriptions\n    const enrichHTMLOptions = {\n      secrets: isOwner,\n      rollData: context.rollData,\n      relativeTo: this.actor,\n    };\n\n    const noDesc = \"<p>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n\n    const desc = context.system.details?.description;\n    const pDesc = desc ? ffd20.utils.enrichHTMLUnrolled(desc, enrichHTMLOptions) : Promise.resolve();\n    pDesc.then((html) => (context.descriptionHTML = html || noDesc));\n    const notes = context.system.details?.notes;\n    const pNotes = notes ? ffd20.utils.enrichHTMLUnrolled(notes, enrichHTMLOptions) : Promise.resolve();\n    pNotes.then((html) => (context.notesHTML = html));\n    await Promise.all([pDesc, pNotes]);\n\n    // The Actor and its Items\n    context.actor = this.actor;\n    context.token = this.token;\n    context.items = this.document.items\n      .map((item) => this._prepareItem(item))\n      .sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    // Prepare owned items\n    this._prepareItems(context);\n\n    //context.sellMultiplier = this.actor.getFlag(\"ffd20\", \"sellMultiplier\");\n\n    const baseCurrency = this.actor.getTotalCurrency({ inLowestDenomination: true });\n    context.hasCurrency = true; // Never fade currency field for this\n\n    // Get total value\n    const cpValue = this.calculateTotalItemValue({ inLowestDenomination: true, recursive: true }) + baseCurrency;\n    const cpSellValue = this.calculateSellItemValue({ inLowestDenomination: true, recursive: true }) + baseCurrency;\n\n    context.totalValue = ffd20.utils.currency.split(cpValue, { pad: true });\n    context.sellValue = ffd20.utils.currency.split(cpSellValue, { pad: true });\n    context.labels.totalValue = game.i18n.format(\"FFD20.Containers.TotalValue\", context.totalValue);\n    context.labels.sellValue = game.i18n.format(\"FFD20.Containers.SellValue\", context.sellValue);\n\n    // Compute encumbrance\n    context.encumbrance = this._computeEncumbrance();\n\n    // Compute Driver data\n    context.driver = this._computeDriverData(context.system.driver.uuid, context.system.driver.skill);\n    context.driver.driverSkill = context.system.driver.skill;\n    if (!context.driver.uuid) {\n      context.driver.skills = ffd20.utils.deepClone(context.config.skills);\n      if (context.driver.driverSkill && !context.driver.skills[context.driver.driverSkill]) {\n        context.driver.skills[context.driver.driverSkill] = context.driver.driverSkill;\n      }\n      context.driver.skillBonus = 0;\n    }\n\n    context._editorState = ffd20.applications.utils.restoreEditState(this, context);\n\n    return context;\n  }\n\n  /**\n   * @protected\n   * @param {string} fullId - Target ID\n   * @param {object} context - Context object to store data into\n   * @throws {Error} - If provided ID is invalid.\n   * @override\n   * @returns {Promise<void>}\n   */\n  async _getTooltipContext(fullId, context) {\n    /** @type {ActorPF} */\n    const actor = this.actor,\n      system = actor.system;\n\n    // Lazy roll data\n    const lazy = {\n      get rollData() {\n        this._cache ??= actor.getRollData();\n        return this._cache;\n      },\n    };\n\n    const getNotes = async (context, all = true) =>\n      (await actor.getContextNotesParsed(context, { all, rollData: lazy.rollData, roll: false })).map((n) => n.text);\n\n    let header, subHeader;\n    const details = [];\n    const paths = [];\n    const sources = [];\n    let notes;\n\n    const re = /^(?<id>[\\w-]+)(?:\\.(?<detail>.*))?$/.exec(fullId);\n    const { id, detail } = re?.groups ?? {};\n\n    switch (id) {\n      case \"hp\": {\n        paths.push(\n          { path: \"@attributes.hp.max\", value: lazy.rollData.attributes.hp.max },\n          { path: \"@attributes.hp.base\", value: lazy.rollData.attributes.hp.base || 0 },\n          { path: \"@attributes.hp.value\", value: lazy.rollData.attributes.hp.value },\n          { path: \"@attributes.hp.bonus\", value: lazy.rollData.attributes.hp.bonus }\n        );\n\n        sources.push({ sources: actor.getSourceDetails(\"system.attributes.hp.max\"), untyped: true });\n        break;\n      }\n      case \"ac\": {\n        if (!system.attributes.ac[detail]) return;\n\n        paths.push(\n          { path: \"@attributes.ac.normal.total\", value: lazy.rollData.attributes.ac.normal.total },\n          { path: \"@attributes.ac.touch.total\", value: lazy.rollData.attributes.ac.touch.total }\n        );\n        if (lazy.rollData.traits.type === \"sea\") {\n          paths.push({ path: \"@attributes.ac.stopped.total\", value: lazy.rollData.attributes.ac.stopped.total });\n        }\n\n        sources.push({\n          sources: actor.getSourceDetails(`system.attributes.ac.${detail}.total`),\n          untyped: true,\n        });\n\n        notes = await getNotes(\"ac\");\n        break;\n      }\n      case \"cmb\": {\n        paths.push({\n          path: \"@attributes.cmb.total\",\n          value: system.attributes.cmb.total,\n        });\n\n        sources.push({\n          sources: [\n            {\n              name: game.i18n.localize(\"FFD20.Size\"),\n              value: Object.values(ffd20.config.sizeSpecialMods)[system.traits.size.value],\n            },\n          ],\n        });\n\n        sources.push(\n          { sources: actor.getSourceDetails(\"system.attributes.attack.general\") },\n          { sources: actor.getSourceDetails(\"system.attributes.cmb.bonus\") },\n          { sources: actor.getSourceDetails(\"system.attributes.attack.shared\") }\n        );\n\n        notes = [...(await getNotes(\"attack\")), ...(await getNotes(\"melee\")), ...(await getNotes(\"cmb\"))];\n        break;\n      }\n      case \"material\": {\n        paths.push({ path: \"@material.base\", value: system.material.base });\n        break;\n      }\n      case \"hardness\": {\n        paths.push(\n          { path: \"@attributes.hardness.total\", value: lazy.rollData.attributes.hardness.total },\n          { path: \"@attributes.hardness.base\", value: system.attributes.hardness.base },\n          { path: \"@attributes.hardness.bonus\", value: lazy.rollData.attributes.hardness.bonus }\n        );\n\n        sources.push({ sources: actor.getSourceDetails(\"system.attributes.hardness.total\"), untyped: true });\n        break;\n      }\n      case \"save\": {\n        if (!system.attributes.savingThrows.save) return;\n\n        paths.push(\n          {\n            path: `@attributes.savingThrows.save.total`,\n            value: lazy.rollData.attributes.savingThrows.save.total,\n          },\n          {\n            path: `@attributes.savingThrows.save.base`,\n            value: lazy.rollData.attributes.savingThrows.save.base,\n          }\n        );\n\n        sources.push({\n          sources: actor.getSourceDetails(`system.attributes.savingThrows.save.total`),\n          untyped: true,\n        });\n\n        notes = await getNotes(\"savingThrows\");\n        break;\n      }\n      case \"acceleration\": {\n        sources.push({ sources: actor.getSourceDetails(`system.details.acceleration`) });\n\n        // Add base speed\n        const speed = system.details.acceleration;\n        const [tD] = ffd20.utils.convertDistance(speed);\n\n        const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n        const tU = isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n        paths.push({ path: `@details.acceleration`, value: tD, unit: tU });\n\n        break;\n      }\n      case \"currentSpeed\": {\n        sources.push({ sources: actor.getSourceDetails(`system.details.currentSpeed`) });\n\n        // Add current speed\n        const speed = system.details.currentSpeed;\n        const speedOverland = system.details.currentSpeedOverland;\n        const [tD] = ffd20.utils.convertDistance(speed);\n\n        const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n        const tU = isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n        paths.push({ path: `@details.currentSpeed`, value: tD, unit: tU });\n\n        // Add overland speed\n        const [oD] = ffd20.utils.convertDistance(speedOverland.speed);\n        const oU = isMetricDist ? ffd20.config.measureUnitsShort.km : ffd20.config.measureUnitsShort.mi;\n        paths.push({ path: `@details.currentSpeedOverland`, value: oD, unit: oU });\n\n        break;\n      }\n      case \"maxSpeed\": {\n        sources.push({ sources: actor.getSourceDetails(`system.details.maxSpeed`) });\n\n        // Add base speed\n        const speed = system.details.maxSpeed;\n        const speedOverland = system.details.maxSpeedOverland;\n        const [tD] = ffd20.utils.convertDistance(speed);\n\n        const isMetricDist = ffd20.utils.getDistanceSystem() === \"metric\";\n        const tU = isMetricDist ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n        paths.push({ path: `@details.maxSpeed`, value: tD, unit: tU });\n\n        // Add overland speed\n        const [oD] = ffd20.utils.convertDistance(speedOverland.speed);\n        const oU = isMetricDist ? ffd20.config.measureUnitsShort.km : ffd20.config.measureUnitsShort.mi;\n        paths.push({ path: `@details.maxSpeedOverland`, value: oD, unit: oU });\n\n        break;\n      }\n      default:\n        return super._getTooltipContext(fullId, context);\n    }\n\n    context.header = header;\n    context.subHeader = subHeader;\n    context.details = details;\n    context.paths = paths;\n    context.sources = sources;\n    context.notes = notes ?? [];\n  }\n\n  /* -------------------------------------------- */\n  /*  Event Listeners and Handlers                */\n  /* -------------------------------------------- */\n\n  /**\n   * Activate event listeners using the prepared sheet HTML\n   *\n   * @param {JQuery} jq The prepared HTML object ready to be rendered into the DOM\n   */\n  activateListeners(jq) {\n    super.activateListeners(jq);\n\n    const html = jq[0];\n\n    // Saving Throw\n    html\n      .querySelector(\".defenses .rollable[data-dtype='saving-throws']\")\n      .addEventListener(\"click\", this._onRollSavingThrow.bind(this));\n\n    // Display defenses\n    html.querySelector(\".defenses .rollable[data-dtype='defenses']\").addEventListener(\"click\", (ev) => {\n      ev.preventDefault();\n      this.actor.displayDefenseCard({ token: this.token });\n    });\n\n    // Roll Driver skill\n    html.querySelector(\".driver-skill .rollable[data-dtype='driverSkill']\").addEventListener(\"click\", (ev) => {\n      ev.preventDefault();\n      const driver = fromUuidSync(this.actor.system.driver.uuid);\n      const skill = this.actor.system.driver.skill;\n      if (skill) {\n        driver.rollSkill(skill, { token: this.token });\n      } else {\n        driver.rollAbilityTest(\"wis\", { token: this.token });\n      }\n    });\n\n    // Hook onto the Driver Select to assign a driver.\n    html.querySelector(\".select-driver\")?.addEventListener(\"click\", async (_ev) => {\n      const targetActorId = await ffd20.utils.dialog.getActor({\n        actors: game.actors.filter(\n          (a) =>\n            [\"character\", \"npc\"].includes(a.type) &&\n            a.testUserPermission(game.user, CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED)\n        ),\n      });\n\n      const targetActor = game.actors.get(targetActorId);\n      if (!targetActor) return;\n\n      await this.actor.update({ \"system.driver.uuid\": targetActor.uuid });\n    });\n\n    // Driver controls\n    html.querySelector(\".driver-info .edit\")?.addEventListener(\"click\", async (_ev) => {\n      fromUuidSync(this.actor.system.driver.uuid).sheet.render(true);\n    });\n\n    html.querySelector(\".driver-info .delete\")?.addEventListener(\"click\", async (_ev) => {\n      await this.actor.update({ \"system.driver.uuid\": \"\" });\n    });\n  }\n\n  /**\n   * Organize and classify Owned Items - We just need attacks\n   *\n   * @param {object} context The rendering context\n   * @private\n   * @override\n   */\n  _prepareItems(context) {\n    const attacks = context.items.filter((i) => i.type === \"attack\");\n\n    const attackSections = Object.values(ffd20.config.sheetSections.combatlite)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n    for (const i of attacks) {\n      const section = attackSections.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      } else {\n        console.warn(\"Could not find a sheet section for\", i.name);\n      }\n    }\n\n    context.attacks = attackSections;\n\n    // Categorize items as inventory, spellbook, features, and classes\n    const inventory = Object.values(ffd20.config.sheetSections.inventory)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    // Alter inventory columns\n    for (const section of inventory) {\n      section.interface = { ...section.interface, value: true, actions: false, noEquip: true };\n    }\n\n    const items = context.items.filter((i) => i.isPhysical);\n\n    // Organize Inventory\n    for (const i of items) {\n      const section = inventory.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      }\n    }\n\n    // Apply user filters\n    const invCat = { key: \"inventory\", sections: inventory };\n    const set = this._filters.sections.inventory ?? new Set();\n    for (const section of inventory) {\n      this._filterSection(invCat, section, set);\n    }\n\n    context.inventory = inventory;\n  }\n\n  /** @type {CoinType} */\n  get itemValueDenomination() {\n    return \"gp\";\n  }\n\n  _updateObject(event, formData) {\n    formData = foundry.utils.expandObject(formData);\n\n    // Convert distances back to backend imperial format\n    const convertibleKeys = [\"currentSpeed\", \"maxSpeed\", \"acceleration\"];\n    for (const key of convertibleKeys) {\n      const value = formData.system.details[key];\n      if (Number.isFinite(value)) {\n        formData.system.details[key] = ffd20.utils.convertDistanceBack(value)[0];\n      }\n    }\n\n    return super._updateObject(event, formData);\n  }\n\n  _computeDriverData(driverId, skillId) {\n    if (!driverId || this.actor.pack) return {};\n\n    /** @type {ActorPF} */\n    const driver = fromUuidSync(driverId);\n    if (!driver) return {};\n\n    const rollData = driver.getRollData();\n    let mod = rollData.abilities.wis.mod;\n    try {\n      mod = driver.getSkillInfo(skillId).mod;\n    } catch {\n      // error silently, as we default to Wisdom Modifier\n    }\n\n    const skills = {};\n    for (const skillId of driver.allSkills) {\n      const skill = driver.getSkillInfo(skillId);\n      skills[skillId] = skill.fullName;\n    }\n\n    return {\n      name: driver.name,\n      img: driver.img,\n      uuid: driver.uuid,\n      skills: skills,\n      skillBonus: mod,\n    };\n  }\n\n  /**\n   * Roll saving throw\n   *\n   * @protected\n   * @param {Event} event - The originating click event\n   */\n  async _onRollSavingThrow(event) {\n    event.preventDefault();\n\n    /** @type {SaveId} */\n    const saveId = await foundry.applications.api.DialogV2.wait({\n      window: { title: game.i18n.localize(\"FFD20.Dialog.VehicleSave.Title\") },\n      content: `<p>${game.i18n.localize(\"FFD20.Dialog.VehicleSave.Message\")}</p>`,\n      buttons: [\n        {\n          label: game.i18n.localize(\"FFD20.SavingThrowFort\"),\n          action: \"fort\",\n        },\n        {\n          label: game.i18n.localize(\"FFD20.SavingThrowRef\"),\n          action: \"ref\",\n        },\n      ],\n    });\n\n    this.actor.rollSavingThrow(saveId, { token: this.token });\n  }\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An application that renders the movement speed configuration of an item\n *\n * @param {ActorPF} actor     The Actor instance for which to configure resting\n */\nexport class SpeedEditor extends HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: SpeedEditor._save,\n      submitOnChange: false,\n      submitOnClose: false,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"speed-editor\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    position: {\n      width: 400,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/speed-editor.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    const itemData = this.document.system;\n    const speeds = {};\n\n    for (const key of ffd20.const.movementKeys) {\n      let value = itemData.speeds?.[key];\n      if (value > 0) value = ffd20.utils.convertDistance(value)[0];\n      speeds[key] = value;\n    }\n\n    speeds.flyManeuverability = itemData.speeds.flyManeuverability || \"average\";\n\n    const isMetric = ffd20.utils.getDistanceSystem() === \"metric\";\n\n    return {\n      speeds,\n      item: this.document,\n      system: itemData,\n      units: game.i18n.localize(isMetric ? \"FFD20.Distance.mShort\" : \"FFD20.Distance.ftShort\"),\n      step: isMetric ? 1.5 : 5,\n      flyManeuverability: {\n        clumsy: \"FFD20.Movement.FlyManeuverability.Quality.clumsy\",\n        poor: \"FFD20.Movement.FlyManeuverability.Quality.poor\",\n        average: \"FFD20.Movement.FlyManeuverability.Quality.average\",\n        good: \"FFD20.Movement.FlyManeuverability.Quality.good\",\n        perfect: \"FFD20.Movement.FlyManeuverability.Quality.perfect\",\n      },\n      buttons: [{ type: \"submit\", label: \"FFD20.Save\", icon: \"fa-solid fa-save\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the speed editor window to include document name, and optionally the actors name, if present\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    const actor = this.document.actor;\n    let title = `${game.i18n.localize(\"FFD20.Movement.Label\")}: ${this.document.name}`;\n    if (actor) title += ` â ${actor.name}`;\n    return title;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Save the movement speed data back to the item\n   *\n   * @internal\n   * @this {SpeedEditor}\n   * @param {SubmitEvent} event - The originating form submission event\n   * @param {HTMLFormElement} form - The form element that was submitted\n   * @param {FormDataExtended} formData - Processed data for the submitted form\n   * @param {Record<string, number|string>} formData.object - The movement speed configuration\n   * @returns {Promise<void>}\n   */\n  static async _save(event, form, formData) {\n    formData = formData.object;\n\n    // Convert data back\n    for (const [key, value] of Object.entries(formData)) {\n      if (Number.isNumeric(value)) {\n        formData[key] = ffd20.utils.convertDistanceBack(value)[0];\n      }\n    }\n\n    this.document.update(formData);\n  }\n}\n","/**\n * @typedef {object} Widget_CategorizedItemPicker~Item\n * @property {string} key - The key of the item.\n * @property {string} [label] - The label of the item.\n * @property {string} [icon] - The icon of the item.\n */\n\n/**\n * @typedef {object} Widget_CategorizedItemPicker~Category\n * @property {string} key - The key of the category.\n * @property {string} label - The label of the category.\n * @property {Widget_CategorizedItemPicker~Item[]} items - All the items associated with this category.\n */\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Item picker widget.\n */\nexport class Widget_CategorizedItemPicker extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"widget\", \"categorized-item-picker\"],\n    window: {\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      width: 480,\n      height: 480,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/widgets/categorized-item-picker.hbs\",\n    },\n  };\n\n  constructor(options, categories, callback, selected) {\n    super(options);\n\n    /**\n     * Objects containing category and item data.\n     *\n     * @type {Widget_CategorizedItemPicker~Category[]}\n     */\n    this.categories = categories;\n\n    /**\n     * Previously selected category and item\n     *\n     * @type {object}\n     * @property {string} category Selected category.\n     * @property {string} item Selected item in that category.\n     */\n    this.selected = selected;\n\n    /**\n     * Callback fired when an item has been selected.\n     *\n     * @type {Function}\n     */\n    this.callback = callback;\n\n    /**\n     * Track hidden elements of the sheet.\n     *\n     * @property\n     * @type {Object<string, string>}\n     */\n    this._hiddenElems = {};\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    const categories = [];\n\n    for (const cat of this.categories) {\n      cat.hidden = cat.validity.item === false;\n      if (cat.hidden) continue;\n      cat.active = cat.key === this.selected?.category;\n\n      const categoryItems = [];\n      for (const item of cat.items) {\n        if (item.validity.item === false) continue;\n\n        // Mark items as invalid if the category is invalid\n        if (!cat.validity.valid) {\n          item.validity.category = false;\n          item.validity.valid = false;\n        }\n\n        categoryItems.push({\n          category: cat.key,\n          active: this.selected?.item === item.key,\n          ...item,\n        });\n      }\n\n      // Has any valid choices\n      cat.hasChoices = categoryItems.some((i) => i.validity.valid);\n      cat.hasVisibleChoices = categoryItems.some((i) => i.validity.item !== false);\n\n      if (!cat.hasVisibleChoices || !cat.hasChoices) continue;\n\n      cat.items = categoryItems;\n      categories.push(cat);\n    }\n\n    return {\n      categories,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    // Click an item\n    this.element.querySelectorAll(\".item\").forEach((el) => el.addEventListener(\"click\", this._onClickItem.bind(this)));\n\n    // Cancel widget\n    window.setTimeout(() => {\n      if (this._cancelCallback) document.removeEventListener(\"click\", this._cancelCallback);\n      this._cancelCallback = this._onCancel.bind(this);\n      document.addEventListener(\"click\", this._cancelCallback);\n    }, 10);\n  }\n\n  /**\n   * @override\n   * @this {Widget_CategorizedItemPicker}\n   */\n  async _onFirstRender(context, options) {\n    super._onFirstRender(context, options);\n\n    // HACK: Yield so browser can render the element. Required for scrollIntoView() to function\n    // This for once is not Foundry's fault\n    await new Promise((resolve) => setTimeout(resolve, 0));\n\n    // Scroll previously  selected option into view\n    this.element\n      .querySelector(\".window-content .pre-selected\")\n      ?.scrollIntoView({ block: \"center\", behaviour: \"instant\" });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle click on an item.\n   *\n   * @param {Event} event\n   * @private\n   */\n  _onClickItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const result = a.dataset.value;\n    this.callback(result);\n    this.close();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle click outside the widget.\n   *\n   * @param {Event} event\n   * @private\n   */\n  _onCancel(event) {\n    event.preventDefault();\n\n    // Don't cancel if this widget was clicked\n    let node = event.target;\n    if (node === this.element) return;\n    while (node.parentNode) {\n      if (node === this.element) return;\n      node = node.parentNode;\n    }\n\n    this.close();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Close the widget\n   *\n   * @param args\n   * @returns {Promise<void>}\n   */\n  async close(...args) {\n    document.removeEventListener(\"click\", this._cancelCallback);\n    return super.close(...args);\n  }\n}\n","import { ActorTraitSelector } from \"@app/trait-selector.mjs\";\n\n/**\n * A trait selector variant that reads and stores information into an object with boolean values.\n *\n * @property {string} _searchFilter           Current search filter\n * @property {string} _collator               Collator for sorting\n * @property {object} attributes              The currently stored values for this trait selector\n * @property {string[]} attributes.value      Elements from the provided set of choices that have been checked\n */\nexport class FlagSelector extends ActorTraitSelector {\n  static DEFAULT_OPTIONS = {\n    form: {\n      handler: FlagSelector._updateDocument,\n    },\n  };\n\n  constructor(options) {\n    options.hasCustom = false;\n    super(options);\n\n    const valueObject = foundry.utils.getProperty(options.document.toObject(), this.attribute) ?? {};\n\n    Object.entries(valueObject).forEach(([k, v]) => {\n      if (v) this.attributes.standard.add(k);\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the Actor object with new trait data processed from the form\n   *\n   * @this {FlagSelector}\n   * @private\n   * @param {SubmitEvent} event                   The originating form submission event\n   * @param {HTMLFormElement} form                The form element that was submitted\n   * @param {FormDataExtended} formData           Processed data for the submitted form\n   * @returns {Promise<void>}\n   */\n  static async _updateDocument(event, form, formData) {\n    // Unregister this app from doc to avoid re-renders\n    delete this.document.apps[this.appId];\n\n    const options = Object.keys(this.options.choices);\n    const newValue = {};\n    options.forEach((o) => {\n      newValue[o] = this.attributes.standard.has(o);\n    });\n\n    const updateData = {\n      [this.attribute]: newValue,\n    };\n\n    this.document.update(updateData);\n    this.close({ force: true });\n  }\n}\n","import { ActorTraitSelector } from \"@app/trait-selector.mjs\";\nimport { SpeedEditor } from \"@app/speed-editor.mjs\";\nimport { Widget_CategorizedItemPicker } from \"@app/categorized-item-picker.mjs\";\nimport { getSkipActionPrompt } from \"@documents/settings.mjs\";\nimport { renderCachedTemplate } from \"@utils/handlebars/templates.mjs\";\nimport { FlagSelector } from \"@app/flag-selector.mjs\";\n\n/**\n * Override and extend the core ItemSheet implementation to handle game system specific item types\n *\n * @type {ItemSheet}\n */\nexport class ItemSheetPF extends ItemSheet {\n  constructor(...args) {\n    super(...args);\n\n    // Add item type to selectors\n    this.options.classes.push(`type-${this.item.type}`);\n\n    /**\n     * Track action updates from the item sheet.\n     *\n     * @property\n     * @private\n     * @type {object[]}\n     */\n    this._actionUpdates = [];\n\n    // Activate more reasonable default links sub-tab per item type.\n    // Related core issue: https://github.com/foundryvtt/foundryvtt/issues/9748\n    const links = this._tabs.find((t) => t.group === \"links\");\n    if (this.item.type === \"class\") {\n      links.active = \"classAssociations\";\n    } else if ([\"feat\", \"consumable\", \"attack\", \"equipment\"].includes(this.item.type)) {\n      links.active = \"charges\";\n    }\n  }\n\n  /**\n   * @internal\n   * @type {Record<string,string>}\n   */\n  _activeEdits = {};\n\n  /**\n   * Which fields to track edits for\n   *\n   * @internal\n   */\n  static EDIT_TRACKING = [\"system.description.value\", \"system.description.unidentified\"];\n\n  /* -------------------------------------------- */\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 800,\n      classes: [\"ffd20\", \"sheet\", \"item\"],\n      scrollY: [\".tab\", \".buff-flags\", \".editor-content\"],\n      dragDrop: [\n        {\n          dragSelector: \"li.action-part\",\n          dropSelector: \".tab.details\",\n        },\n        {\n          dragSelector: \".tab.changes li.change\",\n          dropSelector: null,\n        },\n        {\n          dragSelector: \".tab.links .item-name\",\n          dropSelector: \".tab.links .tab[data-group='links']\",\n        },\n      ],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"description\",\n          group: \"primary\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='links']\",\n          contentSelector: \"section.links-body\",\n          initial: \"children\",\n          group: \"links\",\n        },\n        {\n          navSelector: \"nav.tabs[data-group='description']\",\n          contentSelector: \"section.description-body\",\n          initial: \"identified\",\n          group: \"description\",\n        },\n      ],\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Return a dynamic reference to the HTML template path used to render this Item Sheet\n   *\n   * @returns {string} - Template path\n   */\n  get template() {\n    const path = \"systems/ffd20/templates/items\";\n    return `${path}/${this.item.type}.hbs`;\n  }\n\n  get title() {\n    const actor = this.actor;\n    if (actor) return `${super.title} â ${actor.name}`;\n    return super.title;\n  }\n\n  /* -------------------------------------------- */\n\n  /** @override */\n  async _render(force, options) {\n    ffd20.applications.utils.saveEditState(this, options);\n\n    return super._render(force, options);\n  }\n\n  /**\n   * Prepare item sheet data\n   * Start with the base item data and extending with additional properties for rendering.\n   */\n  async getData() {\n    const lang = game.settings.get(\"core\", \"language\");\n\n    /** @type {ItemPF} */\n    const item = this.item,\n      system = item.system;\n\n    const actor = item.actor,\n      actorData = actor?.system;\n\n    const isolated = !actor;\n\n    const defaultAction = item.defaultAction;\n\n    const rollData = defaultAction?.getRollData() ?? item.getRollData();\n\n    const context = {\n      cssClass: this.isEditable ? \"editable\" : \"locked\",\n      item,\n      document: item, // Reference used by unknown data\n      name: item.name,\n      system,\n      itemType: game.i18n.localize(CONFIG.Item.typeLabels[item.type]),\n      rollData,\n      config: ffd20.config,\n      owned: !!actor,\n      owner: item.isOwner,\n      editable: this.isEditable,\n      isGM: game.user.isGM,\n      labels: item.getLabels({ rollData, isolated }),\n      canClassLink: ffd20.config.classAssociations.includes(item.type) && !!rollData.classes,\n      inContainer: item.inContainer ?? false,\n      // Include raw tag data (from source to not get autofilled tag)\n      tag: this.item._source.system.tag,\n    };\n\n    // Item type identifiers\n    const isPhysical = item.isPhysical;\n    const isWeapon = item.type === \"weapon\";\n    const isAttack = item.type === \"attack\";\n    const isWeaponLike = isAttack && item.subType === \"weapon\";\n    const isNaturalAttack = isAttack && system.subType === \"natural\";\n    const isClass = item.type === \"class\";\n    const isSpell = item.type === \"spell\";\n    const isMateria = system.subType === \"materia\";\n    const isImplant = item.type === \"implant\";\n    const isEquipment = item.type === \"equipment\";\n\n    context.isPhysical = isPhysical;\n    context.isWeapon = isWeapon;\n    context.isAttack = isAttack;\n    context.isWeaponLike = isWeaponLike;\n    context.isNaturalAttack = isNaturalAttack;\n    context.isClass = isClass;\n    context.isSpell = isSpell;\n    context.isMateria = isMateria;\n    context.isImplant = isImplant;\n    context.isEquipment = isEquipment;\n\n    if (context.canClassLink) {\n      context.hasClassLink = !!item.system.class;\n      context.classes = {};\n      for (const [classTag, classData] of Object.entries(rollData.classes)) {\n        context.classes[classTag] = classData.name;\n      }\n    }\n\n    // Include sub-items\n    context.items = item.items?.map((i) => i.toObject()) ?? [];\n\n    // Add hit die size options for classes\n    if (isClass) {\n      context.hitDieSizes = context.config.hitDieSizes.reduce((all, size) => {\n        all[size] = game.i18n.format(\"FFD20.DieSize\", { size });\n        return all;\n      }, {});\n\n      context.isMythic = this.item.subType === \"mythic\";\n\n      if (item.system.wealth) {\n        const context = { formula: item.system.wealth, item: this.item };\n        const max = Roll.defaultImplementation.safeRollSync(item.system.wealth, undefined, context, undefined, {\n          maximize: true,\n        })?.total;\n        const min = Roll.defaultImplementation.safeRollSync(item.system.wealth, undefined, context, undefined, {\n          minimize: true,\n        })?.total;\n        if (max > 0) {\n          context.wealth ??= {};\n          context.wealth.average = (max + min) / 2;\n        }\n      }\n    }\n\n    if (item.links.charges) context.inheritCharges = item.links.charges;\n    context.isCharged = ![\"single\", \"\", undefined].includes(system.uses?.per);\n    context.defaultChargeFormula = item.getDefaultChargeFormula();\n\n    context.limitedUsePeriods = { ...ffd20.config.limitedUsePeriods };\n    if (!item.isPhysical) delete context.limitedUsePeriods.single;\n    context.isRechargeable = ffd20.config.limitedUsePeriodOrder.includes(system.uses?.per);\n\n    context.isActivatable = ![\"race\", \"class\", \"container\", \"loot\"].includes(item.type);\n    context.hasAction = item.hasAction;\n    context.hasAttack = item.hasAttack;\n    context.hasDamage = item.hasDamage;\n    context.showBothDescriptions = context.isGM && context.isPhysical;\n    context.showUnidentifiedData = item.showUnidentifiedData;\n    context.showIdentified = !item.showUnidentifiedData;\n    context.isIdentified = item.system.identified !== false;\n    context.showIdentifiedData = context.showIdentified;\n    if (context.showIdentified && context.isPhysical) context.showBothDescriptions = true;\n    context.unchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n\n    context.showInCombat = [\"weapon\", \"spell\", \"equipment\", \"consumable\"].includes(item.type);\n    if (item.type === \"feat\" && [\"feat\", \"classFeat\", \"racial\"].includes(item.subType)) context.showInCombat = true;\n\n    // Identification information\n    context.identify ??= {};\n    context.identify.dc = 0;\n    const auraStrength = rollData.item.auraStrength;\n    if (auraStrength) {\n      context.aura = {\n        strength: auraStrength,\n        strengthLabel: ffd20.config.auraStrengths[auraStrength],\n        school: ffd20.config.spellSchools[system.aura.school] || system.aura.school || game.i18n.localize(\"FFD20.Unknown\"),\n      };\n\n      context.identify.dc = 15 + rollData.item.cl;\n      context.identify.curse = context.identify.dc + 10;\n    }\n\n    // Add spellcasting configuration\n    if (isClass) {\n      context.casting = {\n        types: ffd20.config.spellcasting.type,\n        spells: ffd20.config.spellcasting.spells,\n        progression: {\n          high: \"FFD20.High\",\n          med: \"FFD20.Medium\",\n          low: \"FFD20.Low\",\n        },\n      };\n\n      if (!item.actor)\n        context.hasSpellbook = true; // Not true, but avoids unwanted behaviour.\n      else {\n        context.hasSpellbook = Object.values(rollData.spells ?? {}).find(\n          (book) => !!book.class && book.class === system.tag && book.inUse\n        );\n      }\n    }\n\n    /** @type {DescriptionAttribute[]} */\n    context.descriptionAttributes = [];\n\n    // Override description attributes\n    if (context.isPhysical) {\n      // Add quantity\n      context.descriptionAttributes.push({\n        isNumber: true,\n        isRelative: true,\n        name: \"system.quantity\",\n        label: game.i18n.localize(\"FFD20.Quantity\"),\n        value: system.quantity || 0,\n        decimals: 0,\n        id: \"data-quantity\",\n        constraints: {\n          min: 0,\n          step: 1,\n        },\n      });\n\n      // Add weight\n      context.descriptionAttributes.push({\n        isNumber: true,\n        isRelative: true,\n        name: \"system.weight.value\",\n        label: game.i18n.localize(\"FFD20.Weight\"),\n        value: system.weight.converted.total,\n        fakeValue: true,\n        inputValue: system.weight.converted.value,\n        decimals: 2,\n        tooltip: \"weight\",\n        id: \"data-weight-value\",\n        constraints: {\n          min: 0,\n          step: 0.01,\n        },\n      });\n\n      // Add price\n      if (context.isGM) {\n        context.descriptionAttributes.push(\n          {\n            isNumber: true,\n            isRelative: true,\n            name: \"system.price\",\n            label: game.i18n.localize(\"FFD20.Price\"),\n            value: item.getValue({ sellValue: 1 }),\n            decimals: 2,\n            tooltip: \"price\",\n            id: \"data-price\",\n            constraints: {\n              min: 0,\n              step: 0.01,\n            },\n          },\n          {\n            isNumber: true,\n            isRelative: true,\n            name: \"system.unidentified.price\",\n            label: game.i18n.localize(\"FFD20.UnidentifiedPriceShort\"),\n            value: item.getValue({ sellValue: 1, forceUnidentified: true }),\n            decimals: 2,\n            tooltip: \"unidprice\",\n            id: \"data-unidentifiedPrice\",\n            constraints: {\n              min: 0,\n              step: 0.01,\n            },\n          }\n        );\n      } else if (context.showUnidentifiedData) {\n        context.descriptionAttributes.push({\n          isNumber: true,\n          isRelative: true,\n          name: \"system.unidentified.price\",\n          fakeName: true,\n          label: game.i18n.localize(\"FFD20.Price\"),\n          value: item.getValue({ sellValue: 1 }),\n          decimals: 2,\n          tooltip: \"price\",\n          id: \"data-price\",\n          constraints: {\n            min: 0,\n            step: 0.01,\n          },\n        });\n      } else {\n        context.descriptionAttributes.push({\n          isNumber: true,\n          isRelative: true,\n          name: \"system.price\",\n          label: game.i18n.localize(\"FFD20.Price\"),\n          value: item.getValue({ sellValue: 1 }),\n          decimals: 2,\n          tooltip: \"price\",\n          id: \"data-price\",\n          constraints: {\n            min: 0,\n            step: 0.01,\n          },\n        });\n      }\n\n      // Add hit points\n      if (!context.isImplant) {\n        context.descriptionAttributes.push({\n          isRange: true,\n          label: game.i18n.localize(\"FFD20.HPShort\"),\n          current: {\n            isNumber: true,\n            isRelative: true,\n            name: \"system.hp.value\",\n            value: system.hp?.value || 0,\n            constraints: {\n              step: 1,\n              max: system.hp?.max || 0,\n            },\n          },\n          max: {\n            isNumber: true,\n            isRelative: true,\n            name: \"system.hp.base\",\n            fakeValue: true,\n            inputValue: system.hp.base,\n            value: system.hp?.max || 0,\n            constraints: {\n              min: 0,\n              step: 1,\n            },\n          },\n        });\n\n        // Add hardness\n        context.descriptionAttributes.push({\n          isNumber: true,\n          isRelative: true,\n          label: game.i18n.localize(\"FFD20.Hardness\"),\n          name: \"system.hardness\",\n          decimals: 0,\n          value: system.hardness.total || 0,\n          fakeValue: true,\n          inputValue: this.item._source.system.hardness || 0,\n          constraints: {\n            min: 0,\n            step: 1,\n          },\n        });\n      }\n\n      let disableEquipping = false;\n      if (item.inContainer) {\n        if (item.canEquip === false) disableEquipping = true;\n        else if (context.isImplant) disableEquipping = true;\n      }\n\n      // Add equipped/implanted flag\n      if (context.isImplant) {\n        context.descriptionAttributes.push({\n          isBoolean: true,\n          name: \"system.implanted\",\n          label: game.i18n.localize(\"FFD20.Implanted\"),\n          value: system.implanted,\n          disabled: disableEquipping,\n        });\n      } else {\n        // Certain loot types don't have equipped\n        if (item.type === \"loot\" && ffd20.config.unequippableLoot.includes(this.item.subType)) disableEquipping = true;\n\n        context.descriptionAttributes.push({\n          isBoolean: true,\n          name: \"system.equipped\",\n          label: game.i18n.localize(\"FFD20.Equipped\"),\n          value: system.equipped,\n          disabled: disableEquipping,\n        });\n      }\n\n      // Add carried flag\n      context.descriptionAttributes.push({\n        isBoolean: true,\n        name: \"system.carried\",\n        label: game.i18n.localize(\"FFD20.Carried\"),\n        value: system.carried || item.system.implanted || false,\n        disabled: item.inContainer || item.system.implanted || false,\n      });\n    }\n\n    if (context.isPhysical || item.isQuasiPhysical) {\n      // Add broken flag\n      if (!context.isImplant) {\n        context.descriptionAttributes.push({\n          isBoolean: true,\n          name: \"system.broken\",\n          label: game.i18n.localize(\"FFD20.Broken\"),\n          value: system.broken,\n          disabled: context.isNaturalAttack,\n        });\n      }\n\n      // Add masterwork flag\n      if (!context.isImplant && !context.isMateria) {\n        context.descriptionAttributes.push({\n          isBoolean: true,\n          name: \"system.masterwork\",\n          label: game.i18n.localize(\"FFD20.Masterwork\"),\n          value: system.masterwork,\n          disabled: context.isNaturalAttack,\n        });\n      }\n    }\n\n    if (context.isPhysical) {\n      // Add identified flag for GM\n      if (game.user.isGM) {\n        context.descriptionAttributes.push({\n          isBoolean: true,\n          name: \"system.identified\",\n          label: game.i18n.localize(\"FFD20.Identified\"),\n          value: system.identified ?? true,\n          disabled: !game.user.isGM,\n        });\n      }\n    }\n\n    // Prepare feat specific stuff\n    if (item.type === \"feat\") {\n      context.isClassFeature = system.subType === \"classFeat\";\n      context.isTemplate = system.subType === \"template\";\n\n      context.abilityTypes = Object.fromEntries(\n        Object.entries(ffd20.config.abilityTypes).map(([key, { short, long }]) => [key, `${long} (${short})`])\n      );\n    }\n\n    // Add skill list to items that support them\n    // TODO: Make this ask the item itself if they have class skills\n    if (system.classSkills || [\"class\", \"feat\", \"race\"].includes(item.type)) {\n      const classSkills = system.classSkills ?? {};\n      // Get all skills\n      const skills = foundry.utils.mergeObject(ffd20.config.skills, actorData?.skills ?? {}, { inplace: false });\n      // Build skill context\n      context.skills = Object.entries(skills)\n        .map(([skillId, skilldata]) => ({\n          ...skilldata,\n          key: skillId,\n          name: ffd20.config.skills[skillId] || skilldata.name,\n          isCS: classSkills[skillId] === true,\n        }))\n        .sort((a, b) => a.name.localeCompare(b.name));\n    }\n\n    // Prepare attack-specific stuff\n    if (isAttack) {\n      context.materialCategories = this._prepareMaterialsAndAddons(item);\n\n      context.alignmentTypes = this._prepareAlignments(system.alignments);\n    }\n\n    const material = isEquipment ? this.item.system.armor?.material : this.item.system.material;\n    if (material?.addon?.length) {\n      context.materialAddons =\n        material.addon.reduce((obj, v) => {\n          obj[v] = true;\n          return obj;\n        }, {}) ?? {};\n    }\n\n    // Prepare categories for weapons\n    if (isWeaponLike) {\n      system.weapon ??= {};\n      system.weapon.category ||= \"simple\";\n      system.weapon.type ||= \"1h\";\n    }\n\n    // Prepare weapon specific stuff\n    if (isWeapon || isWeaponLike) {\n      const category = isWeapon ? system.subType : system.weapon.category;\n      const wsubtype = isWeapon ? system.weaponSubtype : system.weapon.type;\n\n      switch (category) {\n        case \"siege\":\n          context.isRanged = [\"direct\", \"indirect\"].includes(wsubtype);\n          break;\n        case \"heavy\":\n        case \"firearm\":\n          context.isRanged = true;\n          break;\n        default:\n          context.isRanged = wsubtype === \"ranged\" || system.properties?.[\"thr\"] === true;\n          break;\n      }\n    }\n\n    if (isWeapon || isWeaponLike) {\n      context.weaponCategories = { types: {}, subTypes: {} };\n      for (const [k, v] of Object.entries(ffd20.config.weaponTypes)) {\n        context.weaponCategories.types[k] = v._label;\n      }\n      let type;\n      if (isWeapon) type = system.subType;\n      else if (isWeaponLike) type = system.weapon?.category;\n\n      if (type in ffd20.config.weaponTypes) {\n        for (const [k, v] of Object.entries(ffd20.config.weaponTypes[type])) {\n          // Add static targets\n          if (!k.startsWith(\"_\")) context.weaponCategories.subTypes[k] = v;\n        }\n      }\n    }\n\n    if (isWeapon) {\n      context.materialCategories = this._prepareMaterialsAndAddons(item);\n\n      context.alignmentTypes = this._prepareAlignments(system.alignments);\n    }\n\n    // Prepare equipment specific stuff\n    if (isEquipment) {\n      // Prepare categories for equipment\n      context.equipmentCategories = { types: {}, subTypes: {} };\n      for (const [k, v] of Object.entries(ffd20.config.equipmentTypes)) {\n        context.equipmentCategories.types[k] = v._label;\n      }\n      const subType = system.subType;\n      if (subType in ffd20.config.equipmentTypes) {\n        for (const [k, v] of Object.entries(ffd20.config.equipmentTypes[subType])) {\n          // Add static targets\n          if (!k.startsWith(\"_\")) context.equipmentCategories.subTypes[k] = v;\n        }\n      }\n\n      // Prepare slots for equipment\n      if(isMateria) {\n        context.equipmentSlots = ffd20.config.equipmentSlots.materia;\n        context.equipmentSlotted = ffd20.config.materia.Slot;\n        context.materiaRarity = ffd20.config.materia.Rarity;\n      } else {\n        context.equipmentSlots = ffd20.config.equipmentSlots.wondrous;\n      }\n\n      // Whether the current equipment type has multiple slots\n      context.hasMultipleSlots = item.hasSlots;\n\n      context.hasSubCategory = [\"armor\", \"shield\", \"materia\"].includes(subType);\n\n      // Prepare materials where they're needed.\n      if ([\"armor\", \"shield\"].includes(item.subType)) {\n        context.materialCategories = this._prepareMaterialsAndAddons(item);\n      }\n\n      // Can be held in different ways\n      context.variableHands = [\"wondrous\", \"other\"].includes(item.subType);\n    }\n\n    if (isImplant) {\n      context.subTypes = ffd20.config.implantTypes;\n\n      context.isCybertech = item.subType === \"cybertech\";\n      if (context.isCybertech) context.slots = ffd20.config.implantSlots.cybertech;\n    }\n\n    let topDescription;\n\n    // Prepare spell specific stuff\n    if (context.isSpell) {\n      let spellbook = null;\n      if (actor) {\n        const bookId = system.spellbook;\n        spellbook = actorData?.attributes.spells?.spellbooks[bookId];\n      }\n\n      context.isSpontaneousLike = spellbook?.spontaneous || spellbook?.spellPoints?.useSystem || false;\n      context.isPreparedSpell = !context.isSpontaneousLike;\n      context.usesSpellpoints = spellbook != null ? (spellbook.spellPoints?.useSystem ?? false) : false;\n      context.isAtWill = system.atWill;\n      context.spellbooks = actorData?.attributes.spells.spellbooks ?? {};\n      context.spellbookChoices = Object.fromEntries(\n        Object.entries(context.spellbooks)\n          .filter(([_, { inUse }]) => inUse)\n          .map(([key, { label }]) => [key, label])\n          .sort(([_0, n0], [_1, n1]) => n0.localeCompare(n1, lang))\n      );\n\n      topDescription = renderCachedTemplate(\n        \"systems/ffd20/templates/items/headers/spell-header.hbs\",\n        await item.getDescriptionData({ rollData, isolated })\n      );\n\n      // Reverse mapping of ffd20.config.divineFocus for readability\n      const dfVariants = { DF: 1, MDF: 2, FDF: 3 };\n      system.components ??= {};\n      const df = system.components.divineFocus;\n      // Force intrinsic DF components\n      if (df === dfVariants.MDF) system.components.material = true;\n      if (df === dfVariants.FDF) system.components.focus = true;\n\n      // Generate component list according to spellbook\n      const c = { ...system.components };\n      context.components = c;\n      if (spellbook) {\n        const isDivine = spellbook.kind === \"divine\";\n        if (isDivine) {\n          if (df === dfVariants.FDF) c.focus = false;\n          if (df === dfVariants.MDF) c.material = false;\n        } else {\n          c.divineFocus = false;\n        }\n      }\n\n      // Material for spells to emulate\n      context.materialCategories = this._prepareMaterialsAndAddons(item);\n\n      context.alignmentTypes = this._prepareAlignments(system.alignments);\n    }\n\n    if (this.item.type === \"buff\") {\n      context.noDurationTiming = !system.duration.units || system.duration.units === \"turn\";\n    }\n\n    // Prepare class specific stuff\n    if (isClass) {\n      context.isMythicPath = system.subType === \"mythic\";\n\n      for (const [a, s] of Object.entries(system.savingThrows)) {\n        s.label = ffd20.config.savingThrows[a];\n      }\n      for (const [a, s] of Object.entries(system.fc)) {\n        s.label = ffd20.config.favouredClassBonuses[a];\n      }\n\n      context.isBaselikeClass = ffd20.config.favoredClassTypes.includes(system.subType);\n      context.isRacialHD = system.subType === \"racial\";\n      context.isNPCClass = system.subType === \"npc\";\n      context.isPCClass = !context.isNPCClass && !context.isRacialHD;\n\n      /** @type {ffd20.applications.settings.HealthConfigModel} */\n      const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n      context.healthConfig = actor ? healthConfig.getClassHD(this.item, actor.type) : null;\n    }\n\n    if (item.type === \"consumable\") {\n      context.hasSpellType = [\"potion\", \"scroll\", \"wand\", \"staff\"].includes(item.subType);\n    }\n\n    // Prepare ammunition\n    context.canUseAmmo = !context.isNaturalAttack && item.type !== \"spell\";\n    if (context.canUseAmmo && item.system.ammo?.type) {\n      context.defaultAmmo = item.defaultAmmo;\n      if (context.defaultAmmo) {\n        context.invalidDefaultAmmo = context.defaultAmmo.system.extraType !== item.system.ammo.type;\n      }\n    }\n\n    // Prepare {value: [], custom: []} objects\n    const traitsMap = {\n      armorProf: ffd20.config.armorProficiencies,\n      descriptors: ffd20.config.spellDescriptors,\n      languages: ffd20.config.languages,\n      multischool: ffd20.config.spellMultischools,\n      subschool: ffd20.config.spellSubschools,\n      weaponGroups: ffd20.config.weaponGroups,\n      weaponProf: ffd20.config.weaponProficiencies,\n      creatureTypes: ffd20.config.creatureTypes,\n      creatureSubtypes: ffd20.config.creatureSubtypes,\n    };\n\n    for (const [traitKey, labels] of Object.entries(traitsMap)) {\n      if (!system[traitKey]) continue;\n\n      const trait = foundry.utils.deepClone(system[traitKey]);\n      context[traitKey] = trait;\n\n      trait.selected = {};\n      for (const id of trait.standard) {\n        trait.selected[id] = labels[id] || id;\n      }\n\n      // Add custom entry\n      let i = 1;\n      for (const id of trait.custom) {\n        trait.selected[`custom${i++}`] = id;\n      }\n\n      trait.active = !foundry.utils.isEmpty(trait.selected);\n    }\n\n    // Prepare stuff for changes\n    if (item.changes?.size) {\n      const buffTargets = ffd20.utils.internal.getBuffTargets(\"buffs\", { actor, item });\n      let showPriority = false;\n      context.changes =\n        item.changes?.map((/** @type {ItemChange} */ ch) => {\n          const target = buffTargets[ch.target];\n          const typeLabel = ffd20.config.bonusTypes[ch.type];\n          const chData = {\n            change: ch,\n            isValid: !!target,\n            label: target?.label ?? ch.target,\n            isDeferred: ch.isDeferred,\n            isCustom: [\"skill\", \"cl\", \"sl\", \"concn\"].includes(ch.target?.split(\".\")?.[0]),\n            isSimple: ch.isSimple,\n            cssClass: ch.cssClass,\n            isAdd: ch.operator === \"add\",\n            isSet: ch.operator === \"set\",\n            ...ch,\n            isValidType: !!typeLabel,\n            typeLabel: typeLabel || ch.type,\n            id: ch.id,\n          };\n          chData.priority ||= 0;\n          if (chData.priority != 0) showPriority = true;\n          return chData;\n        }) ?? [];\n\n      context.changePriority = showPriority;\n    }\n\n    // Prepare stuff for items with context notes\n    if (system.contextNotes) {\n      context.contextNotes = system.contextNotes;\n      const noteTargets = ffd20.utils.internal.getBuffTargets(\"contextNotes\", { actor, item });\n      for (const n of context.contextNotes) {\n        const target = noteTargets[n.target];\n        n.isValid = !!target;\n        n.label = target?.label ?? n.target;\n      }\n    }\n\n    // Prepare condition display\n    context.conditions = item.effects\n      .filter((e) => !e.disabled && e.statuses.size)\n      .map((e) => Array.from(e.statuses))\n      .flat()\n      .map((s) => ffd20.registry.conditions.get(s)?.name || s);\n\n    if (item.system.conditions?.length) {\n      context.causedConditions = item.system.conditions.map((c) => ffd20.registry.conditions.get(c)?.name || c);\n\n      context.conditions.push(...context.causedConditions);\n    }\n\n    context.conditions = new Set(context.conditions.sort((a, b) => a.localeCompare(b)));\n\n    // Add distance units\n    context.distanceUnits = foundry.utils.deepClone(ffd20.config.distanceUnits);\n    if (item.type !== \"spell\") {\n      for (const d of [\"close\", \"medium\", \"long\"]) {\n        delete context.distanceUnits[d];\n      }\n    }\n\n    // Parse notes\n    if (system.attackNotes) {\n      const value = system.attackNotes;\n      foundry.utils.setProperty(context, \"notes.attack\", value);\n    }\n\n    // Add item flags\n    this._prepareItemFlags(context);\n\n    // Add actions\n    context.actions = this.item.actions;\n\n    context.distanceUnit = game.i18n.localize(\n      ffd20.utils.getDistanceSystem() === \"imperial\" ? \"FFD20.Distance.ftShort\" : \"FFD20.Distance.mShort\"\n    );\n\n    // Prepare speeds\n    if (item.type === \"race\") {\n      // Creature types\n      context.raceCreatureTypes = ffd20.utils.naturalSort(system.creatureTypes?.names ?? []);\n      context.raceCreatureSubtypes = ffd20.utils.naturalSort(system.creatureSubtypes?.names ?? []);\n\n      // Speeds\n      context.speeds = [];\n      for (const key of [\"land\", \"fly\", \"swim\", \"climb\", \"burrow\"]) {\n        const value = item.system.speeds?.[key] ?? 0;\n        if (value == 0) continue;\n        let descriptor;\n        if (key === \"fly\") {\n          const fm = item.system.speeds.flyManeuverability || \"average\";\n          descriptor = `FFD20.Movement.FlyManeuverability.Quality.${fm}`;\n        }\n        context.speeds.push({\n          value: ffd20.utils.convertDistance(value)[0],\n          mode: key,\n          label: `FFD20.Movement.Mode.${key}`,\n          descriptor,\n        });\n      }\n    }\n\n    // Content source, fill in from registry\n    if (context.showIdentifiedData) {\n      this._prepareContentSource(context);\n    }\n\n    // Trailing async awaits to ensure they're all awaited in one go instead of sequentially\n\n    // Add descriptions\n    const description = context.showIdentified\n      ? await this.item.getDescription({ rollData, header: false, isolated })\n      : null;\n\n    context.descriptionHTML = {\n      identified: null,\n      unidentified: null,\n    };\n    const enrichOptions = {\n      secrets: context.owner,\n      rollData,\n      relativeTo: this.actor,\n    };\n\n    const noDesc = \"<p class='placeholder'>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n\n    const pIdentDesc = description ? ffd20.utils.enrichHTMLUnrolled(description, enrichOptions) : Promise.resolve();\n    pIdentDesc.then((html) => (context.descriptionHTML.identified = html || noDesc));\n    const unidentDesc = system.description?.unidentified;\n    const pUnidentDesc = unidentDesc ? ffd20.utils.enrichHTMLUnrolled(unidentDesc, enrichOptions) : Promise.resolve();\n    pUnidentDesc.then((html) => (context.descriptionHTML.unidentified = html || noDesc));\n    const pTopDesc = topDescription ? TextEditor.enrichHTML(topDescription, enrichOptions) : Promise.resolve();\n    pTopDesc.then((html) => (context.topDescription = html));\n    const instrDesc = system.description?.instructions;\n    const pInstrDesc = instrDesc ? ffd20.utils.enrichHTMLUnrolled(instrDesc, enrichOptions) : Promise.resolve();\n    pInstrDesc.then((html) => (context.descriptionHTML.instructions = html));\n\n    // Add script calls\n    const pScripts = this._prepareScriptCalls(context);\n\n    // Add links\n    const pLinks = await this._prepareLinks(context);\n\n    await Promise.all([pIdentDesc, pUnidentDesc, pTopDesc, pInstrDesc, pScripts, pLinks]);\n\n    if (this.constructor.EDIT_TRACKING?.length)\n      context._editorState = ffd20.applications.utils.restoreEditState(this, context);\n\n    return context;\n  }\n\n  _prepareContentSource(context) {\n    const sources = this._getContentSources();\n    if (sources.length == 0) return;\n\n    const main = this._selectContentSource(sources);\n\n    context.bookSources = {\n      all: sources,\n      main,\n    };\n\n    if (sources.length > 1) {\n      context.bookSources.extras = sources.filter((s) => s !== main);\n    }\n  }\n\n  _selectContentSource(sources) {\n    if (sources?.length === 0) return null;\n\n    sources.sort((a, b) => b.datestamp - a.datestamp);\n\n    return sources[0];\n  }\n\n  _getContentSources() {\n    const sources = this.item.system.sources ?? [];\n\n    return sources.map((source) => {\n      const registry = ffd20.registry.sources.get(source?.id) ?? {};\n      const { publisher, date, abbr, name, edition, url } = registry;\n\n      return {\n        publisher,\n        date,\n        abbr,\n        name,\n        edition,\n        url,\n        ...source,\n        title: source.title || registry.name,\n        registry,\n        datestamp: Date.parse(source.date || registry.date),\n      };\n    });\n  }\n\n  _prepareMaterialsAndAddons(item) {\n    const materialList = {};\n    const addonList = [];\n    const basicList = {};\n\n    for (const material of ffd20.utils.naturalSort([...ffd20.registry.materials], \"name\")) {\n      if (material.basic) {\n        // Filter basic materials\n        basicList[material.id] = material.name;\n      } else {\n        const isAllowed = material.isAllowed(item);\n        if (!isAllowed) continue;\n\n        if (!material.addon) {\n          materialList[material.id] = material.name;\n        } else {\n          addonList.push({ key: material.id, name: material.name });\n        }\n      }\n    }\n\n    return {\n      materials: materialList,\n      addons: addonList,\n      basics: basicList,\n    };\n  }\n\n  _prepareAlignments(alignments) {\n    const alignmentChoices = {};\n\n    Object.keys(ffd20.config.damageResistances).forEach((dType) => {\n      if (![\"magic\", \"epic\"].includes(dType)) alignmentChoices[dType] = ffd20.config.damageResistances[dType];\n    });\n\n    return {\n      choices: alignmentChoices,\n      values: foundry.utils.deepClone(alignments),\n    };\n  }\n\n  async _prepareLinks(context) {\n    context.links = {\n      list: [],\n    };\n\n    // Add charges link type\n    if ([\"feat\", \"consumable\", \"attack\", \"equipment\"].includes(this.item.type)) {\n      context.links.list.push({\n        id: \"charges\",\n        label: game.i18n.localize(\"FFD20.LinkTypeCharges\"),\n        help: game.i18n.localize(\"FFD20.LinkHelpCharges\"),\n        items: [],\n      });\n    }\n\n    // Add class associations\n    if (context.isClass) {\n      context.links.list.push({\n        id: \"classAssociations\",\n        label: game.i18n.localize(\"FFD20.LinkTypeClassAssociations\"),\n        help: game.i18n.localize(\"FFD20.LinkHelpClassAssociations\"),\n        fields: {\n          level: {\n            type: \"Number\",\n            label: game.i18n.localize(\"FFD20.Level\"),\n          },\n        },\n        items: [],\n      });\n    }\n\n    // Add children link type\n    context.links.list.push({\n      id: \"children\",\n      label: game.i18n.localize(\"FFD20.LinkTypeChildren\"),\n      help: game.i18n.localize(\"FFD20.LinkHelpChildren\"),\n      items: [],\n    });\n\n    context.links.list.push({\n      id: \"supplements\",\n      label: game.i18n.localize(\"FFD20.LinkTypeSupplements\"),\n      help: game.i18n.localize(\"FFD20.LinkHelpSupplements\"),\n      fields: {\n        /*\n        // TODO: Add child link creation toggle\n        asChild: {\n          type: \"Boolean\",\n          label: game.i18n.localize(\"FFD20.AsChild\"),\n        },\n        */\n      },\n      items: [],\n    });\n\n    // Post process data\n    const item = this.item,\n      actor = item.actor;\n    for (const links of context.links.list) {\n      const items = item.system.links?.[links.id] || [];\n      for (let index = 0; index < items.length; index++) {\n        const linkData = foundry.utils.deepClone(items[index]);\n        linkData.index = index; // Record index so sorted lists maintain data cohesion\n\n        const linkedItem = ffd20.utils.internal.fromUuid(linkData.uuid, actor);\n        if (!linkedItem) linkData.broken = true;\n        linkData.img = linkedItem?.img || Item.implementation.getDefaultArtwork(linkedItem);\n\n        // Fill in name if it's not in the local data\n        linkData.name ||= linkedItem?.name;\n\n        // Add item to stack\n        links.items.push(linkData);\n      }\n    }\n  }\n\n  _prepareItemFlags(context) {\n    const flags = context.system.flags ?? {};\n    context.flags ??= {};\n    context.flags.boolean = flags.boolean ?? {};\n    context.flags.dictionary = flags.dictionary ?? {};\n  }\n\n  async _prepareScriptCalls(context) {\n    context.scriptCalls = null;\n\n    const categories = ffd20.registry.scriptCalls.filter((category) => {\n      if (!category.itemTypes.includes(this.item.type)) return false;\n      return !(category.hidden === true && !game.user.isGM);\n    });\n    // Don't show the Script Calls section if there are no categories for this item type\n    if (!categories.length) return;\n\n    context.scriptCalls = {};\n\n    // Iterate over all script calls, and adjust data\n    const scriptCalls = this.item.scriptCalls ?? [];\n\n    // Create categories, and assign items to them\n    for (const { id, name, info } of categories) {\n      context.scriptCalls[id] = {\n        name,\n        tooltip: info,\n        items: scriptCalls.filter((sc) => sc.category === id && !sc.hide),\n        dataset: {\n          category: id,\n        },\n      };\n    }\n  }\n\n  /* -------------------------------------------- */\n  /*  Form Submission                             */\n  /* -------------------------------------------- */\n\n  /**\n   * Extend the parent class _updateObject method to ensure that damage ends up in an Array\n   *\n   * @protected\n   * @param event\n   * @param formData\n   */\n  async _updateObject(event, formData) {\n    formData = foundry.utils.expandObject(formData);\n\n    const oldData = this.item.toObject();\n    const system = formData.system;\n    const links = system.links;\n\n    if (links) {\n      const oldLinks = oldData.system?.links ?? {};\n      // Handle links arrays\n      for (const [linkType, typedLinks] of Object.entries(links)) {\n        if (Array.isArray(typedLinks)) continue; // Already handled by something else\n\n        // Maintain array and merge new data in\n        links[linkType] = foundry.utils.deepClone(oldLinks[linkType] ?? []);\n        for (const [index, linkData] of Object.entries(typedLinks)) {\n          links[linkType][index] = foundry.utils.mergeObject(links[linkType][index] ?? {}, linkData);\n        }\n      }\n    }\n\n    // Target for relative input handling\n    const targetName = event.target?.name;\n\n    // Handle relative input\n    function relativeInput(key, { min = -Infinity, max = Infinity, current, quantity = false, decimals = 0 } = {}) {\n      let value = foundry.utils.getProperty(system, key);\n      if (value === undefined) return null;\n\n      value = value.normalize(\"NFKD\");\n\n      // Not editing, unset value to prevent absurd changes\n      if (targetName !== `system.${key}`) {\n        foundry.utils.setProperty(system, key, undefined);\n        return null;\n      }\n\n      // Add or subtract values\n      let newValue;\n\n      // Relative input\n      if (value.match(/(\\+|-)([.\\d]+)/)) {\n        const operator = RegExp.$1;\n        let value = parseFloat(RegExp.$2);\n        if (operator === \"-\") value = -value;\n        current ??= foundry.utils.getProperty(oldData.system, key);\n        newValue = current + value;\n      }\n      // Exact value\n      else if (value.match(/^=?-?\\d+(\\.\\d+)?$/)) {\n        newValue = parseFloat(value.replace(/^=/, \"\"));\n      }\n      // Cleared\n      else if (value === \"\") {\n        newValue = 0;\n      }\n      // Reset on invalid value\n      else {\n        newValue = 0;\n        // Trigger warning for bad value\n        event.target.setCustomValidity(game.i18n.localize(\"FFD20.Warning.InvalidInput\"));\n      }\n\n      foundry.utils.setProperty(system, key, ffd20.utils.limitPrecision(Math.clamp(newValue, min, max), decimals));\n      return newValue;\n    }\n\n    if (this.item.isPhysical) {\n      // Ensure values are stored as lbs\n      if (system.weight) {\n        if (system.weight?.value !== undefined) {\n          const current = ffd20.utils.convertWeight(oldData.system.weight?.value ?? 0);\n          const value = relativeInput(\"weight.value\", { current, decimals: 2, quantity: true });\n          if (value === null) {\n            system.weight.value = undefined;\n          } else {\n            system.weight.value = ffd20.utils.convertWeightBack(system.weight.value / this.item.getWeightMultiplier());\n          }\n        }\n\n        if (system.weight?.reduction?.value !== undefined) {\n          const current = ffd20.utils.convertWeight(oldData.system.weight?.reduction?.value ?? 0);\n          const value = relativeInput(\"weight.reduction.value\", { min: 0, decimals: 2, current });\n          if (value === null) {\n            system.weight.reduction.value = undefined;\n          } else {\n            system.weight.reduction.value = ffd20.utils.convertWeightBack(system.weight.reduction.value);\n          }\n        }\n      }\n\n      // Relative input handling, which also cancels updates if no relative input happened.\n      // Avoids value drift caused by displayed value not agreeing with base value\n\n      // Change currencies with relative values\n      const relativeKeys = [\"currency.pp\", \"currency.gp\", \"currency.sp\", \"currency.cp\", \"quantity\"];\n      for (const key of relativeKeys) {\n        relativeInput(key, { min: 0 });\n      }\n\n      // Adjust with quantity\n      relativeInput(\"price\", { min: 0, quantity: true, decimals: 2 });\n      relativeInput(\"unidentified.price\", { min: 0, quantity: true, decimals: 2 });\n\n      // Adjust current and max HP relatively\n      relativeInput(\"hp.value\", { min: 0, current: this.item.system.hp?.value });\n      relativeInput(\"hp.base\", { min: 1 });\n      relativeInput(\"hardness\", { min: 0 });\n\n      relativeInput(\"weight.reduction.percent\", { min: 0, max: 100, decimals: 0 });\n\n      // Adjust current or max HP if adjusting the other would break logical constraints\n      const nHpVal = system.hp?.value;\n      const hpVal = nHpVal ?? oldData.system.hp?.value ?? 0;\n      const nHpBase = system.hp?.base;\n      const hpBase = Math.max(1, nHpBase ?? oldData.system.hp?.base ?? 1);\n\n      // Adjust only if the relevant field was edited\n      if (targetName === \"system.hp.value\") {\n        const realMax = this.item.system.hp?.max || 0;\n        if (Number.isFinite(nHpVal) && hpVal > realMax) {\n          foundry.utils.setProperty(system, \"hp.base\", hpBase + (hpVal - realMax));\n        }\n      }\n    }\n\n    // Adjust Material Addons\n    // The available addons can change depending in the chosen material,\n    // so we need to get the values to build the addons on the item.\n    const material = this.item.type === \"equipment\" ? system.armor?.material : system.material;\n    if (material?.addon) {\n      // Convert to array\n      material.addon = Object.entries(material.addon)\n        .filter(([_, chosen]) => chosen)\n        .map(([key]) => key);\n    }\n\n    // Validate max uses formula and set current uses to maximum if null\n    if (\n      formData.system.uses?.maxFormula &&\n      formData.system.uses?.maxFormula !== (this.item.system.uses?.maxFormula || \"\")\n    ) {\n      try {\n        const roll = new ffd20.dice.RollPF(formData.system.uses.maxFormula, this.item.getRollData()).evaluateSync();\n        formData.system.uses.value ??= roll.total;\n      } catch (err) {\n        console.error(\"Max charges formula is invalid:\", formData.system.uses?.maxFormula, \"\\n\", err);\n      }\n    }\n\n    // Update the Item\n    return super._updateObject(event, formData);\n  }\n\n  /* -------------------------------------------- */\n\n  _onHoverTooltip(event) {\n    const type = event.target.dataset.tooltipType;\n    const content = [];\n    switch (type) {\n      case \"weight\":\n        this._onHoverWeightTooltip(event, content);\n        break;\n      case \"price\":\n        this._onHoverPriceTooltip(event, content);\n        break;\n      case \"unidprice\":\n        this._onHoverPriceTooltip(event, content, false);\n        break;\n    }\n    return content.join(\"<br>\");\n  }\n\n  _onHoverWeightTooltip(event, content) {\n    const unit = game.i18n.localize(ffd20.utils.getWeightSystem() === \"metric\" ? \"FFD20.Kgs\" : \"FFD20.Lbs\");\n    const value = ffd20.utils.limitPrecision(this.item.system.weight.converted.value, 3);\n    // TODO: better i18n support\n    const mValue = `${value} ${unit}`;\n    content.push(game.i18n.format(\"FFD20.StackDetails.Base\", { value: mValue }));\n  }\n\n  _onHoverPriceTooltip(event, content, identified = true) {\n    let cp = this.item.getValue({\n      sellValue: 1,\n      single: true,\n      inLowestDenomination: true,\n      forceUnidentified: !identified,\n    });\n\n    cp = Math.floor(cp); // getValue() can return decimals\n\n    const c = ffd20.utils.currency.split(cp);\n    const inline = [];\n    for (const [key, rawValue] of Object.entries(c)) {\n      if (rawValue > 0) {\n        const value = ffd20.utils.limitPrecision(rawValue, 2);\n        inline.push(game.i18n.format(`FFD20.Currency.Inline.${key}`, { value }));\n      }\n    }\n\n    // Add base zero if no value\n    if (inline.length == 0) {\n      inline.push(game.i18n.format(`FFD20.Currency.Inline.${ffd20.config.currency.standard}`, { value: 0 }));\n    }\n\n    content.push(game.i18n.format(\"FFD20.StackDetails.Base\", { value: ffd20.utils.i18n.join(inline) }));\n  }\n\n  /**\n   * Validate input formula for basic errors.\n   *\n   * @internal\n   * @param {HTMLElement} el\n   */\n  async _validateFormula(el) {\n    const formula = el.value;\n    if (!formula) return;\n\n    let roll;\n    // Test if formula even works\n    try {\n      roll = Roll.create(formula || \"0\");\n      await roll.evaluate({ allowInteractive: false });\n    } catch (e) {\n      el.dataset.tooltip = e.message;\n      el.classList.add(\"invalid\");\n      el.setCustomValidity(e.message);\n      return;\n    }\n\n    // Formulas not meant for checks or other rolls must be deterministic\n    if (el.classList.contains(\"simple\")) {\n      if (!roll.isDeterministic || formula.includes(\"@\")) {\n        el.dataset.tooltip = \"FFD20.Warning.FormulaMustBeSimple\";\n        el.classList.add(\"invalid\");\n        el.setCustomValidity(game.i18n.localize(\"FFD20.Warning.FormulaMustBeSimple\"));\n      }\n    }\n    // TODO: Make this selection better\n    else if (!el.classList.contains(\"roll\")) {\n      if (!roll.isDeterministic) {\n        el.dataset.tooltip = \"FFD20.Warning.FormulaMustBeDeterministic\";\n        el.classList.add(\"invalid\");\n        el.setCustomValidity(game.i18n.localize(\"FFD20.Warning.FormulaMustBeDeterministic\"));\n      }\n    }\n  }\n\n  /**\n   * Activate listeners for interactive item sheet events\n   *\n   * @param {JQuery<HTMLElement>} html\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    const hasActor = !!this.actor;\n\n    if (this.item.isPhysical) {\n      html.find(\".details-tooltip\").each((i, el) => {\n        el.addEventListener(\n          \"pointermove\",\n          (ev) => {\n            const content = this._onHoverTooltip(ev);\n            if (content) {\n              game.tooltip.activate(el, {\n                text: content,\n                direction: TooltipManager.TOOLTIP_DIRECTIONS.RIGHT,\n                cssClass: \"ffd20\",\n              });\n            }\n          },\n          { passive: true }\n        );\n        el.addEventListener(\"pointerleave\", (ev) => game.tooltip.deactivate(), { passive: true });\n      });\n    }\n\n    // Action interactions\n    html\n      .find(\".actions .item-list .item .item-name\")\n      // Edit action\n      .on(\"contextmenu\", this._onActionEdit.bind(this))\n      // Action summaries\n      .on(\"click\", this._onActionSummary.bind(this));\n\n    // Action control\n    html.find(\".actions .action-controls a\").on(\"click\", this._onActionControl.bind(this));\n\n    // Instructions control\n    html.find(\".tab.description .instructions .controls a.html-editor\").on(\"click\", this._onOpenTextEditor.bind(this));\n\n    // Open help browser\n    html.find(\"a.help-browser[data-url]\").click(this._openHelpBrowser.bind(this));\n\n    // Open entry/trait editor/viewer\n    html.find(\".entry-selector\").on(\"click\", this._onEntrySelector.bind(this));\n    html.find(\".trait-selector\").on(\"click\", this._onTraitSelector.bind(this));\n    html.find(\".flag-selector\").on(\"click\", this._onFlagSelector.bind(this));\n\n    // Content source editor\n    html\n      .find(\".content-source .control a.edit\")\n      .click(() => ffd20.applications.ContentSourceEditor.open(this.item, { editable: this.isEditable }));\n\n    // Mark proficiency in indeterminate state if not forced but actor has it.\n    if (\n      hasActor &&\n      this.item.system.proficient !== true &&\n      [\"weapon\", \"equipment\", \"attack\"].includes(this.item.type)\n    ) {\n      if (this.item.isProficient) {\n        const proficiency = html.find(\"input[name='system.proficient']\")[0];\n        if (proficiency) proficiency.indeterminate = true;\n      }\n    }\n\n    // Mark broken in indeterminate state if it's automatically designated broken but not explicitly\n    if (this.item.isPhysical) {\n      if (this.item.isBroken && this.item.system.broken !== true) {\n        const broken = html.find(\"input[name='system.broken']\")[0];\n        if (broken) {\n          broken.indeterminate = true;\n          broken.dataset.tooltip = \"FFD20.AutoBroken\";\n        }\n      }\n    }\n\n    // Allow editing and viewing visible scripts\n    html.find(\".script-calls .item-list .item\").contextmenu(this._onScriptCallEdit.bind(this));\n    html.find(\".script-calls .item-control\").click(this._onScriptCallControl.bind(this));\n\n    // Add warning about formulas\n    html.find(\"input.formula\").each(async (_, el) => this._validateFormula(el));\n\n    // Linked item clicks\n    html\n      .find(\".tab[data-tab='links'] .links-item .item-name .source-item\")\n      .on(\"click\", this._openLinkedItem.bind(this));\n\n    html.find('a[data-action=\"browse\"]').click(this._onOpenCompendiumBrowser.bind(this));\n\n    // Modify note changes\n    html.find(\".context-note-control\").click(this._onNoteControl.bind(this));\n    html.find(\".context-note .context-note-target\").click(this._onNoteTargetControl.bind(this));\n\n    // Create new change\n    html.find(\".tab.changes .controls a.add-change\").click(this._onCreateChange.bind(this));\n\n    // Effect notes and footnotes\n    html.find(\".card-notes .controls a\").click(this._onCardNoteControl.bind(this));\n\n    // Link control\n    html.find(\".link-control\").click(this._onLinkControl.bind(this));\n\n    // Everything below here is only needed if the sheet is editable\n    if (!this.isEditable) {\n      html.find(\"span.text-box\").addClass(\"readonly\");\n      return;\n    }\n\n    // Add drop handler to textareas and text inputs\n    html.find(\"textarea, input[type='text']\").on(\"drop\", this._onTextAreaDrop.bind(this));\n\n    // Changes\n    html[0].querySelectorAll(\".tab.changes .changes .change[data-change-id]\").forEach((el) => {\n      // Sticky tooltip controls\n      el.querySelector(\".controls a.menu\").addEventListener(\"pointerenter\", this._onOpenChangeMenu.bind(this), {\n        passive: true,\n      });\n      // Right click open change editor\n      el.addEventListener(\"contextmenu\", this._onEditChange.bind(this));\n    });\n\n    // Create attack\n    if ([\"weapon\"].includes(this.item.type)) {\n      html.find(\"button[name='create-attack']\").click(this._createAttack.bind(this));\n    }\n\n    // Create spellbook\n    if (this.item.type === \"class\") {\n      html.find(\"button[name='create-spellbook']\").click(this._createSpellbook.bind(this));\n    }\n\n    // Listen to field entries\n    html.find(\".item-selector\").click(this._onItemSelector.bind(this));\n\n    // Click to change text input\n    html.find('*[data-action=\"input-text\"]').click((event) => this._onInputText(event));\n\n    // Select the whole text on click\n    html.find(\".select-on-click\").click(this._selectOnClick.bind(this));\n\n    html.find(\".speed-editor\").click(this._onSpeedEdit.bind(this));\n\n    /* -------------------------------------------- */\n    /*  Actions\n    /* -------------------------------------------- */\n\n    // Modify action charges\n    html\n      .find(\".action-parts .item-uses span.text-box.value\")\n      .on(\"wheel\", this._setActionUses.bind(this))\n      .on(\"click\", (event) => {\n        this._onSpanTextInput(event, this._setActionUses.bind(this));\n      });\n\n    // Open charge source with right click\n    html.find(\".item-link[data-item-id]\").on(\"contextmenu\", (event) => {\n      event.preventDefault();\n      const itemId = event.currentTarget.dataset.itemId;\n      const item = this.actor.items.get(itemId);\n      item?.sheet.render(true, { focus: true });\n    });\n\n    /* -------------------------------------------- */\n    /*  Script Calls\n    /* -------------------------------------------- */\n\n    html.find(\".script-calls .item-list[data-category]\").on(\"drop\", this._onScriptCallDrop.bind(this));\n  }\n\n  _onSpanTextInput(event, callback = null) {\n    const el = event.currentTarget;\n    const parent = el.parentElement;\n\n    // Replace span element with an input (text) element\n    const newEl = document.createElement(`INPUT`);\n    newEl.type = \"text\";\n    if (el.dataset?.dtype) newEl.dataset.dtype = el.dataset.dtype;\n\n    // Set value of new input element\n    let prevValue = el.innerText;\n    if (el.classList.contains(\"placeholder\")) prevValue = \"\";\n\n    const noCap = el.classList.contains(\"no-value-cap\");\n\n    const name = el.getAttribute(\"name\");\n    let maxValue;\n    if (name) {\n      newEl.setAttribute(\"name\", name);\n      prevValue = foundry.utils.getProperty(this.item, name) ?? \"\";\n      if (typeof prevValue !== \"string\") prevValue = prevValue.toString();\n\n      if (name.endsWith(\".value\") && !noCap) {\n        const maxName = name.replace(/\\.value$/, \".max\");\n        maxValue = foundry.utils.getProperty(this.item, maxName);\n      }\n    }\n    newEl.value = prevValue;\n\n    // Toggle classes\n    const forbiddenClasses = [\"placeholder\", \"direct\", \"allow-relative\"];\n    for (const cls of el.classList) {\n      if (!forbiddenClasses.includes(cls)) newEl.classList.add(cls);\n    }\n\n    // Replace span with input element\n    const allowRelative = el.classList.contains(\"allow-relative\"),\n      clearValue = parseFloat(el.dataset.clearValue || \"0\");\n    parent.replaceChild(newEl, el);\n    let changed = false;\n    newEl.addEventListener(\"keypress\", (event) => {\n      if (event.key !== \"Enter\") return;\n      changed = true;\n      if (allowRelative) {\n        const number = ffd20.utils.internal.adjustNumberByStringCommand(\n          parseFloat(prevValue),\n          newEl.value,\n          maxValue,\n          clearValue\n        );\n        newEl.value = number;\n      }\n\n      if (newEl.value.toString() === prevValue.toString()) {\n        this.render();\n      } else if (typeof callback === \"function\") {\n        callback(event);\n      }\n    });\n    newEl.addEventListener(\"focusout\", (event) => {\n      if (!changed) {\n        changed = true;\n        if (allowRelative && parseFloat(prevValue) !== parseFloat(newEl.value)) {\n          const number = ffd20.utils.internal.adjustNumberByStringCommand(\n            parseFloat(prevValue),\n            newEl.value,\n            maxValue,\n            clearValue\n          );\n          newEl.value = number;\n        }\n\n        if (newEl.value.toString() === prevValue.toString()) {\n          this.render();\n        } else if (typeof callback === \"function\") {\n          callback(event);\n        }\n      }\n    });\n\n    // Select text inside new element\n    newEl.focus();\n    newEl.select();\n  }\n\n  _mouseWheelAdd(event, el) {\n    const isInput = el.tagName === \"INPUT\";\n    const { originalEvent } = event;\n\n    if (originalEvent && originalEvent instanceof WheelEvent && originalEvent.ctrlKey) {\n      event.preventDefault();\n      const value = (isInput ? parseFloat(el.value) : parseFloat(el.innerText)) || 0;\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(originalEvent.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n\n      if (isInput) {\n        el.value = value + amount * increase;\n      } else {\n        el.innerText = (value + amount * increase).toString();\n      }\n    }\n  }\n\n  _setActionUses(event) {\n    if (!(event.originalEvent instanceof MouseEvent)) event.preventDefault();\n    const el = event.currentTarget;\n    const actionId = el.closest(\".item[data-action-id]\").dataset.actionId;\n    const action = this.item.actions.get(actionId);\n\n    this._mouseWheelAdd(event, el);\n\n    const value = el.tagName === \"INPUT\" ? Number(el.value) : Number(el.innerText);\n    this.setActionUpdate(action.id, \"uses.self.value\", value);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", () => this._updateActions(), { passive: true, once: true });\n    } else this._updateActions();\n  }\n\n  setActionUpdate(id, key, value) {\n    let obj = this._actionUpdates.find((o) => o._id === id);\n    if (!obj) {\n      obj = { _id: id };\n      this._actionUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  async _updateActions() {\n    const updates = this._actionUpdates;\n    this._actionUpdates = [];\n\n    // Memorize variables in document\n    for (const d of updates) {\n      const action = this.item.actions.get(d._id);\n      if (!action) {\n        console.error(\"Item update for non-existing item:\", d._id, d);\n        continue;\n      }\n      await action.update(d);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  _onOpenCompendiumBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const category = a.dataset.category;\n\n    ffd20.applications.compendiums[category].render(true, { focus: true });\n  }\n\n  async _onScriptCallControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const script = this.item.scriptCalls ? this.item.scriptCalls.get(a.closest(\".item\")?.dataset.itemId) : null;\n    const group = a.closest(\".item-list\");\n    const category = group.dataset.category;\n\n    // Create item\n    if (a.classList.contains(\"item-create\")) {\n      await this._onSubmit(event, { preventRender: true });\n      const newScripts = await ffd20.components.ItemScriptCall.create([{ category, type: \"script\" }], {\n        parent: this.item,\n      });\n      newScripts?.forEach((script) => script.edit());\n      return;\n    }\n    // Delete item\n    else if (script && a.classList.contains(\"item-delete\")) {\n      const list = (this.item.system.scriptCalls || []).filter((o) => o._id !== script.id);\n      const updateData = { \"system.scriptCalls\": list };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n    // Edit item\n    else if (script && a.classList.contains(\"item-edit\")) {\n      script.edit();\n    }\n    // Toggle hidden\n    else if (script && a.classList.contains(\"item-hide\")) {\n      await this._onSubmit(event, { preventRender: true });\n      script.update({ hidden: !script.hidden });\n    }\n  }\n\n  _onScriptCallEdit(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    /** @type {ffd20.components.ItemScriptCall} */\n    const script = this.item.scriptCalls?.get(el.dataset.itemId);\n    script?.edit({ editable: this.isEditable });\n  }\n\n  /**\n   * Handle dropping content-linkable data to `<textarea>` or text `<input>`\n   *\n   * @internal\n   * @param {DragEvent} event\n   */\n  async _onTextAreaDrop(event) {\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const elem = event.currentTarget;\n    if (elem.disabled || elem.readOnly) return;\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    const link = await TextEditor.getContentLink(eventData, { relativeTo: this.actor });\n    if (!link) return void ui.notifications.warn(\"FFD20.Error.InvalidContentLinkDrop\", { localize: true });\n\n    // Insert link\n    // TODO: Replace painted text if any\n    elem.value = !elem.value ? link : elem.value + \"\\n\" + link;\n\n    return this._onSubmit(event); // Save\n  }\n\n  async _onScriptCallDrop(event) {\n    event.preventDefault();\n\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const { uuid, type } = eventData;\n    if (type !== \"Macro\") return;\n\n    // Submit data\n    if (uuid) {\n      await this._onSubmit(event, { preventRender: true });\n\n      const elem = event.currentTarget;\n      const category = elem.dataset.category;\n\n      return ffd20.components.ItemScriptCall.create([{ type: \"macro\", value: uuid, category, name: \"\", img: \"\" }], {\n        parent: this.item,\n      });\n    }\n  }\n\n  _openHelpBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    ffd20.applications.helpBrowser.openUrl(a.dataset.url);\n  }\n\n  /**\n   * By default, returns true only for GM\n   *\n   * @override\n   */\n  _canDragStart(selector) {\n    return true;\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {DragEvent} event\n   */\n  _onDragStart(event) {\n    const elem = event.target;\n\n    // Drag action\n    const actionId = elem.dataset.actionId;\n    if (actionId) {\n      /** @type {ffd20.components.ItemAction} */\n      const action = this.item.actions.get(actionId);\n      const obj = { type: \"pf1Action\", uuid: action.uuid, actionId: action.id, data: action.toObject() };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(obj));\n      return;\n    }\n\n    // Drag Change\n    const changeId = elem.dataset.changeId;\n    if (changeId) {\n      /** @type {ffd20.components.ItemChange} */\n      const ch = this.item.changes.get(changeId);\n      const obj = { type: \"pf1Change\", data: ch.toObject(), changeId, uuid: ch.uuid };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(obj));\n      return;\n    }\n\n    // Drag link\n    if (elem.matches(\".links-item .item-name\")) {\n      const el = elem.closest(\"[data-uuid]\");\n      const type = el.closest(\"[data-tab]\")?.dataset.tab;\n      const uuid = ffd20.utils.internal.uniformUuid(el.dataset.uuid, this.actor);\n      const index = Number(el.dataset.index);\n      const link = this.item.system.links?.[type]?.[index];\n      const obj = { type: \"Item\", uuid, pf1Link: {} };\n      if (link) obj.pf1Link.level = link.level;\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(obj));\n      return;\n    }\n  }\n\n  /**\n   * Allow non-GM to drag&drop actions and items (for containers) to this sheet.\n   *\n   * @override\n   * @protected\n   */\n  _canDragDrop() {\n    return this.isEditable;\n  }\n\n  /**\n   * @internal\n   * @param {DragEvent} event\n   */\n  async _onDrop(event) {\n    if (!this.isEditable) return;\n\n    event.preventDefault();\n    event.stopPropagation();\n\n    const dropData = TextEditor.getDragEventData(event);\n    const { type, uuid } = dropData;\n    if (!type) return; // Weird drop, just bail out on it\n\n    /** @type {ItemPF} */\n    const item = this.item;\n\n    const srcDoc = uuid ? await fromUuid(uuid) : null;\n\n    switch (type) {\n      // Handle actions\n      case \"pf1Action\": {\n        let actionData;\n\n        /** @type {ffd20.components.ItemAction} */\n        let parentItem;\n        // @deprecated\n        if (srcDoc instanceof Item) {\n          foundry.utils.logCompatibilityWarning(\n            \"ItemSheetPF drop handler accepting Actions with UUID pointing to the Item is deprecated, please provide UUID to the Action itself\",\n            {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            }\n          );\n          actionData = dropData.data;\n          parentItem = srcDoc;\n        }\n        // New functionality\n        else {\n          actionData = srcDoc.toObject();\n          parentItem = srcDoc.item;\n        }\n\n        const actionId = actionData._id || dropData.actionId;\n\n        this.activateTab(\"details\", \"primary\");\n\n        // Re-order\n        if (parentItem === item) {\n          const targetActionId = event.target.closest(\".item[data-action-id]\")?.dataset.actionId;\n          if (!targetActionId) return void console.debug(\"Action dropped at an indeterminate location; ignoring\");\n\n          // Dropped onto self, ignore.\n          if (targetActionId === actionId) return void console.debug(`Action [${uuid}] dropped onto itself; ignoring`);\n\n          /** @type {object[]} */\n          const prevActions = item.toObject().system.actions ?? [];\n\n          let targetIdx;\n          if (!targetActionId) targetIdx = prevActions.length - 1;\n          else targetIdx = prevActions.indexOf(prevActions.find((o) => o._id === targetActionId));\n          const srcIdx = prevActions.indexOf(prevActions.find((o) => o._id === actionId));\n\n          const [actionData] = prevActions.splice(srcIdx, 1);\n          prevActions.splice(targetIdx, 0, actionData);\n\n          await this.item.update({ \"system.actions\": prevActions });\n        }\n        // Add to another item\n        else {\n          delete actionData._id;\n          return ffd20.components.ItemAction.create([actionData], { parent: this.item });\n        }\n        break;\n      }\n\n      case \"pf1Change\": {\n        return this._onChangeDrop(event, dropData);\n      }\n\n      case \"Item\": {\n        // Add drop handler to link tabs\n        const linksTab = event.target.closest(\".tab.links .tab[data-group='links']\");\n        if (linksTab) this._onLinksDrop(event, dropData);\n        break;\n      }\n      case \"pf1ContentSourceEntry\": {\n        const src = dropData.data;\n        const origin = await fromUuid(dropData.uuid);\n        if (!origin) return;\n        if (origin === this.item) return; // From same item\n\n        const sources = this.item.toObject().system.sources ?? [];\n\n        // Disallow same ID source copy\n        if (src.id && sources.some((osrc) => (src.id ? osrc.id === src.id : osrc.title === src.title))) {\n          ui.notifications.warn(\"FFD20.ContentSource.Errors.DuplicateID\", { localize: true });\n          return;\n        }\n\n        sources.push(src);\n        await this.item.update({ \"system.sources\": sources });\n        if (!event.shiftKey) {\n          ffd20.applications.ContentSourceEditor.open(this.item);\n          // TODO: Activate desired tab.\n        }\n        break;\n      }\n      default:\n        ui.notifications.warn(game.i18n.format(\"FFD20.Warning.InvalidItemSheetDrop\", { type }));\n        break;\n    }\n  }\n\n  async _onLinksDrop(event, data) {\n    const elem = event.target;\n    const category = elem.closest(\"[data-tab]\").dataset.tab;\n\n    // Try to extract the data\n    if (!data.type) throw new Error(\"Invalid drop data received\");\n\n    const targetItem = await fromUuid(data.uuid);\n    if (!targetItem || !(targetItem instanceof Item))\n      throw new Error(`UUID did not resolve to valid item: ${data.uuid}`);\n\n    // Add extra data\n    const extraData = {};\n    switch (category) {\n      case \"classAssociations\": {\n        const level = data.pf1Link?.level;\n        if (Number.isNumeric(level)) extraData.level = level;\n        break;\n      }\n    }\n\n    await this.item.createItemLink(category, targetItem, extraData);\n  }\n\n  /**\n   * Handle {@link ffd20.components.ItemChange} drop events.\n   *\n   * @internal\n   * @param {DragEvent} event - The originating drop event\n   * @param {object} data - The data extracted from the drop event\n   * @returns {Promise<void>}\n   */\n  async _onChangeDrop(event, data) {\n    const item = this.item;\n    const srcDoc = data.uuid ? await fromUuid(data.uuid) : null;\n    let chData;\n\n    /** @type {ItemPF} */\n    let parentItem;\n    // @deprecated\n    if (srcDoc instanceof Item) {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemSheetPF drop handler accepting Changes with UUID pointing to the Item is deprecated, please provide UUID to the Change itself\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      chData = data.data;\n      parentItem = srcDoc;\n    }\n    // New functionality\n    else {\n      chData = srcDoc.toObject();\n      parentItem = srcDoc.parent;\n    }\n\n    const changeId = chData._id || data.changeId;\n\n    this.activateTab(\"changes\", \"primary\");\n\n    // Sort in same item\n    if (parentItem === item) {\n      const targetChangeId = event.target.closest(\".change[data-change-id]\")?.dataset.changeId;\n      if (!targetChangeId) return void console.debug(\"Change dropped at an indeterminate location; ignoring\");\n\n      // Dropped onto self, ignore.\n      if (changeId === targetChangeId) return void console.debug(`Change [${data.uuid}] dropped onto itself; ignoring`);\n\n      // Re-arrange\n      /** @type {Array<object>} */\n      const changes = item.toObject().system.changes ?? [];\n      const removed = changes.findSplice((c) => c._id === changeId);\n      if (!removed) return;\n      const idx = changes.findIndex((c) => c._id === targetChangeId);\n      if (idx >= 0) {\n        changes.splice(idx, 0, removed);\n        return item.update({ \"system.changes\": changes });\n      }\n    }\n    // Duplicate\n    else {\n      delete chData._id;\n      return ffd20.components.ItemChange.create([chData], { parent: item });\n    }\n  }\n\n  /**\n   * Handle spawning the ActorTraitSelector application which allows a checkbox of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onTraitSelector(event) {\n    event.preventDefault();\n\n    if (!this.isEditable) return;\n\n    const a = event.currentTarget;\n    const options = {\n      name: a.dataset.for,\n      title: game.i18n.localize(a.dataset.title),\n      subject: a.dataset.options,\n      choices: ffd20.config[a.dataset.options],\n      hasCustom: a.dataset.hasCustom !== \"false\",\n    };\n\n    switch (a.dataset.options) {\n      case \"conditions\": {\n        options.choices = ffd20.registry.conditions.getLabels();\n        break;\n      }\n      case \"multischool\": {\n        const school = a.dataset.school;\n        const subs = new Set([...ffd20.config.spellMultischoolsMap[school], ...this.item.system.multischool.value]);\n        const choices = subs.reduce((acc, curr) => ({ ...acc, [curr]: ffd20.config.spellMultischools[curr] }), {});\n        options.choices = choices;\n        break;\n      }\n      case \"subschool\": {\n        const school = a.dataset.school;\n        const subs = new Set([...ffd20.config.spellSubschoolsMap[school], ...this.item.system.subschool.value]);\n        const choices = subs.reduce((acc, curr) => ({ ...acc, [curr]: ffd20.config.spellSubschools[curr] }), {});\n        options.choices = choices;\n        break;\n      }\n    }\n\n    new ActorTraitSelector({\n      ...options,\n      document: this.item,\n    }).render(true);\n  }\n\n  /**\n   * Handle spawning the FlagSelector application which allows a checkbox of multiple trait options\n   *\n   * @param {Event} event   The click event which originated the selection\n   * @private\n   */\n  _onFlagSelector(event) {\n    event.preventDefault();\n\n    if (!this.isEditable) return;\n\n    const a = event.currentTarget;\n    const options = {\n      name: a.dataset.for,\n      title: game.i18n.localize(a.dataset.title),\n      subject: a.dataset.options,\n      choices: ffd20.config[a.dataset.options],\n    };\n\n    new FlagSelector({\n      ...options,\n      document: this.item,\n    }).render(true);\n  }\n\n  _onSpeedEdit(event) {\n    event.preventDefault();\n\n    const app = Object.values(ui.windows).find((o) => {\n      return o instanceof SpeedEditor && o.document === this.item;\n    });\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else new SpeedEditor({ document: this.item }).render({ force: true });\n  }\n\n  /**\n   * Toggle inline display of an item's summary/description by expanding or hiding info div\n   *\n   * @protected\n   * @param {JQuery.ClickEvent<HTMLElement>} event - The click event on the item\n   */\n  async _onActionSummary(event) {\n    event.preventDefault();\n\n    const li = event.target.closest(\".item[data-action-id]\");\n    // Check whether pseudo-item belongs to another collection\n    const action = this.item.actions.get(li.dataset.actionId);\n\n    const rollData = action.getRollData();\n\n    // For actions (embedded into a parent item), show only the action's summary instead of a complete one\n    const { actionDescription, properties } = await action.getChatData({ chatcard: false, rollData });\n\n    // Toggle summary\n    if (li.classList.contains(\"expanded\")) {\n      const summary = li.querySelector(\".item-summary\");\n      $(summary).slideUp(200, () => summary.remove());\n    } else {\n      const templateData = {\n        description: actionDescription,\n        properties,\n      };\n      let content = await renderTemplate(\"systems/ffd20/templates/items/parts/item-action-summary.hbs\", templateData);\n      content = await ffd20.utils.enrichHTMLUnrolled(content, { rollData, secrets: this.item.isOwner });\n\n      const div = $(content);\n      div.hide();\n      li.append(...div);\n      div.slideDown(200);\n    }\n    li.classList.toggle(\"expanded\");\n  }\n\n  /**\n   * Open linked item sheet.\n   *\n   * @param {Event} event\n   */\n  async _openLinkedItem(event) {\n    event.preventDefault();\n    const el = event.target.closest(\".links-item[data-uuid],.links-item[data-item-id]\");\n    const { uuid } = el.dataset;\n\n    const item = await fromUuid(uuid, { relative: this.actor });\n    item.sheet.render(true, { focus: true });\n  }\n\n  async _onActionControl(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const a = event.currentTarget;\n\n    const getUniqueActionName = (baseName) => {\n      baseName = baseName.replace(/\\s*\\(\\d+\\)$/, \"\"); // Strip existing number\n      let name = baseName;\n      const names = new Set(this.item.actions?.map((act) => act.name) ?? []);\n      let iter = 1;\n      // Find unique name\n      while (names.has(name)) name = `${baseName} (${iter++})`;\n      return name;\n    };\n\n    // Edit action\n    if (a.classList.contains(\"edit-action\")) {\n      return this._onActionEdit(event);\n    }\n    // Add action\n    else if (a.classList.contains(\"add-action\")) {\n      await this._onSubmit(event, { preventRender: true });\n\n      const baseName = [\"weapon\", \"attack\"].includes(this.item.type)\n        ? game.i18n.localize(\"FFD20.Attack\")\n        : game.i18n.localize(\"FFD20.Use\");\n\n      const newActionData = {\n        name: getUniqueActionName(baseName),\n      };\n\n      const newActions = await ffd20.components.ItemAction.create([newActionData], { parent: this.item });\n      newActions.forEach((action) => action.sheet.render(true));\n      return;\n    }\n    // Remove action\n    else if (a.classList.contains(\"delete-action\")) {\n      const li = a.closest(\".item[data-action-id]\");\n      const action = this.item.actions.get(li.dataset.actionId);\n\n      const confirmed = getSkipActionPrompt()\n        ? true\n        : await foundry.applications.api.DialogV2.confirm({\n            window: { title: game.i18n.format(\"FFD20.DeleteActionTitle\", { name: action.name }) },\n            classes: [\"pf1-v2\", \"delete-action\"],\n            content: `<p>${game.i18n.format(\"FFD20.DeleteActionConfirmation\", { name: this.item.name })}</p>`,\n            rejectClose: false,\n            modal: true, // Require dialog to be resolved\n          });\n\n      if (confirmed === true) {\n        await this._onSubmit(event, { preventRender: true });\n        action.delete();\n      }\n    }\n    // Duplicate action\n    else if (a.classList.contains(\"duplicate-action\")) {\n      const li = a.closest(\".item[data-action-id]\");\n      const actions = this.item.toObject().system.actions ?? [];\n      const action = foundry.utils.deepClone(actions.find((act) => act._id === li.dataset.actionId) ?? {});\n      action.name = getUniqueActionName(action.name);\n      action._id = foundry.utils.randomID(16);\n      actions.push(action);\n      const updateData = { \"system.actions\": actions };\n      await this._updateObject(event, this._getSubmitData(updateData));\n      this.item.actions.get(action._id)?.sheet.render(true);\n    }\n  }\n\n  async _onActionEdit(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const li = event.target.closest(\".item[data-action-id]\");\n    this.item.actions.get(li.dataset.actionId).sheet.render(true);\n  }\n\n  /**\n   * @internal\n   * @param {Event} event\n   */\n  async _onOpenTextEditor(event) {\n    event.preventDefault();\n\n    if (!this.isEditable) throw new Error(\"Document is not editable!\");\n\n    const app = new ffd20.applications.HTMLEditor({\n      document: this.item,\n      path: event.target.dataset.path,\n      window: { title: `${game.i18n.localize(\"FFD20.Instructions\")} â ${this.item.name}` },\n    });\n\n    app.render(true);\n  }\n\n  async _onOpenChangeMenu(event) {\n    const el = event.target;\n\n    const changeId = el.dataset.changeId;\n    if (!changeId) return;\n\n    const content = document.createElement(\"div\");\n    content.innerHTML = await renderTemplate(\"systems/ffd20/templates/items/parts/item-change-tooltip.hbs\", { changeId });\n\n    content.querySelector(\".duplicate\").addEventListener(\"click\", (ev) => this._onDuplicateChange(ev, el));\n    content.querySelector(\".delete\").addEventListener(\"click\", (ev) => this._onDeleteChange(ev, el));\n    content.querySelector(\".edit\").addEventListener(\"click\", (ev) => this._onEditChange(ev, el, true));\n\n    if (!document.querySelector(`.locked-tooltip.ffd20.change-${changeId}`)) {\n      await game.tooltip.activate(el, {\n        content,\n        locked: true,\n        direction: TooltipManager.TOOLTIP_DIRECTIONS.LEFT,\n        cssClass: \"ffd20 change-menu change-\" + changeId,\n      });\n    }\n  }\n\n  /**\n   * @internal\n   * @param {Event} event - Click event\n   * @param {boolean} [tooltip] - Is this event from locked tooltip?\n   */\n  _onEditChange(event, tooltip = false) {\n    event.preventDefault();\n    const el = event.target;\n    const changeId = el.closest(\"[data-change-id]\").dataset.changeId;\n    const change = this.item.changes.get(changeId);\n    if (change) {\n      if (tooltip) game.tooltip.dismissLockedTooltip(el.closest(\".locked-tooltip\"));\n      return void ffd20.applications.ChangeEditor.wait({ change, document: this.item });\n    }\n  }\n\n  _onDuplicateChange(event) {\n    event.preventDefault();\n    const el = event.target;\n    const changeId = el.dataset.changeId;\n    if (!changeId) return;\n    const changes = this.item.toObject().system.changes ?? [];\n    const old = changes.find((c) => c._id === changeId);\n    if (old) {\n      game.tooltip.dismissLockedTooltip(el.closest(\".locked-tooltip\"));\n      delete old._id;\n      return ffd20.components.ItemChange.create([old], { parent: this.item });\n    }\n  }\n\n  _onDeleteChange(event) {\n    event.preventDefault();\n    const el = event.target;\n    const changeId = el.dataset.changeId;\n    game.tooltip.dismissLockedTooltip(el.closest(\".locked-tooltip\"));\n    this.item.changes.get(changeId)?.delete();\n  }\n\n  async _onCreateChange(event) {\n    event.preventDefault();\n\n    const [change] = await ffd20.components.ItemChange.create([{ modifier: \"untyped\" }], { parent: this.item });\n    if (change) ffd20.applications.ChangeEditor.wait({ change, document: this.item });\n  }\n\n  async _onNoteControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Add new note\n    if (a.classList.contains(\"add-note\")) {\n      const contextNotes = this.item.toObject().system.contextNotes || [];\n      contextNotes.push(new ffd20.components.ContextNote().toObject());\n      const updateData = { \"system.contextNotes\": contextNotes };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n    // Remove a note\n    if (a.classList.contains(\"delete-note\")) {\n      const li = a.closest(\".context-note\");\n      const contextNotes = this.item.toObject().system.contextNotes || [];\n      contextNotes.splice(Number(li.dataset.note), 1);\n      const updateData = { \"system.contextNotes\": contextNotes };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n\n  _onNoteTargetControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Prepare categories and changes to display\n    const li = a.closest(\".context-note\");\n    const noteIndex = Number(li.dataset.note);\n    const note = this.item.system.contextNotes[noteIndex];\n    const categories = ffd20.utils.internal.getBuffTargetDictionary(\"contextNotes\", {\n      actor: this.item.actor,\n      item: this.item,\n    });\n\n    // Sort specific categories\n    const sortable = new Set([\"skill\"]);\n    const lang = game.settings.get(\"core\", \"language\");\n    for (const category of categories) {\n      if (!sortable.has(category.key)) continue;\n      category.items.sort((a, b) => a.label.localeCompare(b.label, lang));\n    }\n\n    const part1 = note?.target?.split(\".\")[0];\n    const category = ffd20.config.contextNoteTargets[part1]?.category ?? part1;\n\n    // Show widget\n    const w = new Widget_CategorizedItemPicker(\n      { window: { title: \"FFD20.Application.ContextNoteTargetSelector.Title\" } },\n      categories,\n      (key) => {\n        if (key) {\n          const updateData = {};\n          updateData[`system.contextNotes.${noteIndex}.target`] = key;\n          this.item.update(updateData);\n        }\n      },\n      { category, item: note?.target }\n    );\n    w.render(true);\n  }\n\n  async _onLinkControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    // Delete link\n    if (a.classList.contains(\"delete-link\")) {\n      const { type, uuid, index } = a.dataset;\n      const links = this.item.toObject().system.links?.[type] ?? [];\n\n      const deleted = links.splice(Number(index), 1);\n\n      // Sanity check: Should happen only if update sneaks in between render and click\n      if (deleted.uuid && deleted.uuid !== uuid) throw new Error(\"Link deletion UUID mismatch\");\n\n      // Call hook for deleting a link\n      Hooks.callAll(\"pf1DeleteItemLink\", this.item, deleted, type);\n\n      const updateData = { \"system.links\": { [type]: links } };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n\n  /**\n   * Makes a readonly text input editable, and focus it.\n   *\n   * @param {Event} event\n   * @private\n   */\n  _onInputText(event) {\n    event.preventDefault();\n\n    /** @type {HTMLElement} */\n    const elem = event.target;\n\n    elem.readOnly = false;\n\n    // Get and set real value\n    const { inputValue } = elem.dataset;\n    let origValue = inputValue ?? foundry.utils.getProperty(this.item, elem.name);\n    const displayValue = elem.value;\n    elem.value = origValue;\n    elem.select();\n\n    // Restore old display on unfocus if nothing was changed\n    elem.addEventListener(\n      \"blur\",\n      () => {\n        if (typeof origValue === \"number\") origValue = origValue.toString();\n        if (origValue === elem.value) {\n          elem.readOnly = true;\n          elem.value = displayValue;\n        }\n\n        // Clear selection\n        const s = document.getSelection();\n        if (s.anchorNode === elem || s.anchorNode === elem.parentElement) s.removeAllRanges();\n      },\n      { once: true, passive: true }\n    );\n  }\n\n  async _createAttack(event) {\n    if (!this.actor) throw new Error(game.i18n.localize(\"FFD20.Error.ItemNoOwner\"));\n\n    await this._onSubmit(event, { preventRender: true });\n\n    const item = this.item;\n\n    const attackItem = ffd20.documents.item.ItemAttackPF.fromItem(item);\n\n    // Show in quickbar only if if the original item is there\n    attackItem.system.showInQuickbar = item.system.showInQuickbar;\n\n    // Create attack\n    const newAttack = await Item.implementation.create(attackItem, { parent: this.actor });\n    if (!newAttack) throw new Error(\"Failed to create attack from weapon\");\n\n    // Disable quick use of weapon\n    await item.update({ \"system.showInQuickbar\": false });\n\n    // Create link\n    await item.createItemLink(\"children\", newAttack);\n\n    // Notify user\n    ui.notifications.info(game.i18n.format(\"FFD20.NotificationCreatedAttack\", { item: item.name }));\n  }\n\n  async _createSpellbook(event) {\n    event.preventDefault();\n    if (this.item.actor == null) throw new Error(game.i18n.localize(\"FFD20.Error.ItemNoOwner\"));\n    await this._onSubmit(event, { preventRender: true });\n\n    await this.item.actor.createSpellbook({ ...this.item.system.casting, class: this.item.system.tag });\n\n    // HACK: The above does not re-render the item sheet for some reason\n    this.render();\n  }\n\n  _onEntrySelector(event) {\n    event.preventDefault();\n\n    //if (!this.isEditable) return; // Learned at data can't be seen otherwise\n\n    const a = event.currentTarget;\n    const options = {\n      name: a.dataset.for,\n      title: a.dataset.title,\n      flag: a.dataset.flag === \"true\",\n      boolean: a.dataset.boolean === \"true\",\n      flat: a.dataset.flat === \"true\",\n      fields: a.dataset.fields,\n      dtypes: a.dataset.dtypes,\n    };\n\n    const app = Object.values(foundry.applications.instances).find((o) => {\n      return o instanceof ffd20.applications.EntrySelector && o.name === options.name && o.document.id === this.id;\n    });\n\n    if (app) {\n      app.render(true);\n      app.bringToFront();\n    } else {\n      new ffd20.applications.EntrySelector({\n        ...options,\n        document: this.item,\n      }).render({ force: true });\n    }\n  }\n\n  async _onItemSelector(event) {\n    event.preventDefault();\n    if (!this.item.isOwner) return void ui.notifications.warn(\"FFD20.Error.NoItemPermission\", { localize: true });\n    // This function should never be called without an actor\n    if (!this.actor) throw new Error(\"No actor to find items from.\");\n\n    const { type, subType, kind, empty, selected, label, name } = event.currentTarget.dataset;\n\n    const filter = (item) => {\n      if (type && item.type !== type) return false;\n      if (subType && item.subType !== subType) return false;\n      if (subType === \"ammo\" && kind) {\n        if (item.system.extraType !== kind) return false;\n      }\n      return true;\n    };\n\n    const options = {\n      window: {\n        title: `${game.i18n.format(\"FFD20.SelectSpecific\", { specifier: game.i18n.localize(label) })} - ${\n          this.actor.name\n        }`,\n      },\n      id: `${this.item.uuid}-item-selector`,\n      actor: this.actor,\n      empty: empty === \"true\" || empty !== \"false\",\n      filterFunc: filter,\n      selected,\n    };\n\n    const item = await ffd20.utils.dialog.getItem(options);\n    if (item === null) return;\n\n    this.item.update({ [name]: item });\n  }\n\n  /**\n   * Control effect notes and footnotes\n   *\n   * @internal\n   * @param {Event} event\n   * @returns {Promise<void>}\n   */\n  async _onCardNoteControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const name = a.dataset.name;\n    const action = a.dataset.action;\n\n    const notes = foundry.utils.getProperty(this.item.toObject(), name) ?? [];\n\n    switch (action) {\n      case \"add\": {\n        notes.push(\"\");\n        const updateData = { [name]: notes };\n        return this._updateObject(event, this._getSubmitData(updateData));\n      }\n      case \"delete\": {\n        notes.splice(Number(a.dataset.index), 1);\n        const updateData = { [name]: notes };\n        return this._updateObject(event, this._getSubmitData(updateData));\n      }\n    }\n  }\n\n  _selectOnClick(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    el.select();\n  }\n}\n\n/**\n * @typedef {object} DescriptionAttribute\n * @property {string} name - Data path to which the input will be written\n * @property {boolean} [fakeName] - Is player lied to about what they're editing. Unused.\n * @property {string} id\n * @property {boolean} [isNumber] - Whether the input is a number (text input)\n * @property {boolean} [isBoolean] - Whether the input is a boolean (checkbox)\n * @property {boolean} [isRange] - Whether this is a dual input for a value and a maximum value\n * @property {string} label - The label for the input\n * @property {string | boolean | number | {value: string | number, name: string}} value - The value that is show in the sidebar.\n *   Ranges require an object with `value` and `name` properties.\n * @property {{value: string | number, name: string}} [max] - Maximum value for a range input\n * @property {number} [decimals] - Number of decimals to display for `number`s\n * @property {boolean} [fakeValue] - Is {@link DescriptionAttribute#inputValue} actually used.\n * @property {string} [inputValue] - Value that will appear in the input field when it is edited,\n *                                   overriding the default value retrieved from the item data\n *                                   using {@link DescriptionAttribute#name}\n */\n","import { ItemSheetPF } from \"./item-sheet.mjs\";\nimport { getSkipActionPrompt } from \"@documents/settings.mjs\";\nimport { CurrencyTransfer } from \"../currency-transfer.mjs\";\n\nexport class ItemSheetPF_Container extends ItemSheetPF {\n  constructor(...args) {\n    super(...args);\n\n    /**\n     * IDs of expanded items.\n     *\n     * @private\n     * @type {string[]}\n     */\n    this._expandedItems = [];\n\n    /**\n     * Track the set of item filters which are applied\n     *\n     * @type {Set}\n     */\n    this._filters = {\n      search: { container: \"\" },\n    };\n\n    /** Item search */\n    this.searchCompositioning = false; // for IME\n    this.searchRefresh = true; // Lock out same term search unless sheet also refreshes\n    this.searchDelay = 250; // arbitrary ?ms for arbitrarily decent reactivity; MMke this configurable?\n    this.searchDelayEvent = null; // setTimeout id\n    this.effectiveSearch = \"\"; // prevent searching the same thing\n\n    /**\n     * Track item updates from the actor sheet.\n     *\n     * @type {object[]}\n     */\n    this._itemUpdates = [];\n\n    /**\n     * Override item sheet initial tab.\n     * Assumes first tab definition is the main tab.\n     */\n    this.options.tabs[0].initial = \"contents\"; // Doesn't actually do anything\n    this._tabs[0].active = \"contents\"; // Actual override\n  }\n\n  static get defaultOptions() {\n    const defaultOptions = super.defaultOptions;\n    return foundry.utils.mergeObject(defaultOptions, {\n      width: 800,\n      classes: [\"ffd20\", \"sheet\", \"item\"],\n      scrollY: [...defaultOptions.scrollY, \".inventory-body\"],\n      dragDrop: [\n        { dragSelector: \"li.item[data-item-id]\", dropSelector: '.tab[data-tab=\"contents\"]' },\n        { dragSelector: \".tab.changes li.change\" },\n        { dragSelector: \"label.denomination\" },\n      ],\n    });\n  }\n\n  /**\n   * Return a dynamic reference to the HTML template path used to render this Item Sheet\n   *\n   * @returns {string}\n   */\n  get template() {\n    return \"systems/ffd20/templates/items/container.hbs\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Prepare item sheet data\n   * Start with the base item data and extending with additional properties for rendering.\n   */\n  async getData() {\n    const context = await super.getData();\n\n    context.units = {\n      weight: ffd20.utils.getWeightSystem() === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\"),\n    };\n\n    // Add filters\n    context.filters = this._filters;\n\n    // Show whether the item has currency\n    context.hasCurrency = Object.values(this.item.system.currency).some((o) => o > 0);\n\n    // Prepare inventory\n    this._prepareContents(context);\n\n    // Get contents weight\n    const usystem = ffd20.utils.getWeightSystem();\n    context.weight = {\n      contents: this.item.system.weight.converted.contents,\n      units: usystem === \"metric\" ? game.i18n.localize(\"FFD20.Kgs\") : game.i18n.localize(\"FFD20.Lbs\"),\n    };\n\n    // Get contents value\n    const coinage = ffd20.utils.currency.merge(this.item.system.currency);\n\n    const cpValue =\n      this.item.getValue({ recursive: true, sellValue: 1, inLowestDenomination: true }) -\n      this.item.getValue({ recursive: false, sellValue: 1, inLowestDenomination: true }) -\n      coinage;\n    const cpSellValue =\n      this.item.getValue({ recursive: true, inLowestDenomination: true }) -\n      this.item.getValue({ recursive: false, inLowestDenomination: true }) -\n      coinage;\n\n    context.totalValue = ffd20.utils.currency.split(cpValue, { pad: true });\n    context.sellValue = ffd20.utils.currency.split(cpSellValue, { pad: true });\n    context.currency = ffd20.utils.currency.split(coinage, { pad: true });\n\n    // Set value labels\n    context.labels ??= {};\n    context.labels.totalValue = game.i18n.format(\"FFD20.SplitValue\", context.totalValue);\n    context.labels.sellValue = game.i18n.format(\"FFD20.SplitValue\", context.sellValue);\n    context.labels.currency = game.i18n.format(\"FFD20.SplitValue\", context.currency);\n\n    return context;\n  }\n\n  /**\n   * Filters item by {@link ffd20.config.sheetSections sheet section} config.\n   *\n   * @internal\n   * @param {Item} item - Item to filter\n   * @param {object} section - Section to filter by\n   * @returns {boolean}\n   */\n  _applySectionFilter(item, section) {\n    if (!section.filters) throw new Error(`Section \"${section.path}\" lacks filters`);\n    return section.filters.some((filter) => {\n      if (filter.type === item.type) {\n        return filter.subTypes?.includes(item.subType) ?? true;\n      }\n      return false;\n    });\n  }\n\n  _prepareContents(context) {\n    // Categorize items as inventory, spellbook, features, and classes\n    const inventory = Object.values(ffd20.config.sheetSections.inventory)\n      .map((data) => ({ ...data }))\n      .sort((a, b) => a.sort - b.sort);\n\n    // The item's items\n    context.items = this.item.items.map((/** @type {ffd20.documents.item.ItemPhysicalPF} */ item) => {\n      const itemData = item.system;\n      const i = { ...item };\n      i.id = item.id; // Alias\n      i.name = item.name;\n      i.img ||= item.getDefaultArtwork();\n      i.subType = item.subType;\n      i.document = item;\n      i.labels = item.getLabels();\n      i.isCharged = !item.isSingleUse && item.isCharged;\n      i.charges = i.isCharged ? item.charges : Infinity;\n      i.hasAttack = item.hasAttack;\n      i.hasDamage = item.hasDamage;\n      i.hasAction = item.hasAction || item.isCharged;\n      i.showUnidentifiedData = item.showUnidentifiedData;\n\n      i.hasUses = item.system.uses?.max > 0;\n      //i.price = item.getValue({ recursive: false, sellValue: 1, inLowestDenomination: true }) / 100;\n\n      i.quantity = itemData.quantity || 0;\n      i.isStack = i.quantity > 1;\n      i.destroyed = itemData.hp?.value <= 0;\n      i.isEmpty = i.quantity <= 0;\n      i.isBroken = item.isBroken;\n\n      i.price = item.getValue({ single: true, recursive: false, sellValue: 1 });\n\n      if (!i.isEmpty && i.isCharged) {\n        if (i.charges <= 0) i.isEmpty = true;\n      }\n\n      if (i.isCharged) {\n        i.maxCharges = item.maxCharges;\n        i.noMaxCharges = !Number.isFinite(i.maxCharges);\n      }\n\n      i.disabled = i.isEmpty || i.destroyed || false;\n\n      return i;\n    }, []);\n\n    context.items.sort((a, b) => (a.sort || 0) - (b.sort || 0));\n\n    // Organize Inventory\n    for (const i of context.items) {\n      const section = inventory.find((section) => this._applySectionFilter(i, section));\n      if (section) {\n        section.items ??= [];\n        section.items.push(i);\n      } else {\n        console.warn(`Could not find section for item \"${i.name}\"`, i);\n      }\n    }\n\n    context.inventory = inventory;\n  }\n\n  async _renderInner(...args) {\n    const html = await super._renderInner(...args);\n\n    // Re-open item summaries\n    for (const itemId of this._expandedItems) {\n      // Only display summaries of items that are still present\n      if (this.document.items.has(itemId)) {\n        const elem = html.find(`.item-list>.item[data-item-id=\"${itemId}\"]`)[0];\n        if (elem) this._openItemSummary(elem, { animation: false });\n      } else {\n        // Delete itemIds belonging to items no longer found in the actor\n        this._expandedItems.findSplice((o) => o === itemId);\n      }\n    }\n\n    return html;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    /* -------------------------------------------- */\n    /*  Inventory\n    /* -------------------------------------------- */\n\n    // Owned Item management\n    html.find(`.tab[data-tab=\"contents\"] .item-create`).click((ev) => this._onItemCreate(ev));\n    html.find(`.tab[data-tab=\"contents\"] .item-edit`).click(this._onItemEdit.bind(this));\n    html.find(`.tab[data-tab=\"contents\"] .item-delete`).click(this._onItemDelete.bind(this));\n    html.find(`.tab[data-tab=\"contents\"] .item-take`).click(this._onItemTake.bind(this));\n\n    html\n      .find(\".item .item-name\")\n      // Quick edit item\n      .contextmenu(this._onItemEdit.bind(this))\n      // Open item summary\n      .click(this._onItemSummary.bind(this));\n\n    // Quick (un)identify item\n    html.find(\"a.item-control.item-identify\").click((ev) => {\n      this._quickIdentifyItem(ev);\n    });\n\n    // Duplicate item\n    html.find(\"a.item-control.item-duplicate\").click(this._duplicateItem.bind(this));\n\n    // Quick add item quantity\n    html.find(\"a.item-control.item-quantity-add\").click((ev) => {\n      this._quickChangeItemQuantity(ev, 1);\n    });\n    // Quick subtract item quantity\n    html.find(\"a.item-control.item-quantity-subtract\").click((ev) => {\n      this._quickChangeItemQuantity(ev, -1);\n    });\n\n    // Quick Item Action control\n    html.find(\".item-actions a\").click((ev) => this._quickItemActionControl(ev));\n\n    // Set item uses\n    html\n      .find(\".item-detail.item-uses input[type='text']:not(:disabled)\")\n      .off(\"change\")\n      .change(this._setItemUses.bind(this))\n      .on(\"wheel\", this._setItemUses.bind(this));\n\n    // Convert currency\n    html.find(\"a.convert-currency\").click(this._convertCurrency.bind(this));\n\n    // Item Rolling\n    html.find(\".item .item-image\").on(\"click\", (event) => this._onItemCard(event));\n\n    // Search box\n    const sb = html.find(\".search-input\");\n    sb.on(\"keyup change\", this._searchFilterChange.bind(this));\n    sb.on(\"compositionstart compositionend\", this._searchFilterCompositioning.bind(this)); // for IME\n    this.searchRefresh = true;\n    // Filter following refresh\n    sb.each(function () {\n      if (this.value.length > 0) $(this).change();\n    });\n  }\n\n  _onItemCreate(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n\n    const [categoryId, sectionId] = el.dataset.create?.split(\".\") ?? [];\n    const createData = foundry.utils.deepClone(ffd20.config.sheetSections[categoryId]?.[sectionId]?.create);\n    if (!createData) throw new Error(`No creation data found for \"${categoryId}.${sectionId}\"`);\n\n    const type = createData.type || el.dataset.type;\n    const subType = createData.system?.subType;\n\n    createData.name = Item.implementation.defaultName({ type, subType });\n    const newItem = new Item.implementation(createData);\n\n    // Get old items of same general category\n    const oldItems = this.item.items\n      .filter((oldItem) => ffd20.utils.isItemSameSubGroup(newItem, oldItem))\n      .sort((a, b) => (b.sort || 0) - (a.sort || 0));\n\n    if (oldItems.length) {\n      // Ensure no duplicate names occur\n      const baseName = newItem.name;\n      let newName = baseName;\n      let i = 2;\n      const names = new Set(oldItems.map((i) => i.name));\n      while (names.has(newName)) newName = `${baseName} (${i++})`;\n\n      if (newName !== newItem.name) newItem.updateSource({ name: newName });\n    }\n\n    // Add to the end of the list of old items\n    const sort = oldItems.reduce((max, i) => Math.max(max, i.sort || 0), 0) + CONST.SORT_INTEGER_DENSITY;\n    newItem.updateSource({ sort });\n\n    return this.item.createContainerContent(newItem.toObject(), { renderSheet: true });\n  }\n\n  _onItemEdit(event) {\n    event.preventDefault();\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.item.items.get(li.dataset.itemId);\n\n    item.sheet.render(true, { focus: true, editable: this.isEditable });\n  }\n\n  _onItemSummary(event) {\n    event.preventDefault();\n    const li = event.target.closest(\".item[data-item-id]\");\n    this._openItemSummary(li);\n  }\n\n  /**\n   * @internal\n   * @param {Element} elem\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.animation=true]\n   * @param {object} [options.rollData]\n   */\n  async _openItemSummary(elem, { animation = true, rollData } = {}) {\n    // Check whether pseudo-item belongs to another collection\n    const itemId = elem.dataset.itemId;\n    const item = this.document.items.get(itemId);\n\n    rollData ??= item.defaultAction?.getRollData() ?? item.getRollData();\n\n    // Toggle summary\n    this._expandedItems = this._expandedItems.filter((o) => o !== itemId);\n    if (elem.classList.contains(\"expanded\")) {\n      const summary = elem.querySelector(\".item-summary\");\n      if (!animation) summary.remove();\n      else $(summary).slideUp(200, () => summary.remove());\n    } else {\n      const templateData = await item.getChatData({ chatcard: false, rollData });\n      const content = await renderTemplate(\"systems/ffd20/templates/actors/parts/actor-item-summary.hbs\", templateData);\n\n      let div = document.createElement(\"div\");\n      div.innerHTML = await ffd20.utils.enrichHTMLUnrolled(content, { rollData, secrets: this.actor.isOwner });\n      div = div.firstElementChild; // The template has only one root element\n\n      if (animation) $(div).hide();\n      elem.append(div);\n      if (animation) $(div).slideDown(200);\n\n      this._expandedItems.push(itemId);\n    }\n    elem.classList.toggle(\"expanded\");\n  }\n\n  async _onItemDelete(event) {\n    event.preventDefault();\n\n    const button = event.currentTarget;\n    if (button.disabled) return;\n\n    const li = event.currentTarget.closest(\".item\");\n    if (getSkipActionPrompt()) {\n      this.item.deleteContainerContent(li.dataset.itemId);\n    } else {\n      button.disabled = true;\n\n      const item = this.document.items.get(li.dataset.itemId);\n\n      const confirm = await foundry.applications.api.DialogV2.confirm({\n        window: { title: game.i18n.format(\"FFD20.DeleteItemTitle\", { name: item.name }) },\n        classes: [\"pf1-v2\", \"delete-item\"],\n        content: `<p>${game.i18n.localize(\"FFD20.DeleteItemConfirmation\")}</p>`,\n        rejectClose: false,\n        modal: true, // Require dialog to be resolved\n      });\n\n      if (confirm) this.item.deleteContainerContent(li.dataset.itemId);\n\n      button.disabled = false;\n    }\n  }\n\n  async _onItemTake(event) {\n    event.preventDefault();\n\n    const li = event.currentTarget.closest(\".item\");\n    const item = this.item.items.get(li.dataset.itemId);\n\n    if (this.actor) {\n      const newItem = await Item.implementation.create(item.toObject(), { parent: this.actor });\n      if (newItem) {\n        await this.item.deleteContainerContent(item._id);\n      }\n    }\n  }\n\n  _onDragStart(event) {\n    // Create drag data for an owned item\n    const elem = event.currentTarget;\n    let dragData;\n    if (elem.classList.contains(\"denomination\")) {\n      if (!this.item.testUserPermission(game.user, 3)) return;\n      dragData = {\n        type: \"Currency\",\n        alt: elem.classList.contains(\"alt-currency\"),\n        currency: [...elem.classList].find((o) => /[pgsc]p/.test(o)),\n        containerId: this.item.id,\n        amount: parseInt(elem.nextElementSibling.textContent || elem.nextElementSibling.value),\n      };\n    } else if (elem.dataset.itemId) {\n      const item = this.item.items.get(elem.dataset.itemId);\n      dragData = {\n        type: \"Item\",\n        data: item.toObject(),\n        containerId: this.item.id,\n      };\n      dragData.itemId = item.id;\n    } else {\n      return super._onDragStart(event);\n    }\n\n    // Add actor to drag data\n    dragData.actorUuid = this.item.actor?.uuid;\n\n    // Set data transfer\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n  }\n\n  _onDrop(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Try to extract the data\n    const data = TextEditor.getDragEventData(event);\n\n    const item = this.item;\n\n    // Handle the drop with a Hooked function\n    const allowed = Hooks.call(\"pf1DropContainerSheetData\", item, this, data);\n    if (allowed === false) return;\n\n    // Handle different data types\n    switch (data.type) {\n      case \"Item\":\n        return this._onDropItem(event, data);\n      case \"Currency\": {\n        return this._onDropCurrency(event, data);\n      }\n      case \"pf1Change\": {\n        return this._onChangeDrop(event, data);\n      }\n    }\n  }\n\n  async _onDropCurrency(event, data) {\n    const sourceActor = await fromUuid(data.actorUuid || \"\");\n\n    return new CurrencyTransfer(\n      { actor: sourceActor, container: data.containerId, alt: data.alt },\n      {\n        actor: this.actor,\n        container: this.item.id,\n        amount: Object.fromEntries([[data.currency, parseInt(data.amount)]]),\n      }\n    ).render(true);\n  }\n\n  async _onDropItem(event, data) {\n    if (!this.item.isOwner) return void ui.notifications.warn(\"FFD20.Error.NoItemPermission\", { localize: true });\n\n    const { actorUuid, containerId } = data;\n    const droppedItem = await Item.implementation.fromDropData(data);\n    let sourceActor = actorUuid ? await fromUuid(actorUuid) : null;\n    sourceActor ??= droppedItem.actor;\n\n    if (droppedItem === this.item || droppedItem === this.item.rootItem)\n      throw new Error(\"Can not place item into itself\");\n\n    const sameActor = sourceActor && sourceActor === this.item.actor;\n\n    const itemData = game.items.fromCompendium(droppedItem, {\n      clearFolder: true,\n      keepId: sameActor,\n      clearSort: !sameActor,\n    });\n\n    // Sort item\n    if (sameActor && containerId === this.item.id) {\n      return this._onSortItem(event, itemData);\n    }\n\n    // Create consumable from spell\n    if (itemData.type === \"spell\") {\n      const resultData = await ffd20.documents.item.ItemSpellPF.toConsumablePrompt(itemData, {\n        allowSpell: false,\n        actor: this.item.actor,\n      });\n      if (resultData) return this.item.createContainerContent(resultData);\n      else return false;\n    }\n\n    // Create or transfer item\n    if (droppedItem.isPhysical) {\n      await this.item.createContainerContent(itemData);\n      // TODO: Verify item was created so we don't delete source item without reason\n\n      if (sameActor) {\n        if (containerId) {\n          sourceActor.containerItems\n            .find((i) => i.id === data.itemId && i.parentItem?.id === containerId)\n            ?.parentItem.deleteContainerContent(data.itemId);\n        } else {\n          sourceActor.items.get(droppedItem.id)?.delete();\n        }\n      }\n    }\n  }\n\n  async _quickIdentifyItem(event) {\n    event.preventDefault();\n    if (!game.user.isGM) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.Error.CantIdentify\"));\n    }\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.items.get(itemId);\n\n    const isIdentified = item.system.identified;\n    if (isIdentified !== undefined) {\n      return item.update({ \"system.identified\": !isIdentified });\n    }\n  }\n\n  async _duplicateItem(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const itemId = $(a).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.items.get(itemId);\n    const itemData = item.toObject();\n\n    delete itemData.system?.links?.children;\n    delete itemData.system?.links?.charges;\n\n    itemData._stats ??= {};\n    itemData._stats.duplicateSource ||= item.uuid;\n\n    delete itemData._id;\n    itemData.name = `${itemData.name} (${game.i18n.localize(\"FFD20.Copy\")})`;\n    if (item.isPhysical && !item.system.identified) {\n      itemData.system.unidentified.name = `${item.system.unidentified.name} (${game.i18n.localize(\"FFD20.Copy\")})`;\n    }\n    if (itemData.system.links?.children) delete itemData.system.links.children;\n\n    return this.item.createContainerContent(itemData);\n  }\n\n  async _quickChangeItemQuantity(event, add = 1) {\n    event.preventDefault();\n    if (event.shiftKey) add *= 5;\n    if (event.ctrlKey) add *= 10;\n\n    const itemId = $(event.currentTarget).parents(\".item\").attr(\"data-item-id\");\n    const item = this.item.items.get(itemId);\n\n    const curQuantity = item.system.quantity || 0;\n    let newQuantity = Math.max(0, curQuantity + add);\n    if (item.type === \"container\" && newQuantity > 1) newQuantity = 1;\n    return item.update({ \"system.quantity\": newQuantity });\n  }\n\n  /**\n   * Handles click events to trigger the use of an item.\n   *\n   * @protected\n   * @param {MouseEvent} event - The originating click event\n   */\n  _quickItemActionControl(event) {\n    event.preventDefault();\n    const itemId = $(event.currentTarget).closest(\".item\").attr(\"data-item-id\");\n    const item = this.item.items.get(itemId);\n    item.use({ ev: event });\n  }\n\n  async _setItemUses(event) {\n    event.preventDefault();\n    const el = event.currentTarget;\n    const itemId = el.closest(\".item\").dataset.itemId;\n    const item = this.item.items.get(itemId);\n\n    this._mouseWheelAdd(event.originalEvent, el);\n\n    const value = Number(el.value);\n    this.setItemUpdate(item._id, \"system.uses.value\", value);\n\n    // Update on lose focus\n    if (event.originalEvent instanceof MouseEvent) {\n      el.addEventListener(\"pointerleave\", () => this._updateItems(), { passive: true, once: true });\n    } else this._updateItems();\n  }\n\n  async _updateItems() {\n    const promises = [];\n\n    const updates = this._itemUpdates;\n    this._itemUpdates = [];\n\n    for (const data of updates) {\n      const item = this.item.items.get(data._id);\n      if (!item) continue;\n\n      delete data._id;\n      if (item.testUserPermission(game.user, \"OWNER\")) promises.push(item.update(data));\n    }\n\n    return Promise.all(promises);\n  }\n\n  setItemUpdate(id, key, value) {\n    let obj = this._itemUpdates.find((o) => o._id === id);\n    if (!obj) {\n      obj = { _id: id };\n      this._itemUpdates.push(obj);\n    }\n\n    obj[key] = value;\n  }\n\n  _mouseWheelAdd(event, el) {\n    if (event && event instanceof WheelEvent) {\n      const value = parseFloat(el.value);\n      if (Number.isNaN(value)) return;\n\n      const increase = -Math.sign(event.deltaY);\n      const amount = parseFloat(el.dataset.wheelStep) || 1;\n      el.value = value + amount * increase;\n    }\n  }\n\n  _convertCurrency(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const currencyType = a.dataset.type;\n\n    this.item.convertCurrency(currencyType);\n  }\n\n  /**\n   * @override\n   */\n  _onSortItem(event, itemData) {\n    const items = this.document.items;\n\n    // Get the drag source and its siblings\n    const source = items.get(itemData._id);\n\n    // Get the drop target\n    const dropTarget = event.target.closest(\".item\");\n    const targetId = dropTarget ? dropTarget.dataset.itemId : null;\n    const target = items.get(targetId);\n\n    // Don't sort on yourself\n    if (targetId === source.id) return;\n\n    // Identify sibling items based on adjacent HTML elements\n    const siblings = [];\n    for (const el of dropTarget.parentElement.children) {\n      const siblingId = el.dataset.itemId;\n      if (siblingId && siblingId !== source.id) {\n        const item = items.get(el.dataset.itemId);\n        // Only take same typed siblings\n        if (item.type !== source.type) continue;\n        siblings.push(item);\n      }\n    }\n\n    // Don't sort if target has no siblings\n    if (siblings.length == 0) return;\n\n    // Perform the sort\n    const sortUpdates = SortingHelpers.performIntegerSort(source, { target, siblings });\n    const updateData = sortUpdates.map((u) => {\n      const update = u.update;\n      update._id = u.target._id;\n      return update;\n    });\n\n    // Perform the update\n    return this.item.updateContainerContents(updateData);\n  }\n\n  /**\n   * Handle rolling of an item from the Actor sheet, obtaining the Item instance and dispatching to it's roll method\n   *\n   * @param event\n   * @private\n   */\n  _onItemCard(event) {\n    event.preventDefault();\n    const itemId = event.currentTarget.closest(\".item\").dataset.itemId;\n    const item = this.item.items.get(itemId);\n\n    if (item == null) return;\n    return item.displayCard();\n  }\n\n  /** Item Search */\n\n  _searchFilterCommit(event) {\n    const container = this.item;\n    const search = this._filters.search.container.toLowerCase();\n\n    // TODO: Do not refresh if same search term, unless the sheet has updated.\n    if (this.effectiveSearch === search && !this.searchRefresh) return;\n\n    this.effectiveSearch = search;\n    this.searchRefresh = false;\n\n    const matchSearch = (name) => name.toLowerCase().includes(search); // MKAhvi: Bad method for i18n support.\n\n    $(event.target)\n      .closest(\".tab\")\n      .find(\".item-list .item\")\n      .each(function () {\n        const jq = $(this);\n        if (search?.length > 0) {\n          const item = container.items.get(this.dataset.itemId);\n          if (matchSearch(item.name)) jq.show();\n          else jq.hide();\n        } else jq.show();\n      });\n  }\n\n  // IME related\n  _searchFilterCompositioning(event) {\n    this.searchCompositioning = event.type === \"compositionstart\";\n  }\n\n  _searchFilterChange(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Accept input only while not compositioning\n\n    const search = event.target.value;\n    const changed = this._filters.search.container !== search;\n\n    if (this.searchCompositioning || changed) clearTimeout(this.searchDelayEvent); // reset\n    if (this.searchCompositioning) return;\n\n    this._filters.search.container = search;\n\n    if (event.type === \"keyup\") {\n      // Delay search\n      if (changed) this.searchDelayEvent = setTimeout(() => this._searchFilterCommit(event), this.searchDelay);\n    } else this._searchFilterCommit(event);\n  }\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Derivate of Foundry's Item.createDialog() functionality.\n */\nexport class ItemCreateDialog extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  /**\n   * @param {object} [options.data] - Initial item data\n   * @param {object} [options] - Optional configuration\n   * @param {Function} [options.resolve] - Resolve callback\n   * @param {*} [options.pack=null] - Pack reference given to Item.create()\n   * @param {*} [options.parent=null] - Parent reference given to Item.create()\n   * @param {object} [options.options] - FormApplication options\n   * @param {Array<string>} options.types - Array of types to limit the choices to.\n   */\n  constructor({ data = {}, resolve, ...options } = {}) {\n    if (options.types) options.types = new Set(options.types);\n\n    super(options);\n\n    this.resolve = resolve;\n    this.object = data;\n\n    this._updateCreationData(data);\n  }\n\n  /** @override */\n  get title() {\n    return game.i18n.format(\"DOCUMENT.Create\", { type: game.i18n.localize(\"DOCUMENT.Item\") });\n  }\n\n  getDefaultName(form = true) {\n    const formData =\n      form && this.form ? foundry.utils.expandObject(new FormDataExtended(this.form).object) : this.createData;\n\n    const type = formData.type;\n    const subType = formData.system?.subType;\n\n    return Item.implementation.defaultName({ type, subType, pack: this.options.pack, parent: this.options.parent });\n  }\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._onSubmit,\n    },\n    position: {\n      height: \"auto\",\n    },\n    classes: [\"pf1-v2\", \"create-document\", \"create-item\"],\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/widgets/item-create.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  get initialData() {\n    return this.object;\n  }\n\n  /** @type {object} */\n  createData = {};\n\n  /**\n   *\n   * @param {string} type - Item type\n   * @returns {Record<string,string>|null} - Option mapping\n   */\n  getSubtypes(type) {\n    switch (type) {\n      case \"class\":\n        return ffd20.config.classTypes;\n      case \"race\":\n        return null;\n      case \"attack\":\n        return ffd20.config.attackTypes;\n      case \"feat\":\n        return ffd20.config.featTypes;\n      case \"weapon\":\n        return Object.entries(ffd20.config.weaponTypes).reduce((all, [key, value]) => {\n          all[key] = value._label;\n          return all;\n        }, {});\n      case \"equipment\":\n        return Object.entries(ffd20.config.equipmentTypes).reduce((all, [key, value]) => {\n          all[key] = value._label;\n          return all;\n        }, {});\n      case \"consumable\":\n        return ffd20.config.consumableTypes;\n      case \"loot\":\n        return ffd20.config.lootTypes;\n      case \"spell\":\n        return null;\n      case \"buff\":\n        return ffd20.config.buffTypes;\n      case \"implant\":\n        return ffd20.config.implantTypes;\n      case \"container\":\n        return null;\n      default:\n        return null;\n    }\n  }\n\n  /**\n   * Called by {@link _preparePartContext}\n   *\n   * @internal\n   * @param {object} context - Context\n   * @param {object} options - Options\n   * @returns {object} - Same as context param\n   */\n  _prepareFormContext(context, options) {\n    const lang = game.i18n.lang;\n\n    let collection;\n    if (!this.options.parent) {\n      if (this.options.pack) collection = game.packs.get(this.options.pack);\n      else collection = game.items;\n    }\n\n    // TODO: Visualize folder tree better\n    const folders = Object.fromEntries(\n      (collection?._formatFolderSelectOptions() ?? []).map(({ id, name }) => [id, name])\n    );\n\n    const createData = this.createData;\n\n    let subtypes = this.getSubtypes(createData.type);\n    if (!subtypes && createData.system?.subType !== undefined) delete createData.system.subType;\n    if (subtypes) {\n      subtypes = Object.fromEntries(\n        Object.entries(subtypes).sort(([key0, label0], [key1, label1]) => label0.localeCompare(label1, lang))\n      );\n\n      if (!subtypes[this.createData.system.subType]) {\n        this.createData.system.subType = Object.keys(subtypes)[0];\n      }\n    } else {\n      this.createData.system.subType = undefined;\n    }\n\n    const types = Object.fromEntries(\n      Object.entries(CONFIG.Item.typeLabels).sort(([key0, label0], [key1, label1]) =>\n        label0.localeCompare(label1, lang)\n      )\n    );\n    delete types.base; // base is Foundry's unusable default\n    if (this.options.types) {\n      for (const type of Object.keys(types)) {\n        if (!this.options.types.has(type)) delete types[type];\n      }\n    }\n\n    context.name = createData.name;\n    context.defaultName = this.getDefaultName(false);\n    context.folder = createData.folder;\n    context.type = createData.type;\n    context.subtype = createData.system?.subType || null;\n    context.choices = {\n      folders,\n      types,\n      subtypes,\n    };\n\n    if (Object.keys(folders).length == 0) delete context.choices.folders;\n\n    return context;\n  }\n\n  /**\n   * @override\n   * @param {string} partId\n   * @param {object} context\n   * @param {object} options\n   * @returns {object}\n   */\n  _preparePartContext(partId, context, options) {\n    switch (partId) {\n      case \"footer\": {\n        // Footer buttons\n        context.buttons = [\n          {\n            action: \"create\",\n            type: \"submit\",\n            icon: \"fa-solid fa-check\",\n            label: game.i18n.format(\"DOCUMENT.Create\", { type: game.i18n.localize(\"DOCUMENT.Item\") }),\n          },\n        ];\n        break;\n      }\n      case \"form\": {\n        return this._prepareFormContext(context, options);\n      }\n    }\n\n    return context;\n  }\n\n  /**\n   * @override\n   * @param {object} formConfig\n   * @param {Event} event\n   */\n  _onChangeForm(formConfig, event) {\n    this._updateCreationData(new FormDataExtended(event.currentTarget).object);\n\n    super._onChangeForm(formConfig, event);\n\n    // HACK: Don't re-render on input changes, we have no reactive elements for them.\n    if (event.target.tagName === \"INPUT\") return;\n\n    this.render({ parts: [\"form\"] });\n  }\n\n  /**\n   * @internal\n   * @param {object} data\n   */\n  _updateCreationData(data = {}) {\n    // Fill in default type if missing\n    data.type ||= CONFIG.Item.defaultType || game.documentTypes.Item[1];\n    // If type does not match restrictions, assume first type is correct\n    if (this.options.types && !this.options.types.has(data.type)) data.type = this.options.types.first();\n\n    this.createData = foundry.utils.mergeObject(this.initialData, data, { inplace: false });\n    this.createData.system ??= {};\n\n    // Clean up data\n    if (!data.folder && !this.initialData.folder) delete this.createData.folder;\n\n    const subtypes = this.getSubtypes(this.createData.type);\n    if (!subtypes) delete this.createData.system.subType;\n\n    return this.createData;\n  }\n\n  /**\n   * @override\n   * @param {SubmitEvent} event\n   * @param {HTMLFormElement} form\n   * @param {FormDataExtended} formData\n   */\n  static async _onSubmit(event, form, formData) {\n    const createData = this._updateCreationData(formData.object);\n    createData.name ||= this.getDefaultName(false);\n\n    const options = {};\n    if (this.options.pack) options.pack = this.options.pack;\n    if (this.options.parent) options.parent = this.options.parent;\n    options.renderSheet = true;\n\n    const promise = Item.implementation.create(createData, options);\n\n    this.resolve?.(promise);\n\n    this.close();\n  }\n\n  /** @override */\n  _onClose(options) {\n    super._onClose(options);\n    this.resolve?.(null);\n  }\n\n  /**\n   * Wait for dialog to the resolved.\n   *\n   * @param {object} [data] Initial data to pass to the constructor.\n   * @param {object} [options] Options to pass to the constructor.\n   * @returns {Promise<Item|null>} Created item or null.\n   */\n  static waitPrompt(options = {}) {\n    return new Promise((resolve) => {\n      options.resolve = resolve;\n      new this(options).render(true);\n    });\n  }\n}\n","export class ItemActionSheet extends FormApplication {\n  constructor(...args) {\n    super(...args);\n\n    this.item.apps[this.appId] = this;\n    this.action.apps[this.appId] = this;\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      template: \"systems/ffd20/templates/apps/item-action.hbs\",\n      classes: [...options.classes, \"ffd20\", \"sheet\", \"action\", \"item-action\"],\n      width: 580,\n      height: 720,\n      closeOnSubmit: false,\n      submitOnClose: true,\n      submitOnChange: true,\n      resizable: true,\n      scrollY: [\".tab\"],\n      tabs: [\n        {\n          navSelector: \"nav.tabs[data-group='primary']\",\n          contentSelector: \"section.primary-body\",\n          initial: \"description\",\n          group: \"primary\",\n        },\n      ],\n      dragDrop: [\n        {\n          dragSelector: \"li.conditional\",\n          dropSelector: 'div[data-tab=\"conditionals\"]',\n        },\n      ],\n    };\n  }\n\n  get title() {\n    return `${this.item.name}: ${this.action.name}`;\n  }\n\n  get id() {\n    return `action-sheet-${this.action.uuid.replaceAll(\".\", \"-\")}`;\n  }\n\n  /** @type {ItemAction} */\n  get action() {\n    return this.object;\n  }\n\n  /** @type {ItemPF} */\n  get item() {\n    return this.action.item;\n  }\n\n  /** @type {ActorPF} */\n  get actor() {\n    return this.item.actor;\n  }\n\n  /**\n   * @internal\n   * @type {Record<string,string>}\n   */\n  _activeEdits = {};\n\n  /**\n   * Which fields to track edits for\n   *\n   * @internal\n   */\n  static EDIT_TRACKING = [\"description\"];\n\n  async getData() {\n    const action = this.action;\n    const item = this.item;\n    const actor = this.actor;\n\n    const editable = this.isEditable;\n\n    const context = {\n      config: ffd20.config,\n      editable,\n      cssClass: editable ? \"editable\" : \"locked\",\n      user: game.user,\n      action, // Derived data\n      data: action.toObject(true, false), // Source data\n      fields: action.schema.fields,\n      item,\n      actor,\n      img: action.img,\n      tag: action._source.tag, // True tag\n      damageTypes: ffd20.registry.damageTypes.toObject(),\n      rollData: action.getRollData(),\n      choices: {\n        measureTemplateTypes: ffd20.utils.internal.getTemplateTypes(),\n      },\n    };\n\n    // Action Details\n    context.hasAttack = action.hasAttack;\n    context.actionType = action.actionType;\n    context.isHealing = context.actionType === \"heal\";\n    context.hasDamage = action.hasDamage;\n    context.isCombatManeuver = action.isCombatManeuver;\n    context.canCrit = action.hasAttack && action.ability?.critMult > 1;\n    // Can have crit and non-crit damage, or simply show them if they've been defined.\n    context.hasCritDamage = context.canCrit || action.damage?.critParts?.length > 0;\n    context.hasNonCritDamage = context.canCrit || action.damage?.nonCritParts?.length > 0;\n\n    context.isCharged = action.isCharged;\n    context.isSelfCharged = action.isSelfCharged;\n    const chargedUsePeriods = new Set([...Object.keys(ffd20.config.limitedUsePeriods), \"charges\"]);\n    chargedUsePeriods.delete(\"single\"); // Single is special\n    context.choices.limitedUsePeriods = { ...ffd20.config.limitedUsePeriods };\n    if (!item.isPhysical) delete context.choices.limitedUsePeriods.single;\n    context.showMaxChargeFormula = chargedUsePeriods.has(action.uses.self.per);\n    if (action.hasRange) {\n      context.canInputRange = [\"ft\", \"mi\", \"spec\"].includes(action.range.units);\n      context.canInputMinRange = [\"ft\", \"mi\", \"spec\"].includes(action.range.minUnits);\n    }\n\n    context.canInputDuration = ![\"\", \"turn\", \"inst\", \"perm\", \"seeText\"].includes(action.duration?.units || \"\");\n\n    // Action Details\n    context.itemName = item.name;\n    context.itemEnh = item.system.enh || 0;\n    context.isSpell = item.type === \"spell\";\n    context.usesSpellPoints = item.spellbook?.spellPoints.useSystem;\n    context.defaultChargeFormula = item.getDefaultChargeFormula();\n    context.owned = actor != null;\n    context.parentOwned = actor != null;\n    context.owner = item.isOwner;\n    context.isGM = game.user.isGM;\n    context.unchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n    context.activation = action.activation;\n    context.hasActivationType = context.activation.type;\n    context.choices.abilityActivationTypes = context.unchainedActionEconomy\n      ? ffd20.config.abilityActivationTypes_unchained\n      : ffd20.config.abilityActivationTypes;\n\n    // Activation types that don't benefit from activation cost field being shown\n    context.costlessActivation = !context.activation.type || ffd20.config.costlessActivation.has(context.activation.type);\n\n    const noDesc = \"<p>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n\n    // Add description\n    const description = action.description;\n    context.descriptionHTML = description\n      ? await ffd20.utils.enrichHTMLUnrolled(description, {\n          secrets: context.owner,\n          rollData: context.rollData,\n          relativeTo: this.actor,\n        })\n      : noDesc;\n\n    // Show additional ranged properties\n    context.showMaxRangeIncrements = action.range.units === \"ft\";\n\n    // Prepare attack specific stuff\n    if (item.type === \"attack\") {\n      context.isWeaponAttack = item.system.subType === \"weapon\";\n      context.isNaturalAttack = item.system.subType === \"natural\";\n    }\n\n    context.canUseAmmo = context.isNaturalAttack !== true;\n    context.usesAmmo = !!action.ammo.type;\n    context.inheritedAmmoType = item?.system.ammo?.type;\n\n    if (context.usesAmmo) {\n      context.inheritedMisfire = item?.system.ammo?.misfire ?? null;\n    }\n\n    if (context.canUseAmmo) {\n      context.choices.ammoTypes = {\n        none: game.i18n.localize(\"FFD20.None\"),\n        \"\": game.i18n.format(\"FFD20.InheritAs\", { inherited: ffd20.config.ammoTypes[context.inheritedAmmoType] }),\n        ...ffd20.config.ammoTypes,\n      };\n      if (!context.inheritedAmmoType) delete context.choices.ammoTypes[\"\"];\n    }\n\n    // Add distance units\n    context.choices.distanceUnits = foundry.utils.deepClone(ffd20.config.distanceUnits);\n    delete context.choices.distanceUnits.none; // same as empty selection\n    // Set whether to show minimum range input\n    context.minRangeAvailable = [\"reach\", \"ft\", \"mi\", \"seeText\"].includes(action.range.units);\n\n    // Prepare stuff for actions with conditionals\n    if (context.data.conditionals) {\n      context.conditionals = [...action.conditionals].map((c) => ({ ...c, _id: c.id }));\n      const targets = action.getConditionalTargets();\n      context.conditionalTargets = targets;\n      context.hasConditionalTargets = !foundry.utils.isEmpty(targets);\n      for (const conditional of context.conditionals) {\n        if (!conditional.modifiers?.size) continue;\n        conditional.modifiers = [...conditional.modifiers].map((m) => ({ ...m, _id: m.id }));\n        for (const modifier of conditional.modifiers) {\n          modifier.targets = targets;\n          modifier.targetEntry = targets[modifier.target];\n          modifier.subTargets = modifier.targetEntry?.choices;\n          modifier.conditionalModifierTypes = action.getConditionalModifierTypes(modifier.target);\n          modifier.conditionalCritical = action.getConditionalCritical(modifier.target);\n\n          // Damage type supporting data\n          modifier.damage = new ffd20.models.action.DamagePartModel({ types: modifier.damageType });\n        }\n      }\n    }\n\n    // Add materials and addons\n    context.materialCategories = this._prepareMaterialsAndAddons();\n\n    context.materialAddons =\n      this.action.addonMaterial.reduce((obj, v) => {\n        obj[v] = true;\n        return obj;\n      }, {}) ?? {};\n\n    // Can hold (attacks & weapons only and only if they have attack rolls)\n    context.canHold = action.hasAttack;\n    // Inherited held option's name if any\n    context.inheritedHeld =\n      context.canHold && [\"attack\", \"weapon\"].includes(item.type)\n        ? ffd20.config.weaponHoldTypes[context.item.system.held]\n        : null;\n\n    // Add alignments\n    context.alignmentTypes = this._prepareAlignments(this.action.alignments);\n    this.alignments = context.alignmentTypes?.values; // Use a deep clone we've already made to track our progress.\n\n    // Ability damage multiplier from held\n    const held = context.rollData.action.held || context.rollData.item.held || \"1h\";\n    context.heldAbilityMultiplier = ffd20.config.abilityDamageHeldMultipliers[held] ?? 1;\n\n    // Key and Default ability score\n    // TODO: Should be allowed for most things eventually that can be class linked and once class key ability can be configured.\n    context.choices ??= {};\n    context.hasKeyAbility = this.item?.type === \"spell\";\n    const keyAbility = this.item?.spellbook?.ability;\n    const keyAbilityLabel = ffd20.config.abilities[keyAbility];\n\n    let defaultAbility;\n    switch (action.actionType) {\n      case \"mwak\":\n      case \"msak\":\n      case \"mcman\":\n        defaultAbility = actor?.system.attributes?.attack?.meleeAbility || \"str\";\n        break;\n      case \"rwak\":\n      case \"twak\":\n      case \"rsak\":\n      case \"rcman\":\n        defaultAbility = actor?.system.attributes?.attack?.rangedAbility || \"dex\";\n        break;\n    }\n\n    const defaultAbilityChoice = game.i18n.format(\"FFD20.DefaultRef\", {\n      value: ffd20.config.abilities[defaultAbility] || game.i18n.localize(\"FFD20.None\"),\n    });\n    context.choices.ability = context.hasKeyAbility\n      ? {\n          _key: game.i18n.format(keyAbility ? \"FFD20.KeyAbilityRef\" : \"FFD20.KeyAbility\", { ability: keyAbilityLabel }),\n          _default: defaultAbilityChoice,\n          ...ffd20.config.abilities,\n        }\n      : {\n          _default: defaultAbilityChoice,\n          ...ffd20.config.abilities,\n        };\n\n    // Power attack multiplier if inherited\n    context.paMultiplier = action.getPowerAttackMult({ rollData: context.rollData });\n\n    // Prepare attack configuration\n    context.extraAttacksTypes = Object.fromEntries([\n      ...Object.entries(ffd20.config.extraAttacks).map(([key, { label }]) => [key, label]),\n    ]);\n\n    context.extraAttacksConfig = { ...ffd20.config.extraAttacks[action.extraAttacks?.type] };\n    context.extraAttacksConfig.allowCustom = context.extraAttacksConfig.manual || context.extraAttacksConfig.formula;\n\n    if (this.constructor.EDIT_TRACKING?.length)\n      context._editorState = ffd20.applications.utils.restoreEditState(this, context.data);\n\n    return context;\n  }\n\n  _prepareMaterialsAndAddons() {\n    const materialList = {};\n    const addonList = [];\n    ffd20.utils.naturalSort([...ffd20.registry.materials], \"name\").forEach((material) => {\n      if (\n        material.allowed.lightBlade ||\n        material.allowed.oneHandBlade ||\n        material.allowed.twoHandBlade ||\n        material.allowed.rangedWeapon\n      ) {\n        if (!material.addon && !material.basic) {\n          materialList[material.id] = material.name;\n        } else if (material.addon && material.isValidAddon(this.action.normalMaterial)) {\n          addonList.push({ key: material.id, name: material.name });\n        }\n      }\n    });\n\n    return {\n      materials: materialList,\n      addons: addonList,\n    };\n  }\n\n  _prepareAlignments(alignments = {}) {\n    const alignmentChoices = {};\n\n    Object.keys(ffd20.config.damageResistances).forEach((dType) => {\n      if (![\"magic\", \"epic\"].includes(dType)) alignmentChoices[dType] = ffd20.config.damageResistances[dType];\n    });\n\n    return {\n      choices: alignmentChoices,\n      values: alignments,\n    };\n  }\n\n  /**\n   * Copy from core DocumentSheet#isEditable\n   */\n  get isEditable() {\n    const parentItem = this.item;\n    let editable = this.options.editable && parentItem.isOwner;\n    if (parentItem.pack) {\n      const pack = game.packs.get(parentItem.pack);\n      if (pack.locked) editable = false;\n    }\n    return editable;\n  }\n\n  /**\n   * @override\n   * @param {JQuery<HTMLElement>} html\n   */\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    if (!this.isEditable) return;\n\n    ffd20.applications.utils.trackStaleEditors(this, html[0]);\n\n    // Modify action image\n    html.find(\"img[data-edit]\").click((ev) => this._onEditImage(ev));\n\n    // Add drop handler to textareas\n    html.find(\"textarea, .card-notes input[type='text']\").on(\"drop\", this._onTextAreaDrop.bind(this));\n\n    // Modify attack formula\n    html.find(\".attack-control\").click(this._onAttackControl.bind(this));\n\n    // Modify damage formula\n    html.find(\".damage-control\").click(this._onDamageControl.bind(this));\n    html.find(\".damage-type-visual\").on(\"click\", this._onClickDamageType.bind(this));\n\n    // Note control\n    html.find(\".card-notes .controls a\").click(this._onNoteEntryControl.bind(this));\n\n    // Modify conditionals\n    html.find(\".conditional-control\").click(this._onConditionalControl.bind(this));\n\n    // Handle Alignment tristate checkboxes\n    html.find(\".alignmentCheckbox\").on(\"change\", (event) => {\n      this._onAlignmentChecked(event);\n    });\n\n    html.find(\".alignmentCheckbox.actionCheckbox\").each((index, item) => {\n      const type = item.dataset.type;\n      if (!(this.alignments[type] || this.alignments[type] === false)) {\n        item.indeterminate = true;\n      }\n    });\n  }\n\n  _onDragStart(event) {\n    const elem = event.currentTarget;\n\n    console.log(elem);\n\n    // Drag conditional\n    if (elem.dataset?.conditional) {\n      const conditional = this.action.conditionals.get(elem.dataset?.conditional);\n      const dragData = {\n        type: \"pf1Conditional\",\n        data: conditional.toObject(),\n      };\n      event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n    }\n  }\n\n  /**\n   * Foundry defaults to isGM check.\n   *\n   * @override\n   */\n  _canDragStart(selector) {\n    return this.isEditable;\n  }\n\n  /**\n   * Foundry defaults to isGM check.\n   *\n   * @override\n   */\n  _canDragDrop(selector) {\n    return this.isEditable;\n  }\n\n  async _onDrop(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const dropData = TextEditor.getDragEventData(event);\n    const { type } = dropData;\n\n    const action = this.action;\n    switch (type) {\n      // Handle conditionals\n      case \"pf1Conditional\": {\n        const conditional = dropData.data;\n        // Check targets and other fields for valid values, reset if necessary\n        for (const modifier of conditional.modifiers) {\n          if (!Object.keys(action.getConditionalTargets()).includes(modifier.target)) {\n            delete modifier.target;\n          }\n          if (modifier.subTarget) {\n            const results = action.getConditionalTargets();\n            const choices = results?.[modifier.target]?.choices;\n            if (!choices) delete modifier.subTarget;\n            else if (!Object.keys(choices).includes(modifier.subTarget)) delete modifier.subTarget;\n          }\n          if (modifier.type) {\n            const keys = Object.keys(action.getConditionalModifierTypes(modifier.target));\n            if (!keys.includes(modifier.type)) delete modifier.type;\n          }\n          if (modifier.critical) {\n            const keys = Object.keys(action.getConditionalCritical(modifier.target));\n            if (!keys.includes(modifier.critical)) delete modifier.critical;\n          }\n        }\n\n        // Renew conditional ID\n        delete conditional._id;\n\n        await ffd20.components.ItemConditional.create(conditional, { parent: this.action });\n      }\n    }\n  }\n\n  async _onNoteEntryControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const key = a.dataset.name;\n\n    switch (a.dataset.action) {\n      // Add\n      case \"add\": {\n        const notes = foundry.utils.getProperty(this.action.toObject(), key) ?? [];\n        notes.push(\"\");\n        const updateData = { [key]: notes };\n        return this._updateObject(event, this._getSubmitData(updateData));\n      }\n      // Delete\n      case \"delete\": {\n        const index = Number(a.dataset.index);\n        const notes = foundry.utils.getProperty(this.action.toObject(), key) ?? [];\n        notes.splice(index, 1);\n        const updateData = { [key]: notes };\n        return this._updateObject(event, this._getSubmitData(updateData));\n      }\n    }\n  }\n\n  async _onConditionalControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    await this._onSubmit(event, { preventRender: true }); // Submit any unsaved changes\n\n    // Add new conditional\n    if (a.classList.contains(\"add-conditional\")) {\n      return ffd20.components.ItemConditional.create([{}], { parent: this.action });\n    }\n    // Remove a conditional\n    else if (a.classList.contains(\"delete-conditional\")) {\n      const li = a.closest(\".conditional\");\n      const conditional = this.action.conditionals.get(li.dataset.conditional);\n      return conditional.delete();\n    }\n    // Add a new conditional modifier\n    else if (a.classList.contains(\"add-conditional-modifier\")) {\n      const li = a.closest(\".conditional\");\n      const conditional = this.action.conditionals.get(li.dataset.conditional);\n      return ffd20.components.ItemConditionalModifier.create([{}], { parent: conditional });\n    }\n    // Remove a conditional modifier\n    else if (a.classList.contains(\"delete-conditional-modifier\")) {\n      const li = a.closest(\".conditional-modifier\");\n      const conditional = this.action.conditionals.get(li.dataset.conditional);\n      const modifier = conditional.modifiers.get(li.dataset.modifier);\n      return modifier.delete();\n    }\n  }\n\n  /**\n   * Add or remove a damage part from the damage formula\n   *\n   * @param {Event} event     The original click event\n   * @returns {Promise}\n   * @private\n   */\n  async _onDamageControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    const list = a.closest(\".damage\");\n    const path = list.dataset.key || \"damage.parts\";\n    const k2 = path.split(\".\").slice(0, -1).join(\".\");\n    const k3 = path.split(\".\").slice(-1).join(\".\");\n\n    // Add new damage component\n    if (a.classList.contains(\"add-damage\")) {\n      // Add data\n      const damage = foundry.utils.getProperty(this.action.toObject(), k2);\n      const damageParts = foundry.utils.getProperty(damage, k3) ?? [];\n      damageParts.push({});\n      const updateData = { [path]: damageParts };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n    // Remove a damage component\n    else if (a.classList.contains(\"delete-damage\")) {\n      const li = a.closest(\".damage-part\");\n      const damage = foundry.utils.getProperty(this.action.toObject(), k2);\n      const damageParts = foundry.utils.getProperty(damage, k3) ?? [];\n      if (damageParts.length) {\n        damageParts.splice(Number(li.dataset.damagePart), 1);\n        const updateData = { [path]: damageParts };\n        return this._updateObject(event, this._getSubmitData(updateData));\n      }\n    }\n  }\n\n  /**\n   * @internal\n   * @param {Event} event\n   */\n  async _onClickDamageType(event) {\n    event.preventDefault();\n    const elem = event.currentTarget;\n\n    // Check for normal damage part\n    const damageIndex = Number(elem.closest(\".damage-part\")?.dataset.damagePart);\n    const damagePart = elem.closest(\".damage\")?.dataset.key;\n\n    if (damageIndex >= 0 && damagePart) {\n      const app = new ffd20.applications.DamageTypeSelector(\n        this.action,\n        `${damagePart}.${damageIndex}.types`,\n        foundry.utils.getProperty(this.action, damagePart)[damageIndex].types,\n        {\n          updateCallback: (update) => {\n            const damageArray = foundry.utils.getProperty(this.action.toObject(), damagePart) ?? [];\n            damageArray[damageIndex].types = update;\n            this.action.update({ [damagePart]: damageArray });\n          },\n        }\n      );\n      return app.render(true);\n    }\n\n    // Check for conditional\n    const conditionalEl = elem.closest(\".conditional\");\n    const modifierEl = elem.closest(\".conditional-modifier\");\n\n    /** @type {ItemConditional} */\n    const conditional = this.action.conditionals.get(conditionalEl?.dataset.conditional);\n\n    /** @type {ItemConditionalModifier} */\n    const modifier = conditional?.modifiers.get(modifierEl?.dataset.modifier);\n\n    if (!modifier) return void console.warn(\"Conditional modifier not found!\");\n\n    const app = new ffd20.applications.DamageTypeSelector(modifier, \"damageType\", modifier.damageType, {\n      updateCallback: (update) => {\n        modifier.update({ damageType: update });\n      },\n    });\n    return app.render(true);\n  }\n\n  async _onAttackControl(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    const manualExtraAttacks = this.action.toObject().extraAttacks?.manual ?? [];\n\n    // Add new attack component\n    if (a.classList.contains(\"add-attack\")) {\n      manualExtraAttacks.push({ formula: \"\", name: \"\" });\n      const updateData = { extraAttacks: { manual: manualExtraAttacks } };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n    // Remove an attack component\n    else if (a.classList.contains(\"delete-attack\")) {\n      const li = a.closest(\".attack-part\");\n      manualExtraAttacks.splice(Number(li.dataset.attackPart), 1);\n      const updateData = { extraAttacks: { manual: manualExtraAttacks } };\n      return this._updateObject(event, this._getSubmitData(updateData));\n    }\n  }\n\n  /**\n   * Clone of item/actor sheet image editor callback.\n   *\n   * @protected\n   * @param {Event} event\n   */\n  _onEditImage(event) {\n    const attr = event.currentTarget.dataset.edit;\n    const current = foundry.utils.getProperty(this.action, attr);\n    const fp = new FilePicker({\n      type: \"image\",\n      current,\n      callback: (path) => this.action.update({ img: path }),\n      top: this.position.top + 40,\n      left: this.position.left + 10,\n    });\n    fp.browse();\n  }\n\n  async _onTextAreaDrop(event) {\n    event.preventDefault();\n\n    const eventData = TextEditor.getDragEventData(event.originalEvent);\n    if (!eventData) return;\n\n    const elem = event.currentTarget;\n    const link = await TextEditor.getContentLink(eventData, { relativeTo: this.actor });\n\n    // Insert link\n    if (link) {\n      elem.value = !elem.value ? link : elem.value + \"\\n\" + link;\n\n      return this._onSubmit(event); // Save\n    }\n  }\n\n  async _onAlignmentChecked(event) {\n    const el = event.target;\n    const previousValue = this.alignments[el.dataset.type];\n\n    // Move from one phase to the next in our tristate checkbox\n    el.checked = previousValue === false;\n    el.indeterminate = previousValue === true;\n\n    if (el.checked) {\n      this.alignments[el.dataset.type] = true;\n    } else if (el.indeterminate) {\n      this.alignments[el.dataset.type] = null;\n    } else {\n      this.alignments[el.dataset.type] = false;\n    }\n  }\n\n  async _updateObject(event, formData) {\n    const oldData = this.action.toObject(true, false);\n\n    formData = foundry.utils.expandObject(formData);\n\n    // Handle conditionals array, merging incomplete data with old data\n    if (formData.conditionals) {\n      // Preserve arrays\n      // Convert {0:{}} to [{}] keeping order of keys\n      const preserveArray = (obj) =>\n        Object.entries(obj ?? {})\n          .sort(([k0], [k1]) => k0 - k1)\n          .map(([_, data]) => data);\n\n      // Convert to arrays and merge old data\n      // mergeObject() does not do deep merging into arrays, so this is somewhat manual\n      const oldConds = oldData.conditionals ?? [];\n      const conditionals = preserveArray(formData.conditionals);\n      for (let ci = 0; ci < conditionals.length; ci++) {\n        const c = conditionals[ci];\n        c.modifiers = preserveArray(c.modifiers);\n\n        const oldC = oldConds[ci];\n        for (let mi = 0; mi < c.modifiers.length; mi++) {\n          const m = c.modifiers[mi];\n          const oldM = oldC.modifiers[mi];\n\n          c.modifiers[mi] = foundry.utils.mergeObject(oldM, m);\n        }\n        conditionals[ci] = foundry.utils.mergeObject(oldC, c);\n      }\n\n      formData.conditionals = conditionals;\n    }\n\n    // Merge partial damage data to preserve overall data\n    if (formData.damage) {\n      for (const [key, array] of Object.entries(formData.damage)) {\n        if (Array.isArray(array)) continue;\n        const damage = oldData.damage[key] ?? [];\n        for (const [idx, data] of Object.entries(array)) {\n          damage[idx] = foundry.utils.mergeObject(damage[Number(idx)] ?? {}, data);\n        }\n        formData.damage[key] = damage;\n      }\n    }\n\n    // Adjust Material Addons object to array\n    const material = formData.material;\n    if (material?.addon) {\n      material.addon = Object.entries(material.addon)\n        .filter(([_, chosen]) => chosen)\n        .map(([key]) => key);\n    }\n\n    if (formData.alignments) {\n      // Adjust Alignment Types (this is necessary to handle null values for inheritance)\n      for (const [key, value] of Object.entries(this.alignments)) {\n        formData.alignments[key] = value;\n      }\n    }\n\n    // Do not add image if it's same as parent item\n    if (formData.img === this.item?.img) delete formData.img;\n\n    return this.action.update(formData);\n  }\n\n  async close(options = {}) {\n    delete this.item.apps[this.appId];\n    delete this.action.apps[this.appId];\n    if (this.action._sheet === this) this.action._sheet = null;\n\n    if (options.force && this._state <= Application.RENDER_STATES.NONE) return; // HACK: already closed, would error without\n\n    return super.close(options);\n  }\n\n  /**\n   * Copy of DocumentSheet._createDocumentIdLink\n   *\n   * @internal\n   * @param {jQuery} html\n   * Synced with Foundry v12.331\n   */\n  _createDocumentIdLink(html) {\n    if (!this.object.id) return;\n    const title = html.find(\".window-title\");\n    const label = game.i18n.localize(this.object.constructor.metadata.label);\n    const idLink = document.createElement(\"a\");\n    idLink.classList.add(\"document-id-link\");\n    idLink.ariaLabel = game.i18n.localize(\"SHEETS.CopyUuid\");\n    idLink.dataset.tooltip = `SHEETS.CopyUuid`;\n    idLink.dataset.tooltipDirection = \"UP\";\n    idLink.innerHTML = '<i class=\"fa-solid fa-passport\"></i>';\n    idLink.addEventListener(\"click\", (event) => {\n      event.preventDefault();\n      game.clipboard.copyPlainText(this.object.uuid);\n      ui.notifications.info(\n        game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label, type: \"uuid\", id: this.object.uuid })\n      );\n    });\n    idLink.addEventListener(\"contextmenu\", (event) => {\n      event.preventDefault();\n      game.clipboard.copyPlainText(this.object.id);\n      ui.notifications.info(game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label, type: \"id\", id: this.object.id }));\n    });\n    title.append(idLink);\n  }\n\n  /**\n   * Used to call {@link _createDocumentIdLink}\n   *\n   * @override\n   */\n  async _renderOuter() {\n    const html = await super._renderOuter();\n    this._createDocumentIdLink(html);\n    return html;\n  }\n\n  async _render(force, options = {}) {\n    ffd20.applications.utils.saveEditState(this, options);\n\n    return super._render(force, options);\n  }\n}\n","import * as baseFilter from \"./base.mjs\";\nimport fuzzysort from \"fuzzysort\";\n\nexport class CheckboxFilter extends baseFilter.BaseFilter {\n  static TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/checkbox-filter.hbs\";\n\n  /**\n   * Should the choices be automatically sorted?\n   *\n   * Affects only choices retrieved from config.\n   *\n   * @type {boolean}\n   */\n  static autoSort = true;\n\n  /**\n   * The minimum number of choices that must be present before the filter will show a search box.\n   * Booleans can be used to override this check.\n   *\n   * @type {number | boolean}\n   */\n  static MIN_SEARCH_CHOICES = 10;\n\n  /**\n   * The boolean operator used to combine choices of this filter.\n   * If \"OR\", an entry will be included if at least one active choice matches.\n   * If \"AND\", an entry will only be included if all active choices match.\n   *\n   * @type {BooleanOperator}\n   */\n  booleanOperator = BOOLEAN_OPERATOR.NONE;\n\n  /**\n   * A string used to determine which choices are shown.\n   *\n   * @type {string}\n   * @private\n   */\n  _choiceQuery = \"\";\n\n  constructor(...args) {\n    super(...args);\n    this._debouncedFilterChoices = foundry.utils.debounce(this._onCustomSearchFilter, 100);\n  }\n\n  /**\n   * Generate a {@link Collection} of {@link FilterChoice}s from a {@link CONFIG} object.\n   *\n   * @param {Record<string, string> | Record<string, Record<string, string>>} configObject - The object to generate choices from; can be a Record<string, string> or\n   * @param {object} [options={}] - Options determining how the choices are generated.\n   * @param {string} [options.labelKey=\"_label\"] - The key to use to determine the label if the configObject is a Record<string, object>; will be ignored if the configObject is a Record<string, string>.\n   * @param {boolean} [options.innerSet=false] - Whether choices should be generated from direct properties of the configObject, or from the properties of the inner objects.\n   * @returns {Collection<FilterChoice>} - A Collection of {@link FilterChoice}s\n   */\n  static getChoicesFromConfig(configObject, { labelKey = \"_label\", innerSet = false } = {}) {\n    /** @type {Collection<FilterChoice>} */\n    const choices = new foundry.utils.Collection();\n    for (const [key, value] of Object.entries(configObject)) {\n      if (innerSet) {\n        for (const [innerKey, innerValue] of Object.entries(value)) {\n          if (innerKey === labelKey) continue;\n          choices.set(innerKey, { key: innerKey, label: innerValue });\n        }\n      } else {\n        if (typeof value === \"object\" && value[labelKey]) {\n          choices.set(key, { key, label: value[labelKey] });\n        } else if (typeof value === \"string\") {\n          choices.set(key, { key, label: value });\n        }\n      }\n    }\n\n    if (this.autoSort) {\n      const collator = new Intl.Collator(game.i18n.lang, { numeric: true, ignorePunctuation: false });\n      const sorted = [...choices.entries()].sort(([_0, a], [_1, b]) => collator.compare(a.label, b.label));\n      return new foundry.utils.Collection(sorted);\n    }\n\n    return choices;\n  }\n\n  /**\n   * Whether this filter provides controls in addition to its choices.\n   *\n   * @type {boolean}\n   */\n  get hasControls() {\n    return this.booleanOperator !== BOOLEAN_OPERATOR.NONE || this.choices.size >= this.constructor.MIN_SEARCH_CHOICES;\n  }\n\n  get hasSearch() {\n    if (this.choices.size >= this.constructor.MIN_SEARCH_CHOICES) return true;\n    return this.constructor.MIN_SEARCH_CHOICES ?? false;\n  }\n\n  /** @inheritDoc */\n  async setup() {\n    await super.setup();\n    this.prepareBooleanOperator();\n  }\n\n  /**\n   * Prepare the boolean operator for this filter.\n   */\n  prepareBooleanOperator() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    // Find the first entry that has data in the field and use its data\n    let fieldData;\n    entries.find((entry) => {\n      return (fieldData = foundry.utils.getProperty(entry, this.constructor.indexField));\n    });\n    if ([\"Array\", \"Object\"].includes(foundry.utils.getType(fieldData))) this.booleanOperator = BOOLEAN_OPERATOR.AND;\n  }\n\n  /** @inheritDoc */\n  prepareChoices() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    const observedValues = new Set(\n      entries.flatMap((entry) => {\n        const data = foundry.utils.getProperty(entry, this.constructor.indexField);\n        if (Array.isArray(data)) {\n          if (data.length === 0) return [];\n          else return data;\n        }\n        if (typeof data === \"object\" && data !== null) {\n          const keys = Object.keys(data);\n          if (keys.length === 0) return [];\n          else return keys;\n        }\n        if (data == null) return [];\n        if (typeof data === \"string\" && data.trim() === \"\") return [];\n        return [data];\n      })\n    );\n\n    const autoLocalize = this.constructor.localizeChoices;\n    const i18nPrefix = this.constructor.localizePrefix || \"\";\n\n    const localize = (key) => {\n      if (autoLocalize) {\n        const path = `${i18nPrefix}${key}`;\n        if (game.i18n.has(path)) return game.i18n.localize(path);\n      }\n      return key;\n    };\n\n    this.choices = new foundry.utils.Collection(\n      ffd20.utils\n        .naturalSort(\n          [...observedValues].map((key) => ({ key, label: localize(key) })),\n          \"label\"\n        )\n        .map((choice) => [`${choice.key}`, choice])\n    );\n  }\n\n  /**\n   * Toggle the active state of a choice, or set it to a specific state.\n   *\n   * @param {string} key - The key of the choice to toggle\n   * @param {boolean | null} [state=null] - The state to set the choice to. If null, the choice will be toggled.\n   * @returns {boolean} - The new state of the choice\n   * @throws {Error} - If the choice does not exist in this filter\n   */\n  toggleChoice(key, state = null) {\n    const choice = this.choices?.get(key);\n    if (!choice) throw new Error(`Choice ${key} does not exist in this filter.`);\n    if (state === null) choice.active = !choice.active;\n    else choice.active = state;\n    return choice.active;\n  }\n\n  /** @inheritDoc */\n  reset() {\n    super.reset();\n    this.prepareBooleanOperator();\n    this._choiceQuery = \"\";\n    this.choices?.forEach((choice) => (choice.active = false));\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const activeChoices = this.choices.filter((choice) => choice.active);\n    // If no choices are active, this filter applies no conditions\n    if (activeChoices.length === 0) return true;\n\n    // If the filter is active, but the entry does not match the filter's types, the entry cannot match\n    const types = this.constructor.handledTypes;\n    if (types.size && !types.has(entry.type)) return false;\n\n    /** @type {string | string[] | Record<string, boolean>} */\n    const data = foundry.utils.getProperty(entry, this.constructor.indexField);\n\n    const testMethod = this.booleanOperator === BOOLEAN_OPERATOR.OR ? \"some\" : \"every\";\n    if (Array.isArray(data)) {\n      return activeChoices[testMethod]((choice) => data.includes(choice.key));\n    } else if (typeof data === \"object\" && data !== null) {\n      return activeChoices[testMethod]((choice) => choice.key in data && data[choice.key] !== false);\n    } else {\n      return activeChoices.some((choice) => {\n        return data == choice.key;\n      });\n    }\n  }\n\n  /** @inheritDoc */\n  getData() {\n    return {\n      ...super.getData(),\n      hasControls: this.hasControls,\n      boolean: this.booleanOperator,\n      hasSearch: this.choices.size > this.constructor.MIN_SEARCH_CHOICES,\n      choiceQuery: this._choiceQuery,\n    };\n  }\n\n  /** @inheritDoc */\n  activateListeners(html) {\n    super.activateListeners(html);\n    this._onCustomSearchFilter(null, html);\n    html.querySelector(\"button.boolean\")?.addEventListener(\"click\", (event) => {\n      event.preventDefault();\n      if (this.booleanOperator === BOOLEAN_OPERATOR.OR) this.booleanOperator = BOOLEAN_OPERATOR.AND;\n      else this.booleanOperator = BOOLEAN_OPERATOR.OR;\n      this.compendiumBrowser.render();\n    });\n    html\n      .querySelector(\"input[name=choice-query]\")\n      ?.addEventListener(\"input\", (event) => this._debouncedFilterChoices(event, html));\n    html.addEventListener(\"change\", (event) => {\n      if (event.target.type === \"checkbox\") {\n        const checkbox = event.target;\n        const choiceKey = /filter.\\w*.choice.(?<choice>.*)/.exec(checkbox.name)?.groups?.choice;\n        if (choiceKey) {\n          this.toggleChoice(choiceKey, checkbox.checked);\n          this.compendiumBrowser.render();\n        }\n      }\n    });\n  }\n\n  /**\n   * Filter this filter's choices based on a string query.\n   *\n   * @protected\n   * @param {Event} event - The originating input event\n   * @param {HTMLElement} html - The rendered HTML of this filter\n   */\n  _onCustomSearchFilter(event, html) {\n    if (event) {\n      event.preventDefault();\n      this._choiceQuery = SearchFilter.cleanQuery(event.target.value);\n    }\n\n    const matchingChoices = fuzzysort\n      .go(this._choiceQuery, this.choices.contents, {\n        key: \"label\",\n        threshold: -10000,\n      })\n      .map((result) => `${result.obj.key}`);\n    const choiceSet = new Set(matchingChoices);\n\n    for (const li of html.querySelectorAll(\"li.filter-choice\")) {\n      const choiceKey = li.dataset.choice;\n      if (choiceKey) {\n        if (choiceSet.has(choiceKey) || !this._choiceQuery) li.classList.remove(\"hidden\");\n        else li.classList.add(\"hidden\");\n      }\n    }\n    if (this._choiceQuery && matchingChoices.length === 0)\n      html.querySelector(\"span.no-choices\")?.classList.remove(\"hidden\");\n    else html.querySelector(\"span.no-choices\")?.classList.add(\"hidden\");\n  }\n}\n\n/** @typedef {keyof typeof BOOLEAN_OPERATOR} BooleanOperator */\n/**\n * States for the boolean operator of a filter.\n */\nexport const BOOLEAN_OPERATOR = /** @type {const} */ ({\n  AND: \"AND\",\n  OR: \"OR\",\n  NONE: false,\n});\n","import * as baseFilter from \"./base.mjs\";\n\n/**\n * @typedef {object} InputObject\n * @property {string} key - The key to retrieve choices.\n * @property {string} [label] - The label to display (can be localized).\n * @property {boolean} [active] - Whether this choice is currently active.\n * @property {string} [value] - The value of the choice.\n * @property {string} [placeholder] - The placeholder text for the input.\n * @property {string} [type=\"text\"] - The HTML type property of input.\n */\n\n/**\n * Base class for filters that require text input.\n */\nexport class TextFilter extends baseFilter.BaseFilter {\n  static TEMPLATE = \"systems/ffd20/templates/apps/compendium-browser/text-filter.hbs\";\n\n  /**\n   * List of inputs for this filter.\n   *\n   * @type {Array<InputObject>}\n   */\n  static inputs = [];\n\n  /** @inheritdoc */\n  hasChoices(number = 1) {\n    // We need to allow at least one choice\n    if (this.choices?.size == 1) return true;\n    return super.hasChoices(number);\n  }\n\n  /** @inheritdoc */\n  prepareChoices() {\n    this.choices = new foundry.utils.Collection(\n      this.constructor.inputs.map((input) => [\n        input.key,\n        {\n          ...input,\n          label: input.label ? game.i18n.localize(input.label) : undefined,\n          placeholder: input.placeholder ? game.i18n.localize(input.placeholder) : undefined,\n          type: input.type ?? \"text\",\n        },\n      ])\n    );\n  }\n\n  /** @inheritdoc */\n  reset() {\n    for (const choice of this.choices) {\n      choice.value = null;\n      choice.active = false;\n    }\n  }\n\n  /** @inheritDoc */\n  activateListeners(html) {\n    html.addEventListener(\"change\", (event) => {\n      const input = event.target;\n      const value = input.value;\n      const key = input.name.split(\"choice.\").pop();\n      const choice = this.choices.get(key);\n      if (choice) {\n        choice.value = this._parseInput(value, choice);\n        choice.active = Boolean(value);\n      }\n      this.compendiumBrowser.render();\n    });\n  }\n\n  /**\n   * Parse the input before it is stored in the choice value.\n   *\n   * @param {string} textInput - The text input to parse.\n   * @param {import(\"./base.mjs\").FilterChoice} choice - The choice object for custom handle by choice.\n   * @returns {string} - The parsed value if any transformation, otherwise the original string.\n   */\n  _parseInput(textInput, choice) {\n    return textInput;\n  }\n}\n","import { TextFilter } from \"./text.mjs\";\n\n/**\n * A filter that allows the user to input a minimum and maximum value.\n */\nexport class NumberRangeFilter extends TextFilter {\n  /** @inheritdoc */\n  static inputs = [\n    { key: \"min\", label: \"FFD20.Minimum\", placeholder: \"0\", type: \"number\" },\n    { key: \"max\", label: \"FFD20.Maximum\", placeholder: \"â\", type: \"number\" },\n  ];\n\n  /** @inheritdoc */\n  _parseInput(textInput, choice) {\n    let parsedInput = super._parseInput(textInput, choice);\n    if (choice.key === \"min\") {\n      parsedInput = Number(parsedInput) || null;\n    } else if (choice.key === \"max\") {\n      parsedInput = Number(parsedInput) || null;\n    } else {\n      throw new Error(\"Invalid choice key for NumberRangeFilter\");\n    }\n    return parsedInput;\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const value = foundry.utils.getProperty(entry, this.constructor.indexField) ?? 0;\n    const min = this.choices.get(\"min\").value ?? 0;\n    const max = this.choices.get(\"max\").value ?? Number.POSITIVE_INFINITY;\n    if (value < min || value > max) return false;\n    return true;\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\nimport { NumberRangeFilter } from \"./number-range.mjs\";\n\nexport class ItemTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static indexField = \"type\";\n  static types = [\"weapon\", \"equipment\", \"consumable\", \"container\", \"loot\", \"implant\"];\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = new foundry.utils.Collection(\n      [\n        { key: \"weapon\", label: game.i18n.localize(\"TYPES.Item.weapon\") },\n        { key: \"equipment\", label: game.i18n.localize(\"TYPES.Item.equipment\") },\n        { key: \"consumable\", label: game.i18n.localize(\"TYPES.Item.consumable\") },\n        { key: \"container\", label: game.i18n.localize(\"TYPES.Item.container\") },\n        { key: \"loot\", label: game.i18n.localize(\"FFD20.Misc\") },\n        { key: \"implant\", label: game.i18n.localize(\"TYPES.Item.implant\") },\n      ].map((choice) => [choice.key, choice])\n    );\n  }\n}\n\nexport class WeaponTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponType\";\n  static indexField = \"system.subType\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes);\n  }\n}\n\nexport class WeaponSubtypeFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponSubtype\";\n  static indexField = \"system.weaponSubtype\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponTypes, { innerSet: true });\n  }\n}\n\nexport class WeaponPropertyFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponProperties\";\n  static indexField = \"system.properties\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponProperties);\n  }\n}\n\nexport class WeaponGroupFilter extends CheckboxFilter {\n  static label = \"FFD20.WeaponGroups\";\n  static indexField = \"system.weaponGroups\";\n  static type = \"weapon\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.weaponGroups);\n  }\n}\n\nexport class EquipmentTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.EquipmentType\";\n  static indexField = \"system.subType\";\n  static type = \"equipment\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes);\n  }\n}\n\nexport class EquipmentSubtypeFilter extends CheckboxFilter {\n  static label = \"FFD20.EquipmentSubtype\";\n  static indexField = \"system.equipmentSubtype\";\n  static type = \"equipment\";\n  static autoSort = false; // Causes illogical order (e.g. heavy armor and heavy shield are next to each other, but not heavy armor and medium armor)\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentTypes, { innerSet: true });\n  }\n}\n\nexport class ItemSlotFilter extends CheckboxFilter {\n  static label = \"FFD20.Slot\";\n  static indexField = \"system.slot\";\n  static type = \"equipment\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.equipmentSlots, { innerSet: true });\n  }\n}\n\nexport class ConsumableTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ConsumableType\";\n  static indexField = \"system.subType\";\n  static type = \"consumable\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.consumableTypes);\n  }\n}\n\nexport class MiscItemTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Misc\";\n  static indexField = \"system.subType\";\n  static type = \"loot\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.lootTypes);\n  }\n}\n\nexport class ItemPriceFilter extends NumberRangeFilter {\n  static label = \"FFD20.Price\";\n  static indexField = \"system.price\";\n}\n\nexport class ItemCasterLevelFilter extends NumberRangeFilter {\n  static label = \"FFD20.CasterLevel\";\n  static indexField = \"system.cl\";\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class PackFilter extends CheckboxFilter {\n  static label = \"FFD20.Compendium\";\n  static indexField = \"__pack\";\n\n  /** @override */\n  prepareChoices() {\n    const entries = this.compendiumBrowser?.entries.contents;\n    const usedPacks = this.compendiumBrowser?.packs\n      ?.filter((pack) => entries.some((entry) => entry.__pack === pack.collection))\n      .map((pack) => {\n        const label = pack.metadata.label;\n        return { key: pack.collection, label: game.i18n.has(label) ? game.i18n.localize(label) : label };\n      });\n    const orderedPacks = ffd20.utils.naturalSort(usedPacks, \"label\").map((pack) => [pack.key, pack]);\n    this.choices = new foundry.utils.Collection(orderedPacks);\n  }\n}\n\nexport class TagFilter extends CheckboxFilter {\n  static label = \"FFD20.Tags\";\n  static indexField = \"system.tags\";\n}\n","import { BOOLEAN_OPERATOR, CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class SpellSchoolFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellSchool\";\n  static indexField = \"system.school\";\n  static type = \"spell\";\n\n  /** @override */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.spellSchools);\n  }\n}\n\nexport class SpellMultischoolFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellMultischool\";\n  static indexField = \"system.multischool\";\n  static type = \"spell\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    super.prepareChoices();\n    const choices = this.choices;\n\n    // Merge standard config choices with custom choices\n    const configChoices = this.constructor.getChoicesFromConfig(ffd20.config.spellMultischools);\n    for (const choice of configChoices) {\n      choices.set(choice.key, choice);\n    }\n    this.choices = choices;\n  }\n}\n\nexport class SpellSubschoolFilter extends CheckboxFilter {\n  static label = \"FFD20.Subschool\";\n  static indexField = \"system.subschool\";\n  static type = \"spell\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    super.prepareChoices();\n    const choices = this.choices;\n\n    // Merge standard config choices with custom choices\n    const configChoices = this.constructor.getChoicesFromConfig(ffd20.config.spellSubschools);\n    for (const choice of configChoices) {\n      choices.set(choice.key, choice);\n    }\n    this.choices = choices;\n  }\n}\n\nexport class SpellDescriptorFilter extends CheckboxFilter {\n  static label = \"FFD20.Descriptor\";\n  static indexField = \"system.descriptors\";\n  static type = \"spell\";\n\n  /** @inheritDoc */\n  async prepareChoices() {\n    await super.prepareChoices();\n\n    // Merge standard config choices with custom choices\n    const choices = this.choices;\n    const configChoices = this.constructor.getChoicesFromConfig(ffd20.config.spellDescriptors);\n    for (const choice of configChoices) {\n      choices.set(choice.key, choice);\n    }\n    this.choices = choices;\n  }\n}\n\nexport class SpellLearnedByClassFilter extends CheckboxFilter {\n  static label = \"FFD20.Classes\";\n  static indexField = \"system.learnedAt.class\";\n  static type = \"spell\";\n\n  /** @inheritDoc */\n  async prepareChoices() {\n    await super.prepareChoices();\n\n    const choices = this.choices;\n\n    // Display human readable name instead of the class identifier\n    const classNames = await ffd20.utils.packs.getClassIDMap();\n    const configChoices = this.constructor.getChoicesFromConfig(classNames);\n    for (const choice of configChoices) {\n      if (choices.has(choice.key)) {\n        choices.set(choice.key, choice);\n      }\n    }\n\n    this.choices = choices;\n  }\n}\n\nexport class SpellLearnedByDomainFilter extends CheckboxFilter {\n  static label = \"FFD20.Domain\";\n  static indexField = \"system.learnedAt.domain\";\n  static type = \"spell\";\n}\n\nexport class SpellLevelFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellLevel\";\n  static indexField = \"system.level\";\n  static type = \"spell\";\n  static autoSort = false; // Cantrip can appear last if true\n\n  /** @override */\n  prepareChoices() {\n    const choices = this.constructor.getChoicesFromConfig(ffd20.config.spellLevels);\n    for (const choice of choices) {\n      choice.key = Number(choice.key); // Convert string to number\n    }\n    this.choices = choices;\n  }\n\n  /** @override */\n  applyFilter(entry) {\n    const activeLearnedAtFilters = this.compendiumBrowser.filters.filter(\n      (filter) => filter.active && filter.constructor.indexField.startsWith(\"system.learnedAt.\")\n    );\n\n    // Fall back to checking whether _anything_ can learn the spell at that level\n    if (activeLearnedAtFilters.length === 0) return super.applyFilter(entry);\n\n    // Otherwise, check whether active filters match the spell's learnedAt\n    const testMethod = this.booleanOperator === BOOLEAN_OPERATOR.OR ? \"some\" : \"every\";\n    const activeLevelChoices = this.choices.filter((choice) => choice.active);\n\n    // Require either any of the active filters to match if OR, or all filters to return a match if AND\n    return activeLearnedAtFilters[testMethod]((filter) => {\n      /** @type {Record<string, number>} */\n      const learnedAt = foundry.utils.getProperty(entry, filter.constructor.indexField) ?? {};\n      const activeLearnedAtChoices = filter.choices.filter((choice) => choice.active);\n      // Require either one of the classes etc. to match if OR, or all classes etc. to match if AND\n      return activeLearnedAtChoices[testMethod]((learnedAtChoice) => {\n        const learnedAtLevel = learnedAt[learnedAtChoice.key];\n        return activeLevelChoices[testMethod]((levelChoice) => levelChoice.key === learnedAtLevel);\n      });\n    });\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class FeatTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static type = \"feat\";\n  static indexField = \"system.subType\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.featTypes);\n  }\n}\n\nexport class FeatClassFilter extends CheckboxFilter {\n  static label = \"FFD20.Classes\";\n  static type = \"feat\";\n  static indexField = \"system.associations.classes\";\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class ClassTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassType\";\n  static type = \"class\";\n  static indexField = \"system.subType\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classTypes);\n  }\n}\n\nexport class ClassHitDieFilter extends CheckboxFilter {\n  static label = \"FFD20.HitDie\";\n  static type = \"class\";\n  static indexField = \"system.hd\";\n}\n\nexport class ClassBaseAttackBonusFilter extends CheckboxFilter {\n  static label = \"FFD20.BAB\";\n  static type = \"class\";\n  static indexField = \"system.bab\";\n  static autoSort = false; // Causes illogical order (e.g. Custom, Good, Poor, None)\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classBAB);\n  }\n}\n\nexport class ClassSkillPointsFilter extends CheckboxFilter {\n  static label = \"FFD20.SkillsPerLevel\";\n  static type = \"class\";\n  static indexField = \"system.skillsPerLevel\";\n}\n\nclass ClassSavingThrowFilter extends CheckboxFilter {\n  static type = \"class\";\n\n  /** @type {SaveId} */\n  static savingThrow = \"\";\n\n  static localizeLabel = false;\n\n  static autoSort = false; // Causes illogical order (e.g. Custom, Good, Poor, None)\n\n  static get label() {\n    return ffd20.config.savingThrows[this.savingThrow] ?? \"\";\n  }\n  static get indexField() {\n    return `system.savingThrows.${this.savingThrow}.value`;\n  }\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classSavingThrows);\n    this.choices.set(\"none\", { label: game.i18n.localize(\"FFD20.None\"), key: \"none\" });\n  }\n\n  /** @inheritDoc */\n  applyFilter(entry) {\n    const result = super.applyFilter(entry);\n    const value = foundry.utils.getProperty(entry, this.constructor.indexField);\n    const noneFilterResult = this.choices.get(\"none\").active && value === \"\";\n    return result || noneFilterResult;\n  }\n}\n\nexport class ClassFortitudeFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"fort\";\n}\n\nexport class ClassReflexFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"ref\";\n}\n\nexport class ClassWillFilter extends ClassSavingThrowFilter {\n  static savingThrow = \"will\";\n}\n//fix\nexport class ClassSubTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassSubType.Label\";\n  static type = \"class\";\n  static indexField = \"system.classSubType\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classSubTypes);\n  }\n}\n\nexport class ClassParentFilter extends CheckboxFilter {\n  static label = \"FFD20.ParentClass.Label\";\n  static type = \"class\";\n  static indexField = \"system.parentClass\";\n}\n\nexport class ClassMPFilter extends CheckboxFilter {\n  static label = \"FFD20.ClassMPType.Label\";\n  static type = \"class\";\n  static indexField = \"system.classBaseMPTypes\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classBaseMPTypes);\n  }\n}\n\nexport class ClassCastingStatFilter extends CheckboxFilter {\n  static label = \"FFD20.SpellcastingAbility\";\n  static type = \"class\";\n  static indexField = \"system.classCastingStat\";\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.classCastingStats);\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class CreatureTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.CreatureType\";\n  static type = \"race\";\n  static indexField = \"system.creatureTypes\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.creatureTypes);\n  }\n}\n\nexport class CreatureSubTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.RaceSubtypePlural\";\n  static type = \"race\";\n  static indexField = \"system.creatureSubtypes\";\n\n  /** @inheritDoc */\n  prepareChoices() {\n    super.prepareChoices();\n\n    // Merge standard config choices with custom choices\n    const choices = this.choices;\n    const configChoices = this.constructor.getChoicesFromConfig(ffd20.config.creatureSubtypes);\n    for (const choice of configChoices) {\n      choices.set(choice.key, choice);\n    }\n    this.choices = choices;\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class BuffTypeFilter extends CheckboxFilter {\n  static label = \"FFD20.Type\";\n  static type = \"buff\";\n  static indexField = \"system.subType\";\n\n  /** @override */\n  prepareChoices() {\n    this.choices = this.constructor.getChoicesFromConfig(ffd20.config.buffTypes);\n  }\n}\n","import { CheckboxFilter } from \"./checkbox.mjs\";\n\nexport class CreatureCRFilter extends CheckboxFilter {\n  static label = \"FFD20.ChallengeRatingShort\";\n  static indexField = \"system.details.cr.base\";\n  static types = [\"character\", \"npc\"];\n\n  /** @override */\n  async prepareChoices() {\n    await super.prepareChoices();\n\n    const choices = this.choices.contents\n      .map((choice) => Number(choice.key))\n      .sort((a, b) => a - b)\n      .map((cr) => {\n        const label = ffd20.utils.CR.fromNumber(cr);\n        return [cr.toString(), { key: cr, label }];\n      });\n    this.choices = new foundry.utils.Collection(choices);\n  }\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as buffFilters from \"./filters/buff.mjs\";\n\nexport class BuffBrowser extends CompendiumBrowser {\n  static documentName = \"Item\";\n  static typeName = \"FFD20.Buffs\";\n  static filterClasses = [commonFilters.PackFilter, buffFilters.BuffTypeFilter, commonFilters.TagFilter];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as classFilters from \"./filters/class.mjs\";\n\nexport class ClassBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Classes\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    classFilters.ClassTypeFilter,\n    classFilters.ClassSubTypeFilter,\n    classFilters.ClassParentFilter,\n    classFilters.ClassHitDieFilter,\n    classFilters.ClassMPFilter,\n    classFilters.ClassCastingStatFilter,\n    classFilters.ClassBaseAttackBonusFilter,\n    classFilters.ClassSkillPointsFilter,\n    classFilters.ClassFortitudeFilter,\n    classFilters.ClassReflexFilter,\n    classFilters.ClassWillFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport { PackFilter } from \"./filters/common.mjs\";\nimport * as creatureFilters from \"./filters/creature.mjs\";\n\nexport class CreatureBrowser extends CompendiumBrowser {\n  static documentName = \"Actor\";\n  static typeName = \"FFD20.Creatures\";\n  static filterClasses = [PackFilter, creatureFilters.CreatureCRFilter];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as featFilter from \"./filters/feat.mjs\";\n\nexport class FeatBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Feats\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    featFilter.FeatTypeFilter,\n    featFilter.FeatClassFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as itemFilters from \"./filters/item.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\n\nexport class ItemBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Items\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    itemFilters.ItemTypeFilter,\n    itemFilters.WeaponTypeFilter,\n    itemFilters.WeaponSubtypeFilter,\n    itemFilters.WeaponPropertyFilter,\n    itemFilters.WeaponGroupFilter,\n    itemFilters.EquipmentTypeFilter,\n    itemFilters.EquipmentSubtypeFilter,\n    itemFilters.ItemSlotFilter,\n    itemFilters.ConsumableTypeFilter,\n    itemFilters.MiscItemTypeFilter,\n    itemFilters.ItemPriceFilter,\n    itemFilters.ItemCasterLevelFilter,\n    commonFilters.TagFilter,\n  ];\n\n  /** @override */\n  static _mapEntry(entry, pack) {\n    const result = super._mapEntry(entry, pack);\n\n    // Remove equipmentSubtype if the item subtype should not have one\n    const { subType, equipmentSubtype } = result.system;\n    if (subType) {\n      const equipmentSubtypes = Object.keys(ffd20.config.equipmentTypes[subType] ?? {}).filter((o) => !o.startsWith(\"_\"));\n      if (equipmentSubtypes.length === 0) {\n        // Clear equipmentSubtype if subType has no equipmentSubtypes\n        result.system.equipmentSubtype = \"\";\n      } else if (!equipmentSubtypes.includes(equipmentSubtype)) {\n        // Default to first equipmentSubtype if current equipmentSubtype is invalid\n        result.system.equipmentSubtype = equipmentSubtypes.at(0);\n      }\n    }\n\n    return result;\n  }\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as raceFilters from \"./filters/race.mjs\";\n\nexport class RaceBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Races\";\n  static filterClasses = [\n    commonFilters.PackFilter,\n    raceFilters.CreatureTypeFilter,\n    raceFilters.CreatureSubTypeFilter,\n    commonFilters.TagFilter,\n  ];\n}\n","import { CompendiumBrowser } from \"./compendium-browser.mjs\";\nimport * as commonFilters from \"./filters/common.mjs\";\nimport * as spellFilter from \"./filters/spell.mjs\";\n\nexport class SpellBrowser extends CompendiumBrowser {\n  static typeName = \"FFD20.Spells\";\n  static types = [\"spell\"];\n  static filterClasses = [\n    commonFilters.PackFilter,\n    spellFilter.SpellSchoolFilter,\n    spellFilter.SpellMultischoolFilter,\n    spellFilter.SpellSubschoolFilter,\n    spellFilter.SpellDescriptorFilter,\n    spellFilter.SpellLearnedByClassFilter,\n    spellFilter.SpellLearnedByDomainFilter,\n    spellFilter.SpellLevelFilter,\n    commonFilters.TagFilter,\n  ];\n  /** @override */\n  static _mapEntry(entry, pack) {\n    const result = super._mapEntry(entry, pack);\n\n    /** @type {number[]} */\n    const learnedAtLevels = Object.values(entry.system.learnedAt ?? {})\n      .map((learnedAtSource) => Object.values(learnedAtSource))\n      .flat();\n    if (typeof entry.system.level === \"number\") learnedAtLevels.push(entry.system.level);\n    // NOTE: This results in `level` being a number[] instead of a number like in the source data.\n    result.system.level = [...new Set(learnedAtLevels)];\n\n    return result;\n  }\n}\n","/**\n * Journal text page sheet that displays parentage with sub-pages\n */\nexport class JournalTextPageSheetPF1 extends JournalTextPageSheet {\n  get template() {\n    if (this.document.type !== \"text\" || this.isEditable) return super.template;\n    return \"systems/ffd20/templates/journals/text-view.hbs\";\n  }\n\n  async getData() {\n    const context = await super.getData();\n\n    // Find parent pages if deeper than level 1 heading\n    const current = this.document;\n    let maxLevel = current.title.level - 1;\n    if (maxLevel > 0 && current.parent instanceof JournalEntry) {\n      /** @type {JournalEntryPage[]} */\n      const pages = current.parent.pages.contents.sort((a, b) => a.sort - b.sort);\n\n      const idx = pages.indexOf(current);\n      const headers = [];\n      // Traverse backwards\n      for (let i = idx - 1; i >= 0; i--) {\n        const npage = pages[i];\n        const nlevel = npage.title.level;\n        if (nlevel <= maxLevel) {\n          maxLevel = nlevel - 1;\n          headers[maxLevel] = npage;\n          if (maxLevel < 1) break;\n        }\n      }\n\n      context.ffd20 = { headers };\n    }\n\n    return context;\n  }\n}\n","/**\n * Save edit state\n *\n * @remarks\n * - Must be combined with {@link restoreEditState()}\n * - Static `EDIT_TRACKING` array must be defined to declare what fields are being tracked for editing.\n *\n * @example\n * In sheet body define the following\n * ```js\n * // Init data\n * _activeEdits = {};\n *\n * // Define fields to track\n * static EDIT_TRACKING = [\"system.description.value\", \"system.description.unidentified\"];\n *\n * // Override\n * async _render(force, options) {\n *   ffd20.applications.utils.saveEditState(this, options);\n *\n *   return super._render(force, options);\n * }\n * ```\n *\n * @internal\n * @experimental\n * @param {FormApplication} sheet\n * @param {object} options\n */\nexport function saveEditState(sheet, options = {}) {\n  if (!sheet.form || !sheet.rendered) return;\n\n  const paths = sheet.constructor.EDIT_TRACKING;\n\n  /** @type {HTMLElement} */\n  const isUpdate = options.renderContext === \"updateItem\";\n\n  // Reset old saved data if it persists\n  sheet._activeEdits = {};\n\n  // Save active editor data\n  // Save {{editor}} state\n  for (const [path, editor] of Object.entries(sheet.editors)) {\n    if (!editor.active) {\n      delete sheet._activeEdits[path];\n    } else {\n      sheet._activeEdits[path] = ProseMirror.dom.serializeString(editor.instance.view.state.doc.content);\n    }\n  }\n  // Save <prose-mirror> state, for whenever it works correctly\n  /*\n  const formData = new FormDataExtended(sheet.form).object;\n  for (const path of paths) {\n    if (isUpdate && foundry.utils.hasProperty(options.renderData, path)) continue;\n    const text = formData[path];\n    if (text !== undefined) {\n      sheet._activeEdits[path] = text;\n      sheet.element[0].classList.add(\"stale-data\");\n    }\n  }\n  */\n}\n\n/**\n * Restore edit state\n *\n * @remarks\n * - Must be combined with {@link saveEditState()}\n * - Should use `context.prefix.path.to.data` to set toggled state so the editor is automatically in edit mode.\n * - Prefix defaults to `_editorState` for the above path.\n *\n * @internal\n * @experimental\n * @param {FormApplication} sheet - Application to work with\n * @param {object} context - Context from which to fetch current data\n * @returns {object} - Editor toggled state mapping\n */\nexport function restoreEditState(sheet, context) {\n  const editorToggledState = {};\n\n  for (const path of sheet.constructor.EDIT_TRACKING) {\n    foundry.utils.setProperty(editorToggledState, path, true);\n  }\n\n  // Re-instate data from in-progress edits\n  for (const [path, text] of Object.entries(sheet._activeEdits)) {\n    if (!text) continue;\n    if (text !== foundry.utils.getProperty(context, path)) {\n      foundry.utils.setProperty(context, path, text);\n      foundry.utils.setProperty(editorToggledState, path, false);\n      console.debug(\"FFD20 | Restored interrupted edit state to\", path);\n\n      // Mark {{editor}} as changed\n      const editor = sheet.editors[path];\n      if (editor) editor.changed = true;\n    }\n    delete sheet._activeEdits[path];\n  }\n\n  sheet._activeEdits = {};\n\n  return editorToggledState;\n}\n\n/**\n * Track stale editors\n *\n * Visually marks editors that need action.\n *\n * Call in `activateListeners()`\n *\n * Must be combined with {@link saveEditState()} and {@link restoreEditState()}\n *\n * @internal\n * @experimental\n * @param {FormApplication} sheet\n * @param {HTMLElement} html\n */\nexport function trackStaleEditors(sheet, html) {\n  /** @type {HTMLElement[]} */\n  const editors = html.querySelectorAll(\"prose-mirror.active\");\n  for (const editor of editors) {\n    if (!sheet.constructor.EDIT_TRACKING?.includes(editor.name)) continue;\n\n    editor.classList.add(\"stale-editor\");\n    editor.addEventListener(\"change\", (ev) => editor.classList.remove(\"stale-editor\"), { once: true });\n  }\n}\n","const { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nexport class ActionSelector extends HandlebarsApplicationMixin(DocumentSheetV2) {\n  static DEFAULT_OPTIONS = {\n    classes: [\"pf1-v2\", \"action-selector\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    actions: {\n      click: ActionSelector._onClickAction,\n    },\n    position: {\n      width: 390,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/action-select.hbs\",\n    },\n  };\n\n  get item() {\n    return this.document;\n  }\n\n  get title() {\n    return game.i18n.format(\"FFD20.Application.ActionSelector.Title\", {\n      actor: this.item.actor.name,\n      item: this.item.name,\n    });\n  }\n\n  async _prepareContext() {\n    return {\n      actions: this.item.actions,\n    };\n  }\n\n  static _onClickAction(event) {\n    event.preventDefault();\n\n    const target = event.target.closest(\"[data-action]\");\n    this.resolve(target.dataset?.id);\n    this.close();\n  }\n\n  close(...args) {\n    this.resolve(null);\n    super.close(...args);\n  }\n\n  /**\n   * @param {object} options - Options\n   * @param {ItemPF} options.document - Item to select action for.\n   * @param {object} renderOptions - Options passed to application rendering\n   * @returns {Promise<ChatMessage|object|undefined>} - Result of ItemPF.use() for selected action\n   */\n  static async open(options) {\n    return new Promise((resolve) => {\n      const selector = new this(options);\n      selector.resolve = resolve;\n      selector.render(true);\n    });\n  }\n}\n","import { RollPF } from \"@dice/roll.mjs\";\n\nexport class ChatAttack {\n  /** @type {ItemAction} */\n  action;\n\n  /** @type {ffd20.actionUse.ActionUse} */\n  actionUse;\n\n  /** @type {D20RollPF | null} */\n  attack = null;\n  hasRange = false;\n  /** @type {D20RollPF | null} */\n  critConfirm = null;\n\n  hasAttack = false;\n  hasCritConfirm = false;\n\n  hasDamage = false;\n  damage = new AttackDamage();\n  damageRows = [];\n  nonlethal = false;\n  manadamage = false;\n  critDamage = new AttackDamage();\n\n  ammo = null;\n\n  hasCards = false;\n  cards = {};\n\n  effectNotes = [];\n  effectNotesHTML = \"\";\n  notesOnly = true;\n\n  targets = null;\n\n  constructor(action, { label = \"\", rollData = {}, targets = null, actionUse = null } = {}) {\n    this.actionUse = actionUse;\n    this.rollData = rollData;\n    this.setAction(action);\n    this.label = label;\n    this.hasRange = action.item.hasRange;\n    this.targets = targets;\n  }\n\n  /** @type {Actor} */\n  get actor() {\n    return this.action?.actor;\n  }\n\n  setAmmo(ammoId) {\n    const ammoItem = this.actor.items.get(ammoId);\n    if (!ammoItem) {\n      this.ammo = null;\n      return;\n    }\n\n    this.ammo = {\n      id: ammoId,\n      img: ammoItem.img,\n      name: ammoItem.name,\n      misfire: false,\n    };\n  }\n\n  /**\n   * Sets the attack's item reference.\n   *\n   * @param {ItemAction} action - The action to reference.\n   */\n  setAction(action) {\n    if (action == null) {\n      this.rollData = null;\n      this.action = null;\n      return;\n    }\n\n    this.action = action;\n    this.isHealing = action.isHealing;\n\n    this.setRollData();\n  }\n\n  /**\n   * Applies changes to the roll data.\n   */\n  setRollData() {\n    const rollData = this.rollData;\n\n    // Set critical hit multiplier\n    rollData.critMult = 1;\n    rollData.critCount = 0;\n\n    // Determine ability multiplier\n    const held = rollData.action?.held || rollData.item?.held || \"1h\";\n    rollData.ablMult = rollData.action.ability.damageMult ?? ffd20.config.abilityDamageHeldMultipliers[held] ?? 1;\n  }\n\n  async setEffectNotesHTML() {\n    if (this.effectNotes.length === 0) {\n      this.effectNotesHTML = \"\";\n      return;\n    }\n\n    const content = await renderTemplate(\"systems/ffd20/templates/chat/parts/item-notes.hbs\", {\n      notes: this.effectNotes,\n      css: \"effect-notes\",\n      header: game.i18n.localize(\"FFD20.EffectNotes\"),\n    });\n\n    const enrichOptions = {\n      rollData: this.rollData,\n      relativeTo: this.action.actor,\n    };\n\n    this.effectNotesHTML = await TextEditor.enrichHTML(content, enrichOptions);\n  }\n\n  async addAttack({ noAttack = false, bonus = null, extraParts = [], critical = false, conditionalParts = {} } = {}) {\n    if (!this.action.item) return;\n\n    const actor = this.action.actor;\n\n    this.hasAttack = true;\n    this.notesOnly = false;\n\n    const extraChanges = [];\n\n    /** @type {D20RollPF} */\n    if (critical === true) {\n      if (this.action.critConfirmBonus) {\n        const critConfirm = this.action.critConfirmBonus;\n        const parsedConfirmResult = RollPF.parse(critConfirm);\n        if (parsedConfirmResult.length > 1)\n          extraParts.push(`(${critConfirm})[${game.i18n.localize(\"FFD20.CriticalConfirmation\")}]`);\n        else if (parsedConfirmResult[0].flavor) extraParts.push(critConfirm);\n        else extraParts.push(`${critConfirm}[${game.i18n.localize(\"FFD20.CriticalConfirmation\")}]`);\n      }\n\n      extraChanges.push(...actor.changes.filter((c) => c.target === \"critConfirm\"));\n\n      // Add conditionals for critical confirmation\n      if (conditionalParts[\"attack.crit\"]?.length) extraParts.push(...conditionalParts[\"attack.crit\"]);\n    } else {\n      // Add conditional attack bonus\n      if (conditionalParts[\"attack.normal\"]?.length) extraParts.push(...conditionalParts[\"attack.normal\"]);\n    }\n\n    // Add broken penalty\n    const broken = this.rollData.item.broken;\n    if (broken && !critical) {\n      const label = game.i18n.localize(\"FFD20.Broken\");\n      extraParts.push(`-2[${label}]`);\n    }\n\n    // Armor as DR\n    if (!noAttack) {\n      if (critical && !game.settings.get(\"ffd20\", \"critConfirm\")) {\n        // Defense DC\n        this.critConfirm = this.actionUse?.getDefenseDC(this.attack) ?? RollPF.safeRollSync(\"0\");\n        this.critConfirm.armorAsDR = true;\n        this.critConfirm.options.flavor = game.i18n.localize(\"FFD20.Critical\");\n        noAttack = true;\n      }\n    }\n\n    // Remove empty parts (e.g. zero iterative penalty)\n    extraParts = extraParts.filter((p) => p && p != 0);\n\n    // Roll attack\n    if (!noAttack) {\n      const roll = await this.action.rollAttack({\n        data: this.rollData,\n        bonus,\n        extraParts,\n        extraChanges,\n      });\n\n      if (critical === true) this.critConfirm = roll;\n      else {\n        this.attack = roll;\n        this.method = CONFIG.Dice.fulfillment.methods[roll.d20.method];\n      }\n\n      // Add crit confirm\n      const baseCritMult = this.rollData.action.ability.critMult ?? 1;\n      if (!critical && !this.action.isCombatManeuver && roll.isCrit && baseCritMult > 1) {\n        this.hasCritConfirm = true;\n        this.rollData.critMult = Math.max(1, baseCritMult + (this.rollData.critMultBonus ?? 0));\n        if (broken) this.rollData.critMult = 1;\n\n        await this.addAttack({ bonus, extraParts, critical: true, conditionalParts });\n      }\n\n      // Add tooltip\n      roll.options.flavor = critical ? game.i18n.localize(\"FFD20.CriticalConfirmation\") : this.label;\n    }\n  }\n\n  async addDamage({ flavor = null, extraParts = [], critical = false, conditionalParts = {} } = {}) {\n    if (!this.action.item) return;\n\n    this.hasDamage = true;\n    this.notesOnly = false;\n    let data = this.damage;\n    if (critical === true) data = this.critDamage;\n\n    const rollData = foundry.utils.deepClone(this.rollData);\n    // Enforce critical multiplier\n    rollData.critCount = 0;\n\n    // Roll damage\n    const repeatCount = critical ? Math.max(1, rollData.critMult - 1) : 1;\n    for (let repeat = 0; repeat < repeatCount; ++repeat) {\n      if (critical) rollData.critCount++;\n      data.rolls.push(\n        ...(await this.action.rollDamage({\n          data: rollData,\n          extraParts,\n          critical,\n          conditionalParts,\n        }))\n      );\n    }\n\n    // Add normal data\n    if (!flavor) {\n      if (!critical) flavor = this.isHealing ? game.i18n.localize(\"FFD20.Healing\") : game.i18n.localize(\"FFD20.Damage\");\n      else flavor = game.i18n.localize(\"FFD20.DamageCritical\");\n    }\n\n    // Determine total damage\n    let totalDamage = data.rolls.reduce((cur, p) => {\n      return cur + p.total;\n    }, 0);\n    if (critical) {\n      totalDamage = this.damage.rolls.reduce((cur, p) => {\n        return cur + p.total;\n      }, totalDamage);\n    }\n\n    // Handle minimum damage rule\n    if (totalDamage < 1) {\n      totalDamage = 1;\n      flavor = game.i18n.localize(\"FFD20.Nonlethal\");\n      this.nonlethal = true;\n    }\n\n    // Handle nonlethal attacks\n    if (this.rollData.action.nonlethal || this.action.item.system.properties?.nnl) {\n      this.nonlethal = true;\n      flavor = game.i18n.localize(\"FFD20.Nonlethal\");\n    }\n\n    // Handle manadamage attacks\n    if (this.rollData.action.manadamage) {\n      this.manadamage = true;\n      if (this.isHealing){\n        flavor = game.i18n.localize(\"FFD20.ManaHealing\");\n      } else {\n        flavor = game.i18n.localize(\"FFD20.ManaDamage\");\n      }\n    }\n\n    // Finalize data\n    data.flavor = flavor;\n    data.total = totalDamage;\n  }\n\n  async addEffectNotes({ rollData } = {}) {\n    this.effectNotes = [];\n\n    const item = this.action.item;\n    if (!item) return;\n\n    const actor = item.actor;\n\n    if (actor) {\n      const noteSources = [\"attacks.effect\"];\n      if (item.type === \"spell\") noteSources.push(\"spellEffect\"); // Spell specific notes\n\n      for (const source of noteSources) {\n        this.effectNotes.push(...(await actor.getContextNotesParsed(source, { rollData })));\n      }\n    }\n\n    // Add item notes\n    if (item.system.effectNotes?.length) {\n      this.effectNotes.push(...item.system.effectNotes.map((text) => ({ text })));\n    }\n    // Add action notes\n    if (this.action.notes.effect.length) {\n      this.effectNotes.push(...this.action.notes.effect.map((text) => ({ text })));\n    }\n\n    // Misfire\n    if (this.ammo?.misfire) {\n      let label = game.i18n.localize(\"FFD20.Misfire\");\n      const explosionRadius = this.action.item?.system.ammo?.explode ?? 0;\n      if (explosionRadius) {\n        const radius = ffd20.utils.convertDistance(explosionRadius, \"ft\")[0];\n        const unit =\n          ffd20.utils.getDistanceSystem() === \"metric\" ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n        label += ` (${radius} ${unit})`;\n      }\n      this.effectNotes.push({ text: label });\n    }\n\n    await this.setEffectNotesHTML();\n  }\n\n  _createInlineRoll(roll, d20 = false, critical = false) {\n    const classes = [\"inline-dsn-hidden\"];\n    if (d20) {\n      if (critical && roll.armorAsDR) classes.push(\"defense-dc\");\n      if (roll.isNat20) classes.push(\"natural-20\", \"success\");\n      if (roll.isNat1) classes.push(\"natural-1\", \"failure\");\n      if (!critical && roll.isCrit) classes.push(\"critical-threat\");\n    }\n    return roll.toAnchor({ classes });\n  }\n\n  /**\n   * Generate inline rolls\n   */\n  _createInlineRolls() {\n    if (this.attack) this.attack.inlineRoll = this._createInlineRoll(this.attack, true);\n    if (this.critConfirm) this.critConfirm.inlineRoll = this._createInlineRoll(this.critConfirm, true, true);\n\n    for (const row of this.damageRows) {\n      if (row.normal) row.normal.inlineRoll = this._createInlineRoll(row.normal);\n      if (row.crit) row.crit.inlineRoll = this._createInlineRoll(row.crit);\n    }\n  }\n\n  finalize() {\n    this.hasCards = Object.keys(this.cards).length > 0;\n\n    // Determine damage rows for chat cards\n    // this.damageRows = [];\n    for (let a = 0; a < Math.max(this.damage.rolls.length, this.critDamage.rolls.length); a++) {\n      this.damageRows.push({ normal: null, crit: null });\n    }\n    for (let a = 0; a < this.damage.rolls.length; a++) {\n      this.damageRows[a].normal = this.damage.rolls[a];\n    }\n    for (let a = 0; a < this.critDamage.rolls.length; a++) {\n      this.damageRows[a].crit = this.critDamage.rolls[a];\n    }\n\n    this._createInlineRolls();\n\n    return this;\n  }\n}\n\nclass AttackDamage {\n  flavor = \"\";\n\n  total = 0;\n\n  /** @type {DamageRoll[]} */\n  rolls = [];\n\n  get isActive() {\n    return this.rolls.length > 0;\n  }\n\n  get half() {\n    return Math.floor(this.total / 2);\n  }\n}\n","import { ChatAttack } from \"./chat-attack.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\n// Documentation/type imports\n/** @typedef {import(\"@item/item-pf.mjs\").SharedActionData} SharedActionData */\n/** @typedef {ffd20.documents.item.ItemPF} ItemPF */\n/** @typedef {ffd20.documents.actor.ActorPF} ActorPF */\n/** @typedef {ffd20.components.ItemAction} ItemAction */\n\n/**\n * Error states for when an item does not meet the requirements for an attack.\n *\n * @enum {number}\n * @readonly\n */\nexport const ERR_REQUIREMENT = Object.freeze({\n  NO_ACTOR_PERM: 1,\n  DISABLED: 2,\n  INSUFFICIENT_QUANTITY: 3,\n  INSUFFICIENT_CHARGES: 4,\n  MISSING_AMMO: 5,\n  INSUFFICIENT_AMMO: 6,\n  DISALLOWED_ACTION_TYPE: 7,\n});\n\nexport class ActionUse {\n  /**\n   * The actor this action use is based on.\n   *\n   * @type {ActorPF}\n   */\n  actor;\n  /**\n   * The actor this action use is based on.\n   *\n   * @type {TokenDocument}\n   */\n  token;\n\n  /**\n   * The item this action use is based on.\n   *\n   * @type {ItemPF}\n   */\n  item;\n  /**\n   * The action this action use is based on.\n   *\n   * @type {ItemAction}\n   */\n  action;\n  /**\n   * The shared data object holding all relevant data for this action use.\n   *\n   * @type {SharedActionData}\n   */\n  shared;\n\n  /**\n   * @param {Partial<SharedActionData>} [shared={}] - The shared context for this action use\n   */\n  constructor(shared = {}) {\n    Object.defineProperties(this, {\n      shared: { value: shared },\n      item: { value: shared.item },\n      action: { value: shared.action },\n      actor: { value: shared.item.actor },\n      token: { value: shared.token },\n    });\n\n    // Init some shared data\n    this.shared.templateData = {\n      action: this.shared.action,\n      item: this.shared.item,\n    };\n  }\n\n  /**\n   * @returns {Promise<number>} - 0 when successful, otherwise one of the ERR_REQUIREMENT constants.\n   */\n  checkRequirements() {\n    if (this.action.isCombatManeuver && this.actor.system.config?.noManeuvers) {\n      ui.notifications.warn(game.i18n.format(\"FFD20.Error.DisallowedActionType\", { name: actor.name }));\n      return ERR_REQUIREMENT.DISALLOWED_ACTION_TYPE;\n    }\n\n    const actor = this.item.actor;\n    if (actor && !actor.isOwner) {\n      ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: actor.name }));\n      return ERR_REQUIREMENT.NO_ACTOR_PERM;\n    }\n\n    if (this.item.type === \"feat\" && this.item.system.disabled) {\n      ui.notifications.warn(game.i18n.localize(\"FFD20.Error.FeatDisabled\"));\n      return ERR_REQUIREMENT.DISABLED;\n    }\n\n    // Cost override set to 0 or to increase charges/quantity\n    if (this.shared.cost !== null && this.shared.cost <= 0) return 0;\n\n    if (this.item.isPhysical) {\n      const itemQuantity = this.item.system.quantity || 0;\n      if (itemQuantity <= 0) {\n        ui.notifications.warn(game.i18n.localize(\"FFD20.Error.NoQuantity\"));\n        return ERR_REQUIREMENT.INSUFFICIENT_QUANTITY;\n      }\n    }\n\n    if (this.action.isSelfCharged && this.action.uses.self?.value < 1) {\n      ui.notifications.warn(\n        game.i18n.format(\"FFD20.Error.InsufficientCharges\", {\n          name: `${this.item.name}: ${this.action.name}`,\n        })\n      );\n      return ERR_REQUIREMENT.INSUFFICIENT_CHARGES;\n    }\n\n    return 0;\n  }\n\n  /**\n   * @returns {Promise<object>} The roll data object for this attack.\n   */\n  getRollData() {\n    const rollData = this.shared.action.getRollData({ cache: false });\n\n    const d20 = this.shared.dice;\n    // TODO: Move this standard roll obfuscation to dialog handling\n    rollData.d20 = d20 === ffd20.dice.D20RollPF.standardRoll ? \"\" : d20;\n\n    // Init values\n    rollData.dcBonus ||= 0;\n    rollData.chargeCost ||= 0;\n    rollData.chargeCostBonus ||= 0;\n\n    rollData.critMultBonus ||= 0;\n\n    this.shared.rollData = rollData;\n  }\n\n  /**\n   * Creates and renders an attack roll dialog, and returns a result.\n   *\n   * @returns {Promise<ItemAttack_Dialog_Result|null>} - Attack dialog result or null if cancelled.\n   */\n  createAttackDialog() {\n    const dialog = new ffd20.applications.AttackDialog(this);\n    return dialog.show();\n  }\n\n  /**\n   * Alters roll (and shared) data based on user input during the attack's dialog.\n   *\n   * @param {object} formData - The attack dialog's form data\n   */\n  alterRollData(formData = {}) {\n    const rollData = this.shared.rollData;\n\n    const useOptions = this.shared.useOptions;\n    formData[\"power-attack\"] ??= useOptions.powerAttack;\n    formData[\"primary-attack\"] ??= useOptions.primaryAttack;\n    formData[\"cl-check\"] ??= useOptions.clCheck ?? this.item?.system.clCheck === true;\n    formData[\"measure-template\"] ??= useOptions.measureTemplate;\n    formData[\"haste-attack\"] ??= useOptions.haste;\n    formData[\"manyshot\"] ??= useOptions.manyshot;\n    formData[\"rapid-shot\"] ??= useOptions.rapidShot;\n    formData[\"damage-ability-multiplier\"] ??= useOptions.abilityMult;\n    formData.fullAttack ??= true;\n\n    if (formData[\"d20\"]) rollData.d20 = formData[\"d20\"];\n    const atkBonus = formData[\"attack-bonus\"];\n    if (atkBonus) {\n      this.shared.attackBonus.push(atkBonus);\n    }\n    const dmgBonus = formData[\"damage-bonus\"];\n    if (dmgBonus) {\n      this.shared.damageBonus.push(dmgBonus);\n    }\n\n    if (formData.rollMode) this.shared.rollMode = formData.rollMode;\n\n    // Point-Blank Shot\n    if (formData[\"point-blank-shot\"]) {\n      this.shared.attackBonus.push(`1[${game.i18n.localize(\"FFD20.PointBlankShot\")}]`);\n      this.shared.damageBonus.push(`1[${game.i18n.localize(\"FFD20.PointBlankShot\")}]`);\n      this.shared.pointBlankShot = true;\n    }\n\n    if (formData[\"flanking\"]) {\n      this.shared.attackBonus.push(`2[${game.i18n.localize(\"FFD20.Flanking\")}]`);\n      this.shared.flanking = true;\n    }\n\n    if (formData[\"highGround\"]) {\n      this.shared.attackBonus.push(`1[${game.i18n.localize(\"FFD20.HighGround\")}]`);\n      this.shared.highGround = true;\n    }\n\n    if (formData[\"charge\"]) {\n      this.shared.attackBonus.push(`2[${game.i18n.localize(\"FFD20.Charge\")}]`);\n      this.shared.charge = true;\n    }\n\n    this.shared.fullAttack = formData.fullAttack;\n    rollData.fullAttack = this.shared.fullAttack ? 1 : 0;\n\n    // Many-shot\n    if (this.shared.fullAttack && formData[\"manyshot\"]) {\n      this.shared.manyShot = true;\n    }\n\n    // Rapid Shot\n    if (this.shared.fullAttack && formData[\"rapid-shot\"]) {\n      this.shared.attackBonus.push(`-2[${game.i18n.localize(\"FFD20.RapidShot\")}]`);\n    }\n\n    // Primary attack\n    if (formData[\"primary-attack\"] != null)\n      foundry.utils.setProperty(rollData, \"action.naturalAttack.primary\", formData[\"primary-attack\"]);\n\n    // Use measure template\n    if (formData[\"measure-template\"] != null) this.shared.useMeasureTemplate = formData[\"measure-template\"];\n\n    // Set held type\n    const held = formData[\"held\"] || rollData.action.held || rollData.item.held || \"1h\";\n    rollData.action.held = held;\n\n    // Damage multiplier\n    const abilityDamageMultOverride = formData[\"damage-ability-multiplier\"];\n    if (abilityDamageMultOverride != null) {\n      rollData.action.ability.damageMult = abilityDamageMultOverride;\n    }\n\n    // Power Attack\n    if (formData[\"power-attack\"]) {\n      const basePowerAttackBonus = rollData.action?.powerAttack?.damageBonus ?? 2;\n      let powerAttackBonus = (1 + Math.floor(rollData.attributes.bab.total / 4)) * basePowerAttackBonus;\n\n      // Get multiplier\n      const paMult = this.shared.action.getPowerAttackMult({ rollData });\n\n      // Apply multiplier\n      powerAttackBonus = Math.floor(powerAttackBonus * paMult);\n\n      // Get label\n      const label = [\"rwak\", \"twak\", \"rsak\"].includes(this.action.actionType)\n        ? game.i18n.localize(\"FFD20.DeadlyAim\")\n        : game.i18n.localize(\"FFD20.PowerAttack\");\n\n      // Get penalty\n      const powerAttackPenalty = -(1 + Math.floor(rollData.bab / 4));\n\n      // Add bonuses\n      rollData.powerAttackPenalty = powerAttackPenalty;\n      this.shared.attackBonus.push(`${powerAttackPenalty}[${label}]`);\n      this.shared.powerAttack = true;\n      rollData.powerAttackBonus = powerAttackBonus;\n      rollData.powerAttackPenalty = powerAttackPenalty;\n    } else {\n      rollData.powerAttackBonus = 0;\n      rollData.powerAttackPenalty = 0;\n    }\n\n    // Conditionals\n    const { conditionals } = foundry.utils.expandObject(formData);\n\n    if (conditionals) {\n      this.shared.conditionals = [];\n      Object.entries(conditionals).forEach(([condId, enabled]) => {\n        if (enabled) this.shared.conditionals.push(condId);\n      });\n    }\n    // Conditional defaults for fast-forwarding\n    if (!this.shared.conditionals) {\n      this.shared.conditionals = this.shared.action.conditionals?.reduce((arr, con) => {\n        if (con.default) arr.push(con.id);\n        return arr;\n      }, []);\n    }\n\n    // Apply secondary attack penalties\n    if (rollData.item.subType === \"natural\" && rollData.action?.naturalAttack.primary === false) {\n      const attackBonus =\n        rollData.action.naturalAttack?.secondary?.attackBonus || ffd20.config.naturalAttacks.secondary.penalty;\n      let damageMult = rollData.action.naturalAttack?.secondary?.damageMult ?? 0.5;\n      // Allow dialog override to work\n      if (abilityDamageMultOverride) damageMult = abilityDamageMultOverride;\n      this.shared.attackBonus.push(`(${attackBonus})[${game.i18n.localize(\"FFD20.SecondaryAttack\")}]`);\n      rollData.action.ability.damageMult = damageMult;\n    }\n\n    // CL check enabled\n    this.shared.casterLevelCheck = formData[\"cl-check\"];\n\n    // Concentration enabled\n    this.shared.concentrationCheck = formData[\"concentration\"];\n  }\n\n  /**\n   * @typedef {object} ItemAttack_AttackData\n   * @property {string} label - The attack's name\n   * @property {number|string|undefined} [attackBonus] - An attack bonus specific to this attack\n   * @property {number|string|undefined} [damageBonus] - A damage bonus specific to this attack\n   * @property {string|null} [ammo] - The ID of the ammo item used\n   */\n  /**\n   * Generates attacks for an item's action.\n   *\n   * @param {boolean} [forceFullAttack=false] - Generate full attack data, e.g. as base data for an {@link AttackDialog}\n   * @returns {Promise<ItemAttack_AttackData[]> | ItemAttack_AttackData[]} The generated default attacks.\n   */\n  generateAttacks(forceFullAttack = false) {\n    const rollData = this.shared.rollData;\n    const action = this.action;\n\n    // Use either natural fullAttack state, or force generation of all attacks via override\n    const full = forceFullAttack || this.shared.fullAttack;\n\n    /** @type {Array<ActionUseAttack>} */\n    const allAttacks = this.action\n      .getAttacks({ full, rollData, conditionals: false, bonuses: false, resolve: false })\n      .map((atk) => new ActionUseAttack(atk.label, atk.bonus));\n\n    // Set default ammo usage\n    const ammoType = this.action.ammo.type;\n    if (ammoType) {\n      const ammoId = this.item.system.ammo?.default;\n      const ammos = this.getAmmo();\n      if (ammoId && ammos.length) {\n        const ammo = ammos.find((a) => a.id === ammoId);\n        const quantity = ammo?.quantity || 0;\n        const ammoCost = action.ammo.cost;\n        const abundant = ammo?.abundant || false;\n        for (let a = 0; a < allAttacks.length; a++) {\n          const atk = allAttacks[a];\n          if (abundant || quantity >= (a + 1) * ammoCost) atk.ammo = ammo;\n          else atk.ammo = null;\n        }\n      }\n    }\n\n    this.shared.attacks = allAttacks;\n\n    return allAttacks;\n  }\n\n  async autoSelectAmmo() {\n    const ammoType = this.shared.action.ammo.type;\n    if (!ammoType) return;\n\n    const ammoCost = this.action.ammo.cost;\n\n    const item = this.item.defaultAmmo;\n    if (item && (item.system.quantity || 0) >= ammoCost) return;\n\n    const ammo = this.actor.itemTypes.loot\n      .filter(\n        (i) =>\n          i.subType === \"ammo\" &&\n          i.system.extraType === ammoType &&\n          i.system.quantity >= ammoCost &&\n          i.system.identified !== false\n      )\n      .sort((a, b) => a.system.price - b.system.price);\n\n    if (ammo.length == 0) return;\n\n    await this.item.update({ \"system.ammo.default\": ammo[0].id });\n  }\n\n  /**\n   * Fetch valid ammo items from actor.\n   *\n   * @returns {AttackAmmo[]} - Available ammo options\n   */\n  getAmmo() {\n    const actor = this.actor;\n    const ammoCost = this.action.ammo.cost;\n    const availableAmmo = actor.itemTypes.loot.filter((item) => this._filterAmmo(item, ammoCost));\n\n    const defaultAmmo = this.action.item.defaultAmmo;\n\n    return availableAmmo.map((ammo) => ({\n      id: ammo.id,\n      quantity: ammo.system.quantity || 0,\n      abundant: ammo.system.abundant || false,\n      data: ammo.toObject(),\n      document: ammo,\n      isDefault: defaultAmmo === ammo,\n    }));\n  }\n\n  /**\n   * Determine if item is valid for use as ammo.\n   *\n   * @internal\n   * @param {Item} item - Item to filter\n   * @param {number} ammoCost - Ammo usage per attack\n   * @returns {boolean} - Whether the provide ammo is valid.\n   */\n  _filterAmmo(item, ammoCost = 1) {\n    if (!(item.type === \"loot\" && item.subType === \"ammo\")) return false;\n    if (item.system.quantity < ammoCost) return false;\n\n    const ammoType = item.system.extraType;\n    if (!ammoType) return true;\n\n    return this.action.ammo.type === ammoType;\n  }\n\n  /**\n   * Subtracts ammo for this attack, updating relevant items with new quantities.\n   *\n   * @param {number} [value=1] - How much ammo to subtract.\n   * @returns {Promise} - Promise that resolves once ammo update is complete.\n   */\n  async subtractAmmo(value = 1) {\n    if (!this.shared.action.ammo.type) return;\n\n    const actor = this.item.actor;\n\n    const ammoUsage = {};\n    for (const atk of this.shared.attacks) {\n      if (atk.ammo) {\n        const item = actor.items.get(atk.ammo.id);\n        if (!item) continue;\n        // Don't remove abundant ammunition\n        if (item.system.abundant) continue;\n\n        ammoUsage[atk.ammo.id] ??= 0;\n        ammoUsage[atk.ammo.id] += value;\n      }\n    }\n\n    this.shared.ammoUsage = ammoUsage;\n\n    if (!foundry.utils.isEmpty(ammoUsage)) {\n      const updateData = Object.entries(ammoUsage).reduce((cur, [ammoId, usage]) => {\n        const quantity = this.item.actor.items.get(ammoId)?.system.quantity;\n        const obj = {\n          _id: ammoId,\n          \"system.quantity\": quantity - usage,\n        };\n\n        cur.push(obj);\n        return cur;\n      }, []);\n\n      return this.item.actor.updateEmbeddedDocuments(\"Item\", updateData);\n    }\n  }\n\n  /**\n   * Update remaining ammo in {@link ChatAttack}s\n   */\n  updateAmmoUsage() {\n    const actor = this.actor;\n    const ammoCost = this.action.ammo.cost;\n    if (ammoCost <= 0) return;\n    for (const atk of this.shared.attacks) {\n      const ammoId = atk.ammo?.id;\n      if (!ammoId) continue;\n      const chatAtk = atk.chatAttack;\n      const ammo = actor.items.get(ammoId)?.system.quantity || 0;\n      chatAtk.ammo.remaining = ammo;\n      chatAtk.ammo.quantity = ammoCost;\n    }\n  }\n\n  async handleConditionals() {\n    if (!this.shared.conditionals?.length) return;\n\n    const rollDataConds = {};\n\n    for (const condId of this.shared.conditionals) {\n      const conditional = this.shared.action.conditionals.get(condId);\n      if (!conditional.name) {\n        console.warn(\"Ignored unnamed conditional\", { conditional, actionUse: this });\n        continue;\n      }\n\n      const tag = ffd20.utils.createTag(conditional.name);\n      for (const [modKey, modifier] of conditional.modifiers.entries()) {\n        // Ignore modifiers with nonexisting formula or formulas that equal to zero\n        if (modifier.formula == 0) {\n          console.warn(\"Ignored ineffective conditional modifier\", { modifier, actionUse: this });\n          continue;\n        }\n\n        // Adds a formula's result to rollData to allow referencing it.\n        // Due to being its own roll, this will only correctly work for static formulae.\n        const conditionalRoll = await RollPF.safeRoll(modifier.formula, this.shared.rollData, undefined, undefined, {\n          allowInteractive: false,\n        });\n        if (conditionalRoll.err) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.Warning.ConditionalRoll\", { number: modKey + 1, name: conditional.name })\n          );\n          // Skip modifier to avoid multiple errors from one non-evaluating entry\n          continue;\n        }\n\n        rollDataConds[tag] ??= {};\n        rollDataConds[tag][modKey] = conditionalRoll.total;\n\n        // Create a key string for the formula array\n        const partString = modifier.partID;\n\n        // Add formula in simple format\n        switch (modifier.target) {\n          case \"attack\":\n          case \"effect\":\n          case \"misc\":\n          case \"dc\":\n          case \"cl\": {\n            const hasFlavor = /\\[.*\\]/.test(modifier.formula);\n            const flavoredFormula = hasFlavor ? modifier.formula : `(${modifier.formula})[${conditional.name}]`;\n            this.shared.conditionalPartsCommon[partString] = [\n              ...(this.shared.conditionalPartsCommon[partString] ?? []),\n              flavoredFormula,\n            ];\n            break;\n          }\n          // Add formula as array for damage\n          case \"damage\":\n            this.shared.conditionalPartsCommon[partString] = [\n              ...(this.shared.conditionalPartsCommon[partString] ?? []),\n              [modifier.formula, modifier.damageType, false],\n            ];\n            break;\n          // Add formula to the size property\n          case \"size\":\n            this.shared.rollData.size += conditionalRoll.total;\n            if (this.shared.rollData.item) {\n              this.shared.rollData.item.size += conditionalRoll.total;\n            }\n            break;\n          case \"critMult\":\n            this.shared.rollData.critMultBonus += conditionalRoll.total;\n            break;\n          default:\n            console.warn(\"Invalid conditional target:\", modifier.target);\n            break;\n        }\n      }\n    }\n\n    // Expand data into rollData to enable referencing in formulae\n    this.shared.rollData.conditionals = rollDataConds;\n\n    // Add specific pre-rolled rollData entries\n    for (const target of [\"cl\", \"dc\", \"charges\"]) {\n      const cond = this.shared.conditionalPartsCommon[target];\n      if (!cond) continue;\n      const formula = cond.join(\" + \");\n      const roll = await RollPF.safeRoll(formula, this.shared.rollData, [target, formula]);\n      switch (target) {\n        case \"cl\":\n          this.shared.rollData.cl += roll.total;\n          break;\n        case \"dc\":\n          this.shared.rollData.dcBonus += roll.total;\n          break;\n        case \"charges\":\n          this.shared.rollData.chargeCostBonus += roll.total;\n          break;\n      }\n    }\n  }\n\n  /**\n   * Checks all requirements to make the attack. This is after the attack dialog's data has been parsed.\n   *\n   * @returns {Promise<number> | number} 0 if successful, otherwise one of the ERR_REQUIREMENT constants.\n   */\n  checkAttackRequirements() {\n    let cost = this.shared.rollData.chargeCost;\n\n    const isSpell = this.item.type === \"spell\";\n\n    if (cost > 0) {\n      const uses = this.item.charges;\n      if (isSpell) {\n        if (this.item.spellbook?.spontaneous && !this.item.system.preparation?.value) {\n          cost = Infinity;\n        }\n      }\n\n      // Cancel usage on insufficient charges\n      if (cost > uses) {\n        // Only spells have variable max uses\n        if (isSpell && this.item.maxCharges <= 0) {\n          ui.notifications.warn(game.i18n.format(\"FFD20.Error.InsufficientPreparation\", { name: this.item.name }));\n        } else {\n          ui.notifications.warn(game.i18n.format(\"FFD20.Error.InsufficientCharges\", { name: this.item.name }));\n        }\n        return ERR_REQUIREMENT.INSUFFICIENT_CHARGES;\n      }\n    }\n\n    return 0;\n  }\n\n  /**\n   * Generates ChatAttack entries based off the attack type.\n   */\n  async generateChatAttacks() {\n    // Normal attack(s)\n    if (this.shared.action.hasAttack) await this.addAttacks();\n    // Damage only\n    else if (this.shared.action.hasDamage) await this.addDamage();\n    // for effect notes only\n    else await this.addEmptyAttack();\n\n    const misfire = this.action.misfire ?? 0;\n\n    // Fill in ammo use details\n    this.shared.attacks.forEach((/** @type {ChatAttack}*/ attack) => {\n      if (!attack.hasAmmo) return;\n      /** @type {ChatAttack} */\n      const atk = attack.chatAttack;\n      if (atk) atk.setAmmo(attack.ammo.id);\n      // Mark misfire\n      if (atk.ammo) {\n        const d20 = atk.attack?.d20?.total;\n        atk.ammo.misfire = d20 <= misfire;\n      }\n    });\n\n    // Add save info\n    this.shared.save = this.shared.action.save.type;\n    this.shared.saveDC = this.shared.action.getDC(this.shared.rollData);\n  }\n\n  /**\n   * Determines conditional parts used in a specific attack.\n   *\n   * @param {object} atk - The attack used.\n   * @param {number} [index=0] - The index of the attack, in order of enabled attacks.\n   * @returns {object} The conditional parts used.\n   */\n  _getConditionalParts(atk, { index = 0 }) {\n    const result = {};\n\n    const conditionalTemplates = {\n      \"attack.normal\": \"attack.;id;.normal\",\n      \"attack.crit\": \"attack.;id;.crit\",\n      \"damage.normal\": \"damage.;id;.normal\",\n      \"damage.crit\": \"damage.;id;.crit\",\n      \"damage.nonCrit\": \"damage.;id;.nonCrit\",\n    };\n    const addPart = (id) => {\n      for (const [templateKey, templateStr] of Object.entries(conditionalTemplates)) {\n        if (!result[templateKey]) result[templateKey] = [];\n\n        const parsedStr = templateStr.replace(\";id;\", id);\n        result[templateKey].push(...(this.shared.conditionalPartsCommon[parsedStr] ?? []));\n      }\n    };\n\n    addPart(`attack_${index}`);\n    addPart(\"allAttack\");\n    addPart(\"allDamage\");\n\n    if (atk.type === \"rapid-shot\") {\n      addPart(\"rapidShotAttack\");\n      addPart(\"rapidShotDamage\");\n    } else if (atk.type === \"haste-attack\") {\n      addPart(\"hasteAttack\");\n      addPart(\"hasteDamage\");\n    }\n\n    return result;\n  }\n\n  /**\n   * Adds ChatAttack entries to an attack's shared context.\n   */\n  async addAttacks() {\n    const rollData = this.shared.rollData;\n\n    for (let a = 0; a < this.shared.attacks.length; a++) {\n      const atk = this.shared.attacks[a];\n\n      // Combine conditional modifiers for attack and damage\n      const conditionalParts = this._getConditionalParts(atk, { index: a });\n\n      rollData.attackCount = a;\n\n      // Create attack object\n      const attack = new ChatAttack(this.shared.action, {\n        label: atk.label,\n        rollData,\n        targets: game.user.targets,\n        actionUse: this,\n      });\n\n      if (atk.type !== \"manyshot\") {\n        // Add attack roll\n        await attack.addAttack({\n          extraParts: [...this.shared.attackBonus, atk.attackBonus],\n          conditionalParts,\n        });\n      }\n\n      // Add damage\n      if (this.shared.action.hasDamage) {\n        const extraParts = foundry.utils.deepClone(this.shared.damageBonus);\n        const nonCritParts = [];\n        const critParts = [];\n\n        // Add power attack bonus\n        if (rollData.powerAttackBonus > 0) {\n          // Get label\n          const label = [\"rwak\", \"twak\", \"rsak\"].includes(this.shared.action.actionType)\n            ? game.i18n.localize(\"FFD20.DeadlyAim\")\n            : game.i18n.localize(\"FFD20.PowerAttack\");\n\n          const powerAttackBonus = rollData.powerAttackBonus;\n          const powerAttackCritBonus = powerAttackBonus * (rollData.action?.powerAttack?.critMultiplier ?? 1);\n          nonCritParts.push(`${powerAttackBonus}[${label}]`);\n          critParts.push(`${powerAttackCritBonus}[${label}]`);\n        }\n\n        // Add damage\n        let flavor = null;\n        if (atk.type === \"manyshot\") flavor = game.i18n.localize(\"FFD20.Manyshot\");\n        await attack.addDamage({\n          flavor,\n          extraParts: [...extraParts, ...nonCritParts],\n          critical: false,\n          conditionalParts,\n        });\n\n        // Add critical hit damage\n        if (attack.hasCritConfirm) {\n          await attack.addDamage({ extraParts: [...extraParts, ...critParts], critical: true, conditionalParts });\n        }\n      }\n\n      // Add to list\n      this.shared.chatAttacks.push(attack);\n\n      // Add a reference to the attack that created this chat attack\n      atk.chatAttack = attack;\n    }\n\n    // Cleanup rollData\n    delete rollData.attackCount;\n  }\n\n  /**\n   * Adds a ChatAttack entry for damage to an attack's shared context.\n   */\n  async addDamage() {\n    // Set conditional modifiers\n    this.shared.conditionalParts = {\n      \"damage.normal\": this.shared.conditionalPartsCommon[\"damage.allDamage.normal\"] ?? [],\n    };\n\n    const attack = new ChatAttack(this.shared.action, {\n      rollData: this.shared.rollData,\n      primaryAttack: this.shared.primaryAttack,\n      actionUse: this,\n    });\n    // Add damage\n    await attack.addDamage({\n      extraParts: foundry.utils.deepClone(this.shared.damageBonus),\n      critical: false,\n      conditionalParts: this.shared.conditionalParts,\n    });\n\n    // Add to list\n    this.shared.chatAttacks.push(attack);\n  }\n\n  async addFootnotes() {\n    if (!this.item) return;\n\n    const actor = this.actor;\n    const rollData = this.shared.rollData;\n\n    const type = this.action.actionType;\n    const typeMap = {\n      rsak: [\"ranged\", \"rangedSpell\"],\n      rwak: [\"ranged\", \"rangedWeapon\"],\n      twak: [\"ranged\", \"thrownWeapon\", \"rangedWeapon\"],\n      rcman: [\"ranged\"],\n      mwak: [\"melee\", \"meleeWeapon\"],\n      msak: [\"melee\", \"meleeSpell\"],\n      mcman: [\"melee\"],\n    };\n\n    const isAttack = this.action.hasAttack ?? false;\n\n    const notes = [];\n    // Add actor notes for attacks\n    if (this.actor && isAttack) {\n      notes.push(...(await actor.getContextNotesParsed(\"attack\", { rollData })));\n      for (const subTarget of typeMap[type]) {\n        notes.push(...(await actor.getContextNotesParsed(subTarget, { rollData })));\n      }\n    }\n    // Add item notes\n    if (this.item?.system.attackNotes) {\n      notes.push(...this.item.system.attackNotes.map((text) => ({ text })));\n    }\n    // Add action notes\n    if (this.action.notes.footer) {\n      notes.push(...this.action.notes.footer.map((text) => ({ text })));\n    }\n\n    // Add CMB notes\n    if (this.action.isCombatManeuver) {\n      notes.push(...((await actor?.getContextNotesParsed(\"cmb\", { rollData })) ?? []));\n    }\n\n    if (isAttack) {\n      const hasCritConfirm = this.shared.attacks.some((atk) => !!atk.chatAttack?.hasCritConfirm);\n      if (hasCritConfirm) notes.push(...((await actor?.getContextNotesParsed(\"critical\", { rollData })) ?? []));\n    }\n\n    this.shared.templateData.footnotes = notes;\n  }\n\n  async addEmptyAttack() {\n    const attack = new ChatAttack(this.shared.action, {\n      rollData: this.shared.rollData,\n      primaryAttack: this.shared.primaryAttack,\n      actionUse: this,\n    });\n\n    // Add to list\n    this.shared.chatAttacks.push(attack);\n  }\n\n  /**\n   * Add effect notes for each individual attack.\n   */\n  async addEffectNotes() {\n    const promises = this.shared.chatAttacks\n      .filter((attack) => attack.type !== \"manyshot\")\n      .map((attack) => attack.addEffectNotes({ rollData: this.shared.rollData }));\n    await Promise.all(promises);\n  }\n\n  /**\n   * @typedef {object} Attack_MeasureTemplateResult\n   * @property {boolean} result - Whether an area was selected.\n   * @property {Function} [place] - Function to place the template, if an area was selected.\n   * @property {Function} [delete] - Function to delete the template, if it has been placed.\n   */\n  /**\n   * Prompts the user for an area, based on the attack's measure template.\n   *\n   * @returns {Promise.<Attack_MeasureTemplateResult|false|null>} Whether an area was selected, false if template placement is skipped, null if cancelled.\n   */\n  async promptMeasureTemplate() {\n    const mt = this.shared.action.measureTemplate;\n\n    // Determine size\n    let dist = RollPF.safeRollSync(mt.size, this.shared.rollData).total;\n    // Apply system of units conversion\n    dist = ffd20.utils.convertDistance(dist)[0];\n\n    // Abort template placement when it exceeds scene size\n    const { distancePixels, width, height } = canvas.scene.dimensions;\n    const maxDist = Math.max(width / distancePixels, height / distancePixels);\n    if (dist > maxDist) {\n      // TODO: Print notification about template placement skipping due to excessive size\n      console.debug(\"FFD20 | Action-Use | Template size exceeds maximum size\", { distance: dist, maximum: maxDist });\n      return false;\n    }\n\n    // Create data object\n    const templateData = {\n      type: mt.type,\n      color: mt.color,\n      texture: mt.texture,\n      distance: dist,\n      flags: {\n        ffd20: {\n          origin: {\n            uuid: this.shared.action.uuid,\n          },\n        },\n      },\n    };\n\n    // Create template\n    this.shared.template = null;\n    const template = ffd20.canvas.AbilityTemplate.fromData(templateData, { action: this.shared.action });\n    let result;\n    if (template) {\n      const actorSheet = this.item.actor?.sheet;\n      const sheetRendered = actorSheet?._element != null;\n      if (sheetRendered) actorSheet.minimize();\n      result = await template.drawPreview(this.shared.event).catch((e) => null);\n      if (sheetRendered) actorSheet.maximize();\n    }\n\n    if (result) this.shared.template = await result.place();\n\n    return result;\n  }\n\n  /**\n   * Handles Dice So Nice integration.\n   */\n  async handleDiceSoNice() {\n    if (!game.settings.get(\"ffd20\", \"integration\").diceSoNice) return;\n    if (!game.dice3d?.isEnabled()) return;\n\n    // Use try to make sure a chat card is rendered even if DsN fails\n    try {\n      // Define common visibility options for whole attack\n      const chatData = {};\n      ChatMessage.implementation.applyRollMode(chatData, this.shared.rollMode);\n\n      const mergeRolls = game.settings.get(\"dice-so-nice\", \"enabledSimultaneousRolls\");\n      const skipRolls = game.settings.get(\"dice-so-nice\", \"immediatelyDisplayChatMessages\");\n\n      /**\n       * Visually roll dice\n       *\n       * @param {PoolTerm[]} pools - An array of PoolTerms to be rolled together\n       * @returns {Promise} A Promise that is resolved when all rolls have been displayed\n       */\n      const showRoll = async (pools) => {\n        const whisper = chatData.whisper?.length ? chatData.whisper : undefined; // DSN does not like empty array for whisper\n\n        if (mergeRolls) {\n          // All at once\n          return Promise.all(\n            pools.map((pool) => game.dice3d.showForRoll(pool, game.user, true, whisper, chatData.blind))\n          );\n        } else {\n          // Sequential\n          for (const pool of pools) {\n            await game.dice3d.showForRoll(pool, game.user, true, whisper, chatData.blind);\n          }\n        }\n      };\n\n      /** @type {PoolTerm[]} */\n      const pools = [];\n\n      for (const atk of this.shared.chatAttacks) {\n        // Create PoolTerm for attack and damage rolls\n        const attackPool = new foundry.dice.terms.PoolTerm();\n        if (atk.attack) attackPool.rolls.push(atk.attack);\n        attackPool.rolls.push(...(atk.damage?.rolls ?? []));\n\n        // Create PoolTerm for crit confirmation and crit damage rolls\n        const critPool = new foundry.dice.terms.PoolTerm();\n        if (atk.hasCritConfirm) critPool.rolls.push(atk.critConfirm);\n        critPool.rolls.push(...(atk.critDamage?.rolls ?? []));\n\n        // Add non-empty pools to the array of rolls to be displayed\n        if (attackPool.rolls.length) pools.push(attackPool);\n        if (critPool.rolls.length) pools.push(critPool);\n      }\n\n      if (pools.length) {\n        // Chat card is to be shown immediately\n        if (skipRolls) showRoll(pools);\n        // Wait for rolls to finish before showing the chat card\n        else await showRoll(pools);\n      }\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  /**\n   * Adds an attack's chat card data to the shared object.\n   */\n  async getMessageData() {\n    if (this.shared.chatAttacks.length === 0) return;\n\n    const rollData = this.shared.rollData;\n\n    // Create chat template data\n    this.shared.templateData = {\n      ...this.shared.templateData,\n      name: this.item.name,\n      style: CONST.CHAT_MESSAGE_STYLES.OTHER,\n      rollMode: this.shared.rollMode,\n      attacks: this.shared.chatAttacks.map((o) => o.finalize()),\n    };\n\n    const actor = this.item.actor,\n      token = this.token ?? actor?.token;\n\n    // Set chat data\n    this.shared.chatData = {\n      type: \"action\",\n      speaker: ChatMessage.implementation.getSpeaker({ actor, token }),\n      rollMode: this.shared.rollMode,\n    };\n\n    // Set attack sound\n    if (this.shared.action.soundEffect) this.shared.chatData.sound = this.shared.action.soundEffect;\n    // Set dice sound if neither attack sound nor Dice so Nice are available\n    else if (!game.settings.get(\"ffd20\", \"integration\").diceSoNice || !game.dice3d?.isEnabled())\n      this.shared.chatData.sound = CONFIG.sounds.dice;\n\n    // Get extra text\n    const properties = [];\n    const extraText = await this.enrichNotes(this.shared.templateData.footnotes, \"FFD20.Footnotes\", \"footnotes\");\n\n    const itemChatData = await this.item.getChatData({\n      actionId: this.shared.action.id,\n      chatcard: true,\n      rollData: this.shared.rollData,\n    });\n\n    const formatTextNotes = (notes) => notes?.map((text) => ({ text })) ?? [];\n\n    // Get properties\n    // TODO: Object format\n    const commonProperties = [...itemChatData.properties, ...this.addGenericPropertyLabels()];\n    if (commonProperties.length) {\n      properties.push({\n        header: game.i18n.localize(\"FFD20.InfoShort\"),\n        css: \"common-notes\",\n        value: formatTextNotes(commonProperties),\n      });\n    }\n\n    // Get combat properties\n    if (game.combat) {\n      // TODO: Object format\n      const combatProps = this.addCombatPropertyLabels();\n\n      if (combatProps.length) {\n        properties.push({\n          header: game.i18n.localize(\"FFD20.CombatInfo_Header\"),\n          value: formatTextNotes(combatProps),\n          css: \"combat-properties\",\n        });\n      }\n    }\n\n    // Add CL notes\n    if (this.item.type === \"spell\" && actor) {\n      const clNotes = await actor.getContextNotesParsed(`spell.cl.${this.item.system.spellbook}`, { rollData });\n\n      if (clNotes.length) {\n        properties.push({\n          header: game.i18n.localize(\"FFD20.CLNotes\"),\n          css: \"cl-notes\",\n          value: clNotes,\n        });\n      }\n\n      const school = this.item.system.school;\n      if (school) {\n        // Add DC School notes\n        const dcSchoolNotes = await actor.getContextNotesParsed(`dc.school.${school}`, { rollData });\n        if (dcSchoolNotes.length) {\n          properties.push({\n            header: game.i18n.format(\"FFD20.DCSchoolNotes\", { school: ffd20.config.spellSchools[school] }),\n            css: \"dc-notes\",\n            value: dcSchoolNotes,\n          });\n        }\n        // Add CL School notes\n        const clSchoolNotes = await actor.getContextNotesParsed(`cl.school.${school}`, { rollData });\n        if (clSchoolNotes.length) {\n          properties.push({\n            header: game.i18n.format(\"FFD20.CLSchoolNotes\", { school: ffd20.config.spellSchools[school] }),\n            css: \"cl-notes\",\n            value: clSchoolNotes,\n          });\n        }\n      }\n    }\n\n    // Parse template data\n    const identified = Boolean(this.shared.rollData.item?.identified ?? true);\n    const name = identified ? `${this.item.name} (${this.shared.action.name})` : this.item.getName(true);\n    this.shared.templateData = {\n      ...this.shared.templateData,\n      tokenUuid: token?.uuid,\n      actionId: this.shared.action?.id,\n      extraText,\n      identified,\n      name,\n      description: identified ? itemChatData.identifiedDescription : itemChatData.unidentifiedDescription,\n      actionDescription: itemChatData.actionDescription,\n      properties,\n      item: this.item.toObject(),\n      actor,\n      token,\n      scene: canvas.scene?.id,\n      hasSave: this.shared.action.hasSave,\n      rollData: this.shared.rollData,\n      save: {\n        dc: this.shared.saveDC,\n        type: this.shared.save,\n        label: game.i18n.format(\"FFD20.SavingThrowButtonLabel\", {\n          type: ffd20.config.savingThrows[this.shared.save],\n          dc: this.shared.saveDC.toString(),\n        }),\n        gmSensitiveLabel: game.i18n.format(\"FFD20.SavingThrowButtonLabelGMSensitive\", {\n          save: ffd20.config.savingThrows[this.shared.save],\n        }),\n      },\n    };\n\n    // Add range info\n    {\n      const range = this.shared.action.getRange({ type: \"max\", rollData: this.shared.rollData });\n      if (range != null) {\n        this.shared.templateData.range = range;\n        const usystem = ffd20.utils.getDistanceSystem();\n        const isMetric = usystem === \"metric\";\n        const units = isMetric ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n\n        const rangeUnits = this.shared.action.range.units;\n        if ([\"melee\", \"touch\", \"reach\", \"close\", \"medium\", \"long\"].includes(rangeUnits)) {\n          this.shared.templateData.rangeLabel = ffd20.config.distanceUnits[rangeUnits];\n          this.shared.templateData.rangeLabel += ` (${game.i18n.format(\"FFD20.RangeFormat\", { distance: range, units })})`;\n        } else {\n          this.shared.templateData.rangeLabel = game.i18n.format(\"FFD20.RangeNote\", { distance: range, units });\n        }\n      }\n    }\n\n    // Add spell info\n    if (this.item.type === \"spell\" && actor) {\n      // Spell failure\n      if (actor.spellFailure > 0 && this.item.system.components.somatic) {\n        const spellbook = foundry.utils.getProperty(\n          actor.system,\n          `attributes.spells.spellbooks.${this.item.system.spellbook}`\n        );\n        if (spellbook && spellbook.arcaneSpellFailure) {\n          const roll = await RollPF.safeRoll(\"1d100\");\n          this.shared.templateData.spellFailure = roll.total;\n          this.shared.templateData.spellFailureRoll = roll;\n          this.shared.templateData.spellFailureSuccess = roll.total > actor.spellFailure;\n        }\n      }\n      // Caster Level Check\n      this.shared.templateData.casterLevelCheck = this.shared.casterLevelCheck;\n      // Concentration check\n      this.shared.templateData.concentrationCheck = this.shared.concentrationCheck;\n    }\n\n    // Generate metadata\n    const metadata = this.generateChatMetadata();\n\n    // Get target info\n    if (!game.settings.get(\"ffd20\", \"disableAttackCardTargets\")) {\n      this.shared.templateData.targets = this.shared.targets.map((t) => ({\n        img: t.document.texture.src,\n        actor: t.actor,\n        token: t.document,\n        uuid: t.document.uuid,\n      }));\n    }\n\n    if (!identified) {\n      metadata.item.identified = identified;\n      metadata.item.name = this.item._source.name || this.item.name;\n      metadata.item.description = itemChatData.identifiedDescription;\n      metadata.action.name = this.shared.action.name;\n      metadata.action.description = itemChatData.actionDescription;\n    }\n    this.shared.chatData.system = metadata;\n    this.shared.chatData[\"flags.core.canPopout\"] = true;\n  }\n\n  /**\n   * Enrich notes\n   *\n   * @param {Array<string>} notes - Notes\n   * @param {string} title - Notes section title\n   * @param {string} css - CSS selectors\n   * @returns {Promise<string>} - Enriched HTML as text\n   */\n  async enrichNotes(notes, title, css) {\n    if (notes.length === 0) return;\n\n    const content = await renderTemplate(\"systems/ffd20/templates/chat/parts/item-notes.hbs\", {\n      notes,\n      css,\n      header: game.i18n.localize(title),\n    });\n\n    const enrichOptions = {\n      rollData: this.shared.rollData,\n      relativeTo: this.actor,\n    };\n\n    return TextEditor.enrichHTML(content, enrichOptions);\n  }\n\n  /**\n   * Adds generic property labels to an attack's chat card.\n   *\n   * @todo Object format\n   * @returns {string[]} The resulting property labels.\n   */\n  addGenericPropertyLabels() {\n    const properties = [];\n\n    // Add actual cost\n    const cost = this.shared.totalChargeCost;\n    if (cost && !this.item.system.atWill) {\n      if (this.item.type === \"spell\" && this.item.useSpellPoints()) {\n        properties.push(`${game.i18n.localize(\"FFD20.SpellPointsCost\")}: ${cost}`);\n      } else {\n        properties.push(`${game.i18n.localize(\"FFD20.ChargeCost\")}: ${cost}`);\n      }\n    }\n\n    // Add conditions\n    const conditions = Object.entries(this.actor.system.conditions ?? {})\n      .filter(([_, enabled]) => enabled)\n      .map(([id]) => ffd20.registry.conditions.get(id))\n      .filter((c) => c?.showInAction)\n      .map((c) => c.name);\n\n    // Special case\n    // TODO: Move this configuration to conditions registry\n    if (this.actor.statuses.has(\"deaf\") && this.item.type === \"spell\") {\n      // TODO: Check if someone modified the conditions to show anyway?\n      conditions.push(ffd20.registry.conditions.get(\"deaf\").name);\n    }\n\n    if (conditions.length) properties.push(...conditions);\n\n    // Nonlethal\n    if (this.action.nonlethal) properties.push(game.i18n.localize(\"FFD20.Nonlethal\"));\n\n    // Mana Damage\n    if (this.action.manadamage) properties.push(game.i18n.localize(\"FFD20.ManaDamage\"));\n\n    // Splash\n    if (this.action.splash) properties.push(game.i18n.localize(\"FFD20.Splash\"));\n\n    if (this.action.touch) properties.push(game.i18n.localize(\"FFD20.TouchAttackShort\"));\n\n    // Add info for material\n    let materialKey = null;\n    let materialAddons = null;\n    const normalMaterialAction = this.action.material?.normal.value;\n    const normalMaterialItem = this.item.system.material?.normal.value;\n    const baseMaterialItem = this.item.system.material?.base?.value;\n    const addonMaterialAction = this.action.material?.addon;\n    const addonMaterialItem = this.item.system.material?.addon;\n\n    // Check the action data first, then the normal material, then the base material\n    if (normalMaterialAction && normalMaterialAction.length > 0) materialKey = normalMaterialAction;\n    else if (normalMaterialItem && normalMaterialItem.length > 0) materialKey = normalMaterialItem;\n    else materialKey = baseMaterialItem;\n\n    if (materialKey) {\n      properties.push(ffd20.registry.materials.get(materialKey.toLowerCase())?.name ?? materialKey.capitalize());\n    }\n\n    // Check for addon materials; prefer action data, then item data\n    if (addonMaterialAction && addonMaterialAction.length > 0) materialAddons = addonMaterialAction;\n    else if (addonMaterialItem && addonMaterialItem.length > 0) materialAddons = addonMaterialItem;\n\n    if (materialAddons) {\n      const materialAddonNames = materialAddons\n        .map((addon) => {\n          if (!addon) return null;\n          const addonName = ffd20.registry.materials.get(addon.toLowerCase())?.name ?? addon.capitalize();\n          return addonName;\n        })\n        .filter((addon) => !!addon);\n\n      if (materialAddonNames.length > 0) properties.push(...materialAddonNames);\n    }\n\n    // Add info for alignments\n    const actionAlignments = this.action.alignments;\n    const itemAlignments = this.item.system.alignments ?? {};\n    if (actionAlignments) {\n      for (const alignment of Object.keys(actionAlignments)) {\n        if (\n          actionAlignments[alignment] || // The action alignment is true OR\n          (actionAlignments[alignment] === null && // (The action alignment is indeterminate AND\n            itemAlignments[alignment])\n        ) {\n          // The item has the alignment)\n          properties.push(game.i18n.localize(`FFD20.Alignments.${alignment[0]}`));\n        }\n      }\n    } else {\n      // Honestly, this should never happen. An action should always have an alignment now.\n      for (const alignment of Object.keys(itemAlignments)) {\n        if (itemAlignments[alignment]) {\n          properties.push(game.i18n.localize(`FFD20.Alignments.${alignment[0]}`));\n        }\n      }\n    }\n\n    // Add info for Power Attack to melee, Deadly Aim to ranged attacks\n    if (this.shared.powerAttack) {\n      switch (this.action.actionType) {\n        case \"rwak\":\n        case \"twak\":\n          properties.push(game.i18n.localize(\"FFD20.DeadlyAim\"));\n          break;\n        case \"mwak\":\n          properties.push(game.i18n.localize(\"FFD20.PowerAttack\"));\n          break;\n      }\n    }\n\n    // Add info for Point-Blank shot\n    if (this.shared.pointBlankShot) properties.push(game.i18n.localize(\"FFD20.PointBlankShot\"));\n\n    // Add info for Rapid Shot\n    if (this.shared.attacks.find((o) => o.id === \"rapid-shot\")) properties.push(game.i18n.localize(\"FFD20.RapidShot\"));\n\n    if (this.shared.manyShot) properties.push(game.i18n.localize(\"FFD20.Manyshot\"));\n\n    // Add Armor Check Penalty's application to attack rolls info\n    if (this.item.hasAttack && this.shared.rollData.attributes?.acp?.attackPenalty > 0)\n      properties.push(game.i18n.localize(\"FFD20.ArmorCheckPenalty\"));\n\n    // Add conditionals info\n    if (this.shared.conditionals?.length) {\n      this.shared.conditionals.forEach((c) => {\n        properties.push(this.shared.action.conditionals.get(c).name);\n      });\n    }\n\n    // Add Wound Thresholds info\n    if (this.shared.rollData.attributes?.woundThresholds?.level > 0)\n      properties.push(ffd20.config.woundThresholdConditions[this.shared.rollData.attributes.woundThresholds.level]);\n\n    return properties;\n  }\n\n  /**\n   * Adds combat property labels to an attack's chat card.\n   *\n   * @todo Object format\n   * @returns {string[]} The resulting property labels.\n   */\n  addCombatPropertyLabels() {\n    const properties = [];\n\n    // Add round info\n    properties.push(game.i18n.format(\"FFD20.CombatInfo_Round\", { round: game.combat.round }));\n\n    return properties;\n  }\n\n  /**\n   * Generates metadata for this attack for the chat card to store.\n   *\n   * @returns {object} The resulting metadata object.\n   */\n  generateChatMetadata() {\n    const metadata = {\n      actor: this.actor.uuid,\n      item: { id: this.item.id },\n      action: { id: this.action.id },\n      combat: undefined,\n      template: this.shared.template?.uuid ?? null,\n      rolls: {\n        attacks: [],\n      },\n      targets: this.shared.targets.map((t) => t.document.uuid),\n      config: {\n        critMult: this.shared.rollData.critMult,\n      },\n    };\n\n    // Mark as nonlethal\n    if (this.action.nonlethal) metadata.config.nonlethal = true;\n\n    // Mark as manadamage\n    if (this.action.manadamage) metadata.config.manadamage = true;\n\n    // Cache effective CL and SL for this action\n    metadata.config.cl = this.shared.rollData.cl;\n    if (this.item.type === \"spell\") metadata.config.sl = this.shared.rollData.sl;\n\n    if (this.actor && game.combat?.combatants.some((c) => c.actor === this.actor)) {\n      metadata.combat = game.combat.id;\n    }\n\n    // Add attack rolls\n    for (let attackIndex = 0; attackIndex < this.shared.chatAttacks.length; attackIndex++) {\n      const chatAttack = this.shared.chatAttacks[attackIndex];\n      const attackRolls = { attack: null, damage: [], critConfirm: null, critDamage: [] };\n      // Add attack roll\n      if (chatAttack.attack) attackRolls.attack = chatAttack.attack.toJSON();\n      // Add damage rolls\n      if (chatAttack.damage.rolls.length) {\n        for (let damageIndex = 0; damageIndex < chatAttack.damage.rolls.length; damageIndex++) {\n          const damageRoll = chatAttack.damage.rolls[damageIndex];\n          attackRolls.damage[damageIndex] = damageRoll.toJSON();\n        }\n      }\n      // Add critical confirmation roll\n      if (chatAttack.critConfirm) attackRolls.critConfirm = chatAttack.critConfirm.toJSON();\n      // Add critical damage rolls\n      if (chatAttack.critDamage.rolls.length) {\n        for (let damageIndex = 0; damageIndex < chatAttack.critDamage.rolls.length; damageIndex++) {\n          const damageRoll = chatAttack.critDamage.rolls[damageIndex];\n          attackRolls.critDamage[damageIndex] = damageRoll.toJSON();\n        }\n      }\n\n      // Record used ammo ID and quantity\n      if (chatAttack.ammo?.id) {\n        attackRolls.ammo = {\n          id: chatAttack.ammo.id,\n          quantity: this.shared.action.ammo.cost,\n          misfire: chatAttack.ammo.misfire ?? false,\n        };\n      }\n\n      metadata.rolls.attacks[attackIndex] = attackRolls;\n    }\n\n    // Add miscellaneous metadata\n    if (this.shared.saveDC) metadata.save = { dc: this.shared.saveDC, type: this.shared.save };\n    if (this.item.type === \"spell\") metadata.spell = { cl: this.shared.rollData.cl, sl: this.shared.rollData.sl };\n\n    return metadata;\n  }\n\n  /**\n   * Executes the item's script calls.\n   *\n   * @param {\"use\"|\"postUse\"} [category=\"use\"] Script call category\n   */\n  async executeScriptCalls(category = \"use\") {\n    const shared = this.shared;\n\n    if (!(\"attackData\" in shared)) {\n      Object.defineProperty(shared, \"attackData\", {\n        get: () => {\n          foundry.utils.logCompatibilityWarning(\n            \"shared.attackData is deprecated in favor of directly accessing shared\",\n            {\n              since: \"PF1 v10\",\n              until: \"PF1 v12\",\n            }\n          );\n          return shared;\n        },\n      });\n    }\n\n    const rv = await this.item.executeScriptCalls(category, {}, shared);\n\n    if (category === \"use\") this.shared.scriptData = rv;\n  }\n\n  /**\n   * Posts the attack's chat card.\n   *\n   * @returns {Promise<ChatMessage | SharedActionData>}\n   */\n  async postMessage() {\n    this.shared.chatTemplate ||= \"systems/ffd20/templates/chat/attack-roll.hbs\";\n\n    if (Hooks.call(\"pf1PreDisplayActionUse\", this) === false) return this.shared;\n\n    // Return early if no chat message is to be provided\n    if (!this.shared.chatMessage || this.shared.scriptData.hideChat) {\n      return this.shared;\n    }\n\n    // Show chat message\n    const enrichOptions = {\n      rollData: this.shared.rollData,\n      secrets: this.isOwner,\n      relativeTo: this.actor,\n    };\n\n    const content = await renderTemplate(this.shared.chatTemplate, this.shared.templateData);\n    this.shared.chatData.content = await TextEditor.enrichHTML(content, enrichOptions);\n\n    // TODO: Enrich only on render\n    const metadata = this.shared.chatData.system;\n    if (metadata.item?.description) {\n      metadata.item.description = await TextEditor.enrichHTML(metadata.item.description, enrichOptions);\n    }\n    if (metadata.action?.description) {\n      metadata.action.description = await TextEditor.enrichHTML(metadata.action.description, enrichOptions);\n    }\n\n    // Apply roll mode\n    this.shared.chatData.rollMode ??= game.settings.get(\"core\", \"rollMode\");\n    ChatMessage.implementation.applyRollMode(this.shared.chatData, this.shared.chatData.rollMode);\n\n    const result = await ChatMessage.implementation.create(this.shared.chatData);\n\n    this.shared.message = result;\n\n    return result;\n  }\n\n  /**\n   * Collect valid targets.\n   */\n  async getTargets() {\n    // Get targets from template, and if no template is present, from explicitly targeted tokens list\n    /** @type {MeasuredTemplatePF|null} */\n    const template = this.shared.template?.object;\n    let targets = template ? await template.getTokensWithin() : null;\n    targets ??= Array.from(game.user.targets);\n    // Ignore defeated and secret tokens\n    this.shared.targets = targets.filter((t) => t.combatant?.isDefeated !== true);\n  }\n\n  /**\n   * Armor as DR defense DC determination.\n   *\n   * @remarks\n   * - Does not account for critical feats.\n   * - Does not account for size difference between target and attacker.\n   *\n   * @param {D20RollPF} attack - Attack roll\n   * @returns {ffd20.dice.RollPF} - Defense DC\n   */\n  getDefenseDC(attack) {\n    const parts = this._getDefenseDCParts(attack);\n    return RollPF.safeRollSync(parts.join(\" + \"));\n  }\n\n  /**\n   * @internal\n   * @param {D20RollPF} attack - Attack roll\n   * @returns {Array<string>} - DC parts\n   */\n  _getDefenseDCParts(attack) {\n    const parts = [];\n\n    // Determine check\n    const check = attack.d20.total;\n    parts.push(`${check}[${game.i18n.localize(\"FFD20.Rolls.Check.Label\")}]`);\n\n    // Locate used BAB (accounts for overrides)\n    const babIdent = game.i18n.localize(\"FFD20.BAB\");\n    const bab = attack.terms.find((t) => t.flavor === babIdent)?.number ?? 0;\n    parts.push(`${Math.floor(bab / 2)}[${game.i18n.localize(\"FFD20.HalfBAB\")}]`);\n\n    return parts;\n  }\n\n  async prepareChargeCost() {\n    const rollData = this.shared.rollData;\n\n    // Determine charge cost\n    const baseCostRoll = await this.shared.action.getChargeCost({ rollData });\n    const baseCost = baseCostRoll?.total || 0;\n\n    // Bonus cost, e.g. from a conditional modifier\n    const bonusCost = this.shared.rollData.chargeCostBonus ?? 0;\n\n    let cost = baseCost + bonusCost;\n\n    // Override cost\n    if (this.shared.cost !== null) cost = this.shared.cost;\n\n    // Save chargeCost as rollData entry for anything else\n    this.shared.rollData.chargeCost = cost;\n  }\n\n  /**\n   * Process everything\n   *\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.skipDialog=false] - Skip dialog\n   * @returns {Promise<ActionUse | SharedActionData | void>}\n   */\n  async process({ skipDialog = false } = {}) {\n    const shared = this.shared;\n\n    // Check requirements for item\n    let reqErr = await this.checkRequirements();\n    if (reqErr > 0) return { err: ffd20.actionUse.ERR_REQUIREMENT, code: reqErr };\n\n    await this.autoSelectAmmo();\n\n    // Get new roll data\n    this.getRollData();\n\n    // let modules modify the ActionUse before attacks are rolled\n    Hooks.callAll(\"pf1CreateActionUse\", this);\n\n    // Generate default attacks\n    shared.fullAttack = true;\n    await this.generateAttacks(true);\n\n    let form;\n    // Show attack dialog, if appropriate\n    if (!skipDialog) {\n      form = await this.createAttackDialog();\n      // Stop if result is not an object (i.e. when closed is clicked on the dialog)\n      if (!form) return;\n    }\n\n    // Save form data in case modules want to reference it later\n    this.formData = form ?? {};\n\n    // Alter roll data\n    await this.alterRollData(form);\n\n    // Filter out attacks without ammo usage (out of ammo)\n    if (shared.action.ammo.type && shared.action.ammo?.cost > 0) {\n      shared.attacks = shared.attacks.filter((o) => o.hasAmmo);\n      if (shared.attacks.length === 0) {\n        ui.notifications.error(game.i18n.localize(\"FFD20.AmmoDepleted\"));\n        return { err: ffd20.actionUse.ERR_REQUIREMENT, code: ffd20.actionUse.ERR_REQUIREMENT.INSUFFICIENT_AMMO };\n      }\n    }\n\n    // Limit attacks to 1 if not full rounding\n    if (!shared.fullAttack) shared.attacks = shared.attacks.slice(0, 1);\n    // Handle conditionals\n    await this.handleConditionals();\n\n    // Prepare charge cost\n    await this.prepareChargeCost();\n\n    // Filter out attacks without charge usage (out of charges)\n    if (shared.rollData.chargeCost != 0 && this.shared.action.uses?.perAttack) {\n      const cost = shared.rollData.chargeCost;\n      const charges = shared.item.charges;\n\n      shared.attacks.forEach((atk, index) => {\n        if (charges >= (index + 1) * cost) atk.chargeCost = cost;\n        else atk.chargeCost = null;\n      });\n\n      shared.attacks = shared.attacks.filter((o) => o.chargeCost !== null);\n      if (shared.attacks.length === 0) {\n        ui.notifications.error(game.i18n.localize(\"FFD20.ChargesDepleted\"));\n        return { err: ffd20.actionUse.ERR_REQUIREMENT, code: ffd20.actionUse.ERR_REQUIREMENT.INSUFFICIENT_CHARGES };\n      }\n    }\n\n    // Check attack requirements, post-dialog\n    reqErr = await this.checkAttackRequirements();\n    if (reqErr > 0) return { err: ffd20.actionUse.ERR_REQUIREMENT, code: reqErr };\n\n    // Prompt measure template\n    let measureResult;\n    if (shared.useMeasureTemplate && canvas.scene) {\n      measureResult = await this.promptMeasureTemplate();\n      if (measureResult === null) return; // Cancelled\n    }\n\n    await this.getTargets();\n\n    // Generate chat attacks - leave this just before `pf1PreActionuse` hook call\n    await this.generateChatAttacks();\n\n    // Add notes after all attack info is generated\n    await this.addEffectNotes();\n    await this.addFootnotes();\n\n    // Call itemUse hook and determine whether the item can be used based off that\n    if (Hooks.call(\"pf1PreActionUse\", this) === false) {\n      await measureResult?.delete();\n      return;\n    }\n\n    // Call script calls\n    await this.executeScriptCalls();\n    if (shared.scriptData?.reject) {\n      await measureResult?.delete();\n      return;\n    }\n\n    const premessage_promises = [];\n    // Handle Dice So Nice\n    premessage_promises.push(this.handleDiceSoNice());\n\n    // Subtract uses\n    const ammoCost = this.action.ammo.cost;\n    if (ammoCost != 0) premessage_promises.push(this.subtractAmmo(ammoCost));\n\n    let totalCost = shared.rollData?.chargeCost;\n    if (this.action.uses.perAttack) {\n      totalCost = this.shared.attacks.reduce((total, atk) => total + atk.chargeCost, 0);\n    }\n    if (totalCost != 0) {\n      shared.totalChargeCost = totalCost;\n      premessage_promises.push(this.item.addCharges(-totalCost));\n    }\n\n    if (shared.action.isSelfCharged)\n      premessage_promises.push(shared.action.update({ \"uses.self.value\": shared.action.uses.self.value - 1 }));\n\n    await Promise.all(premessage_promises);\n\n    // Update remaining ammo for chat message display\n    this.updateAmmoUsage();\n\n    // Retrieve message data\n    await this.getMessageData();\n\n    // Post message\n    let result = Promise.resolve(null);\n    if (shared.scriptData?.hideChat !== true) {\n      result = this.postMessage();\n    }\n\n    // Deselect targets\n    if (game.settings.get(\"ffd20\", \"clearTargetsAfterAttack\") && game.user.targets.size) {\n      game.user.updateTokenTargets([]);\n      // Above does not communicate targets to other users, so..\n      game.user.broadcastActivity({ targets: [] });\n    }\n\n    // Wait for chat message to be created before continuing\n    await result;\n\n    // Call post-use script calls\n    await this.executeScriptCalls(\"postUse\");\n\n    Hooks.callAll(\"pf1PostActionUse\", this, this.shared.message ?? null);\n\n    return this;\n  }\n}\n\nexport class ActionUseAttack {\n  /** @type {string|null} */\n  type;\n\n  /** @type {string} */\n  label;\n\n  /** @type {string} */\n  attackBonus;\n\n  /** @type {boolean} */\n  abstract;\n\n  /** @type {AttackAmmo|null} */\n  ammo = null;\n\n  /** @type {number} */\n  chargeCost = null;\n\n  /** @type {ChatAttack} */\n  chatAttack = null;\n\n  /** @type {boolean} */\n  get hasAmmo() {\n    return !!this.ammo;\n  }\n\n  constructor(label, bonus = \"\", ammo = null, { abstract = false, type = null } = {}) {\n    this.label = label;\n    this.attackBonus = bonus;\n    this.ammo = ammo;\n    this.abstract = abstract ?? false;\n    this.type = type;\n  }\n}\n\n/**\n * @typedef {object} ItemAttack_Dialog_Result\n * @property {boolean} fullAttack - Whether it's a full attack (true) or a single attack (false)\n * @property {JQuery} html - The html containing user input and selections.\n */\n\n/**\n * @typedef {object} AttackAmmo\n * @property {string} id - Ammo item ID\n * @property {number} quantity - Quantity of ammo\n * @property {boolean} abundant - Is abundant?\n * @property {object} data - Ammo document data\n * @property {Item} document - Ammo document\n * @property {boolean} isDefault - Is this default ammo for the item?\n */\n","import { ActionUse, ActionUseAttack } from \"../action-use/action-use.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\nexport class AttackDialog extends Application {\n  /**\n   * @param {ffd20.actionUse.ActionUse} actionUse\n   * @param {object} appOptions\n   */\n  constructor(actionUse, appOptions = {}) {\n    super(appOptions);\n\n    this.actionUse = actionUse;\n    this.object = actionUse.action;\n\n    const action = actionUse.action;\n    const item = actionUse.item;\n    const shared = actionUse.shared;\n    this.shared = shared;\n\n    this.useOptions = shared.useOptions ?? {};\n\n    this.rollData = shared.rollData;\n\n    this.initAmmoUsage();\n    this.initAttacks();\n\n    this.base = {\n      cl: this.rollData.cl ?? 0,\n      sl: this.rollData.sl ?? 0,\n    };\n\n    const isNaturalAttack = action.item.subType === \"natural\",\n      isPrimaryAttack = isNaturalAttack ? action.naturalAttack.primary !== false : true;\n\n    const useOptions = this.useOptions;\n\n    /** @type {Record<string,boolean>} */\n    this.flags = {\n      \"power-attack\": useOptions.powerAttack ?? false,\n      \"primary-attack\": useOptions.primaryAttack ?? isPrimaryAttack,\n      \"cl-check\": useOptions.clCheck ?? item?.system.clCheck === true,\n      \"measure-template\": useOptions.measureTemplate ?? true,\n      \"haste-attack\": useOptions.haste,\n      manyshot: useOptions.manyshot,\n      \"rapid-shot\": useOptions.rapidShot,\n    };\n\n    let damageMult = this.damageMult;\n    if (useOptions.abilityMult != null) damageMult = useOptions.abilityMult;\n\n    /** @type {Record<string, string>} */\n    this.attributes = {\n      d20: this.rollData.d20 ?? \"\",\n      \"attack-bonus\": \"\",\n      \"damage-bonus\": \"\",\n      \"cl-offset\": \"0\",\n      \"sl-offset\": \"0\",\n      rollMode: shared.rollMode || game.settings.get(\"core\", \"rollMode\"),\n      \"damage-ability-multiplier\": damageMult,\n      held: useOptions.held || this.rollData.action?.held || this.rollData.item?.held || \"1h\",\n    };\n\n    this.conditionals = {};\n    for (const conditional of action.conditionals) {\n      this.conditionals[`conditionals.${conditional.id}`] = {\n        enabled: conditional.default === true,\n        conditional,\n      };\n    }\n\n    if (useOptions.haste) this._toggleExtraAttack(\"haste-attack\", true);\n    if (useOptions.manyshot) this._toggleExtraAttack(\"manyshot\", true);\n    if (useOptions.rapidShot) this._toggleExtraAttack(\"rapid-shot\", true);\n\n    // Callback for AttackDialog.show()\n    this.resolve = null;\n  }\n\n  /** @type {number|null} */\n  get damageMult() {\n    const rollData = this.rollData;\n\n    let damageMult = rollData.action?.ability?.damageMult;\n\n    const isNatural = this.action.subType === \"natural\";\n    if (isNatural) {\n      damageMult ??= 1;\n      const isPrimaryAttack = this.flags[\"primary-attack\"];\n      if (!isPrimaryAttack) {\n        damageMult = rollData.action.naturalAttack?.secondary?.damageMult ?? 0.5;\n      }\n    }\n\n    return damageMult;\n  }\n\n  /** @type {ffd20.components.ItemAction} */\n  get action() {\n    return this.object;\n  }\n\n  get title() {\n    const action = this.action,\n      item = action.item,\n      actor = action.actor;\n\n    if (actor) return `${action.name} (${item.name}) â ${actor.name}`;\n    return `${action.name} (${item.name})`;\n  }\n\n  static get defaultOptions() {\n    return {\n      ...super.defaultOptions,\n      template: \"systems/ffd20/templates/apps/attack-roll-dialog.hbs\",\n      classes: [\"ffd20\", \"attack-dialog\"],\n      width: 440,\n      height: \"auto\",\n      closeOnSubmit: true,\n      sheetConfig: false,\n      submitOnChange: false,\n      submitOnClose: false,\n    };\n  }\n\n  getData() {\n    const action = this.action,\n      item = action.item;\n\n    const rollData = this.rollData;\n\n    const context = {\n      data: rollData,\n      item,\n      action,\n      config: ffd20.config,\n      rollMode: game.settings.get(\"core\", \"rollMode\"),\n      rollModes: CONFIG.Dice.rollModes,\n      hasAttack: action.hasAttack,\n      hasDamage: action.hasDamage,\n      hasDamageAbility: !!action.ability?.damage,\n      isNaturalAttack: item.system.subType === \"natural\",\n      isWeaponAttack: item.system.subType === \"weapon\",\n      isRanged: action.isRanged,\n      isMelee: !action.isRanged,\n      isMeleeWeaponAttackAction: action.actionType === \"mwak\",\n      isRangedWeaponAttackAction: action.isRanged && !action.isCombatManeuver,\n      isAttack: item.type === \"attack\",\n      isWeapon: item.type === \"weapon\",\n      isSpell: item.type === \"spell\",\n      isFeat: item.type === \"feat\",\n      isHealing: action.isHealing,\n      hasTemplate: action.hasTemplate,\n      attacks: this.attacks,\n      flags: this.flags,\n      attributes: this.attributes,\n      conditionals: this.conditionals,\n      usesAmmo: !!this.action.ammo.type,\n      ammo: this.actionUse.getAmmo(),\n    };\n\n    // Configure held related data\n    const canHold = !context.isRanged && (context.isAttack || context.isWeapon) && !context.isNaturalAttack;\n\n    // Determine if power attack mode should be displayed\n    const canConfigureHeld = context.flags[\"power-attack\"] && canHold;\n\n    const held = this.attributes.held || rollData.action.held || rollData.item.held || \"1h\";\n\n    context.held = {\n      inheritable: canHold,\n      configurable: canConfigureHeld,\n      mult: ffd20.config.abilityDamageHeldMultipliers[held] ?? 1,\n    };\n\n    return context;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Form changing\n    html.find(`.flags input[type=\"checkbox\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input.attribute`).on(\"change\", this._onChangeAttribute.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"concentration\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"cl-check\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`input[type=\"checkbox\"][name=\"measure-template\"]`).on(\"change\", this._onToggleFlag.bind(this));\n    html.find(`select`).on(\"change\", this._onSelectChange.bind(this));\n    html.find(`.conditionals input[type=\"checkbox\"]`).on(\"change\", this._onToggleConditional.bind(this));\n\n    // Dropdown menu\n    html.find(\".ammo-select\").on(\"click\", this._onAmmoSelectClick.bind(this));\n    html.find(\".ammo-select .ammo-item .controls a\").on(\"click\", this._onAmmoControlClick.bind(this));\n    html.find(\".ammo-select .ammo-item\").on(\"click\", this._onAmmoClick.bind(this));\n    html.on(\"click\", this._unfocusElements.bind(this));\n\n    // Button hover\n    html.find(`button[name=\"attack_single\"]`).on(\"pointerenter\", this._hideExtraAttacks.bind(this));\n    html.find(`button[name=\"attack_single\"]`).on(\"pointerleave\", this._showExtraAttacks.bind(this));\n\n    // Button press\n    html.find(`button[name=\"attack_single\"]`).on(\"click\", (ev) => this.resolveAttack(ev, false));\n    html.find(`button[name=\"attack_full\"]`).on(\"click\", (ev) => this.resolveAttack(ev, true));\n  }\n\n  _onSelectChange(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.attributes[elem.name] = elem.options[elem.selectedIndex].value;\n    this.render();\n  }\n\n  _hideExtraAttacks(event) {\n    const elems = this.element.find(\".attacks .attack\").filter((index, elem) => parseInt(elem.dataset.index) > 0);\n    elems.addClass(\"disabled\");\n  }\n\n  _showExtraAttacks(event) {\n    this.element.find(\".attacks .attack\").removeClass(\"disabled\");\n  }\n\n  /**\n   * @internal\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.render=true] - Call render\n   * @param {Event} event\n   */\n  _onToggleFlag(event) {\n    if (event?.cancelable) event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.flags[elem.name] = elem.checked === true;\n\n    // Add or remove haste, rapid-shot or manyshot attack\n    switch (elem.name) {\n      case \"haste-attack\":\n      case \"rapid-shot\":\n      case \"manyshot\": {\n        this._toggleExtraAttack(elem.name, elem.checked);\n        break;\n      }\n      case \"primary-attack\":\n        // Update damage mult to match primary/secondary default\n        this.attributes[\"damage-ability-multiplier\"] = this.damageMult;\n        break;\n    }\n\n    this.render();\n  }\n\n  _toggleExtraAttack(type, enabled = true) {\n    if (enabled) {\n      const translationString = {\n        \"haste-attack\": \"FFD20.Haste\",\n        \"rapid-shot\": \"FFD20.RapidShot\",\n        manyshot: \"FFD20.Manyshot\",\n      };\n\n      // Correlate manyshot with the first attack, add the others at the end\n      const place = type === \"manyshot\" ? 1 : this.attacks.length;\n\n      this.attacks.splice(\n        place,\n        0,\n        new ActionUseAttack(game.i18n.localize(translationString[type]), \"\", null, { abstract: true, type })\n      );\n      this.setAttackAmmo(place, this.action.item.system.ammo?.default);\n    } else {\n      this.attacks.findSplice((o) => o.type === type);\n    }\n  }\n\n  _onToggleConditional(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.conditionals[elem.name].enabled = elem.checked === true;\n    this.render();\n  }\n\n  _onAmmoSelectClick(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    const listElem = elem.querySelector(\"ul\");\n\n    // Filter to NOT act when clicking on the list child element\n    if (!event.target.closest(\"ul\")) {\n      // Set classes for CSS\n      listElem.classList.toggle(\"open\");\n      const isOpen = listElem.classList.contains(\"open\");\n      if (isOpen) elem.classList.add(\"focus\");\n      else elem.classList.remove(\"focus\");\n    }\n  }\n\n  _onAmmoClick(event) {\n    const elem = event.target;\n    // Don't do anything if this click was actually on its controls\n    if (elem.closest(\".controls\") && !elem.classList.contains(\"controls\")) return;\n\n    event.preventDefault();\n    const ammoId = elem.closest(\".ammo-item\").dataset.id;\n    const attackIndex = parseInt(elem.closest(\".attack\").dataset.index);\n\n    // Set ammo\n    this.setAttackAmmo(attackIndex, ammoId === \"null\" ? null : ammoId);\n    this.render();\n  }\n\n  async _onAmmoControlClick(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    const ammoId = elem.closest(\".ammo-item\").dataset.id;\n    switch (elem.dataset.type) {\n      case \"set-default\":\n        if (ammoId === \"null\") await this.action.item.update({ \"system.ammo.-=default\": null });\n        else await this.action.item.update({ \"system.ammo.default\": ammoId });\n\n        // Apply CSS class, since we can't do a render in here and keep the dropdown menu open\n        elem\n          .closest(\"ul\")\n          .querySelectorAll(\".ammo-item\")\n          .forEach((o) => o.classList.remove(\"default\"));\n        if (ammoId !== \"null\") elem.closest(\".ammo-item\").classList.add(\"default\");\n        break;\n      case \"set-all\":\n        for (let a = 0; a < this.attacks.length; a++) {\n          this.setAttackAmmo(a, ammoId);\n        }\n        this.render();\n    }\n  }\n\n  _unfocusElements(event) {\n    // Close ammo select\n    if (this.element[0].querySelector(\".ammo-select\") != null && !event.target.closest(\".ammo-select\")) {\n      const elem = this.element[0].querySelector(\".ammo-select\");\n      elem.classList.remove(\"focus\");\n      elem.querySelector(\"ul\").classList.remove(\"open\");\n    }\n  }\n\n  _onChangeAttribute(event) {\n    event.preventDefault();\n\n    const elem = event.currentTarget;\n    this.attributes[elem.name] = elem.value;\n\n    // Also change roll data, if appropriate\n    switch (elem.name) {\n      case \"cl-offset\":\n        this.rollData.cl = this.base.cl + parseInt(elem.value);\n        break;\n      case \"sl-offset\":\n        this.rollData.sl = this.base.sl + parseInt(elem.value);\n        break;\n      case \"damage-ability-multiplier\":\n        foundry.utils.setProperty(this.rollData, \"action.ability.damageMult\", elem.value);\n        break;\n      case \"held\":\n        foundry.utils.setProperty(this.rollData, \"action.held\", elem.value);\n        break;\n    }\n\n    this.render();\n  }\n\n  initAttacks() {\n    this.attacks = this.shared.attacks;\n\n    for (const atk of this.attacks) {\n      atk.attackBonusTotal =\n        RollPF.safeRollSync(atk.attackBonus, this.rollData, undefined, undefined, { minimize: true }).total ?? 0;\n    }\n\n    // Set ammo usage\n    if (this.action.ammo.type) {\n      const ammoId = this.action.item.system.ammo?.default;\n      if (ammoId != null) {\n        for (let a = 0; a < this.attacks.length; a++) {\n          this.setAttackAmmo(a, ammoId);\n        }\n      }\n    }\n  }\n\n  // Initializes ammo usage, which helps avoid being able to overuse ammo\n  initAmmoUsage() {\n    this.ammoUsage = this.actionUse.getAmmo().reduce((cur, o) => {\n      cur[o.id] = {\n        quantity: o.quantity,\n        used: 0,\n      };\n\n      return cur;\n    }, {});\n  }\n\n  setAttackAmmo(attackIndex, ammoId = null) {\n    if (!this.action.ammo.type) return;\n\n    const atk = this.attacks[attackIndex];\n    const curAmmo = atk.ammo?.id;\n    const ammoItem = this.action.actor?.items.get(ammoId) ?? null;\n    const abundant = ammoItem?.system.abundant ?? false;\n\n    // Check if ammo exists\n    if (ammoId && this.ammoUsage[ammoId] == null) ammoId = null;\n\n    if (!ammoId) {\n      atk.ammo = null;\n      // Remove from ammo usage tracker\n      if (curAmmo != null) {\n        this.ammoUsage[curAmmo].used--;\n      }\n      return;\n    }\n\n    // Don't allow overuse\n    if (!abundant && this.ammoUsage[ammoId].used >= this.ammoUsage[ammoId].quantity) return;\n\n    atk.ammo = this.actionUse.getAmmo().find((o) => o.id === ammoId);\n\n    // Add to ammo usage tracker\n    if (curAmmo) this.ammoUsage[curAmmo].used--;\n    this.ammoUsage[ammoId].used++;\n  }\n\n  /**\n   * @internal\n   * @param {Event} event\n   * @param {boolean} fullAttack\n   */\n  resolveAttack(event, fullAttack = true) {\n    event.preventDefault();\n\n    const form = new FormDataExtended(this.element.find(\"form\")[0]).object;\n    form.fullAttack = fullAttack;\n\n    this.resolve(form);\n    this.close();\n  }\n\n  async close(options = {}) {\n    this.resolve(null);\n    return super.close(options);\n  }\n\n  /**\n   * @returns {Promise<object|null>} - Attack configuration object or null if rejected\n   */\n  show() {\n    return new Promise((resolve, reject) => {\n      this.resolve = resolve;\n      this.render(true);\n    });\n  }\n}\n","const { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Changelog Dialog\n */\nexport class ChangeLogWindow extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    id: \"changelog\",\n    tag: \"form\",\n    form: {\n      handler: ChangeLogWindow._updateObject,\n      submitOnChange: true,\n      closeOnSubmit: false,\n    },\n    classes: [\"pf1-v2\", \"changelog\"],\n    window: {\n      minimizable: true,\n      resizable: true,\n    },\n    position: {\n      width: 500,\n      height: 680,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/changelog.hbs\",\n    },\n  };\n\n  _cache;\n\n  /**\n   * @param {boolean} lastVersion - Display only latest version, legacy versions are to be omitted.\n   * @param {boolean} autoDisplay - Is the dialog being shown without prompting?\n   */\n  constructor(lastVersion = false, autoDisplay = false) {\n    super({}, {});\n\n    this.lastVersion = lastVersion;\n    this.autoDisplay = autoDisplay;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @override\n   * @returns {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Title\")} ~ ${game.i18n.localize(\"FFD20.Application.Changelog.Title\")}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  async _prepareContext() {\n    const context = {};\n\n    context.dontShowAgain = game.settings.get(\"ffd20\", \"dontShowChangelog\");\n    context.autoDisplay = this.autoDisplay;\n    context.lastVersion = this.lastVersion;\n\n    if (!this._cache) {\n      const xhr = new XMLHttpRequest();\n      xhr.open(\"GET\", \"systems/ffd20/CHANGELOG.md\");\n\n      const promise = new Promise((resolve) => {\n        xhr.onload = () => {\n          if (xhr.status === 200) {\n            this._cache = this._processChangelog(xhr.response);\n          } else {\n            context.error = {\n              number: xhr.status,\n              message: xhr.statusText,\n              url: xhr.responseURL,\n            };\n          }\n          resolve();\n        };\n      });\n      xhr.send(null);\n\n      await promise;\n    }\n\n    context.changelog = this._cache;\n    context.link = game.system.changelog;\n\n    return context;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @internal\n   * @param {string} md\n   * @returns {string}\n   */\n  _processChangelog(md) {\n    const converter = new showdown.Converter();\n\n    const latestVersion = ffd20.utils.SemanticVersion.fromString(game.system.version);\n    const latestMajor = latestVersion.major;\n    const latest = [];\n    const major = [];\n    const majorPatches = [];\n    const legacy = [];\n\n    let currentVersion = null;\n\n    const lines = md.split(/[\\n\\r]+/);\n\n    for (const line of lines) {\n      if (/^#\\s/.test(line)) continue; // Ignore H1\n\n      if (line.match(/##\\s+([0-9]+\\.[0-9]+(\\.[0-9]+)?)/)) {\n        currentVersion = ffd20.utils.SemanticVersion.fromString(RegExp.$1);\n        if (currentVersion.major === latestMajor) {\n          majorPatches.push(currentVersion);\n        }\n      }\n\n      // Skip lines not associated with any version\n      if (!currentVersion) continue;\n      // Split other lines to appropriate pools\n      if (currentVersion.isSame(latestVersion)) latest.push(line);\n      else if (currentVersion.major === latestMajor) major.push(line);\n      else if (!this.lastVersion) legacy.push(line);\n    }\n\n    return {\n      version: latestVersion,\n      latest: {\n        content: converter.makeHtml(latest.join(\"\\n\")),\n      },\n      major: {\n        patches: majorPatches,\n        content: major.length ? converter.makeHtml(major.join(\"\\n\")) : null,\n      },\n      legacy: {\n        content: legacy.length ? converter.makeHtml(legacy.join(\"\\n\")) : null,\n      },\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Cancel distribution and close dialog\n   *\n   * @param {SubmitEvent} event                   The originating form submission event\n   * @param {HTMLFormElement} form                The form element that was submitted\n   * @param {FormDataExtended} formData           Processed data for the submitted form\n   * @internal\n   * @this {ChangeLogWindow}\n   * @returns {Promise<void>}\n   */\n  static async _updateObject(event, form, formData) {\n    formData = formData.object;\n    if (formData.dontShowAgain != null) {\n      await game.settings.set(\"ffd20\", \"dontShowChangelog\", formData.dontShowAgain);\n    }\n  }\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nexport class DamageTypeSelector extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._updateObject,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"damage-type-selector\"],\n    window: {\n      title: \"FFD20.DamageType\",\n      minimizable: true,\n      resizable: false,\n    },\n    position: {\n      width: 720,\n    },\n    actions: {\n      toggleDamageType: this._toggleDamageType,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/damage-type-selector.hbs\",\n      scrollable: [\".damage-type-categories\", \".damage-modifiers\"],\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /**\n   * @param {object} object - Parent object\n   * @param {string} path - Path to damage data in object\n   * @param {Set<string>} data - Damage types\n   * @param {object} options - Options\n   * @param {Function} options.updateCallback - Update callback\n   */\n  constructor(object, path, data = new Set(), options = {}) {\n    options.object = object;\n    options.path = path;\n    super(options);\n\n    // Prepare types\n    const customTypes = new Set();\n    const allTypes = data ? [...data] : [];\n    const standardTypes = new Set();\n\n    for (const type of allTypes) {\n      if (!type) continue;\n\n      const d = ffd20.registry.damageTypes.get(type);\n      if (d) standardTypes.add(type);\n      else customTypes.add(type);\n    }\n\n    this.types = standardTypes;\n    this.customTypes = customTypes;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Initialize the configuration for this application. Override the default ID to be unique to this\n   * entry selector instance based on document and attribute that is being edited.\n   *\n   * @override\n   * @param {ApplicationConfiguration} options    The provided configuration options for the Application\n   * @returns {ApplicationConfiguration}           The final configuration values for the application\n   */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n    options.id = `DamageTypeSelector-${options.object.id}-${options.path.replaceAll(\".\", \"_\")}`;\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  get categoryOrder() {\n    return [\"physical\", \"energy\", \"misc\"];\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    const types = ffd20.registry.damageTypes\n      .filter((damageType) => !damageType.isModifier)\n      .map((dt) => ({ ...dt, id: dt.id, enabled: this.types.has(dt.id) }));\n\n    const sortOrder = this.categoryOrder;\n\n    return {\n      types: this.types,\n      customTypes: [...this.customTypes].join(\";\"), // HACK\n      modifiers: ffd20.registry.damageTypes\n        .filter((o) => o.isModifier)\n        .map((dm) => ({ ...dm, id: dm.id, enabled: this.types.has(dm.id) })),\n      // Damage type categories\n      categories: types\n        .reduce((cur, o) => {\n          let categoryObj = cur.find((o2) => o2.key === o.category);\n          if (!categoryObj) {\n            categoryObj = { key: o.category, label: `FFD20.DamageTypeCategory.${o.category}`, types: [] };\n            cur.push(categoryObj);\n          }\n          categoryObj.types.push(o);\n          return cur;\n        }, [])\n        .sort((a, b) => {\n          const idxA = sortOrder.indexOf(a.key);\n          const idxB = sortOrder.indexOf(b.key);\n          if (idxA === -1 && idxB >= 0) return 1;\n          if (idxB === -1 && idxA >= 0) return -1;\n          if (idxA > idxB) return 1;\n          if (idxA < idxB) return -1;\n          return 0;\n        }),\n      buttons: [{ type: \"submit\", label: \"FFD20.Save\", icon: \"far fa-save\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update internal data snapshot on form change\n   *\n   * @param formConfig\n   * @param event\n   * @override\n   * @protected\n   * @this {DamageTypeSelector}\n   * @returns {Promise<void>}\n   */\n  async _onChangeForm(formConfig, event) {\n    event.preventDefault();\n    const elem = event.target;\n\n    // Only handle custom types here\n    if (elem.name !== \"custom\") return;\n\n    const types = elem.value\n      .split(\";\")\n      .map((t) => t.trim())\n      .filter((t) => !!t);\n\n    this.customTypes = new Set(types);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @internal\n   * @param {Event} event\n   */\n  static _toggleDamageType(event) {\n    event.preventDefault();\n    const a = event.target.closest(\"[data-action]\");\n    const dt = a.dataset.id;\n\n    if (this.types.has(dt)) this.types.delete(dt);\n    else this.types.add(dt);\n\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @param {Event} event\n   * @param {object} formData\n   */\n  static async _updateObject(event, formData) {\n    const allTypes = [...this.types.union(this.customTypes)];\n    return this.options.updateCallback(allTypes);\n  }\n}\n","const { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An abstract class for a document selector application.\n *\n * @abstract\n */\nexport class AbstractDocumentSelector extends HandlebarsApplicationMixin(ApplicationV2) {\n  /**\n   * The currently selected document ID\n   */\n  selected;\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: AbstractDocumentSelector._submit,\n      submitOnClose: false,\n      submitOnChange: true,\n      closeOnSubmit: false,\n    },\n    classes: [\"pf1-v2\", \"document-selector\"],\n    window: {\n      title: \"FFD20.Application.DocumentSelector.Title\",\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      width: 350,\n    },\n    sheetConfig: false,\n    search: {\n      delay: 250,\n      value: \"\",\n      event: null,\n      compositioning: false,\n      effectiveSearch: \"\",\n    },\n    empty: \"\",\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/document-selector.hbs\",\n      scrollable: [\".document-section-wrapper\"],\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  constructor(options) {\n    if (options?.title) {\n      foundry.utils.logCompatibilityWarning(\"AbstractDocumentSelector options title property is deprecated\", {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      });\n      options.window ??= {};\n      options.window.title = options.title;\n      delete options.title;\n    }\n\n    super(options);\n    this.selected = this.options.selected || \"\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  async _prepareContext() {\n    const sections = await this._getSections();\n\n    for (let i = 0; i < sections.length; i++) {\n      const section = sections[i];\n\n      if (!section.documents.length) {\n        sections.splice(i, 1);\n        i--;\n        continue;\n      }\n\n      if (!this.options.empty) {\n        this.selected ||= section.documents[0]?.id;\n      }\n    }\n\n    return {\n      document: this.document,\n      selected: this.selected,\n      searchTerm: this.options.search.value,\n      showSectionHeaders: sections.length > 1,\n      sections,\n      empty: {\n        include: this.options.empty,\n        document: {\n          id: \"\",\n          name: game.i18n.localize(\"FFD20.Application.DocumentSelector.None\"),\n          img: \"icons/svg/cancel.svg\",\n        },\n      },\n      buttons: [{ type: \"submit\", label: \"FFD20.Select\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    const searchInput = this.element.querySelector(\"input[type='search']\");\n    searchInput.addEventListener(\"input\", this._onSearch.bind(this));\n    searchInput.addEventListener(\"change\", this._onSearch.bind(this));\n    searchInput.addEventListener(\"compositionstart\", this._onSearchComposition.bind(this));\n    searchInput.addEventListener(\"compositionend\", this._onSearchComposition.bind(this));\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for changes to form input elements\n   *\n   * @internal\n   * @param {ApplicationFormConfiguration} formConfig   The configuration of the form being changed\n   * @param {Event} event                               The triggering event\n   * @returns {void}\n   */\n  _onChangeForm(formConfig, event) {\n    const target = event.target;\n    if (target.matches(\"input[type='radio']\")) {\n      this.element.querySelector(\"li.selected\")?.classList.remove(\"selected\");\n      this.selected = target.value;\n      target.closest(\"li\").classList.add(\"selected\");\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle the beginning of a search composition event\n   *\n   * @param event\n   * @private\n   */\n  _onSearchComposition(event) {\n    this.options.search.compositioning = event.type === \"compositionstart\";\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle search input events\n   *\n   * @param event\n   * @private\n   */\n  _onSearch(event) {\n    event.preventDefault();\n    event.stopPropagation();\n\n    // Accept input only while not compositioning\n\n    const searchTerm = event.target.value;\n    const changed = this.options.search.value !== searchTerm;\n\n    if (this.options.search.compositioning || changed) clearTimeout(this.options.search.event); // reset\n    if (this.options.search.compositioning) return;\n\n    //if (unchanged) return; // nothing changed\n    this.options.search.value = searchTerm;\n\n    if (event.type === \"input\") {\n      // Delay search\n      if (changed)\n        this.options.search.event = setTimeout(() => this._searchFilterCommit(event), this.options.search.delay);\n    } else {\n      this._searchFilterCommit(event);\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Kick off search\n   *\n   * @private\n   */\n  _searchFilterCommit() {\n    const searchTerm = this.options.search.value.toLowerCase();\n\n    // Skip if the search term is the same as the last one\n    if (this.options.search.effectiveSearch === searchTerm) return;\n    this.options.search.effectiveSearch = searchTerm;\n    this.render(true);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the list of sections to show in the selector. Categories are supposed\n   * to have their permissions correctly applied and display error messages, if they\n   * are not accessible.\n   *\n   * @abstract\n   * @private\n   * @returns {Promise<DocumentSelectorSection[]>}\n   */\n  async _getSections() {}\n\n  /* -------------------------------------------- */\n\n  /**\n   * Submit the form selection and resolve the stored promise, if provided\n   *\n   * @private\n   */\n  static _submit() {\n    this.resolve?.(this.selected);\n    this.close();\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Render selector and wait for it to resolve.\n   *\n   * @param {object} options - Options\n   * @returns {Promise<string|null>} - Document ID or null if cancelled.\n   */\n  static wait(options) {\n    return new Promise((resolve) => {\n      const app = new this(options);\n      app.resolve = resolve;\n      app.render({ force: true });\n    });\n  }\n}\n\n/**\n * @typedef {object} DocumentSelectorDocumentExtra\n * @property {string} [label] - The label of the property\n * @property {string} value - The value of the property\n */\n\n/**\n * @typedef {object} DocumentSelectorDocument\n * @property {string} id - The document ID\n * @property {string} name - The document name\n * @property {string} img - The document image\n * @property {boolean} isOwner - Is the current user the owner of the document\n * @property {DocumentSelectorDocumentExtra[]} extras - Additional document properties\n */\n\n/**\n * @typedef {object} DocumentSelectorSection\n * @property {string} id - The section ID\n * @property {string} label - The section label\n * @property {DocumentSelectorDocument[]} documents - The documents in the section\n */\n","import { AbstractDocumentSelector } from \"@app/abstract-document-selector.mjs\";\n\n/**\n * A specialized form application for selecting an Item from a list of available choices\n */\nexport class ItemSelector extends AbstractDocumentSelector {\n  static DEFAULT_OPTIONS = {\n    actor: undefined,\n    items: undefined,\n    filterFunc: undefined,\n    selected: null,\n    window: {\n      title: \"FFD20.Application.ItemSelector.Title\",\n    },\n    empty: true,\n  };\n\n  /* -------------------------------------------- */\n\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n    options.items ||= options.actor?.items || [];\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  async _getSections() {\n    let itemList = this.options.filterFunc\n      ? this.options.items.filter(this.options.filterFunc)\n      : [...this.options.items];\n\n    if (this.options.search.value) {\n      itemList = itemList.filter((item) => item.name.toLowerCase().includes(this.options.search.value.toLowerCase()));\n    }\n\n    itemList.sort((a, b) => a.name.localeCompare(b.name));\n\n    itemList = itemList.map((item) => {\n      return {\n        id: item.id,\n        name: item.name,\n        img: item.img,\n        isOwner: item.actor?.isOwner || false,\n        extras: [\n          {\n            label: \"FFD20.Application.ItemSelector.Quantity\",\n            value: item.system.quantity,\n          },\n        ],\n      };\n    });\n\n    return [\n      {\n        id: \"items\",\n        label: \"FFD20.Application.ItemSelector.Items\",\n        documents: itemList,\n      },\n    ];\n  }\n}\n","const { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An application for displaying system documentation.\n */\nexport class HelpBrowserPF extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    id: \"pf1-help-browser\",\n    classes: [\"pf1-v2\", \"help-browser\"],\n    window: {\n      title: \"FFD20.Help.Label\",\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      width: 620,\n      height: 600,\n    },\n    actions: {\n      forward: HelpBrowserPF._forwardInHistory,\n      back: HelpBrowserPF._backInHistory,\n      home: HelpBrowserPF._home,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/help-browser.hbs\",\n    },\n  };\n\n  /**\n   * @type {HistoryEntry[]}\n   * @private\n   */\n  _backwardHistory = [];\n\n  /**\n   * @type {HistoryEntry[]}\n   * @private\n   */\n  _forwardHistory = [];\n\n  /**\n   * The currently shown entry.\n   *\n   * @type {HistoryEntry}\n   * @private\n   */\n  _currentPage = { url: \"Help/Home\" };\n\n  /**\n   * The Markdown converter for this application.\n   *\n   * @type {showdown.Converter}\n   * @private\n   */\n  #converter;\n\n  /** @inheritdoc */\n  constructor(options = {}) {\n    super(options);\n\n    this.#converter = new showdown.Converter({\n      extensions: [HelpBrowserPF.defaultExtensions],\n      noHeaderId: false,\n      ghCompatibleHeaderId: true,\n      prefixHeaderId: \"pf1-help-browser-\",\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The URL of the page currently displayed\n   *\n   * @type {string}\n   */\n  get currentUrl() {\n    return this._currentPage.url;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    return {\n      hasHistoryBack: this._backwardHistory.length > 0,\n      hasHistoryForward: this._forwardHistory.length > 0,\n      // Get markdown string from localization, and parse it\n      pageContent: this.#converter.makeHtml(game.i18n.localize(`FFD20.${this.currentUrl}`)),\n      url: this.currentUrl.slugify({ strict: true }),\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Opens a specific page in the help browser.\n   *\n   * @param {string} url - The help URL to open\n   */\n  openUrl(url) {\n    // Remove leading `/`, which are okay in the wiki, but not present in localization files\n    if (url.startsWith(\"/\")) url = url.slice(1);\n    let header;\n    // Extract header from URL\n    [url, header] = url.split(\"#\");\n    if (this.currentUrl && url !== this.currentUrl) {\n      // Add new page to history\n      this._backwardHistory.push(this.getCurrentHistoryObject());\n      this._forwardHistory.splice(0, this._forwardHistory.length);\n    }\n    this._currentPage = { url };\n    this.render({ header, force: true });\n  }\n\n  /* -------------------------------------------- */\n\n  /** @inheritdoc */\n  async _render(force, options) {\n    await super._render(force, options);\n    const contentElement = this.element.querySelector(\".content\");\n\n    if (this._currentPage.scrollTop) {\n      // Dirty timeout to wait for loading of images with unknown height\n      setTimeout(() => {\n        contentElement.scrollTop = this._currentPage.scrollTop;\n      }, 0);\n    } else if (options.header) {\n      const headerElement = document.getElementById(`pf1-help-browser-${options.header}`);\n      if (headerElement) {\n        setTimeout(() => {\n          headerElement.scrollIntoView({ block: \"start\" });\n        }, 0);\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Returns a {@link HistoryEntry} containing a snapshot of the currently rendered state.\n   *\n   * @returns {HistoryEntry} The current state\n   */\n  getCurrentHistoryObject() {\n    const elem = this.element?.querySelector(\".content\");\n    const scrollTop = elem?.scrollTop ?? 0;\n    return {\n      url: this.currentUrl,\n      scrollTop,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /** Go back one page in history. */\n  static _backInHistory() {\n    if (!this._backwardHistory.length) return;\n    this._forwardHistory.push(this.getCurrentHistoryObject());\n    this._currentPage = this._backwardHistory.pop();\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  /** Go forward one page in history. */\n  static _forwardInHistory() {\n    if (!this._forwardHistory.length) return;\n    this._backwardHistory.push(this.getCurrentHistoryObject());\n    this._currentPage = this._forwardHistory.pop();\n    this.render();\n  }\n\n  /* -------------------------------------------- */\n\n  static _home() {\n    this.openUrl(\"Help/Home\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    // Remove href attributes to avoid actual browser page changes\n    const links = this.element.querySelectorAll(\"a[href]\");\n    for (const l of links) {\n      const href = l.getAttribute(\"href\");\n      if (!href.startsWith(\"Help\")) {\n        l.addEventListener(\"contextmenu\", (event) => {\n          event.stopImmediatePropagation();\n        });\n        continue;\n      }\n      l.removeAttribute(\"href\");\n      // Store target in dataset\n      l.dataset.url = href;\n\n      l.addEventListener(\"click\", (event) => {\n        event.preventDefault();\n        this.openUrl(href);\n      });\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Extensions for the Markdown converter used by the help browser.\n   *\n   * @type {showdown.ShowdownExtension[]}\n   */\n  static get defaultExtensions() {\n    return [\n      // Replace image paths from the wiki with localized paths available in the current Foundry context\n      {\n        type: \"output\",\n        regex: /<img.*?src=\"(.+?)\".*?>/g,\n        replace: function (match, src, _offset, _string) {\n          const foundrySrc = game.i18n.localize(`FFD20.${src.startsWith(\"/\") ? src.slice(1) : src}`);\n          return match.replace(src, foundry.utils.getRoute(`systems/ffd20/${foundrySrc}`));\n        },\n      },\n    ];\n  }\n}\n\n/**\n * The singleton instance of the {@link HelpBrowserPF} available at runtime.\n */\nexport const helpBrowser = new HelpBrowserPF();\n\n/**\n * @typedef {object} HistoryEntry\n * @property {string} url - URL of this history entry\n * @property {number} [scrollTop] - Scroll position of this history entry\n */\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nexport class ScriptEditor extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: ScriptEditor._updateObject,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"script-editor\"],\n    window: {\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      width: 640,\n      height: 560,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/script-editor.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  constructor(options = {}) {\n    super(options);\n\n    this.command = options.command || \"\";\n    this.name = options.name || null;\n\n    this.parent = options.parent;\n    this.script = options.script;\n\n    this._promises = {\n      submit: [],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get the window title\n   *\n   * @returns {string}\n   */\n  get title() {\n    return this.name\n      ? this.parent\n        ? `${this.parent.name}: ${this.name}`\n        : this.name\n      : (this.parent?.name ?? game.i18n.localize(\"FFD20.Unknown\"));\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   *\n   * @returns {string}\n   */\n  get id() {\n    return `script-call-${this.parent.uuid.replaceAll(\".\", \"-\")}-id-${this.script}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   *\n   * @returns {boolean}\n   */\n  get isEditable() {\n    const item = this.parent;\n    let editable = this.options.editable && item.isOwner;\n    if (item.pack && game.packs.get(item.pack)?.locked) editable = false;\n    return editable;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    return {\n      command: this.command || \"\",\n      name: this.name,\n      buttons: [{ type: \"submit\", label: \"FFD20.Save\", icon: \"far fa-save\" }],\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   *\n   * @returns {Promise<unknown>}\n   */\n  awaitResult() {\n    let callback;\n    const promise = new Promise((resolve) => {\n      callback = resolve;\n    });\n    this._promises.submit.push({ callback, promise, resolved: false });\n    return promise;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    // Open help browser\n    this.element.querySelector(\"a.help-browser[data-url]\").addEventListener(\"click\", this._openHelpBrowser.bind(this));\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Open the help browser to the specified URL.\n   *\n   * @param {Event} event\n   * @private\n   */\n  _openHelpBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n    ffd20.applications.helpBrowser.openUrl(a.dataset.url);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the object with the new change data from the form.\n   *\n   * @this {ScriptEditor}\n   * @param {SubmitEvent} event                   The originating form submission event\n   * @param {HTMLFormElement} form                The form element that was submitted\n   * @param {FormDataExtended} formData           Processed data for the submitted form\n   * @returns {Promise<void>}\n   * @private\n   */\n  static _updateObject(event, form, formData) {\n    formData = formData.object;\n\n    this.command = formData[\"command\"];\n    this.name = formData[\"name\"] || null;\n\n    const result = {\n      command: this.command,\n      name: this.name,\n    };\n\n    this.resolvePromises(\"submit\", result);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Resolve all promises of the given type with the given result.\n   *\n   * @param type\n   * @param result\n   */\n  resolvePromises(type, result) {\n    for (const p of this._promises[type]) {\n      if (!p.resolved) {\n        p.callback(result);\n        p.resolved = true;\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Close the application and resolve any pending submit promises.\n   *\n   * @param args\n   * @returns {Promise<void>}\n   */\n  async close(...args) {\n    super.close(...args);\n\n    this.resolvePromises(\"submit\", null);\n  }\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * An application that allows a user to configure an actors senses.\n *\n * @param {ActorPF} actor     The Actor instance for which to configure senses\n */\nexport class SensesSelector extends HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._onSave,\n      submitOnChange: false,\n      closeOnSubmit: true,\n    },\n    classes: [\"pf1-v2\", \"senses-selector\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: false,\n    },\n    position: {\n      width: 400,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/senses-selector.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  /**\n   * Returns which keys to convert in distance or weight\n   */\n  static get convertKeys() {\n    return {\n      dv: \"distance\",\n      ts: \"distance\",\n      bse: \"distance\",\n      bs: \"distance\",\n      sc: \"distance\",\n      tr: \"distance\",\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _preparePartContext(partId) {\n    const editable = this.isEditable;\n\n    switch (partId) {\n      case \"form\": {\n        const actor = this.document;\n\n        const senses = actor.toObject().system.traits?.senses ?? {};\n        for (const [key, type] of Object.entries(this.constructor.convertKeys)) {\n          const value = senses[key];\n          if (type === \"distance\" && value.value > 0) {\n            senses[key].value = ffd20.utils.convertDistance(value.value)[0];\n          }\n        }\n\n        const isMetric = ffd20.utils.getDistanceSystem() !== \"imperial\";\n\n        return {\n          editable,\n          cssClass: editable ? \"\" : \"locked\",\n          actor: this.actor,\n          noSystemVision:\n            !game.settings.get(\"ffd20\", \"systemVision\") ||\n            (actor.token?.getFlag(\"ffd20\", \"customVisionRules\") ??\n              actor.prototypeToken?.getFlag(\"ffd20\", \"customVisionRules\")) ||\n            false,\n          senses,\n          isMetric,\n          gridUnits: isMetric ? game.i18n.localize(\"FFD20.Distance.mShort\") : game.i18n.localize(\"FFD20.Distance.ftShort\"),\n        };\n      }\n      case \"footer\": {\n        if (!editable) return {};\n        return {\n          buttons: [{ type: \"submit\", label: \"FFD20.Save\", icon: \"far fa-save\" }],\n        };\n      }\n    }\n  }\n\n  _onRender() {\n    // Disable form if not editable\n    if (!this.isEditable) {\n      for (const el of this.element.querySelectorAll(\".window-content :is(input,button)\")) {\n        el.disabled = true;\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Alias the document property to actor\n   *\n   * @type {ActorPF}\n   */\n  get actor() {\n    return this.document;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the vision configuration window to include the Actor name\n   *\n   * @type {string}\n   */\n  get title() {\n    return `${game.i18n.localize(\"FFD20.Senses\")}: ${this.document.name}`;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Save the new vision details for the actor.\n   *\n   * @internal\n   * @this {ActorRestDialog}\n   * @param {SubmitEvent} event                The originating form submission event\n   * @param {HTMLFormElement} form             The form element that was submitted\n   * @param {FormDataExtended} formData        Processed data for the submitted form\n   * @param {object} formData.object           The parsed form data object\n   * @returns {Promise<void>}\n   */\n  static async _onSave(event, form, formData) {\n    formData = foundry.utils.expandObject(formData.object);\n    const senses = formData.system.traits.senses;\n\n    // Convert data back\n    Object.entries(this.constructor.convertKeys).forEach(([key, type]) => {\n      const value = senses[key];\n      if (value.value > 0 && type === \"distance\") {\n        senses[key].value = ffd20.utils.convertDistanceBack(value.value)[0];\n      }\n    });\n\n    // Delete undefined or disabled senses\n    // But only for linked actor since otherwise you can not override them to be disabled\n    if (!this.document.isToken) {\n      for (const [key, value] of Object.entries(senses)) {\n        if (!value) {\n          delete senses[key];\n          senses[`-=${key}`] = null;\n        }\n      }\n    }\n\n    this.document.update({ \"system.traits.senses\": senses });\n  }\n}\n","export class SkillEditor extends DocumentSheet {\n  constructor(actor, skillId, subSkillId, options = {}) {\n    super(actor, options);\n    this.skillId = skillId;\n    this.subSkillId = subSkillId;\n\n    this._callbacks = [];\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      width: 380,\n      template: \"systems/ffd20/templates/apps/skill-editor.hbs\",\n      dragDrop: [{ dragSelector: null, dropSelector: \"*\" }],\n      classes: [...options.classes, \"ffd20\", \"skill-editor\"],\n      sheetConfig: false,\n      submitOnChange: true,\n      closeOnSubmit: false,\n      submitOnClose: false,\n    };\n  }\n\n  get title() {\n    return `${game.i18n.localize(\"FFD20.EditSkill\")}: ${this.skillName} â ${this.actor.name}`;\n  }\n\n  /** @type {ActorPF} */\n  get actor() {\n    return this.document;\n  }\n\n  /** @type {boolean} */\n  get isSubSkill() {\n    return !!this.subSkillId;\n  }\n\n  /** @type {boolean} */\n  get isStaticSkill() {\n    return ffd20.config.skills[this.skillId] != null && !this.isSubSkill;\n  }\n\n  /** @type {object} */\n  get skill() {\n    if (this.isSubSkill) return this.actor.system.skills[this.skillId]?.subSkills[this.subSkillId];\n    return this.actor.system.skills[this.skillId];\n  }\n\n  /** @type {string} */\n  get skillName() {\n    return this.isStaticSkill ? ffd20.config.skills[this.skillId] : this.skill.name;\n  }\n\n  /** @type {string} */\n  get skillTag() {\n    if (this.isStaticSkill) return this.skillId;\n    return this.isSubSkill ? this.subSkillId : this.skillId;\n  }\n\n  async getData() {\n    const data = await super.getData();\n\n    // Configuration\n    data.config = ffd20.config;\n\n    // Skill data\n    data.skill = foundry.utils.mergeObject(\n      this.skill,\n      {\n        skillId: this.skillId,\n        subSkillId: this.subSkillId,\n        isSubSkill: this.isSubSkill,\n        name: this.skillName,\n        static: this.isStaticSkill,\n        tag: this.skillTag,\n      },\n      { inplace: false }\n    );\n\n    // Actor data\n    data.actorData = this.actor.toObject();\n\n    // Referenced documents\n    try {\n      const document = await fromUuid(data.skill.journal);\n      data.journal = document.toObject();\n      data.journal.uuid = data.skill.journal;\n      data.journal.documentType = document instanceof JournalEntryPage ? \"JournalEntryPage\" : \"JournalEntry\";\n    } catch {\n      data.journal = null;\n    }\n\n    return data;\n  }\n\n  addCallback(fn) {\n    this._callbacks.push(fn);\n  }\n\n  async _updateObject(event, formData) {\n    event.preventDefault();\n\n    // Setup base update data\n    const updateData = { system: { skills: {} } };\n    const skillCoreUpdateData = updateData.system.skills;\n\n    formData = foundry.utils.expandObject(formData);\n    // Forcibly slugify provided tag to ensure it is not invalid (e.g. contain periods)\n    const tag = ffd20.utils.createTag(formData.tag, { allowUpperCase: true, camelCase: false });\n    const newData = formData.skill;\n\n    // Track old IDs for rename related data deletion\n    const oldSubSkillId = this.subSkillId,\n      oldSkillId = this.skillId;\n\n    // Preserve some data\n    if (newData.journal === undefined) newData.journal ??= this.skill.journal;\n    if (newData.custom === undefined) newData.custom ??= this.skill.custom;\n\n    if (!this.isStaticSkill) {\n      newData.background ??= this.skill.background;\n    }\n\n    // Basic sanity check\n    if (!this.isStaticSkill && !tag) {\n      return void ui.notifications.error(game.i18n.localize(\"FFD20.Error.EmptySkillTag\"));\n    }\n\n    const subSkillId = this.isSubSkill ? tag : null;\n    const skillId = !this.isSubSkill ? tag : this.skillId;\n\n    // Detect skill ID conflicts\n    const tagChanged = this.isSubSkill ? tag !== this.subSkillId : tag !== this.skillId;\n    if (tagChanged) {\n      const skillsData = this.isSubSkill ? this.actor.system.skills[skillId].subSkills : this.actor.system.skills;\n      if (tag in skillsData) {\n        const msgOpts = { tag: this.isSubSkill ? `${this.skillId}.${tag}` : tag };\n        return void ui.notifications.error(game.i18n.format(\"FFD20.Error.SkillTagAlreadyExists\", msgOpts));\n      }\n    }\n\n    // Change application's id by tag\n    if (tag) {\n      if (this.isSubSkill) this.subSkillId = tag;\n      else this.skillId = tag;\n    }\n\n    if (this.isSubSkill) {\n      skillCoreUpdateData[skillId] = { subSkills: { [subSkillId]: newData } };\n      // Delete old skill\n      if (tagChanged) skillCoreUpdateData[skillId].subSkills[`-=${oldSubSkillId}`] = null;\n    } else {\n      skillCoreUpdateData[skillId] = newData;\n      // Delete old skill\n      if (tagChanged) skillCoreUpdateData[`-=${oldSkillId}`] = null;\n    }\n\n    return this.actor.update(updateData);\n  }\n\n  async close(...args) {\n    await super.close(...args);\n\n    this._callbacks.forEach((fn) => fn());\n  }\n\n  /**\n   * @override\n   */\n  _canDragDrop() {\n    // Allow non-GM to drop links as appropriate.\n    return this.isEditable;\n  }\n\n  async _onDrop(event) {\n    // Retrieve the dropped Journal Entry Page\n    const data = TextEditor.getDragEventData(event);\n    if (data.type !== \"JournalEntryPage\" && data.type !== \"JournalEntry\") return;\n    const document = await CONFIG[data.type].documentClass.implementation.fromDropData(data);\n    if (!document) return;\n\n    this._updateObject(event, this._getSubmitData({ \"skill.journal\": document.uuid }));\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Open compendium page\n    html.find(\".compendium-page\").on(\"click\", this._openCompendiumEntry.bind(this));\n    html.find(\".compendium-controls a\").on(\"click\", this._onCompendiumControls.bind(this));\n\n    // Submit\n    html.find(`button[type=\"submit\"]`).on(\"click\", (event) => {\n      event.preventDefault();\n      const valid = this.element[0].querySelector(\"form\").reportValidity();\n      if (valid) this.close({ submit: true });\n    });\n  }\n\n  async _openCompendiumEntry(event) {\n    event.preventDefault();\n    const elem = event.currentTarget.closest(\".compendium-entry\");\n\n    ffd20.utils.openJournal(elem.dataset.compendiumEntry);\n  }\n\n  async _onCompendiumControls(event) {\n    event.preventDefault();\n    const elem = event.currentTarget;\n\n    if (elem.classList.contains(\"delete\")) {\n      return this._updateObject(event, this._getSubmitData({ \"skill.journal\": null }));\n    }\n  }\n}\n","export class ContentSourceEditor extends DocumentSheet {\n  get title() {\n    const label = game.i18n.format(\"FFD20.ContentSource.Title\", { name: this.document.name });\n    const actor = this.document.actor;\n    if (actor) return label + ` â ${actor.name}`;\n    return label;\n  }\n\n  get template() {\n    return \"systems/ffd20/templates/apps/content-source-editor.hbs\";\n  }\n\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    return {\n      ...options,\n      tabs: [\n        {\n          contentSelector: \"section.content\",\n          navSelector: \"nav.tabs\",\n          group: \"sources\",\n        },\n      ],\n      dragDrop: [{ dragSelector: \"nav.tabs .source\", dropSelector: null }],\n      width: 540,\n      height: \"auto\",\n      resizable: true,\n      submitOnChange: true,\n      submitOnClose: true,\n      closeOnSubmit: false,\n      sheetConfig: false,\n      classes: [...options.classes, \"ffd20\", \"content-source-editor\"],\n    };\n  }\n\n  /**\n   * @internal\n   * @override\n   * @returns {object}\n   */\n  getData() {\n    let canAdd = true;\n\n    let sources = this.document.system.sources ?? [];\n\n    // Prevent adding new sources if there's already an empty source\n    if (sources.some((src) => Object.keys(src).length === 0)) canAdd = false;\n\n    // Shallow clone sources for extra data\n    sources = sources.map((src) => {\n      const registry = ffd20.registry.sources.get(src.id);\n      return {\n        ...src,\n        registry,\n      };\n    });\n\n    // Add default entry for editing when no entries exist\n    if (sources.length === 0) {\n      sources.push({ stub: true });\n      canAdd = false;\n    }\n\n    return {\n      editable: this.isEditable,\n      sources,\n      registry: ffd20.registry.sources,\n      uuid: this.document.uuid,\n      canAdd,\n    };\n  }\n\n  _getHeaderButtons() {\n    // HACK: Do not display import button\n    return super._getHeaderButtons().filter((b) => b.class !== \"import\");\n  }\n\n  /**\n   * @internal\n   * @param {Event} event\n   */\n  async _onAction(event) {\n    event.preventDefault();\n\n    const el = event.target;\n\n    if (el.classList.contains(\"disabled\")) return;\n\n    switch (el.dataset.action) {\n      case \"add\": {\n        this.form.disabled = true;\n        const sources = this.document.system.sources ?? [];\n        await this.document.update({ \"system.sources\": [...sources, {}] });\n        // Activate the newly created source tab\n        this.activateTab(`source-${sources.length}`);\n        break;\n      }\n      case \"delete\": {\n        const idx = Number(el.dataset.index);\n        if (Number.isFinite(idx) && idx >= 0) {\n          const src = this.document.system.sources[idx];\n          if (!src) return void this.render();\n          const name =\n            src.title || ffd20.registry.sources.get(src.id)?.name || game.i18n.localize(\"FFD20.ContentSource.NewEntry\");\n\n          const confirm = await foundry.applications.api.DialogV2.confirm({\n            window: { title: game.i18n.format(\"FFD20.ContentSource.DelTitle\", { entry: name }) },\n            content: game.i18n.format(\"FFD20.ContentSource.DelEntryDesc\", { entry: name }),\n            rejectClose: false,\n            modal: true, // Wait for user confirm\n          });\n\n          if (confirm !== true) return;\n\n          this.form.disabled = true;\n          const updated = await this.document.update({\n            \"system.sources\": this.document.system.sources.filter((_, sidx) => sidx !== idx),\n          });\n          if (!updated) this.render();\n        }\n        break;\n      }\n      default:\n        console.warn(\"Unrecognized action:\", el.dataset.action, el);\n        break;\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {string} selector\n   * @returns {boolean}\n   */\n  _canDragStart(selector) {\n    if (this.document.inContainer) return false;\n    return true;\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {string} selector\n   * @returns {boolean}\n   */\n  _canDragDrop(selector) {\n    if (this.document.inContainer) return false;\n    return this.isEditable;\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {DragEvent} event\n   */\n  _onDragStart(event) {\n    const el = event.currentTarget;\n\n    const index = Number(el.dataset.index);\n    const src = this.document.system.sources?.[index];\n\n    if (!src) return false;\n\n    // Set drag data\n    const dragData = {\n      type: \"pf1ContentSourceEntry\",\n      uuid: this.document.uuid,\n      index,\n      data: {\n        ...src,\n      },\n    };\n\n    event.dataTransfer.setData(\"text/plain\", JSON.stringify(dragData));\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {DragEvent} event\n   */\n  async _onDrop(event) {\n    const dropData = TextEditor.getDragEventData(event);\n\n    switch (dropData.type) {\n      case \"pf1ContentSourceEntry\":\n        this._onDropContentSource(event, dropData);\n        break;\n    }\n  }\n\n  /**\n   * Handle content source drop\n   *\n   * @remarks\n   * - Does not work correctly when dealing with\n   * @internal\n   * @param {DragEvent} event\n   * @param {object} dropData\n   */\n  async _onDropContentSource(event, dropData) {\n    let el = event.target;\n    if (el.dataset.index === undefined) el = el.closest(\".source[data-index]\");\n    let dropIndex = Number(el?.dataset.index);\n\n    this.form.disabled = true;\n\n    const src = dropData.data;\n    const origin = fromUuidSync(dropData.uuid);\n    if (!origin) return;\n\n    // Sort\n    if (origin === this.document) {\n      if (!Number.isFinite(dropIndex) || dropIndex < 0) return;\n      if (dropIndex === dropData.index) return;\n      const sources = this.document.toObject().system.sources ?? [];\n      const [moved] = sources.splice(dropData.index, 1);\n      sources.splice(dropIndex, 0, moved);\n      this.document.update({ \"system.sources\": sources });\n    }\n    // Copy\n    else {\n      const sources = this.document.toObject().system.sources ?? [];\n\n      // Disallow same ID source copy\n      if (src.id && sources.some((osrc) => osrc.id === src.id)) return; // TODO: Add error notification?\n\n      // If dropped in odd location, add as last\n      if (!Number.isFinite(dropIndex)) dropIndex = sources.length;\n      sources.splice(dropIndex, 0, src);\n      this.document.update({ \"system.sources\": sources });\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {JQuery<HTMLElement>} jq\n   */\n  activateListeners(jq) {\n    super.activateListeners(jq);\n\n    this.form\n      .querySelectorAll(\"header .control\")\n      .forEach((el) => el.addEventListener(\"click\", this._onAction.bind(this)));\n  }\n\n  /**\n   * Open editor application for defined document.\n   *\n   * @param {Actor|Item} document Item or Actor reference\n   * @returns {ContentSourceEditor} Reference to opened application.\n   */\n  static open(document) {\n    const app =\n      Object.values(ui.windows).find((app) => app instanceof this && app.object === document) ?? new this(document);\n    app.render(true, { focus: true });\n    return app;\n  }\n\n  _updateObject(event, updateData) {\n    updateData = foundry.utils.expandObject(updateData);\n\n    updateData.system.sources = Object.values(updateData.system.sources);\n\n    const sources = updateData.system.sources;\n    for (const source of sources) {\n      // Remove empty data\n      let empty = true;\n      for (const [key, value] of Object.entries(source)) {\n        if (value === null || value === \"\") {\n          delete source[key];\n        } else empty = false;\n      }\n\n      const registry = ffd20.registry.sources.get(source.id);\n\n      // Empty data that is auto-filled from registry\n      if (registry) {\n        delete source.title;\n        delete source.publisher;\n      }\n\n      // Mark as empty for followup removal\n      if (empty) source.empty = true;\n    }\n\n    updateData.system.sources = updateData.system.sources.filter((s) => s.empty !== true);\n\n    return this.document.update(updateData);\n  }\n}\n","const { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n// Add Vision Sharing sheet to ActorDirectory context options\nHooks.on(\"getActorDirectoryEntryContext\", function addVisionSharingContextMenu(html, menu) {\n  menu.push({\n    name: \"FFD20.Application.VisionSharing.Label\",\n    icon: '<i class=\"fa-solid fa-eye\"></i>',\n    condition: () => game.user.isGM,\n    callback: ([li]) =>\n      game.actors.get(li.dataset.documentId).visionSharingSheet.render(true, {\n        position: {\n          // Positioning copied from Foundry's ownership dialog\n          top: Math.min(li.offsetTop, window.innerHeight - 370),\n          left: window.innerWidth - 720,\n        },\n      }),\n  });\n});\n\nexport class VisionSharingSheet extends HandlebarsApplicationMixin(DocumentSheetV2) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"vision-sharing\"],\n    window: {\n      minimizable: false,\n    },\n    position: {\n      width: 400,\n      height: \"auto\",\n    },\n    form: {\n      handler: this._onSubmit,\n      closeOnSubmit: true,\n      submitOnChange: false,\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/vision-sharing.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  get title() {\n    let title = game.i18n.localize(\"FFD20.Application.VisionSharing.Label\") + `: ${this.actor.name}`;\n    if (this.actor.token) title += \"[\" + game.i18n.localize(\"Token\") + \"]\";\n    return title;\n  }\n\n  async _prepareContext() {\n    const context = {\n      levels: {\n        false: \"FFD20.No\",\n        true: \"FFD20.Yes\",\n      },\n      users: game.users.players.reduce((rv, user) => {\n        rv[user.id] = {\n          user,\n          level: null,\n        };\n        return rv;\n      }, {}),\n    };\n\n    const config = this.actor.getFlag(\"ffd20\", \"visionSharing\");\n    context.default = String(config?.default ?? false);\n    if (config?.users) {\n      Object.entries(config.users).forEach(([userId, level]) => (context.users[userId].level = String(level ?? null)));\n    }\n\n    // Footer buttons\n    context.buttons = [{ type: \"submit\", label: \"FFD20.Save\", icon: \"fa-solid fa-save\" }];\n\n    return context;\n  }\n\n  /** @type {Actor} */\n  get actor() {\n    return this.document;\n  }\n\n  /**\n   * @this {VisionSharingSheet}\n   * @param {Event} event\n   * @param {HTMLFormElement} form\n   * @param {FormDataExtended} formData\n   */\n  static async _onSubmit(event, form, formData) {\n    formData = foundry.utils.expandObject(formData.object);\n\n    // Clear users that are using default\n    for (const [userId, enabled] of Object.entries(formData.users)) {\n      if (enabled) formData.users[userId] = enabled === \"true\";\n      else formData.users[`-=${userId}`] = null;\n    }\n\n    await this.actor.setFlag(\"ffd20\", \"visionSharing\", formData);\n  }\n}\n","import { NoAutocomplete } from \"./mixins/no-autocomplete.mjs\";\nimport { DragDropApplicationMixin } from \"@app/mixins/drag-drop.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nexport class ExperienceDistributor extends DragDropApplicationMixin(\n  HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2))\n) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"experience-distributor\", \"standard-form\"],\n    window: {\n      title: \"FFD20.Application.XPDistributor.Title\",\n      minimizable: true,\n      resizable: true,\n    },\n    actions: {\n      split: this._doSplitReward,\n      full: this._doFullReward,\n    },\n    dragDrop: [{ dragSelector: null, dropSelector: \"form\" }],\n    position: {\n      width: 450,\n      height: 690,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/experience-distributor.hbs\",\n      scrollable: [\".selectors\"],\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  /**\n   * Bonus XP granted\n   *\n   * @type {number}\n   */\n  _bonusXP = 0;\n\n  /**\n   * Special actor data array\n   *\n   * @type {ExperienceDistributorActor[]}\n   */\n  _actors = [];\n\n  constructor(options) {\n    if (Array.isArray(options)) {\n      foundry.utils.logCompatibilityWarning(\n        \"ExperienceDistributor constructor first parameter is no longer directly actor array. Please provide options object with actors property instead.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      options = { actors: options };\n    }\n\n    super(options);\n\n    const actors = options.actors ?? [];\n    this._actors = actors.map((actor) => this.constructor.getActorData(actor)).filter((o) => !!o);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @internal\n   */\n  _preparePartContext(partId, context) {\n    switch (partId) {\n      case \"footer\":\n        context.buttons = [\n          {\n            action: \"split\",\n            label: \"FFD20.Application.XPDistributor.SplitEvenly\",\n            type: \"button\", // non-default\n            icon: \"fa-solid fa-people-arrows\",\n          },\n          {\n            action: \"full\",\n            label: \"FFD20.Application.XPDistributor.GiveToAll\",\n            type: \"submit\", // default\n            icon: \"fa-solid fa-star\",\n          },\n        ];\n        break;\n      case \"form\":\n        // Add combatants\n        context.actors = {\n          characters: this.characters,\n          npcs: this.npcs,\n        };\n        // Add labels\n        context.xp = {\n          total: this.totalExperience.toLocaleString(),\n          split: this.splitExperience.toLocaleString(),\n        };\n        context.bonusXP = this._bonusXP;\n        break;\n    }\n\n    return context;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get PC actors\n   *\n   * @type {ExperienceDistributorActor[]}\n   */\n  get characters() {\n    return this._actors.filter((o) => !o.isNPC);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Get NPC actors\n   *\n   * @type {ExperienceDistributorActor[]}\n   */\n  get npcs() {\n    return this._actors.filter((o) => o.isNPC);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Handle Drop Event\n   *\n   * @param {DragEvent} event - The originating DragEvent\n   * @protected\n   * @override\n   */\n  async _onDrop(event) {\n    event.preventDefault();\n    const data = TextEditor.getDragEventData(event);\n\n    if (data.type !== \"Actor\") return;\n\n    // Add actor\n    const actor = await ffd20.documents.actor.ActorPF.fromDropData(data);\n\n    // Prevent duplicate characters (not NPCs)\n    if (actor.type !== \"character\" || this._actors.find((o) => o.actor === actor) == null) {\n      // Add actor to list\n      const actorData = this.constructor.getActorData(actor);\n      actorData.selected = true;\n      this._actors.push(actorData);\n\n      this.render({ parts: [\"form\"] });\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for changes to form input elements\n   *\n   * @internal\n   * @param {ApplicationFormConfiguration} formConfig   The configuration of the form being changed\n   * @param {Event} event                               The triggering event\n   * @returns {void}\n   */\n  _onChangeForm(formConfig, event) {\n    event.preventDefault();\n\n    const el = event.target;\n\n    if (el.matches(\"input[type=checkbox]\")) {\n      const actorID = el.dataset.id;\n      const actor = this._actors.find((o) => o.id === actorID);\n      if (!actor) return;\n      actor.selected = el.checked;\n    }\n\n    if (el.matches(\"input[name=bonusXP]\")) {\n      this._bonusXP = parseInt(el.value);\n      if (isNaN(this._bonusXP)) this._bonusXP = 0;\n    }\n\n    this.render({ parts: [\"form\"] });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Split reward for each\n   *\n   * @param {Event} event\n   * @returns\n   */\n  static _doSplitReward(event) {\n    event.preventDefault();\n    return this._giveExperience(true);\n  }\n\n  /**\n   * Full reward for each\n   *\n   * @internal\n   * @param {Event} event\n   * @returns\n   */\n  static _doFullReward(event) {\n    event.preventDefault();\n    return this._giveExperience(false);\n  }\n\n  /**\n   * Distributes experience to all PC actors\n   *\n   * @internal\n   * @this {ExperienceDistributor} - XP distributor instance rather than the class.\n   * @param {boolean} splitEvenly - Should XP be split evenly?\n   * @returns {Promise<void>}\n   */\n  async _giveExperience(splitEvenly = false) {\n    const total = this.totalExperience;\n    const split = this.splitExperience;\n    const value = splitEvenly ? split : total;\n    const characters = this.characters.filter((o) => o.selected);\n\n    if (characters.length == 0) {\n      return void ui.notifications.error(\"FFD20.Application.XPDistributor.Warnings.NoRecipients\", { localize: true });\n    }\n\n    if (!(value > 0)) {\n      return void ui.notifications.error(\"FFD20.Application.XPDistributor.Warnings.NoReward\", { localize: true });\n    }\n\n    if (splitEvenly)\n      console.debug(\"FFD20 | XP Reward |\", total, \"split evenly as\", split, \"to\", characters.length, \"characters\");\n    else console.debug(\"FFD20 | XP Reward |\", total, \"to all\");\n\n    for (const actorData of characters) {\n      const result = { value };\n      Hooks.callAll(\"pf1GainXp\", actorData.actor, result);\n      actorData.value = Math.floor(result.value);\n    }\n\n    const updates = characters\n      .filter((o) => o.value > 0 && Number.isSafeInteger(o.value))\n      .map((o) => ({\n        _id: o.actor.id,\n        \"system.details.xp.value\": o.actor.system.details.xp.value + o.value,\n      }));\n\n    this.close();\n\n    await Actor.implementation.updateDocuments(updates);\n\n    ui.notifications.info(game.i18n.format(\"FFD20.Application.XPDistributor.Result\", { xp: value }), { console: false });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Total experience the encounter is worth, including regular XP reward and bonus XP.\n   *\n   * @returns {number} - Total value\n   */\n  get totalExperience() {\n    const npcs = this.npcs.filter((o) => o.selected);\n    return npcs.reduce((cur, o) => cur + o.xp, this._bonusXP);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Split experience, as split across all characters.\n   *\n   * @returns {number} - Reward value\n   */\n  get splitExperience() {\n    const characters = this.characters.filter((o) => o.selected);\n    if (characters.length === 0) return 0;\n    const xp = this.totalExperience;\n    return Math.floor(xp / characters.length);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @protected\n   * @param {Actor} actor\n   * @returns {ExperienceDistributorActor}\n   */\n  static getActorData(actor) {\n    if (!(actor instanceof Actor)) return null;\n\n    const xp = ffd20.utils.CR.getXP(actor.getCR?.() ?? 0);\n\n    return {\n      id: foundry.utils.randomID(16),\n      isNPC: actor.type !== \"character\",\n      actor,\n      selected: this._shouldActorBeSelected(actor),\n      xp,\n      xpLabel: xp.toLocaleString(),\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Should the actor be selected by default.\n   *\n   * @param {Actor} actor\n   * @returns {boolean}\n   */\n  static _shouldActorBeSelected(actor) {\n    const isPC = actor.type === \"character\";\n    if (isPC) return true;\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const healthConfig = hpConfig.getActorConfig(actor);\n    const useWoundsAndVigor = healthConfig.rules.useWoundsAndVigor ?? false;\n\n    return useWoundsAndVigor ? actor.system.attributes?.wounds?.value <= 0 : actor.system.attributes?.hp?.value < 0;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Open XP distributor dialog based on passed combat instance.\n   *\n   * @param {Combat} combat - Combat instance\n   * @returns {ExperienceDistributor} - Application instance\n   */\n  static fromCombat(combat) {\n    const app = new this({ actors: combat.combatants.map((c) => c.actor) });\n\n    if (app.characters.length > 0) {\n      app.render({ force: true });\n    } else {\n      app.close();\n    }\n\n    return app;\n  }\n}\n\n/**\n * @typedef {object} ExperienceDistributorActor\n * @property {string} id - Internal reference ID\n * @property {ActorPF} actor - Actor instance\n * @property {boolean} isNPC - Is this an NPC?\n * @property {boolean} selected - Is the actor selected\n * @property {number} xp\n * @property {string} xpLabel\n */\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\nimport { Widget_CategorizedItemPicker } from \"./categorized-item-picker.mjs\";\n\nconst { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Change Editor\n *\n * @since PF1 v10\n */\nexport class ChangeEditor extends HandlebarsApplicationMixin(NoAutocomplete(DocumentSheetV2)) {\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._onSubmit,\n      submitOnChange: true,\n      submitOnClose: true,\n      closeOnSubmit: false,\n    },\n    classes: [\"pf1-v2\", \"change-editor\", \"standard-form\"],\n    window: {\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      width: 460,\n    },\n    actions: {\n      copyUuid: { handler: this.#onCopyUuid, buttons: [0, 2] },\n    },\n    sheetConfig: false,\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/change-editor.hbs\",\n    },\n  };\n\n  /** @type {ItemChange} */\n  change;\n\n  /**\n   * @internal\n   * @param options\n   */\n  constructor(options) {\n    super(options);\n    this.change = options.change;\n  }\n\n  /**\n   * Override to fix DocumentSheet ignoring get id\n   *\n   * @override\n   * @param {object} options - App options\n   */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n    options.uniqueId = this.getID(options); // HACK: Document Sheet ignores the id getter\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @type {ActorPF}\n   */\n  get actor() {\n    return this.item.actor;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @type {ItemPF}\n   */\n  get item() {\n    return this.document;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @type {string}\n   */\n  get title() {\n    let title = game.i18n.localize(\"FFD20.Application.ChangeEditor.Label\");\n    title += \": \" + this.item.name;\n    if (this.actor) title += \" â \" + this.actor.name;\n    return title;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   * @type {string}\n   */\n  get id() {\n    return this.getID();\n  }\n\n  /**\n   * HACK: To deal with AppV2 and DocumentSheetV2 behaviour\n   *\n   * @internal\n   * @param {object} options\n   * @returns {string}\n   */\n  getID(options) {\n    options ??= this.options;\n    return \"change-editor-\" + options.change.uuid.replaceAll(\".\", \"-\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    const change = this.change,\n      actor = this.actor,\n      item = this.item;\n\n    const buffTargets = ffd20.utils.internal.getBuffTargets(\"buffs\", { actor, item });\n    const target = buffTargets[change.target];\n\n    const editable = this.isEditable;\n\n    const defaultPriority = change.priority == 0,\n      earlyPriority = change.priority > 0,\n      latePriority = change.priority < 0;\n\n    return {\n      editable,\n      cssClass: editable ? \"\" : \"locked\",\n      config: ffd20.config,\n      actor,\n      item,\n      change,\n      // Which kind of priority does this have\n      priority: {\n        early: earlyPriority,\n        late: latePriority,\n        normal: defaultPriority,\n      },\n      // Alternative values\n      values: {\n        priority: {\n          early: earlyPriority ? change.priority : defaultPriority ? 1 : -change.priority,\n          late: latePriority ? change.priority : defaultPriority ? -1 : -change.priority,\n        },\n      },\n      isAdd: change.operator === \"add\",\n      isSet: change.operator === \"set\",\n      isValid: !!target,\n      isCustom: [\"skill\", \"cl\", \"sl\", \"concn\"].includes(change.target?.split(\".\")?.[0]),\n      isValidType: !!ffd20.config.bonusTypes[change.type],\n      isValidOp: [\"add\", \"set\"].includes(change.operator),\n      isSimple: change.isSimple,\n      isDeferred: change.isDeferred,\n      label: target?.label || change.target,\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @internal\n   * @param {Event} event\n   */\n  _onChangeTargetControl(event) {\n    event.preventDefault();\n\n    if (!this.isEditable) return;\n\n    // Prepare categories and changes to display\n    const categories = ffd20.utils.internal.getBuffTargetDictionary(\"buffs\", { actor: this.item.actor, item: this.item });\n\n    // Sort specific categories\n    const sortable = new Set([\"skill\"]);\n    const lang = game.settings.get(\"core\", \"language\");\n    for (const category of categories) {\n      if (!sortable.has(category.key)) continue;\n      category.items.sort((a, b) => a.label.localeCompare(b.label, lang));\n    }\n\n    let part1 = this.change?.target?.split(\".\")[0];\n    if (part1 === \"concn\") part1 = \"concentration\"; // HACK: Fixes spellbook concentration pointing wrong\n    const category = ffd20.config.buffTargets[part1]?.category ?? part1;\n\n    // Show widget\n    const w = new Widget_CategorizedItemPicker(\n      { window: { title: \"FFD20.Application.ChangeTargetSelector.Title\" }, classes: [\"change-target-selector\"] },\n      categories,\n      (key) => {\n        if (key) {\n          this.change.update({ target: key });\n        }\n      },\n      { category, item: this.change?.target }\n    );\n    w.render(true);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Show the help browser\n   *\n   * @internal\n   * @param {Event} event\n   */\n  _openHelpBrowser(event) {\n    event.preventDefault();\n    const a = event.currentTarget;\n\n    ffd20.applications.helpBrowser.openUrl(a.dataset.url);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Validate input formula for basic errors.\n   *\n   * @internal\n   * @param {HTMLElement} el\n   */\n  async _validateFormula(el) {\n    const formula = el.value;\n    if (!formula) return;\n\n    let roll;\n    // Test if formula even works\n    try {\n      roll = Roll.create(formula);\n      await roll.evaluate({ allowInteractive: false });\n    } catch (e) {\n      el.dataset.tooltip = e.message;\n      el.setCustomValidity(e.message);\n      return;\n    }\n\n    if (el.classList.contains(\"simple\")) {\n      if (!roll.isDeterministic || formula.includes(\"@\")) {\n        el.dataset.tooltip = \"FFD20.Warning.FormulaMustBeSimple\";\n        el.setCustomValidity(game.i18n.localize(\"FFD20.Warning.FormulaMustBeSimple\"));\n      }\n    }\n    // Deterministic formulas must be deterministic\n    else if (el.classList.contains(\"deterministic\")) {\n      if (!roll.isDeterministic) {\n        el.dataset.tooltip = \"FFD20.Warning.FormulaMustBeDeterministic\";\n        el.setCustomValidity(game.i18n.localize(\"FFD20.Warning.FormulaMustBeDeterministic\"));\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Test if this Change is in its declared parent.\n   *\n   * @type {boolean}\n   */\n  get inParent() {\n    return !!this.document.changes.get(this.change.id);\n  }\n\n  /**\n   * HACK: Override to force close the dialog when the Change is deleted\n   *\n   * @override\n   * @param {object} options - Options\n   * @param {object} _options - Legacy options\n   */\n  async render(options, _options) {\n    // Despite _options being deprecated, it is the only place for render context\n    if (_options?.renderContext === \"updateItem\") {\n      // Close instead of rendering if the Change no longer exists, ignoring anything else\n      if (!this.inParent) return this.close();\n    }\n    return super.render(options, _options);\n  }\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} context      Prepared context data\n   * @param {RenderOptions} options                 Provided render options\n   * @protected\n   */\n  _onRender(context, options) {\n    // Modify changes\n    this.element\n      .querySelector(\".target .change-target\")\n      .addEventListener(\"click\", this._onChangeTargetControl.bind(this));\n\n    // Open help browser\n    this.element.querySelector(\"a.help-browser[data-url]\").addEventListener(\"click\", this._openHelpBrowser.bind(this));\n\n    // Add warning about formulas\n    this.element.querySelectorAll(\"input.formula\").forEach(async (el) => this._validateFormula(el));\n\n    this.element.reportValidity();\n\n    // Disable form if not editable\n    if (!this.isEditable) {\n      for (const el of this.element.querySelectorAll(\".window-content :is(input,select)\")) {\n        el.disabled = true;\n      }\n    }\n  }\n\n  /**\n   * Override document ID/UUID handling and redirect them to the Change\n   *\n   * @internal\n   * @override\n   * @param {PointerEvent} event - Triggering event\n   * @this {ChangeEditor}\n   */\n  static #onCopyUuid(event) {\n    event.preventDefault();\n    event.stopPropagation();\n    if (event.detail > 1) return; // Ignore repeated clicks\n    const id = event.button === 2 ? this.change.id : this.change.uuid;\n    const type = event.button === 2 ? \"id\" : \"uuid\";\n    const label = game.i18n.localize(\"FFD20.Change\");\n    game.clipboard.copyPlainText(id);\n    ui.notifications.info(game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label, type, id }));\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {object} options - Application options\n   * @param {ItemChange} options.change - Change to modify\n   * @param {object} oldOptions - Deprecated application options\n   * @returns {Promise<void|ChangeEditor>} - Promise that resolves when the app is closed. Returns application instance if no new instance was created.\n   */\n  static async wait(options, oldOptions = {}) {\n    if (options instanceof ffd20.components.ItemChange) {\n      foundry.utils.logCompatibilityWarning(\n        \"ChangeEditor.wait() first parameter as change instance is deprecated. Please include it in app options instead.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      oldOptions.change = options;\n      options = oldOptions;\n    }\n\n    const old = Object.values(foundry.applications.instances).find(\n      (app) => app instanceof this && app.change === options.change\n    );\n\n    if (old) {\n      old.render(true);\n      old.bringToFront();\n      return old;\n    }\n\n    return new Promise((resolve) => {\n      options.document = options.change.parent;\n      const app = new this(options);\n      app.resolve = resolve;\n      app.render(true);\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update the object with the new change data from the form.\n   *\n   * @this {ChangeEditor}\n   * @param {SubmitEvent} event                   The originating form submission event\n   * @param {HTMLFormElement} form                The form element that was submitted\n   * @param {FormDataExtended} formData           Processed data for the submitted form\n   * @returns {Promise<void>}\n   * @private\n   */\n  static _onSubmit(event, form, formData) {\n    formData = formData.object;\n    const updateData = foundry.utils.expandObject(formData).change;\n    this.change.update(updateData);\n  }\n}\n","export class ItemDirectoryPF extends ItemDirectory {\n  /**\n   * Enrich default options for detecting identified/unidentified name changes\n   *\n   * @override\n   */\n  static get defaultOptions() {\n    const options = super.defaultOptions;\n    options.renderUpdateKeys.push(\"system.unidentified.name\", \"system.identified\");\n    return options;\n  }\n}\n","const { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\nexport class Troubleshooter extends HandlebarsApplicationMixin(ApplicationV2) {\n  static DEFAULT_OPTIONS = {\n    id: \"pf1-troubleshooter\",\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"troubleshooter\"],\n    window: {\n      title: \"FFD20.Troubleshooter.Title\",\n      minimizable: false,\n      resizable: false,\n    },\n    position: {\n      width: 460,\n    },\n    actions: {\n      migrate: this._runMigration,\n      help: this._openHelp,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/troubleshooter.hbs\",\n    },\n  };\n\n  // Are packs to be unlocked?\n  unlock = false;\n\n  // Are already migrated documents to be reprocessed?\n  reprocess = false;\n\n  // Migration state\n  migrating = { world: false, modules: false };\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _prepareContext() {\n    return {\n      isGM: game.user.isGM,\n      unlockPacks: this.unlock,\n      reprocess: this.reprocess,\n      migrating: this.migrating,\n      links: {\n        help: `<a data-action='help'>${game.i18n.localize(\"FFD20.Troubleshooter.Steps.HelpLink\")}</a>`,\n        report: `<a href=\"https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/issues\">${game.i18n.localize(\n          \"FFD20.Troubleshooter.Steps.ReportLinkText\"\n        )}</a>`,\n        foundry: {\n          kb: `<a href=\"https://foundryvtt.com/kb/\">${game.i18n.localize(\"FFD20.Troubleshooter.Steps.FoundryLink\")}</a>`,\n          discord: `<a href=\"https://discord.gg/foundryvtt\">Foundry VTT</a>`,\n          channel: \"#pf1\",\n        },\n        faq: \"https://gitlab.com/foundryvtt_pathfinder1e/foundryvtt-pathfinder1/-/wikis/FAQs\",\n        helpmodule: `<a href=\"https://foundryvtt.com/packages/find-the-culprit\">Find the Culprit</a>`,\n      },\n    };\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {Event} event - Triggering event\n   * @param {Element} button - Source button\n   */\n  static async _runMigration(event, button) {\n    const unlock = this.unlock ?? false;\n    const fast = !this.reprocess;\n\n    /** @type {Element} */\n    if (button.disabled) return;\n\n    button.classList.remove(\"finished\");\n    button.disabled = true;\n    button.classList.add(\"active\");\n\n    const target = button.dataset.target;\n    const top = button.closest(\".window-content\").getBoundingClientRect().top + 20;\n\n    switch (target) {\n      case \"world\":\n        this.migrating.world = true;\n        await ffd20.migrations.migrateWorld({ unlock, fast, dialog: { top } });\n        this.migrating.world = false;\n        break;\n\n      case \"modules\":\n        this.migrating.modules = true;\n        await ffd20.migrations.migrateModules({ unlock, fast, dialog: { top } });\n        this.migrating.modules = false;\n        break;\n\n      default:\n        throw new Error(`Unrecognized migration target: \"${target}\"`);\n    }\n\n    this.element?.querySelector(\".form-body\").classList.remove(\"migrating\");\n    button.disabled = false;\n    button.classList.remove(\"active\");\n    button.classList.add(\"finished\");\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {Event} _event - Triggering event\n   */\n  static _openHelp(_event) {\n    ffd20.applications.helpBrowser.openUrl(\"Help/Home\");\n  }\n  /* -------------------------------------------- */\n\n  /**\n   * The event handler for changes to form input elements\n   *\n   * @internal\n   * @override\n   * @param {ApplicationFormConfiguration} formConfig - The configuration of the form being changed\n   * @param {Event} event - The triggering event\n   */\n  _onChangeForm(formConfig, event) {\n    const target = event.target;\n\n    switch (target.name) {\n      case \"unlock\":\n        this.unlock = target.checked;\n        break;\n      case \"reprocess\":\n        this.reprocess = target.checked;\n        break;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Attach event listeners to the rendered application form.\n   *\n   * @param {ApplicationRenderContext} _context      Prepared context data\n   * @param {RenderOptions} _options                 Provided render options\n   * @protected\n   */\n  _onRender(_context, _options) {\n    const migrationButtons = this.element.querySelectorAll(\"button[data-action='migrate']\");\n\n    // React to external migration to minimal degree\n    if (ffd20.migrations.isMigrating) {\n      this.migrating.world = true;\n      this.migrating.modules = true;\n      for (const button of migrationButtons) {\n        button.disabled = true;\n        button.classList.add(\"active\");\n      }\n\n      Hooks.once(\"pf1MigrationFinished\", () => {\n        for (const button of migrationButtons) {\n          button.disabled = false;\n          this.migrating.world = false;\n          this.migrating.modules = false;\n        }\n      });\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  static open() {\n    new Troubleshooter().render(true);\n  }\n}\n","import { AbstractDocumentSelector } from \"@app/abstract-document-selector.mjs\";\n\n/**\n * A specialized form application for selecting an Actor from a list of available choices\n */\nexport class ActorSelector extends AbstractDocumentSelector {\n  static DEFAULT_OPTIONS = {\n    actors: undefined,\n    ownership: undefined,\n    selected: null,\n    window: {\n      title: \"FFD20.Application.ActorSelector.Title\",\n    },\n  };\n\n  /* -------------------------------------------- */\n\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n    options.ownership ||= CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED;\n    options.actors ||= [...game.actors];\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  async _getSections() {\n    let actorList = this.options.filterFunc ? this.options.actors.filter(this.filterFunc) : [...this.options.actors];\n\n    actorList = actorList.filter((actor) => actor.testUserPermission(game.user, this.options.ownership));\n\n    if (this.options.search.value) {\n      actorList = actorList.filter((actor) =>\n        actor.name.toLowerCase().includes(this.options.search.value.toLowerCase())\n      );\n    }\n\n    actorList.sort((a, b) => a.name.localeCompare(b.name));\n\n    actorList = actorList.map((actor) => {\n      return {\n        id: actor.id,\n        name: actor.name,\n        img: actor.img,\n        isOwner: actor.isOwner,\n        extras: [\n          {\n            label: \"FFD20.Application.ActorSelector.Owner\",\n            value: [...game.users]\n              .filter((user) => actor.testUserPermission(user, CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER))\n              .map((user) =>\n                user.id === game.user.id ? game.i18n.localize(\"FFD20.Application.ActorSelector.You\") : user.name\n              )\n              .join(\", \"),\n          },\n        ],\n      };\n    });\n\n    return [\n      {\n        id: \"owned\",\n        label: \"FFD20.Application.ActorSelector.OwnedActors\",\n        documents: actorList.filter((actor) => actor.isOwner),\n      },\n      {\n        id: \"unowned\",\n        label: \"FFD20.Application.ActorSelector.UnownedActors\",\n        documents: actorList.filter((actor) => !actor.isOwner),\n      },\n    ];\n  }\n}\n","/**\n * Stack splitting dialog\n *\n * @example\n * ```js\n * const result = await ffd20.applications.SplitStack.wait({ title: \"My Stuff\", initial: 50, total: 100 });\n * if (!result) throw new Error(\"Fsck!\");\n * const [keep,split] = result;\n * console.log(`I keep ${keep} and you get ${split}`);\n * ```\n */\nexport class SplitStack extends foundry.applications.api.DialogV2 {\n  /**\n   * Wait for user interaction to finish.\n   *\n   * @param {object} options - Options\n   * @param {string} [options.title] - Dialog title\n   * @param {number} options.initial - Initial value\n   * @param {number} options.total - Total value to split.\n   * @param {number} [options.step] - Value stepping.\n   * @param {string[]} [options.css] - Optional CSS selectors to add to the dialog.\n   * @param {object} dialogOptions - Additional options to pass to DialogV2\n   * @returns {Promise<number[]|null>} - Number tuple, to keep and to split values. Null if cancelled.\n   */\n  static async wait({ title, initial = 1, step = 1, total, css = [] } = {}, dialogOptions = {}) {\n    // Can't split\n    if (total <= 1) return null;\n    // Only one answer\n    if (total == 2) return [1, 1];\n\n    step ||= 1;\n    initial = Math.clamp(initial || 0, 1, total);\n    const max = total - 1;\n\n    const content = await renderTemplate(\"systems/ffd20/templates/apps/split-stack.hbs\", {\n      initial,\n      keep: total - initial,\n      max,\n    });\n\n    const options = {\n      window: { title },\n      content,\n      classes: [\"pf1-v2\", \"split-stack\", ...css],\n      buttons: [\n        {\n          icon: \"fa-solid fa-people-arrows\",\n          label: game.i18n.localize(\"FFD20.Split\"),\n          action: \"split\",\n          default: true,\n          callback: (event, target, html) => {\n            const splitValue = Math.clamp(html.querySelector(\"form input.split\").valueAsNumber, 1, max);\n            if (Number.isNumeric(splitValue)) {\n              return [Math.max(1, total - splitValue), splitValue];\n            }\n            return null;\n          },\n        },\n      ],\n      render: (event, html) => {\n        html = html.querySelector(\".dialog-content\");\n        const slider = html.querySelector(\"input.slider\");\n        const oldStack = html.querySelector(\"input.left\");\n        const newStack = html.querySelector(\"input.split\");\n        slider.addEventListener(\n          \"input\",\n          (ev) => {\n            const newValue = ev.target.valueAsNumber;\n            newStack.value = newValue;\n            oldStack.value = total - newValue;\n          },\n          { passive: true }\n        );\n        newStack.addEventListener(\n          \"input\",\n          (ev) => {\n            let newValue = ev.target.valueAsNumber;\n            if (newValue > max) {\n              newStack.value = max;\n              newValue = max;\n            } else if (newValue < 1) {\n              newStack.value = 1;\n              newValue = 1;\n            }\n            slider.value = newValue;\n            oldStack.value = total - newValue;\n          },\n          { passive: true }\n        );\n        oldStack.addEventListener(\"input\", (ev) => {\n          let newValue = total - ev.target.valueAsNumber;\n          if (newValue > total) {\n            oldStack.value = max;\n            newValue = 1;\n          } else if (newValue < 1) {\n            oldStack.value = 1;\n            newValue = max;\n          }\n          newStack.value = newValue;\n          slider.value = newValue;\n        });\n      },\n      close: () => null,\n      rejectClose: false,\n    };\n\n    return super.wait(foundry.utils.mergeObject(options, dialogOptions));\n  }\n}\n","const { DocumentSheetV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * HTML Editor\n *\n * Generic HTML text editor.\n *\n * @group Applications\n */\nexport class HTMLEditor extends HandlebarsApplicationMixin(DocumentSheetV2) {\n  /** @override */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n\n    options.uniqueId += `-${options.path.replaceAll(\".\", \"-\")}`;\n\n    return options;\n  }\n\n  /** @override */\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"html-editor\"],\n    window: {\n      minimizable: false,\n      resizable: true,\n    },\n    position: {\n      height: 520,\n      width: 580,\n    },\n    sheetConfig: false,\n    form: {\n      closeOnSubmit: true,\n      submitOnChange: true,\n    },\n  };\n\n  /** @override */\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/html-editor.hbs\",\n    },\n  };\n\n  /** @override */\n  get title() {\n    return this.options.window.title || super.title;\n  }\n\n  /** @override */\n  _prepareContext() {\n    return {\n      uuid: this.document.uuid,\n      content: foundry.utils.getProperty(this.document, this.options.path),\n      path: this.options.path,\n      editable: this.isEditable,\n      field: new foundry.data.fields.HTMLField(),\n    };\n  }\n\n  /** @override */\n  _processSubmitData(event, form, submitData) {\n    if (this.options.callback) return this.options.callback(submitData);\n    else this.document.update(submitData);\n  }\n}\n","import { NoAutocomplete } from \"./mixins/no-autocomplete.mjs\";\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Apply Damage Prompt\n *\n * Handles damage application UX when adjustment is desired.\n *\n * Calls {@link ActorPF#applyDamage} when finally committing changes.\n *\n * Called primarily from {@link ActorPF.applyDamage}\n */\nexport class ApplyDamage extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  /** @type {number} */\n  value;\n  /** @type {boolean} */\n  isHealing;\n  /** @type {boolean} */\n  asWounds;\n  /** @type {number} */\n  critMult;\n  /** @type {boolean} */\n  asNonlethal;\n  /** @type {boolean} */\n  asManaDamage;\n  /** @type {number} */\n  reduction;\n  /** @type {Collection<object>} */\n  targets;\n  /** @type {Array} */\n  instances;\n  /** @type {Function} */\n  resolve;\n\n  constructor(options) {\n    const isHealing = options.value < 0;\n    if (isHealing) options.value = -options.value;\n\n    const { resolve } = options;\n\n    super(options);\n\n    this.damageOptions = {\n      asNonlethal: options.asNonlethal ?? false,\n      asManaDamage: options.asManaDamage ?? false,\n      asWounds: options.asWounds ?? false,\n      critMult: options.critMult ?? 0,\n      dualHeal: options.dualHeal ?? game.settings.get(\"ffd20\", \"dualHeal\"),\n    };\n\n    Object.defineProperties(this, {\n      resolve: {\n        value: resolve,\n        writable: true,\n        enumerable: false,\n      },\n      isHealing: {\n        value: isHealing,\n        writable: false,\n      },\n      asWounds: {\n        value: options.asWounds ?? false,\n      },\n      asNonlethal: {\n        value: options.asNonlethal ?? false,\n      },\n      asManaDamage: {\n        value: options.asManaDamage ?? false,\n      },\n      critMult: {\n        value: options.critMult || 0,\n      },\n      value: {\n        value: options.value,\n        writable: true,\n      },\n      reduction: {\n        value: options.reduction,\n        writable: true,\n      },\n      woundsAndVigor: {\n        value: false,\n        writable: true,\n      },\n    });\n\n    this._prepareInstances();\n    this._prepareTargets();\n  }\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"apply-damage\", \"standard-form\"],\n    window: {\n      resizable: true,\n      minimizable: false,\n    },\n    position: {\n      width: 460,\n      height: \"auto\",\n    },\n    actions: {\n      apply: this._onApply,\n    },\n  };\n\n  get title() {\n    return this.isHealing ? game.i18n.localize(\"FFD20.ApplyHealing\") : game.i18n.localize(\"FFD20.ApplyDamage\");\n  }\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/apply-damage-dialog.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  _preparePartContext(partId, context, options) {\n    switch (partId) {\n      case \"footer\": {\n        context.buttons = [\n          {\n            action: \"apply\",\n            type: \"submit\",\n            label: game.i18n.localize(\"FFD20.Apply\"),\n            icon: \"fa-solid fa-heart-pulse\",\n            default: true,\n          },\n        ];\n        break;\n      }\n      case \"form\": {\n        context.value = this.value;\n        context.isHealing = this.isHealing;\n        context.reduction = this.reduction;\n        context.targets = this.targets;\n        context.instances = this.instances;\n        context.hasPhysical = this.hasPhysical;\n        context.hasEnergy = this.hasEnergy;\n        context.options = this.damageOptions;\n        context.useWoundsAndVigor = this.woundsAndVigor;\n        break;\n      }\n    }\n\n    return context;\n  }\n\n  /**\n   * @override\n   * @param {object} options\n   * @param {Event} event\n   */\n  _onChangeForm(options, event) {\n    const formData = foundry.utils.expandObject(new FormDataExtended(this.element).object);\n\n    const name = event.target.name;\n    const parts = name.split(\".\");\n    if (parts[0] === \"targets\") {\n      const idx = parts[1];\n      const data = formData.targets[idx];\n      this._updateTarget(data.uuid, data);\n    }\n\n    switch (name) {\n      case \"value\":\n        this.value = formData.value;\n        break;\n      case \"reduction\":\n        this.reduction = formData.reduction;\n        break;\n    }\n\n    for (const target of this.targets) this._updateTarget(target.uuid);\n\n    // Merge options\n    foundry.utils.mergeObject(this.damageOptions, formData.options);\n\n    // Re-render if no action was triggered\n    if (!event.target.dataset?.action) this.render({ parts: [\"form\"] });\n  }\n\n  /** @override */\n  _onClose() {\n    super._onClose();\n\n    this.resolve?.(null);\n  }\n\n  /**\n   * Prepare damage/healing instances.\n   *\n   * Merge damage instances of same type.\n   */\n  _prepareInstances() {\n    const instances = this.options.instances;\n\n    for (let i = 1; i < instances.length; i++) {\n      const cur = instances[i];\n      if (cur.value == 0) continue;\n\n      // Merge with previous if one exists\n      for (let y = 0; y < i; y++) {\n        const prev = instances[y];\n        if (prev.value == 0) continue;\n        if (cur.types.equals(prev.types)) {\n          prev.value += cur.value;\n          cur.value = 0;\n          break;\n        }\n      }\n    }\n\n    Object.defineProperty(this, \"instances\", {\n      value: instances.filter((i) => i.value != 0),\n      writable: false,\n      enumerable: false,\n    });\n  }\n\n  _prepareTargets() {\n    const instances = this.instances ?? [];\n    for (const instance of instances) {\n      instance.label = ffd20.utils.i18n.join(instance.names, \"u\", true);\n    }\n\n    const unknownTypes =\n      instances.length === 0 ||\n      instances.some((i) => i.standard.some((t) => ![\"physical\", \"energy\"].includes(t.category)));\n\n    Object.defineProperties(this, {\n      hasPhysical: {\n        value: unknownTypes ? true : instances.some((i) => i.standard.some((t) => t.category === \"physical\")),\n        enumerable: false,\n        writable: false,\n      },\n      hasEnergy: {\n        value: unknownTypes ? true : instances.some((i) => i.standard.some((t) => t.category === \"energy\")),\n        enumerable: false,\n        writable: false,\n      },\n    });\n\n    Object.defineProperty(this, \"targets\", {\n      value: new Collection(),\n      writable: false,\n      enumerable: false,\n    });\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpconfig = game.settings.get(\"ffd20\", \"healthConfig\");\n\n    for (const actor of this.options.targets) {\n      const target = {\n        uuid: actor.uuid,\n        actor,\n        name: actor.token?.name || actor.name,\n        value: this.value,\n        isToken: !!actor.token,\n        ratio: 1,\n        dr: this.hasPhysical ? this.getResistances(actor, \"dr\") : [],\n        get activeDR() {\n          return this.dr.some((r) => r.enabled);\n        },\n        eres: this.hasEnergy ? this.getResistances(actor, \"eres\") : [],\n        get activeER() {\n          return this.eres.some((r) => r.enabled);\n        },\n        hardness: actor.system.traits.hardness,\n        reduction: undefined,\n        reductionChoices: 0, // Display choices\n        di: actor.system.traits?.di?.names ?? [],\n        dv: actor.system.traits?.dv?.names ?? [],\n        selected: true,\n      };\n\n      target.haveDIV = target.di.length || target.dv.length;\n      target.haveDER = target.dr.length || target.eres.length || target.hardness;\n\n      this.targets.set(target.uuid, target);\n\n      this._updateTarget(target.uuid);\n\n      const cfg = hpconfig.getActorConfig(actor);\n      this.woundsAndVigor ||= cfg.rules.useWoundsAndVigor ?? false;\n    }\n  }\n\n  /**\n   *\n   * @param {ActorPF} actor\n   * @param {\"dr\"|\"eres\"} resistanceType\n   * @returns {object[]} - Array of results from {@link ActorPF._parseResistance()}\n   */\n  getResistances(actor, resistanceType = \"dr\") {\n    const res = actor.system.traits?.[resistanceType];\n    if (!res) return;\n\n    const resistances = [];\n\n    if (res.custom) {\n      for (const entry of res.custom.split(ffd20.config.re.traitSeparator)) {\n        const re = actor._parseResistanceEntry(entry, resistanceType);\n        resistances.push(re);\n      }\n    }\n    if (res.value?.length) {\n      for (const entry of res.value) {\n        const re = actor._parseResistanceEntry(entry, resistanceType);\n        resistances.push(re);\n      }\n    }\n\n    const damageTypes = new Set(this.instances.map((i) => [...i.types]).flat());\n\n    // Add in data used by this dialog\n    const enrichResistance = (res) => {\n      res.value = res.amount;\n      res.active = false;\n      res.typeIds = [res.type0?.id, res.type1?.id].filter((t) => t);\n      res.enabled = true;\n      res.hasGeneric = res.isDR && (res.typeIds.length === 0 || res.typeIds.includes(\"\"));\n\n      // Set generic resistances to be active by default\n      if (res.hasGeneric) {\n        res.active = true;\n      } else {\n        // Operator: true -> OR; false -> AND\n        if (res.operator) {\n          // OR; if any of the resistance types are in the damage types, the resistance is overcome\n          res.active = !res.typeIds.some((t) => damageTypes.has(t));\n        } else {\n          // AND; if all of the resistance types are in the damage types, the resistance is overcome\n          res.active = !res.typeIds.every((t) => damageTypes.has(t));\n        }\n      }\n    };\n\n    for (const res of resistances) enrichResistance(res);\n\n    return resistances;\n  }\n\n  /**\n   * Update target data based on form data and recalculate values.\n   *\n   * @internal\n   * @param {string} targetId\n   * @param {object} [data] - Update data\n   */\n  _updateTarget(targetId, data) {\n    const target = this.targets.get(targetId);\n    if (data) {\n      const { dr, eres } = data;\n      delete data.dr;\n      delete data.eres;\n\n      foundry.utils.mergeObject(target, data);\n\n      if (dr) Object.values(dr).forEach((rdata, idx) => foundry.utils.mergeObject(target.dr[idx], rdata));\n      if (eres) Object.values(eres).forEach((rdata, idx) => foundry.utils.mergeObject(target.eres[idx], rdata));\n    }\n\n    // Update value\n    target.value = Math.floor(this.value * (target.ratio ?? 0));\n    // Reduction input\n    const baseReduction = (target.reduction || 0) + (this.reduction || 0);\n    // Reduction choices\n    let reductionChoices = 0;\n    reductionChoices += target.dr.filter((r) => r.active).reduce((total, cur) => total + cur.value, 0);\n    reductionChoices += target.eres.filter((r) => r.active).reduce((total, cur) => total + cur.value, 0);\n\n    target.reductionChoices = reductionChoices;\n\n    // Reduce and clamp\n    target.value -= baseReduction + reductionChoices;\n    if (target.value < 0) target.value = 0;\n  }\n\n  /**\n   * Apply health and mana changes\n   *\n   * @param {Event} event\n   * @param {HTMLElement} target\n   * @this {ApplyDamage}\n   */\n  static async _onApply(event, target) {\n    event.preventDefault();\n\n    const resolve = this.resolve;\n    this.resolve = null; // Prevent _onClose() calling resolve\n    const config = {\n      value: this.options.value,\n      reduction: this.reduction || 0,\n      isHealing: this.isHealing,\n      asWounds: this.asWounds,\n      asNonlethal: this.asNonlethal,\n      asManaDamage: this.asManaDamage,\n      instances: this.instances,\n      targets: this.targets,\n    };\n\n    // This causes clicks to go through the dialog\n    this.element.inert = true;\n\n    // Applied value with general damage reduction accounted for\n    let value = Math.max(0, this.value - (this.reduction || 0));\n    if (this.isHealing) value = -value; // Flip healing\n\n    const updated = [];\n    try {\n      const promises = [];\n\n      let targetCount = 0;\n      for (const target of this.targets) {\n        if (target.value == 0) continue;\n        targetCount++;\n        const p = target.actor.applyDamage(value, this._getTargetDamageOptions(target));\n        updated.push(target.actor);\n        promises.push(p);\n      }\n\n      await Promise.all(promises);\n\n      value = Math.abs(value);\n      if (this.isHealing)\n        ui.notifications.info(game.i18n.format(\"FFD20.Application.Damage.ApplyHeal\", { targets: targetCount }));\n      else ui.notifications.info(game.i18n.format(\"FFD20.Application.Damage.ApplyDamage\", { targets: targetCount }));\n    } catch (err) {\n      ui.notifications.error(err.message, { console: false });\n      throw err;\n    } finally {\n      this.close();\n\n      config.updated = updated;\n      resolve(config);\n    }\n  }\n\n  _getTargetDamageOptions(target) {\n    const options = ffd20.utils.deepClone({\n      ...this.damageOptions, // Spread damage options in, allowing modules to extend the options and slip in extra data\n      reduction: (target.reduction || 0) + (this.reduction || 0) + target.reductionChoices,\n      ratio: target.ratio ?? 1,\n      event: this.options.event,\n      message: this.options.message,\n      element: this.options.element,\n      instances: this.instances,\n    });\n    return options;\n  }\n\n  /**\n   *\n   * @param {object} options - Options passed to apply damage\n   * @param {object} [renderOptions] - Render options passed to the application.\n   * @returns {Promise<null|object>} - Null if cancelled, object describing applied settings.\n   */\n  static async wait(options, renderOptions = {}) {\n    return new Promise((resolve) => {\n      options.resolve = resolve;\n      const app = new this(options);\n      app.render(true, renderOptions);\n    });\n  }\n}\n","/**\n * The various {@link Application}s used by the Pathfinder 1e system.\n *\n * @module\n */\n\nimport { CompendiumBrowser } from \"./compendium-browser/compendium-browser.mjs\";\n\nexport * as actor from \"./actor/_module.mjs\";\nexport * as item from \"./item/_module.mjs\";\nexport * as component from \"./component/_module.mjs\";\nexport * as settings from \"./settings/_module.mjs\";\nexport * as compendiumBrowser from \"./compendium-browser/_module.mjs\";\nexport * as journal from \"./journal/_module.mjs\";\nexport * as mixin from \"./mixins/_module.mjs\";\nexport * as utils from \"./utils/_module.mjs\";\n\nexport { ActionSelector } from \"./action-selector.mjs\";\nexport { AttackDialog } from \"./attack-dialog.mjs\";\nexport { Widget_CategorizedItemPicker } from \"./categorized-item-picker.mjs\";\nexport { ChangeLogWindow } from \"./change-log.mjs\";\nexport { CurrencyTransfer } from \"./currency-transfer.mjs\";\nexport { DamageTypeSelector } from \"./damage-type-selector.mjs\";\nexport { EntrySelector } from \"./entry-selector.mjs\";\nexport { ItemSelector } from \"./item-selector.mjs\";\nexport { HelpBrowserPF } from \"./help-browser.mjs\";\nexport { Widget_ItemPicker } from \"./item-picker.mjs\";\nexport { LevelUpForm } from \"./level-up.mjs\";\nexport { PointBuyCalculator } from \"./point-buy-calculator.mjs\";\nexport { ScriptEditor } from \"./script-editor.mjs\";\nexport { SensesSelector } from \"./senses-selector.mjs\";\nexport { SkillEditor } from \"./skill-editor.mjs\";\nexport { ContentSourceEditor } from \"./content-source-editor.mjs\";\nexport { ActorTraitSelector } from \"./trait-selector.mjs\";\nexport { VisionSharingSheet } from \"./vision-sharing.mjs\";\nexport { ExperienceDistributor } from \"./experience-distributor.mjs\";\nexport { ChangeEditor } from \"./change-editor.mjs\";\n\nexport { ItemDirectoryPF } from \"./sidebar/items-directory.mjs\";\nexport { Troubleshooter } from \"./troubleshooter.mjs\";\n\nexport { ActorSelector } from \"./actor-selector.mjs\";\nexport { SplitStack } from \"./split-stack.mjs\";\nexport { HTMLEditor } from \"./html-editor.mjs\";\n\nexport { ApplyDamage } from \"./apply-damage.mjs\";\n\n/**\n * {@link CompendiumBrowser}s for the various compendiums.\n *\n * @type {Record<string, CompendiumBrowser>}\n */\nexport const compendiums = {};\nexport { helpBrowser } from \"./help-browser.mjs\";\n","import { AbstractListSelector } from \"@app/abstract-list-selector.mjs\";\n\n/**\n * An application that allows the user to configure change flags on an item\n */\nexport class EntrySelector extends AbstractListSelector {\n  static DEFAULT_OPTIONS = {\n    classes: [\"entry-selector\"],\n    position: {\n      width: 300,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/entry-selector.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  constructor(options) {\n    super(options);\n\n    if (options.title) this.subtitle = game.i18n.localize(options.title);\n\n    // Prepare data and convert it into format compatible with the editor\n    this.isFlag = this.options.flag === true;\n    this.isBoolean = this.options.boolean === true;\n    this.isFlat = this.options.flat === true;\n    const data = foundry.utils.deepClone(\n      foundry.utils.getProperty(this.document, this.attribute) ?? (this.isFlag ? {} : [])\n    );\n\n    this.originalEntries = data;\n    this.entries = this.isFlag ? (this.isBoolean ? Object.keys(data).map((d) => [d]) : Object.entries(data)) : data;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Initialize the configuration for this application. Override the default ID to be unique to this\n   * entry selector instance based on document and attribute that is being edited.\n   *\n   * @override\n   * @param {ApplicationConfiguration} options    The provided configuration options for the Application\n   * @returns {ApplicationConfiguration}           The final configuration values for the application\n   */\n  _initializeApplicationOptions(options) {\n    options = super._initializeApplicationOptions(options);\n    options.id = `EntrySelector-${options.name}-${options.document.uuid.replaceAll(\".\", \"-\")}`;\n\n    const isBoolean = options.boolean === true;\n    // Increase width for non-boolean selector\n    // TODO: Needs better solution\n    if (!isBoolean) {\n      options.position ??= {};\n      options.position.width = Math.max(options.position?.width ?? 0, 360);\n    }\n\n    return options;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Configure the title of the dialog window.\n   *\n   * @override\n   * @type {string}\n   */\n  get title() {\n    const item = this.document;\n    const actor = item.actor;\n    const title = this.subtitle ?? game.i18n.localize(\"FFD20.Application.EntrySelector.Title\");\n    if (item) {\n      if (actor) {\n        return game.i18n.format(\"FFD20.Application.EntrySelector.TitleOwned\", {\n          item: item.name,\n          actor: actor.name,\n          title,\n        });\n      } else {\n        return game.i18n.format(\"FFD20.Application.EntrySelector.TitleIsolated\", { item: item.name, title });\n      }\n    } else {\n      return title;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @inheritDoc\n   * @protected\n   */\n  async _preparePartContext(partId, context, options) {\n    let rv = await super._preparePartContext(partId, context, options);\n\n    if (partId === \"form\") {\n      rv ??= {};\n      const entries = this.entries.map((entry) =>\n        this.isFlat ? [entry, this.dtypes[entry]] : entry.map((o2, a) => [o2, this.dtypes[a]])\n      );\n\n      rv.entries = entries;\n      rv.isFlat = this.isFlat;\n      rv.isBoolean = this.isBoolean;\n    }\n\n    return rv;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides default data for a new list entry\n   *\n   * @override\n   * @param event\n   * @protected\n   * @returns {object}\n   */\n  _getNewEntry(event) {\n    const a = event.currentTarget;\n\n    if (this.isFlat) {\n      const dataType = this.dtypes[a];\n      if (dataType === \"Number\") return 0;\n      return \"\";\n    } else {\n      const obj = [];\n      for (let a = 0; a < this.dataCount; a++) {\n        const dataType = this.dtypes[a];\n        if (dataType === \"Number\") obj.push(0);\n        else obj.push(\"\");\n      }\n      return obj;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Update internal data snapshot on form change\n   *\n   * @param formConfig\n   * @param event\n   * @override\n   * @protected\n   * @this {EntrySelector}\n   * @returns {Promise<void>}\n   */\n  async _onChangeForm(formConfig, event) {\n    const a = event.target;\n\n    const tr = a.closest(\"tr.entry\");\n    const index = parseInt(tr.dataset.index);\n    const index2 = parseInt(a.dataset.index);\n    const value = a.value;\n\n    if (a.dataset.dtype === \"Number\") {\n      let v = parseFloat(value);\n      if (isNaN(v)) v = 0;\n      if (this.isFlat) this.entries[index] = Math.floor(v * 100) / 100;\n      else this.entries[index][index2] = Math.floor(v * 100) / 100;\n    } else {\n      if (this.isFlat) this.entries[index] = value;\n      else this.entries[index][index2] = value;\n    }\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Provides update data for saves\n   *\n   * @override\n   * @protected\n   * @returns {object}\n   */\n  _getUpdateData() {\n    const updateData = {};\n\n    if (this.isFlag) {\n      // Convert editor data for flags\n      const newKeys = new Set(); // Needed for deletion detection\n      this.entries.forEach(([key, value]) => {\n        newKeys.add(key);\n        updateData[`${this.attribute}.${key}`] = this.isBoolean ? true : value;\n      });\n\n      // Handle deletions\n      const oldKeys = Object.keys(this.originalEntries);\n      oldKeys.forEach((key) => {\n        if (!newKeys.has(key)) updateData[`${this.attribute}.-=${key}`] = null;\n      });\n    } else {\n      updateData[this.attribute] = this.entries;\n    }\n\n    return updateData;\n  }\n}\n","/**\n * Active Effect extension for system properties.\n */\nexport class ActiveEffectPF extends ActiveEffect {\n  /**\n   * @protected\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Creation context\n   * @param {User} user - Triggering user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Record current initiative\n    // But only if the current actor is in combat\n    const combat = actor.getCombatants()[0]?.combat;\n    if (combat) {\n      // Set flag only if it doesn't exist in the data already\n      const init = this.system.initiative ?? data.system?.initiative;\n      if (init === undefined) {\n        this.updateSource({ \"system.initiative\": combat.initiative });\n      }\n    }\n  }\n\n  /**\n   * Parent actor\n   *\n   * @remarks\n   * - Null if no parent exists.\n   *\n   * @type {Actor|null}\n   */\n  get actor() {\n    const parent = this.parent;\n    if (parent instanceof Actor) return parent;\n    else return parent?.actor || null;\n  }\n\n  /**\n   * @remarks BUG: Foundry v11 and older controls visibility through this.\n   * @override\n   * @type {boolean}\n   */\n  get isTemporary() {\n    // Allow overlays to always show, no matter what else\n    if (this.statuses.size && this.getFlag(\"core\", \"overlay\")) return true;\n\n    // Hide everything told to hide\n    if (this.getFlag(\"ffd20\", \"show\") === false) return false;\n\n    // Hide buffs if buff hiding option is enabled\n    const isTracker = this.isTracker;\n    if (isTracker) {\n      // Hide based on parent item hide toggle\n      if (this.parent?.system?.hideFromToken) return false;\n      // Hide based on global setting\n      if (game.settings.get(\"ffd20\", \"hideTokenConditions\")) return false;\n    }\n\n    return isTracker || super.isTemporary;\n  }\n\n  /**\n   * Temporary solution until Foundry v12 to deal with problems of isTemporary.\n   *\n   * @internal\n   * @returns {boolean} - Has duration\n   */\n  get _hasDuration() {\n    const duration = this.duration.seconds ?? (this.duration.rounds || this.duration.turns);\n    // Allow zero for single-turn duration effects to register correctly.\n    return Number.isFinite(duration) && duration >= 0;\n  }\n\n  /**\n   * Initiative counter\n   *\n   * Present only if the AE was started during combat\n   *\n   * @type {number|undefined}\n   */\n  get initiative() {\n    return this.system.initiative;\n  }\n\n  /**\n   * Tracking a buff\n   *\n   * @remarks\n   * - There should be only one tracker per item.\n   *\n   * @type {boolean}\n   */\n  get isTracker() {\n    return this.system.isTracker ?? false;\n  }\n\n  /** @override */\n  get isSuppressed() {\n    if (this.parent instanceof Item) return !this.parent.isActive;\n    return false;\n  }\n}\n","/**\n * Chat Message document extension\n */\nexport class ChatMessagePF extends ChatMessage {\n  /** @override */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const flags = data.flags?.ffd20;\n    if (!flags) return;\n\n    // Print warnings, leave changes to migration\n    if (flags.metadata) {\n      foundry.utils.logCompatibilityWarning(\n        \"message.flags.ffd20.metadata has been deprecated in favor of message.system\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      // Migration required\n    }\n\n    if (flags.identifiedInfo) {\n      foundry.utils.logCompatibilityWarning(\n        \"message.flags.ffd20.identifiedInfo has been deprecated in favor of message.system\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      // Migration required\n    }\n\n    if (flags.subject) {\n      foundry.utils.logCompatibilityWarning(\n        \"message.flags.ffd20.subject has been deprecated in favor of message.system.subject\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      // Move data to new location\n      this.updateSource({\n        flags: { ffd20: { \"-=subject\": null } },\n        system: { subject: flags.subject },\n      });\n    }\n  }\n\n  /**\n   * Replaces all roll data object in a given object with {@link Roll} instances\n   *\n   * @param {object} maybeRollObject - The object to replace roll data objects with {@link Roll} instances\n   * @returns {object} The object with all roll data objects replaced with {@link Roll} instances\n   * @private\n   */\n  static _initRollObject(maybeRollObject) {\n    // If object is an array, map to roll objects\n    if (Array.isArray(maybeRollObject)) {\n      return maybeRollObject.map((o) => this._initRollObject(o));\n    }\n\n    // If this is a roll object, initialize it\n    if (maybeRollObject != null && typeof maybeRollObject === \"object\" && \"class\" in maybeRollObject) {\n      return Roll.fromData(maybeRollObject);\n    }\n\n    // If object is a regular object, recurse into it to find roll to initialize\n    if (typeof maybeRollObject === \"object\" && maybeRollObject != null) {\n      for (const [k, v] of Object.entries(maybeRollObject)) {\n        maybeRollObject[k] = this._initRollObject(v);\n      }\n    }\n    // Return object in which all roll data has been replaced by Roll instances\n    return maybeRollObject;\n  }\n\n  /**\n   * Linked action.\n   *\n   * @remarks\n   * - Null is returned if no action is linked.\n   * - Undefined is returned if the linked action is not found.\n   *\n   * @type {ItemAction|undefined|null}\n   */\n  get actionSource() {\n    const actionId = this.system.action?.id;\n    return actionId ? this.itemSource?.actions.get(actionId) : null;\n  }\n\n  /**\n   * Linked item.\n   *\n   * @remarks\n   * - Null is returned if no item is linked\n   * - Undefined if item is not found\n   *\n   * @type {ItemPF|undefined|null}\n   */\n  get itemSource() {\n    const itemId = this.system.item?.id;\n    if (itemId) {\n      // fromUuidSync(this.system.actor)\n      const actor = this.constructor.getSpeakerActor(this.speaker);\n      return actor?.items.get(itemId);\n    }\n    return null;\n  }\n\n  /**\n   * Has linked item.\n   *\n   * @deprecated\n   * @type {boolean}\n   */\n  get hasItemSource() {\n    foundry.utils.logCompatibilityWarning(\n      \"ChatMessagePF.hasItemSource has been deprecated in favor of ChatMessagePF.itemSource\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n    return this.system.item !== undefined;\n  }\n\n  /**\n   * Associated measured template\n   *\n   * @type {MeasuredTemplatePF|null}\n   */\n  get measureTemplate() {\n    const templateId = this.system.template;\n    if (!templateId) return null;\n\n    return fromUuidSync(templateId) ?? canvas.templates.get(templateId) ?? null;\n  }\n\n  /**\n   * Targeted tokens.\n   *\n   * @type {Array<TokenPF>}\n   */\n  get targets() {\n    const targetIds = this.system.targets ?? [];\n    if (targetIds.length === 0) return targetIds;\n\n    // Legacy IDs from old messages\n    if (/^\\w{16}$/.test(targetIds[0])) return canvas.tokens.placeables.filter((o) => targetIds.includes(o.id));\n\n    return targetIds.map((uuid) => fromUuidSync(uuid)?.object).filter((t) => !!t);\n  }\n\n  /** @inheritDoc */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    /**\n     * An object containing Pathfinder specific rolls for this chat message,\n     * with a structure grouping them by their purpose.\n     *\n     * @type {object}\n     */\n    this.systemRolls = this.constructor._initRollObject(this.system.rolls ?? {});\n\n    // Compatibility shims\n    this.flags.ffd20 ??= {};\n\n    const msg = this;\n\n    if (!(\"subject\" in this.flags.ffd20)) {\n      Object.defineProperty(this.flags.ffd20, \"subject\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(\n            \"ChatMessagePF.flags.ffd20.subject has been deprecated in favor of ChatMessagePF.system.subject\",\n            {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            }\n          );\n\n          return msg.system?.subject;\n        },\n      });\n    }\n\n    if (!(\"metadata\" in this.flags.ffd20)) {\n      Object.defineProperty(this.flags.ffd20, \"metadata\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(\n            \"ChatMessagePF.flags.ffd20.metadata has been deprecated in favor of ChatMessagePF.system\",\n            {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            }\n          );\n\n          return msg.system;\n        },\n      });\n    }\n\n    if (![\"item\", \"action\"].includes(this.type)) return;\n\n    if (!(\"identifiedInfo\" in this.flags.ffd20)) {\n      Object.defineProperty(this.flags.ffd20, \"identifiedInfo\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(\n            \"ChatMessagePF.flags.ffd20.identifiedInfo has been deprecated in favor of ChatMessagePF.system\",\n            {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            }\n          );\n\n          return {\n            identified: msg.system.item?.identified ?? true,\n            name: msg.system.item?.name,\n            description: msg.system.item?.description,\n            actionName: msg.system.action?.name,\n            actionDescription: msg.system.action?.description,\n          };\n        },\n      });\n    }\n  }\n\n  /**\n   * Chat message frame context data.\n   *\n   * @override\n   * @param {object} context\n   *\n   * Synced with Foundry v12.331\n   */\n  _renderRollContent(context) {\n    switch (this.type) {\n      case \"check\":\n        context.cssClass += \" basic-check ffd20\";\n        break;\n      case \"item\":\n        context.cssClass += \" item-card ffd20\";\n        break;\n      case \"action\":\n        context.cssClass += \" action-card ffd20\";\n        break;\n      default:\n        if (this.isRoll) context.cssClass += \" basic-roll ffd20\";\n        break;\n    }\n    return super._renderRollContent(context);\n  }\n\n  /**\n   * @override\n   * @param {boolean} source - Return source data\n   * @param {boolean} clean - Clean the source data of excess data\n   * @returns {object} - Raw data\n   */\n  toObject(source = true, clean = true) {\n    const data = super.toObject(source);\n\n    if (clean && data.system) this.system.constructor.pruneData?.(data.system);\n\n    return data;\n  }\n\n  /** @override */\n  _onCreate(data, options, userId) {\n    super._onCreate(data, options, userId);\n\n    const user = game.users.get(userId);\n\n    switch (this.type) {\n      case \"check\":\n        this._onCreateCheck(user);\n        break;\n    }\n  }\n\n  /**\n   * On Check Message creation\n   *\n   * @protected\n   * @param {User} user - User who created the message\n   */\n  _onCreateCheck(user) {\n    // Only active GM should proceed due to ownership of reference card\n    if (!game.users.activeGM?.isSelf) return;\n\n    const saveId = this.system.subject?.save;\n    if (!saveId) return;\n\n    const { scene: sceneId, token: tokenId } = this.speaker;\n    const token = game.scenes.get(sceneId)?.tokens.get(tokenId);\n    if (!token) return;\n\n    const refMsg = fromUuidSync(this.system.reference);\n    if (!refMsg) return;\n    if (!refMsg.system.targets?.length) return; // No targets\n\n    const check = this.rolls[0]?.total;\n    if (!Number.isFinite(check)) return;\n\n    // Record the rolled save in the card that prompted it\n    //const defenses = refMsg.getFlag(\"ffd20\", \"targetDefense\") ?? {};\n    //const oldSave = foundry.utils.getProperty(defenses, uuid)?.save?.[saveId];\n    // This overwrites the save regardless who did it and why\n    // Valid rerolls, GM rolling, etc. make it not viable for enforcement\n    refMsg.setFlag(\"ffd20\", \"targetDefense\", { [token.uuid]: { save: { [saveId]: check } } });\n  }\n}\n","import { getSkipActionPrompt } from \"./settings.mjs\";\n\n/* -------------------------------------------- */\n\n/**\n * @internal\n * @param {string} combatantId - Combatant ID\n * @returns {Promise<Combatant>} - Result of {@link CombatantPF.duplicateWithData}\n */\nasync function duplicateCombatantInitiativeDialog(combatantId) {\n  /** @type {CombatantPF} */\n  const combatant = game.combat.combatants.get(combatantId);\n  if (!combatant) return void ui.notifications.warn(game.i18n.localize(\"FFD20.Warning.NoCombatantFound\"));\n\n  const offset = await ffd20.utils.dialog.getNumber({\n    title: `${game.i18n.localize(\"FFD20.DuplicateInitiative\")}: ${combatant.name}`,\n    label: game.i18n.localize(\"FFD20.InitiativeOffset\"),\n    initial: 0,\n    classes: [\"duplicate-initiative\"],\n  });\n\n  if (!Number.isFinite(offset)) return; // Cancelled\n\n  return combatant.duplicateWithData({ initiative: (combatant.initiative ?? 0) + offset });\n}\n\nHooks.on(\"getCombatTrackerEntryContext\", function addCombatTrackerContextOptions(html, menuItems) {\n  menuItems.push({\n    name: \"FFD20.DuplicateInitiative\",\n    icon: '<i class=\"fa-solid fa-dice-d20\"></i>',\n    callback: ([li]) => duplicateCombatantInitiativeDialog(li.dataset.combatantId),\n  });\n});\n\n/**\n * Combat manager extension\n */\nexport class CombatPF extends Combat {\n  /**\n   * @override\n   * @param {string[]} ids Combatant IDs to roll initiative for.\n   * @param {object} [options={}] - Additional options\n   * @param {string} [options.formula] - Formula override. Passed to {@link Combatant.getInitiativeRoll}\n   * @param {string} [options.d20] - d20 override. Passed to {@link Combatant.getInitiativeRoll}\n   * @param {string} [options.bonus=null] - Formula for bonus to initiative\n   * @param {string} [options.rollMode] - Roll mode override.\n   * @param {boolean} [options.updateTurn] - Adjust current turn if the new init would shift it\n   * @param {object} [options.messageOptions={}] - Additional data for created chat message\n   * @param {boolean} [options.skipDialog=null] - Skip roll dialog\n   * Synced with Foundry v12.331\n   */\n  async rollInitiative(\n    ids,\n    { formula = null, d20, bonus = null, rollMode, updateTurn = true, messageOptions = {}, skipDialog = null } = {}\n  ) {\n    skipDialog ??= getSkipActionPrompt();\n    // Structure input data\n    ids = Array.isArray(ids) ? ids : [ids];\n\n    const currentId = this.combatant?.id;\n\n    // Shift rollmode to foundry standard parameter\n    if (rollMode) messageOptions.rollMode = rollMode;\n    rollMode = messageOptions.rollMode || game.settings.get(\"core\", \"rollMode\");\n\n    const roller = ids.length == 1 ? this.combatants.get(ids[0]) : null;\n    const rollerName = roller?.name ?? null;\n\n    // Show initiative dialog\n    if (!skipDialog) {\n      let check = true;\n      if (roller) {\n        const opts = roller.actor?.getInitiativeOptions?.();\n        if (opts.check === false) check = false;\n      }\n\n      const dialogData = await this.constructor.showInitiativeDialog({\n        d20,\n        check,\n        bonus,\n        rollMode,\n        name: rollerName,\n      });\n      if (!dialogData) return this;\n\n      rollMode = dialogData.rollMode;\n      messageOptions.rollMode = rollMode;\n      bonus = dialogData.bonus || \"\";\n      d20 = dialogData.d20;\n    }\n\n    // Iterate over Combatants, performing an initiative roll for each\n    const updates = [];\n    const messages = [];\n\n    for (const [i, id] of ids.entries()) {\n      // Get Combatant data (non-strictly)\n      /** @type {CombatantPF} */\n      const combatant = this.combatants.get(id);\n      if (!combatant?.isOwner) continue;\n\n      // Produce an initiative roll for the Combatant\n      const roll = combatant.getInitiativeRoll(formula, d20, bonus);\n      roll.options.flavor = game.i18n.format(\"FFD20.Check\", { type: game.i18n.localize(\"FFD20.Initiative\") });\n\n      // Produce an initiative roll for the Combatant\n      await roll.evaluate();\n      if (roll.err) ui.notifications.warn(roll.err.message);\n\n      updates.push({ _id: id, initiative: roll.total });\n\n      // Per-combatant roll mode\n      let cRollMode = rollMode;\n\n      // Hide initiative rolls for hidden combatants, unless explicit roll mode was requested\n      const isHidden = combatant.token?.hidden || combatant.hidden;\n      if (isHidden && !messageOptions.rollMode && [\"roll\", CONST.DICE_ROLL_MODES.PUBLIC].includes(cRollMode)) {\n        cRollMode = messageOptions.rollMode || CONST.DICE_ROLL_MODES.PRIVATE;\n      }\n\n      const properties = [];\n      const notes = (await combatant.actor?.getContextNotesParsed?.(\"init\")) ?? [];\n      if (notes.length) {\n        properties.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n      }\n\n      // Create card template data\n      const templateData = {\n        formula: roll.formula,\n        tooltip: await roll.getTooltip(),\n        total: roll.total,\n        properties,\n      };\n\n      // Create base chat card data\n      let chatData = {\n        speaker: ChatMessage.implementation.getSpeakerActor({\n          actor: combatant.actor,\n          token: combatant.token,\n          alias: combatant.name, // Combatant name can differ from token name, so alias is needed here\n        }),\n        ...messageOptions,\n      };\n\n      chatData.rollMode ||= cRollMode;\n\n      // Mimic core Foundry data\n      foundry.utils.setProperty(chatData, \"flags.core.initiativeRoll\", true);\n\n      // Generate message proper via D20RollPF\n      chatData = await roll.toMessage(chatData, {\n        create: false,\n        rollMode: cRollMode,\n        subject: { core: \"init\" },\n        chatTemplateData: templateData,\n      });\n\n      if (i > 0) chatData.sound = null; // Only play 1 sound for the whole set\n      messages.push(chatData);\n    }\n\n    if (!updates.length) return this;\n\n    // Update multiple combatants\n    await this.updateEmbeddedDocuments(\"Combatant\", updates);\n\n    // Ensure the turn order remains with the same combatant\n    if (updateTurn && currentId) {\n      await this.update({ turn: this.turns.findIndex((t) => t.id === currentId) });\n    }\n\n    // Create multiple chat messages\n    await ChatMessage.implementation.create(messages);\n\n    return this;\n  }\n\n  /**\n   * @param {object} [options] - Additional options\n   * @param {string} [options.d20] Formula override\n   * @param {boolean} [options.check=true] - If false, no base d20 check is provided\n   * @param {string} [options.bonus] Bonus formula override\n   * @param {string} options.name Name of the roller\n   * @returns {Promise<object>} - Result\n   */\n  static async showInitiativeDialog({ d20 = null, check = true, bonus = null, name } = {}) {\n    const rollMode = game.settings.get(\"core\", \"rollMode\");\n\n    const template = \"systems/ffd20/templates/chat/roll-dialog.hbs\";\n    const dialogData = { d20, check, bonus, rollMode, rollModes: CONFIG.Dice.rollModes };\n\n    // Show dialog\n    // TODO: Use D20RollPF's prompt instead\n    return foundry.applications.api.DialogV2.wait({\n      window: {\n        title:\n          (name ? name + \" â \" : \"\") + game.i18n.format(\"FFD20.Check\", { type: game.i18n.localize(\"FFD20.Initiative\") }),\n      },\n      position: { width: 420 },\n      content: await renderTemplate(template, dialogData),\n      buttons: [\n        {\n          action: \"roll\",\n          default: true,\n          icon: \"fa-solid fa-dice-d20\",\n          label: game.i18n.localize(\"FFD20.Roll\"),\n          callback: (event, button, html) => new FormDataExtended(html.querySelector(\"form\")).object,\n        },\n      ],\n      close: () => null,\n      classes: [\"pf1-v2\", \"roll-prompt\", \"roll-initiative\"],\n      subject: { core: \"init\" },\n      rejectClose: false,\n    });\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Update data\n   * @param {options} context - Context options\n   * @param {string} userId - Triggering user ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    if (changed.turn !== undefined || changed.round !== undefined) {\n      // Cache current world time here since actual time update can happen at random time in the future due to async code.\n      context.ffd20 ??= {};\n      context.ffd20.worldTime = game.time.worldTime;\n      this._onNewTurn(changed, context, userId);\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    if (\"turn\" in changed || \"round\" in changed) {\n      // Record origin turn and round\n      context.ffd20 ??= {};\n      context.ffd20.from = { turn: this.turn, round: this.round };\n    }\n  }\n\n  /**\n   * New turn handling.\n   *\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   * @private\n   */\n  async _onNewTurn(changed, context, userId) {\n    if (!this._isForwardTime(changed, context)) return;\n\n    if (context.ffd20?.from) {\n      const skipped = this._detectSkippedTurns(context.ffd20.from, context);\n\n      if (game.users.activeGM?.isSelf) {\n        this._handleSkippedTurns(skipped, context);\n      }\n\n      const previous = this.turns.at(this.turn - 1);\n      if (!skipped.has(previous)) this._processEndTurn(context.ffd20?.from, context);\n    }\n\n    this._processTurnStart(changed, context, userId);\n\n    this._processInitiative(context);\n  }\n\n  _isForwardTime(changed, context) {\n    // Non-UI turn progression does not have context.direction present to detect this otherwise\n    const t0 = context.ffd20.from.turn,\n      r0 = context.ffd20.from.round,\n      t1 = changed.turn ?? t0,\n      r1 = changed.round ?? r0,\n      rd = r1 - r0, // round delta\n      td = t1 - t0; // turn delta\n\n    if (rd < 0) return false;\n    else if (rd == 0 && td <= 0) return false;\n    return true;\n  }\n\n  /**\n   * Determine skipped turns\n   *\n   * @internal\n   * @param {object} from - Origin combat time frame\n   * @param {number} from.turn - From turn\n   * @param {number} from.round - From round\n   * @param {object} context - Update context\n   * @returns {Set<Combatant>} - Set of combatant IDs whose turn was skipped\n   */\n  _detectSkippedTurns({ turn, round } = {}, context) {\n    const roundChange = this.round !== round;\n\n    const skipped = new Set();\n\n    // No combatants skipped\n    if (!roundChange && turn + 1 === this.turn) return skipped;\n\n    // Determine skipped combatants\n    for (const [index, combatant] of this.turns.entries()) {\n      // Seeking first, not actually skipped\n      if (!roundChange && index <= turn) continue;\n      // Skipped\n      else if (index < this.turn) skipped.add(combatant);\n      // Skipped (usually via nextRound)\n      else if (roundChange && index > turn) skipped.add(combatant);\n    }\n\n    Hooks.callAll(\"pf1CombatTurnSkip\", this, skipped, context);\n\n    return skipped;\n  }\n\n  /**\n   * Handle effects of skipped turns.\n   *\n   * @internal\n   * @param {Set<Combatant>} skipped - Combatant IDs of those whose turn was skipped.\n   * @param {object} context - Combat update context\n   */\n  _handleSkippedTurns(skipped, context) {\n    const currentTurn = this.turn;\n    const event = \"turnEnd\";\n\n    const timeOffset = context.advanceTime ?? 0;\n    const worldTime = context.ffd20?.worldTime ?? game.time.worldTime;\n\n    // Expire effects for skipped combatants\n    for (const combatant of skipped) {\n      const actor = combatant.actor;\n      if (!actor) continue;\n\n      // Adjust expiration time for those who come after in initiative (their expiration was for previous round)\n      const turn = this.turns.findIndex((c) => c === combatant);\n      const turnTimeOffset = timeOffset + (turn > currentTurn) ? -CONFIG.time.roundTime : 0;\n\n      actor.expireActiveEffects?.({ timeOffset: timeOffset + turnTimeOffset, worldTime, combat: this, event });\n    }\n  }\n\n  /**\n   * Handle end of turn\n   *\n   * @internal\n   * @param {object} originTime - Origin time frame\n   * @param {number} originTime.turn - Turn that ended\n   * @param {number} originTime.round - Round on which the turn ended\n   * @param {object} context - Context\n   */\n  async _processEndTurn({ turn, round } = {}, context = {}) {\n    const previous = this.turns.at(turn);\n    const actor = previous.actor;\n    if (!actor) return;\n\n    const owner = actor.activeOwner;\n    if (!owner?.isSelf) return;\n\n    const timeOffset = context.advanceTime ?? 0;\n    const worldTime = context.ffd20?.worldTime ?? game.time.worldTime;\n\n    try {\n      await actor.expireActiveEffects?.({\n        combat: this,\n        worldTime,\n        timeOffset,\n        event: \"turnEnd\",\n      });\n    } catch (error) {\n      console.error(error, actor);\n    }\n  }\n\n  /**\n   * Process current combatant: expire active effects & buffs.\n   *\n   * @param {object} changed Update data\n   * @param {options} context Context options\n   */\n  async _processTurnStart(changed, context) {\n    const actor = this.combatant?.actor;\n    if (!actor) return;\n\n    // Attempt to perform expiration on owning active user\n    const owner = actor.activeOwner;\n    if (!owner?.isSelf) return;\n\n    const timeOffset = context.advanceTime ?? 0;\n    const worldTime = context.ffd20?.worldTime ?? game.time.worldTime;\n\n    try {\n      await actor.expireActiveEffects?.({\n        combat: this,\n        worldTime,\n        timeOffset,\n        event: \"turnStart\",\n      });\n    } catch (error) {\n      console.error(error, actor);\n    }\n\n    try {\n      await actor.rechargeItems?.({ period: \"round\", exact: true });\n    } catch (error) {\n      console.error(error, actor);\n    }\n  }\n\n  /**\n   * Process end of durations based on initiative.\n   *\n   * Only active GM processes these to avoid conflicts and logic bloat.\n   *\n   * @internal\n   * @param {object} [context] - Update context\n   */\n  _processInitiative(context = {}) {\n    if (!game.users.activeGM?.isSelf) return;\n\n    const worldTime = context.ffd20?.worldTime ?? game.time.worldTime;\n    const timeOffset = context.advanceTime ?? 0;\n\n    const initiative = this.initiative;\n    for (const combatant of this.combatants) {\n      if (combatant.isDefeated) continue;\n      const actor = combatant.actor;\n      if (!actor) continue;\n\n      actor.expireActiveEffects?.({ combat: this, initiative, timeOffset, worldTime });\n    }\n  }\n\n  _onDelete(options, userId) {\n    super._onDelete(options, userId);\n\n    if (game.user.id !== userId) return;\n\n    // Show experience distributor after combat\n    if (!this.started) return;\n    const xpCfg = game.settings.get(\"ffd20\", \"experienceConfig\");\n    if (xpCfg.disable) return;\n\n    const openUI = xpCfg.openDistributor;\n    const skipPrompt = ffd20.documents.settings.getSkipActionPrompt();\n    if (openUI ^ skipPrompt) {\n      ffd20.applications.ExperienceDistributor.fromCombat(this);\n    }\n  }\n\n  /**\n   * Get current initiative.\n   *\n   * @type {number|undefined}\n   */\n  get initiative() {\n    return this.combatant?.initiative;\n  }\n}\n","/**\n * Combatant extension.\n */\nexport class CombatantPF extends Combatant {\n  /**\n   * Combat tracker resource update.\n   *\n   * Required to deal with 0 values disappearing with core implementation\n   *\n   * @override\n   * @returns {*} Resource value.\n   *\n   * Synchronized with Foundry 12.331\n   */\n  updateResource() {\n    if (!this.actor || !this.combat) return (this.resource = null);\n    return (this.resource = foundry.utils.getProperty(this.actor.system, this.parent.settings.resource) ?? null);\n  }\n\n  /**\n   * Duplicate combatant with added data.\n   *\n   * @param {object} data - Override data\n   * @param {object} context - Creation context\n   * @returns {Promise<Combatant>} - Created combatant\n   */\n  duplicateWithData(data = {}, context = {}) {\n    console.debug(\"Duplicating combatant:\", this);\n    context.parent ??= this.combat;\n    return this.constructor.create(foundry.utils.mergeObject(this.toObject(), data), context);\n  }\n\n  /**\n   * Get unevaluated initiative roll instance.\n   *\n   * @override\n   * @param {string} [formula] Initiative formula override\n   * @param {string} [d20=null] D20 override. Non-standard option.\n   * @param {number} [bonus=null] Bonus to initiative. Non-standard option.\n   * @returns {ffd20.dice.D20RollPF} Initiative roll instance\n   *\n   * Synchronized with Foundry VTT 12.331\n   */\n  getInitiativeRoll(formula, d20 = null, bonus = null) {\n    const options = this.actor?.getInitiativeOptions?.() ?? {};\n\n    formula ||= this._getInitiativeFormula(d20);\n    const rollData = this.actor?.getRollData() || {};\n    if (bonus) {\n      rollData.bonus = bonus;\n      formula += \" + @bonus\";\n    }\n\n    return new ffd20.dice.D20RollPF(formula, rollData, options);\n  }\n\n  /**\n   * Override the default Initiative formula to customize special behaviors of the game system.\n   *\n   * Apply tiebreaker if desired\n   *\n   * See Combat._getInitiativeFormula for more detail.\n   *\n   * @override\n   * @todo Build proper formula\n   * @param {string} [d20=ffd20.dice.D20RollPF.standardRoll] Default check roll\n   * @returns {string} Initiative formula\n   *\n   * Synchronized with Foundry 12.331\n   */\n  _getInitiativeFormula(d20) {\n    const defaultParts = [];\n\n    const options = this.actor?.getInitiativeOptions?.() ?? {};\n    if (options.check !== false) {\n      defaultParts.push(d20 || ffd20.dice.D20RollPF.standardRoll);\n    }\n    defaultParts.push(`@attributes.init.total[${game.i18n.localize(\"FFD20.Initiative\")}]`);\n\n    const actor = this.actor;\n    if (actor && game.settings.get(\"ffd20\", \"initiativeTiebreaker\"))\n      defaultParts.push(`(@attributes.init.total / 100)[${game.i18n.localize(\"FFD20.Tiebreaker\")}]`);\n    const parts = CONFIG.Combat.initiative.formula ? CONFIG.Combat.initiative.formula.split(/\\s*\\+\\s*/) : defaultParts;\n    if (!actor) return parts[0] || \"0\";\n    return parts.filter((p) => !!p).join(\" + \");\n  }\n}\n","/**\n * Transforms a key input into an array of objects for the keybinding API\n *\n * @param {string} key - A key string\n * @returns {{\"key\": string}[]} Keybinding objects\n */\nconst getLeftRight = (key) => [`${key}Left`, `${key}Right`].map((k) => ({ key: k }));\n\nconst SHIFT_KEYS = getLeftRight(\"Shift\");\nconst CTRL_KEYS = getLeftRight(\"Control\");\n\n/**\n * Registers the system's keybindings\n *\n * @internal\n */\nexport const registerSystemControls = () => {\n  game.keybindings.register(\"ffd20\", \"skipConfirmPrompt\", {\n    name: \"FFD20.KEYBINDINGS.SkipConfirmPrompt.Name\",\n    uneditable: SHIFT_KEYS,\n    onDown: () => {\n      ffd20.skipConfirmPrompt = true;\n    },\n    onUp: () => {\n      ffd20.skipConfirmPrompt = false;\n    },\n  });\n};\n","/**\n * Token Document extension\n */\nexport class TokenDocumentPF extends TokenDocument {\n  /**\n   * @internal\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    this._preCreateSetSize();\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    if (context.recursive === false) return;\n\n    const flags = changed.flags?.ffd20;\n    if (flags) {\n      // Delete flags instead of turning them false\n      const deleteFlags = [\"staticSize\", \"disableLowLight\", \"customVisionRules\"];\n      for (const flag of deleteFlags) {\n        if (flags[flag] === false) {\n          flags[`-=${flag}`] = null;\n          delete flags[flag];\n        }\n      }\n    }\n  }\n\n  /**\n   * Handle actor size during token creation.\n   */\n  _preCreateSetSize() {\n    if (!this.actor) return;\n\n    // Apply token size\n    if (this.getFlag(\"ffd20\", \"staticSize\")) return;\n    const sizeConf = ffd20.config.tokenSizes[this.actor.system.traits?.size];\n    if (!sizeConf) return;\n\n    this.updateSource({\n      width: sizeConf.w,\n      height: sizeConf.h,\n      texture: {\n        scaleX: sizeConf.scale * this.actor.prototypeToken.texture.scaleX,\n        scaleY: sizeConf.scale * this.actor.prototypeToken.texture.scaleY,\n      },\n    });\n  }\n\n  /**\n   * Called by getTrackedAttributes() when not dealing with data models.\n   *\n   * @override\n   */\n  static _getTrackedAttributesFromObject(data, path = []) {\n    if (path[0] === \"conditions\") return { bar: [], value: [] };\n\n    const attr = super._getTrackedAttributesFromObject(data, path);\n\n    if (path[0] === \"attributes\") {\n      if (path.length === 1) {\n        // These are necessary for token config inclusion which does not delve into hp, vigor or wounds for some reason\n        // This has no effect on combat tracker resources for some reason\n        attr.value.push(\n          [\"attributes\", \"hp\", \"value\"],\n          [\"attributes\", \"hp\", \"offset\"],\n          [\"attributes\", \"hp\", \"max\"],\n          [\"attributes\", \"hp\", \"temp\"],\n          [\"attributes\", \"hp\", \"nonlethal\"],\n          [\"attributes\", \"vigor\", \"value\"],\n          [\"attributes\", \"vigor\", \"offset\"],\n          [\"attributes\", \"vigor\", \"max\"],\n          [\"attributes\", \"vigor\", \"temp\"],\n          [\"attributes\", \"wounds\", \"value\"],\n          [\"attributes\", \"wounds\", \"offset\"],\n          [\"attributes\", \"wounds\", \"max\"]\n        );\n      }\n\n      const hpPart = path[1];\n      // Needed by combat tracker and token resources for consistent availability of bars\n      if (path.length === 2 && [\"hp\", \"wounds\", \"vigor\"].includes(hpPart)) {\n        attr.value.push(\n          [\"attributes\", hpPart, \"value\"],\n          [\"attributes\", hpPart, \"max\"],\n          [\"attributes\", hpPart, \"offset\"]\n        );\n        attr.bar.push([\"attributes\", hpPart]);\n      }\n    }\n\n    // If data is missing entirely, AC will not be listed but the others will\n    if (!data) {\n      attr.value.push([\"attributes\", \"ac\", \"normal\", \"total\"]);\n    }\n\n    return attr;\n  }\n\n  /**\n   * Hijack Token health bar rendering to include temporary and temp-max health in the bar display\n   *\n   * @override\n   * @param {string} barName - Bar name\n   * @param {object} [options] - Additional options\n   * @param {string} [options.alternative] - Alt bar path to use\n   * @returns {object|null} - Attribute to be displayed if any\n   * Synced with Foundry v12.331\n   */\n  getBarAttribute(barName, { alternative = null } = {}) {\n    let data;\n    try {\n      data = super.getBarAttribute(barName, { alternative });\n    } catch {\n      data = null;\n    }\n\n    // Make resources editable\n    if (data?.attribute.startsWith(\"resources.\")) data.editable = true;\n\n    const offsetAttributes = [\"attributes.hp\", \"attributes.wounds\", \"attributes.vigor\"];\n    if (offsetAttributes.includes(data?.attribute)) {\n      // Add temp HP on top\n      const temp = foundry.utils.getProperty(this.actor?.system, data.attribute + \".temp\") || 0;\n      data.value += temp;\n      // Allow editing\n      data.editable = true;\n    }\n\n    return data;\n  }\n\n  prepareBaseData() {\n    this._syncSenses();\n\n    super.prepareBaseData();\n  }\n\n  /**\n   * Synchronize senses from actor.\n   */\n  _syncSenses() {\n    if (!this.actorId || !this.actor) return;\n    if (!game.settings.get(\"ffd20\", \"systemVision\")) return;\n    if (this.getFlag(\"ffd20\", \"customVisionRules\")) return;\n\n    this.detectionModes = [];\n\n    // Get base range from source data\n    const baseRange = this._source.sight.range;\n\n    this.sight.visionMode = \"basic\";\n\n    // Basic detection\n    const basicMode = { id: DetectionMode.BASIC_MODE_ID, enabled: true, range: baseRange };\n    this.detectionModes.push(basicMode);\n\n    const senses = this.actor?.system?.traits?.senses ?? {};\n\n    const convertDistance = (d) => ffd20.utils.convertDistance(d)[0];\n\n    // Darkvision, also includes blindsight until we have a better representation\n    const darkvision = senses.dv?.total ?? 0;\n    const blindsight = senses.bs?.total ?? 0;\n    const blackAndWhite = Math.max(darkvision, blindsight);\n\n    if (blackAndWhite > 0) {\n      this.sight.visionMode = \"darkvision\";\n      // Upgrade basic mode range if greater\n      basicMode.range = Math.max(baseRange, convertDistance(blackAndWhite));\n    }\n\n    // -----------------------\n\n    // See invisibility\n    if (senses.si) {\n      this.detectionModes.push({ id: \"seeInvisibility\", enabled: true, range: basicMode.range });\n    }\n\n    // True seeing\n    const trueseeing = senses.tr?.total ?? 0;\n    if (trueseeing > 0) {\n      // Add normal vision within range of true seeing\n      const trr = convertDistance(trueseeing);\n      basicMode.range = Math.max(trr, basicMode.range);\n      if (trueseeing > blackAndWhite) this.sight.visionMode = \"basic\";\n\n      this.detectionModes.push({ id: \"seeInvisibility\", enabled: true, range: trr, limited: true });\n    }\n\n    this.sight.range = Math.max(baseRange, basicMode.range);\n\n    // Tremor sense\n    if (senses.ts?.total) {\n      this.detectionModes.push({ id: \"feelTremor\", enabled: true, range: convertDistance(senses.ts?.total) });\n    }\n\n    // Lifesense\n    if (senses.ls?.total) {\n      this.detectionModes.push({ id: \"lifesense\", enabled: true, range: convertDistance(senses.ls?.total) });\n    }\n\n    // Blind sense\n    if (senses.bse?.total) {\n      this.detectionModes.push({ id: \"blindSense\", enabled: true, range: convertDistance(senses.bse?.total) });\n    }\n\n    // Blind sight\n    if (senses.bs?.total) {\n      this.detectionModes.push({ id: \"blindSight\", enabled: true, range: convertDistance(senses.bs?.total) });\n    }\n\n    // Sort detection modes\n    this.detectionModes.sort(this.constructor._sortDetectionModes);\n\n    // Update vision advanced fields with current mode's defaults\n    const visionDefaults = CONFIG.Canvas.visionModes[this.sight.visionMode]?.vision?.defaults || {};\n    for (const fieldName of [\"attenuation\", \"brightness\", \"saturation\", \"contrast\"]) {\n      if (fieldName in visionDefaults) {\n        this.sight[fieldName] = visionDefaults[fieldName];\n      }\n    }\n  }\n\n  static _sortDetectionModes(a, b) {\n    if (a.id === DetectionMode.BASIC_MODE_ID) return -1;\n    if (b.id === DetectionMode.BASIC_MODE_ID) return 1;\n\n    const src = { a: CONFIG.Canvas.detectionModes[a.id], b: CONFIG.Canvas.detectionModes[b.id] };\n    return (src.a?.constructor.PRIORITY ?? 0) - (src.b?.constructor.PRIORITY ?? 0);\n  }\n}\n","import { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * @param {ffd20.documents.actor.ActorPF} actor - Actor to apply changes to\n * @param {object} [options] - Additional options\n * @param {boolean} [options.simple] - Process only simple changes\n */\nexport const applyChanges = (actor, { simple = false } = {}) => {\n  actor.changeOverrides = {};\n  /** @type {ItemChange[]} */\n  const changes = Array.from(actor.changes).filter((change) => {\n    const changeTargetData = ffd20.config.buffTargets[change.target];\n    return !!changeTargetData?.simple === simple;\n  });\n\n  const { targets, types } = getSortChangePriority(actor);\n  const _sortChanges = (a, b) => {\n    const targetA = targets.indexOf(a.target);\n    const targetB = targets.indexOf(b.target);\n    const typeA = types.indexOf(a.type);\n    const typeB = types.indexOf(b.type);\n    const prioA = a.priority ?? 0;\n    const prioB = b.priority ?? 0;\n\n    // TODO: Improve ordering logic\n    // Currently priority overrides all other considerations, making priority become its own separate processing queue\n    // Any alteration of this can however completely break how users use changes.\n    return prioB - prioA || targetA - targetB || typeA - typeB;\n  };\n\n  // Organize changes by priority\n  changes.sort((a, b) => _sortChanges(a, b));\n\n  actor.changeFlags.immuneToMorale = actor.system.traits?.ci?.total?.has(\"moraleEffects\") || false;\n\n  // Get items with change flags\n  const chflagItems = actor.items.filter((i) => i.isActive && i.hasChanges && i.system.changeFlags);\n\n  // Parse change flags\n  for (const i of chflagItems) {\n    if (!i.system.changeFlags) continue;\n    for (const [k, v] of Object.entries(i.system.changeFlags)) {\n      if (v !== true) continue;\n      actor.changeFlags[k] = true;\n      if (k !== \"loseDexToAC\") continue;\n\n      for (const k2 of [\"normal\", \"touch\"]) {\n        getSourceInfo(actor.sourceInfo, `system.attributes.ac.${k2}.total`).negative.push({\n          value: game.i18n.localize(\"FFD20.ChangeFlags.LoseDexToAC\"),\n          name: i.name,\n          type: i.type,\n        });\n      }\n      getSourceInfo(actor.sourceInfo, \"system.attributes.cmd.total\").negative.push({\n        value: game.i18n.localize(\"FFD20.ChangeFlags.LoseDexToAC\"),\n        name: i.name,\n        type: i.type,\n      });\n    }\n  }\n  if (!simple) actor.refreshDerivedData();\n\n  // Determine continuous changes\n  const continuousChanges = changes.filter((o) => o.continuous === true);\n\n  // Apply all changes\n  for (const change of changes) {\n    if (actor.changeFlags.immuneToMorale && change.type === \"morale\") continue;\n\n    const flats = change.getTargets(actor);\n    for (const f of flats) {\n      actor.changeOverrides[f] ??= createOverride();\n    }\n\n    change._safeApplyChange(actor, flats, { applySourceInfo: false });\n\n    // Apply continuous changes\n    for (const cc of continuousChanges) {\n      if (cc === change) continue;\n      const flats = cc.getTargets(actor);\n      for (const f of flats) {\n        if (!actor.changeOverrides[f]) actor.changeOverrides[f] = createOverride();\n      }\n\n      cc._safeApplyChange(actor, flats, { applySourceInfo: false });\n    }\n\n    if (!simple) actor.refreshDerivedData();\n  }\n\n  // Apply source info for changes\n  for (const change of changes) {\n    change.applySourceInfo(actor);\n  }\n};\n\n/**\n * Create override structure\n *\n * @returns {object} - Override base structure\n */\nfunction createOverride() {\n  const result = {\n    add: {},\n    set: {},\n  };\n\n  for (const k of Object.keys(ffd20.config.bonusTypes)) {\n    result.add[k] = null;\n    result.set[k] = null;\n  }\n\n  return result;\n}\n\nconst getSortChangePriority = (actor) => {\n  const skillBasePrio = ffd20.config.buffTargets.skills.sort + 100;\n  /** @type {[string, {sort: number}][]} */\n  const skillTargets = actor._skillTargets.map((target, index) => [target, { sort: skillBasePrio + index * 10 }]);\n  const buffTargets = Object.entries(ffd20.config.buffTargets);\n  const targets = [...skillTargets, ...buffTargets]\n    .sort(([, { sort: aSort }], [, { sort: bSort }]) => aSort - bSort)\n    .map(([target]) => target);\n\n  return {\n    targets,\n    types: Object.keys(ffd20.config.bonusTypes),\n  };\n};\n\n/**\n * @param {Actor} actor - Actor to get data from\n * @param {BuffTarget} target Target (e.g. \"ac\" or \"skills\")\n * @param {ModifierType} modifierType Type (e.g. \"profane\", \"untyped\", or \"dodge\"). If undefined, all valid targets will be returned.\n * @param {number} [value]  Value, if known\n * @returns {Array<string>} Array of target paths to modify\n */\nexport function getChangeFlat(actor, target, modifierType, value) {\n  if (target == null) return [];\n\n  const system = actor.system;\n  /** @type {string[]} */\n  const result = [];\n\n  switch (target) {\n    case \"mhp\":\n      result.push(\"system.attributes.hp.max\");\n      break;\n    case \"wounds\":\n      result.push(\"system.attributes.wounds.max\");\n      break;\n    case \"woundThreshold\":\n      result.push(\"system.attributes.wounds.threshold\");\n      break;\n    case \"vigor\":\n      result.push(\"system.attributes.vigor.max\");\n      break;\n    case \"mmp\":\n      result.push(\"system.attributes.mp.max\");\n      break;\n    case \"mprec\":\n      result.push(\"system.attributes.mp.recover\");\n      break;\n    case \"str\":\n    case \"dex\":\n    case \"con\":\n    case \"int\":\n    case \"wis\":\n    case \"cha\":\n      if ([\"base\", \"untypedPerm\"].includes(modifierType)) {\n        result.push(`system.abilities.${target}.base`);\n      }\n      result.push(`system.abilities.${target}.total`, `system.abilities.${target}.undrained`);\n      break;\n    case \"strPen\":\n    case \"dexPen\":\n    case \"conPen\":\n    case \"intPen\":\n    case \"wisPen\":\n    case \"chaPen\": {\n      const ablKey = target.slice(0, -3);\n      result.push(`system.abilities.${ablKey}.penalty`);\n      break;\n    }\n    case \"strMod\":\n    case \"dexMod\":\n    case \"conMod\":\n    case \"intMod\":\n    case \"wisMod\":\n    case \"chaMod\":\n      result.push(`system.abilities.${target.slice(0, 3)}.mod`);\n      break;\n    case \"carryStr\":\n      result.push(\"system.details.carryCapacity.bonus.total\");\n      break;\n    case \"carryMult\":\n      result.push(\"system.details.carryCapacity.multiplier.total\");\n      break;\n    case \"size\":\n      result.push(\"system.traits.size.value\");\n      break;\n    case \"ageCategory\":\n      result.push(\"system.traits.ageCategory.value\");\n      result.push(\"system.traits.ageCategory.mental\");\n      result.push(\"system.traits.ageCategory.physical\");\n      break;\n    case \"ageCategoryMental\":\n      result.push(\"system.traits.ageCategory.mental\");\n      break;\n    case \"ageCategoryPhysical\":\n      result.push(\"system.traits.ageCategory.physical\");\n      break;\n    case \"ac\":\n      result.push(\"system.attributes.ac.normal.total\", \"system.attributes.ac.touch.total\");\n\n      switch (modifierType) {\n        case \"dodge\":\n        case \"haste\":\n          result.push(\"system.attributes.cmd.total\");\n          break;\n        case \"deflection\":\n        case \"circumstance\":\n        case \"insight\":\n        case \"luck\":\n        case \"morale\":\n        case \"profane\":\n        case \"sacred\":\n          result.push(\n            \"system.attributes.ac.flatFooted.total\",\n            \"system.attributes.cmd.total\",\n            \"system.attributes.cmd.flatFootedTotal\"\n          );\n          break;\n        default:\n          result.push(\"system.attributes.ac.flatFooted.total\");\n          // Other penalties also apply to CMD, but not bonuses\n          if (value < 0) {\n            result.push(\"system.attributes.cmd.total\", \"system.attributes.cmd.flatFootedTotal\");\n          }\n          break;\n      }\n      break;\n    case \"aac\": {\n      const targets = [\"system.ac.normal.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.normal.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.normal.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.normal.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"sac\": {\n      const targets = [\"system.ac.shield.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.shield.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.shield.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.shield.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"nac\": {\n      const targets = [\"system.ac.natural.total\"];\n      switch (modifierType) {\n        case \"base\":\n          targets.push(\"system.ac.natural.base\");\n          break;\n        case \"enh\":\n          targets.push(\"system.ac.natural.enh\");\n          break;\n        default:\n          targets.push(\"system.ac.natural.misc\");\n          break;\n      }\n      result.push(...targets);\n      break;\n    }\n    case \"tac\":\n      result.push(\"system.attributes.ac.touch.total\");\n      break;\n    case \"ffac\":\n      result.push(\"system.attributes.ac.flatFooted.total\");\n      break;\n    case \"ffcmd\":\n      result.push(\"system.attributes.cmd.flatFootedTotal\");\n      break;\n    case \"bab\":\n      result.push(\"system.attributes.bab.total\");\n      break;\n    case \"~attackCore\":\n      result.push(\"system.attributes.attack.shared\");\n      break;\n    case \"attack\":\n      result.push(\"system.attributes.attack.general\");\n      break;\n    case \"wattack\":\n      result.push(\"system.attributes.attack.weapon\");\n      break;\n    case \"sattack\":\n      result.push(\"system.attributes.attack.spell\");\n      break;\n    case \"mattack\":\n      result.push(\"system.attributes.attack.melee\");\n      break;\n    case \"nattack\":\n      result.push(\"system.attributes.attack.natural\");\n      break;\n    case \"rattack\":\n      result.push(\"system.attributes.attack.ranged\");\n      break;\n    case \"critConfirm\":\n      result.push(\"system.attributes.attack.critConfirm\");\n      break;\n    case \"allSavingThrows\":\n      result.push(\n        \"system.attributes.savingThrows.fort.total\",\n        \"system.attributes.savingThrows.ref.total\",\n        \"system.attributes.savingThrows.will.total\"\n      );\n      break;\n    case \"fort\":\n      result.push(\"system.attributes.savingThrows.fort.total\");\n      break;\n    case \"ref\":\n      result.push(\"system.attributes.savingThrows.ref.total\");\n      break;\n    case \"will\":\n      result.push(\"system.attributes.savingThrows.will.total\");\n      break;\n    case \"vehicleSave\":\n      result.push(\"system.attributes.savingThrows.save.total\");\n      break;\n    case \"skills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const b of Object.keys(skl.subSkills)) {\n            result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"unskills\":\n      // Untrained skills\n      for (const [skillId, skill] of Object.entries(system.skills)) {\n        if (skill == null) continue;\n        for (const [subSkillId, subskill] of Object.entries(skill.subSkills ?? {})) {\n          if (subskill.rank > 0) continue;\n          result.push(`system.skills.${skillId}.subSkills.${subSkillId}.mod`);\n        }\n        if (skill.rank > 0) continue;\n        result.push(`system.skills.${skillId}.mod`);\n      }\n      break;\n    case \"reach\":\n      // Natural reach\n      result.push(\"system.traits.reach.total.melee\");\n      result.push(\"system.traits.reach.total.reach\");\n      break;\n    case \"strSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"str\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"str\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"dexSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"dex\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"dex\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"conSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"con\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"con\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"intSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"int\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"int\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"wisSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"wis\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"wis\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"chaSkills\":\n      for (const [a, skl] of Object.entries(system.skills)) {\n        if (skl == null) continue;\n        if (skl.ability === \"cha\") result.push(`system.skills.${a}.mod`);\n\n        if (skl.subSkills != null) {\n          for (const [b, subSkl] of Object.entries(skl.subSkills)) {\n            if (subSkl != null && subSkl.ability === \"cha\") result.push(`system.skills.${a}.subSkills.${b}.mod`);\n          }\n        }\n      }\n      break;\n    case \"allChecks\":\n      result.push(\n        \"system.abilities.str.checkMod\",\n        \"system.abilities.dex.checkMod\",\n        \"system.abilities.con.checkMod\",\n        \"system.abilities.int.checkMod\",\n        \"system.abilities.wis.checkMod\",\n        \"system.abilities.cha.checkMod\",\n        ...(system.attributes.init.ability ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"strChecks\":\n      result.push(\n        \"system.abilities.str.checkMod\",\n        ...(system.attributes.init.ability === \"str\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"dexChecks\":\n      result.push(\n        \"system.abilities.dex.checkMod\",\n        ...(system.attributes.init.ability === \"dex\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"conChecks\":\n      result.push(\n        \"system.abilities.con.checkMod\",\n        ...(system.attributes.init.ability === \"con\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"intChecks\":\n      result.push(\n        \"system.abilities.int.checkMod\",\n        ...(system.attributes.init.ability === \"int\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"wisChecks\":\n      result.push(\n        \"system.abilities.wis.checkMod\",\n        ...(system.attributes.init.ability === \"wis\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"chaChecks\":\n      result.push(\n        \"system.abilities.cha.checkMod\",\n        ...(system.attributes.init.ability === \"cha\" ? [\"system.attributes.init.total\"] : [])\n      );\n      break;\n    case \"allSpeeds\":\n      for (const speedKey of Object.keys(system.attributes.speed)) {\n        result.push(`system.attributes.speed.${speedKey}.total`);\n      }\n      break;\n    case \"landSpeed\":\n      result.push(\"system.attributes.speed.land.total\");\n      break;\n    case \"climbSpeed\":\n      result.push(\"system.attributes.speed.climb.total\");\n      break;\n    case \"swimSpeed\":\n      result.push(\"system.attributes.speed.swim.total\");\n      break;\n    case \"burrowSpeed\":\n      result.push(\"system.attributes.speed.burrow.total\");\n      break;\n    case \"flySpeed\":\n      result.push(\"system.attributes.speed.fly.total\");\n      break;\n    case \"cmb\":\n      result.push(\"system.attributes.cmb.bonus\");\n      break;\n    case \"cmd\":\n      if ([\"dodge\", \"haste\"].includes(modifierType)) {\n        result.push(\"system.attributes.cmd.total\");\n        break;\n      }\n      result.push(\"system.attributes.cmd.total\", \"system.attributes.cmd.flatFootedTotal\");\n      break;\n    case \"init\":\n      result.push(\"system.attributes.init.total\");\n      break;\n    case \"acpA\":\n      result.push(\"system.attributes.acp.armorBonus\");\n      break;\n    case \"acpS\":\n      result.push(\"system.attributes.acp.shieldBonus\");\n      break;\n    case \"mDexA\":\n      result.push(\"system.attributes.mDex.armorBonus\");\n      break;\n    case \"mDexS\":\n      result.push(\"system.attributes.mDex.shieldBonus\");\n      break;\n    case \"spellResist\":\n      result.push(\"system.attributes.sr.total\");\n      break;\n    case \"damage\":\n      result.push(\"system.attributes.damage.general\");\n      break;\n    case \"mdamage\":\n      result.push(\"system.attributes.damage.meleeAll\");\n      break;\n    case \"rdamage\":\n      result.push(\"system.attributes.damage.rangedAll\");\n      break;\n    case \"wdamage\":\n      result.push(\"system.attributes.damage.weapon\");\n      break;\n    case \"rwdamage\":\n      result.push(\"system.attributes.damage.ranged\");\n      break;\n    case \"twdamage\":\n      result.push(\"system.attributes.damage.thrown\");\n      break;\n    case \"mwdamage\":\n      result.push(\"system.attributes.damage.melee\");\n      break;\n    case \"ndamage\":\n      result.push(\"system.attributes.damage.natural\");\n      break;\n    case \"sdamage\":\n      result.push(\"system.attributes.damage.spell\");\n      break;\n    case \"bonusFeats\":\n      result.push(\"system.details.feats.bonus\");\n      break;\n    case \"bonusSkillRanks\":\n      result.push(\"system.details.skills.bonus\");\n      break;\n    case \"concentration\":\n      result.push(\n        \"system.attributes.spells.spellbooks.primary.concentration.total\",\n        \"system.attributes.spells.spellbooks.secondary.concentration.total\",\n        \"system.attributes.spells.spellbooks.tertiary.concentration.total\",\n        \"system.attributes.spells.spellbooks.quaternary.concentration.total\",\n        \"system.attributes.spells.spellbooks.spelllike.concentration.total\"\n      );\n      break;\n    case \"cl\":\n      result.push(\n        \"system.attributes.spells.spellbooks.primary.cl.total\",\n        \"system.attributes.spells.spellbooks.secondary.cl.total\",\n        \"system.attributes.spells.spellbooks.tertiary.cl.total\",\n        \"system.attributes.spells.spellbooks.quaternary.cl.total\",\n        \"system.attributes.spells.spellbooks.spelllike.cl.total\"\n      );\n      break;\n    case \"dc\":\n      result.push(`system.attributes.spells.school.all.dc`);\n      break;\n    case \"sensedv\":\n      result.push(\"system.traits.senses.dv.total\");\n      break;\n    case \"sensets\":\n      result.push(\"system.traits.senses.ts.total\");\n      break;\n    case \"sensebse\":\n      result.push(\"system.traits.senses.bse.total\");\n      break;\n    case \"sensebs\":\n      result.push(\"system.traits.senses.bs.total\");\n      break;\n    case \"sensels\":\n      result.push(\"system.traits.senses.ls.total\");\n      break;\n    case \"sensetr\":\n      result.push(\"system.traits.senses.tr.total\");\n      break;\n    case \"sensesc\":\n      result.push(\"system.traits.senses.sc.total\");\n      break;\n  }\n\n  // Per school DC target\n  const schoolDC = /^dc\\.school\\.(?<schoolId>\\w+)/.exec(target);\n  if (schoolDC) {\n    const schoolId = schoolDC.groups.schoolId;\n    result.push(`system.attributes.spells.school.${schoolId}.dc`);\n  }\n\n  // Per school CL target\n  const schoolCL = /^cl\\.school\\.(?<schoolId>\\w+)/.exec(target);\n  if (schoolCL) {\n    const schoolId = schoolCL.groups.schoolId;\n    result.push(`system.attributes.spells.school.${schoolId}.cl`);\n  }\n\n  // Per book concentration target\n  const concnMatch = /^concn\\.(?<bookId>\\w+)/.exec(target);\n  if (concnMatch) {\n    const bookId = concnMatch.groups.bookId;\n    result.push(`system.attributes.spells.spellbooks.${bookId}.concentration.total`);\n  }\n\n  // Per book caster level target\n  const bookCL = /^cl\\.book\\.(?<bookId>\\w+)/.exec(target);\n  if (bookCL) {\n    const bookId = bookCL.groups.bookId;\n    result.push(`system.attributes.spells.spellbooks.${bookId}.cl.bonus`);\n  }\n\n  if (/^skill\\./.test(target)) {\n    const parts = target.split(\".\").slice(1);\n    let sklKey = parts.shift();\n\n    let spread = true;\n    if (sklKey[0] === \"~\") {\n      spread = false;\n      sklKey = sklKey.slice(1);\n    }\n\n    const skillData = system.skills[sklKey];\n    if (skillData) {\n      const subSklKey = parts.pop();\n\n      if (subSklKey) {\n        // Apply to all skills in this tree, including parent\n        if (skillData.subSkills?.[subSklKey]) {\n          result.push(`system.skills.${sklKey}.subSkills.${subSklKey}.mod`);\n        }\n      } else {\n        result.push(`system.skills.${sklKey}.mod`);\n        if (spread) {\n          for (const subSklKey of Object.keys(skillData.subSkills ?? {})) {\n            result.push(`system.skills.${sklKey}.subSkills.${subSklKey}.mod`);\n          }\n        }\n      }\n    }\n  }\n\n  // Call hooks to enable modules to add or adjust the result array\n  if (Hooks.events.pf1GetChangeFlat?.length) {\n    Hooks.callAll(\"pf1GetChangeFlat\", result, target, modifierType, value, this);\n  }\n\n  // Return results directly when deprecation is removed\n  return result;\n}\n\n/**\n * @deprecated - Implementation moved to {@link ffd20.documents.actor.abstract.BaseCharacterPF#_prepareTypeChanges}\n * @param {*} actor\n * @param {*} changes\n */\nexport function addDefaultChanges(actor, changes) {\n  foundry.utils.logCompatibilityWarning(\n    \"ffd20.documents.actor.changes.addDefaultChanges() is deprecated in favor of ffd20.documents.actor.abstract.BaseCharacterPF#_prepareTypeChanges()\",\n    {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    }\n  );\n}\n\n/**\n * Initialize source info structure and retrieve it\n *\n * @param {object} obj  - Source info base structure\n * @param {string} key - Data path\n * @returns {object} - Target source info structure\n */\nexport function getSourceInfo(obj, key) {\n  obj[key] ??= { negative: [], positive: [] };\n  return obj[key];\n}\n\n/**\n * @param {object} obj - Source info base\n * @param {string} key - Data path\n * @param {string} name - Name to find\n * @param {*} value - Value to set\n * @param {boolean} [positive=true] - Is this positive or negative source\n * @param {string} [id] - Special ID\n */\nexport function setSourceInfoByName(obj, key, name, value, positive = true, id) {\n  const target = positive ? \"positive\" : \"negative\";\n  const sourceInfo = getSourceInfo(obj, key)[target];\n  const data = sourceInfo.find((o) => o.name === name);\n  if (data) data.value = value;\n  else {\n    const srcInfo = {\n      name,\n      value,\n    };\n    if (id) srcInfo.id = id;\n    sourceInfo.push(srcInfo);\n  }\n}\n\n/**\n * @param {ItemChange[]} changes - An array containing all changes to check. Must be called after they received a value (by ItemChange.applyChange)\n * @param {object} [options] - Additional options\n * @param {boolean} [options.ignoreTarget] - Whether to only check for modifiers such as enhancement, insight (true) or whether the target (AC, weapon damage) is also important (false)\n * @returns {ItemChange[]} - A list of processed changes, excluding the lower-valued ones inserted (if they don't stack)\n */\nexport function getHighestChanges(changes, options = { ignoreTarget: false }) {\n  const highestTemplate = {\n    value: 0,\n    ids: [],\n    highestID: null,\n  };\n  const highest = Object.keys(ffd20.config.bonusTypes).reduce((cur, k) => {\n    if (options.ignoreTarget) cur[k] = foundry.utils.deepClone(highestTemplate);\n    else cur[k] = {};\n    return cur;\n  }, {});\n\n  for (const c of changes) {\n    let h;\n    if (options.ignoreTarget) h = highest[c.type];\n    else h = highest[c.type]?.[c.target];\n\n    if (!h) continue; // Ignore bad changes\n    h.ids.push(c._id);\n    if (h.value < c.value || !h.highestID) {\n      h.value = c.value;\n      h.highestID = c._id;\n    }\n  }\n\n  {\n    let mod, h;\n    const filterFunc = (c) => {\n      if (h.highestID === c._id) return true;\n      if (ffd20.config.stackingBonusTypes.indexOf(mod) === -1 && h.ids.includes(c._id)) return false;\n      return true;\n    };\n\n    for (mod of Object.keys(highest)) {\n      if (options.ignoreTarget) {\n        h = highest[mod];\n        changes = changes.filter(filterFunc);\n      } else {\n        for (const subTarget of Object.keys(highest[mod])) {\n          h = highest[mod][subTarget];\n          changes = changes.filter(filterFunc);\n        }\n      }\n    }\n  }\n\n  return changes;\n}\n","/**\n * Spellbook details.\n */\nexport class Spellbook {\n  /**\n   * Book key.\n   */\n  key;\n\n  /**\n   * Owning actor.\n   */\n  actor;\n\n  /**\n   * Raw spellbook data.\n   */\n  data;\n\n  /**\n   * All spells.\n   */\n  spells = [];\n\n  level = {};\n\n  /**\n   * @param {string} bookKey Book key.\n   * @param {ActorPF} actor Owning actor.\n   */\n  constructor(bookKey, actor) {\n    this.key = bookKey;\n    this.actor = actor;\n    this.data = actor.system.attributes.spells.spellbooks[bookKey];\n  }\n\n  /**\n   * Add spell to the spellbook and to its appropriate level.\n   *\n   * @param {ItemSpellPF} spell\n   */\n  addSpell(spell) {\n    this.spells.push(spell);\n\n    // Basic sanity check\n    const level = spell.system.level;\n    if (Math.clamp(level, 0, 9) !== level) {\n      console.error(\"Spell with impossible spell level:\", spell);\n      return;\n    }\n\n    // Ensure appropriate spell level exists\n    this.level[level] ??= new SpellbookLevel(this);\n\n    // Add spell to the spell level also\n    this.level[level].spells.push(spell);\n  }\n}\n\n/**\n * Spellbook leveled details.\n */\nexport class SpellbookLevel {\n  /**\n   * Owning book.\n   */\n\n  book;\n  /**\n   * Spells for level.\n   */\n  spells = [];\n\n  constructor(book) {\n    this.book = book;\n  }\n}\n\nexport class SpellbookSlots {\n  level = 0;\n  max = 0;\n  value = 0;\n  domain = 0;\n  domainMax = 0;\n  domainUnused = 0;\n  used = 0;\n  total = 0;\n\n  /**\n   * @param {object} options - Options\n   * @param {number} options.max - Maximum normal spells\n   * @param {number} options.domain - Maximum domain spells\n   * @param {number} options.level - Spell level\n   */\n  constructor({ max = 0, domain = 0, level = 0 } = {}) {\n    this.level = level;\n\n    // Enforce lack of domain slots for level 0\n    if (level === 0) domain = 0;\n\n    this.value = max + domain;\n    this.max = max;\n\n    this.domain = domain;\n    this.domainMax = domain;\n    this.domainUnused = domain;\n\n    this.total = max + domain;\n  }\n}\n\nexport class SpellRanges {\n  close;\n  medium;\n  long;\n\n  cl;\n\n  constructor(cl) {\n    this.cl = cl;\n    this.close = ffd20.utils.calculateRange(null, \"close\", { cl })[0];\n    this.medium = ffd20.utils.calculateRange(null, \"medium\", { cl })[0];\n    this.long = ffd20.utils.calculateRange(null, \"long\", { cl })[0];\n  }\n}\n\nexport class SpellbookMode {\n  raw;\n\n  #spontaneous = false;\n  #prepared = false;\n\n  get isSpontaneous() {\n    return this.#spontaneous || false;\n  }\n\n  get isPrepared() {\n    return this.#prepared || false;\n  }\n\n  get usesSpellpoints() {\n    return this.book.spellPoints?.useSystem === true;\n  }\n\n  get isSemiSpontaneous() {\n    return this.isSpontaneous || this.usesSpellpoints || false;\n  }\n\n  constructor(book) {\n    this.book = book;\n\n    let mode = book.spellPreparationMode;\n    // Shunt invalid mode\n    mode ||= book.spellPreparationMode = \"spontaneous\";\n\n    this.raw = mode;\n\n    const preparation = ffd20.config.caster.type[this.raw];\n    this.#spontaneous = preparation.spontaneous;\n    this.#prepared = preparation.prepared;\n  }\n}\n","/**\n * Resource interface.\n */\nexport class Resource {\n  /** @type {string} */\n  get id() {\n    return this._id;\n  }\n\n  /** @type {ItemPF} */\n  #item;\n  get item() {\n    return this.#item;\n  }\n\n  /**\n   * @param {number} value Value to add to the charges.\n   * @returns {Promise<Item>} Update promise\n   */\n  async add(value) {\n    return this.item.addCharges(value);\n  }\n\n  constructor(item) {\n    this.#item = item;\n    const tag = item.system.tag;\n\n    Object.defineProperties(this, {\n      value: {\n        get() {\n          return this.item.charges;\n        },\n        enumerable: true,\n      },\n      max: {\n        get() {\n          return this.item.maxCharges;\n        },\n        enumerable: true,\n      },\n      _id: {\n        value: item.id,\n        enumerable: true,\n      },\n      tag: {\n        value: tag,\n        enumerable: true,\n      },\n    });\n  }\n}\n","import { ActorBasePF } from \"./actor-base.mjs\";\nimport {\n  applyChanges,\n  getChangeFlat,\n  getSourceInfo,\n  setSourceInfoByName,\n  getHighestChanges,\n} from \"./utils/apply-changes.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\nimport { Spellbook, SpellRanges, SpellbookMode, SpellbookSlots } from \"./utils/spellbook.mjs\";\nimport { VisionSharingSheet } from \"module/applications/vision-sharing.mjs\";\nimport { Resource } from \"./components/resource.mjs\";\n\n/**\n * Extend the base Actor class to implement additional game system logic.\n */\nexport class ActorPF extends ActorBasePF {\n  /**\n   * Configure actor before data preparation.\n   *\n   * @override\n   * @param {object} options - Document options\n   */\n  _configure(options = {}) {\n    super._configure(options);\n\n    /**\n     * Stores all ItemChanges from carried items.\n     *\n     * @public\n     * @type {Collection<ItemChange>}\n     */\n    this.changes ??= new Collection();\n\n    /**\n     * Cached roll data for this item.\n     *\n     * @internal\n     * @type {object}\n     */\n    Object.defineProperties(this, {\n      itemFlags: {\n        value: { boolean: {}, dictionary: {} },\n        writable: false,\n      },\n      _rollData: {\n        value: null,\n        enumerable: false,\n        writable: true,\n      },\n      _visionSharingSheet: {\n        value: null,\n        enumerable: false,\n        writable: true,\n      },\n    });\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Spell Failure Percentage as number from 0 to 100.\n   *\n   * @type {number}\n   */\n  get spellFailure() {\n    return this.itemTypes.equipment\n      .filter((o) => o.system.equipped === true)\n      .reduce((cur, o) => cur + (o.system.spellFailure || 0), 0);\n  }\n\n  /**\n   * Actor's current race item.\n   *\n   * @type {ffd20.documents.item.ItemRacePF|null}\n   */\n  get race() {\n    return this.itemTypes.race[0] ?? null;\n  }\n\n  /**\n   * @internal\n   * @param {SourceInfo} src - Source info\n   * @returns {string} - Label for source\n   */\n  static _getSourceLabel(src) {\n    /** @type {ItemPF} */\n    const item = src.change?.parent;\n    if (item) {\n      const subtype = item.subType;\n      let typeLabel;\n\n      if (subtype && ((item.system.identified ?? true) || game.user.isGM) && ![\"weapon\"].includes(item.type))\n        typeLabel = game.i18n.localize(`FFD20.Subtypes.Item.${item.type}.${subtype}.Single`);\n      else typeLabel = game.i18n.localize(`TYPES.Item.${item.type}`);\n\n      return `${src.name} (${typeLabel})`;\n    }\n\n    return src.name;\n  }\n\n  /**\n   * Retrieve valid skill change targets for this actor.\n   *\n   * @internal\n   * @returns {Array<string>} - Skill target array\n   */\n  get _skillTargets() {\n    const skills = [];\n    for (const [sklKey, skl] of Object.entries(this.system.skills)) {\n      if (skl == null) continue;\n      // Add main skill\n      skills.push(`skill.${sklKey}`); // Affects this and sub-skills\n      skills.push(`skill.~${sklKey}`); // Special extra target that does not affect sub-skills\n      // Add subskills if present\n      for (const subSklKey of Object.keys(skl.subSkills ?? [])) {\n        skills.push(`skill.${sklKey}.${subSklKey}`);\n      }\n    }\n    return skills;\n  }\n\n  /**\n   * Change target paths for spellbooks on the actor.\n   *\n   * @internal\n   * @type {Array<string>}\n   */\n  get _spellbookTargets() {\n    const spellTargets = [];\n    // Add caster level and concentration to targets\n    for (const [bookId, bookData] of Object.entries(this._source.system.attributes?.spells?.spellbooks ?? {})) {\n      if (bookData.inUse) {\n        spellTargets.push(`cl.book.${bookId}`, `concn.${bookId}`);\n      }\n    }\n    return spellTargets;\n  }\n\n  /**\n   * Prepare boolean and dictionary flags.\n   *\n   * @internal\n   */\n  _prepareItemFlags() {\n    const items = this.allItems;\n    const bFlags = {};\n    const dFlags = {};\n\n    for (const item of items) {\n      // Process boolean flags\n      if (item.isActive) {\n        const flags = item.system.flags?.boolean || {};\n        for (const flag of Object.keys(flags)) {\n          bFlags[flag] ??= { sources: [] };\n          bFlags[flag].sources.push(item);\n        }\n      }\n\n      // Process dictionary flags\n      const tag = item.system.tag;\n      if (tag) {\n        const dEntries = Object.entries(item.system.flags?.dictionary || {});\n        if (dEntries.length) {\n          dFlags[tag] ||= {};\n\n          for (const [key, value] of dEntries) {\n            if (dFlags[tag][key] !== undefined && this.isOwner) {\n              const msg = game.i18n.format(\"FFD20.Warning.DuplicateDFlag\", {\n                actor: this.uuid,\n                item: item.name,\n                key,\n                tag,\n              });\n              console.warn(msg, item);\n              ui.notifications?.warn(msg, { console: false });\n            }\n\n            dFlags[tag][key] = item.isActive ? value : 0;\n          }\n        }\n      }\n    }\n\n    this.itemFlags.boolean = bFlags;\n    this.itemFlags.dictionary = dFlags;\n  }\n\n  /**\n   * @internal\n   */\n  _prepareChanges() {\n    /** @type {ItemChange[]} */\n    const changes = [];\n    for (const item of this.items) {\n      if (item.isActive && item.hasChanges && item.changes.size) {\n        changes.push(...item.changes);\n      }\n    }\n\n    this._prepareTypeChanges(changes);\n\n    const c = new Collection();\n    for (const change of changes) {\n      // Avoid ID conflicts\n      const parentId = change.parent?.id ?? \"Actor\";\n      const uniqueId = `${parentId}-${change._id}`;\n      c.set(uniqueId, change);\n    }\n\n    this.changes = c;\n  }\n\n  /**\n   * Add actor type specific changes.\n   *\n   * @internal\n   * @abstract\n   * @protected\n   * @param {ItemChange[]} changes - Array of changes\n   */\n  // eslint-disable-next-line no-unused-vars\n  _prepareTypeChanges(changes) {}\n\n  /**\n   * @internal\n   * @override\n   */\n  applyActiveEffects() {\n    // Apply active effects. Required for status effects in v11 and onward, such as blind and invisible.\n    super.applyActiveEffects();\n\n    this.prepareConditions();\n\n    this._prepareItemFlags();\n    this._prepareChanges();\n    applyChanges(this, { simple: true });\n  }\n\n  /**\n   * Deletes expired temporary active effects and disables linked expired buffs.\n   *\n   * @param {object} [options] Additional options\n   * @param {Combat} [options.combat] Combat to expire data in, if relevant\n   * @param {number} [options.worldTime] - World time\n   * @param {number} [options.timeOffset=0] Time offset from world time\n   * @param {string} [options.event] - Expiration event\n   * @param {number} [options.initiative] - Initiative based expiration marker\n   * @param {DocumentModificationContext} [context] Document update context\n   * @throws {Error} - With insufficient permissions to control the actor.\n   */\n  async expireActiveEffects(\n    { combat, timeOffset = 0, worldTime = null, event = null, initiative = null } = {},\n    context = {}\n  ) {\n    if (!this.isOwner) throw new Error(\"Must be owner\");\n\n    // Canonical world time.\n    // Due to async code in numerous places and no awaiting of time updates, this can go out of sync of actual time.\n    worldTime ??= game.time.worldTime;\n    worldTime += timeOffset;\n\n    // Effects that have timed out\n    const expiredEffects = this._effectsWithDuration.filter((ae) => {\n      const { seconds, startTime } = ae.duration;\n      const { rounds, startRound } = ae.duration;\n\n      // Calculate remaining duration.\n      // AE.duration.remaining is updated by Foundry only in combat and is unreliable.\n      let remaining = Infinity;\n      // Convert rounds to seconds\n      if (Number.isFinite(seconds) && seconds >= 0) {\n        const elapsed = worldTime - (startTime ?? 0);\n        remaining = seconds - elapsed;\n      } else if (rounds > 0 && combat) {\n        // BUG: This will ignore which combat the round tracking started for\n        const elapsed = combat.round - (startRound ?? 0);\n        remaining = (rounds - elapsed) * CONFIG.time.roundTime;\n      }\n\n      // Time still remaining\n      if (remaining > 0) return false;\n\n      const aeInit = ae.system?.initiative;\n      const endTiming = ae.system?.end || \"turnStart\";\n\n      switch (endTiming) {\n        // Initiative based ending\n        case \"initiative\":\n          if (initiative !== null) {\n            return initiative <= aeInit;\n          }\n          // Anything not on initiative expires if they have negative time remaining\n          return remaining < 0;\n        // End on turn start, but we're not there yet\n        case \"turnStart\":\n          if (remaining === 0 && ![\"turnStart\", \"turnEnd\"].includes(event)) return false;\n          break;\n        // End on turn end, but we're not quite there yet\n        case \"turnEnd\":\n          if (remaining === 0 && event !== \"turnEnd\") return false;\n          break;\n      }\n\n      // Otherwise end when time is out\n      return remaining <= 0;\n    });\n\n    const disableActiveEffects = [],\n      deleteActiveEffects = [],\n      disableBuffs = [];\n\n    for (const ae of expiredEffects) {\n      let item;\n      // Use AE parent when available\n      if (ae.parent instanceof Item) item = ae.parent;\n      // Otherwise support older origin cases\n      else item = ae.origin ? await fromUuid(ae.origin, { relative: this }) : null;\n\n      if (item?.type === \"buff\") {\n        disableBuffs.push({ _id: item.id, \"system.active\": false });\n      } else {\n        if (ae.getFlag(\"ffd20\", \"autoDelete\")) {\n          deleteActiveEffects.push(ae.id);\n        } else {\n          disableActiveEffects.push({ _id: ae.id, disabled: true });\n        }\n      }\n    }\n\n    // Add context info for why this update happens to allow modules to understand the cause.\n    context.ffd20 ??= {};\n    context.ffd20.reason = \"duration\";\n\n    if (deleteActiveEffects.length) {\n      const deleteAEContext = foundry.utils.mergeObject(\n        { render: !disableBuffs.length && !disableActiveEffects.length },\n        context\n      );\n      await this.deleteEmbeddedDocuments(\"ActiveEffect\", deleteActiveEffects, deleteAEContext);\n    }\n\n    if (disableActiveEffects.length) {\n      const disableAEContext = foundry.utils.mergeObject({ render: !disableBuffs.length }, context);\n      await this.updateEmbeddedDocuments(\"ActiveEffect\", disableActiveEffects, disableAEContext);\n    }\n\n    if (disableBuffs.length) {\n      await this.updateEmbeddedDocuments(\"Item\", disableBuffs, context);\n    }\n  }\n\n  /**\n   * Prepare actor data before items are prepared.\n   *\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    this.system.details ??= {};\n    this.system.details.level ??= {};\n\n    /** @type {Record<string, {negative:SourceInfo[], positive:SourceInfo[]}>} */\n    this.sourceInfo = {};\n    this.changeFlags = {};\n\n    // Reset equipment info\n    this.equipment = {\n      shield: { type: ffd20.config.shieldTypes.none, id: undefined },\n      armor: { type: ffd20.config.armorTypes.none, id: undefined },\n    };\n\n    // Reset class info\n    this.classes = {};\n\n    //  Init resources structure\n    this.system.resources ??= {};\n\n    this._resetInherentTotals();\n\n    this._prepareTraits();\n\n    if (Hooks.events.pf1PrepareBaseActorData?.length) {\n      Hooks.callAll(\"pf1PrepareBaseActorData\", this);\n    }\n\n    // Update total level and mythic tier\n    const classes = this.itemTypes.class;\n    /** @type {{hd:number,mythic:number,level:number}} */\n    const levels = classes.reduce(\n      (cur, o) => {\n        o.reset(); // HACK: Out of order preparation for later.\n        cur.hd += o.hitDice;\n        if (![\"mythic\", \"racial\"].includes(o.subType)) {\n          cur.level += o.system.level ?? 0;\n        }\n        cur.mythic += o.mythicTier;\n        return cur;\n      },\n      { hd: 0, mythic: 0, level: 0 }\n    );\n\n    this.system.details.level.value = levels.level;\n    this.system.details.mythicTier = levels.mythic;\n\n    // Refresh ability scores\n    for (const ability of Object.values(this.system.abilities)) {\n      const value = ability.value;\n      if (value === null) {\n        ability.total = null;\n        ability.base = null;\n        ability.undrained = null;\n      } else {\n        ability.undrained = value;\n        ability.total = value - ability.drain;\n        ability.penalty = (ability.penalty || 0) - Math.abs(ability.userPenalty || 0);\n        ability.base = ability.total;\n      }\n    }\n    this.refreshAbilityModifiers();\n\n    // Reset BAB\n    {\n      const k = \"system.attributes.bab.total\";\n      const v = Math.floor(\n        classes.reduce((cur, cls) => {\n          // HACK: Depends on earlier out of order preparation\n          const bab = cls.system.babBase;\n          if (bab !== 0) {\n            getSourceInfo(this.sourceInfo, k).positive.push({\n              name: cls.name,\n              value: ffd20.utils.fractionalToString(bab),\n            });\n          }\n          return cur + bab;\n        }, 0)\n      );\n      this.system.attributes.bab.total = Math.floor(v);\n\n      // Add .value for NPC lite sheet\n      if (this.system.attributes.bab.value) this.system.attributes.bab.total += this.system.attributes.bab.value ?? 0;\n    }\n\n    this._prepareSenses();\n\n    this._prepareClassSkills();\n\n    // Reset HD\n    foundry.utils.setProperty(this.system, \"attributes.hd.total\", levels.hd);\n  }\n\n  /**\n   * Prepare traits.\n   *\n   * Called in prepareBaseData()\n   *\n   * @protected\n   * @abstract\n   */\n  _prepareTraits() {}\n\n  /**\n   * Finalize preparing armor, weapon, and language proficiencies and other traits.\n   *\n   * Called in prepareDerivedData()\n   *\n   * @protected\n   * @abstract\n   */\n  _finalizeTraits() {}\n\n  /**\n   * Prepare creature type info\n   */\n  _prepareCreatureType() {\n    const race = this.race;\n    if (race) {\n      const creatureType = race?.system.creatureType || \"humanoid\";\n      this.system.traits.type = creatureType;\n      // TODO: Move quadruped to traits or system roots\n      this.system.attributes.quadruped ??= race?.system.quadruped ?? false;\n    }\n\n    const types = this.system.traits.creatureTypes?.standard;\n    if (!types?.size) return;\n\n    // Add some booleans about the types\n    this.system.traits.humanoid = types.has(\"humanoid\");\n    this.system.traits.undead = types.has(\"undead\");\n    this.system.traits.construct = types.has(\"construct\");\n    this.system.traits.living = !this.system.traits.undead && !this.system.traits.construct;\n\n    // Add something from this.system.traits.creatureSubtypes ?\n  }\n\n  _prepareSenses() {\n    // Refresh senses\n    for (const [senseId, sense] of Object.entries(this.system.traits.senses)) {\n      if (typeof sense !== \"object\") continue;\n      if (!sense) continue;\n\n      switch (senseId) {\n        case \"ll\":\n        case \"si\":\n        case \"sid\":\n          break;\n\n        default:\n          sense.total = sense.value;\n          break;\n      }\n    }\n  }\n\n  /**\n   * Prepare actor.system.conditions for use.\n   *\n   * @protected\n   */\n  prepareConditions() {\n    this.system.conditions = {};\n    const conditions = this.system.conditions;\n\n    // Populate conditions\n    // @deprecated - This should be only done in getRollData()\n    for (const condition of ffd20.registry.conditions.keys()) {\n      conditions[condition] = this.statuses.has(condition);\n    }\n  }\n\n  /**\n   * Prepare natural reach for melee range and for reach weapons.\n   *\n   * @protected\n   */\n  _prepareNaturalReach() {\n    // Prepare base natural reach\n    this.system.traits.reach ??= {};\n    const reach = this.system.traits.reach;\n\n    reach.base = this.constructor.getReach(this.system.traits?.size?.value, this.system.traits?.stature);\n\n    // Reset values\n    reach.natural = reach.base;\n    reach.total = { ...reach.base };\n\n    // Add base natural values to the change sources\n    getSourceInfo(this.sourceInfo, \"system.traits.reach.total.melee\").positive.push({\n      name: game.i18n.localize(\"FFD20.BuffTarReach\"),\n      modifier: \"base\",\n      value: reach.base.melee,\n    });\n    getSourceInfo(this.sourceInfo, \"system.traits.reach.total.reach\").positive.push({\n      name: game.i18n.localize(\"FFD20.BuffTarReach\"),\n      modifier: \"base\",\n      value: reach.base.reach,\n    });\n  }\n\n  /**\n   * Reset class skills.\n   *\n   * @protected\n   */\n  _prepareClassSkills() {\n    /** @type {Record<string,SkillData>} */\n    const skills = this.system.skills;\n    if (!skills) return;\n\n    const skillSet = new Set();\n    const csSources = this.items.filter((item) => [\"class\", \"race\", \"feat\"].includes(item.type));\n    for (const csItem of csSources) {\n      for (const [classSkillName, isClassSkill] of Object.entries(csItem.system.classSkills || {})) {\n        if (isClassSkill === true) skillSet.add(classSkillName);\n      }\n    }\n    if (skillSet.size == 0) return;\n\n    for (const [skillKey, skillData] of Object.entries(skills)) {\n      if (!skillData) {\n        console.warn(`Bad skill data for \"${skillKey}\"`, this);\n        continue;\n      }\n      skills[skillKey].cs = skillSet.has(skillKey);\n      for (const k2 of Object.keys(skillData.subSkills ?? {})) {\n        foundry.utils.setProperty(skillData, `subSkills.${k2}.cs`, skillSet.has(skillKey));\n      }\n    }\n  }\n\n  /**\n   * Checks if there's any matching proficiency\n   *\n   * @param {ffd20.document.item.ItemEquipmentPF} item - The item to check for.\n   * @returns {boolean} Whether the actor is proficient with that item.\n   */\n  hasArmorProficiency(item) {\n    // Check for item type\n    if (item.type !== \"equipment\" || ![\"armor\", \"shield\"].includes(item.system.subType)) return true;\n\n    /** @type {TraitData} */\n    const aprof = this.system.traits?.armorProf;\n    if (!aprof) return false;\n\n    // Base proficiency\n    if (aprof.total.has(item.baseArmorProficiency)) return true;\n\n    // Base types with custom proficiencies\n    if (aprof.custom.size == 0) return false;\n\n    /** @type {string[]} */\n    const baseTypes = item.system.baseTypes ?? [];\n    return baseTypes.some((type) => aprof.custom.has(type));\n  }\n\n  /**\n   * Test if actor is proficient with specified weapon.\n   *\n   * @remarks Natural attacks incorrectly do not count as proficient.\n   *\n   * @param {ItemPF} item - Item to test\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.override=true] - Allow item's proficiency override to influence the result.\n   * @returns {boolean} - Proficiency state\n   */\n  hasWeaponProficiency(item, { override = true } = {}) {\n    if (override && item.system.proficient) return true; // Explicitly marked as proficient\n\n    /** @type {TraitData} */\n    const wprof = this.system.traits?.weaponProf;\n    if (!wprof) return false;\n\n    // Match basic proficiencies, e.g. simple and martial (only present on weapons)\n    // TODO: Make the item identify it's own weapon type\n    let category;\n    if (item.type === \"weapon\") {\n      category = item.subType;\n    } else if (item.type === \"attack\") {\n      category = item.subType === \"weapon\" ? item.system.weapon?.category : null;\n    }\n    if (wprof.standard.has(category)) return true;\n\n    // Match base types\n    if (wprof.custom.size == 0) return false;\n    const baseTypes = item.system.baseTypes ?? [];\n    return baseTypes.some((type) => wprof.custom.has(type));\n  }\n\n  /**\n   * Update specific spellbook.\n   *\n   * @internal\n   * @param {string} bookId Spellbook identifier\n   * @param {object} [rollData] Roll data instance\n   * @param {object} cache Pre-calculated data for re-use from _generateSpellbookCache\n   */\n  _updateSpellBook(bookId, rollData, cache) {\n    const actorData = this.system;\n    const book = actorData.attributes?.spells?.spellbooks?.[bookId];\n    if (!book) {\n      console.error(`Spellbook data not found for \"${bookId} on actor`, this);\n      return;\n    }\n\n    // Set spellbook label\n    book.label = book.name || game.i18n.localize(`FFD20.SpellBook${bookId.capitalize()}`);\n\n    // Do not process spellbooks that are not in use\n    if (!book.inUse) return;\n\n    const mode = new SpellbookMode(book);\n\n    let castsPerDayTables = ffd20.config.casterProgression.castsPerDay[mode.raw] ?? {};\n\n    book.isSchool = book.kind !== \"divine\";\n    book.hasProgressionChoices = Object.keys(castsPerDayTables).length > 1;\n\n    // Use custom name if present\n    if (book.name) book.label = book.name;\n    // Get name from class if selected\n    else if (book.class) {\n      if (book.class === \"_hd\") book.label = book.name || game.i18n.localize(\"FFD20.SpellBookSpelllike\");\n      else {\n        const bookClassId = this.classes[book.class]?._id;\n        const bookClass = this.items.get(bookClassId);\n        if (bookClass) book.label = bookClass.name;\n      }\n    }\n\n    rollData ??= this.getRollData({ refresh: true });\n    cache ??= this._generateSpellbookCache();\n\n    const bookInfo = cache.books[bookId];\n\n    /** @type {AbilityScoreData} */\n    const spellbookAbility = actorData.abilities[book.ability];\n\n    // Add spell slots based on ability bonus slot formula\n    const spellSlotAbilityScoreBonus = RollPF.safeRollSync(book.spellSlotAbilityBonusFormula || \"0\", rollData).total,\n      spellSlotAbilityScore = (spellbookAbility?.total ?? 10) + spellSlotAbilityScoreBonus,\n      spellSlotAbilityMod = ffd20.utils.getAbilityModifier(spellSlotAbilityScore);\n\n    // Set CL\n    let clTotal = 0;\n    {\n      const key = `system.attributes.spells.spellbooks.${bookId}.cl.total`;\n      const formula = book.cl.formula || \"0\";\n      let total = 0;\n\n      // Add NPC base\n      if (this.type === \"npc\") {\n        const value = book.cl.base || 0;\n        total += value;\n        clTotal += value;\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.Base\"), value);\n      }\n      // Add HD\n      if (book.class === \"_hd\") {\n        const value = actorData.attributes.hd.total;\n        total += value;\n        clTotal += value;\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.HitDie\"), value);\n      }\n      // Add class levels\n      else if (book.class && rollData.classes[book.class]) {\n        const value = rollData.classes[book.class].unlevel;\n        total += value;\n        clTotal += value;\n\n        setSourceInfoByName(this.sourceInfo, key, rollData.classes[book.class].name, value, true, \"class\");\n      }\n\n      // Set auto spell level calculation offset\n      if (book.autoSpellLevelCalculation) {\n        const autoFormula = book.cl.autoSpellLevelCalculationFormula || \"0\";\n        const autoBonus = RollPF.safeRollSync(autoFormula, rollData).total ?? 0;\n        const autoTotal = Math.clamp(total + autoBonus, 1, 20);\n        book.cl.autoSpellLevelTotal = autoTotal;\n\n        clTotal += autoBonus;\n        if (autoBonus !== 0) {\n          setSourceInfoByName(\n            this.sourceInfo,\n            key,\n            game.i18n.localize(\"FFD20.AutoSpellClassLevelOffset.Formula\"),\n            autoBonus\n          );\n        }\n      }\n\n      // Add from bonus formula\n      const clBonus = RollPF.safeRollSync(formula, rollData).total;\n      clTotal += clBonus;\n      if (clBonus > 0) {\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.CasterLevelBonusFormula\"), clBonus);\n      } else if (clBonus < 0) {\n        setSourceInfoByName(this.sourceInfo, key, game.i18n.localize(\"FFD20.CasterLevelBonusFormula\"), clBonus, false);\n      }\n\n      // HACK: Apply Wound Threshold outside of normal WT workflow since spellbook is handled outside of normal workflow\n      const penalty = this.system.attributes?.woundThresholds?.penalty || 0;\n      if (clTotal > 0 && penalty != 0) {\n        // BUG: If CL target affects more than .cl.total this fails to do so\n        // In case CL target of WT has been disabled by users\n        if (ffd20.config.woundThresholdChangeTargets.includes(\"cl\")) {\n          const newCL = Math.max(1, clTotal - penalty);\n          book.cl.woundPenalty = clTotal - newCL; // Keep record of how much WT actually reduced this\n          clTotal = newCL;\n        }\n      }\n\n      // Apply negative levels\n      if (rollData.attributes.energyDrain) {\n        clTotal = Math.max(0, clTotal - rollData.attributes.energyDrain);\n        setSourceInfoByName(\n          this.sourceInfo,\n          key,\n          game.i18n.localize(\"FFD20.NegativeLevels\"),\n          -Math.abs(rollData.attributes.energyDrain),\n          false\n        );\n      }\n\n      clTotal += book.cl.total ?? 0;\n      clTotal += book.cl.bonus ?? 0;\n      book.cl.total = clTotal;\n    }\n\n    // Set concentration bonus\n    {\n      // Temp fix for old actors that fail migration\n      if (Number.isFinite(book.concentration)) {\n        console.error(`Bad spellbook concentration value \"${book.concentration}\" in spellbook \"${bookId}\"`);\n        book.concentration = {};\n      }\n\n      // Bonus formula\n      const concFormula = book.concentrationFormula;\n      const formulaRoll = concFormula.length\n        ? RollPF.safeRollSync(concFormula, rollData, undefined, undefined, { minimize: true })\n        : { total: 0, isDeterministic: true };\n      const rollBonus = formulaRoll.isDeterministic ? formulaRoll.total : 0;\n\n      // Add it all up\n      const classAbilityMod = actorData.abilities[book.ability]?.mod ?? 0;\n      const concentration = clTotal + classAbilityMod + rollBonus;\n      const prevTotal = book.concentration.total ?? 0;\n\n      // Set source info\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.CasterLevel\"),\n        clTotal,\n        false\n      );\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.SpellcastingAbility\"),\n        classAbilityMod,\n        false\n      );\n      setSourceInfoByName(\n        this.sourceInfo,\n        `system.attributes.spells.spellbooks.${bookId}.concentration.total`,\n        game.i18n.localize(\"FFD20.ByBonus\"),\n        formulaRoll.isDeterministic ? formulaRoll.total : formulaRoll.formula,\n        false\n      );\n\n      // Apply value\n      book.concentration ??= {};\n      book.concentration.total = prevTotal + concentration;\n    }\n\n    const getAbilityBonus = (a) => (a !== 0 ? ActorPF.getSpellSlotIncrease(spellSlotAbilityMod, a) : 0);\n\n    // Spell slots\n    const useAuto = book.autoSpellLevelCalculation;\n\n    // Turn off spell points with auto slots\n    if (useAuto) book.spellPoints.useSystem = false;\n    // Turn off bonus slots from ability score without auto slots\n    else book.autoSpellLevels = false;\n\n    const useSpellPoints = book.spellPoints.useSystem === true;\n\n    // Set base \"spontaneous\" based on spell prep mode when using auto slots or spell points\n    const isSpontaneous = mode.isSemiSpontaneous;\n    const isPrepared = mode.isPrepared;\n    book.spontaneous = isSpontaneous;\n    book.prepared = isPrepared;\n\n    let casterType = book.casterType;\n    // Set caster type to sane default if configuration not found.\n    if (!castsPerDayTables[casterType]) {\n      const keys = Object.keys(castsPerDayTables);\n      book.casterType = casterType = keys[0];\n      console.debug(\n        `Actor ${this.name} [${this.uuid}] has invalid caster type in spellbook \"${bookId}\", auto-corrected to \"${casterType}\"`\n      );\n    }\n    castsPerDayTables = castsPerDayTables[casterType];\n\n    // Invalid caster type\n    if (!castsPerDayTables) {\n      return void console.error(`Actor ${this.name} [${this.uuid}] has invalid caster type in spellbook \"${bookId}\"`);\n    }\n\n    // Prepared spells and known spells table\n    const preparedForLevels = ffd20.config.casterProgression.spellsPreparedPerDay[mode.raw][casterType];\n\n    if (useAuto) {\n      let classLevel = Math.clamp(book.cl.autoSpellLevelTotal, 1, 20);\n\n      // Protect against invalid class level bricking actors\n      if (!Number.isSafeInteger(classLevel)) {\n        const msg = `Actor ${this.id} has invalid caster class level.`;\n        console.error(msg, classLevel);\n        ui.notifications?.error(msg, { console: false });\n        classLevel = Math.floor(classLevel);\n      }\n\n      rollData.ablMod = spellSlotAbilityMod;\n\n      const allLevelModFormula = book[isSpontaneous ? \"castPerDayAllOffsetFormula\" : \"preparedAllOffsetFormula\"] || \"0\";\n      const allLevelMod = RollPF.safeRollSync(allLevelModFormula, rollData).total ?? 0;\n\n      // Casts per day table\n      const castsForLevels = castsPerDayTables[classLevel - 1];\n\n      for (let level = 0; level < 10; level++) {\n        const levelData = book.spells[`spell${level}`];\n\n        const castsPerDay = castsForLevels[level];\n        levelData.base = castsPerDay || 0;\n\n        const offsetFormula = levelData[isSpontaneous ? \"castPerDayOffsetFormula\" : \"preparedOffsetFormula\"] || \"0\";\n\n        // Infinite casts, not much else to it\n        if (castsPerDay === Infinity) {\n          levelData.max = Infinity;\n        }\n        // Dealing with cantrips with cantrips not enabled\n        else if (!book.hasCantrips && level == 0) {\n          levelData.max = NaN;\n        }\n        // Has valid number of spells for level\n        else if (Number.isFinite(castsPerDay)) {\n          const max =\n            castsPerDay +\n            getAbilityBonus(level) +\n            allLevelMod +\n            (RollPF.safeRollSync(offsetFormula, rollData).total ?? 0);\n\n          levelData.max = max;\n        }\n        // All other cases\n        else {\n          levelData.max = NaN;\n        }\n\n        // Set spells remaining to match max if it's not a number\n        if (!Number.isFinite(levelData.value)) levelData.value = levelData.max;\n      }\n    } else {\n      for (let level = book.hasCantrips ? 0 : 1; level < 10; level++) {\n        const levelData = book.spells[`spell${level}`];\n        let base = levelData.base;\n        if (Number.isNaN(base) || base === null) {\n          levelData.base = null;\n          levelData.max = 0;\n        } else if (book.autoSpellLevels && base >= 0) {\n          base += getAbilityBonus(level);\n          levelData.max = base;\n        } else {\n          levelData.max = base || 0;\n        }\n\n        if (!Number.isFinite(levelData.value)) {\n          levelData.value = levelData.max;\n        }\n      }\n    }\n\n    // Set spontaneous spell slots to something sane\n    for (let a = 0; a < 10; a++) {\n      book.spells[`spell${a}`].value ||= 0;\n    }\n\n    // Update spellbook slots\n\n    /** @type {Record<number, SpellbookSlots>} */\n    const slots = {};\n\n    for (let spellLevel = 0; spellLevel < 10; spellLevel++) {\n      const max = book.spells[`spell${spellLevel}`].max || 0;\n      slots[spellLevel] = new SpellbookSlots({\n        level: spellLevel,\n        max,\n        domain: book.domainSlotValue || 0,\n      });\n    }\n\n    // Slot usage\n    for (let level = 0; level < 10; level++) {\n      /** @type {ffd20.documents.item.ItemSpellPF[]} */\n      const levelSpells = bookInfo.level[level]?.spells ?? [];\n      const lvlSlots = slots[level];\n      const levelData = book.spells[`spell${level}`];\n      levelData.slots = { used: 0, max: lvlSlots.max };\n\n      //if (!isPrepared) continue; // Needed by Arcanist\n\n      // Occupied slots\n      for (const spell of levelSpells) {\n        /** @type {number} */\n        let prepared;\n        if (isSpontaneous) prepared = spell.system.preparation?.value || 0;\n        else prepared = spell.system.preparation?.max || 0;\n        if (!prepared) continue;\n\n        const slotCost = spell.slotCost;\n        const slots = slotCost * prepared;\n\n        if (spell.isDomain) {\n          lvlSlots.domain -= slots;\n        } else {\n          lvlSlots.used += slots;\n        }\n\n        lvlSlots.value -= slots;\n      }\n\n      // True prepared reduce casts by prepared slots, arcanist and sorcerer for example do not\n      if (!isSpontaneous) levelData.value = lvlSlots.value;\n\n      // Add slot statistics\n      levelData.slots.used = lvlSlots.used;\n      levelData.slots.remaining = levelData.slots.max - levelData.slots.used;\n      levelData.slots.excess = Math.max(0, -levelData.slots.remaining);\n      levelData.domain = { max: lvlSlots.domainMax, remaining: lvlSlots.domain, used: 0 };\n      levelData.domain.excess = Math.max(0, -levelData.domain.remaining);\n      levelData.mismatchSlots = -(\n        levelData.slots.excess +\n        levelData.domain.excess -\n        Math.max(0, levelData.slots.remaining)\n      );\n\n      if (levelData.mismatchSlots == 0) levelData.mismatchSlots = levelData.slots.remaining;\n\n      // Without auto or with any form of spontaneous, slots are impossible to calculate\n      if (useAuto || !isSpontaneous) {\n        levelData.invalidSlots = levelData.mismatchSlots != 0 || levelData.slots.remaining != 0;\n      }\n    }\n\n    // Spells available hint text if auto spell levels is enabled\n    const maxLevelByAblScore = (spellbookAbility?.total ?? 0) - 10;\n\n    const bonusSlotsModFormula = book.preparedAllOffsetFormula || \"0\";\n    const bonusSlotsMod = RollPF.safeRollSync(bonusSlotsModFormula, rollData).total ?? 0;\n\n    const classLevel = Math.floor(Math.clamp(book.cl.autoSpellLevelTotal, 1, 20));\n\n    for (let spellLevel = 0; spellLevel < 10; spellLevel++) {\n      const spellLevelData = book.spells[`spell${spellLevel}`];\n      // Insufficient ability score for the level\n      if (maxLevelByAblScore < spellLevel) {\n        const unlimit = bookInfo.data.noAbilityLimit ?? false;\n        if (!unlimit) {\n          spellLevelData.hasIssues = true;\n          spellLevelData.lowAbilityScore = true;\n        }\n      }\n\n      const lvlSlots = slots[spellLevel];\n\n      spellLevelData.known = { unused: 0, max: 0 };\n      spellLevelData.preparation = { unused: 0, max: 0, domain: spellLevel > 0 ? (lvlSlots.domainMax ?? 0) : 0 };\n\n      let remaining = 0;\n      // True prepared (not hybrid either)\n      if (!isSpontaneous) {\n        remaining = spellLevelData.value;\n        spellLevelData.preparation.max = spellLevelData.max + spellLevelData.preparation.domain;\n      }\n      // Spontaneous\n      else {\n        // Spontaneous and Hybrid\n        // if not prepared then base off of casts per day\n        let available = useAuto ? preparedForLevels[classLevel - 1][spellLevel] : spellLevelData.max;\n        available += bonusSlotsMod;\n        // True spontaneous get domain spells as bonus known, arcanist and wizard/cleric do not\n        //if (!isPrepared) available += spellLevelData.domain.max;\n\n        const perLevelBonusSlotsFormula = spellLevelData.preparedOffsetFormula || \"0\";\n        available += RollPF.safeRollSync(perLevelBonusSlotsFormula, rollData).total ?? 0;\n\n        // Leave record of max known\n        spellLevelData.known.max = available;\n        // Hybrid needs preparation info\n        if (isPrepared) spellLevelData.preparation.max = available;\n\n        if (Number.isNaN(available)) {\n          spellLevelData.hasIssues = true;\n          spellLevelData.lowLevel = true;\n        }\n\n        // Reset used, just in case\n        lvlSlots.used = 0;\n        spellLevelData.domain.used = 0;\n        let domainRemaining = spellLevelData.domain.max;\n\n        // Count spell slots used\n        for (const spell of bookInfo.level[spellLevel]?.spells ?? []) {\n          const { preparation, atWill, domain } = spell.system;\n          if (atWill) continue;\n          if (preparation.value <= 0) continue;\n\n          const slotCost = spell.slotCost;\n          if (domain && domainRemaining > 0) domainRemaining -= slotCost;\n          else lvlSlots.used += slotCost;\n        }\n\n        spellLevelData.domain.used = spellLevelData.domain.max - domainRemaining;\n        remaining = available - lvlSlots.used;\n\n        // Hybrid\n        if (isPrepared) {\n          spellLevelData.mismatchSlots = spellLevelData.mismatchKnown;\n        }\n      }\n\n      // Detect domain slot problems\n      const domainSlotsRemaining = spellLevel > 0 ? lvlSlots.domain : 0;\n\n      spellLevelData.remaining = remaining;\n\n      // No more processing needed\n      if (remaining == 0 && domainSlotsRemaining <= 0) continue;\n\n      spellLevelData.hasIssues = true;\n\n      // Only pure spontaneous tracks known, hybrid calculates prepared through this\n      if (isSpontaneous) {\n        spellLevelData.known.used = lvlSlots.used;\n        spellLevelData.known.unused = Math.max(0, remaining);\n        spellLevelData.known.excess = -Math.min(0, remaining);\n\n        if (useAuto) {\n          // Hybrid\n          if (isPrepared) {\n            spellLevelData.mismatchSlots = remaining;\n            spellLevelData.mismatchKnown = 0;\n          }\n          // True spontaneous\n          else {\n            spellLevelData.invalidKnown = spellLevelData.known.unused != 0 || spellLevelData.known.excess != 0;\n            spellLevelData.mismatchKnown = remaining;\n          }\n        }\n      }\n\n      if (isPrepared) {\n        spellLevelData.preparation.unused = Math.max(0, remaining);\n      }\n\n      // With auto slots disabled and any kind of spontaneous, we know nothing\n      if (!useAuto && isSpontaneous) {\n        spellLevelData.mismatchKnown = 0;\n        spellLevelData.mismatchSlots = 0;\n        spellLevelData.domain.remaining = 0;\n        spellLevelData.slots.remaining = 0;\n      }\n    }\n\n    // Spell points\n    if (useSpellPoints) {\n      const formula = book.spellPoints.maxFormula || \"0\";\n      rollData.cl = book.cl.total;\n      rollData.ablMod = spellSlotAbilityMod;\n      const spellClass = book.class ?? \"\";\n      rollData.classLevel =\n        spellClass === \"_hd\"\n          ? (rollData.attributes.hd?.total ?? rollData.details.level.value)\n          : rollData.classes[spellClass]?.level || 0;\n\n      const roll = RollPF.safeRollSync(formula, rollData);\n      book.spellPoints.max = roll.total;\n    } else {\n      book.spellPoints.max = 0;\n    }\n\n    // Set spellbook ranges\n    book.range = new SpellRanges(book.cl.total);\n  }\n\n  /**\n   * Collect some basic spellbook info so it doesn't need to be gathered again for each spellbook.\n   *\n   * @internal\n   * @returns {object} Spellbook cache\n   */\n  _generateSpellbookCache() {\n    const bookKeys = new Set(Object.keys(this.system.attributes.spells.spellbooks));\n\n    const allSpells = this.itemTypes.spell;\n\n    const cache = {\n      spells: allSpells,\n      /** @type {Record<string,Spellbook>} */\n      books: {},\n    };\n\n    // Prepare spellbooks\n    for (const bookKey of bookKeys) {\n      cache.books[bookKey] ??= new Spellbook(bookKey, this);\n    }\n\n    // Spread out spells to books\n    for (const spell of allSpells) {\n      const bookKey = spell.system.spellbook;\n      if (!bookKeys.has(bookKey)) return console.error(\"Spell has invalid book\", spell);\n      cache.books[bookKey].addSpell(spell);\n    }\n\n    return cache;\n  }\n\n  /**\n   * Update all spellbooks\n   *\n   * @internal\n   * @param {object} [rollData] Roll data instance\n   * @param {object} [cache] Spellbook cache\n   */\n  updateSpellbookInfo(rollData, cache) {\n    rollData ??= this.getRollData({ refresh: true });\n    cache ??= this._generateSpellbookCache();\n\n    const spellbooks = this.system.attributes.spells.spellbooks;\n\n    // Set spellbook info\n    for (const bookKey of Object.keys(spellbooks)) {\n      this._updateSpellBook(bookKey, rollData, cache);\n    }\n  }\n\n  /**\n   * Called just before the first change is applied, and after every change is applied.\n   * Sets additional variables (such as spellbook range)\n   *\n   * @internal\n   */\n  refreshDerivedData() {\n    // Reset maximum dexterity bonus\n    this.system.attributes.maxDexBonus = null;\n    this.system.abilities.dex.maxBonus = this.system.abilities.dex.mod;\n\n    // Compute encumbrance\n    const encPen = this._computeEncumbrance();\n\n    // Apply armor penalties\n    const gearPen = this._applyArmorPenalties();\n\n    // Set armor check penalty\n    this.system.attributes.acp.encumbrance = encPen.acp;\n    this.system.attributes.acp.gear = gearPen.acp;\n    this.system.attributes.acp.total = Math.max(encPen.acp, gearPen.acp);\n    // Broken gear affects only skills\n    this.system.attributes.acp.skill = Math.max(encPen.acp, gearPen.acpSkill);\n\n    // Set maximum dexterity bonus\n    if (encPen.maxDexBonus != null || gearPen.maxDexBonus != null) {\n      this.system.attributes.maxDexBonus = Math.min(\n        encPen.maxDexBonus ?? Number.POSITIVE_INFINITY,\n        gearPen.maxDexBonus ?? Number.POSITIVE_INFINITY\n      );\n      this.system.abilities.dex.maxBonus = Math.min(\n        this.system.abilities.dex.maxBonus,\n        this.system.attributes.maxDexBonus\n      );\n    }\n  }\n\n  /**\n   * Augment the basic actor data with additional dynamic data.\n   *\n   * @override\n   */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    this._prepareNaturalReach();\n\n    this.system.traits ??= {};\n    this._finalizeTraits();\n\n    // Add incorporeal status if they have incorporeal creature type\n    if (this.system.traits?.creatureSubtypes?.standard?.has(\"incorporeal\")) {\n      this.statuses.add(\"incorporeal\");\n      this.system.conditions.incorporeal = true;\n    }\n\n    this.system.attributes ??= {};\n\n    this._prepareCreatureType();\n\n    // Reset roll data cache\n    // Some changes act wonky without this\n    // Example: `@skills.hea.rank >= 10 ? 6 : 3` doesn't work well without this\n    this._rollData = null;\n\n    // Setup links\n    this.prepareItemLinks();\n\n    // Update dependant data and resources\n    for (const item of this.items) {\n      item._prepareDependentData(false);\n      this.updateItemResources(item);\n    }\n\n    applyChanges(this);\n\n    const natReach = this.system.traits.reach.total;\n    // Ensure reach never becomes negative value\n    if (natReach.melee < 0) natReach.melee = 0;\n    if (natReach.reach < 0) natReach.reach = 0;\n\n    // Prepare specific derived data\n    // Final weight, ability modifiers, etc.\n    this.prepareSpecificDerivedData();\n\n    // Prepare CMB total\n    this.prepareCMB();\n\n    this._prepareOverlandSpeeds();\n\n    // Reset roll data cache again to include processed info\n    this._rollData = null;\n\n    // Update items\n    for (const item of this.items) {\n      item._prepareDependentData(true);\n      // because the resources were already set up above, this is just updating from current roll data - so do not warn on duplicates\n      this.updateItemResources(item, { warnOnDuplicate: false });\n    }\n  }\n\n  /**\n   * Calculate overland speeds.\n   *\n   * @protected\n   */\n  _prepareOverlandSpeeds() {\n    for (const speed of Object.values(this.system.attributes?.speed ?? {})) {\n      speed.overland = speed.total > 0 ? ffd20.utils.overlandSpeed(speed.total).speed : 0;\n    }\n  }\n\n  /**\n   * Prepare total CMB value.\n   *\n   * @todo Move all the logic here to the Change system.\n   *\n   * @protected\n   */\n  prepareCMB() {\n    const shrAtk = this.system.attributes.attack.shared ?? 0,\n      genAtk = this.system.attributes.attack.general ?? 0,\n      cmbAbl = this.system.attributes.cmbAbility,\n      cmbAblMod = this.system.abilities[cmbAbl]?.mod ?? 0,\n      size = this.system.traits.size.value,\n      szCMBMod = Object.values(ffd20.config.sizeSpecialMods)[size] ?? 0,\n      cmbBonus = this.system.attributes.cmb.bonus ?? 0,\n      cmb = shrAtk + genAtk + szCMBMod + cmbBonus + cmbAblMod;\n    this.system.attributes.cmb.total = cmb;\n  }\n\n  /**\n   * @protected\n   */\n  prepareSpecificDerivedData() {\n    if (Hooks.events.pf1PrepareDerivedActorData?.length) {\n      Hooks.callAll(\"pf1PrepareDerivedActorData\", this);\n    }\n\n    this.refreshDerivedData();\n\n    const attributes = this.system.attributes,\n      /** @type {Record<string,AbilityScoreData>} */\n      abilities = this.system.abilities;\n\n    // Set base ability modifier\n    for (const ablKey of Object.keys(abilities)) {\n      const abl = abilities[ablKey];\n      const base = abl.base;\n      const penalty = abl.penalty || 0;\n      const damage = abl.damage;\n      abl.baseMod = ffd20.utils.getAbilityModifier(base, { penalty, damage });\n      // Save also unmodified modifier\n      abl.unmod = ffd20.utils.getAbilityModifier(abl.undrained);\n    }\n\n    const actorData = this.system;\n\n    // Round health\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const round = { up: Math.ceil, nearest: Math.round, down: Math.floor }[healthConfig.rounding];\n    for (const k of [\"hp\", \"vigor\"]) {\n      attributes[k].max = round(attributes[k].max);\n    }\n\n    // Offset relative health\n    for (const key of [\"hp\", \"wounds\", \"vigor\"]) {\n      const hp = this.system.attributes[key];\n      if (Number.isFinite(hp?.offset)) {\n        hp.value = hp.max + hp.offset;\n      }\n    }\n\n    // Offset relative mana\n    for (const key of [\"mp\"]) {\n      const mp = this.system.attributes[key];\n      if (Number.isFinite(mp?.offset)) {\n        mp.value = mp.max + mp.offset;\n      }\n    }\n\n    // Shared attack bonuses\n    {\n      // Total\n      const totalAtk = attributes.bab.total - attributes.acp.attackPenalty - (attributes.energyDrain ?? 0);\n      attributes.attack.shared = totalAtk;\n    }\n\n    // Update wound threshold\n    this.updateWoundThreshold();\n\n    // Create arbitrary skill slots\n    for (const skillId of ffd20.config.arbitrarySkills) {\n      if (actorData.skills[skillId] == null) continue;\n      /** @type {SkillData} */\n      const skill = actorData.skills[skillId];\n      skill.subSkills = skill.subSkills || {};\n      for (const subSkillId of Object.keys(skill.subSkills)) {\n        if (skill.subSkills[subSkillId] == null) delete skill.subSkills[subSkillId];\n      }\n    }\n\n    // Delete removed skills\n    for (const skillId of Object.keys(actorData.skills)) {\n      const skl = actorData.skills[skillId];\n      if (skl == null) {\n        delete actorData.skills[skillId];\n      }\n    }\n\n    // Mark background skills\n    for (const skillId of Object.keys(actorData.skills)) {\n      if (ffd20.config.backgroundSkills.includes(skillId)) {\n        const skill = actorData.skills[skillId];\n        skill.background = true;\n        for (const subSkillId of Object.keys(skill.subSkills ?? {})) skill.subSkills[subSkillId].background = true;\n      }\n    }\n\n    // Combine AC types\n    for (const k of [\"ac.normal.total\", \"ac.shield.total\", \"ac.natural.total\"]) {\n      const v = foundry.utils.getProperty(actorData, k);\n      if (v) {\n        for (const k2 of [\"normal\", \"flatFooted\"]) {\n          attributes.ac[k2].total += v;\n        }\n      }\n    }\n\n    // Add Dexterity to AC\n    {\n      // get configured ability scores\n      const acAbl = attributes.ac.normal.ability ?? \"dex\";\n      const acTouchAbl = attributes.ac.touch.ability ?? \"dex\";\n      const cmdDexAbl = attributes.cmd.dexAbility ?? \"dex\";\n      let acAblMod = abilities[acAbl]?.mod ?? 0;\n      let acTouchAblMod = abilities[acTouchAbl]?.mod ?? 0;\n      const cmdDexAblMod = abilities[cmdDexAbl]?.mod ?? 0;\n      if (this.changeFlags[\"loseDexToAC\"]) {\n        acAblMod = Math.min(acAblMod, 0);\n        acTouchAblMod = Math.min(acTouchAblMod, 0);\n      }\n      const maxDex = attributes.maxDexBonus ?? null;\n      const ac = {\n        normal: maxDex !== null ? Math.min(maxDex, acAblMod) : acAblMod,\n        touch: maxDex !== null ? Math.min(maxDex, acTouchAblMod) : acTouchAblMod,\n        flatFooted: Math.min(0, acAblMod),\n      };\n      const acAblKey = {\n        normal: acAbl,\n        touch: acTouchAbl,\n        flatFooted: acAbl,\n      };\n      const cmd = {\n        total: cmdDexAblMod,\n        flatFootedTotal: Math.min(0, cmdDexAblMod),\n      };\n      for (const [k, v] of Object.entries(ac)) {\n        attributes.ac[k].total += v;\n        getSourceInfo(this.sourceInfo, `system.attributes.ac.${k}.total`).positive.push({\n          value: v,\n          name: ffd20.config.abilities[acAblKey[k]],\n        });\n      }\n      for (const [k, v] of Object.entries(cmd)) {\n        attributes.cmd[k] += v;\n        getSourceInfo(this.sourceInfo, `system.attributes.cmd.${k}`).positive.push({\n          value: v,\n          name: ffd20.config.abilities[cmdDexAbl],\n        });\n      }\n    }\n\n    // Reduce final speed under certain circumstances\n    {\n      let reducedSpeed = false;\n      const sInfo = { name: \"\", value: game.i18n.localize(\"FFD20.ReducedMovementSpeed\") };\n\n      // from encumbrance\n      const encLevel = attributes.encumbrance.level;\n      if (encLevel > 0) {\n        const encLevels = ffd20.config.encumbranceLevels;\n        if (encLevel >= encLevels.heavy) {\n          if (!this.changeFlags.noHeavyEncumbrance) {\n            reducedSpeed = true;\n            sInfo.name = game.i18n.localize(\"FFD20.HeavyEncumbrance\");\n          }\n        } else if (encLevel >= encLevels.medium) {\n          if (!this.changeFlags.noMediumEncumbrance) {\n            reducedSpeed = true;\n            sInfo.name = game.i18n.localize(\"FFD20.MediumEncumbrance\");\n          }\n        }\n      }\n\n      const armor = { type: 0 };\n      const eqData = this.equipment;\n      if (eqData) this._prepareArmorData(eqData.armor, armor);\n\n      // Wearing heavy armor\n      if (armor.type == ffd20.config.armorTypes.heavy && !this.changeFlags.heavyArmorFullSpeed) {\n        reducedSpeed = true;\n        sInfo.name = game.i18n.localize(\"FFD20.Subtypes.Item.equipment.armor.Types.heavy\");\n      }\n      // Wearing medium armor\n      else if (armor.type == ffd20.config.armorTypes.medium && !this.changeFlags.mediumArmorFullSpeed) {\n        reducedSpeed = true;\n        sInfo.name = game.i18n.localize(\"FFD20.Subtypes.Item.equipment.armor.Types.medium\");\n      }\n\n      for (const speedKey of Object.keys(this.system.attributes.speed)) {\n        const speedValue = this.system.attributes.speed[speedKey].total;\n        // Save speed unaffected by speed maluses here (not counting negative changes)\n        // TODO: Somehow make this ignore additional set operators\n        this.system.attributes.speed[speedKey].unhindered = speedValue; // @since PF1 v10\n\n        if (reducedSpeed && speedValue > 0) {\n          this.system.attributes.speed[speedKey].total = this.constructor.getReducedMovementSpeed(speedValue);\n          getSourceInfo(this.sourceInfo, `system.attributes.speed.${speedKey}.total`).negative.push(sInfo);\n        }\n      }\n    }\n\n    // Add encumbrance source details\n    let encACPPenalty = null,\n      encMaxDex = null;\n    switch (attributes.encumbrance.level) {\n      case ffd20.config.encumbranceLevels.medium: {\n        encACPPenalty = 3;\n        encMaxDex = 3;\n        break;\n      }\n      case ffd20.config.encumbranceLevels.heavy: {\n        encACPPenalty = 6;\n        encMaxDex = 1;\n        break;\n      }\n    }\n    const encLabel = game.i18n.localize(\"FFD20.Encumbrance\");\n    if (encACPPenalty !== null) {\n      getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.push({\n        name: encLabel,\n        value: encACPPenalty,\n      });\n    }\n    if (encMaxDex !== null) {\n      getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.push({\n        name: encLabel,\n        value: encMaxDex,\n      });\n      let maxDexLabel = new Intl.NumberFormat(undefined, { signDisplay: \"always\" }).format(encMaxDex);\n      maxDexLabel = `${game.i18n.localize(\"FFD20.MaxDexShort\")} ${maxDexLabel}`;\n      getSourceInfo(this.sourceInfo, \"system.attributes.ac.normal.total\").negative.push({\n        name: encLabel,\n        value: maxDexLabel,\n        valueAsNumber: encMaxDex,\n      });\n      getSourceInfo(this.sourceInfo, \"system.attributes.ac.touch.total\").negative.push({\n        name: encLabel,\n        value: maxDexLabel,\n        valueAsNumber: encMaxDex,\n      });\n    }\n\n    // Enable senses based on flags\n    const senses = this.system.traits.senses;\n    senses.ll.enabled ||= this.changeFlags.lowLightVision;\n    senses.si ||= this.changeFlags.seeInvisibility;\n    senses.sid ||= this.changeFlags.seeInDarkness;\n\n    this.updateSpellbookInfo();\n  }\n\n  /**\n   * Returns this actor's labels for use with sheets.\n   *\n   * @protected\n   * @returns {Record<string, string>} - Label object\n   */\n  getLabels() {\n    const labels = {};\n\n    labels.alignment = ffd20.config.alignments[this.system.details.alignment];\n\n    // Speed\n    labels.speed = {};\n    for (const [key, obj] of Object.entries(this.system.attributes.speed ?? {})) {\n      const dist = ffd20.utils.convertDistance(obj.total);\n      labels.speed[key] = `${dist[0]} ${ffd20.config.measureUnitsShort[dist[1]]}`;\n    }\n\n    return labels;\n  }\n\n  /**\n   * Computes armor penalties for this actor.\n   *\n   * @internal\n   * @returns {MobilityPenaltyResult} The resulting penalties from armor.\n   */\n  _applyArmorPenalties() {\n    let attackACPPenalty = 0; // ACP to attack penalty from lacking proficiency. Stacks infinitely.\n    const acp = { armor: 0, shield: 0 };\n    const broken = { armor: { value: 0, item: null }, shield: { value: 0, item: null } };\n    const mdex = { armor: null, shield: null };\n\n    const equipment = this.itemTypes.equipment;\n    for (const item of equipment) {\n      if (!item.system.equipped) continue;\n\n      const eqType = item.system.subType;\n      const isShieldOrArmor = [\"armor\", \"shield\"].includes(eqType);\n      let itemACP = Math.abs(item.system.armor.acp);\n      if (item.system.masterwork === true && isShieldOrArmor) itemACP = Math.max(0, itemACP - 1);\n\n      if (isShieldOrArmor) {\n        itemACP = Math.max(0, itemACP + (this.system.attributes?.acp?.[`${eqType}Bonus`] ?? 0));\n      }\n\n      if (itemACP) {\n        if (item.isBroken) {\n          broken[eqType].value = itemACP;\n          broken[eqType].item = item;\n\n          const bsInfo = getSourceInfo(this.sourceInfo, \"system.attributes.acp.skill\").negative.find(\n            (o) => o.itemId === item.id\n          );\n          if (bsInfo) bsInfo.value = itemACP;\n          else {\n            getSourceInfo(this.sourceInfo, \"system.attributes.acp.skill\").negative.push({\n              name: `${item.name} (${game.i18n.localize(\"FFD20.Broken\")})`,\n              itemId: item.id,\n              value: itemACP,\n            });\n          }\n        }\n\n        const sInfo = getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.find(\n          (o) => o.itemId === item.id\n        );\n\n        if (sInfo) sInfo.value = itemACP;\n        else {\n          getSourceInfo(this.sourceInfo, \"system.attributes.acp.total\").negative.push({\n            name: item.name,\n            itemId: item.id,\n            value: itemACP,\n          });\n        }\n      }\n\n      if (isShieldOrArmor) {\n        if (itemACP > acp[eqType]) acp[eqType] = itemACP;\n        if (!item.getProficiency(false)) attackACPPenalty += itemACP;\n      }\n\n      if (item.system.armor.dex !== null && isShieldOrArmor) {\n        const mDex = item.system.armor.dex;\n        if (Number.isInteger(mDex)) {\n          const mod = this.system.attributes?.mDex?.[`${eqType}Bonus`] ?? 0;\n          const itemMDex = mDex + mod;\n          mdex[eqType] = Math.min(itemMDex, mdex[eqType] ?? Number.POSITIVE_INFINITY);\n\n          const sInfo = getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.find(\n            (o) => o.itemId === item.id\n          );\n          if (sInfo) sInfo.value = itemMDex;\n          else {\n            getSourceInfo(this.sourceInfo, \"system.attributes.maxDexBonus\").negative.push({\n              name: item.name,\n              itemId: item.id,\n              value: itemMDex,\n              ignoreNull: false,\n            });\n          }\n\n          // Add max dex to AC, too.\n          let maxDexLabel = new Intl.NumberFormat(undefined, { signDisplay: \"always\" }).format(itemMDex);\n          maxDexLabel = `${game.i18n.localize(\"FFD20.MaxDexShort\")} ${maxDexLabel}`;\n          for (const p of [\"system.attributes.ac.normal.total\", \"system.attributes.ac.touch.total\"]) {\n            // Use special maxDex id to ensure only the worst is shown\n            const sInfoA = getSourceInfo(this.sourceInfo, p).negative.find((o) => o.id === \"maxDexEq\");\n            if (sInfoA) {\n              if (itemMDex < sInfoA.valueAsNumber) {\n                sInfoA.value = maxDexLabel;\n                sInfoA.valueAsNumber = itemMDex;\n                sInfoA.itemId = item.id;\n                sInfoA.name = item.name;\n              } else if (sInfoA.itemId == item.id) {\n                // Update existing (armor training or the like)\n                sInfoA.value = maxDexLabel;\n                sInfoA.valueAsNumber = itemMDex;\n              }\n            } else {\n              getSourceInfo(this.sourceInfo, p).negative.push({\n                name: item.name,\n                value: maxDexLabel,\n                valueAsNumber: itemMDex,\n                itemId: item.id,\n                id: \"maxDexEq\",\n              });\n            }\n          }\n        }\n      }\n    }\n\n    // Add Broken to sources\n    for (const eqType of Object.keys(broken)) {\n      const value = broken[eqType].value;\n      if (value == 0) continue;\n      const brokenId = broken[eqType].item.id;\n      const sInfo = getSourceInfo(this.sourceInfo, `system.attributes.acp.${eqType}Bonus`).negative.find(\n        (o) => o.brokenId === brokenId\n      );\n      if (sInfo) sInfo.value = value;\n      else\n        getSourceInfo(this.sourceInfo, `system.attributes.acp.${eqType}Bonus`).negative.push({\n          name: `${broken[eqType].item.name} (${game.i18n.localize(\"FFD20.Broken\")})`,\n          brokenId,\n          value,\n        });\n    }\n\n    // Return result\n    const totalACP = acp.armor + acp.shield;\n    const result = {\n      maxDexBonus: null,\n      acp: totalACP,\n      acpSkill: totalACP + broken.armor.value + broken.shield.value,\n    };\n    this.system.attributes.acp.gear = totalACP;\n    if (mdex.armor !== null || mdex.shield !== null)\n      result.maxDexBonus = Math.min(mdex.armor ?? Number.POSITIVE_INFINITY, mdex.shield ?? Number.POSITIVE_INFINITY);\n\n    // Set armor penalty to attack rolls\n    this.system.attributes.acp.attackPenalty = attackACPPenalty;\n\n    return result;\n  }\n\n  /**\n   * @internal\n   */\n  prepareItemLinks() {\n    for (const item of this.items) {\n      const links = item.system.links;\n      if (!links) continue;\n\n      for (const type of Object.keys(links)) {\n        for (const link of links[type]) {\n          // HACK: fromUuid[Sync]() causes recursive synth actor initialization at world launch, so we do this instead\n          if (!link.uuid) {\n            console.warn(`\"${item.name}\" on \"${this.name}\" has invalid link in \"${type}\"`, { link, item });\n            continue;\n          }\n          const linkData = foundry.utils.parseUuid(link.uuid, { relative: this });\n          const linkedItem = this.items.get(linkData?.id);\n          if (!linkedItem) continue; // Ignore items not on current actor\n\n          switch (type) {\n            case \"charges\": {\n              linkedItem.links.charges = item;\n              linkedItem.prepareLinks();\n              break;\n            }\n            case \"children\": {\n              linkedItem.links.parent = item;\n              break;\n            }\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * @deprecated - Use {@link getSourceDetails()} instead.\n   * @type {object}\n   */\n  get sourceDetails() {\n    foundry.utils.logCompatibilityWarning(\n      \"ActorPF.sourceDetails is deprecated in favor of ActorPF.getSourceDetails()\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n\n    const actor = this;\n\n    // Redirect to getSourceDetails()\n    const sourceDetailsHandler = {\n      get(_, prop) {\n        return actor.getSourceDetails(prop);\n      },\n    };\n\n    return new Proxy({}, sourceDetailsHandler);\n  }\n\n  /**\n   * Retrieve source details regarding a change target.\n   *\n   * @example\n   * ```js\n   * actor.getSourceDetails(\"system.attributes.hp.max\");\n   * ```\n   * @todo - Merge `sourceInfo` into the change system to reduce underlying system complexity\n   * @param {string} path - Change target path\n   * @returns {SourceInfo[]}\n   */\n  getSourceDetails(path) {\n    const sources = [];\n\n    const dexDenied = this.changeFlags.loseDexToAC === true;\n\n    // Add extra data\n    const rollData = this.getRollData();\n    const changeGrp = this.sourceInfo[path] ?? {};\n    const sourceGroups = Object.values(changeGrp);\n\n    const typeBonuses = {};\n\n    for (const grp of sourceGroups) {\n      for (const src of grp) {\n        src.operator ||= \"add\";\n        let srcValue =\n          src.value != null\n            ? src.value\n            : RollPF.safeRollSync(src.formula || \"0\", rollData, [path, src, this], {\n                suppressError: !this.isOwner,\n              }).total;\n        if (src.operator === \"set\") {\n          let displayValue = srcValue;\n          if (src.change?.isDistance) displayValue = ffd20.utils.convertDistance(displayValue)[0];\n          srcValue = game.i18n.format(\"FFD20.SetTo\", { value: displayValue });\n        }\n\n        // Add sources only if they actually add something else than zero\n        if (!(src.operator === \"add\" && srcValue === 0) || src.ignoreNull === false) {\n          // Account for dex denied denying dodge bonuses\n          if (dexDenied && srcValue > 0 && src.modifier === \"dodge\" && src.operator === \"add\" && src.change?.isAC)\n            continue;\n\n          // TODO: Separate source name from item type label\n          const label = this.constructor._getSourceLabel(src);\n          const info = { name: label.replace(/[[\\]]/g, \"\"), value: srcValue, modifier: src.modifier || null };\n          if (src.id) info.id = src.id;\n          typeBonuses[src.modifier || \"untyped\"] ??= [];\n          typeBonuses[src.modifier || \"untyped\"].push(info);\n          sources.push(info);\n        }\n      }\n    }\n\n    // Sort and disable entries\n    const stacking = new Set(ffd20.config.stackingBonusTypes);\n    for (const [type, entries] of Object.entries(typeBonuses)) {\n      if (stacking.has(type)) continue;\n      entries.sort((a, b) => b.value - a.value);\n      for (const entry of entries) {\n        entry.disabled = entry.value >= 0 || typeof entry.value !== \"number\";\n      }\n      entries[0].disabled = false;\n    }\n\n    return sources;\n  }\n\n  /**\n   * @internal\n   * @returns {Record<string,*>} - Path to value mapping\n   */\n  _getInherentTotalsKeys() {\n    // Determine base keys\n    const keys = {\n      \"attributes.ac.normal.total\": 10,\n      \"attributes.ac.touch.total\": 10,\n      \"attributes.ac.flatFooted.total\": 10,\n      \"attributes.bab.total\": 0,\n      \"attributes.cmd.total\": 10,\n      \"attributes.cmd.flatFootedTotal\": 10,\n      \"attributes.acp.armorBonus\": 0,\n      \"attributes.acp.shieldBonus\": 0,\n      \"attributes.acp.gear\": 0,\n      \"attributes.acp.encumbrance\": 0,\n      \"attributes.acp.total\": 0,\n      \"attributes.acp.skill\": 0,\n      \"attributes.acp.attackPenalty\": 0,\n      \"attributes.maxDexBonus\": null,\n      \"ac.normal.total\": 0,\n      \"ac.normal.base\": 0,\n      \"ac.normal.enh\": 0,\n      \"ac.normal.misc\": 0,\n      \"ac.natural.total\": 0,\n      \"ac.natural.base\": 0,\n      \"ac.natural.misc\": 0,\n      \"ac.natural.enh\": 0,\n      \"ac.shield.total\": 0,\n      \"ac.shield.base\": 0,\n      \"ac.shield.enh\": 0,\n      \"ac.shield.misc\": 0,\n      \"attributes.sr.total\": 0,\n      \"attributes.init.bonus\": 0,\n      \"attributes.init.total\": this.system.attributes.init.value ?? 0,\n      \"attributes.cmb.bonus\": 0,\n      \"attributes.cmb.total\": 0,\n      \"attributes.cmb.value\": 0,\n      \"attributes.hp.max\": this.system.attributes.hp.base ?? 0,\n      \"attributes.vigor.max\": this.system.attributes.vigor.base ?? 0,\n      \"attributes.wounds.max\": this.system.attributes.wounds.base ?? 0,\n      \"attributes.wounds.threshold\": 0,\n      \"attributes.mp.max\": this.system.attributes.mp.base ?? 0,\n      \"attributes.mp.recover\": 0,\n      \"attributes.attack.general\": 0,\n      \"attributes.attack.melee\": 0,\n      \"attributes.attack.natural\": 0,\n      \"attributes.attack.ranged\": 0,\n      \"attributes.attack.thrown\": 0,\n      \"attributes.attack.shared\": 0,\n      \"attributes.attack.critConfirm\": 0,\n      \"attributes.mDex\": { armorBonus: 0, shieldBonus: 0 },\n      \"attributes.damage.general\": 0,\n      \"attributes.damage.weapon\": 0,\n      \"attributes.damage.natural\": 0,\n      \"attributes.damage.melee\": 0, // Melee weapon\n      \"attributes.damage.meleeAll\": 0,\n      \"attributes.damage.ranged\": 0, // Ranged weapon\n      \"attributes.damage.rangedAll\": 0,\n      \"attributes.damage.thrown\": 0, // Thrown weapon\n      \"attributes.damage.spell\": 0,\n      \"attributes.damage.shared\": 0,\n      \"attributes.woundThresholds.level\": 0,\n      \"attributes.woundThresholds.mod\": 0,\n      \"attributes.woundThresholds.penaltyBase\": 0,\n      \"attributes.woundThresholds.penalty\": 0,\n      \"abilities.str.checkMod\": 0,\n      \"abilities.str.total\": 0,\n      \"abilities.str.undrained\": 0,\n      \"abilities.dex.checkMod\": 0,\n      \"abilities.dex.total\": 0,\n      \"abilities.dex.undrained\": 0,\n      \"abilities.con.checkMod\": 0,\n      \"abilities.con.total\": 0,\n      \"abilities.con.undrained\": 0,\n      \"abilities.int.checkMod\": 0,\n      \"abilities.int.total\": 0,\n      \"abilities.int.undrained\": 0,\n      \"abilities.wis.checkMod\": 0,\n      \"abilities.wis.total\": 0,\n      \"abilities.wis.undrained\": 0,\n      \"abilities.cha.checkMod\": 0,\n      \"abilities.cha.total\": 0,\n      \"abilities.cha.undrained\": 0,\n      \"attributes.spells.spellbooks.primary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.secondary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.tertiary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.quaternary.concentration.total\": 0,\n      \"attributes.spells.spellbooks.spelllike.concentration.total\": 0,\n      \"attributes.spells.spellbooks.primary.cl.total\": 0,\n      \"attributes.spells.spellbooks.secondary.cl.total\": 0,\n      \"attributes.spells.spellbooks.tertiary.cl.total\": 0,\n      \"attributes.spells.spellbooks.quaternary.cl.total\": 0,\n      \"attributes.spells.spellbooks.spelllike.cl.total\": 0,\n      \"details.carryCapacity.bonus.total\": 0,\n      \"details.carryCapacity.multiplier.total\": 0,\n      \"details.feats.bonus\": 0,\n      \"details.skills.bonus\": 0,\n      \"attributes.speed.land.add\": 0,\n      \"attributes.speed.swim.add\": 0,\n      \"attributes.speed.fly.add\": 0,\n      \"attributes.speed.climb.add\": 0,\n      \"attributes.speed.burrow.add\": 0,\n      \"attributes.savingThrows.fort.total\": this.system.attributes.savingThrows.fort.base ?? 0,\n      \"attributes.savingThrows.ref.total\": this.system.attributes.savingThrows.ref.base ?? 0,\n      \"attributes.savingThrows.will.total\": this.system.attributes.savingThrows.will.base ?? 0,\n    };\n\n    // Determine skill keys\n    try {\n      const skillKeys = getChangeFlat(this, \"skills\");\n      for (const k of skillKeys) {\n        keys[k.replace(/^system\\./, \"\")] = 0;\n      }\n    } catch (err) {\n      console.error(\"Could not determine skills for an actor\", this, err);\n    }\n\n    return keys;\n  }\n\n  /**\n   * Data to reset base value of, but only if missing.\n   *\n   * @private\n   * @see {@link _resetInherentTotals}\n   * @returns {Record<string,number>} - Base fill keys\n   */\n  _getBaseValueFillKeys() {\n    return [\n      { parent: \"abilities.str\", key: \"base\", value: 0 },\n      { parent: \"abilities.dex\", key: \"base\", value: 0 },\n      { parent: \"abilities.con\", key: \"base\", value: 0 },\n      { parent: \"abilities.int\", key: \"base\", value: 0 },\n      { parent: \"abilities.wis\", key: \"base\", value: 0 },\n      { parent: \"abilities.cha\", key: \"base\", value: 0 },\n    ];\n  }\n\n  /**\n   * @protected\n   */\n  _resetInherentTotals() {\n    const keys = this._getInherentTotalsKeys();\n\n    // Reset totals\n    for (const [k, v] of Object.entries(keys)) {\n      try {\n        foundry.utils.setProperty(this.system, k, v);\n      } catch (err) {\n        console.error(err, k);\n      }\n    }\n\n    for (const data of this._getBaseValueFillKeys()) {\n      const { parent, key, value } = data;\n      const o = foundry.utils.getProperty(this.system, parent);\n      if (!o) continue; // Not all actor types have these\n      o[key] ??= value;\n    }\n  }\n\n  /**\n   * Return reduced movement speed.\n   *\n   * @example\n   * ```js\n   * ffd20.documents.actor.ActorPF.getReducedMovementSpeed(30); // => 20\n   * ```\n   *\n   * @param {number} value - The non-reduced movement speed.\n   * @returns {number} The reduced movement speed.\n   */\n  static getReducedMovementSpeed(value) {\n    return value - Math.floor(value / 5 / 3) * 5;\n  }\n\n  /**\n   * Return increased amount of spell slots by ability score modifier.\n   *\n   * @example\n   * ```js\n   * ffd20.documents.actor.ActorPF.getSpellSlotIncrease(2, 1); // => 1\n   * ffd20.documents.actor.ActorPF.getSpellSlotIncrease(6, 1); // => 2\n   * ffd20.documents.actor.ActorPF.getSpellSlotIncrease(6, 7); // => 0\n   * ```\n   *\n   * @param {number} mod - The associated ability modifier.\n   * @param {number} level - Spell level.\n   * @returns {number} Amount of spell levels to increase.\n   */\n  static getSpellSlotIncrease(mod, level) {\n    if (level === 0) return 0;\n    if (mod <= 0) return 0;\n    return Math.max(0, Math.ceil((mod + 1 - level) / 4));\n  }\n\n  /**\n   * Return the amount of experience required to gain a certain character level.\n   *\n   * @abstract\n   * @param {number} level - The desired level\n   * @returns {number} - The XP required\n   */\n  // eslint-disable-next-line no-unused-vars\n  getLevelExp(level) {\n    return 0; // Only used by PCs\n  }\n\n  /**\n   * Create a new Token document, not yet saved to the database, which represents the Actor, and apply actor size to it.\n   *\n   * @override\n   * @param {object} [data={}]            Additional data, such as x, y, rotation, etc. for the created token data\n   * @param {object} [options={}]         The options passed to the TokenDocument constructor\n   * @returns {Promise<TokenDocumentPF>}  The created TokenDocument instance\n   */\n  async getTokenDocument(data = {}, options = {}) {\n    if (!this.prototypeToken.flags?.ffd20?.staticSize) {\n      const size = Object.values(ffd20.config.tokenSizes)[this.getRollData({ refresh: true }).size];\n      if (size) {\n        foundry.utils.mergeObject(data, {\n          width: size.w,\n          height: size.h,\n          texture: {\n            scaleX: size.scale * (this.prototypeToken.texture.scaleX || 1),\n            scaleY: size.scale * (this.prototypeToken.texture.scaleY || 1),\n          },\n        });\n      }\n    }\n\n    return super.getTokenDocument(data, options);\n  }\n\n  /* -------------------------------------------- */\n\n  /* -------------------------------------------- */\n  /*  Socket Listeners and Handlers\n  /* -------------------------------------------- */\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return; // No system updates.\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    const oldData = this.system;\n\n    // Offset HP values\n    const attributes = changed.system.attributes;\n    if (attributes) {\n      for (const key of [\"hp\", \"wounds\", \"vigor\"]) {\n        const hp = attributes[key];\n        if (!hp) continue;\n        if (hp.value !== undefined && hp.offset === undefined) {\n          const max = hp.max ?? oldData.attributes[key]?.max ?? 0;\n          hp.offset = hp.value - max;\n        }\n        // Do not ever keep .value\n        delete hp.value;\n      }\n\n      // Offset MP values\n      for (const key of [\"mp\"]) {\n        const mp = attributes[key];\n        if (!mp) continue;\n        if (mp.value !== undefined && mp.offset === undefined) {\n          const max = mp.max ?? oldData.attributes[key]?.max ?? 0;\n          mp.offset = mp.value - max;\n        }\n        // Do not ever keep .value\n        delete mp.value;\n      }\n\n      // Convert excess vigor damage to wounds\n      const vigor = attributes.vigor;\n      if (vigor?.offset < 0) {\n        const maxVigor = oldData.attributes.vigor.max;\n        const excessVigorDamage = -(maxVigor + vigor.offset);\n        if (excessVigorDamage > 0) {\n          attributes.wounds ??= {};\n          attributes.wounds.offset ??= oldData.attributes?.wounds?.offset ?? 0;\n          attributes.wounds.offset -= excessVigorDamage;\n          vigor.offset = -maxVigor;\n        }\n      }\n    }\n\n    if (changed.system.attributes?.quadruped !== undefined) {\n      const quad = changed.system.attributes.quadruped;\n      const quadRace = this.race?.system.quadruped ?? false;\n      // Null if setting quadruped to same as race (no override)\n      if (quad === quadRace) changed.system.attributes.quadruped = null;\n    }\n\n    // Make certain variables absolute\n    const abilities = changed.system.abilities;\n    if (abilities) {\n      const absoluteKeys = [\"userPenalty\", \"damage\", \"drain\"];\n      const keys = Object.keys(abilities);\n      for (const abl of keys) {\n        const ablData = abilities[abl];\n        if (!ablData) continue; // e.g. if null from being deleted for homebrew\n        for (const absKey of absoluteKeys) {\n          if (ablData[absKey] !== undefined) {\n            ablData[absKey] = Math.abs(ablData[absKey]);\n          }\n        }\n      }\n    }\n\n    const energyDrain = changed.system.attributes?.energyDrain;\n    if (energyDrain !== undefined) {\n      changed.system.attributes.energyDrain = Math.abs(energyDrain);\n    }\n\n    // Never allow updates to the new conditions location\n    if (changed.system.conditions !== undefined) {\n      delete changed.system.conditions;\n    }\n\n    // Adjust spellbook data\n    const books = changed.system.attributes?.spells?.spellbooks;\n    if (books) {\n      const cbooks = this.system.attributes?.spells?.spellbooks;\n      for (const [bookId, bookData] of Object.entries(books)) {\n        const prepMode = bookData.spellPreparationMode;\n        if (prepMode !== cbooks[bookId].spellPreparationMode) {\n          const prog = bookData.casterType || cbooks[bookId].casterType;\n          const progs = ffd20.config.casterProgression.castsPerDay[prepMode] ?? {};\n          // Reset invalid progression to first choice\n          if (!progs[prog]) bookData.casterType = Object.keys(progs)[0];\n        }\n      }\n    }\n\n    this._detectHealthChange(changed, context);\n  }\n\n  /**\n   * Detect Health Changes\n   *\n   * Builds data for post-update handling of deltas, stored in `context.ffd20.deltas`.\n   *\n   * @internal\n   * @abstract\n   * @param {object} changed\n   * @param {object} context\n   */\n  _detectHealthChange(changed, context) {}\n\n  /**\n   * Synchronize actor and token vision\n   *\n   * @internal\n   * @param {boolean} initializeVision - Initialize vision\n   * @param {boolean} refreshLighting - Refresh lightning\n   */\n  updateVision(initializeVision = false, refreshLighting = false) {\n    if (!this.testUserPermission(game.user, \"OBSERVER\")) return;\n\n    const visionUpdate = {\n      refreshLighting: true,\n      refreshVision: true,\n    };\n\n    let tokens = this.getActiveTokens(false, true).filter((t) => t.sight.enabled);\n    const needSelection = game.settings.get(\"ffd20\", \"lowLightVisionMode\");\n    if (needSelection) tokens = tokens.filter((t) => t.object?.controlled ?? false);\n\n    // Skip refresh if no tokens with vision present on scene\n    if (tokens.length == 0) return;\n\n    // Ensure vision immediately updates\n    if (initializeVision) {\n      for (const token of tokens) {\n        token._syncSenses();\n      }\n      visionUpdate.initializeVision = true;\n    }\n\n    // Ensure LLV functions correctly\n    if (refreshLighting) {\n      visionUpdate.initializeLighting = true;\n    }\n\n    canvas.perception.update(visionUpdate);\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - User ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    // No system data updated\n    if (!changed.system) return;\n\n    const sourceUser = game.user.id === userId;\n\n    let initializeVision = false,\n      refreshLighting = false;\n\n    if (foundry.utils.hasProperty(changed.system, \"traits.senses\")) {\n      initializeVision = true;\n      if (changed.system.traits.senses.ll) {\n        refreshLighting = true;\n      }\n    } else if (changed.flags?.ffd20?.visionSharing) {\n      initializeVision = true;\n      refreshLighting = true;\n    }\n\n    if (initializeVision || refreshLighting) {\n      this.updateVision(initializeVision, refreshLighting);\n    }\n\n    // Handle base size change\n    // TODO: Combine this test with testing updated items to reduce updates\n    if (sourceUser && changed?.system?.traits?.size) {\n      this._updateTokenSize();\n    }\n  }\n\n  /**\n   * Resize token sizes based on actor size.\n   *\n   * Ignores tokens with static size set.\n   *\n   * @todo Add option to update token size on all scenes.\n   *\n   * @internal\n   * @param {string} [sizeKey] - Size key to update to. If not provided, will use actor's current size.\n   * @returns {Promise<TokenDocument[]|null>} - Updated token documents, or null if no update was performed.\n   * @throws {Error} - On invalid parameters\n   */\n  async _updateTokenSize(sizeKey = undefined) {\n    const scene = canvas.scene;\n    if (!scene) return null;\n\n    if (!sizeKey) {\n      const sizes = Object.keys(ffd20.config.tokenSizes);\n      sizeKey = sizes[this.getRollData({ refresh: true }).size];\n      if (sizeKey === undefined) return;\n    }\n\n    const size = ffd20.config.tokenSizes[sizeKey];\n    if (!size) throw new Error(`Size key \"${sizeKey}\" is invalid`);\n\n    // Get relevant tokens\n    const tokens = (this.token ? [this.token] : this.getActiveTokens(false, true)).filter(\n      (token) => !token.getFlag(\"ffd20\", \"staticSize\")\n    );\n\n    const { scaleX, scaleY } = this.prototypeToken?.texture ?? {};\n\n    const updates = tokens.map((t) => ({\n      _id: t.id,\n      width: size.w,\n      height: size.h,\n      texture: {\n        scaleX: size.scale * (scaleX || 1),\n        scaleY: size.scale * (scaleY || 1),\n      },\n    }));\n\n    if (!updates.length) return;\n\n    return TokenDocument.implementation.updateDocuments(updates, { parent: scene });\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {Item|Actor} parent - Parent document\n   * @param {\"items\"|\"effects\"} collection - Collection name\n   * @param {Item[]|ActiveEffect[]} documents - Created documents\n   * @param {object[]} result - Creation data for the documents\n   * @param {object} context - Create context options\n   * @param {string} userId - Triggering user's ID\n   */\n  _onCreateDescendantDocuments(parent, collection, documents, result, context, userId) {\n    super._onCreateDescendantDocuments(...arguments);\n\n    if (userId !== game.user.id) return;\n\n    if (collection === \"items\") {\n      // Apply race size to actor\n      const race = documents.find((d) => d.type === \"race\");\n      if (race?.system.size) {\n        if (this.system.traits.size !== race.system.size) this.update({ \"system.traits.size\": race.system.size });\n      }\n    }\n\n    if (collection === \"effects\") {\n      if (context.ffd20?.updateConditionTracks !== false) {\n        this._handleConditionTracks(documents, context);\n      }\n    }\n  }\n\n  /**\n   * Handle condition track toggling post active effect creation if there's still some issues.\n   *\n   * @internal\n   * @param {ActiveEffect[]} documents - Updated active effect documents\n   * @returns {Promise<object>} - Result from {@link ActorPF.setConditions}\n   */\n  async _handleConditionTracks(documents) {\n    // Record of previously update conditions that didn't get notified about\n    const previousConditions = {};\n\n    const conditions = {};\n    const tracks = ffd20.registry.conditions.trackedConditions();\n    for (const ae of documents) {\n      for (const statusId of ae.statuses ?? []) {\n        // Skip non-conditions\n        if (!ffd20.registry.conditions.has(statusId)) continue;\n\n        // Mark this condition for notification\n        previousConditions[statusId] = true;\n\n        // Process condition tracks\n        for (const conditionGroup of tracks) {\n          if (!conditionGroup.includes(statusId)) continue;\n          // Disable other conditions in the track\n          for (const disableConditionId of conditionGroup) {\n            if (disableConditionId === statusId) continue;\n            conditions[disableConditionId] = false;\n          }\n        }\n      }\n    }\n\n    this._conditionToggleNotify(previousConditions);\n\n    if (!foundry.utils.isEmpty(conditions)) {\n      return this.setConditions(conditions);\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {*} parent - Parent document\n   * @param {\"items\"|\"effects\"} collection - Collection name\n   * @param {Item|ActiveEffect[]} documents - Document array\n   * @param {string[]} ids - Document ID array\n   * @param {object} context - Delete context\n   * @param {string} userId - User ID\n   */\n  _onDeleteDescendantDocuments(parent, collection, documents, ids, context, userId) {\n    super._onDeleteDescendantDocuments(parent, collection, documents, ids, context, userId);\n\n    if (collection === \"effects\") {\n      const updatedConditions = {};\n      for (const ae of documents) {\n        for (const statusId of ae.statuses ?? []) {\n          // Toggle off only if it's valid ID and there isn't any other AEs that have same condition still\n          if (ffd20.registry.conditions.has(statusId) && !this.statuses.has(statusId)) {\n            updatedConditions[statusId] = false;\n          }\n        }\n      }\n\n      if (context?.ffd20?.updateConditionTracks !== false) {\n        this._conditionToggleNotify(updatedConditions);\n      }\n    }\n\n    // Following process is done only on triggering user\n    if (game.user.id !== userId) return;\n\n    if (collection === \"items\") {\n      this._cleanItemLinksTo(documents);\n\n      // Delete child linked items\n      const toRemove = new Set();\n\n      // Remove linked children with item\n      const _enumChildren = (item) => {\n        toRemove.add(item.id);\n\n        const links = item.getLinkedItemsSync(\"children\");\n        for (const link of links) {\n          if (toRemove.has(link.id)) continue;\n          const child = item.actor.items.get(link.id);\n          if (child) _enumChildren(child);\n        }\n      };\n\n      // Find children\n      for (const item of documents) _enumChildren(item);\n      // Remove already deleted items\n      for (const id of ids) toRemove.delete(id);\n\n      if (toRemove.size > 0) {\n        this.deleteEmbeddedDocuments(\"Item\", Array.from(toRemove));\n      }\n    }\n  }\n\n  /**\n   * @internal\n   * @param {ffd20.documents.item.ItemPF[]} items - Item documents to clean links to.\n   * @returns {Promise<Document[]>} - Updated documents\n   */\n  async _cleanItemLinksTo(items) {\n    const updates = [];\n    // Clean up references to this item\n    for (const deleted of items) {\n      const uuid = deleted.getRelativeUUID(this);\n      for (const item of this.items) {\n        const updateData = await item.removeItemLink(uuid, { commit: false });\n        if (updateData) {\n          updateData._id = item.id;\n          updates.push(updateData);\n        }\n      }\n    }\n\n    if (updates.length) {\n      return this.updateEmbeddedDocuments(\"Item\", updates);\n    }\n  }\n\n  /**\n   * @todo - The condition notification needs to be smarter.\n   *\n   * @internal\n   * @param {Record<string,boolean>} conditions - Condition toggle state\n   */\n  _conditionToggleNotify(conditions = {}) {\n    for (const [conditionId, state] of Object.entries(conditions)) {\n      Hooks.callAll(\"pf1ToggleActorCondition\", this, conditionId, state);\n    }\n  }\n\n  /**\n   * @internal\n   * @param {ItemPF} item - the item to add to the actor's resources\n   * @param {object} [options] - extra options\n   * @param {boolean} [options.warnOnDuplicate] - Skips warning if item tag already exists in dictionary flags\n   * @returns {boolean} True if resources were set\n   */\n\n  updateItemResources(item, { warnOnDuplicate = true } = {}) {\n    if (item.type === \"spell\") return false;\n    if (item.links?.charges) return false; // Don't create resource for items that are inheriting charges\n    if (!item.isCharged) return false;\n    if (item.isSingleUse) return false;\n    if (item.isPhysical) return false;\n\n    const tag = item.system.tag;\n    if (!tag) console.error(\"Attempting create resource on tagless item\", item);\n\n    if (warnOnDuplicate && this.system.resources[tag] && this.isOwner) {\n      const msg = game.i18n.format(\"FFD20.Warning.DuplicateTag\", {\n        actor: this.uuid,\n        item: item.name,\n        tag,\n      });\n      console.warn(msg, item);\n      ui.notifications?.warn(msg, { console: false });\n    }\n\n    const res = new Resource(item);\n    this.system.resources[tag] = res;\n\n    return true;\n  }\n\n  /* -------------------------------------------- */\n  /*  Rolls                                       */\n  /* -------------------------------------------- */\n\n  /**\n   * Enable and configure a new spellbook.\n   *\n   * @example\n   * Create spellbook for inquisitor\n   * ```js\n   * actor.createSpellbook({\n   *   type: \"spontaneous\",\n   *   progression: \"med\",\n   *   ability: \"wis\",\n   *   spells: \"divine\",\n   *   class: \"inquisitor\",\n   *   cantrips: true,\n   *   domain: 0\n   * });\n   * ```\n   *\n   * @param {object} [casting] - Book casting configuration\n   * @param {\"prepared\"|\"spontaneous\"|\"hybrid\"} [casting.type=\"prepared\"] - Spellbook type\n   * @param {\"high\"|\"med\"|\"low\"} [casting.progression=\"high\"] - Casting progression type\n   * @param {string} [casting.ability=\"int\"] - Spellcasting ability score ID\n   * @param {\"arcane\"|\"divine\"|\"psychic\"|\"alchemy\"} [casting.spells=\"arcane\"] - Spell/spellcasting type\n   * @param {string} [casting.class=\"_hd\"] - Class tag\n   * @param {boolean} [casting.cantrips=true] - Has cantrips?\n   * @param {number} [casting.domain=1] - Domain/School slots\n   * @param {number} [casting.offset] - Level offset\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.commit=true] - Commit modifications. If false, update data is returned instead of committing.\n   * @returns {Promise<this>} - Promise to updated document\n   */\n  createSpellbook(casting = {}, { commit = true } = {}) {\n    const books = this.system.attributes.spells.spellbooks ?? {};\n\n    const oldBook = casting.class\n      ? Object.entries(books).find(([_, book]) => !!book.class && book.class === casting.class)\n      : null;\n\n    let bookId;\n    if (oldBook) {\n      if (oldBook[1].inUse) return void ui.notifications.warn(game.i18n.localize(\"FFD20.Error.SpellbookExists\"));\n      bookId = oldBook[0]; // Reuse old book\n    } else {\n      const available = Object.entries(books).find(([_, bookData]) => bookData.inUse !== true);\n      if (available === undefined) return void ui.notifications.warn(game.i18n.localize(\"FFD20.Error.NoFreeSpellbooks\"));\n      bookId = available[0];\n    }\n\n    // Add defaults when unconfigured\n    // `class` causes problems if destructured, hence why it is here.\n    casting.type ??= \"prepared\";\n    casting.class ??= \"_hd\";\n    casting.progression ??= \"high\";\n    casting.spells ??= \"arcane\";\n    casting.ability ??= \"int\";\n    casting.cantrips ??= true;\n    casting.domain ??= 1;\n    casting.offset ??= 0;\n    if (casting.offset !== 0) casting.offset = `${casting.offset}`;\n\n    const updateData = {\n      [`system.attributes.spells.spellbooks.${bookId}`]: {\n        inUse: true,\n        kind: casting.spells,\n        class: casting.class,\n        spellPreparationMode: casting.type,\n        casterType: casting.progression,\n        ability: casting.ability,\n        psychic: casting.spells === \"psychic\",\n        arcaneSpellFailure: casting.spells === \"arcane\",\n        hasCantrips: casting.cantrips,\n        domainSlotValue: casting.domain,\n        \"cl.formula\": casting.offset ? `${casting.offset}` : \"\",\n      },\n    };\n\n    if (commit) return this.update(updateData);\n    else return updateData;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Retrieve information about a skill.\n   *\n   * @example\n   * ```js\n   * actor.getSkillInfo(\"per\"); // Perception skill info\n   * actor.getSkillInfo(\"crf.alchemy\"); // Craft (Alchemy) subskill info\n   * ```\n   *\n   * @param {string} skillId - Skill ID\n   * @param {object} [options] - Additional options\n   * @param {{ skills: Record<string, SkillData>}} [options.rollData] - Roll data instance to use.\n   * @throws {Error} - If defined skill is not found.\n   * @returns {SkillInfo} - Skill information\n   */\n  getSkillInfo(skillId, { rollData } = {}) {\n    const skillIdParts = skillId.split(\".\");\n    if (skillIdParts.length > 2) skillIdParts.splice(1, 1);\n\n    const mainSkillId = skillIdParts.shift(),\n      subSkillId = skillIdParts.pop(),\n      isSubSkill = !!subSkillId;\n\n    // Reconstruct skillId with new shorter version to ensure format\n    skillId = [mainSkillId, subSkillId].filterJoin(\".\");\n\n    rollData ??= this.getRollData();\n    const parentSkill = isSubSkill ? this.getSkillInfo(mainSkillId, { rollData }) : null;\n\n    /** @type {SkillInfo} */\n    const skill = subSkillId\n      ? parentSkill.subSkills?.[subSkillId]\n      : foundry.utils.deepClone(rollData.skills[mainSkillId]);\n\n    if (!skill) throw new Error(`Invalid skill ID '${skillId}'`);\n\n    skill.journal ||= ffd20.config.skillCompendiumEntries[isSubSkill ? mainSkillId : skillId];\n    skill.name ||= ffd20.config.skills[skillId] || skillId;\n    skill.id = skillId;\n\n    if (isSubSkill) {\n      skill.fullName = `${parentSkill.name} (${skill.name})`;\n      skill.parentSkill = parentSkill;\n    } else {\n      skill.fullName = skill.name;\n    }\n\n    return skill;\n  }\n\n  /**\n   * Roll a Skill Check\n   *\n   * @example\n   * ```js\n   * await actor.rollSkill(\"per\", { skipDialog: true, bonus: \"1d6\", dice: \"2d20kh\" });\n   * ```\n   *\n   * @param {string} skillId - The skill id (e.g. \"per\", \"prf.prf1\", or \"crf.alchemy\")\n   * @param {ActorRollOptions} [options={}] - Options which configure how the skill check is rolled\n   * @returns {Promise<ChatMessage|object|void>} - The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollSkill(skillId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const skillIdParts = skillId.split(\".\");\n    const mainSkillId = skillIdParts[0],\n      subSkillId = skillIdParts.length > 1 ? skillIdParts.at(-1) : null;\n    // Reconstruct skill ID to ensure it is valid for everything else.\n    skillId = subSkillId ? `${mainSkillId}.${subSkillId}` : mainSkillId;\n\n    const skl = this.getSkillInfo(skillId);\n    const haveParentSkill = !!subSkillId;\n\n    // Add context notes\n    const rollData = this.getRollData();\n    const notes = await this.getContextNotesParsed(`skill.${skillId}`, { rollData });\n    if (haveParentSkill)\n      notes.push(...(await this.getContextNotesParsed(`skill.${mainSkillId}`, { rollData, all: false })));\n\n    // Add untrained note\n    if (skl.rt && !skl.rank) {\n      notes.push({ text: game.i18n.localize(\"FFD20.Untrained\") });\n    }\n\n    // Add parts\n    const parts = [];\n\n    // Base parts\n    // Ability damage and penalty are not part of change system\n    const details = this.getSourceDetails(`system.abilities.${skl.ability}.mod`);\n    for (const { value, name } of details) {\n      parts.push(`${value}[${name}]`);\n    }\n\n    // Add Wound Thresholds info\n    if (rollData.attributes.woundThresholds?.penalty > 0) {\n      const label = ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level];\n      notes.push({ text: label });\n      parts.push(`- @attributes.woundThresholds.penalty[${label}]`);\n    }\n\n    // Gather changes\n    const skillDataPathPart = subSkillId ? `${mainSkillId}.subSkills.${subSkillId}` : mainSkillId;\n\n    const validChanges = this.changes.filter((/** @type {ItemChange} */ c) =>\n      c.getTargets(this).includes(`system.skills.${skillDataPathPart}.mod`)\n    );\n    const changes = getHighestChanges(validChanges, { ignoreTarget: true });\n\n    // Add changes\n    for (const c of changes) {\n      if (!c.value) continue;\n      // Hide complex change formulas in parenthesis.\n      if (typeof c.value === \"string\" && RollPF.parse(c.value).length > 1) {\n        parts.push(`(${c.value})[${c.flavor}]`);\n      } else {\n        parts.push(`${c.value}[${c.flavor}]`);\n      }\n    }\n\n    // Get relevant conditions if any\n    const conds = this._getContextConditions(`skill.${skillId}`);\n    for (const cond of conds) notes.push({ text: cond.name });\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    // Add metadata about the skill\n    const metadata = { rank: skl.rank ?? 0 };\n    if ([\"acr\", \"swm\", \"clm\"].includes(skillId)) {\n      const speeds = this.system.attributes?.speed ?? {};\n      metadata.speed = { base: speeds.land?.total ?? 0 };\n      if (skillId === \"swm\") metadata.speed.swim = speeds.swim?.total ?? 0;\n      if (skillId === \"clm\") metadata.speed.climb = speeds.climb?.total ?? 0;\n    }\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.Check\", { type: skl.fullName }),\n      chatTemplateData: { properties: props },\n      compendium: { entry: ffd20.config.skillCompendiumEntries[skillId] ?? skl.journal, type: \"JournalEntry\" },\n      subject: { skill: skillId },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n      messageData: {\n        system: {\n          subject: { skill: skillId },\n          config: metadata,\n        },\n      },\n    };\n    if (Hooks.call(\"pf1PreActorRollSkill\", this, rollOptions, skillId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    if (result) Hooks.callAll(\"pf1ActorRollSkill\", this, result, skillId);\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Roll basic BAB check\n   *\n   * @param {ActorRollOptions} [options] - Additional options\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollBAB(options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts: [`${this.system.attributes.bab.total}[${game.i18n.localize(\"FFD20.BABAbbr\")}]`],\n      subject: { core: \"bab\" },\n      flavor: game.i18n.format(\"FFD20.Check\", { type: game.i18n.localize(\"FFD20.BABAbbr\") }),\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n    };\n    if (Hooks.call(\"pf1PreActorRollBab\", this, rollOptions) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollBab\", this, result);\n    return result;\n  }\n\n  /**\n   * Roll a generic attack\n   *\n   * @example\n   * Basic ranged attack\n   * ```js\n   * await actor.rollAttack({ ranged: true });\n   * ```\n   * Basic melee maneuver\n   * ```js\n   * await actor.rollAttack({ maneuver: true });\n   * ```\n   *\n   * @param {ActorRollOptions} [options={}] - Roll options\n   * @param {boolean} [options.maneuver=false] - Whether this is weapon or maneuver check.\n   * @param {boolean} [options.ranged=false] - Melee or ranged.\n   * @param {boolean} [options.ability=null] - Attack ability. If not defined, appropriate one is chosen based on the ranged option.\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollAttack({ maneuver = false, ranged = false, ability = null, ...options } = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    if (maneuver && this.system.config?.noManeuvers) throw new Error(\"Manuevers are disabled for this actor.\");\n\n    let actionType;\n    if (!maneuver) actionType = ranged ? \"rwak\" : \"mwak\";\n    else actionType = ranged ? \"rcman\" : \"mcman\";\n\n    const atkData = {\n      name: !ranged ? game.i18n.localize(\"FFD20.Melee\") : game.i18n.localize(\"FFD20.Ranged\"),\n      actionType,\n    };\n\n    // Alter attack ability\n    const atkAbl = this.system.attributes?.attack?.[`${ranged ? \"ranged\" : \"melee\"}Ability`];\n    atkData.ability ??= {};\n    if (maneuver) atkData.ability.attack = ability || this.system.attributes?.cmbAbility;\n    atkData.ability.attack ||= ability || atkAbl || (ranged ? \"dex\" : \"str\");\n\n    // Alter activation type\n    atkData.activation ??= {};\n    atkData.activation.type = \"attack\";\n    atkData.activation.unchained ??= {};\n    atkData.activation.unchained.type = \"attack\";\n\n    // Generate temporary item\n    /** @type {ffd20.documents.item.ItemAttackPF} */\n    const atk = new Item.implementation(\n      {\n        type: \"attack\",\n        name: !maneuver ? game.i18n.localize(\"TYPES.Item.weapon\") : game.i18n.localize(\"FFD20.CMBAbbr\"),\n        system: {\n          actions: [new ffd20.components.ItemAction(atkData).toObject()],\n        },\n      },\n      { parent: this }\n    );\n\n    return atk.use(options);\n  }\n\n  /**\n   * Roll a Caster Level check using a particular spellbook of this actor\n   *\n   * @example\n   * Roll caster level check for primary spellbook.\n   * ```js\n   * await actor.rollCL(\"primary\");\n   * ```\n   *\n   * @param {string} bookId Spellbook identifier\n   * @param {ActorRollOptions} [options={}] Roll options\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollCL(bookId, options = {}) {\n    const spellbook = this.system.attributes.spells.spellbooks[bookId];\n    const rollData = options.rollData ?? this.getRollData();\n    rollData.cl = spellbook.cl.total;\n\n    // Set up roll parts\n    const parts = [];\n\n    const sources = this.getSourceDetails(`system.attributes.spells.spellbooks.${bookId}.cl.total`);\n    for (const src of sources.reverse()) {\n      if (src.id === \"woundThreshold\") {\n        // Adjust WT part to how much WT actually adjusted CL, to account for minimum CL\n        const wt = spellbook.cl.woundPenalty || 0;\n        if (wt) parts.push(`${wt}[${src.name}]`);\n        continue;\n      }\n      parts.push(`${src.value}[${src.name}]`);\n    }\n\n    // Add contextual caster level string\n    const notes = await this.getContextNotesParsed(`spell.cl.${bookId}`, { rollData });\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) notes.push({ text: ffd20.config.woundThresholdConditions[wT.level] });\n\n    const props = [];\n    if (notes.length) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      subject: { core: \"cl\", spellbook: bookId },\n      flavor: game.i18n.localize(\"FFD20.CasterLevelCheck\"),\n      chatTemplateData: { properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n    };\n    if (Hooks.call(\"pf1PreActorRollCl\", this, rollOptions, bookId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollCl\", this, result, bookId);\n    return result;\n  }\n\n  /**\n   * Roll a concentration check using a particular spellbook of this actor\n   *\n   * @todo Add support for concentration check type, e.g. defensive casting\n   *\n   * @param {string} bookId Spellbook identifier\n   * @param {ActorRollOptions} [options={}] Roll options\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollConcentration(bookId, options = {}) {\n    const spellbook = this.system.attributes.spells.spellbooks[bookId];\n    const rollData = options.rollData ?? this.getRollData();\n    rollData.cl = spellbook.cl.total;\n    rollData.mod = this.system.abilities[spellbook.ability]?.mod ?? 0;\n\n    if (\n      Hooks.call(\"actorRoll\", \"pf1PreActorRollConcentration\", undefined, this, \"concentration\", bookId, options) ===\n      false\n    )\n      return;\n\n    // Set up roll parts\n    const parts = [];\n\n    const describePart = (value, label) => parts.push(`${value}[${label}]`);\n    const srcDetails = (s) => s?.reverse().forEach((d) => describePart(d.value, d.name, -10));\n    srcDetails(this.getSourceDetails(`system.attributes.spells.spellbooks.${bookId}.concentration.total`));\n\n    // Add contextual concentration string\n    const notes = await this.getContextNotesParsed(`spell.concentration.${bookId}`, { rollData });\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) notes.push({ text: game.i18n.localize(ffd20.config.woundThresholdConditions[wT.level]) });\n    // TODO: Make the penalty show separate of the CL.total.\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      subject: { core: \"concentration\", spellbook: bookId },\n      flavor: game.i18n.localize(\"FFD20.ConcentrationCheck\"),\n      chatTemplateData: { properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n    };\n    if (Hooks.call(\"pf1PreActorRollConcentration\", this, rollOptions, bookId) === false) return;\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollConcentration\", this, result, bookId);\n    return result;\n  }\n\n  /**\n   * @protected\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.damageResistances=true] If false, damage resistances (DR, ER) are omitted.\n   * @param {boolean} [options.damageVulnerabilities=true] If false, damage vulnerabilities are omitted.\n   * @returns {*} - Header data\n   */\n  getDefenseHeaders({ damageResistances = true, damageVulnerabilities = true } = {}) {\n    const system = this.system;\n    const headers = [];\n\n    const reSplit = ffd20.config.re.traitSeparator;\n    const misc = [];\n\n    if (damageResistances) {\n      // Damage reduction\n      if (system.traits.dr.length) {\n        headers.push({\n          header: game.i18n.localize(\"FFD20.DamRed\"),\n          value: system.traits.dr.split(reSplit).map((text) => ({ text })),\n        });\n      }\n      // Energy resistance\n      if (system.traits.eres.length) {\n        headers.push({\n          header: game.i18n.localize(\"FFD20.EnRes\"),\n          value: system.traits.eres.split(reSplit).map((text) => ({ text })),\n        });\n      }\n    }\n    if (damageVulnerabilities) {\n      // Damage vulnerabilities\n      if (system.traits.dv.total.size) {\n        const value = system.traits.dv.names.map((text) => ({ text }));\n        headers.push({ header: game.i18n.localize(\"FFD20.DamVuln\"), value });\n      }\n    }\n    // Condition resistance\n    if (system.traits.cres.length) {\n      headers.push({\n        header: game.i18n.localize(\"FFD20.ConRes\"),\n        value: system.traits.cres.split(reSplit).map((text) => ({ text })),\n      });\n    }\n    // Immunities\n    if (system.traits.di.total.size || system.traits.ci.total.size) {\n      const value = [...system.traits.di.names, ...system.traits.ci.names].map((text) => ({ text }));\n      headers.push({ header: game.i18n.localize(\"FFD20.ImmunityPlural\"), value });\n    }\n    // Spell Resistance\n    if (system.attributes.sr.total > 0) {\n      misc.push({ text: game.i18n.format(\"FFD20.SpellResistanceNote\", { value: system.attributes.sr.total }) });\n    }\n\n    if (misc.length > 0) {\n      headers.push({ header: game.i18n.localize(\"FFD20.MiscShort\"), value: misc });\n    }\n\n    return headers;\n  }\n\n  /**\n   * Roll initiative for one or multiple Combatants associated with this actor.\n   * If no combat exists, GMs have the option to create one.\n   * If viewing a full Actor document, all Tokens which map to that actor will be targeted for initiative rolls.\n   * If viewing a synthetic Token actor, only that particular Token will be targeted for an initiative roll.\n   *\n   * @example\n   * ```js\n   * await actor.rollInitiative({ dice: \"2d20kh\", createCombatants: true, skipDialog: true });\n   * ```\n   *\n   * @override\n   * @see {@link ffd20.documents.CombatPF#rollInitiative}\n   * @param {object} [options={}] Options which configure how initiative is rolled\n   * @param {boolean} [options.createCombatants=false] - Create new Combatant entries for tokens associated with this actor.\n   * @param {boolean} [options.rerollInitiative=false] - Reroll initiative for existing Combatants\n   * @param {object} [options.initiativeOptions] - Options to pass to {@link CombatPF.rollInitiative()}\n   * @param {string|null} [options.dice=null] - Formula override for dice to roll\n   * @param {string|null} [options.bonus=null] - Formula for bonus to initiative\n   * @param {boolean} [options.skipDialog] - Skip roll dialog\n   * @param {string} [options.rollMode] - Roll mode override\n   * @param {TokenDocumentPF} [options.token=this.token] - For which token this initiative roll is for\n   * @returns {Promise<ffd20.documents.CombatPF|null>} The updated Combat document in which initiative was rolled, or null if no initiative was rolled\n   */\n  async rollInitiative({\n    createCombatants = false,\n    rerollInitiative = false,\n    initiativeOptions = {},\n    dice = null,\n    bonus = null,\n    rollMode = null,\n    skipDialog,\n    token,\n  } = {}) {\n    token ||= this.token;\n\n    // Obtain (or create) a combat encounter\n    let combat = game.combat;\n    if (!combat) {\n      if (game.user.isGM) {\n        const cls = getDocumentClass(\"Combat\");\n        combat = await cls.create({ scene: canvas.scene?.id, active: true });\n      } else {\n        ui.notifications.warn(\"COMBAT.NoneActive\", { localize: true });\n        return null;\n      }\n    }\n\n    // Create new combatants\n    if (createCombatants) {\n      const tokens = this.isToken ? [this.token] : this.getActiveTokens().map((t) => t.document);\n      const toCreate = [];\n      if (tokens.length) {\n        for (const t of tokens) {\n          if (t.inCombat) continue;\n          toCreate.push({ tokenId: t.id, sceneId: t.parent.id, actorId: this.id, hidden: t.hidden });\n        }\n      }\n      // No tokens on scene\n      else {\n        const existing = combat.combatants.filter((t) => t.actor == this && !t.token);\n        if (!existing.length) {\n          toCreate.push({ actorId: this.id, hidden: false });\n        }\n      }\n\n      if (toCreate.length) await combat.createEmbeddedDocuments(\"Combatant\", toCreate);\n    }\n\n    let untokened = 0;\n    // Roll initiative for combatants\n    let combatants = combat.combatants.filter((c) => {\n      if (c.actor?.id !== this.id) return false;\n      if (token && c.token?.id !== token.id) return false;\n      if (!c.token) untokened += 1;\n      return rerollInitiative || c.initiative === null;\n    });\n\n    // If more than one relevant combatants with no token present, prune list of valid combatants.\n    if (untokened > 1) {\n      combatants = combatants.filter((c) => !!c.token || c.initiative === null);\n      if (combatants.length == 0) ui.notifications.warn(game.i18n.localize(\"FFD20.Error.NoInitOnDuplicateCombatant\"));\n    }\n\n    // No combatants. Possibly from reroll being disabled.\n    if (combatants.length == 0) return combat;\n\n    foundry.utils.mergeObject(initiativeOptions, { d20: dice, bonus, rollMode, skipDialog });\n\n    return combat.rollInitiative(\n      combatants.map((c) => c.id),\n      initiativeOptions\n    );\n  }\n\n  /**\n   * Roll a specific saving throw\n   *\n   * @example\n   * ```js\n   * await actor.rollSavingThrow(\"ref\", { skipDialog: true, dice: \"2d20kh\", bonus: \"4\" });\n   * ```\n   *\n   * @param {SaveId} savingThrowId Identifier for saving throw type.\n   * @param {ActorRollOptions} [options={}] Roll options.\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollSavingThrow(savingThrowId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const notes = await this.getContextNotesParsed(`savingThrow.${savingThrowId}`, { rollData });\n\n    const parts = [];\n\n    // Get base\n    const base = this.system.attributes.savingThrows[savingThrowId]?.base;\n    if (base) parts.push(`${base}[${game.i18n.localize(\"FFD20.Base\")}]`);\n\n    // Add changes\n    let changeBonus = [];\n    const changes = this.changes.filter((c) => [\"allSavingThrows\", savingThrowId].includes(c.target));\n    {\n      // Get damage bonus\n      changeBonus = getHighestChanges(\n        changes.filter((c) => c.operator !== \"set\"),\n        { ignoreTarget: true }\n      ).reduce((cur, c) => {\n        if (c.value)\n          cur.push({\n            value: c.value,\n            source: c.flavor,\n          });\n        return cur;\n      }, []);\n    }\n    for (const c of changeBonus) {\n      parts.push(`${c.value}[${c.source}]`);\n    }\n\n    // Wound Threshold penalty\n    if (rollData.attributes.woundThresholds.penalty > 0) {\n      const label = ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level];\n      notes.push({ text: label });\n      parts.push(`- @attributes.woundThresholds.penalty[${label}]`);\n    }\n\n    // Get relevant conditions if any\n    const conds = this._getContextConditions(`savingThrow.${savingThrowId}`);\n    for (const cond of conds) notes.push({ text: cond.name });\n\n    const props = this.getDefenseHeaders({ damageResistances: false, damageVulnerabilities: false });\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n    const label = ffd20.config.savingThrows[savingThrowId];\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.SavingThrowRoll\", { save: label }),\n      subject: { save: savingThrowId },\n      chatTemplateData: { properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n    };\n\n    if (Hooks.call(\"pf1PreActorRollSave\", this, rollOptions, savingThrowId) === false) return;\n\n    // Roll saving throw\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollSave\", this, result, savingThrowId);\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Roll an Ability Test\n   * Prompt the user for input regarding Advantage/Disadvantage and any Situational Bonus\n   *\n   * @example\n   * ```js\n   * await actor.rollAbilityTest(\"str\");\n   * ```\n   *\n   * @param {AbilityId} abilityId - The ability ID (e.g. \"str\")\n   * @param {ActorRollOptions} [options={}] - Additional options\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollAbilityTest(abilityId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Add contextual notes\n    const rollData = options.rollData || this.getRollData();\n    const notes = await this.getContextNotesParsed(`abilityChecks.${abilityId}`, { rollData });\n\n    const label = ffd20.config.abilities[abilityId] ?? abilityId;\n\n    const parts = [`@abilities.${abilityId}.mod[${label}]`];\n\n    // Base parts\n    // Ability damage and penalty are not part of change system\n    const details = this.getSourceDetails(`system.abilities.${abilityId}.mod`);\n    for (const { value, name } of details) {\n      parts.push(`${value}[${name}]`);\n    }\n\n    // Gather changes\n    const dataPathCheck = `system.abilities.${abilityId}.checkMod`;\n\n    const changes = getHighestChanges(\n      this.changes.filter((/** @type {ItemChange} */ c) => {\n        const cf = c.getTargets(this);\n\n        return cf.includes(dataPathCheck);\n      }),\n      { ignoreTarget: true }\n    );\n\n    // Add changes\n    for (const c of changes) {\n      if (!c.value) continue;\n      // Hide complex change formulas in parenthesis.\n      if (typeof c.value === \"string\" && RollPF.parse(c.value).length > 1) {\n        parts.push(`(${c.value})[${c.flavor}]`);\n      } else {\n        parts.push(`${c.value}[${c.flavor}]`);\n      }\n    }\n\n    // Add negative levels\n    if (this.system.attributes.energyDrain) {\n      const label = game.i18n.localize(\"FFD20.NegativeLevels\");\n      parts.push(`-@attributes.energyDrain[${label}]`);\n    }\n\n    // Wound Threshold penalty\n    if (rollData.attributes.woundThresholds.penalty > 0) {\n      const label = ffd20.config.woundThresholdConditions[rollData.attributes.woundThresholds.level];\n      notes.push({ text: label });\n      parts.push(`-@attributes.woundThresholds.penalty[${label}]`);\n    }\n\n    const props = [];\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.Check\", { type: label }),\n      subject: { ability: abilityId },\n      chatTemplateData: { properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n    };\n\n    if (Hooks.call(\"pf1PreActorRollAbility\", this, rollOptions, abilityId) === false) return;\n\n    const result = await ffd20.dice.d20Roll(rollOptions);\n\n    Hooks.callAll(\"pf1ActorRollAbility\", this, result, abilityId);\n\n    return result;\n  }\n\n  /**\n   * Show defenses in chat\n   *\n   * @param {object} [options={}] Additional options\n   * @param {string | null} [options.rollMode=null]   The roll mode to use for the roll; defaults to the user's current preference when `null`.\n   * @param {TokenDocument} [options.token] Relevant token if any.\n   * @returns {Promise<ChatMessage|undefined>} - Created message\n   */\n  async displayDefenseCard({ rollMode = null, token } = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n    const rollData = this.getRollData();\n\n    const formatTextNotes = (notes) => notes?.split(/[\\n\\r]+/).map((text) => ({ text })) ?? [];\n\n    // Add contextual AC notes\n    const acNotes = await this.getContextNotesParsed(\"ac\", { rollData });\n    if (this.system.attributes.acNotes) acNotes.push(...formatTextNotes(this.system.attributes.acNotes));\n\n    // Add contextual CMD notes\n    const cmdNotes = await this.getContextNotesParsed(\"cmd\", { rollData });\n    if (this.system.attributes.cmdNotes) cmdNotes.push(...formatTextNotes(this.system.attributes.cmdNotes));\n\n    // Add contextual SR notes\n    const srNotes = await this.getContextNotesParsed(\"sr\", { rollData });\n    if (this.system.attributes.srNotes) srNotes.push(...formatTextNotes(this.system.attributes.srNotes));\n\n    // BUG: No specific saving throw notes are included\n    const saveNotes = await this.getContextNotesParsed(\"allSavingThrows\", { rollData });\n    if (this.system.attributes.saveNotes) saveNotes.push(...formatTextNotes(this.system.attributes.saveNotes));\n\n    // Add misc data\n\n    // Damage Reduction\n    const drNotes = Object.values(this.parseResistances(\"dr\")).map((text) => ({ text }));\n\n    // Energy Resistance\n    const erNotes = Object.values(this.parseResistances(\"eres\")).map((text) => ({ text }));\n\n    // Damage Immunity\n    // BUG: All incorrectly clumped with ER\n    if (this.system.traits.di.total.size) {\n      const values = [...this.system.traits.di.names];\n      erNotes.push(...values.map((o) => ({ text: game.i18n.format(\"FFD20.ImmuneTo\", { immunity: o }) })));\n    }\n    // Damage Vulnerability\n    if (this.system.traits.dv.total.size) {\n      const values = [...this.system.traits.dv.names];\n      erNotes.push(...values.map((o) => ({ text: game.i18n.format(\"FFD20.VulnerableTo\", { vulnerability: o }) })));\n    }\n\n    // Conditions\n    const conditions = Object.entries(this.system.conditions ?? {})\n      .filter(([_, enabled]) => enabled)\n      .map(([id]) => ffd20.registry.conditions.get(id))\n      .filter((c) => c?.showInDefense)\n      .map((c) => ({ text: c.name }));\n\n    // Wound Threshold penalty\n    const wT = this.getWoundThresholdData();\n    if (wT.valid) {\n      const wTlabel = ffd20.config.woundThresholdConditions[wT.level];\n      acNotes.push({ text: wTlabel });\n      cmdNotes.push({ text: wTlabel });\n    }\n\n    // Get actor's token\n    token ??= this.token;\n\n    // Create message\n    const actorData = this.system;\n    const templateData = {\n      actor: this,\n      name: token?.name ?? this.name,\n      tokenUuid: token?.uuid ?? null,\n      ac: {\n        normal: actorData.attributes.ac.normal.total,\n        touch: actorData.attributes.ac.touch.total,\n        flatFooted: actorData.attributes.ac.flatFooted.total,\n        notes: acNotes,\n      },\n      cmd: {\n        normal: actorData.attributes.cmd.total,\n        flatFooted: actorData.attributes.cmd.flatFootedTotal,\n        notes: cmdNotes,\n      },\n      misc: {\n        hardness: actorData.traits.hardness,\n        sr: actorData.attributes.sr.total,\n        srNotes,\n        drNotes,\n        erNotes,\n        conditions,\n      },\n      saves: {\n        fort: rollData.attributes?.savingThrows?.fort?.total,\n        ref: rollData.attributes?.savingThrows?.ref?.total,\n        will: rollData.attributes?.savingThrows?.will?.total,\n        notes: saveNotes,\n      },\n    };\n\n    if (this.system.config?.noManeuvers) {\n      delete templateData.cmd;\n    }\n\n    // Add regeneration and fast healing\n    if ((actorData.traits?.fastHealing || \"\").length || (actorData.traits?.regen || \"\").length) {\n      templateData.regen = {\n        regen: actorData.traits.regen,\n        fastHealing: actorData.traits.fastHealing,\n      };\n    }\n\n    rollMode ||= game.settings.get(\"core\", \"rollMode\");\n\n    const chatData = {\n      content: await renderTemplate(\"systems/ffd20/templates/chat/defenses.hbs\", templateData),\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n      rollMode,\n      system: {\n        subject: { info: \"defenses\" },\n      },\n      flags: {\n        core: {\n          canPopout: true,\n        },\n      },\n    };\n\n    // Apply roll mode\n    ChatMessage.implementation.applyRollMode(chatData, rollMode);\n\n    return ChatMessage.implementation.create(chatData);\n  }\n\n  /**\n   * Easy way to toggle a condition.\n   *\n   * @example\n   * Toggle Dazzled\n   * ```js\n   * await actor.toggleCondition(\"dazzled\");\n   * ```\n   * Toggle Blinded, set duration for 3 rounds if it's being enabled.\n   * ```js\n   * await actor.toggleCondition(\"blinded\", { duration: { seconds: 18 } });\n   * ```\n   *\n   * @param {boolean} conditionId - A direct condition key, as per {@link ffd20.registry.conditions}, such as `shaken` or `dazed`.\n   * @param {object} [aeData] - Extra data to add to the AE if it's being enabled\n   * @returns {Promise<object>} Condition ID to boolean mapping of actual updates.\n   */\n  async toggleCondition(conditionId, aeData) {\n    let active = !this.statuses.has(conditionId);\n    if (active && aeData) active = aeData;\n    return this.setCondition(conditionId, active);\n  }\n\n  /**\n   * Easy way to set a condition.\n   *\n   * @example\n   * Enable Dazzled\n   * ```js\n   * await actor.setCondition(\"dazzled\", true);\n   * ```\n   * Enable Sleep for 10 rounds\n   * ```js\n   * await actor.setCondition(\"sleep\", { duration: { seconds: 60 } });\n   * ```\n   *\n   * @param {string} conditionId - A direct condition key, as per {@link ffd20.registry.conditions}, such as `shaken` or `dazed`.\n   * @param {object|boolean} enabled - Whether to enable (true) the condition, or disable (false) it. Or object for merging into the active effect as part of enabling.\n   * @param {object} [context] Update context\n   * @returns {Promise<object>} Condition ID to boolean mapping of actual updates.\n   */\n  async setCondition(conditionId, enabled, context) {\n    if (typeof enabled !== \"boolean\" && foundry.utils.getType(enabled) !== \"Object\")\n      throw new TypeError(\"Actor.setCondition() enabled state must be a boolean or plain object\");\n    return this.setConditions({ [conditionId]: enabled }, context);\n  }\n\n  /**\n   * Set state of multiple conditions.\n   * Also handles condition tracks to minimize number of updates.\n   *\n   * @example\n   * Enable Blinded and Shaken conditions but disable Sleeping\n   * ```js\n   * await actor.setConditions({ blind: true, sleep: false, shaken:true });\n   * ```\n   *\n   * @param {object} conditions Condition ID to boolean (or update data) mapping of new condition states. See {@link setCondition()}\n   * @param {object} [context] Update context\n   * @returns {Record<string,boolean>} Condition ID to boolean mapping of actual updates.\n   */\n  async setConditions(conditions = {}, context = {}) {\n    conditions = foundry.utils.deepClone(conditions);\n\n    // Handle Condition tracks\n    const tracks = ffd20.registry.conditions.trackedConditions();\n    for (const conditionGroup of tracks) {\n      const newTrackState = conditionGroup.find((c) => conditions[c] === true);\n      if (!newTrackState) continue;\n      const disableTrackEntries = conditionGroup.filter((c) => c !== newTrackState);\n      for (const key of disableTrackEntries) {\n        conditions[key] = false;\n      }\n    }\n\n    // Create update data\n    const toDelete = [],\n      toCreate = [];\n\n    const immunities = this.getConditionImmunities();\n\n    for (const [conditionId, value] of Object.entries(conditions)) {\n      const currentCondition = ffd20.registry.conditions.get(conditionId);\n      if (currentCondition === undefined) {\n        console.error(\"Unrecognized condition:\", conditionId);\n        delete conditions[conditionId];\n        continue;\n      }\n\n      if (value === true && immunities.has(conditionId)) {\n        console.warn(\"Actor is immune to condition:\", conditionId, this);\n        delete conditions[conditionId];\n        continue;\n      }\n\n      // BUG: Only finds conditions directly on actor, not on items\n      const oldAe = this.statuses.has(conditionId) ? this.effects.find((ae) => ae.statuses.has(conditionId)) : null;\n\n      // Create\n      if (value) {\n        if (!oldAe) {\n          const aeData = {\n            flags: {\n              ffd20: {\n                autoDelete: true,\n              },\n            },\n            statuses: [conditionId],\n            name: currentCondition.name,\n            img: currentCondition.texture,\n          };\n\n          // Special boolean for easy overlay\n          if (value?.overlay) {\n            delete value.overlay;\n            foundry.utils.setProperty(aeData.flags, \"core.overlay\", true);\n          }\n\n          if (typeof value !== \"boolean\") {\n            foundry.utils.mergeObject(aeData, value);\n          }\n\n          toCreate.push(aeData);\n        } else {\n          delete conditions[conditionId];\n        }\n      }\n      // Delete\n      else {\n        if (oldAe) {\n          toDelete.push(oldAe.id);\n        } else {\n          delete conditions[conditionId];\n        }\n      }\n    }\n\n    // Perform updates\n    // Inform update handlers they don't need to do work\n    context.ffd20 ??= {};\n    context.ffd20.updateConditionTracks = false;\n\n    if (toDelete.length) {\n      const deleteContext = foundry.utils.deepClone(context);\n      // Prevent double render\n      if (context.trender && toCreate.length) deleteContext.render = false;\n      // Without await the deletions may not happen at all, presumably due to race condition, if AEs are also created.\n      await this.deleteEmbeddedDocuments(\"ActiveEffect\", toDelete, context);\n    }\n    if (toCreate.length) {\n      const createContext = foundry.utils.deepClone(context);\n      await this.createEmbeddedDocuments(\"ActiveEffect\", toCreate, createContext);\n    }\n\n    this._conditionToggleNotify(conditions);\n\n    return conditions;\n  }\n\n  /**\n   * Easy way to determine whether this actor has a condition.\n   *\n   * @example\n   * Test if user is grappled\n   * ```js\n   * actor.hasCondition(\"grappled\");\n   * ```\n   *\n   * @deprecated This is identical to `actor.statuses.has(\"conditionId\")`\n   * @param {string} conditionId - A direct condition key, as per ffd20.registry.conditions, such as `shaken` or `dazed`.\n   * @returns {boolean} Condition state\n   */\n  hasCondition(conditionId) {\n    foundry.utils.logCompatibilityWarning(\n      \"ActorPF.hasCondition() is deprecated in favor of actor.statuses.has(conditionId)\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v13\",\n      }\n    );\n    return this.statuses.has(conditionId);\n  }\n\n  /**\n   * Get active conditions marked for context\n   *\n   * @internal\n   * @param {string} context - Context ID\n   * @returns {Array<ffd20.registry.conditions.model>} - Array of conditions\n   */\n  _getContextConditions(context) {\n    const conditions = [];\n    for (const conditionId of this.statuses) {\n      const condition = ffd20.registry.conditions.get(conditionId);\n      if (!condition) continue;\n      if (condition.mechanics.contexts.has(context)) conditions.push(condition);\n    }\n    return conditions;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Helper function for actor energy resistance and damage reduction feedback.\n   *\n   * @protected\n   * @param {\"dr\"|\"eres\"} resistanceType Value to check resistances for.\n   * @returns {Record<string,string>} Entry to label mapping of resistances or reductions.\n   */\n  parseResistances(resistanceType) {\n    /** @type {{custom:string, value: {amount:number,operator:string,types:string[]}[]}} */\n    const res = this.system.traits?.[resistanceType];\n    if (!res) return {}; // Either actor is malformed, or it's a type that doesn't have this info\n\n    const result = {};\n    if (Array.isArray(res.value)) {\n      res.value.forEach((entry, counter) => {\n        const res = this._parseResistanceEntry(entry, resistanceType);\n        result[`${counter + 1}`] = res.label;\n      });\n    }\n\n    if (typeof res.custom === \"string\") {\n      res.custom.split(ffd20.config.re.traitSeparator).forEach((entry, counter) => {\n        entry = entry?.trim();\n        if (!entry?.length) return;\n        const res = this._parseResistanceEntry(entry, resistanceType);\n        result[`custom${counter + 1}`] = res.label;\n      });\n    }\n\n    return result;\n  }\n\n  /**\n   * Parse resistance entry\n   *\n   * Primarily called from {@link parseResistances}\n   *\n   * @internal\n   * @experimental\n   * @param {object|string} entry\n   * @param {\"dr\"|\"er\"} [resistanceType]\n   * @returns {ParsedResistanceEntry}\n   */\n  _parseResistanceEntry(entry, resistanceType = \"dr\") {\n    const format = (amount, type1, operator = null, type2 = null) => {\n      let label = type1;\n      if (type2) {\n        switch (operator) {\n          case false: {\n            // Combine with AND\n            label = game.i18n.format(\"FFD20.Application.DamageResistanceSelector.CombinationFormattedAnd\", {\n              type1,\n              type2,\n            });\n            break;\n          }\n          default:\n          case true: {\n            // Combine with OR\n            label = game.i18n.format(\"FFD20.Application.DamageResistanceSelector.CombinationFormattedOr\", {\n              type1,\n              type2,\n            });\n            break;\n          }\n        }\n      }\n\n      return resistanceType === \"dr\" ? `${amount}/${label}` : `${label} ${amount}`;\n    };\n\n    const getType = (typeId) =>\n      ffd20.registry.damageTypes.get(typeId) ??\n      ffd20.registry.materials.get(typeId) ?? { name: ffd20.config.damageResistances[typeId] ?? typeId };\n\n    const isDR = resistanceType == \"dr\";\n    const isER = !isDR;\n\n    // Parse custom entry\n    if (typeof entry === \"string\") {\n      const re = /(?<value>\\d+)/.exec(entry);\n      const amount = parseInt(re?.groups.value || \"0\");\n      const type = entry.replace(/\\d+\\s*\\/?/, \"\").trim();\n\n      return {\n        type0: { name: type },\n        amount,\n        label: format(amount, type || \"â\"),\n        isDR,\n        isER,\n        custom: true,\n      };\n    }\n    // Parse normal entry\n    else {\n      const { amount, operator } = entry;\n      const [typeId0, typeId1] = entry.types;\n\n      const type0 = getType(typeId0);\n      const type0name = type0?.shortName || type0?.name;\n      const type1 = getType(typeId1);\n      const type1name = type1?.shortName || type1?.name;\n\n      return {\n        type0: { id: typeId0, name: type0name, data: type0 },\n        type1: { id: typeId1, name: type1name, data: type1 },\n        operator,\n        amount,\n        label: format(amount, type0name || \"-\", operator, type1name),\n        isDR,\n        isER,\n      };\n    }\n  }\n\n  /**\n   * Wrapper for the static function, taking this actor as the only target.\n   *\n   * @see {@link ActorPF.applyDamage}\n   *\n   * @example\n   * Cause 10 damage\n   * ```js\n   * await actor.applyDamage(10);\n   * ```\n   * Heal 10 damage\n   * ```js\n   * await actor.applyDamage(-10);\n   * ```\n   * Apply 3 damage directly to Wounds instead of Vigor\n   * ```js\n   * await actor.applyDamage(3, { asWounds: true });\n   * ```\n   *\n   * @param {number} value - Value to adjust health by. Positive values deal damage, negative values heal.\n   * @param {ApplyDamageOptions} [options] Additional options. This object will be transformed in-place as the damage application is processed.\n   * @returns {Promise<Actor|false>} - Updated actor or false.\n   */\n  async applyDamage(value, options = {}) {\n    const {\n      asWounds = false,\n      asNonlethal = false,\n      asManaDamage = false,\n      critMult,\n      dualHeal = game.settings.get(\"ffd20\", \"dualHeal\"),\n      reduction = 0,\n      ratio = 1,\n    } = options;\n    const isHealing = value < 0;\n\n    // Apply ratio and reduction\n    value = Math.floor(value * ratio);\n    if (value < 0) value += Math.min(-value, reduction);\n    else value -= Math.min(value, reduction);\n    value = Math.floor(value); // Round again just for sake of sanity\n\n    console.debug(\"FFD20 | Apply Damage |\", value, \"to\", this.name, `[${this.uuid}]`);\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n\n    if (value == 0) return void console.warn(\"Attempting to apply 0 damage.\"); // Early exit\n\n    if (!this.isOwner) {\n      ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n      return;\n    }\n\n    const useWoundsAndVigor = healthConfig.getActorConfig(this).rules?.useWoundsAndVigor ?? false,\n      hp = !useWoundsAndVigor ? this.system.attributes.hp : this.system.attributes.vigor,\n      mp = this.system.attributes.mp;\n    // Cancel if no health data is found\n    if (!hp) return false;\n\n    const thp = hp.temp || 0,\n          tmp = mp.temp || 0;\n\n    const updateData = {};\n\n    // check if it is mp damage first\n    if (asManaDamage) {\n      // MP damage\n      const currentMP = mp.value;\n\n      if (asManaDamage && value > 0) {\n          value = Math.min(currentMP, value);\n        }\n\n      // Temp MP adjustment\n      const dt = !isHealing ? Math.min(tmp, value) : 0;\n\n      // Create update data\n      if (dt != 0) updateData[\"system.attributes.mp.temp\"] = tmp - dt;\n      const newMp = Math.min(mp.value - (value - dt), mp.max);\n      if (newMp != mp.value) updateData[\"system.attributes.mp.value\"] = newMp;\n\n    } else {\n\n      // Wounds & Vigor\n      if (useWoundsAndVigor) {\n        const currentHealth = hp.value;\n        let woundAdjust = 0;\n\n        if (asWounds) {\n          woundAdjust -= value;\n          value = 0;\n        }\n\n        // Temp HP adjustment\n        const dt = value > 0 ? Math.min(tmp, value) : 0;\n        value -= dt;\n\n        // Nonlethal damage\n        if (asNonlethal && value > 0) {\n          if (currentHealth > 0) {\n            value = Math.min(currentHealth, value);\n          } else {\n            woundAdjust -= critMult > 1 ? critMult : 1;\n            value = 0; // No other bleedover to wounds\n          }\n        }\n\n        // Create update data\n        if (dt != 0) updateData[\"system.attributes.vigor.temp\"] = tmp - dt;\n        if (value != 0) {\n          let newHP = Math.min(currentHealth - value, hp.max);\n          if (value > 0) {\n            if (newHP < 0) {\n              woundAdjust -= -newHP;\n              if (critMult > 0) woundAdjust -= critMult;\n              newHP = 0;\n            }\n          }\n\n          if (newHP != hp.value) updateData[\"system.attributes.vigor.value\"] = newHP;\n        }\n\n        if (woundAdjust != 0) {\n          const wounds = this.system.attributes.wounds;\n          updateData[\"system.attributes.wounds.value\"] = Math.clamp(wounds.value + woundAdjust, 0, wounds.max);\n        }\n      }\n      // Normal Hit Points\n      else {\n        // Nonlethal damage\n        let nld = 0;\n        if (asNonlethal) {\n          if (value > 0) {\n            nld = Math.min(hp.max - hp.nonlethal, value);\n            value -= nld;\n          }\n          // Nonlethal healing\n          else if (value < 0) {\n            nld = value;\n            value = 0;\n          }\n        }\n        // Dual healing heals also nonlethal\n        else if (isHealing && dualHeal) {\n          nld = value;\n        }\n\n        // Temp HP adjustment\n        const dt = !isHealing ? Math.min(thp, value) : 0;\n\n        // Create update data\n        if (nld != 0) updateData[\"system.attributes.hp.nonlethal\"] = Math.max(0, hp.nonlethal + nld);\n        if (dt != 0) updateData[\"system.attributes.hp.temp\"] = thp - dt;\n        const newHp = Math.min(hp.value - (value - dt), hp.max);\n        if (newHp != hp.value) updateData[\"system.attributes.hp.value\"] = newHp;\n      }\n    }\n\n    return this.update(updateData);\n  }\n\n  /**\n   * Apply damage to the token or tokens which are currently controlled.\n   *\n   * If Shift is held, will prompt for adjustments based on damage reduction and energy resistances.\n   *\n   * @param {number} value - The amount of damage to deal. Negative values heal instead.\n   * @param {TargetedApplyDamageOptions} [options] - Object containing default settings for overriding\n   * @throws {Error} - If no valid targets are provided.\n   * @returns {Promise<false|Actor[]>} - False if cancelled or array of updated actors.\n   */\n  static async applyDamage(value = 0, options = {}) {\n    // Get targets if none are provided\n    if (!options.targets?.length) options.targets = canvas.tokens.controlled;\n    if (!options.targets?.length && game.user.character) options.targets = [game.user.character];\n\n    // Make sure targets are all actors\n    options.targets = options.targets.map((t) => t.actor || t).filter((t) => t instanceof Actor);\n\n    console.debug(\"FFD20 | Apply Damage |\", value, \"to\", options.targets.length, \"target(s)\");\n\n    if (options.targets.length === 0) throw new Error(\"No valid targets\");\n\n    if (value == 0 || !Number.isFinite(value)) {\n      console.warn(\"Attempting to apply 0 damage.\");\n      return false;\n    }\n\n    // HACK: Infer nonlethal\n    if (options.instances?.length && options.asNonlethal === undefined) {\n      options.asNonlethal = options.instances.every((t) => t.types.has(\"nonlethal\"));\n      if (options.asNonlethal) console.debug(\"FFD20 | Damage inferred as nonlethal\");\n    }\n\n    // HACK: Infer mana damage\n    if (options.instances?.length && options.asManaDamage === undefined) {\n      options.asManaDamage = options.instances.every((t) => t.types.has(\"manapoint\"));\n      if (options.asManaDamage) console.debug(\"FFD20 | Damage inferred as mana damage\");\n    }\n\n\n    // Apply defaults\n    options.asNonlethal ??= false;\n    options.asManaDamage ??= false;\n    options.critMult ??= 0;\n    options.asWounds ??= false;\n    options.forceDialog ??= false;\n\n    if (options.reductionDefault !== undefined) {\n      foundry.utils.logCompatibilityWarning(\n        \"ActorPF.applyDamage() reductionDefault option is deprecated in favor of reduction.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      options.reduction = options.reductionDefault;\n    }\n\n    // Dialog skipped\n    if (ffd20.skipConfirmPrompt ? options.forceDialog : !options.forceDialog) {\n      const promises = options.targets.map((t) => t.applyDamage(value, options));\n      return Promise.all(promises);\n    }\n\n    // Open dialog\n    options.value = value;\n\n    // TODO: This does not return updated documents\n    const rv = await ffd20.applications.ApplyDamage.wait(options);\n    if (!rv) return false;\n    return rv.updated;\n  }\n\n  /**\n   * Adjust temporary hit points.\n   *\n   * @example\n   * Gain 50 THP\n   * ```js\n   * actor.addTempHP(50);\n   * ```\n   * Lose 10 THP\n   * ```js\n   * actor.addTempHP(-10);\n   * ```\n   * Set THP to zero\n   * ```js\n   * actor.addTempHP(0, { set: true });\n   * ```\n   *\n   * @param {number} value - Value to add to temp HP\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.set] - If true, the temporary hit points are set to the provide value instead of added to existing.\n   * @returns {Promise<this|undefined>} - Updated document or undefined if no update occurred\n   */\n  async addTempHP(value, { set = false } = {}) {\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const hpActorConfig = healthConfig.getActorConfig(this);\n    const vigor = hpActorConfig.rules.useWoundsAndVigor;\n\n    const curTHP = (vigor ? this.system.attributes.vigor.temp : this.system.attributes.hp.temp) || 0;\n    const newTHP = Math.max(0, !set ? curTHP + value : value);\n\n    return this.update({ system: { attributes: { [vigor ? \"vigor\" : \"hp\"]: { temp: newTHP } } } });\n  }\n\n  /**\n   * Returns effective Wound Threshold multiplier with rules and overrides applied.\n   *\n   * @protected\n   * @param {object} [options] - Additional options\n   * @param {object} [options.healthConfig] - PC/NPC health config variant data\n   * @returns {number} Multiplier\n   */\n  getWoundThresholdMultiplier({ healthConfig } = {}) {\n    healthConfig ??= game.settings.get(\"ffd20\", \"healthConfig\").getActorConfig(this);\n\n    return healthConfig.rules.useWoundThresholds;\n  }\n\n  /**\n   * Returns Wound Threshold relevant data.\n   *\n   * @protected\n   * @param {object} [options] - Additional options\n   * @param {object} [options.healthConfig] - PC/NPC health config variant data\n   * @returns {{level:number,penalty:number,multiplier:number,valid:boolean}} - Wound threshold info\n   */\n  getWoundThresholdData({ healthConfig } = {}) {\n    healthConfig ??= game.settings.get(\"ffd20\", \"healthConfig\").getActorConfig(this);\n\n    /** @type {{level:number,mod:number}} */\n    const wt = this.system.attributes?.woundThresholds ?? {};\n\n    const woundMult = this.getWoundThresholdMultiplier({ healthConfig }),\n      woundLevel = wt.level || 0,\n      woundPenalty = woundLevel * woundMult + (wt.mod || 0);\n\n    return {\n      level: woundLevel,\n      penalty: woundPenalty,\n      multiplier: woundMult,\n      valid: woundLevel > 0 && woundMult > 0,\n    };\n  }\n\n  /**\n   * Updates attributes.woundThresholds.level variable.\n   *\n   * @protected\n   */\n  updateWoundThreshold() {\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const hpActorConfig = hpConfig.getActorConfig(this);\n    const usage = hpActorConfig.rules.useWoundThresholds;\n    const vigor = hpActorConfig.rules.useWoundsAndVigor;\n\n    /** @type {{mod:number,penalty:number}} */\n    const wt = this.system.attributes.woundThresholds;\n    // Null if WT is not in use, or it is combined with Wounds & Vigor\n    if (!usage || vigor) {\n      wt.level = 0;\n      wt.penaltyBase = 0;\n      wt.penalty = 0;\n      wt.mod = 0;\n      return;\n    }\n    /** @type {{value:number,temp:number,max:number}} */\n    const hp = this.system.attributes.hp,\n      curHP = hp.value,\n      tempHP = hp.temp ?? 0,\n      maxHP = hp.max;\n\n    let level = usage > 0 ? Math.clamp(4 - Math.ceil(((curHP + tempHP) / maxHP) * 4), 0, 3) : 0;\n    if (Number.isNaN(level)) level = 0; // Division by 0 due to max HP on new actors.\n\n    const wtMult = this.getWoundThresholdMultiplier({ healthConfig: hpActorConfig });\n    const wtMod = wt.mod ?? 0;\n\n    wt.level = level;\n    wt.penaltyBase = level * wtMult; // To aid relevant formulas\n    wt.penalty = level * wtMult + wtMod;\n\n    const penalty = wt.penalty;\n    // TODO: Convert to changes\n    if (penalty != 0) {\n      const changeFlatKeys = ffd20.config.woundThresholdChangeTargets;\n      for (const fk of changeFlatKeys) {\n        if (fk === \"cl\") continue; // HACK: Handle CL change in spellbook update\n        const flats = getChangeFlat(this, fk, \"untyped\", -penalty);\n        for (const k of flats) {\n          if (!k) continue;\n          const curValue = foundry.utils.getProperty(this, k) ?? 0;\n          foundry.utils.setProperty(this, k, curValue - penalty);\n        }\n      }\n\n      // Soft add change for attacks\n      const ch = new ffd20.components.ItemChange({\n        _id: \"woundThreshold\",\n        formula: `-${penalty}`,\n        flavor: ffd20.config.woundThresholdConditions[wt.level],\n        target: \"attack\",\n        type: \"untyped\",\n        value: -penalty,\n      });\n      this.changes.set(ch.id, ch);\n    } else {\n      this.changes.delete(\"woundThreshold\");\n    }\n  }\n\n  /**\n   * All skill IDs relevant to this actor\n   *\n   * @type {Array<string>}\n   */\n  get allSkills() {\n    const result = [];\n    for (const [key, skillData] of Object.entries(this.system.skills)) {\n      if (!skillData) continue;\n      result.push(key);\n      for (const subKey of Object.keys(skillData.subSkills ?? {})) {\n        result.push(`${key}.${subKey}`);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * An array of all context note data for this actor.\n   *\n   * @type {{notes: Array<ffd20.components.ContextNote>, item: ItemPF}[]}\n   */\n  get allNotes() {\n    return this.items\n      .filter((item) => item.isActive && item.system.contextNotes?.length > 0)\n      .map((item) => ({ notes: item.system.contextNotes, item }));\n  }\n\n  /**\n   * @returns {ItemPF[]} All items on this actor, including those in containers.\n   */\n  get allItems() {\n    return [...this.containerItems, ...this.items];\n  }\n\n  /**\n   * All items this actor is holding in containers.\n   *\n   * @internal\n   * @type {ItemPF[]}\n   */\n  get containerItems() {\n    /** @type {Array<ItemPF>} */\n    const items = [];\n\n    /**\n     * @param {ffd20.documents.item.ItemContainerPF} container - Item doc\n     */\n    function getContainerContents(container) {\n      if (container.type !== \"container\") return;\n\n      for (const item of container.items) {\n        items.push(item);\n        getContainerContents(item);\n      }\n    }\n\n    for (const container of this.itemTypes.container) {\n      getContainerContents(container);\n    }\n\n    return items;\n  }\n\n  /**\n   * Generates an array with all the active context-sensitive notes for the given context on this actor.\n   *\n   * @param {string} context - The context to draw from.\n   * @param {boolean} [all=true] - Retrieve notes meant for all, such as notes targeting all skills.\n   * @returns {Array<ItemContextNotes>} - Context notes\n   */\n  getContextNotes(context, all = true) {\n    if (context.string) {\n      foundry.utils.logCompatibilityWarning(\n        \"ActorPF.getcontextNotes() first parameter must be a string, support for anything else is deprecated.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      context = context.string;\n    }\n\n    const formatTextNotes = (notes) => notes?.split(/[\\n\\r]+/) ?? [];\n\n    const result = this.allNotes;\n\n    const parts = context.split(\".\");\n    const mainId = parts.shift();\n\n    // Special contexts that retrieve additional targets.\n    switch (mainId) {\n      // skill.*\n      case \"skill\": {\n        const skillKey = parts.shift();\n        const skill = this.getSkillInfo(skillKey);\n        const ability = skill.ability;\n        for (const noteSource of result) {\n          noteSource.notes = noteSource.notes\n            .filter((n) => [context, `${ability}Skills`].includes(n.target) || (all && n.target === \"skills\"))\n            .map((n) => n.text);\n        }\n\n        return result;\n      }\n      // savingThrow.*\n      case \"savingThrow\": {\n        const saveKey = parts.shift();\n        for (const noteSource of result) {\n          noteSource.notes = noteSource.notes\n            .filter((n) => [saveKey, \"allSavingThrows\"].includes(n.target))\n            .map((n) => n.text);\n        }\n\n        if (this.system.attributes?.saveNotes) {\n          result.push({ notes: [this.system.attributes.saveNotes], item: null });\n        }\n\n        return result;\n      }\n      // abilityChecks.*\n      case \"abilityChecks\": {\n        const ablKey = parts.shift();\n        for (const noteSource of result) {\n          noteSource.notes = noteSource.notes\n            .filter((n) => [`${ablKey}Checks`, \"allChecks\"].includes(n.target))\n            .map((n) => n.text);\n        }\n\n        return result;\n      }\n      // spell.*\n      case \"spell\": {\n        const subId = parts.shift();\n        // spell.concentration.*\n        if (subId === \"concentration\") {\n          const bookId = parts.shift();\n          for (const noteSource of result) {\n            noteSource.notes = noteSource.notes.filter((n) => n.target === \"concentration\").map((n) => n.text);\n          }\n\n          /** @type {string} */\n          const spellbookNotes = this.system.attributes?.spells?.spellbooks?.[bookId]?.concentrationNotes;\n          if (spellbookNotes?.length) {\n            result.push({ notes: formatTextNotes(spellbookNotes), item: null });\n          }\n\n          return result;\n        }\n        // spell.cl.*\n        if (subId == \"cl\") {\n          const bookId = parts.shift();\n          for (const noteSource of result) {\n            noteSource.notes = noteSource.notes.filter((n) => n.target === \"cl\").map((n) => n.text);\n          }\n\n          /** @type {string} */\n          const spellbookNotes = this.system.attributes?.spells?.spellbooks?.[bookId]?.clNotes;\n          if (spellbookNotes?.length) {\n            result.push({ notes: formatTextNotes(spellbookNotes), item: null });\n          }\n\n          return result;\n        }\n\n        return [];\n      }\n    }\n\n    // Otherwise return notes if they directly match context\n    for (const note of result) {\n      note.notes = note.notes.filter((o) => o.target === context).map((o) => o.text);\n    }\n\n    return result.filter((n) => n.notes.length);\n  }\n\n  /**\n   * Returns a list of already parsed context notes.\n   *\n   * @param {string} context - The context to draw notes from.\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.roll=true] Whether to roll inline rolls or not.\n   * @param {boolean} [options.all] - Option to pass to {@link getContextNotes}\n   * @returns {Promise<Array<ParsedContextNoteEntry>>} The resulting notes, already parsed.\n   */\n  async getContextNotesParsed(context, { all, roll = true, rollData } = {}) {\n    rollData ??= this.getRollData();\n\n    const noteObjects = this.getContextNotes(context, all);\n    await this.enrichContextNotes(noteObjects, rollData, { roll });\n\n    return noteObjects.reduce((all, o) => {\n      all.push(...o.enriched.map((text) => ({ text, source: o.item?.name })));\n      return all;\n    }, []);\n  }\n\n  /**\n   * Enrich context notes with item specific roll data.\n   *\n   * Adds `enriched` array to each note object.\n   *\n   * @param {ItemContextNotes} notes - Context notes\n   * @param {object} [rollData] - Roll data instance\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.roll=true] - Handle rolls\n   */\n  async enrichContextNotes(notes, rollData, { roll = true } = {}) {\n    rollData ??= this.getRollData();\n    for (const noteObj of notes) {\n      rollData.item = {};\n      if (noteObj.item) rollData = noteObj.item.getRollData();\n\n      const enriched = [];\n      for (const note of noteObj.notes) {\n        enriched.push(\n          ...note\n            .split(/[\\n\\r]+/)\n            .map((subnote) => ffd20.utils.enrichHTMLUnrolled(subnote, { rollData, rolls: roll, relativeTo: this }))\n        );\n      }\n\n      noteObj.enriched = await Promise.all(enriched);\n    }\n  }\n\n  /**\n   * @typedef {object} MobilityPenaltyResult\n   * @property {number|null} maxDexBonus - The maximum dexterity bonus allowed for this result.\n   * @property {number} acp - The armor check penalty of this result.\n   */\n\n  /**\n   * Computes encumbrance values for this actor.\n   *\n   * @internal\n   * @returns {MobilityPenaltyResult} The resulting penalties from encumbrance.\n   */\n  _computeEncumbrance() {\n    // Init base data\n    this.system.attributes ??= {};\n    const attributes = this.system.attributes;\n    attributes.encumbrance ??= {};\n    const encumbrance = attributes.encumbrance;\n\n    const carry = this.getCarryCapacity();\n    // Set levels\n    encumbrance.levels = carry;\n    encumbrance.levels.carry = carry.heavy * 2;\n    encumbrance.levels.drag = carry.heavy * 5;\n\n    const carriedWeight = Math.max(0, this.getCarriedWeight());\n    encumbrance.carriedWeight = Math.round(carriedWeight * 10) / 10;\n\n    // Determine load level\n    let encLevel = ffd20.config.encumbranceLevels.light;\n    if (carriedWeight > 0) {\n      if (carriedWeight > encumbrance.levels.medium) encLevel = ffd20.config.encumbranceLevels.heavy;\n      else if (carriedWeight > encumbrance.levels.light) encLevel = ffd20.config.encumbranceLevels.medium;\n    }\n    encumbrance.level = encLevel;\n\n    const result = {\n      maxDexBonus: null,\n      acp: 0,\n    };\n\n    switch (encumbrance.level) {\n      case ffd20.config.encumbranceLevels.medium:\n        result.acp = 3;\n        result.maxDexBonus = 3;\n        break;\n      case ffd20.config.encumbranceLevels.heavy:\n        result.acp = 6;\n        result.maxDexBonus = 1;\n        break;\n    }\n\n    encumbrance.acp = result.acp;\n    encumbrance.maxDex = result.maxDexBonus;\n\n    return result;\n  }\n\n  /**\n   * @internal\n   * @returns {number} - Total coin weight in lbs\n   */\n  _calculateCoinWeight() {\n    const divisor = game.settings.get(\"ffd20\", \"coinWeight\");\n    if (!divisor) return 0;\n    return Object.values(this.system.currency || {}).reduce((total, coins) => total + (coins || 0), 0) / divisor;\n  }\n\n  /**\n   * Calculate current carry capacity limits.\n   *\n   * @returns {{light:number,medium:number,heavy:number}} - Capacity info\n   */\n  getCarryCapacity() {\n    // Determine carrying capacity\n    const carryCapacity = this.system.details?.carryCapacity ?? {};\n    const carryStr = this.system.abilities.str.total + carryCapacity.bonus?.total;\n    let carryMultiplier = carryCapacity.multiplier?.total;\n    const size = Object.keys(ffd20.config.sizeChart)[this.system.traits.size.value];\n    if (this.system.attributes.quadruped) carryMultiplier *= ffd20.config.encumbranceMultipliers.quadruped[size];\n    else carryMultiplier *= ffd20.config.encumbranceMultipliers.normal[size];\n    const table = ffd20.config.encumbranceLoads;\n\n    let heavy = Math.floor(table[carryStr] * carryMultiplier);\n    if (carryStr >= table.length) {\n      const multiplierCount = (carryStr - (table.length - 1)) / 10;\n      heavy = Math.floor(table[table.length - 1] * Math.pow(4, multiplierCount) * carryMultiplier);\n    }\n    // Convert to world unit system\n    heavy = ffd20.utils.convertWeight(heavy);\n\n    return {\n      light: Math.floor(heavy / 3),\n      medium: Math.floor((heavy / 3) * 2),\n      heavy,\n    };\n  }\n\n  /**\n   * Determines carried weight.\n   *\n   * @returns {number} - kg or lbs of all carried things, including currency\n   */\n  getCarriedWeight() {\n    const weight = this.items\n      .filter((i) => i.isPhysical && i.system.carried !== false)\n      .reduce((cur, o) => cur + o.system.weight.total, this._calculateCoinWeight());\n\n    return ffd20.utils.convertWeight(weight);\n  }\n\n  /**\n   * Get total currency in category.\n   *\n   * @param {\"currency\"|\"altCurrency\"} [category=\"currency\"] - Currency category.\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.inLowestDenomination=true] - Return result in lowest denomination (default copper). If false, returns standard currency (default gold) instead.\n   * @returns {number} - Total currency in category.\n   */\n  getCurrency(category = \"currency\", { inLowestDenomination = true } = {}) {\n    const currencies = this.system[category];\n    if (!currencies) {\n      console.error(`Currency type \"${category}\" not found.`);\n      return NaN;\n    }\n\n    const cc = ffd20.config.currency;\n\n    let total = 0;\n    for (let [unit, value] of Object.entries(currencies)) {\n      value = Math.max(0, value || 0);\n      if (value == 0) continue;\n      total += value * (cc.rate[unit] || 1);\n    }\n\n    return inLowestDenomination ? total : total / cc.standardRate;\n  }\n\n  /**\n   * Total coinage in both weighted and weightless.\n   *\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.inLowestDenomination=true] - Use copper for calculations, otherwise {@link ffd20.config.currency.standard standard denomination} is used.\n   * @returns {number} - The total amount of currency, in copper pieces.\n   */\n  getTotalCurrency({ inLowestDenomination = true } = {}) {\n    const total =\n      this.getCurrency(\"currency\", { inLowestDenomination: true }) +\n      this.getCurrency(\"altCurrency\", { inLowestDenomination: true });\n\n    return inLowestDenomination ? total : total / ffd20.config.currency.standardRate;\n  }\n\n  /**\n   * Converts currencies of the given category to the given currency type\n   *\n   * @see {@link ffd20.utils.currency.convert}\n   *\n   * @param {\"currency\"|\"altCurrency\"} [category=\"currency\"] - Currency category, altCurrency is for weightless\n   * @param {CoinType} [type=\"pp\"] - Target currency.\n   * @returns {Promise<this>|undefined} Updated document or undefined if no update occurred.\n   */\n  convertCurrency(category = \"currency\", type = \"pp\") {\n    const cp = this.getCurrency(category, { inLowestDenomination: true });\n    if (!Number.isFinite(cp)) {\n      console.error(`Invalid total currency \"${cp}\" in \"${category}\" category`);\n      return;\n    }\n\n    const currency = ffd20.utils.currency.convert(cp, type, { pad: true });\n\n    return this.update({ system: { [category]: currency } });\n  }\n\n  /**\n   * Prepare armor/shield data for roll data\n   *\n   * @internal\n   * @param {object} equipment Equipment info\n   * @param {string} equipment.id Item ID\n   * @param {string} equipment.type Armor/Shield type\n   * @param {object} armorData Armor data object\n   */\n  _prepareArmorData({ id, type } = {}, armorData) {\n    armorData.type = type ?? null;\n\n    const itemData = this.items.get(id)?.system;\n    if (!itemData) return;\n\n    armorData.ac = itemData.armor.value ?? 0;\n    armorData.enh = itemData.armor.enh ?? 0;\n    armorData.total = armorData.ac + armorData.enh;\n    if (!Number.isFinite(armorData.total)) armorData.total = 0;\n  }\n\n  /**\n   * Retrieve data used to fill in roll variables.\n   *\n   * @example\n   * ```js\n   * await new Roll(\"1d20 + @abilities.wis.mod[Wis]\", actor.getRollData()).toMessage();\n   * ```\n   *\n   * @override\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.refresh] - Refresh cache\n   * @param {boolean} [options.cache] - Use cache. If set to false, new fresh copy is returned without caching it.\n   * @returns {object} - Roll data object\n   */\n  getRollData(options = { refresh: false, cache: true }) {\n    // Return cached data, if applicable\n    const skipRefresh = !options.refresh && this._rollData && options.cache;\n\n    const result = { ...(skipRefresh ? this._rollData : foundry.utils.deepClone(this.system)) };\n\n    ffd20.utils.rollData.addStatic(result);\n\n    // Clear certain fields if not refreshing\n    if (skipRefresh) {\n      for (const key of ffd20.config.temporaryRollDataFields.actor) {\n        // Cleanup has no deep paths, so we can directly delete them\n        // TODO: Move this cleanup to whatever adds the data\n        delete result[key];\n      }\n    }\n\n    /* ----------------------------- */\n    /* Always add the following data\n    /* ----------------------------- */\n\n    // Add combat round, if in combat\n    if (game.combats?.viewed) {\n      result.combat = {\n        round: game.combat.round || 0,\n      };\n    }\n\n    // Add denied Dex to AC\n    result.conditions ??= {};\n    result.conditions.loseDexToAC = this.changeFlags?.loseDexToAC ?? false;\n\n    // Return cached data, if applicable\n    if (skipRefresh) return result;\n\n    /* ----------------------------- */\n    /* Set the following data on a refresh\n    /* ----------------------------- */\n\n    // Sync health values\n    for (const hpKey of [\"hp\", \"wounds\", \"vigor\"]) {\n      const hp = result.attributes[hpKey];\n      hp.value = hp.max + hp.offset;\n      /*\n      // Supporting values\n      const thp = hp.temp ?? 0;\n      hp.effective = hp.value + thp;\n      hp.ratio = hp.effective / (hp.max + thp);\n      */\n    }\n\n    // Sync mana values\n    for (const mpKey of [\"mp\"]) {\n      const mp = result.attributes[mpKey];\n      mp.value = mp.max + mp.offset;\n    }\n\n    // Set size index\n    const sizes = Object.values(ffd20.config.sizeChart);\n    result.size = Math.clamp(result.traits.size.value, 0, sizes.length - 1);\n\n    // Set age category index\n    const ageCategories = Object.keys(ffd20.config.ageCategories);\n    const maxAgeOffset = ageCategories.length - 1;\n    result.ageCategory = {\n      value: Math.clamp(result.traits?.ageCategory?.value, 0, maxAgeOffset),\n      physical: Math.clamp(result.traits?.ageCategory?.physical, 0, maxAgeOffset),\n      mental: Math.clamp(result.traits?.ageCategory?.mental, 0, maxAgeOffset),\n    };\n\n    // Add more info for formulas\n    result.armor = { type: 0, total: 0, ac: 0, enh: 0 };\n    result.shield = { type: 0, total: 0, ac: 0, enh: 0 };\n\n    // Determine equipped armor type\n    const eqData = this.equipment;\n    if (eqData) {\n      this._prepareArmorData(eqData.armor, result.armor);\n      this._prepareArmorData(eqData.shield, result.shield);\n    }\n\n    // Add spellbook info\n    result.spells = result.attributes.spells.spellbooks;\n    for (const book of Object.values(result.spells)) {\n      book.abilityMod = result.abilities[book.ability]?.mod ?? 0;\n      // Add alias\n      if (book.class && book.class !== \"_hd\") result.spells[book.class] ??= book;\n    }\n\n    // Add item dictionary flags\n    result.dFlags = this.itemFlags.dictionary ?? {};\n    result.bFlags = Object.fromEntries(\n      Object.entries(this.itemFlags.boolean ?? {}).map(([key, { sources }]) => [key, sources.length > 0 ? 1 : 0])\n    );\n\n    result.range = this.system.traits?.reach?.total ?? { melee: NaN, reach: NaN };\n\n    // Add class info\n    result.classes = this.classes;\n    const negLevels = result.attributes.energyDrain ?? 0;\n    if (negLevels > 0 && result.classes) {\n      for (const cls of Object.values(result.classes)) {\n        if (cls.isMythic) continue;\n        cls.level = Math.max(0, cls.unlevel - negLevels);\n      }\n    }\n\n    // Map HP ability\n    const hpAbility = result.abilities[result.attributes.hpAbility];\n    Object.defineProperty(result.attributes, \"hpAbility\", {\n      get() {\n        return hpAbility;\n      },\n    });\n\n    // @since PF1 v10\n    result.alignment = ffd20.utils.parseAlignment(this.system.details?.alignment || \"tn\");\n\n    if (options.cache) {\n      this._rollData = result;\n    }\n\n    // Call hook\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  /**\n   * Get melee and reach maximum ranges.\n   *\n   * @param {ActorSize|number} size - Actor size as size key or number\n   * @param {ActorStature} stature - Actor stature\n   * @returns {{melee:number,reach:number}} - Ranges\n   */\n  static getReach(size = \"med\", stature = \"tall\") {\n    let effectiveSize = size >= 0 ? size : Object.keys(ffd20.config.sizeChart).indexOf(size);\n    // Long creatures larger than medium count as one size smaller\n    // https://www.aonprd.com/Rules.aspx?ID=179\n    if (stature !== \"tall\" && effectiveSize > 4) effectiveSize -= 1;\n\n    const reachStruct = (melee, reach) => ({ melee, reach });\n\n    switch (effectiveSize) {\n      case 0: // Fine\n      case 1: // Diminutive\n        return reachStruct(0, 0);\n      case 2: // Tiny\n        return reachStruct(0, 5);\n      default:\n      case 3: // Small\n      case 4: // Medium\n        return reachStruct(5, 10);\n      case 5: // Large\n        return reachStruct(10, 20);\n      case 6: // Huge\n        return reachStruct(15, 30);\n      case 7: // Gargantuan\n        return reachStruct(20, 40);\n      case 8: // Colossal\n        return reachStruct(30, 60);\n    }\n  }\n\n  /**\n   * @protected\n   * @returns {Array<object>} - Array of item defining objects\n   */\n  getQuickActions() {\n    return this.items\n      .filter((o) => o.isActive && o.system.showInQuickbar === true && o.showUnidentifiedData !== true)\n      .sort((a, b) => a.sort - b.sort)\n      .map((item) => {\n        const qi = {\n          item,\n          name: item.name,\n          id: item.id,\n          type: item.type,\n          img: item.img,\n          get isSingleUse() {\n            return item.isSingleUse;\n          },\n          get haveAnyCharges() {\n            return this.item.isCharged && this.maxCharge > 0;\n          },\n          get maxCharge() {\n            return item.maxCharges;\n          },\n          get charges() {\n            return this.item.charges;\n          },\n        };\n\n        // Fill in charge details\n        qi.isCharged = qi.haveAnyCharges;\n        if (qi.isCharged) {\n          let chargeCost =\n            item.defaultAction?.getChargeCostSync({ maximize: true })?.total ?? item.getDefaultChargeCost();\n          //if (chargeCost == 0) qi.isCharged = false;\n\n          qi.recharging = chargeCost < 0;\n          chargeCost = Math.abs(chargeCost);\n\n          qi.uses = qi.charges;\n          qi.max = qi.maxCharge;\n\n          if (!Number.isFinite(qi.max)) {\n            delete qi.max; // Infinite\n          } else if (chargeCost != 0) {\n            // Maximum charging\n            if (qi.recharging) {\n              qi.uses = Math.ceil((qi.max - qi.uses) / chargeCost);\n              qi.max = Math.ceil(qi.max / chargeCost);\n            }\n            // Actual uses\n            else {\n              qi.uses = Math.floor(qi.uses / chargeCost);\n              qi.max = Math.floor(qi.max / chargeCost);\n            }\n          }\n        } else {\n          const action = item.defaultAction;\n          // Add fake charges for ammo using items\n          if (action?.ammo.type) {\n            const ammo = item.defaultAmmo;\n            if (ammo) {\n              qi.isCharged = true;\n              qi.uses = ammo.system.quantity || 0;\n            }\n          }\n        }\n\n        return qi;\n      });\n  }\n\n  /**\n   * @internal\n   */\n  refreshAbilityModifiers() {\n    for (const abl of Object.values(this.system.abilities)) {\n      const penalty = Math.abs(abl.penalty || 0);\n      const damage = abl.damage || 0;\n      const newMod = ffd20.utils.getAbilityModifier(abl.total, { penalty, damage });\n      abl.mod = newMod;\n    }\n  }\n\n  /**\n   * Return feat counts.\n   *\n   * @typedef FeatCounts\n   * @type {object}\n   * @property {number} max - The maximum allowed feats.\n   * @property {number} active - The current number of active feats.\n   * @property {number} owned - The current number of feats, active or not.\n   * @property {number} levels - Feats gained by levels specifically\n   * @property {number} mythic - Mythic feats\n   * @property {number} formula - Feats gained by custom formula on the feats tab\n   * @property {number} changes - Feats gained via Changes\n   * @property {number} disabled - Disabled feats\n   * @property {number} excess - Feats over maximum allowed\n   * @property {number} missing - Feats under maximum allowed\n   * @returns {FeatCounts} An object with a property `value` which refers to the current used feats, and `max` which refers to the maximum available feats.\n   */\n  getFeatCount() {\n    const feats = this.itemTypes.feat.filter((o) => o.subType === \"feat\");\n\n    const active = feats.filter((o) => o.isActive).length;\n    const owned = feats.length;\n\n    const result = {\n      max: 0,\n      active,\n      owned,\n      disabled: owned - active,\n      levels: 0,\n      mythic: 0,\n      formula: 0,\n      changes: 0,\n      // Count totals\n      get discrepancy() {\n        return this.max - this.active;\n      },\n      get missing() {\n        return Math.max(0, this.discrepancy);\n      },\n      get excess() {\n        return Math.max(0, -this.discrepancy);\n      },\n    };\n\n    const isMindless = this.system.abilities?.int?.value === null;\n\n    // Ignore classes for feats with mindless\n    // Mindless gets other bonuses to feats beyond these...\n    // ... since they can be explicit \"gains X feat\", homebrew, or other impossible to account for.\n    if (!isMindless) {\n      // Add feat count by level\n      result.levels = Math.ceil(this.system.attributes.hd.total / 2);\n      result.max += result.levels;\n\n      // Mythic feats\n      // https://aonprd.com/Rules.aspx?Name=Mythic%20Heroes&Category=Mythic%20Rules\n      // Gained at 1, 3, 5, etc.\n      result.mythic = Math.ceil(this.system.details.mythicTier / 2);\n      result.max += result.mythic;\n    }\n\n    // Bonus feat formula\n    const bonusRoll = RollPF.safeRollSync(this.system.details?.bonusFeatFormula || \"0\", this.getRollData());\n    result.formula = bonusRoll.total;\n    result.max += result.formula;\n    if (bonusRoll.err) {\n      console.error(\n        `An error occurred in the Bonus Feat Formula of actor \"${this.name}\" [${this.id}].`,\n        {\n          formula: this.system.details?.bonusFeatFormula,\n          actor: this,\n        },\n        bonusRoll.err\n      );\n    }\n\n    // Bonuses from changes\n    result.changes = getHighestChanges(\n      this.changes.filter((c) => {\n        if (c.target !== \"bonusFeats\") return false;\n        return c.operator !== \"set\";\n      }),\n      { ignoreTarget: true }\n    ).reduce((cur, c) => cur + c.value, 0);\n    result.max += result.changes;\n\n    return result;\n  }\n\n  /**\n   * Check if actor has item with specified boolean flag.\n   *\n   * @param {string} flagName - The name/key of the flag to search for.\n   * @returns {boolean} Whether this actor has any owned item with the given flag.\n   */\n  hasItemBooleanFlag(flagName) {\n    return this.itemFlags.boolean[flagName] != null;\n  }\n\n  /**\n   * Restore spellbook used slots and spellpoints.\n   *\n   * @param {object} [options] Additional options\n   * @param {boolean} [options.commit=true] If false, return update data object instead of directly updating the actor.\n   * @param {object} [options.rollData] Roll data\n   * @returns {Promise<this|object>} Result of update or the update data.\n   */\n  async resetSpellbookUsage({ commit = true, rollData } = {}) {\n    const actorData = this.system;\n    const updateData = {};\n\n    rollData ??= this.getRollData();\n\n    // Update spellbooks\n    for (const [bookId, spellbook] of Object.entries(actorData.attributes.spells.spellbooks)) {\n      if (!spellbook.inUse) continue;\n\n      // Restore spellbooks using spell points\n      if (spellbook.spellPoints.useSystem) {\n        // Try to roll restoreFormula, fall back to restoring max spell points\n        let restorePoints = spellbook.spellPoints.max;\n        if (spellbook.spellPoints.restoreFormula) {\n          const restoreRoll = await RollPF.safeRoll(\n            spellbook.spellPoints.restoreFormula,\n            rollData,\n            undefined,\n            undefined,\n            { allowInteractive: false }\n          );\n          if (restoreRoll.err) console.error(restoreRoll.err, spellbook.spellPoints.restoreFormula);\n          else restorePoints = Math.min(spellbook.spellPoints.value + restoreRoll.total, spellbook.spellPoints.max);\n        }\n        updateData[`system.attributes.spells.spellbooks.${bookId}.spellPoints.value`] = restorePoints;\n      }\n      // Restore spell slots\n      else {\n        for (let level = 0; level < 10; level++) {\n          updateData[`system.attributes.spells.spellbooks.${bookId}.spells.spell${level}.value`] =\n            spellbook.spells[`spell${level}`]?.max ?? 0;\n        }\n      }\n    }\n\n    if (commit) return this.update(updateData);\n    return updateData;\n  }\n\n  /**\n   * Recharge all owned items.\n   *\n   * @see {@link ffd20.documents.item.ItemPF.recharge}\n   *\n   * @example\n   * Recharge items with default settings.\n   * ```js\n   * await actor.rechargeItems();\n   * ```\n   * Recharge items as if week had passed.\n   * ```js\n   * await actor.rechargeItems({ period: \"week\" });\n   * ```\n   *\n   * @param {RechargeActorItemsOptions} [options] - Additional options\n   * @returns {Promise<Item[]|object[]>} - Result of an update or the update data.\n   */\n  async rechargeItems({ commit = true, ...rechargeOptions } = {}) {\n    const itemUpdates = [];\n\n    // Update charged items\n    // TODO: Await all item recharges in one go.\n    for (const item of this.items) {\n      const itemUpdate = await item.recharge({ ...rechargeOptions, commit: false });\n\n      // Append update to queue\n      if (itemUpdate?.system && !foundry.utils.isEmpty(itemUpdate.system)) {\n        itemUpdate._id = item.id;\n        itemUpdates.push(itemUpdate);\n      }\n    }\n\n    if (commit) {\n      if (itemUpdates.length) return this.updateEmbeddedDocuments(\"Item\", itemUpdates);\n    } else return itemUpdates;\n    return [];\n  }\n\n  /**\n   * Handler for character healing during rest.\n   *\n   * @protected\n   * @param {object} options Resting options.\n   * @returns {object} Update data object\n   */\n  _restingHeal(options = {}) {\n    const actorData = this.system,\n      hp = actorData.attributes.hp,\n      mp = actorData.attributes.mp,\n      wounds = actorData.attributes?.wounds,\n      vigor = actorData.attributes?.vigor;\n\n    const { hours, longTermCare } = options;\n    const updateData = {};\n\n    /** @type {number} */\n    const hd = actorData.attributes.hd.total;\n\n    // Base healing\n    const mprev = actorData.attributes.mp.recover;\n    const heal = {\n      hp: hd,\n      mp: mprev, // change this to reflect total caster level and casting mods\n      abl: 1,\n      nonlethal: hours * hd,\n      vigor: vigor?.max ?? 0,\n      wounds: wounds?.max > 0 ? 1 : 0,\n    };\n\n    // -- Normal Hit Points ---\n\n    // Full day of resting\n    if (hours >= 24) {\n      heal.hp += 1;\n      heal.mp *= 2;\n      heal.wounds += Math.floor(hd / 2);\n      heal.abl += 1;\n    }\n    // Long term care\n    if (longTermCare === true) {\n      heal.hp *= 2;\n      heal.mp *= 2;\n      heal.abl *= 2;\n      heal.wounds *= 2;\n    }\n\n    updateData[\"system.attributes.hp.value\"] = Math.min(hp.value + heal.hp, hp.max);\n    updateData[\"system.attributes.mp.value\"] = Math.min(mp.value + heal.mp, mp.max);\n    updateData[\"system.attributes.hp.nonlethal\"] = Math.max(0, (hp.nonlethal || 0) - heal.nonlethal);\n    for (const [key, abl] of Object.entries(actorData.abilities)) {\n      const dmg = Math.abs(abl.damage);\n      updateData[`system.abilities.${key}.damage`] = Math.max(0, dmg - heal.abl);\n    }\n\n    // --- Wounds & Vigor ---\n\n    // Secondary actors don't use W&V rules\n    if (wounds?.max && vigor?.max) {\n      updateData[\"system.attributes.wounds.value\"] = Math.min(wounds.value + heal.wounds, wounds.max);\n      updateData[\"system.attributes.vigor.value\"] = Math.min(vigor.value + heal.vigor, vigor.max);\n    }\n\n    return updateData;\n  }\n\n  /**\n   * Perform all changes related to an actor resting, including restoring HP, ability scores, item uses, etc.\n   *\n   * @example\n   * Rest with default settings\n   * ```js\n   * await actor.performRest();\n   * ```\n   *\n   * @see {@link hookEvents!pf1PreActorRest pf1PreActorRest hook}\n   * @see {@link hookEvents!pf1ActorRest pf1ActorRest hook}\n   * @param {Partial<ActorRestOptions>} options - Options affecting an actor's resting\n   * @returns {Promise<ActorRestData | void>} Updates applied to the actor, if resting was completed\n   */\n  async performRest(options = {}) {\n    const { restoreHealth = true, longTermCare = false, restoreDailyUses = true, hours = 8, verbose = false } = options;\n\n    const updateData = {};\n    // Restore health and ability damage\n    if (restoreHealth === true) {\n      const healUpdate = this._restingHeal(options);\n      foundry.utils.mergeObject(updateData, healUpdate);\n    }\n\n    let itemUpdates = [];\n    // Restore daily uses of spells, feats, etc.\n    if (restoreDailyUses === true) {\n      const spellbookUpdates = await this.resetSpellbookUsage({ commit: false });\n      foundry.utils.mergeObject(updateData, spellbookUpdates);\n\n      // Recharge all items (including spells for prepared spellbooks)\n      itemUpdates = await this.rechargeItems({ commit: false, updateData, period: \"day\" });\n    }\n\n    options = { restoreHealth, restoreDailyUses, longTermCare, hours };\n    const allowed = Hooks.call(\"pf1PreActorRest\", this, options, updateData, itemUpdates);\n    if (allowed === false) return;\n\n    const context = { ffd20: { action: \"rest\", restOptions: options } };\n\n    if (itemUpdates.length) await this.updateEmbeddedDocuments(\"Item\", itemUpdates, foundry.utils.deepClone(context));\n    if (!foundry.utils.isEmpty(updateData.system)) await this.update(updateData, foundry.utils.deepClone(context));\n\n    Hooks.callAll(\"pf1ActorRest\", this, options, updateData, itemUpdates);\n\n    if (verbose) {\n      const message = restoreDailyUses ? \"FFD20.FullRestMessage\" : \"FFD20.RestMessage\";\n      ui.notifications.info(game.i18n.format(message, { name: this.token?.name ?? this.name, hours }));\n    }\n\n    return { options, updateData, itemUpdates };\n  }\n\n  /**\n   * @protected\n   * @override\n   */\n  async modifyTokenAttribute(attribute, value, isDelta = false, isBar = true) {\n    let doc = this;\n    const current = foundry.utils.getProperty(this.system, attribute),\n      updates = {};\n\n    const isResource = current instanceof Resource;\n    if (isResource) doc = current.item;\n\n    if (!doc) return;\n\n    // Hit points\n    if (attribute === \"attributes.hp\") {\n      if (!isDelta) value = (current.temp + current.value - value) * -1;\n      let dt = value;\n      if (current.temp > 0 && value < 0) {\n        dt = Math.min(0, current.temp + value);\n        updates[\"system.attributes.hp.temp\"] = Math.max(0, current.temp + value);\n      }\n      updates[\"system.attributes.hp.value\"] = Math.min(current.value + dt, current.max);\n    }\n    // Wounds & Vigor\n    else if (attribute === \"attributes.vigor\") {\n      if (!isDelta) value = (current.temp + current.value - value) * -1;\n      let dt = value;\n      if (current.temp > 0 && value < 0) {\n        dt = Math.min(0, current.temp + value);\n        updates[\"system.attributes.vigor.temp\"] = Math.max(0, current.temp + value);\n      }\n      updates[\"system.attributes.vigor.value\"] = Math.min(current.value + dt, current.max);\n    }\n    // Relative\n    else if (isDelta) {\n      if (isResource) {\n        updates[\"system.uses.value\"] = Math.min(current.value + value, current.max);\n      } else {\n        if (isBar)\n          updates[`system.${attribute}.value`] = Math.clamp(current.value + value, current.min || 0, current.max);\n        else updates[`system.${attribute}`] = current + value;\n      }\n    }\n    // Absolute\n    else {\n      if (isResource) {\n        updates[\"system.uses.value\"] = Math.clamp(value, 0, current.max);\n      } else {\n        if (isBar) updates[`system.${attribute}.value`] = Math.min(value, current.max);\n        else updates[`system.${attribute}`] = value;\n      }\n    }\n\n    const allowed = Hooks.call(\"modifyTokenAttribute\", { attribute, value, isDelta, isBar }, updates);\n    return allowed !== false ? doc.update(updates) : this;\n  }\n\n  /**\n   * The VisionSharingSheet instance for this actor\n   *\n   * @type {VisionSharingSheet}\n   */\n  get visionSharingSheet() {\n    this._visionSharingSheet ??= new VisionSharingSheet({ document: this });\n    return this._visionSharingSheet;\n  }\n}\n\n/**\n * @typedef {object} ActorRestOptions\n * Options given to {@link ActorPF.performRest} affecting an actor's resting.\n * @property {boolean} [restoreHealth=true] - Whether the actor's health should be restored.\n * @property {boolean} [restoreDailyUses=true] - Whether daily uses of spells and abilities should be restored.\n * @property {boolean} [longTermCare=false] - Whether additional hit and ability score points should be restored through the Heal skill.\n * @property {number} [hours=8] - The number of hours the actor will rest.\n * @property {boolean} [verbose=false] - Display notification once rest processing finishes.\n */\n\n/**\n * @typedef {object} ActorRestData\n * @property {ActorRestOptions} options - Options for resting\n * @property {object} updateData - Updates applied to the actor\n * @property {object[]} itemUpdates - Updates applied to the actor's items\n */\n\n/**\n * @typedef {object} DamageInstance\n * @property {number} value - Total damage in this instance\n * @property {object} types - Damage type data\n * @property {string} types.custom - Custom damage types\n * @property {string[]} types.values - Standard damage types\n */\n\n/**\n * @typedef {object} ItemContextNotes\n * @property {Item} item - Item from which the notes are from\n * @property {Array<string>} notes - Note strings\n * @property {Array<string>} enriched - Enriched note things\n */\n\n/**\n * @typedef {object} ParsedContextNoteEntry\n * @property {string} text - Enriched note text\n * @property {string|undefined} source - Source label if any\n */\n","import { ActorPF } from \"@actor/actor-pf.mjs\";\nimport { getSourceInfo, getChangeFlat } from \"@actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * Shared functionality for {@link ffd20.documents.actor.ActorCharacterPF | PCs} and {@link ffd20.documents.actor.ActorNPCPF | NPCs}.\n *\n * @todo Move PC/NPC functionality from ActorPF here.\n *\n * @abstract\n */\nexport class BaseCharacterPF extends ActorPF {\n  /** @inheritDoc */\n  _detectHealthChange(changed, context) {\n    super._detectHealthChange(changed, context);\n\n    const deltas = context.ffd20?.deltas ?? {};\n\n    const hpData = changed.system?.attributes;\n\n    if (hpData) {\n      const oldHpData = this.system.attributes;\n\n      for (const type of [\"hp\", \"wounds\", \"vigor\"]) {\n        const hp = hpData[type];\n        if (!hp) continue;\n        for (const key of [\"offset\", \"temp\", \"nonlethal\"]) {\n          if (hp[key] === undefined) continue;\n          const diff = hp[key] - (oldHpData?.[type]?.[key] || 0);\n          if (diff && Number.isFinite(diff)) {\n            deltas[type] ??= {};\n            deltas[type][key] = diff;\n          }\n        }\n      }\n    }\n\n    const abilities = changed.system.abilities;\n    if (abilities) {\n      const oldAblData = this.system.abilities;\n      for (const [ablKey, ablData] of Object.entries(abilities)) {\n        for (const key of [\"damage\", \"drain\", \"userPenalty\"]) {\n          if (ablData[key] === undefined) continue;\n          const diff = ablData[key] - (oldAblData?.[ablKey]?.[key] ?? 0);\n          if (diff && Number.isFinite(diff)) {\n            deltas[ablKey] ??= {};\n            deltas[ablKey][key] = diff;\n          }\n        }\n      }\n    }\n\n    if (changed.system.attributes?.energyDrain !== undefined) {\n      const diff = changed.system.attributes?.energyDrain - this.system.attributes.energyDrain;\n      if (diff && Number.isFinite(diff)) {\n        deltas.energyDrain = diff;\n      }\n    }\n\n    if (Object.keys(deltas).length > 0) {\n      context.ffd20 ??= {};\n      context.ffd20.deltas = deltas;\n    }\n  }\n\n  /** @override */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    this._onDeltaUpdates(context.ffd20?.deltas);\n  }\n\n  /**\n   * Handle Deltas in update context\n   *\n   * Produces scrolling text for health changes.\n   *\n   * @param {Promise<object>} deltas\n   */\n  async _onDeltaUpdates(deltas) {\n    if (!deltas) return;\n\n    // TODO: Maybe allow if the token has visible HP bar regardless?\n    if (!game.user.isGM && !this.testUserPermission(game.user, game.settings.get(\"ffd20\", \"healthPermission\"))) return;\n\n    // TODO: Support multiple tokens?\n    let token = this.token ?? this.getActiveTokens(true, true)[0];\n\n    if (!game.user.isGM && !token.object.isVisible) token = null;\n\n    if (!token) return;\n\n    const deltaLabels = {\n      hp: {\n        offset: {\n          label: \"FFD20.ActiveFeedback.Deltas.Health\",\n          color: ffd20.config.feedback.deltas.hp,\n        },\n        temp: {\n          label: \"FFD20.ActiveFeedback.Deltas.TempHP\",\n          color: ffd20.config.feedback.deltas.temp,\n        },\n        nonlethal: {\n          label: \"FFD20.ActiveFeedback.Deltas.Nonlethal\",\n          color: ffd20.config.feedback.deltas.nonlethal,\n        },\n      },\n      wounds: {\n        offset: {\n          label: \"FFD20.ActiveFeedback.Deltas.Wounds\",\n          color: ffd20.config.feedback.deltas.wounds,\n        },\n      },\n      vigor: {\n        offset: {\n          label: \"FFD20.ActiveFeedback.Deltas.Vigor\",\n          color: ffd20.config.feedback.deltas.vigor,\n        },\n        temp: {\n          label: \"FFD20.ActiveFeedback.Deltas.TempVigor\",\n          color: ffd20.config.feedback.deltas.temp,\n        },\n      },\n      energyDrain: {\n        label: \"FFD20.ActiveFeedback.Deltas.NegativeLevel\",\n        color: ffd20.config.feedback.deltas.energyDrain,\n      },\n      ability: {\n        damage: {\n          label: \"FFD20.ActiveFeedback.Deltas.AbilityDamage\",\n          color: ffd20.config.feedback.deltas.abilityScore,\n        },\n        drain: {\n          label: \"FFD20.ActiveFeedback.Deltas.AbilityDrain\",\n          color: ffd20.config.feedback.deltas.abilityScore,\n        },\n        userPenalty: {\n          label: \"FFD20.ActiveFeedback.Deltas.AbilityPenalty\",\n          color: ffd20.config.feedback.deltas.abilityScore,\n        },\n      },\n    };\n\n    const formatter = new Intl.NumberFormat(undefined, { signDisplay: \"always\" }).format;\n\n    for (const key of Object.keys(deltas)) {\n      const labels = [];\n      switch (key) {\n        case \"hp\":\n        case \"wounds\":\n        case \"vigor\":\n          for (const [hpKey, value] of Object.entries(deltas[key])) {\n            const conf = deltaLabels[key][hpKey];\n            if (conf) {\n              const positive = value > 0;\n              const color = positive ? conf.color.positive : conf.color.negative;\n              labels.push({\n                label: game.i18n.format(conf.label, { value: formatter(value) }),\n                positive,\n                color,\n                value,\n                key: `${key}.${hpKey}`,\n              });\n            } else console.debug(\"Unrecognized delta:\", key, hpKey, value);\n          }\n          break;\n        case \"energyDrain\": {\n          const diff = deltas[key];\n          const conf = deltaLabels.energyDrain;\n          const positive = diff < 0;\n          const color = positive ? conf.color.positive : conf.color.negative;\n          labels.push({\n            label: game.i18n.format(conf.label, { value: formatter(diff) }),\n            positive,\n            color,\n            value: diff,\n            key,\n          });\n          break;\n        }\n        default:\n          if (key in ffd20.config.abilities) {\n            for (const [dmgKey, diff] of Object.entries(deltas[key])) {\n              const ablName = ffd20.config.abilities[key];\n              const conf = deltaLabels.ability[dmgKey];\n              if (ablName && conf) {\n                const positive = diff < 0;\n                const color = positive ? conf.color.positive : conf.color.negative;\n                labels.push({\n                  label: game.i18n.format(conf.label, { value: formatter(diff), ability: ablName }),\n                  positive,\n                  color,\n                  value: diff,\n                  key: `${key}.${dmgKey}`,\n                });\n              } else {\n                console.debug(\"Unrecognized ability score delta:\", key, dmgKey, deltas[key]?.[dmgKey]);\n              }\n            }\n          } else {\n            console.warn(\"Unrecognized delta:\", key, deltas[key]);\n          }\n          break;\n      }\n\n      // Print the actual message.\n      let t0 = 0;\n      for (const options of labels) {\n        const { positive, color } = options;\n\n        // Roughly scale based on canvas resolution with some lower end clamping\n        // TODO: Adjust size based on how \"large\" the change was\n        const fontSize = Math.max(canvas.grid.size / 3, 24);\n\n        const textData = {\n          anchor: CONST.TEXT_ANCHOR_POINTS.CENTER,\n          direction: positive ? CONST.TEXT_ANCHOR_POINTS.TOP : CONST.TEXT_ANCHOR_POINTS.BOTTOM,\n          // duration: 2000,\n          fontSize,\n          fill: color,\n          stroke: 0x000000,\n          strokeThickness: 2.5,\n          jitter: 0.5,\n        };\n\n        if (Hooks.call(\"pf1HealthDeltaRender\", this, options, textData) === false) continue;\n\n        const t1 = performance.now();\n\n        // Prevent scrolling text from overlapping too much\n        const sinceLast = t1 - t0;\n        if (sinceLast < 200) {\n          await new Promise((resolve) => setTimeout(() => resolve(), Math.max(10, 200 - sinceLast)));\n        }\n        t0 = t1;\n\n        console.debug(\"FFD20 |\", options.label, \"|\", this.uuid);\n        canvas.interface.createScrollingText(token.object.center, options.label, textData);\n      }\n    }\n  }\n\n  /**\n   * @protected\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    const system = this.system;\n\n    system.traits ??= {};\n\n    // Prepare size data\n    const baseSize = system.traits.size || \"med\";\n    const sizeValue = Object.keys(ffd20.config.sizeChart).indexOf(baseSize);\n    system.traits.size = {\n      base: baseSize,\n      value: sizeValue,\n    };\n\n    // Prepare age category data\n    const baseAge = system.traits.ageCategory || \"adult\";\n    const ageValue = Object.keys(ffd20.config.ageCategories).indexOf(baseAge);\n    system.traits.ageCategory = {\n      base: baseAge,\n      value: ageValue,\n      physical: ageValue,\n      mental: ageValue,\n    };\n\n    // Prepare skills\n    const skills = system.skills;\n    for (const skill of Object.values(skills)) {\n      if (!skill) continue; // Shouldn't happen\n\n      skill.rank ||= 0;\n      skill.mod = 0;\n\n      for (const subSkill of Object.values(skill.subSkills || {})) {\n        if (!subSkill) continue; // Shouldn't happen\n        subSkill.rank ||= 0;\n        subSkill.mod = 0;\n      }\n    }\n  }\n\n  /** @inheritDoc  */\n  _prepareTypeChanges(changes) {\n    // Call hook\n    const tempChanges = [];\n    if (Hooks.events.pf1AddDefaultChanges?.length) {\n      Hooks.callAll(\"pf1AddDefaultChanges\", this, tempChanges);\n    }\n    changes.push(...tempChanges.filter((c) => c instanceof ffd20.components.ItemChange));\n\n    const allClasses = this.itemTypes.class.sort((a, b) => a.sort - b.sort);\n\n    this._calculateMaxHealth(allClasses, changes);\n    this._calculateMaxMana(allClasses, changes);\n\n    const system = this.system;\n\n    // Add class data to saving throws\n    const useFractional = game.settings.get(\"ffd20\", \"useFractionalBaseBonuses\") === true;\n    for (const a of Object.keys(system.attributes.savingThrows)) {\n      let hasGoodSave = false;\n      system.attributes.savingThrows[a].total = system.attributes.savingThrows[a]?.base ?? 0;\n\n      const total = allClasses.reduce((cur, cls) => {\n        const base = cls.system.savingThrows[a].base;\n\n        if (!useFractional) {\n          // Add per class change\n          changes.push(\n            new ffd20.components.ItemChange({\n              formula: base,\n              target: a,\n              type: \"untypedPerm\",\n              flavor: cls.name,\n            })\n          );\n        } else {\n          if (cls.system.savingThrows[a].good === true) hasGoodSave = true;\n        }\n        return cur + base;\n      }, 0);\n\n      if (useFractional) {\n        // Add shared change with fractional\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: Math.floor(total),\n            target: a,\n            type: \"untypedPerm\",\n            flavor: game.i18n.localize(\"FFD20.Base\"),\n          })\n        );\n      }\n\n      // Fractional bonus +2 when one class has good save\n      if (useFractional && hasGoodSave) {\n        const goodSaveFormula = ffd20.config.classFractionalSavingThrowFormulas.goodSaveBonus;\n        const total = RollPF.safeRollSync(goodSaveFormula).total;\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: total,\n            target: a,\n            type: \"untypedPerm\",\n            flavor: game.i18n.localize(\"FFD20.SavingThrowGoodFractionalBonus\"),\n          })\n        );\n      }\n    }\n\n  // add mp recovery\n  let mpCasterLevel = 0;\n  let mpAbilityint = false;\n  let mpAbilitywis = false;\n  let mpAbilitycha = false;\n  allClasses.forEach((mpclass) => {\n    if (mpclass.system.classCastingStat !== \"\" || mpclass.system.classCastingStat !== \"noncaster\") {\n      if (mpclass.system.classBaseMPTypes === \"halfCaster\" && mpclass.system.level > 3) {\n        mpCasterLevel = mpCasterLevel + (mpclass.system.level - 3);\n      } else {\n        mpCasterLevel = mpCasterLevel + mpclass.system.level;\n      }\n      if (mpclass.system.classCastingStat === \"intAndWis\" || mpclass.system.classCastingStat === \"int\") {\n        mpAbilityint = true;\n      }\n      if (mpclass.system.classCastingStat === \"intAndWis\" || mpclass.system.classCastingStat === \"wis\") {\n        mpAbilitywis = true;\n      }\n      if (mpclass.system.classCastingStat === \"cha\") {\n        mpAbilitycha = true;\n      }\n    }\n  });\n\n  changes.push(\n    new ffd20.components.ItemChange({\n      formula: mpCasterLevel,\n      target: \"mprec\",\n      type: \"untypedPerm\",\n      flavor: \"Mp recovery from total Caster Levels\",\n    })\n  );\n  if (mpAbilityint)\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"@abilities.int.mod\",\n        target: \"mprec\",\n        type: \"untypedPerm\",\n        flavor: \"Mp recovery from Intelligence\",\n      })\n    );\n  if (mpAbilitywis)\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"@abilities.wis.mod\",\n        target: \"mprec\",\n        type: \"untypedPerm\",\n        flavor: \"Mp recovery from Wisdom\",\n      })\n    );\n  if (mpAbilitycha)\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"@abilities.cha.mod\",\n        //operator: \"add\",\n        target: \"mprec\",\n        type: \"untypedPerm\",\n        flavor: `Mp recovery from Charisma`,\n      })\n    );\n\n    // Add Constitution to HP\n    const hpAbility = system.attributes.hpAbility;\n    if (hpAbility) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"@attributes.hpAbility.mod * @attributes.hd.total\",\n          operator: \"add\",\n          target: \"mhp\",\n          type: \"base\",\n          flavor: ffd20.config.abilities[hpAbility],\n        })\n      );\n\n      if (!system.attributes.wounds?.base) {\n        // > a creature has a number of wound points equal to twice its Constitution score.\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: \"@attributes.hpAbility.undrained * 2\",\n            operator: \"add\",\n            target: \"wounds\",\n            type: \"base\",\n            flavor: ffd20.config.abilities[hpAbility],\n          })\n        );\n        // > It also has a wound threshold equal to its Constitution score.\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: \"@attributes.hpAbility.undrained\",\n            operator: \"add\",\n            target: \"woundThreshold\",\n            type: \"base\",\n            flavor: ffd20.config.abilities[hpAbility],\n          })\n        );\n        // https://www.aonprd.com/Rules.aspx?ID=1157\n        // >  For each point of Constitution damage a creature takes, it loses 2 wound points\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: \"-(@attributes.hpAbility.damage * 2)\",\n            operator: \"add\",\n            target: \"wounds\",\n            type: \"untyped\",\n            flavor: game.i18n.localize(\"FFD20.AbilityDamage\"),\n          })\n        );\n        // > When a creature takes a penalty to its Constitution score or its Constitution is drained,\n        // > it loses 1 wound point per point of drain or per penalty\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: \"@attributes.hpAbility.penalty\", // no minus since penalty is negative inherently\n            operator: \"add\",\n            target: \"wounds\",\n            type: \"untyped\",\n            flavor: game.i18n.localize(`FFD20.Ability${hpAbility.capitalize()}Pen`),\n          })\n        );\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: \"-@attributes.hpAbility.drain\",\n            operator: \"add\",\n            target: \"wounds\",\n            type: \"untyped\",\n            flavor: game.i18n.localize(\"FFD20.AbilityDrain\"),\n          })\n        );\n      }\n    }\n\n    // Add skill changes\n    const addSKillChanges = (skill, target) => {\n      if (skill.rank > 0) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: skill.rank,\n            value: skill.rank,\n            target: `skill.~${target}`,\n            type: \"base\",\n            operator: \"add\",\n            flavor: game.i18n.localize(\"FFD20.SkillRankPlural\"),\n          })\n        );\n        if (skill.cs) {\n          changes.push(\n            new ffd20.components.ItemChange({\n              formula: ffd20.config.classSkillBonus,\n              value: ffd20.config.classSkillBonus,\n              target: `skill.~${target}`,\n              type: \"untyped\",\n              operator: \"add\",\n              flavor: game.i18n.localize(\"FFD20.CSTooltip\"),\n            })\n          );\n        }\n      }\n\n      if (skill.ability) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: `@abilities.${skill.ability}.mod`,\n            target: `skill.~${target}`,\n            operator: \"add\",\n            type: \"untyped\",\n            flavor: ffd20.config.abilities[skill.ability] || skill.ability,\n            priority: -10, // Stat buffing items don't work correctly without this\n          })\n        );\n\n        if (skill.acp) {\n          changes.push(\n            new ffd20.components.ItemChange({\n              formula: \"-@attributes.acp.skill\",\n              target: `skill.~${target}`,\n              type: \"untyped\",\n              operator: \"add\",\n              flavor: game.i18n.localize(\"FFD20.ACPLong\"),\n            })\n          );\n        }\n      }\n    };\n\n    const skills = system.skills;\n    for (const [skillId, skill] of Object.entries(skills)) {\n      if (!skill) continue; // Shouldn't happen\n      addSKillChanges(skill, skillId);\n\n      for (const [subSkillId, subSkill] of Object.entries(skill.subSkills || {})) {\n        if (!subSkill) continue; // Shouldn't happen\n        addSKillChanges(subSkill, `${skillId}.${subSkillId}`);\n      }\n    }\n\n    // Add movement speed(s)\n    for (const [mode, speed] of Object.entries(system.attributes.speed)) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: speed.base || 0,\n          target: `${mode}Speed`,\n          type: \"base\",\n          operator: \"set\",\n          priority: 1001,\n          flavor: game.i18n.localize(\"FFD20.Base\"),\n        })\n      );\n    }\n\n    // Add base attack modifiers shared by all attacks\n    // BAB to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        _id: \"_bab\", // HACK: Force ID to be special\n        formula: \"@attributes.bab.total\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n    // Negative levels to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.energyDrain\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n      })\n    );\n    // ACP to attack\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.acp.attackPenalty\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untyped\",\n        flavor: game.i18n.localize(\"FFD20.ArmorCheckPenalty\"),\n      })\n    );\n\n    // Add variables to CMD\n    // BAB to CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"@attributes.bab.total\",\n        operator: \"add\",\n        target: \"cmd\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n    // Strength or substitute to CMD\n    const strAbl = system.attributes.cmd.strAbility;\n    if (strAbl in ffd20.config.abilities) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${strAbl}.mod`,\n          target: \"cmd\",\n          type: \"untypedPerm\",\n          flavor: ffd20.config.abilities[strAbl],\n        })\n      );\n    }\n    // Negative levels to CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.energyDrain\",\n        operator: \"add\",\n        target: \"cmd\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n      })\n    );\n\n    // Add Dexterity Modifier to Initiative\n    const abl = system.attributes.init.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${abl}.mod`,\n          operator: \"add\",\n          target: \"init\",\n          type: \"untypedPerm\",\n          priority: -100,\n          flavor: ffd20.config.abilities[abl],\n        })\n      );\n    }\n\n    // Add ACP penalty\n    if ([\"str\", \"dex\"].includes(abl)) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"-@attributes.acp.attackPenalty\",\n          operator: \"add\",\n          target: \"init\",\n          type: \"untyped\",\n          priority: -100,\n          flavor: game.i18n.localize(\"FFD20.ArmorCheckPenalty\"),\n        })\n      );\n    }\n\n    // Add Ability modifiers and negative levels to saving throws\n    // Ability Mod to Fortitude\n    const fortAbl = system.attributes.savingThrows.fort.ability;\n    if (fortAbl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${fortAbl}.mod`,\n          operator: \"add\",\n          target: \"fort\",\n          type: \"untypedPerm\",\n          flavor: ffd20.config.abilities[fortAbl],\n        })\n      );\n    }\n    // Ability Mod to Reflex\n    const refAbl = system.attributes.savingThrows.ref.ability;\n    if (abl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${refAbl}.mod`,\n          operator: \"add\",\n          target: \"ref\",\n          type: \"untypedPerm\",\n          flavor: ffd20.config.abilities[refAbl],\n        })\n      );\n    }\n    // Ability Mod to Will\n    const willAbl = system.attributes.savingThrows.will.ability;\n    if (willAbl) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `@abilities.${willAbl}.mod`,\n          operator: \"add\",\n          target: \"will\",\n          type: \"untypedPerm\",\n          flavor: ffd20.config.abilities[willAbl],\n        })\n      );\n    }\n    // Negative level to saves\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.energyDrain\",\n        operator: \"add\",\n        target: \"allSavingThrows\",\n        type: \"untyped\",\n        flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n      })\n    );\n\n    // Spell Resistance\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: system.attributes.sr.formula || 0,\n        target: \"spellResist\",\n        type: \"untyped\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.CustomBonus\"),\n      })\n    );\n\n    // Carry capacity strength bonus\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: system.details.carryCapacity.bonus.user || 0,\n        target: \"carryStr\",\n        type: \"untyped\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Custom\"),\n      })\n    );\n    // Carry capacity multiplier\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: system.details.carryCapacity.multiplier.base ?? 1,\n        target: \"carryMult\",\n        type: \"base\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Base\"),\n      })\n    );\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: system.details.carryCapacity.multiplier.user || 0,\n        target: \"carryMult\",\n        type: \"untyped\",\n        priority: 1000,\n        flavor: game.i18n.localize(\"FFD20.Custom\"),\n      })\n    );\n\n    // NPC Lite Sheet Values for Init, CMD, BAB and AC\n    const liteValues = {\n      init: null,\n      cmd: null,\n      bab: null,\n      ac: (data) => data.normal,\n    };\n\n    for (const [key, valfn] of Object.entries(liteValues)) {\n      let value = system.attributes[key];\n      if (typeof valfn === \"function\") value = valfn(value);\n      value = value.value;\n\n      if (value !== undefined) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: value,\n            trget: key,\n            type: \"base\",\n            flavor: game.i18n.localize(\"FFD20.Custom\"),\n            operator: \"set\",\n          })\n        );\n      }\n    }\n\n    // Natural armor\n    const ac = system.attributes.naturalAC || 0;\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: ac,\n        target: \"nac\",\n        type: \"untyped\",\n        flavor: game.i18n.format(\"FFD20.CustomBonusType\", { type: game.i18n.localize(\"FFD20.NaturalArmor\") }),\n      })\n    );\n\n    // Add armor bonuses from equipment\n    for (const item of this.itemTypes.equipment) {\n      if (!item.system.equipped) continue;\n      // Ignore armor with zero value\n      const normalAC = item.system.armor?.value || 0;\n      const enhAC = item.system.armor?.enh || 0;\n      if (!(normalAC + enhAC)) continue;\n\n      const isBroken = item.isBroken;\n      let armorTarget = \"aac\";\n      if (item.system.subType === \"shield\") armorTarget = \"sac\";\n      // Push base armor\n      const baseAC = isBroken ? Math.floor(normalAC / 2) : normalAC;\n      const enhACEffective = isBroken ? Math.floor(enhAC / 2) : enhAC;\n      // Adjust broken AC to not cause extra reduction from halving both\n      // Proof: 5 / 2 base + 3 / 2 enh = 3, when it should be 8 / 2 = 4\n      const brokenAdjust = isBroken ? Math.floor(((normalAC % 2) + (enhAC % 2)) / 2) : 0;\n\n      // Add changes\n      changes.push(\n        new ffd20.components.ItemChange(\n          {\n            formula: baseAC,\n            value: baseAC,\n            target: armorTarget,\n            type: \"base\",\n          },\n          { parent: item }\n        )\n      );\n      changes.push(\n        new ffd20.components.ItemChange(\n          {\n            formula: enhACEffective + brokenAdjust,\n            value: enhACEffective + brokenAdjust,\n            target: armorTarget,\n            type: \"enhancement\",\n          },\n          { parent: item }\n        )\n      );\n    }\n\n    // Add fly bonuses or penalties based on maneuverability\n\n    const flyKey = system.attributes.speed.fly.maneuverability;\n    let flyValue = 0;\n    if (flyKey != null) flyValue = ffd20.config.flyManeuverabilityValues[flyKey];\n    if (flyValue !== 0) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: flyValue,\n          target: \"skill.fly\",\n          type: \"racial\",\n          flavor: game.i18n.localize(\"FFD20.Movement.FlyManeuverability.Label\"),\n        })\n      );\n    }\n\n    // Add swim and climb skill bonuses based on having speeds for them\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"(min(1, @attributes.speed.climb.total) * 8)\",\n        operator: \"add\",\n        target: \"skill.clm\",\n        type: \"racial\",\n        priority: -1,\n        flavor: game.i18n.localize(\"FFD20.Movement.Mode.climb\"),\n      })\n    );\n\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"(min(1, @attributes.speed.swim.total) * 8)\",\n        operator: \"add\",\n        target: \"skill.swm\",\n        type: \"racial\",\n        priority: -1,\n        flavor: game.i18n.localize(\"FFD20.Movement.Mode.swim\"),\n      })\n    );\n\n    // Negative level to skills\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.energyDrain\",\n        operator: \"add\",\n        target: \"skills\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n      })\n    );\n\n    // Wound Threshold to all skills\n    // BUG: This does nothing since the penalty is calculated independent of the change system\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"-@attributes.woundThresholds.penalty\",\n        operator: \"add\",\n        target: \"skills\",\n        type: \"untyped\",\n        flavor: game.i18n.localize(\"FFD20.WoundThreshold\"),\n      })\n    );\n\n    // Add size bonuses to various attributes\n    // AC\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"lookup(@size + 1, 0, \" + Object.values(ffd20.config.sizeMods).join(\", \") + \")\",\n        target: \"ac\",\n        type: \"size\",\n        flavor: game.i18n.localize(\"FFD20.ModifierType.size\"),\n        priority: -1000,\n      })\n    );\n    // Stealth skill\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"lookup(@size + 1, 0, \" + Object.values(ffd20.config.sizeStealthMods).join(\", \") + \")\",\n        target: \"skill.ste\",\n        type: \"size\",\n        flavor: game.i18n.localize(\"FFD20.ModifierType.size\"),\n        priority: -1000,\n      })\n    );\n    // Fly skill\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"lookup(@size + 1, 0, \" + Object.values(ffd20.config.sizeFlyMods).join(\", \") + \")\",\n        target: \"skill.fly\",\n        type: \"size\",\n        flavor: game.i18n.localize(\"FFD20.ModifierType.size\"),\n        priority: -1000,\n      })\n    );\n    // CMD\n    changes.push(\n      new ffd20.components.ItemChange({\n        formula: \"lookup(@size + 1, 0, \" + Object.values(ffd20.config.sizeSpecialMods).join(\", \") + \")\",\n        target: \"cmd\",\n        type: \"size\",\n        flavor: game.i18n.localize(\"FFD20.ModifierType.size\"),\n        priority: -1000,\n      })\n    );\n\n    // Add age modifiers to attributes\n    const ageCategories = Object.values(ffd20.config.ageCategories);\n    for (const key of [\"str\", \"dex\", \"con\", \"int\", \"wis\", \"cha\"]) {\n      const ageCategoryIdentifier = [\"str\", \"dex\", \"con\"].includes(key) ? \"physical\" : \"mental\";\n      const lookupStatement =\n        `lookup(@ageCategory.${ageCategoryIdentifier} + 1, 0, ` +\n        ageCategories.map((c) => c.modifiers[key]).join(\", \") +\n        \")\";\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: `ifelse(gt(@abilities.${key}.base + ${lookupStatement}, 0), ${lookupStatement}, -@abilities.${key}.base + 1)`,\n          target: key,\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.Age\"),\n          priority: 0,\n        })\n      );\n    }\n\n    // Custom skill rank bonus from sheet\n    if (system.details?.bonusSkillRankFormula) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: system.details.bonusSkillRankFormula,\n          target: \"bonusSkillRanks\",\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.SkillBonusRankFormula\"),\n        })\n      );\n    }\n\n    // Add conditions\n    for (const [con, v] of Object.entries(system.conditions)) {\n      if (!v) continue;\n      const condition = ffd20.registry.conditions.get(con);\n      const mechanics = condition?.mechanics;\n      if (!mechanics) continue;\n\n      // Add changes\n      for (const change of mechanics.changes) {\n        // Alter change data\n        const changeData = { ...change, flavor: condition.name };\n\n        // Create change object\n        const changeObj = new ffd20.components.ItemChange(changeData);\n        changes.push(changeObj);\n      }\n\n      // Set flags\n      for (const flag of mechanics.flags) {\n        this.changeFlags[flag] = true;\n      }\n    }\n\n    // Negative level to hit points and init\n    if (system.attributes.energyDrain > 0) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"-(@attributes.energyDrain * 5)\",\n          operator: \"add\",\n          target: \"mhp\",\n          type: \"untyped\",\n          priority: -750,\n          flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n        })\n      );\n\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"-(@attributes.energyDrain * 5)\",\n          operator: \"add\",\n          target: \"vigor\",\n          type: \"untyped\",\n          priority: -750,\n          flavor: game.i18n.localize(\"FFD20.NegativeLevels\"),\n        })\n      );\n    }\n  }\n\n  /**\n   * Calculate maximum health\n   *\n   * @internal\n   * @param {ItemClassPF[]} allClasses - All classes, sorted in order to be applied\n   * @param {ItemChange[]} changes - Changes to\n   */\n  _calculateMaxHealth(allClasses, changes) {\n    // Categorize classes\n    const pcClasses = [],\n      npcClasses = [],\n      racialHD = [];\n    for (const cls of allClasses) {\n      if (cls.subType === \"racial\") racialHD.push(cls);\n      else if (cls.subType === \"npc\") npcClasses.push(cls);\n      else pcClasses.push(cls);\n    }\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const healthConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const actorHealthConfig = healthConfig.getActorConfig(this);\n\n    /**\n     * @type {typeof Math.round}\n     */\n    const round = { up: Math.ceil, nearest: Math.round, down: Math.floor }[healthConfig.rounding];\n    const { continuous } = healthConfig;\n\n    /**\n     * @param {number} value - Amount of health to add\n     * @param {ItemPF} source - Source item\n     */\n    function pushHealth(value, source) {\n      const fcb = ffd20.config.favoredClassTypes.includes(source.subType) ? source.system.fc?.hp?.value || 0 : 0;\n\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: value,\n          target: \"mhp\",\n          type: \"untypedPerm\",\n          flavor: source.name,\n        }),\n        new ffd20.components.ItemChange({\n          formula: value,\n          target: \"vigor\",\n          type: \"untypedPerm\",\n          flavor: source.name,\n        })\n      );\n      if (fcb != 0) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: fcb,\n            target: \"mhp\",\n            type: \"untypedPerm\",\n            flavor: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassFC\", { className: source.name }),\n          }),\n          new ffd20.components.ItemChange({\n            formula: fcb,\n            target: \"vigor\",\n            type: \"untypedPerm\",\n            flavor: game.i18n.format(\"FFD20.SourceInfoSkillRank_ClassFC\", { className: source.name }),\n          })\n        );\n      }\n    }\n\n    /**\n     * @param {ItemPF} source - Source item\n     */\n    function manualHealth(source) {\n      let health = source.system.hp;\n      if (!continuous) health = round(health);\n\n      pushHealth(health, source);\n    }\n\n    /**\n     * @param {ItemPF} source - Class granting health\n     * @param {object} config - Class type configuration\n     * @param {number} config.rate - Automatic HP rate\n     * @param {boolean} config.maximized - Is this class allowed to grant maximized HP\n     * @param {object} state - State tracking\n     */\n    function autoHealth(source, { rate, maximized } = {}, state) {\n      const hpPerHD = source.system.hd ?? 0;\n      if (hpPerHD === 0) return;\n\n      let health = 0;\n\n      // Mythic\n      if (source.subType === \"mythic\") {\n        const hpPerTier = hpPerHD ?? 0;\n        if (hpPerTier === 0) return;\n        const tiers = source.system.level ?? 0;\n        if (tiers === 0) return;\n        health = hpPerTier * tiers;\n      }\n      // Everything else\n      else {\n        let dieHealth = 1 + (hpPerHD - 1) * rate;\n        if (!continuous) dieHealth = round(dieHealth);\n\n        const hitDice = source.hitDice;\n\n        let maxedHD = 0;\n        if (maximized) {\n          maxedHD = Math.min(hitDice, state.maximized.remaining);\n          state.maximized.value += maxedHD;\n        }\n        const maxedHp = maxedHD * hpPerHD;\n        const levelHp = Math.max(0, hitDice - maxedHD) * dieHealth;\n        health = maxedHp + levelHp;\n      }\n\n      pushHealth(health, source);\n    }\n\n    /**\n     * Compute and push health, tracking the remaining maximized levels.\n     *\n     * @param {ItemPF[]} sources - Health source classes\n     * @param {object} config - Configuration for this class type\n     * @param {boolean} config.auto - Automatic health enabled\n     * @param {object} state - State tracker for auto health\n     */\n    function computeHealth(sources, config, state) {\n      if (config.auto) {\n        for (const cls of sources) autoHealth(cls, config, state);\n      } else {\n        for (const cls of sources) manualHealth(cls);\n      }\n    }\n\n    // State tracking\n    const state = {\n      maximized: {\n        value: 0,\n        max: healthConfig.maximized,\n        get remaining() {\n          return this.max - this.value;\n        },\n      },\n    };\n\n    computeHealth(racialHD, actorHealthConfig.classes.racial, state);\n    computeHealth(pcClasses, actorHealthConfig.classes.base, state);\n    computeHealth(npcClasses, actorHealthConfig.classes.npc, state);\n  }\n\n  /**\n   * Calculate actor mana\n   *\n   * @internal\n   * @param {ItemClassPF[]} allClasses - All classes, sorted in order to be applied\n   * @param {ItemChange[]} changes - Changes to\n   * Class mana points, call class and race info from above\n   * Compute and push mana, tracking the remaining maximized levels.\n   * for each class, check if it is calulating mp or defaulting to manually entered value\n   * step 1 - gather all classes\n   * step 2 - check for each if it is auto or manual\n   * step 3 - pass to correct function\n   * step 4 - if manual just add mp to pool\n   * step 5 - for auto follow substeps\n   * the following is for each class passed to it\n   * step 5a - condence relevant variables\n   *   MP type: which mp chart does it look at - source.system. classBaseMPTypes\n   *   Max spell lvl: which spell prog does it look at - source.system.classBaseMPTypes\n   *   level: level of the class - source.system.level\n   *   casting stat: what stat(s) are used for it - source.system.classCastingStat\n   * pass result\n   * else\n   * pass manual mp value\n   * total results\n   * TODO adjust for class autos\n   * check each for false or null, do first manual option, if true move to auto\n   */\n  _calculateMaxMana(allClasses, changes) {\n    // Categorize classes\n    const pcClasses = [],\n      npcClasses = [],\n      racialHD = [];\n    for (const cls of allClasses) {\n      if (cls.subType === \"racial\") racialHD.push(cls);\n      else if (cls.subType === \"npc\") npcClasses.push(cls);\n      else pcClasses.push(cls);\n    }\n    /**\n     * @param {number} value - Amount of Mana to add\n     * @param {ItemPF} source - Source item\n     */\n    function pushMana(value, source) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: value,\n          target: \"mmp\",\n          type: \"untypedPerm\",\n          flavor: source.name,\n        }),\n      );\n      // add bounus mp here\n      // add bonus mp and does it after all stat mods (see if above code can be used to pass function for post stat mod adjustments) Spellcaster classes function off of an MP pool, and while they gain a set amount of MP in accordance to their class level (see respective class tables), they also gain bonus MP from their associated casting modifier (be it Intelligence, Wisdom, or Charisma) and their current spellcasting level (note: this is different from caster level!). Bonus MP is given fully from a multiclass.\n      const mpAbility = source.system.classCastingStat;\n      const spellMath = ffd20.config.ClassSpellLvlProgression[source.system.classBaseMPTypes];\n      const currentSpellLvl = Math.floor(RollPF.safeRollSync(spellMath, { level: source.system.level }).total);\n      if (mpAbility !== \"\") {\n        for (let slvl = 1; slvl < currentSpellLvl + 1; slvl++) {\n          if (mpAbility === \"intAndWis\" || mpAbility === \"int\")\n            changes.push(\n              new ffd20.components.ItemChange({\n                formula: `ceil(max(@abilities.int.mod - (${slvl} - 1 ), 0) / 4) * ${slvl}`,\n                target: \"mmp\",\n                type: \"untypedPerm\",\n                flavor: `Bonus Mp ${source.name} from Intelligence for spell level ${slvl}`,\n              })\n            );\n          if (mpAbility === \"intAndWis\" || mpAbility === \"wis\")\n            changes.push(\n              new ffd20.components.ItemChange({\n                formula: `ceil(max(@abilities.wis.mod - (${slvl} - 1 ), 0) / 4) * ${slvl}`,\n                target: \"mmp\",\n                type: \"untypedPerm\",\n                flavor: `Bonus Mp ${source.name} from Wisdom for spell level ${slvl}`,\n              })\n            );\n          if (mpAbility === \"cha\")\n            changes.push(\n              new ffd20.components.ItemChange({\n                formula: `ceil(max(@abilities.cha.mod - (${slvl} - 1 ), 0) / 4) * ${slvl}`,\n                //operator: \"add\",\n                target: \"mmp\",\n                type: \"untypedPerm\",\n                flavor: `Bonus Mp ${source.name} from Charisma for spell level ${slvl}`,\n              })\n            );\n        }\n      }\n    }\n\n    /**\n     * @param {ItemPF} source - Class granting fixed amount of mana\n     */\n    function manualMana(source) {\n      const mana = source.system.mp;\n\n      pushMana(mana, source);\n    }\n\n    /**\n     * @param {ItemPF} source - Class granting mana\n     */\n    function autoMana(source) {\n      // if any of the following, just stop for non-casters, no levels, or half-casters of lvl 3 or lower\n      if (source.system.classBaseMPTypes === \"noncaster\") return;\n      if (source.system.level === 0) return;\n      if (source.system.classBaseMPTypes === \"halfCaster\" && source.system.level < 4) return;\n\n      // figure out how much mp comes from the class\n      let level_mana = 0;\n      let mult = 1;\n\n      if (source.system.classBaseMPauto === \"half\") mult = 0.5;\n      const manaChart = ffd20.config.classMPlevels[source.system.classBaseMPTypes];\n      level_mana = Math.floor(manaChart[source.system.level - 1] * mult);\n\n      pushMana(level_mana, source);\n    }\n\n    /**\n     * Compute and push mana, tracking the remaining maximized levels.\n     *\n     * @param {ItemPF[]} sources - Mana source classes\n     */\n    function computeMana(sources) {\n      sources.forEach((mpSource) => {\n        if (mpSource.system.classBaseMPauto === \"no\" || mpSource.system.classBaseMPauto === null) {\n          manualMana(mpSource)\n        } else {\n          autoMana(mpSource)\n        }\n      })\n    }\n\n    computeMana(racialHD);\n    computeMana(pcClasses);\n    computeMana(npcClasses);\n  }\n\n  /** @inheritDoc */\n  getSourceDetails(path) {\n    const sources = super.getSourceDetails(path);\n\n    const baseLabel = game.i18n.localize(\"FFD20.Base\");\n\n    // Add base values to certain bonuses\n    if (\n      [\n        \"system.attributes.ac.normal.total\",\n        \"system.attributes.ac.touch.total\",\n        \"system.attributes.ac.flatFooted.total\",\n        \"system.attributes.cmd.total\",\n        \"system.attributes.cmd.flatFootedTotal\",\n      ].includes(path)\n    ) {\n      sources.push({ name: baseLabel, value: 10, enabled: true });\n    }\n\n    const ablRE = /^system\\.abilities\\.(?<key>\\w+)\\.(?<detail>\\w+)$/.exec(path);\n    if (ablRE) {\n      const { key, detail } = ablRE.groups;\n      const abl = this.system.abilities[key];\n      switch (detail) {\n        case \"total\":\n          sources.push({ name: baseLabel, value: abl.value });\n          if (abl.drain > 0) {\n            sources.push({\n              name: game.i18n.localize(\"FFD20.AbilityDrain\"),\n              value: -Math.abs(abl.drain),\n            });\n          }\n          break;\n        case \"mod\":\n          if (abl.damage > 0) {\n            sources.push({\n              name: game.i18n.localize(\"FFD20.AbilityDamage\"),\n              value: -Math.floor(Math.abs(abl.damage) / 2),\n            });\n          }\n          if (abl.userPenalty > 0) {\n            sources.push({\n              name: game.i18n.localize(\"FFD20.AbilityPenalty\"),\n              value: -Math.floor(Math.abs(abl.userPenalty) / 2),\n            });\n          }\n          break;\n      }\n    }\n\n    // Add wound threshold data\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const actorHpConfig = hpConfig.getActorConfig(this);\n\n    if (actorHpConfig.rules.useWoundThresholds != 0) {\n      const wtData = this.getWoundThresholdData({ healthConfig: actorHpConfig });\n      if (wtData.valid) {\n        const penalty = -wtData.penalty;\n        for (const fk of ffd20.config.woundThresholdChangeTargets) {\n          const paths = getChangeFlat(this, fk, \"untyped\", penalty);\n          if (paths.includes(path)) {\n            sources.push({\n              name: ffd20.config.woundThresholdConditions[wtData.level],\n              value: penalty,\n              id: \"woundThreshold\",\n            });\n          }\n        }\n      }\n    }\n\n    return sources;\n  }\n\n  /**\n   * @internal\n   */\n  _prepareTraits() {\n    this.system.traits ??= {};\n    const traits = this.system.traits;\n\n    const damageTypes = ffd20.registry.damageTypes.getLabels();\n    const traitsMap = {\n      di: damageTypes,\n      dv: damageTypes,\n      ci: ffd20.config.conditionTypes,\n      languages: ffd20.config.languages,\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      creatureTypes: ffd20.config.creatureTypes,\n      creatureSubtypes: ffd20.config.creatureSubtypes,\n    };\n\n    for (const [key, labels] of Object.entries(traitsMap)) {\n      const trait = {\n        base: traits[key] ?? [],\n        custom: new Set(),\n        standard: new Set(),\n        get total() {\n          return this.standard.union(this.custom);\n        },\n        get names() {\n          return [...this.standard.map((t) => labels[t] || t), ...this.custom];\n        },\n      };\n\n      traits[key] = trait;\n\n      Object.defineProperty(trait, \"value\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(`actor.system.traits.${key}.value is deprecated.`, {\n            since: \"PF1 v11\",\n            until: \"PF1 v12\",\n          });\n          return this.standard;\n        },\n      });\n      if (Array.isArray(trait.base)) {\n        const canon = traitsMap[key];\n        for (const c of trait.base) {\n          if (canon[c]) trait.standard.add(c);\n          else trait.custom.add(c);\n        }\n      }\n    }\n  }\n\n  /**\n   * Finalize preparing armor, weapon, and language proficiencies and other traits.\n   *\n   * @inheritDoc\n   * @protected\n   */\n  _finalizeTraits() {\n    const traits = this.system.traits;\n\n    const traitsMap = {\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      languages: ffd20.config.languages,\n      creatureTypes: ffd20.config.creatureTypes,\n      creatureSubtypes: ffd20.config.creatureSubtypes,\n    };\n\n    const validItems = this.items.filter((i) => i.isActive);\n\n    for (const [traitKey, labels] of Object.entries(traitsMap)) {\n      const trait = traits[traitKey];\n      if (!trait) {\n        console.error(this.name, \"actor trait\", traitKey, \"is missing\");\n        continue;\n      }\n\n      // Iterate over all items to create one array of non-custom proficiencies\n      for (const item of validItems) {\n        const itemTrait = item.system[traitKey];\n        // Check only items able to grant proficiencies\n        if (!itemTrait) continue;\n        // Lack of migration or prep failure elsewhere\n        if (!itemTrait.total) continue;\n        if (itemTrait.total.size == 0) continue;\n\n        // Get existing sourceInfo for item with this name, create sourceInfo if none is found\n        // Remember whether sourceInfo can be modified or has to be pushed at the end\n        let sInfo = getSourceInfo(this.sourceInfo, `system.traits.${traitKey}`).positive.find(\n          (o) => o.name === item.name\n        );\n        const hasInfo = !!sInfo;\n        if (!sInfo) sInfo = { name: item.name, value: [] };\n        else if (typeof sInfo.value === \"string\") sInfo.value = sInfo.value.split(\", \"); // BUG: this is not i18n friendly\n\n        // Regular proficiencies\n        for (const traitId of itemTrait.standard) {\n          // Add localized source info if item's info does not have this proficiency already\n          const label = labels[traitId];\n          if (!sInfo.value.includes(label)) sInfo.value.push(label);\n          // Add raw proficiency key\n          trait.standard.add(traitId);\n        }\n\n        // Add readable custom profs to sources and overall collection\n        for (const name of itemTrait.custom) {\n          if (!sInfo.value.includes(name)) sInfo.value.push(name);\n          trait.custom.add(name);\n        }\n\n        if (sInfo.value.length > 0) {\n          // Dedupe if adding to existing sourceInfo\n          if (hasInfo) sInfo.value = [...new Set(sInfo.value)];\n          // Transform arrays into presentable strings\n          sInfo.value = ffd20.utils.i18n.join(sInfo.value);\n          // If sourceInfo was not a reference to existing info, push it now\n          if (!hasInfo) getSourceInfo(this.sourceInfo, `system.traits.${traitKey}`).positive.push(sInfo);\n        }\n      }\n    }\n  }\n}\n","import { BaseCharacterPF } from \"./abstract/base-character.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\nexport class ActorCharacterPF extends BaseCharacterPF {\n  /**\n   * @internal\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const tokenUpdate = {};\n\n    // Link token data by default\n    if (data.prototypeToken?.actorLink === undefined) {\n      tokenUpdate.actorLink = true;\n    }\n\n    // Enable vision by default\n    if (game.settings.get(\"ffd20\", \"characterVision\") && data.prototypeToken?.sight?.enabled === undefined) {\n      tokenUpdate.sight = { enabled: true };\n    }\n\n    if (data.prototypeToken?.disposition === undefined) {\n      const disposition = game.settings.get(\"ffd20\", \"pcDisposition\");\n      if (disposition !== \"NONE\") {\n        tokenUpdate.disposition = CONST.TOKEN_DISPOSITIONS[disposition];\n      }\n    }\n\n    if (!foundry.utils.isEmpty(tokenUpdate)) {\n      this.prototypeToken.updateSource(tokenUpdate);\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Update experience\n    this._updateExp(changed);\n  }\n\n  /**\n   * Handle relative XP change and constrain it to appropriate minimum value.\n   *\n   * @protected\n   * @param {object} changed - Changed data\n   */\n  _updateExp(changed) {\n    const xpData = changed.system.details?.xp;\n\n    if (xpData?.value <= 0) {\n      // Reset XP to minimum possible\n      // BUG: This will have stale value if the update changed classes, too\n      const level = this.system.details?.level?.value ?? 0;\n      xpData.value = level > 0 ? this.getLevelExp(level - 1) : 0;\n    }\n  }\n\n  /**\n   * Amount of experience required to gain next level at specific character level.\n   *\n   * @example\n   * ```js\n   * getLevelExp(1); // -> 3000, the XP needed for level 2\n   * ```\n   *\n   * @param {number} level - Desired level to level-up.\n   * @param {object} [options] - Additional options\n   * @param {object} [options.rollData] - Roll data instance\n   * @returns {number} - The XP required for next level.\n   * @throws {Error} - If invalid level is provided.\n   */\n  getLevelExp(level, { rollData = null } = {}) {\n    if (!Number.isInteger(level) || !(level >= 0)) throw new Error(`Level \"${level}\" must be zero or greater integer.`);\n    if (level === 0) return 0; // Explicit case for absolute minimum.\n\n    const config = game.settings.get(\"ffd20\", \"experienceConfig\");\n    const track = config.track;\n\n    // Preset experience tracks\n    if ([\"fast\", \"medium\", \"slow\"].includes(track)) {\n      const levels = ffd20.config.CHARACTER_EXP_LEVELS[track];\n      // Normal levels\n      if (level < levels.length) return levels[level];\n      // Otherwise return last possible\n      else return levels.at(-1);\n    }\n\n    // Custom formula experience track\n    let totalXP = 0;\n    if (config.custom.formula.length > 0) {\n      rollData ??= this.getRollData();\n      for (let a = 0; a < level; a++) {\n        rollData.level = a + 1;\n        const roll = RollPF.safeRollSync(config.custom.formula, rollData);\n        totalXP += roll.total;\n      }\n      delete rollData.level; // Cleanup\n    }\n\n    return totalXP;\n  }\n\n  /**\n   * @protected\n   * @override\n   */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n    const actorData = this.system;\n\n    actorData.details ??= {};\n\n    // Prepare experience data\n    const level = actorData.details.level?.value || 1;\n\n    actorData.details.xp ??= {};\n\n    const maxExp = this.getLevelExp(level);\n    actorData.details.xp.max = maxExp;\n\n    // Experience bar\n    const curXp = actorData.details.xp.value;\n    // Maxed out XP needs no math\n    if (curXp >= maxExp) {\n      actorData.details.xp.pct = 100;\n    } else {\n      const prior = this.getLevelExp(level - 1 || 0);\n      actorData.details.xp.pct = ((Math.clamp(curXp, prior, maxExp) - prior) / (maxExp - prior)) * 100;\n    }\n  }\n}\n","import { BaseCharacterPF } from \"./abstract/base-character.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\nexport class ActorNPCPF extends BaseCharacterPF {\n  /**\n   * @internal\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const tokenUpdate = {};\n\n    if (data.prototypeToken?.disposition === undefined) {\n      const disposition = game.settings.get(\"ffd20\", \"npcDisposition\");\n      if (disposition !== \"NONE\") {\n        tokenUpdate.disposition = CONST.TOKEN_DISPOSITIONS[disposition];\n      }\n    }\n\n    if (!foundry.utils.isEmpty(tokenUpdate)) {\n      this.prototypeToken.updateSource(tokenUpdate);\n    }\n  }\n\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    const cr = changed.system?.details?.cr?.base;\n    if (typeof cr === \"string\") changed.system.details.cr.base = ffd20.utils.CR.fromString(cr);\n  }\n\n  /**\n   * @protected\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n    this.system.details.cr.total = this.getCR();\n  }\n\n  prepareSpecificDerivedData() {\n    super.prepareSpecificDerivedData();\n\n    this._prepareCR();\n  }\n\n  _prepareCR() {\n    // Reset CR\n    foundry.utils.setProperty(this.system, \"details.cr.total\", this.getCR());\n\n    // Reset experience value\n    let newXP = 0;\n    try {\n      const crTotal = this.system.details?.cr?.total || 0;\n      newXP = ffd20.utils.CR.getXP(crTotal);\n    } catch {\n      newXP = ffd20.utils.CR.getXP(1);\n    }\n    foundry.utils.setProperty(this.system, \"details.xp.value\", newXP);\n  }\n\n  /**\n   * @inheritDoc\n   * @remarks If NPC proficiencies is not enabled, this always returns true.\n   */\n  hasArmorProficiency(item) {\n    // Assume NPCs to be proficient with their armor\n    return game.settings.get(\"ffd20\", \"npcProficiencies\") ? super.hasArmorProficiency(item) : true;\n  }\n\n  /**\n   * @inheritDoc\n   * @remarks If NPC proficiencies is not enabled, this always returns true.\n   */\n  hasWeaponProficiency(item, options = {}) {\n    // Assume NPCs to be proficient with their weapon\n    return game.settings.get(\"ffd20\", \"npcProficiencies\") ? super.hasWeaponProficiency(item, options) : true;\n  }\n\n  /**\n   * Get challenge rating.\n   * Applies CR offset modifications from templates.\n   *\n   * @returns {number} - CR\n   */\n  getCR() {\n    const base = this.system.details?.cr?.base ?? 0;\n\n    // Gather CR from templates\n    const templates = this.itemTypes.feat.filter((item) => item.subType === \"template\" && item.isActive);\n\n    return templates.reduce((cur, item) => {\n      const crOffset = item.system.crOffset;\n      if (crOffset) {\n        cur += RollPF.safeRollSync(crOffset, item.getRollData()).total;\n      }\n      return cur;\n    }, base);\n  }\n\n  /**\n   * Return the amount of experience granted by killing a creature of a certain CR.\n   *\n   * @deprecated\n   * @param {number} cr - The creature's challenge rating\n   * @returns {number|null} - The amount of experience granted per kill. Or null if the CR was invalid.\n   */\n  getCRExp(cr) {\n    foundry.utils.logCompatibilityWarning(\"ActorPF.getCRExp() is deprecated in favor of ffd20.utils.CR.getXP()\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return ffd20.utils.CR.getXP(cr);\n  }\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\nimport { applyChanges } from \"./utils/apply-changes.mjs\";\n\nexport class ActorHauntPF extends ActorPF {\n  prepareBaseData() {\n    this._resetInherentTotals();\n\n    this.changeFlags = {};\n    /** @type {Record<string, SourceInfo>} */\n    this.sourceInfo = {};\n\n    // Needed for getRollData and ActorPF, but useless for the actor\n    this.system.abilities = {\n      str: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n      dex: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n      con: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n      int: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n      wis: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n      cha: {\n        value: 10,\n        damage: 0,\n        drain: 0,\n        userPenalty: 0,\n        mod: 0,\n        total: 10,\n      },\n    };\n\n    this.system.attributes.attack ??= { general: 0, shared: 0 };\n\n    this.system.skills ??= {};\n\n    // Init resources structure\n    this.system.resources ??= {};\n\n    // Handle Health\n    this.system.attributes.hp.max = this.system.attributes.hp.base;\n  }\n\n  _getInherentTotalsKeys() {\n    return {\n      \"details.carryCapacity.bonus.total\": 0,\n      \"details.carryCapacity.multiplier.total\": 0,\n    };\n  }\n\n  /**\n   * Needed to prevent unnecessary behavior in ActorPF\n   *\n   * @override\n   */\n  prepareDerivedData() {\n    this.system.details.cr.total = this.system.details.cr.base;\n    this.system.attributes.init.total = this.system.attributes.init.value;\n\n    for (const item of this.items) {\n      item._prepareDependentData(false);\n      this.updateItemResources(item);\n    }\n\n    applyChanges(this);\n\n    this._prepareTemplates();\n    this._prepareCR();\n    this.prepareHealth();\n\n    // Setup links\n    this.prepareItemLinks();\n\n    // Reset roll data cache again to include processed info\n    this._rollData = null;\n\n    // Update item resources\n    for (const item of this.items) {\n      item._prepareDependentData(true);\n      // because the resources were already set up above, this is just updating from current roll data - so do not warn on duplicates\n      this.updateItemResources(item, { warnOnDuplicate: false });\n    }\n  }\n\n  prepareHealth() {\n    // Offset relative health\n    const hp = this.system.attributes.hp;\n    if (!Number.isFinite(hp?.offset)) hp.offset = 0;\n    hp.value = hp.max + hp.offset;\n  }\n\n  /**\n   * Needed to prevent unnecessary behavior in ActorPF\n   *\n   * @override\n   */\n  refreshDerivedData() {}\n\n  _prepareTypeChanges(changes) {\n    // BAB\n    changes.push(\n      new ffd20.components.ItemChange({\n        _id: \"_bab\", // HACK: Force ID to be special\n        formula: \"@attributes.bab.total\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n  }\n\n  getRollData(options = { refresh: false, cache: true }) {\n    // Return cached data, if applicable\n    const skipRefresh = !options.refresh && this._rollData && options.cache;\n\n    const result = { ...(skipRefresh ? this._rollData : ffd20.utils.deepClone(this.system)) };\n\n    // Clear certain fields if not refreshing\n    if (skipRefresh) {\n      for (const key of ffd20.config.temporaryRollDataFields.actor) {\n        delete result[key];\n      }\n    }\n\n    /* ----------------------------- */\n    /* Always add the following data\n    /* ----------------------------- */\n\n    // Add combat round, if in combat\n    if (game.combats?.viewed) {\n      result.combat = {\n        round: game.combat.round || 0,\n      };\n    }\n\n    // Caster Level\n    result.cl = result.details.cl;\n\n    // Aura strength\n    result.auraStrength = this.auraStrength;\n\n    // Return cached data, if applicable\n    if (skipRefresh) return result;\n\n    /* ----------------------------- */\n    /* Set the following data on a refresh\n    /* ----------------------------- */\n\n    // Spoof size as Medium instead of letting it fail to Fine\n    result.size = 4;\n\n    // Add item dictionary flags\n    result.dFlags = this.itemFlags?.dictionary ?? {};\n\n    // Add range info\n    result.range = ffd20.documents.actor.ActorPF.getReach(this.system.traits.size, this.system.traits.stature);\n\n    // Wound Threshold isn't applicable\n    result.attributes.woundThresholds = { level: 0 };\n\n    // Haunts don't have ACP\n    result.attributes.acp = { attackPenalty: 0 };\n\n    // Call hook\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    this._rollData = result;\n    return result;\n  }\n\n  _prepareCR() {\n    // Gather CR Offset\n    let crOffset = 0;\n    for (const key of this.system.templates.base) {\n      const crDetail = ffd20.config.hauntTemplates[key];\n      if (!crDetail) continue;\n      crOffset += crDetail.cr;\n\n      // Check for bonus CR - this is a special case for when a template's\n      // CR bonus is increased by the existence of a template with a specific tag.\n      // In 1PP, this is only used for the \"Elusive\" template when \"Persistent\" is also applied.\n      const crBonusTag = crDetail.crBonusTag;\n      if (crBonusTag && this.system.templates.base.includes(crBonusTag)) {\n        crOffset += crDetail.crBonus;\n      }\n    }\n\n    // Reset CR\n    this.system.details.cr.total = this.system.details.cr.base + crOffset;\n\n    // Reset experience value\n    let newXP = 0;\n    try {\n      const crTotal = this.system.details?.cr?.total || 0;\n      newXP = ffd20.utils.CR.getXP(crTotal);\n    } catch {\n      newXP = ffd20.utils.CR.getXP(1);\n    }\n    foundry.utils.setProperty(this.system, \"details.xp.value\", newXP);\n  }\n\n  /**\n   * Aura strength as number from 0 to 4.\n   *\n   * @see {@link ffd20.config.auraStrengths}\n   *\n   * @type {number}\n   */\n  get auraStrength() {\n    const cl = this.system.details.cl || 0;\n    if (cl < 1) {\n      return 0;\n    } else if (cl < 6) {\n      return 1;\n    } else if (cl < 12) {\n      return 2;\n    } else if (cl < 21) {\n      return 3;\n    }\n    return 4;\n  }\n\n  /** @inheritDoc */\n  getInitiativeOptions() {\n    return {\n      check: false,\n    };\n  }\n\n  _prepareTemplates() {\n    const templates = this.system.templates ?? {};\n    const key = \"templates\";\n    const labels = ffd20.config.hauntTemplateLabels;\n    const template = {\n      base: templates,\n      custom: new Set(),\n      standard: new Set(),\n      get total() {\n        return this.standard.union(this.custom);\n      },\n      get names() {\n        return [...this.standard.map((t) => labels[t] || t), ...this.custom];\n      },\n    };\n\n    this.system[key] = template;\n\n    if (Array.isArray(template.base)) {\n      for (const c of template.base) {\n        if (labels[c]) template.standard.add(c);\n        else template.custom.add(c);\n      }\n    }\n  }\n\n  /**\n   * Get challenge rating.\n   *\n   * @returns {number} - CR\n   */\n  getCR() {\n    return this.system.details?.cr?.total ?? 0;\n  }\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\nimport { applyChanges } from \"./utils/apply-changes.mjs\";\n\nexport class ActorTrapPF extends ActorPF {\n  prepareBaseData() {\n    this.changeFlags = {};\n    /** @type {Record<string, SourceInfo>} */\n    this.sourceInfo = {};\n    this.system.resources ??= {};\n\n    // Everything below this is needed for getRollData and ActorPF, but useless for the actor\n    // Necessary shim for action data prep.\n    this.system.abilities = {};\n\n    this.system.attributes = {\n      attack: { general: 0, shared: 0 },\n      bab: { total: 0 },\n      woundThresholds: {},\n    };\n\n    this.system.skills ??= {};\n  }\n\n  /**\n   * @override\n   */\n  prepareDerivedData() {\n    for (const item of this.items) {\n      item._prepareDependentData(false);\n      this.updateItemResources(item);\n    }\n\n    applyChanges(this);\n\n    this._prepareCR();\n\n    // Setup links\n    this.prepareItemLinks();\n\n    // Reset roll data cache again to include processed info\n    this._rollData = null;\n\n    // Update item resources\n    for (const item of this.items) {\n      item._prepareDependentData(true);\n      // because the resources were already set up above, this is just updating from current roll data - so do not warn on duplicates\n      this.updateItemResources(item, { warnOnDuplicate: false });\n    }\n  }\n\n  /**\n   * Needed to prevent unnecessary behavior in ActorPF\n   *\n   * @override\n   */\n  refreshDerivedData() {}\n\n  _prepareCR() {\n    // Reset CR\n    this.system.cr.total = this.system.cr.base;\n\n    // Reset experience value\n    const newXP = ffd20.utils.CR.getXP(this.system.cr.total);\n    foundry.utils.setProperty(this.system, \"xp.value\", newXP);\n  }\n\n  /** @inheritDoc */\n  _prepareTypeChanges(changes) {\n    // BAB\n    changes.push(\n      new ffd20.components.ItemChange({\n        _id: \"_bab\", // HACK: Force ID to be special\n        formula: \"@attributes.bab.total\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n  }\n\n  getRollData(options = { refresh: false, cache: true }) {\n    // Return cached data, if applicable\n    const skipRefresh = !options.refresh && this._rollData && options.cache;\n\n    const result = { ...(skipRefresh ? this._rollData : foundry.utils.deepClone(this.system)) };\n\n    // Clear certain fields if not refreshing\n    if (skipRefresh) {\n      for (const key of ffd20.config.temporaryRollDataFields.actor) {\n        delete result[key];\n      }\n    }\n\n    /* ----------------------------- */\n    /* Always add the following data\n    /* ----------------------------- */\n\n    // Add combat round, if in combat\n    if (game.combats?.viewed) {\n      result.combat = {\n        round: game.combat.round || 0,\n      };\n    }\n\n    // Return cached data, if applicable\n    if (skipRefresh) return result;\n\n    /* ----------------------------- */\n    /* Set the following data on a refresh\n    /* ----------------------------- */\n\n    // Spoof size as Medium instead of letting it fail to Fine\n    result.size = 4;\n\n    // Spoof range as medium tall creature\n    result.range = ffd20.documents.actor.ActorPF.getReach();\n\n    // Add item dictionary flags\n    result.dFlags = this.itemFlags?.dictionary ?? {};\n\n    // Call hook\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    if (options.cache) {\n      this._rollData = result;\n    }\n\n    return result;\n  }\n\n  /**\n   * Get the perception modifier for the trap to detect triggers\n   *\n   * @returns {number} The perception modifier for the trap\n   */\n  getPerceptionModifier() {\n    const triggerType = this.system.trigger.type;\n    const visionType = this.system.trigger.vision;\n\n    if (triggerType !== \"visual\") return ffd20.config.trapPerceptionModifiers[triggerType] ?? 0;\n    else return ffd20.config.trapPerceptionModifiers.vision[visionType] ?? 0;\n  }\n\n  /**\n   * Roll a perception check for the trap\n   *\n   * @param {object} options Options for the roll\n   * @returns {Promise<void>}\n   */\n  async rollPerception(options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    const rollData = this.getRollData();\n    const token = options.token ?? this.token;\n\n    // Add metadata about the skill\n    const metadata = { rank: 0 };\n\n    const rollOptions = {\n      ...options,\n      parts: [`(${this.getPerceptionModifier()})[${game.i18n.localize(\"FFD20.SkillPer\")}]`],\n      rollData,\n      flavor: game.i18n.format(\"FFD20.SkillCheck\", { skill: game.i18n.localize(\"FFD20.SkillPer\") }),\n      // chatTemplateData: { properties: props },\n      compendium: { entry: ffd20.config.skillCompendiumEntries[\"per\"], type: \"JournalEntry\" },\n      subject: { skill: \"per\" },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token }),\n      messageData: {\n        system: {\n          subject: { skill: \"per\" },\n          config: metadata,\n        },\n      },\n    };\n\n    await ffd20.dice.d20Roll(rollOptions);\n  }\n\n  /**\n   * Get challenge rating.\n   *\n   * @returns {number} - CR\n   */\n  getCR() {\n    return this.system.cr?.total ?? 0;\n  }\n}\n","import { ActorPF } from \"./actor-pf.mjs\";\nimport { getSourceInfo, getHighestChanges, applyChanges } from \"./utils/apply-changes.mjs\";\n\nexport class ActorVehiclePF extends ActorPF {\n  prepareBaseData() {\n    this._resetInherentTotals();\n\n    // Prepare size data\n    this.system.traits ??= {};\n    const baseSize = this.system.traits.size || \"med\";\n    const sizeValue = Object.keys(ffd20.config.sizeChart).indexOf(baseSize);\n    this.system.traits.size = {\n      base: baseSize,\n      value: sizeValue,\n    };\n\n    /** @type {Record<string, SourceInfo>} */\n    this.sourceInfo = {};\n    this.changeFlags = {};\n    this.system.resources ??= {};\n    const sizeMod = ffd20.config.sizeMods[this.system.traits.size.base];\n    const sizeModSpecial = Object.values(ffd20.config.sizeSpecialMods)[this.system.traits.size.value] ?? 0;\n\n    // Add base initiative\n    this.system.attributes.init.total = this.system.attributes.init.value;\n\n    // Handle AC\n    for (const [key, value] of Object.entries(this.system.attributes.ac)) {\n      value.base = 10;\n      this.system.attributes.ac[key].total = value.bonus + value.base + sizeMod;\n      getSourceInfo(this.sourceInfo, `system.attributes.ac.${key}.total`).positive.push(\n        {\n          name: game.i18n.localize(\"FFD20.Size\"),\n          value: sizeMod,\n          modifier: \"size\",\n        },\n        {\n          name: game.i18n.localize(\"FFD20.Modifications\"),\n          value: value.bonus,\n        }\n      );\n\n      if (key === \"stopped\") {\n        this.system.attributes.ac[key].total -= 7;\n        getSourceInfo(this.sourceInfo, \"system.attributes.ac.stopped.total\").positive.push(\n          {\n            name: game.i18n.localize(\"FFD20.AbilityDex\"),\n            value: -5,\n          },\n          {\n            name: game.i18n.localize(\"FFD20.Vehicles.ACStoppedMotion\"),\n            value: -2,\n          }\n        );\n      }\n    }\n\n    // Handle CMD\n    this.system.attributes.cmd = { base: 10 };\n    this.system.attributes.cmd.total = this.system.attributes.cmd.base + sizeModSpecial;\n    getSourceInfo(this.sourceInfo, \"system.attributes.cmd.total\").positive.push({\n      name: game.i18n.localize(\"FFD20.Size\"),\n      value: sizeModSpecial,\n      modifier: \"size\",\n    });\n    this.system.attributes.cmd.stoppedTotal = this.system.attributes.cmd.total - 7;\n    getSourceInfo(this.sourceInfo, \"system.attributes.cmd.stoppedTotal\").positive.push(\n      {\n        name: game.i18n.localize(\"FFD20.Size\"),\n        value: sizeModSpecial,\n        modifier: \"size\",\n      },\n      {\n        name: game.i18n.localize(\"FFD20.AbilityDex\"),\n        value: -5,\n      },\n      {\n        name: game.i18n.localize(\"FFD20.Vehicles.ACStoppedMotion\"),\n        value: -2,\n      }\n    );\n\n    this.system.attributes.savingThrows.save.total = this.system.attributes.savingThrows.save.base;\n    getSourceInfo(this.sourceInfo, `system.attributes.savingThrows.save.total`).positive.push({\n      name: game.i18n.localize(\"FFD20.Base\"),\n      value: this.system.attributes.savingThrows.save.base,\n    });\n\n    // Handle hardness\n    this.system.attributes.hardness.base = ffd20.config.vehicleMaterials[this.system.material.base]?.hardness ?? 0;\n    this.system.attributes.hardness.total =\n      (this.system.attributes.hardness.base + this.system.attributes.hardness.bonus) *\n      (this.system.material.magicallyHardened ? 2 : 1);\n    getSourceInfo(this.sourceInfo, \"system.attributes.hardness.total\").positive.push(\n      {\n        name: game.i18n.localize(\"FFD20.Materials.Normal\"),\n        value: this.system.attributes.hardness.base,\n      },\n      {\n        name: game.i18n.localize(\"FFD20.Modifications\"),\n        value: this.system.attributes.hardness.bonus,\n      }\n    );\n    if (this.system.material.magicallyHardened) {\n      getSourceInfo(this.sourceInfo, \"system.attributes.hardness.total\").positive.push({\n        name: game.i18n.localize(\"FFD20.Vehicles.MagicallyHardened\"),\n        value: \"x2\",\n      });\n    }\n\n    // Handle HP\n    this.system.attributes.hp.base =\n      (ffd20.config.vehicleMaterials[this.system.material.base]?.hp ?? 0) * this.system.squares;\n    this.system.attributes.hp.max =\n      (this.system.attributes.hp.base + this.system.attributes.hp.bonus) *\n      (this.system.material.magicallyHardened ? 2 : 1);\n    getSourceInfo(this.sourceInfo, \"system.attributes.hp.max\").positive.push(\n      {\n        name: game.i18n.localize(\"FFD20.Materials.Normal\"),\n        value: this.system.attributes.hp.base,\n      },\n      {\n        name: game.i18n.localize(\"FFD20.Modifications\"),\n        value: this.system.attributes.hp.bonus,\n      }\n    );\n    if (this.system.squares > 0 && this.system.material.magicallyHardened) {\n      getSourceInfo(this.sourceInfo, \"system.attributes.hp.max\").positive.push({\n        name: game.i18n.localize(\"FFD20.Vehicles.MagicallyHardened\"),\n        value: \"x2\",\n      });\n    }\n\n    // Everything below this is needed for getRollData and ActorPF, but useless for the actor\n    this.system.attributes.attack ??= { general: 0, shared: 0 };\n    this.system.attributes.woundThresholds ??= {};\n    this.system.skills ??= {};\n    this.system.attributes.speed ??= {};\n    this.system.attributes.cmb ??= {};\n\n    this._prepareDriverData();\n  }\n\n  /** @inheritDoc */\n  getSourceDetails(path) {\n    const sources = super.getSourceDetails(path);\n\n    const baseLabel = game.i18n.localize(\"FFD20.Base\");\n\n    // Add base values to certain bonuses\n    if (\n      [\n        \"system.attributes.ac.normal.total\",\n        \"system.attributes.ac.touch.total\",\n        \"system.attributes.ac.stopped.total\",\n        \"system.attributes.cmd.total\",\n        \"system.attributes.cmd.stoppedTotal\",\n      ].includes(path)\n    ) {\n      sources.push({ name: baseLabel, value: 10 });\n    }\n  }\n\n  /**\n   * Calculate current carry capacity limits.\n   *\n   * Overridden to prevent unnecessary behavior in ActorPF, as vehicles don't have carry capacity.\n   *\n   * @override\n   * @returns {{light:number,medium:number,heavy:number}} - Capacity info\n   */\n  getCarryCapacity() {\n    return {\n      light: 0,\n      medium: 0,\n      heavy: 0,\n    };\n  }\n\n  _getInherentTotalsKeys() {\n    return {\n      \"details.carryCapacity.bonus.total\": 0,\n      \"details.carryCapacity.multiplier.total\": 0,\n    };\n  }\n\n  /**\n   * @override\n   * @inheritDoc\n   */\n  _getBaseValueFillKeys() {\n    return [];\n  }\n\n  /**\n   * Needed to prevent unnecessary behavior in ActorPF\n   *\n   * @override\n   */\n  prepareDerivedData() {\n    for (const item of this.items) {\n      item._prepareDependentData(false);\n      this.updateItemResources(item);\n    }\n\n    applyChanges(this);\n\n    this.prepareHealth();\n    this._computeEncumbrance();\n\n    this.prepareCMB();\n\n    this._prepareOverlandSpeeds();\n\n    // Setup links\n    this.prepareItemLinks();\n\n    // Reset roll data cache again to include processed info\n    this._rollData = null;\n\n    // Update item resources\n    for (const item of this.items) {\n      item._prepareDependentData(true);\n      // because the resources were already set up above, this is just updating from current roll data - so do not warn on duplicates\n      this.updateItemResources(item, { warnOnDuplicate: false });\n    }\n  }\n\n  _prepareDriverData() {\n    const driver = this.system.driver.uuid ? fromUuidSync(this.system.driver.uuid) : null;\n    if (!driver) return;\n\n    // Default to WIS mod\n    let driverBase = driver.system.abilities.wis.mod;\n\n    try {\n      const skill = driver.getSkillInfo(this.system.driver.skill);\n      driverBase = skill.mod;\n    } catch {\n      // error silently, as we default to Wisdom Modifier\n    }\n\n    this.system.driver.bonus = driverBase;\n  }\n\n  /**\n   * @override\n   */\n  prepareCMB() {\n    const size = this.system.traits.size.value,\n      szCMBMod = Object.values(ffd20.config.sizeSpecialMods)[size] ?? 0,\n      driver = this.system.driver.bonus ?? 0;\n\n    this.system.attributes.cmb.total = szCMBMod + driver;\n  }\n\n  prepareHealth() {\n    // Offset relative health\n    const hp = this.system.attributes.hp;\n    if (!Number.isFinite(hp?.offset)) hp.offset = 0;\n    hp.value = hp.max + hp.offset;\n  }\n\n  /**\n   * Needed to prevent unnecessary behavior in ActorPF\n   *\n   * @override\n   */\n  refreshDerivedData() {}\n\n  /** @inheritDoc */\n  _prepareTypeChanges(changes) {\n    changes.push(\n      // BAB\n      new ffd20.components.ItemChange({\n        _id: \"_bab\", // HACK: Force ID to be special\n        formula: \"@attributes.bab.total\",\n        operator: \"add\",\n        target: \"~attackCore\",\n        type: \"untypedPerm\",\n        flavor: game.i18n.localize(\"FFD20.BAB\"),\n      })\n    );\n\n    if (this.system.driver.uuid) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"@driver.bonus\",\n          operator: \"add\",\n          target: \"cmb\",\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.Vehicles.DriverSkill\"),\n        }),\n        new ffd20.components.ItemChange({\n          formula: \"@driver.bonus\",\n          operator: \"add\",\n          target: \"ac\",\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.Vehicles.DriverSkill\"),\n        }),\n        new ffd20.components.ItemChange({\n          formula: \"@driver.bonus\",\n          operator: \"add\",\n          target: \"cmd\",\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.Vehicles.DriverSkill\"),\n        }),\n        new ffd20.components.ItemChange({\n          formula: \"floor(@driver.bonus / 2)\",\n          operator: \"add\",\n          target: \"vehicleSave\",\n          type: \"untyped\",\n          flavor: game.i18n.localize(\"FFD20.Vehicles.DriverSkill\"),\n        })\n      );\n    }\n  }\n\n  /** @inheritDoc */\n  getRollData(options = { refresh: false, cache: true }) {\n    // Return cached data, if applicable\n    const skipRefresh = !options.refresh && this._rollData && options.cache;\n\n    const result = { ...(skipRefresh ? this._rollData : foundry.utils.deepClone(this.system)) };\n\n    // Clear certain fields if not refreshing\n    if (skipRefresh) {\n      for (const key of ffd20.config.temporaryRollDataFields.actor) {\n        delete result[key];\n      }\n    }\n\n    /* ----------------------------- */\n    /* Always add the following data\n    /* ----------------------------- */\n\n    // Add combat round, if in combat\n    if (game.combats?.viewed) {\n      result.combat = {\n        round: game.combat.round || 0,\n      };\n    }\n\n    // Return cached data, if applicable\n    if (skipRefresh) return result;\n\n    /* ----------------------------- */\n    /* Set the following data on a refresh\n      /* ----------------------------- */\n\n    // Set size index\n    const sizes = Object.values(ffd20.config.sizeChart);\n    result.size = Math.clamp(result.traits.size.value, 0, sizes.length - 1);\n\n    // Add item dictionary flags\n    result.dFlags = this.itemFlags?.dictionary ?? {};\n\n    // Add range info\n    result.range = { melee: 5, reach: 5 };\n\n    // Wound Threshold isn't applicable\n    result.attributes.woundThresholds = { level: 0 };\n\n    // Traps don't have ACP\n    result.attributes.acp = { attackPenalty: 0 };\n\n    // Call hook\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    if (options.cache) {\n      this._rollData = result;\n    }\n\n    return result;\n  }\n\n  /**\n   * @remarks - Vehicles don't have weightless currency\n   * @override\n   * @inheritDoc\n   */\n  getTotalCurrency({ inLowestDenomination = true } = {}) {\n    const total = this.getCurrency(\"currency\", { inLowestDenomination: true });\n    return inLowestDenomination ? total : total / 100;\n  }\n\n  /**\n   * Calculate overland speeds.\n   * Overridden to use different data in Vehicles.\n   *\n   * @protected\n   * @override\n   */\n  _prepareOverlandSpeeds() {\n    this.system.details.currentSpeedOverland = ffd20.utils.overlandSpeed(this.system.details.currentSpeed);\n    this.system.details.maxSpeedOverland = ffd20.utils.overlandSpeed(this.system.details.maxSpeed);\n  }\n\n  /**\n   * Roll a specific saving throw\n   *\n   * @example\n   * await actor.rollSavingThrow(\"ref\", { skipDialog: true, dice: \"2d20kh\", bonus: \"4\" });\n   *\n   * @param {SaveId} savingThrowId Identifier for saving throw type.\n   * @param {ActorRollOptions} [options={}] Roll options.\n   * @returns {Promise<ChatMessage|object|void>} The chat message if one was created, or its data if not. `void` if the roll was cancelled.\n   */\n  async rollSavingThrow(savingThrowId, options = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n\n    // Add contextual notes\n    const rollData = this.getRollData();\n    const notes = await this.getContextNotesParsed(`savingThrow.${savingThrowId}`, { rollData });\n\n    const parts = [];\n\n    // Get base\n    const base = this.system.attributes.savingThrows.save.base;\n    if (base) parts.push(`${base}[${game.i18n.localize(\"FFD20.Base\")}]`);\n\n    // Add changes\n    let changeBonus = [];\n    const changes = this.changes.filter((c) => [\"vehicle\", savingThrowId].includes(c.target));\n    {\n      // Get damage bonus\n      changeBonus = getHighestChanges(\n        changes.filter((c) => c.operator !== \"set\"),\n        { ignoreTarget: true }\n      ).reduce((cur, c) => {\n        if (c.value)\n          cur.push({\n            value: c.value,\n            source: c.flavor,\n          });\n        return cur;\n      }, []);\n    }\n    for (const c of changeBonus) {\n      parts.push(`${c.value}[${c.source}]`);\n    }\n\n    // Roll saving throw\n    const props = [\n      {\n        header: game.i18n.localize(\"FFD20.ConRes\"),\n        value: [\n          { text: ffd20.registry.conditions.get(\"bleed\").name.toLowerCase() },\n          { text: game.i18n.localize(\"FFD20.AbilityDamage\").toLowerCase() },\n          { text: game.i18n.localize(\"FFD20.AbilityDrain\").toLowerCase() },\n        ],\n      },\n    ];\n\n    if (notes.length > 0) props.push({ header: game.i18n.localize(\"FFD20.Notes\"), value: notes });\n    const label = ffd20.config.savingThrows[savingThrowId];\n\n    const token = options.token ?? this.token;\n\n    const rollOptions = {\n      ...options,\n      parts,\n      rollData,\n      flavor: game.i18n.format(\"FFD20.SavingThrowRoll\", { save: label }),\n      subject: { save: savingThrowId },\n      chatTemplateData: { properties: props },\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n    };\n\n    if (Hooks.call(\"pf1PreActorRollSave\", this, rollOptions, savingThrowId) === false) return;\n\n    const result = await ffd20.dice.d20Roll(rollOptions);\n    Hooks.callAll(\"pf1ActorRollSave\", this, result, savingThrowId);\n\n    return result;\n  }\n\n  /**\n   * Show defenses in chat\n   *\n   * @param {object} [options={}] Additional options\n   * @param {string | null} [options.rollMode=null]   The roll mode to use for the roll; defaults to the user's current preference when `null`.\n   * @param {TokenDocument} [options.token] Relevant token if any.\n   * @returns {Promise<ChatMessage|undefined>} - Created message\n   */\n  async displayDefenseCard({ rollMode = null, token } = {}) {\n    if (!this.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: this.name }));\n    }\n    const rollData = this.getRollData();\n\n    // Add contextual AC notes\n    const acNotes = await this.getContextNotesParsed(\"ac\", { rollData });\n\n    // Add contextual CMD notes\n    const cmdNotes = await this.getContextNotesParsed(\"cmd\", { rollData });\n\n    // BUG: No specific saving throw notes are included\n    const saveNotes = await this.getContextNotesParsed(\"allSavingThrows\", { rollData });\n\n    // Conditions\n    const conditions = {\n      bleed: ffd20.registry.conditions.get(\"bleed\").name,\n      abilityDamage: game.i18n.localize(\"FFD20.AbilityDamage\"),\n      abilityDrain: game.i18n.localize(\"FFD20.AbilityDrain\"),\n    };\n\n    // Get actor's token\n    token ??= this.token;\n\n    // Create message\n    const actorData = this.system;\n    const templateData = {\n      actor: this,\n      name: token?.name ?? this.name,\n      tokenUuid: token?.uuid ?? null,\n      type: this.system.traits.type,\n      ac: {\n        normal: actorData.attributes.ac.normal.total,\n        touch: actorData.attributes.ac.touch.total,\n        stopped: actorData.attributes.ac.stopped.total,\n        notes: acNotes,\n      },\n      cmd: {\n        normal: actorData.attributes.cmd.total,\n        stopped: actorData.attributes.cmd.stoppedTotal,\n        notes: cmdNotes,\n      },\n      misc: {\n        hardness: actorData.traits.hardness,\n        conditions,\n      },\n      saves: {\n        save: rollData.attributes?.savingThrows?.save?.total,\n        notes: saveNotes,\n      },\n    };\n\n    rollMode ||= game.settings.get(\"core\", \"rollMode\");\n\n    const chatData = {\n      content: await renderTemplate(\"systems/ffd20/templates/chat/defenses-vehicle.hbs\", templateData),\n      speaker: ChatMessage.implementation.getSpeaker({ actor: this, token, alias: token?.name }),\n      rollMode,\n      system: {\n        subject: { info: \"defenses\" },\n      },\n      flags: {\n        core: {\n          canPopout: true,\n        },\n      },\n    };\n\n    // Apply roll mode\n    ChatMessage.implementation.applyRollMode(chatData, rollMode);\n\n    return ChatMessage.implementation.create(chatData);\n  }\n}\n","import { ItemBasePF } from \"@item/item-base.mjs\";\nimport { getHighestChanges } from \"@documents/actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\nimport { ActionUse } from \"@actionUse/action-use.mjs\";\nimport { getSkipActionPrompt } from \"@documents/settings.mjs\";\n\n/**\n * Override and extend the basic :class:`Item` implementation\n */\nexport class ItemPF extends ItemBasePF {\n  /**\n   * Configure item before data preparation.\n   *\n   * @override\n   * @param {object} options - Data model options\n   */\n  _configure(options = {}) {\n    super._configure(options);\n\n    /**\n     * An object containing links to other items.\n     *\n     * @type {Record<string, ItemPF>}\n     */\n    this.links = {};\n\n    if (this.hasActions) {\n      /**\n       * A {@link Collection} of {@link ItemAction}s.\n       *\n       * @type {Collection<ffd20.components.ItemAction>}\n       */\n      this.actions = new Collection();\n    }\n\n    /** @type {Collection<string, ffd20.components.ItemScriptCall>} */\n    this.scriptCalls = new Collection();\n  }\n\n  /**\n   * A static object holding system-specific metadata applicable to all instances of this Document class.\n   *\n   * @internal\n   */\n  static system = Object.freeze({\n    /**\n     * Whether this item is a physical one, possessing properties like quantity or weight.\n     *\n     * @type {boolean}\n     */\n    isPhysical: false,\n    /**\n     * Whether this item receives an identifier.\n     */\n    hasIdentifier: true,\n    /**\n     * Whether this item has changes and change flags.\n     */\n    hasChanges: true,\n    /**\n     * Whether this item has actions.\n     */\n    hasActions: true,\n    /**\n     * Subtype name should be used as default name.\n     */\n    subtypeName: false,\n  });\n\n  /** @inheritDoc */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    // Ensure unique Change IDs\n    const actor = this.actor;\n    if (actor && data?.system?.changes?.length > 0) {\n      /** @type {Array<ItemChange>} */\n      const changes = data.system.changes;\n\n      /** @type {Set<string>} */\n      let ids = new Set();\n      while (ids.size < changes.length) ids.add(foundry.utils.randomID(8));\n      ids = Array.from(ids);\n      for (const c of changes) c._id = ids.pop();\n      this.updateSource({ \"system.changes\": changes });\n    }\n  }\n\n  /**\n   * Adjust temporary item before creation\n   *\n   * @abstract\n   * @protected\n   * @param {ItemPF} [item] - Temporary document\n   * @param {object} [data] - Creation data\n   * @param {boolean} [override=false] - Override values even if defined\n   */\n  // eslint-disable-next-line no-unused-vars\n  static _adjustNewItem(item, data, override = false) {}\n\n  /**\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Creation context options\n   * @param {string} userId - Triggering user ID\n   */\n  _onCreate(data, context, userId) {\n    super._onCreate(data, context, userId);\n\n    if (userId !== game.user.id) return;\n\n    if (this.isActive) {\n      // Simulate toggling a feature or buff on\n      if ([\"buff\", \"feat\"].includes(this.type)) {\n        this.executeScriptCalls(\"toggle\", { state: true });\n      }\n    }\n\n    // Handle Size Change no longer affecting actor\n    // TODO: Move this to actor so it's done only once\n    if (this.actor && this.adjustsSize) {\n      this.actor._updateTokenSize();\n    }\n  }\n\n  /** @override */\n  getFlag(scope, key) {\n    if (scope === \"ffd20\" && key === \"defaultAmmo\") {\n      foundry.utils.logCompatibilityWarning(\n        \"item.getFlag('ffd20', 'defaultAmmo') is deprecated, please use item.system.ammo?.default instead\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      return this.system.ammo?.default || this.flags?.ffd20?.defaultAmmo;\n    }\n    return super.getFlag(scope, key);\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    context.adjustedSize = this.adjustsSize;\n    context.adjustedVision = this.adjustsVision;\n\n    await super._preUpdate(changed, context, user);\n\n    // Obsolete ammo location\n    if (changed.flags?.ffd20?.defaultAmmo) {\n      foundry.utils.logCompatibilityWarning(\n        \"item.flags.ffd20.defaultAmmo is no longer used, please use item.system.ammo.default instead\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      foundry.utils.setProperty(changed.system, \"ammo.default\", changed.flags?.ffd20?.defaultAmmo);\n      delete changed.flags.ffd20.defaultAmmo;\n    }\n\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    this._preUpdateNumericValueGuard(changed.system);\n\n    // Ensure tag is not invalid\n    if (changed.system.tag) {\n      changed.system.tag = ffd20.utils.createTag(changed.system.tag, { allowUpperCase: true, camelCase: false });\n    }\n\n    // Make sure stuff remains an array\n    const keepPaths = [\n      \"system.attackNotes\",\n      \"system.effectNotes\",\n      \"system.contextNotes\",\n      \"system.scriptCalls\",\n      \"system.actions\",\n      \"system.changes\",\n    ];\n\n    const itemData = this.toObject();\n    for (const path of keepPaths) {\n      ffd20.utils.internal.keepUpdateArray(itemData, changed, path);\n    }\n\n    await this._chargePreUpdate(changed, context);\n  }\n\n  /**\n   * Fake DataModel-like behaviour\n   *\n   * Ensure numeric bits remain numbers\n   *\n   * @internal\n   * @abstract\n   * @param {object} system - System data\n   */\n  // eslint-disable-next-line no-unused-vars\n  _preUpdateNumericValueGuard(system) {}\n\n  /**\n   * Handle charge update sanity checking, constraining them to reasonable values,\n   *   and propagating to parent items if charges are shared.\n   *\n   * @private\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   */\n  async _chargePreUpdate(changed, context) {\n    // Make sure charges doesn't exceed max charges\n    const uses = changed.system.uses;\n    if (uses?.value && this.isCharged) {\n      const maxCharges = this.maxCharges;\n      if (uses.value > maxCharges) uses.value = maxCharges;\n\n      const link = this.links.charges;\n      if (link) {\n        // Update charges for linked item. This will cascade if items are linked more.\n        await link.update({ \"system.uses.value\": uses.value }, context);\n        // Remove updating current item's inherited value\n        delete changed.system.uses.value;\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context - Delete context options\n   * @param {string} userId - Triggering user\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Remove special charge sharing links that don't clear on their own\n    const links = this.getLinkedItemsSync(\"charges\");\n    if (links.length) {\n      for (const link of links) {\n        if (link.links?.charges) {\n          delete link.links.charges;\n          link.reset();\n        }\n      }\n    }\n\n    // Handle Size Change no longer affecting actor\n    // TODO: Move this to actor so it's done only once\n    if (this.adjustsSize) {\n      this.actor?._updateTokenSize();\n    }\n  }\n\n  /**\n   * @returns {string[]} The keys of data variables to memorize between updates, for e.g. determining the difference in update.\n   */\n  get memoryVariables() {\n    return [\"quantity\", \"level\"];\n  }\n\n  /**\n   * Whether the item is tangible physical object in reality.\n   *\n   * @remarks\n   * - You can utilize this with raw data via `CONFIG.Item.documentClasses[type]?.isPhysical`\n   *\n   * @type {boolean}\n   */\n  static get isPhysical() {\n    return this.system.isPhysical;\n  }\n\n  /** {@inheritDoc ItemPF.isPhysical:getter} */\n  get isPhysical() {\n    return this.constructor.isPhysical;\n  }\n\n  /** @type {boolean} */\n  static get hasChanges() {\n    return this.system.hasChanges;\n  }\n\n  /** {@inheritDoc ItemPF.isPhysical:getter} */\n  get hasChanges() {\n    return this.constructor.hasChanges;\n  }\n\n  static get hasActions() {\n    return this.system.hasChanges;\n  }\n\n  /** {@inheritDoc ItemPF.hasActions:getter} */\n  get hasActions() {\n    return this.constructor.hasActions;\n  }\n\n  /**\n   * The item's subtype, or `null` if the item has no subtype\n   *\n   * @type {string|null}\n   */\n  get subType() {\n    return this.system.subType ?? null;\n  }\n\n  /**\n   * Base material\n   *\n   * @type {string|null}\n   */\n  get baseMaterial() {\n    return this.system.armor?.material?.base?.value || this.system.material?.base?.value || null;\n  }\n\n  /**\n   * The item's actual material.\n   *\n   * @type {string|null}\n   */\n  get normalMaterial() {\n    return (\n      this.system.armor?.material?.normal?.value || this.system.material?.normal?.value || this.baseMaterial || null\n    );\n  }\n\n  /**\n   * The item's material addons.\n   *\n   * @type {string[]}\n   */\n  get addonMaterial() {\n    const addons = this.system.armor?.material?.addon || this.system.material?.addon || [];\n    return addons.filter((o) => !!o);\n  }\n\n  /**\n   * The item's alignment attributes, or `null` if the item has no alignment attributes\n   *\n   * @type {string|null}\n   */\n  get alignments() {\n    return this.system.alignments ?? null;\n  }\n\n  /**\n   * @deprecated\n   * @type {ffd20.components.ItemAction|undefined}\n   */\n  get firstAction() {\n    foundry.utils.logCompatibilityWarning(\"ItemPF.firstAction is deprecated in favor of ItemPF.defaultAction\", {\n      since: \"PF1 v10\",\n      until: \"PF1 v12\",\n    });\n    return this.defaultAction;\n  }\n\n  /** @type {ffd20.components.ItemAction|undefined} */\n  get defaultAction() {\n    return this.actions?.get(this.system.actions?.[0]?._id);\n  }\n\n  /**\n   * Returns `true` if any of this item's actions have an attack, see {@link ItemAction#hasAttack}.\n   *\n   * @type {boolean}\n   */\n  get hasAttack() {\n    return this.actions?.some((o) => o.hasAttack) ?? false;\n  }\n\n  /**\n   * Returns `true` if any of this item's actions have a damage roll, see {@link ItemAction#hasDamage}.\n   *\n   * @type {boolean}\n   */\n  get hasDamage() {\n    return this.actions?.some((o) => o.hasDamage) ?? false;\n  }\n\n  /* -------------------------------------------- */\n  /*  Item Properties                             */\n  /* -------------------------------------------- */\n\n  /**\n   * @abstract\n   * @param {boolean} [weapon=true] - Get proficiency as a weapon. Armor otherwise.\n   * @returns {boolean} - Whether or not the owner of the item is proficient.\n   * @throws {Error} - If item type does not support proficiency.\n   * @since PF1 v10\n   */\n  // eslint-disable-next-line no-unused-vars\n  getProficiency(weapon = true) {\n    throw new Error(`Item type ${this.type} has no concept of proficiency`);\n  }\n\n  /**\n   * Is the owning actor proficiency at using this as weapon.\n   *\n   * @abstract\n   * @type {boolean}\n   * @since PF1 v10\n   */\n  get isProficient() {\n    return true;\n  }\n\n  /** @type {boolean} */\n  get hasAction() {\n    return this.system.actions?.length > 0;\n  }\n\n  /** @type {boolean} */\n  get isSingleUse() {\n    return this.system.uses?.per === \"single\";\n  }\n\n  /** @type {boolean} */\n  get isCharged() {\n    return this.isSingleUse || !!this.system.uses?.per;\n  }\n\n  /**\n   * Finite charges\n   *\n   * @type {boolean}\n   */\n  get hasFiniteCharges() {\n    return this.isSingleUse || [\"charges\"].includes(this.system.uses?.per);\n  }\n\n  /**\n   * Remaining charges\n   *\n   * @type {number}\n   */\n  get charges() {\n    // Get linked charges\n    const link = this.links?.charges;\n    if (link) return link.charges;\n\n    if (!this.system.uses?.per) return Infinity;\n\n    // Get own charges\n    if (this.isSingleUse) return this.system.quantity || 0;\n    return this.system.uses?.value ?? 0;\n  }\n\n  /**\n   * Consumes are adds charges by default.\n   *\n   * @type {boolean}\n   */\n  get autoDeductCharges() {\n    return this.getDefaultChargeCost() != 0;\n  }\n\n  /**\n   * Get default charge cost for all actions.\n   *\n   * @param {object} [options] Additional options\n   * @param {object} [options.rollData] Roll data instance\n   * @returns {number} Number for default cost.\n   */\n  getDefaultChargeCost({ rollData } = {}) {\n    rollData ??= this.getRollData();\n    const formula = this.getDefaultChargeFormula();\n    // TODO: Support default cost being variable\n    return RollPF.safeRollSync(formula, rollData, undefined, undefined, { maximize: true }).total;\n  }\n\n  /**\n   * Default charge formula.\n   *\n   * @returns {string} Charge formula\n   */\n  getDefaultChargeFormula() {\n    return this.system.uses?.autoDeductChargesCost || \"1\";\n  }\n\n  /**\n   * Maximum possible charges this item can have.\n   *\n   * @remarks\n   * - Can return zero. Usually signifying something has reduced the potential uses below usability.\n   * - Can return infinity, signifying lack of limits.\n   *\n   * @type {number}\n   */\n  get maxCharges() {\n    // Get linked charges\n    const link = this.links?.charges;\n    if (link) return link.maxCharges;\n\n    if (!this.system.uses?.per) return Infinity;\n\n    // Get own charges\n    if (this.isSingleUse) return this.system.quantity || 0;\n\n    return this.system.uses?.max ?? Infinity;\n  }\n\n  /**\n   * Recharges item's uses, if any.\n   *\n   * @param {object} options - Options\n   * @param {\"round\"|\"minute\"|\"hour\"|\"day\"|\"week\"|\"any\"} [options.period=\"day\"] Recharge period. Use \"any\" to ignore item's configuration.\n   * @param {boolean} [options.exact=false] - Use exact time period. Otherwise \"week\" for example will also recharge items with \"day\" period.\n   * @param {number} [options.value] - Recharge to specific value, respecting maximum and minimum bounds.\n   * @param {boolean} [options.maximize=false] - Recharge to full regardless of recharge formula.\n   * @param {boolean} [options.commit=true] - Commit update directly. If false, returns the update data instead.\n   * @param {object} [options.rollData] - Roll data instance to use for formulas.\n   * @param {object} [options.context] - Update context\n   * @returns {Promise<this|object|undefined>} - Promise for the update, update data object, or undefined (no update needed).\n   */\n  async recharge({ value, period = \"day\", exact = false, maximize = false, commit = true, rollData, context } = {}) {\n    const updateData = (await this._rechargeUses({ value, period, exact, maximize, rollData })) ?? { system: {} };\n    const actionUpdate = this._rechargeActions({ period, exact, rollData });\n    if (actionUpdate) updateData.system.actions = actionUpdate.system.actions;\n\n    // Cancel empty update\n    if (foundry.utils.isEmpty(updateData.system)) return;\n\n    if (commit) return this.update(updateData, context);\n    return updateData;\n  }\n\n  /**\n   * Recharge item uses\n   *\n   * {@inheritDoc recharge}\n   *\n   * @internal\n   * @param {object} options - Options\n   * @param {number} [options.value] - Set charges to specific value\n   * @param {string} [options.period] - Recharge only if it matches this time period\n   * @param {boolean} [options.exact] - Match only exact time period\n   * @param {boolean} [options.maximize] - Maximize instead of using recharge formula\n   * @param {object} [options.rollData] - Roll data instance\n   * @returns {Promise<object | undefined>} - Update data or undefined if no update is necessary.\n   */\n  async _rechargeUses({ value, period, exact, maximize, rollData } = {}) {\n    const uses = this.system.uses ?? {};\n    if (!uses.per) return; // Unlimited uses, recharging meaningless\n\n    // Cancel if charges are managed by different item.\n    if (this.links.charges) return;\n\n    // No update when period does not match usage\n    if ([\"charges\", \"single\"].includes(uses.per)) {\n      // Only charge if time period is any\n      if (period !== \"any\") return;\n    } else if (ffd20.config.limitedUsePeriodOrder.includes(period) && !exact) {\n      // Recharge lesser time periods when using inexact matching\n      const idx = ffd20.config.limitedUsePeriodOrder.indexOf(period);\n      const validPeriods = ffd20.config.limitedUsePeriodOrder.slice(0, idx + 1);\n      if (!validPeriods.includes(uses.per)) return;\n    }\n    // Otherwise test if \"any\" period is used\n    else if (uses.per !== period && period !== \"any\") return;\n\n    const staticValue = value !== undefined;\n\n    // No specific value given\n    if (!staticValue) {\n      const formula = uses.rechargeFormula || \"\";\n      // Default to maximizing value\n      if (!formula) {\n        if (uses.max > 0) maximize = true;\n      } else {\n        rollData ??= this.getRollData();\n        const roll = await RollPF.safeRoll(formula, rollData, \"recharge\", undefined, { allowInteractive: false });\n        value = roll.total;\n\n        // Cancel if formula produced invalid value\n        if (!Number.isFinite(value))\n          return void console.warn(`Formula \"${formula}\" produced non-numeric value \"${value}\"`);\n      }\n    }\n\n    // Maximize value regardless what value is\n    if (maximize) value = uses.max;\n\n    // No recharge value established\n    if (!Number.isFinite(value)) return;\n\n    // Clamp charge value to\n    value = Math.clamp(value, 0, uses.max);\n\n    if (value !== uses.value) {\n      return { system: { uses: { value } } };\n    }\n  }\n\n  /**\n   * Update action limited uses\n   *\n   * {@inheritDoc ItemPF.recharge}\n   *\n   * @internal\n   * @param {object} options - Options\n   * @param {string} [options.period] - Recharge only if matching this time period\n   * @param {boolean} options.exact - Exact time period only\n   * @param {object} [options.rollData] - Roll data\n   * @returns {object|undefined} - Update data or undefined if no update is needed.\n   */\n  // eslint-disable-next-line no-unused-vars\n  _rechargeActions({ period, exact, rollData } = {}) {\n    if (!(this.system.actions?.length > 0)) return;\n\n    const actions = this.toObject().system.actions;\n    let changedActions = false;\n    for (const actionData of actions) {\n      const action = this.actions.get(actionData._id);\n      const max = action.uses?.self?.max ?? 0;\n      if (!(max > 0)) continue;\n\n      const uses = actionData.uses?.self;\n      const per = uses?.per;\n      if (!per) continue;\n\n      if ([\"charges\"].includes(uses.per)) {\n        continue;\n      } else if (ffd20.config.limitedUsePeriodOrder.includes(period) && !exact) {\n        // Recharge lesser time periods when using inexact matching\n        const idx = ffd20.config.limitedUsePeriodOrder.indexOf(period);\n        const validPeriods = ffd20.config.limitedUsePeriodOrder.slice(0, idx + 1);\n        if (!validPeriods.includes(per)) continue;\n      }\n\n      if (uses.value < max) {\n        uses.value = max;\n        changedActions = true;\n      }\n    }\n\n    if (!changedActions) return;\n\n    return { system: { actions } };\n  }\n\n  /**\n   * Aura strength as number from 0 to 4.\n   *\n   * @see {@link ffd20.config.auraStrengths}\n   *\n   * @type {number}\n   */\n  get auraStrength() {\n    const cl = this.system.cl || 0;\n    if (cl < 1) {\n      return 0;\n    } else if (cl < 6) {\n      return 1;\n    } else if (cl < 12) {\n      return 2;\n    } else if (cl < 21) {\n      return 3;\n    }\n    return 4;\n  }\n\n  get uuid() {\n    if (this.parentItem) return this.parentItem.uuid + `.Item.${this.id}`;\n    return super.uuid;\n  }\n\n  get fullDescription() {\n    return this.system.description.value;\n  }\n\n  /**\n   * Get full description.\n   *\n   * @abstract\n   * @param {object} options - Item type dependant options for rendering the description.\n   * @param {boolean} [options.chatcard=false] - Instruct template to render chat card in mind.\n   * @param {object} [options.data={}] - Template data for rendering\n   * @param {object} [options.rollData] - Roll data for transforming description\n   * @param {boolean} [options.header] - Include header if such exists.\n   * @param {boolean} [options.body] - Include main description body if such exists.\n   * @param {boolean} [options.identified] - Enforce identified description retrieval\n   * @param {boolean} [options.isolated] - Passed to {@link getDescriptionData}\n   * @returns {Promise<string>} - Full description.\n   */\n\n  async getDescription({\n    chatcard = false,\n    data = {},\n    rollData,\n    header = true,\n    body = true,\n    isolated = false,\n    identified = false,\n  } = {}) {\n    if (body) {\n      if (identified) return this._source.system.description?.value || \"\";\n      return this.system.description?.value || \"\";\n    }\n    return \"\";\n  }\n\n  /**\n   * Description Data\n   *\n   * @param {object} options - Additional options\n   * @param {object} [options.rollData] - Roll data instance\n   * @param {boolean} [options.isolated] - Include extra data to reflect it not being so easily available in context.\n   * @returns {Promise<object>} - Description context data\n   */\n  async getDescriptionData({ rollData, isolated = false } = {}) {\n    const context = {};\n\n    const action = this.defaultAction;\n    rollData ??= action?.getRollData() ?? this.getRollData();\n    context.rollData = rollData;\n    context.labels = action?.getLabels({ rollData, isolated }) ?? this.getLabels({ rollData, isolated });\n\n    const fullInfo = game.user.isGM ? true : (this.system.identified ?? true);\n\n    // Attack data, for attacks and weapons primarily\n    if (!action) return context;\n\n    if (action?.hasAttack) {\n      context.action = {};\n      if (action.hasDamage) {\n        const firstDamage = action.damage?.parts?.[0]?.formula;\n        // Spoof sizeRoll() to work based on weapon size instead of actor size\n        const sizeKey = ffd20.config.sizeChart[this.system.size || \"med\"] || \"M\";\n        const sizeIndex = Object.values(ffd20.config.sizeChart).indexOf(sizeKey);\n        context.action.damage = ffd20.utils.formula.simplify(firstDamage || \"0\", {\n          ...rollData,\n          size: sizeIndex,\n        });\n        const critMult = action?.ability?.critMult || 1;\n        if (critMult > 1) {\n          const critRange = action.critRange || 20;\n          if (critRange === 20) context.action.critical = `Ã${critMult}`;\n          else context.action.critical = `${critRange}-20/Ã${critMult}`;\n        }\n        context.action.size = Object.values(ffd20.config.actorSizes)[sizeIndex] || ffd20.config.actorSizes.med;\n\n        const types = fullInfo\n          ? action.damage?.parts?.map((part) => part.parsed.all.map((t) => t.name || t)).flat()\n          : (action.damage?.parts?.[0].parsed.all.map((t) => t.name || t) ?? []);\n\n        context.action.type = types.join(\", \");\n      }\n\n      // Range\n      if ([\"melee\", \"reach\"].includes(action.range?.units)) context.action.range = \"â\";\n      else if ([\"ft\"].includes(action.range?.units)) {\n        context.action.range = action.range;\n        context.action.unit =\n          ffd20.utils.getDistanceSystem() === \"metric\" ? ffd20.config.measureUnitsShort.m : ffd20.config.measureUnitsShort.ft;\n      }\n\n      if (action.ammo.type && action.ammo.cost) {\n        const misfire = action.misfire;\n        const capacity = this.system.ammo?.capacity ?? 0;\n        context.action.ammo = {\n          misfire: misfire > 1 ? `1â${misfire}` : misfire > 0 ? misfire : null,\n          capacity: capacity > 0 ? capacity : \"â\",\n          enabled: misfire > 0 || capacity > 0,\n        };\n      }\n    }\n    return context;\n  }\n\n  /**\n   * An active effect associated with this item.\n   *\n   * @remarks\n   * - Most item types don't have associated effect.\n   *\n   * @abstract\n   * @type {ActiveEffect|null}\n   */\n  get effect() {\n    return null;\n  }\n\n  /**\n   * An array containing all action types from this item's actions.\n   *\n   * @see {@link config.itemActionTypes}\n   * @type {string[]}\n   */\n  get actionTypes() {\n    const actionTypes = this.actions?.map((action) => action.actionType).filter(Boolean) ?? [];\n    return [...new Set(actionTypes)];\n  }\n\n  /**\n   * Generic charge addition (or subtraction) function that either adds charges\n   * or quantity, based on item data.\n   *\n   * @param {number} value The amount of charges to add.\n   * @returns {Promise<this | void>} Updated document or undefined if no update is possible.\n   */\n  async addCharges(value) {\n    // Add link charges\n    const link = this.links.charges;\n    if (link) return link.addCharges(value);\n\n    // Add own charges\n    if (this.isSingleUse && this.isPhysical) {\n      return this.update({ \"system.quantity\": (this.system.quantity || 0) + value });\n    } else {\n      return this.update({ \"system.uses.value\": (this.system.uses?.value || 0) + value });\n    }\n  }\n\n  /**\n   * Linked ammunition item if any.\n   *\n   * @type {Item|undefined}\n   */\n  get defaultAmmo() {\n    return this.actor?.items.get(this.system.ammo?.default);\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Should the item show unidentified data\n   *\n   * @type {boolean}\n   */\n  get showUnidentifiedData() {\n    return false;\n  }\n\n  /* -------------------------------------------- */\n  /*\tData Preparation\t\t\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * @override\n   */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    this.prepareLinks();\n\n    // Update changes\n    if (this.hasChanges) {\n      this._prepareChanges();\n    }\n\n    this._prepareScriptCalls();\n\n    // Prepare dependent data only if there's no actor or actor initialization has happened.\n    if (!this.actor || this.actor._initialized !== false) {\n      this._prepareDependentData(true);\n    }\n  }\n\n  /**\n   * Prepare data potentially dependent on other items.\n   *\n   * This should be run at in Item.prepareDerivedData() if no actor is present,\n   * or in actor's prepareDerivedData after document preparation is done.\n   *\n   * @param {boolean} final - Is this final call to this?\n   */\n  _prepareDependentData(final = false) {\n    // Update maximum uses\n    this._updateMaxUses();\n\n    // Prepare actions only when item preparation is deemed finalized\n    if (final) this._prepareActions();\n  }\n\n  /**\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    this._prepareIdentifier();\n    this._prepareTraits();\n\n    if (this.inContainer) this.adjustContained();\n\n    if (this.system.contextNotes?.length) {\n      this.system.contextNotes = this.system.contextNotes.map(\n        (cn) => new ffd20.components.ContextNote(cn, { parent: this })\n      );\n    }\n  }\n\n  /**\n   * Initialize identifier\n   *\n   * @internal\n   */\n  _prepareIdentifier() {\n    const isTaggedType = this.constructor.system?.hasIdentifier ?? false;\n    if (isTaggedType) {\n      if (!this.system.tag) {\n        this.system.tag = ffd20.utils.createTag(this.name);\n      }\n    }\n  }\n\n  /**\n   * @internal\n   */\n  _prepareTraits() {\n    const map = {\n      descriptors: ffd20.config.spellDescriptors,\n      weaponGroups: ffd20.config.weaponGroups,\n      multischool: ffd20.config.spellMultischools,\n      subschool: ffd20.config.spellSubschools,\n      languages: ffd20.config.languages,\n      armorProf: ffd20.config.armorProficiencies,\n      weaponProf: ffd20.config.weaponProficiencies,\n      creatureTypes: ffd20.config.creatureTypes,\n      creatureSubtypes: ffd20.config.creatureSubtypes,\n    };\n\n    for (const [key, labels] of Object.entries(map)) {\n      if (!this.system[key]) continue;\n      if (!Array.isArray(this.system[key])) {\n        continue; // Preparation has already run, avoid double transform\n      }\n\n      const trait = {\n        base: this.system[key],\n        custom: new Set(),\n        standard: new Set(),\n        get total() {\n          return this.standard.union(this.custom);\n        },\n        get names() {\n          return [...this.standard.map((t) => labels[t] || t), ...this.custom];\n        },\n      };\n      Object.defineProperty(trait, \"value\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(`item.system.${key}.value is deprecated.`, {\n            since: \"PF1 v11\",\n            until: \"PF1 v12\",\n          });\n          return this.standard;\n        },\n      });\n      if (Array.isArray(trait.base)) {\n        for (const c of trait.base) {\n          if (labels[c]) trait.standard.add(c);\n          else trait.custom.add(c);\n        }\n      }\n      this.system[key] = trait;\n    }\n  }\n\n  /**\n   * Adjust data if the item is in container.\n   *\n   * @abstract\n   */\n  adjustContained() {}\n\n  /**\n   * Returns labels for this item\n   *\n   * @param {object} [options={}] - Additional options\n   * @param {string} [options.actionId] - ID of one of this item's actions to get labels for; defaults to first action\n   * @param {object} [options.rollData] - Roll data to use.\n   * @param {boolean} [options.isolated] - Is this isolated use? If true, more data is included.\n   * @returns {Record<string, string>} This item's labels\n   */\n  getLabels({ actionId, rollData, isolated } = {}) {\n    const action = actionId ? this.actions.get(actionId) : this.defaultAction;\n    const labels = action?.getLabels({ rollData, isolated }) ?? {};\n    labels.activation ||= ffd20.config.abilityActivationTypes.passive; // Default passive if no action is present\n    if (!action) labels.noAction = true;\n    if (!action || action.activation.type === \"passive\") labels.isPassive = true;\n    labels.hasEffect = Boolean(\n      labels.range || labels.area || labels.target || labels.effect || labels.duration || labels.savingThrow\n    );\n    return labels;\n  }\n\n  /**\n   * Prepare item links.\n   *\n   * @internal\n   */\n  prepareLinks() {\n    if (!this.links) return;\n\n    for (const [type, item] of Object.entries(this.links)) {\n      if (type === \"charges\") {\n        // Remove cached link if stale\n        // TODO: This should not exist.\n        const links = item.getLinkedItemsSync(\"charges\");\n        if (!links.some((i) => i.id === this.id)) {\n          delete this.links.charges;\n          continue;\n        }\n\n        this._updateInheritedCharges(item);\n      }\n    }\n  }\n\n  /**\n   * Prepare and update Changes collection.\n   *\n   * @internal\n   */\n  _prepareChanges() {\n    const prior = this.changes;\n    const collection = new Collection();\n    for (const c of this.system.changes ?? []) {\n      /** @type {ffd20.components.ItemChange} */\n      let change;\n      if (prior && prior.has(c._id)) {\n        change = prior.get(c._id);\n        change.replaceSource(c);\n      } else change = new ffd20.components.ItemChange(c, { parent: this });\n      collection.set(c._id || change.data._id, change);\n    }\n\n    this.changes = collection;\n  }\n\n  /**\n   * Prepare actions\n   *\n   * @internal\n   */\n  _prepareActions() {\n    const actions = this.system.actions ?? [];\n\n    const prior = this.actions;\n    const collection = new Collection();\n    for (const actionData of actions) {\n      let action = null;\n      if (prior && prior.has(actionData._id)) {\n        action = prior.get(actionData._id);\n        action.replaceSource(actionData);\n      } else {\n        action = new ffd20.components.ItemAction(actionData, { parent: this });\n      }\n      collection.set(action.id, action);\n    }\n\n    /** @type {Collection<ffd20.components.ItemAction>} */\n    this.actions = collection;\n\n    for (const action of prior ?? []) {\n      if (this.actions.get(action.id) !== action) {\n        for (const app of Object.values(action.apps)) {\n          app.close({ ffd20: { action: \"delete\" }, submit: false, force: true });\n        }\n      }\n    }\n  }\n\n  /**\n   * Prepare `ItemPF.scriptCalls` collection.\n   *\n   * @internal\n   */\n  _prepareScriptCalls() {\n    if (!this.scriptCalls) return;\n\n    const prior = new Collection(this.scriptCalls.entries());\n    this.scriptCalls.clear(); // TODO: Remove specific entries after the loop instead of full clear here\n\n    const scriptCalls = this.system.scriptCalls;\n    if (!scriptCalls?.length) return;\n\n    for (const s of scriptCalls) {\n      const sid = s._id;\n      let script = null;\n      if (prior && prior.has(sid)) {\n        script = prior.get(sid);\n        const scriptData = { ...s };\n        script.replaceSource(scriptData);\n      } else script = new ffd20.components.ItemScriptCall(s, { parent: this });\n      this.scriptCalls.set(sid, script);\n    }\n  }\n\n  /**\n   * Executes all script calls on this item of a specified category.\n   *\n   * @param {string} category - The category of script calls to call.\n   * @param {Record<string, *>} [extraParams={}] - A dictionary of extra parameters to pass as variables for use in the script.\n   * @param {object} [shared={}] - Shared data object\n   * @returns {Promise<object>} The shared object between calls which may have been given data.\n   */\n  async executeScriptCalls(category, extraParams = {}, shared = {}) {\n    /** @type {ffd20.components.ItemScriptCall[]} */\n    const scripts = this.scriptCalls?.filter((o) => o.category === category) ?? [];\n\n    shared.category = category;\n\n    try {\n      for (const s of scripts) {\n        await s.execute(shared, extraParams);\n      }\n    } catch (error) {\n      console.error(`Script call execution failed\\n`, error, this);\n      // Rethrow to ensure everything cancels\n      throw new Error(\"Error occurred while executing a script call\", { cause: error });\n    }\n\n    return shared;\n  }\n\n  /**\n   * @override\n   * @param {object} data - Update data\n   * @param {object} context - Context\n   * @returns {Promise<Item>} - Updated item\n   */\n  async update(data, context = {}) {\n    // Avoid regular update flow for explicitly non-recursive update calls\n    if (context.recursive === false) {\n      if (this.inContainer) {\n        this.rootItem.update(this._transformContainerUpdateData(data, { recursive: true }), context);\n      } else {\n        return super.update(data, context);\n      }\n    }\n\n    data = foundry.utils.expandObject(data);\n\n    this.memorizeVariables();\n\n    const parentItem = this.parentItem;\n    if (!parentItem) {\n      return super.update(data, context);\n    } else {\n      // Update parent item\n      context.ffd20 ??= {};\n      context.ffd20.containerItem = this.id;\n      await parentItem.update(this._transformContainerUpdateData(data), context);\n      return this;\n    }\n  }\n\n  /**\n   * Transform given data so it becomes valid update data within parent item.\n   *\n   * This can, for example, be used to generate batched update to the real item.\n   *\n   * @example\n   * ```js\n   * _transformContainerUpdateData({ name: \"new name\" })\n   * // => { system: { items: { [itemID]: { name: \"new name\" } } } }\n   * ```\n   *\n   * @internal\n   * @param {object} data Update data\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.recursive=false] - Create data recursively, meant for the real item document.\n   * @returns {object} - Transformed update data\n   */\n  _transformContainerUpdateData(data, { recursive = false } = {}) {\n    const parentItem = this.parentItem;\n    if (parentItem) {\n      const baseUpdate = { system: { items: { [this.id]: data } } };\n      if (recursive) return parentItem._transformContainerUpdateData(baseUpdate, { recursive });\n      else return baseUpdate;\n    }\n    return data;\n  }\n\n  /**\n   * Memorize quantity and level for later diffing.\n   *\n   * @internal\n   */\n  memorizeVariables() {\n    if (this._memoryVariables != null) return;\n\n    const memKeys = this.memoryVariables;\n    this._memoryVariables = {};\n    for (const k of memKeys) {\n      if (foundry.utils.hasProperty(this.system, k)) {\n        this._memoryVariables[k] = foundry.utils.deepClone(foundry.utils.getProperty(this.system, k));\n      }\n    }\n\n    // Memorize variables recursively on container items\n    for (const item of this.items ?? []) {\n      item.memorizeVariables();\n    }\n  }\n\n  /**\n   * Determine whether this item adjusts actor size\n   *\n   * @type {boolean}\n   * @readonly\n   * @private\n   */\n  get adjustsSize() {\n    return this.changes?.some((change) => change.target === \"size\") ?? false;\n  }\n\n  /**\n   * Determine whether a given change set affects size\n   *\n   * @internal\n   * @param {object} data - Item data\n   * @returns {boolean} - Contains size targeting change\n   */\n  static _hasSizeUpdate(data) {\n    return data.system?.changes?.some((change) => change.target === \"size\") || false;\n  }\n\n  /**\n   * Determine whether this item adjusts senses\n   *\n   * @type {boolean}\n   * @readonly\n   * @private\n   */\n  get adjustsVision() {\n    const flags = this.system.changeFlags;\n    if (flags && (flags?.lowLightVision || flags?.seeInvisibility || flags?.seeInDarkness)) {\n      return true;\n    }\n\n    return this.system.changes?.some((change) => ffd20.config.buffTargets[change.target]?.category === \"senses\") ?? false;\n  }\n\n  /**\n   * Determine whether a given change set affect senses\n   *\n   * @internal\n   * @param {object} changes - An object containing changeFlags and changes to be inspected.\n   * @returns {boolean} - Vision alteration detected\n   */\n  static _hasVisionUpdate(changes) {\n    if (\n      changes.system?.changeFlags?.lowLightVision !== undefined ||\n      changes.system?.changeFlags?.seeInvisibility !== undefined ||\n      changes.system?.changeFlags?.seeInDarkness !== undefined\n    ) {\n      return true;\n    }\n\n    return (\n      changes.system?.changes?.some((change) => ffd20.config.buffTargets[change.target]?.category === \"senses\") || false\n    );\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    if (userId !== game.user.id) return;\n\n    // Call 'toggle' script calls\n    let state = null;\n    if (this.type === \"buff\") state = changed.system?.active;\n    else if (this.type === \"feat\" && changed.system?.disabled !== undefined)\n      state = changed.system.disabled === true ? false : true;\n    if (state != null) {\n      const startTime = this.effect?.duration.startTime ?? game.time.worldTime;\n      this.executeScriptCalls(\"toggle\", { state, startTime });\n    }\n\n    // Handle Size Change\n    // TODO: Move this to actor to handle it only once\n    const activeChanged = this._activeStateChange(changed);\n    const adjustsSize = this.adjustsSize;\n    if (\n      // Item contains a size change and active state was toggled\n      (activeChanged !== undefined && adjustsSize) ||\n      // Item contains a new or updated size change\n      this.constructor._hasSizeUpdate(changed) ||\n      // Item contained a size change that was removed\n      (context.adjustedSize && !adjustsSize)\n    ) {\n      this.actor?._updateTokenSize();\n    }\n\n    if (this._memoryVariables) this._onMemorizedUpdate(changed, context);\n  }\n\n  /**\n   * Return active state change from data if present\n   *\n   * This is a hack to allow item-type agnostic active state change detection.\n   *\n   * @internal\n   * @experimental\n   * @param {object} changed\n   * @returns\n   */\n  _activeStateChange(changed) {\n    return this.system._activeStateChange?.(changed.system) ?? true;\n  }\n\n  _onMemorizedUpdate(changed, context) {\n    // Call 'changeLevel' script calls\n    const oldLevel = this._memoryVariables?.level;\n    if (oldLevel !== undefined && changed.system?.level !== undefined) {\n      const level = {\n        previous: parseInt(oldLevel),\n        new: parseInt(this.system.level),\n      };\n      for (const [k, v] of Object.entries(level)) {\n        if (Number.isNaN(v)) level[k] = null;\n      }\n      if (level.new !== undefined && level.new !== level.previous) {\n        this.executeScriptCalls(\"changeLevel\", { level });\n      }\n    }\n\n    if (\n      // Item contains a vision change and active state was toggled\n      (changed?.system?.active !== undefined && this.adjustsVision) ||\n      // Item contains a new or updated vision change\n      this.constructor._hasVisionUpdate(changed) ||\n      // Item contained a vision change that was removed\n      (context.adjustedVision && !this.adjustsVision)\n    ) {\n      const initializeVision = true;\n      const refreshLighting = this.system.changeFlags.lowLightVision || false;\n      this.actor.updateVision(initializeVision, refreshLighting);\n    }\n\n    // Forget memory variables\n    this._memoryVariables = null;\n  }\n\n  /**\n   * Update max uses\n   *\n   * @internal\n   */\n  _updateMaxUses() {\n    const per = this.system.uses?.per;\n\n    // No charges? No charges!\n    if (!per) return;\n\n    // Do not evaluate inherited charges\n    if (this.links?.charges) return;\n\n    const maxFormula = this.system.uses.maxFormula;\n    if (per === \"single\") {\n      this.system.uses.max = 1;\n    } else if (!maxFormula) {\n      this.system.uses.max = null;\n    } else {\n      try {\n        const isDeterministic = Roll.parse(maxFormula).every((t) => t.isDeterministic);\n        if (isDeterministic) {\n          const rollData = this.getRollData();\n          const roll = RollPF.safeRollSync(\n            maxFormula,\n            rollData,\n            { formula: maxFormula, item: this },\n            { suppressError: !this.isOwner }\n          );\n          this.system.uses.max = roll.total;\n\n          // Update any items inheriting our charges\n          const linked = this.getLinkedItemsSync(\"charges\");\n          for (const item of linked) {\n            item._updateInheritedCharges(this);\n          }\n        } else {\n          const msg = game.i18n.format(\"FFD20.Warning.NoDiceAllowedInFormula\", {\n            formula: maxFormula,\n            context: game.i18n.localize(\"FFD20.ChargePlural\"),\n          });\n          ui.notifications.warn(msg, { console: false });\n          console.warn(msg, this);\n        }\n      } catch (err) {\n        console.error(\"Invalid max uses formula:\", { formula: maxFormula, item: this }, err);\n      }\n    }\n  }\n\n  /**\n   * Update this item's charges based on provided item.\n   *\n   * @internal\n   * @param {Item} item - Charge source\n   */\n  _updateInheritedCharges(item) {\n    const iuses = item.system.uses;\n    if (!iuses) return;\n\n    const uses = this.system.uses;\n\n    uses.per = iuses.per;\n    uses.max = iuses.max;\n    uses.maxFormula = iuses.maxFormula;\n    uses.value = iuses.value;\n    uses.rechargeFormula = iuses.rechargeFormula;\n  }\n\n  /**\n   * Determines the starting data for an ActiveEffect based off this item.\n   *\n   * @param {object} options - Additional options\n   * @param {object} options.rollData - Roll data\n   * @returns {Promise<object>} - Active Effect creation data\n   */\n  // eslint-disable-next-line no-unused-vars\n  async getRawEffectData({ rollData } = {}) {\n    return {\n      name: this.name,\n      img: this.img,\n      origin: this.getRelativeUUID(this.actor),\n      duration: {\n        startTime: game.time.worldTime,\n      },\n      disabled: !this.isActive,\n    };\n  }\n\n  /**\n   * Fetches all this item's script calls of a specified category\n   *\n   * @internal\n   * @param {string} category - Category\n   * @returns {ffd20.components.ItemScriptCall[]} - Script calls within the category.\n   */\n  getScriptCalls(category) {\n    return this.scriptCalls?.filter((s) => s.category === category) ?? [];\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Display the chat card for an Item as a message in chat\n   *\n   * @param {object} [altChatData={}] - Optional data that will be merged into the chat data object.\n   * @param {object} [options=[]] Additional options.\n   * @param {TokenDocument} [options.token] Relevant token if any.\n   * @returns {Promise<ChatMessage | void>} Chat message instance if one was created.\n   */\n  async displayCard(altChatData = {}, { token } = {}) {\n    const actor = this.actor;\n    if (actor && !actor.isOwner) {\n      return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.NoActorPermissionAlt\", { name: actor.name }));\n    }\n\n    // Basic template rendering data\n    token ??= actor?.token;\n    const rollData = this.getRollData();\n    const itemChatData = await this.getChatData({ rollData });\n    const identified = Boolean(rollData.item?.identified ?? true);\n\n    const templateData = {\n      actor: this.actor,\n      token,\n      tokenId: token?.uuid,\n      item: this.toObject(),\n      labels: this.getLabels({ rollData }),\n      hasAttack: this.hasAttack,\n      hasMultiAttack: this.hasMultiAttack,\n      hasAction: this.hasAction,\n      isVersatile: this.isVersatile,\n      isSpell: this.type === \"spell\",\n      name: this.getName(true),\n      description: identified ? itemChatData.identifiedDescription : itemChatData.unidentifiedDescription,\n      rollData,\n      properties: [],\n    };\n\n    const enrichOptions = {\n      rollData,\n      secrets: this.isOwner,\n      relativeTo: this.actor,\n    };\n\n    // If the item was unidentified, store data for GM info box containing identified info\n    const system = {};\n    system.item = {\n      identified,\n      id: this.id,\n    };\n\n    if (identified === false) {\n      system.item.name = this._source.name;\n      // TODO: Remove storage of description?\n      // It should not be relevant after the item is deleted and the description can be fetched from the item.\n      system.item.description = await TextEditor.enrichHTML(itemChatData.identifiedDescription, enrichOptions);\n    }\n\n    if (itemChatData.properties) {\n      templateData.properties.push({\n        header: game.i18n.localize(\"FFD20.InfoShort\"),\n        value: itemChatData.properties,\n        css: \"info-properties\",\n      });\n    }\n\n    // Add combat info\n    if (game.combat) {\n      system.combat = game.combat.id;\n\n      const combatProps = [];\n      // Add round info\n      combatProps.push(game.i18n.format(\"FFD20.CombatInfo_Round\", { round: game.combat.round }));\n\n      if (combatProps.length > 0) {\n        templateData.properties.push({\n          header: game.i18n.localize(\"FFD20.CombatInfo_Header\"),\n          value: combatProps,\n          css: \"combat-properties\",\n        });\n      }\n    }\n\n    // Basic chat message data\n    const chatData = foundry.utils.mergeObject(\n      {\n        type: \"item\",\n        system,\n        style: CONST.CHAT_MESSAGE_STYLES.OTHER,\n        speaker: ChatMessage.implementation.getSpeaker({ actor, token }),\n        flags: {\n          core: {\n            canPopout: true,\n          },\n        },\n      },\n      altChatData\n    );\n\n    const template = `systems/ffd20/templates/chat/items/item-card.hbs`;\n    if (Hooks.call(\"pf1DisplayCard\", this, { template, templateData, chatData }) === false) return;\n\n    // Create the chat message\n    const content = await renderTemplate(template, templateData);\n    chatData.content = await TextEditor.enrichHTML(content, enrichOptions);\n\n    // Apply roll mode\n    chatData.rollMode ??= game.settings.get(\"core\", \"rollMode\");\n    ChatMessage.implementation.applyRollMode(chatData, chatData.rollMode);\n\n    return ChatMessage.implementation.create(chatData);\n  }\n\n  /* -------------------------------------------- */\n  /*  Chat Cards\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * Generates {@link ChatData} for this item, either in a default configuration or for a specific action.\n   *\n   * @param {object} [options] - Options affecting how descriptions are enriched.\n   *                                              `rollData`\n   * @param {boolean} [options.chatcard=false] - Is this actually for chat card.\n   * @param {boolean} [options.extended=false] - Include extended information that may not be useful in all circumstances.\n   * @param {string} [options.actionId] - The ID of an action on this item to generate chat data for,\n   *                                      defaults to {@link ItemPF.defaultAction}\n   * @param {object} [options.rollData] - Defaults to {@link ItemAction#getRollData}/{@link ItemPF#getRollData}.\n   * @param {boolean} [options.interactive=false]\n   * @returns {Promise<ChatData>} The chat data for this item (+action)\n   */\n  async getChatData({ chatcard = false, actionId = null, rollData, extended = false, interactive = false } = {}) {\n    /** @type {ChatData} */\n    const data = {};\n    const action = actionId ? this.actions.get(actionId) : this.defaultAction;\n\n    rollData ??= action ? action.getRollData() : this.getRollData();\n    const actionData = rollData.action ?? action ?? {};\n\n    const labels = this.getLabels({ actionId, rollData });\n\n    // Rich text descriptions\n    data.identifiedDescription = await this.getDescription({\n      chatcard,\n      rollData,\n      isolated: extended,\n      identified: true,\n    });\n    data.unidentifiedDescription = this.system.description.unidentified;\n\n    data.isIdentified = this.system.identified ?? true;\n    data.showIdentified = !this.showUnidentifiedData;\n    data.description = data.showIdentified ? data.identifiedDescription : data.unidentifiedDescription;\n    data.actionDescription = actionData.description;\n\n    // General equipment properties\n    const props = [];\n\n    if (chatcard !== true) {\n      if (labels.subType && labels.childTypeDistinct !== true) props.push(labels.subType);\n      if (labels.childType) props.push(labels.childType);\n    }\n\n    if (!this.showUnidentifiedData) {\n      if (labels.activation) props.push(labels.activation);\n      // Range\n      if (actionData.range != null) {\n        const range = action.getRange({ type: \"max\", rollData }),\n          units = actionData.range.units === \"mi\" ? \"mi\" : \"ft\";\n        const distanceValues = ffd20.utils.convertDistance(range, units);\n        // TODO: Display range increment and max range instead of just the latter when max increment is higher than 1\n        const rangeLabel =\n          range > 0 ? game.i18n.format(\"FFD20.MaxRangeNote\", { distance: range, units: distanceValues[1] }) : null;\n        if (rangeLabel) props.push(rangeLabel);\n      }\n\n      // Add Difficulty Class (DC) label\n      if (labels.save) {\n        props.push(labels.save);\n        const saveDesc = actionData.save?.description;\n        if (saveDesc) props.push(saveDesc);\n      }\n\n      // Duration\n      if (actionData.duration != null) {\n        let duration;\n        if (actionData.duration.units === \"spec\") {\n          duration = actionData.duration.value;\n        } else if (![\"inst\", \"perm\"].includes(actionData.duration.units)) {\n          const roll = await RollPF.safeRoll(actionData.duration.value || \"0\", rollData, undefined, undefined, {\n            allowInteractive: interactive,\n          });\n          const value = roll.total;\n          duration = [value, ffd20.config.timePeriods[actionData.duration.units]].filterJoin(\" \");\n        }\n        if (duration) props.push(duration);\n      }\n\n      // Enhancement Bonus\n      const enhBonus = actionData.enh?.value ?? rollData.item.enh ?? 0;\n      if (enhBonus > 0) {\n        props.push(game.i18n.format(\"FFD20.EnhancementInline\", { bonus: enhBonus }));\n      }\n    }\n\n    // Get per item type chat data\n    this.getTypeChatData(data, labels, props, rollData, { actionId, chatcard });\n\n    const harmless = actionData.save?.harmless;\n    if (harmless) props.push(game.i18n.localize(\"FFD20.Harmless\"));\n\n    if (this.isBroken) props.push(game.i18n.localize(\"FFD20.Broken\"));\n\n    data.properties = props;\n\n    return data;\n  }\n\n  /**\n   * Per item type chat data.\n   *\n   * @param {ChatData} data - A partial of a chat data object that can be modified to add per item type data.\n   * @param {Record<string, *>} labels - The labels for this item.\n   * @param {string[]} props - Additional property strings\n   * @param {object} rollData - A rollData object to be used for checks\n   * @param {object} [options] - Additional options\n   * @param {string} [options.actionId=null] - Action this pertains to, if any.\n   * @param {boolean} [options.chatcard=false] - Is this for a chat card?\n   */\n  // eslint-disable-next-line no-unused-vars\n  getTypeChatData(data, labels, props, rollData, { actionId = null, chatcard = false } = {}) {\n    // Charges as used by most item types, except spells\n    if (this.isCharged) {\n      const charges = this.charges;\n      if (Number.isFinite(charges)) {\n        const max = this.maxCharges;\n        // Finite max charges\n        if (Number.isFinite(max)) {\n          props.push(`${game.i18n.localize(\"FFD20.ChargePlural\")}: ${charges}/${max}`);\n        }\n        // Infinite max charges\n        else {\n          props.push(`${game.i18n.localize(\"FFD20.ChargePlural\")}: ${charges}`);\n        }\n      }\n    }\n  }\n\n  /* -------------------------------------------- */\n  /*  Item Rolls - Attack, Damage, Saves, Checks  */\n  /* -------------------------------------------- */\n\n  /**\n   * Use an attack, using {@link SharedActionData}\n   *\n   * @see {@link SharedActionData}\n   * @param {object} options - Options\n   * @param {string} [options.actionId=\"\"] - The ID of the action to use, defaults to the first action\n   * @param {number} [options.cost=null] - Cost override. Replaces charge cost or slot cost as appropriate.\n   * @param {Event | null} [options.ev=null] - The event that triggered the use, if any\n   * @param {boolean} [options.skipDialog=getSkipActionPrompt()] - Whether to skip the dialog for this action\n   * @param {boolean} [options.chatMessage=true] - Whether to send a chat message for this action\n   * @param {string} [options.dice=ffd20.dice.D20RollPF.standardRoll] - The base dice to roll for this action\n   * @param {string} [options.rollMode] - The roll mode to use for the chat message\n   * @param {TokenDocument} [options.token] Token this action is for, if any.\n   * @param {UseOptions} [options.options={}] Additional use options.\n   * @throws {Error} - On some invalid inputs.\n   * @returns {Promise<ActionUse | SharedActionData | void>} - Action use, shared data, or nothing.\n   */\n  async use({\n    actionId = \"\",\n    cost = null,\n    ev = null,\n    skipDialog = getSkipActionPrompt(),\n    chatMessage = true,\n    dice = ffd20.dice.D20RollPF.standardRoll,\n    rollMode,\n    token,\n    options = {},\n  } = {}) {\n    rollMode ||= game.settings.get(\"core\", \"rollMode\");\n    token ||= this.actor?.token ?? this.actor?.getActiveTokens(true, true)[0];\n\n    if (ev?.originalEvent) ev = ev.originalEvent;\n\n    if (cost !== null && !Number.isSafeInteger(cost)) throw new Error(`Invalid value for cost override: ${cost}`);\n\n    if (options.held) {\n      // Convert human friendly options to internal types\n      if (options.held === \"twohanded\") options.held = \"2h\";\n      else if (options.held === \"offhand\") options.held = \"oh\";\n    }\n\n    // Prepare variables\n    /** @type {SharedActionData} */\n    const shared = {\n      event: ev,\n      action: null,\n      item: null,\n      token: null,\n      rollData: {},\n      skipDialog,\n      chatMessage,\n      dice,\n      cost,\n      fullAttack: true,\n      useOptions: options,\n      attackBonus: [],\n      damageBonus: [],\n      attacks: [],\n      chatAttacks: [],\n      rollMode,\n      useMeasureTemplate: false,\n      conditionals: null,\n      conditionalPartsCommon: {},\n      casterLevelCheck: false, // TODO: Move to use-options\n      concentrationCheck: false, // TODO: Move to use-options\n      scriptData: {},\n    };\n\n    // Prevent reassigning the ActionUse's item and token\n    Object.defineProperties(shared, {\n      item: { value: this, writable: false, enumerable: true },\n      token: { value: token, writable: false, enumerable: true },\n    });\n\n    // Old use method\n    if (!this.hasAction) {\n      // Use\n      if (!(\"attackData\" in shared)) {\n        Object.defineProperty(shared, \"attackData\", {\n          get: () => {\n            foundry.utils.logCompatibilityWarning(\n              \"shared.attackData is deprecated in favor of directly accessing shared\",\n              {\n                since: \"PF1 v10\",\n                until: \"PF1 v12\",\n              }\n            );\n            return shared;\n          },\n        });\n      }\n\n      await this.executeScriptCalls(\"use\", {}, shared);\n      rollMode = shared.rollMode || rollMode;\n      if (shared.reject) return shared;\n\n      // Deduct charges\n      if (this.isCharged) {\n        const chargeCost = cost ?? this.getDefaultChargeCost();\n        if (this.charges < chargeCost) {\n          if (this.isSingleUse) {\n            return void ui.notifications.warn(game.i18n.localize(\"FFD20.Error.NoQuantity\"));\n          }\n          return void ui.notifications.warn(game.i18n.format(\"FFD20.Error.InsufficientCharges\", { name: this.name }));\n        }\n\n        await this.addCharges(-chargeCost);\n      }\n\n      if (shared.hideChat !== true && chatMessage) {\n        shared.descriptionOnly = true;\n        Object.defineProperty(shared, \"chatCard\", {\n          get() {\n            foundry.utils.logCompatibilityWarning(\"shared.chatCard is deprecated in favor of shared.message\", {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            });\n\n            return this.message;\n          },\n        });\n        shared.message = await this.displayCard({ rollMode });\n      }\n\n      await this.executeScriptCalls(\"postUse\", {}, shared);\n\n      return shared;\n    }\n\n    /** @type {ItemAction | undefined} */\n    let action;\n    if (actionId) {\n      action = this.actions.get(actionId);\n      if (!action) throw new Error(`Could not find action by ID \"${actionId}\"`);\n    } else if (this.system.actions.length > 1 && skipDialog !== true) {\n      const actionId = await ffd20.applications.ActionSelector.open({ document: this });\n      action = this.actions.get(actionId);\n    } else {\n      action = this.defaultAction;\n    }\n\n    if (!action) {\n      console.debug(`FFD20 | Cancelled use of \"${this.name}\"`);\n      return null; // No action chosen\n    }\n\n    // Prevent reassigning the ActionUse's action\n    Object.defineProperties(shared, {\n      action: { value: action, writable: false, enumerable: true },\n    });\n\n    if (shared.useOptions.ammo) {\n      if (action.usesAmmo) {\n        await this.update({ \"system.ammo.default\": shared.useOptions.ammo });\n      } else {\n        console.error(\"Attempted to set ammo for action that does not use ammo\");\n      }\n    }\n\n    // TODO: Remove this variable usage\n    shared.useMeasureTemplate = action.hasTemplate && game.settings.get(\"ffd20\", \"placeMeasureTemplateOnQuickRolls\");\n\n    return new ActionUse(shared).process({ skipDialog });\n  }\n\n  /**\n   * Item specific conditional targets.\n   *\n   * @abstract\n   * @param {object} results - Conditional targets\n   * @param _result\n   * @param {Record<string, string>} results - Result key to label mapping.\n   */\n\n  getConditionalTargets(results, _result) {\n    if (_result) {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemPF.getConditionalTargets() with two parameters is now ItemPF.getConditionalSubTargets()\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      return this.getConditionalSubTargets(results, _result);\n    }\n  }\n\n  /**\n   * Item specific conditional sub targets.\n   *\n   * @abstract\n   * @param {string} target - Conditional target\n   * @param {Record<string, string>} result - Result key to label mapping.\n   */\n  getConditionalSubTargets(target, result) {}\n\n  /**\n   * Finds, filters and alters changes relevant to a context, and returns the result (as an array)\n   *\n   * @remarks - Always returns empty array if no actor is present.\n   * @param {\"mattack\"|\"rattack\"|\"nattack\"|\"tattack\"|\"wdamage\"|\"sdamage\"|\"rwdamage\"|\"twdamage\"|\"mwdamage\"|\"ndamage\"|\"rdamage\"|\"tdamage\"|\"mdamage\"} context - The given context.\n   * @returns {ItemChange[]} - The matching changes.\n   */\n  getContextChanges(context = [\"attack\"]) {\n    if (!this.actor) return [];\n    const targets = this.getContextStack(context);\n    return this.actor.changes.filter((c) => targets.has(c.target));\n  }\n\n  /**\n   * Retrieve stack of contexts related to the one given.\n   *\n   * @private\n   * @param {Array<string>} contexts Context subtarget ID array.\n   * @returns {Set<string>} - Modified context array.\n   */\n  getContextStack(contexts) {\n    const result = new Set(contexts);\n    for (const context of contexts) {\n      switch (context) {\n        case \"sattack\":\n        case \"wattack\":\n        case \"mattack\":\n        case \"rattack\":\n        case \"nattack\":\n        case \"tattack\":\n          result.add(\"attack\");\n          break;\n        case \"wdamage\":\n        case \"sdamage\":\n          result.add(\"damage\");\n          break;\n        case \"mwdamage\":\n        case \"rwdamage\":\n        case \"twdamage\":\n          result.add(\"damage\");\n          result.add(\"wdamage\");\n          break;\n      }\n    }\n\n    // Add generic ranged damage for ranged weapon damage and thrown weapon damage\n    if (result.has(\"rwdamage\") || result.has(\"twdamage\")) {\n      result.add(\"rdamage\");\n    }\n\n    return result;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * @param {object} [options] - Additional options\n   * @returns {object} An object with data to be used in rolls in relation to this item.\n   */\n  getRollData(options) {\n    const actor = this.actor;\n    const result = { ...(actor?.getRollData(options) ?? {}) };\n\n    if (!actor) ffd20.utils.rollData.addStatic(result);\n\n    result.item = foundry.utils.deepClone(this.system);\n\n    // Add @class\n    const classTag = result.item.class;\n    if (classTag) result.class = result.classes?.[classTag];\n\n    // Add dictionary flag\n    const tag = this.system.tag;\n    result.item.dFlags = result.dFlags?.[tag];\n\n    result.item.bFlags = Object.fromEntries(\n      Object.entries(result.item.flags?.boolean ?? {}).map(([key, value]) => [key, value ? 1 : 0])\n    );\n\n    // Set aura strength\n    if (this.isPhysical) {\n      result.item.auraStrength = this.auraStrength;\n\n      // Resize item\n      if (this.system.resizing && result.size !== undefined) {\n        result.item.size = result.size;\n      }\n    }\n\n    // Add caster level\n    // TODO: Replace with associated class level if higher?\n    result.cl = result.item?.cl;\n\n    this._addTypeRollData(result);\n\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  /**\n   * Add item type specific roll data.\n   *\n   * @abstract\n   * @internal\n   * @param {object} result - Roll data\n   */\n  // eslint-disable-next-line no-unused-vars\n  _addTypeRollData(result) {}\n\n  /* -------------------------------------------- */\n\n  /**\n   * Test if specified link can be created.\n   *\n   * @internal\n   * @param {string} type - The type of link.\n   * @param {Item} item - The target item to link to.\n   * @returns {Promise<boolean>} Whether a link to the item is possible here.\n   */\n  async _canCreateItemLink(type, item) {\n    if (!(item instanceof Item)) throw new Error(\"Item must be instance of Item document\");\n\n    if (![\"charges\", \"children\", \"supplements\", \"classAssociations\"].includes(type))\n      throw new Error(`Invalid link type: \"${type}\"`);\n\n    // Don't create link to self\n    if (item === this) return false;\n\n    const sameActor = this.actor && item.actor === this.actor;\n\n    // Link happens between items on same actor?\n    const linkOnActor = [\"children\", \"charges\"].includes(type);\n    if (linkOnActor && !sameActor) {\n      ui.notifications.warn(\"FFD20.Warning.LinkOwnerMismatch\", { localize: true });\n      return false;\n    }\n\n    // Don't re-create existing links\n    const links = this.system.links?.[type] || [];\n    for (const link of links) {\n      // Use slow matching method to ensure old style links aren't ignored\n      const ti = await fromUuid(link.uuid, { relative: this.actor });\n      if (ti === item) {\n        ui.notifications.warn(\"FFD20.Warning.NoMultiLink\", { localize: true });\n        return false;\n      }\n    }\n\n    switch (type) {\n      // Charge link requirements\n      case \"charges\": {\n        // Prevent item from inheriting charges from multiple sources\n        if (item.links?.charges) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.Warning.CannotCreateChargeLink2\", {\n              source: this.name,\n              target: item.name,\n              deeptarget: item.links.charges.name,\n            })\n          );\n          return false;\n        }\n        // Target is already sharing charges itself\n        const targetLinks = item.system.links?.charges ?? [];\n        if (targetLinks.length > 0) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.Warning.CannotCreateChargeLink\", { source: this.name, target: item.name })\n          );\n          return false;\n        }\n        if (this.links?.charges) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.Warning.CannotCreateChargeLink2\", {\n              source: item.name,\n              target: this.name,\n              deeptarget: this.links.charges.name,\n            })\n          );\n          return false;\n        }\n        return true;\n      }\n      // Class association link requirements\n      case \"classAssociations\":\n        // Item must not be on actor and must be in compendium\n        if (item.actor) {\n          ui.notifications.error(\"FFD20.Warning.LinkOnlyUnowned\", { localize: true });\n          return false;\n        }\n        if (!item.pack) {\n          ui.notifications.error(\"FFD20.Warning.LinkOnlyCompendium\", { localize: true });\n          return false;\n        }\n        return true;\n      case \"supplements\": {\n        // Must NOT be on actor\n        if (!item.actor) return true;\n        else ui.notifications.error(\"FFD20.Warning.LinkOnlyUnowned\", { localize: true });\n        break;\n      }\n      case \"children\":\n        return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * @internal\n   * @param {string} type - The type of link.\n   * @param {object} item - The target item to link to.\n   * @param {string} uuid - The link identifier for the item.\n   * @returns {Array} An array to insert into this item's link data.\n   */\n  _generateLinkData(type, item, uuid) {\n    const result = {\n      name: item.name,\n      uuid,\n    };\n\n    // Remove name for various links\n    switch (type) {\n      case \"classAssociations\":\n        result.level = 1;\n      // eslint-disable-next-line no-fallthrough\n      case \"supplements\":\n        // System packs are assumed static\n        if (game.packs.get(item.pack)?.metadata.packageType === \"system\") {\n          delete result.name;\n        }\n        break;\n      case \"charges\":\n      case \"children\":\n        // Actor local links\n        delete result.name;\n        break;\n    }\n\n    return result;\n  }\n\n  /**\n   * Creates a link to another item.\n   *\n   * @param {\"children\"|\"charges\"|\"supplement\"|\"classAssociations\"} type - The type of link.\n   * @param {Item} item - The target item to link into this.\n   * @param {object} [extraData] - Additional data to store int he link\n   * @returns {Promise<boolean>} - Whether a link was created.\n   */\n  async createItemLink(type, item, extraData) {\n    if (!(await this._canCreateItemLink(type, item))) {\n      console.warn(`Can not create \"${type}\" link for ${item.name} [${item.uuid}] in ${this.name}`);\n      return false;\n    }\n\n    const links = this.toObject().system.links?.[type] ?? [];\n\n    const uuid = this.actor ? item.getRelativeUUID(this.actor) : item.uuid;\n\n    const linkData = this._generateLinkData(type, item, uuid);\n    if (extraData) foundry.utils.mergeObject(linkData, extraData);\n    links.push(linkData);\n\n    const itemUpdate = { _id: this.id, [`system.links.${type}`]: links };\n\n    // Clear value, maxFormula and per from link target to avoid odd behaviour\n    const itemUpdates = [];\n    if (type === \"charges\") {\n      itemUpdates.push({\n        _id: item.id,\n        system: { uses: { \"-=value\": null, \"-=maxFormula\": null, \"-=per\": null, \"-=rechargeFormula\": null } },\n      });\n    }\n\n    if (this.actor && itemUpdates.length > 0) {\n      await this.actor.updateEmbeddedDocuments(\"Item\", [itemUpdate, ...itemUpdates]);\n    } else {\n      await this.update(itemUpdate);\n    }\n\n    // Call link creation hook\n    Hooks.callAll(\"pf1CreateItemLink\", this, linkData, type);\n\n    return true;\n  }\n\n  /**\n   * Get item links of type\n   *\n   * @param {string} type - Link type\n   * @param {boolean} includeLinkData - Include link data, return value changes from item array to object array\n   * @param {object} [options={}] - Additional options\n   * @param {Set} [options._results] - Internal use only.\n   * @param {boolean} [options.recursive=false] - Retrieved linked items recursively.\n   * @returns {Promise<Item[]|object[]>} - Linked items, or objects with linked items and additional data\n   */\n  async getLinkedItems(type, includeLinkData = false, { recursive = false, _results } = {}) {\n    const items = this.system.links?.[type];\n    if (!items) return [];\n\n    const results = _results ?? new Set();\n    for (const l of items) {\n      if (!l.uuid) continue;\n      const item = await fromUuid(l.uuid, { relative: this.actor });\n      if (item) {\n        if (includeLinkData) {\n          if (results.some((i) => i.item === item)) continue;\n        } else if (results.has(item)) continue;\n\n        if (includeLinkData) results.add({ item, linkData: l });\n        else results.add(item);\n\n        // Recursive\n        if (type !== \"charges\" && recursive) {\n          await item.getLinkedItems(type, { recursive, includeLinkData, _results: results });\n        }\n      }\n    }\n\n    return Array.from(results);\n  }\n\n  /**\n   * Retrieve list of linked items for a type, synchronously.\n   * Intended mainly for fetching child or charge links quickly.\n   *\n   * @example\n   * ```js\n   * const childItems = item.getLinkedItemsSync(\"children\");\n   * ```\n   *\n   * @param {string} type Link type, e.g. \"children\", \"charges\", or \"classAssociations\"\n   * @param {object} [options={}] - Additional options\n   * @param {boolean} [options.recursive=false] - Retrieve links recursively.\n   * @param {Set<string>} [options._results] - Internal use only\n   * @returns {Item[]|object[]} Linked items or their compendium index data\n   */\n  getLinkedItemsSync(type, { recursive = false, _results } = {}) {\n    const links = this.system.links?.[type];\n    if (!links) return [];\n\n    const results = _results ?? new Set();\n    for (const linkData of links) {\n      if (!linkData.uuid) continue;\n\n      const parsed = foundry.utils.parseUuid(linkData.uuid, { relative: this.actor });\n      const item = this.actor?.items.get(parsed?.id);\n      if (!item || results.has(item)) continue;\n      results.add(item);\n\n      // Recursive\n      if (type !== \"charges\" && recursive) {\n        item.getLinkedItemsSync(type, { recursive, _results: results });\n      }\n    }\n\n    return Array.from(results);\n  }\n\n  /**\n   * Get all items linked by any means.\n   *\n   * @returns {Promise<Item[]>} - Linked items\n   */\n  async getAllLinkedItems() {\n    const result = [];\n\n    for (const items of Object.values(this.system.links ?? {})) {\n      for (const l of items) {\n        if (!l.uuid) continue;\n        const item = await fromUuid(l.uuid, { relative: this.actor });\n        if (item) result.push(item);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Removes all link references to an item.\n   *\n   * @param {string} uuid - The UUID of the item to remove links to.\n   * @param {object} [options={}] - Additional options\n   * @param {boolean} [options.commit=true] - Commit changes to database. If false, resulting update data is returned instead.\n   * @returns {Promise<Item|object|undefined>} - Updated document, update data, or undefined\n   */\n  async removeItemLink(uuid, { commit = true } = {}) {\n    const updateData = {};\n    for (const [type, linkItems] of Object.entries(this.system.links ?? {})) {\n      const items = foundry.utils.deepClone(linkItems);\n      const idx = items.findIndex((item) => item.uuid === uuid);\n      if (idx >= 0) {\n        items.splice(idx, 1);\n        updateData[`system.links.${type}`] = items;\n      }\n    }\n\n    if (!foundry.utils.isEmpty(updateData)) {\n      if (commit) return this.update(updateData);\n      return updateData;\n    }\n  }\n\n  /**\n   * Generates lists of change targets this item can have.\n   *\n   * @param {string} target - The target key, as defined in FFD20.buffTargets.\n   * @returns {Record<string, string>} A list of changes\n   */\n  getChangeTargets(target) {\n    const result = {};\n    // Add specific skills\n    if (target === \"skill\") {\n      if (!this.actor) {\n        for (const [s, skl] of Object.entries(ffd20.config.skills)) {\n          result[`skill.${s}`] = skl;\n        }\n      } else {\n        const actorSkills = foundry.utils.mergeObject(ffd20.config.skills, this.actor.system.skills, { inplace: false });\n        for (const [s, skl] of Object.entries(actorSkills)) {\n          if (!skl.subSkills) {\n            if (skl.custom) result[`skill.${s}`] = skl.name;\n            else result[`skill.${s}`] = ffd20.config.skills[s];\n          } else {\n            for (const [s2, skl2] of Object.entries(skl.subSkills)) {\n              result[`skill.${s}.${s2}`] = `${ffd20.config.skills[s]} (${skl2.name})`;\n            }\n          }\n        }\n      }\n    }\n    // Add static subtargets\n    else if (foundry.utils.hasProperty(ffd20.config.buffTargets, target)) {\n      for (const [k, v] of Object.entries(ffd20.config.buffTargets[target])) {\n        if (!k.startsWith(\"_\") && !k.startsWith(\"~\")) result[k] = v;\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Sets a boolean flag on this item.\n   *\n   * @param {string} flagName - The name/key of the flag to set.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async addItemBooleanFlag(flagName, context = {}) {\n    flagName = String(flagName)\n      .replace(/[^\\w_-]/g, \"-\")\n      .replace(/^-+/, \"_\");\n    const flags = this.system.flags?.boolean ?? {};\n\n    if (Array.isArray(flags)) throw new Error(`${this.name} [${this.id}] requires migration.`);\n\n    if (flags[flagName] === undefined) {\n      await this.update({ [`system.flags.boolean.${flagName}`]: true }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Removes a boolean flag from this item.\n   *\n   * @param {string} flagName - The name/key of the flag to remove.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async removeItemBooleanFlag(flagName, context = {}) {\n    const flags = this.system.flags?.boolean ?? {};\n\n    if (flags[flagName] !== undefined) {\n      await this.update({ [`system.flags.boolean.-=${flagName}`]: null }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * @param {string} flagName - The name/key of the flag on this item.\n   * @returns {boolean} Whether the flag was found on this item.\n   */\n  hasItemBooleanFlag(flagName) {\n    const flags = this.system.flags?.boolean ?? {};\n    return flags[flagName] === true;\n  }\n\n  /**\n   * Get all item boolean flags as array.\n   *\n   * @returns {string[]} - Flag keys\n   */\n  getItemBooleanFlags() {\n    const flags = this.system.flags?.boolean ?? {};\n    return Object.keys(flags);\n  }\n\n  /**\n   * Sets a dictionary flag value on this item.\n   *\n   * @param {string} flagName - The name/key of the flag to set.\n   * @param {number|string} value - The flag's new value.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async setItemDictionaryFlag(flagName, value, context = {}) {\n    flagName = String(flagName)\n      .replace(/[^\\w_-]/g, \"-\")\n      .replace(/^-+/, \"_\");\n    const flags = this.system.flags?.dictionary ?? {};\n\n    if (flags[flagName] !== value) {\n      await this.update({ [`system.flags.dictionary.${flagName}`]: value }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Removes a dictionary flag from this item.\n   *\n   * @param {string} flagName - The name/key of the flag to remove.\n   * @param {object} context Update context\n   * @returns {Promise<boolean>} Whether something was changed.\n   */\n  async removeItemDictionaryFlag(flagName, context = {}) {\n    const flags = this.system.flags?.dictionary ?? {};\n\n    if (flags[flagName] !== undefined) {\n      await this.update({ [`system.flags.dictionary.-=${flagName}`]: null }, context);\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * @param {string} flagName - The name/key of the flag to get.\n   * @returns {string|number|undefined} The value stored in the flag.\n   */\n  getItemDictionaryFlag(flagName) {\n    const flags = this.system.flags?.dictionary || {};\n    return flags[flagName];\n  }\n\n  /**\n   * Get all item dictionary flags as array of objects.\n   *\n   * @returns {Record<string, *>} - All dictionary flags\n   */\n  getItemDictionaryFlags() {\n    const flags = this.system.flags?.dictionary || {};\n    return flags;\n  }\n\n  /**\n   * Attack sources for a specific action.\n   *\n   * @param {string} actionId Action ID\n   * @param {object} [options={}] - Additional options\n   * @param {object} [options.rollData] - Roll data instance\n   * @returns {object[]|undefined} Array of value and label pairs for attack bonus sources on the main attack, or undefined if the action is missing.\n   */\n  getAttackSources(actionId, { rollData } = {}) {\n    actionId ??= this.defaultAction?.id;\n\n    /** @type {ffd20.components.ItemAction} */\n    const action = this.actions.get(actionId);\n    if (!action) return;\n\n    const sources = [];\n\n    const actorData = this.actor?.system,\n      itemData = this.system;\n\n    if (!actorData) return sources;\n    rollData ??= action.getRollData();\n\n    const describePart = (value, name, modifier, sort = 0) => {\n      if (value == 0) return;\n      sources.push({ value, name, modifier, sort });\n    };\n\n    const isManeuver = action.isCombatManeuver;\n\n    // Unreliable melee/ranged identification\n    const sizeBonus = Object.values(!isManeuver ? ffd20.config.sizeMods : ffd20.config.sizeSpecialMods)[rollData.size] || 0;\n\n    // Add size bonus\n    if (sizeBonus != 0) describePart(sizeBonus, game.i18n.localize(\"FFD20.Size\"), \"size\", -20);\n\n    const changeSources = action.attackSources;\n\n    const effectiveChanges = getHighestChanges(changeSources, { ignoreTarget: true });\n    for (const ic of effectiveChanges) {\n      let value = ic.value;\n      // BAB override\n      if (action.bab && ic._id === \"_bab\") {\n        value = RollPF.safeRollSync(ic.formula, rollData).total || 0;\n      }\n      describePart(value, ic.flavor, ic.type, -800);\n    }\n\n    if (action.ability.attack) {\n      const ablMod = actorData.abilities?.[action.ability.attack]?.mod ?? 0;\n      describePart(ablMod, ffd20.config.abilities[action.ability.attack], \"untyped\", -50);\n    }\n\n    // Attack bonus formula\n    // TODO: Don't pre-eval\n    const bonusRoll = RollPF.safeRollSync(action.attackBonus || \"0\", rollData, undefined, undefined, {\n      minimize: true,\n    });\n    if (bonusRoll.total != 0)\n      describePart(bonusRoll.total, bonusRoll.flavor ?? game.i18n.localize(\"FFD20.AttackRollBonus\"), \"untyped\", -100);\n\n    // Masterwork or enhancement bonus\n    // Only add them if there's no larger enhancement bonus from some other source\n    const virtualEnh = action.enhancementBonus ?? (itemData.masterwork ? 1 : 0);\n    if (!effectiveChanges.find((i) => i.type === \"enh\" && i.value > virtualEnh)) {\n      if (Number.isFinite(action.enhancementBonus) && action.enhancementBonus !== 0) {\n        describePart(action.enhancementBonus, game.i18n.localize(\"FFD20.EnhancementBonus\"), \"enh\", -300);\n      } else if (itemData.masterwork) {\n        describePart(1, game.i18n.localize(\"FFD20.Masterwork\"), \"enh\", -300);\n      }\n    }\n\n    // Add proficiency penalty\n    try {\n      if (!this.getProficiency(true)) {\n        describePart(-4, game.i18n.localize(\"FFD20.Proficiency.Penalty\"), \"untyped\", -500);\n      }\n    } catch {\n      // Ignore proficiency incompatibility.\n    }\n\n    // Broken condition\n    if (this.isBroken) {\n      describePart(-2, game.i18n.localize(\"FFD20.Broken\"), \"untyped\", -500);\n    }\n\n    // Add secondary natural attack penalty\n    if (action.naturalAttack.primary !== true && itemData.subType === \"natural\") {\n      const attackBonus = action.naturalAttack?.secondary?.attackBonus || ffd20.config.naturalAttacks.secondary.penalty;\n      const secondaryModifier = RollPF.safeRollSync(`${attackBonus}`, rollData).total ?? 0;\n      describePart(secondaryModifier, game.i18n.localize(\"FFD20.SecondaryAttack\"), \"untyped\", -400);\n    }\n\n    // Conditional modifiers\n    const conditionals = action.conditionals.filter(\n      (c) => c.default && c.modifiers.find((sc) => sc.target === \"attack\")\n    );\n    for (const c of conditionals) {\n      for (const cc of c.modifiers) {\n        if (cc.subTarget === \"allAttack\") {\n          const bonusRoll = new RollPF(cc.formula, rollData);\n          bonusRoll.evaluateSync({ minimize: true });\n          const isRng = !bonusRoll.isDeterministic;\n          if (bonusRoll.total == 0 && !isRng) continue;\n          const value = isRng ? bonusRoll.formula : bonusRoll.total;\n          describePart(value, c.name, cc.type, -5000);\n        }\n      }\n    }\n\n    return sources.sort((a, b) => b.sort - a.sort);\n  }\n\n  /**\n   * Return attack sources for default action.\n   *\n   * @returns {object[]|undefined} Array of value and label pairs for attack bonus sources on the main attack.\n   */\n  get attackSources() {\n    return this.getAttackSources(this.defaultAction.id);\n  }\n\n  getAllDamageSources(actionId) {\n    return this.actions.get(actionId)?.allDamageSources;\n  }\n\n  /**\n   * Generic damage source retrieval for default action, includes default conditionals and other item specific modifiers.\n   *\n   * @returns {ItemChange[]|undefined} All relevant changes, or undefined if action was not found.\n   */\n  get allDamageSources() {\n    return this.getAllDamageSources(this.defaultAction.id);\n  }\n\n  /**\n   * Is this item inside a container?\n   *\n   * @type {boolean}\n   */\n  get inContainer() {\n    return !!this.parentItem;\n  }\n\n  /**\n   * Root item.\n   *\n   * Specifically the item at bottom of the container tree.\n   *\n   * @internal\n   * @type {Item}\n   */\n  get rootItem() {\n    return this.parentItem?.rootItem ?? this;\n  }\n}\n\n/**\n * @typedef {object} ChatData\n * Data required to render an item's summary or chat card, including descriptions and properties/tags/labels\n * @property {string} description - The item's enriched description as appropriate for the current user\n * @property {string} identifiedDescription - The item's full enriched description when identified\n * @property {string} unidentifiedDescription - The item's enriched description when unidentified\n * @property {string} [actionDescription] - The enriched description of a specific action\n * @property {string[]} properties - Additional properties/labels for the item and the action\n */\n\n/**\n * @typedef {object} SharedActionData\n * A common data object used to store and share data between stages of an action's usage.\n * @property {Event | null} event - The event that triggered the action. Defaults to `null`.\n * @property {object} rollData - The singular rollData object used for all rolls in the action\n * @property {boolean} skipDialog - Whether the user-facing dialog should get skipped. Defaults to `false`.\n * @property {boolean} chatMessage - Whether a chat message should be created at the end of the action's usage. Defaults to `true`.\n * @property {ChatMessage} message - Chat message once it is created.\n * @property {string} dice - The base dice used for the action's attack rolls. Defaults to return value of `ffd20.dice.D20RollPF.standardRoll`.\n * @property {boolean} fullAttack - Whether the action is a full attack. Defaults to `true`.\n * @property {string[]} attackBonus - Bonus values to be added to the attack roll formula\n * @property {string[]} damageBonus - Bonus values to be added to the damage roll formula\n * @property {ActionUseAttack[]} attacks - Array of attacks\n * @property {ffd20.actionUse.ChatAttack[]} chatAttacks - Array of chat attacks for this action's use\n * @property {string} rollMode - The roll mode to be used for the creation of the chat message. Defaults to the `core.rollMode` setting.\n * @property {boolean} useMeasureTemplate - Whether to use a measure template\n * @property {object[] | null} conditionals - Conditionals\n * @property {object} conditionalPartsCommon - Common conditionals\n * @property {boolean} casterLevelCheck - Will caster level check be needed?\n * @property {boolean} concentrationCheck - Will concentration check be needed?\n * @property {object} scriptData - Return data from script calls\n * @property {ItemAction} action - The {@link ItemAction} this use is based on\n * @property {ItemPF} item - The {@link ItemPF} this use is based on\n * @property {object} chatData - Data to be passed to {@link ChatMessage.create}, excluding `content` rendered using {@link templateData} and {@link template}.\n * @property {string} [chatTemplate] - The template to be used for the creation of the chat message.\n * @property {MeasuredTemplateDocument} template - Template document.\n * @property {object} templateData - Data used to render the chat card, passed to {@link foundry.utils.renderTemplate}.\n * @property {Token[]} targets - Targeted tokens\n */\n\n/**\n * Additional options for (action) use.\n *\n * @typedef {object} UseOptions\n * @property {boolean} [primaryAttack] - Set primary attack state\n * @property {boolean} [clCheck] - Set caster level check state\n * @property {boolean} [measureTemplate] - Set measure template state\n * @property {boolean} [powerAttack] - Set power attack state\n * @property {\"normal\"|\"2h\"|\"twohanded\"|\"oh\"|\"offhand\"} [held] - Set held option (for power attack mode).\n * @property {number} [abilityMult] - Ability score damage multiplier\n * @property {string} [ammo] - Ammo item ID to use.\n * @property {boolean} [haste] - Enable Haste\n * @property {boolean} [manyshot] - Enable Manyshot\n * @property {boolean} [rapidShot] - Enable Rapid Shot\n */\n","import { ItemPF } from \"./item-pf.mjs\";\n\n/**\n * Attack item\n *\n * Non-specific combat related actions. Mainly used to populate the combat tab.\n */\nexport class ItemAttackPF extends ItemPF {\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Remove held option if type changed to natural attack\n    if (changed.system.subType === \"natural\") {\n      changed.system.held = null;\n    }\n  }\n\n  /** @override */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    // Init weapon-like type if missing\n    if (this.subType === \"weapon\") {\n      this.system.weapon ??= {};\n      this.system.weapon.category ||= \"simple\";\n      this.system.weapon.type ||= \"light\";\n    }\n  }\n\n  /**\n   * Pretend-physical item.\n   *\n   * Used in action handling only.\n   *\n   * @type {boolean}\n   */\n  get isQuasiPhysical() {\n    return [\"weapon\", \"item\"].includes(this.subType);\n  }\n\n  /**\n   * Is pretend broken?\n   *\n   * @see {@link ffd20.documents.item.ItemPhysicalPF.isBroken}\n   * @type {boolean}\n   */\n  get isBroken() {\n    if (!this.isQuasiPhysical) return false;\n    return this.system.broken === true;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getProficiency(weapon = true) {\n    if (!weapon) throw new Error(\"Attacks do not support non-weapon proficiency\");\n\n    return this.isProficient;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  get isProficient() {\n    if (this.system.proficient) return true;\n\n    // Non-weapon attacks always proficient\n    if (this.subType !== \"weapon\") return true;\n\n    return this.actor?.hasWeaponProficiency?.(this) ?? true;\n  }\n\n  /**\n   * Creates attack from provided item.\n   *\n   * @remarks - Only supports weapon item type.\n   * @param {Item} item - Source item\n   * @throws {Error} - On unsupported type\n   * @returns {object} - Attack item data\n   */\n  static fromItem(item) {\n    if (item.type !== \"weapon\") throw new Error(`Unsupported item type \"${item.type}\"`);\n\n    const srcData = item.toObject().system;\n\n    // Convert single-use to 1 max charge\n    const uses = srcData.uses ?? {};\n    if (uses.per === \"single\") {\n      uses.per = \"charges\";\n      uses.maxFormula = \"1\";\n    }\n\n    // Get attack template\n    const attackItem = {\n      name: item.name,\n      type: \"attack\",\n      img: item.img,\n      system: {\n        subType: \"weapon\",\n        weapon: {\n          category: srcData.subType,\n          type: srcData.weaponSubtype,\n        },\n        held: srcData.held,\n        masterwork: srcData.masterwork,\n        proficient: srcData.proficient,\n        enh: srcData.enh,\n        broken: item.isBroken,\n        timeworn: srcData.timeworn,\n        cursed: srcData.cursed,\n        artifact: srcData.artifact,\n        baseTypes: srcData.baseTypes,\n        tags: srcData.tags,\n        ammo: srcData.ammo,\n        weaponGroups: srcData.weaponGroups,\n        actions: srcData.actions ?? [],\n        material: srcData.material,\n        alignments: srcData.alignments,\n        attackNotes: srcData.attackNotes ?? [],\n        effectNotes: srcData.effectNotes ?? [],\n      },\n    };\n\n    // Ensure action IDs are correct and unique\n    for (const action of attackItem.system.actions) {\n      action._id = foundry.utils.randomID(16);\n    }\n\n    return attackItem;\n  }\n\n  /**\n   * @override\n   * @inheritDoc\n   */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    const itemData = this.system;\n    labels.subType = ffd20.config.attackTypes[this.subType];\n\n    if (this.subType === \"weapon\") {\n      // Type and subtype labels\n      const wcat = itemData.weapon?.category || \"simple\";\n      const wtype = itemData.weapon?.type || \"light\";\n\n      labels.weapon ??= {};\n      const cat = ffd20.config.weaponTypes[wcat];\n      labels.weapon.category = cat?._label;\n      labels.weapon.type = cat?.[wtype];\n    }\n\n    return labels;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * Buff item\n *\n * More or less ephemeral effects, such as spell buffs.\n */\nexport class ItemBuffPF extends ItemPF {\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Add activation time when not present\n    if (changed.system?.active && changed.system?.duration?.start === undefined) {\n      foundry.utils.setProperty(changed, \"system.duration.start\", game.time.worldTime);\n    }\n\n    if (this.isActive && changed.system?.active === false) {\n      const effect = this.effect;\n      context.ffd20 ??= {};\n      context.ffd20.startTime = effect?.duration.startTime;\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Update data\n   * @param {object} context - Update context options\n   * @param {string} userId - User ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    if (changed.system === undefined) return; // No system data updates\n\n    // Following requires actor\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Toggle buff hook\n    const isActive = changed.system?.active;\n    if (isActive !== undefined) {\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, this, isActive);\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Creation context\n   * @param {string} userId - User ID\n   */\n  _onCreate(data, context, userId) {\n    super._onCreate(data, context, userId);\n\n    const actor = this.actor;\n    const isActive = this.isActive;\n    if (actor && isActive) {\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, this, true);\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} context - Delete context options\n   * @param {string} userId - Triggering user ID\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    // Run script call(s)\n    if (game.users.get(userId)?.isSelf) {\n      if (this.isActive) {\n        const startTime = context.ffd20?.startTime;\n        this.executeScriptCalls(\"toggle\", { state: false, startTime });\n      }\n    }\n\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Call buff removal hook\n    if (this.isActive) {\n      Hooks.callAll(\"pf1ToggleActorBuff\", actor, this, false);\n    }\n  }\n\n  /** @inheritDoc */\n  _activeStateChange(changed) {\n    return changed.system?.active;\n  }\n\n  /**\n   * Toggle active effect icon as necessary.\n   *\n   * @param {object} changed Update data\n   */\n  async _updateTrackingEffect(changed) {\n    // Toggle icon if active state has changed\n    const isActive = changed.system?.active;\n    if (isActive === undefined) return;\n\n    const oldEffect = this.effect;\n\n    // Remove old AE\n    if (!isActive) {\n      oldEffect?.delete({ render: false });\n    }\n    // Add new AE or update old AE\n    else {\n      const aeData = await this.getRawEffectData();\n      aeData.active = isActive;\n      aeData.transfer = true;\n      foundry.utils.setProperty(aeData, \"flags.ffd20.tracker\", true);\n\n      // Update old\n      if (oldEffect) oldEffect.update(aeData);\n      // Create new\n      else ActiveEffect.implementation.create(aeData, { parent: this });\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preDelete(context, user) {\n    const effect = this.effect;\n    if (effect) {\n      context.ffd20 ??= {};\n      context.ffd20.startTime = effect?.duration.startTime;\n      // Delete associated effect\n      // TODO: Remove this eventually, it is only needed by old items/actors\n      if (effect?.parent !== this) {\n        await effect.delete({ ffd20: { delete: this.uuid } });\n      }\n    }\n\n    await super._preDelete(context, user);\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    const itemData = this.system;\n    labels.subType = ffd20.config.buffTypes[itemData.subType];\n\n    if (this.system.duration) {\n      const duration = this.system.duration;\n      const unit = ffd20.config.timePeriodsShort[duration.units];\n      if (unit === \"turn\") {\n        labels.duration = game.i18n.format(\"FFD20.Time.Format\", { value: 1, unit });\n      } else if (unit && duration.value) {\n        try {\n          // TODO: Durations can be variable, variable durations need to be supported.\n          rollData ??= this.getRollData();\n          const roll = RollPF.safeRollSync(\n            duration.value,\n            rollData,\n            { formula: duration.value, item: this },\n            {},\n            { maximize: true }\n          );\n          let value;\n          if (roll.isDeterministic) {\n            value = roll.total ?? 0;\n          } else {\n            value = ffd20.utils.formula.simplify(duration.value, rollData);\n          }\n          labels.duration = game.i18n.format(\"FFD20.Time.Format\", { value, unit });\n        } catch (e) {\n          console.warn(`Error with buff duration formula \"${duration.value}\"`, this, e);\n        }\n      }\n    }\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  _addTypeRollData(result) {\n    // Add fake CL based on buff level\n    result.cl = result.item.level;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  _prepareDependentData(final = false) {\n    super._prepareDependentData(final);\n  }\n\n  /**\n   * Duration of the buff in seconds.\n   *\n   * @internal\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.interactive=false]\n   * @param {object} [options.rollData] - Roll data\n   * @returns {Promise<number|null>} Duration in seconds or null if if it has no duration.\n   */\n  async getDuration({ rollData, interactive = false } = {}) {\n    const duration = this.system.duration ?? {};\n    const { units, value: formula } = duration;\n    if (!units) return null;\n\n    rollData ??= this.getRollData();\n\n    // Add total duration in seconds\n    let seconds = 0;\n    if (units === \"turn\") {\n      seconds = CONFIG.time.roundTime;\n    } else {\n      if (!formula) return null;\n      rollData ??= this.getRollData();\n      // TODO: Make this roll somehow known\n      const droll = await RollPF.safeRoll(formula, rollData, undefined, undefined, { allowInteractive: interactive });\n      const duration = droll.total;\n      switch (units) {\n        case \"hour\":\n          seconds = duration * 60 * 60;\n          break;\n        case \"minute\":\n          seconds = duration * 60;\n          break;\n        case \"round\":\n          seconds = duration * CONFIG.time.roundTime;\n          break;\n      }\n    }\n    return seconds;\n  }\n\n  /** @inheritDoc */\n  async getRawEffectData({ rollData } = {}) {\n    const createData = await super.getRawEffectData();\n\n    createData.type = \"buff\";\n\n    if (this.system.conditions?.length) createData.statuses = [...this.system.conditions];\n\n    // Add buff durations\n    const duration = this.system.duration;\n\n    let endTiming = this.system.duration.end || \"turnStart\";\n\n    let seconds;\n    if (duration.units === \"turn\") {\n      endTiming = \"turnEnd\";\n      seconds = 0;\n    } else if (duration.value) {\n      seconds = await this.getDuration({ rollData });\n    }\n\n    if (Number.isFinite(seconds)) {\n      createData.duration.seconds = seconds;\n    }\n\n    // Record timing\n    createData.system ??= {};\n    createData.system.end = endTiming;\n    createData.system.initiative = game.combat?.initiative;\n\n    return createData;\n  }\n\n  /**\n   * @override\n   */\n  getRollData(options) {\n    const result = super.getRollData(options);\n\n    result.item.level = this.system.level;\n\n    return result;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  get isActive() {\n    return this.system.active ?? false;\n  }\n\n  /**\n   * Retrieve associated tracking Active Effect\n   *\n   * @type {ActiveEffect|undefined}\n   */\n  get effect() {\n    return this.effects.find((ae) => ae.getFlag(\"ffd20\", \"tracker\") === true);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  async setActive(active, context) {\n    return this.update({ \"system.active\": active }, context);\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * Class-like item\n *\n * For base classes, NPC classes, racial HD, and mythic paths.\n */\nexport class ItemClassPF extends ItemPF {\n  /** @override */\n  static system = Object.freeze({\n    ...super.system,\n    hasActions: false,\n    subtypeName: true,\n  });\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Set level marker\n    if (changed.system.level !== undefined && changed.system.level !== this.system.level) {\n      context.ffd20 ??= {};\n      context.ffd20.item ??= {};\n      context.ffd20.item[this.id] ??= {};\n      context.ffd20.item[this.id].oldLevel = this.system.level;\n    }\n\n    // Ensure class associations remain in level order\n    const classLinks = changed.system.links?.classAssociations;\n    if (classLinks?.length) {\n      classLinks.forEach((link) => (link.level ||= 1));\n      classLinks.sort((a, b) => a.level - b.level);\n    }\n  }\n\n  /**\n   * Add or remove class associations on level change.\n   *\n   * @param {number} curLevel Current level, before the change.\n   * @param {number} newLevel New level, after the change.\n   * @param {object} [options] - Additional options\n   * @param {\"delete\"|\"update\"|\"create\"} [options.event] - Relevant event\n   */\n  async _onLevelChange(curLevel = 0, newLevel = 0, { event } = {}) {\n    const actor = this.actor;\n    if (!actor) return;\n\n    if (curLevel === newLevel) return;\n\n    // Add items associated to this class\n    if (newLevel > curLevel) {\n      const associations = this.system.links?.classAssociations ?? [];\n      const newAssociations = associations.filter((link) => link.level > curLevel && link.level <= newLevel);\n\n      const sources = new Map();\n\n      const newItems = [];\n      for (const link of newAssociations) {\n        const item = await fromUuid(link.uuid);\n        if (!item) {\n          const msg = `Could not find class association: ${link.uuid}`;\n          console.warn(link.uuid, msg, this);\n          ui.notifications?.warn(msg, { console: false });\n          continue;\n        }\n\n        sources.set(item.uuid, link);\n\n        // Apply Foundry's transformations for importing (automatically calls .toObject())\n        // This adds _stats.compendiumSource, removes extraneous permissions, resets sorting, etc.\n        const itemData = game.items.fromCompendium(item, { clearFolder: true });\n\n        // Set associated class\n        itemData.system.class = this.system.tag;\n\n        newItems.push({ data: itemData, link });\n      }\n\n      if (newItems.length) {\n        const itemsCreationData = newItems.sort((a, b) => a.link.level - b.link.level).map((o) => o.data);\n        // Put new items at end of their types\n        const _typeSorting = {};\n        for (const item of itemsCreationData) {\n          _typeSorting[item.type] ??= actor.itemTypes[item.type].sort((a, b) => b.sort - a.sort)[0]?.sort ?? 0;\n          _typeSorting[item.type] += CONST.SORT_INTEGER_DENSITY;\n          item.sort = _typeSorting[item.type];\n        }\n        const items = await actor.createEmbeddedDocuments(\"Item\", itemsCreationData);\n\n        const classAssociations = {};\n        const updateData = { flags: { ffd20: { links: { classAssociations } } } };\n        for (const item of items) {\n          const link = sources.get(item._stats?.compendiumSource);\n\n          // Set class association flags\n          classAssociations[item.id] = link?.level ?? 1;\n        }\n\n        await this.update(updateData, { render: false });\n      }\n    }\n\n    // Remove items associated to this class\n    if (newLevel < curLevel) {\n      const associations = foundry.utils.deepClone(this.getFlag(\"ffd20\", \"links.classAssociations\") || {});\n\n      const itemIds = [];\n      for (const [id, level] of Object.entries(associations)) {\n        const item = actor.items.get(id);\n        if (!item) {\n          delete associations[id];\n          continue;\n        }\n\n        if (level > newLevel) {\n          itemIds.push(item.id);\n          delete associations[id];\n        }\n      }\n\n      if (event !== \"delete\") await this.setFlag(\"ffd20\", \"links.classAssociations\", associations);\n\n      await Item.implementation.deleteDocuments(itemIds, { parent: actor });\n    }\n\n    // Call level change hook\n    Hooks.callAll(\"pf1ClassLevelChange\", this.actor, this, curLevel, newLevel);\n  }\n\n  /**\n   * @override\n   */\n  prepareBaseData() {\n    super.prepareBaseData();\n    const itemData = this.system;\n    // Reset cached HD/MT\n    // Can't prepare here as the actor uses this info before item preparation is done.\n    itemData.hitDice = undefined;\n    itemData.mythicTier = undefined;\n\n    // Soft fill default casting details when missing\n    if (itemData.casting?.type) {\n      itemData.casting.progression ??= \"high\";\n      itemData.casting.ability ??= \"int\";\n      itemData.casting.spells ??= \"arcane\";\n      itemData.casting.domainSlots ??= 1;\n      itemData.casting.cantrips ??= true;\n    }\n  }\n\n  /**\n   * @override\n   */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    const itemData = this.system;\n\n    const useFractional = game.settings.get(\"ffd20\", \"useFractionalBaseBonuses\");\n\n    // Prepare class base save\n    {\n      const saveFormulas = useFractional\n        ? ffd20.config.classFractionalSavingThrowFormulas\n        : ffd20.config.classSavingThrowFormulas;\n\n      for (const save of Object.keys(ffd20.config.savingThrows)) {\n        const classType = itemData.subType || \"base\";\n        let formula;\n        const saveData = itemData.savingThrows[save];\n        const saveType = saveData.value;\n        if (saveType === \"custom\") {\n          formula = saveData.custom || \"0\";\n        } else {\n          formula = saveFormulas[classType][saveType];\n        }\n        if (formula == null) formula = \"0\";\n        const total = RollPF.safeRollSync(formula, { level: itemData.level, hitDice: this.hitDice }).total;\n        saveData.base = total;\n        if (useFractional) saveData.good = saveFormulas[classType].goodSave === true && saveType === \"high\";\n      }\n    }\n\n    // Prepare BAB\n    {\n      const babFormulas = useFractional ? ffd20.config.classFractionalBABFormulas : ffd20.config.classBABFormulas;\n\n      const babType = itemData.bab;\n      let formula;\n      if (babType === \"custom\") {\n        formula = itemData.babFormula || \"0\";\n      } else {\n        formula = babFormulas[babType] || \"0\";\n      }\n      itemData.babBase = RollPF.safeRollSync(formula, { level: itemData.level, hitDice: this.hitDice }).total;\n    }\n\n    // Feed info back to actor\n    // Unlinked actors sometimes call item prep when actor isn't prepped and they're lacking .system\n    if (this.actor?.system) this._registerOnActor();\n  }\n\n  /**\n   * Register this item on actor in relevant places.\n   *\n   * @internal\n   * @returns {void}\n   */\n  _registerOnActor() {\n    const actor = this.actor;\n    if (!actor.classes) return; // actor prep has not run for some reason (unlinked actor)\n\n    const itemData = this.system;\n\n    // Don't record a link of tag is missing or empty.\n    if (!itemData.tag) return void console.error(\"Class doesn't have a tag\", this);\n\n    if (!itemData.subType) console.warn(`${this.name} lacks class type`, this);\n\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const classHpConfig = hpConfig.getClassHD(this);\n\n    const isBaseClass = (itemData.subType || \"base\") === \"base\";\n    const isMythic = itemData.subType === \"mythic\";\n\n    actor.classes[itemData.tag] = {\n      _id: this.id,\n      level: itemData.level,\n      unlevel: itemData.level,\n      name: this.name,\n      hd: itemData.hd,\n      hitDice: this.hitDice,\n      mythicTier: this.mythicTier,\n      bab: itemData.bab,\n      hp: classHpConfig.auto,\n      type: itemData.subType,\n      isBase: isBaseClass,\n      isMythic,\n      savingThrows: {\n        fort: itemData.savingThrows.fort.base,\n        ref: itemData.savingThrows.ref.base,\n        will: itemData.savingThrows.will.base,\n      },\n      fc: {\n        hp: isBaseClass ? itemData.fc.hp.value : 0,\n        skill: isBaseClass ? itemData.fc.skill.value : 0,\n        alt: isBaseClass ? itemData.fc.alt.value : 0,\n      },\n    };\n  }\n\n  /**\n   * Hit Dice\n   *\n   * @type {number}\n   */\n  get hitDice() {\n    const itemData = this.system;\n    if (itemData.hitDice === undefined) {\n      if (itemData.subType === \"mythic\") {\n        itemData.hitDice = 0;\n      } else if (itemData.customHD?.length > 0) {\n        const rollData = { item: { level: this.system.level } };\n        itemData.hitDice = RollPF.safeRollSync(itemData.customHD, rollData).total;\n      } else {\n        itemData.hitDice = itemData.level;\n      }\n    }\n\n    return itemData.hitDice;\n  }\n\n  /**\n   * Mythic Tier\n   *\n   * @type {number}\n   */\n  get mythicTier() {\n    this.system.mythicTier ??= this.subType === \"mythic\" ? this.system.level : 0;\n    return this.system.mythicTier;\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n\n  /** @inheritDoc */\n  getLabels({ rollData, isolated } = {}) {\n    const labels = super.getLabels({ rollData, isolated });\n\n    const itemData = this.system;\n    labels.subType = ffd20.config.classTypes[itemData.subType];\n\n    labels.bab = ffd20.config.classBAB[itemData.bab];\n    labels.saves = {\n      fort: ffd20.config.classSavingThrows[itemData.savingThrows?.fort?.value],\n      ref: ffd20.config.classSavingThrows[itemData.savingThrows?.ref?.value],\n      will: ffd20.config.classSavingThrows[itemData.savingThrows?.will?.value],\n    };\n\n    labels.hitDie = itemData.hd;\n    if (itemData.subType !== \"mythic\") labels.hitDie = game.i18n.format(\"FFD20.DieSize\", { size: itemData.hd });\n\n    labels.hasFCB = itemData.fc?.hp > 0 || itemData.fc?.skill > 0 || itemData.fc?.alt > 0;\n\n    // Remove labels that are meaningless for classes\n    delete labels.activation;\n\n    return labels;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\n/**\n * Abstract class for physical items.\n */\nexport class ItemPhysicalPF extends ItemPF {\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return;\n\n    // Convert .hp.value into .hp.offset\n    const hp = changed.system?.hp;\n    if (hp?.value !== undefined) {\n      let max = this.system.hp?.max ?? 0;\n      const oldBase = this.system.hp?.base;\n      if (hp.base !== undefined && hp.base !== oldBase) {\n        max += hp.base - oldBase;\n      }\n      hp.offset ??= hp.value - max;\n      delete hp.value;\n    }\n\n    await this._resetChargesOnQuantityUpdate(changed);\n  }\n\n  /**\n   * @inheritDoc\n   * @internal\n   */\n  static system = Object.freeze(foundry.utils.mergeObject(super.system, { isPhysical: true }, { inplace: false }));\n\n  /**\n   * @internal\n   * @param {object} system - System data\n   */\n  _preUpdateNumericValueGuard(system) {\n    super._preUpdateNumericValueGuard(system);\n\n    if (system.quantity !== undefined && (!Number.isSafeInteger(system.quantity) || system.quantity < 0)) {\n      system.quantity = 0;\n    }\n    if (system.price !== undefined && !Number.isFinite(system.price)) {\n      system.price = 0;\n    }\n    if (system.unidentified?.price !== undefined && !Number.isFinite(system.unidentified.price)) {\n      system.unidentified.price = 0;\n    }\n    if (system.hardness !== undefined && (!Number.isSafeInteger(system.hardness) || system.hardness < 0)) {\n      system.hardness = 0;\n    }\n    if (system.hp?.value !== undefined && !Number.isSafeInteger(system.hp.value)) {\n      system.hp.value = 0;\n    }\n    if (system.hp?.max !== undefined && (!Number.isSafeInteger(system.hp.max) || system.hp.max < 0)) {\n      system.hp.max = 0;\n    }\n  }\n\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const extraData = {};\n\n    // Items for NPCs should be unidentified by default if unknown\n    if (\n      data.system?.identified === undefined &&\n      this.actor && // Has actor, ignore otherwise\n      this.actor.type !== \"character\" && // Any NPCs\n      !this.actor?.hasPlayerOwner // Player owned actors ignore this\n    ) {\n      extraData[\"system.identified\"] = false;\n    }\n\n    // No HP defined, old or new\n    if (data.system?.hp?.base === undefined && data.system?.hp?.max === undefined) {\n      extraData[\"system.hp.base\"] = 10;\n    }\n\n    if (!foundry.utils.isEmpty(extraData)) {\n      this.updateSource(extraData);\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onCreate(data, context, userId) {\n    super._onCreate(data, context, userId);\n\n    // Simulate equipping items    {\n    if (this.system.equipped === true) {\n      this.executeScriptCalls(\"equip\", { equipped: true });\n    }\n\n    // Quantity change\n    const quantity = this.system.quantity || 0;\n    if (quantity > 0) {\n      this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: 0, new: quantity } });\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    // Call 'equip' script calls\n    const equipped = changed.system?.equipped;\n    if (equipped != null) {\n      this.executeScriptCalls(\"equip\", { equipped });\n    }\n  }\n\n  _onMemorizedUpdate(changed, context) {\n    // Call 'changeQuantity' script calls\n    const oldQuantity = this._memoryVariables?.quantity;\n    if (oldQuantity !== undefined) {\n      const quantity = {\n        previous: oldQuantity,\n        new: this.system.quantity,\n      };\n\n      if (quantity.new != null && quantity.new !== quantity.previous) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity });\n      }\n    }\n\n    // Must call super last or the memory data gets cleared too soon\n    super._onMemorizedUpdate(changed, context);\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    if (game.users.get(userId)?.isSelf) {\n      if (this.system.equipped === true) {\n        this.executeScriptCalls(\"equip\", { equipped: false });\n      }\n\n      if (this.system.quantity > 0) {\n        this.executeScriptCalls(\"changeQuantity\", { quantity: { previous: this.system.quantity, new: 0 } });\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  _activeStateChange(changed) {\n    return changed.system?.equipped;\n  }\n\n  /**\n   * Reset charges when quantity is changed to simulate a stack.\n   *\n   * - If charges are 0\n   * - ... and quantity is reduced, reset to max\n   *\n   * @param {object} changed - Changed data\n   */\n  async _resetChargesOnQuantityUpdate(changed) {\n    // Don't care if charges are linked\n    if (this.links.charges) return;\n\n    // Only if quantity changed\n    const newQuantity = changed.system.quantity;\n    if (newQuantity === undefined) return;\n    // Don't touch if quantity is increased or remains the same\n    if ((newQuantity || 0) >= (this.system.quantity || 0)) return;\n\n    // Avoid overwriting value if the update is modifying it.\n    if (changed.system.uses?.value !== undefined) return;\n\n    const oldUses = this.system.uses ?? {};\n    if (oldUses.per && oldUses.value === 0 && oldUses.max > 0) {\n      const update = await this.recharge({ period: \"any\", commit: false });\n      if (update) {\n        changed.system.uses ??= {};\n        changed.system.uses.value = update.system.uses.value;\n      }\n    }\n  }\n\n  /** @override */\n  prepareBaseData() {\n    // Set visible name\n    if (this.showUnidentifiedData) {\n      this.name = this.system.unidentified?.name || this._source.name;\n    } else {\n      this.name = this._source.name;\n    }\n\n    // Ensure some base data has values\n    this.system.size ||= \"med\";\n    this.system.weight ??= {};\n    this.system.weight.value ||= 0;\n    this.system.quantity ||= 0;\n\n    super.prepareBaseData();\n\n    const itemData = this.system;\n    // Init base weight values in case they're missing.\n    itemData.weight ??= {};\n    itemData.weight.value ??= 0;\n    itemData.weight.total = 0;\n    itemData.weight.converted ??= {};\n\n    this.prepareDurability();\n  }\n\n  /** @override */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n\n    // Physical items\n    if (this.isPhysical && this.showUnidentifiedData) {\n      // Set unidentified description for players\n      this.system.description.value = this.system.description.unidentified;\n    }\n  }\n\n  /**\n   * Prepare dependent data for contained items.\n   *\n   * @inheritDoc\n   */\n  _prepareDependentData(final = false) {\n    super._prepareDependentData(final);\n    this.prepareWeight();\n  }\n\n  /** @inheritDoc */\n  async setActive(active, context) {\n    return this.update({ \"system.equipped\": active }, context);\n  }\n\n  /** @inheritDoc */\n  get isActive() {\n    const hp = this.system.hp?.value || 0;\n    if (hp <= 0) return false; // Destroyed\n    if (this.system.quantity <= 0) return false;\n    return this.system.equipped ?? false;\n  }\n\n  /**\n   * Determines if the item is equipped.\n   *\n   * @inheritDoc\n   */\n  get activeState() {\n    return this.system.equipped || false;\n  }\n\n  /**\n   * Prepare hardness and hit points\n   *\n   * @internal\n   */\n  prepareDurability() {\n    const system = this.system;\n\n    const enh = system.enh || 0;\n    const hardness = this._source.system.hardness || 0;\n\n    system.hardness = {\n      base: hardness,\n      total: hardness + ffd20.config.itemEnhancementMods.hardness * enh,\n    };\n\n    // Establish HP structure\n    system.hp ??= {};\n    system.hp.base ??= 10;\n    system.hp.offset ||= 0;\n    system.hp.max = this._sizeAdjustedHealth() + ffd20.config.itemEnhancementMods.hp * enh;\n    system.hp.value = Math.max(0, system.hp.max + system.hp.offset);\n\n    // TODO: Adjust HP based on item size\n  }\n\n  /**\n   * Adjust HP value by item size.\n   *\n   * In reference to rules established at Table 7-12 of CRB p. 175\n   *\n   * @see {@link https://aonprd.com/Rules.aspx?ID=126}\n   *\n   * @internal\n   * @returns {number} - Size adjusted health\n   */\n  _sizeAdjustedHealth() {\n    let hp = this.system.hp?.base || 10;\n\n    // Adjust HP per size\n    let itemSize = Object.keys(ffd20.config.actorSizes).indexOf(this.system.size || \"med\");\n    if (itemSize < 0) itemSize = 4;\n    while (itemSize !== 4) {\n      if (itemSize > 4) {\n        hp *= 2;\n        itemSize--;\n      } else if (itemSize < 4) {\n        hp /= 2;\n        itemSize++;\n      }\n    }\n\n    return Math.max(1, Math.floor(hp));\n  }\n\n  /**\n   * Prepare this item's {@link ItemWeightData}\n   *\n   * @param {boolean} [initialize=true] - Initialize. Only used by containers.\n   */\n  prepareWeight(initialize = true) {\n    const itemData = this.system;\n    const weight = itemData.weight;\n\n    // Adjust base weight\n    // Altering weight.value directly will corrupt the weight\n    const baseWeight = weight.value * this.getWeightMultiplier();\n\n    if (initialize) weight.total = 0;\n\n    weight.total += baseWeight * itemData.quantity;\n\n    // Convert weight according metric system (lb vs kg)\n    weight.converted.value = ffd20.utils.convertWeight(baseWeight);\n    weight.converted.total = ffd20.utils.convertWeight(weight.total);\n  }\n\n  /**\n   * Return weight multiplier affecting this item.\n   *\n   * Such as item size dictating how heavy an armor is.\n   *\n   * @returns {number} - Multiplier, 1 for most items regardless of size.\n   */\n  getWeightMultiplier() {\n    return 1;\n  }\n\n  /**\n   * Weight scaling\n   *\n   * For use with {@link getWeightMultiplier()} across item types\n   *\n   * @internal\n   * @returns {number} - Weight multiplier\n   */\n  _getArmorWeightMultiplier() {\n    // Scale weight for weapons, armor and shields\n    const actorSize = Object.keys(ffd20.config.sizeChart)[this.actor?.system.traits?.size?.value];\n    const itemSize = this.system.size || \"med\";\n    const size = this.system.resizing ? actorSize || itemSize : itemSize;\n    const mult = ffd20.config.armorWeight[size];\n    return mult ?? 1;\n  }\n\n  /**\n   * Returns the displayed value of an item according to multiple options\n   *\n   * @param {object} [options] - Various optional parameters affecting value calculations\n   * @param {boolean} [options.recursive=true] - Whether the value of contained items should be included\n   * @param {number} [options.sellValue=0.5] - The sell value multiplier\n   * @param {boolean} [options.inLowestDenomination=false] - Whether the value should be returned in the lowest denomination\n   * @param {boolean} [options.forceUnidentified=false] - Override whether the value should use the unidentified price\n   * @param {boolean} [options.single=false] - Return value of singular item instead of the actual stack. Disables recursive option.\n   * @param {boolean} [options.identical=false] - Treat all items in stack as identical (same number of charges).\n   * @param {boolean} [options.maximized=false] - Pretend as if the items were fresh  (full charges)\n   * @returns {number} The item's value\n   */\n  getValue({\n    // eslint-disable-next-line no-unused-vars\n    recursive = true, // Not used by all types, so unused in this base implementation\n    sellValue = 0.5,\n    inLowestDenomination = false,\n    forceUnidentified = false,\n    single = false,\n    identical = false,\n    maximized = false,\n  } = {}) {\n    const hasFiniteCharges = this.hasFiniteCharges;\n    const maxChargesValue = hasFiniteCharges ? this.maxCharges : 0;\n    const remainingCharges = hasFiniteCharges ? (maximized ? maxChargesValue : this.charges) : 0;\n\n    const getActualValue = (identified = true, maxCharges = false) => {\n      let value = 0;\n      if (identified) value = this.system.price || 0;\n      else value = this.system.unidentified?.price || 0;\n\n      // Add charge price\n      if (identified && hasFiniteCharges) {\n        let charges = maxCharges ? maxChargesValue : remainingCharges;\n        if (!Number.isFinite(charges) || charges < 0) charges = 0;\n        value += (this.system.uses?.pricePerUse ?? 0) * charges;\n      }\n\n      if (inLowestDenomination) value *= 100;\n      if (this.isBroken) value *= 0.75; // TODO: Make broken value configurable\n      if (this.system.timeworn) {\n        if (hasFiniteCharges && remainingCharges === 0) value *= 0.01;\n        else value *= 0.5;\n      }\n      return value;\n    };\n\n    // Increase value by quantity\n    const isIdentified = forceUnidentified ? false : !this.showUnidentifiedData;\n    const quantity = single ? 1 : this.system.quantity || 0;\n    let result = getActualValue(isIdentified);\n    if (quantity > 1) {\n      // If charged item, add rest of the stack as if they had full charges\n      if (hasFiniteCharges && identical !== true) result += getActualValue(isIdentified, true) * (quantity - 1);\n      // Otherwise just multiply\n      else result *= quantity;\n    }\n\n    // Modify sell value\n    if (!(this.type === \"loot\" && [\"tradeGoods\", \"treasure\"].includes(this.subType))) result *= sellValue;\n\n    return result;\n  }\n\n  /**\n   * @remarks\n   * Checks if the item is equipped and has quantity.\n   * @inheritDoc\n   */\n  get canUse() {\n    return this.system.equipped && this.system.quantity > 0;\n  }\n\n  /**\n   * Broken state\n   *\n   * Tests both explicit broken override and current health.\n   *\n   * @type {boolean}\n   */\n  get isBroken() {\n    if (this.system.broken) return true;\n\n    const hp = this.system.hp ?? {};\n    const hpMax = hp.max ?? 0;\n    if (hpMax > 0) {\n      const hpCur = hp.value ?? 0;\n      const brokenThreshold = Math.floor(hpMax / 2);\n      return hpCur <= brokenThreshold;\n    }\n\n    return false;\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    labels.broken = this.isBroken;\n\n    const itemData = this.system;\n\n    // Equipped label\n    const checkYes = '<i class=\"fa-solid fa-check\"></i>';\n    const checkNo = '<i class=\"fa-solid fa-times\"></i>';\n    labels.equipped = \"\";\n    if (itemData.equipped === true) labels.equipped = checkYes;\n    else labels.equipped = checkNo;\n\n    // Carried label\n    labels.carried = \"\";\n    if (itemData.carried === true) labels.carried = checkYes;\n    else labels.carried = checkNo;\n\n    // Identified label\n    labels.identified = \"\";\n    if (itemData.identified === true) labels.identified = checkYes;\n    else labels.identified = checkNo;\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  adjustContained() {\n    super.adjustContained();\n\n    this.system.carried = true;\n\n    // Auto-unequip\n    if (!this.canEquip) this.system.equipped = false;\n  }\n\n  /**\n   * Can equip currently?\n   *\n   * @type {boolean}\n   */\n  get canEquip() {\n    return !this.inContainer;\n  }\n\n  /**\n   * @remarks\n   * Identified state is the only thing that can alter the result.\n   * @override\n   * @inheritDoc\n   */\n  getName(forcePlayerPerspective = false) {\n    if (game.user.isGM && forcePlayerPerspective) {\n      if (this.system.identified === false) return this.system.unidentified?.name || this.name;\n    }\n    return this.name;\n  }\n\n  get showUnidentifiedData() {\n    return !game.user.isGM && this.system.identified === false;\n  }\n\n  /** @inheritDoc */\n  _addTypeRollData(result) {\n    // Convert size string to number\n    result.item.size = Object.keys(ffd20.config.actorSizes).indexOf(result.item.size);\n\n    // Overwrite broken state\n    result.item.broken = this.isBroken;\n  }\n}\n\n/**\n * @typedef {object} ItemWeightData\n * An item's `weight` data. The only property to be stored is `value`, from which all other values are derived.\n * @see {@link ItemPF.prepareWeight} for generation\n * @remarks A weight property is considered \"effective\" if it is the value that is added to its parent's weight.\n *          An item with a weight of 10 lbs in a container with 50% weight reduction would increase\n *          the container's effective `weight.total` by 5 lbs, but increases the container's `weight.contents` weight by 10 lbs.\n * @property {number} value - The weight of a single item instance, in lbs\n * @property {number} total - The effective total weight of the item (including quantity and contents), in lbs\n * @property {number} [currency] - Effective weight of contained currency for containers, in lbs\n * @property {number} [contents] - Weight of contained items and currency, in lbs\n * @property {object} converted - Weight of this item, converted to the current unit system\n * @property {number} converted.value - The weight of a single item instance, in world units\n * @property {number} converted.total - The effective total weight of the item (including quantity and contents), in world units\n * @property {number} [converted.contents] - Weight of contained items and currency, in world units\n */\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Consumable item\n *\n * For potions, wands, scrolls, drugs, etc.\n */\nexport class ItemConsumablePF extends ItemPhysicalPF {\n  /** @inheritDoc */\n  static system = Object.freeze({ ...super.system, subtypeName: true });\n\n  /**\n   * @inheritDoc\n   */\n  adjustContained() {\n    super.adjustContained();\n\n    this.system.carried = true;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    labels.subType = ffd20.config.consumableTypes[this.subType];\n\n    return labels;\n  }\n}\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Container item\n *\n * Bags, backpacks, chests, etc.\n */\nexport class ItemContainerPF extends ItemPhysicalPF {\n  /** @override */\n  static system = Object.freeze({\n    ...super.system,\n    hasIdentifier: true,\n    hasActions: false,\n  });\n\n  _initialize() {\n    this.items = new Collection();\n\n    super._initialize();\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.recursive === false || context.diff === false) return;\n\n    // Ensure contained item updates adhere to reason\n    const items = changed.system.items;\n    if (items) {\n      for (const [itemId, itemData] of Object.entries(items)) {\n        await this._containedItemUpdate(itemId, itemData, items, context);\n      }\n    }\n  }\n\n  /**\n   * Handle contained item CRUD\n   *\n   * @internal\n   * @param {string} itemId - Item ID\n   * @param {object|null} itemData - Item's update data\n   * @param {object} items - Parent's items update object\n   * @param {object} context - Context\n   */\n  async _containedItemUpdate(itemId, itemData, items, context) {\n    // Deletion\n    if (itemId.startsWith(\"-=\")) {\n      /** @type {ItemPF} */\n      const oldItem = this.items.get(itemId.replace(/^-=/, \"\"));\n\n      if (oldItem) {\n        await oldItem._preDelete(context, game.user);\n        // TODO: Run pre-delete on everything contained by this\n      }\n      return;\n    }\n\n    /** @type {ItemPF} */\n    const oldItem = this.items.get(itemId);\n\n    let diff;\n    // Existing contained item\n    if (oldItem) {\n      await oldItem._preUpdate(itemData, context, game.user);\n      diff = oldItem.updateSource(itemData, { dryRun: true, fallback: false });\n      // Remove lingering .data if present, the above line prunes this out if done externally\n      if (\"data\" in this.system.items[itemId]) diff[\"-=data\"] = null;\n    }\n    // New contained item\n    else {\n      /** @type {ItemPF} */\n      const temp = new Item.implementation(itemData);\n      await temp._preCreate(itemData, context, game.user);\n      diff = temp.toObject();\n    }\n\n    items[itemId] = diff;\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onUpdate(changed, context, userId) {\n    // Call various document workflows for changed items\n    const items = changed.system?.items;\n    if (items) {\n      for (const [itemId, itemData] of Object.entries(items)) {\n        const item = this.items.get(itemId);\n        try {\n          if (itemId.startsWith(\"-=\")) {\n            // TODO: Item reference is no longer available for _onDelete workflow\n            // item._onDelete(options, userId);\n          } else if (itemData._id) {\n            item._onCreate(itemData, context, userId);\n          } else {\n            item._onUpdate(itemData, context, userId);\n          }\n        } catch (err) {\n          console.error(err, { parent: this, item });\n        }\n\n        // TODO: createDocument, deleteDocument, updateDocument hooks\n      }\n    }\n\n    super._onUpdate(changed, context, userId);\n  }\n\n  /** @override */\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    // Set base weight to weight of coins, which can be calculated without knowing contained items\n    const weightReduction = (100 - (this.system.weight?.reduction?.percent ?? 0)) / 100;\n    this.system.weight.currency = this._calculateCoinWeight() * weightReduction;\n  }\n\n  /** @override */\n  prepareDerivedData() {\n    this._prepareInventory();\n\n    super.prepareDerivedData();\n  }\n\n  /**\n   * Prepare dependent data for contained items.\n   *\n   * @inheritDoc\n   */\n  _prepareDependentData(final = false) {\n    // Update dependant data and resources\n    for (const item of this.items) {\n      item._prepareDependentData(final);\n    }\n\n    super._prepareDependentData(final);\n  }\n\n  /**\n   * Prepare .items collection for contained items.\n   *\n   * @private\n   */\n  _prepareInventory() {\n    const prior = this.items;\n    const collection = new Collection();\n    this.system.items ??= {}; // Shim for items that haven't had template.json applied to them\n    for (const [itemId, itemData] of Object.entries(this.system.items)) {\n      try {\n        let item = prior?.get(itemId);\n        if (item) {\n          item.updateSource(new Item.implementation(itemData).toObject(), { recursive: false });\n        } else {\n          item = new Item.implementation(itemData, { parent: this.actor });\n          item.parentItem = this;\n        }\n        item.reset();\n        collection.set(itemId, item);\n      } catch (err) {\n        console.error(\"Error preparing contained item:\", { id: itemId, data: itemData }, this);\n        throw err;\n      }\n    }\n\n    /** @type {Collection<ItemPF>} */\n    this.items = collection;\n  }\n\n  /** @inheritDoc */\n  prepareWeight() {\n    this.system.weight ??= {};\n    /** @type {ItemWeightData} */\n    const weight = this.system.weight;\n    weight.total = 0; // Reset\n\n    // Percentile weight reduction\n    const weightMult = (100 - (weight.reduction?.percent || 0)) / 100;\n\n    const currencyWeight = this._calculateCoinWeight();\n    weight.currency = currencyWeight * weightMult;\n\n    // Total unreduced weight of contents\n    weight.contents = this.items.reduce((total, item) => total + item.system.weight.total, 0);\n    weight.contents += currencyWeight;\n\n    const reductionFlat = weight.reduction?.value ?? 0;\n    weight.total += Math.max(0, weight.contents * weightMult - reductionFlat);\n\n    // Apply quantity\n    weight.total *= this.system.quantity || 0;\n\n    weight.converted.reduction = ffd20.utils.convertWeight(reductionFlat);\n    weight.converted.contents = ffd20.utils.convertWeight(weight.contents);\n    weight.converted.currency = ffd20.utils.convertWeight(weight.currency);\n\n    super.prepareWeight(false);\n  }\n\n  /**\n   * @protected\n   * @param {object[]} itemsData Item creation data\n   * @param {object} [options={}] Additional options\n   * @returns {Promise<this>} Promise to the updated document.\n   */\n  async createContainerContent(itemsData, options = { renderSheet: false }) {\n    itemsData = itemsData instanceof Array ? itemsData : [itemsData];\n\n    const itemOptions = foundry.utils.deepClone(options);\n    const user = game.user;\n\n    const actuallyCreated = [];\n    const updateData = { system: { items: {} } };\n\n    // Iterate over data to create\n    for (const itemData of itemsData) {\n      // Find unique ID\n      do {\n        itemData._id = foundry.utils.randomID(16);\n      } while (this.system.items[itemData._id] !== undefined);\n\n      // Create temporary item\n      const item = new Item.implementation(itemData);\n\n      // Run pre-create workflow\n      let allowed = (await item._preCreate(itemData, options, game.user)) ?? true;\n      allowed &&= options.noHook || Hooks.call(\"preCreateItem\", item, itemData, itemOptions, user.id);\n      if (allowed === false) {\n        console.debug(`FFD20 | Item creation prevented during pre-create`);\n        continue;\n      }\n\n      // Update _stats\n      item.updateSource({\n        _stats: {\n          coreVersion: game.version,\n          systemVersion: game.system.version,\n          createdTime: Date.now(),\n          lastModifiedBy: user.id,\n        },\n      });\n\n      updateData.system.items[itemData._id] = item.toObject();\n      actuallyCreated.push(itemData._id);\n    }\n\n    await this.update(updateData, { ffd20: { createContained: actuallyCreated } });\n\n    // Mimic createEmbeddedDocuments()\n    const created = this.items.filter((i) => actuallyCreated.includes(i.id));\n    if (options.renderSheet) created.forEach((i) => i.sheet.render(true));\n    return created;\n  }\n\n  async deleteContainerContent(data, context = {}) {\n    const ids = new Set(data instanceof Array ? data : [data]);\n\n    const embeddedName = \"ContainerContent\";\n    const user = game.user;\n\n    const updateData = { system: { items: {} } };\n\n    const actuallyDeleted = [];\n\n    // Iterate over data to delete\n    for (const id of ids) {\n      const item = this.items.get(id);\n\n      // Run pre-delete workflow\n      let allowed = (await item._preDelete(context, user)) ?? true;\n      allowed &&= context.noHook || Hooks.call(`preDelete${embeddedName}`, item, context, user.id);\n      if (allowed === false) {\n        console.debug(`FFD20 | ${embeddedName} deletion prevented during pre-delete`);\n        continue;\n      }\n\n      updateData.system.items[`-=${id}`] = null;\n      actuallyDeleted.push(id);\n    }\n\n    await this.update(updateData, { ffd20: { removeContained: actuallyDeleted } });\n  }\n\n  async updateContainerContents(data) {\n    data = data instanceof Array ? data : [data];\n\n    const embeddedName = \"ContainerContent\";\n    const user = game.user;\n    const options = { diff: true };\n\n    const actuallyUpdated = [];\n    const updateData = { system: { items: {} } };\n\n    // Difference each update against existing data\n    for (const changes of data) {\n      if (!changes._id) throw new Error(\"You must provide an id for every Embedded Document in an update operation\");\n\n      const item = this.items.get(changes._id);\n\n      let diff = {};\n      try {\n        diff = item.updateSource(changes, { dryRun: true, fallback: false });\n      } catch (err) {\n        console.error(err);\n        continue;\n      }\n\n      // Run pre-update workflow\n      let allowed = (await item._preUpdate(diff, options, user)) ?? true;\n      allowed &&= options.noHook || Hooks.call(`preUpdate${embeddedName}`, item, diff, options, user.id);\n      if (allowed === false) {\n        console.debug(`FFD20 | ${embeddedName} update prevented during pre-update`);\n        continue;\n      }\n\n      diff._stats = {\n        coreVersion: game.version,\n        systemVersion: game.system.version,\n        modifiedTime: Date.now(),\n        lastModifiedBy: user.id,\n      };\n\n      updateData.system.items[changes._id] = diff;\n      actuallyUpdated.push(changes._id);\n    }\n\n    await this.update(updateData, { ffd20: { updateContained: actuallyUpdated } });\n  }\n\n  /**\n   * Returns the currency this item contains\n   *\n   * @param {object} [options] - Additional options affecting how the value is returned\n   * @param {boolean} [options.inLowestDenomination=false] - Whether to return the value in copper, or in gold (default)\n   * @returns {number} The total amount of currency this item contains, in gold pieces\n   */\n  getTotalCurrency({ inLowestDenomination = false } = {}) {\n    const cc = ffd20.config.currency;\n\n    let total = 0;\n    for (let [unit, value] of Object.entries(this.system.currency || {})) {\n      value = Math.max(0, value || 0);\n      if (value == 0) continue;\n      total += value * (cc.rate[unit] || 1);\n    }\n\n    return inLowestDenomination ? total : total / cc.standardRate;\n  }\n\n  /**\n   * Converts currencies to the given currency type\n   *\n   * @param {CoinType} type - Converts as much currency as possible to this type.\n   * @returns {Promise<this>} The updated item\n   */\n  convertCurrency(type = \"pp\") {\n    const cp = this.getTotalCurrency({ inLowestDenomination: true });\n\n    const currency = ffd20.utils.currency.convert(cp, type, { pad: true });\n\n    return this.update({ system: { currency } });\n  }\n\n  /**\n   * @returns {number} Weight of coins on the item.\n   * @private\n   */\n  _calculateCoinWeight() {\n    const divisor = game.settings.get(\"ffd20\", \"coinWeight\");\n    if (!divisor) return 0;\n    return Object.values(this.system.currency || {}).reduce((total, coins) => total + (coins || 0), 0) / divisor;\n  }\n\n  /** @inheritDoc */\n  getValue({ recursive = false, inLowestDenomination = false, ...options } = {}) {\n    if (options.single) recursive = false;\n    const fullOptions = { recursive, inLowestDenomination, ...options };\n    let result = super.getValue(fullOptions);\n\n    if (!recursive) return result;\n\n    // Add item's contained currencies at full value\n    result += this.getTotalCurrency({ inLowestDenomination });\n\n    // Add item's content items' values\n    for (const item of this.items) {\n      result += item.getValue(fullOptions);\n    }\n\n    return result;\n  }\n\n  /** @inheritDoc */\n  async getChatData({ chatcard, rollData } = {}) {\n    const context = await super.getChatData({ chatcard, rollData });\n    // Get contents value\n    const cpValue =\n      this.getValue({ sellValue: 1, recursive: true, inLowestDenomination: true }) -\n      this.getValue({ sellValue: 1, recursive: false, inLowestDenomination: true });\n    const totalValue = ffd20.utils.currency.split(cpValue, { pad: true });\n    const value =\n      game.i18n.localize(\"FFD20.Containers.Contents.Value\") + \": \" + game.i18n.format(\"FFD20.SplitValue\", totalValue);\n    context.properties.push(value);\n    const currency = { ...this.system.currency };\n    currency.gp ||= 0;\n    currency.gp += currency.pp * 10;\n    const coins = game.i18n.localize(\"FFD20.Currency.Label\") + \": \" + game.i18n.format(\"FFD20.SplitValue\", currency);\n    context.properties.push(coins);\n\n    return context;\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n\n  /** @inheritDoc */\n  adjustContained() {\n    super.adjustContained();\n\n    this.system.carried = true;\n  }\n}\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Equipment item\n *\n * Armor, shields, wondrous items, etc.\n */\nexport class ItemEquipmentPF extends ItemPhysicalPF {\n  /** @inheritDoc */\n  static system = Object.freeze({ ...super.system, subtypeName: true });\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Set equipment subtype and slot\n    const type = changed.system?.subType;\n    if (type !== undefined && type !== this.system.subType) {\n      // Set subtype\n      const subtype = changed.system?.equipmentSubtype ?? this.system.equipmentSubtype ?? \"\";\n      const subtypes = Object.keys(ffd20.config.equipmentTypes[type] ?? {}).filter((o) => !o.startsWith(\"_\"));\n\n      // Current subtype is not valid for current type\n      if (!subtypes.includes(subtype)) {\n        // Clear if no subtypes exist\n        if (subtypes.length === 0) {\n          changed.system.equipmentSubtype = \"\";\n        }\n        // Set to first subtype if no valid subtype is set\n        else if (subtypes.length > 0) {\n          changed.system.equipmentSubtype = subtypes[0];\n        }\n      }\n      // Set slot\n      const slot = changed.system?.slot ?? this.system.slot ?? \"\";\n      const slotType = type === \"other\" ? \"wondrous\" : type; // Fix \"other\" item default slot type\n      const slotTypes = Object.keys(ffd20.config.equipmentSlots[slotType] ?? {});\n      if (!slot || !slotTypes.includes(slot)) {\n        changed.system.slot = slotTypes[0];\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n    const itemData = this.system;\n\n    let eType = this.subType;\n    const typeKeys = Object.keys(ffd20.config.equipmentTypes);\n    if (!typeKeys.includes(eType)) eType = typeKeys[0];\n\n    let eSubtype = this.system.equipmentSubtype;\n    const subtypeKeys = Object.keys(ffd20.config.equipmentTypes[eType]).filter((o) => !o.startsWith(\"_\"));\n    if (!subtypeKeys.includes(eSubtype)) eSubtype = subtypeKeys[0];\n\n    const showIdentified = !this.showUnidentifiedData;\n\n    const isArmor = [\"armor\", \"shield\"].includes(this.subType);\n    const isOrdinary = isArmor || [\"clothing\"].includes(this.subType);\n\n    const subtypeLabels = ffd20.config.equipmentTypes[eType];\n    labels.subType = subtypeLabels._label;\n    if (showIdentified || isOrdinary) {\n      labels.childType = subtypeLabels[eSubtype];\n    } else {\n      // Obfuscate wondrous as other\n      if (this.subType === \"wondrous\") labels.subType = ffd20.config.equipmentTypes.other._label;\n    }\n\n    if (isArmor && labels.childType) {\n      labels.childTypeDistinct = true;\n    }\n\n    let ac = itemData.armor.value || 0;\n    if (showIdentified) ac += itemData.armor?.enh || 0;\n\n    if (ac > 0) {\n      labels.armor = `${ac} ${game.i18n.localize(\"FFD20.ACNormal\")}`;\n      labels.armorValue = ac;\n      if (labels.broken) {\n        labels.armorValueEffective = Math.floor(ac / 2);\n      }\n    }\n\n    const acp = itemData.armor?.acp || 0;\n    if (acp > 0) {\n      labels.acp = true;\n      labels.acpEffective = Math.max(0, acp + (itemData.masterwork ? -1 : 0));\n    }\n    const mdex = itemData.armor?.dex ?? null;\n    if (Number.isFinite(mdex)) labels.mdex = true;\n\n    if (this.hasSlots || [\"armor\", \"shield\", \"materia\"].includes(this.subType)) {\n      if (this.subType === \"armor\") {\n        labels.slot = ffd20.config.equipmentSlots.armor.armor;\n      } else if (this.subType === \"shield\") {\n        labels.slot = ffd20.config.equipmentSlots.shield.shield;\n      } else if (this.subType === \"clothing\") {\n        labels.slot = ffd20.config.equipmentSlots.clothing.clothing;\n      } else if (this.subType === \"materia\") {\n        labels.slot = ffd20.config.equipmentSlots.materia[itemData.slot];\n        labels.slotted = ffd20.config.materia.Slot[itemData.slotted];\n        labels.materiaRarity = ffd20.config.materia.Rarity[itemData.materiaRarity];\n      } else {\n        labels.slot = ffd20.config.equipmentSlots.wondrous[itemData.slot];\n      }\n    }\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  get canEquip() {\n    // Always true if not in container\n    if (!this.inContainer) return true;\n\n    switch (this.subType) {\n      case \"armor\":\n      case \"shield\":\n      case \"clothing\":\n        return false;\n      case \"wondrous\":\n      case \"materia\":\n      case \"other\":\n        return this.system.slot === \"slotless\";\n    }\n    return true;\n  }\n\n  /** @override */\n  prepareDerivedData() {\n    super.prepareDerivedData();\n    const itemData = this.system;\n\n    // Add enhancement bonus\n    itemData.armor.enh ??= 0;\n\n    const enh = itemData.armor.enh || 0;\n    itemData.armor.total = (itemData.armor.value || 0) + enh;\n\n    // Feed info back to actor\n    if (itemData.equipped !== false) {\n      this.applyEquippedEffects();\n    }\n  }\n\n  /**\n   * Apply effects of equipping this item.\n   */\n  applyEquippedEffects() {\n    const itemData = this.system;\n\n    if (!this.isActive) return;\n\n    const actor = this.actor;\n    // Guard against weirdness with unlinked data (data is undefined at this state), and also basic test for if this item has actor.\n    if (!actor?.system || !actor?.equipment) return;\n\n    switch (this.subType) {\n      case \"shield\": {\n        const shieldTypes = ffd20.config.shieldTypes;\n        const subtype = itemData.equipmentSubtype;\n        let shieldType = actor.equipment.shield.type;\n        if (subtype === \"other\" && shieldType < shieldTypes.other) shieldType = shieldTypes.other;\n        else if (subtype === \"lightShield\" && shieldType < shieldTypes.light) shieldType = shieldTypes.light;\n        else if (subtype === \"heavyShield\" && shieldType < shieldTypes.heavy) shieldType = shieldTypes.heavy;\n        else if (subtype === \"towerShield\" && shieldType < shieldTypes.tower) shieldType = shieldTypes.tower;\n        if (actor.equipment.shield.type !== shieldType) {\n          actor.equipment.shield.type = shieldType;\n          actor.equipment.shield.id = this.id;\n        }\n        break;\n      }\n      case \"armor\": {\n        const armorTypes = ffd20.config.armorTypes;\n        const subtype = itemData.equipmentSubtype;\n        let armorType = actor.equipment.armor.type;\n        if (subtype === \"lightArmor\" && armorType < armorTypes.light) armorType = armorTypes.light;\n        else if (subtype === \"mediumArmor\" && armorType < armorTypes.medium) armorType = armorTypes.medium;\n        else if (subtype === \"heavyArmor\" && armorType < armorTypes.heavy) armorType = armorTypes.heavy;\n        if (armorType !== actor.equipment.armor.type) {\n          actor.equipment.armor.type = armorType;\n          actor.equipment.armor.id = this.id;\n        }\n        break;\n      }\n    }\n  }\n\n  /**\n   * Does the equipment subtype use slots.\n   *\n   * @type {boolean}\n   */\n  get hasSlots() {\n    return [\"wondrous\", \"other\", \"materia\"].includes(this.subType);\n  }\n\n  /**\n   * @inheritDoc\n   *\n   * @remarks Supports both weapon and armor proficiencies.\n   */\n  getProficiency(weapon = true) {\n    if (weapon) return this.isProficient;\n\n    const subType = this.subType;\n    if (![\"armor\", \"shield\"].includes(subType)) throw new Error(`\"${subType}\" does not support proficiency`);\n\n    const actor = this.actor;\n    if (!actor) return true; // No actor, so always proficient\n\n    return actor.hasArmorProficiency(this);\n  }\n\n  /**\n   * Retrieve armor proficiency type required by this item.\n   *\n   * @remarks\n   * - Null if no relevant proficiency found. Possibly an error.\n   *\n   * @type {keyof typeof ffd20.config.armorProficiencies | null}\n   * @throws - If used on item that is not an armor or a shield.\n   * @since PF1 v10\n   */\n  get baseArmorProficiency() {\n    const subType = this.subType;\n    if (![\"armor\", \"shield\"].includes(subType)) throw new Error(`\"${subType}\" does not support proficiency`);\n\n    // Item type to proficiency maps\n    const proficiencyMaps = {\n      armor: {\n        lightArmor: \"lgt\",\n        mediumArmor: \"med\",\n        heavyArmor: \"hvy\",\n      },\n      shield: {\n        other: \"shl\", // buckler\n        lightShield: \"shl\",\n        heavyShield: \"shl\",\n        towerShield: \"twr\",\n      },\n    };\n\n    return proficiencyMaps[subType][this.system.equipmentSubtype] ?? null;\n  }\n\n  /**\n   * @see {@link https://aonprd.com/Rules.aspx?Name=Armor%20for%20Unusual%20Creatures&Category=Armor}\n   *\n   * @inheritdoc\n   * @remarks - Only armor and shields get anything besides 1.\n   * @since PF1 v10\n   */\n  getWeightMultiplier() {\n    if (![\"armor\", \"shield\"].includes(this.subType)) return 1;\n\n    return this._getArmorWeightMultiplier();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  get isProficient() {\n    if (this.system.proficient) return true;\n    return this.actor?.hasWeaponProficiency?.(this) ?? true;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\n/**\n * Feature item\n *\n * Class features, feats, traits, templates, racial traits, etc.\n */\nexport class ItemFeatPF extends ItemPF {\n  /** @inheritDoc */\n  static system = Object.freeze({ ...super.system, subtypeName: true });\n\n  /**\n   * @internal\n   * @override\n   * @param {object} context - Context\n   * @param {User} userId - Triggering user ID\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    if (game.users.get(userId)?.isSelf) {\n      if (this.isActive) {\n        this.executeScriptCalls(\"toggle\", { state: false });\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  _activeStateChange(changed) {\n    const active = changed.system?.disabled;\n    if (active !== undefined) return !active;\n  }\n\n  /** @inheritDoc */\n  async setActive(active, context) {\n    return this.update({ \"system.disabled\": !active }, context);\n  }\n\n  /** @inheritDoc */\n  get isActive() {\n    return this.system.disabled !== true;\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n    const { subType, abilityType } = this.system;\n\n    labels.subType = ffd20.config.featTypes[subType];\n    labels.featType = ffd20.config.featTypes[subType];\n\n    labels.abilityType = ffd20.config.abilityTypes[this.system.abilityType]?.short;\n    if (this.subType === \"trait\") {\n      labels.traitType = ffd20.config.traitTypes[this.system.traitType];\n    } else if (this.subType === \"racial\") {\n      labels.raceType = ffd20.config.raceTypes[this.system.traitType];\n      labels.traitCategory = ffd20.config.racialTraitCategories[this.system.traitCategory];\n    }\n\n    // Ability type\n    if (abilityType && abilityType !== \"none\") {\n      labels.abilityType = ffd20.config.abilityTypes[abilityType].short;\n      labels.abilityTypeLong = ffd20.config.abilityTypes[abilityType].long;\n    } else if (labels.abilityType) {\n      delete labels.abilityType;\n    }\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  _addTypeRollData(result) {\n    // Add fake CL based on associated class level or HD\n    result.cl = result.class?.level || result.attributes?.hd?.total;\n  }\n\n  /** @inheritDoc */\n  getTypeChatData(data, labels, props, rollData) {\n    super.getTypeChatData(data, labels, props, rollData);\n    // Add ability type label\n    if (labels.abilityType) {\n      props.push(labels.abilityType);\n    }\n  }\n}\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Loot item\n *\n * Ammunition, gear, trade goods, etc.\n */\nexport class ItemLootPF extends ItemPhysicalPF {\n  /** @inheritDoc */\n  static system = Object.freeze({ ...super.system, subtypeName: true });\n\n  /** @type {string} */\n  get extraType() {\n    return this.system.extraType;\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Reset loot extra type when loot subtype is changed\n    if (\n      changed.system?.subType !== undefined &&\n      changed.system?.subType !== this.system.subType &&\n      changed.system?.extraType === undefined\n    ) {\n      changed.system.extraType = \"\";\n    }\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    if (!this.showUnidentifiedData) {\n      labels.subType = ffd20.config.lootTypes[this.subType];\n    }\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  get isActive() {\n    const hp = this.system.hp?.value || 0;\n    if (hp <= 0) return false; // Destroyed\n    if (this.system.quantity <= 0) return false;\n    if (ffd20.config.unequippableLoot.includes(this.subType)) return true;\n    return this.system.equipped ?? false;\n  }\n\n  /**\n   * Make ammo count inherently as single use.\n   *\n   * @inheritDoc\n   */\n  get isSingleUse() {\n    return this.subType === \"ammo\" || super.isSingleUse;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\n\n/**\n * Race item\n */\nexport class ItemRacePF extends ItemPF {\n  /**\n   * @override\n   */\n  static system = Object.freeze({\n    ...super.system,\n    hasIdentifier: false,\n    hasActions: false,\n  });\n\n  /**\n   * @internal\n   * @override\n   * @param {object} data - Creation data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    const actor = this.actor;\n    if (!actor) return;\n\n    // Overwrite race\n    const oldRace = actor.itemTypes.race.find((r) => r !== this);\n    if (oldRace) {\n      const oldSize = oldRace.system.size;\n      await oldRace.delete();\n\n      const context = {};\n      // Ensure actor size is updated to match the race, but only if it's same as old race\n      const actorSize = actor.system.traits.size;\n      if (actorSize !== this.system.size && oldSize === actorSize) context._pf1SizeChanged = true;\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    const actor = this.actor;\n\n    // Track size change\n    const newSize = changed.system?.size;\n    if (actor && newSize !== undefined) {\n      const oldSize = actor.system.traits?.size?.base;\n      if (this.system.size === oldSize && newSize !== oldSize) {\n        context._pf1SizeChanged = true;\n      }\n    }\n  }\n\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    // Add humanoid if the race has nothing\n    if (this.system.creatureTypes?.total?.size === 0) {\n      this.system.creatureTypes.standard.add(\"humanoid\");\n    }\n  }\n\n  /**\n   * @remarks This item type can not be recharged.\n   * @override\n   */\n  recharge() {\n    return;\n  }\n}\n","import { ItemPF } from \"./item-pf.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\nimport { renderCachedTemplate } from \"@utils/handlebars/templates.mjs\";\n\n/**\n * Spell item\n */\nexport class ItemSpellPF extends ItemPF {\n  /**\n   * @override\n   * @inheritDoc\n   */\n  static system = Object.freeze({\n    ...super.system,\n    hasIdentifier: false,\n    hasChanges: false,\n  });\n\n  /**\n   * @internal\n   * @override\n   * @param {object} data Creation data\n   * @param {object} options Context options\n   * @param {User} user Triggering user\n   */\n  async _preCreate(data, options, user) {\n    await super._preCreate(data, options, user);\n\n    // Following is only if the item is added on actor\n    if (!this.actor) return;\n\n    this.constructor._adjustNewItem(this, data, false);\n  }\n\n  /** @inheritDoc */\n  static _adjustNewItem(item, data, override = false) {\n    if (!item.actor) return;\n\n    // Assign level if undefined\n    if (!Number.isFinite(data?.system?.level) || override) {\n      const book = item.system.spellbook;\n      const cls = item.actor.system.attributes?.spells?.spellbooks?.[book]?.class;\n      const level = item.system.learnedAt?.class?.[cls];\n      if (Number.isFinite(level)) {\n        foundry.utils.setProperty(item._source, \"system.level\", Math.clamp(level, 0, 9));\n      }\n    }\n\n    // Prepare if undefined\n    if (!Number.isFinite(data?.system?.preparation?.value) || override) {\n      // Only spontaneous casters auto-prepare new spells\n      if (item.spellbook?.spellPreparationMode === \"spontaneous\") {\n        foundry.utils.setProperty(item._source, \"system.preparation.value\", 1);\n        foundry.utils.setProperty(item._source, \"system.preparation.max\", 1);\n      }\n    }\n\n    // Swap non-psychic components for psychic ones\n    if (this.spellbook?.psychic === true) {\n      if (this.system.components?.verbal === true) {\n        foundry.utils.setProperty(item._source, \"components.verbal\", false);\n        foundry.utils.setProperty(item._source, \"components.thought\", true);\n      }\n      if (this.system.components?.somatic === true) {\n        foundry.utils.setProperty(item._source, \"components.somatic\", false);\n        foundry.utils.setProperty(item._source, \"components.emotion\", true);\n      }\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    this._preparationPreUpdate(changed);\n  }\n\n  /**\n   * Constrains and alters prepared slot updates to result in meaningful end results.\n   *\n   * @private\n   * @param {object} changed Change data in pre-update\n   */\n  _preparationPreUpdate(changed) {\n    const prep = changed.system.preparation;\n    if (!prep) return;\n\n    const current = this.system.preparation;\n    const max = prep.max ?? current.max ?? 0;\n    const left = prep.value ?? current.value ?? 0;\n\n    // Constrain left and max to sane values\n    if (left > max) {\n      if (prep.max !== undefined) {\n        prep.value = max;\n      } else if (prep.value !== undefined) {\n        prep.max = left;\n      }\n    }\n\n    // TODO: Remove following once DataModel is implemented with relevant constraints\n    if (prep.max < 0) prep.max = 0;\n    if (prep.value < 0) prep.value = 0;\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData, isolated } = {}) {\n    const labels = super.getLabels({ actionId, rollData, isolated });\n    const itemData = this.system;\n\n    // Spell Level, School, and Components\n    labels.level = ffd20.config.spellLevels[itemData.level];\n    labels.school = ffd20.config.spellSchools[itemData.school];\n    labels.components = this.getSpellComponents({ compact: true }).join(\" \");\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  _addTypeRollData(result) {\n    result.sl = this.spellLevel || 0;\n\n    const spellbook = this.spellbook;\n    if (spellbook) {\n      const spellAbility = spellbook.ability;\n      let ablMod = \"\";\n      if (spellAbility !== \"\") ablMod = result.abilities?.[spellAbility]?.mod;\n      result.ablMod = ablMod;\n\n      result.cl = this.casterLevel || 0;\n\n      // Add @class shortcut to @classes[classTag]\n      if (spellbook.class === \"_hd\")\n        result.class = { level: result.attributes.hd?.total ?? result.details?.level?.value ?? 0 };\n      else result.class = result.classes?.[spellbook.class] ?? {};\n\n      // Add @spellbook shortcut to @spells[bookId]\n      result.spellbook = result.spells[this.system.spellbook];\n\n      if (this.useSpellPoints()) {\n        result.sp = result.spellbook.spellPoints;\n      }\n    } else {\n      const [sl, cl] = this.constructor.getMinimumCasterLevelBySpellData(this);\n\n      result.sl = sl;\n      result.cl = cl;\n      result.ablMod = Math.floor(sl / 2);\n    }\n  }\n\n  /** @inheritDoc */\n  getConditionalTargets(targets) {\n    super.getConditionalTargets(targets);\n\n    // Add Caster Level target\n    targets.push({\n      id: \"cl\",\n      label: game.i18n.localize(\"FFD20.CasterLevel\"),\n      simple: true,\n      sort: (targets.find((e) => e.id === \"dc\").sort ?? 5_000) + 100, // Sort after DC\n    });\n\n    const charges = targets.find((t) => t.id === \"charges\");\n\n    // Relabel for spellpoints\n    if (this.useSpellPoints()) charges.label = game.i18n.localize(\"FFD20.SpellPointsCost\");\n    else charges.disabled = true; // Non-spellpoint spells do not use charges\n  }\n\n  /** @inheritDoc */\n  getTypeChatData(data, labels, props, rollData) {\n    if (rollData.item.sr) {\n      props.push(game.i18n.localize(\"FFD20.SpellResistance\"));\n    }\n\n    // Add charges\n    if (this.isCharged && !this.system.atWill) {\n      if (this.useSpellPoints()) {\n        props.push(`${game.i18n.localize(\"FFD20.SpellPoints\")}: ${this.charges}/${this.maxCharges}`);\n      } else {\n        props.push(`${game.i18n.localize(\"FFD20.ChargePlural\")}: ${this.charges}/${this.maxCharges}`);\n      }\n    }\n  }\n\n  /**\n   * Add charges to the spell or its relevant resource pool (spell points or spontaneous spells).\n   *\n   * @override\n   * @param {number} value - Number of charges to add\n   * @param {object} [data=null] - Additional data to pass to the update\n   * @returns {Promise<this | void>} Updated document or undefined if no update is possible or required.\n   */\n  async addCharges(value, data = null) {\n    if (!this.actor) return;\n    if (this.system.atWill) return;\n\n    const spellbook = this.spellbook;\n    if (!spellbook) return;\n    const isSpontaneous = spellbook.spontaneous,\n      spellbookKey = this.system.spellbook || \"primary\",\n      spellLevel = this.system.level;\n\n    if (this.useSpellPoints()) {\n      const curUses = this.getSpellUses();\n      const updateData = {};\n      const tempMP = foundry.utils.getProperty(this.actor, \"system.attributes.mp.temp\");\n      const curMP = foundry.utils.getProperty(this.actor, \"system.attributes.mp.value\");\n\n      // check for temp mp\n      // if temp mp is 0 do normal\n      // else check if temp mp is greater then spell cost\n      // if so deduct from temp\n      // else deduct from temp and then from normal\n      if (tempMP === 0) {\n        updateData[\"system.attributes.mp.value\"] = curUses + value;\n        await this.actor.update(updateData);\n      } else {\n        if (tempMP >= value * -1) {\n          updateData[\"system.attributes.mp.temp\"] = tempMP + value;\n          await this.actor.update(updateData);\n        } else {\n          const leftMP = tempMP + value;\n          updateData[\"system.attributes.mp.temp\"] = 0;\n          updateData[\"system.attributes.mp.value\"] = curMP + leftMP;\n          await this.actor.update(updateData);\n        }\n      }\n      return this;\n    } else {\n      const newCharges = isSpontaneous\n        ? Math.max(0, (spellbook.spells?.[`spell${spellLevel}`]?.value || 0) + value)\n        : Math.max(0, (this.system.preparation?.value || 0) + value);\n\n      if (!isSpontaneous) {\n        const key = \"system.preparation.value\";\n        if (data == null) {\n          data = {};\n          data[key] = newCharges;\n          return this.update(data);\n        } else {\n          data[key] = newCharges;\n        }\n      } else {\n        const key = `system.attributes.spells.spellbooks.${spellbookKey}.spells.spell${spellLevel}.value`;\n        const actorUpdateData = {};\n        actorUpdateData[key] = newCharges;\n        await this.actor.update(actorUpdateData);\n        return this;\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  get isCharged() {\n    if (this.system.atWill) return false;\n    return true;\n  }\n\n  /** @inheritdoc */\n  get hasFiniteCharges() {\n    if (this.system.atWill) return false;\n    return this.getDefaultChargeCost() > 0;\n  }\n\n  /** @inheritDoc */\n  get charges() {\n    return this.getSpellUses();\n  }\n\n  /** @inheritDoc */\n  get maxCharges() {\n    return this.getSpellUses(true);\n  }\n\n  /**\n   * Get default charge cost for spell actions.\n   *\n   * @param {object} [options] - Additional options\n   * @param {object} [options.rollData] - Roll data instance\n   * @returns {number} - Default cost.\n   */\n  getDefaultChargeCost({ rollData } = {}) {\n    if (this.system.atWill) return 0;\n\n    if (this.useSpellPoints()) {\n      rollData ??= this.getRollData();\n      const formula = this.getDefaultChargeFormula();\n      return RollPF.safeRollSync(formula, rollData).total;\n    } else {\n      return super.getDefaultChargeCost({ rollData });\n    }\n  }\n\n  /** @inheritDoc */\n  getDefaultChargeFormula() {\n    if (this.useSpellPoints()) {\n      return this.system.spellPoints?.cost || game.settings.get(\"ffd20\", \"spellPointCost\") || \"0\";\n    } else {\n      return super.getDefaultChargeFormula();\n    }\n  }\n\n  /**\n   * @remarks\n   * - Recharging individual spells for spell point, spontaneous, or hybrid spellbooks has no effect.\n   * @override\n   * @inheritDoc\n   */\n  // eslint-disable-next-line no-unused-vars\n  async recharge({ value, period = \"day\", exact = false, maximize = true, commit = true, rollData, context } = {}) {\n    const spellbook = this.spellbook,\n      mode = spellbook?.spellPreparationMode || \"prepared\";\n\n    // Can not recharge non-prepared spellbooks\n    if (mode !== \"prepared\") return;\n\n    // Spellpoints are not on spells\n    if (spellbook?.spellPoints?.useSystem ?? false) return;\n\n    if (period == \"week\") {\n      // Spells do not recharge per week\n      if (exact) return;\n      // When not recharging with exact period, downgrade to \"day\" which is normal spell restoration period\n      period = \"day\";\n    }\n\n    // Spells do not restore on non-day period\n    if (![\"day\", \"any\"].includes(period)) return;\n\n    const prep = this.system.preparation ?? {};\n\n    // No specific value given\n    maximize = !(Number.isFinite(value) && value >= 0);\n\n    // Set value\n    if (maximize) value = prep.max || 0;\n    // Clamp charge value\n    value = Math.clamp(value, 0, prep.max || 0);\n\n    // Cancel pointless or bad update\n    if (value === (prep.value || 0) || !Number.isFinite(value)) return;\n\n    const updateData = { system: { preparation: { value } } };\n\n    if (commit) return this.update(updateData, context);\n    return updateData;\n  }\n\n  /**\n   * Effective spell level\n   *\n   * @remarks\n   * - Accounts for offset\n   *\n   * @type {number}\n   */\n  get spellLevel() {\n    return this.system.level + (this.system.slOffset || 0);\n  }\n\n  /**\n   * Effective caster level\n   *\n   * @remarks\n   * - Accounts for offset\n   * - Returns null if not linked to a valid spellbook.\n   *\n   * @type {number|null}\n   */\n  get casterLevel() {\n    const spellbook = this.spellbook;\n    if (!spellbook) return null;\n\n    return spellbook.cl.total + (this.system.clOffset || 0);\n  }\n\n  /**\n   * Linked spellbook\n   *\n   * @type {object|undefined}\n   */\n  get spellbook() {\n    const bookId = this.system.spellbook;\n    return this.actor?.system.attributes?.spells.spellbooks[bookId];\n  }\n\n  /**\n   * Number of remaining uses, or max.\n   *\n   * @param {boolean} max - Return max uses.\n   * @returns {number} - Uses\n   */\n  getSpellUses(max = false) {\n    const itemData = this.system;\n    if (itemData.atWill) return Number.POSITIVE_INFINITY;\n\n    const spellbook = this.spellbook;\n\n    const isSpontaneous = spellbook?.spontaneous ?? false,\n      spellLevel = itemData.level;\n\n    const maxPrepared = itemData.preparation?.max ?? 0,\n      prepared = itemData.preparation?.value ?? 0;\n\n    // added for temp mp\n    if (this.useSpellPoints()) {\n      if (prepared > 0) {\n        if (max) return this.actor.system.attributes.mp.max;\n      return this.actor.system.attributes.mp.value + this.actor.system.attributes.mp.temp;\n      }\n    } else if (isSpontaneous) {\n      if (prepared > 0) {\n        if (max) return Math.max(spellbook.spells?.[`spell${spellLevel}`]?.max || 0, prepared);\n        return spellbook.spells?.[`spell${spellLevel}`]?.value || 0;\n      }\n    } else {\n      if (max) return maxPrepared;\n      return prepared;\n    }\n\n    return 0;\n  }\n\n  /** @returns {boolean} - Whether the attached spellbok uses spell points */\n  useSpellPoints() {\n    return this.spellbook?.spellPoints?.useSystem ?? false;\n  }\n\n  /**\n   * Spell components\n   *\n   * @example\n   * Example with Discern Lies on Cleric\n   * ```js\n   * spell.getSpellComponents(); // => [\"V\", \"S\", \"M/DF\"]\n   * ```\n   * Same with compacted components\n   * ```js\n   * spell.getSpellComponents({compact:true}); // => [\"V\",\"S\", \"DF\"]\n   * ```\n   *\n   * @param {object} options - Additional options\n   * @param {boolean} [options.compact] - Remove redundant components (e.g. M/DF becomes DF for divine caster)\n   * @returns {string[]} - Component keys\n   */\n  getSpellComponents({ compact = false } = {}) {\n    const reSplit = ffd20.config.re.traitSeparator,\n      srcComponents = this.system.components ?? {},\n      srcMaterials = this.system.materials ?? {};\n\n    const kind = this.spellbook?.kind,\n      //isArcane = kind === \"arcane\",\n      //isPsychic = kind === \"psychic\",\n      //isAlchemical = kind === \"alchemy\",\n      isDivine = kind === \"divine\";\n\n    const components = [];\n    const labels = ffd20.config.spellComponents;\n\n    if (srcComponents.verbal) components.push(labels.verbal);\n    if (srcComponents.somatic) components.push(labels.somatic);\n    if (srcComponents.thought) components.push(labels.thought);\n    if (srcComponents.emotion) components.push(labels.emotion);\n\n    // Reverse mapping of ffd20.config.divineFocus for readability\n    const dfVariants = { DF: 1, MDF: 2, FDF: 3 };\n\n    let df = srcComponents.divineFocus;\n\n    // Display focus and material only if they aren't overridden by DF variant\n    if (isDivine && df === dfVariants.MDF && compact) {\n      // Downgrade to DF since material is not used\n      df = dfVariants.DF;\n    } else if (srcComponents.material) {\n      let material = labels.material;\n      // Display indeterminate M/DF only if spellcasting kind is not known\n      if ((!kind || !compact) && df === dfVariants.MDF) material = `${material}/${labels.divineFocus}`;\n      if (srcMaterials.value && !compact) material = `${material} (${srcMaterials.value})`;\n      if (material) components.push(material);\n    }\n\n    if (isDivine && df === dfVariants.FDF && compact) {\n      // Downgrade to DF since focus is not used\n      df = dfVariants.DF;\n    } else if (srcComponents.focus) {\n      let focus = labels.focus;\n      // Display indeterminate F/DF only if spellcasting kind is not known\n      if ((!kind || !compact) && df === dfVariants.FDF) focus = `${focus}/${labels.divineFocus}`;\n      if (srcMaterials.focus && !compact) focus = `${focus} (${srcMaterials.focus})`;\n      if (focus) components.push(focus);\n    }\n\n    if (df === dfVariants.DF) components.push(labels.divineFocus);\n    if (labels.value) components.push(...srcComponents.value.split(reSplit));\n\n    return components;\n  }\n\n  /**\n   * @param {object} itemData - A spell item's data.\n   * @returns {[number,number]} - A tuple containing the spell level and caster level in order.\n   */\n  static getMinimumCasterLevelBySpellData(itemData) {\n    const learnedAt = Object.entries(itemData.system.learnedAt?.class ?? {})?.reduce((cur, [classId, level]) => {\n      const classes = classId.split(\"/\");\n      for (const cls of classes) cur.push([cls, level]);\n      return cur;\n    }, []);\n    const result = [9, 20];\n    for (const [classId, level] of learnedAt) {\n      result[0] = Math.min(result[0], level);\n\n      const tc = ffd20.config.classCasterType[classId] || \"high\";\n      if (tc === \"high\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level - 1) * 2);\n      } else if (tc === \"med\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level - 1) * 3);\n      } else if (tc === \"low\") {\n        result[1] = Math.min(result[1], 1 + Math.max(0, level) * 3);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Used in consumable creation\n   *\n   * @internal\n   * @param {string} string - String to convert\n   * @param {object} rollData - Roll data instance\n   * @returns {string} - Converted string\n   */\n  static _replaceConsumableConversionString(string, rollData) {\n    return string\n      .replace(/@sl/g, `${rollData.sl}[${game.i18n.localize(\"FFD20.SpellLevel\")}]`)\n      .replace(/@cl/g, \"@item.cl\")\n      .replace(/@ablMod/g, `${rollData.ablMod}[${game.i18n.localize(\"FFD20.AbilityScore\")}]`);\n  }\n\n  /**\n   * Convert spell into a consumable item.\n   *\n   * @param {object} origData - Spell item data\n   * @param {\"wand\"|\"scroll\"|\"potion\"} type - Consumable type\n   * @param {object} [options] - Additional options\n   * @param {string} [options.spellType=\"arcane\"] - Spell type\n   * @returns {Promise<object|null>} - Item data for appropriate consumable, or null if dialog option was used and it was cancelled.\n   */\n  static async toConsumable(origData, type, { spellType = \"arcane\" } = {}) {\n    const isWand = type === \"wand\",\n      isPotion = type === \"potion\",\n      isScroll = type === \"scroll\";\n\n    const [minLevel, minCl] = this.getMinimumCasterLevelBySpellData(origData);\n    const level = origData.sl ?? minLevel ?? 1;\n    const cl = origData.cl ?? minCl ?? 1;\n    const materialPrice = origData.system.materials?.gpValue ?? 0;\n\n    const itemData = {\n      type: \"consumable\",\n      name: origData.name,\n      system: {\n        subType: type,\n        spellType: origData.spellType || spellType,\n        description: {},\n        identified: origData.identified ?? true,\n        unidentified: {\n          name: origData.unidentifiedName || game.i18n.localize(`FFD20.CreateItem${type.capitalize()}`),\n        },\n        cl, // Caster level\n        aura: { school: origData.system.school },\n        uses: { per: \"single\" },\n        price: 0,\n        hardness: 0,\n        hp: { value: 1, max: 1 },\n        actions: origData.system.actions ?? [],\n        sources: origData.system.sources ?? [],\n      },\n    };\n\n    // Add basic item type source as source for the consumable\n    const extraSources = {\n      wand: { id: \"PZO1110\", pages: \"496\" },\n      scroll: { id: \"PZO1110\", pages: \"490-491\" },\n      potion: { id: \"PZO1110\", pages: \"477-478\" },\n    };\n    const xsrc = extraSources[type];\n    if (xsrc) {\n      const osrc = itemData.system.sources.find((s) => s.id == xsrc.id);\n      if (osrc) {\n        // Merge pages when same source already exists\n        if (osrc.pages) osrc.pages += `, ${xsrc.pages}`;\n        else osrc.pages = xsrc.pages;\n      } else {\n        itemData.system.sources.push(xsrc);\n      }\n    }\n\n    // Initialize default action\n    if (itemData.system.actions.length == 0) itemData.system.actions.push(defaultAction);\n    const defaultAction = itemData.system.actions[0] ?? ffd20.components.ItemAction({}, { parent: this }).toObject();\n    defaultAction.range ??= {};\n\n    // Prepare new action copying over with old data if present\n\n    // Override activation as required by consumables\n    defaultAction.activation.type = \"standard\";\n    defaultAction.activation.unchained.type = \"action\";\n    defaultAction.activation.unchained.cost = 2;\n\n    // Fill in pseudo roll data object\n    const rollData = {\n      item: origData.system,\n      ablMod: Math.floor(level / 2), // Minimum usable ability modifier\n      sl: level,\n      cl,\n    };\n\n    if (isWand) {\n      itemData.name = game.i18n.format(\"FFD20.CreateItemWandOf\", { name: origData.name });\n      defaultAction.name = game.i18n.localize(\"FFD20.Use\");\n      itemData.img = \"systems/ffd20/icons/items/inventory/wand-star.jpg\";\n      itemData.system.uses.pricePerUse =\n        Math.floor(((Math.max(0.5, level) * cl * 750) / 50) * 100) / 100 + materialPrice;\n      itemData.system.hardness = 5;\n      itemData.system.hp.max = 5;\n      itemData.system.hp.value = 5;\n      // Set charges\n      itemData.system.uses.maxFormula = \"50\";\n      itemData.system.uses.value = 50;\n      itemData.system.uses.max = 50;\n      itemData.system.uses.per = \"charges\";\n    } else if (isPotion) {\n      itemData.name = game.i18n.format(\"FFD20.CreateItemPotionOf\", { name: origData.name });\n      defaultAction.name = game.i18n.localize(\"FFD20.Drink\");\n      itemData.img = \"systems/ffd20/icons/items/potions/minor-blue.jpg\";\n      itemData.system.price = Math.max(0.5, level) * cl * 50 + materialPrice;\n      itemData.system.hardness = 1;\n    } else if (isScroll) {\n      itemData.name = game.i18n.format(\"FFD20.CreateItemScrollOf\", { name: origData.name });\n      defaultAction.name = game.i18n.localize(\"FFD20.Use\");\n      itemData.img = \"systems/ffd20/icons/items/inventory/scroll-magic.jpg\";\n      itemData.system.price = Math.max(0.5, level) * cl * 25 + materialPrice;\n    }\n\n    const convertNotes = (data, keys = []) => {\n      if (!data) return;\n\n      // Replace attack and effect formula data\n      for (const arrKey of keys) {\n        const arr = data[arrKey];\n        if (!arr) continue;\n        for (let idx = 0; idx < arr.length; idx++) {\n          arr[idx] = this._replaceConsumableConversionString(arr[idx], rollData);\n        }\n      }\n    };\n\n    // Adjust all actions\n    for (const action of itemData.system.actions) {\n      // Convert ranges\n      // Special handling for potions\n      if (isPotion && defaultAction === action) {\n        // BUG: This is wrong for oils\n        action.range.units = \"personal\";\n        delete action.range.value;\n      }\n\n      // Convert template\n      if (action.measureTemplate?.type) {\n        action.measureTemplate.size = this._replaceConsumableConversionString(action.measureTemplate.size, rollData);\n      }\n\n      // Convert extra attacks\n      const exAtk = action.extraAttacks;\n      if (exAtk) {\n        if (exAtk.formula?.count?.length)\n          exAtk.formula.count = this._replaceConsumableConversionString(exAtk.formula.count, rollData);\n        if (exAtk.formula?.bonus?.length)\n          exAtk.formula.bonus = this._replaceConsumableConversionString(exAtk.formula.bonus, rollData);\n\n        for (const bAtk of exAtk.manual ?? []) {\n          bAtk.formula = this._replaceConsumableConversionString(bAtk.formula, rollData);\n        }\n      }\n\n      // Set damage formula\n      for (const dmgPart of action.damage?.parts ?? []) {\n        dmgPart.formula = this._replaceConsumableConversionString(dmgPart.formula, rollData);\n      }\n\n      // Set save\n      if (action.save?.type) {\n        const oldSaveDC = action.save.dc;\n        action.save.dc = `10 + ${origData.sl}[${game.i18n.localize(\"FFD20.SpellLevel\")}] + ${Math.floor(\n          origData.sl / 2\n        )}[${game.i18n.localize(\"FFD20.SpellcastingAbility\")}]`;\n        // Add DC offset\n        if (oldSaveDC?.length) action.save.dc += ` + (${oldSaveDC})[${game.i18n.localize(\"FFD20.DCOffset\")}]`;\n      }\n\n      convertNotes(action.notes, [\"effect\", \"footer\"]);\n    }\n\n    convertNotes(itemData.system, [\"attackNotes\", \"effectNotes\"]);\n\n    // Set description\n    const spell = new Item.implementation(origData);\n    spell.reset();\n    // TODO: Make range and duration appear as inline rolls that scale on item CL?\n    const desc = await spell.getDescription({ charcard: false, header: true, body: true, rollData });\n    itemData.system.description.value = this._replaceConsumableConversionString(desc, rollData);\n\n    // Create and return synthetic item data\n    return new ItemPF(foundry.utils.expandObject(itemData)).toObject();\n  }\n\n  /**\n   * Open Consumable conversion dialog.\n   *\n   * Automatically calls {@link this.toConsumable} as appropriate.\n   *\n   * @param {object} itemData - Spell item data\n   * @param {object} [options] - Additional options\n   * @param {boolean} [options.allowSpell=true] - Allow spell creation\n   * @param {string} [options.spellType=\"arcane\"] - Spell type\n   * @param {object} [options.actor=undefined] - The actor the consumable is being created on.\n   * @returns {Promise<null|false|object>} - Returns null if cancelled, false if no conversion is to take place, or converted data.\n   */\n  static async toConsumablePrompt(itemData, { allowSpell = true, spellType = \"arcane\", actor = undefined } = {}) {\n    const [sl, cl] = CONFIG.Item.documentClasses.spell.getMinimumCasterLevelBySpellData(itemData);\n\n    const getFormData = (html) => {\n      const formData = foundry.utils.expandObject(new FormDataExtended(html.querySelector(\"form\")).object);\n      foundry.utils.mergeObject(itemData, formData);\n      // NaN check here to allow SL 0\n      if (Number.isNaN(itemData.sl)) itemData.sl = 1;\n      return itemData;\n    };\n\n    const createConsumable = (data, type) => this.toConsumable(data, type, { spellType: data.spellType });\n\n    const buttons = [\n      {\n        icon: \"fa-solid fa-prescription-bottle\",\n        label: game.i18n.localize(\"FFD20.CreateItemPotion\"),\n        action: \"potion\",\n        default: true,\n        callback: (event, target, html) => createConsumable(getFormData(html), \"potion\"),\n      },\n      {\n        icon: \"fa-solid fa-scroll\",\n        label: game.i18n.localize(\"FFD20.CreateItemScroll\"),\n        action: \"scroll\",\n        callback: (event, target, html) => createConsumable(getFormData(html), \"scroll\"),\n      },\n      {\n        icon: \"fa-solid fa-magic\",\n        label: game.i18n.localize(\"FFD20.CreateItemWand\"),\n        action: \"wand\",\n        callback: (event, target, html) => createConsumable(getFormData(html), \"wand\"),\n      },\n    ];\n\n    if (allowSpell) {\n      buttons.push({\n        icon: \"fa-solid fa-hand-sparkles\",\n        label: game.i18n.localize(\"TYPES.Item.spell\"),\n        action: \"spell\",\n        callback: () => false,\n      });\n    }\n\n    const fields = foundry.data.fields;\n\n    return foundry.applications.api.DialogV2.wait({\n      window: { title: game.i18n.format(\"FFD20.CreateItemForSpell\", { name: itemData.name }) },\n      position: {\n        width: \"auto\",\n        height: \"auto\",\n      },\n      classes: [\"pf1-v2\", \"create-consumable\"],\n      content: await renderTemplate(\"systems/ffd20/templates/internal/create-consumable.hbs\", {\n        name: itemData.name,\n        sl,\n        cl,\n        isGM: game.user.isGM,\n        spellType,\n        fields: {\n          sl: new fields.NumberField({ min: 0, integer: true }),\n          cl: new fields.NumberField({ min: 1, integer: true }),\n          spellType: new fields.StringField({ choices: ffd20.config.spellcasting.spells }),\n          identified: new fields.BooleanField({ initial: actor?.type === \"character\" }),\n          unidentifiedName: new fields.StringField(),\n        },\n        // We assume every other check done at `ActorSheetPF._alterDropItemData` has passed\n        isNPC: actor?.type === \"npc\",\n      }),\n      itemData,\n      buttons,\n      close: () => null,\n      rejectClose: false,\n    });\n  }\n\n  /**\n   * @remarks\n   * Checks for at-will and preparation status.\n   * @inheritDoc\n   */\n  get canUse() {\n    if (this.system.atWill) return true;\n\n    return (this.system.preparation?.value ?? 0) > 0;\n  }\n\n  /**\n   * Determine if this spell is domain/school spell.\n   *\n   * @type {boolean}\n   */\n  get isDomain() {\n    return this.system.domain === true;\n  }\n\n  /** @inheritDoc */\n  async getDescription({ chatcard = false, data = {}, rollData, header = true, body = true, isolated = false } = {}) {\n    const headerContent = header\n      ? renderCachedTemplate(\"systems/ffd20/templates/items/headers/spell-header.hbs\", {\n          ...data,\n          ...(await this.getDescriptionData({ rollData, isolated })),\n          chatcard: chatcard === true,\n        })\n      : \"\";\n\n    let bodyContent = \"\";\n    if (body) {\n      const noDesc = \"<p class='placeholder'>\" + game.i18n.localize(\"FFD20.NoDescription\") + \"</p>\";\n      bodyContent = `<div class=\"description-body\">` + (this.system.description.value || noDesc) + \"</div>\";\n    }\n\n    let separator = \"\";\n    if (header && body) separator = `<h3 class=\"description-header\">${game.i18n.localize(\"FFD20.Description\")}</h3>`;\n\n    return headerContent + separator + bodyContent;\n  }\n\n  /** @inheritDoc */\n  async getDescriptionData({ rollData, isolated = false } = {}) {\n    const result = await super.getDescriptionData({ rollData, isolated });\n\n    const system = this.system;\n    result.system = system;\n\n    const defaultAction = this.defaultAction;\n    const action = defaultAction ?? {};\n\n    rollData ??= defaultAction?.getRollData() ?? this.getRollData();\n\n    const labels = this.getLabels({ rollData, isolated });\n    result.labels = labels;\n\n    labels.school = ffd20.config.spellSchools[system.school];\n    labels.multischool = ffd20.utils.i18n.join([...(system.multischool.names ?? [])]);\n    labels.subschool = ffd20.utils.i18n.join([...(system.subschool.names ?? [])]);\n    labels.descriptors = ffd20.utils.i18n.join([...(system.descriptors.names ?? [])], \"conjunction\", false);\n\n    // Set information about when the spell is learned\n    result.learnedAt = {};\n    if (system.learnedAt) {\n      const classNames = await ffd20.utils.packs.getClassIDMap();\n      for (const category of [\"class\", \"domain\"]) {\n        result.learnedAt[category] = ffd20.utils.i18n.join(\n          Object.entries(system.learnedAt[category]).map(\n            ([classId, level]) => `${classNames[classId] || classId} ${level}`\n          )\n        );\n      }\n    }\n\n    // Set components label\n    labels.components = ffd20.utils.i18n.join(this.getSpellComponents());\n\n    // Set effect label\n    const effect = action.effect;\n    if (effect) labels.effect = effect;\n\n    // Set DC and SR\n    {\n      const savingThrowDescription = action.save?.description;\n      labels.savingThrow = savingThrowDescription || game.i18n.localize(\"FFD20.None\");\n\n      const sr = system.sr;\n      labels.sr = (sr === true ? game.i18n.localize(\"FFD20.Yes\") : game.i18n.localize(\"FFD20.No\")).toLowerCase();\n\n      if (action.range?.units !== \"personal\") result.useDCandSR = true;\n    }\n\n    const harmless = action.save?.harmless ?? false;\n    if (harmless) labels.harmless = game.i18n.localize(\"FFD20.Yes\").toLowerCase();\n\n    return result;\n  }\n\n  /**\n   * Number of slots the spell takes to prepare.\n   *\n   * Quick access to .system.slotCost with additional considerations such as at-will toggle.\n   *\n   * Defaults to 1 if the data is not present, 0 if the spell is at-will.\n   *\n   * @type {number}\n   */\n  get slotCost() {\n    if (this.system.atWill) return 0;\n    return this.system.slotCost ?? 1;\n  }\n\n  /**\n   * Concentration DC\n   *\n   * @param {string} type - Type of concentration check\n   * @param {object} [options] - Additional options\n   * @throws {Error} - If type is invalid\n   * @returns {number} - DC\n   */\n  getConcentrationDC(type = \"defensive\", options = {}) {\n    const level = this.system.level || 0;\n    switch (type) {\n      // Defensive Casting\n      case \"defensive\": {\n        return 15 + level * 2;\n      }\n      // Maintain spell on damage taken\n      case \"damage\": {\n        const damage = options.damage ?? 0;\n        return 15 + level + damage;\n      }\n      // Default nonsense value\n      default: {\n        throw new Error(`Unrecgnized concentration check type: \"${type}\"`);\n      }\n    }\n  }\n}\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Weapon item\n */\nexport class ItemWeaponPF extends ItemPhysicalPF {\n  /**\n   * @internal\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {User} user - Triggering user\n   */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n    if (!changed.system) return;\n    if (context.diff === false || context.recursive === false) return; // Don't diff if we were told not to diff\n\n    // Set weapon subtype if not present\n    const newWeaponType = changed.system?.subType;\n    if (newWeaponType != null && newWeaponType !== this.system.subType) {\n      const subtype = changed.system.weaponSubtype ?? this.system.weaponSubtype ?? \"\";\n      const keys = Object.keys(ffd20.config.weaponTypes[newWeaponType]).filter((o) => !o.startsWith(\"_\"));\n      if (!subtype || !keys.includes(subtype)) {\n        changed.system.weaponSubtype = keys[0];\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    const { weaponTypes } = ffd20.config;\n\n    // Type and subtype labels\n    let wType = this.system.subType;\n    const typeKeys = Object.keys(weaponTypes);\n    if (!typeKeys.includes(wType)) wType = typeKeys[0];\n\n    let wSubtype = this.system.weaponSubtype;\n    const subtypeKeys = Object.keys(weaponTypes[wType]).filter((o) => !o.startsWith(\"_\"));\n    if (!subtypeKeys.includes(wSubtype)) wSubtype = subtypeKeys[0];\n\n    labels.subType = weaponTypes[wType]._label;\n    labels.childType = weaponTypes[wType][wSubtype];\n\n    labels.properties = [\n      ...Object.entries(this.system.properties ?? {})\n        .filter(([_, enabled]) => enabled)\n        .map(([id]) => ffd20.config.weaponProperties[id] || id),\n    ];\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  getTypeChatData(data, labels, props, rollData, { actionId = null, chatcard = false } = {}) {\n    super.getTypeChatData(data, labels, props, rollData, { actionId, chatcard });\n\n    if (this.showUnidentifiedData) return;\n\n    if (labels.weaponSubtype) props.push(labels.weaponSubtype);\n  }\n\n  /** @inheritDoc */\n  getProficiency(weapon = true) {\n    if (!weapon) throw new Error(\"Weapons do not support non-weapon proficiency\");\n\n    return this.isProficient;\n  }\n\n  /** @inheritDoc */\n  get isProficient() {\n    if (this.system.proficient) return true;\n    return this.actor?.hasWeaponProficiency?.(this) ?? true;\n  }\n\n  /**\n   * @inheritDoc\n   * @remarks\n   * Not 100% RAW correct as this applies armor table to weapons,\n   * but since Paizo did not provide a table for weapons\n   * besides stating weapons for small are half weight, we assume they use the same table.\n   *\n   * @see {@link ffd20.documents.item.ItemEquipmentPF.getWeightMultiplier}\n   */\n  getWeightMultiplier() {\n    // Use same as armor, even though Paizo has only stats for halving for small and nothing else.\n    return this._getArmorWeightMultiplier();\n  }\n}\n","import { ItemPhysicalPF } from \"./item-physical.mjs\";\n\n/**\n * Implant item\n *\n * Cybernetics, magic tattoos, necrografts, demonic implants, piercings, etc.\n */\nexport class ItemImplantPF extends ItemPhysicalPF {\n  /** @inheritDoc */\n  static system = Object.freeze({ ...super.system, subtypeName: true });\n\n  /** @override */\n  _onCreate(data, context, userId) {\n    super._onCreate(data, context, userId);\n\n    // Simulate equipping items    {\n    if (this.system.implanted === true) {\n      this.executeScriptCalls(\"implant\", { implanted: true });\n    }\n  }\n\n  /**\n   * @internal\n   * @override\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onDelete(context, userId) {\n    super._onDelete(context, userId);\n\n    if (game.users.get(userId)?.isSelf) {\n      if (this.system.implanted === true) {\n        this.executeScriptCalls(\"implant\", { implanted: false });\n      }\n    }\n  }\n\n  /**\n   * @override\n   * @param {object} changed - Changed data\n   * @param {object} context - Context\n   * @param {string} userId - Triggering user ID\n   */\n  _onUpdate(changed, context, userId) {\n    super._onUpdate(changed, context, userId);\n\n    // Call 'implant' script calls\n    const implanted = changed.system?.implanted;\n    if (implanted != null) {\n      this.executeScriptCalls(\"implant\", { implanted });\n    }\n  }\n\n  /** @inheritDoc */\n  _activeStateChange(changed) {\n    return changed.system?.implanted;\n  }\n\n  /** @inheritDoc */\n  getLabels({ actionId, rollData } = {}) {\n    const labels = super.getLabels({ actionId, rollData });\n\n    labels.subType = ffd20.config.implantTypes[this.subType];\n\n    switch (this.subType) {\n      case \"cybertech\":\n        labels.slot = ffd20.config.implantSlots.cybertech[this.system.slot] ?? ffd20.config.implantSlots.cybertech.none;\n        break;\n    }\n\n    const checkYes = '<i class=\"fa-solid fa-check\"></i>';\n    const checkNo = '<i class=\"fa-solid fa-times\"></i>';\n    labels.equipped = this.system.implanted ? checkYes : checkNo;\n\n    return labels;\n  }\n\n  /** @inheritDoc */\n  adjustContained() {\n    // Everything in containers count as carried\n    this.system.carried = true;\n\n    // Auto-unimplant\n    this.system.implanted = false;\n  }\n\n  /** @inheritDoc */\n  prepareWeight() {\n    super.prepareWeight();\n\n    // Implanted items weigh nothing\n    const itemData = this.system;\n    const weight = itemData.weight;\n    if (itemData.implanted) {\n      weight.total = 0;\n      weight.converted.total = 0;\n\n      // If there's more than 1 in stack, restore part of the weight\n      if (itemData.quantity > 1) {\n        // Partial duplication from base physical item\n        const baseWeight = weight.value * this.getWeightMultiplier();\n        weight.total = baseWeight * (itemData.quantity - 1);\n        weight.converted.total = ffd20.utils.convertWeight(weight.total);\n      }\n    }\n  }\n\n  /** @inheritDoc */\n  get isActive() {\n    if (this.system.quantity <= 0) return false;\n    if (this.subType === \"cybertech\" && this.system.disabled) return false;\n    return this.system.implanted || false;\n  }\n\n  /**\n   * Determines if the item implanted.\n   *\n   * @inheritDoc\n   */\n  get activeState() {\n    return this.system.implanted || false;\n  }\n\n  /** @inheritDoc */\n  async setActive(active, context) {\n    return this.update({ \"system.implanted\": active }, context);\n  }\n}\n","/**\n * ID field.\n *\n * Validates the field contents are alphanumeric string as expected of document IDs.\n */\nexport class IDField extends foundry.data.fields.StringField {\n  constructor(options = {}, context) {\n    if (options.choices) throw new Error(\"choices is not valid option for IDField\");\n    super(options, context);\n  }\n\n  static get _defaults() {\n    const defaults = super._defaults;\n    defaults.required = true;\n    defaults.nullable = false;\n    defaults.blank = false;\n    defaults.readonly = true;\n    defaults.initial = () => foundry.utils.randomID(16);\n    return defaults;\n  }\n\n  _validateType(value) {\n    if (typeof value !== \"string\") throw new Error(\"must be a string\");\n    if (!/^[a-z\\d]+$/i.test(value)) throw new Error(\"must be alphanumeric\");\n  }\n}\n","/**\n * DataModel that performs automatic data preparation\n *\n * Calls {@link prepareData()} on initialization and on {@link reset()}\n */\nexport class PreparedModel extends foundry.abstract.DataModel {\n  /**\n   * @override\n   * @protected\n   * @param {object} options - Constructor options\n   */\n  _initialize(options = {}) {\n    super._initialize(options);\n\n    this._safePrepareData();\n  }\n\n  /**\n   * Safely prepare data\n   *\n   * @internal\n   */\n  _safePrepareData() {\n    try {\n      this.prepareData();\n    } catch (err) {\n      console.error(err, this, { parent: this.parent });\n    }\n  }\n\n  /**\n   * Prepare data after initialization or reset.\n   *\n   * @abstract\n   * @protected\n   */\n  prepareData() {}\n}\n","import { PreparedModel } from \"./prepared-model.mjs\";\n\nimport { IDField } from \"@datafields/id-field.mjs\";\n\n/**\n * DataModel to mimic basic document-like behaviour.\n *\n * Calls {@link prepareData()} on initialization and on {@link reset()}\n *\n * Also handles `_id` nicely.\n */\nexport class DocumentLikeModel extends PreparedModel {\n  static defineSchema(options) {\n    const fields = foundry.data.fields;\n    return {\n      _id: new IDField(),\n      name: new fields.StringField({\n        required: true,\n        blank: false,\n        nullable: false,\n        initial: options.name,\n      }),\n    };\n  }\n\n  /**\n   * Internal ID\n   *\n   * @type {string}\n   */\n  get id() {\n    return this._id;\n  }\n}\n","/**\n * Base model for Active Effects\n *\n * Active Effect type: `base` (the default when unspecified)\n */\nexport class AEBaseModel extends foundry.abstract.TypeDataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      // End timing\n      end: new fields.StringField({\n        required: false,\n        blank: false,\n        choices: () => ffd20.config.durationEndEvents,\n        label: \"FFD20.DurationEndTiming\",\n      }),\n      // Initiative this AE was started on\n      initiative: new fields.NumberField({\n        required: false,\n        initial: undefined, // HACK: Without unlinked actors start erroring about nulls\n        nullable: false,\n        label: \"FFD20.Initiative\",\n      }),\n      // Arbitrary level\n      level: new fields.NumberField({\n        required: false,\n        initial: undefined, // HACK: Without unlinked actors start erroring about nulls\n        integer: true,\n        nullable: false,\n        label: \"FFD20.Level\",\n      }),\n    };\n  }\n\n  /**\n   * Retrieve parent item\n   *\n   * @type {Item|null}\n   */\n  get item() {\n    const doc = this.parent?.parent;\n    if (doc instanceof Item) return doc;\n    return null;\n  }\n}\n","import { AEBaseModel } from \"./ae-base.mjs\";\n\n/**\n * Buff tracking Active Effect.\n *\n * Active Effect type: `buff`\n */\nexport class AEBuffModel extends AEBaseModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      ...super.defineSchema(),\n      // Nothing here yet\n    };\n  }\n\n  /** @override */\n  async _preCreate(data, context, user) {\n    await super._preCreate(data, context, user);\n\n    // Tracker does not support disabling\n    if (data.disabled) this.parent.updateSource({ disabled: false });\n  }\n\n  /** @override */\n  async _preUpdate(changed, context, user) {\n    await super._preUpdate(changed, context, user);\n\n    // Buff trackers do not support disabling themselves.\n    delete changed.disabled;\n  }\n\n  /** @override */\n  async _preDelete(context, user) {\n    await super._preDelete(context, user);\n\n    // Tracker AE can not be deleted while parent item is active\n    if (this.item?.isActive) return false;\n  }\n\n  /**\n   * Is this item tracking AE\n   *\n   * @remarks\n   * - There should be only one AE with this true per item.\n   *\n   * @type {boolean}\n   */\n  get isTracker() {\n    // This being false is an error of some kind.\n    return !!this.item;\n  }\n}\n","/**\n * Compacting Mixin\n *\n * Provides framework for automatic data pruning.\n *\n * @param {T} Base - Base datamodel\n * @returns {T} - Enriched class\n */\nexport const CompactingMixin = (Base) =>\n  class extends Base {\n    /** @override */\n    toObject(source = true, clean = true) {\n      const data = super.toObject(source);\n\n      if (clean) this.constructor.pruneData(data);\n\n      return data;\n    }\n\n    /**\n     * Prune data\n     *\n     * @abstract\n     * @protected\n     * @param {object} data - Source data to prune\n     * @returns {void}\n     */\n    // eslint-disable-next-line no-unused-vars\n    static pruneData(data) {}\n  };\n","import { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\nexport class DamagePartModel extends CompactingMixin(foundry.abstract.DataModel) {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      formula: new FormulaField(),\n      types: new fields.SetField(new fields.StringField({ blank: false, nullable: false })),\n    };\n  }\n\n  static migrateData(source) {\n    // Since v11, merge standard and custom type IDs into single array.\n    if (!source.types && source.type) {\n      source.types = source.type?.values ?? [];\n\n      if (typeof source.type?.custom === \"string\" && source.type.custom.length) {\n        source.types.push(source.type.custom.split(\";\").map((t) => t.trim()));\n      }\n    }\n\n    return super.migrateData(source);\n  }\n\n  _initialize(options) {\n    super._initialize(options);\n\n    Object.defineProperty(this, \"type\", {\n      get() {\n        foundry.utils.logCompatibilityWarning(\"DamagePartModel.type is deprecated in favor of DamagePartModel.types\", {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        });\n\n        const full = this.parsed;\n        return {\n          values: [...full.standard].map((d) => d.id),\n          custom: [...full.custom].join(\";\"),\n        };\n      },\n    });\n  }\n\n  /**\n   * Prune data\n   *\n   * @param {object} data - Damage part data\n   */\n  static pruneData(data) {\n    if (!data.formula) delete data.formula;\n    data.types = data.types?.map((t) => t.trim()).filter((t) => !!t);\n    if (!data.types?.length) delete data.types;\n  }\n\n  /**\n   * Parsed types\n   *\n   * @type {{standard:Set<ffd20.registry.DamageType>,custom:Set<string>}}\n   */\n  get parsed() {\n    // TODO: Cache this?\n\n    const result = {\n      standard: new Set(),\n      custom: new Set(),\n      get all() {\n        return [...this.standard, ...this.custom];\n      },\n    };\n    for (const type of this.types) {\n      const d = ffd20.registry.damageTypes.get(type);\n      if (d) {\n        result.standard.add(d);\n      } else {\n        result.custom.add(type);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Parsed names of all types\n   *\n   * @type {Array<string>}\n   */\n  get names() {\n    return this.parsed.all.map((dt) => dt.name || dt);\n  }\n\n  /**\n   * Standard types\n   *\n   * @type {Set<ffd20.registry.DamageType>}\n   */\n  get standard() {\n    return this.parsed.standard;\n  }\n\n  /**\n   * Custom types\n   *\n   * @type {Set<string>}\n   */\n  get custom() {\n    return this.parsed.custom;\n  }\n}\n","import { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\n/**\n * Manual Extra Attack data model\n */\nexport class ExtraAttackModel extends CompactingMixin(foundry.abstract.DataModel) {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      name: new fields.StringField(),\n      formula: new FormulaField(),\n    };\n  }\n\n  static migrateData(source) {\n    // Convert very old tuple format\n    if (Array.isArray(source)) {\n      const [formula, name] = source;\n      source = { formula, name };\n    }\n\n    return super.migrateData(source);\n  }\n\n  /** @override */\n  static pruneData(data) {\n    if (!data.formula) delete data.formula;\n    if (!data.name) delete data.name;\n  }\n}\n","/**\n * Replaceable Source Mixin\n *\n * Adds function to the data model to replace source data.\n *\n * @see {@link https://github.com/foundryvtt/foundryvtt/issues/11792}\n *\n * @param {T} Base - Base datamodel\n * @returns {T} - Enriched class\n */\nexport const ReplaceableSourceMixin = (Base) =>\n  class extends Base {\n    /**\n     * Replace datamodel source\n     *\n     * @param {object} source - New source\n     * @returns {object} - Result of DataModel.updateSource()\n     */\n    replaceSource(source) {\n      source = foundry.utils.deepClone(source); // Prevent mutations to source data\n\n      this.constructor.migrateData(source);\n\n      // Clear values not present in new data\n      // Does not do deep comparisons\n      for (const [key, schema] of Object.entries(this.schema.fields)) {\n        if (schema.readonly) continue;\n        if (key in source) continue;\n        if (key in this._source) {\n          source[key] = undefined; // Delete syntax does not work here\n        }\n      }\n\n      return this.updateSource(source); // recursive:false,diff:false does not work here\n    }\n  };\n","import { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\n\nexport class BaseMessageModel extends CompactingMixin(foundry.abstract.TypeDataModel) {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    const nonEmpty = { initial: undefined, blank: false, nullable: false }; // Either undefined or something, not something but nothing\n    return {\n      subject: new fields.ObjectField(), // Message subject data\n      reference: new fields.StringField({ ...nonEmpty }), // UUID reference to whatever prompted this message\n      combat: new fields.StringField(), // Combat ID\n      config: new fields.ObjectField(), // Details about the message use scenario\n    };\n  }\n\n  static pruneData(data) {\n    for (const [key, sv] of Object.entries(data.subject ?? {})) {\n      if (typeof sv === \"object\") delete data.subject[key];\n    }\n    if (foundry.utils.isEmpty(data.subject)) delete data.subject;\n    if (!data.reference) delete data.reference;\n    if (!data.combat) delete data.combat;\n    if (foundry.utils.isEmpty(data.config)) delete data.config;\n  }\n\n  /**\n   * Additional shim for metadata shim\n   *\n   * @deprecated - Use `msg.system.config.rank` instead.\n   * @returns {{rank:number}} - Skill data\n   */\n  get skill() {\n    foundry.utils.logCompatibilityWarning(\n      \"ChatMessagePF.flags.ffd20.metadata.skill.rank has been deprecated in favor of ChatMessagePF.system.config.rank\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n\n    return {\n      rank: this.config.rank,\n    };\n  }\n}\n","import { BaseMessageModel } from \"./base-message.mjs\";\n\n/**\n * Data Model for item cards.\n */\nexport class ItemMessageModel extends BaseMessageModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      ...super.defineSchema(),\n      actor: new fields.StringField(), // Actor UUID (is this actually ever different from card speaker?)\n      template: new fields.StringField(), // Template UUID\n      item: new fields.SchemaField({\n        id: new fields.StringField(), // Item ID,\n        name: new fields.StringField(),\n        description: new fields.HTMLField(),\n        identified: new fields.BooleanField({ initial: true }),\n      }),\n    };\n  }\n\n  static migrateData(source) {\n    if (typeof source.item === \"string\") {\n      source.item = { id: source.item };\n    }\n\n    return super.migrateData(source);\n  }\n\n  static pruneData(data) {\n    super.pruneData(data);\n\n    if (!data.actor) delete data.actor;\n    if (!data.template) delete data.template;\n\n    if (data.item) {\n      if (!data.item.id) delete data.item.id;\n      if (data.item.identified) delete data.item.identified;\n      if (!data.item.description) delete data.item.description;\n      if (!data.item.name) delete data.item.name;\n\n      if (foundry.utils.isEmpty(data.item)) delete data.item;\n    }\n  }\n}\n","import { ItemMessageModel } from \"./item-message.mjs\";\n\n/**\n * Data Model for action cards.\n */\nexport class ActionMessageModel extends ItemMessageModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    const nonEmpty = { initial: undefined, blank: false, nullable: false }; // Either undefined or something, not something but nothing\n\n    return {\n      ...super.defineSchema(),\n      config: new fields.SchemaField({\n        critMult: new fields.NumberField({ initial: undefined, min: 1, step: 1, integer: true }),\n        nonlethal: new fields.BooleanField({ initial: false, required: false }),\n        cl: new fields.NumberField({ initial: undefined, required: false, integer: true, min: 0 }),\n        sl: new fields.NumberField({ initial: undefined, required: false, integer: true, min: 0 }),\n      }),\n      rolls: new fields.ObjectField(),\n      targets: new fields.ArrayField(new fields.StringField({ ...nonEmpty })),\n      action: new fields.SchemaField({\n        id: new fields.StringField(), // Action ID\n        name: new fields.StringField(),\n        description: new fields.HTMLField(),\n      }),\n      save: new fields.SchemaField(\n        {\n          dc: new fields.NumberField({ initial: undefined, integer: true, nullable: false }),\n          type: new fields.StringField(),\n        },\n        { initial: undefined, required: false }\n      ),\n    };\n  }\n\n  static migrateData(source) {\n    if (!source) return;\n\n    // Old flag metadata\n    if (typeof source.action === \"string\") {\n      source.action = { id: source.action };\n    }\n\n    // PF1 v11.3\n    if (source.action?.dc !== undefined) {\n      source.save ??= {};\n      source.save.dc ??= source.action?.dc;\n    }\n\n    return super.migrateData(source);\n  }\n\n  prepareBaseData() {\n    super.prepareBaseData();\n\n    if (this.action) {\n      // @deprecated\n      Object.defineProperty(this.action, \"dc\", {\n        get: () => {\n          foundry.utils.logCompatibilityWarning(\n            \"ChatMessagePF.system.action.dc is deprecated in favor of ChatMessagePF.system.save.dc\",\n            {\n              since: \"PF1 v11.3\",\n              until: \"PF1 v12\",\n            }\n          );\n\n          return this.save?.dc;\n        },\n      });\n    }\n  }\n\n  static pruneData(data) {\n    super.pruneData(data);\n\n    if (data.rolls) {\n      if (!(data.rolls.attacks?.length > 0)) delete data.rolls.attacks;\n      else {\n        for (const atk of data.rolls.attacks) {\n          if (!atk.critConfirm) delete atk.critConfirm;\n          if (!atk.critDamage?.length) delete atk.critDamage;\n          if (!atk.damage?.length) delete atk.damage;\n        }\n      }\n      if (foundry.utils.isEmpty(data.rolls)) delete data.rolls;\n    }\n\n    if (!data.targets?.length) delete data.targets;\n\n    if (data.config?.nonlethal === false) delete data.config?.nonlethal;\n    if (!Number.isFinite(data.config?.sl)) delete data.config?.sl;\n    if (!Number.isFinite(data.config?.cl)) delete data.config?.cl;\n\n    if (data.action) {\n      if (!data.action.id) delete data.action.id;\n      if (!data.action.description) delete data.action.description;\n      if (!data.action.name) delete data.action.name;\n      if (!Number.isFinite(data.action.dc)) delete data.action.dc;\n\n      if (foundry.utils.isEmpty(data.action)) delete data.action;\n    }\n\n    if (data.save?.dc === undefined) delete data.save;\n  }\n}\n","import { BaseMessageModel } from \"./base-message.mjs\";\n\n/**\n * Data Model for basic check cards.\n */\nexport class CheckMessageModel extends BaseMessageModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      ...super.defineSchema(),\n      dc: new fields.NumberField({ initial: undefined, nullable: false, integer: true }),\n    };\n  }\n\n  static pruneData(data) {\n    super.pruneData(data);\n\n    if (typeof data.dc !== \"number\") delete data.dc;\n  }\n}\n","/**\n * Haunt actor data model\n */\nexport class HauntModel extends foundry.abstract.TypeDataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      attributes: new fields.SchemaField({\n        hp: new fields.SchemaField({\n          base: new fields.NumberField({\n            initial: 0,\n            integer: true,\n            nullable: false,\n          }),\n          offset: new fields.NumberField({\n            initial: 0,\n            integer: true,\n            nullable: false,\n          }),\n        }),\n        init: new fields.SchemaField({\n          value: new fields.NumberField({\n            initial: 10,\n            integer: true,\n            nullable: false,\n          }),\n        }),\n      }),\n      templates: new fields.ArrayField(new fields.StringField({ blank: false })),\n      traits: new fields.SchemaField({\n        size: new fields.StringField({\n          required: true,\n          initial: \"med\",\n          choices: () => ffd20.config.actorSizes,\n        }),\n      }),\n      details: new fields.SchemaField({\n        alignment: new fields.StringField({\n          required: true,\n          initial: \"tn\",\n          choices: () => ffd20.config.alignments,\n        }),\n        area: new fields.SchemaField({\n          size: new fields.NumberField({\n            initial: 0,\n            integer: true,\n            min: 0,\n            nullable: false,\n          }),\n          type: new fields.StringField({\n            initial: \"circle\",\n            required: true,\n            choices: () => ffd20.utils.internal.getTemplateTypes(),\n          }),\n        }),\n        aura: new fields.SchemaField({\n          custom: new fields.BooleanField({\n            initial: false,\n          }),\n          school: new fields.StringField(),\n        }),\n        cl: new fields.NumberField({\n          initial: 1,\n          integer: true,\n          min: 1,\n          nullable: false,\n        }),\n        cr: new fields.SchemaField({\n          base: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n          }),\n        }),\n        destruction: new fields.HTMLField(),\n        effect: new fields.HTMLField(),\n        notes: new fields.HTMLField(),\n        notice: new fields.SchemaField({\n          dc: new fields.NumberField({\n            initial: 0,\n            integer: true,\n            min: 0,\n            nullable: false,\n          }),\n          desc: new fields.StringField(),\n          value: new fields.StringField(),\n        }),\n        reset: new fields.SchemaField({\n          value: new fields.StringField(),\n          units: new fields.StringField({\n            blank: true,\n            choices: () => ffd20.config.timePeriods,\n          }),\n        }),\n        trigger: new fields.StringField(),\n        weakness: new fields.StringField(),\n      }),\n    };\n  }\n\n  static migrateData(source) {\n    // Migrate Alignment info\n    const alignment = source.details?.alignment?.toLowerCase();\n    if (alignment && Object.keys(ffd20.config.alignments).includes(alignment)) {\n      source.details.alignment = alignment;\n    }\n\n    // Migrate Aura info\n    if (typeof source.details?.aura === \"string\") {\n      source.details.aura = {\n        custom: true,\n        school: source.details.aura,\n      };\n    }\n\n    // Migrate Area info\n    if (typeof source.details?.area === \"string\") {\n      source.details.area = {\n        size: source.details.area.match(/\\d+/)?.[0] ?? 0,\n        type: \"circle\",\n      };\n    }\n\n    // Migrate Reset info\n    if (typeof source.details?.reset === \"string\") {\n      source.details.reset = {\n        value: source.details.reset,\n        units: \"spec\",\n      };\n    }\n\n    // Migrate Notice info\n    if (typeof source.details?.notice === \"string\") {\n      source.details.notice = {\n        value: source.details.notice,\n        dc: 0,\n      };\n    }\n\n    // Migrate Notes\n    if (typeof source.details?.notes?.value === \"string\") {\n      source.details.notes = source.details.notes.value;\n    }\n  }\n}\n","/**\n * Trap actor data model\n */\nexport class TrapModel extends foundry.abstract.TypeDataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      bypass: new fields.StringField({\n        blank: true,\n        choices: () => ffd20.config.traps.bypass,\n      }),\n      cr: new fields.SchemaField({\n        base: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n        }),\n      }),\n      disarm: new fields.NumberField({\n        initial: 0,\n        integer: true,\n        min: 0,\n        nullable: false,\n      }),\n      duration: new fields.SchemaField({\n        value: new fields.StringField(),\n        units: new fields.StringField({\n          blank: true,\n          initial: \"inst\",\n          choices: () => ffd20.config.timePeriods,\n        }),\n      }),\n      effect: new fields.HTMLField(),\n      notes: new fields.HTMLField(),\n      perception: new fields.NumberField({\n        initial: 0,\n        integer: true,\n        min: 0,\n        nullable: false,\n      }),\n      reset: new fields.SchemaField({\n        type: new fields.StringField({\n          blank: true,\n          choices: () => ffd20.config.traps.reset,\n        }),\n        value: new fields.StringField(),\n        units: new fields.StringField({\n          blank: true,\n          initial: \"inst\",\n          choices: () => ffd20.config.timePeriods,\n        }),\n      }),\n      trigger: new fields.SchemaField({\n        type: new fields.StringField({\n          blank: true,\n          choices: () => ffd20.config.traps.trigger,\n        }),\n        value: new fields.StringField(),\n        vision: new fields.StringField({\n          blank: true,\n          choices: () => ffd20.config.traps.vision,\n        }),\n        units: new fields.StringField({\n          blank: true,\n          initial: \"inst\",\n          choices: () => ffd20.config.timePeriods,\n        }),\n      }),\n      type: new fields.StringField({\n        initial: \"mechanical\",\n      }),\n      technology: new fields.BooleanField({\n        initial: false,\n      }),\n    };\n  }\n\n  static migrateData(source) {\n    if (!source.details) return;\n\n    // Migrate CR\n    if (source.details.cr) {\n      source.cr ??= {\n        base: source.details.cr.base,\n      };\n    }\n\n    // Migrate flat fields\n    [\"disarm\", \"effect\", \"perception\"].forEach((key) => {\n      if (source.details[key]) {\n        source[key] ??= source.details[key];\n      }\n    });\n\n    // Make sure the type is lowercase (actor breaks if type was \"Magic\" instead of \"magic\", for example)\n    if (source.details.type) {\n      const old = source.details.type;\n      for (const [key, value] of Object.entries(ffd20.config.traps.types)) {\n        if (value === old) {\n          source.type ??= key;\n          break;\n        }\n      }\n      source.type ??= old;\n    }\n\n    // Migrate Duration\n    if (source.details.duration) {\n      source.duration ??= {\n        value: source.details.duration,\n        units: \"\",\n      };\n    }\n\n    // Migrate Reset\n    if (source.details.reset) {\n      source.reset ??= {\n        type: \"automatic\",\n        value: source.details.reset,\n        units: \"\",\n      };\n    }\n\n    // Migrate Trigger\n    if (source.details.trigger) {\n      source.duration ??= {\n        type: \"location\",\n        value: source.details.trigger,\n        units: \"\",\n      };\n    }\n\n    // Migrate Notes\n    if (typeof source.details?.notes?.value === \"string\") {\n      source.notes = source.details.notes.value;\n    }\n\n    // Clean up the Details\n    delete source.details;\n  }\n}\n","/**\n * Vehicle actor data model\n */\nexport class VehicleModel extends foundry.abstract.TypeDataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      attributes: new fields.SchemaField({\n        ac: new fields.SchemaField({\n          normal: new fields.SchemaField({\n            bonus: new fields.NumberField({\n              initial: 0,\n              nullable: false,\n            }),\n          }),\n          touch: new fields.SchemaField({\n            bonus: new fields.NumberField({\n              initial: 0,\n              nullable: false,\n            }),\n          }),\n          stopped: new fields.SchemaField({\n            bonus: new fields.NumberField({\n              initial: 0,\n              nullable: false,\n            }),\n          }),\n        }),\n        hardness: new fields.SchemaField({\n          base: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n            integer: true,\n          }),\n          bonus: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n          }),\n        }),\n        hp: new fields.SchemaField({\n          bonus: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n            integer: true,\n          }),\n          offset: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n            integer: true,\n          }),\n        }),\n        init: new fields.SchemaField({\n          value: new fields.NumberField({\n            initial: 0,\n            nullable: false,\n            integer: true,\n          }),\n        }),\n        savingThrows: new fields.SchemaField({\n          save: new fields.SchemaField({\n            base: new fields.NumberField({\n              initial: 0,\n              nullable: false,\n              integer: true,\n            }),\n          }),\n        }),\n      }),\n      crew: new fields.SchemaField({\n        value: new fields.NumberField({\n          initial: 0,\n          integer: true,\n          min: 0,\n          nullable: false,\n        }),\n        max: new fields.NumberField({\n          initial: 1,\n          integer: true,\n          min: 1,\n          nullable: false,\n        }),\n        passengers: new fields.NumberField({\n          initial: 0,\n          integer: true,\n          min: 0,\n          nullable: false,\n        }),\n      }),\n      currency: new fields.SchemaField({\n        pp: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n          integer: true,\n        }),\n        gp: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n          integer: true,\n        }),\n        sp: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n          integer: true,\n        }),\n        cp: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n          integer: true,\n        }),\n      }),\n      material: new fields.SchemaField({\n        base: new fields.StringField({}),\n        magicallyHardened: new fields.BooleanField({\n          initial: false,\n        }),\n      }),\n      squares: new fields.NumberField({\n        initial: 2,\n        integer: true,\n        min: 2,\n        nullable: false,\n      }),\n      traits: new fields.SchemaField({\n        size: new fields.StringField({\n          required: true,\n          initial: \"lg\",\n          choices: () => ffd20.config.actorSizes,\n        }),\n        type: new fields.StringField({\n          required: true,\n          initial: \"land\",\n          choices: () => ffd20.config.vehicles.type,\n        }),\n      }),\n      details: new fields.SchemaField({\n        carryCapacity: new fields.SchemaField({}),\n        acceleration: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          integer: true,\n          nullable: false,\n        }),\n        cost: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          nullable: false,\n        }),\n        currentSpeed: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          integer: true,\n          nullable: false,\n        }),\n        decks: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          integer: true,\n          nullable: false,\n        }),\n        description: new fields.HTMLField({}),\n        drivingCheck: new fields.StringField({}),\n        drivingDevice: new fields.StringField({}),\n        drivingSpace: new fields.StringField({}),\n        forwardFacing: new fields.StringField({}),\n        maxSpeed: new fields.NumberField({\n          initial: 0,\n          min: 0,\n          integer: true,\n          nullable: false,\n        }),\n        propulsion: new fields.StringField({}),\n        notes: new fields.HTMLField(),\n      }),\n      driver: new fields.SchemaField({\n        skill: new fields.StringField(),\n        uuid: new fields.StringField(),\n      }),\n    };\n  }\n\n  static migrateData(source) {\n    if (!source.details) return;\n\n    // Migrate Hardess\n    if (typeof source.details.hardness === \"number\") {\n      source.attributes.hardness ??= {\n        base: source.details.hardness,\n        bonus: 0,\n      };\n\n      delete source.details.hardness;\n    }\n\n    // Migrate Crew\n    if (Number.isInteger(source.details.crew)) {\n      source.details.crew = {\n        value: source.details.crew,\n        max: source.details.crew,\n        passengers: 0,\n      };\n    }\n\n    // Migrate Notes\n    if (typeof source.details?.notes?.value === \"string\") {\n      source.details.notes = source.details.notes.value;\n    }\n  }\n}\n","import { RollPF } from \"module/dice/roll.mjs\";\n\nconst affirmative = new Set([\"yes\", \"true\", \"1\", \"y\"]);\nconst negatory = new Set([\"no\", \"false\", \"0\", \"n\"]);\n\n/**\n * Basic item filter function for {@link findItem}\n *\n * @internal\n * @param {Item|object} item - Item or index entry to match\n * @param {object} query - Query data\n * @returns {boolean}\n */\nexport function matchItem(item, query) {\n  const { name, type } = query;\n  return item.name === name && (type ? item.type === type : true);\n}\n\n/**\n * Find item based on basic criteria.\n *\n * @internal\n * @param {string} name - Item name to search for\n * @param {object} [options] - Additional options\n * @param {string} [options.type] - Document type, such as \"buff\"\n * @returns {string|null} - Most appropriate matching item's UUID\n */\nexport async function findItem(name, { type } = {}) {\n  // Items directory has priority\n  const item = game.items.find((i) => ffd20.chat.enrichers.matchItem(i, { name, type }));\n  if (item) return item.uuid;\n\n  const packTypePriority = {\n    items: 1_000,\n    world: 2_000,\n    module: 3_000,\n    system: 4_000,\n  };\n\n  // Sort packs by above criteria\n  const packs = [...game.packs]\n    .map((p) => ({\n      pack: p,\n      visible: p.visible ?? true,\n      disabled: p.config.ffd20?.disabled ?? false,\n      sort: packTypePriority[p.metadata.packageType],\n    }))\n    .filter((p) => !p.disabled && p.visible && p.pack.metadata.type === \"Item\")\n    .sort((a, b) => a.sort - b.sort);\n\n  for (const { pack } of packs) {\n    if (!pack.indexed) await pack.getIndex();\n    const item = pack.index.find((i) => ffd20.chat.enrichers.matchItem(i, { name, type }));\n    if (item) return item.uuid;\n  }\n\n  return null;\n}\n\n/**\n * Get most relevant roll data\n *\n * @param {ChatMessagePF} message\n * @returns {object} - Roll data\n */\nfunction getRollData(message) {\n  // Get action, item, or actor\n  let srcDoc = message.actionSource ?? message.itemSource;\n  srcDoc ??= message.speaker ? ChatMessage.getSpeakerActor(message.speaker) : null;\n  const rollData = srcDoc?.getRollData();\n\n  // Apply cached values\n  const cfg = message.system?.config;\n  if (cfg && rollData) {\n    if (cfg.cl !== undefined) rollData.cl = cfg.cl;\n    if (cfg.sl !== undefined) rollData.sl = cfg.sl;\n    if (cfg.critMult !== undefined) rollData.critMult = cfg.critMult;\n  }\n\n  return rollData;\n}\n\n/**\n * Helper class for making `CONFIG.TextEditor.enrichers` usage easier.\n */\nexport class PF1TextEnricher {\n  id;\n\n  pattern;\n\n  match;\n\n  enricher;\n\n  /**\n   * @abstract\n   * @param {Event} event Click event\n   * @param {HTMLElement} target Target element\n   */\n  click(event, target) {}\n\n  /**\n   * @abstract\n   * @param {Event} event Drag event\n   * @param {HTMLElement} target Target element\n   */\n  drag(event, target) {}\n\n  /**\n   * @param {string} id Unique identifier\n   * @param {RegExp} pattern Pattern for content matching.\n   * @param {Function} enricher Function for generating enriched content.\n   * @param {object} [interaction] Additional interaction options\n   * @param {string[]} [interaction.match] CSS selectors for triggering click or drag handler\n   * @param {Function} [interaction.click] Click handler\n   * @param {Function} [interaction.drag] Drag handler\n   */\n  constructor(id, pattern, enricher, { click, drag } = {}) {\n    if (!(pattern instanceof RegExp)) throw new Error(\"TextEnricher pattern must be a regular expression\");\n    if (!pattern.global) throw new Error(\"TextEnricher pattern must be global\");\n    this.id = id;\n    this.pattern = pattern;\n    this.enricher = enricher.bind(this);\n    if (click) this.click = click;\n    if (drag) this.drag = drag;\n  }\n}\n\n/**\n * @param {Element} el\n * @param {string} icon\n */\nfunction setIcon(el, icon) {\n  const i = document.createElement(\"i\");\n  i.inert = true;\n  i.classList.add(...icon.split(\" \"));\n  el.prepend(i, \"Â \");\n}\n\n/**\n * Parses duration string into distinct time and unit.\n *\n * @param {string} duration\n */\nfunction parseDuration(duration) {\n  const re = /^(?<time>\\d+)(?<unit>[a-z]+)?$/.exec(duration);\n  if (!re) return [];\n  const { time, unit } = re.groups;\n\n  const unitLabel = (() => {\n    switch (unit?.[0]?.toLowerCase()) {\n      default:\n      case \"r\":\n        return game.i18n.localize(\"FFD20.Time.Period.round.Label\");\n      case \"s\":\n        return game.i18n.localize(\"FFD20.Time.Period.second.Label\");\n      case \"h\":\n        return game.i18n.localize(\"FFD20.Time.Period.hour.Label\");\n      case \"m\":\n        return game.i18n.localize(\"FFD20.Time.Period.minute.Label\");\n    }\n  })();\n\n  return [parseInt(time), unit || \"r\", unitLabel];\n}\n\n/**\n * Create enriched element for interaction.\n *\n * @param {object} config - Element configuration\n * @param {string} [config.label] - Prefix label for the element\n * @param {string} [config.icon] - Font Awesome icon classes\n * @param {boolean} [config.click=false] - Is this a clickable element?\n * @param {boolean} [config.drag=false] - Is this draggable element?\n * @param {string} config.handler - {@link PF1TextEnricher} ID\n * @param {Record<string,string>} [config.options] - Additional options set as dataset elements.\n * @param {boolean} [config.broken=false] - Is this broken?\n * @returns {HTMLElement} - The element.\n */\nexport function createElement({ label, icon, click = false, drag = false, handler, options, broken = false } = {}) {\n  const a = document.createElement(\"a\");\n  if (click || drag) a.classList.add(\"pf1-link\");\n  else a.classList.add(\"pf1-info\");\n  if (click) a.classList.add(\"button\");\n  if (drag) {\n    a.classList.add(\"content\");\n    a.draggable = true;\n  }\n  if (icon) setIcon(a, icon);\n\n  if (label) a.append(label, \": \");\n  if (handler) a.dataset.handler = handler;\n\n  if (broken) a.classList.add(\"broken\");\n\n  setElementOptions(a, options);\n\n  return a;\n}\n\n/**\n * Get card's speaker actor\n *\n * @param {HTMLElement} target\n * @param {ChatMessage} [message]\n * @returns {Actor|undefined}\n */\nfunction getSpeaker(target, message) {\n  const speaker = getSpeakerData(target, message);\n  if (!speaker) return;\n  return ChatMessage.implementation.getSpeakerActor(speaker);\n}\n\n/**\n * Get card's speaker data\n *\n * @param {HTMLElement} target - Element to search message card from.\n * @param {ChatMessage} [message]\n * @returns {object|undefined} - Message's speaker data or undefined\n */\nfunction getSpeakerData(target, message) {\n  message ??= getMessage(target);\n  return message?.speaker;\n}\n\n/**\n * Get Chat Message\n *\n * @param {HTMLElement} target\n * @returns {ChatMessagePF|undefined}\n */\nfunction getMessage(target) {\n  const messageId = target.closest(\"[data-message-id]\")?.dataset.messageId;\n  return game.messages.get(messageId);\n}\n\n/**\n * Get sheet actor\n *\n * @param {Element} target\n * @returns {Actor|undefined}\n */\nfunction getSheetActor(target) {\n  const appId = target.closest(\".app[data-appid]\")?.dataset.appid;\n  return ui.windows[appId]?.actor;\n}\n\n/**\n * Get relevant actors based on the enriched element data.\n *\n * @param {HTMLElement} button - Clicked element.\n * @param {boolean} required - Error if no actors are found.\n * @returns {Set<ActorPF>} - Relevant actors\n */\nexport function getRelevantActors(button, required = true) {\n  const actors = [];\n\n  const as = button.dataset.as || (button.dataset.speaker ? \"speaker\" : null);\n  const asSpeaker = as === \"speaker\";\n  const asSheet = as === \"sheet\";\n  const auto = [\"auto\", \"context\"].includes(as);\n\n  // Speaker\n  if (asSpeaker || auto) {\n    const actor = getSpeaker(button);\n    if (actor) actors.push(actor);\n  }\n\n  if (asSheet || auto) {\n    const actor = getSheetActor(button);\n    if (actor) actors.push(actor);\n  }\n\n  if (!as) {\n    // Controlled tokens\n    if (canvas.tokens.controlled.length) {\n      const tokenActors = canvas.tokens.controlled.map((t) => t.actor);\n      for (const actor of tokenActors) {\n        if (actor) actors.push(actor);\n      }\n    }\n    // Configured character\n    else {\n      const actor = game.user.character;\n      if (actor) actors.push(actor);\n    }\n  }\n\n  if (required && actors.length == 0) {\n    ui.notifications.error(game.i18n.localize(\"FFD20.EnrichedText.Errors.NoActors\"), { console: false });\n    throw new Error(\"No valid actors found.\");\n  }\n\n  return new Set(actors);\n}\n\n/**\n * Add tooltip to enriched element.\n *\n * @param {Element} el Target element\n * @param {object} allowed -\n */\nexport function generateTooltip(el, allowed = {}) {\n  const { roll, formula, bonus, speaker, name, level, as, card, dc } = el.dataset;\n\n  const tooltip = [];\n  if (name) tooltip.push(name);\n  if (roll) {\n    if (/d\\d+/.test(roll)) tooltip.push(game.i18n.localize(\"FFD20.Roll\") + `: ${roll}`);\n    else tooltip.push(game.i18n.format(\"FFD20.TakeX\", { number: roll }));\n  } else if (formula) {\n    tooltip.push(formula);\n  }\n  if (level) tooltip.push(game.i18n.localize(\"FFD20.Level\") + `: ${level}`);\n  if (bonus) tooltip.push(game.i18n.localize(\"FFD20.Bonus\") + `: ${bonus}`);\n  if (speaker || as === \"speaker\") tooltip.push(game.i18n.localize(\"FFD20.EnrichedText.AsSpeaker\"));\n  if (allowed.card) {\n    if (card) tooltip.push(game.i18n.localize(\"FFD20.EnrichedText.AsCard\"));\n    else tooltip.push(game.i18n.localize(\"FFD20.EnrichedText.Direct\"));\n  }\n\n  if (tooltip.length) el.dataset.tooltip = tooltip.join(\"<br>\");\n}\n\n/**\n * Break down options string into dataset properties.\n *\n * @internal\n * @param {Element} el Target element\n * @param {string} options Options string\n */\nexport function setElementOptions(el, options) {\n  if (!options) return;\n  for (const option of options.split(\";\")) {\n    const [key, value] = option.split(\"=\", 2);\n    if (el.dataset[key]) el.dataset[key] += \";\" + value;\n    else el.dataset[key] = value ?? true;\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onSave(event, target) {\n  const actors = getRelevantActors(target);\n\n  // Add additional options\n  const options = {};\n  const { roll, bonus, type, dc } = target.dataset;\n  if (!type) throw new Error(\"No save type defined\");\n  if (roll) options.staticRoll = roll;\n  if (bonus) options.bonus = bonus;\n  if (dc) options.dc = parseInt(dc);\n\n  // Roll\n  for (const actor of actors) {\n    actor.rollSavingThrow(type, foundry.utils.deepClone(options));\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onAbility(event, target) {\n  const actors = getRelevantActors(target);\n\n  // Add additional options\n  const options = {};\n  const { ability, bonus, roll } = target.dataset;\n  if (!ability) throw new Error(\"No ability check type defined\");\n  if (roll) options.staticRoll = roll;\n  if (bonus) options.bonus = bonus;\n\n  // Roll\n  for (const actor of actors) {\n    actor.rollAbilityTest(ability, foundry.utils.deepClone(options));\n  }\n}\n\n/**\n * @param {Event} _event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport async function onDraw(_event, target) {\n  const { ident } = target.dataset;\n  if (!ident) throw new Error(\"No roll table defined\");\n\n  const table = await fromUuid(ident);\n  if (!table) throw new Error(`Roll table not found for \"${ident}\"`);\n  await table.draw({ roll: true, displayChat: true });\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onSkill(event, target) {\n  // Add additional options\n  const options = {};\n  const { skill, bonus, roll, info, dc } = target.dataset;\n  if (!skill) throw new Error(\"No skill key defined\");\n\n  if (info) {\n    const journal = ffd20.config.skillCompendiumEntries[skill];\n    if (!journal) throw new Error(`Journal entry not found for skill \"${skill}\"`);\n    return void ffd20.utils.openJournal(journal);\n  }\n\n  if (roll) options.staticRoll = roll;\n  if (bonus) options.bonus = bonus;\n  if (dc) options.dc = parseInt(dc);\n\n  const actors = getRelevantActors(target);\n\n  // Roll\n  for (const actor of actors) {\n    actor.rollSkill(skill, foundry.utils.deepClone(options));\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onUse(event, target) {\n  // Add additional options\n  const options = {};\n  const { type, item: itemName, action: actionIdent, speaker } = target.dataset;\n  if (!itemName) throw new Error(\"No item name defined\");\n\n  const actors = getRelevantActors(target);\n\n  for (const actor of actors) {\n    const item = actor.items.find((item) => {\n      if (type && item.type !== type) return false;\n      return item.name.localeCompare(itemName, undefined, { usage: \"search\" }) == 0;\n    });\n\n    if (!item) {\n      const msg = game.i18n.format(\"FFD20.Warning.NoItemOnActor\", { actor: actor.name, item: itemName });\n      ui.notifications.warn(msg, { console: false });\n      console.warn(\"FFD20 | @Use |\", msg, actor);\n      continue;\n    }\n\n    let itemAction;\n    if (actionIdent) {\n      const re = /^(?:tag:(?<actionTag>.*?)|id:(?<actionId>.*?))$/.exec(actionIdent);\n      const { actionTag, actionId } = re?.groups ?? {};\n      const actionName = !actionTag && !actionId ? actionIdent : null;\n      itemAction = item.actions.find((act) => {\n        if (actionId) return act.id === actionId;\n        if (actionTag) return act.tag === actionTag;\n        return act.name.localeCompare(actionName, undefined, { usage: \"search\" }) == 0;\n      });\n\n      if (!itemAction) {\n        const msg = game.i18n.format(\"FFD20.Warning.NoActionInItem\", { item: item.name, action: actionIdent });\n        ui.notifications.warn(msg, { console: false });\n        console.warn(\"FFD20 | @Use |\", msg, actor);\n        continue;\n      }\n\n      itemAction.use();\n    } else {\n      item.use();\n    }\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onAction(event, target) {\n  // Add additional options\n  const options = {};\n  const { action: actionIdent } = target.dataset;\n\n  const msgId = target.closest(\".chat-message[data-message-id]\")?.dataset.messageId;\n  const msg = game.messages.get(msgId);\n  const item = msg.itemSource;\n\n  if (!item) {\n    const warn = game.i18n.format(\"FFD20.EnrichedText.Errors.NoItemInMessage\");\n    ui.notifications.warn(warn, { console: false });\n    return void console.warn(\"FFD20 | @Action |\", warn, msg);\n  }\n\n  const actor = item.actor;\n\n  const re = /^(?:tag:(?<actionTag>.*?)|id:(?<actionId>.*?))$/.exec(actionIdent);\n  const { actionTag, actionId } = re?.groups ?? {};\n  const actionName = !actionTag && !actionId ? actionIdent : null;\n\n  const action = item.actions.find((act) => {\n    if (actionId) return act.id === actionId;\n    if (actionTag) return act.tag === actionTag;\n    return act.name.localeCompare(actionName, undefined, { usage: \"search\" }) == 0;\n  });\n\n  if (!action) {\n    const msg = game.i18n.format(\"FFD20.Warning.NoActionInItem\", { item: item.name, actor: actor.name });\n    ui.notifications.warn(msg, { console: false });\n    return void console.warn(\"FFD20 | @Action |\", msg, actor);\n  }\n\n  action.use();\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport async function onHealth(event, target) {\n  const { command, formula, speaker, nonlethal, manadamage, vars, dual, card } = target.dataset;\n\n  const actors = getRelevantActors(target);\n\n  // Add additional options\n  const options = {};\n  if (nonlethal) options.asNonlethal = true;\n  if (manadamage) options.asManaDamage = true;\n  if (affirmative.has(dual)) options.dualHeal = true;\n\n  const message = getMessage(target);\n  const speakerData = getSpeakerData(target, message);\n\n  const targetRollData = vars === \"target\";\n  let rollData = targetRollData ? null : getRollData(message);\n\n  const isHeal = command === \"heal\";\n\n  // Generate card\n  if (card && actors.size == 0) {\n    // TODO: Make card flavor better\n    ffd20.chat.command(command, formula, undefined, { rollData, speaker: speakerData });\n    return;\n  }\n\n  // Apply directly\n  for (const actor of actors) {\n    if (targetRollData) rollData = actor.getRollData();\n    // Roll card\n    if (card) {\n      const tname = actor.token?.name ?? actor.name;\n      ffd20.chat.command(command, formula, game.i18n.format(\"FFD20.EnrichedText.Subject\", { name: tname }), {\n        rollData,\n        speaker: speakerData,\n      });\n    }\n    // Apply directly\n    else {\n      const roll = await RollPF.safeRoll(formula, rollData);\n      let value = roll.total;\n      if (isHeal) value = -value;\n      actor.applyDamage(value, { ...options, event, element: target });\n    }\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport function onBrowse(event, target) {\n  const { category, options } = target.dataset;\n\n  // TODO: Configure browser filters with options.\n  // TODO: Find closest browser via SÃ¸rensenâDice coefficient or something.\n\n  const browser = ffd20.applications.compendiums[category];\n\n  const filters = {};\n\n  filters.tags = target.dataset.tag?.split(\";\").map((f) => f?.trim());\n  if (filters.tags?.length) browser._queueFilters(filters);\n\n  if (browser) browser.render(true, { focus: true });\n  else ui.notifications.error(game.i18n.format(\"FFD20.EnrichedText.Errors.BrowserNotFound\", { category }));\n}\n\n/**\n * Handle Condition click\n *\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n * @returns {void}\n */\nexport async function onCondition(event, target) {\n  const { condition, toggle, remove, duration, options, vars, info } = target.dataset;\n\n  const cond = ffd20.registry.conditions.getAliased(condition);\n  if (!cond) throw new Error(`Condition \"${condition}\" not found!`); // TODO: Error notification\n\n  let enableConfig = !remove;\n\n  let seconds = duration;\n  // Determine duration\n  if (duration && !info) {\n    const [time, unit] = parseDuration(duration);\n    if (time) {\n      const units = {\n        s: 1,\n        r: CONFIG.time.roundTime,\n        m: 60,\n        h: 60 * 60,\n      };\n      seconds = time * (units[unit?.[0]] ?? CONFIG.time.roundTime);\n    }\n  }\n\n  if (info) {\n    /** @type {JournalEntry} */\n    const journal = cond?.journal;\n    if (!journal) throw new Error(`Journal entry not found for condition \"${condition}\"`);\n    return void ffd20.utils.openJournal(journal);\n  }\n\n  const targetRollData = vars === \"target\";\n  let rollData;\n\n  if (seconds && !Number.isFinite(seconds) && !targetRollData) {\n    rollData = getRollData(getMessage(target));\n    seconds = (await RollPF.safeRoll(seconds, rollData)).total * CONFIG.time.roundTime;\n  }\n\n  const actors = getRelevantActors(target);\n\n  for (const actor of actors) {\n    if (!remove && seconds) {\n      // Flat number\n      if (Number.isFinite(seconds)) {\n        enableConfig = { duration: { seconds } };\n      }\n      // Roll\n      else {\n        if (targetRollData) rollData = actor.getRollData();\n        else\n          rollData ??= enableConfig = {\n            duration: { seconds: (await RollPF.safeRoll(seconds, rollData)).total * CONFIG.time.roundTime },\n          };\n      }\n    }\n\n    if (toggle) {\n      actor.toggleCondition(condition, enableConfig);\n    } else {\n      actor.setCondition(condition, enableConfig);\n    }\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport async function onApply(event, target) {\n  const { uuid, level, vars } = target.dataset;\n\n  const actors = getRelevantActors(target);\n  if (actors.length == 0) return;\n\n  const item = await fromUuid(uuid);\n  if (!item) {\n    const warn = game.i18n.localize(\"FFD20.EnrichedText.Errors.ItemNotFound\");\n    ui.notifications.warn(warn, { console: false });\n    return void console.error(\"FFD20 | @Apply |\", warn, uuid);\n  }\n\n  // TODO: Support more types (race, class, and few others should never be here)\n  if (item.type !== \"buff\") {\n    return void ui.notifications.error(\n      game.i18n.format(\"FFD20.EnrichedText.Errors.UnsupportedItemType\", { type: item.type })\n    );\n  }\n\n  // Prepare item\n  const itemData = game.items.fromCompendium(item, { clearFolder: true });\n  itemData.system.active = true;\n\n  let roll;\n  const targetRollData = vars === \"target\";\n  const message = getMessage(target);\n  let rollData = targetRollData ? null : getRollData(message);\n  if (!targetRollData && level?.length) {\n    roll = await RollPF.safeRoll(level, rollData);\n    itemData.system.level = roll.total;\n  }\n\n  // Apply\n  for (const actor of actors) {\n    if (targetRollData && level?.length) {\n      rollData = actor.getRollData();\n      roll = await RollPF.safeRoll(level, rollData);\n      itemData.system.level = roll.total;\n    }\n\n    // Activate existing item with same source\n    const old = actor.itemTypes[item.type].find((i) => i._stats?.compendiumSource === uuid);\n    if (old) {\n      const activationData = { system: { active: true } };\n      if (roll) activationData.system.level = roll.total;\n      old.update(activationData);\n    }\n    // Add new\n    else {\n      Item.implementation.create(itemData, { parent: actor });\n    }\n  }\n}\n\n/**\n * @param {Event} event - Triggering event\n * @param {HTMLElement} target - Triggered element\n */\nexport async function onToggle(event, target) {\n  const { name, level, enable, disable, type, vars } = target.dataset;\n\n  const actors = getRelevantActors(target);\n  if (actors.length == 0) return;\n\n  let state;\n  if (enable) state = true;\n  else if (disable) state = false;\n\n  const targetRollData = vars === \"target\";\n  const message = getMessage(target);\n  let rollData = targetRollData ? null : getRollData(message);\n\n  for (const actor of actors) {\n    //\n    let items = actor.items;\n    if (type) items = actor.itemTypes[type];\n    const item = items?.getName(name);\n\n    // TODO: Attempt to find item based on source UUID\n\n    if (item) {\n      console.debug(\n        `FFD20 | @Toggle | Setting ${name} state to`,\n        state ?? !item.activeState,\n        `on ${actor.name} [${actor.uuid}]`\n      );\n      // Special handling for buffs to assign level\n      if (type === \"buff\" && level) {\n        if (targetRollData) rollData = actor.getRollData();\n        const roll = await RollPF.safeRoll(level, rollData);\n\n        item.update({\n          system: {\n            active: state ?? !item.activeState,\n            level: roll.total,\n          },\n        });\n      } else {\n        item.setActive(state ?? !item.activeState);\n      }\n    } else {\n      console.debug(`FFD20 | @Toggle | ${name} not found on ${actor.name} [${actor.uuid}]`);\n      if (actors.size === 1) ui.notifications.error(\"FFD20.EnrichedText.Errors.ItemNotFound\", { localize: true });\n    }\n  }\n}\n\n/**\n * Text enrichers\n */\nexport const enrichers = [\n  // @Apply\n  new PF1TextEnricher(\n    \"apply\",\n    /@Apply\\[(?<ident>.*?)(?:;(?<options>.*?))?\\](?:\\{(?<label>.*?)})?/g,\n    async (match, _options) => {\n      const { ident, options, label } = match.groups;\n\n      const item = fromUuidSync(ident) ?? fromUuidSync(await findItem(ident, { type: \"buff\" }));\n\n      if (!item) console.warn(\"FFD20 | @Apply | Could not find item\", ident);\n\n      const broken = !item;\n\n      const a = createElement({ label, click: true, handler: \"apply\", options, broken });\n\n      if (item) {\n        a.dataset.name = `${game.i18n.localize(\"DOCUMENT.Item\")}: ${item.name}`;\n        a.dataset.uuid = item.uuid;\n        a.append(item.name);\n\n        generateTooltip(a);\n      } else {\n        a.replaceChildren(ident);\n      }\n\n      setIcon(a, \"fa-solid fa-angles-right\");\n\n      return a;\n    },\n    {\n      click: onApply,\n    }\n  ),\n  // @Toggle\n  new PF1TextEnricher(\n    \"toggle\",\n    /@Toggle\\[(?<ident>.*?)(?:;(?<options>.*?))?\\](?:\\{(?<label>.*?)})?/g,\n    async (match, _options) => {\n      const { ident, options, label } = match.groups;\n      if (!ident) throw new Error(\"No target\");\n\n      const a = createElement({ label, click: true, handler: \"toggle\", options });\n\n      a.dataset.name = ident.trim();\n\n      generateTooltip(a);\n\n      a.append(label || ident);\n      if (a.dataset.enable) setIcon(a, \"fa-solid fa-toggle-on\");\n      else if (a.dataset.disable) setIcon(a, \"fa-solid fa-toggle-off\");\n      else setIcon(a, \"fa-solid fa-shuffle\");\n\n      return a;\n    },\n    {\n      click: onToggle,\n    }\n  ),\n  // @Save\n  new PF1TextEnricher(\n    \"save\",\n    /@Save\\[(?<save>\\w+)(;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match, { rollData } = {}) => {\n      const { save, options, label } = match.groups;\n      const a = createElement({ label, click: true, handler: \"save\", options });\n      const name = ffd20.config.savingThrows[save];\n\n      let dc = a.dataset.dc;\n      // DC is not simple value\n      // For supporting things like: @Save[ref;dc=15+@attributes.hd.total + 2]\n      if (dc?.length && !/^\\d+$/.test(dc)) {\n        a.dataset.formula = dc;\n        const roll = RollPF.safeRollSync(dc, rollData, { formula: dc }, {}, { minimize: true });\n        dc = roll.total;\n        a.dataset.dc = dc;\n      }\n\n      const title = dc?.length ? game.i18n.format(\"FFD20.SavingThrowButtonLabel\", { type: name, dc }) : name;\n      a.append(title);\n      a.dataset.type = save;\n      if (dc?.length) a.dataset.sensitiveLabel = name;\n\n      generateTooltip(a);\n      setIcon(a, \"fa-solid fa-shield-halved\");\n\n      return a;\n    },\n    {\n      click: onSave,\n    }\n  ),\n  // @Ability\n  new PF1TextEnricher(\n    \"ability\",\n    /@Ability\\[(?<ability>\\w+)(;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match, _options) => {\n      const { ability, label, options } = match.groups;\n      const a = createElement({ label, click: true, handler: \"ability\", options });\n      const title = ffd20.config.abilities[ability] ?? ability;\n      a.dataset.ability = ability;\n      a.append(title);\n\n      generateTooltip(a);\n      setIcon(a, \"fa-solid fa-brain\");\n\n      return a;\n    },\n    {\n      click: onAbility,\n    }\n  ),\n  // @Skill\n  new PF1TextEnricher(\n    \"skill\",\n    /@Skill\\[(?<skill>\\w+)(;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match, { rollData }) => {\n      const { skill, label, options } = match.groups;\n      const a = createElement({ label, click: true, handler: \"skill\", options });\n      const name = ffd20.config.skills[skill] ?? skill;\n      a.dataset.skill = skill;\n\n      if (a.dataset.info) {\n        const compendium = ffd20.config.skillCompendiumEntries[skill];\n        if (!compendium) return;\n        setIcon(a, \"fa-solid fa-book\");\n      } else {\n        setIcon(a, \"fa-solid fa-hands-clapping\");\n      }\n\n      let dc = a.dataset.dc;\n      // DC is not simple value\n      // For supporting things like: @Save[ref;dc=15+@attributes.hd.total + 2]\n      if (dc?.length && !/^\\d+$/.test(dc)) {\n        a.dataset.formula = dc;\n        const roll = RollPF.safeRollSync(dc, rollData, { formula: dc }, {}, { minimize: true });\n        dc = roll.total;\n        a.dataset.dc = dc;\n      }\n      const title = dc?.length ? game.i18n.format(\"FFD20.SavingThrowButtonLabel\", { type: name, dc }) : name;\n      a.append(title);\n      if (dc?.length) a.dataset.sensitiveLabel = name;\n\n      generateTooltip(a);\n\n      return a;\n    },\n    {\n      click: onSkill,\n    }\n  ),\n  // @Use\n  new PF1TextEnricher(\n    \"use\",\n    /@Use\\[(?<item>.*?)(?:#(?<action>.*?))?(?:;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n\n    (match, _options) => {\n      const { item, action, label, options } = match.groups;\n      const a = createElement({ label, click: true, handler: \"use\", options });\n      a.append(item?.trim());\n      a.dataset.item = item?.trim();\n      if (action) {\n        const displayAction = action.replace(/^(id|tag):\\s*/, \"\")?.trim();\n        // TODO: pretty print action name if speaker option is enabled\n        a.append(` (${displayAction})`);\n        a.dataset.action = action?.trim();\n      }\n\n      generateTooltip(a);\n      setIcon(a, \"fa-solid fa-trowel\");\n\n      return a;\n    },\n    {\n      click: onUse,\n    }\n  ),\n  // @Action\n  new PF1TextEnricher(\n    \"action\",\n    /@Action\\[(?<action>.*?)(?:;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match, _options) => {\n      const { action, label, options } = match.groups;\n      const a = createElement({ label, click: true, handler: \"action\", options });\n      // TODO: Pretty print the action name, especially if speaker option is enabled\n      a.append(action);\n      a.dataset.speaker = true;\n      a.dataset.action = action?.trim();\n\n      generateTooltip(a);\n      setIcon(a, \"fa-solid fa-trowel\");\n\n      return a;\n    },\n    {\n      click: onAction,\n    }\n  ),\n  // @Heal & @Damage\n  new PF1TextEnricher(\n    \"health\",\n    /@(?<command>Heal|Damage)\\[(?<formula>.*?)(?:;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match, _options) => {\n      const { command, formula, label, options } = match.groups;\n      const a = createElement({ click: true, handler: \"health\", options });\n      a.dataset.command = command.toLowerCase();\n      a.dataset.formula = formula;\n\n      a.append(\n        game.i18n.format(`FFD20.EnrichedText.Health.${command}`, {\n          value: label || formula,\n          NL: a.dataset.nonlethal ? game.i18n.localize(\"FFD20.EnrichedText.Health.NL\") : \"\",\n        })\n      );\n\n      generateTooltip(a, { card: true });\n\n      if (a.dataset.command === \"heal\") setIcon(a, \"fa-solid fa-heart-pulse\");\n      else setIcon(a, \"fa-solid fa-heart-crack\");\n\n      return a;\n    },\n    {\n      click: onHealth,\n    }\n  ),\n  // @Browse\n  new PF1TextEnricher(\n    \"browse\",\n    /@Browse\\[(?<category>\\w+)(?:;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match) => {\n      const { category, label, options } = match.groups;\n      const a = createElement({ click: true, handler: \"browse\", options });\n\n      a.dataset.category = category;\n\n      let mainlabel;\n      const browser = ffd20.applications.compendiumBrowser.CompendiumBrowser.BROWSERS[category];\n      if (!browser) {\n        setIcon(a, \"fa-solid fa-link-slash\");\n        a.classList.add(\"invalid\");\n        mainlabel = category;\n      } else {\n        setIcon(a, \"fa-solid fa-book\");\n        mainlabel = game.i18n.localize(browser.typeName);\n      }\n\n      mainlabel = game.i18n.format(\"FFD20.EnrichedText.Browse\", { value: mainlabel });\n\n      if (label) a.append(label);\n      else a.append(mainlabel);\n\n      generateTooltip(a);\n\n      if (label) a.dataset.tooltip = mainlabel;\n      if (!browser) {\n        if (label) a.dataset.tooltip += \"<br>\";\n        a.dataset.tooltip +=\n          game.i18n.localize(\"FFD20.EnrichedText.Error\") +\n          \": \" +\n          game.i18n.localize(\"FFD20.EnrichedText.Errors.NoCategory\");\n      }\n\n      return a;\n    },\n    {\n      click: onBrowse,\n    }\n  ),\n  // Weight\n  new PF1TextEnricher(\"weight\", /@Weight\\[(?<formula>.+?)(?:;(?<options>.*?))?\\]/g, (match, rollData) => {\n    const { formula, options } = match.groups;\n\n    const a = createElement({ options });\n\n    const isDual = !!a.dataset.dual;\n\n    const re = /^(?<value>.+?)\\s*(?<unit>lbs|kg)?$/.exec(formula);\n    const { value, unit } = re?.groups ?? {};\n    if (unit === \"kg\") {\n      a.dataset.metric = \"true\";\n      delete a.dataset.imperial;\n    } else if (unit === \"lbs\") {\n      a.dataset.imperial = \"true\";\n      delete a.dataset.metric;\n    }\n\n    const sourceMetric = !!a.dataset.metric;\n    const sourceImperial = !sourceMetric;\n\n    const total = RollPF.safeRollSync(value || \"0\", rollData).total;\n\n    let lbs = total,\n      kg = total;\n\n    if (sourceImperial) kg = ffd20.utils.swapWeight(total, \"lbs\");\n    if (sourceMetric) lbs = ffd20.utils.swapWeight(total, \"kg\");\n\n    const kgl = `${ffd20.utils.limitPrecision(kg, 3)} ${game.i18n.localize(\"FFD20.Kgs\")}`;\n    const lbsl = `${ffd20.utils.limitPrecision(lbs, 3)} ${game.i18n.localize(\"FFD20.Lbs\")}`;\n\n    const isMetric = ffd20.utils.getWeightSystem() == \"metric\";\n\n    let label;\n    if (isDual) {\n      if (isMetric) label = `${kgl} (${lbsl})`;\n      else label = `${lbsl} (${kgl})`;\n    } else if (isMetric) label = kgl;\n    else label = lbsl;\n\n    a.textContent = label;\n\n    return a;\n  }),\n  // Distance\n  new PF1TextEnricher(\"distance\", /@Distance\\[(?<formula>.+?)(?:;(?<options>.*?))?\\]/g, (match, rollData) => {\n    const { formula, options } = match.groups;\n\n    const a = createElement({ options });\n\n    const isDual = !!a.dataset.dual;\n\n    const re = /^(?<value>.+?)\\s*(?<unit>ft|m)?$/.exec(formula);\n    const { value, unit } = re?.groups ?? {};\n    if (unit === \"m\") {\n      a.dataset.metric = \"true\";\n      delete a.dataset.imperial;\n    } else if (unit === \"ft\") {\n      a.dataset.imperial = \"true\";\n      delete a.dataset.metric;\n    }\n\n    const sourceMetric = !!a.dataset.metric;\n    const sourceImperial = !sourceMetric;\n\n    const total = RollPF.safeRollSync(value || \"0\", rollData).total;\n    let ft = total,\n      m = total;\n\n    if (sourceImperial) m = ffd20.utils.swapDistance(total, \"ft\");\n    if (sourceMetric) ft = ffd20.utils.swapDistance(total, \"m\");\n\n    const ml = `${ffd20.utils.limitPrecision(m, 3)} ${ffd20.config.measureUnitsShort.m}`;\n    const ftl = `${ffd20.utils.limitPrecision(ft, 3)} ${ffd20.config.measureUnitsShort.ft}`;\n\n    const isMetric = ffd20.utils.getDistanceSystem() == \"metric\";\n\n    let label;\n    if (isDual) {\n      if (isMetric) label = `${ml} (${ftl})`;\n      else label = `${ftl} (${ml})`;\n    } else if (isMetric) label = ml;\n    else label = ftl;\n\n    a.textContent = label;\n\n    a.dataset.tooltip = formula;\n\n    return a;\n  }),\n  // @Condition\n  new PF1TextEnricher(\n    \"condition\",\n    /@Condition\\[(?<condition>\\w+)(?:;(?<options>.*?))?](?:\\{(?<label>.*?)})?/g,\n    (match) => {\n      const { condition, options, label } = match.groups;\n\n      // TODO: Find closest condition via SÃ¸rensenâDice coefficient or something.\n      let cond = ffd20.registry.conditions.getAliased(condition);\n      if (!cond) {\n        // No direct match, find closest matching conditions and take the one with longest ID\n        const condId = [\n          ...ffd20.registry.conditions.keys(),\n          ...[...ffd20.registry.conditions.values()].map((e) => [...e.aliases]).flat(),\n        ]\n          .filter((c) => c.startsWith(condition))\n          .sort((a, b) => b.length - a.length)[0];\n        cond = ffd20.registry.conditions.getAliased(condId);\n      }\n      let text = label || cond?.name || condition;\n\n      const broken = !cond;\n\n      const a = createElement({ click: true, handler: \"condition\", options, broken });\n      if (!cond) a.classList.add(\"broken\");\n\n      a.dataset.condition = cond?.id || condition;\n\n      if (a.dataset.disable) a.dataset.remove = true;\n\n      if (a.dataset.info) {\n        setIcon(a, \"fa-solid fa-book\");\n        if (!cond?.journal) a.classList.add(\"broken\");\n      } else if (a.dataset.remove) {\n        setIcon(a, \"fa-solid fa-minus\");\n        a.dataset.tooltip = game.i18n.format(\"FFD20.EnrichedText.Remove\", { value: text });\n      } else if (a.dataset.toggle) {\n        setIcon(a, \"fa-solid fa-plus-minus\");\n        a.dataset.tooltip = game.i18n.format(\"FFD20.EnrichedText.Toggle\", { value: text });\n      } else {\n        setIcon(a, \"fa-solid fa-plus\");\n        a.dataset.tooltip = game.i18n.format(\"FFD20.EnrichedText.Add\", { value: text });\n      }\n\n      if (a.dataset.duration) {\n        let [period, _, unit] = parseDuration(a.dataset.duration);\n        if (!period) {\n          // On parse failing, treat it as complex formula\n          period = a.dataset.duration;\n          unit = game.i18n.localize(\"FFD20.Time.Period.round.Label\");\n        }\n        a.dataset.tooltip += \"<br>\" + game.i18n.format(\"FFD20.EnrichedText.Condition.Duration\", { unit, period });\n        text = game.i18n.format(\"FFD20.ForDuration\", {\n          subject: text,\n          duration: game.i18n.format(\"FFD20.Time.Format\", { value: period, unit }),\n        });\n      }\n\n      a.append(text);\n\n      return a;\n    },\n    {\n      click: onCondition,\n    }\n  ),\n  // @Draw\n  new PF1TextEnricher(\n    \"draw\",\n    /@Draw\\[(?<ident>.*?)\\](?:\\{(?<label>.*?)\\})?/g,\n    /**\n     * @param {any} match\n     * @param {unknown} _options\n     * @returns\n     */\n    async (match, _options) => {\n      const { ident, label } = match.groups;\n\n      const table = fromUuidSync(ident) || game.tables.getName(ident);\n\n      if (!table) console.warn(\"FFD20 | @Draw | Could not find roll table\", ident);\n\n      const broken = !table;\n\n      const a = createElement({ click: true, handler: \"draw\", broken });\n\n      if (table) {\n        a.dataset.name = `${game.i18n.localize(\"DOCUMENT.RollTable\")}: ${table.name}`;\n        a.dataset.ident = table.uuid;\n\n        a.append(label || table.name);\n\n        generateTooltip(a);\n      } else {\n        a.replaceChildren(ident);\n      }\n\n      setIcon(a, \"fa-solid fa-th-list\");\n\n      return a;\n    },\n    {\n      click: onDraw,\n    }\n  ),\n  // Source\n  new PF1TextEnricher(\"source\", /@Source\\[(?<ident>\\w+)(?:;(?<options>.*?))?]/g, async (match, _options) => {\n    const { ident, options } = match.groups;\n\n    let source = ffd20.registry.sources.get(ident);\n    if (!source) source = ffd20.registry.sources.find((s) => s.abbr.toLowerCase() === ident.toLowerCase());\n\n    const a = createElement({ handler: \"source\", options, broken: !source });\n\n    if (source) {\n      a.append(source.name);\n      const pages = a.dataset.pages;\n      if (pages) a.append(\" \", game.i18n.format(\"FFD20.ContentSource.Pages\", { pages }));\n\n      // Tooltip\n      const tips = [game.i18n.localize(\"FFD20.ContentSource.Info.ID\") + \": \" + source.id];\n      if (source.date) tips.push(game.i18n.localize(\"FFD20.ContentSource.Info.Release\") + \": \" + source.date);\n      if (source.publisher) tips.push(game.i18n.localize(\"FFD20.ContentSource.Info.Publisher\") + \": \" + source.publisher);\n      a.dataset.tooltip = tips.join(\"<br>\");\n    } else {\n      a.replaceChildren(ident);\n    }\n\n    setIcon(a, \"fa-solid fa-bookmark\");\n\n    return a;\n  }),\n];\n\n/**\n * Register in setup phase so modules can alter the enrichers before they're registered\n * ... and become largely immutable without deeper modification.\n * Otherwise this could be done in init phase.\n */\nHooks.once(\"setup\", () => {\n  CONFIG.TextEditor.enrichers.push(...enrichers);\n});\n\n/**\n * Proxy click and drag events to the enrichers\n *\n * @param {JQuery<MouseEvent>} event Click event\n * @param click\n */\nconst onEnrichedInteraction = (event, click = true) => {\n  const target = event.currentTarget,\n    handler = target.dataset.handler,\n    enricher = enrichers.find((e) => e.id === handler);\n\n  if (!enricher) throw new Error(`Relevant enricher not found: ${handler}`);\n\n  if (target.classList.contains(\"broken\")) return;\n\n  event.stopPropagation();\n  event.preventDefault();\n\n  if (click) enricher.click(event, target);\n  else enricher.drag(event, target);\n};\n\n// Register click & drag handlers\nHooks.once(\"ready\", () => {\n  // Mimic Foundry listener handling for simplicity\n  // TODO: Use plain DOM instead\n  const body = $(\"body\");\n  body.on(\"click\", \"a.pf1-link.button\", (event) => onEnrichedInteraction(event, true));\n  //body.on(\"drag\", \"a.pf1-link.content\", (event) => onEnrichedInteraction(event, false));\n});\n","/**\n * Handle custom chat commands\n *\n * @param {string} command - Command\n * @param {string} message - Message\n * @param {string} comment - Comment\n * @param {object} options - Additional options\n */\nexport async function command(command, message, comment, options) {\n  command = command.toUpperCase();\n  let { speaker, rollData } = options;\n\n  speaker = speaker ?? ChatMessage.implementation.getSpeaker();\n  const actor = ChatMessage.implementation.getSpeakerActor(speaker);\n  const token = actor?.token;\n\n  switch (command) {\n    case \"D\":\n    case \"DAMAGE\":\n    case \"H\":\n    case \"HEAL\": {\n      rollData ??= actor?.getRollData() ?? {};\n      const roll = await new Roll(message, rollData).evaluate();\n\n      const isHealing = command[0] === \"H\";\n      const content = await renderTemplate(\"systems/ffd20/templates/chat/simple-damage.hbs\", {\n        actor,\n        token,\n        isHealing,\n        css: isHealing ? \"heal\" : \"damage\",\n        value: {\n          total: roll.total * (isHealing ? -1 : 1),\n          half: Math.floor(roll.total / 2) * (isHealing ? -1 : 1),\n        },\n        roll,\n        total: roll.total,\n        details: await roll.getTooltip(),\n        hasDetails: roll.terms.length > 1 || !roll.isDeterministic,\n      });\n\n      const chatOptions = {\n        // TODO: Apply custom message type\n        rolls: [roll],\n        flavor: comment,\n        sound: CONFIG.sounds.dice,\n        speaker,\n        rollMode: game.settings.get(\"core\", \"rollMode\"),\n        content,\n        system: {\n          subject: { health: isHealing ? \"healing\" : \"damage\" },\n        },\n      };\n\n      ChatMessage.implementation.create(chatOptions);\n    }\n  }\n}\n\n/**\n * `chatMessage` hook event handler.\n *\n * @param {ChatLog} app - Chat log\n * @param {string} msg - Chat message\n * @param {object} options - Options\n * @returns {boolean|void} - False if processing is to stop. Nothing otherwise.\n */\nfunction handleChatInput(app, msg, options) {\n  if (/^\\/(h|heal|d|damage)/i.test(msg)) {\n    try {\n      const re = /^\\/(?<command>h|heal|d|damage)\\s+(?<formula>.*?)(\\s*#\\s*(?<comment>.*))?$/i.exec(msg);\n      if (re) {\n        const { command, formula, comment } = re.groups;\n        console.debug(\"FFD20 | Chat command:\", { command, formula, comment });\n        ffd20.chat.command(command, formula, comment, options);\n      } else {\n        ui.notifications.error(\"FFD20.Error.CommandParse\", { localize: true });\n      }\n    } catch (err) {\n      console.error(\"Failed to parse command:\", msg, \"\\n\", err);\n    }\n    return false;\n  }\n}\n\nHooks.on(\"chatMessage\", handleChatInput);\n","const withinAngle = (min, max, value) => {\n  min = Math.normalizeDegrees(min);\n  max = Math.normalizeDegrees(max);\n  value = Math.normalizeDegrees(value);\n\n  if (min < max) return value >= min && value <= max;\n  return value >= min || value <= max;\n};\n\n/**\n * @param {Point} point\n * @param {Rectangle} rect\n * @returns {boolean}\n */\nconst withinRect = (point, rect) => {\n  return point.x >= rect.x && point.x < rect.x + rect.width && point.y >= rect.y && point.y < rect.y + rect.height;\n};\n\n/**\n * Applies patches to core functions to integrate Pathfinder specific measurements.\n *\n * Replacement for `CONFIG.Canvas.layers.templates.layerClass`\n */\nexport class TemplateLayerPF extends TemplateLayer {\n  /**\n   * Override to provide snapped drag for cone template direction.\n   *\n   * @override\n   * @param {Event} event\n   * Synced with Foundry v12.331\n   */\n  _onDragLeftMove(event) {\n    if (!game.settings.get(\"ffd20\", \"measureStyle\")) return super._onDragLeftMove(event);\n\n    const interaction = event.interactionData;\n\n    // Snap the destination to the grid\n    const snapToGrid = !event.shiftKey;\n    if (snapToGrid) {\n      const snapMode =\n        CONST.GRID_SNAPPING_MODES.CENTER | CONST.GRID_SNAPPING_MODES.EDGE_MIDPOINT | CONST.GRID_SNAPPING_MODES.CORNER;\n      interaction.destination = this.getSnappedPoint(interaction.destination, { mode: snapMode });\n    }\n\n    // Compute the ray\n    const { origin, destination, preview } = interaction;\n    const ray = new Ray(origin, destination);\n    let distance;\n\n    // Grid type\n    if (game.settings.get(\"core\", \"gridTemplates\")) {\n      distance = canvas.grid.measurePath([origin, destination]).distance;\n    }\n    // Euclidean type\n    else {\n      const ratio = canvas.dimensions.size / canvas.dimensions.distance;\n      distance = ray.distance / ratio;\n    }\n\n    // Update the preview object\n    if (snapToGrid && preview.document.t === \"cone\") {\n      const halfAngle = CONFIG.MeasuredTemplate.defaults.angle / 2;\n      const baseDirection = Math.normalizeDegrees(Math.toDegrees(ray.angle));\n      preview.document.direction = Math.floor((baseDirection + halfAngle / 2) / halfAngle) * halfAngle;\n    } else {\n      preview.document.direction = Math.normalizeDegrees(Math.toDegrees(ray.angle));\n    }\n    preview.document.distance = distance;\n    preview.renderFlags.set({ refreshShape: true });\n  }\n}\n\nexport class MeasuredTemplatePF extends MeasuredTemplate {\n  /**\n   * Calculates a set of x & y coordinates that the template actually should have based on type and origin\n   *\n   * @returns {{x: number, y: number}}\n   * @private\n   */\n  _getTemplateSnapCoordinates() {\n    let { x, y } = this.document;\n    const grid = canvas.grid;\n\n    if (this.document.t === \"cone\" && game.canvas.grid.isSquare) {\n      const angle = this.document.direction;\n\n      if (angle <= 45 || angle >= 315) {\n        x = Math.ceil(x / grid.size) * grid.size;\n      } else if (angle >= 135 && angle <= 225) {\n        x = Math.floor(x / grid.size) * grid.size;\n      }\n\n      if (angle >= 45 && angle <= 135) {\n        y = Math.ceil(y / grid.size) * grid.size;\n      } else if (angle >= 225 && angle <= 315) {\n        y = Math.floor(y / grid.size) * grid.size;\n      }\n    }\n\n    return { x, y };\n  }\n\n  /**\n   * Recalculate template visual element positions based on snap coordinates\n   *\n   * @private\n   */\n  _setElementOffsets() {\n    const { x: snapX, y: snapY } = this._getTemplateSnapCoordinates();\n    const offsetX = snapX - this.document.x;\n    const offsetY = snapY - this.document.y;\n\n    this.template.x = offsetX;\n    this.template.y = offsetY;\n\n    this.ruler.position.set(this.ray?.dx + 10 + offsetX, this.ray?.dy + 5 + offsetY);\n  }\n\n  /**\n   * @override\n   * @private\n   */\n  _refreshRulerText() {\n    super._refreshRulerText();\n    this._setElementOffsets();\n  }\n\n  /**\n   * @override\n   * @private\n   */\n  _refreshPosition() {\n    super._refreshPosition();\n    this._setElementOffsets();\n  }\n\n  /**\n   * @override\n   * @private\n   */\n  _refreshTemplate() {\n    super._refreshTemplate();\n    this._setElementOffsets();\n  }\n\n  /**\n   * Get highlighted square coordinates.\n   *\n   * Supports only circle, cone and ray templates.\n   *\n   * @protected\n   * @override\n   * @returns {Point[]} - Array of grid coordinates\n   */\n  _getGridHighlightPositions() {\n    const templateType = this.document.t;\n    // In case this is not initialized, not circle or cone, or system measure templates are disabled, let Foundry handle it.\n    // Foundry's handling of Ray is perfectly usable even if slightly wrong, so no override needed.\n    if (\n      !game.settings.get(\"ffd20\", \"measureStyle\") ||\n      (templateType !== \"circle\" && (templateType !== \"cone\" || canvas.grid.isHexagonal))\n    ) {\n      return super._getGridHighlightPositions();\n    }\n\n    const grid = canvas.grid;\n    const { x: ox, y: oy } = this._getTemplateSnapCoordinates();\n\n    // Test if template origin is in the center of a grid space. Apply a grace margin for odd grid sizes\n    const originInCenter = ox % grid.size === Math.ceil(grid.size / 2) && oy % grid.size === Math.ceil(grid.size / 2);\n\n    const shape = this.shape;\n    const bounds = shape.getBounds();\n    bounds.x += ox;\n    bounds.y += oy;\n    bounds.fit(canvas.dimensions.rect);\n    bounds.pad(1);\n\n    // Identify grid spaces that are in \"walking distance\" of the template origin\n    const positions = [];\n    const [i0, j0, i1, j1] = grid.getOffsetRange(bounds);\n    for (let i = i0; i < i1; i++) {\n      for (let j = j0; j < j1; j++) {\n        const offset = { i, j };\n        const { x: cx, y: cy } = grid.getCenterPoint(offset);\n\n        const distance = grid.measurePath([\n          { x: cx, y: cy },\n          { x: ox, y: oy },\n        ]).distance;\n\n        switch (templateType) {\n          case \"cone\": {\n            // Include all squares that are within \"walking distance\"\" and within 45 degrees of the cone direction\n            const angle = (Math.atan2(cy - oy, cx - ox) * 180) / Math.PI;\n            const angleDiff = Math.abs(angle - this.document.direction) % 360;\n            const docAngle = this.document.angle / 2;\n\n            if (distance < this.document.distance && (angleDiff <= docAngle || angleDiff >= 360 - docAngle)) {\n              positions.push(grid.getTopLeftPoint(offset));\n            }\n            break;\n          }\n\n          case \"circle\":\n            // If template origin lies in grid center, include all squares that have their center within the distance, otherwise only those that are strictly within\n            // Centered circles get a 2% grace margin in distance calculation to deal with uneven grid sizes\n            if (\n              originInCenter || canvas.grid.isHexagonal\n                ? distance <= this.document.distance * 1.02\n                : distance < this.document.distance\n            ) {\n              positions.push(grid.getTopLeftPoint(offset));\n            }\n            break;\n        }\n      }\n    }\n    return positions;\n  }\n\n  /**\n   * Determine tokens residing within the template bounds, based on either grid highlight logic or token center.\n   *\n   * @public\n   * @returns {Promise<Token[]>} Tokens sufficiently within the template.\n   */\n  async getTokensWithin() {\n    const shape = this.document.t,\n      dimensions = this.scene.dimensions,\n      gridSizePx = dimensions.size,\n      gridSizeUnits = dimensions.distance;\n\n    const getCenter = () => {\n      if (shape !== \"rect\") return this.center;\n      // Hack: Fix for Foundry bug where .center for rectangle template returns top-left corner instead.\n      return {\n        x: this.x + this.width / 2,\n        y: this.y + this.height / 2,\n      };\n    };\n\n    // Ensure shape and related data exists (e.g. this.ray) for getHighlightedSquares to work correctly.\n    // this.width, this.height, etc. are wrong without this\n    if (!this.shape) {\n      this._applyRenderFlags({ refreshShape: true });\n      // HACK: Wait for next tick, the template won't be finalized by Foundry until then.\n      // Likely breaks with Foundry v12 with newer PIXI version\n      await new Promise((resolve) => canvas.app.ticker.addOnce(() => resolve()), undefined, PIXI.UPDATE_PRIORITY.LOW);\n    }\n\n    const tCenter = getCenter();\n\n    const { distance, angle, direction } = this.document;\n\n    // Max distance from template center, +1 cell for proper detection, and +1 pixel for uneven grids and rounding protection\n    const maxDistance = Math.max(this.height, this.width) + gridSizePx + 1;\n    // Get tokens within max potential distance from the template\n    const relevantTokens = new Set(\n      canvas.tokens.placeables.filter((t) => new Ray(t.center, tCenter).distance - t.sizeErrorMargin <= maxDistance)\n    );\n\n    const results = new Set();\n\n    const isLargeToken = (t) => t.document.width > 1 || t.document.height > 1;\n\n    const withinCircle = (target) => {\n      const ray = new Ray(tCenter, target);\n      // Calculate ray length in relation to circle radius\n      const raySceneLength = (ray.distance / gridSizePx) * gridSizeUnits;\n      // Include this token if its center is within template radius\n      return raySceneLength <= distance + 1;\n    };\n\n    const withinCone = (target, minAngle, maxAngle) => {\n      const ray = new Ray(tCenter, target);\n      const rayAngle = Math.normalizeDegrees(Math.toDegrees(ray.angle));\n      const rayWithinAngle = withinAngle(minAngle, maxAngle, rayAngle);\n      // Calculate ray length in relation to circle radius\n      const raySceneLength = (ray.distance / gridSizePx) * gridSizeUnits;\n      // Include token if its within template distance and within the cone's angle\n      return rayWithinAngle && raySceneLength <= distance + 1;\n    };\n\n    // Rectangle has same handling everywhere\n    if (shape === \"rect\") {\n      const rect = {\n        x: this.x,\n        y: this.y,\n        width: this.shape.width,\n        height: this.shape.height,\n      };\n\n      for (const t of relevantTokens) {\n        if (isLargeToken(t)) {\n          const cells = t.getOccupiedCells({ center: true });\n          if (cells.some((c) => withinRect(c, rect))) results.add(t);\n        } else {\n          if (withinRect(t.center, rect)) results.add(t);\n        }\n      }\n    }\n    // Special handling for gridless\n    else if (canvas.grid.type === CONST.GRID_TYPES.GRIDLESS && [\"circle\", \"cone\"].includes(shape)) {\n      // Pre-calc cone data\n      let minAngle, maxAngle;\n      if (shape === \"cone\") {\n        minAngle = Math.normalizeDegrees(direction - angle / 2);\n        maxAngle = Math.normalizeDegrees(direction + angle / 2);\n      }\n\n      // TODO: Test against vision points and ensure ~third of them are inside the template instead.\n      for (const t of relevantTokens) {\n        const cells = isLargeToken(t) ? t.getOccupiedCells({ center: true }) : [t.center];\n\n        switch (shape) {\n          case \"circle\": {\n            if (cells.some((c) => withinCircle(c))) results.add(t);\n            break;\n          }\n          case \"cone\": {\n            if (cells.some((c) => withinCone(c, minAngle, maxAngle))) results.add(t);\n            break;\n          }\n        }\n      }\n    }\n    // Non-gridless\n    else {\n      const mapCoordsToCell = ({ x, y }) => ({ x, y, width: gridSizePx, height: gridSizePx });\n\n      const highlightSquares = this._getGridHighlightPositions().map(mapCoordsToCell);\n      for (const cell of highlightSquares) {\n        for (const t of relevantTokens) {\n          const cells = isLargeToken(t) ? t.getOccupiedCells({ center: true }) : [t.center];\n\n          if (cells.some((tc) => withinRect(tc, cell))) {\n            results.add(t);\n            relevantTokens.delete(t);\n          }\n        }\n      }\n    }\n\n    return Array.from(results);\n  }\n\n  getHighlightLayer() {\n    return canvas.interface.grid.getHighlightLayer(this.highlightId);\n  }\n\n  /**\n   * Return origin item if any.\n   *\n   * @type {Item|ffd20.components.ItemAction|null}\n   */\n  get origin() {\n    const { uuid, action: actionId } = this.document.getFlag(\"ffd20\", \"origin\") ?? {};\n    if (!uuid) return null;\n    const item = fromUuidSync(uuid);\n    const action = item?.actions?.get(actionId);\n    return action ?? item ?? null;\n  }\n}\n","// TODO: Make the highlight colors configurable\nconst rangeColor = {\n  fill: Color.from(\"#FF0000\"),\n  border: Color.from(\"#FF0000\").multiply(0.9),\n};\nconst reachColor = {\n  fill: Color.from(\"#FFFF00\"),\n  border: Color.from(\"#FFFF00\").multiply(0.9),\n};\n\nclass SquareHighlight {\n  constructor(origin, fillColor = 0x00ff00, borderColor = 0x000000, name) {\n    this.origin = origin;\n    this.borderColor = borderColor;\n    this.fillColor = fillColor;\n    this._squares = [];\n\n    this._id = foundry.utils.randomID();\n    this.name = name;\n    this.layer = canvas.interface.grid.addHighlightLayer(this.name);\n  }\n\n  addSquare(x, y) {\n    this._squares.push({ x, y });\n  }\n\n  clear() {\n    this.layer?.clear();\n  }\n\n  render() {\n    const gridSize = canvas.grid.size;\n\n    this.clear();\n\n    // Highlight squares\n    const hlname = this.layer.name;\n    const ig = canvas.interface.grid;\n    for (const s of this._squares) {\n      const x = Math.floor(this.origin.x - s.x) * gridSize;\n      const y = Math.floor(this.origin.y - s.y) * gridSize;\n      ig.highlightPosition(hlname, { x, y, border: this.borderColor, color: this.fillColor });\n    }\n  }\n}\n\n/**\n * Calculates the attack for a token's attack.\n */\nclass AttackHighlightBase {\n  /** @abstract */\n  clearHighlight() {\n    throw new Error(\"must be overridden\");\n  }\n  /** @abstract */\n  renderHighlight() {\n    throw new Error(\"must be overridden\");\n  }\n\n  /**\n   * @abstract\n   * @returns {boolean}\n   */\n  get isValid() {\n    throw new Error(\"must be overridden\");\n  }\n\n  /**\n   * @param {Token} token - The token to calculate the attack reach for\n   * @param {ffd20.components.ItemAction} action - The action to calculate the reach for\n   */\n  constructor(token, action) {\n    const attack = action?.item;\n    if (!action || !token || !attack) throw new Error(\"Invalid arguments.\");\n\n    this._id = foundry.utils.randomID();\n    this.name = `AttackHighlight.${this._id}`;\n    this.layer = canvas.interface.grid.addHighlightLayer(this.name);\n  }\n}\n\nclass GridlessHighlight extends AttackHighlightBase {\n  /** @type {number[]|undefined} */\n  #rangeStops;\n\n  /** @override */\n  get isValid() {\n    return (this.#rangeStops?.length ?? 0) >= 2;\n  }\n\n  /** @type {{x: number, y: number} | undefined} */\n  #center;\n\n  /**\n   * @param {Token} token - The token to calculate the attack reach for\n   * @param {ffd20.components.ItemAction} action - The action to calculate the reach for\n   */\n  constructor(token, action) {\n    super(token, action);\n    const attack = action?.item;\n\n    const grid = canvas.grid;\n    const gridSize = grid.size;\n    const tw = token.document.width;\n    const th = token.document.height;\n    this.#center = {\n      x: Math.floor(token.x + (tw * gridSize) / 2),\n      y: Math.floor(token.y + (th * gridSize) / 2),\n    };\n\n    const rollData = action.getRollData();\n\n    // Determine whether reach\n    const rangeKey = action.range.units;\n    if (![\"melee\", \"touch\", \"reach\", \"ft\", \"close\", \"medium\"].includes(rangeKey)) return;\n    const isReach = rangeKey === \"reach\";\n\n    // Determine minimum range\n    const minRange = ffd20.utils.convertDistanceBack(action.getRange({ type: \"min\", rollData }))[0];\n    const r = ffd20.utils.convertDistanceBack(action.getRange({ type: \"single\", rollData }))[0];\n\n    const rangeMeasurements = [minRange || 0, r];\n\n    if (rangeKey === \"ft\") {\n      // Add range increments\n      const rangeIncrements = action.range.maxIncrements;\n      for (let a = 1; a < rangeIncrements; a++) {\n        rangeMeasurements.push((a + 1) * r);\n      }\n    }\n\n    this.#rangeStops = rangeMeasurements.map((r) => {\n      const tokenOffset = r === 0 ? 0 : (tw * gridSize) / 2;\n      return r * canvas.dimensions.distancePixels + tokenOffset;\n    });\n  }\n\n  clearHighlight() {\n    if (this.isValid) {\n      const hl = this.layer;\n      if (!hl) return;\n      hl.removeChildren();\n      this.#rangeStops = undefined;\n    }\n  }\n\n  renderHighlight() {\n    if (this.isValid) {\n      const hl = this.layer;\n      if (!hl) return;\n      hl.clear();\n\n      const { x, y } = this.#center;\n\n      const circle = new PIXI.Graphics();\n\n      const stops = /** @type {!number[]} */ (this.#rangeStops);\n      for (let i = stops.length - 1; i > 0; i--) {\n        const outer = stops[i];\n        const inner = stops[i - 1];\n\n        const color = [rangeColor, reachColor][(i + 1) % 2];\n\n        circle.beginFill(color.fill, 0.1);\n        circle.drawCircle(x, y, outer);\n\n        // if inner has a defined value and is not 0, then cut a hole for either the next increment or because it's the minimum range\n        if (inner) {\n          circle.beginHole();\n          circle.beginFill(reachColor.fill, 0.1);\n          circle.drawCircle(x, y, inner);\n          circle.endHole();\n        }\n      }\n      circle.endFill();\n\n      hl.addChild(circle);\n    }\n  }\n}\n\nclass SquareGridHighlight extends AttackHighlightBase {\n  /**\n   * @typedef {object} AttackReachHighlight\n   * An object containing highlights belonging to a specific attack\n   * @property {SquareHighlight} normal - Highlight for normal range\n   * @property {SquareHighlight[]} extra - Additional highlights\n   */\n\n  /** @type {AttackReachHighlight|undefined} */\n  #currentHighlight;\n\n  /** @override */\n  get isValid() {\n    return !!this.#currentHighlight;\n  }\n\n  /**\n   * @inheritdoc\n   */\n  constructor(token, action) {\n    super(token, action);\n    const attack = action?.item;\n\n    const grid = canvas.grid;\n    const gridSize = grid.size;\n    const tw = token.document.width;\n    const th = token.document.height;\n    const origin = {\n      x: Math.floor((token.x + tw * gridSize - 0.5 * gridSize) / gridSize),\n      y: Math.floor((token.y + th * gridSize - 0.5 * gridSize) / gridSize),\n    };\n\n    const rollData = action.getRollData();\n\n    // Determine whether reach\n    const rangeKey = action.range.units;\n    if (![\"melee\", \"touch\", \"reach\", \"ft\", \"close\", \"medium\"].includes(rangeKey)) return;\n    const isReach = rangeKey === \"reach\";\n    const isFeet = rangeKey === \"ft\";\n\n    // Determine minimum range\n    const minRange = ffd20.utils.convertDistanceBack(action.getRange({ type: \"min\", rollData }))[0];\n\n    const r = ffd20.utils.convertDistanceBack(action.getRange({ type: \"single\", rollData }))[0];\n\n    const squares = {\n      normal: [],\n      reach: [],\n      extra: [],\n    };\n    const useReachRule = game.settings.get(\"ffd20\", \"alternativeReachCornerRule\") !== true;\n\n    squares.normal = this.#getReachSquares(token, r, minRange, { useReachRule: isFeet ? true : useReachRule });\n\n    if (isFeet) {\n      // Add range increments\n      const ftDistance = ffd20.utils.convertDistance(r)[0];\n      const userLimit = game.settings.get(\"ffd20\", \"performance\").reachLimit;\n      const maxSquareRange = Math.min(\n        userLimit, // arbitrary limit to enhance performance on large canvases\n        Math.max(\n          canvas.dimensions.width / canvas.dimensions.distancePixels,\n          canvas.dimensions.height / canvas.dimensions.distancePixels\n        ) + ftDistance\n      );\n      const rangeIncrements = action.range.maxIncrements;\n      for (let a = 1; a < rangeIncrements; a++) {\n        if ((a + 1) * ftDistance <= maxSquareRange) {\n          squares.extra.push(this.#getReachSquares(token, (a + 1) * r, a * r, { useReachRule }));\n        }\n      }\n    }\n\n    const result = {\n      normal: new SquareHighlight(origin, rangeColor.fill, rangeColor.border, this.name + \".base\"),\n      extra: [],\n    };\n\n    for (const s of squares.normal) {\n      result.normal.addSquare(s[0], s[1]);\n    }\n\n    // Add extra range squares\n    for (let a = 0; a < squares.extra.length; a++) {\n      const squaresExtra = squares.extra[a];\n\n      const color = {\n        fill: a % 2 === 1 ? rangeColor.fill : reachColor.fill,\n        border: a % 2 === 1 ? rangeColor.border : reachColor.border,\n      };\n\n      const hl = new SquareHighlight(origin, color.fill, color.border, this.name + `.${a}`);\n      for (const s of squaresExtra) {\n        hl.addSquare(s[0], s[1]);\n      }\n      result.extra.push(hl);\n    }\n\n    this.#currentHighlight = result;\n  }\n\n  /**\n   *\n   * @param {Token} token\n   * @param {number} range\n   * @param {number} minRange\n   * @param {object} options\n   * @returns {Array<Array<number,number>>} - Array of x,y coordinate tuples\n   */\n  #getReachSquares(token, range, minRange = 0, options) {\n    const result = [];\n    if (canvas.grid.type !== CONST.GRID_TYPES.SQUARE) return result;\n\n    range = ffd20.utils.convertDistance(range)[0];\n    if (typeof minRange === \"number\") minRange = ffd20.utils.convertDistance(minRange)[0];\n\n    // Initialize variables\n    const gridDist = canvas.scene.grid.distance;\n    const gridSize = canvas.grid.size;\n\n    // Determine token squares\n    const tokenSquares = [];\n    for (let a = 0; a < Math.floor(token.w / gridSize); a++) {\n      for (let b = 0; b < Math.floor(token.h / gridSize); b++) {\n        const x = Math.floor((token.x + gridSize * 0.5) / gridSize + a);\n        const y = Math.floor((token.y + gridSize * 0.5) / gridSize + b);\n        tokenSquares.push([x, y]);\n      }\n    }\n\n    // Determine token-based variables\n    const tokenRect = [\n      Math.floor((token.x + gridSize * 0.5) / gridSize),\n      Math.floor((token.y + gridSize * 0.5) / gridSize),\n      Math.floor(token.w / gridSize),\n      Math.floor(token.h / gridSize),\n    ];\n\n    // Create function to determine closest token square\n    const getClosestTokenSquare = (pos) => {\n      const lowest = { square: null, dist: null };\n      for (const s of tokenSquares) {\n        const dist = Math.sqrt((s[0] - pos[0]) ** 2 + (s[1] - pos[1]) ** 2);\n        if (lowest.dist == null || dist < lowest.dist) {\n          lowest.square = s;\n          lowest.dist = dist;\n        }\n      }\n\n      return lowest.square;\n    };\n\n    // Gather potential squares\n    const squareRange = Math.round(range / gridDist);\n    const wMax = squareRange * 2 + tokenRect[2];\n    const hMax = squareRange * 2 + tokenRect[3];\n    const tl = [tokenRect[0] - squareRange, tokenRect[1] - squareRange];\n    for (let a = tl[0]; a < tl[0] + wMax; a++) {\n      for (let b = tl[1]; b < tl[1] + hMax; b++) {\n        const closestSquare = getClosestTokenSquare([a, b]);\n\n        const offset = [a - tokenRect[0], b - tokenRect[1]];\n        if (\n          !(\n            a >= tokenRect[0] &&\n            a < tokenRect[0] + tokenRect[2] &&\n            b >= tokenRect[1] &&\n            b < tokenRect[1] + tokenRect[2] &&\n            minRange != null\n          ) &&\n          this.#shouldAddReachSquare([a, b], closestSquare, range, minRange, options)\n        ) {\n          result.push(offset);\n        }\n      }\n    }\n\n    return result;\n  }\n\n  #shouldAddReachSquare(pos, closestTokenSquare, range, minRange, { useReachRule = false } = {}) {\n    const gridSize = canvas.grid.size;\n    const p0 = { x: closestTokenSquare[0] * gridSize, y: closestTokenSquare[1] * gridSize };\n    const p1 = { x: pos[0] * gridSize, y: pos[1] * gridSize };\n\n    // BUG: This will fail if user is using non 1/2/1 diagonals\n    const dist = canvas.grid.measurePath([p0, p1]).distance;\n\n    // TODO: https://github.com/foundryvtt/foundryvtt/issues/11428\n    const dist2 = useReachRule\n      ? new foundry.grid.SquareGrid({\n          size: canvas.grid.size,\n          distance: canvas.grid.distance,\n          diagonals: CONST.GRID_DIAGONALS.EQUIDISTANT,\n        }).measurePath([p0, p1]).distance\n      : null;\n\n    const reachRuleRange = ffd20.utils.convertDistance(10)[0];\n    if (dist > range) {\n      // Special rule for 10-ft. reach\n      if (!(useReachRule && range === reachRuleRange)) {\n        return false;\n      }\n    }\n\n    if (minRange != null && dist <= minRange) {\n      return false;\n    }\n\n    // Special rule for minimum ranges >= 10-ft.\n    if (useReachRule && minRange >= reachRuleRange && dist2 <= reachRuleRange) {\n      return false;\n    }\n\n    return true;\n  }\n\n  clearHighlight() {\n    if (this.#currentHighlight) {\n      this.#currentHighlight.normal.clear();\n      for (const h of this.#currentHighlight.extra) {\n        h.clear();\n      }\n      this.#currentHighlight = undefined;\n    }\n  }\n\n  renderHighlight() {\n    if (this.#currentHighlight) {\n      this.#currentHighlight.normal.render();\n      for (const h of this.#currentHighlight.extra) {\n        h.render();\n      }\n    }\n  }\n}\n\n/** @type {AttackHighlightBase|undefined} */\nlet attackReachHighlight;\n\n/**\n * Calculates and renders the {@link AttackReachHighlight} for a token's attack.\n * If a highlight already exists, it will be removed.\n *\n * @param {Token} token - The token to calculate the attack reach for\n * @param {ffd20.components.ItemAction} action - The action to calculate the reach for\n */\nexport const showAttackReach = (token, action) => {\n  // Clear previous highlight\n  clearHighlight();\n\n  const cls = canvas.grid.type === CONST.GRID_TYPES.SQUARE ? SquareGridHighlight : GridlessHighlight;\n\n  try {\n    const highlight = new cls(token, action);\n\n    // If a highlight could be created, make it the current highlight and render it\n    if (!highlight.isValid) return;\n    attackReachHighlight = highlight;\n    attackReachHighlight.renderHighlight();\n  } catch {\n    // no action, token, or item to use to render the highlight\n  }\n};\n\nexport const clearHighlight = () => {\n  attackReachHighlight?.clearHighlight();\n  attackReachHighlight = undefined;\n};\n\n/**\n * Returns a token belonging to either an actor's UUID or a token's UUID\n *\n * @param {string} uuid - UUID of an actor or token\n * @returns {Promise<Token|null|undefined>} A Token, if one can be found\n */\nconst _getTokenByUuid = async function (uuid) {\n  if (!uuid) return;\n  /** @type {TokenDocument | Actor} */\n  const actor = await fromUuid(uuid);\n  if (actor instanceof TokenDocument) return actor.object;\n  return actor?.token ?? (actor != null ? canvas.tokens.placeables.find((o) => o.actor === actor) : null);\n};\n\n/**\n * Add listeners on the {@link ChatLog}'s HTML element, checking for hover events involving\n * chat cards' range element using event delegation.\n *\n * @param {JQuery<HTMLElement>} html - The chat log\n */\nexport function addReachListeners(html) {\n  html.on(\"pointerenter\", \".card-range\", _onMouseEnterReach);\n  html.on(\"pointerleave\", \".card-range\", _onMouseLeaveReach);\n}\n\n/**\n * Handle display of reach when a chat card's reach element is hovered\n *\n * @param {JQuery.MouseEnterEvent<HTMLElement>} event - A `mouseEnter` event\n */\nconst _onMouseEnterReach = (event) => {\n  event.preventDefault();\n  if (game.settings.get(\"ffd20\", \"performance\").reachLimit < 10) return;\n\n  const reachElement = event.currentTarget;\n  const card = reachElement.closest(\".chat-card\");\n  const { tokenUuid, actionId, itemId } = card.dataset;\n  if (!(itemId && actionId && tokenUuid)) return;\n\n  _getTokenByUuid(tokenUuid).then((token) => {\n    if (!token) return;\n\n    const item = token.actor.allItems.find((item) => item.id === itemId);\n    const action = item?.actions.get(actionId);\n    if (!action) return;\n\n    showAttackReach(token, action);\n  });\n};\n\n/**\n * Handle clearing of reach highlights created by {@link _onMouseEnterReach}\n *\n * @param {JQuery.MouseLeaveEvent} event - A `mouseLeave` event\n */\nconst _onMouseLeaveReach = (event) => {\n  event.preventDefault();\n  clearHighlight();\n};\n","/**\n * Add a checkbox to enable/disable low-light vision effects to a light's configuration\n *\n * @param {AmbientLightConfig} app - The LightConfig app\n * @param {Element} html - The application HTML element\n */\nexport function addLowLightVisionToLightConfig(app, html) {\n  /** @type {AmbientLightDocument} */\n  const light = app.document;\n\n  // Create checkbox HTML element\n  const bf = new foundry.data.fields.BooleanField();\n\n  /** @type {Element} */\n  const el = bf.toFormGroup(\n    {\n      label: game.i18n.localize(\"FFD20.SETTINGS.DisableLLV.Label\"),\n      hint: game.i18n.localize(\"FFD20.SETTINGS.DisableLLV.Hint\"),\n    },\n    {\n      name: \"flags.ffd20.disableLowLight\",\n      value: light.getFlag(\"ffd20\", \"disableLowLight\") ?? false,\n    }\n  );\n\n  // Create containing fieldset\n  const field = document.createElement(\"fieldset\");\n  const legend = document.createElement(\"legend\");\n  legend.innerText = game.i18n.localize(\"FFD20.Title\");\n  field.append(legend, el);\n\n  // Insert new checkbox\n  html.querySelector('section.tab[data-tab=\"advanced\"]').append(field);\n}\n\n/**\n * LLV support mixin for AmbientLight and Token\n *\n * Adds light-radius multiplication effect to both light sources.\n *\n * @param {class} Base - Base class\n * @returns {class} - Mixin class\n */\nexport const LLVMixin = (Base) =>\n  class extends Base {\n    /** @override */\n    _getLightSourceData() {\n      const data = super._getLightSourceData();\n\n      const { dim, bright } = this.getRadius(data.dim, data.bright);\n\n      // Avoid NaN and introducing keys that shouldn't be in the data\n      // Without undefined check, global illumination will cause darkvision and similar vision modes to glitch.\n      // We're assuming getRadius gives sensible values otherwise.\n      if (data.dim !== undefined) data.dim = dim;\n      if (data.bright !== undefined) data.bright = bright;\n\n      return data;\n    }\n\n    /**\n     * @param {number} dim - Dim radius\n     * @param {number} bright - Bright radius\n     * @returns {{dim:number,bright:number}} - Adjusted distances\n     */\n    getRadius(dim, bright) {\n      const result = { dim, bright };\n      let multiplier = { dim: 1, bright: 1 };\n\n      if (!game.settings.get(\"ffd20\", \"systemVision\")) return result;\n\n      /**\n       * @param {TokenDocument} token\n       * @returns {boolean}\n       */\n      const hasSystemVision = (token) =>\n        token.getFlag(\"ffd20\", \"disableLowLight\") !== true && token.getFlag(\"ffd20\", \"customVisionRules\") !== true;\n\n      const token = this.object?.document;\n      if (token && !hasSystemVision(token)) return result;\n\n      const requiresSelection = game.user.isGM || game.settings.get(\"ffd20\", \"lowLightVisionMode\");\n      const relevantTokens = canvas.tokens.placeables.filter((token) => {\n        const tokenDoc = token.document;\n        return (\n          token.actor?.testUserPermission(game.user, \"OBSERVER\") &&\n          (requiresSelection ? token.controlled : true) &&\n          hasSystemVision(tokenDoc)\n        );\n      });\n      const lowLightTokens = relevantTokens.filter((o) => o.actorVision.lowLight === true);\n\n      if (requiresSelection) {\n        if (lowLightTokens.length && lowLightTokens.length === relevantTokens.length) {\n          multiplier = { dim: 999, bright: 999 };\n          for (const t of lowLightTokens) {\n            const tokenVision = t.actorVision;\n            multiplier.dim = Math.min(multiplier.dim, tokenVision.lowLightMultiplier);\n            multiplier.bright = Math.min(multiplier.bright, tokenVision.lowLightMultiplierBright);\n          }\n        }\n      } else {\n        for (const t of lowLightTokens) {\n          const tokenVision = t.actorVision;\n          multiplier.dim = Math.max(multiplier.dim, tokenVision.lowLightMultiplier);\n          multiplier.bright = Math.max(multiplier.bright, tokenVision.lowLightMultiplierBright);\n        }\n      }\n\n      result.dim *= multiplier.dim;\n      result.bright *= multiplier.bright;\n\n      return result;\n    }\n  };\n\n/**\n * Re-initialize light sources.\n *\n * @remarks\n * Foundry v12 no longer initializes the lights fully on calling perception manager to do so, making the following insufficient.\n * ```js\n * canvas.perception.update({ initializeLighting: true }, true);\n * ```\n */\nexport function reinitLightSources() {\n  for (const { object } of canvas.effects.lightSources) {\n    if (!(object instanceof AmbientLight || object instanceof Token)) continue;\n    object.initializeLightSource();\n  }\n}\n\n/**\n * Debounced call to {@link reinitLightSources}\n */\nexport const debouncedLightSourceReInit = foundry.utils.debounce(reinitLightSources, 100);\n\nHooks.on(\"renderAmbientLightConfig\", (app, html) =>\n  ffd20.canvas.lowLightVision.addLowLightVisionToLightConfig(app, html)\n);\n","export class TokenPF extends Token {\n  /**\n   * Synced with Foundry v12\n   *\n   * @override\n   * @param {string|object} effect - Effect ID or data\n   * @param {object} options - Additional options\n   * @param {boolean} [options.active] - Force active state\n   * @param {boolean} [options.overlay=false] - Overlay effect\n   * @param {boolean} [options.interaction=true] - Nonstandard. Is this triggered by user interaction?\n   * @returns {Promise<boolean>} - was it applied or removed\n   */\n  async toggleEffect(effect, { active, overlay = false, interaction = true } = {}) {\n    const effectId = typeof effect === \"string\" ? effect : effect?.id;\n\n    if (this.actor && ffd20.registry.conditions.has(effectId) && typeof this.actor.toggleCondition === \"function\") {\n      const enable = active ?? !this.actor.statuses.has(effectId);\n      if (enable && this.actor.getConditionImmunities().has(effectId)) {\n        if (interaction) {\n          ui.notifications.warn(\n            game.i18n.format(\"FFD20.Warning.ImmuneToCondition\", {\n              name: this.actor.name,\n              condition: ffd20.registry.conditions.get(effectId)?.name || effectId,\n            })\n          );\n        }\n        return false;\n      }\n\n      const extraData = overlay ? { flags: { core: { overlay: true } } } : undefined;\n\n      let rv;\n      if (active === undefined) rv = await this.actor.toggleCondition(effectId, extraData);\n      else {\n        if (active && overlay) active = extraData; // Support right click\n        rv = await this.actor.setCondition(effectId, active);\n      }\n      return rv[effectId];\n    } else {\n      return super.toggleEffect(effect, { active, overlay });\n    }\n  }\n\n  get actorVision() {\n    const ll = this.actor.system.traits?.senses?.ll ?? {};\n    return {\n      lowLight: ll.enabled,\n      lowLightMultiplier: ll.multiplier?.dim,\n      lowLightMultiplierBright: ll.multiplier?.bright,\n    };\n  }\n\n  get disableLowLight() {\n    return this.document.getFlag(\"ffd20\", \"disableLowLight\") === true;\n  }\n\n  /**\n   * @override\n   * @param {object} options - Control options\n   */\n  _onControl(options) {\n    super._onControl(options);\n\n    ffd20.canvas.lowLightVision.debouncedLightSourceReInit();\n  }\n\n  /**\n   * @override\n   * @param {object} options - Release options\n   */\n  _onRelease(options) {\n    super._onRelease(options);\n\n    ffd20.canvas.lowLightVision.debouncedLightSourceReInit();\n  }\n\n  /**\n   * Override to support vision sharing and setting for minimum needed permission level.\n   *\n   * Synced with Foundry v12.331\n   *\n   * @override\n   * @since PF1 v10\n   */\n  _isVisionSource() {\n    if (!canvas.visibility.tokenVision || !this.hasSight) return false;\n\n    // Only display hidden tokens for the GM\n    const isGM = game.user.isGM;\n    if (this.document.hidden && !isGM) return false;\n\n    // Always display controlled tokens which have vision\n    if (this.controlled) return true;\n\n    // Otherwise, vision is ignored for GM users\n    if (isGM) return false;\n\n    // Vision sharing\n    if (this.actor?.sharesVision) return true;\n\n    // If a non-GM user controls no other tokens with sight, display sight\n    const guarantee = game.settings.get(\"ffd20\", \"guaranteedVision\");\n    const canObserve = this.actor?.testUserPermission(game.user, guarantee) ?? false;\n    if (!canObserve) return false;\n    return !this.layer.controlled.some((t) => !t.document.hidden && t.hasSight);\n  }\n\n  /**\n   * @param {object} data         Resource data for this bar\n   * @returns {number|null}       The number to boost the bar by, if any.\n   * @protected\n   */\n  _getBarBoost(data) {\n    if (data.attribute === \"attributes.hp\") return { value: this.actor.system.attributes.hp.temp, color: 0xc0d6e4 };\n    if (data.attribute === \"attributes.vigor\")\n      return { value: this.actor.system.attributes.vigor.temp, color: 0xc0d6e4 };\n    return null;\n  }\n\n  /**\n   * Determines the length of the underline (bottom half-height bar overlay) on a token bar.\n   *\n   * @param {object} data         Resource data for this bar\n   * @returns {number|null}       The value of the bar underline, if any.\n   * @protected\n   */\n  _getBarUnderline(data) {\n    if (data.attribute === \"attributes.hp\")\n      return { value: this.actor.system.attributes.hp.nonlethal, color: 0x7d2828 };\n    return null;\n  }\n\n  /**\n   * Draw a single resource bar, given provided data.\n   *\n   * @param {number} number       The Bar number>\n   * @param {PIXI.Graphics} bar   The Bar container.\n   * @param {object} data         Resource data for this bar.\n   * @protected\n   */\n  _drawBar(number, bar, data) {\n    // Get boost value (such as temporary hit points\n    const boost = this._getBarBoost(data);\n    const underline = this._getBarUnderline(data);\n    const boostlessMax = data.max;\n\n    const val = Number(data.value);\n    data.max = Math.max(data.max, (boost?.value ?? 0) + val);\n    const pct = Math.clamp(val, 0, data.max) / data.max;\n    const boostlessPct = Math.clamp(val, 0, boostlessMax) / boostlessMax;\n\n    // Determine sizing\n    let h = Math.max(canvas.dimensions.size / 12, 8);\n    const w = this.w;\n    const bs = Math.clamp(h / 8, 1, 2);\n    if (this.document.height >= 2) h *= 1.6; // Enlarge the bar for large tokens\n\n    // Determine the color to use\n    const blk = 0x000000;\n    let color;\n    if (number === 0) color = Color.fromRGBvalues(1 - boostlessPct / 2, boostlessPct, 0);\n    else color = Color.fromRGBvalues(0.5 * boostlessPct, 0.7 * boostlessPct, 0.5 + boostlessPct / 2);\n\n    // Draw the bar\n    bar.clear();\n    // Draw background of bar\n    bar.beginFill(blk, 0.5).lineStyle(bs, blk, 1.0).drawRoundedRect(0, 0, this.w, h, 3);\n    // Draw bar boost\n    if (boost?.value > 0) {\n      const pct = Math.clamp(val + boost.value, 0, data.max) / data.max;\n      bar\n        .beginFill(boost.color, 1.0)\n        .lineStyle(bs, blk, 1.0)\n        .drawRoundedRect(0, 0, pct * w, h, 2);\n    }\n\n    // Draw normal value\n    bar\n      .beginFill(color, 1.0)\n      .lineStyle(bs, blk, 1.0)\n      .drawRoundedRect(0, 0, pct * w, h, 2);\n    // Draw bar underline\n    if (underline?.value > 0) {\n      const pct = Math.clamp(underline.value, 0, data.max) / data.max;\n      bar\n        .beginFill(underline.color, 1.0)\n        .lineStyle(bs, blk, 1.0)\n        .drawRoundedRect(0, h / 2, pct * w, h / 2, 2);\n    }\n\n    // Set position\n    const posY = number === 0 ? this.h - h : 0;\n    bar.position.set(0, posY);\n  }\n\n  /**\n   * Returns error margin, in pixels, for measuring to and from token center.\n   *\n   * Defined as larger of half the token's width and height.\n   *\n   * @type {number}\n   */\n  get sizeErrorMargin() {\n    return Math.max(this.w / 2, this.h / 2);\n  }\n\n  /**\n   * Return coordinates of cells the token occupies.\n   *\n   * Bug: Does not work with hex grid.\n   * Bug: Does not account for rotation.\n   *\n   * @param {object} [options={}] - Additional options\n   * @param {boolean} [options.center=false] - Return cell centers instead of origins\n   * @returns {Point[]} - Occupied cell coordinates.\n   */\n  getOccupiedCells({ center = false } = {}) {\n    const doc = this.document;\n    const gridSizePx = this.scene.grid.size ?? 1;\n    const { x, y, width, height } = doc;\n\n    // Offset for returning cell center\n    const offset = center ? gridSizePx / 2 : 0;\n\n    const squares = [];\n\n    const wr = width - 1,\n      hr = height - 1;\n\n    for (let x0 = 0; x0 <= wr; x0++) {\n      for (let y0 = 0; y0 <= hr; y0++) {\n        squares.push({ x: x + x0 * gridSizePx + offset, y: y + y0 * gridSizePx + offset });\n      }\n    }\n\n    return squares;\n  }\n\n  /**\n   * Is this token a square?\n   *\n   * @type {boolean}\n   */\n  get isSquare() {\n    return this.document.width === this.document.height;\n  }\n}\n","/**\n * See invisibility detection mode with respect to sight (light & darkvision)\n *\n * Replacement for `CONFIG.Canvas.detectionModes.seeInvisibility`\n */\nexport class DetectionModeInvisibilityPF extends DetectionModeInvisibility {\n  static ID = \"seeInvisibility\";\n  static LABEL = \"FFD20.Sense.seeInvis\";\n  static PRIORITY = 100000;\n\n  /**\n   * Copy of DetectionModeBasicSight._testPoint instead of the one inherited from DetectionMode.\n   *\n   * Allows seeing invisible in lit areas.\n   *\n   * @override\n   */\n  _testPoint(visionSource, mode, target, test) {\n    // Blocked by walls\n    if (!this._testLOS(visionSource, mode, target, test)) return false;\n    // Otherwise allowed within range\n    if (this._testRange(visionSource, mode, target, test)) return true;\n\n    // If limited (e.g. true seeing), do not care about other light sources beyond range\n    if (mode.limited) return false;\n\n    // Allowed outside of range if lit\n    const { x, y } = test.point;\n    for (const lightSource of canvas.effects.lightSources.values()) {\n      if (!lightSource.active) continue;\n      if (lightSource.shape.contains(x, y)) return true;\n    }\n    return false;\n  }\n}\n\n/**\n * Blindsense\n *\n * Registered at `CONFIG.Canvas.detectionModes.blindSense`\n */\nexport class DetectionModeBlindSensePF extends DetectionMode {\n  static ID = \"blindSense\";\n  static LABEL = \"FFD20.Sense.blindsense\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.OTHER;\n  static PRIORITY = 200100;\n\n  constructor(data = {}, ...args) {\n    data.walls = true;\n    super(data, ...args);\n  }\n\n  /** @override */\n  static getDetectionFilter() {\n    return (this._detectionFilter ??= OutlineOverlayFilter.create({\n      outlineColor: [0, 0.33, 0.6, 1],\n      knockout: false,\n      wave: this.ID === \"blindSense\",\n    }));\n  }\n\n  /** @override */\n  _canDetect(visionSource, target) {\n    return true;\n  }\n}\n\n/**\n * Blindsight\n *\n * Registered at `CONFIG.Canvas.detectionModes.blindSight`\n */\nexport class DetectionModeBlindSightPF extends DetectionModeBlindSensePF {\n  static ID = \"blindSight\";\n  static LABEL = \"FFD20.Sense.blindsight\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.OTHER;\n  static PRIORITY = 200000;\n\n  /** @override */\n  static getDetectionFilter() {\n    return (this._detectionFilter ??= OutlineOverlayFilter.create({\n      outlineColor: [0, 0.33, 0.6, 1],\n      knockout: false,\n      wave: false,\n    }));\n  }\n}\n\n/**\n * Lifesense\n *\n * Registered at `CONFIG.Canvas.detectionModes.lifesense`\n */\nexport class DetectionModeLifesensePF extends DetectionMode {\n  static ID = \"lifesense\";\n  static LABEL = \"FFD20.Sense.lifesense\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.OTHER;\n  static PRIORITY = 200200;\n\n  /** @override */\n  static getDetectionFilter() {\n    return (this._detectionFilter ??= OutlineOverlayFilter.create({\n      outlineColor: [1, 0.1, 0.2, 1],\n      knockout: false,\n      wave: this.ID === \"lifesense\",\n    }));\n  }\n\n  /** @override */\n  _canDetect(visionSource, target) {\n    const rv = super._canDetect(visionSource, target);\n\n    if (rv) {\n      const traits = target.actor?.system?.traits;\n      if (!traits?.living) {\n        return false;\n      }\n    }\n\n    return rv;\n  }\n}\n\n/**\n * Tremorsense\n *\n * Unlike base implementation, does not block with walls but also does not detect swimming.\n *\n * Replacement for `CONFIG.Canvas.detectionModes.feelTremor`\n */\nexport class DetectionModeTremorPF extends DetectionModeTremor {\n  static ID = \"feelTremor\";\n  static LABEL = \"FFD20.Sense.tremorsense\";\n  static DETECTION_TYPE = DetectionMode.DETECTION_TYPES.MOVE;\n  static PRIORITY = 201000;\n\n  constructor(data = {}, ...args) {\n    data.walls = false;\n    super(data, ...args);\n  }\n\n  /** @override */\n  _canDetect(visionSource, target) {\n    const rv = super._canDetect(visionSource, target);\n\n    if (rv) {\n      // Do not detect swimming\n      if (target.document.hasStatusEffect(CONFIG.specialStatusEffects.SWIM)) return false;\n    }\n\n    return rv;\n  }\n}\n","/**\n * Rules accurate darkvision override.\n *\n * Replacement for `CONFIG.Canvas.visionModes.darkvision`\n *\n * @remarks\n * Compared to example implementation, this does not turn dim light into bright.\n *\n * @type {VisionMode}\n */\nexport const darkvision = (() => {\n  const data = CONFIG.Canvas.visionModes.darkvision.toObject();\n  delete data.lighting.levels[VisionMode.LIGHTING_LEVELS.DIM];\n  return new VisionMode(data);\n})();\n","import { clearHighlight, showAttackReach } from \"./attack-reach.mjs\";\nimport { getSkipActionPrompt } from \"module/documents/settings.mjs\";\nimport { renderCachedTemplate } from \"@utils/handlebars/templates.mjs\";\n\n/**\n * Extension of core Token HUD\n *\n * @since PF1 v11\n */\nexport class TokenHUDPF extends TokenHUD {\n  _getStatusEffectChoices() {\n    const core = super._getStatusEffectChoices(),\n      buffs = {};\n\n    const items = this.object.actor?.itemTypes.buff ?? [];\n    for (const buff of items) {\n      const id = `buff-${buff.id}`;\n      buffs[id] = {\n        _id: id, // to match v12\n        id,\n        title: buff.name,\n        src: buff.img,\n        isActive: buff.isActive,\n        isOverlay: false,\n        cssClass: buff.isActive ? \"active\" : \"\",\n      };\n    }\n\n    return { ...core, ...buffs };\n  }\n\n  // V12 and prior\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    this.addQuickActions(this, html[0]);\n  }\n\n  // V13\n  _onRender(context, options) {\n    this.addQuickActions(this, this.element);\n  }\n\n  /**\n   * Add quick action buttons to token HUD.\n   *\n   * @param {TokenHUD} app - HUD app\n   * @param {Element} html - HUD element\n   */\n  async addQuickActions(app, html) {\n    const token = app.object;\n    const actor = token.actor;\n\n    const quickActions = actor?.getQuickActions?.();\n\n    if (!quickActions?.length) return;\n\n    const templateData = {\n      actions: quickActions,\n    };\n\n    const template = document.createElement(\"template\");\n    template.innerHTML = renderCachedTemplate(\"systems/ffd20/templates/hud/quick-actions.hbs\", templateData);\n    const fragment = template.content;\n\n    this.addQuickActionListeners(fragment);\n\n    Hooks.callAll(\"pf1RenderQuickActions\", app, token, fragment);\n\n    html.querySelector(\".col.middle\").after(fragment);\n  }\n\n  /**\n   * Add listeners to token HUD quick action element.\n   *\n   * @param {DocumentFragment} html - Quick actions element\n   */\n  addQuickActionListeners(html) {\n    const showReach = game.settings.get(\"ffd20\", \"performance\").reachLimit >= 10;\n\n    const token = this.object;\n    const actor = token.actor;\n\n    for (const el of html.querySelectorAll(\".token-quick-action\")) {\n      el.addEventListener(\"click\", (event) => {\n        event.preventDefault();\n        const itemId = event.target.dataset.itemId;\n        const item = actor.items.get(itemId);\n        if (!event.ctrlKey) {\n          item.use({ ev: event, token: token.document, skipDialog: getSkipActionPrompt() });\n        } else {\n          item.displayCard({ token: token.document });\n        }\n      });\n\n      el.addEventListener(\"contextmenu\", (event) => {\n        event.preventDefault();\n        const itemId = event.target.dataset.itemId;\n        const item = actor.items.get(itemId);\n        item.sheet.render(true, { focus: true });\n      });\n\n      // Reach highlight on mouse hover\n      if (showReach) {\n        const itemId = el.dataset.itemId;\n        const item = actor.items.get(itemId);\n        const action = item.defaultAction;\n        el.addEventListener(\"pointerenter\", () => showAttackReach(token, action), { passive: true });\n        el.addEventListener(\"pointerleave\", () => clearHighlight(), { passive: true });\n      }\n    }\n  }\n}\n","import { MeasuredTemplatePF } from \"./measure.mjs\";\n\n/**\n * A helper class for building MeasuredTemplates for PF1 spells and abilities\n */\nexport class AbilityTemplate extends MeasuredTemplatePF {\n  /**\n   * Preview movement and rotation re-render throttle time in milliseconds.\n   *\n   * @private\n   */\n  static RENDER_THROTTLE = 30;\n\n  /**\n   * A factory method to create an AbilityTemplate instance using provided data\n   *\n   * @param {object} data - Data used to create the template\n   * @param {\"cone\" | \"circle\" | \"rect\" | \"ray\"} data.type - The type of template\n   * @param {number} data.distance - The distance/size of the template\n   * @param {string} [data.texture=null] - Path to template texture\n   * @param {string} [data.color=game.user.color] - Template color\n   * @param {object} [data.flags] - Additional flags stored on the template\n   * @param {object} [options]\n   * @param {ffd20.components.ItemAction} [options.action]\n   * @returns {AbilityTemplate|null} - The template object, or null if the data does not produce a template\n   */\n  static fromData(data, { action } = {}) {\n    const { type, distance, flags } = data;\n    if (!type || !distance || !canvas.scene) return null;\n    if (![\"cone\", \"circle\", \"rect\", \"ray\"].includes(type)) return null;\n\n    // Prepare template data\n    const templateData = {\n      t: type,\n      distance: distance || game.system.grid.distance,\n      direction: 0,\n      x: 0,\n      y: 0,\n      flags,\n      fillColor: data.color ? data.color : game.user.color,\n      texture: data.texture ? data.texture : null,\n    };\n\n    // Additional type-specific data\n    switch (type) {\n      case \"cone\":\n        templateData.angle = game.settings.get(\"ffd20\", \"measureStyle\")\n          ? game.canvas.grid.isHexagonal\n            ? 60\n            : CONFIG.MeasuredTemplate.defaults.angle\n          : CONFIG.MeasuredTemplate.defaults.originalAngle;\n        break;\n\n      case \"rect\":\n        templateData.distance = Math.sqrt(Math.pow(distance, 2) + Math.pow(distance, 2));\n        templateData.direction = 45;\n        break;\n\n      case \"ray\":\n        templateData.width = CONFIG.MeasuredTemplate.defaults.width;\n        break;\n      default:\n        break;\n    }\n\n    // Return the template constructed from the item data\n    const cls = CONFIG.MeasuredTemplate.documentClass;\n    const template = new cls(templateData, { parent: canvas.scene });\n    const object = new this(template);\n    object.action = action;\n    return object;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Creates a preview of the spell template\n   *\n   * @override\n   * @param {Event} _event - The initiating click event\n   * @returns {Promise<object>} - Result\n   */\n  async drawPreview(_event) {\n    const initialLayer = canvas.activeLayer;\n    await this.draw();\n    this.layer.activate();\n    this.layer.preview.addChild(this);\n    return this.activatePreviewListeners(initialLayer);\n  }\n\n  /* -------------------------------------------- */\n\n  // Use system style\n  pfStyle = true;\n\n  // Event handlers\n  #events;\n\n  // Initial layer\n  #initialLayer;\n\n  /**\n   * Activate listeners for the template preview\n   *\n   * @param {CanvasLayer} initialLayer  The initially active CanvasLayer to re-activate after the workflow is complete\n   * @returns {Promise<object>} Returns result object\n   */\n  activatePreviewListeners(initialLayer) {\n    this.#initialLayer = initialLayer;\n    this.pfStyle = game.settings.get(\"ffd20\", \"measureStyle\") === true;\n\n    return new Promise((resolve, reject) => {\n      // Prepare events\n      this.#events = {\n        confirm: this._onConfirm.bind(this),\n        cancel: this._onCancel.bind(this),\n        move: this._onMove.bind(this),\n        rotate: this._onRotate.bind(this),\n        resolve,\n        reject,\n      };\n\n      // Prevent interactions with control icon\n      // This also allows left and right click to work correctly\n      if (this.controlIcon) this.controlIcon.removeAllListeners();\n\n      // Activate listeners\n      canvas.stage.on(\"pointermove\", this.#events.move);\n      canvas.stage.on(\"click\", this.#events.confirm);\n      canvas.app.view.addEventListener(\"contextmenu\", this.#events.cancel);\n      canvas.app.view.addEventListener(\"wheel\", this.#events.rotate);\n    });\n  }\n\n  #lastMove = 0;\n\n  // Update placement (mouse-move)\n  _onMove(event) {\n    event.stopPropagation();\n\n    // Throttle\n    const now = performance.now();\n    if (now - this.#lastMove <= this.constructor.RENDER_THROTTLE) return;\n\n    const snapMode =\n      CONST.GRID_SNAPPING_MODES.CENTER | CONST.GRID_SNAPPING_MODES.EDGE_MIDPOINT | CONST.GRID_SNAPPING_MODES.CORNER;\n\n    const center = event.data.getLocalPosition(this.layer);\n    const pos = canvas.grid.getSnappedPoint(center, { mode: snapMode });\n\n    // TODO: Adjust template size if placing in middle of a square (especially if on a token)\n\n    this.document.updateSource({\n      x: pos.x,\n      y: pos.y,\n    });\n\n    this.refresh();\n\n    this.#lastMove = now;\n  }\n\n  /**\n   * Cancel the workflow (right-click)\n   *\n   * @param {Event} event\n   */\n  _onCancel(event) {\n    console.debug(\"FFD20 | Cancelling template placement for\", this.action?.item?.name ?? \"unknown\");\n\n    this._onFinish(event);\n    this.#events.reject();\n  }\n\n  // Confirm the workflow (left-click)\n  _onConfirm(event) {\n    console.debug(\"FFD20 | Placing template for\", this.action?.item?.name ?? \"unknown\");\n\n    this._onFinish(event);\n\n    // Reject if template size is zero\n    if (!this.document.distance) return this.#events.reject();\n\n    // Create the template\n    // TODO: This should create the template directly and resolve with it.\n    const result = {\n      result: true,\n      place: async () => {\n        this.document = await MeasuredTemplateDocument.create(this.document.toObject(false), { parent: canvas.scene });\n        return this.document;\n      },\n      delete: () => {\n        return this.document.delete();\n      },\n    };\n\n    this.#events.resolve(result);\n  }\n\n  /**\n   * Rotate the template by 3 degree increments (mouse-wheel)\n   *\n   * @param {Event} event\n   */\n  _onRotate(event) {\n    event.preventDefault(); // Prevent browser zoom\n    event.stopPropagation(); // Prevent other handlers\n\n    let { distance, direction } = this.document,\n      delta;\n\n    if (event.ctrlKey) {\n      delta = canvas.dimensions.distance * -Math.sign(event.deltaY);\n      distance += delta;\n      if (distance < 0) distance = 0;\n    } else {\n      let snap;\n      if (this.pfStyle && this.document.t === \"cone\") {\n        delta = game.canvas.grid.isHexagonal ? 60 : 90;\n        snap = event.shiftKey ? delta : game.canvas.grid.isHexagonal ? 30 : 45;\n      } else {\n        delta = canvas.grid.type > CONST.GRID_TYPES.SQUARE ? 30 : 15;\n        snap = event.shiftKey ? delta : 5;\n      }\n      if (this.document.t === \"rect\") {\n        snap = Math.sqrt(Math.pow(5, 2) + Math.pow(5, 2));\n        distance += snap * -Math.sign(event.deltaY);\n      } else {\n        direction += snap * Math.sign(event.deltaY);\n      }\n    }\n\n    this.document.updateSource({ distance, direction });\n\n    this.refresh();\n  }\n\n  /** @override */\n  _onClickRight(event) {\n    event.stopPropagation(); // Prevent right click counting as left click\n  }\n\n  /**\n   * @param {Event} event\n   */\n  _onFinish(event) {\n    // Call Foundry's preview cleanup\n    this.layer._onDragLeftCancel(event);\n\n    // Remove listeners\n    canvas.stage.off(\"pointermove\", this.#events.move);\n    canvas.stage.off(\"click\", this.#events.confirm);\n    canvas.app.view.removeEventListener(\"contextmenu\", this.#events.cancel);\n    canvas.app.view.removeEventListener(\"wheel\", this.#events.rotate);\n\n    this.#initialLayer.activate();\n  }\n}\n","import { getSkipActionPrompt } from \"module/documents/settings.mjs\";\nimport { RollPF } from \"./roll.mjs\";\n\n/**\n * A class adding additional functionality to `Roll` class for d20 based Pathfinder rolls.\n */\nexport class D20RollPF extends RollPF {\n  /** @type {D20RollOptions} */\n  options;\n\n  /**\n   * Standard roll used by the system (1d20).\n   *\n   * @readonly\n   */\n  static standardRoll = \"1d20\";\n\n  /**\n   * @param {string} formula - The roll formula to parse\n   * @param {object} [data] - The data object against which to parse attributes within the formula\n   * @param {Partial<D20RollConstructorOptions>} [options] - Options\n   * @param {D20RollContext} [context] - Context\n   */\n  constructor(formula, data, options = {}, context = {}) {\n    super(formula, data, options);\n    this.options = foundry.utils.mergeObject(this.constructor.defaultOptions, options);\n\n    // Cleanup redundant options\n    if (this.options.check) delete this.options.check; // Keep only if set to false\n    if (!this.options.flavor) delete this.options.flavor;\n    if (!Number.isFinite(this.options.staticRoll)) delete this.options.staticRoll;\n    if (!this.options.bonus) delete this.options.bonus;\n    if (!Number.isFinite(this.options.dc)) delete this.options.dc;\n\n    this.context = context;\n\n    this._applyStaticRoll();\n  }\n\n  /**\n   * Apply static roll, such as Take 10/20\n   *\n   * @param {boolean} [force] - Ignore evaluated state of the roll and apply static roll config anyway.\n   * @protected\n   */\n  _applyStaticRoll(force = false) {\n    // Spoof only if check isn't disabled\n    if (this.options.check === false) return;\n    // _evaluate() has _evaluated already set true and the override is needed\n    if (this._evaluated && force !== true) return;\n\n    const d20 = this.d20;\n    const result = d20.total;\n\n    const isNumeric = d20 instanceof foundry.dice.terms.NumericTerm;\n    const isDie = d20 instanceof foundry.dice.terms.Die;\n\n    if (isNumeric) {\n      this.options.staticRoll = result;\n    } else if (isDie) {\n      /* NOP */\n    } else {\n      // Conflict between numeric term and static roll\n      throw new Error(`Invalid D20RollPF formula provided: ${this._formula}`);\n    }\n\n    if (!this.isStatic) return;\n\n    const die = isDie ? d20.toJSON() : {};\n\n    // Configure static roll\n    die.number = 1;\n    die.faces = 20;\n    die.results = [\n      {\n        result: this.options.staticRoll,\n        active: true,\n      },\n    ];\n    die.method = \"manual\"; // Spoof resolver for consistency\n    die.evaluated = true;\n\n    // Record spoofed term\n    this.terms[0] = new foundry.dice.terms.Die(die);\n  }\n\n  /**\n   * Default options for D20Rolls\n   *\n   * @type {Partial<D20RollOptions>}\n   */\n  static get defaultOptions() {\n    return { critical: 20 };\n  }\n\n  /**\n   * The default handlebars template used to render the roll's dialog\n   *\n   * @type {string}\n   * @readonly\n   */\n  static DIALOG_TEMPLATE = \"systems/ffd20/templates/chat/roll-dialog.hbs\";\n\n  /**\n   * The default handlebars template used to render the roll's chat message\n   *\n   * @type {string}\n   * @readonly\n   */\n  static CHAT_TEMPLATE = \"systems/ffd20/templates/chat/roll-ext.hbs\";\n\n  /**\n   * Static roll results\n   *\n   * @enum {number}\n   * @readonly\n   */\n  static STATIC_ROLL = {\n    TEN: 10,\n    TWENTY: 20,\n  };\n\n  /**\n   * The D20 die this roll is based on.\n   *\n   * @type {Die}\n   */\n  get d20() {\n    // this.dice[0] returns wrong number if formula had, for example, a die roll inside parenthesis.\n    return this.terms[0];\n  }\n\n  /**\n   * Is this a proper check?\n   *\n   * @type {boolean}\n   */\n  get isCheck() {\n    return this.options.check !== false;\n  }\n\n  /**\n   * Is this roll a critical success? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isCrit() {\n    if (!this._evaluated) return undefined;\n    if (!Number.isFinite(this.options.critical)) return false;\n    return this.d20.total >= this.options.critical;\n  }\n\n  /**\n   * Is this roll a natural 20? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isNat20() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total === 20;\n  }\n\n  /**\n   * Is this roll a natural 1? Returns undefined if roll isn't evaluated.\n   *\n   * @type {boolean|void}\n   */\n  get isNat1() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total === 1;\n  }\n\n  /**\n   * Difficulty Class\n   *\n   * @type {number|undefined}\n   */\n  get dc() {\n    return this.options.dc;\n  }\n\n  /**\n   * Is this roll a success against its DC?\n   *\n   * @remarks\n   * - Returns undefined if no DC is known or if the roll is not evaluated yet.\n   *\n   * @type {boolean|undefined}\n   */\n  get isSuccess() {\n    if (!this._evaluated) return undefined;\n    const dc = this.dc;\n    if (!Number.isFinite(dc)) return undefined;\n    if (dc <= this.total) return true;\n    return false;\n  }\n\n  /**\n   * Is this roll a failure against its DC?\n   *\n   * @remarks\n   * - Returns undefined if no DC is known or if the roll is not evaluated yet.\n   *\n   * @type {boolean|undefined}\n   */\n  get isFailure() {\n    if (!this._evaluated) return undefined;\n    const dc = this.dc;\n    if (!Number.isFinite(dc)) return undefined;\n    if (dc > this.total) return true;\n    return false;\n  }\n\n  /**\n   * DC offset\n   *\n   * @remarks\n   * - Returns NaN if no DC is defined.\n   * - Returns NaN if the roll has not been evaluated.\n   *\n   * @type {number}\n   */\n  get offset() {\n    if (!this._evaluated) return NaN;\n    return this.total - this.dc;\n  }\n\n  /**\n   * How many 5s over the DC is this?\n   *\n   * Primarily meant for things like Heal check bonus healing or similar.\n   *\n   * @remarks\n   * - Returns NaN if no DC is defined.\n   *\n   * @type {number}\n   */\n  get overBy5() {\n    return Math.floor(this.offset / 5);\n  }\n\n  /**\n   * Is this roll a misfire.\n   *\n   * @type {boolean|void}\n   */\n  get isMisfire() {\n    if (!this._evaluated) return undefined;\n    return this.natural <= (this.options.misfire ?? 0);\n  }\n\n  /**\n   * Natural roll value. Undefined if the roll isn't evaluated.\n   *\n   * @type {number|void}\n   */\n  get natural() {\n    if (!this._evaluated) return undefined;\n    return this.d20.total;\n  }\n\n  /**\n   * Is static roll (e.g. Take 20)\n   *\n   * @type {boolean}\n   */\n  get isStatic() {\n    return Number.isFinite(this.options.staticRoll) || this.d20.method === \"manual\";\n  }\n\n  /**\n   * Is not an actual roll.\n   *\n   * @type {boolean}\n   */\n  get isNonRoll() {\n    return this.d20.constructor.name !== \"Die\" && this.options.check === false;\n  }\n\n  /**\n   * Is a normal d20\n   *\n   * @type {boolean}\n   */\n  get isNormal() {\n    return this.d20.formula === this.constructor.standardRoll;\n  }\n\n  /**\n   * Modifier on the roll besides natural roll. Undefined if the roll isn't evaluated.\n   *\n   * @type {number|void}\n   */\n  get bonus() {\n    if (!this._evaluated) return undefined;\n    return this.total - this.natural;\n  }\n\n  /**\n   * Return a standardized representation for the displayed formula associated with this Roll.\n   * This formula includes any {@link D20RollOptions.bonus bonus} that might not be part of this roll's {@link terms}.\n   *\n   * @type {string}\n   */\n  get formula() {\n    let formula = this.constructor.getFormula(this.terms);\n    const bonusTerms = this.constructor.parse(`${this.options.bonus}`, this.data);\n    if (this.options.bonus && !this._evaluated) formula += ` + ${this.constructor.getFormula(bonusTerms)}`;\n    return formula;\n  }\n\n  /**\n   * The flavor this roll was created with.\n   *\n   * @type {string}\n   */\n  get flavor() {\n    return this.options.flavor;\n  }\n\n  /**\n   * Render a {@link Dialog} for the user to enter additional bonuses, set a static roll result, or take 10/20.\n   *\n   * @param {D20RollDialogOptions} [options] - Additional options determining what options to show in the dialog\n   * @returns {Promise<this | null>} A promise that resolves when the dialog is closed\n   */\n  async promptDialog(options = {}) {\n    const { rollMode = game.settings.get(\"core\", \"rollMode\"), template = this.constructor.DIALOG_TEMPLATE } = options;\n    const d20 = this.isStatic ? this.options.staticRoll : this.d20.formula;\n    const hasDC = Number.isFinite(options.dc);\n    const editDC = game.user.isGM || !hasDC || !game.settings.get(\"ffd20\", \"obscureSaveDCs\");\n    const templateData = {\n      check: true,\n      data: this.data,\n      rollMode: options.rollMode || rollMode,\n      rollModes: CONFIG.Dice.rollModes,\n      // TODO: Move this standard roll obfuscation to dialog handling\n      d20: d20 === ffd20.dice.D20RollPF.standardRoll ? \"\" : d20, // Do not show standard roll in the input field\n      bonus: this.options.bonus || options.bonus, // DEPRECATED: this.options.bonus to be removed with PF1 v12\n      dc: options.dc,\n      editDC,\n    };\n\n    let title = options.title || game.i18n.localize(\"FFD20.Roll\");\n    // Display DC, if allowed\n    if (hasDC && editDC) title += \" (\" + game.i18n.format(\"FFD20.DCThreshold\", { threshold: options.dc }) + \")\";\n\n    const dialogData = {\n      window: { title },\n      position: { width: 420 },\n      classes: [\"pf1-v2\", \"roll-prompt\"],\n      content: await renderTemplate(template, templateData),\n      buttons: [\n        {\n          action: \"normal\",\n          default: true,\n          icon: \"fa-solid fa-dice-d20\",\n          label: game.i18n.localize(\"FFD20.Normal\"),\n          callback: (event, button, html) => this._onDialogSubmit(html, null),\n        },\n        {\n          action: \"take10\",\n          label: game.i18n.format(\"FFD20.TakeX\", { number: this.constructor.STATIC_ROLL.TEN }),\n          callback: (event, button, html) => this._onDialogSubmit(html, this.constructor.STATIC_ROLL.TEN),\n        },\n        {\n          action: \"take20\",\n          label: game.i18n.format(\"FFD20.TakeX\", { number: this.constructor.STATIC_ROLL.TWENTY }),\n          callback: (event, button, html) => this._onDialogSubmit(html, this.constructor.STATIC_ROLL.TWENTY),\n        },\n      ],\n      close: () => null,\n      rejectClose: false,\n      subject: options.subject,\n      speaker: options.speaker,\n      roll: this,\n    };\n\n    if (options.dialogOptions) {\n      foundry.utils.mergeObject(dialogData, options.dialogOptions);\n    }\n\n    return foundry.applications.api.DialogV2.wait(dialogData);\n  }\n\n  /**\n   * Converts form element to object\n   *\n   * @protected\n   * @param {HTMLFormElement} html\n   * @returns {object} - Expanded form data\n   */\n  _getFormData(html) {\n    return foundry.utils.expandObject(new FormDataExtended(html).object);\n  }\n\n  /**\n   * A callback applying the user's input from the dialog to the roll and its options.\n   *\n   * @protected\n   * @param {HTMLElement} html - The dialog's submitted HTML\n   * @param {number | null} [staticRoll] - A static roll result to use instead of rolling the dice\n   * @returns {D20RollPF} This roll\n   */\n  _onDialogSubmit(html, staticRoll) {\n    const form = html.querySelector(\"form\");\n    if (!form) return this;\n    const formData = this._getFormData(form);\n\n    if (formData.bonus) this.options.bonus = formData.bonus;\n\n    if (formData.d20) {\n      const baseDice = this.constructor.parse(formData.d20, this.data);\n      // If a static roll is given as d20 input, Take X button clicks are ignored\n      if (baseDice[0] instanceof foundry.dice.terms.NumericTerm) this.options.staticRoll = baseDice[0].total;\n      else if (baseDice[0] instanceof foundry.dice.terms.Die) {\n        this.terms = [...baseDice, ...this.terms.slice(1)];\n        // d20 input is actual dice, so Take X buttons are respected\n        this.options.staticRoll = staticRoll;\n      }\n    } else {\n      // No d20 input, base die is default, so Take X buttons are respected\n      this.options.staticRoll = staticRoll;\n    }\n\n    if (formData.rollMode) {\n      this.options.rollMode = formData.rollMode;\n    }\n\n    if (Number.isFinite(formData.dc)) this.options.dc = formData.dc;\n\n    this._formula = this.constructor.getFormula(this.terms);\n\n    return this;\n  }\n\n  /**\n   * Render a Roll instance to HTML\n   *\n   * @override\n   * @param {object} [options={}] - Options which affect how the Roll is rendered\n   * @param {string} [options.flavor] - Flavor text to include\n   * @param {string} [options.template] - A custom HTML template path\n   * @param {boolean} [options.isPrivate=false] - Is the Roll displayed privately?\n   * @returns {Promise<string>} - The rendered HTML template as a string\n   * Synced with Foundry v12.331\n   */\n  async render({ flavor, template = this.constructor.CHAT_TEMPLATE, isPrivate = false } = {}) {\n    if (!this._evaluated) await this.evaluate({ allowInteractive: !isPrivate });\n\n    const templateData = {\n      onDemand: true,\n      isPrivate,\n      formula: isPrivate ? \"???\" : this._formula,\n      flavor: isPrivate ? null : (flavor ?? this.options.flavor),\n      user: game.user.id,\n      details: isPrivate ? \"\" : await this.getTooltip(),\n      total: isPrivate ? \"?\" : ffd20.utils.limitPrecision(this.total, 2), // Total result\n      roll: this,\n      d20: this.d20.total, // Natural d20 roll\n      bonus: this.bonus, // Total bonus to the roll\n      precision: Math.floor((this.total - Math.floor(this.total)) * 100), // Extra precision\n      isCrit: this.isCrit,\n      isMisfire: this.isMisfire,\n      isNat20: this.isNat20,\n      isNat1: this.isNat1,\n      dc: this.dc,\n      hasDC: Number.isFinite(this.dc),\n      isSuccess: this.isSuccess,\n      isFailure: this.isFailure,\n      natural: this.natural,\n      options: this.options,\n      isStatic: this.isStatic,\n      isNormal: this.isNormal,\n      isNonRoll: this.isNonRoll,\n      get isAbnormal() {\n        if (this.isNonRoll) return false; // Technically abnormal but not override\n        return this.isStatic || !this.isNormal;\n      },\n      get abnormalTooltip() {\n        if (this.isStatic) return game.i18n.format(\"FFD20.TakeX\", { number: this.d20 });\n        else if (this.isAbnormal) return \"FFD20.CustomRollDesc\";\n        else return \"\";\n      },\n    };\n\n    return renderTemplate(template, templateData);\n  }\n\n  /**\n   * Transform this roll into a {@link ChatMessage} displaying the result.\n   * This function can either create a ChatMessage (by default) or return the data object that would be used to create one.\n   *\n   * @param {object} messageData - The data object to use when creating the message\n   * @param {D20RollChatOptions} options - Additional options which configure how the message is created\n   * @returns {Promise<ChatMessage | object>} The created ChatMessage document, or the object of data that would be used to create one\n   */\n  async toMessage(messageData = {}, options = {}) {\n    if (!this._evaluated) await this.evaluate();\n\n    const chatTemplate = options.chatTemplate || this.constructor.CHAT_TEMPLATE;\n    const chatTemplateData = foundry.utils.mergeObject(\n      {\n        formula: this.formula,\n        details: await this.getTooltip(),\n        roll: this,\n        d20: this.d20.total, // Natural d20 roll\n        total: ffd20.utils.limitPrecision(this.total, 2), // Total result\n        bonus: this.bonus, // Total bonus to the roll\n        precision: Math.floor((this.total - Math.floor(this.total)) * 100), // Extra precision\n        isCrit: this.isCrit,\n        isMisfire: this.isMisfire,\n        isNat20: this.isNat20,\n        isNat1: this.isNat1,\n        dc: this.dc,\n        hasDC: Number.isFinite(this.dc),\n        isSuccess: this.isSuccess,\n        isFailure: this.isFailure,\n        natural: this.natural,\n        options: this.options,\n        isStatic: this.isStatic,\n        isNormal: this.isNormal,\n        isNonRoll: this.isNonRoll,\n        get isAbnormal() {\n          if (this.isNonRoll) return false; // Technically abnormal but not override\n          return this.isStatic || !this.isNormal;\n        },\n        get abnormalTooltip() {\n          if (this.isStatic) return game.i18n.format(\"FFD20.TakeX\", { number: this.d20 });\n          else if (this.isAbnormal) return \"FFD20.CustomRollDesc\";\n          else return \"\";\n        },\n        flavor: this.options.flavor,\n        compendiumEntry: options.compendium?.entry,\n        compendiumEntryType: options.compendium?.type,\n      },\n      options.chatTemplateData || {}\n    );\n\n    const rollMode = options.rollMode || this.options.rollMode || game.settings.get(\"core\", \"rollMode\");\n\n    messageData = foundry.utils.mergeObject(\n      {\n        type: \"check\",\n        style: CONST.CHAT_MESSAGE_STYLES.OTHER,\n        sound: options.noSound ? undefined : CONFIG.sounds.dice,\n        content: await renderTemplate(chatTemplate, chatTemplateData),\n        system: {\n          dc: this.dc,\n          reference: options.reference,\n        },\n      },\n      messageData\n    );\n    messageData.rolls = [this]; // merge/expandObject would otherwise destroy the `Roll` instance\n\n    messageData.system ??= {};\n    if (options.subject) messageData.system.subject = options.subject;\n\n    // Add combat reference if such exists\n    const actor = ChatMessage.getSpeakerActor(messageData.speaker);\n    if (actor && game.combat?.combatants.some((c) => c.actor === actor)) {\n      foundry.utils.setProperty(messageData, \"system.combat\", game.combat.id);\n    }\n\n    const message = new ChatMessage.implementation(messageData);\n    if (rollMode) message.applyRollMode(rollMode);\n    messageData = message.toObject();\n\n    if (options.create ?? true) {\n      return ChatMessage.implementation.create(messageData, { rollMode });\n    } else {\n      return messageData;\n    }\n  }\n\n  /** @inheritDoc */\n  async _evaluate(options) {\n    this._applyBonus(); // deprecated\n    this._applyStaticRoll(true);\n    await super._evaluate(options);\n    return this;\n  }\n\n  /** @inheritDoc */\n  _evaluateSync(options) {\n    this._applyBonus(); // deprecated\n    this._applyStaticRoll(true);\n    super._evaluateSync(options);\n    return this;\n  }\n\n  /**\n   * Apply the bonus the roll was created with or the user entered into the dialog.\n   *\n   * @deprecated\n   * @private\n   */\n  _applyBonus() {\n    if (this.options.bonus) {\n      foundry.utils.logCompatibilityWarning(\n        \"D20RollPF bonus option is deprecated in favor of including it in the base formula itself\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      const bonusTerms = this.constructor.parse(`${this.options.bonus}`, this.data);\n      if (!(bonusTerms[0] instanceof foundry.dice.terms.OperatorTerm))\n        bonusTerms.unshift(new foundry.dice.terms.OperatorTerm({ operator: \"+\" }));\n      this.terms.push(...bonusTerms);\n      this._formula = this.constructor.getFormula(this.terms);\n    }\n  }\n\n  /**\n   * @internal\n   * @param {string} bonus\n   */\n  addBonus(bonus) {\n    const bonusTerms = this.constructor.parse(`${bonus}`, this.data);\n    if (bonusTerms[0].operator !== \"+\") bonusTerms.unshift(new foundry.dice.terms.OperatorTerm({ operator: \"+\" }));\n    this.terms.push(...bonusTerms);\n    this._formula = this.constructor.getFormula(this.terms);\n  }\n}\n\n/**\n * Performs an actor based d20 roll.\n *\n * @param {Partial<D20ActorRollOptions>} [options] - Options\n * @example Rolling a 1d20 + an actor's BAB + 2 for good behavior\n * ```js\n * const actor = game.actors.getName(\"Righteous Paladin\");\n * await ffd20.dice.d20Roll({\n *   skipDialog: true, // Roll away without a dialog\n *   flavor: \"BAB\", // Add a flavor/title to the roll\n *   parts: [`${actor.system.attributes.bab.total}[BAB]`], // Use the actor's BAB\n *   dice: \"2d20kh\", // Roll 2 d20s and keep the highest\n *   bonus: \"2[Good Behavior]\", // Add a static bonus of 2\n *   rollMode: \"gmroll\", // Make roll only visible to user and GM\n * });\n * ```\n * @returns {Promise<ChatMessage | object | undefined>} The created ChatMessage document, the object of data that would be used to create one, or undefined if cancelled\n */\nexport async function d20Roll(options = {}) {\n  const {\n    skipDialog = getSkipActionPrompt(),\n    staticRoll = null,\n    chatTemplateData = {},\n    chatMessage = true,\n    compendium,\n    noSound = false,\n    flavor = \"\",\n    parts = [],\n    dice = ffd20.dice.D20RollPF.standardRoll,\n    rollData = {},\n    subject,\n    bonus = \"\",\n    speaker,\n    messageData = undefined,\n    dc,\n    reference,\n  } = options;\n\n  let rollMode = options.rollMode;\n\n  const formula = [dice, ...parts].join(\" + \");\n\n  const roll = new ffd20.dice.D20RollPF(formula, rollData, { flavor, staticRoll, bonus, dc }, { speaker });\n  if (!skipDialog) {\n    const title = speaker?.alias ? `${speaker.alias}: ${flavor}` : flavor;\n    const dialogResult = await roll.promptDialog({ title, rollMode, bonus, subject, speaker, dc });\n    if (dialogResult === null) return;\n\n    // Move roll mode selection from roll data\n    rollMode = roll.options.rollMode;\n    delete roll.options.rollMode;\n  }\n\n  // Move deprecated roll.options.bonus out\n  if (roll.options?.bonus) {\n    roll.addBonus(roll.options.bonus);\n    delete roll.options.bonus;\n  }\n\n  if (Hooks.call(\"pf1PreD20Roll\", roll, options) === false) return;\n\n  return roll.toMessage(\n    { ...messageData, speaker },\n    { create: chatMessage, noSound, chatTemplateData, compendium, subject, dc, reference, rollMode }\n  );\n}\n","import { RollPF } from \"./roll.mjs\";\n\n/**\n * A specialized Roll class which is used to evaluate damage rolls.\n * Provides additional utility getters for data relevant to damage rolls (e.g. damage type).\n */\nexport class DamageRoll extends RollPF {\n  /**\n   * @param {string} formula - The formula to parse.\n   * @param {object} data - The data object against which to parse attributes within the formula.\n   * @param {object} options - Additional options which customize the created Roll instance.\n   */\n  constructor(formula, data, options = {}) {\n    super(formula, data, options);\n\n    this.options.damageType ??= [\"untyped\"];\n    if (this.options.damageType instanceof Set) this.options.damageType = [...this.options.damageType];\n\n    // Add DSN dice styling based on type\n    if (game.dice3d?.isEnabled() && game.dice3d?.constructor.CONFIG().enableFlavorColorset) {\n      // FIXME: for now just randomization of the damage type since we cannot handle randomization of multiple damage types\n      const typeId = this.options.damageType[Math.floor(Math.random() * this.options.damageType.length)];\n      const type = ffd20.registry.damageTypes.get(typeId);\n\n      if (type?.diceSoNice) {\n        this.options.appearance = { ...type.diceSoNice };\n      }\n    }\n  }\n\n  /**\n   * Types of damage rolls with regard to their critical status.\n   *\n   * @type {{NON_CRITICAL: string, NORMAL: string, CRITICAL: string}}\n   */\n  static TYPES = {\n    NORMAL: \"normal\",\n    CRITICAL: \"crit\",\n    NON_CRITICAL: \"nonCrit\",\n  };\n\n  /**\n   * The damage type info of this damage roll.\n   *\n   * Returns damage part model to benefit from its auxiliary functionality.\n   *\n   * @type {ffd20.models.action.DamagePartModel}\n   */\n  get damageType() {\n    return new ffd20.models.action.DamagePartModel({ types: this.options.damageType });\n  }\n\n  /**\n   * The type of this damage roll.\n   *\n   * @see {@link DamageRoll.TYPES}\n   * @type {\"normal\"|\"crit\"|\"nonCrit\"}\n   */\n  get type() {\n    return this.options.type;\n  }\n\n  /**\n   * Whether this damage roll is for a critical damage instance.\n   *\n   * @type {boolean}\n   */\n  get isCritical() {\n    return this.type === this.constructor.TYPES.CRITICAL;\n  }\n}\n","/**\n * Function Term override to support sizeRoll\n */\nexport class FunctionTermPF extends CONFIG.Dice.termTypes.FunctionTerm {\n  /** @override */\n  get expression() {\n    // Evaluated sizeRoll has extra term to store the roll in\n    if (this._evaluated && this.fn === \"sizeRoll\") {\n      const terms = [...this.terms];\n      terms.pop(); // Remove the result\n      return `sizeRoll(${terms.join(\",\")})`;\n    }\n    return super.expression;\n  }\n\n  /**\n   * Simpler formula expression if possible\n   *\n   * @remarks\n   * - Used mainly by {@link ffd20.utils.formula.simplify()}\n   * - Unevaluated rolls can't always be simplified.\n   * @type {string}\n   */\n  get simplify() {\n    switch (this.fn) {\n      case \"sizeRoll\":\n        if (!this._evaluated) {\n          if (this.terms.length === 2) return this.terms.join(\"d\");\n          else return this.expression;\n        }\n        return this.terms.at(-1);\n      case \"if\": {\n        const cond = this.rolls[0];\n        if (!cond.isDeterministic) return this.expression;\n        if (cond.total !== 0) return this.terms[1];\n        return \"0\";\n      }\n      case \"ifelse\": {\n        const cond = this.rolls[0];\n        if (!cond.isDeterministic) return this.expression;\n        if (cond.total !== 0) return this.terms[1];\n        return this.terms[2];\n      }\n      case \"lookup\": {\n        const search = this.rolls[0];\n        if (!search.isDeterministic) return this.expression;\n        const offset = search.total;\n        const result = this.terms[offset + 1] ?? this.terms[1];\n        return result;\n      }\n    }\n    return this.expression;\n  }\n\n  /**\n   * Flavor text\n   *\n   * @type {string}\n   */\n  get flavor() {\n    return this.options.flavor || \"\";\n  }\n\n  /** @override */\n  get isDeterministic() {\n    if (this.fn === \"sizeRoll\") return false; // sizeRoll is never deterministic\n    return super.isDeterministic;\n  }\n\n  /** @override */\n  _evaluateSync(options = {}) {\n    super._evaluateSync(options);\n    if (this.fn === \"sizeRoll\") {\n      const result = this.rolls.at(-1);\n      result.options.flavor ||= this.flavor;\n      result.propagateFlavor(this.flavor);\n      if (!result._evaluated) result.evaluateSync(options);\n      this.result = result.total;\n    }\n    return this;\n  }\n\n  /** @override */\n  async _evaluateAsync(options = {}) {\n    await super._evaluateAsync(options);\n    if (this.fn === \"sizeRoll\") {\n      const result = this.rolls.at(-1);\n      result.options.flavor ||= this.flavor;\n      result.propagateFlavor(this.flavor);\n      if (!result._evaluated) await result.evaluate(options);\n      this.result = result.total;\n    }\n    return this;\n  }\n\n  /** @override */\n  toJSON() {\n    const json = super.toJSON();\n    json.class = super.constructor.name; // Alias to original function term to allow de-serialization to work\n    return json;\n  }\n}\n","/**\n * String Term override to support booleans as numbers\n *\n * Should be obsoleted by: https://github.com/foundryvtt/foundryvtt/issues/12139\n */\nexport class StringTermPF extends foundry.dice.terms.StringTerm {\n  constructor({ term, options } = {}) {\n    if ([\"true\", \"false\"].includes(term))\n      return new foundry.dice.terms.NumericTerm({ number: term === \"true\" ? 1 : 0, options });\n\n    super({ term, options });\n  }\n}\n","import { getHighestChanges } from \"@actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"../dice/roll.mjs\";\nimport { DamageRoll } from \"../dice/damage-roll.mjs\";\n\nimport { DocumentLikeModel } from \"@models/abstract/document-like-model.mjs\";\nimport { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\nimport { DamagePartModel } from \"@models/action/damage-part-model.mjs\";\nimport { ExtraAttackModel } from \"@models/action/extra-attack-model.mjs\";\n\nimport { ReplaceableSourceMixin } from \"@models/mixins/replaceable-source.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\n/**\n * Action pseudo-document\n */\nexport class ItemAction extends ReplaceableSourceMixin(CompactingMixin(DocumentLikeModel)) {\n  /**\n   * Default image if the action has no image and it is not correctly linked to an item\n   *\n   * @readonly\n   */\n  static FALLBACK_IMAGE = /** @type {const} */ (\"systems/ffd20/icons/skills/gray_04.jpg\");\n\n  /**\n   * Metadata mimicking Foundry documents\n   *\n   * Required by {@link ffd20.applications.ItemActionSheet#_createDocumentIdLink}\n   *\n   * @internal\n   * @readonly\n   */\n  static metadata = Object.freeze({\n    label: \"FFD20.Action\",\n  });\n\n  /**\n   * @param {object} data - Action data\n   * @param {*} options - Data model options\n   */\n  constructor(data, options) {\n    if (options instanceof Item) {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemAction constructor's second parameter as parent is deprecated. Please wrap it in options object like with datamodels.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      options = { parent: options };\n    }\n\n    super(data, options);\n  }\n\n  /** @override */\n  _configure(options) {\n    super._configure(options);\n\n    // Following prevent these definitions being lost on model reset()\n    Object.defineProperties(this, {\n      // Apps\n      apps: {\n        value: {},\n        writable: false,\n        enumerable: false,\n      },\n      // Sheet cache\n      _sheet: {\n        value: null,\n        writable: true,\n        enumerable: false,\n      },\n      // Conditionals collection cache to avoid conflicts with stored array\n      _conditionals: {\n        value: new Collection(),\n        writable: false,\n        enumerable: false,\n      },\n    });\n  }\n\n  /** @override */\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    const blankToNull = { nullable: true, blank: false };\n    return {\n      ...super.defineSchema({ name: () => game.i18n.localize(\"FFD20.Action\") }),\n      img: new fields.FilePathField({ categories: [\"IMAGE\"] }),\n      description: new fields.HTMLField(),\n      tag: new fields.StringField({ blank: false, nullable: true }), // TODO: slug field\n      activation: new fields.SchemaField({\n        cost: new fields.NumberField({ initial: 1, nullable: true, min: 1, integer: true }),\n        type: new fields.StringField({ initial: \"nonaction\" }), // ffd20.config.abilityActivationTypes\n        unchained: new fields.SchemaField({\n          cost: new fields.NumberField({ initial: 1, nullable: true, min: 1, integer: true }),\n          type: new fields.StringField({ initial: \"nonaction\" }), // ffd20.config.abilityActivationTypes_unchained\n        }),\n      }),\n      duration: new fields.SchemaField({\n        value: new fields.StringField(),\n        units: new fields.StringField(),\n        dismiss: new fields.BooleanField({ initial: false }),\n        concentration: new fields.BooleanField({ initial: false }),\n      }),\n      // Refactor into just .target string?\n      target: new fields.SchemaField({\n        value: new fields.StringField(),\n      }),\n      range: new fields.SchemaField({\n        value: new fields.StringField({ ...blankToNull }),\n        units: new fields.StringField({ ...blankToNull }),\n        maxIncrements: new fields.NumberField({ integer: true, nullable: false, initial: 1 }),\n        minValue: new fields.StringField({ ...blankToNull }),\n        minUnits: new fields.StringField({ ...blankToNull }),\n      }),\n      uses: new fields.SchemaField({\n        autoDeductChargesCost: new fields.StringField(),\n        perAttack: new fields.BooleanField({ initial: false }),\n        self: new fields.SchemaField({\n          value: new fields.NumberField({ integer: true, min: 0, nullable: false, initial: 0 }),\n          maxFormula: new FormulaField(),\n          per: new fields.StringField(),\n        }),\n      }),\n      measureTemplate: new fields.SchemaField({\n        type: new fields.StringField(),\n        size: new FormulaField(),\n        color: new fields.ColorField(),\n        texture: new fields.FilePathField({ categories: [\"IMAGE\", \"VIDEO\"] }),\n      }),\n      bab: new FormulaField(),\n      attackName: new fields.StringField(),\n      actionType: new fields.StringField({ initial: \"other\" }), // ffd20.config.itemActionTypes\n      attackBonus: new FormulaField(),\n      critConfirmBonus: new FormulaField(),\n      damage: new fields.SchemaField({\n        parts: new fields.ArrayField(new fields.EmbeddedDataField(DamagePartModel)),\n        critParts: new fields.ArrayField(new fields.EmbeddedDataField(DamagePartModel)),\n        nonCritParts: new fields.ArrayField(new fields.EmbeddedDataField(DamagePartModel)),\n      }),\n      extraAttacks: new fields.SchemaField({\n        type: new fields.StringField(), // ffd20.config.extraAttacks\n        manual: new fields.ArrayField(new fields.EmbeddedDataField(ExtraAttackModel)),\n        formula: new fields.SchemaField({\n          count: new FormulaField(),\n          bonus: new FormulaField(),\n          label: new fields.StringField(),\n        }),\n      }),\n      ability: new fields.SchemaField({\n        attack: new fields.StringField(), // ability key\n        damage: new fields.StringField(), // ability key\n        max: new fields.NumberField({ integer: true, nullable: true }),\n        damageMult: new fields.NumberField({ initial: null }),\n        critRange: new fields.NumberField({ initial: 20, nullable: true }), // null => 0\n        critMult: new fields.NumberField({ initial: 2, nullable: true }), // null => 1\n      }),\n      save: new fields.SchemaField({\n        dc: new FormulaField(),\n        type: new fields.StringField(), // ffd20.config.savingThrows\n        description: new fields.StringField(),\n        harmless: new fields.BooleanField({ initial: false }),\n      }),\n      notes: new fields.SchemaField({\n        effect: new fields.ArrayField(new fields.StringField()),\n        footer: new fields.ArrayField(new fields.StringField()),\n      }),\n      soundEffect: new fields.FilePathField({ categories: [\"AUDIO\"] }),\n      powerAttack: new fields.SchemaField({\n        multiplier: new fields.NumberField({ min: 0, initial: null, nullable: true }),\n        damageBonus: new fields.NumberField({ min: 0, initial: 2, integer: true }),\n        critMultiplier: new fields.NumberField({ min: 1, initial: 1, integer: true }),\n      }),\n      naturalAttack: new fields.SchemaField({\n        primary: new fields.BooleanField({ initial: true }),\n        secondary: new fields.SchemaField({\n          attackBonus: new FormulaField(),\n          damageMult: new fields.NumberField({ initial: 0.5, positive: true }),\n        }),\n      }),\n      held: new fields.StringField({ choices: () => ffd20.config.weaponHoldTypes, initial: undefined, blank: true }),\n      nonlethal: new fields.BooleanField({ initial: false }),\n      manadamage: new fields.BooleanField({ initial: false }),\n      splash: new fields.BooleanField({ initial: false }),\n      touch: new fields.BooleanField({ initial: false }),\n      ammo: new fields.SchemaField({\n        type: new fields.StringField(), // ffd20.config.ammoTypes\n        cost: new fields.NumberField({ integer: true, min: 0, initial: 1 }),\n      }),\n      effect: new fields.StringField(),\n      area: new fields.StringField(),\n      conditionals: new fields.ArrayField(new fields.ObjectField()), // TODO\n      enh: new fields.SchemaField({\n        value: new fields.NumberField({ integer: true, min: 0, initial: null, nullable: true }),\n      }),\n      material: new fields.SchemaField({\n        normal: new fields.SchemaField({\n          value: new fields.StringField(),\n          custom: new fields.BooleanField({ initial: false }),\n        }),\n        addon: new fields.SetField(new fields.StringField({ nullable: false, blank: false })),\n      }),\n      // Trinary alignments to allow inheriting from item and to explicitly disabling alignments\n      alignments: new fields.SchemaField({\n        lawful: new fields.BooleanField({ nullable: true, initial: null }),\n        chaotic: new fields.BooleanField({ nullable: true, initial: null }),\n        good: new fields.BooleanField({ nullable: true, initial: null }),\n        evil: new fields.BooleanField({ nullable: true, initial: null }),\n      }),\n    };\n  }\n\n  /** @override */\n  static migrateData(source) {\n    if (typeof source !== \"object\") return;\n\n    source.activation ??= {};\n    source.activation.unchained ??= {};\n\n    // Added with v?\n    // .unchainedAction.activation to .activation.unchained\n    if (source.unchainedAction?.activation) {\n      source.activation.unchained = source.unchainedAction.activation;\n    }\n\n    // Inconsistent held option (PF1 v11)\n    if (source.held === \"normal\") source.held = \"1h\";\n\n    // Migrate invalid string activation cost to 1.\n    if (typeof source.activation.cost === \"string\") source.activation.cost = 1;\n    if (typeof source.activation.unchained?.cost === \"string\") source.activation.unchained.cost = 1;\n\n    if (source.enh !== undefined) {\n      if (typeof source.enh !== \"object\") {\n        source.enh = { value: source.enh ?? null };\n      }\n      // Set to null if disabled.\n      if (source.enh.override === false) {\n        source.enh.value = null;\n      }\n      // Reset odd values to null, too.\n      else if (source.enh.value !== null && typeof source.enh.value !== \"number\") {\n        source.enh.value = null;\n      }\n    }\n\n    if (source.uses?.autoDeductCharges === false) {\n      source.uses.autoDeductChargesCost = \"0\";\n    } else if (source.uses?.autoDeductCharges === true) {\n      source.uses.autoDeductChargesCost = \"1\";\n    }\n\n    // Added with v10\n    source.actionType ||= \"other\";\n    source.area ||= source.spellArea;\n\n    // Migrate unlimited to empty selection, as the two are identical in meaning\n    if (source.uses?.self?.per === \"unlimited\") {\n      delete source.uses.self.per;\n    }\n\n    const mt = source.measureTemplate;\n    if (mt) {\n      mt.color ||= mt.customColor;\n      mt.texture ||= mt.customTexture;\n    }\n\n    // Added with v11\n    if (source.range?.maxIncrements === null || source.range?.maxIncrements < 1) source.range.maxIncrements = 1;\n    if (source.spellEffect && !source.effect) source.effect = source.spellEffect;\n    if (source.naturalAttack?.primaryAttack !== undefined && source.naturalAttack?.primary === undefined) {\n      source.naturalAttack.primary = source.naturalAttack?.primaryAttack;\n    }\n    source.notes ??= {};\n    if (source.effectNotes && !source.notes.effect) source.notes.effect = source.effectNotes;\n    if (source.attackNotes && !source.notes.footer) source.notes.footer = source.attackNotes;\n\n    if (source.range?.units === \"none\") delete source.range.units;\n\n    //if (data.ability?.critMult === null) data.ability.critMult = 1;\n    //if (data.ability?.critRange === null) data.ability.critRange = 0;\n\n    // Since v9, convert old damage array format of [formula, types] tuple into object\n    // DamagePartModel.migrateData can't handle this as DataModel trashes it before it reaches it\n    // See: https://github.com/foundryvtt/foundryvtt/issues/12125\n    if (source.damage) {\n      for (const key of [\"parts\", \"critParts\", \"nonCritParts\"]) {\n        const parts = source.damage[key] ?? [];\n        if (parts.some((p) => Array.isArray(p))) {\n          source.damage[key] = parts.map((p) => {\n            if (Array.isArray(p)) {\n              const [formula, type] = p;\n              return { formula, type };\n            }\n            return p;\n          });\n        }\n      }\n    }\n\n    return super.migrateData(source);\n  }\n\n  /**\n   * Retrieve UUID\n   *\n   * Relies on {@link ffd20.documents.item.ItemBasePF.getEmbeddedDocument | Item#getEmbeddedDocument()} override to function with fromUuid() and similar functions.\n   *\n   * @type {string}\n   */\n  get uuid() {\n    return this.parent.uuid + `.Action.${this.id}`;\n  }\n\n  /**\n   * Data preparation\n   *\n   * @internal\n   */\n  prepareData() {\n    // Default action type to other if undefined.\n    // Optimally this would be in constructor only, but item action handling can cause that to be lost\n    this.actionType ||= \"other\";\n\n    this.img ||= this.item?.img || this.constructor.FALLBACK_IMAGE;\n\n    this.tag ||= ffd20.utils.createTag(this.name);\n\n    // DEPRECATIONS\n    if (this.naturalAttack) {\n      Object.defineProperty(this.naturalAttack, \"primaryAttack\", {\n        get() {\n          foundry.utils.logCompatibilityWarning(\n            \"ItemAction.naturalAttack.primaryAttack is deprecated in favor of ItemAction.naturalAttack.primary\",\n            {\n              since: \"PF1 v11\",\n              until: \"PF1 v12\",\n            }\n          );\n          return this.primary;\n        },\n      });\n    }\n\n    // Prepare ammo\n    const ammoType = this.ammo?.type;\n    this.ammo.type = ammoType === \"none\" ? null : ammoType || this.item?.system.ammo?.type || null;\n\n    if (this.ammo.type) this.ammo.cost ??= 1;\n    else this.ammo.cost = 0; // Force zero if no type defined\n\n    // Override activation\n    if (game.settings.get(\"ffd20\", \"unchainedActionEconomy\")) {\n      this.activation = this.activation.unchained;\n    }\n\n    this._prepareConditionals();\n\n    // Nothing more if there's no parent. Temporary Action?\n    if (!this.item) return;\n\n    const rollData = this.getRollData();\n\n    if (this.item.type === \"spell\") {\n      // Early transform key ability reference to spellbook ability\n      // TODO: Support key ability via class-association\n      const keyAbility = this.item.spellbook?.ability;\n      if (keyAbility) {\n        if (this.ability?.damage === \"_key\") {\n          this.ability.damage = keyAbility;\n        }\n        if (this.ability?.attack === \"_key\") {\n          this.ability.attack = keyAbility;\n        }\n      }\n    }\n\n    if (this.ability?.attack === \"_default\") {\n      let defaultAbility;\n      switch (this.actionType) {\n        case \"mwak\":\n        case \"msak\":\n        case \"mcman\":\n          defaultAbility = this.actor?.system.attributes?.attack?.meleeAbility || \"str\";\n          break;\n        case \"rwak\":\n        case \"twak\":\n        case \"rsak\":\n        case \"rcman\":\n          defaultAbility = this.actor?.system.attributes?.attack?.rangedAbility || \"dex\";\n          break;\n      }\n      this.ability.attack = defaultAbility;\n    }\n\n    // Prepare max personal charges\n    if (this.uses.self?.per) {\n      const maxFormula = this.uses.self.per === \"single\" ? \"1\" : this.uses.self.maxFormula;\n      const maxUses = RollPF.safeRollSync(maxFormula, rollData).total ?? 0;\n      this.uses.self.max = maxUses;\n    }\n\n    // Remove enhancement bonus override, if wrong type\n    if (this.enh?.value != null && ![\"weapon\", \"attack\"].includes(this.item.type)) {\n      this.enh.value = null;\n    }\n\n    // Initialize default damageMult if missing (for things that can't inherit it from item)\n    if (!Number.isFinite(this.ability?.damageMult)) {\n      let canHold = this.item.isPhysical || this.item.isQuasiPhysical || false;\n      if (!this.hasAttack) canHold = false;\n      if (!canHold) this.ability.damageMult = 1;\n    }\n  }\n\n  /**\n   * Normal material\n   *\n   * @remarks - Null if no material is configured in action or item.\n   *\n   * @type {string|null}\n   */\n  get normalMaterial() {\n    return this.material.normal.value || this.item.normalMaterial || null;\n  }\n\n  /**\n   * Addon materials\n   *\n   * @type {Array<string>}\n   */\n  get addonMaterial() {\n    const addons = this.material.addon || this.item.addonMaterial || [];\n    return addons.filter((o) => !!o);\n  }\n\n  /**\n   * Returns whether this action is a combat maneuver\n   *\n   * @type {boolean}\n   */\n  get isCombatManeuver() {\n    return [\"mcman\", \"rcman\"].includes(this.actionType);\n  }\n\n  /**\n   * Creates an action.\n   *\n   * @param {object[]} data - Data to initialize the action(s) with.\n   * @param {object} context - An object containing update context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the action within.\n   * @throws {Error} - If the action has no parent\n   * @returns {Promise<ItemAction[]>} - The resulting actions\n   */\n  static async create(data, context = {}) {\n    const { parent, ...updateContext } = context;\n\n    if (!(parent instanceof Item)) throw new Error(\"No parent declared\");\n\n    // Prepare new data\n    data = data.map((dataObj) => new this(dataObj).toObject());\n\n    // Update parent\n    const actions = parent.toObject().system.actions || [];\n    actions.push(...data);\n    await parent.update({ \"system.actions\": actions }, updateContext);\n\n    // Return resulting actions\n    return data.map((o) => parent.actions.get(o._id));\n  }\n\n  /**\n   * Parent item\n   *\n   * @type {ItemPF|undefined}\n   */\n  get item() {\n    return this.parent;\n  }\n\n  /**\n   * Parent actor of the parent item\n   *\n   * @type {ActorPF|undefined}\n   */\n  get actor() {\n    return this.parent?.actor;\n  }\n\n  /**\n   * Action ID\n   *\n   * @type {string}\n   */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * Can this action be used?\n   *\n   * Returns false if any known criteria for use limitation fails. Calls owning item's canUse functionality also.\n   *\n   * @see {@link ffd20.documents.item.ItemBasePF.canUse}\n   *\n   * @type {boolean}\n   */\n  get canUse() {\n    const item = this.item;\n    if (!item.canUse) return false;\n\n    if (this.isSelfCharged) {\n      if ((this.uses.self?.value ?? 0) <= 0) return false;\n    }\n\n    if (item.isPhysical) {\n      if (item.system.quantity <= 0) return false;\n    }\n\n    if (this.isCharged) {\n      const cost = this.getChargeCostSync({ maximize: true })?.total ?? 0;\n      const charges = item.charges;\n      if (cost > 0) {\n        if (cost > charges) return false;\n      }\n    }\n\n    const ammo = this.ammo.type;\n    if (ammo) {\n      // Check if actor has any relevant ammo, regardless if they're set to default\n      if (\n        this.actor?.itemTypes.loot.filter(\n          (i) => i.subType === \"ammo\" && i.system.extraType === ammo && i.system.quantity > 0\n        ).length === 0\n      )\n        return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Includes attack roll?\n   *\n   * @type {boolean}\n   */\n  get hasAttack() {\n    return [\"mwak\", \"rwak\", \"twak\", \"msak\", \"rsak\", \"mcman\", \"rcman\"].includes(this.actionType);\n  }\n\n  /**\n   * Has potentially multiple attacks\n   *\n   * @type {boolean}\n   */\n  get hasMultiAttack() {\n    if (!this.hasAttack) return false;\n    const exAtk = this.extraAttacks ?? {};\n    return exAtk.manual?.length > 0 || !!exAtk.type;\n  }\n\n  /**\n   * Consumes charges on use?\n   *\n   * @type {boolean}\n   */\n  get autoDeductCharges() {\n    return this.getChargeCostSync({ maximize: true })?.total > 0;\n  }\n\n  /**\n   * Does parent item have charges?\n   *\n   * @type {boolean}\n   */\n  get isCharged() {\n    return this.item.isCharged ?? false;\n  }\n\n  /**\n   * Action has charges of its own?\n   *\n   * @type {boolean}\n   */\n  get isSelfCharged() {\n    return !!this.uses?.self?.per;\n  }\n\n  /**\n   * @param {object} [options] - Additional options to configure behavior.\n   * @param {object} [options.rollData=null] - Pre-determined roll data to pass for determining the charge cost.\n   * @param {boolean} [options.minimize=false]\n   * @param {boolean} [options.maximize=false]\n   * @param {boolean} [options.interactive=false]\n   * @returns {Promise<Roll|null>} - Cost in charges for this action. Null if not charged.\n   */\n  async getChargeCost({ minimize = false, maximize = false, rollData = null, interactive = false } = {}) {\n    if (!this.isCharged) return null;\n\n    const isSpell = this.item.type === \"spell\";\n    const isSpellpointSpell = isSpell && this.item.useSpellPoints();\n\n    let formula = !isSpellpointSpell ? this.uses.autoDeductChargesCost : this.uses.spellPointCost;\n    if (!formula) {\n      formula = this.item.getDefaultChargeFormula();\n    } else if (typeof formula !== \"string\") {\n      console.warn(this.item.name, \"action\", this.name, \"has invalid charge formula:\", formula, this);\n      formula = this.item.getDefaultChargeFormula();\n    }\n\n    rollData ??= this.getRollData();\n\n    const roll = await RollPF.safeRoll(formula, rollData, undefined, undefined, {\n      maximize,\n      minimize,\n      allowInteractive: interactive,\n    });\n\n    // Clamp single use\n    if (this.item.isSingleUse) roll._total = Math.clamp(roll._total, -1, 1);\n\n    return roll;\n  }\n\n  /**\n   * @param {object} [options] - Additional options to configure behavior.\n   * @param {object} [options.rollData=null] - Pre-determined roll data to pass for determining the charge cost.\n   * @param {boolean} [options.minimize=false]\n   * @param {boolean} [options.maximize=false]\n   * @returns {Roll|null} - Cost in charges for this action. Null if not charged.\n   */\n  getChargeCostSync({ minimize = false, maximize = false, rollData = null } = {}) {\n    if (!this.isCharged) return null;\n\n    const isSpell = this.item.type === \"spell\";\n    const isSpellpointSpell = isSpell && this.item.useSpellPoints();\n\n    let formula = !isSpellpointSpell ? this.uses.autoDeductChargesCost : this.uses.spellPointCost;\n    if (!formula) {\n      formula = this.item.getDefaultChargeFormula();\n    } else if (typeof formula !== \"string\") {\n      console.warn(this.item.name, \"action\", this.name, \"has invalid charge formula:\", formula, this);\n      formula = this.item.getDefaultChargeFormula();\n    }\n\n    rollData ??= this.getRollData();\n\n    if (!maximize && !minimize) maximize = true; // Enforce maximization if neither is called in case this is a die\n    const roll = RollPF.safeRollSync(formula, rollData, undefined, undefined, { maximize, minimize });\n\n    // Clamp single use\n    if (this.item.isSingleUse) roll._total = Math.clamp(roll._total, -1, 1);\n\n    return roll;\n  }\n\n  /**\n   * The action's first increment range (in system configured units)\n   *\n   * @type {number}\n   */\n  get rangeIncrement() {\n    return this.getRange({ type: \"single\" });\n  }\n\n  /**\n   * The action's exclusive minimum range.\n   *\n   * @type {number}\n   */\n  get minRange() {\n    return this.getRange({ type: \"min\" });\n  }\n\n  /**\n   * The action's maximum range (range multiplied by maximum range increments).\n   *\n   * @type {number}\n   */\n  get maxRange() {\n    return this.getRange({ type: \"max\" });\n  }\n\n  /**\n   * @param {object} [options] - Additional options to configure behavior.\n   * @param {\"single\"|\"min\"|\"max\"} [options.type=\"single\"] - What type of range to query. Either \"single\" (for a single range increment), \"max\" or \"min\".\n   * @param {object} [options.rollData=null] - Specific roll data to pass.\n   * @returns {number|null} The given range, in system configured units, or `null` if no range is applicable.\n   */\n  getRange({ type = \"single\", rollData = null } = {}) {\n    const baseRange = this.range.units;\n    const range = type === \"min\" ? this.range.minValue : this.range.value;\n    let rangeType = type === \"min\" ? this.range.minUnits : baseRange;\n\n    // Special case of ignoring min range for invalid range types\n    if (type === \"min\" && ![\"reach\", \"ft\", \"mi\", \"seeText\"].includes(baseRange)) return 0;\n\n    if (!rangeType) {\n      if (type !== \"min\") return null;\n      // Special handling for reach minimum range to account for natural reach when no explicit minimum range is defined\n      if (baseRange === \"reach\") rangeType = \"natural\";\n      else return 0;\n    }\n\n    rollData ??= this.getRollData();\n    const singleIncrementRange = ffd20.utils.calculateRange(range, rangeType, rollData)[0];\n\n    if ([\"single\", \"min\"].includes(type)) return singleIncrementRange;\n    return singleIncrementRange * this.range.maxIncrements;\n  }\n\n  /**\n   * Has measured template?\n   *\n   * @type {boolean}\n   */\n  get hasTemplate() {\n    const { type, size } = this.measureTemplate;\n    return !!type && !!size;\n  }\n\n  /**\n   * Does the action implement a damage roll as part of its usage\n   *\n   * @type {boolean}\n   */\n  get hasDamage() {\n    return !!this.damage.parts?.length;\n  }\n\n  /**\n   * Effective critical range when accounting for broken status and action type.\n   *\n   * @type {number}\n   */\n  get critRange() {\n    if (this.item.isBroken || this.isCombatManeuver) return 20;\n    return this.ability?.critRange || 20;\n  }\n\n  /**\n   * Misfire threshold\n   *\n   * @remarks - Zero if action does not misfire.\n   *\n   * @type {number}\n   */\n  get misfire() {\n    const misfire = this.ammo?.misfire ?? null;\n    if (Number.isFinite(misfire)) return misfire;\n    return this.item.system.ammo?.misfire ?? 0;\n  }\n\n  /**\n   * Get power attack, deadly aim or piranha strike multiplier.\n   *\n   * @param {object} [options] - Additional options\n   * @param {object} [options.rollData=null] - Roll data instance\n   * @returns {number} - Effective multiplier\n   */\n  getPowerAttackMult({ rollData = null } = {}) {\n    rollData ??= this.getRollData();\n\n    const held = rollData.action?.held || rollData.item?.held || \"1h\";\n\n    let mult = rollData.action?.powerAttack?.multiplier;\n    // Use defined override\n    if (mult) return mult;\n\n    // Determine default based on attack type and held option\n    mult = 1;\n    if (this.item.subType === \"natural\") {\n      // Primary\n      if (rollData.action.naturalAttack?.primary) {\n        const ablDmgMult = rollData.action.ability?.damageMult ?? 1;\n        // Primary attack gets +50% damage like with two-handing if ability score multiplier is 1.5x or higher\n        if (ablDmgMult >= 1.5) mult = 1.5;\n      }\n      // Secondary\n      else {\n        mult = 0.5;\n      }\n    } else {\n      if (held === \"2h\") mult = 1.5;\n      else if (held === \"oh\") mult = 0.5;\n    }\n\n    return mult;\n  }\n\n  /**\n   * Does the item have range defined.\n   *\n   * @type {boolean}\n   */\n  get hasRange() {\n    const units = this.range?.units;\n    if (!units) return false;\n    return !!units;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Does the item provide an amount of healing instead of conventional damage?\n   *\n   * @returns {boolean}\n   */\n  get isHealing() {\n    return this.actionType === \"heal\" && this.hasDamage;\n  }\n\n  get hasEffect() {\n    return this.hasDamage || this.notes.effect.length > 0;\n  }\n\n  /**\n   * Does the Item implement a saving throw as part of its usage\n   *\n   * @type {boolean}\n   */\n  get hasSave() {\n    return !!this.save?.type;\n  }\n\n  /**\n   * @param {object} [rollData] - Data to pass to the roll. If none is given, get new roll data.\n   * @returns {number} The Difficulty Class for this action.\n   */\n  getDC(rollData = null) {\n    rollData ??= this.getRollData();\n    let result = 10;\n\n    // Get conditional save DC bonus\n    const dcBonus = rollData.dcBonus ?? 0;\n\n    if (this.item.type === \"spell\") {\n      const spellbook = this.item.spellbook;\n      if (spellbook) {\n        let formula = spellbook.baseDCFormula;\n\n        const data = rollData.action;\n        if (data.save.dc) formula += ` + ${data.save.dc}`;\n\n        const dcSchoolBonus = rollData.attributes.spells?.school?.[this.item.system.school]?.dc ?? 0;\n        const universalDCBonus = rollData.attributes?.spells?.school?.all?.dc ?? 0;\n\n        return RollPF.safeRollSync(formula, rollData).total + dcBonus + dcSchoolBonus + universalDCBonus;\n      } else {\n        // Assume standard base formula for spells with minimum required abilty score\n        const level = this.item.system.level ?? 1;\n        const minAbl = Math.floor(level / 2);\n        return 10 + level + minAbl + dcBonus;\n      }\n    } else {\n      const dcFormula = this.save.dc?.toString() || \"0\";\n      result = RollPF.safeRollSync(dcFormula, rollData).total + dcBonus;\n      return result;\n    }\n  }\n\n  /**\n   * Effective enhancement bonus\n   *\n   * Action's enhancement override or what is inherited from item.\n   *\n   * @remarks\n   * - Null if not enhanced.\n   *\n   * @type {number|null}\n   */\n  get enhancementBonus() {\n    return this.enh?.value ?? this.item.system.enh ?? null;\n  }\n\n  /**\n   * Is ranged rather than melee.\n   *\n   * @type {boolean}\n   */\n  get isRanged() {\n    return [\"rwak\", \"twak\", \"rsak\", \"rcman\"].includes(this.actionType);\n  }\n\n  /**\n   * Is spell-like action\n   *\n   * @remarks\n   * - Action type is set to melee/ranged spell attack or spell save.\n   *\n   * @type {boolean}\n   */\n  get isSpell() {\n    return [\"rsak\", \"msak\", \"spellsave\"].includes(this.actionType);\n  }\n\n  /**\n   * An array of changes affecting this action's damage\n   *\n   * @type {ItemChange[]}\n   */\n  get damageSources() {\n    // Build damage context\n    const contexts = [ffd20.const.actionTypeToContext[this.actionType] ?? \"damage\"];\n    if (this.isRanged) contexts.push(\"rdamage\");\n    else contexts.push(\"mdamage\");\n    if (this.item.subType === \"natural\") contexts.push(\"ndamage\");\n\n    const changes = this.item.getContextChanges(contexts);\n    if (changes.length == 0) return [];\n    return getHighestChanges(changes, { ignoreTarget: true });\n  }\n\n  /**\n   * All relevant Changes the action's damage.\n   *\n   * @type {ItemChange[]}\n   */\n  get allDamageSources() {\n    const conds = this.conditionals\n      .filter((c) => c.default)\n      .filter((c) => c.modifiers.find((m) => m.target === \"damage\"));\n    const rollData = this.getRollData();\n\n    if (!rollData) return [];\n\n    const mods = Object.keys(ffd20.config.bonusTypes);\n\n    // Turn relevant conditionals into structure accepted by getHighestChanges\n    const fakeCondChanges = [];\n    for (const c of conds) {\n      for (const m of c.modifiers) {\n        if (m.target !== \"damage\") continue;\n        let roll;\n        let isDeterministic;\n        try {\n          roll = new RollPF(m.formula, rollData);\n          isDeterministic = roll.isDeterministic;\n          if (isDeterministic) roll.evaluateSync();\n        } catch (err) {\n          // This is very noisy but needed to help track down the problem\n          console.error(\n            \"Invalid conditional formula:\",\n            { formula: m.formula, conditional: c, action: this, item: this.item },\n            \"\\n\",\n            err\n          );\n        }\n        const isModifier = mods.includes(m.type);\n        fakeCondChanges.push({\n          flavor: c.name,\n          value: isDeterministic ? roll.total : m.formula,\n          modifier: isModifier ? m.type : \"untyped\", // Turn unrecognized types to untyped\n          type: isModifier ? undefined : m.type, // Preserve damage type if present\n          formula: m.formula,\n        });\n      }\n    }\n\n    const allChanges = [...this.damageSources, ...fakeCondChanges];\n\n    // Add enhancement bonus\n    const enh = this.enhancementBonus;\n    if (enh) {\n      allChanges.push({\n        flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        value: enh,\n        type: \"enh\",\n        formula: enh.toString(),\n      });\n    }\n\n    // Add special cases specific to the item\n    // Broken\n    if (this.item.isBroken) {\n      allChanges.push({\n        flavor: game.i18n.localize(\"FFD20.Broken\"),\n        value: -2,\n        type: \"untyped\",\n        formula: \"-2\",\n      });\n    }\n\n    return getHighestChanges(allChanges, { ignoreTarget: true });\n  }\n\n  /**\n   * @param {object} [options]\n   * @internal\n   * @returns {object}\n   */\n  getRollData(options) {\n    const item = this.item;\n    const result = item?.getRollData({ ...options, cache: false }) ?? {};\n\n    result.action = ffd20.utils.deepClone(this);\n    result.dc = this.hasSave ? this.getDC(result) : 0;\n\n    if (item?.type === \"spell\") {\n      // Add per school CL bonus\n      // TODO: Move to item roll data generation?\n      result.cl += result.attributes?.spells?.school?.[item.system.school]?.cl ?? 0;\n    }\n\n    // Determine size bonus\n    if (this.hasAttack) {\n      const size = result.size || 4;\n      result.sizeBonus = Object.values(this.isCombatManeuver ? ffd20.config.sizeSpecialMods : ffd20.config.sizeMods)[size];\n    }\n\n    // BAB override\n    if (result.action.bab) {\n      const bab = RollPF.safeRollSync(result.action.bab, result).total;\n      foundry.utils.setProperty(result, \"attributes.bab.total\", bab || 0);\n    }\n\n    // Add @bab alias\n    result.bab = result.attributes?.bab?.total || 0;\n\n    if (Hooks.events[\"pf1GetRollData\"]?.length > 0) Hooks.callAll(\"pf1GetRollData\", this, result);\n\n    return result;\n  }\n\n  /**\n   * Replace conditionals array with collection\n   *\n   * @internal\n   */\n  _prepareConditionals() {\n    const collection = this._conditionals;\n    /** @type {Collection<ffd20.components.ItemConditional>} */\n    const prior = new Collection(collection.entries());\n    collection.clear(); // TODO: Remove specific entries after the loop instead of full clear here\n\n    for (const condData of this._source.conditionals) {\n      /** @type {ffd20.components.ItemConditional} */\n      let conditional;\n      if (prior && prior.has(condData._id)) {\n        conditional = prior.get(condData._id);\n        conditional.replaceSource(condData);\n      } else {\n        conditional = new ffd20.components.ItemConditional(condData, { parent: this });\n      }\n\n      collection.set(conditional.id, conditional);\n    }\n\n    /** @type {Collection<ffd20.components.ItemConditional>} */\n    this.conditionals = collection;\n  }\n\n  /**\n   * Delete this action\n   *\n   * @returns {Promise<Item>} - Updated parent item document.\n   */\n  async delete() {\n    const actions = this.item.toObject().system.actions;\n    actions.findSplice((a) => a._id == this.id);\n\n    // Preemptively close applications\n    const promises = [];\n    for (const app of Object.values(this.apps)) {\n      promises.push(app.close({ ffd20: { action: \"delete\" }, submit: false, force: true }));\n    }\n    await Promise.all(promises);\n\n    // Delete action\n    return this.item.update({ \"system.actions\": actions });\n  }\n\n  /**\n   * Update the action\n   *\n   * TODO: BROKEN\n   *\n   * @param {object} updateData - Update data\n   * @param {object} context - Update context\n   */\n  async update(updateData, context = {}) {\n    updateData = foundry.utils.expandObject(updateData);\n\n    delete updateData._id; // Prevent ID drift\n    this.updateSource(updateData);\n\n    const updates = this.item.actions.map((a) => a.toObject());\n\n    await this.item.update({ \"system.actions\": updates }, context);\n  }\n\n  /* -------------------------------------------- */\n  /*  Chat Data Generation\t\t\t\t\t\t\t\t\t\t\t\t*/\n  /* -------------------------------------------- */\n\n  /**\n   * Generates {@link ChatData} for this action's parent item, but with this action's data,\n   * regardless of whether it is the first action or not.\n   *\n   * @see {@link ItemPF#getChatData}\n   * @param {object} [chatDataOptions] - Options passed to {@link ItemPF#getChatData} affecting the chat data\n   * @returns {Promise<import(\"../documents/item/item-pf.mjs\").ChatData>} Chat data for this action's parent and this action\n   */\n  async getChatData(chatDataOptions = {}) {\n    return this.item.getChatData({ ...chatDataOptions, actionId: this.id });\n  }\n\n  /**\n   * Returns labels related to this particular action\n   *\n   * @param {object} [options]\n   * @param {object} [options.rollData] - Pre-determined roll data. If not provided, finds the action's own roll data.\n   * @param {boolean} [options.isolated] - Are these labels generated for isolated information (that is, need more details)\n   * @returns {Record<string, string>} This action's labels\n   */\n  getLabels({ rollData, isolated = false } = {}) {\n    const labels = {};\n    rollData ??= this.getRollData();\n\n    const hasActor = !!this.actor;\n\n    // Activation method\n    if (this.activation) {\n      const activation = this.activation;\n      if (activation) {\n        const isUnchainedActionEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n        const activationTypes = isUnchainedActionEconomy\n          ? ffd20.config.abilityActivationTypes_unchained\n          : ffd20.config.abilityActivationTypes;\n        const activationTypesPlural = isUnchainedActionEconomy\n          ? ffd20.config.abilityActivationTypesPlurals_unchained\n          : ffd20.config.abilityActivationTypesPlurals;\n\n        const activationType = activation.type || \"nonaction\";\n        if (activation.type === \"special\") {\n          labels.activation = activationTypes.special;\n        } else if (activation.cost > 1 && !!activationTypesPlural[activationType]) {\n          labels.activation = [activation.cost.toString(), activationTypesPlural[activationType]].filterJoin(\" \");\n        } else {\n          labels.activation = [\n            [\"minute\", \"hour\", \"action\"].includes(activationType) && activation.cost ? activation.cost.toString() : \"\",\n            activationTypes[activationType],\n          ].filterJoin(\" \");\n        }\n      }\n    }\n\n    // Duration\n    // Set duration label\n    const duration = this.duration;\n    switch (duration?.units) {\n      case \"spec\":\n        labels.duration = duration.value;\n        break;\n      case \"seeText\":\n      case \"inst\":\n      case \"perm\":\n        labels.duration = ffd20.config.timePeriods[duration.units];\n        break;\n      case \"turn\": {\n        const unit = ffd20.config.timePeriods[duration.units];\n        labels.duration = game.i18n.format(\"FFD20.Time.Format\", { value: 1, unit });\n        break;\n      }\n      case \"round\":\n      case \"minute\":\n      case \"hour\":\n      case \"day\":\n      case \"month\":\n      case \"year\":\n        if (duration.value) {\n          const unit = ffd20.config.timePeriods[duration.units];\n          labels.durationFormula = duration.value;\n          labels.variableDuration = /@\\w/.test(duration.value);\n          let roll, value;\n          try {\n            roll = new RollPF(duration.value, rollData);\n            // Outside of actor\n            if (isolated) {\n              const _rollData = foundry.utils.deepClone(rollData);\n              const minroll = new RollPF(duration.value, _rollData);\n              minroll.evaluateSync({ minimize: true });\n              // Spoof level 20\n              _rollData.cl = 20;\n              foundry.utils.setProperty(_rollData, \"attributes.hd.total\", 20);\n              foundry.utils.setProperty(_rollData, \"attributes.bab.total\", 20);\n              _rollData.bab = 20;\n              foundry.utils.setProperty(_rollData, \"class.level\", 20);\n              const maxroll = new RollPF(duration.value, _rollData);\n              maxroll.evaluateSync({ maximize: true });\n              if (minroll.total !== maxroll.total) value = `${minroll.total} - ${maxroll.total}`;\n              else value = `${minroll.total}`;\n            }\n            // On actor\n            else {\n              if (roll.isDeterministic) {\n                roll.evaluateSync();\n                value = roll.total;\n              } else {\n                let formula = ffd20.utils.formula.unflair(duration.value || \"0\");\n                formula = RollPF.replaceFormulaData(formula || \"0\", rollData);\n                value = ffd20.utils.formula.compress(ffd20.utils.formula.simplify(formula));\n              }\n            }\n\n            labels.duration = game.i18n.format(\"FFD20.Time.Format\", { value, unit });\n          } catch (err) {\n            console.error(\n              \"Error in duration formula:\",\n              { formula: duration.value, rollData, roll },\n              roll?.err ?? err,\n              this\n            );\n          }\n        }\n        break;\n    }\n\n    // Dismissable, but only if special duration isn't used\n    // TODO: Better i18n support\n    if (labels.duration && duration.units !== \"spec\") {\n      if (duration.dismiss) labels.duration += \" \" + game.i18n.localize(\"FFD20.DismissableMark\");\n      if (duration.concentration)\n        labels.duration = game.i18n.format(\"FFD20.ConcentationDuration\", { duration: labels.duration });\n    }\n\n    // Difficulty Class\n    if (this.hasSave) {\n      const totalDC = rollData.dc + (rollData.dcBonus ?? 0);\n      labels.save = game.i18n.format(\"FFD20.DCThreshold\", { threshold: totalDC });\n    }\n\n    // Range\n    if (this.hasRange) {\n      const rangeUnit = this.range.units;\n      const rangeValue = this.range.value;\n      const rangeLabel = ffd20.config.distanceUnits[rangeUnit];\n      labels.range = rangeLabel;\n      if (rangeUnit === \"spec\") {\n        labels.range = rangeValue || labels.range;\n      } else if ([\"personal\", \"touch\", \"melee\", \"reach\"].includes(rangeUnit)) {\n        // Display as is\n      } else {\n        const range = this.getRange({ type: \"single\", rollData });\n        if (range > 0) {\n          const usystem = ffd20.utils.getDistanceSystem();\n          const rangeUnit = usystem === \"metric\" ? \"m\" : \"ft\";\n          const lrange = new Intl.NumberFormat(undefined).format(range);\n          labels.range = `${lrange} ${rangeUnit}`;\n        }\n        if ([\"close\", \"medium\", \"long\"].includes(rangeUnit)) {\n          labels.range += ` (${rangeLabel})`;\n        }\n      }\n\n      // Special formatting when no actor present\n      if (!hasActor) {\n        const units = ffd20.utils.getDistanceSystem();\n        switch (rangeUnit) {\n          case \"close\":\n            labels.range = `${rangeLabel} (${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeShortMetric\" : \"FFD20.SpellRangeShort\"\n            )})`;\n            break;\n          case \"medium\":\n            labels.range = `${rangeLabel} (${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeMediumMetric\" : \"FFD20.SpellRangeMedium\"\n            )})`;\n            break;\n          case \"long\":\n            labels.range = `${rangeLabel} (${game.i18n.localize(\n              units == \"metric\" ? \"FFD20.SpellRangeLongMetric\" : \"FFD20.SpellRangeLong\"\n            )})`;\n            break;\n        }\n      }\n    }\n\n    // Targets\n    const targets = this.target?.value;\n    if (targets) labels.targets = targets;\n\n    // Set area label\n    if (this?.area) labels.area = this.area;\n\n    // Action type\n    labels.actionType = ffd20.config.itemActionTypes[this.actionType];\n\n    return labels;\n  }\n\n  // -----------------------------------------------------------------------\n\n  /**\n   * Get all appropriate context changes for attack rolls.\n   *\n   * @see {@link ItemPF.getContextChanges}\n   */\n  get attackSources() {\n    const contexts = [\"~attackCore\"];\n    if (this.isCombatManeuver) contexts.push(\"cmb\");\n    if (this.isRanged) contexts.push(\"rattack\");\n    else contexts.push(\"mattack\");\n\n    const isNatural = this.item.subType === \"natural\";\n    if (isNatural) contexts.push(\"nattack\");\n\n    switch (this.actionType) {\n      case \"twak\":\n        contexts.push(\"tattack\");\n        if (!isNatural) contexts.push(\"wattack\");\n        break;\n      case \"mwak\":\n      case \"rwak\":\n        if (!isNatural) contexts.push(\"wattack\");\n        break;\n      case \"msak\":\n      case \"rsak\":\n        contexts.push(\"sattack\");\n        break;\n    }\n\n    return this.item.getContextChanges(contexts);\n  }\n\n  /**\n   * Place an attack roll using an item (weapon, feat, spell, or equipment)\n   *\n   * @param {object} [options] - Options\n   * @param {object} [options.data] - Roll data\n   * @param {Array<string>} [options.extraParts] - Additional attack parts\n   * @param {string} [options.bonus] - Additional attack bonus\n   * @param {boolean} [options.primary=true] - Treat as primary natural attack\n   * @param {ffd20.components.ItemChange[]} [options.extraChanges] - Additional changes\n   * @returns {Promise<D20RollPF>}\n   */\n  async rollAttack({ data = null, extraParts = [], extraChanges = [], bonus = null, primary = true, ...options } = {}) {\n    if (typeof options.primaryAttack === \"boolean\") {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemAttack.rollAttack()'s `primaryAttack` option is deprecated in favor of `primary`\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      primary = options.primaryAttack;\n    }\n    const rollData = data ?? this.getRollData();\n    const itemData = rollData.item;\n    const actionData = rollData.action;\n\n    const config = {};\n\n    itemData.primaryAttack = primary;\n\n    // Add misc bonuses/penalties\n    itemData.proficiencyPenalty = -4;\n\n    // Determine ability score modifier\n    const abl = actionData.ability.attack;\n\n    // Define Roll parts\n    const parts = [];\n\n    // Add size bonus\n    if (rollData.sizeBonus !== 0) parts.push(`@sizeBonus[${game.i18n.localize(\"FFD20.Size\")}]`);\n\n    const ability = rollData.abilities?.[abl];\n    // Add ability modifier\n    if (ability && ability?.mod !== 0) {\n      parts.push(`@abilities.${abl}.mod[${ffd20.config.abilities[abl]}]`);\n    }\n\n    // Get relevant changes\n    const changes = this.attackSources;\n    changes.push(...extraChanges);\n\n    // Add masterwork bonus to changes (if applicable)\n    if ([\"mwak\", \"rwak\", \"twak\", \"mcman\", \"rcman\"].includes(this.actionType) && this.item.system.masterwork) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: \"1\",\n          operator: \"add\",\n          target: \"attack\",\n          type: \"enh\",\n          value: 1,\n          flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        })\n      );\n    }\n\n    // Add enhancement bonus to changes\n    if (this.enhancementBonus) {\n      changes.push(\n        new ffd20.components.ItemChange({\n          formula: this.enhancementBonus.toString(),\n          operator: \"add\",\n          target: \"attack\",\n          type: \"enh\",\n          value: this.enhancementBonus,\n          flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n        })\n      );\n    }\n\n    // Add bonus parts\n    parts.push(...extraParts);\n    // Add attack bonus\n    if (typeof actionData.attackBonus === \"string\" && ![\"\", \"0\"].includes(actionData.attackBonus)) {\n      parts.push(actionData.attackBonus);\n    }\n    // Backwards compatibility\n    else if (typeof actionData.attackBonus === \"number\") {\n      itemData.attackBonus = actionData.attackBonus;\n      parts.push(`@item.attackBonus[${game.i18n.localize(\"FFD20.AttackRollBonus\")}]`);\n    }\n\n    // Add proficiency penalty\n    try {\n      config.proficient = this.item.getProficiency(true);\n    } catch (error) {\n      // Treat as proficient if there's proficiency incompatibility.\n      config.proficient = true;\n    }\n\n    // Add secondary natural attack penalty\n    const isNatural = this.item.subType === \"natural\";\n    const isNaturalSecondary = isNatural && primary === false;\n    config.secondaryPenalty = isNaturalSecondary ? ffd20.config.naturalAttacks.secondary.penalty : \"0\";\n\n    // Add bonus\n    rollData.bonus = 0;\n    if (bonus) {\n      // TODO: Do not pre-roll\n      const roll = await RollPF.safeRoll(bonus, rollData);\n      rollData.bonus = roll.total;\n    }\n\n    // Options for D20RollPF\n    const rollOptions = {\n      critical: this.critRange,\n    };\n\n    if (this.ammo.type && this.ammo.cost > 0) {\n      const misfire = this.misfire;\n      if (misfire > 0) rollOptions.misfire = misfire;\n    }\n\n    // call pre attack hook before changes are filtered and before specific [parts] from config and roll data are created\n    Hooks.call(\"pf1PreAttackRoll\", this, config, rollData, rollOptions, parts, changes);\n\n    // Get attack bonus\n    getHighestChanges(\n      changes.filter((c) => {\n        c.applyChange(this.actor);\n        return c.operator !== \"set\";\n      }),\n      { ignoreTarget: true }\n    ).forEach((c) => {\n      let value = c.value;\n      // BAB override\n      if (actionData.bab && c._id === \"_bab\") {\n        value = RollPF.safeRollSync(c.formula, data).total || 0;\n      }\n      if (value == 0) return;\n      parts.push(`${value}[${RollPF.cleanFlavor(c.flavor)}]`);\n    });\n\n    // Convert config to roll part\n    if (config.secondaryPenalty != 0) {\n      const terms = RollPF.parse(config.secondaryPenalty);\n      if (terms.length > 1) config.secondaryPenalty = `(${config.secondaryPenalty})`;\n      parts.push(`${config.secondaryPenalty}[${game.i18n.localize(\"FFD20.SecondaryAttack\")}]`);\n    }\n\n    if (rollData.bonus != 0) {\n      parts.push(`@bonus[${game.i18n.localize(\"FFD20.SituationalBonus\")}]`);\n    }\n\n    if (!config.proficient) {\n      parts.push(`@item.proficiencyPenalty[${game.i18n.localize(\"FFD20.Proficiency.Penalty\")}]`);\n    }\n\n    const roll = new ffd20.dice.D20RollPF(\n      [rollData.d20 || ffd20.dice.D20RollPF.standardRoll, ...parts.filter((p) => !!p)].join(\"+\"),\n      rollData,\n      rollOptions\n    );\n\n    try {\n      await roll.evaluate();\n    } catch (err) {\n      throw new Error(`Attack roll evaluation failed:\\n${roll.formula}\\n`, { cause: err });\n    }\n\n    // Cleanup roll data that was altered here.\n    delete rollData.bonus;\n\n    Hooks.call(\"pf1AttackRoll\", this, roll, config);\n\n    return roll;\n  }\n\n  /* -------------------------------------------- */\n\n  /**\n   * Roll damage for an action.\n   *\n   * @param {object} [options] - Options configuring the damage roll\n   * @param {object | null} [options.data=null] - rollData to be used\n   * @param {boolean} [options.critical=false] - Whether to roll critical damage\n   * @param {string[]} [options.extraParts] - Additional strings added to the roll formula\n   * @param {object} [options.conditionalParts=[]] - Conditional data sets\n   * @param {boolean} [options.primaryAttack] - Whether this is the primary attack\n   * @returns {Promise<DamageRoll[]>} Created damage rolls, one roll per damage part\n   */\n  async rollDamage({\n    data = null,\n    critical = false,\n    extraParts = [],\n    conditionalParts = {},\n    primaryAttack = true,\n  } = {}) {\n    const rollData = data ?? this.getRollData();\n    const itemData = rollData.item;\n    const actionData = rollData.action;\n\n    if (!this.hasDamage) {\n      throw new Error(\"You may not make a Damage Roll with this Action.\");\n    }\n\n    const isNatural = this.item.subType === \"natural\";\n\n    // Determine critical multiplier\n    rollData.critMult = 1;\n    if (critical) rollData.critMult = actionData.ability.critMult;\n    // Determine ability multiplier\n    if (rollData.ablMult == null) {\n      const held = actionData?.held || itemData?.held || \"1h\";\n      rollData.ablMult =\n        actionData?.ability.damageMult ?? (isNatural ? null : ffd20.config.abilityDamageHeldMultipliers[held]) ?? 1;\n    }\n\n    // Define Roll parts\n    const parts = [];\n    const addParts = (property, type) => {\n      parts.push(\n        ...(this.damage[property]?.map((damage) => ({\n          base: damage.formula,\n          extra: [],\n          damageType: damage.types,\n          type,\n        })) ?? [])\n      );\n\n      // add typed conditionals\n      conditionalParts[`damage.${type}`]?.forEach((p) => {\n        const [base, damageType, isExtra] = p;\n        isExtra ? parts[0].extra.push(base) : parts.push({ base, extra: [], damageType, type });\n      });\n    };\n\n    addParts(\"parts\", \"normal\");\n    if (critical) addParts(\"critParts\", \"crit\");\n    else addParts(\"nonCritParts\", \"nonCrit\");\n\n    /**\n     * Initialize changes to empty array so mods can still add changes for healing \"attacks\" via the pre-roll hook below\n     *\n     * @type {ItemChange[]}\n     */\n    let changes = [];\n    if (!this.isHealing) {\n      // Gather changes\n      changes = this.damageSources;\n\n      // Add enhancement bonus to changes\n      if (this.enhancementBonus) {\n        changes.push(\n          new ffd20.components.ItemChange({\n            formula: this.enhancementBonus.toString(),\n            operator: \"add\",\n            target: \"damage\",\n            type: \"enh\",\n            value: this.enhancementBonus,\n            flavor: game.i18n.localize(\"FFD20.EnhancementBonus\"),\n          })\n        );\n      }\n\n      // Add broken penalty\n      if (this.item.isBroken) {\n        const label = game.i18n.localize(\"FFD20.Broken\");\n        parts[0].extra.push(`-2[${label}]`);\n      }\n    }\n\n    // call pre damage hook before changes are filtered and before specific [parts] from roll data are created\n    Hooks.call(\"pf1PreDamageRoll\", this, rollData, parts, changes);\n\n    // Get damage bonus\n    getHighestChanges(\n      changes.filter((c) => {\n        c.applyChange(this.actor);\n        return c.operator !== \"set\";\n      }),\n      { ignoreTarget: true }\n    ).forEach((c) => {\n      let value = c.value;\n      // Put in parenthesis if there's a chance it is more complex\n      if (/[\\s+-?:]/.test(value)) value = `(${value})`;\n      parts[0].extra.push(`${value}[${c.flavor}]`);\n    });\n\n    // Determine ability score modifier\n    const abl = actionData.ability.damage;\n    const ability = rollData.abilities?.[abl];\n    if (ability) {\n      // Determine ability score bonus\n      const max = actionData.ability?.max ?? Infinity;\n      if (ability.mod < 0) rollData.ablDamage = Math.min(max, ability.mod);\n      else rollData.ablDamage = Math.floor(Math.min(max, ability.mod) * rollData.ablMult);\n\n      // Determine ability score label\n      const ablLabel = ffd20.config.abilities[abl];\n\n      // Add ability score\n      parts[0].extra.push(`@ablDamage[${ablLabel}]`);\n    }\n\n    // Ensure previous data does not infect things here\n    delete rollData.previous;\n    delete rollData.base;\n\n    // Create roll\n    const rolls = [];\n    for (let a = 0; a < parts.length; a++) {\n      const part = parts[a];\n      let rollParts = [];\n      if (a === 0) rollParts = [...part.extra, ...extraParts];\n      const formula = [part.base, ...rollParts].join(\" + \");\n      // Skip empty formulas instead of erroring on them\n      if (formula.length == 0) continue;\n      let roll;\n      try {\n        roll = await new DamageRoll(formula, rollData, {\n          damageType: part.damageType,\n          type: part.type,\n        }).evaluate();\n        // Add to result\n        rolls.push(roll);\n      } catch (err) {\n        console.error(\"Error with damage formula:\", formula, this);\n        throw err;\n      }\n\n      const firstDie = roll.dice[0];\n\n      // Add first normal damage instance as @base damage data in roll data\n      if (a === 0 && !critical) {\n        rollData.base = {\n          total: roll.total,\n          dice: firstDie?.expression,\n          die: { size: firstDie?.faces, count: firstDie?.number },\n        };\n      }\n\n      // Store some details as @previous\n      rollData.previous = {\n        total: roll.total,\n        dice: firstDie?.expression,\n        die: { size: firstDie?.faces, count: firstDie?.number },\n      };\n    }\n\n    return rolls;\n  }\n\n  /**\n   * Generates a list of targets this modifier can have.\n   *\n   * @returns {Record<string, string>} Target ID to label mapping.\n   */\n  getConditionalTargets() {\n    const hasAttack = this.hasAttack,\n      hasDamage = this.hasDamage,\n      hasSave = this.hasSave;\n\n    const results = [\n      { id: \"attack\", sort: 1_000, label: ffd20.config.conditionalTargets.attack._label, disabled: !hasAttack },\n      {\n        id: \"critMult\",\n        sort: 2_000,\n        label: ffd20.config.conditionalTargets.critMult._label,\n        disabled: !hasAttack,\n        simple: true,\n      },\n      { id: \"damage\", sort: 3_000, label: ffd20.config.conditionalTargets.damage._label, disabled: !hasDamage },\n      { id: \"size\", sort: 4_000, label: ffd20.config.conditionalTargets.size._label, disabled: !hasDamage, simple: true },\n      { id: \"dc\", sort: 5_000, label: game.i18n.localize(\"FFD20.DC\"), disabled: !hasSave, simple: true },\n      {\n        id: \"effect\",\n        sort: 6_000,\n        label: ffd20.config.conditionalTargets.effect._label,\n        choices: {},\n        get disabled() {\n          return foundry.utils.isEmpty(this.choices);\n        },\n      },\n      {\n        id: \"misc\",\n        sort: 7_000,\n        label: ffd20.config.conditionalTargets.misc._label,\n        choices: {},\n        get disabled() {\n          return foundry.utils.isEmpty(this.choices);\n        },\n      },\n      {\n        id: \"charges\",\n        sort: 8_000,\n        label: game.i18n.localize(\"FFD20.ChargeCost\"),\n        disabled: !this.isCharged,\n        simple: true,\n      },\n    ];\n\n    // Add additional item-specific targets\n    this.item.getConditionalTargets(results);\n\n    // Fill in sub-targets\n    for (const entry of results) {\n      this.getConditionalSubTargets(entry);\n    }\n\n    // Convert results into its final form\n    const result = {};\n    for (const entry of results.sort((a, b) => a.sort - b.sort)) {\n      if (entry.disabled) continue;\n      if (!entry.simple && foundry.utils.isEmpty(entry.choices)) continue;\n      result[entry.id] = entry;\n    }\n\n    return result;\n  }\n\n  /**\n   * Generates lists of conditional sub-targets this action can have.\n   *\n   * @param {object} entry - The target entry\n   * @param {*} _results - Unused. Deprecated option\n   * @returns {object} - Same as the target entry parameter with added info.\n   */\n  getConditionalSubTargets(entry, _results) {\n    // @deprecated - Remove after PF1 v12\n    if (typeof entry === \"string\" || _results)\n      throw new Error(\"ItemAction#getConditionalSubTargets() called with invalid arguments\");\n\n    entry.choices ??= {};\n\n    const targetId = entry.id;\n\n    // Add static targets\n    const subTargets = ffd20.config.conditionalTargets[targetId];\n    if (subTargets) {\n      for (const [key, label] of Object.entries(subTargets)) {\n        if (!key.startsWith(\"_\") && !key.startsWith(\"~\")) entry.choices[key] = label;\n      }\n    }\n\n    // Add subtargets depending on attacks\n    if ([\"attack\", \"damage\"].includes(targetId)) {\n      // Add specific attacks\n      if (this.hasAttack) {\n        entry.choices[\"attack_0\"] = `${game.i18n.localize(\"FFD20.Attack\")} 1`;\n\n        const exAtk = this.extraAttacks;\n        if (exAtk?.manual?.length) {\n          exAtk.manual.forEach((part, index) => {\n            entry.choices[`attack_${index + 1}`] = part.name;\n          });\n        }\n      } else {\n        delete entry.choices[\"rapidShotDamage\"];\n      }\n    }\n\n    this.item.getConditionalSubTargets?.(entry);\n\n    return entry;\n  }\n\n  /* Generates lists of conditional modifier bonus types applicable to a formula.\n   * @param {string} target - The target key as defined in FFD20.conditionTargets.\n   * @returns {Object.<string, string>} A list of bonus types.\n   * */\n  getConditionalModifierTypes(target) {\n    const result = {};\n    if (target === \"attack\" || target === \"damage\") {\n      // Add types from ffd20.config.bonusTypes\n      for (const [k, v] of Object.entries(ffd20.config.bonusTypes)) {\n        result[k] = v;\n      }\n    }\n    if (target === \"damage\") {\n      for (const damageType of ffd20.registry.damageTypes) {\n        result[damageType.id] = damageType.name;\n      }\n    }\n    return result;\n  }\n\n  /* Generates a list of critical applications for a given formula target.\n   * @param {string} target - The target key as defined in FFD20.conditionalTargets.\n   * @returns {Object.<string, string>} A list of critical applications.\n   * */\n  getConditionalCritical(target) {\n    let result = {};\n    // Attack bonuses can only apply as critical confirm bonus\n    if (target === \"attack\") {\n      result = { ...result, normal: \"FFD20.Normal\", crit: \"FFD20.CriticalConfirmBonus\" };\n    }\n    // Damage bonuses can be multiplied or not\n    if (target === \"damage\") {\n      result = { ...result, normal: \"FFD20.Normal\" };\n      if (this.hasAttack) {\n        result = { ...result, crit: \"FFD20.OnCritBonusFormula\", nonCrit: \"FFD20.NonMultBonusFormula\" };\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Generate attacks.\n   *\n   * @param {object} [options] - Options\n   * @param {boolean} [options.full=true] - Full attack\n   * @param {object} [options.rollData] - Roll data\n   * @param {boolean} [options.resolve=false] - If the bonuses are to be resolved directly.\n   * @param {boolean} [options.conditionals=false] - Include conditional modifications. Requires `resolve` to be enabled.\n   * @param {boolean} [options.bonuses=false] - Include other bonuses. Requires `resolve` to be enabled.\n   * @returns {Array<object>} - Array of attack data\n   */\n  getAttacks({ full = true, rollData, resolve = false, conditionals = false, bonuses = false } = {}) {\n    rollData ||= this.getRollData();\n\n    const exAtkCfg = ffd20.config.extraAttacks[this.extraAttacks?.type] ?? {};\n\n    const bonusToAll = exAtkCfg.modToAll;\n\n    /**\n     * Counter for unnamed or other numbered attacks, to be incremented with each usage.\n     * Starts at 1 to account for the base attack.\n     */\n    let unnamedAttack = 0;\n    const unnamedAttackNames = new Set();\n    const getUniqueName = (name, template) => {\n      if (template && template.indexOf(\"{0}\") == -1) template = null;\n      let label = name;\n      while (unnamedAttackNames.has(label) || !label) {\n        unnamedAttack += 1;\n        if (template) {\n          if (game.i18n.has(template)) label = game.i18n.format(template, { 0: unnamedAttack });\n          else label = template.replace(\"{0}\", unnamedAttack);\n        } else label = game.i18n.format(\"FFD20.ExtraAttacks.Formula.LabelDefault\", { 0: unnamedAttack });\n      }\n      unnamedAttackNames.add(label);\n      return label;\n    };\n\n    rollData.attackCount = 0;\n\n    // Replace roll data that won't be available after\n    const replaceSpecificRollData = (formula, data) => {\n      return formula.replace(/@\\w+\\b/, (m) => {\n        const p = m.slice(1);\n        if (p in data) return data[p];\n        return m;\n      });\n    };\n\n    const _rollData = {\n      attackCount: 0,\n      attackSetCount: 0,\n      formulaicAttack: 0,\n    };\n\n    const flavor = game.i18n.localize(exAtkCfg.flavor || \"\");\n    let formula = `(${exAtkCfg.bonus || \"0\"} + ${bonusToAll || \"0\"})` + (flavor ? `[${flavor}]` : \"\");\n    formula = replaceSpecificRollData(formula, _rollData);\n    formula = ffd20.utils.formula.simplify(formula); // Reduce (0 + 0) to 0 or other similar cases\n    const attacks = [{ bonus: formula, label: getUniqueName(this.attackName) }];\n\n    // Extra attacks\n    if (full) {\n      rollData.fullAttack = 1;\n      const unchainedEconomy = game.settings.get(\"ffd20\", \"unchainedActionEconomy\");\n\n      let attackCount = 0;\n\n      const parseAttacks = async (countFormula, bonusFormula, label, bonusLabel) => {\n        // Soft assign zero formula to deal with empty string causing parameter init to fail\n        countFormula ||= \"0\";\n        bonusFormula ||= \"0\";\n        if (!countFormula || countFormula == \"0\") return;\n\n        const exAtkCount =\n          RollPF.safeRollSync(countFormula, rollData, undefined, undefined, { minimized: true })?.total ?? 0;\n        if (exAtkCount <= 0) return;\n\n        try {\n          for (let i = 0; i < exAtkCount; i++) {\n            const _rollData = {\n              attackCount: (attackCount += 1),\n              attackSetCount: i,\n              formulaicAttack: i + 1, // Add and update attack counter\n            };\n\n            let formula = bonusFormula;\n            if (bonusToAll) formula += ` + ${bonusToAll}`;\n            formula = replaceSpecificRollData(formula, _rollData);\n\n            const alabel = game.i18n.has(label) ? game.i18n.format(label, { 0: i + 1 }) : label?.replace(\"{0}\", i + 1);\n\n            attacks.push({\n              bonus: bonusLabel ? `(${formula})[${bonusLabel}]` : `(${formula})`,\n              formula,\n              flavor: bonusLabel,\n              // Continue counting if similar to initial attack name\n              // If formulaic attacks have a non-default name, number them with their own counter; otherwise, continue unnamed attack numbering\n              label: getUniqueName(alabel, label),\n              rollData: _rollData,\n            });\n          }\n        } catch (err) {\n          console.error(err);\n        }\n      };\n\n      if (exAtkCfg.iteratives && !unchainedEconomy) {\n        parseAttacks(\n          ffd20.config.iterativeExtraAttacks,\n          ffd20.config.iterativeAttackModifier,\n          null,\n          game.i18n.localize(\"FFD20.Iterative\")\n        );\n      }\n\n      // Add attacks defined by configuration\n      if (exAtkCfg.count) {\n        parseAttacks(exAtkCfg.count, exAtkCfg.bonus, exAtkCfg.attackName, flavor);\n      }\n\n      // Add manually entered explicit extra attacks\n      if (exAtkCfg.manual) {\n        const extraAttacks = this.extraAttacks?.manual ?? [];\n        for (const { name, formula } of extraAttacks) {\n          if (name) unnamedAttackNames.add(name);\n          attacks.push({\n            bonus: formula,\n            // Use defined label, or fall back to continuously numbered default attack name\n            label: name || getUniqueName(),\n          });\n        }\n      }\n\n      // Add custom extra attack formula\n      if (exAtkCfg.formula) {\n        const formulaCfg = this.extraAttacks.formula ?? {};\n        parseAttacks(formulaCfg.count, formulaCfg.bonus, formulaCfg.label);\n      }\n    }\n\n    // TODO: Move this to be part of the output data as formulas\n    if (resolve) {\n      const condBonuses = new Array(attacks.length).fill(0);\n      if (conditionals) {\n        // Conditional modifiers\n        const conds = this.conditionals.filter((c) => c.default && c.modifiers.find((sc) => sc.target === \"attack\"));\n        for (const c of conds) {\n          for (const cc of c.modifiers) {\n            const bonusRoll = RollPF.safeRollSync(cc.formula, rollData, undefined, undefined, { minimize: true });\n            if (bonusRoll.total == 0) continue;\n            if (cc.subTarget?.match(/^attack\\.(\\d+)$/)) {\n              const atk = parseInt(RegExp.$1, 10);\n              if (atk in condBonuses) condBonuses[atk] += bonusRoll.total;\n            }\n          }\n        }\n      }\n\n      let totalBonus = 0;\n      if (bonuses) {\n        const sources = this.item.getAttackSources(this.id, { rollData });\n        totalBonus = sources.reduce((total, src) => {\n          let value = src.value;\n          if (typeof value === \"string\") {\n            const roll = RollPF.safeRollSync(value, rollData, undefined, undefined, { minimize: true });\n            value = roll.total;\n          }\n          return total + value;\n        }, 0);\n      }\n\n      attacks.forEach((atk, i) => {\n        rollData.attackCount = i;\n        const roll = RollPF.safeRollSync(atk.bonus, rollData, undefined, undefined, { minimize: true });\n        atk.bonus = roll.total + totalBonus + condBonuses[i];\n        delete rollData.attackCount;\n      });\n    }\n\n    return attacks;\n  }\n\n  /**\n   * Use action.\n   *\n   * Wrapper for {@link ffd20.documents.item.ItemPF.use() ItemPF.use()}\n   *\n   * @param {object} options - Options passed to `ItemPF.use()`.\n   * @returns {Promise<void>} - Returns what `ItemPF.use()` returns.\n   */\n  async use(options = {}) {\n    options.actionId = this.id;\n\n    // TODO: ItemPF.use() and this.use() relation needs to be flipped.\n\n    return this.item.use(options);\n  }\n\n  /**\n   * Prune data\n   *\n   * @internal\n   * @param {object} data - Raw data (e.g. product of {@link toObject()})\n   */\n  static pruneData(data) {\n    // Aggressive data size reduction\n\n    if (!data.img) delete data.img;\n    if (!data.tag) delete data.tag;\n    if (!data.bab) delete data.bab;\n    if (!data.attackName) delete data.attackName;\n    if (!data.attackBonus) delete data.attackBonus;\n    if (!data.critConfirmBonus) delete data.critConfirmBonus;\n    if (!data.measureTemplate?.type) delete data.measureTemplate;\n    if (!data.extraAttacks?.type) delete data.extraAttacks;\n    if (data.extraAttacks) {\n      if (!data.extraAttacks.formula) delete data.extraAttacks.formula;\n      if (!data.extraAttacks.count) delete data.extraAttacks.count;\n      if (!data.extraAttacks.label) delete data.extraAttacks.label;\n      if (data.extraAttacks.manual?.length == 0) delete data.extraAttacks.manual;\n    }\n    if (!data.uses?.self?.per) delete data.uses?.self;\n    if (data.save && !data.save.type) {\n      // Preserve description even if there's no save (TODO: Maybe cull it anyway?)\n      if (!data.save.description) delete data.save.description;\n      // RAW preserving harmless=true here is pointless if there's no save.\n      if (data.save.harmless === false) delete data.save.harmless;\n      if (data.save.harmless !== true && !data.save.description) delete data.save;\n      else {\n        delete data.save.type;\n        delete data.save.dc;\n      }\n    }\n    if (!data.held) delete data.held;\n    if (!data.duration?.units) delete data.duration;\n    if (data.duration?.dismiss === false) delete data.duration.dismiss;\n    if (data.duration?.concentration === false) delete data.duration.concentration;\n    if (!data.target?.value) delete data.target;\n    if (!data.uses?.autoDeductChargesCost) delete data.uses?.autoDeductChargesCost;\n    if (data.uses?.perAttack === false) delete data.uses.perAttack;\n\n    if (data.ability?.max === null) delete data.ability.max;\n\n    if (!data.area) delete data.area;\n    if (!data.effect) delete data.effect;\n    if (data.notes?.effect) {\n      if (data.notes.effect.length === 0) delete data.notes.effect;\n    }\n    if (data.notes?.footer) {\n      if (data.notes.footer.length === 0) delete data.notes.footer;\n    }\n\n    if (!data.range?.units) delete data.range;\n    else {\n      if (!data.range?.minUnits) delete data.range?.minValue;\n      if (data.range?.maxIncrements === 1) delete data.range?.maxIncrements;\n    }\n\n    if (data.damage) {\n      if (data.damage.parts?.length == 0) delete data.damage.parts;\n      if (data.damage.critParts?.length == 0) delete data.damage.critParts;\n      if (data.damage.nonCritParts?.length == 0) delete data.damage.nonCritParts;\n      if (Object.keys(data.damage).length == 0) delete data.damage;\n    }\n\n    if (data.material) {\n      if (!data.material.normal?.value) delete data.material?.normal;\n      if (!(data.material.addon?.length > 0)) delete data.material?.addon;\n      if (Object.keys(data.material).length == 0) delete data.material;\n    }\n\n    // Diff based cleanup (don't do this for everything, to avoid defaults changing causing problems)\n    const defaults = new this().toObject(true, false);\n    const diff = foundry.utils.diffObject(defaults, data);\n    if (!diff.naturalAttack) delete data.naturalAttack;\n    if (!diff.alignments) delete data.alignments;\n\n    // Prune child models\n    // HACK: .toObject() only clones _source and thus never calls .toObject() on the child models\n    if (data.damage) {\n      for (const parts of Object.values(data.damage)) {\n        for (const part of parts) {\n          DamagePartModel.pruneData(part);\n        }\n      }\n    }\n\n    if (data.extraAttacks?.manual?.length) {\n      for (const exAtk of data.extraAttacks.manual) {\n        ExtraAttackModel.pruneData(exAtk);\n      }\n    }\n  }\n\n  /**\n   * Current sheet.\n   *\n   * @remarks\n   * - Initializes a new sheet if one doesn't exist yet.\n   *\n   * @type {ffd20.applications.component.ItemActionSheet}\n   */\n  get sheet() {\n    this._sheet ??= new ffd20.applications.component.ItemActionSheet(this);\n    return this._sheet;\n  }\n\n  /**\n   * Render all connected application instances.\n   *\n   * @param {boolean} [force=false] - Force rendering\n   * @param {object} [context={}] - Optional context\n   */\n  render(force = false, context = {}) {\n    // TODO: Support AppV2\n    Object.values(this.apps).forEach((app) => app.render(force, context));\n  }\n\n  /* DEPRECATIONS */\n\n  /** @deprecated - No replacement */\n  static get defaultData() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.defaultData has been deprecated with no replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return new this().toObject(undefined, false);\n  }\n\n  /**\n   * @deprecated - Use the action directly instead\n   * @returns {this}\n   */\n  get data() {\n    foundry.utils.logCompatibilityWarning(\n      \"ItemAction.data has been deprecated. Use the data directly on the action instead.\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n\n    return this;\n  }\n\n  /** @deprecated - No replacement */\n  static get defaultDamageType() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.defaultDamageType is deprecated with no replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return [];\n  }\n\n  /**\n   * Has sound effect?\n   *\n   * @deprecated - Test `!!action.soundEffect` instead.\n   * @type {boolean}\n   */\n  get hasSound() {\n    foundry.utils.logCompatibilityWarning(\n      \"ItemAction.hasSound is deprecated with no replacement. Test !!action.soundEffect instead.\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n    return !!this.soundEffect;\n  }\n\n  /**\n   * Effective ammo type.\n   *\n   * @deprecated - Use `action.ammo.type` instead.\n   * @type {string|null}\n   */\n  get ammoType() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.ammoType is deprecated in favor of ItemAction.ammo.type\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n    return this.ammo.type;\n  }\n\n  /**\n   * Effective per-attack ammo cost.\n   *\n   * @deprecated - Use `action.ammo.cost` instead.\n   * @type {number}\n   */\n  get ammoCost() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.ammoCost is deprecated in favor of ItemAction.ammo.cost\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return this.ammo.cost;\n  }\n\n  /**\n   * @deprecated - Use `action.effect` instead\n   */\n  get spellEffect() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.spellEffect is deprecated in favor of ItemAction.effect\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return this.effect;\n  }\n\n  /** @deprecated - Use `action.notes.footer` instead */\n  get attackNotes() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.attackNotes is deprecated in favor of ItemAction.notes.footer\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n    return this.notes?.footer;\n  }\n\n  /** @deprecated - Use `action.notes.effect` instead */\n  get effectNotes() {\n    foundry.utils.logCompatibilityWarning(\"ItemAction.effectNotes is deprecated in favor of ItemAction.notes.effect\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n    return this.notes?.effect;\n  }\n}\n","import { getChangeFlat, getSourceInfo } from \"@actor/utils/apply-changes.mjs\";\nimport { RollPF } from \"@dice/roll.mjs\";\n\nimport { ReplaceableSourceMixin } from \"@models/mixins/replaceable-source.mjs\";\nimport { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\n/**\n * Change datamodel\n */\nexport class ItemChange extends ReplaceableSourceMixin(CompactingMixin(foundry.abstract.DataModel)) {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      _id: new fields.StringField({\n        blank: false,\n        initial: () => foundry.utils.randomID(8),\n        required: true,\n        readonly: true,\n      }),\n      formula: new FormulaField(),\n      operator: new fields.StringField({ blank: false, initial: \"add\", choices: [\"add\", \"set\"] }),\n      target: new fields.StringField({ blank: true, required: false }),\n      type: new fields.StringField({ blank: false, required: false, initial: \"untyped\" }),\n      priority: new fields.NumberField({ initial: 0, required: false }),\n      value: new fields.NumberField({ initial: 0, required: false }),\n      flavor: new fields.StringField({ blank: true, initial: undefined, required: false }),\n      continuous: new fields.BooleanField({ initial: undefined, required: false }),\n    };\n  }\n\n  static migrateData(source) {\n    // Update terminology\n    if (source.subTarget) {\n      source.target = source.subTarget;\n      delete source.subTarget;\n    }\n    if (source.modifier) {\n      source.type = source.modifier;\n      delete source.modifier;\n    }\n    // Script operator is no longer supported\n    // And migrate legacy operators\n    if (source.operator === \"script\") source.operator = \"add\";\n    else if (source.operator === \"+\") source.operator = \"add\";\n    else if (source.operator === \"=\") source.operator = \"set\";\n\n    return super.migrateData(source);\n  }\n\n  constructor(data, options = {}) {\n    super(data, options);\n    this.updateTime = new Date();\n  }\n\n  /**\n   * Retrieve UUID\n   *\n   * Relies on {@link ffd20.documents.item.ItemBasePF.getEmbeddedDocument | Item#getEmbeddedDocument()} override to function with fromUuid() and similar functions.\n   *\n   * @type {string}\n   */\n  get uuid() {\n    return this.parent.uuid + `.Change.${this.id}`;\n  }\n\n  /**\n   * @override\n   */\n  _initialize(options = {}) {\n    super._initialize(options);\n    // Required to overcome Foundry's _id special case\n    Object.defineProperty(this, \"_id\", {\n      value: this._source._id,\n      writable: false,\n      configurable: true,\n    });\n    this.prepareData();\n  }\n\n  /**\n   * Prepare in-memory data.\n   *\n   * @internal\n   */\n  prepareData() {\n    this.flavor ||= this.parent?.name.replace(/\\[|\\]/g, \"\") || this.type;\n  }\n\n  /**\n   * Creates a change.\n   *\n   * @param {object[]} data - Data to initialize the change(s) with.\n   * @param {object} context - An object containing context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the change within.\n   * @returns {Promise<ItemChange[]>} The resulting changes, or an empty array if nothing was created.\n   */\n  static async create(data, { parent = null } = {}) {\n    if (!Array.isArray(data)) data = [data];\n\n    if (parent instanceof ffd20.documents.item.ItemPF) {\n      // Prepare data\n      data = data.map((dataObj) => new this(dataObj).toObject());\n\n      const oldChangeData = parent.toObject().system.changes ?? [];\n\n      // Catalog existing IDs\n      const ids = new Set(oldChangeData.map((c) => c._id));\n      // Remove invalid IDs\n      ids.delete(undefined);\n      ids.delete(\"\");\n      // Ensure new data has unique IDs that don't conflict with old\n      const newIds = new Set();\n      for (const c of data) {\n        c._id ||= foundry.utils.randomID(8);\n        while (ids.has(c._id)) c._id = foundry.utils.randomID(8);\n        ids.add(c._id);\n        newIds.add(c._id);\n      }\n\n      // Update parent\n      const newChangeData = [...oldChangeData, ...data];\n      await parent.update({ \"system.changes\": newChangeData });\n\n      // Return results\n      return [...parent.changes.filter((c) => newIds.has(c._id))];\n    }\n\n    return [];\n  }\n\n  async delete() {\n    const item = this.parent;\n    if (!item) throw new Error(\"Can not delete Change not in an item\");\n    const changes = item.toObject().system.changes ?? [];\n    const changeId = this.id;\n    changes.findSplice((c) => c._id === changeId);\n    return item.update({ \"system.changes\": changes });\n  }\n\n  /**\n   * Change ID\n   *\n   * @type {string}\n   */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * CSS Template Class\n   *\n   * @type {string}\n   */\n  get cssClass() {\n    if (this.isSimple) return \"simple\";\n    if (this.isDeferred) return \"roll\";\n    return \"deterministic\";\n  }\n\n  /**\n   * Is simple?\n   *\n   * Simple changes are evaluated before roll data becomes available.\n   *\n   * @type {boolean}\n   */\n  get isSimple() {\n    const targetData = ffd20.config.buffTargets[this.target];\n    return targetData?.simple ?? false;\n  }\n\n  /**\n   * Is deferred?\n   *\n   * Deferred changes are evaluated only when rolled.\n   *\n   * @type {boolean}\n   */\n  get isDeferred() {\n    const targetData = ffd20.config.buffTargets[this.target];\n    if (targetData) return targetData.deferred ?? false;\n\n    // Also any per-skill change is deferred\n    return /^skill\\./.test(this.target);\n  }\n\n  /**\n   * Does this change distance of something?\n   *\n   * Affects mostly presentation.\n   *\n   * @type {boolean}\n   */\n  get isDistance() {\n    return /speed|sense/i.test(this.target);\n  }\n\n  get source() {\n    console.warn(\"ItemChange.source does not exist\");\n    return null;\n  }\n\n  getSourceInfoTargets(actor) {\n    switch (this.target) {\n      case \"aac\":\n      case \"sac\":\n      case \"nac\":\n        return [\"system.attributes.ac.normal.total\", \"system.attributes.ac.flatFooted.total\"];\n    }\n\n    // Return default targets\n    return getChangeFlat(actor, this.target, this.type);\n  }\n\n  /**\n   * @internal\n   * @param {object} data - Data to update with\n   */\n  _preUpdate(data) {\n    // Make sure sub-target is valid\n    /*\n    // BUG: This does not work reliably for much anything but skills\n    const targetCategory = data.target?.split(\".\").shift();\n    if (targetCategory) {\n      const target = data.target || this.target;\n      const changeTargets = this.parent.getChangeTargets(targetCategory);\n      if (changeTargets[target] == null) {\n        console.error(`Invalid change target ${target}, resetting.`);\n        data.target = \"\";\n      }\n    }\n    */\n  }\n\n  /**\n   * @override\n   */\n  updateSource(data, options) {\n    // Shallow copy to avoid altering things for caller\n    data = { ...data };\n    // Prevent ID alterations\n    if (this.id && data._id) delete data._id;\n\n    return super.updateSource(data, options);\n  }\n\n  /**\n   * Update this change.\n   *\n   * @param {object} data - Update data\n   * @param {object} options - Additional options\n   * @param {object} context - Update context\n   * @throws {Error} - If change has no parent to update or the change does not exist on parent.\n   * @returns {Promise<Item|null>} - Updated parent, or null if no update was performed (e.g. nothing changed)\n   */\n  async update(data, options = {}, context = {}) {\n    if (!this.parent) throw new Error(\"ItemChange has no parent to update.\");\n\n    this.updateTime = new Date();\n\n    this._preUpdate(data);\n    // Prevent ID alterations\n    if (data._id) delete data._id;\n\n    const changes = this.parent.toObject().system.changes ?? [];\n\n    const idx = changes.findIndex((change) => change._id === this.id);\n    if (idx >= 0) {\n      // Temporary change to validate the update\n      const tc = new this.constructor(this.toObject());\n      const updated = tc.updateSource(data);\n      // Omit update if nothing would change\n      if (foundry.utils.isEmpty(updated)) return null;\n\n      changes[idx] = tc.toObject();\n      return this.parent.update({ \"system.changes\": changes }, context);\n    } else {\n      throw new Error(`Change #${this.id} not found on parent ${this.parent.uuid}`);\n    }\n  }\n\n  /**\n   * Safely apply this change to an actor, catching any errors.\n   *\n   * @internal\n   * @see {@link ItemChange#applyChange}\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * @param {string[]} [targets] - Property paths to target on the actor's data.\n   * @param {object} [options] - Optional options to change the behavior of this function.\n   * @param {boolean} [options.applySourceInfo=true] - Whether to add the changes to the actor's source information.\n   */\n  _safeApplyChange(actor, targets = null, { applySourceInfo = true } = {}) {\n    try {\n      this.applyChange(actor, targets, { applySourceInfo });\n    } catch (error) {\n      if (this.parent?.isOwner || actor.isOwner) {\n        const msgSourceReference = this.parent\n          ? `from ${this.parent.name} [${this.parent.uuid}] to ${actor.name}`\n          : `to ${actor.name} [${actor.uuid}]]`;\n        const errorMessage = `Failed to apply ItemChange ${this.id} ${msgSourceReference}`;\n        const errorData = {\n          change: this,\n          parent: this.parent,\n          actor,\n          targets,\n        };\n        Hooks.onError(\"ItemChange#applyChange\", error, {\n          msg: errorMessage,\n          log: \"error\",\n          data: errorData,\n        });\n        ui.notifications?.error(error.message, { console: false });\n      }\n    }\n  }\n\n  /**\n   * Applies this change to an actor.\n   *\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * @param {string[]} [targets] - Property paths to target on the actor's data.\n   * @param {object} [options] - Optional options to change the behavior of this function.\n   * @param {boolean} [options.applySourceInfo=true] - Whether to add the changes to the actor's source information.\n   * @param {object} [options.rollData] - Roll data\n   */\n  applyChange(actor, targets = null, { applySourceInfo = true, rollData } = {}) {\n    // Prepare change targets\n    targets ??= this.getTargets(actor);\n\n    rollData ??= this.parent ? this.parent.getRollData({ refresh: true }) : actor.getRollData({ refresh: true });\n\n    const overrides = actor.changeOverrides;\n    for (const t of targets) {\n      const override = overrides[t];\n      const operator = this.operator;\n\n      // HACK: Data prep change application creates overrides; only changes meant for manual comparison lack them,\n      // and those do not have to be applied to the actor.\n      // This hack enables calling applyChange on Changes that are not meant to be applied, but require a call to\n      // determine effective operator and/or value.\n      if (!override) continue;\n\n      let value = 0;\n      if (this.formula) {\n        if (!isNaN(this.formula)) {\n          value = parseFloat(this.formula);\n        } else if (this.isDeferred && RollPF.parse(this.formula).some((t) => !t.isDeterministic)) {\n          value = RollPF.replaceFormulaData(this.formula, rollData, { missing: 0 });\n        } else {\n          value = RollPF.safeRollSync(\n            this.formula,\n            rollData,\n            { formula: this.formula, target: t, change: this, rollData },\n            { suppressError: this.parent && !this.parent.isOwner },\n            { maximize: true }\n          ).total;\n        }\n      }\n\n      this.value = value;\n\n      if (!t) continue;\n\n      const prior = override[operator][this.type];\n\n      switch (operator) {\n        case \"add\":\n          {\n            let base = foundry.utils.getProperty(actor, t);\n\n            // Don't change non-existing ability scores\n            if (base == null) {\n              if (t.match(/^system\\.abilities/)) continue;\n              base = 0;\n            }\n\n            // Deferred formula\n            if (typeof value === \"string\") break;\n\n            if (typeof base === \"number\") {\n              // Skip positive dodge modifiers if lose dex to AC is in effect\n              if (actor.changeFlags.loseDexToAC && value > 0 && this.type === \"dodge\" && this.isAC) continue;\n\n              if (ffd20.config.stackingBonusTypes.includes(this.type)) {\n                // Add stacking bonus\n                foundry.utils.setProperty(actor, t, base + value);\n                override[operator][this.type] = (prior ?? 0) + value;\n              } else {\n                // Use higher value only\n                const diff = !prior ? value : Math.max(0, value - (prior ?? 0));\n                foundry.utils.setProperty(actor, t, base + diff);\n                override[operator][this.type] = Math.max(prior ?? 0, value);\n              }\n            }\n          }\n          break;\n\n        case \"set\":\n          foundry.utils.setProperty(actor, t, value);\n          override[operator][this.type] = value;\n          break;\n      }\n\n      if (applySourceInfo) this.applySourceInfo(actor);\n\n      // Adjust ability modifier\n      const modifierChanger = t.match(/^system\\.abilities\\.([a-zA-Z0-9]+)\\.(?:total|penalty|base)$/);\n      const abilityTarget = modifierChanger?.[1];\n      if (abilityTarget) {\n        const ability = actor.system.abilities[abilityTarget];\n        ability.mod = ffd20.utils.getAbilityModifier(ability.total, {\n          damage: ability.damage,\n          penalty: ability.penalty,\n        });\n      }\n    }\n  }\n\n  /**\n   * Does this target any kind of AC?\n   *\n   * @type {boolean}\n   */\n  get isAC() {\n    return [\"ac\", \"aac\", \"sac\", \"nac\", \"tac\", \"ffac\"].includes(this.target);\n  }\n\n  /**\n   * Applies this change's info to an actor's `sourceInfo`.\n   * Info is only added if either the {@link type | modifier type} allows stacking or the {@link value} is higher than the previous value.\n   * If the modifier type is not stacking and this change's info is added, existing and now ineffective info entries are removed.\n   *\n   * @param {ActorPF} actor - The actor to apply the change's data to.\n   * @returns {void}\n   */\n  applySourceInfo(actor) {\n    const sourceInfoTargets = this.getSourceInfoTargets(actor);\n    const value = this.value;\n\n    // This Change's info entry data\n    const infoEntry = {\n      value,\n      operator: this.operator,\n      name: this.parent ? this.parent.name : this.flavor,\n      modifier: this.type,\n      type: this.parent ? this.parent.type : null,\n      change: this,\n    };\n\n    switch (this.operator) {\n      case \"add\":\n      case \"function\":\n        if (ffd20.config.stackingBonusTypes.includes(this.type)) {\n          // Always add stacking entries\n          const sourceInfoGroup = value >= 0 ? \"positive\" : \"negative\";\n          for (const si of sourceInfoTargets) {\n            getSourceInfo(actor.sourceInfo, si)[sourceInfoGroup].push(infoEntry);\n          }\n        } else {\n          for (const infoTarget of sourceInfoTargets) {\n            const sourceInfoGroup = value >= 0 ? \"positive\" : \"negative\";\n            const sInfo = getSourceInfo(actor.sourceInfo, infoTarget)[sourceInfoGroup];\n\n            // Assume this Change's info entry should be added\n            let doAdd = true;\n\n            // The value of the this Change's source info entry for this specific target\n            let sumValue = value;\n\n            // Check if there already is an info entry with which this Change should be combined\n            // This is the case for `enhancement` and `base` entries otherwise sharing parent and target\n            const existingInfoEntry = sInfo.find((infoEntry) => {\n              const hasSameParent = infoEntry.change?.parent === this.parent;\n              const isEnh =\n                (infoEntry.change?.type === \"base\" && this.type === \"enhancement\") ||\n                (infoEntry.change?.type === \"enhancement\" && this.type === \"base\");\n              const hasSameTarget = infoEntry.change?.target === this.target;\n              return hasSameParent && isEnh && hasSameTarget;\n            });\n            if (existingInfoEntry) {\n              doAdd = false;\n              if (existingInfoEntry.change?.type === \"base\") {\n                // This Change enhances an existing base\n                existingInfoEntry.value += value;\n                continue;\n              } else {\n                // This Change replaces an existing `enhancement` entry with its own `base` entry, using the sum of both values\n                sumValue += existingInfoEntry.value;\n                // Check whether the combined entry should exist, or if another entry is already better than it\n                const hasHighestValue = !sInfo.some((infoEntry) => {\n                  const isSameModifier = infoEntry.modifier === infoEntry.modifier;\n                  const target = infoEntry.change?.target;\n                  const isSameTarget = target ? target === this.target : true;\n                  const hasHigherValue = infoEntry.value > sumValue;\n                  return isSameModifier && isSameTarget && hasHigherValue;\n                });\n                // If the merged entry is the best, replace the existing entry with it\n                sInfo.findSplice(\n                  (entry) => entry === existingInfoEntry,\n                  hasHighestValue ? { ...infoEntry, value: sumValue } : undefined\n                );\n              }\n            }\n\n            // Determine whether there is an entry with a higher value; remove entries with lower values\n            if (this.type) {\n              for (const oldEntry of sInfo) {\n                if (!oldEntry.type) continue;\n                const isSameType = oldEntry.change?.type === oldEntry.type;\n                if (!isSameType) continue;\n                if (oldEntry.value < sumValue) {\n                  sInfo.splice(sInfo.indexOf(oldEntry), 1);\n                } else {\n                  doAdd = false;\n                }\n              }\n            }\n\n            if (doAdd) sInfo.push({ ...infoEntry });\n          }\n        }\n        break;\n      case \"set\": {\n        for (const si of sourceInfoTargets) {\n          getSourceInfo(actor.sourceInfo, si).positive.push({ ...infoEntry });\n        }\n        break;\n      }\n    }\n  }\n\n  /**\n   * @see {@link getChangeFlat}\n   * @param {ActorPF} actor - Actor instance\n   * @returns {Array<string>} - Valid targets for this change on specified actor\n   */\n  getTargets(actor) {\n    return getChangeFlat(actor, this.target, this.type, this.value);\n  }\n\n  static pruneData(data) {\n    // Null priority is pointless\n    if (data.priority === null) delete data.priority;\n\n    // Clear undefined values\n    for (const [key, value] of Object.entries(data)) {\n      if (value === undefined) delete data[key];\n    }\n  }\n\n  toObject(source, prune) {\n    const data = super.toObject(source, prune);\n\n    // Cleanup: Following are never meant to be stored\n    delete data.value;\n    delete data.continuous;\n\n    return data;\n  }\n}\n","import { CompactingMixin } from \"@models/mixins/compacting-mixin.mjs\";\nimport { PreparedModel } from \"@models/abstract/prepared-model.mjs\";\nimport { IDField } from \"@datafields/id-field.mjs\";\n\nimport { ReplaceableSourceMixin } from \"@models/mixins/replaceable-source.mjs\";\n\nimport { FormulaField } from \"@datafields/formula-field.mjs\";\n\n/**\n * Conditional modifier bundle.\n */\nexport class ItemConditional extends ReplaceableSourceMixin(CompactingMixin(PreparedModel)) {\n  constructor(data, options) {\n    if (options instanceof ffd20.components.ItemAction) {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemConditional constructor's second parameter as parent is deprecated. Please wrap it in options object like with datamodels.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      options = { parent: options };\n    }\n    super(data, options);\n  }\n\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      _id: new IDField(),\n      name: new fields.StringField(),\n      default: new fields.BooleanField({ initial: false }),\n      modifiers: new fields.ArrayField(new fields.EmbeddedDataField(ItemConditionalModifier)),\n    };\n  }\n\n  _configure(options) {\n    super._configure(options);\n\n    // Following prevent these definitions being lost on model reset()\n    Object.defineProperties(this, {\n      // Modifiers collection cache to avoid conflicts with stored array\n      _modifiers: {\n        value: new Collection(),\n        writable: false,\n        enumerable: false,\n      },\n    });\n  }\n\n  /**\n   * @internal\n   */\n  prepareData() {\n    this._prepareModifiers();\n  }\n\n  /**\n   * @internal\n   */\n  _prepareModifiers() {\n    const collection = this._modifiers;\n    const prior = new Collection(collection.entries());\n    collection.clear(); // TODO: Remove specific entries after the loop instead of full clear here\n\n    // HACK: this causes modifier datamodels to be re-initialized\n    // It would be better for the system if we didn't make this persistent reference guarantee\n    for (const mod of this.modifiers) {\n      let modifier = null;\n      if (prior && prior.has(mod.id)) {\n        modifier = prior.get(mod.id);\n        if (mod !== modifier) modifier.replaceSource(mod._source);\n      } else {\n        modifier = mod;\n      }\n\n      collection.set(modifier.id, modifier);\n    }\n\n    this.modifiers = collection;\n  }\n\n  /**\n   * Create new conditional\n   *\n   * @param {object|object[]} data - Data to create conditional(s) from.\n   * @param {object} context - Context data\n   * @param {ItemAction} context.parent Parent action to add the conditional to.\n   * @throws {Error} - If no valid parent is defined.\n   * @returns {Proimise<ItemConditional[]>} - Created conditionals\n   */\n  static async create(data, context = {}) {\n    const { parent } = context;\n\n    if (!(parent instanceof ffd20.components.ItemAction))\n      throw new Error(\"Can not create conditionals without parent ItemAction\");\n\n    if (!Array.isArray(data)) data = [data];\n\n    // Prepare data\n    data = data.map((dataObj) => new this(dataObj).toObject());\n    const conditionals = parent.toObject().conditionals || [];\n    conditionals.push(...data);\n\n    // Update parent\n    await parent.update({ conditionals });\n\n    // Return results\n    return data.map((o) => parent.conditionals.get(o._id));\n  }\n\n  static get defaultData() {\n    foundry.utils.logCompatibilityWarning(\"ItemConditional.defaultData has been deprecated with no replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n\n    return new this().toObject(true, false);\n  }\n\n  /** @type {string} */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * Update conditional\n   *\n   * @param {object} updateData\n   * @param {object} options\n   */\n  async update(updateData, options = {}) {\n    if (options.dryRun) return this.updateSource(updateData, { dryRun: true });\n\n    this.updateSource(updateData);\n\n    const conditionals = this.parent.conditionals.map((t) => t.toObject());\n    await this.parent.update({ conditionals });\n  }\n\n  /**\n   * Delete conditional\n   */\n  async delete() {\n    const conditionals = this.parent.conditionals.map((t) => t.toObject());\n    conditionals.findSplice((c) => c._id === this.id);\n    return this.parent.update({ conditionals });\n  }\n\n  /**\n   * @internal\n   * @param {object} data\n   */\n  static pruneData(data) {\n    if (!data.default) delete data.default;\n    if (!(data.modifiers?.length > 0)) delete data.modifiers;\n    else {\n      for (const m of data.modifiers) {\n        ItemConditionalModifier.pruneData(m);\n      }\n    }\n  }\n}\n\n/**\n * Individual modifier in a conditional bundle.\n */\nexport class ItemConditionalModifier extends ReplaceableSourceMixin(CompactingMixin(foundry.abstract.DataModel)) {\n  /**\n   * @param {object} data\n   * @param {object} options\n   */\n  constructor(data, options) {\n    if (options instanceof ffd20.components.ItemAction) {\n      foundry.utils.logCompatibilityWarning(\n        \"ItemConditionalModifier constructor's second parameter as parent is deprecated. Please wrap it in options object like with datamodels.\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n      options = { parent: options };\n    }\n    super(data, options);\n  }\n\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      _id: new IDField(),\n      formula: new FormulaField(),\n      target: new fields.StringField(), // modifier on what?\n      subTarget: new fields.StringField(), // which attack is this targeting?\n      type: new fields.StringField({ initial: \"untyped\" }), // Bonus type\n      damageType: new fields.SetField(new fields.StringField({ blank: false, nullable: false })),\n      critical: new fields.StringField({ initial: undefined }), // Does this target normal or critical confirm? or which kind of damage is this in relation to crits?\n    };\n  }\n\n  static migrateData(source) {\n    if (source.damageType && !Array.isArray(source.damageType)) {\n      const custom =\n        source.damageType.custom\n          ?.split(\";\")\n          .map((t) => t?.trim())\n          .filter((t) => !!t) ?? [];\n      const standard = source.damageType.values ?? [];\n      source.damageType = [...standard, ...custom];\n    }\n\n    // Move effect.dc and effect.cl to dc and cl\n    if (source.target === \"effect\") {\n      if ([\"dc\", \"cl\"].includes(source.subTarget)) {\n        source.target = source.subTarget;\n        source.subTarget = undefined;\n      }\n    }\n    // Remove redundant subtarget\n    if ([\"cl\", \"dc\"].includes(source.target)) source.subTarget = undefined;\n    // Move misc.charges to charges\n    if (source.target === \"misc\") {\n      if (source.subTarget === \"charges\") {\n        source.target = source.subTarget;\n        source.subTarget = undefined;\n      }\n    }\n\n    // Initialize defaults for attack and damage modifiers if not present\n    if (source.target === \"damage\") {\n      if (!source.subTarget) source.subTarget = \"allDamage\";\n      if (!source.critical) source.critical = \"normal\";\n    }\n    if (source.target === \"attack\") {\n      if (!source.subTarget) source.subTarget = \"allAttack\";\n      if (!source.critical) source.critical = \"normal\";\n    }\n\n    return super.migrateData(source);\n  }\n\n  static get defaultData() {\n    foundry.utils.logCompatibilityWarning(\n      \"ItemConditionalModifier.defaultData has been deprecated with no replacement.\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n\n    return new this().toObject(true, false);\n  }\n\n  /** @type {string} */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * Part ID string\n   *\n   * @type {string}\n   */\n  get partID() {\n    const parts = [this.target];\n    if (this.subTarget) parts.push(this.subTarget);\n    if (this.critical) parts.push(this.critical);\n    return parts.join(\".\");\n  }\n\n  /**\n   * Create conditional modifier\n   *\n   * @param {object} data - Creation data\n   * @param {object} context - Context data\n   * @param {ItemConditional} context.parent - Parent conditional\n   * @returns {Promise<ItemConditionalModifier[]>} - Created modifiers\n   */\n  static async create(data, context = {}) {\n    const { parent } = context;\n    if (!(parent instanceof ffd20.components.ItemConditional))\n      throw new Error(\"Conditional modifier's parent must be a Conditional\");\n\n    if (!Array.isArray(data)) data = [data];\n\n    const modifiers = parent.toObject().modifiers ?? [];\n\n    // Prepare data\n    data = data.map((dataObj) => new this(dataObj).toObject());\n    modifiers.push(...data);\n\n    // Update parent\n    await parent.update({ modifiers });\n\n    // Return results\n    return data.map((o) => parent.modifiers.get(o._id));\n  }\n\n  /**\n   * Update modifier\n   *\n   * @param {object} updateData\n   * @param {object} [options]\n   * @returns {Promise<ItemAction>} - Updated action\n   */\n  async update(updateData, options = {}) {\n    if (options.dryRun) return this.updateSource(updateData, { dryRun: true });\n\n    this.updateSource(updateData);\n\n    const modifiers = this.parent.modifiers.map((m) => m.toObject());\n    return this.parent.update({ modifiers });\n  }\n\n  /**\n   * Delete this individual modifier.\n   *\n   * @returns {Promise<ItemAction>} - Updated action\n   */\n  async delete() {\n    const modifiers = this.parent.toObject().modifiers ?? [];\n    const idx = modifiers.findIndex((m) => m._id === this.id);\n    if (idx < 0) throw new Error(`Modifier not found in parent ${this.parent.name}`);\n\n    modifiers.splice(idx, 1);\n    return this.parent.update({ modifiers });\n  }\n\n  /**\n   * @internal\n   * @param {object} data\n   */\n  static pruneData(data) {\n    if (!data.type) delete data.type;\n    if (!data.formula) delete data.formula;\n    if (!data.critical || data.critical === \"normal\") delete data.critical;\n    if (!data.target) delete data.target;\n    if (!data.subTarget) delete data.subTarget;\n\n    if (![\"attack\", \"damage\"].includes(data.target)) {\n      delete data.critical;\n    }\n\n    // Damage type is only meaningful with damage target\n    if (data.target !== \"damage\") delete data.damageType;\n    else {\n      if (data.damageType?.length) {\n        data.damageType = [...new Set(data.damageType)].filter((t) => !!t);\n      }\n      if (!(data.damageType?.length > 0)) delete data.damageType;\n    }\n\n    // These don't use bonus typing\n    if ([\"damage\", \"size\", \"charges\", \"critMult\", \"cl\", \"sl\"].includes(data.target)) {\n      delete data.type;\n    }\n  }\n}\n","import { PreparedModel } from \"@models/abstract/prepared-model.mjs\";\nimport { ReplaceableSourceMixin } from \"@models/mixins/replaceable-source.mjs\";\n\n/**\n * Script Call\n */\nexport class ItemScriptCall extends ReplaceableSourceMixin(PreparedModel) {\n  constructor(data, options) {\n    if (options instanceof foundry.abstract.DataModel) {\n      foundry.utils.logCompatibilityWarning(\"ItemScriptCall second constructor parameter is no longer plain parent.\", {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      });\n      options = { parent: options };\n    }\n    super(data, options);\n  }\n\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      _id: new fields.StringField({\n        required: true,\n        blank: false,\n        readonly: true,\n        initial: () => foundry.utils.randomID(8),\n      }),\n      name: new fields.StringField({ required: true, initial: () => game.i18n.localize(\"FFD20.ScriptCalls.NewName\") }),\n      img: new fields.FilePathField({ required: false, blank: false, categories: [\"IMAGE\"] }),\n      type: new fields.StringField({\n        required: true,\n        blank: false,\n        nullable: false,\n        initial: \"script\",\n        choices: [\"script\", \"macro\"],\n      }),\n      value: new fields.StringField({ required: true, nullable: false, blank: true }),\n      category: new fields.StringField({ required: false }),\n      hidden: new fields.BooleanField({ initial: false, required: false }),\n    };\n  }\n\n  static migrateData(source) {\n    if (source.type == \"macro\") {\n      source.name = \"\";\n      source.img = \"\";\n    }\n\n    return super.migrateData(source);\n  }\n\n  /** @deprecated */\n  get data() {\n    foundry.utils.logCompatibilityWarning(\n      \"ItemScriptCall.data is deprecated in favor of directly accessing the data.\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n    return this;\n  }\n\n  /** @deprecated */\n  static get defaultData() {\n    foundry.utils.logCompatibilityWarning(\"ItemScriptCall.defaultData is deprecated with no replacement.\", {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    });\n    return new this().toObject();\n  }\n\n  prepareData() {\n    if (this.type === \"macro\") {\n      const macro = fromUuidSync(this.value);\n      this.name = macro?.name || `${game.i18n.localize(\"FFD20.Unknown\")} (${game.i18n.localize(\"DOCUMENT.Macro\")})`;\n      this.img = macro?.img || \"icons/svg/hazard.svg\";\n    }\n  }\n\n  /**\n   * Creates a script call.\n   *\n   * @param {object[]} data - Data to initialize the script call(s) with.\n   * @param {object} context - An object containing context information.\n   * @param {ItemPF} [context.parent] - The parent entity to create the script call within.\n   * @returns {Promise<ItemScriptCall[]>} - The resulting script calls, or an empty array if nothing was created.\n   */\n  static async create(data, context) {\n    const { parent } = context;\n\n    if (!(parent instanceof ffd20.documents.item.ItemPF))\n      throw new Error(\"Can not create script calls outside of items.\");\n\n    // Prepare data\n    data = data.map((dataObj) => new ItemScriptCall(dataObj, { parent }).toObject());\n    const newScriptCallData = parent.toObject().system.scriptCalls || [];\n    newScriptCallData.push(...data);\n\n    // TODO: Ensure new script calls don't have ID conflicts\n\n    // Update parent\n    await parent.update({ \"system.scriptCalls\": newScriptCallData });\n\n    // Return results\n    return data.map((o) => parent.scriptCalls.get(o._id));\n  }\n\n  /** @type {string} */\n  get id() {\n    return this._id;\n  }\n\n  /** @type {boolean} */\n  get hide() {\n    return this.hidden && !game.user.isGM;\n  }\n\n  /**\n   * Get macro delegate for executing this script call with.\n   *\n   * @returns {Promise<Macro>} - Actual macro or its delegate\n   */\n  async getDelegate() {\n    if (this.type === \"script\") {\n      return new Macro({\n        type: \"script\",\n        command: this.value,\n        name: this.name,\n      });\n    } else {\n      return fromUuid(this.value);\n    }\n  }\n\n  async update(data, options = {}) {\n    if (this.parent != null) {\n      const idx = this.parent.system.scriptCalls.findIndex((o) => o._id === this.id);\n      if (idx >= 0) {\n        data = Object.entries(data).reduce((cur, o) => {\n          cur[`system.scriptCalls.${idx}.${o[0]}`] = o[1];\n          return cur;\n        }, {});\n        return this.parent.update(data, options);\n      }\n    }\n  }\n\n  // Opens up the editor for this script call\n  async edit({ editable = true } = {}) {\n    // For Macros\n    if (this.type === \"macro\") {\n      const macro = await fromUuid(this.value);\n      if (!macro) return void ui.notifications.error(game.i18n.format(\"FFD20.Error.NoMacroID\", { id: this.value }));\n\n      macro.sheet.render(true, { focus: true, editable });\n    }\n    // For regular script calls\n    else {\n      const scriptEditor = new ffd20.applications.ScriptEditor({\n        command: this.value,\n        name: this.name,\n        parent: this.parent,\n        script: this.id,\n        scriptCall: true,\n      });\n      scriptEditor.render(true);\n\n      const result = await scriptEditor.awaitResult();\n      if (result) {\n        return this.update({ value: result.command, name: result.name });\n      }\n    }\n  }\n\n  /**\n   * Executes the script.\n   *\n   * @param {object} shared - An object passed between script calls, and which is passed back as a result of ItemPF.executeScriptCalls.\n   * @param {object} extraParams - A dictionary containing extra parameters to pass on to the call.\n   * @returns {Promise<*>} - Script return value if any\n   */\n  async execute(shared, extraParams = {}) {\n    // Add variables to the evaluation scope\n    const item = this.parent;\n    const actor = item.actor;\n    const action = shared.action ?? null;\n    const token = actor?.token?.object ?? actor?.getActiveTokens(false, false)[0];\n\n    const scm = await this.getDelegate();\n    if (!scm) return;\n\n    // Create temporary macro for handling execution context and other utility\n    return scm.execute({ item, actor, token, shared, action, ...extraParams });\n  }\n}\n","export class ContextNote extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n    return {\n      text: new fields.StringField({ initial: \"\", nullable: false, blank: true }),\n      target: new fields.StringField({ initial: \"\", nullable: false, blank: true }),\n    };\n  }\n\n  static migrateData(source) {\n    if (source.subTarget) {\n      // Transfer a special tuple format target\n      if (source.target === \"spell\" && source.subTarget === \"effect\") {\n        source.target = \"spellEffect\";\n      }\n      // Otherwise transfer subtarget to target\n      else {\n        source.target = source.subTarget;\n      }\n    }\n\n    return super.migrateData(source);\n  }\n}\n","/**\n * Convert Distance\n *\n * @example\n * With metric enabled\n * ```hbs\n * {{convertDistance 5}} -> 1.5\n * ```\n * With imperial\n * ```hbs\n * {{convertDistance 9 \"m\"}} -> 30\n * ```\n *\n * @see {@link ffd20.utils.convertDistance}\n * @internal\n * @group Handlebars\n * @param {number} value\n * @param {string} [type]\n */\nexport function convertDistance(value, type) {\n  return Number.isFinite(value)\n    ? ffd20.utils.convertDistance(value, typeof type === \"string\" ? type : undefined)[0]\n    : value;\n}\n\n/**\n * Action Range\n *\n * @example\n * ```hbs\n * {{actionRange someAction actionRollData}} -> 30 ft\n * ```\n *\n * @group Handlebars\n * @internal\n * @param {ffd20.components.ItemAction} action\n * @param {object} rollData\n * @returns {string}\n */\nexport function actionRange(action, rollData) {\n  if (!action?.hasRange) return null;\n\n  const range = action.range.value;\n  const rangeType = action.range.units;\n\n  if (!rangeType) return null;\n  if (rangeType === \"spec\") return null; // Special is its own thing\n\n  const [rng, unit] = ffd20.utils.calculateRange(range, rangeType, rollData);\n  return `${rng} ${unit}`;\n}\n\n/**\n * Action Damage\n *\n * @example\n * ```hbs\n * {{actionDamage someAction}} -> 3d6\n * ```\n * @see {@link ffd20.utils.formula.actionDamage}\n * @group Handlebars\n * @internal\n * @param {ItemAction} action - Action\n * @param {object} [_rollData] - Deprecated\n * @param {object} [options] - Additional options\n * @returns {string} - Damage string\n */\nexport function actionDamage(action, _rollData, options) {\n  if (!action.hasDamage) return null;\n  return ffd20.utils.formula.actionDamage(action, { simplify: options?.hash?.combine ?? true });\n}\n\n/**\n * Alt numberFormat helper to provide non-fixed point decimals and pretty fractionals\n *\n * @example\n * ```hbs\n * {{numberFormatAlt 5.52 decimals=1}} -> 5.5\n * {{numberFormatAlt 5 decimals=1}} -> 5\n * {{numberFormatAlt 5.5 fraction=true}} -> 5 1/2\n * ```\n * Compare with core helper\n * ```hbs\n * {{numberFormat 5.52 decimals=1}} -> 5.5\n * {{numberFormat 5 decimals=1}} -> 5.0\n * ```\n *\n * @group Handlebars\n * @internal\n * @param {number} number\n * @param {object} [context]\n * @param {object} [context.hash]\n * @param {boolean} [context.hash.fraction] - Format as fractional.\n * @param {number} [context.hash.decimals] - Display up to this many decimals. Has no effect with fractional.\n * @returns {number|string} - Formatted number\n */\nexport function numberFormatAlt(number, { hash } = {}) {\n  if (hash.fraction) return ffd20.utils.fractionalToString(number);\n  else return ffd20.utils.limitPrecision(number, hash.decimals);\n}\n\n/**\n * Register Handlebars Helpers as part of system initialization\n *\n * @group Handlebars\n * @internal\n */\nexport function register() {\n  const helpers = {\n    convertDistance,\n    actionRange,\n    actionDamage,\n    numberFormatAlt,\n  };\n\n  for (const [id, fn] of Object.entries(helpers)) {\n    Handlebars.registerHelper(id, fn);\n  }\n}\n","/**\n * Measure the distance between two pixel coordinates\n * See BaseGrid.measureDistance for more details\n *\n * @deprecated\n * @param segments\n * @param options\n */\nexport function measureDistances(segments, options = {}) {\n  foundry.utils.logCompatibilityWarning(\n    \"ffd20.utils.canvas.measureDistances() is deprecated in favor of canvas.grid.measureDistances() and canvas.grid.measurePath()\",\n    {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    }\n  );\n  return canvas.grid.measureDistances(segments, options);\n}\n","import { ItemSelector } from \"module/applications/item-selector.mjs\";\nimport { ActorSelector } from \"module/applications/actor-selector.mjs\";\n\n/**\n * Choose actor from list.\n *\n * This is simplified interface to {@link ffd20.applications.ActorSelector}\n *\n * @param {ActorSelectorOptions} options - Selection options\n * @returns {Promise<string|null>} - Actor ID or null if cancelled.\n */\nexport async function getActor(options) {\n  return ActorSelector.wait(options);\n}\n\n/**\n * Choose item from actor.\n *\n * This is simplified interface to {@link ffd20.applications.ItemSelector}\n *\n * @param {getItemOptions} options - Options\n * @returns {Promise<Item|null>} - Chosen item or null.\n */\nexport async function getItem(options) {\n  if (!options.type && !options.subType && !options.filterFunc && !options.items)\n    throw new Error(\"Insufficient filter rules provided.\");\n\n  options.filterFunc ||= (item) => {\n    return (!options.type || item.type === options.type) && (!options.subType || item.subType === options.subType);\n  };\n\n  if (!options.window) options.window = {};\n\n  // Provide nice basic title\n  if (!options.window.title && !options.filterFunc && options.type) {\n    options.window.title = game.i18n.format(\"FFD20.SelectSpecific\", {\n      specifier: options.subType\n        ? ffd20.config[`${options.type}Types`]?.[options.subType]\n        : game.i18n.localize(CONFIG.Item.typeLabels[options.type]),\n    });\n  }\n\n  return ItemSelector.wait(options);\n}\n\n/**\n * Query for a number from current user.\n *\n * @example\n * ```js\n * const num = await ffd20.utils.dialog.getNumber({\n *   placeholder: \"NaN\",\n *   hint: \"Amazing\",\n *   label: \"Gimme a number\",\n * });\n * ```\n *\n * @param {object} [options={}] Additional options\n * @param {number} [options.min=null] Minimum value\n * @param {number} [options.max=null] Maximum value\n * @param {number} [options.step] Value stepping\n * @param {string} [options.title] Dialog title\n * @param {string} [options.label] A label preceding the number input.\n * @param {string} [options.hint] A hint displayed under the input.\n * @param {number} [options.initial] Initial value\n * @param {string} [options.placeholder] Placeholder value or description.\n * @param {string[]} [options.classes=[]] CSS classes to add.\n * @param {Function} [options.render] Render callback. Passed onto DialogV2.\n * @param {object} [options.dialog={}] Additional dialog options. Merged with the other DialogV2 options.\n * @returns {Promise<number|null>} Provided value or null if dialog was cancelled.\n */\nexport async function getNumber({\n  title,\n  label,\n  hint,\n  initial,\n  placeholder,\n  min,\n  max,\n  step,\n  classes = [],\n  render: renderCallback,\n  dialog: dialogOptions = {},\n} = {}) {\n  const templateData = { value: initial, min, max, step, placeholder, label, hint };\n  const content = await renderTemplate(\"systems/ffd20/templates/apps/get-number.hbs\", templateData);\n\n  const options = {\n    window: { title: title || game.i18n.localize(\"FFD20.Application.GetNumber.Title\") },\n    classes: [\"pf1-v2\", \"get-number\", ...classes],\n    content,\n    position: {\n      width: 260,\n    },\n    buttons: [\n      {\n        icon: \"fa-solid fa-check\",\n        label: \"FFD20.Application.GetNumber.Confirm\",\n        action: \"confirm\",\n        default: true,\n        callback: (event, target, html) => html.querySelector(\"form input[name='number']\").valueAsNumber,\n      },\n    ],\n    render: (event, html) => {\n      // Select contents of the number input\n      html.querySelector(\"form input[name='number']\").select();\n\n      renderCallback?.(event, html);\n    },\n    close: () => NaN,\n    rejectClose: false,\n  };\n\n  return foundry.applications.api.DialogV2.wait(foundry.utils.mergeObject(options, dialogOptions));\n}\n","/**\n * Split copper currency into multiple currencies favoring the one with highest rates.\n *\n * @param {number} cp - Copper\n * @param {object} [options] - Additional options\n * @param {CoinType[]} [options.omit=[]] - Omit these types from the result. Baseline currency can not be omitted.\n * @param {boolean} [options.pad=true] - Pad return value by including zeroed currencies\n * @param {boolean} [options.standard=true] - If true, no coinage of greater value than the {@link ffd20.config.currency.standard standard currency} is included.\n * @returns {Record<CoinType,number>} The various currencies.\n */\nexport function split(cp, { omit = [], standard = true, pad = true } = {}) {\n  const cc = ffd20.config.currency;\n\n  const rates = Object.entries(cc.rate)\n    .filter(([key]) => !omit.includes(key))\n    .sort((a, b) => b[1] - a[1]);\n\n  const maxRate = standard ? cc.standardRate : Infinity;\n\n  const currencies = {};\n  for (const [key, rate] of rates) {\n    if (rate > maxRate) {\n      if (pad) currencies[key] = 0;\n      continue;\n    }\n\n    const value = Math.floor(cp / rate);\n    if (value != 0 || pad) {\n      currencies[key] = value;\n      cp -= value * rate;\n    }\n  }\n\n  if (cp != 0 || pad) {\n    currencies[cc.base] = cp;\n  }\n\n  return currencies;\n}\n\n/**\n * Merges provided currencies into specified type.\n *\n * @param {object} currency - Currency object with keys according to {@link ffd20.config.currencies}\n * @param {CoinType} [type] - Return coinage, defaults to {@link ffd20.config.currency.base baseline currency}.\n * @returns {number} - Merged currency\n */\nexport function merge({ ...currency } = {}, type) {\n  const { rate: rates, base } = ffd20.config.currency;\n  type ||= ffd20.config.currency.base;\n\n  let copper = 0;\n  for (let [type, value] of Object.entries(currency)) {\n    value ??= 0;\n    if (!Number.isFinite(value)) throw new Error(`Invalid currency value \"${value}\" for type \"${type}\"`);\n    if (value == 0) continue;\n    /** @type {number|undefined} */\n    const rate = rates[type];\n    if (rate) {\n      copper += value * rate;\n    } else {\n      if (type === base) copper += value;\n      else throw new Error(`Invalid currency type: \"${type}\"`);\n    }\n  }\n\n  if (type === base) return copper;\n  return copper / rates[type];\n}\n\n/**\n * Convert given amount of copper to some other currency, excess is placed on less valuable coinage.\n *\n * @param {number} cp - Copper quantity\n * @param {CoinType} [target] - Target unit. Defaults to {@link ffd20.config.currency.standard standard currency}.\n * @param {object} [options] - Additional options\n * @param {boolean} [options.pad] - Pad return value by including zeroed currencies\n * @returns {Record<CoinType,number>} - Resulting conversion\n */\nexport function convert(cp, target, { pad = true } = {}) {\n  if (!Number.isFinite(cp) || !(cp >= 0)) throw new Error(`Invalid currency quantity: ${cp}`);\n\n  const cc = ffd20.config.currency;\n  target ||= cc.standard;\n\n  if (target !== cc.base && cc.rate[target] === undefined) throw new Error(`Invalid currency type \"${target}\"`);\n\n  const { base, rate } = cc;\n  const rates = Object.entries(rate).sort((a, b) => b[1] - a[1]);\n\n  /** @type {number} */\n  const maxRate = rate[target] ?? 1;\n\n  const currencies = {};\n  for (const [key, rate] of rates) {\n    if (rate > maxRate) {\n      if (pad) currencies[key] = 0;\n      continue;\n    }\n\n    const value = Math.floor(cp / rate);\n    if (value !== 0 || pad) {\n      currencies[key] = value;\n      cp -= value * rate;\n    }\n  }\n\n  if (cp != 0 || pad) {\n    currencies[base] = cp;\n  }\n\n  return currencies;\n}\n","/**\n * @internal\n * @typedef {RollTerm|FormulaPart} AnyTerm\n */\n\n/**\n * Removes flairs from a formula.\n *\n * @param {string} formula Formula\n * @returns {string} Stripped formula\n */\nexport const unflair = (formula) => formula.replace(/\\[[^\\]]*]/g, \"\");\n\n/**\n * Compress basic math and space in produced formula.\n *\n * @param {string} formula - Formula to compress\n * @returns {string} - Compressed formula\n */\nexport const compress = (formula) =>\n  formula\n    .replace(/\\s+/g, \"\") // remove whitespaces\n    .replace(/\\+-/g, \"-\") // + -n = -n\n    .replace(/--/g, \"+\") // - -n = +n\n    .replace(/-\\+/g, \"-\") // - +n = -n\n    .replace(/\\+\\++/g, \"+\"); // + +n = +n\n\n/**\n * @param {AnyTerm} t - Term to test\n * @returns {boolean} - Is deemed simple.\n */\nconst isSimpleTerm = (t) => t instanceof foundry.dice.terms.NumericTerm || t?.simple || false;\n\nclass FormulaPart {\n  /** @type {AnyChunk[]} */\n  terms = [];\n  simple = false;\n\n  constructor(terms = [], simple = false, evaluate = true) {\n    this.terms = terms.filter((t) => !!t);\n    this.simple = simple;\n\n    if (evaluate) this.evaluate();\n  }\n\n  get isDeterministic() {\n    return this.terms.every((t) => t.isDeterministic);\n  }\n\n  #formula;\n  get formula() {\n    if (this.#formula) return this.#formula;\n\n    const f = this.terms\n      .map((t) => {\n        if (t.isDeterministic) return `${t.total}`;\n        else if (t instanceof foundry.dice.terms.FunctionTerm) return `${t.simplify || t.expression}`;\n        // Dice eat up prefix parentheticals in v12\n        else if (\n          t instanceof foundry.dice.terms.Die &&\n          t._number instanceof Roll &&\n          t._number.terms.length == 1 &&\n          t._number.terms[0] instanceof foundry.dice.terms.ParentheticalTerm\n        ) {\n          // Simplify prefix parenthetical part of (X)dY\n          const formula = t._number.terms[0].roll.formula;\n          const iformula = simplify(formula);\n          t._number = new Roll.defaultImplementation(iformula).evaluateSync({ maximize: true });\n          return t.formula;\n        } else {\n          return t.formula;\n        }\n      })\n      .join(\"\");\n\n    const roll = new Roll.defaultImplementation(f);\n    if (roll.isDeterministic) this.#formula = roll.evaluateSync({ minimize: true }).total.toString();\n    else this.#formula = f;\n\n    return this.#formula;\n  }\n\n  _total = null;\n\n  evaluate() {\n    const roll = new Roll.defaultImplementation(this.formula).evaluateSync({ minimize: true });\n    this._total = roll.total;\n  }\n\n  get total() {\n    if (this._total === null) {\n      console.error(\"Must be evaluated first!\", this);\n      throw new Error(\"Must be evaluated first!\");\n    }\n    return this._total;\n  }\n}\n\n/**\n * Combine [\"-\", term] into single {@link FormulaPart}\n *\n * @param {AnyTerm[]} terms - Terms to handle\n * @returns {Array<AnyTerm>} - New terms\n */\nfunction negativeTerms(terms) {\n  const nterms = [];\n  while (terms.length) {\n    const term = terms.shift();\n    if (term instanceof foundry.dice.terms.OperatorTerm && term.operator === \"-\") {\n      // Add preceding + if operators are fully consumed\n      if (!(nterms.at(-1) instanceof foundry.dice.terms.OperatorTerm)) {\n        const nt = new foundry.dice.terms.OperatorTerm({ operator: \"+\" });\n        nt._evaluated = true;\n        nterms.push(nt);\n      }\n      nterms.push(new FormulaPart([term, terms.shift()], true));\n    } else nterms.push(term);\n  }\n  return nterms;\n}\n\n/**\n *\n * @param {AnyTerm[]} terms - Terms to handle\n * @returns {Array<AnyTerm>} - Reduced terms\n */\nfunction stringTerms(terms) {\n  const nterms = [];\n  while (terms.length) {\n    const term = terms.shift();\n    if (term instanceof foundry.dice.terms.StringTerm) {\n      // Partial dice terms combine left\n      if (/^d\\d/.test(term.expression)) {\n        nterms.push(new FormulaPart([nterms.pop(), term]));\n      }\n      // Rest combine right\n      else {\n        nterms.push(new FormulaPart([term, terms.shift()]));\n      }\n    } else nterms.push(term);\n  }\n  return nterms;\n}\n\n/**\n * Combine [term, operator, term] cases into singular {@link FormulaPart}\n *\n * @param {AnyTerm[]} terms - Terms to combine\n * @param {string[]} operators - Operators to look for\n * @param {boolean} simpleOnly - Only combine simple terms\n * @returns {AnyTerm[]} - Product\n */\nfunction triTermOps(terms, operators, simpleOnly = false) {\n  const eterms = [];\n  while (terms.length) {\n    const term = terms.shift();\n    if (term instanceof foundry.dice.terms.OperatorTerm && operators.includes(term.operator)) {\n      // Only combine simple terms\n      if (simpleOnly && !(isSimpleTerm(eterms.at(-1)) && isSimpleTerm(terms[0]))) {\n        // Fall through\n      }\n      // Combine all\n      else {\n        const left = eterms.pop(),\n          right = terms.shift();\n        eterms.push(new FormulaPart([left, term, right], isSimpleTerm(left) && isSimpleTerm(right)));\n        continue;\n      }\n    }\n    eterms.push(term);\n  }\n\n  return eterms;\n}\n\n/**\n * Replace 0dX with 0\n *\n * Alters terms in-place.\n *\n * @param {foundry.dice.terms.RollTerm[]} terms - Term array\n * @returns {foundry.dice.terms.RollTerm[]} - Same term array as it was given.\n */\nfunction replaceZeroDice(terms) {\n  for (let i = 0; i < terms.length; i++) {\n    const term = terms[i];\n    if (term instanceof foundry.dice.terms.Die && term.number === 0) {\n      terms.splice(i, 1, foundry.dice.terms.RollTerm.fromData({ number: 0, class: \"NumericTerm\", _evaluated: true }));\n    }\n  }\n\n  return terms;\n}\n\n/**\n * Simplifies formula to very basic level.\n *\n * @param {string} formula - Formula\n * @param {object} [rollData={}] - Roll data\n * @param {object} [options] - Additional options\n * @param {boolean} [options.strict] - Attempt to return something even slightly valid even with bad formulas\n * @returns {string} - Simpler formula\n * @throws {Error} - On invalid formula\n */\nexport function simplify(formula, rollData = {}, { strict = true } = {}) {\n  formula = compress(Roll.replaceFormulaData(unflair(formula), rollData, { missing: 0 }));\n\n  // Produce nicer formula\n  formula = Roll.defaultImplementation\n    .parse(formula)\n    .map((t) => {\n      if (t instanceof foundry.dice.terms.ParentheticalTerm) {\n        if (t.isDeterministic) {\n          // Parenthetical term doesn't have separate evaluate calls yet\n          t.evaluate({ minimize: true });\n          const v = t.total;\n          return `${v}`;\n        } else {\n          const iformula = simplify(t.roll.formula);\n          const isSingleTerm = Roll.defaultImplementation.parse(iformula).length === 1;\n          if (isSingleTerm) return iformula;\n          else return `(${iformula})`;\n        }\n      }\n      return t.formula;\n    })\n    .join(\"\");\n\n  const roll = new Roll.defaultImplementation(formula);\n\n  // Evaluate\n  try {\n    roll.evaluateSync({ minimize: true });\n  } catch (err) {\n    if (strict) throw err;\n    else return compress(formula);\n  }\n\n  // Old evaluation, fails with parenthetical terms followed by d6 or the like\n  //terms.forEach((term) => term.evaluateSync({ minimize: true }));\n  let terms = replaceZeroDice(roll.terms);\n\n  // Negatives (combine - with the following term)\n  terms = negativeTerms(terms);\n\n  // PEMDAS\n  // Foundry doesn't support juxtaposition so it's not handled here\n\n  // Exponents\n  terms = triTermOps(terms, [\"**\"]);\n  // Multiply/Divide\n  terms = triTermOps(terms, [\"/\", \"*\"]);\n  // Conditionals\n  terms = triTermOps(terms, [\"==\", \"===\", \">\", \">=\", \"<\", \"<=\", \"!=\", \"!==\"]);\n  // Plus/Minus\n  terms = triTermOps(terms, [\"+\", \"-\"], true);\n  // String terms\n  terms = stringTerms(terms);\n\n  // Make final pass\n  const final = new FormulaPart(terms, undefined, false);\n\n  return final.formula.replace(/ \\+ 0\\b/g, \"\");\n}\n\n/**\n * Get action's damage formula.\n *\n * @internal\n * @param {ItemAction} action - Action\n * @param {object} [options] - Additional options\n * @param {boolean} [options.simplify] - Simplify and compress the resulting formula before returning.\n * @param {boolean} [options.strict] - Strict option to pass to {@link ffd20.utils.formula.simplify simplify}.\n * @returns {string} - Damage string\n */\nexport function actionDamage(action, { simplify = true, strict = true } = {}) {\n  const actor = action.actor,\n    item = action.item,\n    actorData = actor?.system;\n\n  const parts = [];\n\n  const lazy = {\n    get rollData() {\n      this._cache ??= action.getRollData();\n      return this._cache;\n    },\n  };\n\n  const handleFormula = (formula, change) => {\n    try {\n      switch (typeof formula) {\n        case \"string\": {\n          // Ensure @item.level and similar gets parsed correctly\n          const rd = formula.indexOf(\"@\") >= 0 ? (change?.parent?.getRollData() ?? lazy.rollData) : {};\n          if (formula != 0) {\n            const newformula = ffd20.utils.formula.simplify(formula, rd, { strict });\n            if (newformula != 0) parts.push(newformula);\n          }\n          break;\n        }\n        case \"number\":\n          if (formula != 0) parts.push(`${formula}`);\n          break;\n      }\n    } catch (err) {\n      console.error(`Action damage formula parsing error with \"${formula}\"`, err, action);\n      parts.push(\"NaN\");\n    }\n  };\n\n  const handleParts = (parts) => parts.forEach(({ formula }) => handleFormula(formula));\n\n  // Normal damage parts\n  handleParts(action.damage.parts);\n\n  const isNatural = action.item.subType === \"natural\";\n\n  // Include ability score only if the string isn't too long yet\n  const dmgAbl = action.ability.damage;\n  if (dmgAbl) {\n    const ablMax = action.ability?.max ?? Infinity;\n    const dmgAblBaseMod = Math.min(actorData?.abilities?.[dmgAbl]?.mod ?? 0, ablMax);\n    const held = action.held || item?.system.held || \"1h\";\n    let ablDmgMult =\n      action.ability.damageMult ?? (isNatural ? null : ffd20.config.abilityDamageHeldMultipliers[held]) ?? 1;\n    if (isNatural && !(action.naturalAttack?.primary ?? true)) {\n      ablDmgMult = action.naturalAttack?.secondary?.damageMult ?? 0.5;\n    }\n\n    const dmgAblMod = dmgAblBaseMod >= 0 ? Math.floor(dmgAblBaseMod * ablDmgMult) : dmgAblBaseMod;\n    if (dmgAblMod != 0) parts.push(dmgAblMod);\n  }\n\n  // Include damage parts that don't happen on crits\n  handleParts(action.damage.nonCritParts);\n\n  // Include general sources. Item enhancement bonus is among these.\n  action.allDamageSources.forEach((s) => handleFormula(s.formula, s));\n\n  // Something probably went wrong\n  // Early exit from invalid formulas\n  if (parts.length === 0 || parts.some((p) => p === \"NaN\")) {\n    console.warn(\"Action damage resulted in invalid formula:\", parts.join(\" + \"), action);\n    return \"NaN\";\n  }\n\n  const semiFinal = ffd20.utils.formula.compress(parts.join(\"+\"));\n  if (!simplify) return semiFinal;\n\n  // Simplification turns 1d12+1d8+6-8+3-2 into 1d12+1d8-1\n  try {\n    const rollData = semiFinal.indexOf(\"@\") >= 0 ? lazy.rollData : undefined;\n    const final = ffd20.utils.formula.simplify(semiFinal, rollData, { strict });\n    return ffd20.utils.formula.compress(final);\n  } catch (err) {\n    console.error(\"Invalid action damage formula:\", parts.join(\" + \"), action, err);\n    return \"NaN\";\n  }\n}\n","/**\n * Returns the result of a roll of die, which changes based on different sizes.\n *\n * Applies size change damage progression as per Paizo's FAQ entry for it.\n *\n * @see https://paizo.com/paizo/faq/v5748nruor1fm#v5748eaic9t3f\n *\n * @param {number} origCount - The original number of die to roll.\n * @param {number} origSides - The original number of sides per die to roll.\n * @param {string|number} [targetSize=\"M\"] - The target size to change the die to.\n *   Can be a string of values \"F\", \"D\", \"T\", \"S\", \"M\", \"L\", \"H\", \"G\" or \"C\" for the different sizes.\n *   Can also be a number in the range of 0 to 8, where 4 is Medium.\n * @param {string|number} [initialSize=\"M\"] - The initial size of the creature. See targetSize above.\n * @returns {Die[]|NumericTerm[]} The resulting roll.\n */\nexport function sizeRoll(origCount, origSides, targetSize = \"M\", initialSize = \"M\") {\n  // Return NaN from invalid input\n  if (!Number.isFinite(origCount) || !Number.isFinite(origSides)) {\n    return [new foundry.dice.terms.NumericTerm({ number: NaN })];\n  }\n\n  const _getSizeIndex = (size) => {\n    if (typeof size === \"string\") return Object.values(ffd20.config.sizeChart).indexOf(size.toUpperCase());\n    return size;\n  };\n\n  targetSize = _getSizeIndex(targetSize);\n  initialSize = _getSizeIndex(initialSize);\n\n  // Do no conversion if no size change is occurring\n  if (targetSize === initialSize) {\n    // Special case for 1d1\n    if (origCount === 1 && origSides === 1) return [new foundry.dice.terms.NumericTerm({ number: 1 })];\n    return [new foundry.dice.terms.Die({ number: origCount, faces: origSides })];\n  }\n\n  // Special rules\n  // \"If the die type is not referenced on this chart\"\n  if (origCount > 1) {\n    // D10\n    if (origSides === 10) {\n      if (targetSize < initialSize) {\n        initialSize--;\n      } else {\n        origCount *= 2;\n        initialSize++;\n      }\n      origSides = 8;\n    }\n    // D4\n    else if (origSides === 4) {\n      // 2d4=1d8, 3d4=2d6, 4d4=2d8, 5d4=3d6, 6d4=3d8, etc...\n      origSides = origCount % 2 == 0 ? 8 : 6;\n      origCount = Math.floor((origCount + 1) / 2);\n    }\n  }\n\n  // D12\n  // Each d12 counts as 2d6\n  if (origSides === 12) {\n    origCount *= 2;\n    origSides = 6;\n  }\n\n  // Get initial die type\n  let currentDie = `${origCount}d${origSides}`;\n  const c = ffd20.config.sizeDie;\n\n  // \"If the exact number of original dice is not found on this chart...\"\n  if (c.indexOf(currentDie) === -1 && [6, 8].includes(origSides)) {\n    // Xd6: \"find the next lowest number of d6 on the chart and use that number of d8 as the original damage value\"\n    let shifted;\n    const fc = c.map((d) => d.split(\"d\").map((n) => Number(n)));\n    if (origSides === 6) {\n      shifted = fc.filter(([c, s]) => c < origCount && s === origSides).at(-1);\n    }\n    // Xd8: \"find the next highest number of d8 on the chart and use that number of d6 as the original damage value\"\n    else if (origSides === 8) {\n      shifted = fc.filter(([c, s]) => c > origCount && s === origSides).at(0);\n    } else {\n      // Paizo has not provided instructions how to resolve this\n    }\n\n    if (shifted) {\n      const [count, sides] = shifted;\n      // Swap d6 to d8 and vice versa\n      const newSides = sides === 6 ? 8 : 6;\n      currentDie = `${count}d${newSides}`;\n    }\n  }\n\n  // Pick an index from the chart\n  let index = c.indexOf(currentDie);\n  if (index === -1 && currentDie === \"1d1\") index = 0;\n  let formula = currentDie;\n  // If found, shift size\n  if (index >= 0) {\n    const d6Index = c.indexOf(\"1d6\");\n    const d8Index = c.indexOf(\"1d8\");\n    let sizeOffset = initialSize - targetSize;\n    let curSize = initialSize;\n\n    // When decreasing in size (e.g. from medium to small)\n    while (sizeOffset > 0) {\n      if (curSize <= 4 || index <= d8Index) {\n        index--;\n        sizeOffset--;\n        curSize--;\n      } else {\n        index -= 2;\n        sizeOffset--;\n        curSize--;\n      }\n    }\n    // When increasing in size (e.g. from medium to large)\n    while (sizeOffset < 0) {\n      if (curSize <= 3 || index <= d6Index) {\n        index++;\n        sizeOffset++;\n        curSize++;\n      } else {\n        index += 2;\n        sizeOffset++;\n        curSize++;\n      }\n    }\n\n    index = Math.max(0, Math.min(c.length - 1, index));\n    formula = c[index];\n  }\n\n  if (index === -1) {\n    ui.notifications.warn(game.i18n.format(\"FFD20.Warning.NoSizeDie\", { fallback: currentDie, formula }));\n  }\n\n  const [number, faces] = formula.split(\"d\").map((n) => parseInt(n));\n  if (!faces || (number === 1 && faces === 1)) {\n    return [new foundry.dice.terms.NumericTerm({ number })];\n  }\n  return [new foundry.dice.terms.Die({ number, faces })];\n}\n\n/**\n * `sizeReach()` roll function handler.\n *\n * Return reach information for defined size and stature.\n *\n * @param {string|number} [size=\"M\"] FFD20.sizeChart key or offset\n * @param {boolean} [reach=false] Reach weapon\n * @param {\"tall\"|\"long\"} [stature=\"tall\"] Character stature\n * @returns {number} -\n */\nexport const sizeReach = (size = \"M\", reach = false, stature = \"tall\") => {\n  if (typeof size === \"number\") size = Object.values(ffd20.config.sizeChart)[size];\n  size = Object.entries(ffd20.config.sizeChart).find((o) => o[1] === size)[0];\n\n  return ffd20.documents.actor.ActorPF.getReach(size, stature)[reach ? \"reach\" : \"melee\"];\n};\n\n/**\n * `sizeRoll()` roll function handler.\n *\n * @internal\n * @param {number} count - Number of dice\n * @param {number} sides - Number of sides\n * @param {number|string} target - Target size\n * @param {number|string} initial - Initial size\n * @returns {number} - Ignore. Placeholder number.\n */\nfunction sizeRollFn(count, sides, target, initial) {\n  /** @type {Die[]|NumericTerm[]} */\n  const [rt] = sizeRoll(count, sides, target, initial);\n\n  this.terms.push(rt.formula);\n\n  if (rt instanceof foundry.dice.terms.Die) {\n    const roll = Roll.defaultImplementation.fromTerms([rt]);\n    roll.options.final = true;\n    this.rolls.push(roll);\n    return 0; // The roll can not be evaluated here due to lacking eval opts.\n  }\n  // NumericTerm\n  else {\n    return rt.number;\n  }\n}\n\n/**\n * `if-else` roll function\n *\n * Syntax:\n * ifelse(condition, if-true, if-else)\n *\n * @example\n * ```txt\n * ifelse(@powerAttackPenalty, 4, 0)\n * ```\n *\n * @param {*} condition - Condition\n * @param {*} ifTrue - Result if condition is true\n * @param {*} ifFalse - Result if condition is false\n * @returns {number} - Result\n */\nfunction ifelse(condition, ifTrue, ifFalse) {\n  return condition ? ifTrue : ifFalse;\n}\n\n/**\n * `if` roll function\n *\n * Alias for ifelse() with last parameter defaulting to 0.\n *\n * @param {*} condition - Condition\n * @param {*} ifTrue - Result if condition is true\n * @returns {number} - Result\n */\nfunction _if(condition, ifTrue) {\n  return ifelse(condition, ifTrue, 0);\n}\n\n/**\n * `lookup` roll function\n *\n * Syntax:\n * lookup(condition, fallback, ...results)\n *\n * @example\n * ```txt\n * lookup(1d4, 0, 4, 3, 2, 1)\n * lookup(@cl, 0, 3, 2, 1)\n * ```\n *\n * @param {number} condition - Condition\n * @param {number} fallback - Fallback if the condition goes out of range\n * @param  {...any} results - Potential results\n * @returns {number} - Result\n */\nfunction lookup(condition, fallback, ...results) {\n  // TODO: mark die terms disabled that are not in the end result\n  return results[condition - 1] ?? fallback;\n}\n\n/**\n * Roll functions\n *\n * @example\n * ```js\n * eq(a,b) // equal (a === b)\n * ne(a,b) // not equal (a !== b)\n * lt(a,b) // less than (a < b)\n * lte(a,b) // less than or equal (a <= b)\n * gt(a,b) // greater than (a > b)\n * gte(a,b) // greater than or equal (a >= b)\n * and(a, b, ...) // all true\n * or(a, b, ...) // some true\n * xor(a, b, ...) // one true\n * not(a) // not (!a)\n * ```\n */\nexport const functions = {\n  sizeRoll: sizeRollFn,\n  sizeReach,\n  lookup,\n  ifelse,\n  if: _if,\n  eq: (a, b) => (a === b ? 1 : 0),\n  ne: (a, b) => (a !== b ? 1 : 0),\n  lt: (a, b) => (a < b ? 1 : 0),\n  lte: (a, b) => (a <= b ? 1 : 0),\n  gt: (a, b) => (a > b ? 1 : 0),\n  gte: (a, b) => (a >= b ? 1 : 0),\n  and: (...args) => (args.every((a) => !!a) ? 1 : 0),\n  or: (...args) => (args.some((a) => !!a) ? 1 : 0),\n  xor: (...args) => (args.filter((a) => !!a).length == 1 ? 1 : 0),\n  not: (a) => !a,\n};\n","/**\n * Initialize `CONFIG.statusEffects`\n *\n * @returns {Array<object>} - Status effects array\n */\nexport function getConditions() {\n  const core = CONFIG.statusEffects.filter((c) => c.id !== \"dead\");\n  let sys = ffd20.registry.conditions.map((condition) => {\n    const status = condition.toStatusEffect();\n\n    // Copy of Foundry's deprecation code\n    for (const [oldKey, newKey] of Object.entries({ label: \"name\", icon: \"img\" })) {\n      const msg = `StatusEffectConfig#${oldKey} has been deprecated in favor of StatusEffectConfig#${newKey}`;\n      Object.defineProperty(status, oldKey, {\n        get() {\n          foundry.utils.logCompatibilityWarning(msg, { since: 12, until: 14, once: true });\n          return this[newKey];\n        },\n        set(value) {\n          foundry.utils.logCompatibilityWarning(msg, { since: 12, until: 14, once: true });\n          this[newKey] = value;\n        },\n        enumerable: false,\n        configurable: true,\n      });\n    }\n\n    return status;\n  });\n\n  if (game.settings.get(\"ffd20\", \"coreEffects\")) sys.push(...core);\n\n  sys.sort((a, b) => a.name.localeCompare(b.name));\n\n  const deadCond = sys.findSplice((c) => c.id === \"dead\");\n  sys = [deadCond, ...sys];\n\n  return sys;\n}\n","/**\n * Add static helper data to roll data.\n *\n * Static data:\n * - `@step`: 5 (represents single step which is always 5 internally, even if it can be 1.5m in the final result)\n *\n * @param {object} rollData - Roll data to modify\n */\nexport function addStatic(rollData) {\n  rollData.step = 5;\n}\n","/**\n * Convert string array into joined string according to current language.\n *\n * @param {Array<string>} strings - Array of strings to join\n * @param {\"c\"|\"d\"|\"u\"} type - conjunction = and, disjunction = or, unit = neither. Only the first letter matters.\n * @param {boolean} short - If true, effectively same as type being set to \"u\"\n * @returns {string} - Formatted string of all traits.\n */\nexport function join(strings, type = \"u\", short = true) {\n  type = {\n    c: \"conjunction\",\n    d: \"disjunction\",\n    u: \"unit\",\n  }[type[0]];\n\n  return new Intl.ListFormat(game.i18n.lang, { style: short ? \"short\" : \"long\", type }).format(strings);\n}\n\nexport const numberFormat = new Intl.NumberFormat(undefined).format;\n","/**\n * Fetch mapping of class identifier to class name.\n *\n * @returns {Record<string,string>}\n */\nexport async function getClassIDMap() {\n  if (this.classIDMap) return this.classIDMap;\n\n  const packTypePriority = {\n    world: 4_000,\n    module: 3_000,\n    system: 2_000,\n  };\n\n  // Sort packs by above criteria, higher priority last so they override earlier entries\n  let packs = [...game.packs]\n    .map((p) => ({\n      pack: p,\n      visible: p.visible ?? true,\n      disabled: p.config.ffd20?.disabled ?? false,\n      sort: packTypePriority[p.metadata.packageType],\n    }))\n    .filter((p) => !p.disabled && p.visible && p.pack.metadata.type === \"Item\")\n    .sort((a, b) => a.sort - b.sort);\n\n  await Promise.all(packs.map((p) => p.pack.getIndex({ fields: [\"system.tag\", \"system.subType\"] })));\n\n  // Only take packs with Just classes, assume first item being class is good enough for this\n  packs = packs.filter((p) => p.pack.index.size > 0 && [...p.pack.index][0]?.type === \"class\");\n\n  const classes = {};\n\n  for (const { pack } of packs) {\n    for (const entry of pack.index) {\n      if (entry.system?.subType && ![\"base\", \"npc\"].includes(entry.system?.subType)) continue;\n\n      const tag = entry.system?.tag;\n      if (!tag) continue;\n\n      classes[tag] = entry.name;\n    }\n  }\n\n  this.classIDMap = classes;\n  return classes;\n}\n","import { NoAutocomplete } from \"@app/mixins/no-autocomplete.mjs\";\n\nconst { HandlebarsApplicationMixin, ApplicationV2 } = foundry.applications.api;\n\n/**\n * Party Rest Configuration Dialog\n */\nexport class PartyRestConfig extends HandlebarsApplicationMixin(NoAutocomplete(ApplicationV2)) {\n  constructor(config, options) {\n    super(options);\n\n    config.hours ??= null;\n    this.restConfig = config;\n\n    this.constructor._prepareActors(config);\n\n    this.constructor._calculateHours(config, config.hours === null);\n  }\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    form: {\n      handler: this._onSubmit,\n      submitOnChange: true,\n      closeOnSubmit: false,\n    },\n    classes: [\"pf1-v2\", \"party-rest\", \"standard-form\"],\n    window: {\n      title: \"FFD20.Application.XPDistributor.Title\",\n      minimizable: false,\n      resizable: true,\n    },\n    actions: {\n      rest: this._onRest,\n      toggle: this._onToggleCategory,\n      sheet: { handler: this._onOpenSheet, buttons: [2] }, // 2: Context menu\n    },\n    position: {\n      width: 500,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/party-rest.hbs\",\n    },\n    footer: {\n      template: \"templates/generic/form-footer.hbs\",\n    },\n  };\n\n  static _prepareActors(config) {\n    const { longTermCare, restoreHealth, restoreUses, restOptions } = config;\n\n    config.actors = config.actors\n      .map((a) => {\n        if ([\"haunt\", \"vehicle\", \"trap\"].includes(a.type)) return null;\n\n        const conscious = this._isConscious(a);\n        return {\n          name: a.token?.name || a.name,\n          img: a.token?.img || a.prototypeToken?.texture?.src || a.img,\n          uuid: a.uuid,\n          conscious,\n          watch: conscious,\n          options: {\n            ...restOptions,\n            longTermCare,\n            restoreHealth,\n            restoreUses,\n          },\n        };\n      })\n      .filter((a) => !!a);\n  }\n\n  static _isConscious(actor) {\n    /** @type {ffd20.applications.settings.HealthConfigModel} */\n    const hpConfig = game.settings.get(\"ffd20\", \"healthConfig\");\n    const actorHpConfig = hpConfig.getActorConfig(this.actor);\n\n    const vigor = actorHpConfig.rules.useWoundsAndVigor;\n\n    // TODO: Wounds & Vigor\n    if (vigor) {\n      const hp = actor.system.attributes.wounds;\n      return hp.value >= hp.threshold;\n    }\n    // normal health\n    else {\n      const hp = actor.system.attributes.hp;\n      return hp.value + hp.temp >= 0;\n    }\n  }\n\n  static _calculateHours(config, updateTime = true) {\n    const nowatch = config.watches === \"none\";\n    const duo = config.watches === \"duo\";\n    const solo = !duo;\n\n    // Count watchers and pretend zero watchers results in math related to single person sleeping\n    const active = nowatch ? 1 : Math.max(1, config.actors.filter((a) => a.watch).length);\n\n    const cfg = ffd20.config.partyRest[active] ?? Object.values(ffd20.config.partyRest).at(-1);\n\n    let hours = config.hours;\n    // Skip time update if it was manually adjusted\n    if (updateTime) {\n      if (solo) hours = cfg.hours;\n      else hours = cfg.double ?? cfg.hours;\n      config.hours = hours;\n    }\n\n    // Set time needed per watch\n    if (active > 1) {\n      const watchTime = Math.clamp(hours, 0, 24);\n      config.watchTime = watchTime / (solo ? active : Math.floor(active / 2));\n    } else {\n      config.watchTime = 0;\n    }\n\n    // Check if double watches are available for this group with this many watchers\n    config.duo = cfg.double ?? false;\n    if (!config.duo && duo) config.watches = \"solo\";\n  }\n\n  get title() {\n    return game.i18n.localize(\"FFD20.Application.PartyRest.Title\");\n  }\n\n  /** @override */\n  _prepareContext() {\n    const config = this.restConfig;\n\n    return {\n      id: this.id,\n      ...config,\n      buttons: [\n        {\n          type: \"button\",\n          label: \"FFD20.Rest\",\n          icon: \"fa-solid fa-bed\",\n          action: \"rest\",\n        },\n      ],\n    };\n  }\n\n  /**\n   * Toggle rest category for all participants.\n   *\n   * @param {Event} event - Click event\n   * @param {Element} el - Clicked element\n   */\n  static _onToggleCategory(event, el) {\n    const config = this.restConfig;\n\n    const toggle = el.dataset.toggle;\n    const isWatch = toggle === \"watch\";\n    const state = config.actors.some((a) => (isWatch ? !a.watch : !a.options[toggle]));\n    config.actors.forEach((a) => {\n      if (isWatch) a.watch = state;\n      else a.options[toggle] = state;\n    });\n\n    if (isWatch) this.constructor._calculateHours(config);\n\n    this.render();\n  }\n\n  /**\n   * Rest button handler\n   *\n   * @param {Event} event - Click event\n   * @param {Element} _el - Clicked element\n   */\n  static async _onRest(event, _el) {\n    event.pf1NoRender = true;\n\n    // Ensure current state is submitted\n    await this._onSubmitForm(this.options.form, event);\n\n    const config = this.restConfig;\n\n    // Disable inputs\n    const content = this.element.querySelector(\".window-content\");\n    content.classList.add(\"resting\");\n    for (const el of content.querySelectorAll(\"input,button\")) {\n      el.disabled = true;\n    }\n\n    const rv = await this.constructor._performRest(config);\n    if (rv !== false) {\n      ui.notifications.info(\n        game.i18n.format(\"FFD20.Application.PartyRest.Rested\", {\n          people: config.actors.length,\n          hours: ffd20.utils.limitPrecision(config.hours, 1),\n        })\n      );\n    } else {\n      config.cancelled = true;\n    }\n    this.resolve(config);\n    this.close();\n  }\n\n  /**\n   * Perform rest on each individual actor\n   *\n   * @internal\n   * @param {object} config - Rest configuration\n   * @returns {Promise<boolean|void>} - False if cancelled, nothing otherwise.\n   */\n  static async _performRest(config) {\n    if (Hooks.call(\"pf1PrePartyRest\", config) === false) return false;\n\n    const { actors, hours } = config;\n\n    const promises = [];\n    for (const actorData of actors) {\n      const { restoreHealth, restoreUses, longTermCare, ...options } = actorData.options;\n      const actor = fromUuidSync(actorData.uuid);\n      if (!actor) continue;\n      const p = actor.performRest({ ...options, restoreHealth, restoreDailyUses: restoreUses, longTermCare });\n      promises.push(p);\n    }\n\n    await Promise.allSettled(promises);\n\n    if (hours > 0 && game.user.isGM) await game.time.advance(Math.floor(hours * 3_600));\n\n    Hooks.callAll(\"pf1PartyRest\", config);\n  }\n\n  /**\n   * @param {Event} event - Triggering event\n   * @param {Element} form - Form element\n   * @param {FormDataExtended} formData - Form data\n   */\n  static _onSubmit(event, form, formData) {\n    const config = this.restConfig;\n\n    formData = foundry.utils.expandObject(formData.object);\n    formData.actors = Object.values(formData.actors).map((a, idx) => foundry.utils.mergeObject(config.actors[idx], a));\n    foundry.utils.mergeObject(config, formData);\n\n    this.constructor._calculateHours(config, event.target.name !== \"hours\");\n\n    if (event.pf1NoRender !== true) this.render();\n  }\n\n  /**\n   * @override\n   */\n  close(...args) {\n    super.close(...args);\n    this.resolve(null);\n  }\n\n  /**\n   * @internal\n   * @param {Event} event - Click event\n   * @param {Element} target - Target element\n   */\n  static _onOpenSheet(event, target) {\n    fromUuidSync(target.dataset.actorUuid).sheet.render(true);\n  }\n\n  static async quickRest({\n    actors = [],\n    hours,\n    restoreUses = true,\n    restoreHealth = true,\n    longTermCare = true,\n    restOptions = {},\n    watches = \"none\",\n  } = {}) {\n    const config = { actors, hours, restoreUses, restoreHealth, longTermCare, restOptions, watches };\n\n    this._prepareActors(config);\n\n    this._calculateHours(config, hours === undefined);\n\n    await this._performRest(config);\n\n    return config;\n  }\n\n  static async open(options) {\n    return new Promise((resolve) => {\n      const rd = new PartyRestConfig(options);\n      rd.resolve = resolve;\n      rd.render(true, { focus: true });\n    });\n  }\n}\n\n/**\n * Rest Party\n *\n * Time is passed if used by the GM.\n *\n * @param {options} options - Additional options\n * @param {Actor[]} options.actors - Actors to rest\n * @param {boolean} [options.watches=true] - People keep watch shifts.\n * @param {number} [options.hours=null] - How many hours to rest.\n * @param {boolean} [options.restoreHealth] - Restore health\n * @param {boolean} [options.restoreUses] - Restore daily uses\n * @param {boolean} [options.longTermCare] - Apply long term care\n * @param {object} [options.restOptions] - Additional options to pass to {@link ActorPF.performRest}\n * @returns {object|null} - Object with configuration resting was performed with, null if cancelled.\n */\nexport async function rest({\n  actors = [],\n  watches = true,\n  hours = null,\n  restoreHealth = true,\n  restoreUses = true,\n  longTermCare = false,\n  skipDialog = false,\n  restOptions = {},\n} = {}) {\n  actors = actors.filter((a) => a instanceof Actor && a.isOwner);\n  if (actors.length == 0) throw new Error(\"No valid actors chosen to rest\");\n\n  if (typeof watches === \"boolean\") watches = watches ? \"solo\" : \"none\";\n\n  if (skipDialog) {\n    return PartyRestConfig.quickRest({ actors, hours, restoreUses, restoreHealth, longTermCare, restOptions });\n  } else {\n    return PartyRestConfig.open({ actors, watches, hours, restoreUses, restoreHealth, longTermCare, restOptions });\n  }\n}\n","import { RollPF } from \"@dice/roll.mjs\";\n\n/**\n * Creates a tag from a string.\n *\n * @example\n * ```js\n * ffd20.utils.createTag(\"Wizard of Oz 2\"); // => \"wizardOfOz2\"\n * ffd20.utils.createTag(\"Wizard of Oz 2\", {camelCase:false}); // => wizardofoz2\n * ffd20.utils.createTag(\"Wizard of Oz 2\", {camelCase:false,allowUpperCase:true}); // => WizardofOz2\n * ffd20.utils.createTag(\"d'Artagnan\"); // => dartagnan\n * ffd20.utils.createTag(\"d'Artagnan\", {allowUpperCase:true}); // => dArtagnan\n * ```\n *\n * @param {string} str - String to convert\n * @param {object} [options] - Additional options\n * @param {boolean} [options.allowUpperCase=false] - Do not forcibly lowercase everything.\n * @param {boolean} [options.camelCase=true] - Automatic camel case\n * @param {string | Function} [options.replacement=\"\"] - Replacement for disallowed characters.\n * @param {boolean} [options.allowInitialNumbers=false] - If false, number prefix is removed.\n * @param {boolean} [options.allowUnderScore=true] - If false, underscore is removed.\n * @returns {string} - String suitable as a tag\n */\nexport function createTag(\n  str,\n  {\n    allowUpperCase = false,\n    camelCase = true,\n    replacement = \"\",\n    allowInitialNumbers = false,\n    allowUnderScore = true,\n  } = {}\n) {\n  if (!str) return \"\";\n\n  str = str\n    .normalize(\"NFD\") // Normalize\n    .replace(/\\p{Diacritic}/gu, \"\") // Remove diacritics\n    .replace(/[^a-zA-Z0-9_\\s]/g, replacement) // Replace remaining non-latin letters\n    // Camel case and such\n    .split(/\\s+/)\n    .map((s, a) => {\n      if (!allowUpperCase) s = s.toLowerCase();\n      if (a > 0 && camelCase) s = s.substring(0, 1).toUpperCase() + s.substring(1);\n      return s;\n    })\n    .join(\"\");\n\n  if (!allowUnderScore) str = str.replaceAll(\"_\", \"\");\n\n  // Remove number prefix\n  if (!allowInitialNumbers) str = str.replace(/^\\d+/, \"\");\n\n  return str;\n}\n\n/**\n * Turn some fractional numbers into pretty strings.\n *\n * @remarks\n * - Only supports the following fractions: 1/4, 1/3, 1/2, 2/3, 3/4\n *\n * @param {number} n - Number to transform\n * @returns {string} - Representation of the fraction\n */\nexport const fractionalToString = (n) => {\n  const base = Math.floor(n);\n  const f = ffd20.utils.limitPrecision(n - base, 3, \"round\");\n  if (f === 0) return `${base}`;\n  const rv = [];\n  if (base !== 0) rv.push(base);\n  if (f === 0.25) rv.push(\"1/4\");\n  else if (f === 0.333) rv.push(\"1/3\");\n  else if (f === 0.5) rv.push(\"1/2\");\n  else if (f === 0.667) rv.push(\"2/3\");\n  else if (f === 0.75) rv.push(\"3/4\");\n  return rv.join(\" \");\n};\n\n/**\n * Challenge Rating helper functions.\n */\nexport class CR {\n  /**\n   * Parse CR string to produce a numeric representation\n   *\n   * Parses 1/8, 1/6, 1/4, 1/3, and 1/2 as exact decimals. Everything else is treated as regular number string and passed through parseFloat().\n   *\n   * @param {string} value - String to transform\n   * @returns {number} - Transformed number\n   */\n  static fromString(value) {\n    if (value === \"1/8\") return 0.125;\n    if (value === \"1/6\") return 0.1625;\n    if (value === \"1/4\") return 0.25;\n    if (value === \"1/3\") return 0.3375;\n    if (value === \"1/2\") return 0.5;\n    return parseFloat(value);\n  }\n\n  /**\n   * Convert number to string representation.\n   *\n   * @param {number} value - Number to transform\n   * @returns {string} - String representation\n   */\n  static fromNumber(value = 0) {\n    if (value === 0.125) return \"1/8\";\n    if (value === 0.1625) return \"1/6\";\n    if (value === 0.25) return \"1/4\";\n    if (value === 0.3375) return \"1/3\";\n    if (value === 0.5) return \"1/2\";\n    if (!Number.isNumeric(value)) return \"0\";\n    return value?.toString() ?? \"\";\n  }\n\n  /**\n   * Return the amount of experience granted by killing a creature of a certain CR.\n   *\n   * @param {number} cr - The creature's challenge rating\n   * @returns {number|null} - The amount of experience granted per kill. Or null if the CR was invalid.\n   */\n  static getXP(cr) {\n    if (cr < 1.0) return Math.floor(Math.max(400 * cr, 0));\n    return ffd20.config.CR_EXP_LEVELS[cr] || null;\n  }\n}\n\n/**\n * Converts feet to what the world is using as a measurement unit.\n *\n * @example\n * With metric enabled\n * ```js\n * ffd20.utils.convertDistance(30); // => [9, \"m\"]\n * ```\n *\n * @param {number} value - The value (in feet) to convert.\n * @param {\"ft\"|\"mi\"} type - The original type to convert from. Either 'ft' (feet, default) or 'mi' (miles, in which case the result is in km (metric))\n * @returns {Array.<number, string>} An array containing the converted value in index 0 and the new unit key in index 1 (for use in FFD20.measureUnits, for example)\n */\nexport const convertDistance = (value, type = \"ft\") => {\n  const system = getDistanceSystem();\n  switch (system) {\n    case \"metric\":\n      switch (type) {\n        case \"mi\":\n          return [Math.round(value * 1.6 * 100) / 100, \"km\"];\n        default:\n          return [Math.round((value / 5) * 1.5 * 100) / 100, \"m\"];\n      }\n    default:\n      if (![\"ft\", \"mi\"].includes(type)) type = \"ft\";\n      return [value, type];\n  }\n};\n\n/**\n * Converts what the world is using as a measurement unit to feet.\n *\n * @param {number} value - The value (in the world's measurement unit) to convert back.\n * @param {string} type - The target type to convert back to. Either 'ft' (feet, default) or 'mi' (miles, in which case the expected given value should be in km (metric))\n * @returns {number} The resulting value.\n */\nexport const convertDistanceBack = (value, type = \"ft\") => {\n  const system = getDistanceSystem();\n  switch (system) {\n    case \"metric\":\n      switch (type) {\n        case \"mi\":\n          return [Math.round((value / 1.6) * 100) / 100, \"mi\"];\n        default:\n          return [Math.round(((value * 5) / 1.5) * 100) / 100, \"ft\"];\n      }\n    default:\n      return [value, type];\n  }\n};\n\n/**\n * Convert feet or meters distance to the opposite regardless of what configuration is used.\n *\n * @example\n * ```js\n * ffd20.utils.swapDistance(30, \"ft\"); // => 9\n * ffd20.utils.swapDistance(9, \"m\"); // => 30\n * ```\n * @param {number} value - Feet or meters\n * @param {\"ft\"|\"m\"} type - Type the value is in\n * @throws {Error} - On invalid parameters.\n * @returns {number} - Feet or meters, opposite of what set type was\n */\nexport function swapDistance(value, type) {\n  if (!Number.isFinite(value)) throw new Error(\"value parameter must be a number\");\n  switch (type) {\n    case \"ft\":\n      return Math.round(((value * 100) / 5) * 1.5) / 100; // to meters\n    case \"m\":\n      return Math.round(((value * 100) / 1.5) * 5) / 100; // to feet\n    default:\n      throw new Error(\"type parameter must be defined\");\n  }\n}\n\n/**\n * Convert pounds or kilograms weight to the opposite regardless of what configuration is used.\n *\n * @example\n * ```js\n * ffd20.utils.swapWeight(5, \"kg\"); // => 10\n * ffd20.utils.swapWeight(10, \"lbs\"); // => 5\n * ```\n * @param {number} value - Pounds or kilos\n * @param {\"kg\"|\"lbs\"} type - Type the value is in\n * @throws {Error} - On invalid parameters.\n * @returns {number} - Pounds or kilos, opposite of what set type was\n */\nexport function swapWeight(value, type) {\n  if (!Number.isFinite(value)) throw new Error(\"value parameter must be a number\");\n  switch (type) {\n    case \"kg\":\n      return value * 2; // to lbs\n    case \"lbs\":\n      return value / 2; // to kg\n    default:\n      throw new Error(\"type parameter must be defined\");\n  }\n}\n\n/**\n * Calculate overland speed per hour\n *\n * @see {@link https://www.aonprd.com/Rules.aspx?Name=Movement&Category=Exploration Exploration Movement rules}\n *\n * @example\n * With metric metric enabled\n * ```js\n * overlandSpeed(9); // => {speed:6, unit:'km'}\n * ```\n * With imperial\n * ```js\n * overlandSpeed(40); // => {speed:4, unit:'mi'}\n * ```\n *\n * @param {number} speed - Tactical speed\n * @returns {{speed:number,unit:string}} - Object with overland speed and unit.\n */\nexport function overlandSpeed(speed) {\n  const system = getDistanceSystem();\n  const variant = system === \"metric\" ? game.settings.get(\"ffd20\", \"overlandMetricVariant\") : \"default\";\n  const { per, out, unit } = ffd20.config.overlandSpeed[system][variant];\n\n  return { speed: (speed / per) * out, unit };\n}\n\n/**\n * @returns {UnitSystem} Effective system of units\n */\nexport const getDistanceSystem = () => {\n  let system = game.settings.get(\"ffd20\", \"distanceUnits\"); // override\n  if (system === \"default\") system = game.settings.get(\"ffd20\", \"units\");\n  return system;\n};\n\n/**\n * @returns {UnitSystem} Effective system of units\n */\nexport const getWeightSystem = () => {\n  let system = game.settings.get(\"ffd20\", \"weightUnits\"); // override\n  if (system === \"default\") system = game.settings.get(\"ffd20\", \"units\");\n  return system;\n};\n\n/**\n * @typedef Point\n * @property {number} x X coordinate\n * @param {number} y Y coordinate\n */\n\n/**\n * @typedef MeasureState\n * @param {number} diagonals Number of diagonals passed so far.\n * @param {number} cells Total cells in distance\n */\n\n/**\n * Measure distance between two points.\n *\n * @deprecated\n * @example\n * ```js\n * ffd20.utils.measureDistance(token, game.user.targets.first());\n * ```\n * @param {Point} p0 - Start point on canvas\n * @param {Point} p1 - End point on canvas\n * @param {object} [options] - Measuring options.\n * @param {\"5105\"|\"555\"} [options.diagonalRule=\"5105\"] - Used diagonal rule. Defaults to 5/10/5 PF measuring.\n * @param {Ray} [options.ray=null] - Pre-generated ray to use instead of the points.\n * @param {MeasureState} [options.state] - Optional state tracking across multiple measures.\n * @returns {number} - Grid distance between the two points.\n */\nexport const measureDistance = (\n  p0,\n  p1,\n  { ray = null, diagonalRule = \"5105\", state = { diagonals: 0, cells: 0 } } = {}\n) => {\n  foundry.utils.logCompatibilityWarning(\n    \"ffd20.utils.measureDistance() is deprecated in favor of canvas.grid.measurePath()\",\n    {\n      since: \"PF1 v11\",\n      until: \"PF1 v12\",\n    }\n  );\n\n  // TODO: Optionally adjust start and end point to closest grid\n  ray ??= new Ray(p0, p1);\n  const gs = canvas.dimensions.size,\n    nx = Math.ceil(Math.abs(ray.dx / gs)),\n    ny = Math.ceil(Math.abs(ray.dy / gs));\n\n  // Get the number of straight and diagonal moves\n  const nDiagonal = Math.min(nx, ny),\n    nStraight = Math.abs(ny - nx);\n\n  state.diagonals += nDiagonal;\n\n  let cells = 0;\n  // Standard Pathfinder diagonals: double distance for every odd.\n  if (diagonalRule === \"5105\") {\n    const nd10 = Math.floor(state.diagonals / 2) - Math.floor((state.diagonals - nDiagonal) / 2);\n    cells = nd10 * 2 + (nDiagonal - nd10) + nStraight;\n  }\n  // Equal distance diagonals\n  else cells = nStraight + nDiagonal;\n\n  state.cells += cells;\n  return cells * canvas.dimensions.distance;\n};\n\n/**\n * Converts lbs to what the world is using as a measurement unit.\n *\n * @param {number} value - The value (in lbs) to convert.\n * @returns {number} The converted value. In the case of the metric system, converts to kg.\n */\nexport const convertWeight = (value) => {\n  const system = getWeightSystem();\n  switch (system) {\n    case \"metric\":\n      // 1 kg is not exactly 2 lb but this conversion is officially used by Paizo/BBE\n      return value / 2;\n    default:\n      return value;\n  }\n};\n\n/**\n * Converts back to lbs from what the world is using as a measurement unit.\n *\n * @example\n * With metric enabled\n * ```js\n * ffd20.utils.convertWeightBack(10); // => 20\n * ```\n * With default imperial\n * ```js\n * ffd20.utils.convertWeightBack(10); // => 10\n * ```\n *\n * @param {number} value - The value to convert back to lbs.\n * @returns {number} The converted value. In the case of the metric system, converts from kg.\n */\nexport const convertWeightBack = (value) => {\n  const system = getWeightSystem();\n  switch (system) {\n    case \"metric\":\n      return value * 2; // 1 kg is not exactly 2 lb but this conversion is officially used by Paizo/BBE\n    default:\n      return value;\n  }\n};\n\n/**\n * Sort an array in-place using a language-aware comparison function that can sort by a property key.\n * If no property key is provided, the array is sorted directly.\n *\n * @template T\n * @param {T[]} arr The array to sort\n * @param {string} [propertyKey=\"\"] The property key to sort by, if any; can be a dot-separated path\n * @param {object} [sortOptions] - Options affecting the sorting of elements\n * @param {boolean} sortOptions.numeric - Whether numeric collation should be used, such that \"1\" < \"2\" < \"10\".\n * @param {boolean} sortOptions.ignorePunctuation - Whether punctuation should be ignored.\n * @returns {T[]} The sorted array\n */\nexport const naturalSort = (arr, propertyKey = \"\", { numeric = true, ignorePunctuation = false } = {}) => {\n  const collator = new Intl.Collator(game.settings.get(\"core\", \"language\"), { numeric, ignorePunctuation });\n  return arr.sort((a, b) => {\n    const propA = propertyKey ? (propertyKey in a ? a[propertyKey] : foundry.utils.getProperty(a, propertyKey)) : a;\n    const propB = propertyKey ? (propertyKey in b ? b[propertyKey] : foundry.utils.getProperty(b, propertyKey)) : b;\n    return collator.compare(propA, propB);\n  });\n};\n\n/**\n * Opens journal or journal page.\n *\n * Pages are opened in collapsed state.\n *\n * @param {string} uuid - UUID to journal or journal page\n * @param {object} [options={}] - Additional rendering options\n * @returns {JournalEntry|JournalEntryPage|null} - Opened document\n */\nexport async function openJournal(uuid, options = {}) {\n  const journal = await fromUuid(uuid);\n\n  if (journal instanceof JournalEntryPage) {\n    journal.parent.sheet.render(true, {\n      pageId: journal.id,\n      editable: false,\n      collapsed: true,\n      width: 600,\n      height: 700,\n      ...options,\n    });\n  } else {\n    journal.sheet.render(true, { editable: false, ...options });\n  }\n\n  return journal;\n}\n\n/**\n * A simple binary search to be used on sorted arrays\n *\n * @internal\n * @template T\n * @param {T[]} searchArr - Sorted Array to be searched\n * @param {T} el - Element to be compared to array values\n * @param {function(T, T): number} compare_fn - Comparison function to be apply el to every element in ar. Should return an positive/ negative integer or 0 if matching.\n * @returns {number} Index where search is found or negative index indicating where it would be inserted\n */\nexport const binarySearch = (searchArr, el, compare_fn) => {\n  let m = 0,\n    n = searchArr.length - 1;\n  while (m <= n) {\n    const k = (n + m) >> 1,\n      cmp = compare_fn(el, searchArr[k]);\n    if (cmp > 0) {\n      m = k + 1;\n    } else if (cmp < 0) {\n      n = k - 1;\n    } else {\n      return k;\n    }\n  }\n  return -m - 1;\n};\n\n/**\n * Generate permutations of an array. Complexity is O(n!).\n * Should be safe up to 7, though you should probably consider something else if you're reaching that high often.\n *\n * @internal\n * @template T\n * @param {T[]} perm - The Array to be generated upon\n * @returns {Array.<T[]>|false} An Array containing all Array permutations or false if failed.\n */\nfunction uniquePermutations(perm) {\n  perm = perm.map((p) => p.trim()).filter((p) => p?.length > 0);\n\n  if (perm.length > 7) {\n    console.warn(\"Array too large. Not attempting.\", perm);\n    return false;\n  }\n\n  const total = new Set();\n\n  for (let i = 0; i < perm.length; i = i + 1) {\n    const rest = uniquePermutations(perm.slice(0, i).concat(perm.slice(i + 1)));\n\n    if (!rest.length) {\n      total.add([perm[i]]);\n    } else {\n      for (let j = 0; j < rest.length; j = j + 1) {\n        total.add([perm[i]].concat(rest[j]));\n      }\n    }\n  }\n  return [...total];\n}\n\n/**\n * Searches through compendia quickly using the system generated index caches.\n * Exact matches excluding punctuation and case are prioritized before searching word order permutations.\n *\n * @param {string} searchTerm - The name of the Document being searched for\n * @param {object} [options] - Provides a filter to limit search to specific packs or Document types\n * @param {string[]} [options.packs] - An array of packs to search in\n * @param {\"Actor\"|\"Item\"|\"Scene\"|\"JournalEntry\"|\"Macro\"|\"RollTable\"|\"Playlist\"} [options.type] - A Document type to limit which packs are searched in\n * @param {string} [options.docType] - Document type, such as \"loot\" or \"npc\"\n * @param {boolean} [options.disabled=false] - Include packs disabled for compendium browser.\n * @returns {{pack: CompendiumCollection, index: object}|false} The index and pack containing it or undefined if no match is found\n */\nexport const findInCompendia = (searchTerm, { packs = [], type, docType, disabled = false } = {}) => {\n  if (packs?.length) packs = packs.flatMap((o) => game.packs.get(o) ?? []);\n  else packs = game.packs.filter((o) => !type || o.metadata.type == type);\n  if (!disabled) packs = packs.filter((o) => o.config?.ffd20?.disabled !== true);\n\n  searchTerm = searchTerm.toLocaleLowerCase();\n\n  for (const pack of packs) {\n    if (!pack.fuzzyIndex) pack.fuzzyIndex = ffd20.utils.internal.sortArrayByName([...pack.index]);\n    let filteredIndex = pack.fuzzyIndex;\n    if (docType) filteredIndex = filteredIndex.filter((e) => e.type === docType);\n\n    const found = binarySearch(filteredIndex, searchTerm, (sp, it) =>\n      sp.localeCompare(it.name, undefined, { ignorePunctuation: true })\n    );\n    if (found > -1) {\n      const entry = pack.index.get(filteredIndex[found]._id);\n      return { pack, index: entry };\n    }\n  }\n\n  let searchMutations = uniquePermutations(searchTerm.split(/[, _-]/));\n  if (searchMutations) searchMutations = searchMutations.map((o) => o.join(\" \"));\n  else {\n    // If array is too long, search for just a reversed version and one that pivots around commas/ semicolons\n    searchMutations = [null];\n    searchMutations.push(searchTerm.split(/[ _-]/).reverse().join(\" \"));\n    searchMutations.push(\n      searchTerm\n        .split(/[,;] ?/)\n        .reverse()\n        .flatMap((o) => o.split(\" \"))\n        .join(\" \")\n    );\n  }\n\n  for (const pack of packs) {\n    let filteredIndex = pack.fuzzyIndex;\n    if (docType) filteredIndex = filteredIndex.filter((e) => e.type === docType);\n\n    // Skip first mutation since it is already searched for manually before computing mutations\n    for (let mut = 1; mut < searchMutations.length; mut++) {\n      const found = binarySearch(filteredIndex, searchMutations[mut], (sp, it) =>\n        sp.localeCompare(it.name, undefined, { ignorePunctuation: true })\n      );\n      if (found > -1) {\n        const entry = pack.index.get(filteredIndex[found]._id);\n        if (entry) return { pack, index: entry };\n      }\n    }\n  }\n\n  return false;\n};\n\n/**\n * enrichHTML but with inline rolls not rolled\n *\n * {@inheritDoc TextEditor.enrichHTML}\n *\n * @experimental - This may be removed without warning.\n * @param {string} content HTML content in string format to be enriched.\n * @param {options} [options] Additional options passed to enrichHTML\n * @param {object} [options.rollData] Roll data object\n * @param {boolean} [options.secrets] Display secrets\n * @param {boolean} [options.rolls=false] Roll inline rolls. If false, the roll formula is shown instead as if /r had been used.\n * @param {boolean} [options.documents] Parse content links\n * @returns {string} - Enriched HTML string\n * Synchronized with Foundry VTT v12.331\n */\nexport async function enrichHTMLUnrolled(\n  content,\n  { secrets, documents, links, embeds, rolls = false, rollData, relativeTo } = {}\n) {\n  let pcontent = await TextEditor.enrichHTML(content, {\n    secrets,\n    documents,\n    links,\n    embeds,\n    rolls,\n    rollData,\n    relativeTo,\n  });\n\n  if (rolls !== true) {\n    const html = document.createElement(\"div\");\n    html.innerHTML = String(pcontent);\n    const text = TextEditor._getTextNodes(html);\n    rollData = rollData instanceof Function ? rollData() : rollData || {};\n    const rgx = /\\[\\[(\\/[a-zA-Z]+\\s)?(.*?)(]{2,3})(?:{([^}]+)})?/gi;\n    await TextEditor._replaceTextContent(text, rgx, (match) => ffd20.utils.internal.createInlineFormula(match, rollData));\n    pcontent = html.innerHTML;\n  }\n\n  return pcontent;\n}\n\n/**\n * Resolve range formula to numeric value.\n *\n * @param {string} [formula] Range formula. Only used with \"mi\", \"ft\", \"m\", \"km\" and similar types.\n * @param {\"natural\"|\"melee\"|\"touch\"|\"reach\"|\"close\"|\"medium\"|\"long\"|\"mi\"} [type=\"ft\"] Formula type\n * @param {object} [rollData] Roll data for evaluating the formula\n * @returns {number} Range in feet for the defined formula\n */\nexport const calculateRangeFormula = (formula, type = \"ft\", rollData = {}) => {\n  switch (type) {\n    case \"natural\":\n      return rollData.traits?.reach?.natural?.melee ?? 0;\n    case \"melee\":\n    case \"touch\":\n      return rollData.range?.melee ?? 0;\n    case \"reach\":\n      return rollData.range?.reach ?? 0;\n    case \"close\":\n      return RollPF.safeRollSync(ffd20.config.spellRangeFormulas.close, rollData).total;\n    case \"medium\":\n      return RollPF.safeRollSync(ffd20.config.spellRangeFormulas.medium, rollData).total;\n    case \"long\":\n      return RollPF.safeRollSync(ffd20.config.spellRangeFormulas.long, rollData).total;\n    case \"mi\":\n      return RollPF.safeRollSync(formula, rollData).total * 5_280;\n    case \"m\":\n      return (RollPF.safeRollSync(formula, rollData).total / 1.5) * 5;\n    case \"km\":\n      return ((RollPF.safeRollSync(formula, rollData).total * 1000) / 1.5) * 5;\n    default:\n      return RollPF.safeRollSync(formula, rollData).total;\n  }\n};\n\n/**\n * Calculates range formula and converts it.\n *\n * Wrapper around {@link calculateRangeFormula} and {@link convertDistance}\n *\n * @example\n * Simple example\n * ```js\n * const [range,unit] = calculateRange(\"@level\", \"mi\", { level:2 });\n * // => range:10560, unit:\"ft\"\n * ```\n *\n * @param {string} formula - Range formula\n * @param {string} type - Type fed to calculateRangeFormula\n * @param {object} rollData - Roll data fed to calculateRangeFormula\n * @returns {Array.<number, string>} - Range value and unit tuple\n */\nexport function calculateRange(formula, type = \"ft\", rollData = {}) {\n  const value = calculateRangeFormula(formula, type, rollData);\n  return convertDistance(value, type);\n}\n\n/**\n * Refreshes all actor data and re-renders sheets.\n *\n * @internal\n * @param {object} [options] - Additional options\n * @param {boolean} [options.renderOnly=false] - If false, actors are reset also.\n * @param {boolean} [options.renderForEveryone=false] - Deprecated. If true, other players are told to re-render, too.\n */\nexport function refreshActors({ renderOnly = false, renderForEveryone = false } = {}) {\n  // Reset base actors\n  if (!renderOnly) {\n    game.actors.forEach((a) => a.reset());\n\n    // Reset unlinked actors in all scenes\n    game.scenes.forEach((scene) =>\n      scene.tokens\n        .filter((t) => t.actor && !t.isLinked)\n        .map((t) => t.actor)\n        .forEach((a) => a.reset())\n    );\n  }\n\n  // Render system sheets. Doesn't matter if this renders more than necessary\n  ffd20.utils.renderApplications({ systemOnly: true });\n\n  if (renderForEveryone) {\n    foundry.utils.logCompatibilityWarning(\n      \"ffd20.utils.refreshActors() renderForEveryone option is deprecated with no replacement.\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n\n    game.socket.emit(\"ffd20\", \"refreshActorSheets\");\n  }\n}\n\n/**\n * Re-render all open applications. Optionally limiting to just the the system apps.\n *\n * @param {object} [options] - Additional options\n * @param {boolean} [options.systemOnly=false] - Render only system apps.\n * @param {boolean} [options.force] - Force render\n */\nexport async function renderApplications({ systemOnly = false, force } = {}) {\n  const applications = [];\n  for (const app of Object.values(ui.windows)) {\n    if (systemOnly && !app.options.classes.includes(\"ffd20\")) continue;\n    applications.push(app);\n  }\n  for (const app of foundry.applications.instances.values()) {\n    if (systemOnly && !app.options.classes.includes(\"pf1-v2\")) continue;\n    applications.push(app);\n  }\n\n  applications.sort((a, b) => a.position.zIndex - b.position.zIndex);\n\n  for (const app of applications) {\n    if (app.minimized) continue;\n    app.render(force, { zIndex: app.position.zIndex });\n  }\n\n  console.debug(\"FFD20 |\", applications.length, \"application(s) re-rendered\");\n}\n\n/**\n * Refresh all actor, item and action sheets.\n *\n * @internal\n * @param {object} [options] Additional options\n * @param {boolean} [options.reset=true] Reset underlying document.\n * @param {boolean} [options.actor] Include actor sheets\n * @param {boolean} [options.item] Include item sheets\n * @param {boolean} [options.action] Include action sheets\n */\nexport function refreshSheets({ reset = true, actor = true, item = true, action = true } = {}) {\n  Object.values(ui.windows).forEach((app) => {\n    if (\n      (actor && app instanceof ActorSheet) ||\n      (item && app instanceof ItemSheet) ||\n      (action && app instanceof ffd20.applications.component.ItemActionSheet)\n    ) {\n      if (reset && app.object instanceof Document) app.object.reset();\n      app.render();\n    }\n  });\n}\n\n/**\n * Deeply difference an object against some other, returning the update keys and values.\n * Unlike foundry.utils.diffObject, this function also deeply compares arrays.\n *\n * @internal\n * @deprecated - Will be removed with PF1 v12\n * @param {object} original       An object comparing data against which to compare\n * @param {object} other          An object containing potentially different data\n * @param {object} [options={}]   Additional options which configure the diff operation\n * @param {boolean} [options.inner=false]  Only recognize differences in other for keys which also exist in original\n * @param {boolean} [options.keepLength=false]  Keep array length intact, possibly having to insert empty objects\n * @returns {object}               An object of the data in other which differs from that in original\n */\nexport const diffObjectAndArray = (original, other, { inner = false, keepLength = false } = {}) => {\n  foundry.utils.logCompatibilityWarning(\"ffd20.utils.diffObjectAndArray() is deprecated with no replacement.\", {\n    since: \"PF1 v11\",\n    until: \"PF1 v12\",\n  });\n\n  function _difference(v0, v1) {\n    const t0 = foundry.utils.getType(v0);\n    const t1 = foundry.utils.getType(v1);\n    if (t0 !== t1) return [true, v1];\n    if (t0 === \"Array\") {\n      if (v0.length !== v1.length) return [true, v1];\n      const d = [];\n      for (let a = 0; a < v0.length; a++) {\n        const d2 = diffObjectAndArray(v0[a], v1[a], { inner, keepLength });\n        if (!foundry.utils.isEmpty(d2)) d.push(d2);\n        else if (keepLength) d.push({});\n      }\n      if (d.length > 0) return [true, d];\n      return [false, d];\n    }\n    if (t0 === \"Object\") {\n      if (foundry.utils.isEmpty(v0) !== foundry.utils.isEmpty(v1)) return [true, v1];\n      const d = diffObjectAndArray(v0, v1, { inner, keepLength });\n      return [!foundry.utils.isEmpty(d), d];\n    }\n    return [v0 !== v1, v1];\n  }\n\n  // Recursively call the _difference function\n  return Object.keys(other).reduce((obj, key) => {\n    if (inner && !(key in original)) return obj;\n    const [isDifferent, difference] = _difference(original[key], other[key]);\n    if (isDifferent) obj[key] = difference;\n    return obj;\n  }, {});\n};\n\n/**\n * Determines what ability modifier is appropriate for a given score.\n *\n * @example\n * ```js\n * ffd20.utils.getAbilityModifier(15); // => 2\n * ffd20.utils.getAbilityModifier(6, { damage: 1 }); // => -2\n * ```\n *\n * @param {number} [score] - The score to find the modifier for.\n * @param {object} [options={}] - Options for this function.\n * @param {number} [options.penalty=0] - A penalty value to take into account.\n * @param {number} [options.damage=0] - Ability score damage to take into account.\n * @returns {number} The modifier for the given score.\n */\nexport function getAbilityModifier(score = null, options = {}) {\n  if (score != null) {\n    const penalty = Math.abs(options.penalty ?? 0);\n    const damage = Math.abs(options.damage ?? 0);\n    return Math.max(-5, Math.floor((score - 10) / 2) - Math.floor(penalty / 2) - Math.floor(damage / 2));\n  }\n  return 0;\n}\n\n/**\n * Create throttling function.\n *\n * Returned function will execute after defined delay. Multiple calls will be discarded until the callback is executed and new timeout can start.\n *\n * @param {Function} callback - Callback function\n * @param {number} delay - Delay in milliseconds\n * @returns {Function}\n */\nexport function throttle(callback, delay) {\n  let timeoutId = -1;\n  return () => {\n    if (timeoutId <= 0) {\n      timeoutId = setTimeout(() => {\n        timeoutId = -1;\n        callback();\n      }, delay);\n    }\n    return timeoutId;\n  };\n}\n\n/**\n * Create limiting function\n *\n * The function is called immediately, unless it was recently called in which case the call is discarded until defined amount of time has passed.\n *\n * @param {Function} callback - Function to call\n * @param {number} ms - Milliseconds that must pass before the wrapped function can be called again.\n * @returns {Function} - Limited function\n */\nexport function limit(callback, ms = 100) {\n  let lastCall = 0;\n  return (...args) => {\n    const t0 = performance.now();\n    if (t0 - lastCall < ms) return;\n    lastCall = t0;\n    callback(...args);\n  };\n}\n\n/**\n * Get iterator for all actors.\n *\n * @param {object} [options] - Options for which actors to fetch.\n * @param {Array<string>|null} [options.types=null] - Array of actor types to accept. Returns all if null.\n * @param {boolean} [options.base=true] - Return base actors (from game.actors).\n * @param {string|Scene|null} [options.scene=null] - Specific scene. Sets `scenes` and `base` to false.\n * @param {boolean} [options.scenes=false] - All scenes.\n * @param {boolean} [options.linked=true] - Get linked actors from scenes.\n * @param {boolean} [options.unlinked=true] - Get unlinked actors from scenes.\n * @param {Array<string|User>} [options.users=[game.user]] - Test specific users permission, either User instances or user IDs. Defaults to current user.\n * @param {*} [options.ownership=CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER] - What permission level (`CONST.DOCUMENT_OWNERSHIP_LEVELS`) to test user for, if user is defined.\n *\n * @yields {Actor} - Relevant actors\n */\nexport function* getActors({\n  base = true,\n  types = null,\n  scene = null,\n  scenes = false,\n  linked = true,\n  unlinked = true,\n  users = [game.user],\n  ownership = CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,\n} = {}) {\n  users = users.map((user) => (user instanceof User ? user : game.users.get(user)));\n\n  const testUsers = (actor) => (users.length ? users.some((user) => actor.testUserPermission(user, ownership)) : true);\n\n  if (base) {\n    for (const actor of [...game.actors]) {\n      if (types && !types.includes(actor.type)) continue;\n      if (!testUsers(actor)) continue;\n      yield actor;\n    }\n  }\n\n  let sceneList;\n  if (scene) {\n    if (scene instanceof Scene) sceneList = [scene];\n    else sceneList = [game.scenes.get(scene)];\n  } else if (scenes) {\n    sceneList = [...game.scenes];\n  }\n\n  for (const scene of sceneList) {\n    for (const token of [...scene.tokens]) {\n      const actor = token.actor;\n      if (!actor) continue;\n\n      if (types && !types.includes(actor.type)) continue;\n\n      // Test at least one user has appropriate ownership\n      if (!testUsers(actor)) continue;\n\n      const isLinked = token.isLinked;\n      // Yield linked only if such are desired and we didn't already return base actors\n      if (isLinked && linked && !base) yield actor;\n      // Yield unlinked only if desired\n      else if (!isLinked && unlinked) yield actor;\n    }\n  }\n}\n\n/**\n * Parse alignment string and provide breakdown of it.\n *\n * Each alignment is either 0 or 1, except for neutral which can reach 2 for true neutral.\n *\n * @param {string} align - Alignment string.\n * @returns {{lawful:number, evil:number, chaotic:number, good:number, neutral:number}}\n * @since PF1 v10\n */\nexport function parseAlignment(align) {\n  const lawful = align.includes(\"l\") ? 1 : 0;\n  const evil = align.includes(\"e\") ? 1 : 0;\n  const chaotic = align.includes(\"c\") ? 1 : 0;\n  const good = align.includes(\"g\") ? 1 : 0;\n  const neutral = align == \"tn\" ? 2 : align.includes(\"n\") ? 1 : 0;\n  return { lawful, evil, chaotic, good, neutral };\n}\n\n/**\n * Limit precision.\n *\n * Reduces number of decimals but does not insist on those decimals to be there.\n *\n * @beta\n * @param {number} number - Number to adjust\n * @param {number} [decimals] - Maximum number of decimals\n * @param {\"floor\"|\"ceil\"|\"round\"} [method] - Rounding method.\n * @returns {number} - Adjusted number\n */\nexport function limitPrecision(number, decimals = 2, method = \"floor\") {\n  const mult = Math.pow(10, decimals);\n  return Math[method](number * mult) / mult;\n}\n\n/**\n * Tests if two items are in same sub-group.\n *\n * This does not test main grouping (that is, item type itself).\n *\n * @param {ItemPF} item0 - First item to test\n * @param {ItemPF} item1 - Second item to test\n * @returns {boolean} - Equivalency\n */\nexport function isItemSameSubGroup(item0, item1) {\n  if (item0.type === \"spell\") {\n    // Spells sort by spell level instead of subtype\n    return item0.system.spellbook === item1.system.spellbook && item0.system.level === item1.system.level;\n  }\n\n  if (item0.subType) return item0.subType === item1.subType;\n\n  // Assume everything else is only categorized by main type\n  return true;\n}\n\n/**\n * Clone value.\n *\n * Similar to `foundry.utils.deepClone()` but does not return references for DataModel instances.\n *\n * @remarks\n * - Documents are returned as references (unless source option is enabled)\n * - PIXI graphics are returned as references\n * - DataModels are extracted like objects with `parent` excluded\n * - Unsupported objects call .toObject() when present, otherwise as references\n *\n * @param {object} original - Original data\n * @param {object} [options] - Additional options\n * @param {boolean} [options.strict=false] - Throw an error if a reference would be returned.\n * @param {boolean} [options.source=false] - Return source data instead for supporting data.\n * @throws {Error} - With strict mode if reference would be returned.\n * @returns {object} - Cloned object\n */\nexport function deepClone(original, { strict = false, source = false } = {}) {\n  return _deepClone(original, strict, source);\n}\n\n/**\n * Faster deepClone() without destructuring.\n *\n * @internal\n * @param {*} original - Original data\n * @param {boolean} strict - Strict mode\n * @param {boolean} source - Clone source data\n * @param {number} _depth - Recursion depth\n * @returns {*} - Cloned data\n */\nfunction _deepClone(original, strict = false, source = false, _depth = 0) {\n  if (_depth > 100) {\n    throw new Error(\"Maximum depth exceeded. Be sure your object does not contain cyclical data structures.\");\n  }\n  _depth++;\n\n  // Simple types (null, undefined, number, string, bigint, function,...)\n  if (typeof original !== \"object\" || original === null) return original;\n\n  // Does not clone injected extra data\n  if (Array.isArray(original)) return original.map((value) => _deepClone(value, strict, source, _depth));\n\n  // Dates\n  if (original instanceof Date) return new Date(original);\n\n  // Return documents as is\n  if (original instanceof foundry.abstract.Document) {\n    if (source) return original.toObject();\n    if (strict) throw new Error(\"Document instance encountered\");\n    return original;\n  }\n\n  if (original instanceof PIXI.DisplayObject) {\n    if (strict) throw new Error(\"PIXI graphic encountered\");\n    return original;\n  }\n\n  // Unsupported advanced objects\n  if (original instanceof foundry.abstract.DataModel) {\n    if (source) return original.toObject();\n    // Otherwise treat as regular object\n  } else if (original.constructor && original.constructor !== Object) {\n    if (typeof original.toObject === \"function\") return original.toObject();\n    else if (typeof original.toJSON === \"function\") return original.toJSON();\n    if (strict) throw new Error(`Unsupported advanced object: ${original.constructor.name}`);\n    return original;\n  }\n\n  // DataModels and other plain objects\n  const clone = {};\n  for (const k of Object.keys(original)) {\n    clone[k] = _deepClone(original[k], strict, source, _depth);\n  }\n\n  return clone;\n}\n","const fields = foundry.data.fields;\n\n/**\n * The Base Registry class, providing shared functionality for all registries in the system.\n *\n * @abstract\n * @group Base Classes\n * @template {RegistryEntry} Model\n * @augments {foundry.utils.Collection<Model>}\n */\nexport class Registry extends foundry.utils.Collection {\n  /**\n   * The class each of this registry's content is expected to be an instance of.\n   *\n   * @type {typeof Model}\n   */\n  static model = null;\n\n  /**\n   * An array of data used to initialize this registry.\n   *\n   * @protected\n   * @type {Array<object>}\n   */\n  static _defaultData = [];\n\n  /**\n   * The class each of this registry's content is expected to be an instance of.\n   *\n   * @see {@link Registry.model}\n   * @type {Model}\n   */\n  model;\n\n  constructor() {\n    super();\n    Object.defineProperty(this, \"model\", { value: this.constructor.model, writable: false, enumerable: false });\n    this._initialize();\n  }\n\n  /**\n   * The name of the registry\n   *\n   * @type {string}\n   */\n  get name() {\n    return this.constructor.name;\n  }\n\n  /**\n   * Initializes the registry with its default data.\n   *\n   * @remarks This method is called automatically when the registry is instantiated.\n   *  It should be self-reliant and not require any other setup.\n   * @private\n   */\n  _initialize() {\n    this.clear();\n    for (const element of this.constructor._defaultData) {\n      try {\n        const content = new this.model({ ...element, namespace: \"ffd20\" });\n        super.set(content.id, content);\n      } catch (error) {\n        console.error(error);\n      }\n    }\n\n    // Allow modules to register their own content\n    Hooks.callAll(`pf1Register${this.name}`, this);\n\n    this.setup();\n  }\n\n  /**\n   * Post-registry initialization entry preparation\n   *\n   * @abstract\n   * @protected\n   */\n  setup() {}\n\n  /**\n   * Localize registry and all their entries.\n   *\n   * Called in `i18nInit`.\n   *\n   * @protected\n   */\n  localize() {\n    for (const element of this) {\n      element.localize();\n    }\n  }\n\n  /**\n   * Sets the value of a key in the registry.\n   *\n   * @param {string} id - ID of the value to set.\n   * @param {Model} content - The value to set.\n   * @returns {Registry} The registry itself, after the value has been set.\n   */\n  set(id, content) {\n    const cls = this.model;\n    if (!(content instanceof cls)) {\n      throw new Error(`Registry '${this.name}' can only register ${cls.name}`);\n    }\n    return super.set(id, content);\n  }\n\n  /**\n   * Registers a new instance of {@link Model} with the registry, using a partial of its data as the base.\n   *\n   * @example\n   * ```js\n   * ffd20.registry.damageTypes.register(\"my-module\", \"my-damage-type\", {\n   *   name: \"My Damage Type\",\n   *   img: \"icons/svg/damage.svg\",\n   *   category: \"physical\",\n   * });\n   * ```\n   * @param {string} namespace - The namespace for which this value is registered.\n   * @param {string} id - The unique key of the value.\n   * @param {object} value - A {@link Partial} of the data to use as the base for the new value.\n   * @returns {Registry} The registry itself, after the value has been registered.\n   */\n  register(namespace, id, value) {\n    if (!namespace || !id) throw new Error(\"Registering requires both a namespace and an ID\");\n    if (this.has(id)) {\n      throw new Error(`Registry '${this.name}' already has a key '${id}'`);\n    }\n    return this.set(id, new this.model({ ...value, namespace, _id: id }));\n  }\n\n  /**\n   * Unregisters a value from the registry, or if no id is provided, all values belonging to the namespace.\n   *\n   * @param {string} namespace - The namespace for which this value is unregistered.\n   * @param {string} [id] - The unique key of the value, or `undefined` to unregister all values belonging to the namespace.\n   */\n  unregister(namespace, id) {\n    if (!namespace) throw new Error(\"Unregistering requires a namespace\");\n    if (id) {\n      const entry = this.get(id);\n      if (entry && entry.namespace === namespace) this.delete(id);\n      else throw new Error(`Registry '${this.name}' has no key '${id}'`);\n    } else {\n      for (const entry of this) {\n        if (entry.namespace === namespace) this.delete(entry.id);\n      }\n    }\n  }\n\n  /**\n   * Returns the contents of this registry as object, using ids as keys.\n   *\n   * @param {boolean} [source=false] - Whether to include the source data instead of its prepared data for each value.\n   * @returns {{ [id: string]: object }} The data of each value in the registry, by id\n   */\n  toObject(source = false) {\n    return Object.fromEntries(this.map((registryObject) => [registryObject.id, registryObject.toObject(source)]));\n  }\n\n  /**\n   * Returns an object of the registry's contents, with the id as key and the name as value.\n   *\n   * @returns {{ [id: string]: string }} The names of each value in the registry, by id\n   */\n  getLabels() {\n    return Object.fromEntries(this.map((registryObject) => [registryObject.id, registryObject.name]));\n  }\n}\n\n/**\n * The Base Registry Object class, providing shared functionality for all registry objects in the system.\n * For the required data, see {@link defineSchema}.\n *\n * @abstract\n * @group Base Classes\n */\nexport class RegistryEntry extends foundry.abstract.DataModel {\n  /** @override */\n  static defineSchema() {\n    return {\n      _id: new fields.StringField({ required: true, blank: false, readonly: true }),\n      name: new fields.StringField({ required: false, initial: \"\", localize: true }),\n      flags: new fields.ObjectField({ required: false, initial: {} }),\n      namespace: new fields.StringField({ required: true, blank: false }),\n    };\n  }\n\n  /**\n   * The unique key of the value.\n   *\n   * @type {string}\n   * @readonly\n   */\n  get id() {\n    return this._id;\n  }\n\n  /**\n   * @internal\n   * @override\n   */\n  _initialize() {\n    super._initialize();\n\n    this.prepareData();\n  }\n\n  /**\n   * Prepares the data of the registry entry.\n   *\n   * @abstract\n   * @protected\n   */\n  prepareData() {}\n\n  /**\n   * Localize fields\n   *\n   * @protected\n   */\n  localize() {\n    for (const [name, field] of Object.entries(this.constructor.schema.fields)) {\n      if (field instanceof fields.StringField && field.options.localize === true)\n        this[name] = game.i18n.localize(this[name]);\n    }\n  }\n}\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nconst fields = foundry.data.fields;\n\n/**\n * A single damage type entry in the {@link DamageTypes} registry.\n *\n * @group Damage Types\n */\nexport class DamageType extends RegistryEntry {\n  static defineSchema() {\n    return {\n      ...super.defineSchema(),\n      abbr: new fields.StringField({ required: false, blank: false, nullable: true, initial: null }),\n      icon: new fields.StringField({ required: false, initial: \"\" }),\n      img: new fields.FilePathField({ categories: [\"IMAGE\"] }),\n      category: new fields.StringField({\n        required: true,\n        blank: false,\n        initial: \"misc\",\n        choices: () => DamageTypes.CATEGORIES,\n      }),\n      isModifier: new fields.BooleanField({ required: false, initial: false }),\n      color: new fields.StringField({ required: true, initial: \"black\" }),\n      resist: new fields.BooleanField({ initial: true }),\n      diceSoNice: new fields.SchemaField(\n        {\n          colorset: new fields.StringField({ required: false }),\n          texture: new fields.StringField({ required: false }),\n          material: new fields.StringField({ required: false }),\n        },\n        {\n          initial: undefined,\n          required: false,\n        }\n      ),\n    };\n  }\n}\n/**\n * The singleton registry of damage types.\n *\n * At runtime this registry is accessible as `ffd20.registry.damageTypes`.\n *\n * @group Damage Types\n * @see {@link Registry}\n * @see {@link DamageType}\n * @augments {Registry<DamageType>}\n */\nexport class DamageTypes extends Registry {\n  /** @inheritdoc */\n  static model = DamageType;\n\n  /**\n   * An array of allowed categories of damage types.\n   */\n  static CATEGORIES = /** @type {const} */ ([\"physical\", \"energy\", \"misc\"]);\n\n  /** @inheritdoc */\n  static _defaultData = /** @type {const} */ ([\n    {\n      _id: \"untyped\",\n      name: \"FFD20.DamageTypes.untyped.Label\",\n      icon: \"ra ra-uncertainty\",\n      resist: false,\n      category: \"misc\",\n    },\n    {\n      _id: \"slashing\",\n      name: \"FFD20.DamageTypes.slashing.Label\",\n      abbr: \"FFD20.DamageTypes.slashing.Abbr\",\n      icon: \"ra ra-sword\",\n      color: \"yellow\",\n      category: \"physical\",\n    },\n    {\n      _id: \"piercing\",\n      name: \"FFD20.DamageTypes.piercing.Label\",\n      abbr: \"FFD20.DamageTypes.piercing.Abbr\",\n      icon: \"ra ra-spear-head\",\n      color: \"blue\",\n      category: \"physical\",\n    },\n    {\n      _id: \"bludgeoning\",\n      name: \"FFD20.DamageTypes.bludgeoning.Label\",\n      abbr: \"FFD20.DamageTypes.bludgeoning.Abbr\",\n      icon: \"ra ra-large-hammer\",\n      color: \"red\",\n      category: \"physical\",\n    },\n    {\n      _id: \"fire\",\n      name: \"FFD20.DamageTypes.fire.Label\",\n      icon: \"ra ra-fire\",\n      color: \"orange\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"fire\",\n        texture: \"fire\",\n      },\n    },\n    {\n      _id: \"ice\",\n      name: \"FFD20.DamageTypes.ice.Label\",\n      icon: \"ra ra-frost-emblem\",\n      color: \"aqua\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"ice\",\n        texture: \"ice\",\n      },\n    },\n    {\n      _id: \"wind\",\n      name: \"FFD20.DamageTypes.wind.Label\",\n      icon: \"ra ra-slash-ring\",\n      color: \"#04e0ce\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"lightning\",\n        texture: \"fire\",\n      },\n    },\n    {\n      _id: \"earth\",\n      name: \"FFD20.DamageTypes.earth.Label\",\n      icon: \"ra ra-groundbreaker\",\n      color: \"#664a02\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"acid\",\n        texture: \"marble\",\n      },\n    },\n    {\n      _id: \"lightning\",\n      name: \"FFD20.DamageTypes.lightning.Label\",\n      icon: \"ra ra-lightning-bolt\",\n      color: \"yellow\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"lightning\",\n        texture: \"ice\",\n      },\n    },\n    {\n      _id: \"water\",\n      name: \"FFD20.DamageTypes.water.Label\",\n      icon: \"ra ra-droplet\",\n      color: \"blue\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"water\",\n        texture: \"marble\",\n      },\n    },\n    {\n      _id: \"light\",\n      name: \"FFD20.DamageTypes.light.Label\",\n      icon: \"ra ra-sunbeams\",\n      color: \"#defffc\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"astralsea\",\n        texture: \"astral\",\n      },\n    },\n    {\n      _id: \"dark\",\n      name: \"FFD20.DamageTypes.dark.Label\",\n      icon: \"ra ra-skull\",\n      color: \"#765898\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"necrotic\",\n        texture: \"skulls\",\n      },\n    },\n    {\n      _id: \"nonelemental\",\n      name: \"FFD20.DamageTypes.nonElemental.Label\",\n      icon: \"ra ra-doubled\",\n      color: \"#a200ff\",\n      category: \"energy\",\n      diceSoNice: {\n        colorset: \"prism\",\n        texture: \"stainedglass\",\n      },\n    },\n    {\n      _id: \"precision\",\n      name: \"FFD20.Precision\",\n      icon: \"ra ra-archery-target\",\n      isModifier: true,\n    },\n    {\n      _id: \"nonlethal\",\n      name: \"FFD20.Nonlethal\",\n      icon: \"ra ra-hand\",\n      isModifier: true,\n    },\n    {\n      _id: \"manapoint\",\n      name: \"FFD20.ManaDamage\",\n      icon: \"ra ra-incense\",\n      isModifier: true,\n    },\n    {\n      _id: \"areaOfEffect\",\n      name: \"FFD20.DamageTypes.areaOfEffect.Label\",\n      icon: \"ra ra-bomb-explosion\",\n      isModifier: true,\n    },\n  ]);\n}\n\n/**\n * {@inheritDoc DamageTypes}\n *\n * @group Damage Types\n * @type {DamageTypes}\n */\nexport let damageTypes;\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nconst fields = foundry.data.fields;\n\n/**\n * A single material type entry in the {@link Materials} registry.\n *\n * @group Materials\n */\nexport class Material extends RegistryEntry {\n  static defineSchema() {\n    return {\n      ...super.defineSchema(),\n      name: new fields.StringField({\n        required: false,\n        localize: true,\n        initial: (data) => `FFD20.Materials.Types.${data._id}`,\n      }),\n      shortName: new fields.StringField({ required: false, initial: undefined, blank: false, localize: true }),\n      treatedAs: new fields.StringField({ required: false, initial: undefined, blank: false }),\n      addon: new fields.BooleanField({ required: false, initial: false }),\n      intrinsic: new fields.BooleanField({ required: false, initial: false }), // Always available, same as base materials\n      primitive: new fields.BooleanField({ required: false, initial: false }),\n      baseMaterial: new fields.ArrayField(new fields.StringField(), { required: false, initial: [] }),\n      hardness: new fields.NumberField({ required: false, initial: 10, integer: true, min: 0 }),\n      hardnessMultiplier: new fields.NumberField({ required: false, initial: null, nullable: true, min: 0 }),\n      healthPerInch: new fields.NumberField({ required: false, initial: null, integer: true, min: 0, nullable: true }),\n      healthBonus: new fields.NumberField({ required: false, initial: 0, integer: true, min: 0 }),\n      healthMultiplier: new fields.NumberField({ required: false, initial: 1.0, integer: false, positive: true }),\n      masterwork: new fields.BooleanField({ required: false, initial: false }),\n      allowed: new fields.SchemaField({\n        lightBlade: new fields.BooleanField({ required: false, initial: true }),\n        oneHandBlade: new fields.BooleanField({ required: false, initial: true }),\n        twoHandBlade: new fields.BooleanField({ required: false, initial: true }),\n        rangedWeapon: new fields.BooleanField({ required: false, initial: true }),\n        buckler: new fields.BooleanField({ required: false, initial: true }),\n        lightShield: new fields.BooleanField({ required: false, initial: true }),\n        heavyShield: new fields.BooleanField({ required: false, initial: true }),\n        towerShield: new fields.BooleanField({ required: false, initial: true }),\n        lightArmor: new fields.BooleanField({ required: false, initial: true }),\n        mediumArmor: new fields.BooleanField({ required: false, initial: true }),\n        heavyArmor: new fields.BooleanField({ required: false, initial: true }),\n      }),\n      armor: new fields.SchemaField({\n        acp: new fields.NumberField({ required: false, initial: 0, integer: true }),\n        maxDex: new fields.NumberField({ required: false, initial: 0, integer: true }),\n        asf: new fields.NumberField({ required: false, initial: 0, integer: true }),\n      }),\n      dr: new fields.BooleanField({ required: false, initial: false }),\n      incompatible: new fields.ArrayField(new fields.StringField(), {\n        required: false,\n        initial: [],\n      }),\n      price: new fields.SchemaField({\n        multiplier: new fields.NumberField({ required: false, initial: 1.0, integer: false, positive: true }),\n        perPound: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        ammunition: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        lightWeapon: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        oneHandWeapon: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        twoHandWeapon: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        rangedOneHandWeapon: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        rangedTwoHandWeapon: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        shield: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        lightArmor: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        mediumArmor: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        heavyArmor: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n        enhancement: new fields.SchemaField({\n          // Bonus cost to apply enhancement. One time price increase on first enhancement.\n          weapon: new fields.NumberField({ required: false, initial: 0, min: 0 }),\n        }),\n      }),\n      shield: new fields.SchemaField({\n        acp: new fields.NumberField({ required: false, initial: 0, integer: true }),\n        maxDex: new fields.NumberField({ required: false, initial: 0, integer: true }),\n        asf: new fields.NumberField({ required: false, initial: 0, integer: true }),\n      }),\n      weight: new fields.SchemaField({\n        multiplier: new fields.NumberField({ required: false, initial: 1.0, integer: false, positive: true }),\n        bonusPerPound: new fields.NumberField({ required: false, initial: 0.0, integer: false, positive: false }),\n      }),\n    };\n  }\n\n  /**\n   * Is this a basic material that items without special materials are made of?\n   *\n   * @type {boolean}\n   */\n  get basic() {\n    return !this.baseMaterial.length && !this.addon;\n  }\n\n  /**\n   * Check if a given material is okay to be added to our materials list\n   *\n   * @param {ItemPF} item - Whether we're checking weapons or equipment\n   * @returns {boolean} - Whether the material is allowed for the given item\n   */\n  isAllowed(item) {\n    // Let's end this early if we can never be allowed\n    if (this.basic) return false;\n    const type = item.type,\n      subtype = item.system.subType,\n      baseMaterial = item.baseMaterial;\n    let result = false;\n\n    if (this.baseMaterial.length && baseMaterial && !this.baseMaterial.includes(baseMaterial)) {\n      return result;\n    }\n\n    // Check whether the material is allowed for the given item\n    switch (type) {\n      case \"spell\": {\n        result = true;\n        break;\n      }\n      case \"weapon\":\n      case \"attack\": {\n        const weaponCategory = type === \"weapon\" ? item.system.weaponSubtype : item.system.weapon?.type || \"all\";\n\n        switch (weaponCategory) {\n          case \"light\":\n            result = this.allowed.lightBlade;\n            break;\n          case \"1h\":\n            result = this.allowed.oneHandBlade;\n            break;\n          case \"2h\":\n            result = this.allowed.twoHandBlade;\n            break;\n          case \"ranged\":\n            result = this.allowed.rangedWeapon;\n            break;\n          case \"all\": // We're prepping an Attack and don't care (don't have the info anyways)\n            result =\n              this.allowed.lightBlade ||\n              this.allowed.oneHandBlade ||\n              this.allowed.twoHandBlade ||\n              this.allowed.rangedWeapon; // Essentially, filter out any that are armor-only.\n            break;\n          default:\n            // Shouldn't find this\n            return false;\n        }\n        break;\n      }\n      case \"equipment\": {\n        if (subtype === \"shield\" && item.system.equipmentSubtype === \"other\") {\n          result = this.allowed.buckler;\n        } else {\n          result = this.allowed[item.system.equipmentSubtype];\n        }\n        break;\n      }\n    }\n\n    if (result && this.addon) {\n      // If we're an addon, we need to check if the addon is valid for the item\n      return this.isValidAddon(item) ?? false;\n    }\n    return result; // Finally made it through the gauntlet!\n  }\n\n  /**\n   * Check if a given addon material is valid for the chosen material\n   *\n   * @param {ItemPF|Material|string} material - Item, material, or material ID for which to test if this addon is valid.\n   * @returns {boolean|null} - Null if the provided parameter is invalid, boolean otherwise.\n   */\n  isValidAddon(material) {\n    // Convert item and material IDs to actual material\n    if (material instanceof Item) material = ffd20.registry.materials.get(material.normalMaterial);\n    else if (typeof material === \"string\") material = ffd20.registry.materials.get(material);\n\n    if (!(material instanceof Material)) {\n      if (this.intrinsic) return true;\n      return null; // Material not found or is invalid data\n    }\n\n    if (this.addon === material.addon) return false; // Both are addons or both are not addons\n\n    return !this.incompatible.includes(material.id);\n  }\n}\n\n/**\n * The singleton registry of materials.\n *\n * At runtime this registry is accessible as `ffd20.registry.materials`.\n *\n * @group Materials\n * @see {@link Registry}\n * @see {@link Material}\n * @augments {Registry<Material>}\n */\nexport class Materials extends Registry {\n  /** @inheritdoc */\n  static model = Material;\n\n  /** @inheritdoc */\n  static _defaultData = /** @type {const} */ ([\n    {\n      _id: \"cloth\",\n      hardness: 0,\n      healthPerInch: 2,\n      healthMultiplier: 0.07,\n    },\n    {\n      _id: \"leather\",\n      hardness: 2,\n      healthPerInch: 5,\n      healthMultiplier: 0.17,\n    },\n    {\n      _id: \"adamantine\",\n      baseMaterial: [\"steel\"],\n      hardness: 20,\n      healthPerInch: 40,\n      dr: true,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      healthMultiplier: 1.34,\n      price: {\n        ammunition: 60.0,\n        lightWeapon: 3000.0,\n        oneHandWeapon: 3000.0,\n        twoHandWeapon: 3000.0,\n        rangedOneHandWeapon: 3000.0,\n        rangedTwoHandWeapon: 3000.0,\n        lightArmor: 5000.0,\n        mediumArmor: 10000.0,\n        heavyArmor: 15000.0,\n      },\n    },\n    {\n      _id: \"alchemicalSilver\",\n      shortName: \"FFD20.Materials.Types.silver\",\n      baseMaterial: [\"steel\"],\n      hardness: 8,\n      healthPerInch: 10,\n      incompatible: [\"adamantine\", \"coldIron\", \"mithral\", \"nexavaranSteel\", \"silversheen\", \"sunsilver\"],\n      dr: true,\n      addon: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      healthMultiplier: 0.34,\n      price: {\n        ammunition: 2.0,\n        lightWeapon: 20.0,\n        oneHandWeapon: 90.0,\n        twoHandWeapon: 180.0,\n        rangedOneHandWeapon: 90.0,\n        rangedTwoHandWeapon: 180.0,\n      },\n    },\n    {\n      _id: \"angelSkin\",\n      baseMaterial: [\"leather\"],\n      hardness: 5,\n      healthPerInch: 5,\n      masterwork: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        heavyArmor: false,\n      },\n      healthMultiplier: 0.17,\n      price: {\n        lightArmor: 1000.0,\n        mediumArmor: 2000.0,\n      },\n    },\n    {\n      _id: \"aszite\",\n      addon: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        lightArmor: 750.0,\n        mediumArmor: 750.0,\n        heavyArmor: 1000.0,\n      },\n      weight: {\n        multiplier: 1.1,\n      },\n    },\n    {\n      _id: \"blackwood\",\n      baseMaterial: [\"wood\"],\n      hardness: 7,\n      healthPerInch: 10,\n      masterwork: true,\n      shield: {\n        acp: -2,\n      },\n      price: {\n        perPound: 20.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"blightQuartz\",\n      addon: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        ammunition: 200.0,\n        lightWeapon: 2500.0,\n        oneHandWeapon: 2500.0,\n        twoHandWeapon: 2500.0,\n        rangedOneHandWeapon: 2500.0,\n        rangedTwoHandWeapon: 2500.0,\n      },\n    },\n    {\n      _id: \"bloodCrystal\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 10,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      healthMultiplier: 0.5,\n      price: {\n        ammunition: 30.0,\n        lightWeapon: 1500.0,\n        oneHandWeapon: 1500.0,\n        twoHandWeapon: 1500.0,\n        rangedOneHandWeapon: 1500.0,\n        rangedTwoHandWeapon: 1500.0,\n      },\n    },\n    {\n      _id: \"caphorite\",\n      baseMaterial: [\"steel\"],\n      // No official hardness stat\n      // No official hp per inch stat\n      // Only allowed to be used for ammunition so these stats are not necessary\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        ammunition: 10.0,\n      },\n    },\n    {\n      _id: \"coldIron\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      dr: true,\n      price: {\n        multiplier: 2.0,\n        enhancement: {\n          weapon: 2_000,\n        },\n      },\n    },\n    {\n      _id: \"cryptstone\",\n      baseMaterial: [\"stone\", \"steel\", \"wood\"],\n      hardness: 10,\n      healthPerInch: 30,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        ammunition: 10.0,\n        lightWeapon: 500.0,\n        oneHandWeapon: 500.0,\n        twoHandWeapon: 500.0,\n        rangedOneHandWeapon: 500.0,\n        rangedTwoHandWeapon: 500.0,\n      },\n    },\n    {\n      _id: \"darkleafCloth\",\n      baseMaterial: [\"leather\", \"cloth\"],\n      hardness: 10,\n      healthPerInch: 20,\n      masterwork: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        heavyArmor: false,\n      },\n      armor: {\n        acp: -3,\n        maxDex: 2,\n        asf: -10,\n      },\n      healthMultiplier: 4.0,\n      price: {\n        lightArmor: 750.0,\n        mediumArmor: 1500.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"darkwood\",\n      baseMaterial: [\"wood\"],\n      hardness: 5,\n      healthPerInch: 10,\n      masterwork: true,\n      shield: {\n        acp: -2,\n      },\n      price: {\n        perPound: 10.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"dragonhide\",\n      baseMaterial: [\"leather\"],\n      hardness: 10,\n      healthPerInch: 10, // Typically Â½ and 1 inch thick\n      masterwork: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        buckler: false,\n        towerShield: false,\n      },\n      price: {\n        multiplier: 2.0,\n      },\n    },\n    {\n      _id: \"druchite\",\n      addon: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      healthMultiplier: 1.34,\n      price: {\n        ammunition: 12.0,\n        lightWeapon: 1200.0,\n        oneHandWeapon: 1200.0,\n        twoHandWeapon: 1200.0,\n        rangedOneHandWeapon: 1200.0,\n        rangedTwoHandWeapon: 1200.0,\n        lightArmor: 1000.0,\n        mediumArmor: 1500.0,\n        heavyArmor: 2000.0,\n      },\n    },\n    {\n      _id: \"eelHide\",\n      baseMaterial: [\"leather\"],\n      hardness: 2,\n      healthPerInch: 5,\n      masterwork: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        heavyArmor: false,\n      },\n      armor: {\n        acp: -1,\n        maxDex: 1,\n      },\n      price: {\n        lightArmor: 1200.0,\n        mediumArmor: 1800.0,\n      },\n    },\n    {\n      _id: \"elysianBronze\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        ammunition: 20.0,\n        lightWeapon: 1000.0,\n        oneHandWeapon: 1000.0,\n        twoHandWeapon: 1000.0,\n        rangedOneHandWeapon: 1000.0,\n        rangedTwoHandWeapon: 1000.0,\n        lightArmor: 1000.0,\n        mediumArmor: 2000.0,\n        heavyArmor: 3000.0,\n      },\n    },\n    {\n      _id: \"fireForgedSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        ammunition: 15.0,\n        lightWeapon: 600.0,\n        oneHandWeapon: 600.0,\n        twoHandWeapon: 600.0,\n        rangedOneHandWeapon: 600.0,\n        rangedTwoHandWeapon: 600.0,\n        lightArmor: 1000.0,\n        mediumArmor: 2500.0,\n        heavyArmor: 3000.0,\n      },\n    },\n    {\n      _id: \"frostForgedSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        ammunition: 15.0,\n        lightWeapon: 600.0,\n        oneHandWeapon: 600.0,\n        twoHandWeapon: 600.0,\n        rangedOneHandWeapon: 600.0,\n        rangedTwoHandWeapon: 600.0,\n        lightArmor: 1000.0,\n        mediumArmor: 2500.0,\n        heavyArmor: 3000.0,\n      },\n    },\n    {\n      _id: \"glaucite\",\n      baseMaterial: [\"steel\"],\n      hardness: 15,\n      healthPerInch: 30,\n      allowed: {\n        buckler: false,\n      },\n      price: {\n        multiplier: 3.0,\n      },\n      weight: {\n        multiplier: 1.5,\n      },\n    },\n    {\n      _id: \"greenwood\",\n      baseMaterial: [\"wood\"],\n      hardness: 5,\n      healthPerInch: 10,\n      masterwork: true,\n      price: {\n        perPound: 50.0,\n        ammunition: 6.0,\n        lightWeapon: 300.0,\n        oneHandWeapon: 300.0,\n        twoHandWeapon: 300.0,\n        rangedOneHandWeapon: 300.0,\n        rangedTwoHandWeapon: 300.0,\n        shield: 150.0,\n        lightArmor: 150.0,\n        mediumArmor: 150.0,\n        heavyArmor: 150.0,\n      },\n    },\n    {\n      _id: \"griffonMane\",\n      baseMaterial: [\"cloth\"],\n      hardness: 1,\n      healthPerInch: 4,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      healthMultiplier: 2.0,\n      price: {\n        perPound: 50.0,\n        lightArmor: 200.0,\n      },\n    },\n    {\n      _id: \"heatstonePlating\",\n      addon: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        heavyArmor: false,\n      },\n      price: {\n        lightArmor: 800.0,\n        mediumArmor: 1000.0,\n      },\n      weight: {\n        bonusPerPound: 0.2,\n      },\n    },\n    {\n      _id: \"horacalcum\",\n      baseMaterial: [\"steel\"],\n      hardness: 15,\n      healthPerInch: 30,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      healthMultiplier: 1.25, // Horacalcum actually has additional multiplier over health per inch\n      price: {\n        ammunition: 120.0,\n        lightWeapon: 6000.0,\n        oneHandWeapon: 6000.0,\n        twoHandWeapon: 6000.0,\n        rangedOneHandWeapon: 6000.0,\n        rangedTwoHandWeapon: 6000.0,\n        lightArmor: 10000.0,\n        mediumArmor: 30000.0,\n        heavyArmor: 60000.0,\n      },\n    },\n    {\n      _id: \"inubrix\",\n      baseMaterial: [\"steel\"],\n      hardness: 5,\n      healthPerInch: 10,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      healthMultiplier: 0.34,\n      price: {\n        ammunition: 100.0,\n        lightWeapon: 5000.0,\n        oneHandWeapon: 5000.0,\n        twoHandWeapon: 5000.0,\n        rangedOneHandWeapon: 5000.0,\n        rangedTwoHandWeapon: 5000.0,\n      },\n    },\n    /* This is added for completenss' sake, but it's not an applicable material outside of constructs.\n    {\n      _id: \"irespanBasalt\",\n      baseMaterial: [\"stone\"],\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      hardness: 10,\n      price: {\n        perPound: 0.5,\n      },\n    },\n    */\n    {\n      _id: \"lazurite\",\n      addon: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        lightArmor: 1500.0,\n        mediumArmor: 2500.0,\n        heavyArmor: 3500.0,\n      },\n    },\n    {\n      _id: \"liquidGlass\",\n      baseMaterial: [\"glass\", \"steel\", \"wood\", \"stone\"], // BUG: Does not actually state base material\n      hardness: 10,\n      healthPerInch: 10,\n      healthMultiplier: 0.34,\n      price: {\n        perPound: 250.0,\n        ammunition: 16.0,\n        lightWeapon: 800.0,\n        oneHandWeapon: 800.0,\n        twoHandWeapon: 800.0,\n        rangedOneHandWeapon: 800.0,\n        rangedTwoHandWeapon: 800.0,\n      },\n    },\n    {\n      _id: \"livingSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 15,\n      healthPerInch: 35,\n      healthMultiplier: 1.16,\n      price: {\n        perPound: 250.0,\n        ammunition: 10.0,\n        lightWeapon: 500.0,\n        oneHandWeapon: 500.0,\n        twoHandWeapon: 500.0,\n        rangedOneHandWeapon: 500.0,\n        rangedTwoHandWeapon: 500.0,\n        shield: 100.0,\n        lightArmor: 500.0,\n        mediumArmor: 1000.0,\n        heavyArmor: 1500.0,\n      },\n    },\n    {\n      _id: \"mithral\",\n      baseMaterial: [\"steel\"],\n      treatedAs: \"alchemicalSilver\",\n      hardness: 15,\n      healthPerInch: 30,\n      masterwork: true,\n      armor: {\n        acp: 3,\n        maxDex: 2,\n        asf: -10,\n      },\n      shield: {\n        acp: 3,\n        maxDex: 2,\n        asf: -10,\n      },\n      price: {\n        perPound: 500, // Non-armor/shield only\n        shield: 1000.0,\n        lightArmor: 1000.0,\n        mediumArmor: 4000.0,\n        heavyArmor: 9000.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"nexavaranSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      dr: true,\n      treatedAs: \"coldIron\",\n      price: {\n        multiplier: 1.5,\n        enhancement: {\n          weapon: 3_000,\n        },\n      },\n    },\n    {\n      _id: \"noqual\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      armor: {\n        acp: -3,\n        maxDex: 2,\n        asf: 20,\n      },\n      shield: {\n        acp: -3,\n        maxDex: 2,\n        asf: 20,\n      },\n      price: {\n        ammunition: 10.0,\n        lightWeapon: 500.0,\n        oneHandWeapon: 500.0,\n        twoHandWeapon: 500.0,\n        rangedOneHandWeapon: 500.0,\n        rangedTwoHandWeapon: 500.0,\n        shield: 2000.0,\n        lightArmor: 4000.0,\n        mediumArmor: 8000.0,\n        heavyArmor: 12000.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"paueliel\",\n      baseMaterial: [\"wood\"],\n      hardness: 7,\n      healthPerInch: 10,\n      masterwork: true,\n      shield: {\n        acp: -2,\n      },\n      price: {\n        perPound: 15.0,\n      },\n      weight: {\n        multiplier: 0.5,\n      },\n    },\n    {\n      _id: \"pyresteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 15,\n      allowed: {\n        buckler: false,\n      },\n      healthMultiplier: 0.5,\n      price: {\n        multiplier: 2.0,\n      },\n    },\n    {\n      _id: \"siccatite\",\n      baseMaterial: [\"steel\"],\n      hardness: 10, // Not officially statted\n      healthPerInch: 30, // Not officially statted\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        ammunition: 20.0,\n        lightWeapon: 1000.0,\n        oneHandWeapon: 1000.0,\n        twoHandWeapon: 1000.0,\n        rangedOneHandWeapon: 1000.0,\n        rangedTwoHandWeapon: 1000.0,\n        lightArmor: 6000.0,\n        mediumArmor: 6000.0,\n        heavyArmor: 6000.0,\n      },\n    },\n    {\n      _id: \"silversheen\",\n      baseMaterial: [\"steel\"],\n      treatedAs: \"alchemicalSilver\",\n      hardness: 10, // Not officially statted\n      healthPerInch: 30, // Not officially statted\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        ammunition: 15.0,\n        lightWeapon: 750.0,\n        oneHandWeapon: 750.0,\n        twoHandWeapon: 750.0,\n        rangedOneHandWeapon: 750.0,\n        rangedTwoHandWeapon: 750.0,\n      },\n    },\n    {\n      _id: \"singingSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 20,\n      masterwork: true,\n      armor: {\n        acp: -1,\n        maxDex: 1,\n        asf: -5,\n      },\n      shield: {\n        acp: -1,\n        maxDex: 1,\n        asf: -5,\n      },\n      healthMultiplier: 0.67,\n      price: {\n        perPound: 600.0,\n        ammunition: 120.0,\n        lightWeapon: 6000.0,\n        oneHandWeapon: 6000.0,\n        twoHandWeapon: 6000.0,\n        rangedOneHandWeapon: 6000.0,\n        rangedTwoHandWeapon: 6000.0,\n        shield: 7000.0,\n        lightArmor: 750.0,\n        mediumArmor: 9000.0,\n        heavyArmor: 12000.0,\n      },\n    },\n    {\n      _id: \"spireSteel\",\n      baseMaterial: [\"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      masterwork: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        ammunition: 10.0,\n        lightWeapon: 2000.0,\n        oneHandWeapon: 2000.0,\n        twoHandWeapon: 2000.0,\n        rangedOneHandWeapon: 2000.0,\n        rangedTwoHandWeapon: 2000.0,\n        lightArmor: 1000.0,\n        mediumArmor: 2000.0,\n        heavyArmor: 3000.0,\n      },\n    },\n    {\n      _id: \"steel\",\n      hardness: 10,\n      healthPerInch: 30,\n    },\n    {\n      _id: \"sunsilk\",\n      addon: true,\n      allowed: {\n        lightBlade: false,\n        oneHandBlade: false,\n        twoHandBlade: false,\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n      },\n      price: {\n        lightArmor: 6000.0,\n        mediumArmor: 6000.0,\n        heavyArmor: 6000.0,\n      },\n    },\n    {\n      _id: \"sunsilver\",\n      baseMaterial: [\"steel\"],\n      treatedAs: \"alchemicalSilver\",\n      hardness: 8,\n      healthPerInch: 10,\n      masterwork: true,\n      healthMultiplier: 0.34,\n      price: {\n        perPound: 25.0,\n      },\n    },\n    {\n      _id: \"throneglass\",\n      baseMaterial: [\"glass\", \"steel\", \"wood\", \"stone\"], // BUG: Does not actually state base material\n      hardness: 10, // \"as durable as steel\"\n      healthPerInch: 30, // \"as durable as steel\"\n      allowed: {\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        lightWeapon: 13000.0,\n        oneHandWeapon: 13000.0,\n        twoHandWeapon: 13000.0,\n      },\n    },\n    {\n      _id: \"viridium\",\n      baseMaterial: [\"steel\"],\n      hardness: 5,\n      healthPerInch: 30, // Not officially statted\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        ammunition: 20.0,\n        lightWeapon: 200.0,\n        oneHandWeapon: 200.0,\n        twoHandWeapon: 200.0,\n        rangedOneHandWeapon: 200.0,\n        rangedTwoHandWeapon: 200.0,\n      },\n    },\n    {\n      _id: \"voidglass\",\n      baseMaterial: [\"glass\", \"steel\"],\n      hardness: 10,\n      healthPerInch: 30,\n      price: {\n        lightWeapon: 1000.0,\n        oneHandWeapon: 1000.0,\n        twoHandWeapon: 1000.0,\n        rangedOneHandWeapon: 1000.0,\n        rangedTwoHandWeapon: 1000.0,\n        shield: 3000.0,\n        lightArmor: 1000.0,\n        mediumArmor: 2000.0,\n        heavyArmor: 4500.0,\n      },\n    },\n    {\n      _id: \"whipwood\",\n      baseMaterial: [\"wood\"],\n      hardness: 5,\n      healthPerInch: 10,\n      healthBonus: 5, // Grants flat +5 hp bonus to item regardless of anything else\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        lightWeapon: 500.0,\n        oneHandWeapon: 500.0,\n        twoHandWeapon: 500.0,\n        rangedOneHandWeapon: 500.0,\n        rangedTwoHandWeapon: 500.0,\n      },\n    },\n    {\n      _id: \"wyroot\",\n      baseMaterial: [\"wood\"],\n      hardness: 5,\n      healthPerInch: 10,\n      allowed: {\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n    },\n    {\n      _id: \"bone\",\n      primitive: true,\n      hardness: 5, // Actually half of whatever the base material is for weapons, 5 is true for armor\n      healthPerInch: null, // Same as base material\n    },\n    {\n      _id: \"bronze\",\n      primitive: true,\n      hardness: 9,\n      healthPerInch: 30, // Not officially statted, but speaks of steel\n      allowed: {\n        buckler: false,\n      },\n    },\n    {\n      _id: \"glass\",\n      primitive: true,\n      hardnessMultiplier: 0.5,\n      allowed: {\n        buckler: false,\n      },\n    },\n    {\n      _id: \"gold\",\n      primitive: true,\n      hardnessMultiplier: 0.5,\n      allowed: {\n        buckler: false,\n      },\n      price: {\n        multiplier: 10.0,\n      },\n      weight: {\n        multiplier: 1.5,\n      },\n    },\n    {\n      _id: \"obsidian\",\n      primitive: true,\n      hardnessMultiplier: 0.5,\n      allowed: {\n        rangedWeapon: false,\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      price: {\n        multiplier: 0.5,\n      },\n      weight: {\n        multiplier: 0.75,\n      },\n    },\n    {\n      _id: \"stone\",\n      primitive: true,\n      hardnessMultiplier: 0.5,\n      allowed: {\n        buckler: false,\n      },\n      price: {\n        multiplier: 0.25,\n      },\n      weight: {\n        multiplier: 0.75,\n      },\n    },\n    {\n      _id: \"wood\",\n      hardness: 5,\n      healthPerInch: 10,\n    },\n    {\n      _id: \"magic\",\n      addon: true,\n      intrinsic: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      dr: true,\n    },\n    {\n      _id: \"epic\",\n      addon: true,\n      intrinsic: true,\n      allowed: {\n        buckler: false,\n        lightShield: false,\n        heavyShield: false,\n        towerShield: false,\n        lightArmor: false,\n        mediumArmor: false,\n        heavyArmor: false,\n      },\n      dr: true,\n    },\n  ]);\n}\n\n/**\n * {@inheritDoc Materials}\n *\n * @group Materials\n * @type {Materials}\n */\nexport let materials;\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nconst fields = foundry.data.fields;\n\n/**\n * A single script call category/trigger.\n *\n * @group Script Call Categories\n */\nexport class ScriptCallCategory extends RegistryEntry {\n  static defineSchema() {\n    return {\n      ...super.defineSchema(),\n      itemTypes: new fields.ArrayField(new fields.StringField({})),\n      info: new fields.StringField({ required: true, blank: false, initial: \"\" }, { localize: true }),\n    };\n  }\n}\n\n/**\n * The singleton registry of script call categories/trigger events.\n * At runtime this registry is accessible as `ffd20.registry.scriptCalls`.\n *\n * @group Script Call Categories\n * @see {@link Registry}\n * @see {@link ScriptCallCategory}\n * @augments {Registry<ScriptCallCategory>}\n */\nexport class ScriptCalls extends Registry {\n  /** @inheritdoc */\n  static model = ScriptCallCategory;\n\n  /** @inheritdoc */\n  static _defaultData = /** @type {const} */ ([\n    // Use\n    {\n      _id: \"use\",\n      itemTypes: [\"attack\", \"buff\", \"feat\", \"loot\", \"equipment\", \"implant\", \"consumable\", \"spell\", \"weapon\"],\n      name: \"FFD20.ScriptCalls.Use.Name\",\n      info: \"FFD20.ScriptCalls.Use.Info\",\n    },\n    // Post-Use\n    {\n      _id: \"postUse\",\n      itemTypes: [\"attack\", \"buff\", \"feat\", \"loot\", \"equipment\", \"implant\", \"consumable\", \"spell\", \"weapon\"],\n      name: \"FFD20.ScriptCalls.PostUse.Name\",\n      info: \"FFD20.ScriptCalls.PostUse.Info\",\n    },\n    // Equip\n    {\n      _id: \"equip\",\n      itemTypes: [\"weapon\", \"equipment\", \"loot\"],\n      name: \"FFD20.ScriptCalls.Equip.Name\",\n      info: \"FFD20.ScriptCalls.Equip.Info\",\n    },\n    // Implant\n    {\n      _id: \"implant\",\n      itemTypes: [\"implant\"],\n      name: \"FFD20.ScriptCalls.Implant.Name\",\n      info: \"FFD20.ScriptCalls.Implant.Info\",\n    },\n    // Toggle\n    {\n      _id: \"toggle\",\n      itemTypes: [\"buff\", \"feat\"],\n      name: \"FFD20.ScriptCalls.Toggle.Name\",\n      info: \"FFD20.ScriptCalls.Toggle.Info\",\n    },\n    // Change Quantity\n    {\n      _id: \"changeQuantity\",\n      itemTypes: [\"loot\", \"equipment\", \"weapon\", \"implant\", \"consumable\", \"container\"],\n      name: \"FFD20.ScriptCalls.ChangeQuantity.Name\",\n      info: \"FFD20.ScriptCalls.ChangeQuantity.Info\",\n    },\n    // Change Level\n    {\n      _id: \"changeLevel\",\n      itemTypes: [\"buff\", \"class\"],\n      name: \"FFD20.ScriptCalls.ChangeLevel.Name\",\n      info: \"FFD20.ScriptCalls.ChangeLevel.Info\",\n    },\n  ]);\n}\n\n/**\n * {@inheritDoc ScriptCalls}\n *\n * @group Script Call Categories\n * @type {ScriptCalls}\n */\nexport let scriptCalls;\n","import { Registry, RegistryEntry } from \"./base-registry.mjs\";\n\nimport { ItemChange } from \"@component/change.mjs\";\n\nconst omitFields = (obj, keys) => {\n  for (const key of keys) delete obj[key];\n  return obj;\n};\n\n/**\n * Condition's status HUD behaviour configuration.\n *\n * @group Conditions\n */\nexport class StatusHudModel extends foundry.abstract.DataModel {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      show: new fields.BooleanField({ required: false, initial: true, label: \"Show in token status HUD\" }),\n      include: new fields.SetField(new fields.StringField({ choices: () => Object.keys(game.model.Actor) }), {\n        initial: [],\n        required: false,\n        label: \"Required actor types.\",\n      }),\n      exclude: new fields.SetField(new fields.StringField({ choices: () => Object.keys(game.model.Actor) }), {\n        initial: [],\n        required: false,\n        label: \"Excluded actor types. Has no effect if include list is populated.\",\n      }),\n    };\n  }\n\n  /**\n   * Allowed actor types.\n   *\n   * @remarks\n   * - Undefined if no limitations are present.\n   *\n   * @type {Array<string>|undefined}\n   */\n  get actorTypes() {\n    if (this.include.size) return [...this.include];\n    if (this.exclude.size) return Object.keys(game.model.Actor).filter((type) => !this.exclude.has(type));\n    return undefined;\n  }\n}\n\n/**\n * A single condition entry in the {@link Condition} registry.\n *\n * @group Conditions\n */\nexport class Condition extends RegistryEntry {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    return {\n      ...super.defineSchema(),\n      aliases: new fields.SetField(new fields.StringField({ blank: false, nullable: false })),\n      texture: new fields.StringField({ required: true }),\n      track: new fields.StringField({\n        required: false,\n        blank: false,\n        nullable: true,\n        initial: null,\n        choices: () => Conditions.TRACKS,\n      }),\n      mechanics: new fields.SchemaField({\n        changes: new fields.ArrayField(\n          new fields.SchemaField({ ...omitFields(ItemChange.defineSchema(), [\"_id\", \"value\", \"flavor\"]) })\n        ),\n        flags: new fields.SetField(new fields.StringField({ blank: false })),\n        contexts: new fields.SetField(new fields.StringField({ blank: false })),\n      }),\n      journal: new fields.StringField({ nullable: true, blank: false, required: false }),\n      showInDefense: new fields.BooleanField({ required: false, initial: true }),\n      showInAction: new fields.BooleanField({ required: false, initial: true }),\n      showInBuffsTab: new fields.BooleanField({ required: false, initial: true }),\n      hud: new fields.EmbeddedDataField(StatusHudModel),\n    };\n  }\n\n  /**\n   * Convert condition to format expected by `CONFIG.statusEffects`.\n   *\n   * @returns {object} - Base object\n   */\n  toStatusEffect() {\n    return {\n      id: this.id,\n      name: this.name,\n      img: this.texture,\n      hud: this.hud.show ? this.hud : false,\n    };\n  }\n}\n\n/**\n * The singleton registry of condition types.\n * At runtime this registry is accessible as `ffd20.registry.conditions`.\n *\n * @group Conditions\n * @see {@link Registry}\n * @see {@link Condition}\n * @augments {Registry<Condition>}\n */\nexport class Conditions extends Registry {\n  /** @inheritdoc */\n  static model = Condition;\n\n  /**\n   * An array of allowed tracks of condition advancement.\n   */\n  static TRACKS = /** @type {const} */ ([\"dying\", \"fear\", \"lethargy\", \"movement\"]);\n\n  /**\n   * @internal\n   */\n  static SET_TO_ZERO = /** @type {const} */ ({\n    formula: 0,\n    type: \"untypedPerm\",\n    operator: \"set\",\n    priority: 1001,\n    continuous: true,\n  });\n\n  /**\n   * @internal\n   */\n  static HUD_EXCLUDE_INANIMATE = /** @type {const} */ ({\n    exclude: [\"haunt\", \"trap\", \"vehicle\"],\n  });\n\n  /** @inheritdoc */\n  static _defaultData = [\n    {\n      _id: \"bleed\",\n      aliases: [\"bleeding\"],\n      name: \"FFD20.Condition.bleed\",\n      texture: \"systems/ffd20/icons/conditions/bleed.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.L6DTocj1PbOtuspU\",\n      showInAction: false,\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"blind\",\n      aliases: [\"blinded\", \"blinding\"],\n      name: \"FFD20.Condition.blind\",\n      texture: \"icons/svg/blind.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.A9KUpd2bsdZZsQqj\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"ac\",\n            type: \"untyped\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n        // Perception checks, and spellcraft checks for non-verbal components\n        contexts: [\"skill.per\", \"skill.spl\"],\n      },\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"confused\",\n      aliases: [\"confuse\", \"confusing\"],\n      name: \"FFD20.Condition.confused\",\n      texture: \"systems/ffd20/icons/conditions/confused.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.J2yma0xciBKRUh9t\",\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"cowering\",\n      aliases: [\"cower\"],\n      name: \"FFD20.Condition.cowering\",\n      texture: \"systems/ffd20/icons/conditions/cowering.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.eNW5geiJqrnAjjNu\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"ac\",\n            type: \"untyped\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"dazed\",\n      aliases: [\"daze\", \"dazing\"],\n      name: \"FFD20.Condition.dazed\",\n      texture: \"systems/ffd20/icons/conditions/dazed.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.2A6Gk60pLDKR2zT0\",\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"dazzled\",\n      aliases: [\"dazzle\", \"dazzling\"],\n      name: \"FFD20.Condition.dazzled\",\n      texture: \"systems/ffd20/icons/conditions/dazzled.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.xHUnCadQ2qYsfvV0\",\n      mechanics: {\n        changes: [\n          {\n            formula: -1,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n        ],\n        contexts: [\"skill.per\"],\n      },\n      showInDefense: false,\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"dead\",\n      name: \"FFD20.Condition.dead\",\n      texture: \"icons/svg/skull.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.YvycF7bsU1hPm4pX\",\n      track: \"dying\",\n      showInBuffsTab: false,\n    },\n    {\n      _id: \"deaf\",\n      aliases: [\"deafen\", \"deafened\", \"deafening\"],\n      name: \"FFD20.Condition.deaf\",\n      texture: \"icons/svg/deaf.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.3uIamlB0L1UZUwoF\",\n      mechanics: {\n        changes: [\n          {\n            formula: -4,\n            target: \"init\",\n            type: \"untyped\",\n          },\n        ],\n        // Any skills that take perception modifiers (perception itself and spellcraft when identifying spellcasting with verbal components)\n        // Language dependant saves\n        contexts: [\"savingThrow.will\", \"skill.per\", \"skill.spl\"],\n      },\n      showInAction: false, // TODO: Add configuration that this is to be true for spells only\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"disabled\",\n      aliases: [\"disable\", \"disabling\"],\n      name: \"FFD20.Condition.disabled\",\n      texture: \"systems/ffd20/icons/conditions/disabled.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.dtHHibCiKZzdjyvp\",\n      track: \"dying\",\n      // TODO: Add card tag whenever any \"strenuous\" activity performed\n      showInDefense: false,\n    },\n    {\n      _id: \"dying\",\n      name: \"FFD20.Condition.dying\",\n      texture: \"systems/ffd20/icons/conditions/dying.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.zG6xEGMIerpbnND0\",\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      track: \"dying\",\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"entangled\",\n      aliases: [\"entangle\", \"entangling\"],\n      name: \"FFD20.Condition.entangled\",\n      texture: \"icons/svg/net.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.oxmugd8SoxVjvRRl\",\n      mechanics: {\n        changes: [\n          {\n            formula: -4,\n            target: \"dexPen\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n        ],\n        // TODO: Tag any spellcasting to hint at potential need to roll concentration\n      },\n    },\n    {\n      _id: \"exhausted\",\n      aliases: [\"exhaust\", \"exhausting\"],\n      name: \"FFD20.Condition.exhausted\",\n      texture: \"systems/ffd20/icons/conditions/exhausted.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.ITxxh53qgl74wWcE\",\n      mechanics: {\n        changes: [\n          {\n            formula: -6,\n            target: \"strPen\",\n            type: \"untyped\",\n          },\n          {\n            formula: -6,\n            target: \"dexPen\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      track: \"lethargy\",\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"fatigued\",\n      aliases: [\"fatigue\", \"fatiguing\"],\n      name: \"FFD20.Condition.fatigued\",\n      texture: \"icons/svg/unconscious.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.AVaxTNildXRzYnQm\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"strPen\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"dexPen\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      track: \"lethargy\",\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"flatFooted\",\n      aliases: [\"flatfooted\"],\n      name: \"FFD20.Condition.flatFooted\",\n      texture: \"systems/ffd20/icons/conditions/flat-footed.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.eSvkrrl3US7RJTai\",\n      mechanics: {\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"frightened\",\n      aliases: [\"frighten\", \"frightening\"],\n      name: \"FFD20.Condition.frightened\",\n      texture: \"systems/ffd20/icons/conditions/frightened.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.uqpJ7ZMnWF5qjOTl\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allSavingThrows\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"skills\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allChecks\",\n            type: \"untyped\",\n          },\n        ],\n        // TODO: Include in any card\n      },\n      track: \"fear\",\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"grappled\",\n      aliases: [\"grapple\", \"grappling\"],\n      name: \"FFD20.Condition.grappled\",\n      texture: \"systems/ffd20/icons/conditions/grappled.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.i4gHNAVajJWs4cFI\",\n      mechanics: {\n        changes: [\n          {\n            formula: -4,\n            target: \"dexPen\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n        ],\n        // TODO: Display on spellcasting\n        // TODO: Display on using two-handed actions\n      },\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"helpless\",\n      name: \"FFD20.Condition.helpless\",\n      texture: \"systems/ffd20/icons/conditions/helpless.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.6dtCytJsNkO8Hwq4\",\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"incorporeal\",\n      name: \"FFD20.Condition.incorporeal\",\n      texture: \"systems/ffd20/icons/conditions/incorporeal.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.acqGBiMxTbXZ47zU\",\n      mechanics: {\n        changes: [\n          {\n            formula: 0,\n            target: \"nac\",\n            type: \"base\",\n            operator: \"set\",\n            priority: -10,\n          },\n          {\n            formula: \"max(1, @abilities.cha.mod)\",\n            operator: \"add\",\n            target: \"ac\",\n            type: \"deflection\",\n          },\n        ],\n      },\n      showInAction: false,\n      showInDefense: false,\n    },\n    {\n      _id: \"invisible\",\n      name: \"FFD20.Condition.invisible\",\n      texture: \"icons/svg/invisible.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.Wr2ZWUZcyVWQ4GtX\",\n      // TODO: Display in attack card for potential contextual +2 that was missed\n      showInDefense: false,\n    },\n    {\n      _id: \"nauseated\",\n      aliases: [\"nausea\", \"nauseating\"],\n      name: \"FFD20.Condition.nauseated\",\n      texture: \"systems/ffd20/icons/conditions/nauseated.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.ySiyyK1BMAyKPY4I\",\n      // TODO: Display on any more strenuous action than move action\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"panicked\",\n      aliases: [\"panic\", \"panicking\"],\n      name: \"FFD20.Condition.panicked\",\n      texture: \"icons/svg/terror.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.nGTsTfpWcJTTU3rk\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allSavingThrows\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"skills\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allChecks\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      track: \"fear\",\n      // TODO: Display in any attack card as the condition denies attacking but we don't enforce that\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"paralyzed\",\n      aliases: [\"paralyze\", \"paralyzing\"],\n      name: \"FFD20.Condition.paralyzed\",\n      texture: \"systems/ffd20/icons/conditions/paralyzed.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.24p2Koq4FFCLDKnj\",\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n          {\n            ...this.SET_TO_ZERO,\n            target: \"str\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"petrified\",\n      aliases: [\"petrify\", \"petrifying\"],\n      name: \"FFD20.Condition.petrified\",\n      texture: \"systems/ffd20/icons/conditions/petrified.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.ayGQWwbrhAc99pkH\",\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      showInDefense: false,\n    },\n    {\n      _id: \"pinned\",\n      aliases: [\"pin\", \"pinning\"],\n      name: \"FFD20.Condition.pinned\",\n      texture: \"systems/ffd20/icons/conditions/pinned.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.poCq8gXdDi5leaMT\",\n      mechanics: {\n        changes: [\n          {\n            formula: \"min(0, @abilities.dex.mod)\",\n            target: \"dexMod\",\n            type: \"untyped\",\n            operator: \"set\",\n            priority: 1001,\n            continuous: true,\n          },\n          {\n            formula: -4,\n            target: \"ac\",\n            type: \"untyped\",\n          },\n          {\n            formula: -4,\n            target: \"cmd\",\n            type: \"untyped\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      // TODO: Display in spellcasting actions\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"prone\",\n      name: \"FFD20.Condition.prone\",\n      texture: \"icons/svg/falling.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.VbagnIPQS523dwxa\",\n      mechanics: {\n        changes: [\n          {\n            formula: -4,\n            target: \"mattack\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"shaken\",\n      aliases: [\"shaking\"],\n      name: \"FFD20.Condition.shaken\",\n      texture: \"systems/ffd20/icons/conditions/shaken.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.XxLUswkCuXnXmA5T\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allSavingThrows\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"skills\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allChecks\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      track: \"fear\",\n      showInAction: false,\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"sickened\",\n      aliases: [\"sick\", \"sickening\"],\n      name: \"FFD20.Condition.sickened\",\n      texture: \"systems/ffd20/icons/conditions/sickened.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.7LwCMwrX3tchvrjW\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"wdamage\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allSavingThrows\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"skills\",\n            type: \"untyped\",\n          },\n          {\n            formula: -2,\n            target: \"allChecks\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      showInAction: false,\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"sleep\",\n      aliases: [\"sleeping\"],\n      name: \"FFD20.Condition.sleep\",\n      texture: \"icons/svg/sleep.svg\",\n      journal: null,\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"squeezing\",\n      aliases: [\"squeeze\"],\n      name: \"FFD20.Condition.squeezing\",\n      texture: \"systems/ffd20/icons/conditions/squeezing.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.jzeZ0Uf31CAMZra9\",\n      mechanics: {\n        changes: [\n          {\n            formula: -4,\n            target: \"ac\",\n            type: \"untyped\",\n          },\n          {\n            formula: -4,\n            target: \"attack\",\n            type: \"untyped\",\n          },\n        ],\n      },\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"stable\",\n      aliases: [\"stabilize\", \"stabilized\"],\n      name: \"FFD20.Condition.stable\",\n      texture: \"systems/ffd20/icons/conditions/stable.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.krgVb43Vd62dqpYr\",\n      mechanics: {\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      track: \"dying\",\n      showInAction: false,\n      showInDefense: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"staggered\",\n      aliases: [\"stagger\", \"staggering\"],\n      name: \"FFD20.Condition.staggered\",\n      texture: \"systems/ffd20/icons/conditions/staggered.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.TTp8q9Vb2PNAujWu\",\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"stunned\",\n      aliases: [\"stun\", \"stunning\"],\n      name: \"FFD20.Condition.stunned\",\n      texture: \"icons/svg/stoned.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.ZgsBPY0uVCVl6SGh\",\n      mechanics: {\n        changes: [\n          {\n            formula: -2,\n            target: \"ac\",\n            type: \"untyped\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      showInAction: false,\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"unconscious\",\n      name: \"FFD20.Condition.unconscious\",\n      texture: \"systems/ffd20/icons/conditions/unconscious.svg\",\n      journal: \"Compendium.ffd20.pf1e-rules.JournalEntry.NSqfXaj4MevUR2uJ.JournalEntryPage.kHwbZ38VHCa1wkUF\",\n      mechanics: {\n        // TODO: Cause helpless secondary condition instead\n        changes: [\n          {\n            ...this.SET_TO_ZERO,\n            target: \"dex\",\n          },\n        ],\n        flags: [\"loseDexToAC\"],\n      },\n      hud: {\n        ...foundry.utils.deepClone(this.HUD_EXCLUDE_INANIMATE),\n      },\n    },\n    {\n      _id: \"burrow\",\n      aliases: [\"burrowing\", \"burrowed\"],\n      name: \"EFFECT.StatusBurrow\",\n      texture: \"icons/svg/mole.svg\",\n      track: \"movement\",\n    },\n    {\n      _id: \"fly\",\n      aliases: [\"flying\"],\n      name: \"EFFECT.StatusFlying\",\n      texture: \"icons/svg/wing.svg\",\n      track: \"movement\",\n    },\n    {\n      _id: \"hover\",\n      aliases: [\"hovering\"],\n      name: \"EFFECT.StatusHover\",\n      texture: \"icons/svg/wingfoot.svg\",\n      track: \"movement\",\n    },\n    {\n      _id: \"swim\",\n      aliases: [\"swimming\"],\n      name: \"EFFECT.StatusSwim\",\n      texture: \"systems/ffd20/icons/actions/swim.svg\",\n      track: \"movement\",\n    },\n  ];\n\n  /**\n   * Get condition by ID, including any that have it as alias.\n   *\n   * @experimental\n   * @param {string} id\n   * @returns {Condition|void}\n   */\n  getAliased(id) {\n    // TODO: Cache alias-to-condition mapping?\n    return this.get(id) ?? this.find((entry) => entry.aliases.has(id));\n  }\n\n  /**\n   * Get all conditions that have belong to a given track\n   *\n   * @param {string} track - The given track to check for\n   * @returns {string[]} - An array of all conditions in the given track\n   */\n  conditionsInTrack(track) {\n    return this.contents.filter((condition) => condition.track === track).map((condition) => condition.id);\n  }\n\n  /**\n   * Get all tracks and their conditions\n   *\n   * @returns {string[][]} - Condition tracks\n   */\n  trackedConditions() {\n    return this.tracks.map((track) => this.conditionsInTrack(track));\n  }\n\n  /**\n   * The allowed tracks.\n   *\n   * @see {@link Conditions.TRACKS}\n   *\n   * @type {string[]}\n   */\n  get tracks() {\n    return this.constructor.TRACKS;\n  }\n}\n\n/**\n * {@inheritDoc Conditions}\n *\n * @group Conditions\n * @type {Conditions}\n */\nexport let conditions;\n","import { Registry } from \"./base-registry.mjs\";\nimport { RegistryEntry } from \"./base-registry.mjs\";\n\n// Notes\n// PPC = Player Companion\n// PRG is in rare cases used to refer to core rulebook, but also sometimes to refer to the game in its entirety\n// PCh = Pathfinder Chronicles\n\nclass URLField extends foundry.data.fields.StringField {\n  /** @override */\n  _validateType(value) {\n    super._validateType(value);\n\n    if (!/^https?:\\/\\/[\\w\\d.]+\\.\\w+/.test(value)) throw new Error(\"Must be a valid URL\");\n  }\n}\n\nclass DateField extends foundry.data.fields.StringField {\n  /** @override */\n  _validateType(value) {\n    super._validateType(value);\n\n    if (value && Number.isNaN(Date.parse(value))) {\n      throw new Error(\"Must be valid date in YYYY-MM-DD format.\");\n    }\n  }\n}\n\nexport class Source extends RegistryEntry {\n  static defineSchema() {\n    const fields = foundry.data.fields;\n\n    const optionalString = (options = {}) =>\n      new fields.StringField({ required: false, nullable: true, blank: true, initial: undefined, ...options });\n\n    return {\n      ...super.defineSchema(),\n      name: new fields.StringField({ nullable: false, blank: false, required: true }),\n      abbr: new fields.StringField({ nullable: false, blank: false, required: false, initial: undefined }), // Add constraints\n      date: new DateField({ required: false, nullable: true, blank: false, initial: undefined }),\n      pages: new fields.NumberField({\n        required: false,\n        integer: true,\n        min: 1,\n        initial: undefined,\n        label: \"Page count\",\n      }),\n      isbn: optionalString(), // TODO: Validate ISBN\n      publisher: new fields.StringField({ required: false, blank: false, nullable: false, initial: \"Paizo\" }), // Assume Paizo\n      level: new fields.NumberField({\n        required: false,\n        min: 1,\n        integer: true,\n        initial: undefined,\n        label: \"Starting level\",\n      }),\n      tieIn: optionalString(),\n      url: new URLField({ required: false, nullable: true, blank: true, initial: undefined }),\n      legacy: new fields.BooleanField({ required: false, initial: false, label: \"D&D 3.5 Material\" }),\n      type: optionalString({ choices: () => this.TYPES }),\n    };\n  }\n\n  /**\n   * An array of allowed types of sources.\n   *\n   * core: Core book\n   * companion: Player companion\n   * setting: Campaign setting book\n   * ap: Adventure path\n   * pg: Adventure path - player guide\n   * comic: Comic\n   * pfs: Pathfinder Society\n   * module: Module\n   *\n   * @internal\n   */\n  static TYPES = /** @type {const} */ ([\"core\", \"setting\", \"ap\", \"module\", \"companion\", \"pg\", \"comic\", \"pfs\"]);\n}\n\n/**\n * The singleton registry of sources.\n *\n * At runtime this registry is accessible as `ffd20.registry.sources`.\n *\n * @group Conditions\n * @see {@link Registry}\n * @see {@link Source}\n * @augments {Registry<Source>}\n */\nexport class Sources extends Registry {\n  /** @inheritDoc */\n  static model = Source;\n\n  /**\n   * Book type prefix\n   *\n   * @internal\n   */\n  static PREFIXES = /** @type {const} */ ({\n    companion: \"PPC\", // Pathfinder Player Companion\n  });\n\n  /** @inheritDoc */\n  static _defaultData = /** @type {const} */ ([\n    {\n      _id: \"PZO1110\",\n      name: \"Core Rulebook\",\n      abbr: \"CRB\",\n      date: \"2009-08-13\",\n      pages: 576,\n      isbn: \"978-1-60125-150-3\",\n      url: \"https://paizo.com/products/btpy88yj\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1114\",\n      name: \"GameMastery Guide\",\n      abbr: \"GMG\",\n      date: \"2010-06-23\",\n      pages: 320,\n      isbn: \"978-1-60125-217-3\",\n      url: \"https://paizo.com/products/btpy8ffn\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1112\",\n      name: \"Bestiary [1]\",\n      date: \"2009-10-21\",\n      pages: 320,\n      isbn: \"978-1-60125-183-1\",\n      url: \"https://paizo.com/products/btpy8auu\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1116\",\n      name: \"Bestiary 2\",\n      date: \"2010-12-29\",\n      pages: 320,\n      isbn: \"978-1-60125-268-5\",\n      url: \"https://paizo.com/products/btpy8hif\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1120\",\n      name: \"Bestiary 3\",\n      date: \"2011-12-21\",\n      pages: 320,\n      isbn: \"978-1-60125-378-1\",\n      url: \"https://paizo.com/products/btpy8odu\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1127\",\n      name: \"Bestiary 4\",\n      date: \"2013-10-30\",\n      pages: 320,\n      isbn: \"978-1-60125-575-4\",\n      url: \"https://paizo.com/products/btpy91ds\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1133\",\n      name: \"Bestiary 5\",\n      date: \"2015-11-18\",\n      pages: 320,\n      isbn: \"978-1-60125-792-5\",\n      url: \"https://paizo.com/products/btpy9g9x\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1137\",\n      name: \"Bestiary 6\",\n      date: \"2017-04-26\",\n      pages: 320,\n      isbn: \"978-1-60125-931-8\",\n      url: \"https://paizo.com/products/btpy9r1y\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1129\",\n      name: \"Advanced Class Guide\",\n      abbr: \"ACG\",\n      date: \"2015-08-14\",\n      pages: 256,\n      isbn: \"978-1-60125-671-3\",\n      url: \"https://paizo.com/products/btpy978v\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1115\",\n      name: \"Advanced Player's Guide\",\n      abbr: \"APG\",\n      date: \"2010-08-05\",\n      pages: 320,\n      isbn: \"978-1-60125-246-3\",\n      url: \"https://paizo.com/products/btpy8fo1\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1121\",\n      name: \"Advanced Race Guide\",\n      abbr: \"ARG\",\n      date: \"2012-06-20\",\n      pages: 256,\n      isbn: \"978-1-60125-390-3\",\n      url: \"https://paizo.com/products/btpy8rv2\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1138\",\n      name: \"Adventurer's Guide\",\n      date: \"2017-05-24\",\n      pages: 192,\n      isbn: \"978-1-60125-938-7\",\n      url: \"https://paizo.com/products/btpy9sjo\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1128\",\n      name: \"Strategy Guide\",\n      date: \"2015-03-25\",\n      pages: 160,\n      isbn: \"978-1-60125-626-3\",\n      url: \"https://paizo.com/products/btpy99sk\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1132\",\n      name: \"Occult Adventures\",\n      abbr: \"OA\",\n      date: \"2015-07-29\",\n      pages: 272,\n      isbn: \"978-1-60125-762-8\",\n      url: \"https://paizo.com/products/btpy9egu\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1131\",\n      name: \"Pathfinder Unchained\",\n      date: \"2015-04-29\",\n      pages: 256,\n      isbn: \"978-1-60125-715-4\",\n      url: \"https://paizo.com/products/btpy9c25\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1136\",\n      name: \"Villain Codex\",\n      date: \"2016-11-16\",\n      pages: 256,\n      isbn: \"978-1-60125-906-6\",\n      url: \"https://paizo.com/products/btpy9oo7\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1130\",\n      name: \"Monster Codex\",\n      abbr: \"MC\",\n      date: \"2014-10-22\",\n      pages: 256,\n      isbn: \"978-1-60125-686-7\",\n      url: \"https://paizo.com/products/btpy9926\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1135\",\n      name: \"Horror Adventures\",\n      date: \"2016-08-04\",\n      pages: 256,\n      isbn: \"978-1-60125-849-6\",\n      url: \"https://paizo.com/products/btpy9n5a\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1126\",\n      name: \"Mythic Adventures\",\n      date: \"2013-08-14\",\n      pages: 256,\n      isbn: \"978-1-60125-549-5\",\n      url: \"https://paizo.com/products/btpy8ywe\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1124\",\n      name: \"NPC Codex\",\n      date: \"2012-11-21\",\n      pages: 320,\n      isbn: \"978-1-60125-467-2\",\n      url: \"https://paizo.com/products/btpy8v3a\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1125\",\n      name: \"Ultimate Campaign\",\n      date: \"2013-05-29\",\n      pages: 256,\n      isbn: \"978-1-60125-498-6\",\n      url: \"https://paizo.com/products/btpy8x64\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1118\",\n      name: \"Ultimate Combat\",\n      abbr: \"UC\",\n      date: \"2011-08-04\",\n      pages: 256,\n      isbn: \"978-1-60125-359-0\",\n      url: \"https://paizo.com/products/btpy8mcz\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1123\",\n      name: \"Ultimate Equipment\",\n      abbr: \"UE\",\n      date: \"2012-08-16\",\n      pages: 400,\n      isbn: \"978-1-60125-449-8\",\n      url: \"https://paizo.com/products/btpy8tmc\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1134\",\n      name: \"Ultimate Intrigue\",\n      abbr: \"UI\",\n      date: \"2016-03-30\",\n      pages: 256,\n      isbn: \"978-1-60125-826-7\",\n      url: \"https://paizo.com/products/btpy9j6p\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1117\",\n      name: \"Ultimate Magic\",\n      abbr: \"UM\",\n      date: \"2011-05-08\",\n      pages: 256,\n      isbn: \"978-1-60125-299-9\",\n      url: \"https://paizo.com/products/btpy8k8r\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1139\",\n      name: \"Book of the Damned\",\n      date: \"2017-09-27\",\n      pages: 258,\n      isbn: \"978-1-60125-986-8\",\n      url: \"https://paizo.com/products/btpy9tok\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1140\",\n      name: \"Ultimate Wilderness\",\n      abbr: \"UW\",\n      date: \"2017-11-15\",\n      pages: 288,\n      isbn: \"978-1-60125-986-8\",\n      url: \"https://paizo.com/products/btpy9ujo\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1141\",\n      name: \"Planar Adventures\",\n      abbr: \"PA\",\n      date: \"2018-06-27\",\n      pages: 192,\n      isbn: \"978-1-64078-044-6\",\n      url: \"https://paizo.com/products/btpya1am\",\n      type: \"core\",\n    },\n    {\n      _id: \"PZO1002-PGE\",\n      name: \"Rise of the Runelords Player's Guide\",\n      date: \"2007-09-01\",\n      pages: 16,\n      isbn: \"978-1-60125-059-9\",\n      legacy: true,\n      url: \"https://paizo.com/products/btpy8bd9\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9001\",\n      name: \"Rise of the Runelords #1: Burnt Offerings\",\n      abbr: \"RotR-1\",\n      date: \"2007-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-035-3\",\n      url: \"https://paizo.com/products/btpy7zkr\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9002\",\n      name: \"Rise of the Runelords #2: The Skinsaw Murders\",\n      abbr: \"RotR-2\",\n      date: \"2007-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-037-7\",\n      url: \"https://paizo.com/products/btpy8029\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9003\",\n      name: \"Rise of the Runelords #3: The Hook Mountain Massacre\",\n      abbr: \"RotR-3\",\n      date: \"2007-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-038-4\",\n      url: \"https://paizo.com/products/btpy80e8\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9004\",\n      name: \"Rise of the Runelords #4: Fortress of the Stone Giants\",\n      abbr: \"RotR-4\",\n      date: \"2007-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-039-1\",\n      url: \"https://paizo.com/products/btpy80hm\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9005\",\n      name: \"Rise of the Runelords #5: Sins of the Saviors\",\n      abbr: \"RotR-5\",\n      date: \"2007-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-040-7\",\n      url: \"https://paizo.com/products/btpy815p\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9006\",\n      name: \"Rise of the Runelords #6: Spires of Xin-Shalast\",\n      abbr: \"RotR-6\",\n      date: \"2008-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-041-4\",\n      url: \"https://paizo.com/products/btpy817c\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-2S\",\n      name: \"Curse of the Crimson Throne Player's Guide\",\n      date: \"2008-02-01\",\n      pages: 16,\n      url: \"https://paizo.com/products/btpy806v\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO1021\",\n      name: \"Curse of the Crimson Throne\",\n      date: \"2016-10-01\",\n      pages: 480,\n      isbn: \"978-1-60125-890-8\",\n      url: \"https://paizo.com/products/btpy9nme\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9007\",\n      name: \"Curse of the Crimson Throne #1: Edge of Anarchy\",\n      abbr: \"CotCT-1\",\n      date: \"2008-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-088-9\",\n      url: \"https://paizo.com/products/btpy81xw\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9008\",\n      name: \"Curse of the Crimson Throne #2: Seven Days to the Grave\",\n      abbr: \"CotCT-2\",\n      date: \"2008-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-091-9\",\n      url: \"https://paizo.com/products/btpy82qy\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9009\",\n      name: \"Curse of the Crimson Throne #3: Escape From Old Korvosa\",\n      abbr: \"CotCT-3\",\n      date: \"2008-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-092-6\",\n      url: \"https://paizo.com/products/btpy82t5\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9010\",\n      name: \"Curse of the Crimson Throne #4: A History of Ashes\",\n      abbr: \"CotCT-4\",\n      date: \"2008-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-093-3\",\n      url: \"https://paizo.com/products/btpy82u9\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9011\",\n      name: \"Curse of the Crimson Throne #5: Skeletons of Scarwall\",\n      abbr: \"CotCT-5\",\n      date: \"2008-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-099-5\",\n      url: \"https://paizo.com/products/btpy83yw\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9012\",\n      name: \"Curse of the Crimson Throne #6: Crown of Fangs\",\n      abbr: \"CotCT-6\",\n      date: \"2008-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-109-1\",\n      url: \"https://paizo.com/products/btpy84el\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9401\",\n      name: \"Second Darkness Player's Guide\",\n      date: \"2008-08-01\",\n      pages: 32,\n      isbn: \"978-1-60125-142-8\",\n      legacy: true,\n      url: \"https://paizo.com/products/btpy84en\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9013\",\n      name: \"Second Darkness #1: Shadow in the Sky\",\n      date: \"2008-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-115-2\",\n      url: \"https://paizo.com/products/btpy84em\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9014\",\n      name: \"Second Darkness #2: Children of the Void\",\n      date: \"2008-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-127-5\",\n      url: \"https://paizo.com/products/btpy85ed\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9015\",\n      name: \"Second Darkness #3: The Armageddon Echo\",\n      date: \"2008-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-128-2\",\n      url: \"https://paizo.com/products/btpy85ep\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9016\",\n      name: \"Second Darkness #4: Endless Night\",\n      date: \"2008-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-129-9\",\n      url: \"https://paizo.com/products/btpy85er\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9017\",\n      name: \"Second Darkness #5: A Memory of Darkness\",\n      date: \"2008-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-130-5\",\n      url: \"https://paizo.com/products/btpy86j6\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9018\",\n      name: \"Second Darkness #6: Descent into Midnight\",\n      date: \"2009-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-131-2\",\n      url: \"https://paizo.com/products/btpy86v1\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9404\",\n      name: \"Legacy of Fire Player's Guide\",\n      date: \"2009-03-01\",\n      pages: 32,\n      isbn: \"978-1-60125-168-8\",\n      tieIn: \"Legacy of Fire\",\n      legacy: true,\n      url: \"https://paizo.com/products/btpy8737\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9019\",\n      name: \"Legacy of Fire #1: Howl of the Carrion King\",\n      abbr: \"LoF-1\",\n      date: \"2009-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-159-6\",\n      url: \"https://paizo.com/products/btpy8735\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9020\",\n      name: \"Legacy of Fire #2: House of the Beast\",\n      abbr: \"LoF-2\",\n      date: \"2009-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-160-2\",\n      url: \"https://paizo.com/products/btpy86xw\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9021\",\n      name: \"Legacy of Fire #3: The Jackal's Price\",\n      abbr: \"LoF-3\",\n      date: \"2009-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-161-9\",\n      url: \"https://paizo.com/products/btpy87uv\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9022\",\n      name: \"Legacy of Fire #4: The End of Eternity\",\n      abbr: \"LoF-4\",\n      date: \"2009-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-173-2\",\n      url: \"https://paizo.com/products/btpy87ux\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9023\",\n      name: \"Legacy of Fire #5: The Impossible Eye\",\n      abbr: \"LoF-5\",\n      date: \"2009-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-179-4\",\n      url: \"https://paizo.com/products/btpy88tp\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9024\",\n      name: \"Legacy of Fire #6: The Final Wish\",\n      abbr: \"LoF-6\",\n      date: \"2009-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-185-5\",\n      url: \"https://paizo.com/products/btpy89a2\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-5E\",\n      name: \"Council of Thieves Player's Guide\",\n      date: \"2009-08-01\",\n      pages: 13,\n      url: \"https://paizo.com/products/btpy89m7\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9025\",\n      name: \"Council of Thieves #1: The Bastards of Erebus\",\n      abbr: \"CoT-1\",\n      date: \"2009-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-190-9\",\n      url: \"https://paizo.com/products/btpy89a4\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9026\",\n      name: \"Council of Thieves #2: The Sixfold Trial\",\n      abbr: \"CoT-2\",\n      date: \"2009-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-196-1\",\n      url: \"https://paizo.com/products/btpy89vw\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9027\",\n      name: \"Council of Thieves #3: What Lies in Dust\",\n      abbr: \"CoT-3\",\n      date: \"2009-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-197-8\",\n      url: \"https://paizo.com/products/btpy8b8h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9028\",\n      name: \"Council of Thieves #4: The Infernal Syndrom\",\n      abbr: \"CoT-4\",\n      date: \"2009-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-198-5\",\n      url: \"https://paizo.com/products/btpy8b9h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9029\",\n      name: \"Council of Thieves #5: Mother of Flies\",\n      abbr: \"CoT-5\",\n      date: \"2010-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-199-2\",\n      url: \"https://paizo.com/products/btpy8bc1\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9030\",\n      name: \"Council of Thieves #6: The Twice-Damned Prince\",\n      abbr: \"CoT-6\",\n      date: \"2010-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-226-5\",\n      url: \"https://paizo.com/products/btpy8d54\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-6E\",\n      name: \"Kingmaker Player's Guide\",\n      date: \"2010-03-01\",\n      pages: 16,\n      url: \"https://paizo.com/products/btpy8dqh\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9031\",\n      name: \"Kingmaker #1: Stolen Land\",\n      date: \"2010-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-229-6\",\n      url: \"https://paizo.com/products/btpy8dhc\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9032\",\n      name: \"Kingmaker #2: Rivers Run Red\",\n      date: \"2010-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-233-3\",\n      url: \"https://paizo.com/products/btpy8dml\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9033\",\n      name: \"Kingmaker #3: The Varnhold Vanishing\",\n      date: \"2010-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-234-0\",\n      url: \"https://paizo.com/products/btpy8e7e\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9034\",\n      name: \"Kingmaker #4: Blood for Blood\",\n      date: \"2010-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-251-7\",\n      url: \"https://paizo.com/products/btpy8b7w\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9035\",\n      name: \"Kingmaker #5: War of the River Kings\",\n      date: \"2010-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-252-4\",\n      url: \"https://paizo.com/products/btpy8b7u\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9036\",\n      name: \"Kingmaker #6: Sound of a Thousand Screams\",\n      date: \"2010-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-253-1\",\n      url: \"https://paizo.com/products/btpy8b7x\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-7E\",\n      name: \"Serpent's Skull Player's Guide\",\n      date: \"2010-07-01\",\n      pages: 13,\n      url: \"https://paizo.com/products/btpy8g6d\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9037\",\n      name: \"Serpent's Skull #1: Soul for Smuggler's Shiv\",\n      date: \"2010-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-254-8\",\n      url: \"https://paizo.com/products/btpy8b7v\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9038\",\n      name: \"Serpent's Skull #2: Racing to Ruin\",\n      date: \"2010-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-273-9\",\n      url: \"https://paizo.com/products/btpy8ddc\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9039\",\n      name: \"Serpent's Skull #3: City of Seven Spears\",\n      date: \"2010-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-274-6\",\n      url: \"https://paizo.com/products/btpy8h6h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9040\",\n      name: \"Serpent's Skull #4: Vaults of Madness\",\n      date: \"2010-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-275-3\",\n      url: \"https://paizo.com/products/btpy8dde\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9041\",\n      name: \"Serpent's Skull #5: The Thousand Fangs Below\",\n      date: \"2011-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-276-0\",\n      url: \"https://paizo.com/products/btpy8ddf\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9042\",\n      name: \"Serpent's Skull #6: Sanctum of the Serpent God\",\n      date: \"2011-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-307-1\",\n      url: \"https://paizo.com/products/btpy8g3i\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-8E\",\n      name: \"Carrion Crown Player's Guide\",\n      date: \"2011-03-01\",\n      pages: 15,\n      url: \"https://paizo.com/products/btpy8j0q\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9043\",\n      name: \"Carrion Crown #1: The Haunting of Harrowstone\",\n      abbr: \"CC-1\",\n      date: \"2011-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-308-8\",\n      url: \"https://paizo.com/products/btpy8g7a\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9044\",\n      name: \"Carrion Crown #2: Trial of the Beast\",\n      abbr: \"CC-2\",\n      date: \"2011-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-309-5\",\n      url: \"https://paizo.com/products/btpy8g7b\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9045\",\n      name: \"Carrion Crown #3: Broken Moon\",\n      abbr: \"CC-3\",\n      date: \"2011-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-310-1\",\n      url: \"https://paizo.com/products/btpy8g7c\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9046\",\n      name: \"Carrion Crown #4: Wake of the Watcher\",\n      abbr: \"CC-4\",\n      date: \"2011-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-311-8\",\n      url: \"https://paizo.com/products/btpy8g7d\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9047\",\n      name: \"Carrion Crown #5: Ashes at Dawn\",\n      abbr: \"CC-5\",\n      date: \"2011-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-312-5\",\n      url: \"https://paizo.com/products/btpy8g7e\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9048\",\n      name: \"Carrion Crown #6: Shadows of Gallowspire\",\n      abbr: \"CC-6\",\n      date: \"2011-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-313-2\",\n      url: \"https://paizo.com/products/btpy8g7t\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-9E\",\n      name: \"Jade Regent Player's Guide\",\n      date: \"2011-07-27\",\n      pages: 28,\n      url: \"https://paizo.com/products/btpy8mh3\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9049\",\n      name: \"Jade Regent #1: The Brinewall Legacy\",\n      date: \"2011-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-361-3\",\n      url: \"https://paizo.com/products/btpy8j35\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9050\",\n      name: \"Jade Regent #2: Night of Frozen Shadows\",\n      date: \"2011-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-366-8\",\n      url: \"https://paizo.com/products/btpy8jrr\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9051\",\n      name: \"Jade Regent #3: The Hungry Storm\",\n      date: \"2011-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-374-3\",\n      url: \"https://paizo.com/products/btpy8kgv\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9052\",\n      name: \"Jade Regent #4: Forest of Spirits\",\n      date: \"2011-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-380-4\",\n      url: \"https://paizo.com/products/btpy8l2h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9053\",\n      name: \"Jade Regent #5: Tide of Honor\",\n      date: \"2012-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-385-9\",\n      url: \"https://paizo.com/products/btpy8mh0\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9054\",\n      name: \"Jade Regent #6: The Empty Throne\",\n      date: \"2012-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-400-9\",\n      url: \"https://paizo.com/products/btpy8mh1\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-10E\",\n      name: \"Skull and Shackles Player's Guide\",\n      date: \"2012-02-01\",\n      pages: 30,\n      url: \"https://paizo.com/products/btpy8rwc\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9055\",\n      name: \"Skull & Shackles #1: The Wormwood Mutiny\",\n      date: \"2012-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-404-7\",\n      url: \"https://paizo.com/products/btpy8mh2\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9056\",\n      name: \"Skull & Shackles #2: Raiders of the Fever Sea\",\n      date: \"2012-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-409-2\",\n      url: \"https://paizo.com/products/btpy8moe\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9057\",\n      name: \"Skull & Shackles #3: Tempest Rising\",\n      date: \"2012-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-413-9\",\n      url: \"https://paizo.com/products/btpy8mof\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9058\",\n      name: \"Skull & Shackles #4: Island of Empty Eyes\",\n      date: \"2012-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-416-0\",\n      url: \"https://paizo.com/products/btpy8mog\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9059\",\n      name: \"Skull & Shackles #5: The Price of Infamy\",\n      date: \"2012-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-421-4\",\n      url: \"https://paizo.com/products/btpy8moh\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9060\",\n      name: \"Skull & Shackles #6: From Hell's Heart\",\n      date: \"2012-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-422-1\",\n      url: \"https://paizo.com/products/btpy8moi\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO1002-PGE\",\n      name: \"Rise of the Runelords Anniversary Edition Player's Guide\",\n      date: \"2012-07-01\",\n      pages: 17,\n      url: \"https://paizo.com/products/btpy8tgl\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO1002\",\n      name: \"Rise of the Runelords Anniversary Edition\",\n      abbr: \"RotRAE\",\n      date: \"2012-07-01\",\n      pages: 432,\n      isbn: \"978-1-60125-436-8\",\n      url: \"https://paizo.com/products/btpy8tc0\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-11E\",\n      name: \"Shattered Star Player's Guide\",\n      date: \"2012-08-01\",\n      pages: 12,\n      url: \"https://paizo.com/products/btpy8txj\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9061\",\n      name: \"Shattered Star #1: Shards of Sin\",\n      date: \"2012-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-452-8\",\n      url: \"https://paizo.com/products/btpy8tmh\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9062\",\n      name: \"Shattered Star #2: Curse of the Lady's Light\",\n      date: \"2012-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-459-7\",\n      url: \"https://paizo.com/products/btpy8run\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9063\",\n      name: \"Shattered Star #3: The Asylum Stone\",\n      date: \"2012-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-469-6\",\n      url: \"https://paizo.com/products/btpy8sds\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9064\",\n      name: \"Shattered Star #4: Beyond the Doomsday Door\",\n      date: \"2012-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-474-0\",\n      url: \"https://paizo.com/products/btpy8t35\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9065\",\n      name: \"Shattered Star #5: Into the Nightmare Rift\",\n      date: \"2012-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-487-0\",\n      url: \"https://paizo.com/products/btpy8tdh\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9066\",\n      name: \"Shattered Star #6: The Dead Heart of Xin\",\n      date: \"2013-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-491-7\",\n      url: \"https://paizo.com/products/btpy8tvr\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-12E\",\n      name: \"Reign of Winter Player's Guide\",\n      date: \"2013-02-01\",\n      pages: 14,\n      url: \"https://paizo.com/products/btpy8x1t\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9067\",\n      name: \"Reign of Winter #1: The Snows of Summer\",\n      date: \"2013-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-492-4\",\n      url: \"https://paizo.com/products/btpy8ubg\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9068\",\n      name: \"Reign of Winter #2: The Shackled Hut\",\n      date: \"2013-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-493-1\",\n      url: \"https://paizo.com/products/btpy8uwz\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9069\",\n      name: \"Reign of Winter #3: Maiden, Mother, Crone\",\n      date: \"2013-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-494-8\",\n      url: \"https://paizo.com/products/btpy8xbz\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9070\",\n      name: \"Reign of Winter #4: The Frozen Stars\",\n      date: \"2013-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-495-5\",\n      url: \"https://paizo.com/products/btpy8vss\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9071\",\n      name: \"Reign of Winter #5: Rasputin Must Die!\",\n      date: \"2013-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-496-2\",\n      url: \"https://paizo.com/products/btpy8wbv\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9072\",\n      name: \"Reign of Winter #6: The Witch Queen's Revenge\",\n      date: \"2013-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-497-9\",\n      url: \"https://paizo.com/products/btpy8wve\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-13E\",\n      name: \"Wrath of the Righteous Player's Guide\",\n      date: \"2013-08-09\",\n      pages: 14,\n      url: \"https://paizo.com/products/btpy919c\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9073\",\n      name: \"Wrath of the Righteous #1: The Worldwound Incursion\",\n      date: \"2013-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-553-2\",\n      url: \"https://paizo.com/products/btpy8x8e\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9074\",\n      name: \"Wrath of the Righteous #2: Sword of Valor\",\n      date: \"2013-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-568-6\",\n      url: \"https://paizo.com/products/btpy8xsi\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9075\",\n      name: \"Wrath of the Righteous #3: Demon's Heresy\",\n      date: \"2013-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-577-8\",\n      url: \"https://paizo.com/products/btpy8yor\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9076\",\n      name: \"Wrath of the Righteous #4: The Midnight Isles\",\n      date: \"2013-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-585-3\",\n      url: \"https://paizo.com/products/btpy8z6x\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9077\",\n      name: \"Wrath of the Righteous #5: Herald of the Ivory Labyrinth\",\n      date: \"2014-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-586-0\",\n      url: \"https://paizo.com/products/btpy909v\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9078\",\n      name: \"Wrath of the Righteous #6: City of Locusts\",\n      date: \"2014-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-587-7\",\n      url: \"https://paizo.com/products/btpy921g\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-14E\",\n      name: \"Mummy's Mask Player's Guide\",\n      date: \"2014-03-01\",\n      pages: 14,\n      url: \"https://paizo.com/products/btpy94z3\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9079\",\n      name: \"Mummy's Mask #1: The Half-Dead City\",\n      date: \"2014-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-588-4\",\n      url: \"https://paizo.com/products/btpy94qz\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9080\",\n      name: \"Mummy's Mask #2: Empty Graves\",\n      date: \"2014-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-589-1\",\n      url: \"https://paizo.com/products/btpy94vv\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9081\",\n      name: \"Mummy's Mask #3: Shifting Sands\",\n      date: \"2014-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-590-7\",\n      url: \"https://paizo.com/products/btpy94qb\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9082\",\n      name: \"Mummy's Mask #4: Secrets of the Sphinx\",\n      date: \"2014-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-591-4\",\n      url: \"https://paizo.com/products/btpy9386\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9083\",\n      name: \"Mummy's Mask #5: The Slave Trenches of Hakotep\",\n      date: \"2014-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-592-1\",\n      url: \"https://paizo.com/products/btpy97at\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9084\",\n      name: \"Mummy's Mask #6: Pyramid of the Sky Pharaoh\",\n      date: \"2014-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-593-8\",\n      url: \"https://paizo.com/products/btpy97av\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-15E\",\n      name: \"Iron Gods Player's Guide\",\n      date: \"2014-08-05\",\n      pages: 12,\n      url: \"https://paizo.com/products/btpy98lf\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9085\",\n      name: \"Iron Gods #1: Fires of Creation\",\n      date: \"2014-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-673-7\",\n      url: \"https://paizo.com/products/btpy95br\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9086\",\n      name: \"Iron Gods #2: Lords of Rust\",\n      date: \"2014-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-678-2\",\n      url: \"https://paizo.com/products/btpy95bs\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9087\",\n      name: \"Iron Gods #3: The Choking Tower\",\n      date: \"2014-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-688-1\",\n      url: \"https://paizo.com/products/btpy95bt\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9088\",\n      name: \"Iron Gods #4: Valley of the Brain Collectors\",\n      date: \"2014-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-704-8\",\n      url: \"https://paizo.com/products/btpy95bu\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9089\",\n      name: \"Iron Gods #5: Palace of Fallen Stars\",\n      date: \"2014-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-711-6\",\n      url: \"https://paizo.com/products/btpy95bv\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9090\",\n      name: \"Iron Gods #6: The Divinity Drive\",\n      date: \"2015-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-724-6\",\n      url: \"https://paizo.com/products/btpy95bw\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-16E\",\n      name: \"Giantslayer Player's Guide\",\n      date: \"2015-01-25\",\n      pages: 16,\n      url: \"https://paizo.com/products/btpy9bsv\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9091\",\n      name: \"Giantslayer #1: Battle of Bloodmarch Hill\",\n      date: \"2015-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-725-3\",\n      url: \"https://paizo.com/products/btpy96ps\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9092\",\n      name: \"Giantslayer #2: The Hill Giant's Pledge\",\n      date: \"2015-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-726-0\",\n      url: \"https://paizo.com/products/btpy98t4\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9093\",\n      name: \"Giantslayer #3: Forge of the Giant God\",\n      date: \"2015-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-727-7\",\n      url: \"https://paizo.com/products/btpy98t5\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9094\",\n      name: \"Giantslayer #4: Ice Tomb of the Giant Queen\",\n      date: \"2015-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-728-4\",\n      url: \"https://paizo.com/products/btpy98t6\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9095\",\n      name: \"Giantslayer #5: Anvil of Fire\",\n      date: \"2015-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-729-1\",\n      url: \"https://paizo.com/products/btpy98t7\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9096\",\n      name: \"Giantslayer #6: Shadow of the Storm Tyrant\",\n      date: \"2015-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-730-7\",\n      url: \"https://paizo.com/products/btpy98t8\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-17E\",\n      name: \"Hell's Rebels Player's Guide\",\n      date: \"2015-08-12\",\n      pages: 34,\n      url: \"https://paizo.com/products/btpy9g44\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO9097\",\n      name: \"Hell's Rebels #1: In Hell's Bright Shadow\",\n      date: \"2015-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-768-0\",\n      url: \"https://paizo.com/products/btpy98t9\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9098\",\n      name: \"Hell's Rebels #2: Turn of the Torrent\",\n      date: \"2015-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-784-0\",\n      url: \"https://paizo.com/products/btpy98ta\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9099\",\n      name: \"Hell's Rebels #3: Dance of the Damned\",\n      date: \"2015-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-788-8\",\n      url: \"https://paizo.com/products/btpy98tb\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90100\",\n      name: \"Hell's Rebels #4: A Song of Silver\",\n      date: \"2015-12-01\",\n      pages: 128,\n      isbn: \"978-1-60125-795-6\",\n      url: \"https://paizo.com/products/btpy98tf\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90101\",\n      name: \"Hell's Rebels #5: The Kintargo Contract\",\n      date: \"2016-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-800-7\",\n      url: \"https://paizo.com/products/btpy98td\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90102\",\n      name: \"Hell's Rebels #6: Breaking the Bones of Hell\",\n      date: \"2016-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-808-3\",\n      url: \"https://paizo.com/products/btpy9i8d\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-18E\",\n      name: \"Hell's Vengeance Player's Guide\",\n      date: \"2016-02-25\",\n      pages: 20,\n      url: \"https://paizo.com/products/btpy9jva\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90103\",\n      name: \"Hell's Vengeance #1: The Hellfire Compact\",\n      date: \"2016-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-818-2\",\n      url: \"https://paizo.com/products/btpy9gds\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90104\",\n      name: \"Hell's Vengeance #2: Wrath of Thrune\",\n      date: \"2016-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-824-3\",\n      url: \"https://paizo.com/products/btpy9h32\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90105\",\n      name: \"Hell's Vengeance #3: The Inferno Gate\",\n      date: \"2016-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-827-4\",\n      url: \"https://paizo.com/products/btpy9hj9\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90106\",\n      name: \"Hell's Vengeance #4: For Queen & Empire\",\n      date: \"2016-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-836-6\",\n      url: \"https://paizo.com/products/btpy9ics\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90107\",\n      name: \"Hell's Vengeance #5: Scourge of the Godclaw\",\n      date: \"2016-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-842-7\",\n      url: \"https://paizo.com/products/btpy9ips\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90108\",\n      name: \"Hell's Vengeance #6: Hell Comes to Westcrown\",\n      date: \"2016-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-851-9\",\n      url: \"https://paizo.com/products/btpy9jd0\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-19E\",\n      name: \"Strange Aeons Player's Guide\",\n      date: \"2016-08-17\",\n      pages: 12,\n      url: \"https://paizo.com/products/btpy9nrw\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90109\",\n      name: \"Strange Aeons #1: In Search of Sanity\",\n      date: \"2016-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-882-3\",\n      url: \"https://paizo.com/products/btpy9k5o\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90110\",\n      name: \"Strange Aeons #2: The Thrushmoor Terror\",\n      date: \"2016-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-892-2\",\n      url: \"https://paizo.com/products/btpy9l3g\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90111\",\n      name: \"Strange Aeons #3: Dreams of the Yellow King\",\n      date: \"2016-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-899-1\",\n      url: \"https://paizo.com/products/btpy9mbj\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90112\",\n      name: \"Strange Aeons #4: The Whisper Out of Time\",\n      date: \"2016-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-908-0\",\n      url: \"https://paizo.com/products/btpy9n12\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90113\",\n      name: \"Strange Aeons #5: What Grows Within\",\n      date: \"2017-01-01\",\n      pages: 96,\n      isbn: \"978-1-60125-913-4\",\n      url: \"https://paizo.com/products/btpy9nd3\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90114\",\n      name: \"Strange Aeons #6: Black Stars Beckon\",\n      date: \"2017-02-01\",\n      pages: 96,\n      isbn: \"978-1-60125-919-6\",\n      url: \"https://paizo.com/products/btpy9nd9\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-20E\",\n      name: \"Ironfang Invasion Player's Guide\",\n      date: \"2017-03-16\",\n      pages: 12,\n      url: \"https://paizo.com/products/btpy9sc5\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90115\",\n      name: \"Ironfang Invasion #1: Trail of the Hunted\",\n      date: \"2017-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-926-4\",\n      url: \"https://paizo.com/products/btpy9npj\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90116\",\n      name: \"Ironfang Invasion #2: Fangs of War\",\n      date: \"2017-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-932-5\",\n      url: \"https://paizo.com/products/btpy9npk\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90117\",\n      name: \"Ironfang Invasion #3: Assault on Longshadow\",\n      date: \"2017-04-01\",\n      pages: 96,\n      isbn: \"978-1-60125-935-6\",\n      url: \"https://paizo.com/products/btpy9p1h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90119\",\n      name: \"Ironfang Invasion #4: Siege of Stone\",\n      date: \"2017-05-01\",\n      pages: 96,\n      isbn: \"978-1-60125-940-0\",\n      url: \"https://paizo.com/products/btpy9pn4\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90119\",\n      name: \"Ironfang Invasion #5: Prisoners of the Blight\",\n      date: \"2017-06-01\",\n      pages: 96,\n      isbn: \"978-1-60125-943-1\",\n      url: \"https://paizo.com/products/btpy9npn\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90120\",\n      name: \"Ironfang Invasion #6: Vault of the Onyx Citadel\",\n      date: \"2017-07-01\",\n      pages: 96,\n      isbn: \"978-1-60125-952-3\",\n      url: \"https://paizo.com/products/btpy9pno\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-21E\",\n      name: \"Ruins of Azlant Player's Guide\",\n      date: \"2017-08-03\",\n      pages: 16,\n      url: \"https://paizo.com/products/btpy9uir\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90121\",\n      name: \"Ruins of Azlant #1: The Lost Outpost\",\n      date: \"2017-08-01\",\n      pages: 96,\n      isbn: \"978-1-60125-964-6\",\n      url: \"https://paizo.com/products/btpy9qya\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90122\",\n      name: \"Ruins of Azlant #2: Into the Shattered Continent\",\n      date: \"2017-09-01\",\n      pages: 96,\n      isbn: \"978-1-60125-972-1\",\n      url: \"https://paizo.com/products/btpy9uk0\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90123\",\n      name: \"Ruins of Azlant #3: The Flooded Cathedral\",\n      date: \"2017-10-01\",\n      pages: 96,\n      isbn: \"978-1-60125-981-3\",\n      url: \"https://paizo.com/products/btpy9uk2\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90124\",\n      name: \"Ruins of Azlant #4: City in the Deep\",\n      date: \"2017-11-01\",\n      pages: 96,\n      isbn: \"978-1-60125-988-2\",\n      url: \"https://paizo.com/products/btpy9x2h\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90125\",\n      name: \"Ruins of Azlant #5: Tower of the Drowned Dead\",\n      date: \"2017-12-01\",\n      pages: 96,\n      isbn: \"978-1-60125-998-1\",\n      url: \"https://paizo.com/products/btpy9xa1\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90126\",\n      name: \"Ruins of Azlant #6: Beyond the Veiled Past\",\n      date: \"2017-12-01\",\n      pages: 96,\n      isbn: \"978-1-64078-009-5\",\n      url: \"https://paizo.com/products/btpy9xf0\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-22E\",\n      name: \"War for the Crown Player's Guide\",\n      date: \"2018-03-22\",\n      pages: 18,\n      url: \"https://paizo.com/products/btpya08v\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90127\",\n      name: \"War for the Crown #1: Crownfall\",\n      date: \"2018-02-01\",\n      pages: 96,\n      isbn: \"978-1-64078-015-6\",\n      url: \"https://paizo.com/products/btpy9zk7\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90128\",\n      name: \"War for the Crown #2: Songbird, Scion, Saboteur\",\n      date: \"2018-03-01\",\n      pages: 96,\n      isbn: \"978-1-64078-025-5\",\n      url: \"https://paizo.com/products/btpya04x\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90129\",\n      name: \"War for the Crown #3: The Twilight Child\",\n      date: \"2018-04-01\",\n      pages: 96,\n      isbn: \"978-1-64078-032-3\",\n      url: \"https://paizo.com/products/btpya0fi\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90130\",\n      name: \"War for the Crown #4: City in the Lion's Eye\",\n      date: \"2018-05-01\",\n      pages: 96,\n      isbn: \"978-1-64078-037-8\",\n      url: \"https://paizo.com/products/btpy9wmy\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90131\",\n      name: \"War for the Crown #5: The Reaper's Right Hand\",\n      date: \"2018-06-01\",\n      pages: 96,\n      isbn: \"978-1-64078-045-3\",\n      url: \"https://paizo.com/products/btpy9x04\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90132\",\n      name: \"War for the Crown #6: The Six-Legend Soul\",\n      date: \"2018-07-01\",\n      pages: 96,\n      isbn: \"978-1-64078-052-1\",\n      url: \"https://paizo.com/products/btpy9xdq\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-23E\",\n      name: \"Return of the Runelords Player's Guide\",\n      date: \"2018-09-05\",\n      pages: 14,\n      url: \"https://paizo.com/products/btq01su5\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90133\",\n      name: \"Return of the Runelords #1: Secrets of Roderic's Cove\",\n      date: \"2018-08-01\",\n      pages: 96,\n      isbn: \"978-1-64078-062-0\",\n      url: \"https://paizo.com/products/btpy9y26\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90134\",\n      name: \"Return of the Runelords #2: It Came from Hollow Mountain\",\n      date: \"2018-09-01\",\n      pages: 96,\n      isbn: \"978-1-64078-070-5\",\n      url: \"https://paizo.com/products/btpy9z14\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90135\",\n      name: \"Return of the Runelords #3: Runeplague\",\n      date: \"2018-10-01\",\n      pages: 96,\n      isbn: \"978-1-64078-079-8\",\n      url: \"https://paizo.com/products/btpy9zsl\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90136\",\n      name: \"Return of the Runelords #4: Temple of the Peacock Spirit\",\n      date: \"2018-11-01\",\n      pages: 96,\n      isbn: \"978-1-64078-091-0\",\n      url: \"https://paizo.com/products/btpya0b5\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90137\",\n      name: \"Return of the Runelords #5: The City Outside of Time\",\n      date: \"2018-12-01\",\n      pages: 96,\n      isbn: \"978-1-64078-098-9\",\n      url: \"https://paizo.com/products/btq01vak\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90138\",\n      name: \"Return of the Runelords #6: Rise of New Thassilon\",\n      date: \"2019-01-01\",\n      pages: 96,\n      isbn: \"978-1-64078-106-1\",\n      url: \"https://paizo.com/products/btq01w1w\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9000-24E\",\n      name: \"Tyrant's Grasp Player's Guide\",\n      date: \"2019-02-08\",\n      pages: 9,\n      url: \"https://paizo.com/products/btq01xdp\",\n      type: \"pg\",\n    },\n    {\n      _id: \"PZO90139\",\n      name: \"Tyrant's Grasp #1: The Dead Roads\",\n      date: \"2019-02-01\",\n      pages: 96,\n      isbn: \"978-1-64078-111-5\",\n      url: \"https://paizo.com/products/btq01ws3\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90140\",\n      name: \"Tyrant's Grasp #2: Eulogy for Roslar's Coffer\",\n      date: \"2019-03-01\",\n      pages: 96,\n      isbn: \"978-1-64078-119-1\",\n      url: \"https://paizo.com/products/btq01x4b\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90141\",\n      name: \"Tyrant's Grasp #3: Last Watch\",\n      date: \"2019-04-01\",\n      pages: 96,\n      isbn: \"978-1-64078-126-9\",\n      url: \"https://paizo.com/products/btq01x4f\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90142\",\n      name: \"Tyrant's Grasp #4: Gardens of Gallowspire\",\n      date: \"2019-05-01\",\n      pages: 96,\n      isbn: \"978-1-64078-134-4\",\n      url: \"https://paizo.com/products/btq01xj6\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90143\",\n      name: \"Tyrant's Grasp #5: Borne by the Sun's Grace\",\n      date: \"2019-06-01\",\n      pages: 96,\n      isbn: \"978-1-64078-140-5\",\n      url: \"https://paizo.com/products/btq01znj\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO90144\",\n      name: \"Tyrant's Grasp #6: Midwives to Death\",\n      date: \"2019-08-01\",\n      pages: 96,\n      isbn: \"978-1-64078-144-3\",\n      url: \"https://paizo.com/products/btq01zno\",\n      type: \"ap\",\n    },\n    {\n      _id: \"PZO9500\",\n      name: \"Hollow's Last Hope\",\n      date: \"2007-06-01\",\n      pages: 16,\n      level: 1,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9501\",\n      name: \"Crown of the Kobold King\",\n      date: \"2007-06-01\",\n      pages: 32,\n      level: 2,\n      isbn: \"978-1-60125-048-3\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9502\",\n      name: \"Conquest of Bloodsworn Vale\",\n      date: \"2007-07-01\",\n      pages: 32,\n      level: 6,\n      isbn: \"978-1-60125-049-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9503\",\n      name: \"Seven Swords of Sin\",\n      date: \"2007-08-01\",\n      pages: 32,\n      level: 7,\n      isbn: \"978-1-60125-050-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9504\",\n      name: \"Gallery of Evil\",\n      date: \"2007-09-01\",\n      pages: 32,\n      level: 8,\n      isbn: \"978-1-60125-051-3\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9505\",\n      name: \"Entombed with the Pharaohs\",\n      date: \"2007-10-01\",\n      pages: 32,\n      level: 6,\n      isbn: \"978-1-60125-052-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-TC1\",\n      name: \"Into the Haunted Forest\",\n      date: \"2007-11-01\",\n      pages: 16,\n      level: 1,\n      isbn: \"978-1-60125-108-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9506\",\n      name: \"Carnival of Tears\",\n      date: \"2007-11-01\",\n      pages: 32,\n      level: 5,\n      isbn: \"978-1-60125-055-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9507\",\n      name: \"Guardians of Dragonfall\",\n      date: \"2007-12-01\",\n      pages: 32,\n      level: 11,\n      isbn: \"978-1-60125-056-8\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9508\",\n      name: \"Hangman's Noose\",\n      date: \"2008-01-01\",\n      pages: 32,\n      level: 1,\n      isbn: \"978-1-60125-073-5\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9509\",\n      name: \"Crucible of Chaos\",\n      date: \"2008-02-01\",\n      pages: 32,\n      level: 8,\n      isbn: \"978-1-60125-074-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9510\",\n      name: \"River into Darkness\",\n      date: \"2008-03-01\",\n      pages: 32,\n      level: 4,\n      isbn: \"978-1-60125-075-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9511\",\n      name: \"The Demon Within\",\n      date: \"2008-04-01\",\n      pages: 32,\n      level: 11,\n      isbn: \"978-1-60125-076-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9512\",\n      name: \"Flight of the Red Raven\",\n      date: \"2008-05-01\",\n      pages: 32,\n      level: 4,\n      isbn: \"978-1-60125-101-5\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-2\",\n      name: \"Revenge of the Kobold King\",\n      date: \"2008-06-01\",\n      pages: 16,\n      level: 5,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9513\",\n      name: \"Tower of the Last Baron\",\n      date: \"2008-06-01\",\n      pages: 32,\n      level: 5,\n      isbn: \"978-1-60125-102-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9514\",\n      name: \"Treasure of Chimera Cove\",\n      date: \"2008-10-01\",\n      pages: 32,\n      level: 7,\n      isbn: \"978-1-60125-119-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9515\",\n      name: \"Hungry Are the Dead\",\n      date: \"2008-10-01\",\n      pages: 32,\n      level: 6,\n      isbn: \"978-1-60125-120-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9516\",\n      name: \"The Pact Stone Pyramid\",\n      date: \"2008-11-01\",\n      pages: 32,\n      level: 8,\n      isbn: \"978-1-60125-145-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9517\",\n      name: \"Clash of the Kingslayers\",\n      date: \"2009-01-01\",\n      pages: 32,\n      level: 10,\n      isbn: \"978-1-60125-125-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9518\",\n      name: \"Blood of Dragonscar\",\n      date: \"2009-03-01\",\n      pages: 32,\n      level: 15,\n      isbn: \"978-1-60125-170-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9519\",\n      name: \"Beyond the Vault of Souls\",\n      date: \"2009-07-01\",\n      pages: 32,\n      level: 9,\n      isbn: \"978-1-60125-174-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9520NM\",\n      name: \"Crypt of the Everflame\",\n      date: \"2009-08-01\",\n      pages: 32,\n      level: 1,\n      isbn: \"978-1-60125-186-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9521\",\n      name: \"Carrion Hill\",\n      date: \"2009-11-01\",\n      pages: 32,\n      level: 5,\n      isbn: \"978-1-60125-206-7\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9522\",\n      name: \"Masks of the Living God\",\n      date: \"2009-12-01\",\n      pages: 32,\n      level: 3,\n      isbn: \"978-1-60125-207-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9523\",\n      name: \"Realm of the Fellnight Queen\",\n      date: \"2010-02-01\",\n      pages: 32,\n      level: 7,\n      isbn: \"978-1-60125-224-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9524\",\n      name: \"City of Golden Death\",\n      date: \"2010-04-01\",\n      pages: 32,\n      level: 5,\n      isbn: \"978-1-60125-225-8\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9525\",\n      name: \"From Shore to Sea\",\n      date: \"2010-06-01\",\n      pages: 32,\n      level: 6,\n      isbn: \"978-1-60125-257-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-4\",\n      name: \"Master of the Fallen Fortress\",\n      date: \"2010-06-01\",\n      pages: 16,\n      level: 1,\n      isbn: \"978-1-60125-365-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9526\",\n      name: \"Curse of the Riven Sky\",\n      date: \"2010-07-01\",\n      pages: 32,\n      level: 10,\n      isbn: \"978-1-60125-258-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9527\",\n      name: \"The Witchwar Legacy\",\n      date: \"2010-09-01\",\n      pages: 32,\n      level: 17,\n      isbn: \"978-1-60125-279-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9528\",\n      name: \"The Godsmouth Heresy\",\n      date: \"2010-12-01\",\n      pages: 32,\n      level: 1,\n      isbn: \"978-1-60125-280-7\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9529\",\n      name: \"Cult of the Ebon Destroyers\",\n      date: \"2011-02-01\",\n      pages: 32,\n      level: 8,\n      isbn: \"978-1-60125-317-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9530\",\n      name: \"Tomb of the Iron Medusa\",\n      date: \"2011-04-01\",\n      pages: 32,\n      level: 14,\n      isbn: \"978-1-60125-318-7\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9531\",\n      name: \"Academy of Secrets\",\n      date: \"2011-06-01\",\n      pages: 32,\n      level: 13,\n      isbn: \"978-1-60125-343-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-5\",\n      name: \"We Be Goblins!\",\n      date: \"2011-06-01\",\n      pages: 16,\n      level: 1,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9532\",\n      name: \"The Harrowing\",\n      date: \"2011-07-01\",\n      pages: 32,\n      level: 9,\n      isbn: \"978-1-60125-355-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9533\",\n      name: \"Feast of Ravenmoor\",\n      date: \"2011-09-01\",\n      pages: 32,\n      level: 3,\n      isbn: \"978-1-60125-367-5\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9534\",\n      name: \"The Ruby Phoenix Tournament\",\n      date: \"2012-01-01\",\n      pages: 32,\n      level: 11,\n      isbn: \"978-1-60125-381-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9535\",\n      name: \"The Midnight Mirror\",\n      date: \"2012-04-01\",\n      pages: 32,\n      level: 4,\n      isbn: \"978-1-60125-401-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9536\",\n      name: \"No Response from Deepmar\",\n      date: \"2012-05-01\",\n      pages: 32,\n      level: 8,\n      isbn: \"978-1-60125-410-8\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-6\",\n      name: \"Dawn of the Scarlet Sun\",\n      date: \"2012-06-01\",\n      pages: 16,\n      level: 5,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9537\",\n      name: \"The Moonscar\",\n      date: \"2012-08-01\",\n      pages: 32,\n      level: 16,\n      isbn: \"978-1-60125-426-9\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9538\",\n      name: \"Murder's Mark\",\n      date: \"2012-10-01\",\n      pages: 32,\n      level: 1,\n      isbn: \"978-1-60125-447-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9539\",\n      name: \"Broken Chains\",\n      date: \"2013-03-01\",\n      pages: 32,\n      level: 6,\n      isbn: \"978-1-60125-461-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9540\",\n      name: \"Fangwood Keep\",\n      date: \"2013-04-01\",\n      pages: 32,\n      level: 4,\n      isbn: \"978-1-60125-476-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9541\",\n      name: \"Doom Comes to Dustpawn\",\n      date: \"2013-05-01\",\n      pages: 32,\n      level: 9,\n      isbn: \"978-1-60125-504-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-7\",\n      name: \"We Be Goblins Too!\",\n      date: \"2013-06-01\",\n      pages: 16,\n      level: 3,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9542\",\n      name: \"The Dragon's Demand\",\n      date: \"2013-07-01\",\n      pages: 64,\n      level: 1,\n      isbn: \"978-1-60125-527-3\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9543\",\n      name: \"Wardens of the Reborn Forge\",\n      date: \"2013-12-01\",\n      pages: 64,\n      level: 12,\n      isbn: \"978-1-60125-555-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9544\",\n      name: \"Tears at Bitter Manor\",\n      date: \"2014-03-01\",\n      pages: 64,\n      level: 5,\n      isbn: \"978-1-60125-613-3\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-8\",\n      name: \"Risen from the Sands\",\n      date: \"2014-06-01\",\n      pages: 16,\n      level: 3,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9545\",\n      name: \"The Emerald Spire Superdungeon\",\n      date: \"2014-06-01\",\n      pages: 160,\n      level: 1,\n      isbn: \"978-1-60125-655-3\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9546\",\n      name: \"Plunder & Peril\",\n      date: \"2014-11-01\",\n      pages: 64,\n      level: 4,\n      isbn: \"978-1-60125-680-5\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9547\",\n      name: \"Daughters of Fury\",\n      date: \"2015-02-01\",\n      pages: 64,\n      level: 3,\n      isbn: \"978-1-60125-706-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-9\",\n      name: \"We Be Goblins Free!\",\n      date: \"2015-06-01\",\n      pages: 16,\n      level: 4,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9548\",\n      name: \"Feast of Dust\",\n      date: \"2015-11-01\",\n      pages: 64,\n      level: 11,\n      isbn: \"978-1-60125-735-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9549\",\n      name: \"The House on Hook Street\",\n      date: \"2015-12-01\",\n      pages: 64,\n      level: 6,\n      isbn: \"978-1-60125-790-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9550\",\n      name: \"Down the Blighted Path\",\n      date: \"2016-02-01\",\n      pages: 64,\n      level: 5,\n      isbn: \"978-1-60125-815-1\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9551\",\n      name: \"Ire of the Storm\",\n      date: \"2016-05-01\",\n      pages: 64,\n      level: 1,\n      isbn: \"978-1-60125-830-4\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-10\",\n      name: \"We B4 Goblins!\",\n      date: \"2016-06-01\",\n      pages: 16,\n      level: 1,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9552\",\n      name: \"Gallows of Madness\",\n      date: \"2016-08-01\",\n      pages: 64,\n      level: 1,\n      isbn: \"978-1-60125-854-0\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9553\",\n      name: \"Seers of the Drowned City\",\n      date: \"2016-11-01\",\n      pages: 64,\n      level: 6,\n      isbn: \"978-1-60125-902-8\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZOGENA001\",\n      name: \"Heroes for Highdelve\",\n      date: \"2017-08-01\",\n      pages: 20,\n      level: 1,\n      isbn: \"978-1-64078-002-6\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZOGAUNTLET\",\n      name: \"The Gauntlet\",\n      date: \"2018-05-01\",\n      pages: 16,\n      level: 8,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-12\",\n      name: \"We Be 5uper Goblins!\",\n      date: \"2018-06-01\",\n      pages: 16,\n      level: 6,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9554\",\n      name: \"Cradle of Night\",\n      date: \"2018-12-01\",\n      pages: 64,\n      level: 8,\n      isbn: \"978-1-60125-991-2\",\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9500-14\",\n      name: \"We Be Heroes?\",\n      date: \"2019-06-01\",\n      pages: 16,\n      level: 1,\n      type: \"module\",\n    },\n    {\n      _id: \"PZO9402\",\n      name: \"Elves of Golarion\",\n      date: \"2008-10-01\",\n      isbn: \"978-1-60125-143-5\",\n      legacy: true,\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9403\",\n      name: \"Osirion, Land of Pharaohs\",\n      date: \"2008-12-01\",\n      isbn: \"978-1-60125-144-2\",\n      url: \"https://paizo.com/products/btpy86j7\",\n      legacy: true,\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9405\",\n      name: \"Taldor, Echoes of Glory\",\n      date: \"2009-04-01\",\n      isbn: \"978-1-60125-169-5\",\n      legacy: true,\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9406\",\n      name: \"Qadira, Gateway to the East\",\n      date: \"2009-06-01\",\n      isbn: \"978-1-60125-180-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9407\",\n      name: \"Cheliax, Empire of Devils\",\n      date: \"2009-08-01\",\n      isbn: \"978-1-60125-191-6\",\n      tieIn: \"Council of Thieves\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9408\",\n      name: \"Dwarves of Golarion\",\n      date: \"2009-12-01\",\n      isbn: \"978-1-60125-204-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9409\",\n      name: \"Andoran, Spirit of Liberty\",\n      date: \"2010-01-01\",\n      isbn: \"978-1-60125-205-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9410\",\n      name: \"Adventurer's Armory\",\n      abbr: \"AA\",\n      date: \"2010-04-01\",\n      isbn: \"978-1-60125-222-7\",\n      tieIn: \"Kingmaker\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9411\",\n      name: \"Gnomes of Golarion\",\n      date: \"2010-05-01\",\n      isbn: \"978-1-60125-223-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9412\",\n      name: \"Sargava, the Lost Colony\",\n      date: \"2010-06-01\",\n      isbn: \"978-1-60125-255-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9413\",\n      name: \"Orcs of Golarion\",\n      date: \"2010-08-01\",\n      isbn: \"978-1-60125-256-2\",\n      tieIn: \"Serpent's Skull\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9414\",\n      name: \"Inner Sea Primer\",\n      date: \"2010-11-01\",\n      isbn: \"978-1-60125-277-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9415\",\n      name: \"Halflings of Golarion\",\n      date: \"2011-01-01\",\n      isbn: \"978-1-60125-278-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9416\",\n      name: \"Faiths of Purity\",\n      date: \"2011-04-01\",\n      isbn: \"978-1-60125-314-9\",\n      tieIn: \"Carrion Crown\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9417\",\n      name: \"Humans of Golarion\",\n      date: \"2011-06-01\",\n      isbn: \"978-1-60125-315-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9418\",\n      name: \"Faiths of Balance\",\n      date: \"2011-07-01\",\n      isbn: \"978-1-60125-316-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9419\",\n      name: \"Goblins of Golarion\",\n      date: \"2011-08-01\",\n      isbn: \"978-1-60125-362-0\",\n      tieIn: \"Jade Regent\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9420\",\n      name: \"Faiths of Corruption\",\n      date: \"2011-10-01\",\n      isbn: \"978-1-60125-375-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9421\",\n      name: \"Dragon Empires Primer\",\n      date: \"2012-01-01\",\n      isbn: \"978-1-60125-386-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9422\",\n      name: \"Pirates of the Inner Sea\",\n      abbr: \"PotIS\",\n      date: \"2012-02-01\",\n      isbn: \"978-1-60125-405-4\",\n      tieIn: \"Skull & Shackles\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9423\",\n      name: \"Blood of Fiends\",\n      date: \"2012-04-01\",\n      isbn: \"978-1-60125-423-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9424\",\n      name: \"Blood of Angels\",\n      date: \"2012-07-01\",\n      isbn: \"978-1-60125-438-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9425\",\n      name: \"Varisia, Birthplace of Legends\",\n      date: \"2012-08-02\",\n      isbn: \"978-1-60125-453-5\",\n      tieIn: \"Shattered Star\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9426\",\n      name: \"Knights of the Inner Sea\",\n      date: \"2012-09-01\",\n      isbn: \"978-1-60125-460-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9427\",\n      name: \"Blood of the Night\",\n      date: \"2012-12-06\",\n      isbn: \"978-1-60125-470-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9428\",\n      name: \"People of the North\",\n      date: \"2013-01-22\",\n      isbn: \"978-1-60125-475-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9429\",\n      name: \"Animal Archive\",\n      date: \"2013-02-13\",\n      isbn: \"978-1-60125-488-7\",\n      tieIn: \"Reign of Winter\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9430\",\n      name: \"Dungeoneer's Handbook\",\n      abbr: \"DHB\",\n      date: \"2013-03-08\",\n      isbn: \"978-1-60125-510-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9431\",\n      name: \"Champions of Purity\",\n      date: \"2013-04-16\",\n      isbn: \"978-1-60125-511-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9432\",\n      name: \"Kobolds of Golarion\",\n      date: \"2013-06-13\",\n      isbn: \"978-1-60125-512-9\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9433\",\n      name: \"Quests & Campaigns\",\n      date: \"2013-06-13\",\n      isbn: \"978-1-60125-513-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9434\",\n      name: \"Dragonslayer's Handbook\",\n      date: \"2013-07-11\",\n      isbn: \"978-1-60125-526-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9435\",\n      name: \"Pathfinder Society Primer\",\n      date: \"2013-07-11\",\n      isbn: \"978-1-60125-534-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9436\",\n      name: \"Faiths & Philosophies\",\n      date: \"2013-08-19\",\n      isbn: \"978-1-60125-543-3\",\n      tieIn: \"Wrath of the Righteous\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9437\",\n      name: \"Demon Hunter's Handbook\",\n      date: \"2013-08-17\",\n      isbn: \"978-1-60125-554-9\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9438\",\n      name: \"Mythic Origins\",\n      date: \"2013-09-25\",\n      isbn: \"978-1-60125-569-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9439\",\n      name: \"Blood of the Moon\",\n      date: \"2013-10-21\",\n      isbn: \"978-1-60125-578-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9440\",\n      name: \"Magical Marketplace\",\n      abbr: \"MM\",\n      date: \"2013-12-11\",\n      isbn: \"978-1-60125-600-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9441\",\n      name: \"People of the Sands\",\n      date: \"2014-01-09\",\n      isbn: \"978-1-60125-601-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9442\",\n      name: \"Bastards of Golarion\",\n      date: \"2014-02-06\",\n      isbn: \"978-1-60125-602-7\",\n      tieIn: \"Mummy's Mask\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9443\",\n      name: \"Champions of Balance\",\n      date: \"2014-03-25\",\n      isbn: \"978-1-60125-603-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9444\",\n      name: \"Undead Slayer's Handbook\",\n      abbr: \"USH\",\n      date: \"2014-04-30\",\n      isbn: \"978-1-60125-604-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9445\",\n      name: \"Alchemy Manual\",\n      abbr: \"AM\",\n      date: \"2014-04-30\",\n      isbn: \"978-1-60125-605-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9446\",\n      name: \"The Harrow Handbook\",\n      date: \"2014-05-28\",\n      isbn: \"978-1-60125-650-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9447\",\n      name: \"Blood of the Elements\",\n      date: \"2014-06-25\",\n      isbn: \"978-1-60125-654-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9448\",\n      name: \"People of the River\",\n      date: \"2014-07-25\",\n      isbn: \"978-1-60125-666-9\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9449\",\n      name: \"People of the Stars\",\n      date: \"2014-08-14\",\n      isbn: \"978-1-60125-674-4\",\n      tieIn: \"Iron Gods\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9450\",\n      name: \"Champions of Corruption\",\n      date: \"2014-09-10\",\n      isbn: \"978-1-60125-679-9\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9451\",\n      name: \"Advanced Class Origins\",\n      date: \"2014-10-22\",\n      isbn: \"978-1-60125-689-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9452\",\n      name: \"Ranged Tactics Toolbox\",\n      date: \"2014-11-24\",\n      isbn: \"978-1-60125-705-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9453\",\n      name: \"Giant Hunter's Handbook\",\n      date: \"2014-12-17\",\n      isbn: \"978-1-60125-712-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9454\",\n      name: \"Familiar Folio\",\n      abbr: \"FF\",\n      date: \"2015-01-28\",\n      isbn: \"978-1-60125-731-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9455\",\n      name: \"Melee Tactics Toolbox\",\n      date: \"2015-03-25\",\n      isbn: \"978-1-60125-732-1\",\n      tieIn: \"Giant Slayer\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9456\",\n      name: \"Heroes of the Wild\",\n      date: \"2015-04-29\",\n      isbn: \"978-1-60125-733-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9457\",\n      name: \"Cohorts and Companions\",\n      date: \"2015-05-27\",\n      isbn: \"978-1-60125-734-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9458\",\n      name: \"Monster Summoner's Handbook\",\n      date: \"2015-06-24\",\n      isbn: \"978-1-60125-758-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9459\",\n      name: \"Dirty Tactics Toolbox\",\n      date: \"2015-09-02\",\n      isbn: \"978-1-60125-763-5\",\n      tieIn: \"Hell's Rebels\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9460\",\n      name: \"Heroes of the Streets\",\n      date: \"2015-09-30\",\n      isbn: \"978-1-60125-769-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9461\",\n      name: \"Occult Origins\",\n      abbr: \"OO\",\n      date: \"2015-10-21\",\n      isbn: \"978-1-60125-785-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9462\",\n      name: \"Black Markets\",\n      abbr: \"BM\",\n      date: \"2015-10-21\",\n      isbn: \"978-1-60125-789-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9463\",\n      name: \"Weapon Master's Handbook\",\n      date: \"2015-11-18\",\n      isbn: \"978-1-60125-796-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9464\",\n      name: \"Agents of Evil\",\n      date: \"2015-12-16\",\n      isbn: \"978-1-60125-801-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9465\",\n      name: \"Arcane Anthology\",\n      abbr: \"AA\",\n      date: \"2016-01-27\",\n      isbn: \"978-1-60125-814-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9466\",\n      name: \"Blood of Shadows\",\n      date: \"2016-02-24\",\n      isbn: \"978-1-60125-820-5\",\n      tieIn: \"Hell's Vengeance\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9467\",\n      name: \"Armor Master's Handbook\",\n      date: \"2016-04-27\",\n      isbn: \"978-1-60125-829-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9468\",\n      name: \"Magic Tactics Toolbox\",\n      date: \"2016-05-25\",\n      isbn: \"978-1-60125-838-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9469\",\n      name: \"Spymaster's Handbook\",\n      date: \"2016-06-29\",\n      isbn: \"978-1-60125-844-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9470\",\n      name: \"Legacy of Dragons\",\n      date: \"2016-08-04\",\n      isbn: \"978-1-60125-853-3\",\n      tieIn: \"Strange Aeons\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9471\",\n      name: \"Haunted Heroes Handbook\",\n      date: \"2016-08-31\",\n      isbn: \"978-1-60125-884-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9472\",\n      name: \"Divine Anthology\",\n      date: \"2016-09-28\",\n      isbn: \"978-1-60125-894-6\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9473\",\n      name: \"Blood of the Beast\",\n      date: \"2016-11-16\",\n      isbn: \"978-1-60125-901-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9474\",\n      name: \"Paths of the Righteous\",\n      date: \"2016-12-14\",\n      isbn: \"978-1-60125-910-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9475\",\n      name: \"Healer's Handbook\",\n      abbr: \"HH\",\n      date: \"2017-01-25\",\n      isbn: \"978-1-60125-914-1\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9476\",\n      name: \"Heroes of the High Court\",\n      date: \"2017-02-22\",\n      isbn: \"978-1-60125-920-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9477\",\n      name: \"Psychic Anthology\",\n      date: \"2017-02-22\",\n      isbn: \"978-1-60125-928-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9478\",\n      name: \"Monster Hunter's Handbook\",\n      date: \"2017-03-29\",\n      isbn: \"978-1-60125-933-2\",\n      tieIn: \"Ironfang Invasion\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9479\",\n      name: \"Heroes of the Darklands\",\n      date: \"2017-04-26\",\n      isbn: \"978-1-60125-936-3\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9480\",\n      name: \"Legacy of the First World\",\n      date: \"2017-05-31\",\n      isbn: \"978-1-60125-941-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9481\",\n      name: \"Adventurer's Armory 2\",\n      abbr: \"AA2\",\n      date: \"2017-06-28\",\n      isbn: \"978-1-60125-945-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9482\",\n      name: \"Blood of the Sea\",\n      date: \"2017-07-26\",\n      isbn: \"978-1-60125-955-4\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9483\",\n      name: \"Elemental Master's Handbook\",\n      date: \"2017-08-17\",\n      isbn: \"978-1-60125-965-3\",\n      tieIn: \"Ruins of Azlant\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9484\",\n      name: \"Antihero's Handbook\",\n      date: \"2017-09-20\",\n      isbn: \"978-1-60125-973-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9485\",\n      name: \"Blood of the Coven\",\n      date: \"2017-10-18\",\n      isbn: \"978-1-60125-982-0\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9486\",\n      name: \"People of the Wastes\",\n      date: \"2017-11-15\",\n      isbn: \"978-1-60125-990-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9487\",\n      name: \"Potions & Poisons\",\n      abbr: \"P&P\",\n      date: \"2017-12-13\",\n      isbn: \"978-1-64078-000-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9488\",\n      name: \"Disciple's Doctrine\",\n      date: \"2018-01-31\",\n      isbn: \"978-1-64078-011-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9489\",\n      name: \"Merchant's Manifest\",\n      date: \"2018-03-28\",\n      isbn: \"978-1-64078-026-2\",\n      tieIn: \"War for the Crown\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9490\",\n      name: \"Blood of the Ancients\",\n      date: \"2018-05-30\",\n      isbn: \"978-1-64078-038-5\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9491\",\n      name: \"Heroes from the Fringe\",\n      date: \"2018-08-29\",\n      isbn: \"978-1-64078-053-8\",\n      tieIn: \"Return of the Runelords\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9492\",\n      name: \"Plane-Hopper's Handbook\",\n      date: \"2018-09-19\",\n      isbn: \"978-1-64078-071-2\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9493\",\n      name: \"Martial Arts Handbook\",\n      date: \"2018-11-14\",\n      isbn: \"978-1-64078-092-7\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9494\",\n      name: \"Wilderness Origins\",\n      date: \"2019-01-30\",\n      isbn: \"978-1-64078-107-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9495\",\n      name: \"Heroes of Golarion\",\n      date: \"2019-03-27\",\n      isbn: \"978-1-64078-120-7\",\n      tieIn: \"Tyrant's Grasp\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO9496\",\n      name: \"Chronicle of Legends\",\n      date: \"2019-05-29\",\n      isbn: \"978-1-64078-136-8\",\n      type: \"companion\",\n    },\n    {\n      _id: \"PZO1106\",\n      name: \"Pathfinder Chronicles: Guide to Korvosa\",\n      date: \"2008-03-01\",\n      pages: 64,\n      isbn: \"978-1-60125-078-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO1105\",\n      name: \"Pathfinder Chronicles: Gazetteer\",\n      date: \"2008-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-077-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO1107\",\n      name: \"Pathfinder Chronicles: Classic Monsters Revisited\",\n      date: \"2008-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-079-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO1108\",\n      name: \"Pathfinder Chronicles: Guide to Darkmoon Vale\",\n      date: \"2008-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-100-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO1111\",\n      name: \"Pathfinder Chronicles: Campaign Setting\",\n      date: \"2008-08-01\",\n      pages: 256,\n      isbn: \"978-1-60125-112-1\",\n      url: \"https://paizo.com/products/btpy84eo\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9202\",\n      name: \"Pathfinder Chronicles: Gods and Magic\",\n      date: \"2008-10-01\",\n      pages: 32,\n      isbn: \"978-1-60125-139-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9204\",\n      name: \"Pathfinder Chronicles: Into the Darklands\",\n      date: \"2008-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-140-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9205\",\n      name: \"Pathfinder Chronicles: Guide to Absalom\",\n      date: \"2008-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-141-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9207\",\n      name: \"Pathfinder Chronicles: Dragons Revisited\",\n      date: \"2009-03-01\",\n      pages: 64,\n      isbn: \"978-1-60125-165-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9208\",\n      name: \"Pathfinder Chronicles: Dark Markets: A Guide to Katapesh\",\n      date: \"2009-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-166-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9209\",\n      name: \"Pathfinder Chronicles: The Great Beyond\",\n      date: \"2009-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-167-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9210\",\n      name: \"Pathfinder Chronicles: Dungeon Denizens Revisited\",\n      abbr: \"DDR\",\n      date: \"2009-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-172-5\",\n      type: \"setting\",\n      legacy: true,\n    },\n    {\n      _id: \"PZO9211\",\n      name: \"Pathfinder Chronicles: Seekers of Secrets\",\n      abbr: \"SoS\",\n      date: \"2009-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-178-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9213\",\n      name: \"Pathfinder Chronicles: Princes of Darkness\",\n      date: \"2009-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-189-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9214\",\n      name: \"Pathfinder Chronicles: Cities of Golarion\",\n      date: \"2009-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-178-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9216\",\n      name: \"Pathfinder Chronicles: Classic Horrors Revisited\",\n      date: \"2010-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-202-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9217E\",\n      name: \"Pathfinder Chronicles: Guide to the River Kingdoms\",\n      date: \"2010-02-01\",\n      pages: 64,\n      isbn: \"978-1-60125-203-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9219\",\n      name: \"Pathfinder Chronicles: NPC Guide\",\n      date: \"2010-03-01\",\n      pages: 64,\n      isbn: \"978-1-60125-219-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9220\",\n      name: \"Pathfinder Chronicles: Classic Treasures Revisited\",\n      date: \"2010-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-220-3\",\n      type: \"setting\",\n      url: \"https://paizo.com/products/btpy8dmn\",\n    },\n    {\n      _id: \"PZO9221\",\n      name: \"Pathfinder Chronicles: Faction Guide\",\n      abbr: \"FG\", //  PCh:FG\n      date: \"2010-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-221-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9222\",\n      name: \"Pathfinder Chronicles: Heart of the Jungle\",\n      date: \"2010-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-247-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9223\",\n      name: \"Pathfinder Chronicles: City of Strangers\",\n      date: \"2010-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-248-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9227\",\n      name: \"Misfit Monsters Redeemed\",\n      date: \"2010-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-270-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9225\",\n      name: \"Lords of Chaos\",\n      date: \"2010-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-250-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9229\",\n      name: \"Lost Cities of Golarion\",\n      date: \"2011-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-272-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9226\",\n      name: \"The Inner Sea World Guide\",\n      abbr: \"ISWG\",\n      date: \"2011-03-01\",\n      pages: 320,\n      isbn: \"978-1-60125-269-2\",\n      url: \"https://paizo.com/products/btpy8ief\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9231\",\n      name: \"Rule of Fear\",\n      date: \"2011-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-301-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9232\",\n      name: \"Rival Guide\",\n      date: \"2011-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-302-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9233\",\n      name: \"Undead Revisited\",\n      date: \"2011-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-303-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9234\",\n      name: \"Dungeons of Golarion\",\n      date: \"2011-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-304-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9235\",\n      name: \"Pathfinder Society Field Guide\",\n      abbr: \"PSFG\",\n      date: \"2011-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-305-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9237\",\n      name: \"Inner Sea Magic\",\n      date: \"2011-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-360-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9238\",\n      name: \"Lands of the Linnorm Kings\",\n      date: \"2011-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-365-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9239\",\n      name: \"Horsemen of the Apocalypse\",\n      date: \"2011-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-373-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9240\",\n      name: \"Dragon Empires Gazetteer\",\n      date: \"2011-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-379-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9241\",\n      name: \"Mythical Monsters Revisited\",\n      date: \"2012-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-384-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9243\",\n      name: \"Distant Worlds\",\n      date: \"2012-02-01\",\n      pages: 64,\n      isbn: \"978-1-60125-403-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9244\",\n      name: \"Isles of the Shackles\",\n      date: \"2012-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-408-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9245\",\n      name: \"Giants Revisited\",\n      date: \"2012-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-412-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9246\",\n      name: \"Lost Kingdoms\",\n      date: \"2012-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-415-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9248\",\n      name: \"Magnimar, City of Monuments\",\n      date: \"2012-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-446-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9249\",\n      name: \"Paths of Prestige\",\n      date: \"2012-08-01\",\n      pages: 64,\n      isbn: \"978-1-60125-451-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9250\",\n      name: \"Artifacts & Legends\",\n      date: \"2012-09-01\",\n      pages: 64,\n      isbn: \"978-1-60125-458-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9251\",\n      name: \"Inner Sea Bestiary\",\n      abbr: \"ISB\",\n      date: \"2012-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-468-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9252\",\n      name: \"Mystery Monsters Revisited\",\n      date: \"2012-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-473-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9253\",\n      name: \"Irrisen, Land of Eternal Winter\",\n      date: \"2013-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-486-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9255\",\n      name: \"Chronicle of the Righteous\",\n      date: \"2013-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-506-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9256\",\n      name: \"Fey Revisited\",\n      date: \"2013-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-507-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9257\",\n      name: \"Castles of the Inner Sea\",\n      date: \"2013-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-508-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9258\",\n      name: \"Dragons Unleashed\",\n      date: \"2013-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-525-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9259\",\n      name: \"The Worldwound\",\n      date: \"2013-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-532-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9261\",\n      name: \"Demons Revisited\",\n      date: \"2013-08-01\",\n      pages: 64,\n      isbn: \"978-1-60125-552-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9262\",\n      name: \"Mythic Realms\",\n      date: \"2013-09-01\",\n      pages: 64,\n      isbn: \"978-1-60125-567-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9263\",\n      name: \"Towns of the Inner Sea\",\n      date: \"2013-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-576-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9264\",\n      name: \"Inner Sea NPC Codex\",\n      date: \"2013-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-594-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9265\",\n      name: \"Osirion, Legacy of Pharaohs\",\n      date: \"2014-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-595-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9267\",\n      name: \"Inner Sea Gods\",\n      abbr: \"ISG\",\n      date: \"2014-04-01\",\n      pages: 320,\n      isbn: \"978-1-60125-597-6\",\n      url: \"https://paizo.com/products/btpy94wj\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9268\",\n      name: \"Inner Sea Combat\",\n      abbr: \"ISC\",\n      date: \"2014-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-598-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9269\",\n      name: \"Occult Mysteries\",\n      date: \"2014-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-649-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9270\",\n      name: \"Numeria, Land of Fallen Stars\",\n      abbr: \"NLFS\",\n      date: \"2014-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-653-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9272\",\n      name: \"Technology Guide\",\n      abbr: \"TG\",\n      date: \"2014-08-01\",\n      pages: 64,\n      isbn: \"978-1-60125-672-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9273\",\n      name: \"Undead Unleashed\",\n      date: \"2014-09-01\",\n      pages: 64,\n      isbn: \"978-1-60125-677-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9274\",\n      name: \"Ships of the Inner Sea\",\n      date: \"2014-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-702-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9275\",\n      name: \"Lost Treasures\",\n      date: \"2014-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-703-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9276\",\n      name: \"Belkzen, Hold of the Orc Hordes\",\n      date: \"2015-02-01\",\n      pages: 64,\n      isbn: \"978-1-60125-710-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9278\",\n      name: \"Tombs of Golarion\",\n      date: \"2015-03-01\",\n      pages: 64,\n      isbn: \"978-1-60125-720-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9279\",\n      name: \"Andoran, Birthplace of Freedom\",\n      date: \"2015-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-721-5\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9283\",\n      name: \"Inner Sea Monster Codex\",\n      date: \"2015-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-752-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9281\",\n      name: \"Hell Unleashed\",\n      date: \"2015-07-01\",\n      pages: 64,\n      isbn: \"978-1-60125-757-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9284\",\n      name: \"Occult Bestiary\",\n      date: \"2015-09-01\",\n      pages: 64,\n      isbn: \"978-1-60125-767-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9280\",\n      name: \"Inner Sea Races\",\n      abbr: \"ISR\",\n      date: \"2015-09-01\",\n      pages: 256,\n      isbn: \"978-1-60125-722-2\",\n      url: \"https://paizo.com/products/btpy9g9v\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9285\",\n      name: \"Distant Shores\",\n      date: \"2015-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-787-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9286\",\n      name: \"Occult Realms\",\n      date: \"2015-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-794-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9287\",\n      name: \"Cheliax, The Infernal Empire\",\n      date: \"2015-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-799-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9289\",\n      name: \"Darklands Revisited\",\n      date: \"2016-02-01\",\n      pages: 64,\n      isbn: \"978-1-60125-819-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9290\",\n      name: \"Inner Sea Faiths\",\n      date: \"2016-03-01\",\n      pages: 96,\n      isbn: \"978-1-60125-825-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9291\",\n      name: \"Heaven Unleashed\",\n      date: \"2016-04-01\",\n      pages: 64,\n      isbn: \"978-1-60125-828-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9292\",\n      name: \"Inner Sea Intrigue\",\n      date: \"2016-05-01\",\n      pages: 64,\n      isbn: \"978-1-60125-837-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9293\",\n      name: \"Path of the Hellknight\",\n      date: \"2016-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-843-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9295\",\n      name: \"Planes of Power\",\n      date: \"2016-09-01\",\n      pages: 64,\n      isbn: \"978-1-60125-883-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9296\",\n      name: \"Inner Sea Temples\",\n      date: \"2016-10-01\",\n      pages: 64,\n      isbn: \"978-1-60125-893-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9297\",\n      name: \"Horror Realms\",\n      date: \"2016-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-900-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9298\",\n      name: \"The First World, Realm of the Fey\",\n      date: \"2016-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-909-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO9299\",\n      name: \"Qadira, Jewel of the East\",\n      date: \"2017-01-01\",\n      pages: 64,\n      isbn: \"978-1-60125-912-7\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92101\",\n      name: \"Lands of Conflict\",\n      date: \"2017-02-01\",\n      pages: 64,\n      isbn: \"978-1-60125-927-1\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92102\",\n      name: \"Aquatic Adventures\",\n      date: \"2017-06-01\",\n      pages: 64,\n      isbn: \"978-1-60125-944-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92105\",\n      name: \"Taldor, the First Empire\",\n      date: \"2017-12-01\",\n      pages: 64,\n      isbn: \"978-1-60125-999-8\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92107\",\n      name: \"Inner Sea Taverns\",\n      date: \"2018-02-01\",\n      pages: 64,\n      isbn: \"978-1-64078-016-3\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92108\",\n      name: \"Nidal, Land of Shadows\",\n      date: \"2018-04-01\",\n      pages: 64,\n      isbn: \"978-1-64078-033-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92109\",\n      name: \"Distant Realms\",\n      date: \"2018-06-01\",\n      pages: 64,\n      isbn: \"978-1-64078-046-0\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92111\",\n      name: \"Sandpoint, Light of the Lost Coast\",\n      date: \"2018-10-01\",\n      pages: 64,\n      isbn: \"978-1-64078-080-4\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92104\",\n      name: \"Construct Handbook\",\n      date: \"2018-11-01\",\n      pages: 64,\n      isbn: \"978-1-60125-989-9\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92112\",\n      name: \"Faiths of Golarion\",\n      date: \"2018-12-01\",\n      pages: 64,\n      isbn: \"978-1-64078-099-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92114\",\n      name: \"Concordance of Rivals\",\n      date: \"2019-04-01\",\n      pages: 64,\n      isbn: \"978-1-64078-127-6\",\n      type: \"setting\",\n    },\n    {\n      _id: \"PZO92116\",\n      name: \"Druma, Profit and Prophecy\",\n      date: \"2019-08-01\",\n      pages: 64,\n      isbn: \"978-1-64078-141-2\",\n      type: \"setting\",\n    },\n    {\n      _id: \"DYN0031-E\",\n      name: \"Worldscape #1\",\n      date: \"2016-10-16\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9oco\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0032-E\",\n      name: \"Worldscape #2\",\n      date: \"2016-11-16\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9oza\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0033-E\",\n      name: \"Worldscape #3\",\n      date: \"2016-12-21\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9qcq\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0034-E\",\n      name: \"Worldscape #4\",\n      date: \"2017-01-25\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9qcu\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0035-E\",\n      name: \"Worldscape #5\",\n      date: \"2017-02-22\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9qcy\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0036-E\",\n      name: \"Worldscape #6\",\n      date: \"2017-04-05\",\n      pages: 32,\n      type: \"comic\",\n      url: \"https://paizo.com/products/btpy9sgk\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0046-HC\",\n      name: \"Spiral of Bones\",\n      date: \"2019-02-09\",\n      pages: 136,\n      type: \"comic\",\n      isbn: \"978-1-5241-0738-3\",\n      url: \"https://paizo.com/products/btq01x8j\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"DYN0010-A\",\n      name: \"Pathfinder Comics #10\",\n      date: \"2013-10-23\",\n      pages: 32,\n      type: \"comic\",\n      publisher: \"Dynamite Entertainment\",\n    },\n    {\n      _id: \"PZOPSS0310E\",\n      name: \"Pathfinder Society Scenario #3â10: The Immortal Conundrum\",\n      date: \"2011-11-01\",\n      pages: 24,\n      type: \"pfs\",\n    },\n    {\n      _id: \"PZOPSS0000E\",\n      name: \"Pathfinder Society Roleplaying Guild Guide\",\n      date: \"2019-08-09\",\n      pages: 44,\n      type: \"pfs\",\n    },\n  ]);\n}\n\n/**\n * @type {Sources}\n */\nexport let sources;\n","/**\n * Migration category tracker for {@link MigrationState}\n */\nexport class MigrationCategory {\n  /** @type {import(\"./migration-state.mjs\").MigrationState} */\n  state;\n\n  id;\n  label;\n  isNumber = false;\n  processed = 0;\n  invalid = 0;\n  errors = [];\n  current = null;\n  total = null;\n  ignored = 0;\n  completed = false;\n\n  /**\n   *\n   * @param {string} id - Category ID\n   * @param {string} label - Label\n   * @param {boolean} isNumber - Is numeric\n   * @param {MigrationState} state - State tracker instance\n   */\n  constructor(id, label, isNumber, state) {\n    this.state = state;\n    this.id = id;\n    this.label = game.i18n.localize(label);\n    this.isNumber = isNumber;\n    if (isNumber) {\n      //this.total = 0;\n      this.processed = 0;\n    }\n  }\n\n  get progress() {\n    return this.ignored + this.invalid + this.processed;\n  }\n\n  get percentage() {\n    if (this.total === 0) return 1;\n    return this.progress / this.total;\n  }\n\n  get hasTotal() {\n    return this.total !== null;\n  }\n\n  get progressLabel() {\n    return `${ffd20.utils.limitPrecision(this.percentage * 100, 1)} %`;\n  }\n\n  /**\n   * Signal that an entry has started processing.\n   *\n   * @param {any} entry - Whatever was started processing.\n   */\n  startEntry(entry) {\n    this.current = entry;\n    this.state.emit(this, { entry, action: \"process\", actionState: \"start\", processing: this.processed + 1 });\n  }\n\n  /**\n   * Signal that an entry has finished processing.\n   *\n   * @param {any} entry - Whatever was finished processing with.\n   */\n  finishEntry(entry) {\n    this.current = null;\n    this.processed += 1;\n    this.state.emit(this, { entry, action: \"process\", actionState: \"finish\", processed: this.processed });\n  }\n\n  recordError(entry, error) {\n    this.errors.push({ entry, error });\n  }\n\n  /**\n   * Signal that a specific entry was ignored.\n   *\n   * @param {any} entry - Whatever was ignored.\n   */\n  ignoreEntry(entry) {\n    this.ignored += 1;\n    this.state.emit(this, { entry, action: \"ignore\" });\n  }\n\n  /**\n   * Add unspecific ignored entries.\n   *\n   * @param {number} ignored - Number of ignored entries\n   */\n  addIgnored(ignored) {\n    this.ignored += ignored;\n    this.state.emit(this, { action: \"info\", ignored, total: this.total, invalid: this.invalid });\n  }\n\n  /**\n   * Record total number of items in this category.\n   *\n   * @param {number} total - Total number of entries in category\n   */\n  setTotal(total) {\n    this.total = total;\n    this.state.emit(this, { action: \"info\", total, ignored: this.ignored, invalid: this.invalid });\n  }\n\n  /**\n   * Record total number of invalid items in this category.\n   *\n   * @param {number} total - Total number of invalid entries in the category\n   */\n  setInvalid(total) {\n    this.invalid = total;\n    this.state.emit(this, { action: \"info\", total: this.total, ignored: this.ignored, invalid: this.invalid });\n  }\n\n  setProgress(value) {\n    this.current = null;\n    this.processed = value;\n  }\n\n  /**\n   * Signal the start of processing this category.\n   */\n  start() {\n    this.completed = false;\n    this.state.emit(this, { action: \"start\" });\n  }\n\n  /**\n   * Signal the finishing of processing this category.\n   */\n  finish() {\n    this.completed = true;\n    this.state.emit(this, { action: \"finish\" });\n  }\n\n  /**\n   * Return name of currently processed entry.\n   *\n   * @remarks\n   * - Null if no entry is being processed currently.\n   *\n   * @type {string|null}\n   */\n  get currentName() {\n    const current = this.current;\n    if (!current) return null;\n\n    if (current instanceof ChatMessage) return `${current.timestamp} [${current.id}]`;\n    if (current instanceof foundry.abstract.Document) return current.name;\n    if (current instanceof CompendiumCollection) {\n      if (game.i18n.has(current.metadata.label)) return game.i18n.localize(current.metadata.label);\n      return current.metadata.label;\n    }\n    return null;\n  }\n\n  getInvalidEntries() {\n    let collection;\n    switch (this.id) {\n      case \"actors\":\n      case \"items\":\n      case \"scenes\":\n        collection = game[this.id];\n        break;\n      default:\n        return [];\n    }\n\n    const results = [];\n    for (const id of collection.invalidDocumentIds) {\n      results.push({ id, entry: collection.getInvalid(id) });\n    }\n\n    return results;\n  }\n\n  getErrorEntries() {\n    return this.errors;\n  }\n}\n","import { MigrationCategory } from \"./migration-category.mjs\";\n\n/**\n * State object for tracking migration progress.\n */\nexport class MigrationState {\n  /**\n   * Display label\n   *\n   * @type {string}\n   */\n  label;\n\n  /**\n   * @type {Record<number, Function>}\n   */\n  callbacks = {};\n\n  /**\n   * @type {Record<string, MigrationCategory>}\n   */\n  categories = {};\n\n  completed = false;\n\n  /**\n   * Compendium unlocking state\n   *\n   * @type {boolean}\n   */\n  unlock = false;\n\n  constructor(label) {\n    if (label) label = game.i18n.localize(label);\n    this.label = label;\n  }\n\n  /**\n   * @param {string} category - Category ID\n   * @param {string} label - Display label\n   * @param {boolean} isNumber - Does the category track a number\n   * @returns {MigrationCategory} - Created category\n   */\n  createCategory(category, label, isNumber) {\n    if (!this.categories[category]) {\n      this.categories[category] = new MigrationCategory(category, label, isNumber, this);\n      this.emit(this.categories[category], { action: \"new\" });\n    }\n    return this.categories[category];\n  }\n\n  /**\n   * @param {MigrationCategory|MigrationState} category - Category or the overall state\n   * @param {object} info - Category or state specific data\n   */\n  emit(category, info) {\n    for (const callback of Object.values(this.callbacks)) {\n      try {\n        callback(this, category, info);\n      } catch (err) {\n        console.error(err, callback);\n      }\n    }\n  }\n\n  start() {\n    this.completed = false;\n    this.emit(this, { action: \"start\" });\n  }\n\n  finish() {\n    this.completed = true;\n    this.emit(this, { action: \"finish\" });\n  }\n\n  get errors() {\n    return Object.values(this.categories).reduce((total, c) => total + c.errors.length, 0);\n  }\n\n  get invalid() {\n    return Object.values(this.categories).reduce((total, c) => total + c.invalid, 0);\n  }\n\n  get ignored() {\n    return Object.values(this.categories).reduce((total, c) => total + c.ignored, 0);\n  }\n}\n","export class MigrationIssuesDialog extends Dialog {\n  /**\n   * Present simple dialog with issues within a migration category.\n   *\n   * @param {MigrationCategory} category\n   */\n  static async open(category) {\n    const templateData = {\n      errors: category.getErrorEntries(),\n      invalid: category.getInvalidEntries(),\n    };\n\n    return this.prompt({\n      title: game.i18n.localize(\"FFD20.Migration.Dialog.Issues\") + \" â \" + category.label,\n      content: await renderTemplate(\"systems/ffd20/templates/apps/migration-issues.hbs\", templateData),\n      rejectClose: false,\n      options: {\n        classes: [...Dialog.defaultOptions.classes, \"ffd20\", \"migration-issues\"],\n        jQuery: false,\n        width: 620,\n        height: \"auto\",\n        resizable: true,\n      },\n    });\n  }\n\n  /**\n   * @param {JQuery<HTMLElement>} jq\n   */\n  activateListeners(jq) {\n    super.activateListeners(jq);\n\n    // Copy ID/UUID to clipboard\n    jq.on(\"click\", \".issue .id a\", (ev) => {\n      const el = ev.target;\n      const { id, uuid } = el.dataset;\n      game.clipboard.copyPlainText(uuid || id);\n      const type = uuid ? \"UUID\" : \"ID\";\n      ui.notifications.info(game.i18n.format(\"DOCUMENT.IdCopiedClipboard\", { label: \"\", type, id: uuid || id }));\n    });\n  }\n}\n","import { MigrationState } from \"../../migration/migration-state.mjs\";\nimport { MigrationIssuesDialog } from \"./migration-issues-dialog.mjs\";\n\nconst { ApplicationV2, HandlebarsApplicationMixin } = foundry.applications.api;\n\n/**\n * Migration progress tracking dialog\n */\nexport class MigrationDialog extends HandlebarsApplicationMixin(ApplicationV2) {\n  /**\n   * Migration state object.\n   *\n   * @type {MigrationState}\n   */\n  migrationState;\n  /**\n   * Autoclose migration dialog once done\n   *\n   * @type {boolean}\n   */\n  autoClose;\n  /**\n   * Ignore documents with appropriate migration marker.\n   *\n   * @type {boolean}\n   */\n  fastMigration;\n\n  constructor(options) {\n    super(options);\n\n    this.migrationState = options.stateTracker;\n\n    this.autoClose = options.autoClose ?? false;\n    this.fastMigration = options.fast ?? true;\n\n    this.migrationState.callbacks[this.appId] = this._onMigration.bind(this);\n  }\n\n  get title() {\n    const label = game.i18n.localize(\"FFD20.Migration.Dialog.Title\");\n    if (this.migrationState.label) return `${label}: ${this.migrationState.label}`;\n    return label;\n  }\n\n  static DEFAULT_OPTIONS = {\n    tag: \"form\",\n    classes: [\"pf1-v2\", \"migration\"],\n    window: {\n      resizable: true,\n    },\n    position: {\n      top: 200,\n      width: \"auto\",\n      height: \"auto\",\n    },\n    actions: {\n      \"show-details\": this._showDetails,\n      \"reload-all\": this._reloadClients,\n    },\n  };\n\n  static PARTS = {\n    form: {\n      template: \"systems/ffd20/templates/apps/migration-progress.hbs\",\n    },\n    status: {\n      template: \"systems/ffd20/templates/apps/migration-status.hbs\",\n    },\n  };\n\n  /**\n   * @override\n   * @param {object} options\n   */\n  async _prepareContext(options) {\n    await super._prepareContext(options);\n\n    return this.migrationState;\n  }\n\n  /**\n   * @override\n   * @param {object} context\n   * @param {object} options\n   */\n  _onRender(context, options) {\n    super._onRender(context, options);\n\n    if (this.migrationState.completed && this.migrationState.typeChanges !== true && this.autoClose) {\n      setTimeout(() => this.close(), 5_000);\n    }\n  }\n\n  /**\n   * @param {Event} event\n   * @param {HTMLElement} target\n   * @this {MigrationDialog}\n   */\n  static _reloadClients(event) {\n    event.preventDefault();\n\n    game.socket.emit(\"reload\");\n    foundry.utils.debouncedReload();\n  }\n\n  /**\n   * @param { Event } event\n   * @param { HTMLElement } target\n   * @this {MigrationDialog}\n   */\n  static _showDetails(event) {\n    event.preventDefault();\n\n    const el = event.target.closest(\".category\");\n    const categoryId = el.dataset.category;\n    const category = this.migrationState.categories[categoryId];\n\n    MigrationIssuesDialog.open(category);\n  }\n\n  _lastProcessUpdate = 0;\n  /**\n   * @param {MigrationState} state\n   * @param {MigrationCategory} category\n   * @param {object} info\n   */\n  _onMigration(state, category, info) {\n    const parts = [\"form\"];\n    switch (info.action) {\n      case \"finish\":\n        if (state.completed) parts.push(\"status\");\n        break;\n      case \"process\": {\n        // Ignore process updates if they come too frequently\n        const t0 = performance.now();\n        if (t0 - this._lastProcessUpdate < 200 && this.state !== this.constructor.RENDER_STATES.RENDERED) return;\n        this._lastProcessUpdate = t0;\n        break;\n      }\n    }\n    this.render({ parts });\n  }\n\n  /**\n   * @override\n   * @param {object} options\n   */\n  async _preClose(options) {\n    await super._preClose(options);\n\n    delete this.migrationState.callbacks[this.appId];\n  }\n\n  /**\n   * Initialize migration dialog and migration state tracker if necessary.\n   *\n   * @param {MigrationState} [state] - Existing state tracker if any\n   * @param {string} [label] - Label associated with the tracker\n   * @param {object} [dialogOptions={}] - Dialog options\n   * @returns {Promise<MigrationDialog>} - Active state tracker\n   */\n  static async initialize(state, label, dialogOptions = {}) {\n    state ??= new MigrationState(label);\n    state.label ||= label;\n\n    const app = new this({ stateTracker: state, autoClose: dialogOptions.autoClose ?? false });\n    await app.render({ dialogOptions, force: true });\n\n    return app;\n  }\n}\n","export const movedAssets = {\n  \"systems/ffd20/icons/conditions/bleed.png\": \"systems/ffd20/icons/conditions/bleed.svg\",\n  \"systems/ffd20/icons/conditions/confused.png\": \"systems/ffd20/icons/conditions/confused.svg\",\n  \"systems/ffd20/icons/conditions/cowering.png\": \"systems/ffd20/icons/conditions/cowering.svg\",\n  \"systems/ffd20/icons/conditions/dazed.png\": \"systems/ffd20/icons/conditions/dazed.svg\",\n  \"systems/ffd20/icons/conditions/dazzled.png\": \"systems/ffd20/icons/conditions/dazzled.svg\",\n  \"systems/ffd20/icons/conditions/exhausted.png\": \"systems/ffd20/icons/conditions/exhausted.svg\",\n  \"systems/ffd20/icons/conditions/frightened.png\": \"systems/ffd20/icons/conditions/frightened.svg\",\n  \"systems/ffd20/icons/conditions/grappled.png\": \"systems/ffd20/icons/conditions/grappled.svg\",\n  \"systems/ffd20/icons/conditions/helpless.png\": \"systems/ffd20/icons/conditions/helpless.svg\",\n  \"systems/ffd20/icons/conditions/incorporeal.png\": \"systems/ffd20/icons/conditions/incorporeal.svg\",\n  \"systems/ffd20/icons/conditions/nauseated.png\": \"systems/ffd20/icons/conditions/nauseated.svg\",\n  \"systems/ffd20/icons/conditions/paralyzed.png\": \"systems/ffd20/icons/conditions/paralyzed.svg\",\n  \"systems/ffd20/icons/conditions/pinned.png\": \"systems/ffd20/icons/conditions/pinned.svg\",\n  \"systems/ffd20/icons/conditions/shaken.png\": \"systems/ffd20/icons/conditions/shaken.svg\",\n  \"systems/ffd20/icons/conditions/sickened.png\": \"systems/ffd20/icons/conditions/sickened.svg\",\n  \"systems/ffd20/icons/conditions/squeezing.png\": \"systems/ffd20/icons/conditions/squeezing.svg\",\n  \"systems/ffd20/icons/conditions/staggered.png\": \"systems/ffd20/icons/conditions/staggered.svg\",\n  \"systems/ffd20/icons/conditions/screaming.png\": \"systems/ffd20/icons/conditions/cowering.svg\",\n  // Duplicated from Core\n  \"systems/ffd20/icons/conditions/entangled.png\": \"icons/svg/net.svg\",\n  \"systems/ffd20/icons/conditions/fear.png\": \"icons/svg/terror.svg\",\n  \"systems/ffd20/icons/conditions/prone.png\": \"icons/svg/falling.svg\",\n  \"systems/ffd20/icons/conditions/sleep.png\": \"icons/svg/sleep.svg\",\n  \"systems/ffd20/icons/conditions/stunned.png\": \"icons/svg/stoned.svg\",\n};\n","import { MigrationDialog } from \"@app/migration/migration-dialog.mjs\";\nimport { MigrationState } from \"./migration/migration-state.mjs\";\n\nexport { movedAssets as assets } from \"./migration/asset-moves.mjs\";\n\nexport const UPDATE_CHUNK_SIZE = 50;\n\n/**\n * Moved compendium content.\n */\nexport const moved = /** @type {const} */ ({\n  // Trapfinding (v10)\n  \"Compendium.ffd20.class-abilities.Item.OhHKCLQXoMlYNodk\": \"Compendium.ffd20.class-abilities.Item.pEODJDoTk7uhCZY7\",\n  // Trap Sense (v10)\n  \"Compendium.ffd20.class-abilities.Item.fb00TzBa32sSisGb\": \"Compendium.ffd20.class-abilities.Item.BoEkMviJrW0PKmhj\",\n  // Danger Sense (v10)\n  \"Compendium.ffd20.class-abilities.Item.4bcGnKYf9beV0nfa\": \"Compendium.ffd20.class-abilities.Item.sTlu3zgAEDdJnER5\",\n  // Fast Movement (v10)\n  \"Compendium.ffd20.class-abilities.Item.dvQdP8QfrDA9Lxzk\": \"Compendium.ffd20.class-abilities.Item.9EX00obqhGHcrOdp\",\n  // A Thousand Faces (v11)\n  \"Compendium.ffd20.class-abilities.Item.cBwQdqQ4KmVBck3t\": \"Compendium.ffd20.class-abilities.Item.MXj2WoyW7vLxiVYw\",\n  // Poison Use (v11)\n  \"Compendium.ffd20.class-abilities.Item.kKaz5A6XbuxgVvhO\": \"Compendium.ffd20.class-abilities.Item.A54sLfcyoR5HGNbP\",\n  \"Compendium.ffd20.class-abilities.Item.AmsnoKelAxLttUbj\": \"Compendium.ffd20.class-abilities.Item.A54sLfcyoR5HGNbP\",\n  // Trap Sense (V11)\n  \"Compendium.ffd20.class-abilities.Item.KbhRBQE5ZyYedJo6\": \"Compendium.ffd20.class-abilities.Item.BoEkMviJrW0PKmhj\",\n});\n\nexport const compendiumRenames = /** @type {const}*/ ({\n  racialhd: \"racial-hd\",\n  commonbuffs: \"buffs\",\n  mythicpaths: \"mythic-paths\",\n  \"pf1e-rules\": \"rules\",\n  \"sample-macros\": \"macros\",\n});\n\nexport function registerRedirects() {\n  for (const [oldUuid, newUuid] of Object.entries(moved)) {\n    CONFIG.compendium.uuidRedirects[oldUuid] = newUuid;\n  }\n\n  const prefix = `Compendium.${game.system.id}`;\n  for (const [oldName, newName] of Object.entries(compendiumRenames)) {\n    CONFIG.compendium.uuidRedirects[`${prefix}.${oldName}`] = `${prefix}.${newName}`;\n  }\n}\n\n/**\n * Material ID changes done with v10.5\n */\nconst materialChanges = {\n  nexavarianSteel: \"nexavaranSteel\",\n  alchemicalsilver: \"alchemicalSilver\",\n  angelskin: \"angelSkin\",\n  bloodcrystal: \"bloodCrystal\",\n  coldiron: \"coldIron\",\n  darkleafcloth: \"darkleafCloth\",\n  eelhide: \"eelHide\",\n  elysianbronze: \"elysianBronze\",\n  fireforgedsteel: \"fireForgedSteel\",\n  frostforgedsteel: \"frostForgedSteel\",\n  griffonmane: \"griffonMane\",\n  liquidglass: \"liquidGlass\",\n  livingsteel: \"livingSteel\",\n  singingsteel: \"singingSteel\",\n  spiresteel: \"spireSteel\",\n};\n\nconst contextMarker = () => ({ ffd20: { action: \"migration\" } });\n\n/**\n * An indicator for whether the system is currently migrating the world.\n *\n * @type {boolean}\n */\n// As the `pf1` global does not use this ES module but a cloned copy, this value\n// only exists for the documentation. Always use `ffd20.migrations.isMigrating` instead!\nexport let isMigrating = false; // eslint-disable-line prefer-const -- ffd20.migrations.isMigrating is changed at runtime\n\n/**\n * Test if provided document has been migrated to current version.\n *\n * @remarks\n * - This only tests migration flag. If the document has been updated with outdated data since, this will return false positive.\n *\n * @param {foundry.abstract.Document} doc - Any document to test\n * @returns {boolean} - Migration matches current version\n */\nexport function isMigrated(doc) {\n  const migration = doc.flags?.ffd20?.migration; // No getFlag() to support pack index entries\n  if (migration) {\n    const v = ffd20.utils.SemanticVersion.fromString(migration);\n    return !v.isLowerThan(ffd20.utils.SemanticVersion.fromString(game.system.version));\n  }\n  return false;\n}\n\n/**\n * Initialize {@link MigrationState} and {@link MigrationDialog}\n *\n * @param {MigrationState} [state] - State tracker\n * @param {string} [label] - Label\n * @param {object} [dialog=null] - If falsy, disable dialog. Otherwise options for the dialog.\n * @returns {MigrationState} - Original state or newly initialized one.\n */\nasync function initializeStateAndDialog(state, label, dialog = null) {\n  state ??= new MigrationState(label);\n  if (dialog) await MigrationDialog.initialize(state, label, dialog);\n\n  return state;\n}\n\n/**\n * Perform a system migration for the entire World,\n * applying migrations for Actors, Items, Scenes, Tokens and Compendium packs\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock=false] - If false, locked compendiums are ignored.\n * @param {boolean} [options.systemPacks=false] - Migrate system packs.\n * @param {MigrationState} [options.state] - Migration state tracker\n * @param {object} [options.dialog={}] - Progress dialog options. Set to falsy to disable the dialog.\n * @param {boolean} [options.fast=true] - Skip documents marked as migrated for current version.\n * @returns {Promise<void>} - A Promise which resolves once the migration is completed\n */\nexport async function migrateWorld({ unlock = false, fast = true, systemPacks = false, state, dialog = {} } = {}) {\n  const isGM = game.user.isGM;\n\n  if (systemPacks) {\n    foundry.utils.logCompatibilityWarning(\n      \"ffd20.migrations.migrateWorld() systemPacks parameter is deprecated in favor of ffd20.migrations.migrateSystem()\",\n      {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      }\n    );\n  }\n\n  // Deny migration if migration is in progress and there's an active GM,\n  // otherwise assume it's an error and allow migration to start anew.\n  // Don't check for the setting to avoid migration state getting stuck, only trust the in-memory state\n  if (ffd20.migrations.isMigrating && game.users.activeGM) {\n    return void ui.notifications.error(game.i18n.localize(\"FFD20.Migration.InProgress\"));\n  }\n\n  if (isGM) await game.settings.set(\"ffd20\", \"migrating\", true);\n\n  ffd20.migrations.isMigrating = true;\n  Hooks.callAll(\"pf1MigrationStarted\", { scope: \"world\" });\n\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.World\", dialog);\n  state.unlock = unlock;\n  state.fast = fast;\n\n  state.start();\n\n  const startMessage = game.i18n.format(\"FFD20.Migration.Start\", { version: game.system.version });\n  const smsgId = ui.notifications.info(startMessage, { permanent: true, console: false });\n  console.log(\"FFD20 | Migration | Starting...\");\n\n  if (isGM) {\n    await _migrateWorldSettings();\n  }\n\n  // Pre-register  migration categories so they all show on the dialog immediately\n  if (dialog) {\n    state.createCategory(\"actors\", \"FFD20.Migration.Category.Actors\", true);\n    state.createCategory(\"items\", \"FFD20.Migration.Category.Items\", true);\n    state.createCategory(\"chat\", \"FFD20.Migration.Category.Chat\", true);\n    state.createCategory(\"packs\", \"FFD20.Migration.Category.Packs\", true);\n    state.createCategory(\"scenes\", \"FFD20.Migration.Category.Scenes\", true);\n\n    // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n    await new Promise((resolve) => setTimeout(resolve, 100));\n  }\n\n  // Migrate World Actors\n  const actorMigration = migrateActors({ state, fast, noHooks: true });\n\n  // Migrate World Items\n  const itemMigration = migrateItems({ state, fast, noHooks: true });\n\n  let packMigration = Promise.resolve(),\n    chatMigration = Promise.resolve();\n\n  if (isGM) {\n    // Migrate chat messages\n    chatMigration = migrateMessages({ state, fast, noHooks: true });\n\n    // Migrate Compendium Packs\n    const packs = game.packs.filter((p) => {\n      const source = p.metadata.packageType;\n      // Ignore modules, adventures, etc.\n      if (![\"world\", \"system\"].includes(source)) return false;\n      // Ignore system packs unless configured to include them\n      if (source === \"system\" && !systemPacks) return false;\n      // Ignore unsupported pack types\n      return [\"Actor\", \"Item\", \"Scene\"].includes(p.metadata.type);\n    });\n\n    packMigration = migrateCompendiums(packs, { unlock, fast, state, noHooks: true });\n  }\n\n  // Migrate Unlinked Actors\n  await actorMigration; // Base actors must be migrated before unlinked actors are migrated\n  const sceneMigration = migrateScenes({ state, fast, noHooks: true });\n\n  // Wait for migrations to finish\n  await Promise.allSettled([itemMigration, packMigration, sceneMigration, chatMigration]);\n\n  // Remove start message\n  ui.notifications.remove(smsgId);\n\n  // Remove migration notification\n  ui.notifications.info(game.i18n.format(\"FFD20.Migration.End\", { version: game.system.version }), { console: false });\n  console.log(\"FFD20 | Migration | Completed!\");\n\n  if (isGM) {\n    // Set the migration as complete\n    await game.settings.set(\"ffd20\", \"systemMigrationVersion\", game.system.version);\n\n    await game.settings.set(\"ffd20\", \"migrating\", false);\n  }\n\n  state.finish();\n\n  Hooks.callAll(\"pf1MigrationFinished\", { scope: \"world\" });\n}\n\n/**\n * Migrate actors directory.\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.fast] - If true, skip already migrated documents.\n * @param {MigrationState} [options.state] - Internal only. State tracker.\n * @param {object} [options.dialog=null] - Dialog configuration.\n * @param {boolean} [options.noHooks=false] - If true, no migration hooks will be fired.\n * @returns {Promise<void>}\n */\nexport async function migrateActors({ fast, state, dialog = null, noHooks = false } = {}) {\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"actors\" });\n\n  // Locally generated state tracker\n  const localState = !state;\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Actors\", dialog);\n\n  if (localState) state.start();\n\n  const tracker = state.createCategory(\"actors\", \"FFD20.Migration.Category.Actors\", true);\n\n  console.log(\"FFD20 | Migration | Actors directory starting...\");\n  tracker.start();\n\n  tracker.setTotal(game.actors.size);\n  tracker.setInvalid(game.actors.invalidDocumentIds.size);\n\n  // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n  if (dialog) await new Promise((resolve) => setTimeout(resolve, 100));\n\n  for (const actor of game.actors) {\n    if (!actor.isOwner || (fast && isMigrated(actor))) {\n      tracker.ignoreEntry(actor);\n      continue;\n    }\n\n    tracker.startEntry(actor);\n\n    try {\n      const updateData = await migrateActorData(actor.toObject(), undefined, { actor });\n      if (!foundry.utils.isEmpty(updateData)) {\n        console.log(`FFD20 | Migration | Actor: ${actor.name} | Applying updates`);\n        await actor.update(updateData, contextMarker());\n      }\n    } catch (err) {\n      tracker.recordError(actor, err);\n      console.error(`FFD20 | Migration | Actor: ${actor.name} | Error`, err);\n    }\n    tracker.finishEntry(actor);\n  }\n\n  console.log(\"FFD20 | Migration | Actors directory complete!\");\n  tracker.finish();\n  if (localState) state.finish();\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"actors\" });\n}\n\n/**\n * Migrate items directory.\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.fast=true] - Ignore already migrated documents.\n * @param {MigrationState} [options.state] - Internal only.\n * @param {object} [options.dialog=null] - Dialog configuration.\n * @param {boolean} [options.noHooks=false] - If true, no migration hooks will be fired.\n * @returns {Promise<void>}\n */\nexport async function migrateItems({ fast = true, state, dialog = null, noHooks = false } = {}) {\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"items\" });\n\n  // Locally generated state tracker\n  const localState = !state;\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Items\", dialog);\n\n  if (localState) state.start();\n\n  const tracker = state.createCategory(\"items\", \"FFD20.Migration.Category.Items\", true);\n\n  console.log(\"FFD20 | Migration | Items directory starting...\");\n  tracker.start();\n\n  tracker.setTotal(game.items.size);\n  tracker.setInvalid(game.items.invalidDocumentIds.size);\n\n  // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n  if (dialog) await new Promise((resolve) => setTimeout(resolve, 100));\n\n  for (const item of game.items) {\n    if (!item.isOwner || (fast && isMigrated(item))) {\n      tracker.ignoreEntry(item);\n      continue;\n    }\n\n    tracker.startEntry(item);\n\n    try {\n      const updateData = await migrateItemData(item.toObject());\n      if (!foundry.utils.isEmpty(updateData)) {\n        console.log(`FFD20 | Migration | Item: ${item.name} | Applying updates`);\n        await item.update(updateData, contextMarker());\n      }\n    } catch (err) {\n      tracker.recordError(item, err);\n      console.error(`FFD20 | Migration | Item: ${item.name} | Error`, err);\n    }\n    tracker.finishEntry(item);\n  }\n\n  tracker.finish();\n  if (localState) state.finish();\n  console.log(\"FFD20 | Migration | Items directory complete!\");\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"items\" });\n}\n\n/**\n * Migrate all scenes.\n *\n * @see {@link migrateScene}\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.fast=true] - Skip already migrated documents.\n * @param {MigrationState} [options.state] - Internal only. State tracker.\n * @param {boolean} [options.noHooks=false] - If true, no migration hooks will be fired.\n * @param {object} [options.dialog=null] - Dialog configuration.\n * @returns {Promise<void>}\n */\nexport async function migrateScenes({ fast, state, noHooks = false, dialog = null } = {}) {\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"scenes\" });\n\n  // Locally generated state tracker\n  const localState = !state;\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Scenes\", dialog);\n\n  if (localState) state.start();\n\n  const tracker = state.createCategory(\"scenes\", \"FFD20.Migration.Category.Scenes\", true);\n\n  console.log(\"FFD20 | Migration | Scene directory starting...\");\n  tracker.start();\n\n  tracker.setTotal(game.scenes.size);\n  tracker.setInvalid(game.scenes.invalidDocumentIds.size);\n\n  // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n  if (dialog) await new Promise((resolve) => setTimeout(resolve, 100));\n\n  for (const scene of game.scenes) {\n    tracker.startEntry(scene);\n    await migrateScene(scene, { fast, state, tracker });\n    tracker.finishEntry(scene);\n  }\n\n  tracker.finish();\n\n  if (localState) state.finish();\n  console.log(\"FFD20 | Migration | Scene directory complete!\");\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"scenes\" });\n}\n\n/**\n * Migrate compendiums.\n *\n * @see {@link migrateCompendium}\n *\n * @param {Array<string|WorldCollection>|null} [packs=null] - Array of pack IDs or packs to migrate. If null, all packs will be migrated.\n * @param {object} [options={}] - Additional options to pass along.\n * @param {boolean} [options.unlock=false] - If false, locked compendiums are ignored.\n * @param {boolean} [options.noHooks=false] - If true, no migration hooks will be fired.\n * @param {boolean} [options.fast=true] - Skip documents marked as migrated for current version.\n * @param {MigrationState} [options.state] - Migration state tracker\n * @param {object} [options.dialog=null] - Display migration dialog. Falsy disables.\n * @returns {Promise<void>} - Promise that resolves once all migrations are complete.\n * @throws {Error} - If defined pack is not found.\n */\nexport async function migrateCompendiums(\n  packs = null,\n  { unlock = false, fast = true, state, noHooks = false, dialog = null } = {}\n) {\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"packs\", packs: foundry.utils.deepClone(packs) });\n\n  if (packs === null) packs = [...game.packs];\n\n  // Locally generated state tracker\n  const localState = !state;\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Packs\", dialog);\n  if (state) {\n    state.unlock = unlock;\n    state.fast = fast;\n  }\n\n  if (localState) state?.start();\n\n  const tracker = state?.createCategory(\"packs\", \"FFD20.Migration.Category.Packs\", true);\n\n  tracker?.start();\n  tracker?.setTotal(packs.length);\n\n  // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n  if (dialog) await new Promise((resolve) => setTimeout(resolve, 100));\n\n  for (const pack of packs) {\n    if (!unlock && pack.locked) {\n      tracker?.ignoreEntry(pack);\n      continue;\n    }\n\n    tracker?.startEntry(pack);\n\n    try {\n      await migrateCompendium(pack, { unlock, fast, noHooks: true, tracker });\n    } catch (err) {\n      console.error(`FFD20 | Migration | Pack: ${pack.collection} | Error\\n`, err);\n      tracker?.recordError({ name: game.i18n.localize(pack.metadata.label), uuid: pack.metadata.id }, err);\n    }\n\n    tracker?.finishEntry(pack);\n  }\n\n  tracker?.finish();\n  if (localState) state?.finish();\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"packs\", packs: foundry.utils.deepClone(packs) });\n}\n\n/**\n * Migrate system compendia.\n *\n * Convenience wrapper for migrateCompendiums.\n *\n * @see {@link migrateCompendiums}\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock] - Unlock compendiums\n * @param {boolean} [options.fast=false] - Skip unmigrated documents.\n * @param {boolean} [options.server] - Call server-side migration on data. Developers only.\n * @param {MigrationState} [options.state] - Internal only. State tracker.\n * @param {object} [options.dialog={}] - Migration dialog options. Falsy disables the dialog.\n * @returns {Promise<void>}\n */\nexport async function migrateSystem({ unlock = true, fast = false, server = true, state, dialog = {} } = {}) {\n  Hooks.callAll(\"pf1MigrationStarted\", { scope: \"system\" });\n\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.System\", dialog);\n  state.unlock = unlock;\n  state.fast = fast;\n\n  state.start();\n  console.debug(\"FFD20 | Migration | System migration starting...\");\n\n  const packs = game.packs.filter((p) => p.metadata.packageType === \"system\");\n\n  await migrateCompendiums(packs, { unlock, fast, server, state, dialog: false, noHooks: true });\n\n  console.debug(\"FFD20 | Migration | System migration complete!\");\n  state.finish();\n\n  Hooks.callAll(\"pf1MigrationFinished\", { scope: \"system\" });\n}\n\n/**\n * Migrate module compendia.\n *\n * Convenience wrapper for migrateCompendiums.\n *\n * @see {@link migrateCompendiums}\n *\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock] - Unlock compendiums\n * @param {boolean} [options.fast=true] - Skip documents marked as migrated for current version.\n * @param {boolean} [options.server=true] - Call server-side migration. Developers only.\n * @param {object} [options.dialog={}] - Dialog options. Falsy disables the dialog.\n * @param {MigrationState} [options.state] - Internal only. State tracker instance.\n * @returns {Promise<void>}\n */\nexport async function migrateModules({ unlock = true, server = true, fast = true, state, dialog = {} } = {}) {\n  Hooks.callAll(\"pf1MigrationStarted\", { scope: \"modules\" });\n\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Modules\", dialog);\n  state.unlock = unlock;\n  state.fast = fast;\n\n  state.start();\n  console.debug(\"FFD20 | Migration | Module migration starting...\");\n\n  const packs = game.packs.filter((p) => p.metadata.packageType === \"module\");\n  await migrateCompendiums(packs, { unlock, fast, server, state, noHooks: true });\n\n  console.debug(\"FFD20 | Migration | Module migration complete!\");\n  state.finish();\n\n  Hooks.callAll(\"pf1MigrationFinished\", { scope: \"modules\" });\n}\n\n/* -------------------------------------------- */\n\n/**\n * Apply migration rules to all Documents within a single Compendium pack\n *\n * @param {CompendiumCollection|string} pack - Compendium (or its ID) to migrate\n * @param {object} [options={}] - Additional options\n * @param {boolean} [options.unlock=false] - If false, locked compendium will be ignored.\n * @param {boolean} [options.fast=true] - Skip documents marked as migrated for current version.\n * @param {boolean} [options.noHooks=false] - If true, no migration hooks will be fired.\n * @param {MigrationCategory} [options.tracker] - Internal only. Tracker instance.\n * @param {boolean} [options.marker=true] - Add migration marker to migrated documents.\n * @param {boolean} [options.server=false] - Call server-side migration. Developers only.\n * @returns {Promise<void>} - Promise that resolves once migration is complete.\n * @throws {Error} - If defined pack is not found.\n */\nexport async function migrateCompendium(\n  pack,\n  { unlock = false, fast = true, server = false, marker = true, noHooks = false, tracker } = {}\n) {\n  if (typeof pack === \"string\") {\n    pack = game.packs.get(pack);\n    if (!pack) throw new Error(`Compendium \"${pack}\" not found.`);\n  }\n\n  if (pack.locked && !unlock) return;\n\n  const docType = pack.metadata.type;\n  if (![\"Actor\", \"Item\", \"Scene\", \"RollTable\", \"Macro\"].includes(docType)) return;\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"pack\", collection: pack });\n\n  // Iterate over compendium entries - applying fine-tuned migration functions\n  console.log(`FFD20 | Migration | Pack: ${pack.collection} | Starting...`);\n\n  const wasLocked = pack.locked;\n\n  // Server-side migration; only useful for development\n  if (server) {\n    if (wasLocked) await pack.configure({ locked: false });\n    console.debug(`FFD20 | Migration | Pack: ${pack.collection} | Server-side migration starting...`);\n    await pack.migrate();\n    console.debug(`FFD20 | Migration | Pack: ${pack.collection} | Server-side migration done!`);\n    ui.notifications.clear(); // Do aggressive clearing\n  }\n\n  console.debug(`FFD20 | Migration | Pack: ${pack.collection} | Fetching ${pack.index.size} document(s)`);\n\n  /** @type {Actor[]|JournalEntry[]|Item[]} */\n  const documents = await pack.getDocuments();\n\n  console.debug(`FFD20 | Migration | Pack: ${pack.collection} | Building update data...`);\n\n  // Collect updates\n  const updates = [];\n\n  async function applyUpdates() {\n    console.debug(`FFD20 | Migration | Pack: ${pack.collection} | Applying update(s) to ${updates.length} document(s)`);\n\n    if (pack.locked) await pack.configure({ locked: false });\n\n    // Commit updates\n    try {\n      await getDocumentClass(docType).updateDocuments(updates, { pack: pack.collection, ...contextMarker() });\n    } catch (err) {\n      console.error(`FFD20 | Migration | Pack: ${pack.collection} | Error:`, err);\n      tracker?.recordError({ name: game.i18n.localize(pack.metadata.label), uuid: pack.metadata.id }, err);\n    }\n  }\n\n  while (documents.length) {\n    const document = documents.shift();\n    if (fast && isMigrated(document)) continue;\n\n    try {\n      let updateData;\n      switch (docType) {\n        case \"Item\":\n          updateData = await migrateItemData(document.toObject(), undefined, { item: document });\n          break;\n        case \"Actor\":\n          updateData = await migrateActorData(document.toObject(), undefined, { actor: document });\n          break;\n        case \"Scene\": {\n          await migrateScene(document);\n          break;\n        }\n      }\n\n      if (updateData && !foundry.utils.isEmpty(updateData)) {\n        updateData._id = document.id;\n        updates.push(updateData);\n      }\n    } catch (err) {\n      tracker?.recordError(document, err);\n      console.error(`FFD20 | Migration | Pack: ${pack.collection} | Error!`, err);\n    }\n\n    if (updates.length >= ffd20.migrations.UPDATE_CHUNK_SIZE) {\n      await applyUpdates();\n      updates.length = 0; // Clear update array\n    }\n  }\n\n  if (updates.length) {\n    await applyUpdates();\n  } else {\n    console.debug(`FFD20 | Migration | Pack: ${pack.collection} | No updates needed`);\n  }\n\n  if (wasLocked) await pack.configure({ locked: true });\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"pack\", collection: pack });\n\n  console.log(`FFD20 | Migration | Pack: ${pack.collection} | Complete!`);\n}\n\n/**\n * Migrates world settings.\n */\nasync function _migrateWorldSettings() {}\n\n/* -------------------------------------------- */\n/*  Document Type Migration Helpers               */\n/* -------------------------------------------- */\n\n/**\n * Migrate data in tokens that is no longer used.\n *\n * @param {object} tokenData Token data\n * @param {object} [options] - Additional options\n * @param {TokenDocument} [options.token] - Token document\n * @param {boolean} [options.marker=true] - Add migration marker\n */\nexport async function migrateTokenData(tokenData, { token, marker = true }) {\n  const flags = tokenData.flags?.ffd20 ?? {};\n\n  const updateData = {};\n\n  // Remove obsolete flags\n  if (flags.lowLightVision !== undefined) {\n    updateData[\"flags.ffd20.-=lowLightVision\"] = null;\n  }\n  if (flags.lowLightVisionMultiplier !== undefined) {\n    updateData[\"flags.ffd20.-=lowLightVisionMultiplier\"] = null;\n  }\n  if (flags.lowLightVisionMultiplierBright !== undefined) {\n    updateData[\"flags.ffd20.-=lowLightVisionMultiplierBright\"] = null;\n  }\n\n  // Remove disabled but still in use flags\n  if (flags.disableLowLight === false) {\n    updateData[\"flags.ffd20.-=disableLowLight\"] = null;\n  }\n  if (flags.staticSize === false) {\n    updateData[\"flags.ffd20.-=staticSize\"] = null;\n  }\n  if (flags.customVisionRules === false) {\n    updateData[\"flags.ffd20.-=customVisionRules\"] = null;\n  }\n\n  // Remove data from v9 vision handling\n  // Added with PF1 v9.4\n  if (!flags.customVisionRules) {\n    let visionMode, range;\n    // Attempt to preserve vision range after migration\n    if (tokenData.sight.visionMode !== \"basic\") {\n      if (tokenData.sight.range !== 0) range = 0;\n      visionMode = \"basic\";\n    }\n\n    // HACK: Foundry V13 does not allow deleting these to reset them, so we reset them via temporary document\n    const { saturation, brightness, attenuation, contrast } = new TokenDocument().toObject().sight;\n    updateData.sight = { saturation, brightness, attenuation, contrast, range, visionMode };\n\n    if (tokenData.detectionModes?.length) updateData[\"detectionModes\"] = [];\n  }\n\n  // Record migrated version\n  if (marker && !foundry.utils.isEmpty(updateData)) {\n    updateData[\"flags.ffd20.migration\"] = game.system.version;\n  }\n\n  return updateData;\n}\n\n/**\n * Migrate token.\n *\n * @param {TokenDocument} token - Token to migrate\n * @returns {Promise<TokenDocument|null>} - Promise to updated document,. or null if no update was done.\n */\nexport async function migrateToken(token) {\n  const tokenData = token.toObject();\n  const updateData = await migrateTokenData(tokenData, { token });\n  if (!foundry.utils.isEmpty(updateData)) {\n    return token.update(foundry.utils.expandObject(updateData), contextMarker());\n  }\n}\n\n/**\n * Migrate singular actor document.\n *\n * @param {Actor} actor - Actor to migrate.\n * @returns {Promise<void>}\n */\nexport async function migrateActor(actor) {\n  console.debug(\"FFD20 | Migration | Starting |\", actor.name, actor.uuid);\n\n  const updateData = await migrateActorData(actor.toObject(), actor.token, { actor });\n  if (!foundry.utils.isEmpty(updateData)) {\n    await actor.update(updateData, contextMarker());\n  }\n\n  await migrateActiveEffectsToItems(actor);\n\n  console.debug(\"FFD20 | Migration | Finished |\", actor.name, actor.uuid);\n}\n\n/**\n * Migrate active effects from actor to items that should own them instead.\n *\n * Added with PF1 v10\n *\n * @param {ActorPF} actor\n */\nexport async function migrateActiveEffectsToItems(actor) {\n  const p = [];\n\n  for (const ae of actor.effects) {\n    // Ignore all cases that would indicate this is not the old tracker AE\n    // Essentially verify the AE does absolutely nothing on its own, as the old AEs had no good markers.\n    if (ae.statuses.size > 0) continue;\n    if (ae.transfer) continue;\n    if (ae.disabled) continue;\n    if (ae.type !== \"base\") continue;\n    if (!ae.origin) continue;\n    if (ae.changes.length !== 0) continue;\n    if (ae.description.length > 0) continue;\n    if (Object.keys(ae.flags).some((k) => ![\"ffd20\"].includes(k))) continue; // Non-PF1 flags\n\n    const item = await fromUuid(ae.origin, { relative: actor });\n    if (!item) continue;\n    if (item.name !== ae.name) continue;\n\n    // Transfer tracker AE to item\n    if (item.effect?.type !== \"buff\") {\n      const aeData = ae.toObject();\n      aeData.transfer = true;\n      aeData.type = \"buff\";\n\n      const p0 = ActiveEffect.implementation.create(aeData, { parent: item });\n      p.push(p0);\n    }\n\n    // Delete old in all cases.\n    // CAUTION: This is technically destructive as the above criteria is NOT foolproof.\n    p.push(ae.delete());\n  }\n\n  await Promise.all(p);\n}\n\n/**\n * Migrate a single Actor document to incorporate latest data model changes\n * Return an Object of updateData to be applied\n *\n * @param {ActorData} actorData   The actor data to derive an update from\n * @param {TokenDocument} token\n * @param {object} [options] - Additional options\n * @param {Actor} [options.actor] - Associated actor document\n * @param {boolean} [options.marker=true] - Add migration marker\n * @returns {object} - The updateData to apply\n */\nexport async function migrateActorData(actorData, token, { actor, marker = true } = {}) {\n  // Ignore module introduced types\n  if (actorData.type.indexOf(\".\") !== -1) return {};\n\n  const updateData = {};\n\n  _migrateActorEncumbrance(actorData, updateData);\n  _migrateActorNoteArrays(actorData, updateData);\n  _migrateActorSpeed(actorData, updateData);\n  _migrateActorSpellbookCL(actorData, updateData);\n  _migrateActorSpellbookSlots(actorData, updateData);\n  _migrateActorSpellbookPrep(actorData, updateData);\n  _migrateActorSpellbookKind(actorData, updateData, actor);\n  _migrateActorConcentration(actorData, updateData);\n  _migrateActorBaseStats(actorData, updateData);\n  _migrateUnusedActorCreatureType(actorData, updateData);\n  _migrateActorSpellbookDCFormula(actorData, updateData);\n  _migrateActorHPAbility(actorData, updateData);\n  _migrateActorCR(actorData, updateData);\n  _migrateAttackAbility(actorData, updateData);\n  _migrateActorDefenseAbility(actorData, updateData);\n  _migrateActorSpellbookUsage(actorData, updateData);\n  _migrateActorNullValues(actorData, updateData);\n  _migrateActorSpellbookDomainSlots(actorData, updateData);\n  _migrateActorStatures(actorData, updateData);\n  _migrateActorInitAbility(actorData, updateData);\n  _migrateActorChangeRevamp(actorData, updateData);\n  _migrateActorCMBRevamp(actorData, updateData);\n  _migrateCarryBonus(actorData, updateData);\n  _migrateBuggedValues(actorData, updateData);\n  _migrateSpellbookUsage(actorData, updateData);\n  _migrateActorHP(actorData, updateData);\n  _migrateActorSenses(actorData, updateData, token);\n  _migrateActorInvaliddSkills(actorData, updateData);\n  _migrateActorSkillRanks(actorData, updateData);\n  _migrateActorSkillJournals(actorData, updateData);\n  _migrateActorSubskillData(actorData, updateData);\n  _migrateActorUnusedData(actorData, updateData);\n  _migrateActorDRandER(actorData, updateData);\n  _migrateActorTraits(actorData, updateData);\n  _migrateActorProficiencies(actorData, updateData);\n  _migrateActorFlags(actorData, updateData);\n  _migrateGilToGoldBackend(actor, updateData);\n\n  // Migrate Owned Items\n  const items = [];\n  for (const item of actorData.items ?? []) {\n    // Migrate the Owned Item\n    const itemData = item instanceof Item ? item.toObject() : item;\n    const itemDoc = actor?.items.get(itemData._id);\n    try {\n      const itemUpdate = await migrateItemData(itemData, actor, { item: itemDoc });\n\n      // Update the Owned Item\n      if (!foundry.utils.isEmpty(itemUpdate)) {\n        itemUpdate._id = itemData._id;\n        items.push(foundry.utils.expandObject(itemUpdate));\n      }\n    } catch (err) {\n      console.error(\n        `Error migrating Item \"${item.name}\" [${itemDoc?.uuid ?? itemData._id}] on actor \"${actorData.name}\" [${\n          actor?.uuid ?? actorData._id\n        }]`\n      );\n      throw new Error(`Item \"${item.name}\" [${itemData._id}] failed migration: ${err.message}`, { cause: err });\n    }\n  }\n  if (items.length > 0) updateData.items = items;\n\n  // Active Effects\n  await _migrateActorActiveEffects(actorData, updateData, actor);\n\n  // Record migrated version\n  if (marker && !foundry.utils.isEmpty(updateData)) {\n    updateData[\"flags.ffd20.migration\"] = game.system.version;\n  }\n\n  return foundry.utils.expandObject(updateData);\n}\n\n/* -------------------------------------------- */\n\n/**\n *  Migrate singular item document.\n *\n * @param {Item} item - Item document to update.\n * @returns {Promise<Item|null>} - Promise to updated item document, or null if no update was performed.\n */\nexport async function migrateItem(item) {\n  let updated = false;\n  const updateData = await migrateItemData(item.toObject(), item.actor, { item });\n  if (!foundry.utils.isEmpty(updateData)) {\n    updated = true;\n    await item.update(updateData, contextMarker());\n  }\n\n  await migrateItemActiveEffects(item);\n\n  return updated ? item : null;\n}\n\n/**\n * Migrate active effects on an item.\n *\n * @param {Item} item\n * @returns {Promise<ActiveEffect[]|null>} - Updated active effects, or null if no updates were needed.\n */\nexport async function migrateItemActiveEffects(item) {\n  const itemData = item.toObject();\n\n  const updateData = {};\n  await migrateItemDataActiveEffects(itemData, updateData);\n\n  if (updateData.effects?.length) {\n    return item.updateEmbeddedDocuments(\"ActiveEffect\", updateData.effects);\n  }\n\n  return null;\n}\n\n/**\n * Migrate active effects in item data\n *\n * @param {object} itemData - Item data\n * @param {object} updateData - Object to hold update data\n */\nasync function migrateItemDataActiveEffects(itemData, updateData) {\n  const { effects = [] } = itemData;\n\n  const updates = [];\n  for (const effect of effects) {\n    const updateData = {};\n\n    // Convert method of tracker identification\n    if (itemData.type === \"buff\") {\n      if (effect.flags?.ffd20?.tracker && effect.type === \"base\") {\n        updateData.type = \"buff\";\n        updateData[\"flags.ffd20.-=tracker\"] = null;\n      }\n    }\n\n    const duration = effect.flags?.ffd20?.duration;\n    if (duration) {\n      // Transfer initiative value to system data\n      const init = effect.flags?.ffd20?.duration?.initiative;\n      if (init !== undefined) {\n        if (effect.system?.initiative === undefined) updateData[\"system.initiative\"] = init;\n      }\n\n      // End timing\n      const endTiminig = effect.flags?.ffd20?.duration?.end;\n      if (endTiminig !== undefined) {\n        if (!effect.system?.end) updateData[\"system.end\"] = endTiminig;\n      }\n\n      updateData[\"flags.ffd20.-=duration\"] = null;\n    }\n\n    if (!foundry.utils.isEmpty(updateData)) {\n      updateData._id = effect._id;\n      updates.push(updateData);\n    }\n  }\n\n  if (updates.length) {\n    updateData.effects = updates;\n  }\n}\n\n/**\n * Migrate a single Item document to incorporate latest data model changes\n *\n * @param {object} itemData    The item data to derive an update from\n * @param {Actor} actor - Parent actor document\n * @param {object} [options] - Additional options\n * @param {number} [options._depth=0] - Internal only. Recursion depth tracking.\n * @param {Item} [options.item] - Item document\n * @param {boolean} [options.marker=true] - Add migration marker\n * @returns {object} - The updateData to apply\n */\nexport async function migrateItemData(itemData, actor = null, { item, _depth = 0, marker = true } = {}) {\n  const updateData = {};\n\n  // Migrate data to system\n  if (itemData.system == null && itemData.data != null) {\n    itemData = foundry.utils.deepClone(itemData);\n    itemData.system = itemData.data;\n    delete itemData.data;\n  }\n\n  // Ignore module introduced types\n  if (!Object.keys(game.system.documentTypes.Item).includes(itemData.type)) return {};\n\n  _migrateItemFlags(itemData, updateData);\n  _migrateItemArrayTypes(itemData, updateData);\n  _migrateFlagsArrayToObject(itemData, updateData);\n  _migrateWeaponImprovised(itemData, updateData);\n  _migrateItemSpellDescription(itemData, updateData);\n  _migrateClassDynamics(itemData, updateData);\n  _migrateClassType(itemData, updateData);\n  _migrateClassCasting(itemData, updateData);\n  _migrateSpellDivineFocus(itemData, updateData);\n  _migrateWeaponCategories(itemData, updateData);\n  _migrateArmorCategories(itemData, updateData);\n  _migrateArmorMaxDex(itemData, updateData);\n  _migrateItemSize(itemData, updateData);\n  _migrateItemFeatAbilityTypes(itemData, updateData);\n  _migrateClassLevels(itemData, updateData);\n  _migrateSavingThrowTypes(itemData, updateData);\n  _migrateCR(itemData, updateData);\n  _migrateItemChanges(itemData, updateData);\n  _migrateItemChangeFlags(itemData, updateData);\n  _migrateItemContextNotes(itemData, updateData);\n  _migrateEquipmentSize(itemData, updateData);\n  _migrateSpellCosts(itemData, updateData);\n  _migrateSpellPreparation(itemData, updateData, { item });\n  _migrateLootEquip(itemData, updateData);\n  await _migrateItemLinks(itemData, updateData, { item, actor });\n  _migrateItemProficiencies(itemData, updateData);\n  _migrateItemNotes(itemData, updateData);\n  _migrateScriptCalls(itemData, updateData);\n  _migrateItemActionToActions(itemData, updateData, { item, actor });\n  _migrateItemChargeCost(itemData, updateData);\n  _migrateItemLimitedUses(itemData, updateData);\n  _migrateItemWeight(itemData, updateData);\n  _migrateItemHealth(itemData, updateData);\n  _migrateContainerReduction(itemData, updateData);\n  _migrateContainerPrice(itemData, updateData);\n  _migrateItemType(itemData, updateData);\n  _migrateItemLearnedAt(itemData, updateData);\n  _migrateItemTuples(itemData, updateData);\n  _migrateEquipmentCategories(itemData, updateData);\n  _migrateSpellDescriptors(itemData, updateData);\n  _migrateItemTraits(itemData, updateData);\n  _migrateRaceItemCreatureType(itemData, updateData);\n  _migrateItemChangeFlags(itemData, updateData);\n  _migrateItemMaterials(itemData, updateData);\n  _migrateSpellMultischool(itemData, updateData);\n  _migrateSpellSubschool(itemData, updateData);\n  _migrateItemDefaultAmmo(itemData, updateData);\n  _migrateItemDurability(itemData, updateData);\n  _migrateItemHeld(itemData, updateData);\n  _migrateItemUnusedData(itemData, updateData);\n\n  // Migrate action data\n  const alreadyHasActions = itemData.system.actions instanceof Array && itemData.system.actions.length > 0;\n  const itemActionData = alreadyHasActions ? itemData.system.actions : updateData[\"system.actions\"];\n  if (itemActionData instanceof Array) {\n    const newActionData = itemActionData.map((action) => migrateItemActionData(action, updateData, { itemData, item }));\n    // Update only if something changed. Bi-directional testing for detecting deletions.\n    if (\n      !foundry.utils.isEmpty(foundry.utils.diffObject(itemActionData, newActionData)) ||\n      !foundry.utils.isEmpty(foundry.utils.diffObject(newActionData, itemActionData))\n    ) {\n      updateData[\"system.actions\"] = newActionData;\n    }\n  }\n\n  // Migrate container .inventoryItems array to .items map\n  // Introduced with PF1 v10\n  if (itemData.system?.inventoryItems instanceof Array) {\n    updateData[\"system.items\"] = {};\n    for (const sitem of itemData.system.inventoryItems) {\n      sitem._id ||= foundry.utils.randomID(16);\n\n      // Deal with corrupt items or v9 or older items\n      sitem.system ??= {};\n      try {\n        if (\"data\" in sitem) {\n          sitem.system = foundry.utils.mergeObject(sitem.data, sitem.system, { inplace: false });\n          delete sitem.data;\n        }\n\n        const subItem = new Item.implementation(sitem);\n\n        const itemUpdateData = await migrateItemData(subItem.toObject(), actor, { _depth: _depth + 1 });\n        subItem.updateSource(itemUpdateData);\n\n        updateData[\"system.items\"][sitem._id] = subItem.toObject();\n      } catch (err) {\n        console.error(\"Failed to migrate container content:\", { item: sitem, parent: item, actor });\n      }\n    }\n\n    updateData[\"system.-=inventoryItems\"] = null;\n  }\n\n  // Migrate container items\n  const migrateContainerItems = async (items) => {\n    if (!items) return;\n    for (const [itemId, itemData] of Object.entries(items)) {\n      try {\n        // Basic validation\n        const subItem = new Item.implementation(itemData);\n\n        // Migrate\n        const subUpdate = await migrateItemData(subItem.toObject(), actor, { item: subItem, _depth: _depth + 1 });\n\n        if (!foundry.utils.isEmpty(subUpdate)) {\n          const diff = subItem.updateSource(subUpdate);\n          updateData[\"system.items\"] ??= {};\n          updateData[\"system.items\"][itemId] = diff;\n        }\n      } catch (err) {\n        console.error(\"FFD20 | Migration | Error\", err, item);\n      }\n    }\n  };\n\n  await migrateContainerItems(itemData.system.items);\n\n  await migrateItemDataActiveEffects(itemData, updateData);\n\n  // Record migrated version\n  if (marker && !foundry.utils.isEmpty(updateData)) {\n    updateData[\"flags.ffd20.migration\"] = game.system.version;\n  }\n\n  // Return the migrated update data\n  return updateData;\n}\n\n// Added with PF1 v10\nfunction _migrateActionLimitedUses(action, itemData) {\n  // Only physical items can be single use\n  const isPhysical = CONFIG.Item.documentClasses[itemData.type]?.isPhysical;\n  if (!isPhysical) {\n    if (action.uses?.self?.per === \"single\") {\n      action.uses.self.per = \"charges\";\n      action.uses.self.maxFormula = \"1\";\n    }\n  }\n}\n\n/**\n * Migrates a single action within an item.\n *\n * @param {object} actionData - The action's data, which also serves as the update data to pass on.\n * @param {object} updateData - Item update data\n * @param {object} [options] - Additional options\n * @param {Item} [options.item=null] - Parent item document this action is in.\n * @param {object} options.itemData - Parent item data\n * @returns {object} The resulting action data.\n */\nexport function migrateItemActionData(actionData, updateData, { itemData, item = null } = {}) {\n  actionData = foundry.utils.deepClone(actionData);\n\n  const action = item?.actions?.get(actionData._id);\n\n  // Migrations that must be done before datamodel cleans the needed data out\n  _migrateActionDamageType(actionData, itemData);\n  _migrateActionLimitedUses(actionData, itemData);\n  _migrateActionExtraAttacks(actionData, itemData);\n  _migrateActionAmmunitionUsage(actionData, itemData, updateData);\n  _migrateActionDuration(actionData, itemData);\n  _migrateActionMaterials(actionData, itemData);\n\n  actionData = new ffd20.components.ItemAction(actionData).toObject();\n\n  _migrateActionConditionals(actionData, itemData, { action });\n  _migrateActionHarmlessSpell(actionData, itemData);\n\n  // Return the migrated update data\n  return actionData;\n}\n\n/* -------------------------------------------- */\n\n/**\n * Migrate singular scene document.\n *\n * @param {Scene} scene - Scene document to update.\n * @param {object} [options] - Additional options\n * @param {MigrationState} [options.state=null]\n * @param {MigrationCategory} [options.tracker=null]\n * @param {boolean} [options.fast] - Skip already migrated\n * @returns {Promise<void>}\n */\nexport async function migrateScene(scene, { fast = true, state, tracker } = {}) {\n  console.log(`FFD20 | Migration | Scene: ${scene.name} | Starting...`);\n  try {\n    await migrateSceneTokens(scene, { fast, state, tracker });\n    await migrateSceneActors(scene, { fast, state, tracker });\n\n    // Mark last migrated version\n    if (game.user.isGM) await scene.setFlag(\"ffd20\", \"migration\", game.system.version);\n  } catch (err) {\n    tracker?.recordError(scene, err);\n    console.error(`FFD20 | Migration | Scene: ${scene.name} | Error`, err);\n  }\n  console.log(`FFD20 | Migration | Scene: ${scene.name} | Complete!`);\n}\n\n/**\n * Migrate tokens in a single scene.\n *\n * @param {Scene} scene - The Scene to Update\n * @param {object} [options] - Additional options\n * @param {boolean} [options.fast=true] - Ignore already migrated documents.\n * @param {MigrationState} [options.state=null]\n * @param {MigrationCategory} [options.tracker=null]\n */\nexport async function migrateSceneTokens(scene, { fast = true, state = null, tracker = null } = {}) {\n  for (const token of scene.tokens) {\n    if (!token.isOwner) continue;\n\n    if (fast && isMigrated(token)) continue;\n\n    try {\n      await migrateToken(token);\n    } catch (err) {\n      tracker?.recordError(token, err);\n      console.error(`FFD20 | Migration | Scene: ${scene.name} | Token: ${token.id} | Error`, token, err);\n    }\n  }\n}\n\n/**\n * Migrate unlinked actors on a single scene.\n *\n * @param {Scene} scene - Scene to migrate actors in.\n * @param {object} [options] - Additional options\n * @param {boolean} [options.fast=true] - Ignore already migrated documents.\n * @param {MigrationState} [options.state=null]\n * @param {MigrationCategory} [options.tracker=null]\n * @returns {Promise<void>}\n */\nexport async function migrateSceneActors(scene, { fast = true, state = null, tracker = null } = {}) {\n  for (const token of scene.tokens) {\n    if (token.isLinked) continue;\n    const actor = token.actor;\n    if (!actor?.isOwner) continue;\n\n    if (fast && isMigrated(actor)) continue;\n\n    try {\n      const updateData = await migrateActorData(actor.toObject(), token, { actor });\n      if (!foundry.utils.isEmpty(updateData)) {\n        if (!(updateData.items?.length > 0)) delete updateData.items;\n        if (!(updateData.effects?.length > 0)) delete updateData.effects;\n        if (!foundry.utils.isEmpty(updateData)) await actor.update(updateData, contextMarker());\n      }\n    } catch (err) {\n      tracker?.recordError(token, err);\n      console.error(`FFD20 | Migration | Scene: ${scene.name} | Token: ${token.id} | Error`, token, err);\n    }\n  }\n}\n\n/* -------------------------------------------- */\n\nfunction _migrateActorEncumbrance(ent, updateData) {\n  const arr = {\n    \"system.attributes.encumbrance.level\": \"attributes.encumbrance.-=level\",\n    \"system.attributes.encumbrance.levels.light\": \"attributes.encumbrance.levels.-=light\",\n    \"system.attributes.encumbrance.levels.medium\": \"attributes.encumbrance.levels.-=medium\",\n    \"system.attributes.encumbrance.levels.heavy\": \"attributes.encumbrance.levels.-=heavy\",\n    \"system.attributes.encumbrance.levels.carry\": \"attributes.encumbrance.levels.-=carry\",\n    \"system.attributes.encumbrance.levels.drag\": \"attributes.encumbrance.levels.-=drag\",\n    \"system.attributes.encumbrance.carriedWeight\": \"attributes.encumbrance.-=carriedWeight\",\n  };\n  for (const [key, updateKey] of Object.entries(arr)) {\n    const value = foundry.utils.getProperty(ent, key);\n    if (value !== undefined) {\n      updateData[\"system.\" + updateKey] = null;\n    }\n  }\n}\n\n/**\n * Convert array based flags into object.\n *\n * @param ent\n * @param updateData\n */\nfunction _migrateFlagsArrayToObject(ent, updateData) {\n  const flags = ent.system.flags;\n  if (!flags) return;\n  const bflags = flags.boolean,\n    dflags = flags.dictionary;\n\n  if (Array.isArray(bflags)) {\n    // Compatibility with old data: Convert old array into actual dictionary.\n    updateData[\"system.flags.boolean\"] = bflags.reduce((flags, flag) => {\n      flags[flag] = true;\n      return flags;\n    }, {});\n  }\n\n  if (Array.isArray(dflags)) {\n    updateData[\"system.flags.dictionary\"] = dflags.reduce((flags, [key, value]) => {\n      flags[key] = value;\n      return flags;\n    }, {});\n  }\n}\n\nfunction _migrateActorNoteArrays(ent, updateData) {\n  const list = [\"system.attributes.acNotes\", \"system.attributes.cmdNotes\", \"system.attributes.srNotes\"];\n  for (const k of list) {\n    const value = foundry.utils.getProperty(ent, k);\n    const hasValue = foundry.utils.hasProperty(ent, k);\n    if (hasValue && value instanceof Array) {\n      updateData[k] = value.join(\"\\n\");\n    }\n  }\n}\n\nfunction _migrateActorSpeed(ent, updateData) {\n  const arr = [\n    \"attributes.speed.land\",\n    \"attributes.speed.climb\",\n    \"attributes.speed.swim\",\n    \"attributes.speed.fly\",\n    \"attributes.speed.burrow\",\n  ];\n  for (const k of arr) {\n    let value = foundry.utils.getProperty(ent.system, k);\n    if (typeof value === \"string\") value = parseInt(value);\n    if (typeof value === \"number\") {\n      updateData[`system.${k}.base`] = value;\n    } else if (value === null) {\n      updateData[`system.${k}.base`] = 0;\n    } else if (value?.total !== undefined) {\n      // Delete derived data\n      updateData[`system.${k}.-=total`] = null;\n    }\n\n    // Add maneuverability\n    if (k === \"attributes.speed.fly\" && foundry.utils.getProperty(ent.system, `${k}.maneuverability`) === undefined) {\n      updateData[`system.${k}.maneuverability`] = \"average\";\n    }\n  }\n\n  // Remove bad fly maneuverability entry if it exists\n  if (ent.system.attributes?.speed?.flyManeuverability !== undefined) {\n    updateData[\"system.attributes.speed.-=flyManeuverability\"] = null;\n  }\n}\n\nfunction _migrateActorSpellbookSlots(ent, updateData) {\n  for (const spellbookSlot of Object.keys(\n    foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {}\n  )) {\n    if (\n      foundry.utils.getProperty(ent.system, `attributes.spells.spellbooks.${spellbookSlot}.autoSpellLevels`) == null\n    ) {\n      updateData[`system.attributes.spells.spellbooks.${spellbookSlot}.autoSpellLevels`] = true;\n    }\n\n    for (let a = 0; a < 10; a++) {\n      const baseKey = `system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.base`;\n      const maxKey = `system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.max`;\n      const base = foundry.utils.getProperty(ent, baseKey);\n      const max = foundry.utils.getProperty(ent, maxKey);\n\n      if (base === undefined) {\n        if (typeof max === \"number\" && max > 0) {\n          updateData[baseKey] = max.toString();\n        }\n      } else {\n        const newBase = parseInt(base);\n        if (newBase > 0) {\n          if (newBase !== base) updateData[baseKey] = newBase;\n        } else {\n          // Remove pointless default value not present in new actors either\n          updateData[`system.attributes.spells.spellbooks.${spellbookSlot}.spells.spell${a}.-=base`] = null;\n        }\n      }\n    }\n  }\n}\n\n// Remove inconsistently used .spontaneous permanently recorded boolean\n// Added with PF1 v10\nfunction _migrateActorSpellbookPrep(actorData, updateData) {\n  for (const [bookId, book] of Object.entries(\n    foundry.utils.getProperty(actorData.system, \"attributes.spells.spellbooks\") || {}\n  )) {\n    const wasSpontaneous = book.spontaneous;\n    if (wasSpontaneous === undefined) continue;\n\n    const usesAuto = book.autoSpellLevelCalculation ?? false;\n    const usesSpellpoints = book.spellPoints.useSystem === true;\n    if (!usesAuto && !usesSpellpoints) {\n      // Set prep type to match old spontaneous toggle\n      updateData[`system.attributes.spells.spellbooks.${bookId}.spellPreparationMode`] = wasSpontaneous\n        ? \"spontaneous\"\n        : \"prepared\";\n\n      // Set progression type to high to match old behaviour\n      updateData[`system.attributes.spells.spellbooks.${bookId}.casterType`] = \"high\";\n    }\n\n    updateData[`system.attributes.spells.spellbooks.${bookId}.-=spontaneous`] = null;\n  }\n}\n\n/**\n * Migrate spellbook kind (arcane, divine, psychic, ...)\n *\n * @param {object} actorData - Actor data\n * @param {object} updateData - Update data\n * @param {Actor} actor - Actor document\n */\nfunction _migrateActorSpellbookKind(actorData, updateData, actor) {\n  for (const [bookId, book] of Object.entries(\n    foundry.utils.getProperty(actorData.system, \"attributes.spells.spellbooks\") || {}\n  )) {\n    if (book.kind === undefined && book.inUse) {\n      // Attempt to get data from class\n      const castingClass =\n        !!book.class && book.class !== \"_hd\" ? actor.itemTypes.class.find((i) => i.system.tag === book.class) : null;\n      let kind = castingClass?.system.casting?.spells;\n\n      if (!kind) {\n        // Attempt to determine kind without access to source class\n        kind = \"arcane\"; // Default to arcane if all else fails\n        if (book.arcaneSpellFailure) kind = \"arcane\";\n        else if (book.psychic) kind = \"psychic\";\n        else if (book.spellPreparationMode === \"prepared\" && book.ability === \"int\") kind = \"alchemy\";\n        else if (book.class !== \"_hd\") kind = \"divine\";\n      }\n\n      updateData[`system.attributes.spells.spellbooks.${bookId}.kind`] = kind;\n    }\n  }\n}\n\nfunction _migrateActorBaseStats(actorData, updateData) {\n  const deleteEntries = {\n    \"system.attributes.hd.base\": \"system.attributes.hd.-=base\",\n    \"system.attributes.savingThrows.fort.value\": \"system.attributes.savingThrows.fort.-=value\",\n    \"system.attributes.savingThrows.ref.value\": \"system.attributes.savingThrows.ref.-=value\",\n    \"system.attributes.savingThrows.will.value\": \"system.attributes.savingThrows.will.-=value\",\n  };\n\n  for (const [path, dPath] of Object.entries(deleteEntries)) {\n    if (foundry.utils.getProperty(actorData, path) !== undefined) {\n      updateData[dPath] = null;\n    }\n  }\n\n  // Delete HP base if it's not non-zero or actor has any classes\n  if (actorData.system.attributes?.hp?.base !== undefined) {\n    if (!(actorData.system.attributes?.hp?.base > 0) || actorData.items.some((i) => i.type === \"class\")) {\n      updateData[\"system.attributes.hp.-=base\"] = null;\n    }\n  }\n\n  // Delete MP base if it's not non-zero or actor has any classes\n  if (actorData.system.attributes?.mp?.base !== undefined) {\n    if (!(actorData.system.attributes?.mp?.base > 0) || actorData.items.some((i) => i.type === \"class\")) {\n      updateData[\"system.attributes.mp.-=base\"] = null;\n    }\n  }\n}\n\nfunction _migrateUnusedActorCreatureType(ent, updateData) {\n  const type = foundry.utils.getProperty(ent.system, \"attributes.creatureType\");\n  if (type != undefined) updateData[\"system.attributes.-=creatureType\"] = null;\n}\n\nfunction _migrateActorSpellbookDCFormula(ent, updateData) {\n  const spellbooks = Object.keys(foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {});\n\n  for (const k of spellbooks) {\n    const key = `system.attributes.spells.spellbooks.${k}.baseDCFormula`;\n    const curFormula = foundry.utils.getProperty(ent, key);\n    if (!curFormula) updateData[key] = \"10 + @sl + @ablMod\";\n  }\n}\n\nfunction _migrateActorSpellbookName(ent, updateData) {\n  const spellbooks = Object.entries(foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {});\n  for (const [bookId, book] of spellbooks) {\n    if (book.altName !== undefined) {\n      const key = `system.attributes.spells.spellbooks.${bookId}`;\n      updateData[`${key}.-=altName`] = null;\n      if (book.altName.length) updateData[`${key}.name`] = book.altName;\n    }\n  }\n}\n\nfunction _migrateActorSpellbookCL(ent, updateData) {\n  const spellbooks = Object.keys(foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {});\n\n  for (const k of spellbooks) {\n    const key = `system.attributes.spells.spellbooks.${k}.cl`;\n    const curBase = parseInt(foundry.utils.getProperty(ent, key + \".base\"));\n    const curFormula = foundry.utils.getProperty(ent, key + \".formula\");\n    if (curBase > 0) {\n      if (curFormula.length > 0) updateData[`${key}.formula`] = curFormula + \" + \" + curBase;\n      else updateData[`${key}.formula`] = curFormula + curBase;\n      updateData[`${key}.base`] = 0;\n    }\n  }\n}\n\nfunction _migrateActorConcentration(ent, updateData) {\n  const spellbooks = Object.keys(foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {});\n  for (const k of spellbooks) {\n    // Delete unused .concentration from old actors\n    const key = `system.attributes.spells.spellbooks.${k}`;\n    const oldValue = foundry.utils.getProperty(ent, `${key}.concentration`);\n    const isString = typeof oldValue === \"string\";\n    if (Number.isFinite(oldValue) || isString) updateData[`${key}.-=concentration`] = null;\n    if (isString) {\n      // Assume erroneous bonus formula location and combine it with existing bonus formula.\n      const formulaKey = `${key}.concentrationFormula`;\n      const formula = [oldValue];\n      formula.push(foundry.utils.getProperty(ent, formulaKey) || \"\");\n      updateData[formulaKey] = formula.filter((f) => f !== 0 && f?.toString().trim().length).join(\" + \");\n    }\n  }\n}\n\nfunction _migrateActorHPAbility(ent, updateData) {\n  // Set HP ability\n  if (foundry.utils.getProperty(ent.system, \"attributes.hpAbility\") === undefined) {\n    updateData[\"system.attributes.hpAbility\"] = \"con\";\n  }\n\n  // Set Fortitude save ability\n  if (foundry.utils.getProperty(ent.system, \"attributes.savingThrows.fort.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.fort.ability\"] = \"con\";\n  }\n\n  // Set Reflex save ability\n  if (foundry.utils.getProperty(ent.system, \"attributes.savingThrows.ref.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.ref.ability\"] = \"dex\";\n  }\n\n  // Set Will save ability\n  if (foundry.utils.getProperty(ent.system, \"attributes.savingThrows.will.ability\") === undefined) {\n    updateData[\"system.attributes.savingThrows.will.ability\"] = \"wis\";\n  }\n}\n\nfunction _migrateItemArrayTypes(ent, updateData) {\n  const conditionals = ent.system.conditionals;\n  if (conditionals != null && !(conditionals instanceof Array)) {\n    updateData[\"system.conditionals\"] = [];\n  }\n\n  const contextNotes = ent.system.contextNotes;\n  if (contextNotes != null && !(contextNotes instanceof Array)) {\n    if (contextNotes instanceof Object) updateData[\"system.contextNotes\"] = Object.values(contextNotes);\n    else updateData[\"system.contextNotes\"] = [];\n  }\n}\n\nfunction _migrateWeaponImprovised(ent, updateData) {\n  if (ent.type !== \"weapon\") return;\n\n  const value = foundry.utils.getProperty(ent.system, \"weaponType\");\n  if (value === \"improv\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.properties.imp\"] = true;\n  }\n}\n\n// Migrates the weird .shortDescription back to .description.value\n// Added with PF1 v10\nfunction _migrateItemSpellDescription(itemData, updateData) {\n  if (itemData.type !== \"spell\") return;\n\n  if (itemData.system.shortDescription) {\n    updateData[\"system.-=shortDescription\"] = null;\n\n    // If description.value exists, it's the older oversized pre-rendered version that is unwanted\n    updateData[\"system.description.value\"] = itemData.system.shortDescription;\n  }\n}\n\nfunction _migrateSpellDivineFocus(item, updateData) {\n  if (item.type !== \"spell\") return;\n\n  const df = foundry.utils.getProperty(item.system, \"components.divineFocus\");\n  if (typeof df === \"boolean\") updateData[\"system.components.divineFocus\"] = Number(df);\n}\n\nfunction _migrateClassDynamics(ent, updateData) {\n  if (ent.type !== \"class\") return;\n\n  const bab = ent.system.bab;\n  if (typeof bab === \"number\") updateData[\"system.bab\"] = \"low\";\n\n  const stKeys = [\"system.savingThrows.fort.value\", \"system.savingThrows.ref.value\", \"system.savingThrows.will.value\"];\n  for (const key of stKeys) {\n    const value = foundry.utils.getProperty(ent, key);\n    if (typeof value === \"number\") updateData[key] = \"low\";\n  }\n}\n\nfunction _migrateClassType(ent, updateData) {\n  if (ent.type !== \"class\") return;\n\n  if (ent.system.classType !== undefined && ent.system.subType === undefined) {\n    updateData[\"system.subType\"] = \"base\";\n  }\n}\n\n// Added with PF1 v10\nfunction _migrateClassCasting(itemData, updateData) {\n  const casting = itemData.system?.casting;\n  if (!casting) return;\n\n  if (!casting.type) {\n    updateData[\"system.-=casting\"] = null;\n    return;\n  }\n\n  // domainSlots -> domain\n  if (casting.domainSlots !== undefined) {\n    updateData[\"system.casting.domain\"] = casting.domain ?? casting.domainSlots ?? 1;\n    updateData[\"system.casting.-=domainSlots\"] = null;\n  }\n}\n\nfunction _migrateWeaponCategories(ent, updateData) {\n  if (ent.type !== \"weapon\") return;\n\n  // Change category\n  const type = ent.system.weaponType;\n  if (type === \"misc\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.weaponSubtype\"] = \"other\";\n  } else if (type === \"splash\") {\n    updateData[\"system.weaponType\"] = \"misc\";\n    updateData[\"system.weaponSubtype\"] = \"splash\";\n  }\n\n  const changeProp = [\"simple\", \"martial\", \"exotic\", \"chef\", \"power\"].includes(type);\n  if (changeProp && ent.system.weaponSubtype == null) {\n    updateData[\"system.weaponSubtype\"] = \"1h\";\n  }\n\n  // Change light property\n  const lgt = foundry.utils.getProperty(ent.system, \"properties.lgt\");\n  if (lgt != null) {\n    updateData[\"system.properties.-=lgt\"] = null;\n    if (lgt === true && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"light\";\n    }\n  }\n\n  // Change two-handed property\n  const two = foundry.utils.getProperty(ent.system, \"properties.two\");\n  if (two != null) {\n    updateData[\"system.properties.-=two\"] = null;\n    if (two === true && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"2h\";\n    }\n  }\n\n  // Change melee property\n  const melee = foundry.utils.getProperty(ent.system, \"weaponData.isMelee\");\n  if (melee != null) {\n    updateData[\"system.weaponData.-=isMelee\"] = null;\n    if (melee === false && changeProp) {\n      updateData[\"system.weaponSubtype\"] = \"ranged\";\n    }\n  }\n}\n\nfunction _migrateArmorCategories(ent, updateData) {\n  if (ent.type !== \"equipment\") return;\n\n  const oldType = foundry.utils.getProperty(ent.system, \"armor.type\");\n  if (oldType == null) return;\n\n  if (oldType === \"clothing\") {\n    updateData[\"system.equipmentType\"] = \"misc\";\n    updateData[\"system.equipmentSubtype\"] = \"clothing\";\n  } else if (oldType === \"shield\") {\n    updateData[\"system.equipmentType\"] = \"shield\";\n    updateData[\"system.equipmentSubtype\"] = \"lightShield\";\n  } else if (oldType === \"misc\") {\n    updateData[\"system.equipmentType\"] = \"misc\";\n    updateData[\"system.equipmentSubtype\"] = \"wondrous\";\n  } else if ([\"light\", \"medium\", \"heavy\"].includes(oldType)) {\n    updateData[\"system.equipmentType\"] = \"armor\";\n    updateData[\"system.equipmentSubtype\"] = `${oldType}Armor`;\n  }\n\n  updateData[\"system.armor.-=type\"] = null;\n}\n\n/**\n * Convert string armor max dex to number.\n *\n * Introduced with PF1 v10\n *\n * @param item\n * @param updateData\n */\nfunction _migrateArmorMaxDex(item, updateData) {\n  if (item.type !== \"equipment\") return;\n\n  let maxDex = item.system.armor?.dex;\n  // Skip valid states\n  if (maxDex === undefined || maxDex === null) return;\n  if (typeof maxDex === \"number\") return;\n\n  // Convert string to number\n  maxDex = parseInt(maxDex);\n  if (Number.isInteger(maxDex)) {\n    updateData[\"system.armor.dex\"] = maxDex;\n  }\n  // Assume corrupt value otherwise\n  else {\n    updateData[\"system.armor.-=dex\"] = null;\n  }\n}\n\nfunction _migrateEquipmentCategories(item, updateData) {\n  if (item.type !== \"equipment\") return;\n\n  const subtype = updateData[\"system.subType\"] ?? item.system.subType;\n  if (subtype !== \"misc\") return;\n\n  switch (item.system.equipmentSubtype) {\n    case \"wondrous\":\n      updateData[\"system.subType\"] = \"wondrous\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n    case \"clothing\":\n      updateData[\"system.subType\"] = \"clothing\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n    case \"other\":\n      updateData[\"system.subType\"] = \"other\";\n      updateData[\"system.-=equipmentSubtype\"] = null;\n      break;\n  }\n}\n\nfunction _migrateSpellDescriptors(item, updateData) {\n  if (item.type !== \"spell\" || item.system.types === undefined) return;\n\n  const current = item.system.types\n    .split(\",\")\n    .flatMap((x) => x.split(\";\"))\n    .filter((x) => x)\n    .map((x) => x.trim());\n\n  const value = [];\n  const custom = [];\n  const entries = Object.entries(ffd20.config.spellDescriptors);\n  current.forEach((c) => {\n    const exists = entries.find(([k, v]) => c.toLowerCase() === k.toLowerCase() || c.toLowerCase() === v.toLowerCase());\n    if (exists) {\n      value.push(exists[0]);\n    } else {\n      custom.push(c);\n    }\n  });\n\n  updateData[\"system.-=types\"] = null;\n  updateData[\"system.descriptors.value\"] = value;\n  updateData[\"system.descriptors.custom\"] = custom.join(\"; \");\n}\n\n// TODO FFD20\nfunction _migrateSpellMultischool(item, updateData) {\n  if (item.type !== \"spell\" || item.system.multischool === undefined || typeof item.system.multischool !== \"string\") return;\n\n  // Split current custom string into options\n  const customMultischools = item.system.multischool\n    .split(\",\")\n    .flatMap((x) => x.split(\";\"))\n    .map((x) => x.trim())\n    .filter((x) => x);\n\n  // Attempt to parse custom entries\n  const values = [];\n  const entries = Object.entries(ffd20.config.spellMultischools);\n  ssLoop: for (const multischool of customMultischools) {\n    for (const [ssId, ssLabel] of entries) {\n      if (multischool in ffd20.config.spellMultischools) {\n        values.push(ssId);\n        continue ssLoop;\n      }\n      const re = new RegExp(ssLabel, \"i\");\n      if (re.test(multischool)) {\n        values.push(ssId);\n        continue ssLoop;\n      }\n    }\n    values.push(multischool);\n  }\n\n  updateData[\"system.multischool\"] = values;\n  if(item.system.multi){\n    updateData[\"system.school\"] = \"multi\";\n  }\n  updateData[\"system.-=multi\"] = null;\n\n}\n\nfunction _migrateSpellSubschool(item, updateData) {\n  if (item.type !== \"spell\" || item.system.subschool === undefined || typeof item.system.subschool !== \"string\") return;\n\n  // Split current custom string into options\n  const customSubschools = item.system.subschool\n    .split(\",\")\n    .flatMap((x) => x.split(\";\"))\n    .map((x) => x.trim())\n    .filter((x) => x);\n\n  // Attempt to parse custom entries\n  const values = [];\n  const entries = Object.entries(ffd20.config.spellSubschools);\n  ssLoop: for (const subschool of customSubschools) {\n    for (const [ssId, ssLabel] of entries) {\n      if (subschool in ffd20.config.spellSubschools) {\n        values.push(ssId);\n        continue ssLoop;\n      }\n      const re = new RegExp(ssLabel, \"i\");\n      if (re.test(subschool)) {\n        values.push(ssId);\n        continue ssLoop;\n      }\n    }\n    values.push(subschool);\n  }\n\n  updateData[\"system.subschool\"] = values;\n}\n\nfunction _migrateItemDefaultAmmo(itemData, updateData) {\n  const ammoId = itemData.flags?.ffd20?.defaultAmmo;\n  if (!ammoId) return;\n  if (!itemData.system?.ammo?.default) {\n    updateData[\"system.ammo.default\"] = ammoId;\n  }\n  updateData[\"flags.ffd20.-=defaultAmmo\"] = null;\n}\n\nfunction _migrateRaceItemCreatureType(itemData, updateData) {\n  if (itemData.type !== \"race\") return;\n\n  if (itemData.system.creatureType) {\n    if (!itemData.system.creatureTypes?.length) updateData[\"system.creatureTypes\"] = [itemData.system.creatureType];\n    updateData[\"system.-=creatureType\"] = null;\n  }\n\n  if (Array.isArray(itemData.system.subTypes)) {\n    const subtypes = [];\n    const oldTypes = itemData.system.subTypes.flat();\n    for (const subtype of oldTypes) {\n      if (!subtype) continue; // Should not happen\n      const lowerCaseKey = subtype.charAt(0).toLowerCase() + subtype.slice(1).replace(\" \", \"\");\n      if (lowerCaseKey in ffd20.config.creatureSubtypes) {\n        subtypes.push(lowerCaseKey);\n      } else {\n        subtypes.push(subtype);\n      }\n    }\n    if (!itemData.system.creatureSubtypes?.length) updateData[\"system.creatureSubtypes\"] = subtypes;\n    updateData[\"system.-=subTypes\"] = null;\n  }\n}\n\nfunction _migrateItemDurability(itemData, updateData) {\n  const isPhysical = CONFIG.Item.documentClasses[itemData.type]?.isPhysical;\n  if (!isPhysical) return;\n\n  const max = itemData.system?.hp?.max;\n  if (max !== undefined) {\n    if (itemData.system?.hp?.base === undefined) {\n      updateData[\"system.hp.base\"] = Number(max ?? 10);\n    }\n    updateData[\"system.hp.-=max\"] = null;\n  }\n  const value = itemData.system?.hp?.value;\n  if (value !== undefined) {\n    if (itemData.system?.hp?.offset === undefined) {\n      // Attempt to provide offset from old data\n      updateData[\"system.hp.offset\"] = max > 0 ? value - max : 0;\n    }\n    updateData[\"system.hp.-=value\"] = null;\n  }\n}\n\nfunction _migrateItemSize(ent, updateData) {\n  // Convert custom sizing in weapons\n  if (ent.type === \"weapon\") {\n    const wdSize = foundry.utils.getProperty(ent.system, \"weaponData.size\");\n    if (wdSize) {\n      // Move old\n      updateData[\"system.size\"] = wdSize;\n      updateData[\"system.weaponData.-=size\"] = null;\n      return;\n    }\n  }\n\n  const oldSize = ent.system.size;\n  if ([\"spell\", \"class\", \"buff\", \"feat\"].includes(ent.type)) {\n    // Remove size from abstract items\n    if (oldSize !== undefined) {\n      updateData[\"system.-=size\"] = null;\n    }\n  } else {\n    // Add default size to everything else if not present\n    if (oldSize === undefined) {\n      updateData[\"system.size\"] = \"med\";\n    }\n  }\n}\n\nfunction _migrateItemFeatAbilityTypes(itemData, updateData) {\n  if (itemData.type !== \"feat\") return;\n\n  const type = itemData.system.abilityType;\n  // Convert \"none\" and other invalid values (e.g. null or \"n/a\") to \"na\"\n  // Added with PF1 v10\n  if (ffd20.config.abilityTypes[type] === undefined) {\n    updateData[\"system.abilityType\"] = \"na\";\n  }\n}\n\nfunction _migrateClassLevels(ent, updateData) {\n  const level = ent.system.levels;\n  if (typeof level === \"number\" && ent.system.level == null) {\n    updateData[\"system.level\"] = level;\n    updateData[\"system.-=levels\"] = null;\n  }\n}\n\nfunction _migrateSavingThrowTypes(ent, updateData) {\n  if (\n    foundry.utils.getProperty(ent.system, \"save.type\") == null &&\n    typeof foundry.utils.getProperty(ent.system, \"save.description\") === \"string\"\n  ) {\n    const desc = foundry.utils.getProperty(ent.system, \"save.description\");\n    if (desc.match(/REF/i)) updateData[\"system.save.type\"] = \"ref\";\n    else if (desc.match(/FORT/i)) updateData[\"system.save.type\"] = \"fort\";\n    else if (desc.match(/WILL/i)) updateData[\"system.save.type\"] = \"will\";\n  }\n}\n\nfunction _migrateCR(ent, updateData) {\n  // Migrate CR offset\n  const crOffset = ent.system.crOffset;\n  if (typeof crOffset === \"number\") {\n    updateData[\"system.crOffset\"] = crOffset.toString();\n  }\n}\n\nfunction _migrateItemChanges(itemData, updateData) {\n  // Migrate changes\n  const changes = itemData.system.changes;\n  if (Array.isArray(changes)) {\n    const newChanges = [];\n    for (const c of changes) {\n      let cd;\n      if (Array.isArray(c)) {\n        cd = {\n          formula: c[0],\n          target: c[1],\n          subTarget: c[2],\n          type: c[3],\n        };\n      } else {\n        cd = foundry.utils.deepClone(c); // Avoid mutating source data so diff works properly\n      }\n      // Value should not exist, yet it was added previously by using derived data for updates.\n      delete cd.value;\n\n      newChanges.push(new ffd20.components.ItemChange(cd).toObject());\n    }\n\n    // Alter the changes list, but only if changes actually occurred. Bidirectional to detect deletions.\n    if (\n      !foundry.utils.isEmpty(foundry.utils.diffObject(changes, newChanges)) ||\n      !foundry.utils.isEmpty(foundry.utils.diffObject(newChanges, changes))\n    ) {\n      updateData[\"system.changes\"] = newChanges;\n    }\n  }\n\n  const oldChanges = updateData[\"system.changes\"] ?? itemData.system?.changes ?? [];\n  const newChanges = [];\n  let updateChanges = false;\n  for (const change of oldChanges) {\n    const cd = new ffd20.components.ItemChange(foundry.utils.deepClone(change)).toObject(true, true);\n    const diff = foundry.utils.diffObject(change, cd);\n    if (!foundry.utils.isEmpty(diff)) {\n      updateChanges = true;\n    }\n\n    // Replace targets with .subSkills. for ones without\n    // @since PF1 v10\n    if (/\\.subSkills\\./.test(cd.target)) {\n      cd.target = cd.target.replace(\".subSkills.\", \".\");\n      updateChanges = true;\n    }\n    // Remove use of penalty bonus type\n    // @since PF1 v10\n    if (cd.type === \"penalty\") {\n      // Convert the special ability score case to specific target\n      if ([\"str\", \"dex\", \"con\", \"int\", \"wis\", \"cha\"].includes(cd.target)) {\n        cd.target = `${cd.target}Pen`;\n      }\n      // Convert all to untyped changes\n      cd.type = \"untyped\";\n      updateChanges = true;\n    }\n    newChanges.push(cd);\n  }\n  if (updateChanges) {\n    updateData[\"system.changes\"] = newChanges;\n  }\n}\n\nfunction _migrateItemContextNotes(itemData, updateData) {\n  // Migrate context notes\n  const oldNotes = itemData.system.contextNotes;\n  if (Array.isArray(oldNotes) && oldNotes?.length > 0) {\n    const newNotes = [];\n\n    for (const oldNote of oldNotes) {\n      let newNote = foundry.utils.deepClone(oldNote);\n\n      // Transform old tuple.\n      if (Array.isArray(oldNote)) {\n        newNote = { text: oldNote[0], target: oldNote[1], subTarget: oldNote[2] };\n      }\n\n      newNote = new ffd20.components.ContextNote(newNote).toObject();\n\n      newNotes.push(newNote);\n    }\n\n    // Alter the context note list, but only if changes actually occurred. Bidirectional to detect deletions.\n    if (\n      !foundry.utils.isEmpty(foundry.utils.diffObject(oldNotes, newNotes)) ||\n      !foundry.utils.isEmpty(foundry.utils.diffObject(newNotes, oldNotes))\n    ) {\n      updateData[\"system.contextNotes\"] = newNotes;\n    }\n  }\n\n  const notes = updateData[\"system.contextNotes\"] ?? oldNotes ?? [];\n  let updateNotes = false;\n  const newNotes = [];\n  for (const note of notes) {\n    const newNote = { ...note };\n    // Replace targets with .subSkills. for ones without\n    // @since PF1 v10\n    if (/^skill\\..+\\.subSkills\\..+$/.test(note.target)) {\n      newNote.target = note.target.replace(\".subSkills.\", \".\");\n      updateNotes = true;\n    }\n    newNotes.push(newNote);\n  }\n  if (updateNotes) {\n    updateData[\"system.contextNotes\"] = newNotes;\n  }\n}\n\nfunction _migrateItemChangeFlags(item, updateData) {\n  const flags = item.system?.changeFlags;\n  if (!flags) return;\n\n  // Dwarf-like encumbrance to distinct no medium/heavy encumbrance\n  if (flags.noEncumbrance !== undefined) {\n    if (flags.noEncumbrance === true) {\n      updateData[\"system.changeFlags.noMediumEncumbrance\"] = true;\n      updateData[\"system.changeFlags.noHeavyEncumbrance\"] = true;\n    }\n    updateData[\"system.changeFlags.-=noEncumbrance\"] = null;\n  }\n}\n\nfunction _migrateEquipmentSize(ent, updateData) {\n  if (ent.type !== \"equipment\") return;\n\n  const size = ent.system.size;\n  if (!size) {\n    updateData[\"system.size\"] = \"med\";\n  }\n}\n\n// Migrate .weight number to .weight.value\n// Migrate .baseWeight that was briefly introduced in 0.81\nfunction _migrateItemWeight(ent, updateData) {\n  const baseWeight = ent.system.baseWeight,\n    weight = ent.system.weight;\n\n  // Skip items of inappropriate type\n  const isPhysical = CONFIG.Item.documentClasses[ent.type]?.isPhysical;\n  if (!isPhysical) {\n    if (weight !== undefined) {\n      // Ensure inappropriate items don't have spurious weight, which breaks data prep\n      updateData[\"system.-=weight\"] = null;\n    }\n    return;\n  }\n\n  if (Number.isFinite(weight)) {\n    updateData[\"system.weight.value\"] = weight;\n  } else if (weight == null || typeof weight !== \"object\") {\n    // Convert any other values to just 0 weight, e.g. null\n    updateData[\"system.weight.value\"] = 0;\n  }\n\n  // If baseWeight exists and looks reasonable, use it for base weight instead\n  if (baseWeight !== undefined) {\n    if (Number.isFinite(baseWeight) && baseWeight > 0) {\n      updateData[\"system.weight.value\"] = baseWeight;\n    }\n    updateData[\"system.-=baseWeight\"] = null;\n  }\n}\n\nfunction _migrateItemHealth(item, updateData) {\n  const isPhysical = CONFIG.Item.documentClasses[item.type]?.isPhysical;\n\n  const hp = item.system.hp;\n  if (isPhysical) {\n    if (hp) {\n      // Fix invalid data type\n      if (typeof hp.max === \"string\") updateData[\"system.hp.max\"] = parseInt(hp.max);\n      if (typeof hp.value === \"string\") updateData[\"system.hp.value\"] = parseInt(hp.value);\n    } else {\n      // Restore missing HP data\n      updateData[\"system.hp.value\"] = 10;\n      updateData[\"system.hp.max\"] = 10;\n    }\n  } else if (item.type !== \"class\" && hp !== undefined) {\n    updateData[\"system.-=hp\"] = null;\n  }\n}\n\nfunction _migrateSpellCosts(ent, updateData) {\n  if (ent.type !== \"spell\") return;\n\n  const spellPointCost = foundry.utils.getProperty(ent.system, \"spellPoints.cost\");\n  if (spellPointCost == null) {\n    updateData[\"system.spellPoints.cost\"] = \"@sl\";\n  }\n\n  const slotCost = ent.system.slotCost;\n  if (slotCost == null) {\n    updateData[\"system.slotCost\"] = 1;\n  }\n\n  const autoDeduct = ent.system.preparation?.autoDeductCharges;\n  if (autoDeduct !== undefined) {\n    if (autoDeduct === false) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n    updateData[\"system.preparation.-=autoDeductCharges\"] = null;\n  }\n}\n\n/**\n * Migrate spell preparation\n *\n * Added with PF1 v10\n *\n * @param {object} itemData\n * @param {object} updateData\n * @param {object} context\n * @param {Item} [context.item=null]\n */\nfunction _migrateSpellPreparation(itemData, updateData, { item = null } = {}) {\n  if (itemData.type !== \"spell\") return;\n\n  const spellbook = item?.spellbook;\n  const prepMode = spellbook?.spellPreparationMode || \"prepared\";\n  const usesSpellPoints = spellbook?.spellPoints?.useSystem ?? false;\n  const isPrepared = usesSpellPoints ? false : prepMode === \"prepared\";\n\n  const prep = itemData.system.preparation ?? {};\n  if (prep.maxAmount !== undefined) {\n    if (!(prep.max > 0)) {\n      // Migrate even older non number max amount\n      if (typeof prep.maxAmount !== \"number\") prep.maxAmount = 0;\n      updateData[\"system.preparation.max\"] = prep.maxAmount ?? 0;\n    }\n    updateData[\"system.preparation.-=maxAmount\"] = null;\n  }\n  if (prep.spontaneousPrepared !== undefined) {\n    if (!(prep.value > 0) && !isPrepared) {\n      updateData[\"system.preparation.value\"] = prep.spontaneousPrepared ? 1 : 0;\n    }\n    updateData[\"system.preparation.-=spontaneousPrepared\"] = null;\n  }\n  if (prep.preparedAmount !== undefined) {\n    if (!(prep.value > 0) && isPrepared) {\n      updateData[\"system.preparation.value\"] = Math.max(\n        prep.preparedAmount,\n        updateData[\"system.preparation.value\"] || 0\n      );\n    }\n    updateData[\"system.preparation.-=preparedAmount\"] = null;\n  }\n}\n\nfunction _migrateLootEquip(ent, updateData) {\n  if (ent.type === \"loot\" && typeof ent.system.equipped !== \"boolean\") {\n    updateData[\"system.equipped\"] = false;\n  }\n}\n\nconst _migrateItemLinks = async function (itemData, updateData, { item, actor }) {\n  const linkData = itemData.system.links ?? {};\n  for (const [linkType, oldLinks] of Object.entries(linkData)) {\n    let updated = false;\n    const links = foundry.utils.deepClone(oldLinks);\n    for (const link of links) {\n      const type = link.dataType;\n      if (type !== undefined) {\n        if (type === \"data\") {\n          delete link.dataType;\n        } else if (type === \"world\") {\n          // Reconstruct world item UUID\n          link.uuid = link.id.replace(/^world\\./, \"Item.\");\n          delete link.id;\n          delete link.dataType;\n        } else if (type === \"compendium\") {\n          // Reconstruct compendium UUID\n          link.uuid = `Compendium.${link.id}`;\n          delete link.id;\n          delete link.dataType;\n        }\n        delete link.img;\n        updated = true;\n      }\n\n      // Convert ID to relative UUID\n      if (link.id !== undefined && actor) {\n        link.uuid = actor.items?.get(link.id)?.getRelativeUUID(actor);\n        if (link.uuid) {\n          delete link.id;\n          updated = true;\n        }\n      }\n\n      if (actor && link.uuid) {\n        let linked = await fromUuid(link.uuid, { relative: actor });\n        // Attempt to recover bad links to other actors\n        if (linked?.actor) {\n          // Attempt to adjust owned item\n          if (linked.actor !== actor) linked = actor.items.get(linked.id);\n          const newLink = linked?.getRelativeUUID(actor);\n          // Successful recovery?\n          if (linked && newLink !== link.uuid) {\n            link.uuid = newLink;\n            updated = true;\n          }\n        }\n      }\n\n      // Transform non-relative UUIDs to new format\n      if (link.uuid?.[0] !== \".\" && link.uuid) {\n        const uuid = ffd20.utils.internal.uniformUuid(link.uuid, actor);\n        if (link.uuid !== uuid) {\n          link.uuid = uuid;\n          updated = true;\n        }\n      }\n\n      // Handle moved compendium content\n      if (link.uuid) {\n        const movedUuid = moved[link.uuid];\n        if (movedUuid) {\n          link.uuid = movedUuid;\n          updated = true;\n        }\n      }\n\n      // Remove unused data\n      if (link._index !== undefined || link.hiddenLinks !== undefined) {\n        delete link._index;\n        delete link.hiddenLinks;\n        updated = true;\n      }\n\n      // Clear out invalid links with just a name or no info at all\n      const keys = Object.keys(link);\n      if (keys.length < 1 || (keys.length === 1 && keys.includes(\"name\"))) {\n        link._delete = true;\n        updated = true;\n      }\n    }\n\n    if (updated) {\n      updateData[`system.links.${linkType}`] = links.filter((i) => i._delete !== true);\n    }\n  }\n};\n\nfunction _migrateItemProficiencies(item, updateData) {\n  // Added with PF1 v10\n  // Migrate sim/mar to simple/martial\n  const wprofmap = {\n    sim: \"simple\",\n    mar: \"martial\",\n  };\n\n  const oldKeys = Object.keys(wprofmap);\n  if (item.system.weaponProf?.value?.some((p) => oldKeys.includes(p))) {\n    const nwprof = item.system.weaponProf.value.map((p) => wprofmap[p] || p);\n    updateData[\"system.weaponProf.value\"] = nwprof;\n  }\n}\n\nfunction _migrateItemNotes(ent, updateData) {\n  const list = [\"system.attackNotes\", \"system.effectNotes\"];\n  for (const k of list) {\n    const value = foundry.utils.getProperty(ent, k);\n    const hasValue = foundry.utils.hasProperty(ent, k);\n    if (hasValue && !(value instanceof Array)) {\n      updateData[k] = [];\n      if (typeof value === \"string\" && value.length > 0) {\n        updateData[k] = value.trim().split(/[\\n\\r]/);\n      }\n    }\n  }\n}\n\nfunction _migrateItemActionToActions(itemData, updateData, { actor, item }) {\n  const hasOldAction =\n    !!itemData.system.actionType || !!itemData.system.activation?.type || !!itemData.system.measureTemplate;\n\n  // Cleanup old data\n  if (itemData.system.actionType !== undefined) updateData[\"system.-=actionType\"] = null;\n  if (itemData.system.activation !== undefined) updateData[\"system.-=activation\"] = null;\n  if (itemData.system.measureTemplate !== undefined) updateData[\"system.-=measureTemplate\"] = null;\n\n  // Already has actions\n  if (itemData.system.actions?.length) return;\n\n  // Proceed with old action cleanup\n\n  // The following is very blunt force migration that includes lots of bad data that shouldn't be incldued\n  if (!hasOldAction) return;\n\n  // Transfer data to an action\n  const actionData = {};\n  for (const k of Object.keys(itemData.system)) {\n    actionData[k] = itemData.system[k];\n  }\n\n  // Transfer name and image\n  if ([\"weapon\", \"attack\"].includes(itemData.type)) {\n    actionData.name = game.i18n.localize(\"FFD20.Attack\");\n  } else {\n    actionData.name = game.i18n.localize(\"FFD20.Use\");\n  }\n\n  // Clear description\n  delete actionData.description;\n\n  // Add spell data\n  // Make sure it has an activation type\n  actionData.activation ??= {};\n  actionData.activation.type ||= \"standard\";\n  actionData.activation.unchained ??= {};\n  actionData.activation.unchained.type ||= \"action\";\n  actionData.activation.unchained.cost ??= 2;\n\n  if (itemData.type === \"spell\") {\n    // Transfer spell duration\n    actionData.duration ??= {};\n    actionData.duration.value = itemData.system.spellDuration;\n\n    // Transfer spell point cost\n    if (actor) {\n      const spellbookKey = itemData.system.spellbook;\n      const spellbook = actor.system.attributes?.spells?.spellbooks?.[spellbookKey];\n      if (spellbook.spellPoints?.useSystem) {\n        const oldSpellPointCostFormula = itemData.system.spellPoints?.cost;\n        if (oldSpellPointCostFormula) actionData.uses.autoDeductChargesCost = oldSpellPointCostFormula;\n      }\n    }\n  }\n\n  // Fix power attack multiplier being non-number\n  const paMult = actionData.powerAttack?.multiplier;\n  if (typeof paMult === \"string\") {\n    if (paMult === \"\") delete actionData.powerAttack.multiplier;\n    else actionData.powerAttack.multiplier = parseInt(paMult);\n  }\n\n  // Clean out old attack and effect notes\n  updateData[\"system.attackNotes\"] = [];\n  updateData[\"system.effectNotes\"] = [];\n\n  updateData[\"system.actions\"] = [new ffd20.components.ItemAction(actionData).toObject()];\n}\n\nfunction _migrateScriptCalls(item, updateData) {\n  if (!(item.system.scriptCalls?.length > 0)) return;\n  let updated = false;\n\n  // Clear out unused name and image for linked macros.\n  const scripts = foundry.utils.deepClone(item.system.scriptCalls);\n  for (const script of scripts) {\n    if (script.type == \"macro\") {\n      if (script.name || script.img) {\n        script.name = \"\";\n        script.img = \"\";\n        updated = true;\n      }\n    }\n  }\n\n  if (updated) {\n    updateData[\"system.scriptCalls\"] = scripts;\n  }\n}\n\n/**\n * Convert tuple learnedAt values into key:value pairs directly in the object.\n *\n * @param item\n * @param updateData\n */\nfunction _migrateItemLearnedAt(item, updateData) {\n  const learnedAt = item.system.learnedAt ?? {};\n  for (const [category, value] of Object.entries(learnedAt)) {\n    if (Array.isArray(value)) {\n      updateData[`system.learnedAt.${category}`] = value.reduce((learned, [classId, level]) => {\n        // Skip invalid entries\n        if (typeof classId !== \"string\" || classId.length == 0) return learned;\n        // Split combined entries and transform them to object format\n        for (let clsId of classId.split(\"/\")) {\n          clsId = clsId.trim().replace(\".\", \"-\"); // Sanitize\n          if (clsId) learned[clsId] = level;\n        }\n        return learned;\n      }, {});\n    }\n  }\n}\n\n/**\n * Migrate action..\n * - ... usesAmmo boolean away\n * - ... ammoType to item.system.ammo.type\n *\n * @param {object} action - Action data\n * @param {object} itemData - Parent item data\n * @param {object} updateData - Item update data\n */\nfunction _migrateActionAmmunitionUsage(action, itemData, updateData) {\n  if (action.usesAmmo === false) {\n    delete action.ammoType;\n  }\n  if (action.usesAmmo === true) {\n    if (!itemData.system.ammo?.type && !updateData[\"system.ammo.type\"]) {\n      updateData[\"system.ammo.type\"] = action.ammoType;\n      action.ammoType = \"\"; // Inherit from item\n    }\n\n    // Same as base item\n    if (itemData.system.ammo?.type == action.ammoType) delete action.ammoType;\n  }\n\n  // Migrate .ammoType to .ammo.type\n  if (action.ammoType) {\n    action.ammo ??= {};\n    action.ammo.type = action.ammoType;\n  }\n  delete action.ammoType;\n\n  // Delete empty ammo type (inherited)\n  if (action.ammo && !action.ammo.type) {\n    delete action.ammo.type;\n  }\n\n  // Uses ammo is no longer used\n  delete action.usesAmmo;\n}\n\n// Migrate harmless from save descriptor to the harmless toggle.\n// Added with PF1 v10\nfunction _migrateActionHarmlessSpell(action, itemData) {\n  if (!action.save?.description) return;\n\n  if (/\\bharmless\\b/.test(action.save.description)) {\n    action.save.description = action.save.description\n      .replace(/\\s*\\bharmless\\b\\s*/, \"\")\n      .replace(/\\(,\\s*/, \"(\")\n      .replace(/\\s*,\\)/, \")\")\n      .replace(\"()\", \"\")\n      .trim();\n    action.save.harmless = true;\n  }\n}\n\n// Action duration\n// Added with PF1 v10\nfunction _migrateActionDuration(action, itemData) {\n  action.duration ??= {};\n\n  // Something has caused \"null\" string durations for some people, this clears it.\n  if (action.duration.value === \"null\") action.duration.value = \"\";\n\n  // Swap units to \"special\" if undefined and formula exists\n  if (!action.duration.units && !!action.duration.value) {\n    action.duration.units = \"spec\";\n  }\n\n  // Swap \"instantaneous\" formula to instantaneous unit\n  if (action.duration.value === \"instantaneous\") {\n    delete action.duration.value;\n    action.duration.units = \"inst\";\n  }\n\n  // Convert easy special values to actual duration info\n  if (action.duration.units === \"spec\") {\n    const value = action.duration.value || \"\";\n\n    switch (value) {\n      case \"1 round\":\n      case \"1 full round\":\n        action.duration.value = \"1\";\n        action.duration.units = \"round\";\n        break;\n      case \"1 min.\":\n      case \"1 minute\":\n        action.duration.value = \"1\";\n        action.duration.units = \"minute\";\n        break;\n      case \"1 hour\":\n        action.duration.value = \"1\";\n        action.duration.units = \"hour\";\n        break;\n      case \"8 hours\":\n        action.duration.value = \"8\";\n        action.duration.units = \"hour\";\n        break;\n      case \"24 hours\":\n        action.duration.value = \"24\";\n        action.duration.units = \"hour\";\n        break;\n      case \"1 day\":\n        action.duration.value = \"1\";\n        action.duration.units = \"day\";\n        break;\n      case \"permanent\":\n        delete action.duration.value;\n        action.duration.units = \"perm\";\n        break;\n      case \"see below\":\n      case \"see text\":\n        delete action.duration.value;\n        action.duration.units = \"seeText\";\n        break;\n    }\n  }\n}\n\nfunction _migrateActionMaterials(action, itemData) {\n  let addons = action.material?.addon;\n  if (addons) {\n    // Since PF1 v10.5\n    if (addons.some((ma) => !!materialChanges[ma])) {\n      action.material.addon = action.material.addon.map((ma) => materialChanges[ma] || ma);\n      addons = action.material.addon; // Ensure following code gets updated addons\n    }\n\n    // Convert Throneglass into non-addon material\n    // Since PF1 v10.3\n    const tg = \"throneglass\";\n    if (addons.includes(tg)) {\n      action.material.addon = action.material.addon.filter((ma) => ma !== tg);\n      action.material.normal.value ||= tg;\n    }\n  }\n\n  // Since PF1 v10.5\n  const newMat = materialChanges[action.material?.normal?.value];\n  if (newMat) action.material.normal.value = newMat;\n}\n\n/**\n * Added with PF1 v10\n *\n * @param {object} action\n * @param {object} itemData\n */\nfunction _migrateActionExtraAttacks(action, itemData) {\n  // Convert tuples into objects\n  if (action.attackParts?.length) {\n    const parts = action.attackParts ?? [];\n    if (parts.some((p) => Array.isArray(p))) {\n      action.attackParts = parts.map((part) => (Array.isArray(part) ? { formula: part[0], name: part[1] } : part));\n    }\n\n    // Ensure formulas are strings\n    for (const part of action.attackParts) part.formula = `${part.formula}`;\n  }\n\n  // Unify extra attacks structure\n  action.extraAttacks ??= {};\n\n  if (action.attackParts !== undefined) {\n    action.extraAttacks.manual = action.attackParts ?? [];\n    delete action.attackParts;\n  }\n\n  if (action.formulaicAttacks !== undefined) {\n    action.extraAttacks.formula ??= {};\n    action.extraAttacks.formula.count = action.formulaicAttacks?.count?.formula || \"\";\n    action.extraAttacks.formula.bonus = action.formulaicAttacks?.bonus?.formula || \"\";\n    action.extraAttacks.formula.label = action.formulaicAttacks?.label || \"\";\n    delete action.formulaicAttacks;\n  }\n\n  if (!action.extraAttacks.type) {\n    // Convert existing formulas to standard options\n    if (\n      action.extraAttacks.formula?.count === \"min(3, ceil(@attributes.bab.total / 5) - 1)\" &&\n      action.extraAttacks.formula?.bonus === \"@formulaicAttack * -5\"\n    ) {\n      action.extraAttacks.type = \"standard\";\n      delete action.extraAttacks.formula.count;\n      delete action.extraAttacks.formula.bonus;\n      delete action.extraAttacks.formula.label;\n\n      if (action.extraAttacks.manual?.length) {\n        action.extraAttacks.type = \"advanced\";\n      } else {\n        delete action.extraAttacks.manual;\n      }\n    } else {\n      if (action.extraAttacks.formula?.count?.length || action.extraAttacks.manual?.length) {\n        action.extraAttacks.type = \"custom\";\n      }\n    }\n\n    // Delete unused data\n    if (!action.extraAttacks.formula?.count) delete action.extraAttacks?.formula?.count;\n    if (!action.extraAttacks.formula?.bonus) delete action.extraAttacks?.formula?.bonus;\n    if (!action.extraAttacks.formula?.label) delete action.extraAttacks?.formula?.label;\n    if (!(action.extraAttacks.manual?.length > 0)) delete action.extraAttacks?.manual;\n  }\n\n  if (foundry.utils.isEmpty(action.extraAttacks.formula)) {\n    delete action.extraAttacks.formula;\n  }\n}\n\nfunction _migrateItemChargeCost(item, updateData) {\n  const toggle = item.system.uses?.autoDeductCharges;\n  if (toggle !== undefined) {\n    // Mimic old setting by setting cost to 0\n    if (toggle === false) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n    updateData[\"system.uses.-=autoDeductCharges\"] = null;\n  }\n  // Special handling for cantrips if the above didn't match\n  else if (item.system.level === 0 && item.system.uses?.autoDeductChargesCost === undefined) {\n    const defaultAction = item.system.actions?.[0];\n    // Check for presence of obsoleted autoDeductCharges in first action\n    if (\n      defaultAction?.uses?.autoDeductCharges === true &&\n      updateData[\"system.uses.autoDeductChargesCost\"] === undefined\n    ) {\n      updateData[\"system.uses.autoDeductChargesCost\"] = \"0\";\n    }\n  }\n}\n\n// Added with PF1 v10\nfunction _migrateItemLimitedUses(itemData, updateData) {\n  // Migrate unlimited to empty selection, as the two are identical in meaning\n  if (itemData.system.uses?.per === \"unlimited\") {\n    updateData[\"system.uses.per\"] = \"\";\n  }\n\n  // Only physical items have single use, convert use cases to 1 charge\n  const isPhysical = CONFIG.Item.documentClasses[itemData.type]?.isPhysical;\n  if (!isPhysical) {\n    if (itemData.system.uses?.per === \"single\") {\n      updateData[\"system.uses.per\"] = \"charges\";\n      updateData[\"system.uses.maxFormula\"] = \"1\";\n    }\n  }\n}\n\n/**\n * @param {object} action - Action data\n * @param {object} itemData - Parent item data\n */\nfunction _migrateActionDamageType(action, itemData) {\n  if (!action.damage) return;\n\n  // Determine data paths using damage types\n  const damageGroupPaths = [\"parts\", \"critParts\", \"nonCritParts\"];\n  for (const damageGroupKey of damageGroupPaths) {\n    if (!action.damage[damageGroupKey]) continue;\n\n    // v9 migration of array damage format\n    action.damage[damageGroupKey] = action.damage[damageGroupKey].map((part) => {\n      if (Array.isArray(part)) {\n        const [formula, type] = part;\n        return { formula, type };\n      }\n      return part;\n    });\n\n    // Other old data format changes\n    const damageGroup = action.damage[damageGroupKey];\n    for (const damagePart of damageGroup) {\n      const damageType = damagePart.type;\n      if (!damageType) continue;\n\n      // Convert damage types\n      if (typeof damageType === \"string\") {\n        damagePart.types = _Action_ConvertDamageType(damageType);\n        if (!damagePart.types.length) damagePart.types = damageType.split(\";\");\n        delete damagePart.type;\n      }\n      // Move existing array\n      else if (damageType instanceof Array) {\n        damagePart.types = damageType;\n        delete damagePart.type;\n      }\n    }\n  }\n}\n\n/**\n * @param {object} actionData - Action data\n * @param {object} itemData - Parent item data\n * @param {object} options\n * @param {ffd20.components.ItemAction} [options.action]\n */\nfunction _migrateActionConditionals(actionData, itemData, { action } = {}) {\n  for (const conditional of actionData.conditionals ?? []) {\n    // Create conditional ID\n    if (!conditional._id) conditional._id = foundry.utils.randomID(16);\n\n    conditional.modifiers ??= [];\n    if (!Array.isArray(conditional.modifiers)) {\n      conditional.modifiers = Object.values(conditional.modifiers);\n    }\n\n    for (const modifier of conditional.modifiers) {\n      // Create modifier ID\n      if (!modifier._id) modifier._id = foundry.utils.randomID(16);\n\n      // Ensure subTarget exists\n      modifier.subTarget ??= \"\";\n\n      let reResult;\n      // Convert modifier subtarget\n      if ((reResult = modifier.subTarget.match(/^attack\\.([0-9]+)/))) {\n        modifier.subTarget = `attack_${reResult[1]}`;\n      }\n\n      // Remove excess sheet data that was previously incorrectly added\n      delete modifier.targets;\n      delete modifier.subTargets;\n      delete modifier.conditionalModifierTypes;\n      delete modifier.conditionalCritical;\n\n      // Convert modifier damage type\n      if (modifier.target === \"damage\" && !modifier.damageType?.length && modifier.type) {\n        modifier.damageType = _Action_ConvertDamageType(modifier.type);\n        if (!modifier.damageType.length) modifier.damageType = modifier.type.split(\";\");\n        modifier.type = \"\";\n      }\n    }\n  }\n\n  // Filter through the datamodel\n  actionData.conditionals = actionData.conditionals.map((c) =>\n    new ffd20.components.ItemConditional(c).toObject(true, true)\n  );\n}\n\nfunction _migrateActorCR(ent, updateData) {\n  // Migrate base CR\n  const cr = foundry.utils.getProperty(ent.system, \"details.cr\");\n  if (typeof cr === \"number\") {\n    updateData[\"system.details.cr.base\"] = cr;\n  } else if (cr == null) {\n    updateData[\"system.details.cr.base\"] = 1;\n  }\n\n  // Remove derived data if present\n  if (foundry.utils.getProperty(ent.system, \"details.cr.total\") !== undefined) {\n    updateData[\"system.details.cr.-=total\"] = null;\n  }\n}\n\nfunction _migrateAttackAbility(ent, updateData) {\n  const cmbAbl = foundry.utils.getProperty(ent.system, \"attributes.cmbAbility\");\n  if (cmbAbl === undefined) updateData[\"system.attributes.cmbAbility\"] = \"str\";\n\n  const meleeAbl = foundry.utils.getProperty(ent.system, \"attributes.attack.meleeAbility\");\n  if (meleeAbl === undefined) updateData[\"system.attributes.attack.meleeAbility\"] = \"str\";\n\n  const rangedAbl = foundry.utils.getProperty(ent.system, \"attributes.attack.rangedAbility\");\n  if (rangedAbl === undefined) updateData[\"system.attributes.attack.rangedAbility\"] = \"dex\";\n}\n\nfunction _migrateActorSpellbookUsage(ent, updateData) {\n  const spellbookUsage = foundry.utils.getProperty(ent.system, \"attributes.spells.usedSpellbooks\");\n  if (spellbookUsage !== undefined) {\n    updateData[\"system.attributes.spells.-=usedSpellbooks\"] = null;\n  }\n}\n\nfunction _migrateActorNullValues(ent, updateData) {\n  // Prepare test data\n  const entries = { \"system.attributes.energyDrain\": foundry.utils.getProperty(ent.system, \"attributes.energyDrain\") };\n  for (const [k, a] of Object.entries(ent.system.abilities || {})) {\n    entries[`system.abilities.${k}.damage`] = a.damage;\n    entries[`system.abilities.${k}.drain`] = a.drain;\n    entries[`system.abilities.${k}.penalty`] = a.penalty;\n  }\n\n  // Set null values to 0\n  for (const [k, v] of Object.entries(entries)) {\n    if (v === null) {\n      updateData[k] = 0;\n    }\n  }\n}\n\nfunction _migrateActorSpellbookDomainSlots(ent, updateData) {\n  const spellbooks = foundry.utils.getProperty(ent.system, \"attributes.spells.spellbooks\") || {};\n\n  for (const [k, b] of Object.entries(spellbooks)) {\n    if (b.domainSlotValue !== undefined) continue;\n    const key = `system.attributes.spells.spellbooks.${k}.domainSlotValue`;\n    updateData[key] = 1;\n  }\n}\n\nfunction _migrateActorStatures(ent, updateData) {\n  const stature = foundry.utils.getProperty(ent.system, \"traits.stature\");\n\n  if (stature === undefined) {\n    updateData[\"system.traits.stature\"] = \"tall\";\n  }\n}\n\n// Migrate weapon proficiencies\n// Converts sim and mar to simple and martial\n// Added with PF1 v10\nfunction _migrateActorProficiencies(actorData, updateData) {\n  const wprofs = updateData[\"system.traits.weaponProf\"] ?? actorData.system.traits?.weaponProf;\n  if (!wprofs?.length) return;\n\n  const wprofmap = {\n    sim: \"simple\",\n    mar: \"martial\",\n  };\n\n  if (wprofs.some((p) => !!wprofmap[p])) {\n    const nwprofs = wprofs.map((p) => wprofmap[p] || p);\n    updateData[\"system.traits.weaponProf\"] = nwprofs;\n  }\n}\n\nfunction _migrateActorDefenseAbility(ent, updateData) {\n  const normalACAbl = foundry.utils.getProperty(ent.system, \"attributes.ac.normal.ability\");\n  if (normalACAbl === undefined) updateData[\"system.attributes.ac.normal.ability\"] = \"dex\";\n  const touchACAbl = foundry.utils.getProperty(ent.system, \"attributes.ac.touch.ability\");\n  if (touchACAbl === undefined) updateData[\"system.attributes.ac.touch.ability\"] = \"dex\";\n\n  // CMD\n  const cmdDexAbl = foundry.utils.getProperty(ent.system, \"attributes.cmd.dexAbility\");\n  if (cmdDexAbl === undefined) updateData[\"system.attributes.cmd.dexAbility\"] = \"dex\";\n  const cmdStrAbl = foundry.utils.getProperty(ent.system, \"attributes.cmd.strAbility\");\n  if (cmdStrAbl === undefined) updateData[\"system.attributes.cmd.strAbility\"] = \"str\";\n}\n\nfunction _migrateActorInitAbility(ent, updateData) {\n  const abl = foundry.utils.getProperty(ent.system, \"attributes.init.ability\");\n\n  if (abl === undefined) {\n    updateData[\"system.attributes.init.ability\"] = \"dex\";\n  }\n}\n\nfunction _migrateActorCMBRevamp(ent, updateData) {\n  if (foundry.utils.getProperty(ent.system, \"attributes.cmb.total\") !== undefined) {\n    updateData[\"system.attributes.cmb.-=total\"] = null;\n  }\n}\n\nfunction _migrateActorChangeRevamp(ent, updateData) {\n  // Skills\n  Object.keys(ent.system.skills ?? {}).forEach((s) => {\n    const path = `system.skills.${s}.`;\n    if (foundry.utils.getProperty(ent, path + \"changeBonus\") !== undefined) {\n      updateData[path + \"-=changeBonus\"] = null;\n    }\n\n    // Check for subskill\n    Object.keys(foundry.utils.getProperty(ent, `system.skills.${s}.subSkills`) ?? {}).forEach((s2) => {\n      const subPath = `system.skills.${s}.subSkills.${s2}.`;\n      if (foundry.utils.getProperty(ent, subPath + \"changeBonus\") !== undefined) {\n        updateData[subPath + \"-=changeBonus\"] = null;\n      }\n    });\n  });\n\n  // Remove derived data\n  const derivedKeys = {\n    \"system.attributes.hp.max\": \"attributes.hp.-=max\",\n    \"system.attributes.mp.max\": \"attributes.mp.-=max\",\n    \"system.attributes.ac.normal.total\": \"attributes.ac.normal.-=total\",\n    \"system.attributes.ac.touch.total\": \"attributes.ac.touch.-=total\",\n    \"system.attributes.ac.flatFooted.total\": \"attributes.ac.flatFooted.-=total\",\n    \"system.attributes.cmd.total\": \"attributes.cmd.-=total\",\n    \"system.attributes.cmd.flatFootedTotal\": \"attributes.cmd.-=flatFootedTotal\",\n    \"system.attributes.sr.total\": \"attributes.sr.-=total\",\n    \"system.attributes.init.total\": \"attributes.init.-=total\",\n  };\n\n  Object.entries(derivedKeys).forEach(([key, updateKey]) => {\n    if (foundry.utils.getProperty(ent, key) !== undefined) {\n      updateData[\"system.\" + updateKey] = null;\n    }\n  });\n}\n\nfunction _migrateActorInvaliddSkills(actor, updateData) {\n  const skills = actor.system.skills;\n  if (!skills) return;\n  for (const [key, sklData] of Object.entries(skills)) {\n    if (!sklData) {\n      updateData[`system.skills.-=${key}`] = null;\n      continue;\n    }\n    for (const [subKey, subSklData] of Object.entries(sklData.subSkills ?? {})) {\n      if (!subSklData) {\n        updateData[`system.skills.${key}.subSkills.-=${subKey}`] = null;\n      }\n    }\n  }\n}\n\n/**\n * Migrate abnormal skill rank values to 0.\n * Primarily changing nulls to 0 to match new actors.\n *\n * @param ent\n * @param updateData\n */\nfunction _migrateActorSkillRanks(ent, updateData) {\n  const skills = ent.system.skills;\n  if (!skills) return; // Unlinked with no skill overrides of any kind\n  for (const [key, sklData] of Object.entries(skills)) {\n    if (!sklData) continue;\n    if (!Number.isFinite(sklData.rank)) updateData[`system.skills.${key}.rank`] = 0;\n    for (const [subKey, subSklData] of Object.entries(sklData.subSkills ?? {})) {\n      if (!subSklData) continue;\n      if (!Number.isFinite(subSklData.rank)) updateData[`system.skills.${key}.subSkills.${subKey}.rank`] = 0;\n    }\n  }\n}\n\nfunction _migrateCarryBonus(ent, updateData) {\n  if (foundry.utils.getProperty(ent.system, \"details.carryCapacity.bonus.user\") === undefined) {\n    let bonus = foundry.utils.getProperty(ent.system, \"abilities.str.carryBonus\");\n    if (bonus !== undefined) {\n      bonus = bonus || 0;\n      updateData[\"system.details.carryCapacity.bonus.user\"] = bonus;\n    }\n    updateData[\"system.abilities.str.-=carryBonus\"] = null;\n  }\n  if (foundry.utils.getProperty(ent.system, \"details.carryCapacity.multiplier.user\") === undefined) {\n    let mult = foundry.utils.getProperty(ent.system, \"abilities.str.carryMultiplier\");\n    if (mult !== undefined) {\n      mult = mult || 1;\n      updateData[\"system.details.carryCapacity.multiplier.user\"] = mult - 1;\n    }\n    updateData[\"system.abilities.str.-=carryMultiplier\"] = null;\n  }\n}\n\nfunction _migrateGilToGoldBackend(ent, updateData) {\n  const pgcoin = foundry.utils.getProperty(ent.system, \"currency.pgil\");\n  const ggcoin = foundry.utils.getProperty(ent.system, \"currency.gil\");\n  const sgcoin = foundry.utils.getProperty(ent.system, \"currency.sgil\");\n  const cgcoin = foundry.utils.getProperty(ent.system, \"currency.cgil\");\n  const apgcoin = foundry.utils.getProperty(ent.system, \"altCurrency.pgil\");\n  const aggcoin = foundry.utils.getProperty(ent.system, \"altCurrency.gil\");\n  const asgcoin = foundry.utils.getProperty(ent.system, \"altCurrency.sgil\");\n  const acgcoin = foundry.utils.getProperty(ent.system, \"altCurrency.cgil\");\n\n  if (pgcoin !== undefined) {\n    updateData[\"system.currency.pp\"] = ent.system.currency.pgil;\n    updateData[\"system.currency.-=pgil\"] = null;\n  }\n\n  if (ggcoin !== undefined) {\n    updateData[\"system.currency.gp\"] = ent.system.currency.gil;\n    updateData[\"system.currency.-=gil\"] = null;\n  }\n\n  if (sgcoin !== undefined) {\n    updateData[\"system.currency.sp\"] = ent.system.currency.sgil;\n    updateData[\"system.currency.-=sgil\"] = null;\n  }\n\n  if (cgcoin !== undefined) {\n    updateData[\"system.currency.cp\"] = ent.system.currency.cgil;\n    updateData[\"system.currency.-=cgil\"] = null;\n  }\n\n  if (apgcoin !== undefined) {\n    updateData[\"system.altCurrency.pp\"] = ent.system.altCurrency.pgil;\n    updateData[\"system.altCurrency.-=pgil\"] = null;\n  }\n\n  if (aggcoin !== undefined) {\n    updateData[\"system.altCurrency.gp\"] = ent.system.altCurrency.gil;\n    updateData[\"system.altCurrency.-=gil\"] = null;\n  }\n\n  if (asgcoin !== undefined) {\n    updateData[\"system.altCurrency.sp\"] = ent.system.altCurrency.sgil;\n    updateData[\"system.altCurrency.-=sgil\"] = null;\n  }\n\n  if (acgcoin !== undefined) {\n    updateData[\"system.altCurrency.cp\"] = ent.system.altCurrency.cgil;\n    updateData[\"system.altCurrency.-=cgil\"] = null;\n  }\n}\n\nfunction _migrateBuggedValues(ent, updateData) {\n  // Convert to integers\n  const convertToInt = [\n    \"system.details.xp.value\",\n    \"system.currency.pp\",\n    \"system.currency.gp\",\n    \"system.currency.sp\",\n    \"system.currency.cp\",\n    \"system.altCurrency.pp\",\n    \"system.altCurrency.gp\",\n    \"system.altCurrency.sp\",\n    \"system.altCurrency.cp\",\n  ];\n  for (const key of convertToInt) {\n    const oldValue = foundry.utils.getProperty(ent, key),\n      value = parseInt(oldValue ?? 0);\n    if (oldValue !== value) {\n      updateData[key] = value;\n    }\n  }\n}\n\nfunction _migrateSpellbookUsage(ent, updateData) {\n  const usedSpellbooks = ent.items\n    .filter((i) => i.type === \"spell\")\n    .reduce((cur, i) => {\n      if (!i.system.spellbook) return cur;\n      if (cur.includes(i.system.spellbook)) return cur;\n      cur.push(i.system.spellbook);\n      return cur;\n    }, []);\n\n  for (const bookKey of usedSpellbooks) {\n    const path = `system.attributes.spells.spellbooks.${bookKey}.inUse`;\n    if (foundry.utils.getProperty(ent, path) !== true) {\n      updateData[path] = true;\n    }\n  }\n}\n\nfunction _migrateActorHP(ent, updateData) {\n  // Migrate HP, Wounds and Vigor values from absolutes to relatives, which is a change in 0.80.16\n  for (const k of [\"system.attributes.hp\", \"system.attributes.wounds\", \"system.attributes.vigor\", \"system.attributes.mp\"]) {\n    const value = foundry.utils.getProperty(ent, `${k}.value`);\n\n    // Fill offset if missing\n    if (foundry.utils.getProperty(ent, `${k}.offset`) == null) {\n      const max = foundry.utils.getProperty(ent, `${k}.max`) ?? 0;\n      updateData[`${k}.offset`] = (value ?? 0) - max;\n    }\n    // Value is no longer used if it exists\n\n    if (value !== undefined) {\n      updateData[`${k}.-=value`] = null;\n    }\n  }\n}\n\nfunction _migrateActorSenses(ent, updateData, token) {\n  const oldSenses = ent.system.traits?.senses;\n\n  if (!oldSenses) return;\n\n  if (typeof oldSenses === \"string\") {\n    const tokenData = token ?? ent.prototypeToken;\n\n    updateData[\"system.traits.senses\"] = {\n      dv: { value: tokenData.brightSight },\n      ts: { value: 0 },\n      bs: { value: 0 },\n      bse: { value: 0 },\n      ll: {\n        enabled: tokenData.flags?.ffd20?.lowLightVision,\n        multiplier: {\n          dim: tokenData.flags?.ffd20?.lowLightVisionMultiplier ?? 2,\n          bright: tokenData.flags?.ffd20?.lowLightVisionMultiplierBright ?? 2,\n        },\n      },\n      sid: false,\n      tr: { value: 0 },\n      si: false,\n      sc: { value: 0 },\n      custom: oldSenses,\n    };\n  }\n\n  // Migrate boolean Scent sense to number\n  if (typeof oldSenses?.sc === \"boolean\") {\n    updateData[\"system.traits.senses.sc\"] = { value: oldSenses.sc ? 30 : 0 };\n  }\n\n  // Migrate boolean true seeing to number\n  if (typeof oldSenses?.tr === \"boolean\") {\n    updateData[\"system.traits.senses.tr\"] = { value: oldSenses.tr ? 120 : 0 };\n  }\n\n  for (const id of [\"dv\", \"ts\", \"ls\", \"bs\", \"bse\", \"sc\", \"tr\"]) {\n    const sense = oldSenses?.[id];\n    if (foundry.utils.getType(sense) !== \"Object\") {\n      updateData[`system.traits.senses.${id}`] = { value: sense || 0 };\n    }\n  }\n}\n\nfunction _migrateActorSkillJournals(ent, updateData) {\n  const reOldJournalFormat = /^[a-zA-Z0-9]+$/;\n  for (const [skillKey, sklData] of Object.entries(ent.system.skills ?? {})) {\n    if (!sklData) continue;\n    for (const [subSkillKey, subSklData] of Object.entries(sklData.subSkills ?? {})) {\n      if (!subSklData) continue;\n      if (subSklData.journal?.match(reOldJournalFormat)) {\n        updateData[`system.skills.${skillKey}.subSkills.${subSkillKey}.journal`] = `JournalEntry.${subSklData.journal}`;\n      }\n    }\n\n    if (sklData.journal?.match(reOldJournalFormat)) {\n      updateData[`system.skills.${skillKey}.journal`] = `JournalEntry.${sklData.journal}`;\n    }\n  }\n}\n\nfunction _migrateActorSubskillData(actor, updateData) {\n  for (const [skillId, skillData] of Object.entries(actor.system.skills ?? {})) {\n    if (!skillData) continue;\n    for (const [subSkillId, subSkillData] of Object.entries(skillData.subSkills ?? {})) {\n      if (!subSkillData) continue;\n      if (subSkillData.mod !== undefined) {\n        // Remove permanently stored .mod which is derived value\n        // Added with PF1 v9\n        updateData[`system.skills.${skillId}.subSkills.${subSkillId}.-=mod`] = null;\n      }\n    }\n  }\n}\n\nfunction _migrateActorDRandER(ent, updateData) {\n  const oldDR = ent.system.traits?.dr;\n  const oldER = ent.system.traits?.eres;\n\n  if (typeof oldDR === \"string\") {\n    updateData[\"system.traits.dr\"] = {\n      value: [],\n      custom: oldDR,\n    };\n  }\n\n  if (typeof oldER === \"string\") {\n    updateData[\"system.traits.eres\"] = {\n      value: [],\n      custom: oldER,\n    };\n  }\n}\n\n/**\n * @param trait\n * @since PF1 v11\n */\nfunction _migrateAnyTrait(trait) {\n  if (!trait) return null; // Missing\n  if (Array.isArray(trait)) return null; // Already in final format\n\n  const all = new Set();\n\n  // Pull standard choices\n  if (Array.isArray(trait.value) && trait.value.length) {\n    trait.value.forEach((v) => all.add(v));\n  }\n  // Convert older plain string custom traits to array\n  if (typeof trait.custom == \"string\") {\n    trait.custom =\n      trait.custom\n        ?.split(ffd20.config.re.traitSeparator)\n        .map((x) => x.trim())\n        .filter((x) => x) ?? [];\n  }\n  // Pull custom choices\n  if (Array.isArray(trait.custom) && trait.custom.length) {\n    trait.custom.forEach((v) => all.add(v));\n  }\n\n  return [...all];\n}\n\nfunction _migrateActorTraits(actor, updateData) {\n  const keys = [\"di\", \"dv\", \"ci\", \"languages\", \"armorProf\", \"weaponProf\"];\n\n  for (const key of keys) {\n    const trait = actor.system.traits?.[key];\n    if (!trait) continue; // Missing\n    if (Array.isArray(trait)) continue; // Already in final format\n\n    const selections = _migrateAnyTrait(trait);\n    if (selections) updateData[`system.traits.${key}`] = selections;\n  }\n}\n\n/**\n * @param itemData\n * @param updateData\n */\nfunction _migrateItemTraits(itemData, updateData) {\n  const keys = [\n    \"armorProf\",\n    \"descriptors\",\n    \"multischool\",\n    \"subschool\",\n    \"languages\",\n    \"weaponGroups\",\n    \"weaponProf\",\n    \"creatureTypes\",\n    \"creatureSubtypes\",\n    \"conditions\",\n  ];\n\n  for (const key of keys) {\n    const trait = itemData.system?.[key];\n    if (!trait) continue; // Missing\n    if (Array.isArray(trait)) continue; // Already in final format\n\n    const selections = _migrateAnyTrait(trait);\n    if (selections) updateData[`system.${key}`] = selections;\n  }\n}\n\n/**\n * @param actorData\n * @param updateData\n * @since PF1 v10\n */\nfunction _migrateActorFlags(actorData, updateData) {\n  const flags = actorData.flags?.ffd20;\n  if (!flags) return;\n\n  // visionPermission to visionSharing\n  if (flags.visionPermission) {\n    updateData[\"flags.ffd20.visionSharing.default\"] = flags.visionPermission.default === \"yes\" ? true : false;\n    const mapping = {\n      yes: true,\n      no: false,\n      default: null,\n    };\n    updateData[\"flags.ffd20.visionSharing.users\"] = Object.fromEntries(\n      Object.entries(flags.visionPermission?.users ?? {}).map(([uid, data]) => [uid, mapping[data.level] ?? null])\n    );\n    updateData[\"flags.ffd20.-=visionPermission\"] = null;\n  }\n}\n\nfunction _Action_ConvertDamageType(damageTypeString) {\n  const separator = /(?:\\s*\\/\\s*|\\s+and\\s+|\\s+or\\s+)/i;\n  const damageTypeList = [\n    {\n      tests: [\"b\", \"blunt\", \"bludgeoning\"],\n      result: \"bludgeoning\",\n    },\n    {\n      tests: [\"p\", \"pierce\", \"piercing\"],\n      result: \"piercing\",\n    },\n    {\n      tests: [\"s\", \"slash\", \"slashing\"],\n      result: \"slashing\",\n    },\n    {\n      tests: [\"f\", \"fire\"],\n      result: \"fire\",\n    },\n    {\n      tests: [\"ice\", \"i\"],\n      result: \"ice\",\n    },\n    {\n      tests: [\"e\", \"l\", \"lightning\", \"electricity\", \"electrical\"],\n      result: \"lightning\",\n    },\n    {\n      tests: [\"wind\"],\n      result: \"wind\",\n    },\n    {\n      tests: [\"earth\"],\n      result: \"earth\",\n    },\n    {\n      tests: [\"water\"],\n      result: \"water\",\n    },\n    {\n      tests: [\"force\"],\n      result: \"force\",\n    },\n    {\n      tests: [\"dark\", \"neg\", \"negative\"],\n      result: \"dark\",\n    },\n    {\n      tests: [\"light\", \"pos\", \"positive\"],\n      result: \"light\",\n    },\n    {\n      tests: [\"u\", \"untyped\", \"untype\"],\n      result: \"untyped\",\n    },\n    {\n      tests: [\"n\", \"nonelemental\", \"non\"],\n      result: \"nonelemental\",\n    },\n  ];\n\n  const damageTypes = damageTypeString.split(separator).map((o) => o.toLowerCase());\n  const result = [];\n  for (const damageTest of damageTypeList) {\n    for (const testString of damageTest.tests) {\n      if (damageTypes.includes(testString)) {\n        result.push(damageTest.result);\n      }\n    }\n  }\n\n  return result;\n}\n\nfunction _migrateContainerPrice(item, updateData) {\n  if (item.type !== \"container\") return;\n\n  // .basePrice was merged into .price with PF1 v9\n  if (item.system.basePrice !== undefined) {\n    updateData[\"system.price\"] = item.system.basePrice;\n    updateData[\"system.-=basePrice\"] = null;\n  }\n  if (item.system.unidentified?.basePrice !== undefined) {\n    updateData[\"system.unidentified.price\"] = item.system.unidentified.basePrice;\n    updateData[\"system.unidentified.-=basePrice\"] = null;\n  }\n}\n\nfunction _migrateContainerReduction(item, updateData) {\n  if (item.type !== \"container\") return;\n  if (item.system.weightReduction !== undefined) {\n    updateData[\"system.weight.reduction.percent\"] = item.system.weightReduction;\n    updateData[\"system.-=weightReduction\"] = null;\n  }\n}\n\nfunction _migrateItemType(ent, updateData) {\n  const type = ent.type;\n  const oldType = ent.system[`${type}Type`];\n  if (oldType == null) return;\n  updateData[\"system.subType\"] = oldType;\n  updateData[`system.-=${type}Type`] = null;\n}\n\n/**\n * @param {object} itemData\n * @param {object} updateData\n * @since PF1 v10\n */\nfunction _migrateItemFlags(itemData, updateData) {\n  if (!itemData.flags?.ffd20) return;\n\n  if (itemData.flags.ffd20.abundant !== undefined) {\n    if (itemData.system.abundant === undefined) {\n      updateData[\"system.abundant\"] = Boolean(itemData.flags.ffd20.abundant);\n    }\n    updateData[\"flags.ffd20.-=abundant\"] = null;\n  }\n}\n\nfunction _migrateItemMaterials(itemData, updateData) {\n  for (const materialPath of [\"material\", \"armor.material\"]) {\n    const material = foundry.utils.getProperty(itemData.system, materialPath);\n    if (!material) continue;\n\n    // Convert incorrect material addon data\n    const tg = \"throneglass\";\n    // Weapon\n    if (material?.addon) {\n      let addon = material.addon;\n      if (!Array.isArray(addon)) {\n        updateData[`system.${material}.addon`] = Object.entries(addon)\n          .filter(([_, chosen]) => chosen)\n          .map(([key]) => key);\n        addon = updateData[`system.${materialPath}.addon`];\n      }\n      // Convert Throneglass into main material\n      // Since PF1 v10.3\n      if (addon.includes(tg)) {\n        updateData[`system.${materialPath}.addon`] = addon.filter((ma) => ma !== tg);\n        if (!itemData.system.material?.normal?.value) {\n          updateData[`system.${materialPath}.normal.value`] = tg;\n        }\n      }\n    }\n\n    // Convert material IDs\n    // Since PF1 v10.5\n    const addons = updateData[`system.${materialPath}.addon`] ?? material?.addon ?? [];\n    if (addons?.some((ma) => !!materialChanges[ma])) {\n      updateData[`system.${materialPath}.addon`] = addons.map((ma) => materialChanges[ma] ?? ma);\n    }\n\n    const newMat = materialChanges[material?.normal?.value];\n    if (newMat) updateData[`system.${materialPath}.normal.value`] = newMat;\n  }\n}\n\n/**\n * Migrate item held option.\n *\n * @param {object} itemData\n * @param {object} updateData\n * @since PF1 v11\n */\nfunction _migrateItemHeld(itemData, updateData) {\n  if (itemData.system.held === \"normal\") {\n    updateData[\"system.held\"] = \"1h\";\n  }\n}\n\n/**\n * Removes data that the system has added to items that is now unused with no new location.\n *\n * @param item\n * @param updateData\n */\nfunction _migrateItemUnusedData(item, updateData) {\n  // .priceUnits was never used, removal added with PF1 v9\n  if (item.system.priceUnits !== undefined) {\n    updateData[\"system.-=priceUnits\"] = null;\n  }\n\n  // .description.chat was never used\n  if (item.system.description?.chat !== undefined) {\n    updateData[\"system.description.-=chat\"] = null;\n  }\n\n  // .identifiedName was made obsolete with PF1 v9\n  if (item.system.identifiedName !== undefined) {\n    updateData[\"system.-=identifiedName\"] = null;\n  }\n\n  // Creating items in containers added typeName for no reason (in 0.82.5 and older)\n  if (item.system.typeName !== undefined) {\n    updateData[\"system.-=typeName\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.weaponData !== undefined) {\n    updateData[\"system.-=weaponData\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.range !== undefined) {\n    updateData[\"system.-=range\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.primaryAttack !== undefined) {\n    updateData[\"system.-=primaryAttack\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.activation !== undefined) {\n    updateData[\"system.-=activation\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.unchainedAction !== undefined) {\n    updateData[\"system.-=unchainedAction\"] = null;\n  }\n\n  // Data not used since 0.81.0\n  if (item.system.measureTemplate !== undefined) {\n    updateData[\"system.-=measureTemplate\"] = null;\n  }\n\n  // useCustomTag not used since PF1 v10\n  if (item.system.useCustomTag !== undefined) {\n    updateData[\"system.-=useCustomTag\"] = null;\n    if (item.system.useCustomTag === false && item.system.tag !== undefined) {\n      updateData[\"system.-=tag\"] = null;\n    }\n  }\n\n  // ammoType seems to have never been actually used, but it was stored in items\n  if (item.system.ammoType !== undefined) {\n    updateData[\"system.-=ammoType\"] = null;\n    // Move it anyway just in case, if missing\n    if (!item.system.ammo?.type && item.system.ammoType) {\n      updateData[\"system.ammo.type\"] = item.system.ammoType;\n    }\n  }\n}\n\n/**\n * Migrate Active Effect data.\n * - Removes pf1_ status ID prefixes.\n *\n * Added with PF1 v10\n *\n * @param {object} actorData - Actor data\n * @param {object} updateData - Update data\n * @param {Actor} [actor] - Actor document\n * @param actor\n */\nconst _migrateActorActiveEffects = async (actorData, updateData, actor) => {\n  // Migate Active Effects\n  const effects = [];\n  for (const ae of actorData.effects ?? []) {\n    const aeUpdate = await migrateActiveEffectData(ae, actor);\n    if (!foundry.utils.isEmpty(aeUpdate)) {\n      aeUpdate._id = ae._id;\n      effects.push(aeUpdate);\n    }\n  }\n\n  if (effects.length) updateData.effects = effects;\n};\n\nfunction _migrateActorUnusedData(actor, updateData) {\n  // Obsolete vision\n  if (foundry.utils.getProperty(actor.system, \"attributes.vision\") !== undefined) {\n    updateData[\"system.attributes.-=vision\"] = null;\n  }\n\n  if (foundry.utils.getProperty(actor.prototypeToken, \"flags.ffd20.lowLightVision\") !== undefined) {\n    updateData[\"prototypeToken.flags.ffd20.-=lowLightVision\"] = null;\n  }\n\n  // XP max is purely derived value\n  if (actor.system.details?.xp?.max !== undefined) {\n    updateData[\"system.details.xp.-=max\"] = null;\n  }\n\n  // Actor resources have always been derived data\n  if (actor.system.resources !== undefined) {\n    updateData[\"system.-=resources\"] = null;\n  }\n\n  // Conditions no longer are permanently stored in actor data (since PF1 v10)\n  if (actor.system.attributes?.conditions !== undefined) {\n    updateData[\"system.attributes.-=conditions\"] = null;\n  }\n\n  // details.level is derived data\n  if (actor.system.details?.level !== undefined) {\n    updateData[\"system.details.-=level\"] = null;\n  }\n}\n\n/**\n * Flatten item tuple arrays\n * Since PF1 v9\n *\n * @param item\n * @param updateData\n */\nfunction _migrateItemTuples(item, updateData) {\n  // Race subtypes\n  if (item.type === \"race\") {\n    if (item.system.subTypes?.length) {\n      if (typeof item.system.subTypes[0] !== \"string\") {\n        updateData[\"system.subTypes\"] = item.system.subTypes.flat();\n      }\n    }\n  }\n\n  // Tags\n  if (item.system.tags?.length) {\n    if (typeof item.system.tags[0] !== \"string\") {\n      updateData[\"system.tags\"] = item.system.tags.flat();\n    }\n  }\n\n  // Feat class associations\n  const classAssociations = item.system.associations?.classes;\n  if (classAssociations?.length) {\n    if (typeof classAssociations[0] !== \"string\") {\n      updateData[\"system.associations.classes\"] = classAssociations.flat();\n    }\n  }\n}\n\n/**\n * Migrate Active Effect data\n *\n * @param {object} ae Active Effect data\n * @param {Actor} actor Actor\n */\nconst migrateActiveEffectData = async (ae, actor) => {\n  if (!actor) return;\n\n  const updateData = {};\n\n  // Fix broken AE\n  if (!ae.name) updateData.name = \"No Name\";\n\n  /**\n   * @param {string} origin Origin string\n   * @returns {string|undefined} Relative UUID, if origin was found\n   */\n  const getNewRelativeOrigin = async (origin) => {\n    if (typeof origin !== \"string\") return; // Invalid origin type, recorded by SBC?\n    const newOrigin = await fromUuid(origin, { relative: actor });\n    if (newOrigin instanceof Item && actor && newOrigin.actor === actor) {\n      return newOrigin.getRelativeUUID(actor);\n    }\n  };\n\n  // Convert no longer used flags.ffd20.prigin to origin, if no origin is present\n  const originFlag = ae.flags?.ffd20?.origin;\n  if (originFlag) {\n    if (!ae.origin) {\n      const newOrigin = await getNewRelativeOrigin(originFlag);\n      if (newOrigin) updateData.origin = newOrigin;\n    }\n    updateData.flags ??= {};\n    updateData.flags.ffd20 ??= {};\n    updateData.flags.ffd20[\"-=origin\"] = null;\n  }\n\n  // Convert origin to relative origin\n  if (ae.origin) {\n    const newOrigin = await getNewRelativeOrigin(ae.origin);\n    // Avoid empty updates\n    if (newOrigin && ae.origin !== newOrigin) {\n      updateData.origin = newOrigin;\n    }\n  }\n\n  // Remove pf1_ prefix from status effects\n  if (ae.statuses.some((s) => s.startsWith(\"pf1_\"))) {\n    updateData.statuses = Array.from(new Set(ae.statuses.map((s) => s.replace(/^pf1_/, \"\"))));\n  }\n  if (ae.statuses.some((s) => s.startsWith(\"ffd20_\"))) {\n    updateData.statuses = Array.from(new Set(ae.statuses.map((s) => s.replace(/^ffd20_/, \"\"))));\n  }\n\n  return updateData;\n};\n\n/**\n * Migrate Roll JSON\n *\n * Creates clone of the roll object.\n *\n * @param {object} roll JSON\n * @param {boolean} inplace - Update in-place, modifying the original object\n * @returns {object|void} - Updated roll object or undefined if nothing was changed\n */\nexport function migrateRollData(roll, inplace = false) {\n  roll = inplace ? roll : foundry.utils.deepClone(roll);\n  let updated = false;\n\n  // Fix corrupt roll class\n  if ([\"RollPF2\", \"RollPF$1\"].includes(roll.class)) {\n    roll.class = \"RollPF\";\n    updated = true;\n  }\n\n  // Delve deeper into the roll object\n  for (const term of roll.terms ?? []) {\n    // _number used in Die terms\n    if (typeof term._number === \"object\" && \"class\" in term._number && \"terms\" in term._number) {\n      const updatedRoll = migrateRollData(term._number, true);\n      if (updatedRoll) updated = true;\n    }\n    // roll used in parenthetical terms\n    if (typeof term.roll === \"object\" && \"class\" in term.roll && \"terms\" in term.roll) {\n      const updatedRoll = migrateRollData(term.roll, true);\n      if (updatedRoll) updated = true;\n    }\n  }\n\n  return updated ? roll : undefined;\n}\n\n/**\n * Migrate Chat Message data\n *\n * @param {object} cmData - Chat message data (such as result of msg.toObject())\n * @returns {object} - Update data\n */\nexport function migrateMessageData(cmData) {\n  const updateData = {};\n\n  const flags = cmData.flags?.ffd20;\n\n  const metadata = flags?.metadata;\n  if (metadata) {\n    updateData.type = \"action\";\n\n    updateData.flags ??= {};\n    updateData.flags.ffd20 ??= {};\n    updateData.flags.ffd20[\"-=metadata\"] = null;\n    updateData.system = metadata;\n\n    if (typeof updateData.system.item !== \"object\") updateData.system.item = { id: updateData.system.item };\n    if (typeof updateData.system.action !== \"object\") updateData.system.action = { id: updateData.system.action };\n  }\n\n  const ident = flags?.identifiedInfo;\n  if (ident) {\n    updateData.system ??= {};\n    updateData.system.item ??= {};\n    updateData.system.item.identified = ident.identified ?? true;\n    updateData.system.item.name = ident.name;\n    updateData.system.item.description = ident.description;\n    updateData.system.action ??= {};\n    updateData.system.action.name = ident.actionName;\n    updateData.system.action.description = ident.actionDescription;\n\n    updateData.flags ??= {};\n    updateData.flags.ffd20 ??= {};\n    updateData.flags.ffd20[\"-=identifiedInfo\"] = null;\n  }\n\n  // Speed is moved to config\n  if (metadata?.speed) {\n    updateData.system ??= {};\n    updateData.system.config ??= {};\n    updateData.system.config.speed = metadata.speed;\n  }\n\n  // Skill rank reference is moved to config\n  if (metadata?.skill) {\n    updateData.system ??= {};\n    updateData.system.config ??= {};\n    updateData.system.config.rank = metadata.skill.rank;\n  }\n\n  if (flags?.subject) {\n    updateData.system ??= {};\n    updateData.system.subject = flags.subject;\n    updateData.flags ??= {};\n    updateData.flags.ffd20 ??= {};\n    updateData.flags.ffd20[\"-=subject\"] = null;\n  }\n\n  if (typeof updateData.system?.subject === \"string\") {\n    updateData.system.subject = { info: updateData.system.subject };\n  }\n\n  // Migrate rolls\n  if (cmData.rolls?.length) {\n    let updated = false;\n    const newRolls = [];\n    for (let roll of cmData.rolls) {\n      if (typeof roll !== \"string\") break; // Fail if the data is not in expected format\n      roll = JSON.parse(roll);\n      const newRoll = migrateRollData(roll);\n      if (newRoll) {\n        roll = newRoll;\n        updated = true;\n      }\n      newRolls.push(JSON.stringify(roll));\n    }\n    if (updated) {\n      updateData.rolls = newRolls;\n    }\n  }\n\n  // TODO: System rolls\n  /*\n  if (cmData.system?.rolls) {\n    for (const atk of cmData.system.rolls.attacks ?? []) {\n      const updateData = migrateRollJson(atk.attack); // D20RollPF\n      if (atk.damage) {\n        for (const dmg of atk.damage) {\n          const updateData = migrateRollJson(dmg); // DamageRoll\n        }\n      }\n    }\n  }\n  */\n\n  return updateData;\n}\n\n/**\n *\n * @param {ChatMessage} cm - Chat Message document\n * @param {object} [options] - Additional options\n * @param {boolean} [options.commit=true] - If false, no update is performed. Returns update data instead.\n * @param {MigrationState} [options.state] - State tragger. Internal use only.\n * @returns {Promise<ChatMessage|object|null>} - Returns null if no update is needed, promise if commit is true, object otherwise.\n */\nexport async function migrateMessage(cm, { commit = true, state } = {}) {\n  const updateData = migrateMessageData(cm.toObject());\n\n  if (!!updateData.type && updateData.type !== cm.type) {\n    if (state) {\n      state.typeChanges = true;\n    } else console.warn(\"Document type changed! Refresh required!\");\n  }\n\n  if (foundry.utils.isEmpty(updateData)) return null;\n\n  if (commit) return cm.update(updateData);\n  return updateData;\n}\n\n/**\n * Migrate chat messages.\n *\n * @param {object} options - Additional options\n * @param {boolean} [options.fast=true] - Skip already migrated documents.\n * @param {MigrationState} [options.state] - Internal only. State tracker.\n * @param {*} [options.dialog=null] - Dialog configuration.\n * @param {boolean} [options.noHooks=false]\n */\nexport async function migrateMessages({ fast, state, dialog = null, noHooks = false } = {}) {\n  if (!noHooks) Hooks.callAll(\"pf1MigrationStarted\", { scope: \"chat\" });\n\n  // Locally generated state tracker\n  const localState = !state;\n  state = await initializeStateAndDialog(state, \"FFD20.Migration.Category.Chat\", dialog);\n\n  if (localState) state.start();\n\n  const tracker = state.createCategory(\"chat\", \"FFD20.Migration.Category.Chat\", true);\n\n  console.log(\"FFD20 | Migration | Chat log starting...\");\n  tracker.start();\n\n  tracker.setTotal(game.messages.size);\n  tracker.setInvalid(game.messages.invalidDocumentIds.size);\n\n  // HACK: Yield thread for smooth dialog experience. Without this the dialog seems to hitch.\n  if (dialog) await new Promise((resolve) => setTimeout(resolve, 100));\n\n  const updates = [];\n\n  const applyUpdates = async () => {\n    try {\n      console.debug(\"FFD20 | Migration | Chat Log | Applying updates to\", updates.length, \"chat message(s)\");\n      await ChatMessage.updateDocuments(updates);\n    } catch (err) {\n      console.error(\"Error migrating chat messages\\n\", err, \"\\n\", { updates });\n    }\n    updates.length = 0;\n\n    // HACK: Yield to keep UI somewhat responsive, without this it can become completely unresponsive for a long period of time\n    // This issue probably can happen with the other document types, but is especially prone to happening with messages\n    await new Promise((resolve) => setTimeout(resolve, 0));\n  };\n\n  // Do actual migration\n  // One by one migration, this is slow but works\n  for (const msg of game.messages) {\n    if (fast && isMigrated(msg)) {\n      tracker.ignoreEntry(msg);\n      continue;\n    }\n\n    tracker.startEntry(msg);\n    try {\n      const updateData = migrateMessageData(msg.toObject());\n      if (!foundry.utils.isEmpty(updateData)) {\n        updateData._id = msg.id;\n        updates.push(updateData);\n\n        if (state && updateData.type && updateData.type !== msg.type) {\n          state.typeChanges = true;\n        }\n      }\n    } catch (err) {\n      console.error(err, msg);\n      tracker.recordError(msg, err);\n    }\n    tracker.finishEntry(msg);\n\n    if (updates.length >= ffd20.migrations.UPDATE_CHUNK_SIZE) await applyUpdates();\n  }\n\n  if (updates.length) await applyUpdates();\n\n  // Migration complete\n  console.log(\"FFD20 | Migration | Chat log complete!\");\n  tracker.finish();\n  if (localState) state.finish();\n\n  if (!noHooks) Hooks.callAll(\"pf1MigrationFinished\", { scope: \"chat\" });\n}\n","/**\n * The core API provided by the system, available via the global `pf1`.\n *\n * @module\n */\n\n// Imports for side effects\nimport \"./less/ffd20.less\";\nimport \"./module/hmr.mjs\";\nimport \"./module/patch-core.mjs\";\nimport \"module/compendium-directory.mjs\";\nimport \"./module/chatlog.mjs\";\n\n// Import Modules\nimport { moduleToObject } from \"./module/utils/internal.mjs\";\nimport { initializeSocket } from \"./module/socket.mjs\";\nimport { SemanticVersion } from \"./module/utils/semver.mjs\";\nimport * as macros from \"./module/documents/macros.mjs\";\nimport * as chatUtils from \"./module/utils/chat.mjs\";\nimport { initializeModuleIntegration } from \"./module/modules.mjs\";\nimport { ActorPFProxy } from \"@actor/actor-proxy.mjs\";\nimport { ItemPFProxy } from \"@item/item-proxy.mjs\";\nimport * as tours from \"module/tours.mjs\";\n\n// New API\nimport * as FFD20 from \"./module/config.mjs\";\nimport * as PF1CONST from \"./module/const.mjs\";\nimport * as applications from \"./module/applications/_module.mjs\";\nimport * as documents from \"./module/documents/_module.mjs\";\nimport * as models from \"./module/models/_module.mjs\";\nimport * as actionUse from \"./module/action-use/_module.mjs\";\nimport * as chat from \"./module/chat/_module.mjs\";\nimport * as _canvas from \"./module/canvas/_module.mjs\";\nimport * as dice from \"./module/dice/_module.mjs\";\nimport * as components from \"./module/components/_module.mjs\";\nimport * as utils from \"./module/utils/_module.mjs\";\nimport * as registry from \"./module/registry/_module.mjs\";\nimport * as migrations from \"./module/migration.mjs\";\n\n// ESM exports, to be kept in sync with globalThis.pf1\nexport {\n  actionUse,\n  applications,\n  _canvas as canvas,\n  components,\n  FFD20 as config,\n  PF1CONST as const,\n  dice,\n  documents,\n  models,\n  migrations,\n  registry,\n  tours,\n  utils,\n  chat,\n};\n\nglobalThis.ffd20 = moduleToObject({\n  actionUse,\n  applications,\n  canvas: _canvas,\n  components,\n  config: FFD20,\n  const: PF1CONST,\n  dice,\n  documents,\n  models,\n  migrations,\n  registry,\n  utils,\n  chat,\n  // Initialize skip confirm prompt value\n  skipConfirmPrompt: false,\n});\n\n/* -------------------------------------------- */\n/*  Foundry VTT Initialization                  */\n/* -------------------------------------------- */\nHooks.once(\"init\", function () {\n  console.log(`FFD20 | Initializing Final Fantasy D20 System`);\n\n  migrations.registerRedirects();\n\n  // Temp store\n  Object.defineProperty(ffd20, \"_temp\", {\n    value: {},\n    enumerable: false,\n    writable: false,\n  });\n\n  // Global exports\n  globalThis.RollPF = dice.RollPF;\n\n  // Record Configuration Values\n  CONFIG.FFD20 = ffd20.config;\n\n  // Canvas\n  CONFIG.Canvas.layers.templates.layerClass = _canvas.TemplateLayerPF;\n\n  // Measured Template\n  CONFIG.MeasuredTemplate.objectClass = _canvas.MeasuredTemplatePF;\n  CONFIG.MeasuredTemplate.defaults.originalAngle = CONFIG.MeasuredTemplate.defaults.angle;\n  CONFIG.MeasuredTemplate.defaults.angle = 90; // PF1 uses 90 degree angles\n\n  // Token\n  CONFIG.Token.objectClass = _canvas.TokenPF;\n  CONFIG.Token.hudClass = _canvas.TokenHUDPF;\n  CONFIG.Token.documentClass = documents.TokenDocumentPF;\n\n  // Document classes\n  CONFIG.Actor.documentClass = ActorPFProxy;\n  CONFIG.Actor.documentClasses = {\n    character: documents.actor.ActorCharacterPF,\n    npc: documents.actor.ActorNPCPF,\n    haunt: documents.actor.ActorHauntPF,\n    trap: documents.actor.ActorTrapPF,\n    vehicle: documents.actor.ActorVehiclePF,\n  };\n  CONFIG.Actor.dataModels.haunt = models.actor.HauntModel;\n  CONFIG.Actor.dataModels.trap = models.actor.TrapModel;\n  CONFIG.Actor.dataModels.vehicle = models.actor.VehicleModel;\n\n  CONFIG.Item.documentClass = ItemPFProxy;\n  CONFIG.Item.documentClasses = {\n    attack: documents.item.ItemAttackPF,\n    buff: documents.item.ItemBuffPF,\n    class: documents.item.ItemClassPF,\n    consumable: documents.item.ItemConsumablePF,\n    container: documents.item.ItemContainerPF,\n    equipment: documents.item.ItemEquipmentPF,\n    feat: documents.item.ItemFeatPF,\n    loot: documents.item.ItemLootPF,\n    race: documents.item.ItemRacePF,\n    spell: documents.item.ItemSpellPF,\n    weapon: documents.item.ItemWeaponPF,\n    implant: documents.item.ItemImplantPF,\n  };\n\n  // Active Effects\n  CONFIG.ActiveEffect.documentClass = documents.ActiveEffectPF;\n  CONFIG.ActiveEffect.legacyTransferral = false; // TODO: Remove once legacy transferral is no longer default.\n  CONFIG.ActiveEffect.dataModels.base = models.ae.AEBaseModel;\n  CONFIG.ActiveEffect.dataModels.buff = models.ae.AEBuffModel;\n\n  // Combat\n  CONFIG.Combat.documentClass = documents.CombatPF;\n  CONFIG.Combatant.documentClass = documents.CombatantPF;\n\n  // Chat\n  CONFIG.ChatMessage.documentClass = documents.ChatMessagePF;\n\n  CONFIG.ChatMessage.dataModels.base = models.chat.BaseMessageModel;\n  CONFIG.ChatMessage.dataModels.item = models.chat.ItemMessageModel;\n  CONFIG.ChatMessage.dataModels.action = models.chat.ActionMessageModel;\n  CONFIG.ChatMessage.dataModels.check = models.chat.CheckMessageModel;\n\n  // UI classes\n  CONFIG.ui.items = applications.ItemDirectoryPF;\n\n  // Dice config\n  CONFIG.Dice.rolls.unshift(dice.RollPF);\n\n  CONFIG.Dice.rolls.push(dice.D20RollPF);\n  CONFIG.Dice.rolls.push(dice.DamageRoll);\n\n  // Replace core terms to provide custom functionality\n  CONFIG.Dice.termTypes.FunctionTerm = ffd20.dice.terms.FunctionTermPF;\n  CONFIG.Dice.termTypes.StringTerm = ffd20.dice.terms.StringTermPF;\n\n  // Roll functions\n  for (const [key, fn] of Object.entries(ffd20.utils.roll.functions)) {\n    CONFIG.Dice.functions[key] = fn;\n  }\n\n  // Combat time progression\n  CONFIG.time.roundTime = 6;\n\n  // Low-Light Vision mixin\n  CONFIG.AmbientLight.objectClass = _canvas.lowLightVision.LLVMixin(CONFIG.AmbientLight.objectClass);\n  CONFIG.Token.objectClass = _canvas.lowLightVision.LLVMixin(CONFIG.Token.objectClass);\n\n  // Register System Settings\n  documents.settings.registerSystemSettings();\n  ffd20.utils.internal.setDefaultSceneScaling();\n\n  // Preload Handlebars Templates\n  utils.handlebars.preload();\n  // Register helpers\n  utils.handlebars.helpers.register();\n\n  // Register sheet application classes\n  Actors.unregisterSheet(\"core\", ActorSheet);\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFCharacter, {\n    label: \"FFD20.Sheet.PC\",\n    types: [\"character\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPC, {\n    label: \"FFD20.Sheet.NPC\",\n    types: [\"npc\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPCLite, {\n    label: \"FFD20.Sheet.NPCLite\",\n    types: [\"npc\"],\n    makeDefault: false,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFNPCLoot, {\n    label: \"FFD20.Sheet.NPCLoot\",\n    types: [\"npc\"],\n    makeDefault: false,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFHaunt, {\n    label: \"FFD20.Sheet.Haunt\",\n    types: [\"haunt\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFTrap, {\n    label: \"FFD20.Sheet.Trap\",\n    types: [\"trap\"],\n    makeDefault: true,\n  });\n  Actors.registerSheet(\"ffd20\", applications.actor.ActorSheetPFVehicle, {\n    label: \"FFD20.Sheet.Vehicle\",\n    types: [\"vehicle\"],\n    makeDefault: true,\n  });\n  Items.unregisterSheet(\"core\", ItemSheet);\n  Items.registerSheet(\"ffd20\", applications.item.ItemSheetPF, {\n    label: \"FFD20.Sheet.Item\",\n    types: [\"class\", \"feat\", \"spell\", \"consumable\", \"equipment\", \"loot\", \"weapon\", \"buff\", \"attack\", \"race\", \"implant\"],\n    makeDefault: true,\n  });\n  Items.registerSheet(\"ffd20\", applications.item.ItemSheetPF_Container, {\n    label: \"FFD20.Sheet.Container\",\n    types: [\"container\"],\n    makeDefault: true,\n  });\n\n  DocumentSheetConfig.registerSheet(JournalEntryPage, \"ffd20\", applications.journal.JournalTextPageSheetPF1, {\n    types: [\"text\"],\n    makeDefault: false,\n    label: \"FFD20.Sheet.TextPage\",\n  });\n\n  // Register detection modes\n  for (const mode of Object.values(ffd20.canvas.detectionModes)) {\n    CONFIG.Canvas.detectionModes[mode.ID] = new mode({\n      id: mode.ID,\n      label: mode.LABEL,\n      type: mode.DETECTION_TYPE ?? DetectionMode.DETECTION_TYPES.SIGHT,\n    });\n  }\n\n  // Register vision modes\n  CONFIG.Canvas.visionModes.darkvision = ffd20.canvas.visionModes.darkvision;\n\n  // Initialize socket listener\n  initializeSocket();\n\n  // Initialize module integrations\n  initializeModuleIntegration();\n\n  // Initialize registries with initial/built-in data\n  const registries = /** @type {const} */ ([\n    [\"damageTypes\", registry.DamageTypes],\n    [\"materials\", registry.Materials],\n    [\"scriptCalls\", registry.ScriptCalls],\n    [\"conditions\", registry.Conditions],\n    [\"sources\", registry.Sources],\n  ]);\n\n  for (const [registryName, registryClass] of registries) {\n    ffd20.registry[registryName] = new registryClass();\n  }\n\n  Object.defineProperty(ffd20.documents, \"customRolls\", {\n    value: function (message, speaker, rollData) {\n      foundry.utils.logCompatibilityWarning(\n        \"ffd20.documents.customRolls() is deprecated in favor of ffd20.chat.command()\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      const re = /^\\/(?<command>h|heal|d|damage)\\s+(?<formula>.*?)(\\s*#\\s*(?<comment>.*))?$/i.exec(message);\n      if (!re) throw new Error(`Failed to parse message: ${message}`);\n\n      const { command, formula, comment } = re.groups;\n      return ffd20.chat.command(command, formula, comment, { speaker, rollData });\n    },\n  });\n\n  Object.defineProperty(ffd20.registry, \"materialTypes\", {\n    get() {\n      foundry.utils.logCompatibilityWarning(\"ffd20.registry.materialTypes has been moved to ffd20.registry.materials.\", {\n        since: \"PF1 v11\",\n        until: \"PF1 v12\",\n      });\n      return ffd20.registry.materials;\n    },\n  });\n\n  // @deprecated - ffd20.config.measureTemplateTypes to CONFIG.MeasuredTemplate.types\n  Object.defineProperty(ffd20.config, \"measureTemplateTypes\", {\n    get() {\n      foundry.utils.logCompatibilityWarning(\n        \"ffd20.config.measureTemplateTypes is deprecated in favor of CONFIG.MeasuredTemplate.types\",\n        {\n          since: \"PF1 v11\",\n          until: \"PF1 v12\",\n        }\n      );\n\n      return ffd20.utils.internal.getTemplateTypes();\n    },\n  });\n\n  //Calculate conditions for world\n  CONFIG.statusEffects = ffd20.utils.init.getConditions();\n  // Add swim as special condition\n  CONFIG.specialStatusEffects.SWIM = \"swim\";\n\n  // Register controls\n  documents.controls.registerSystemControls();\n\n  // Register compendium browsers\n  ffd20.applications.compendiumBrowser.CompendiumBrowser.registerDefault();\n\n  // Delay pack preparation after babele is ready if it is in use\n  if (game.modules.get(\"babele\")?.active && game.settings.get(\"ffd20\", \"integration\").babele)\n    Hooks.once(\"babele.ready\", preparePacks);\n  else Hooks.once(\"ready\", preparePacks);\n\n  // Call post-init hook\n  Hooks.callAll(\"pf1PostInit\");\n});\n\n/**\n * Prepare pack related data.\n */\nfunction preparePacks() {\n  // Pre-load class ID map for better UX\n  console.debug(\"FFD20 | Pre-caching class ID map\");\n  ffd20.utils.packs.getClassIDMap();\n}\n\n// Load Quench test in development environment\nif (import.meta.env.DEV) {\n  await import(\"./module/test/index.mjs\");\n}\n\n/* -------------------------------------------- */\n/*  Foundry VTT Setup                           */\n/* -------------------------------------------- */\n\n// Pre-translation passes\nHooks.once(\"i18nInit\", function () {\n  // Localize ffd20.config objects once up-front\n  const toLocalize = [\n    \"abilities\",\n    \"abilitiesShort\",\n    \"alignments\",\n    \"alignmentsShort\",\n    \"currencies\",\n    \"distanceUnits\",\n    \"itemActionTypes\",\n    \"senses\",\n    \"skills\",\n    \"timePeriods\",\n    \"timePeriodsShort\",\n    \"durationEndEvents\",\n    \"savingThrows\",\n    \"ac\",\n    \"featTypes\",\n    \"featTypesPlurals\",\n    \"traitTypes\",\n    \"racialTraitCategories\",\n    \"raceTypes\",\n    \"conditionTypes\",\n    \"lootTypes\",\n    \"flyManeuverabilities\",\n    \"favouredClassBonuses\",\n    \"abilityTypes\",\n    \"weaponGroups\",\n    \"weaponTypes\",\n    \"weaponProperties\",\n    \"spellComponents\",\n    \"spellDescriptors\",\n    \"spellSchools\",\n    \"spellMultischools\",\n    \"spellSubschools\",\n    \"spellLevels\",\n    \"spellcasting\",\n    \"armorProficiencies\",\n    \"weaponProficiencies\",\n    \"actorSizes\",\n    \"abilityActivationTypes\",\n    \"abilityActivationTypesPlurals\",\n    \"limitedUsePeriods\",\n    \"equipmentTypes\",\n    \"equipmentSlots\",\n    \"implantSlots\",\n    \"implantTypes\",\n    \"consumableTypes\",\n    \"attackTypes\",\n    \"buffTypes\",\n    \"divineFocus\",\n    \"classSavingThrows\",\n    \"classBAB\",\n    \"classTypes\",\n    \"creatureTypes\",\n    \"creatureSubtypes\",\n    \"measureUnits\",\n    \"measureUnitsShort\",\n    \"languages\",\n    \"weaponHoldTypes\",\n    \"auraStrengths\",\n    \"conditionalTargets\",\n    \"bonusTypes\",\n    \"abilityActivationTypes_unchained\",\n    \"abilityActivationTypesPlurals_unchained\",\n    \"actorStatures\",\n    \"ammoTypes\",\n    \"damageResistances\",\n    \"vehicles\",\n    \"woundThresholdConditions\",\n    \"changeFlags\",\n    \"hauntTemplateLabels\",\n    \"traps\",\n    \"classBaseMPTypes\",\n    \"classSubTypes\",\n    \"classBaseMPauto\",\n    \"classCastingStats\",\n    \"countforexp\",\n    \"materia\",\n  ];\n\n  // Localize ffd20.const objects\n  const toLocalizeConst = [\"messageVisibility\"];\n\n  // Config (sub-)objects to be sorted\n  const toSort = [\n    \"bonusTypes\",\n    \"skills\",\n    \"traitTypes\",\n    \"racialTraitCategories\",\n    \"conditionTypes\",\n    \"consumableTypes\",\n    \"creatureTypes\",\n    \"creatureSubtypes\",\n    \"featTypes\",\n    \"weaponProperties\",\n    \"spellSchools\",\n    \"languages\",\n    \"spellMultischools\",\n  ];\n\n  /**\n   * Helper function to recursively localize object entries\n   *\n   * @param {object} obj - The object to be localized\n   * @param {string} cat - The object's name\n   * @returns {object} The localized object\n   */\n  const doLocalize = (obj, cat) => {\n    // Create tuples of (key, localized object/string)\n    const localized = Object.entries(obj).reduce((arr, [key, value]) => {\n      if (typeof value === \"string\") arr.push([key, game.i18n.localize(value)]);\n      else if (typeof value === \"object\") arr.push([key, doLocalize(value, `${cat}.${key}`)]);\n      return arr;\n    }, []);\n\n    if (toSort.includes(cat)) {\n      // Sort simple strings, fall back to sorting by label for objects/categories\n      localized.sort(([akey, aval], [bkey, bval]) => {\n        // Move misc to bottom of every list\n        if (akey === \"misc\") return 1;\n        else if (bkey === \"misc\") return -1;\n\n        // Regular sorting of localized strings\n        const localA = typeof aval === \"string\" ? aval : aval._label;\n        const localB = typeof bval === \"string\" ? bval : bval._label;\n        return localA.localeCompare(localB);\n      });\n    }\n\n    // Get the localized and sorted object out of tuple\n    return localized.reduce((obj, [key, value]) => {\n      obj[key] = value;\n      return obj;\n    }, {});\n  };\n\n  const doLocalizePaths = (obj, paths = []) => {\n    for (const path of paths) {\n      const value = foundry.utils.getProperty(obj, path);\n      if (value) {\n        foundry.utils.setProperty(obj, path, game.i18n.localize(value));\n      }\n    }\n  };\n\n  const doLocalizeKeys = (obj, keys = []) => {\n    for (const path of Object.keys(foundry.utils.flattenObject(obj))) {\n      const key = path.split(\".\").at(-1);\n      if (keys.includes(key)) {\n        const value = foundry.utils.getProperty(obj, path);\n        if (value) {\n          foundry.utils.setProperty(obj, path, game.i18n.localize(value));\n        }\n      }\n    }\n  };\n\n  // Localize and sort CONFIG objects\n  for (const o of toLocalize) {\n    ffd20.config[o] = doLocalize(ffd20.config[o], o);\n  }\n\n  for (const o of toLocalizeConst) {\n    ffd20.const[o] = doLocalize(ffd20.const[o], o);\n  }\n\n  // Localize buff targets\n  const localizeLabels = [\n    \"buffTargets\",\n    \"buffTargetCategories\",\n    \"contextNoteTargets\",\n    \"contextNoteCategories\",\n    \"ageCategories\",\n    \"vehicleMaterials\",\n  ];\n  for (const l of localizeLabels) {\n    for (const [k, v] of Object.entries(ffd20.config[l])) {\n      ffd20.config[l][k].label = game.i18n.localize(v.label);\n    }\n  }\n\n  // Extra attack structure\n  doLocalizeKeys(ffd20.config.extraAttacks, [\"label\", \"flavor\"]);\n\n  // Level-up data\n  doLocalizePaths(ffd20.config.levelAbilityScoreFeature, [\"name\", \"system.description.value\"]);\n\n  // Point buy data\n  doLocalizeKeys(ffd20.config.pointBuy, [\"label\"]);\n\n  // Caster type labels\n  doLocalizeKeys(ffd20.config.caster.type, [\"label\"]);\n  doLocalizeKeys(ffd20.config.caster.progression, [\"label\", \"hint\"]);\n\n  // Localize registry data\n  for (const registry of Object.values(ffd20.registry)) {\n    if (registry instanceof ffd20.registry.Registry) registry.localize();\n  }\n});\n\n/**\n * This function runs after game data has been requested and loaded from the servers, so documents exist\n */\nHooks.once(\"setup\", () => {\n  Hooks.callAll(\"pf1PostSetup\");\n});\n\n/* -------------------------------------------- */\n\n/**\n * Once the entire VTT framework is initialized, check to see if we should perform a data migration\n */\nHooks.once(\"ready\", async function () {\n  // Migrate data\n  const NEEDS_MIGRATION_VERSION = \"12.11.2.0\";\n  let PREVIOUS_MIGRATION_VERSION = game.settings.get(\"ffd20\", \"systemMigrationVersion\");\n  if (typeof PREVIOUS_MIGRATION_VERSION === \"number\") {\n    PREVIOUS_MIGRATION_VERSION = PREVIOUS_MIGRATION_VERSION.toString() + \".0\";\n  } else if (\n    typeof PREVIOUS_MIGRATION_VERSION === \"string\" &&\n    PREVIOUS_MIGRATION_VERSION.match(/^([0-9]+)\\.([0-9]+)$/)\n  ) {\n    PREVIOUS_MIGRATION_VERSION = `${PREVIOUS_MIGRATION_VERSION}.0`;\n  }\n  const needMigration = SemanticVersion.fromString(NEEDS_MIGRATION_VERSION).isHigherThan(\n    SemanticVersion.fromString(PREVIOUS_MIGRATION_VERSION)\n  );\n\n  if (needMigration) {\n    const options = {};\n    // Omit dialog for new worlds with presumably nothing to migrate\n    if (PREVIOUS_MIGRATION_VERSION === \"0.0.0.0\") options.dialog = false;\n    else console.debug(\"FFD20 | Migration |\", PREVIOUS_MIGRATION_VERSION, \"to\", game.system.version);\n\n    // Use lack of actors and items as soft block against new world migration\n    if (game.actors.size || game.items.size) {\n      await ffd20.migrations.migrateWorld(options);\n    } else {\n      if (game.user.isGM) {\n        // Set the migration as complete\n        await game.settings.set(\"ffd20\", \"systemMigrationVersion\", game.system.version);\n      }\n    }\n  }\n\n  // Inform users who aren't running migration\n  if (!game.user.isGM && game.settings.get(\"ffd20\", \"migrating\")) {\n    ui.notifications.warn(\"FFD20.Migration.InProgress\", { localize: true });\n  }\n\n  // Migrate system settings\n  await documents.settings.migrateSystemSettings();\n\n  // Populate `ffd20.applications.compendiums`\n  ffd20.applications.compendiumBrowser.CompendiumBrowser.initializeBrowsers();\n\n  // Show changelog\n  if (!game.settings.get(\"ffd20\", \"dontShowChangelog\")) {\n    const v = game.settings.get(\"ffd20\", \"changelogVersion\");\n    const changelogVersion = SemanticVersion.fromString(v);\n    const curVersion = SemanticVersion.fromString(game.system.version);\n\n    if (curVersion.isHigherThan(changelogVersion)) {\n      const app = new ffd20.applications.ChangeLogWindow(true);\n      app.render(true, { focus: true });\n      game.settings.set(\"ffd20\", \"changelogVersion\", curVersion.toString());\n    }\n  }\n\n  Hooks.callAll(\"pf1PostReady\");\n});\n\n/* -------------------------------------------- */\n/*  Other Hooks                                 */\n/* -------------------------------------------- */\n\nHooks.on(\n  \"renderChatMessage\",\n  /**\n   * @param {ChatMessage} cm - Chat message instance\n   * @param {JQuery<HTMLElement>} jq - JQuery instance\n   * @param {object} options - Render options\n   */\n  (cm, jq, options) => {\n    const html = jq[0];\n\n    // Hide roll info\n    chatUtils.hideRollInfo(cm, jq, options);\n\n    // Hide GM sensitive info\n    chatUtils.hideGMSensitiveInfo(cm, html, options);\n\n    // Display placeholder if no description is present.\n    const desc = html.querySelector(\".card-content .item-description\");\n    if (desc && !desc.textContent.trim()) {\n      desc.append(game.i18n.localize(\"FFD20.NoDescription\"));\n    }\n\n    // Hide non-visible targets for players\n    if (!game.user.isGM) chatUtils.hideInvisibleTargets(cm, html);\n\n    // Create target callbacks\n    chatUtils.addTargetCallbacks(cm, jq);\n\n    // Alter target defense options\n    chatUtils.alterTargetDefense(cm, jq);\n\n    // Optionally collapse the content\n    if (game.settings.get(\"ffd20\", \"autoCollapseItemCards\")) {\n      html.querySelector(\".card-content\")?.classList.add(\"hidden\");\n    }\n\n    // Optionally hide chat buttons\n    if (game.settings.get(\"ffd20\", \"hideChatButtons\")) {\n      for (const button of html.querySelectorAll(\".card-buttons\")) button.remove();\n    }\n\n    // Alter ammo recovery options\n    chatUtils.alterAmmoRecovery(cm, jq);\n  }\n);\n\nHooks.on(\"renderChatMessage\", (cm, [html]) => ffd20.utils.chat.addListeners(cm, html));\nHooks.on(\"renderChatMessage\", (_, html) => _canvas.attackReach.addReachListeners(html));\n\nHooks.on(\"renderActorDirectory\", (app, html) => {\n  if (html instanceof jQuery) html = html[0]; // v12/v13 cross compatibility\n  for (const li of html.querySelectorAll(\"li.actor\")) {\n    li.addEventListener(\n      \"drop\",\n      ffd20.applications.CurrencyTransfer._directoryDrop.bind(undefined, li.getAttribute(\"data-document-id\"))\n    );\n  }\n});\n\nHooks.on(\"renderItemDirectory\", (app, html) => {\n  if (html instanceof jQuery) html = html[0]; // v12/v13 cross compatibility\n  for (const li of html.querySelectorAll(\"li.item\")) {\n    li.addEventListener(\n      \"drop\",\n      applications.CurrencyTransfer._directoryDrop.bind(undefined, li.getAttribute(\"data-document-id\"))\n    );\n  }\n});\n\nHooks.on(\"dropActorSheetData\", (act, sheet, data) => {\n  if (data.type === \"Currency\") {\n    sheet._onDropCurrency(event, data);\n    return false;\n  }\n});\n\n/* -------------------------------------------- */\n/*  Hotbar Macros                               */\n/* -------------------------------------------- */\n\n// Delay hotbarDrop handler registration to allow modules to override it.\nHooks.once(\"ready\", () => {\n  Hooks.on(\"hotbarDrop\", (bar, data, slot) => {\n    let macro;\n    const { type, uuid } = data;\n    switch (type) {\n      case \"Item\":\n        macro = macros.createItemMacro(uuid, slot);\n        break;\n      case \"pf1Action\":\n        macro = macros.createActionMacro(uuid, slot);\n        break;\n      case \"skill\":\n        macro = macros.createSkillMacro(data.skill, uuid, slot);\n        break;\n      case \"save\":\n        macro = macros.createSaveMacro(data.save, uuid, slot);\n        break;\n      case \"defenses\":\n      case \"cmb\":\n      case \"concentration\":\n      case \"cl\":\n      case \"attack\":\n      case \"abilityScore\":\n      case \"initiative\":\n      case \"bab\":\n        macro = macros.createMiscActorMacro(type, uuid, slot, data);\n        break;\n      default:\n        return true;\n    }\n\n    if (macro == null || macro instanceof Promise) return false;\n  });\n});\n\n// Render TokenConfig\nHooks.on(\n  \"renderTokenConfig\",\n  /**\n   * @param {TokenConfig} app - Config application\n   * @param {JQuery<HTMLElement>} html - HTML element\n   */\n  async (app, html) => {\n    // Add vision inputs\n    let token = app.document ?? app.object;\n    // Prototype token\n    if (token instanceof Actor) token = token.prototypeToken;\n\n    const flags = token.flags?.ffd20 ?? {};\n\n    // Add static size checkbox\n    const sizingTemplateData = { flags, appId: app.id };\n    const sizeContent = await renderTemplate(\n      \"systems/ffd20/templates/foundry/token/token-sizing.hbs\",\n      sizingTemplateData\n    );\n\n    const systemVision = game.settings.get(\"ffd20\", \"systemVision\");\n\n    /** @type {HTMLElement} */\n    html = html instanceof jQuery ? html[0] : html;\n\n    html\n      .querySelector('.tab[data-tab=\"appearance\"] input[name=\"width\"]')\n      .closest(\".form-group\")\n      .insertAdjacentHTML(\"afterEnd\", sizeContent);\n\n    const visionTab = html.querySelector(`.tab[data-tab=\"vision\"]`);\n\n    // Disable vision elements if custom vision is disabled\n    const enableCustomVision = flags.customVisionRules === true || !systemVision;\n\n    const toggleCustomVision = (enabled) => {\n      // Disable vision mode selection\n      visionTab.querySelector(\"select[name='sight.visionMode']\").disabled = !enabled;\n\n      // Disable detection mode tab\n      let dmTab;\n      if (game.release.generation >= 13)\n        dmTab = visionTab.querySelector(\".detection-mode\").parentElement; // V12 and prior\n      else dmTab = visionTab.querySelector(\".tab[data-tab='detection']\");\n\n      for (const el of dmTab.querySelectorAll(\"input,select\")) {\n        if (el.name === \"flags.ffd20.customVisionRules\") continue;\n        el.disabled = !enabled;\n      }\n\n      // Disable detection mode tab buttons via CSS\n      // TODO: Apply inert property instead\n      dmTab.classList.toggle(\"disabled\", !enabled);\n    };\n\n    if (!enableCustomVision) toggleCustomVision(enableCustomVision);\n\n    const visionContent = await renderTemplate(\"systems/ffd20/templates/foundry/token/custom-vision.hbs\", {\n      enabled: enableCustomVision || !systemVision,\n      noSystemVision: !systemVision,\n      appId: app.id,\n    });\n\n    visionTab.insertAdjacentHTML(\"beforeEnd\", visionContent);\n\n    // Add listener for custom vision rules checkbox\n    // Soft toggle to work nicer with Foundry's preview behaviour\n    visionTab.querySelector(`input[name=\"flags.ffd20.customVisionRules\"]`).addEventListener(\"change\", async (event) => {\n      toggleCustomVision(event.target.checked);\n    });\n\n    // Resize windows\n    app.setPosition();\n  }\n);\n\n// V13\nHooks.on(\"renderSettings\", (app, html) => {\n  if (!(game.release.generation >= 13)) return;\n  if (!(app instanceof CONFIG.ui.settings)) return;\n\n  const template = document.createElement(\"template\");\n  template.innerHTML = `<section class=\"flexcol\" id=\"pf1-details\">\n    <h4 class=\"divider\">${game.i18n.localize(\"FFD20.Title\")}</h4>\n    <button type=\"button\" data-action=\"pf1-changelog\">${game.i18n.localize(\"FFD20.Application.Changelog.Title\")}</button>\n    <button type=\"button\" data-action=\"pf1-documentation\">${game.i18n.localize(\"FFD20.Help.Label\")}</button>\n    <button type=\"button\" data-action=\"pf1-troubleshooter\">${game.i18n.localize(\"FFD20.Troubleshooter.Button\")}</button>\n  </section>`;\n\n  Object.assign(app.options.actions, {\n    \"pf1-changelog\": () => {\n      const chlog =\n        Object.values(ui.windows).find((app) => app instanceof applications.ChangeLogWindow) ??\n        new applications.ChangeLogWindow();\n      chlog.render(true, { focus: true });\n    },\n    \"pf1-documentation\": () => ffd20.applications.helpBrowser.openUrl(\"Help/Home\"),\n    \"pf1-troubleshooter\": () => ffd20.applications.Troubleshooter.open(),\n  });\n\n  const details = html.querySelector(\"section.info\");\n  details.after(template.content);\n});\n\n// Render Sidebar (V12 and prior)\nHooks.on(\"renderSidebarTab\", (app, html) => {\n  if (!(app instanceof Settings)) return;\n\n  const details = document.getElementById(\"game-details\");\n\n  const template = document.createElement(\"template\");\n  template.innerHTML = `<h2>${game.i18n.localize(\"FFD20.Title\")}</h2>\n  <div id='pf1-details'>\n    <button type=\"button\" data-action=\"pf1-changelog\">${game.i18n.localize(\"FFD20.Application.Changelog.Title\")}</button>\n    <button type=\"button\" data-action=\"pf1-documentation\">${game.i18n.localize(\"FFD20.Help.Label\")}</button>\n    <button type=\"button\" data-action=\"pf1-troubleshooter\">${game.i18n.localize(\"FFD20.Troubleshooter.Button\")}</button>\n  </div>`;\n\n  for (const button of template.content.querySelectorAll(\"button\")) {\n    switch (button.dataset.action) {\n      case \"pf1-changelog\":\n        button.addEventListener(\"click\", (ev) => {\n          ev.preventDefault();\n          const chlog =\n            Object.values(ui.windows).find((app) => app instanceof applications.ChangeLogWindow) ??\n            new applications.ChangeLogWindow();\n          chlog.render(true, { focus: true });\n        });\n        break;\n      case \"pf1-documentation\":\n        button.addEventListener(\"click\", (ev) => {\n          ev.preventDefault();\n          ffd20.applications.helpBrowser.openUrl(\"Help/Home\");\n        });\n        break;\n      case \"pf1-troubleshooter\":\n        button.addEventListener(\"click\", (ev) => {\n          ev.preventDefault();\n          ffd20.applications.Troubleshooter.open();\n        });\n        break;\n    }\n  }\n\n  details.after(template.content);\n});\n\nHooks.on(\"controlToken\", () => {\n  // Refresh lighting to (un)apply low-light vision parameters to them\n  canvas.perception.update(\n    {\n      initializeLighting: true,\n    },\n    true\n  );\n});\n\n/* ------------------------------- */\n/* Expire active effects\n/* ------------------------------- */\n\n/**\n * Expire Active Effects from Tokens\n *\n * Triggers duration end handling of active effects on currently viewed scene.\n *\n * Called with `updateWorldTime` and `canvasReady` events.\n */\nfunction expireFromTokens() {\n  if (!game.users.activeGM?.isSelf) return;\n\n  for (const t of canvas.tokens.placeables) {\n    if (!t.actor) continue;\n\n    // Skip tokens in combat to avoid too early expiration\n    if (t.combatant?.combat?.started) continue;\n\n    try {\n      t.actor.expireActiveEffects();\n    } catch (err) {\n      console.error(`FFD20 | Failed to expire active effects from token: ${t.name} [${t.document?.uuid}]\\n`, err);\n    }\n  }\n}\n\n// On game time change\nHooks.on(\"updateWorldTime\", () => expireFromTokens());\n\n// On canvas render\nHooks.on(\"canvasReady\", () => expireFromTokens());\n\n// Ensure correct token sizing\nHooks.on(\"canvasReady\", async (canvas) => {\n  if (!game.user.isGM) return;\n\n  /** @type {TokenDocument[]} */\n  const tokens = canvas.scene?.tokens.filter((t) => t.actor);\n  if (!tokens.length) return;\n\n  console.debug(\"FFD20 | Ensuring correct sizing of\", tokens.length, \"tokens(s)...\");\n  for (const token of tokens) {\n    const actor = token.actor;\n\n    try {\n      actor._updateTokenSize?.();\n    } catch (err) {\n      console.error(\"FFD20 | Failed to adjust token size for\", token.name, \"\\n\", actor, \"\\n\", err);\n    }\n  }\n});\n\n// Refresh skip state (alleviates sticky modifier issue #1572)\nwindow.addEventListener(\"focus\", () => (ffd20.skipConfirmPrompt = false), { passive: true });\n","/**\n * Initialize module compatibility/integration code.\n *\n * Currently integrated modules:\n * - Drag Ruler\n * - DSN (scattered game.dice3d usage)\n */\nexport function initializeModuleIntegration() {\n  const integration = game.settings.get(\"ffd20\", \"integration\");\n  // Drag Ruler <https://foundryvtt.com/packages/drag-ruler>\n  if (game.modules.get(\"drag-ruler\")?.active && integration.dragRuler) {\n    Hooks.once(\"dragRuler.ready\", (SpeedProvider) => {\n      class Pf1SpeedProvider extends SpeedProvider {\n        get colors() {\n          return [\n            { id: \"walk\", default: 0x00ff00, name: \"FFD20.SETTINGS.DragRulerWalk\" },\n            { id: \"dash\", default: 0xffff00, name: \"FFD20.SETTINGS.DragRulerDash\" },\n            { id: \"run\", default: 0xff8000, name: \"FFD20.SETTINGS.DragRulerRun\" },\n          ];\n        }\n\n        getRanges(token) {\n          const baseSpeed = ffd20.utils.convertDistance(this.getBaseSpeed(token))[0];\n          const rollData = token.actor.getRollData(),\n            inHeavyArmor = rollData.armor.type >= ffd20.config.armorTypes.heavy,\n            inHeavyLoad = rollData.attributes.encumbrance.level >= ffd20.config.encumbranceLevels.heavy;\n\n          let runMultiplier = 4;\n          if (inHeavyArmor || inHeavyLoad) runMultiplier = 3;\n          return [\n            { range: baseSpeed, color: \"walk\" },\n            { range: baseSpeed * 2, color: \"dash\" },\n            { range: baseSpeed * runMultiplier, color: \"run\" },\n          ];\n        }\n\n        getBaseSpeed(token) {\n          //const { i: x, j: y } = canvas.grid.getOffset(token);\n          const useElevation = this.getSetting(\"useElevation\");\n          const speeds = token.actor.system.attributes.speed;\n\n          if (useElevation && token.document.elevation > 0) {\n            const flySpeed = speeds.fly.total;\n            if (flySpeed > 0) {\n              return flySpeed;\n            }\n          }\n\n          if (useElevation && token.document.elevation < 0) {\n            const burrowSpeed = speeds.burrow.total;\n            if (burrowSpeed > 0) {\n              return burrowSpeed;\n            }\n          }\n\n          return speeds.land.total;\n        }\n\n        get settings() {\n          return [\n            {\n              id: \"useElevation\",\n              name: \"FFD20.SETTINGS.DragRulerUseElevationName\",\n              hint: \"FFD20.SETTINGS.DragRulerUseElevationHint\",\n              scope: \"world\",\n              type: Boolean,\n              default: true,\n            },\n          ];\n        }\n      }\n\n      /* global dragRuler */\n      dragRuler.registerSystem(\"ffd20\", Pf1SpeedProvider);\n    });\n  }\n}\n"],"names":["origFunc","TextEditor","_createContentLink","async","match","relativeTo","name","a","call","this","indexOf","args","split","label","pop","length","forEach","o","key","value","firstChild","className","classList","add","setAttribute","lastChild","textContent","Roll","fromData","data","includes","class","original_handleShareImage","ImagePopout","_handleShareImage","image","title","caption","uuid","showTitle","doc","fromUuid","Item","KeyboardManager","prototype","_onFocusIn","event","formElements","HTMLInputElement","HTMLSelectElement","HTMLTextAreaElement","HTMLOptionElement","target","isContentEditable","some","cls","releaseKeys","Object","defineProperty","get","selector","map","el","join","document","querySelectorAll","buttons","spells","items","bestiary","feats","classes","races","buffs","wide","compendiumButtonClick","preventDefault","type","dataset","category","ffd20","applications","compendiums","_render","focus","Hooks","on","app","html","element","jQuery","game","release","generation","createElement","append","querySelector","info","entries","button","innerText","i18n","localize","addEventListener","entryOptions","unshift","icon","condition","li","pack","packs","config","disabled","callback","configure","getMessage","messages","messageId","isOwnedSpellCard","msg","item","itemSource","isOwner","actor","spellCardContextMenu","_","id","fromUuidSync","system","reference","ChatMessage","closest","parentElement","scrollIntoView","block","rollConcentration","spellbook","rollCL","isValidChangeTarget","filters","valid","ar","include","exclude","fn","ir","getBuffTargets","buffTargets","foundry","utils","deepClone","contextNotes","contextNoteTargets","allowSkills","buffTargetCategories","skills","skillTargets","_skillTargets","s","skillId","slice","startsWith","skill","getSkillInfo","fullName","allowSpells","spell","books","attributes","spellbooks","primary","secondary","tertiary","quaternary","spelllike","spellTargets","_spellbookTargets","schoolId","keys","spellSchools","push","re","exec","subKey","groups","subLabel","fullKey","mainLabel","concn","moduleToObject","module","result","toString","initialValue","cmdStr","maxValue","clearValue","op","operator","abs","rawValue","isAbsolute","isNegative","parseInt","parseFloat","Number","isFinite","Math","min","isNaN","console","warn","initial","command","createInlineFormula","rollData","_options","formula","closing","_createInlineRoll","rollCls","defaultImplementation","resolvedFormula","replaceFormulaData","trim","pLabel","roll","isDeterministic","evaluateSync","total","simplify","tooltip","innerHTML","parent","relative","parseUuid","embedded","itemId","Error","getBuffTargetDictionary","targetCategories","contextNoteCategories","categories","values","reduce","cur","options","validity","naturalSort","getTemplateTypes","fromEntries","CONST","MEASURED_TEMPLATE_TYPES","CONFIG","MeasuredTemplate","types","keepUpdateArray","sourceObj","targetObj","keepPath","newValue","getProperty","Array","isArray","newArray","getType","subData","expandObject","mergeObject","setProperty","setDefaultSceneScaling","scaling","units","getDistanceSystem","grid","distance","defaults","width","inputArr","elem","toLocaleLowerCase","numeric","ignorePunctuation","uniformUuid","runSocketFunction","senderId","isFirstGM","users","activeGM","isSelf","sender","eventType","source","sourceActor","dest","destActor","sourceContainer","destContainer","amount","CurrencyTransfer","transfer","sourceAlt","destAlt","alterChatTargetAttribute","message","contentHTML","$","content","save","valueElem","find","targetUuid","isFailure","addClass","removeClass","isSuccess","update","prop","testUserPermission","targetActor","itemData","toObject","implementation","create","deleteEmbeddedDocuments","hasPermission","USER_PERMISSIONS","SETTINGS_MODIFY","refreshActors","renderOnly","err","log","SemanticVersion","static","constructor","fversion","major","minor","patch","preRelease","buildMetaData","fromString","str","RegExp","$1","$2","$3","$4","$5","$6","isHigherThan","otherVersion","isLowerThan","isSame","findOldMacro","macros","m","canExecute","visible","isAuthor","createItemMacro","slot","macro","Macro","img","flags","displaySheet","user","assignHotbarMacro","createActionMacro","_slot","action","logCompatibilityWarning","since","until","actions","ui","notifications","error","format","actionMacro","createSkillMacro","skillInfo","createSaveMacro","saveId","saveName","capitalize","createMiscActorMacro","getBookLabel","bookId","book","attack","isMelee","ability","abilities","hideRollInfo","cm","jq","whisper","isBlind","blind","text","addExtraGMInfo","isGM","metadata","identified","cardContent","insertAdjacentHTML","getIdentifiedBlock","hasUniqueActionName","renderTemplate","hideGMSensitiveInfo","gmSensitiveUuid","obj","Token","TokenDocument","remove","showDCs","settings","getSpeakerActor","speaker","DOCUMENT_OWNERSHIP_LEVELS","OBSERVER","node","childNodes","nodeName","children","sensitiveLabel","gmSensitiveInner","inlineEls","fromJSON","unescape","nroll","safeRollSync","escape","JSON","stringify","results","rollEls","replaceChildren","filter","contains","tagName","detailEls","alterAmmoRecovery","recoveryData","getFlag","each","attackIndex","index","ammoId","recovered","i","ia","alterTargetDefense","defenseData","targetEl","targetDefense","saveEl","savingThrow","hideInvisibleTargets","recursive","targetsElem","canvas","ready","once","targetElems","targets","from","hasVisible","t","token","object","isVisible","isObserver","isSecret","getTokenByUuid","addTargetCallbacks","_mouseEnterCallback","_onHoverIn","hoverOutOthers","_mouseLeaveCallback","_onHoverOut","_imageClickCallback","toggle","shiftKey","controlled","chat","panToToken","control","releaseOthers","imgElem","ev","passive","targetACClick","targetSavingThrowClick","addListeners","onToggleDescription","onButton","currentTarget","buttonActionId","getLinkedItem","asNonlethal","asManaDamage","nonlethal","manadamage","attackType","systemRolls","attacks","isCritical","instances","addInstances","damageRolls","dmg","d","models","DamagePartModel","damageType","damage","critDamage","documents","ActorPF","applyDamage","critMult","ammoItem","ammoQuantity","ammoRecovery","failed","chance","recoverChance","random","promises","addCharges","setFlag","Promise","all","count","as","dc","actors","tokens","character","noSound","errored","rollSavingThrow","catch","cause","getConcentrationDC","compendiumEntry","openJournal","desc","_collapsedDescription","popout","windows","appid","setPosition","duration","animatePan","center","_event","displayDefenseCard","rollMode","ActorBasePF","Actor","getDefaultArtwork","actorData","super","defaultIcons","texture","src","reset","_itemTypes","_rollData","_initialized","_initialize","getItemByTag","tag","itemTypes","defineProperties","getName","getId","identifier","activeOwner","u","active","sort","b","getCombatants","combat","combatants","c","sharesVision","visionFlag","shared","default","_effectsWithDuration","effects","effect","allApplicableEffects","_hasDuration","toggleStatusEffect","statusId","overlay","buffId","buff","isActive","state","setActive","getConditionImmunities","ci","traits","list","Set","condToImmMap","confuse","daze","dazzle","fatigue","fear","registry","conditions","conditionsInTrack","sicken","paralyze","petrify","stun","has","cond","getInitiativeOptions","expireActiveEffects","ActorPFProxy","Proxy","construct","documentClasses","ItemBasePF","createDialog","left","top","position","CreateDialog","waitPrompt","defaultName","subType","documentName","collection","getEmbeddedCollection","collections","takenNames","baseNameKey","hasTypeData","typeNameKey","subtypeName","typeLabels","baseName","_onCreateOperation","operation","syntheticActor","_id","casting","bookData","p","createSpellbook","level","_onLevelChange","_updateTrackingEffect","speeds","speedUpdates","const","movementKeys","base","fly","maneuverability","flyManeuverability","_pf1NoSupplements","_createSupplements","_onUpdateOperation","changed","updates","oldLevel","newLevel","_pf1SizeChanged","size","_onDeleteOperation","prevLevel","usedBook","inUse","race","allSupplements","Collection","t0","performance","now","collect","classLink","_depth","supplements","links","t1","debug","newItemData","supplement","extraItem","fromCompendium","clearFolder","old","set","newItem","lastSortOrder","createData","isPhysical","quantity","oldItemsOfSameType","max","MIN_SAFE_INTEGER","SORT_INTEGER_DENSITY","newItems","createEmbeddedDocuments","render","allItems","internal","si","getRelativeUUID","updateEmbeddedDocuments","forcePlayerPerspective","activeState","context","canUse","getEmbeddedDocument","embeddedName","changes","ItemPFProxy","PF1Tour","Tour","apps","previousStep","hasPrevious","steps","stepIndex","sheetInDisplay","ActorSheet","StepsEnum","step","replaceAll","toUpperCase","getStepIndexById","findIndex","openCompendiumBrowser","compendium","comp","openCompendium","strict","compApp","applicationClass","closeCompendium","compApps","compendiumBrowser","CompendiumBrowser","Compendium","_debug","close","_log","loglevel","namespace","currentStep","_warn","expandCompendiumFolder","folder","clickFolder","expanded","folderEl","click","_preStep","sheetTab","tabName","group","activateTab","PF1ActorSheetTour","openSheet","compendiumId","getDocument","actorId","sheet","start","sidebar","tabs","activate","previous","GO_TO_BASIC_MONSTERS","_postStep","HIGHLIGHT_STREET_MAGICIAN_IN_COMPENDIUM","exit","HIGHLIGHT_SHEET","SPELLBOOKS_CONFIGURATION","targetElement","complete","registerPF1Tours","tours","register","costlessActivation","currency","rate","pp","gp","sp","standard","standardRate","casterProgression","castsPerDay","prepared","low","med","high","spontaneous","hybrid","prestige","spellsPreparedPerDay","spellMultischools","crn","drk","ele","enf","enh","heal","ill","lit","nec","nel","sum","uni","misc","spellMultischoolsMap","multi","spellSubschools","charm","compulsion","divination","figment","glamer","pattern","phantasm","polymorph","scrying","shadow","teleportation","spellSubschoolsMap","acpA","acpS","mDexA","mDexS","dex","con","int","wis","cha","strMod","dexMod","conMod","intMod","wisMod","chaMod","strPen","dexPen","conPen","intPen","wisPen","chaPen","carryStr","carryMult","simple","reach","ageCategory","ageCategoryPhysical","ageCategoryMental","deferred","unskills","strSkills","dexSkills","conSkills","intSkills","wisSkills","chaSkills","allChecks","strChecks","dexChecks","conChecks","intChecks","wisChecks","chaChecks","landSpeed","climbSpeed","swimSpeed","burrowSpeed","flySpeed","allSpeeds","ac","aac","sac","nac","tac","ffac","bab","wattack","sattack","mattack","nattack","rattack","tattack","wdamage","mwdamage","rwdamage","twdamage","rdamage","mdamage","ndamage","sdamage","critConfirm","allSavingThrows","fort","ref","will","cmb","cmd","ffcmd","init","mhp","wounds","vigor","mmp","mprec","spellResist","bonusFeats","bonusSkillRanks","concentration","cl","sensedv","sensets","sensebse","sensebs","sensels","sensesc","sensetr","defense","savingThrows","abilityChecks","health","speed","senses","sheetSections","interface","browse","classType","weapon","hideEmpty","weaponLike","subTypes","proficient","natural","classFeat","feat","racial","racialAbility","equipment","consumable","inventory","equip","armor","slots","equipmentType","equipmentSubtype","materia","slotted","rarity","implants","labels","gear","unequippableLoot","ammo","lootType","tradeGoods","container","features","featType","trait","template","buffType","perm","temp","school","combatlite","catKey","sectKey","section","path","iface","slow","medium","fast","noncaster","halfCaster","dimPacman","pacman","dimFullCaster","fullCaster","advFullCaster","nonaction","free","swift","immediate","move","full","aoo","round","minute","hour","special","reaction","oh","na","long","short","ex","su","normal","touch","flatFooted","fine","dim","tiny","sm","lg","huge","grg","col","tall","young","modifiers","adult","middleAge","venerable","ng","cg","ln","tn","cn","le","ne","ce","arrow","bolt","repeatingBolt","slingBullet","gunBullet","dragoonBullet","dart","siege","humanoid","nonhumanoid","lgt","hvy","shl","twr","none","light","heavy","untyped","untypedPerm","dodge","haste","inherent","deflection","morale","luck","sacred","insight","resist","profane","competence","circumstance","alchemical","progression","lowLightVision","seeInDarkness","seeInvisibility","immuneToMorale","loseDexToAC","noMediumEncumbrance","noHeavyEncumbrance","mediumArmorFullSpeed","heavyArmorFullSpeed","custom","no","yes","half","astrologian","blackmage","bluemage","geomancer","illusionist","necromancer","summoner","timemage","whitemage","bard","cleric","redmage","scholar","darkknight","holyknight","intAndWis","goodSaveBonus","goodSave","npc","mythic","core","coreArc","baseArc","hybridArc","antagonized","berserk","bleed","burning","charmed","cowering","cursed","deaf","deathEffects","deprotect","deshell","dimmed","disease","doom","drenched","energyDrain","entangled","exhausted","fascinated","frightened","frog","frozen","immobilized","imperil","invisible","moraleEffects","mindAffecting","mini","nauseated","panicked","poison","prone","sapped","shaken","silenced","sleep","squalled","staggered","stop","weighted","unlucky","zombie","_label","allAttack","hasteAttack","rapidShotAttack","allDamage","hasteDamage","rapidShotDamage","potion","oil","drug","alchContact","alchIngested","alchInhaled","scroll","wand","rod","staff","pharmaceutical","critical","melee","meleeWeapon","meleeSpell","ranged","rangedWeapon","rangedSpell","spellEffect","sr","exp","noExp","aegyl","albhed","amaljaa","antica","aquatic","archfiend","aura","avian","bangaa","bomb","boss","burmecian","centaur","cieth","clockwork","daemon","demon","devil","dracobaltian","dwarf","earth","elemental","elvaan","extraplanar","fire","forgiven","galka","garif","garlean","genome","giant","gnath","goblin","goblinoid","gria","guado","halfbreed","halfgigas","holy","hume","hypello","ice","immortal","incorporeal","ixal","kindred","kobold","kojin","lambkin","lamia","lightning","livingconstruct","lizardman","loporrit","machina","mandragora","matanga","merfolk","miniboss","mithra","moogle","moomba","namazu","native","nonelemental","numou","orc","palico","primal","pupu","qiqirn","qu","quadav","reptilian","roegadyn","ronso","sahagin","seeq","setolion","shindroid","sineater","superboss","sylph","syricta","tarutaru","tonkin","vanuvanu","varg","viera","water","wind","yagudo","aberration","animal","dragon","fey","magicalBeast","monstrousHumanoid","ooze","outsider","plant","undead","vermin","cp","lawful","chaotic","good","evil","loot","haunt","basic","trap","vehicle","personal","ft","mi","spec","seeText","unlimited","turnStart","initiative","turnEnd","quadruped","shield","wondrous","slotless","head","headband","eyes","shoulders","neck","chest","body","belt","wrists","hands","ring","feet","clothing","any","weaponarmor","armorShield","other","lightArmor","mediumArmor","heavyArmor","lightShield","heavyShield","towerShield","independent","summon","support","iteratives","manual","advanced","flurry","bonus","attackName","flavor","modToAll","unflurry","hp","alt","deltas","positive","negative","abilityScore","clumsy","poor","average","perfect","belligerent","itemBound","chained","elusive","freeRoaming","increasedArea","latent","persistent","possessing","spiteful","tenacious","unyielding","vaporous","variant","cr","crBonus","crBonusTag","cybertech","arm","brain","ears","legs","mwak","rwak","twak","msak","rsak","mcman","rcman","spellsave","hardness","common","dwarven","galkan","lalafellan","mithran","aegyllan","albhedian","banganese","draconic","lupin","mandragoran","numish","queran","ronsaur","tonberry","vieran","celestial","infernal","abyssal","aquan","auran","auroran","enochian","ignan","terran","thorian","umbran","antican","orcish","sylvan","undercommon","vanu","description","single","day","week","charges","tool","food","herb","adventuring","animalGear","reagent","remedy","treasure","entertainment","power","Rarity","uncommon","rare","legendary","RarityMath","Slot","unslotted","Attuned","unattuned","attuned","km","penalty","overlandSpeed","imperial","per","out","unit","metric","rounded","exact","hours","double","points","epic","beastman","monstrous","featSkills","magical","movement","offense","weakness","alternate","traitSeparator","bs","bse","dv","ts","tr","ll","ls","sid","sc","tower","acr","apr","blf","clm","crf","dip","dev","dis","dri","esc","han","hea","kar","kdu","ken","kge","khi","klo","kna","kno","kpl","kre","kte","lin","nav","prf","pil","pro","rep","rid","sen","slt","spl","ste","sur","swm","umd","verbal","somatic","thought","emotion","material","divineFocus","acid","air","cold","curse","darkness","death","electricity","force","languageDependent","meditative","pain","ruse","sonic","inst","turn","month","year","w","h","scale","minChoicesForSearch","magic","faith","social","campaign","cosmic","exemplar","faction","family","mount","region","religion","drawback","electricEyes","sound","vision","arcaneEye","clairvoyance","trueSeeing","bypass","lock","hiddenSwitch","hiddenLock","automatic","repair","trigger","genetic","location","proximity","timed","visual","mechanical","darkvision","leather","wood","stone","metal","space","land","sea","axes","bladesHeavy","bladesLight","bows","crossbows","firearms","flails","hammers","monk","polearms","siegeEngines","spears","thrown","tribal","martial","exotic","firearm","chef","ato","blc","brc","dea","dst","dbl","fin","frg","grp","imp","mnk","nnl","rch","sct","sma","slf","snd","spc","thr","trp","assault","indirect","direct","splash","publicroll","gmroll","blindroll","selfroll","BaseFilter","choices","randomID","writable","configurable","registerIndexFields","handledTypes","choice","activeChoiceCount","indexField","compendiumIndexFields","setup","prepareChoices","hasChoices","number","applyFilter","entry","getData","TEMPLATE","localizeLabel","activeCount","contents","field","activateListeners","root","UMD","prepare","prepareLowerInfo","new_result","_targetLower","_lower","_targetLowerCodes","lowerCodes","_bitflags","bitflags","Result","_indexes","len","indexes","open","targetLen","highlighted","matchI","indexesI","opened","parts","char","substr","highlight","normalizeScore","_score","score","denormalizeScore","KeysResult","NULL","NEGATIVE_INFINITY","_nextBeginningIndexes","E","normalizedScore","pow","prepareSearch","search","spaceSearches","containsSpace","searches","_info","toLowerCase","getPrepared","targetPrepared","preparedCache","getPreparedSearch","searchPrepared","preparedSearchCache","limit","INFINITY","getValue","isPrepared","objResults","keyI","noTarget","algorithm","preparedSearch","allowSpaces","allowPartialMatch","algorithmSpaces","searchLower","searchLowerCodes","searchLowerCode","targetLowerCodes","searchLen","searchI","targetI","matchesSimpleLen","matchesSimple","successStrict","matchesStrictLen","nextBeginningIndexes","prepareNextBeginningIndexes","backtrackCount","lastMatch","matchesStrict","substringIndex","isSubstring","isSubstringBeginning","calculateScore","matches","extraMatchGroupCount","uniqueBeginningIndexes","matchesBest","seen_indexes","first_seen_index_last_search","searchesLen","changeslen","resetNextBeginningIndexes","nextBeginningIndexesChanges","hasAtLeast1Match","allowPartialMatchScores","indexesIsConsecutiveSubstring","newBeginningIndex","toReplace","j","allowSpacesResult","remove_accents","replace","normalize","strLen","lower","lowerCode","charCodeAt","beginningIndexes","beginningIndexesLen","wasUpper","wasAlphanum","targetCode","isUpper","isAlphanum","isBeginning","prepareBeginningIndexes","lastIsBeginning","lastIsBeginningI","Map","keysSpacesBestScores","tmpTargets","tmpResults","tmp","segs","x","Infinity","noResults","e","v","q","r","f","poll","peek","replaceTop","searchBitflags","go","threshold","resultsLen","limitedCount","targetsLen","push_result","keysLen","outer","keysBitflags","scoreFn","cleanup","clear","exports","Application","expandedFilters","_query","_loadingInfo","initialize","_debouncedRender","debounce","defaultOptions","height","window","innerHeight","resizable","scrollY","dragDrop","dragSelector","dropSelector","registerDefault","BROWSERS","ItemBrowser","FeatBrowser","SpellBrowser","ClassBrowser","RaceBrowser","CreatureBrowser","BuffBrowser","initializeBrowsers","getIndexes","packNames","resultPromise","indexingPromises","getIndex","finally","delete","_mapEntry","model","inplace","__pack","__packLabel","__uuid","getUuid","__name","fuzzysort","_renderEntries","ENTRY_TEMPLATE","typeName","filterClasses","isPackIncluded","indexCount","entryCount","acc","_activateFilterQueue","filterQueue","idToFilter","tags","filterId","filterName","_queueFilters","unorderedEntries","loadPackIndex","flat","indexed","onError","getFilteredEntries","activeFilters","every","collator","Intl","Collator","compare","selectionStart","input","_element","Function","selectionEnd","query","collapsed","_entries","itemCount","filteredItemCount","loading","loadingInfo","_refocus","_priorState","RENDER_STATES","NONE","_initLazyScrolling","filterContent","_onClickEntry","_onReload","_onClearFilters","header","_onFilterHeaderClick","_onCustomSearchFilter","ContextMenu","_getEntryContextOptions","then","editable","locked","getDocumentClass","canUserCreate","importFromCompendium","renderSheet","clipboard","copyPlainText","_canDragStart","_onDragStart","dataTransfer","setData","setTimeout","filterContents","listEnd","IntersectionObserver","observer","isIntersecting","currentCount","newEntries","unobserve","newHtml","_dragDrop","bind","rootMargin","observe","NoAutocomplete","Base","_renderFrame","frame","autocomplete","DocumentSheetV2","HandlebarsApplicationMixin","api","ActorTraitSelector","form","handler","_updateDocument","submitOnClose","submitOnChange","closeOnSubmit","minimizable","sheetConfig","scrollable","footer","_searchFilter","_collator","lang","subject","attribute","searchIndex","_name","_searchIndex","_preparePartContext","partId","isEditable","k","chosen","cssClass","hideSearch","traitSelector","hasCustom","splitCustom","_onRender","_onSearch","customInput","_onCustomInput","_onActiveCustomInput","_deleteCustomTag","attrib","checked","indeterminate","test","_onChangeForm","isComposing","repeat","last","customTag","SEARCH_INCLUDE_ID","els","formConfig","formData","FormData","appId","updateData","union","DragDropApplicationMixin","BaseApplication","DragDropApplication","createDragDropHandlers","permissions","dragstart","drop","_canDragDrop","callbacks","dragover","_onDragOver","_onDrop","DragDrop","AbstractListSelector","_save","addEntry","_onAddEntry","deleteEntry","_onDeleteEntry","dragDropHighlightTimeout","dragDropType","row","dragData","setDragImage","_temp","dragDropData","clearDragHighlights","clearTimeout","dragEventData","getDragEventData","moveToBeforeId","movedId","splice","fields","dtypes","dataCount","_getNewEntry","_getUpdateData","DamageResistanceSelector","isDR","resistances","originalEntries","damageOBJ","damageTypes","dType","isModifier","damages","damageResistances","materials","dr","treatedAs","allowed","lightBlade","oneHandBlade","twoHandBlade","shortName","operators","true","false","_initializeApplicationOptions","rv","_onResistanceCustomChange","_onResistanceChange","index2","updateValue","dtype","val","floor","String","ActorRestDialog","_rest","_prepareContext","performRest","PointBuyCalculator","_onAbilityControl","ablValues","abilityCost","usedPoints","spentPoints","pointBuy","limitsArr","ldata","l","limits","invalidPoints","ablKey","abl","Widget_ItemPicker","columns","_items","parentElem","rootElem","parseHTML","rowElem","itemElem","widthRate","css","offsetLeft","offsetBottom","_onClickItem","_cancelCallback","_onCancel","parentNode","cancel","attr","removeEventListener","ApplicationV2","AbstractSettingsApplication","resetForm","_onFormReset","phraseKey","configKey","assign","activeTab","tabGroups","schema","tab","updateSource","RollPF","totalHalved","safeRoll","suppressError","evalOpts","evaluate","warning","cleanFlavor","getTermTooltipData","term","getTooltipData","expression","getTooltip","dice","numericParts","terms","idx","arr","DiceTerm","FunctionTerm","ttdata","prior","NumericTerm","OperatorTerm","CHAT_TEMPLATE","isPrivate","_evaluated","allowInteractive","templateData","details","limitPrecision","hasDetails","FormulaField","StringField","_toInput","parse","ExperienceConfigModel","abstract","DataModel","defineSchema","disable","BooleanField","track","SchemaField","openDistributor","migrateData","disableExperienceTracking","openXpDistributor","progressionOptions","ExperienceConfig","enabled","hasCustomFormula","HealthConfigModel","auto","NumberField","maximized","variantRules","useWoundsAndVigor","useWoundThresholds","woundThresholdOptions","pc","rules","integer","rounding","blank","nullable","healthRoundingOptions","continuous","getClassHD","actorType","getActorConfig","continuity","hitdice","PC","NPC","Racial","variants","up","nearest","down","healthContinuityOptions","prepareDerivedData","HealthConfig","templates","showWoundsVigorWarning","hdId","hdData","IntegrationConfigModel","diceSoNice","dragRuler","babele","IntegrationConfig","dsnFound","modules","drFound","bFound","PerformanceConfigModel","reachLimit","PerformanceConfig","registerSystemSettings","scope","Boolean","onChange","migrations","isMigrating","registerMenu","hint","restricted","requiresReload","LIMITED","OWNER","perception","initializeLighting","initializeVision","refreshLighting","refreshVision","FRIENDLY","NEUTRAL","HOSTILE","TokenConfig","refreshSheets","placeables","_applyRenderFlags","redrawEffects","migrateSystemSettings","storage","removeItem","getSkipActionPrompt","skipConfirmPrompt","LevelUpForm","FormApplication","simulacra","mold","fcb","unavailable","available","visibility","new","used","useBackgroundSkills","isMythic","levelUp","hd","upgrades","added","isEnhanced","isNull","isValid","isAvailable","isModified","hasPlayerOwner","DICE_ROLL_MODES","PRIVATE","_initData","_initChoices","createTag","isLevelUp","isNewClass","increaseLevel","resolve","addClassWizard","_prepareAssociations","associations","assocs","classAssociations","hpOptions","fc","icons","ICONS","visibilityOptions","messageVisibility","tier","tierAbilityScores","levelAbilityScores","delta","raw","ranks","adv","next","_getNextAbilityScoreLandmark","isReady","table","hdt","gained","_getDefaultHealthOption","_getDefaultHitPoints","ceil","_prepareHealthData","hpConfig","clsConf","hitDie","dieHealth","newHD","oldHD","hpAbl","hpAbility","hpMod","mod","cfg","isFavouredClass","getLevelData","totalHD","mythicTier","totalMythicTier","oldSaves","newSaves","bg","tempActor","isMindless","advSkillRanks","bgSkillRanks","hitDice","perLevel","skillsPerLevel","backgroundSkillClasses","bgranks","backgroundSkillsPerLevel","bonusSkillRankFormula","getRollData","getFeatCount","babBase","favoredClassTypes","_updateObject","_onClickAbilityScoreOperator","_openItemSheet","_onCommit","_onSkip","itemUuid","_adjustAbilityScore","_adjustAbilityScoreValue","abls","cost","_adjustAbilityScoreCost","tierAbilityScoreMult","levelAbilityScoreMult","_initFCBChoices","_initHPChoices","highest","maxLeft","_getHealthFormula","dieSize","_spoofHealthRoll","toJSON","_getHealthRoll","_disableSheet","cardData","newFeatures","toAnchor","outerHTML","hpValue","fcKey","oldFeatCount","itemUpdates","ablUpdate","_updateAbilityScore","extra","featCount","createChatMessage","style","cursor","change","prevValue","components","ItemChange","levelAbilityScoreFeature","rolls","messageData","CHAT_MESSAGE_STYLES","OOC","getSpeaker","SELF","applyRollMode","altCurrency","notification","order","_curRange","_calcTotal","formField","amounts","_failed","i18nKey","_directoryDrop","docDestId","destDoc","actorUuid","containerId","sourceDoc","allowConversion","sourceCurrency","destCurrency","originalSource","totalAmount","totalSource","newSource","convert","socket","emit","minRequired","inCopper","templatePaths","preload","loadTemplates","renderCachedTemplate","Handlebars","partials","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","preventIndent","ActorSheetPF","_filters","sections","searchCompositioning","searchRefresh","searchDelay","searchDelayEvent","effectiveSearch","_itemUpdates","_hiddenElems","_skillsLocked","_expandedItems","_activeEdits","navSelector","contentSelector","currentPrimaryTab","_tabs","currentSpellbookKey","isMetricDist","owner","limited","isCharacter","hasHD","usesAnySpellbook","sourceData","skillsLocked","weight","getWeightSystem","tactical","measureUnitsShort","overland","unchainedActions","caster","casterPreparation","inCharacterGeneration","hasProficiencies","numAttacks","iterativeExtraAttacks","iters","fromRange","attackCount","iterativeAttackModifier","hasCurrency","hasAltCurrency","enrichHTMLOptions","secrets","bio","biography","pBio","enrichHTMLUnrolled","biographyHTML","notes","pNotes","notesHTML","_prepareItem","getLabels","sizeModifier","sizeMods","baseBonus","general","meleeAbility","rangedAbility","genericAttacks","abilityMod","modifier","cpValue","calculateTotalItemValue","inLowestDenomination","totalValue","pad","totalLabel","arbitrary","arbitrarySkills","skillCompendiumEntries","journal","untrained","rt","rank","subSkills","subSkillId","subSkill","issues","missing","excess","_prepareTraits","_prepareSenseLabels","parseResistances","eres","_prepareItems","encumbrance","_computeEncumbrance","_prepareSkillsets","_prepareSkills","healthConfig","_prepareHiddenElements","hiddenElems","magicItems","unidentified","carried","unidentifiedName","strength","auraStrengths","auraStrength","identifyDC","dataFilters","firstClass","browser","inheritedEffects","appliedEffects","ae","statuses","condImmunities","creatureSubtypes","showInBuffsTab","immune","inherited","_editorState","restoreEditState","isPhysicalLike","isQuasiPhysical","isSingleUse","isCharged","hasResource","maxCharges","noMaxCharges","hasUses","defaultAction","actionId","hasAction","getScriptCalls","hasAttack","hasMultiAttack","hasDamage","hasRange","hasEffect","_canShowRange","range","getRange","getAttacks","conditionals","bonuses","attackBonuses","atk","attackArray","attackSummary","usesAmmo","ammoRemaining","showUnidentifiedData","isEmpty","isStack","destroyed","isBroken","uncharged","equipped","implanted","typeLabel","xpUnbound","di","conditionTypes","languages","armorProf","armorProficiencies","weaponProf","weaponProficiencies","creatureTypes","selected","svalue","converted","convertDistance","_prepareSpellbook","bookKey","hasCantrips","autoSpellLevelCalculation","autoSpellLevelTotal","spellPreparationMode","casterType","spellLevel","usesSlots","canPrepare","spellLevels","uses","hasIssues","lowAbilityScore","lowLevel","known","preparation","invalidSlots","mismatchSlots","invalidKnown","mismatchKnown","domain","isSchool","levelData","sets","adventure","background","localeCompare","skl","backgroundOnlySkills","skillsets","useBGSkills","skillRanks","bgAllowed","bgUsed","sentToBG","subSkl","carriedWeight","load","levels","carryLabel","kg","lbs","pct","clamp","encumbered","encumbranceLevels","aboveHead","offGround","dragPush","filterLists","_initializeFilterItemList","_onToggleFilter","sb","_searchFilterChange","_searchFilterCompositioning","_onItemSummary","_onItemEdit","contextmenu","_hideShowElement","_onOpenCompendiumEntry","_onOpenCompendiumBrowser","_activateExtendedTooltip","deactivate","_onSpanTextInput","_adjustActorPropertyBySpan","_onInputText","originalEvent","_selectOnClick","_onRollAbilityTest","_onRollBAB","_onRollAttack","_onRollInitiative","_onRollSavingThrow","_onArbitrarySkillCreate","_onSkillCreate","_onSkillEdit","_onSkillDelete","_itemActivationControl","_onRollSkillCheck","_onTraitSelector","_onResistanceSelector","_onRest","_onPointBuyCalculator","_onControlAlignment","_onSensesSelector","_onItemCreate","_onItemDelete","_onItemGive","_onItemSplit","_onItemCard","_quickChangeItemQuantity","_quickEquipItem","_quickCarryItem","_quickIdentifyItem","_itemPreparedToggle","_duplicateItem","_quickAction","_convertCurrency","_setItemUses","el0","direction","TooltipManager","TOOLTIP_DIRECTIONS","LEFT","_onLevelUp","_setSpellUses","_setMaxSpellUses","_onRollConcentration","_onRollCL","off","_setItemActive","_setBuffLevel","_onToggleCondition","_onEditCondition","_onToggleSkillLock","tooltipExtended","bonusTypes","_getTooltipContext","sources","paths","callAll","tooltipDirection","fullId","lazy","_cache","getNotes","getContextNotesParsed","n","subHeader","detail","NaN","CR","fromNumber","offset","getSourceDetails","mp","recover","mode","tD","tB","tR","unhindered","tU","oD","oU","sizeSpecialMods","cmbAbility","hasAbility","sign","drain","undrained","baseMod","unmod","acp","mdex","maxDexBonus","asfSources","itemASF","spellFailure","implant","physical","mental","stature","signed","empty","isBoolean","unlevel","formatter","NumberFormat","signDisplay","attackSources","dmgSources","names","nonCritParts","held","mult","damageMult","abilityDamageHeldMultipliers","allDamageSources","maxIncrements","mu","carryCapacity","multiplier","bonusMults","isQuadruped","smult","encumbranceMultipliers","decimals","featSources","skillSources","isBG","fcSkills","fullSkillId","skillIdParts","mainId","shift","subTarget","ablMod","spellPoints","multischool","subschool","descriptors","isNumber","newEl","noCap","getAttribute","endsWith","maxName","forbiddenClasses","allowRelative","replaceChild","stopPropagation","adjustNumberByStringCommand","readOnly","select","_onDragSkillStart","skillElem","mainSkill","_onDragMiscStart","_onDragSaveStart","_i","ul","verbose","bringToFront","displayCard","_mouseWheelAdd","isInput","WheelEvent","ctrlKey","increase","deltaY","wheelStep","MouseEvent","_commitItemUsesBound","_commitItemUses","setItemUpdate","_updateItems","curValue","oldEl","toNearest","_getSubmitData","for","hasClass","hide","slideDown","slideUp","conditionId","toggleCondition","relevantAEs","bottom","getBoundingClientRect","rounds","dialog","getNumber","seconds","time","roundTime","setCondition","cat0","cat1","part","clsId","spellbookKey","openItemSummary","instant","listEl","expandedId","summary","inert","getChatData","chatcard","div","firstElementChild","origValue","wheelEvent","getSelection","anchorNode","removeAllRanges","keyHandler","_onSubmit","parents","mainSkillData","skillData","cs","_editSkill","isBackground","baseTag","allowUnderScore","SkillEditor","addCallback","mainSkillId","confirm","DialogV2","rejectClose","modal","deleteSkill","SensesSelector","alignmentsShort","alignment","use","curQuantity","newQuantity","property","_prepareDuplicateItem","rename","original","_stats","duplicateSource","relatedItems","searchUnusedName","existingNames","newName","iter","identNames","unidentNames","currencyType","convertCurrency","categoryId","sectionId","_sortNewItem","oldItems","oldItem","isItemSameSubGroup","linked","findAllLinks","getLinkedItemsSync","targetActorId","getActor","clickEl","renderOpts","SplitStack","wait","keep","createDocuments","rollAbilityTest","rollBAB","maneuver","rollAttack","rollInitiative","createCombatants","rerollInitiative","savingthrow","_applySectionFilter","hasASF","hasSpellbooks","spellbookSections","spellbookSpells","classId","arcaneSpellFailure","asf","allClasses","_0","_1","ct","findSplice","cat","featureSections","ablType","abilityType","typelabel","abilityTypes","found","discrepancy","buffSections","attackSections","cweapons","showInCombat","cspells","cfeat","classfeat","racefeat","cequipment","cconsumables","classSections","_filterSection","spellbookData","quickActions","getQuickActions","_preparedOnly","_hideEmpty","inFilters","_hidden","rollSkill","_searchFilterCommit","show","saveEditState","_renderInner","listId","preventClose","preventRender","_onDropCurrency","_onDropItem","sourceItem","fromDropData","sameActor","keepId","clearSort","_onSortItem","altKey","_alterDropItemData","_onDropItemCreate","deleteContainerContent","fromActor","fromItemsDir","isClass","_source","_adjustNewItem","itemDatas","creationData","specifier","getItem","spellType","kind","resultData","ItemSpellPF","toConsumablePrompt","allowSpell","_focusTabByItem","tabId","isAlt","denomination","drag","price","sellValue","calculateSellItemValue","sellMultiplier","_disableFields","getElementsByTagName","ActorSheetPFCharacter","xpSettings","disableExperience","showXpBar","minimumExperience","getLevelExp","hasClasses","xp","xpTrack","CHARACTER_EXP_LEVELS","ActorSheetPFNPC","_adjustCR","ActorSheetPFNPCLite","ActorSheetPFNPCLoot","itemValueDenomination","isLootSheet","baseCurrency","getTotalCurrency","cpSellValue","noEquip","ActorSheetPFHaunt","measureTemplateTypes","alignments","noDesc","destruction","pDestruction","destructionHTML","pEffect","effectHTML","pTemplates","hauntTemplates","enrichHTML","templateLinks","link","hauntTemplateLabels","broken","area","convertDistanceBack","ActorSheetPFTrap","getPerceptionModifier","traps","trapTypes","hasTriggerRange","hasTriggerTime","hasPerceptionTrigger","disarm","rollPerception","ActorSheetPFVehicle","vehicleSizes","vehicles","pDesc","descriptionHTML","driver","_computeDriverData","driverSkill","skillBonus","stopped","acceleration","currentSpeed","speedOverland","currentSpeedOverland","maxSpeed","maxSpeedOverland","_ev","invCat","convertibleKeys","driverId","allSkills","SpeedEditor","isMetric","isNumeric","Widget_CategorizedItemPicker","hidden","categoryItems","hasVisibleChoices","_onFirstRender","behaviour","FlagSelector","valueObject","ItemSheetPF","ItemSheet","_actionUpdates","isolated","itemType","owned","canClassLink","inContainer","isWeapon","isAttack","isWeaponLike","isNaturalAttack","isSpell","isMateria","isImplant","isEquipment","hasClassLink","classTag","classData","hitDieSizes","wealth","maximize","minimize","inheritCharges","defaultChargeFormula","getDefaultChargeFormula","limitedUsePeriods","isRechargeable","limitedUsePeriodOrder","isActivatable","showBothDescriptions","showIdentified","isIdentified","showIdentifiedData","unchainedActionEconomy","identify","strengthLabel","spellcasting","hasSpellbook","descriptionAttributes","isRelative","constraints","fakeValue","inputValue","forceUnidentified","fakeName","isRange","current","disableEquipping","canEquip","masterwork","isClassFeature","isTemplate","classSkills","skilldata","isCS","materialCategories","_prepareMaterialsAndAddons","alignmentTypes","_prepareAlignments","addon","materialAddons","wsubtype","weaponSubtype","isRanged","properties","weaponCategories","weaponTypes","equipmentCategories","equipmentTypes","equipmentSlots","equipmentSlotted","materiaRarity","hasMultipleSlots","hasSlots","hasSubCategory","variableHands","topDescription","implantTypes","isCybertech","implantSlots","isSpontaneousLike","useSystem","isPreparedSpell","usesSpellpoints","isAtWill","atWill","spellbookChoices","n0","n1","getDescriptionData","dfVariants","MDF","FDF","df","noDurationTiming","isMythicPath","favouredClassBonuses","isBaselikeClass","isRacialHD","isNPCClass","isPCClass","hasSpellType","canUseAmmo","defaultAmmo","invalidDefaultAmmo","extraType","traitsMap","spellDescriptors","weaponGroups","traitKey","showPriority","ch","chData","isDeferred","isCustom","isSimple","isAdd","isSet","isValidType","priority","changePriority","noteTargets","causedConditions","distanceUnits","attackNotes","_prepareItemFlags","distanceUnit","raceCreatureTypes","raceCreatureSubtypes","descriptor","_prepareContentSource","getDescription","enrichOptions","pIdentDesc","unidentDesc","pUnidentDesc","pTopDesc","instrDesc","instructions","pInstrDesc","pScripts","_prepareScriptCalls","pLinks","_prepareLinks","EDIT_TRACKING","_getContentSources","main","_selectContentSource","bookSources","extras","datestamp","publisher","date","abbr","edition","url","Date","materialList","addonList","basicList","isAllowed","addons","basics","alignmentChoices","help","linkData","linkedItem","boolean","dictionary","scriptCalls","oldData","oldLinks","linkType","typedLinks","targetName","relativeInput","setCustomValidity","convertWeight","convertWeightBack","getWeightMultiplier","reduction","relativeKeys","nHpVal","hpVal","nHpBase","hpBase","realMax","maxFormula","_onHoverTooltip","tooltipType","_onHoverWeightTooltip","_onHoverPriceTooltip","mValue","inline","_validateFormula","hasActor","RIGHT","_onActionEdit","_onActionSummary","_onActionControl","_onOpenTextEditor","_openHelpBrowser","_onEntrySelector","_onFlagSelector","ContentSourceEditor","isProficient","proficiency","_onScriptCallEdit","_onScriptCallControl","_openLinkedItem","_onNoteControl","_onNoteTargetControl","_onCreateChange","_onCardNoteControl","_onLinkControl","_onTextAreaDrop","_onOpenChangeMenu","_onEditChange","_createAttack","_createSpellbook","_onItemSelector","_onSpeedEdit","_setActionUses","_onScriptCallDrop","setActionUpdate","_updateActions","script","newScripts","ItemScriptCall","edit","eventData","getContentLink","helpBrowser","openUrl","changeId","pf1Link","dropData","srcDoc","actionData","parentItem","ItemAction","targetActionId","prevActions","targetIdx","srcIdx","_onChangeDrop","_onLinksDrop","origin","osrc","targetItem","extraData","createItemLink","targetChangeId","removed","curr","actionDescription","getUniqueActionName","act","newActionData","HTMLEditor","_onDuplicateChange","_onDeleteChange","dismissLockedTooltip","ChangeEditor","ContextNote","note","noteIndex","sortable","part1","deleted","displayValue","attackItem","ItemAttackPF","fromItem","showInQuickbar","newAttack","flag","EntrySelector","filterFunc","ItemSheetPF_Container","_prepareContents","usystem","coinage","merge","_openItemSummary","animation","_onItemTake","_quickItemActionControl","createContainerContent","nextElementSibling","droppedItem","rootItem","containerItems","dropTarget","targetId","siblings","siblingId","SortingHelpers","performIntegerSort","updateContainerContents","ItemCreateDialog","_updateCreationData","getDefaultName","FormDataExtended","initialData","getSubtypes","classTypes","attackTypes","featTypes","consumableTypes","lootTypes","buffTypes","_prepareFormContext","folders","_formatFolderSelectOptions","subtypes","key0","label0","key1","label1","subtype","defaultType","documentTypes","first","promise","_onClose","ItemActionSheet","actionType","isHealing","isCombatManeuver","canCrit","hasCritDamage","critParts","hasNonCritDamage","isSelfCharged","chargedUsePeriods","showMaxChargeFormula","self","canInputRange","canInputMinRange","minUnits","canInputDuration","itemName","itemEnh","usesSpellPoints","parentOwned","activation","hasActivationType","abilityActivationTypes","abilityActivationTypes_unchained","showMaxRangeIncrements","isWeaponAttack","inheritedAmmoType","inheritedMisfire","misfire","ammoTypes","minRangeAvailable","getConditionalTargets","conditionalTargets","hasConditionalTargets","conditional","targetEntry","subTargets","conditionalModifierTypes","getConditionalModifierTypes","conditionalCritical","getConditionalCritical","addonMaterial","canHold","inheritedHeld","weaponHoldTypes","heldAbilityMultiplier","hasKeyAbility","keyAbility","keyAbilityLabel","defaultAbility","defaultAbilityChoice","_key","_default","paMultiplier","getPowerAttackMult","extraAttacksTypes","extraAttacks","extraAttacksConfig","allowCustom","isValidAddon","normalMaterial","trackStaleEditors","_onEditImage","_onAttackControl","_onDamageControl","_onClickDamageType","_onNoteEntryControl","_onConditionalControl","_onAlignmentChecked","ItemConditional","ItemConditionalModifier","k2","k3","damageParts","damagePart","damageIndex","DamageTypeSelector","updateCallback","damageArray","conditionalEl","modifierEl","manualExtraAttacks","attackPart","FilePicker","previousValue","preserveArray","k0","k1","oldConds","oldC","oldM","array","_sheet","_state","_createDocumentIdLink","idLink","ariaLabel","_renderOuter","CheckboxFilter","baseFilter.BaseFilter","booleanOperator","BOOLEAN_OPERATOR","_choiceQuery","_debouncedFilterChoices","getChoicesFromConfig","configObject","labelKey","innerSet","innerKey","innerValue","autoSort","sorted","hasControls","MIN_SEARCH_CHOICES","hasSearch","prepareBooleanOperator","fieldData","AND","observedValues","flatMap","autoLocalize","localizeChoices","i18nPrefix","localizePrefix","toggleChoice","activeChoices","testMethod","OR","choiceQuery","checkbox","choiceKey","SearchFilter","cleanQuery","matchingChoices","choiceSet","TextFilter","inputs","placeholder","_parseInput","textInput","NumberRangeFilter","parsedInput","ItemTypeFilter","WeaponTypeFilter","WeaponSubtypeFilter","WeaponPropertyFilter","weaponProperties","WeaponGroupFilter","EquipmentTypeFilter","EquipmentSubtypeFilter","ItemSlotFilter","ConsumableTypeFilter","MiscItemTypeFilter","ItemPriceFilter","ItemCasterLevelFilter","PackFilter","usedPacks","orderedPacks","TagFilter","SpellSchoolFilter","SpellMultischoolFilter","configChoices","SpellSubschoolFilter","SpellDescriptorFilter","SpellLearnedByClassFilter","classNames","getClassIDMap","SpellLearnedByDomainFilter","SpellLevelFilter","activeLearnedAtFilters","activeLevelChoices","learnedAt","learnedAtChoice","learnedAtLevel","levelChoice","FeatTypeFilter","FeatClassFilter","ClassTypeFilter","ClassHitDieFilter","ClassBaseAttackBonusFilter","classBAB","ClassSkillPointsFilter","ClassSavingThrowFilter","classSavingThrows","noneFilterResult","ClassFortitudeFilter","ClassReflexFilter","ClassWillFilter","ClassSubTypeFilter","classSubTypes","ClassParentFilter","ClassMPFilter","classBaseMPTypes","ClassCastingStatFilter","classCastingStats","CreatureTypeFilter","CreatureSubTypeFilter","BuffTypeFilter","CreatureCRFilter","commonFilters.PackFilter","buffFilters.BuffTypeFilter","commonFilters.TagFilter","classFilters.ClassTypeFilter","classFilters.ClassSubTypeFilter","classFilters.ClassParentFilter","classFilters.ClassHitDieFilter","classFilters.ClassMPFilter","classFilters.ClassCastingStatFilter","classFilters.ClassBaseAttackBonusFilter","classFilters.ClassSkillPointsFilter","classFilters.ClassFortitudeFilter","classFilters.ClassReflexFilter","classFilters.ClassWillFilter","creatureFilters.CreatureCRFilter","featFilter.FeatTypeFilter","featFilter.FeatClassFilter","itemFilters.ItemTypeFilter","itemFilters.WeaponTypeFilter","itemFilters.WeaponSubtypeFilter","itemFilters.WeaponPropertyFilter","itemFilters.WeaponGroupFilter","itemFilters.EquipmentTypeFilter","itemFilters.EquipmentSubtypeFilter","itemFilters.ItemSlotFilter","itemFilters.ConsumableTypeFilter","itemFilters.MiscItemTypeFilter","itemFilters.ItemPriceFilter","itemFilters.ItemCasterLevelFilter","equipmentSubtypes","at","raceFilters.CreatureTypeFilter","raceFilters.CreatureSubTypeFilter","spellFilter.SpellSchoolFilter","spellFilter.SpellMultischoolFilter","spellFilter.SpellSubschoolFilter","spellFilter.SpellDescriptorFilter","spellFilter.SpellLearnedByClassFilter","spellFilter.SpellLearnedByDomainFilter","spellFilter.SpellLevelFilter","learnedAtLevels","learnedAtSource","JournalTextPageSheetPF1","JournalTextPageSheet","maxLevel","JournalEntry","pages","headers","npage","nlevel","editorToggledState","editor","editors","rendered","renderContext","ProseMirror","dom","serializeString","instance","view","ActionSelector","_onClickAction","ChatAttack","actionUse","hasCritConfirm","AttackDamage","damageRows","hasCards","cards","effectNotes","effectNotesHTML","notesOnly","setAction","setAmmo","setRollData","critCount","ablMult","setEffectNotesHTML","addAttack","noAttack","extraParts","conditionalParts","extraChanges","critConfirmBonus","parsedConfirmResult","getDefenseDC","armorAsDR","method","Dice","fulfillment","methods","d20","baseCritMult","isCrit","critMultBonus","addDamage","repeatCount","rollDamage","totalDamage","addEffectNotes","noteSources","explosionRadius","explode","isNat20","isNat1","_createInlineRolls","inlineRoll","crit","finalize","ERR_REQUIREMENT","freeze","NO_ACTOR_PERM","DISABLED","INSUFFICIENT_QUANTITY","INSUFFICIENT_CHARGES","MISSING_AMMO","INSUFFICIENT_AMMO","DISALLOWED_ACTION_TYPE","ActionUse","checkRequirements","noManeuvers","cache","D20RollPF","standardRoll","dcBonus","chargeCost","chargeCostBonus","createAttackDialog","AttackDialog","alterRollData","useOptions","powerAttack","primaryAttack","clCheck","measureTemplate","manyshot","rapidShot","abilityMult","fullAttack","atkBonus","attackBonus","dmgBonus","damageBonus","pointBlankShot","flanking","highGround","charge","manyShot","useMeasureTemplate","abilityDamageMultOverride","basePowerAttackBonus","powerAttackBonus","paMult","powerAttackPenalty","condId","naturalAttack","naturalAttacks","casterLevelCheck","concentrationCheck","generateAttacks","forceFullAttack","allAttacks","ActionUseAttack","ammos","getAmmo","ammoCost","abundant","autoSelectAmmo","ammoType","availableAmmo","_filterAmmo","isDefault","subtractAmmo","ammoUsage","usage","updateAmmoUsage","chatAtk","chatAttack","remaining","handleConditionals","rollDataConds","modKey","conditionalRoll","partString","partID","flavoredFormula","conditionalPartsCommon","checkAttackRequirements","generateChatAttacks","addAttacks","addEmptyAttack","hasAmmo","saveDC","getDC","_getConditionalParts","conditionalTemplates","addPart","templateKey","templateStr","parsedStr","powerAttackCritBonus","critMultiplier","chatAttacks","addFootnotes","typeMap","footnotes","promptMeasureTemplate","mt","dist","distancePixels","scene","dimensions","maxDist","maximum","color","AbilityTemplate","actorSheet","sheetRendered","drawPreview","place","handleDiceSoNice","dice3d","isEnabled","chatData","mergeRolls","skipRolls","showRoll","pools","pool","showForRoll","attackPool","PoolTerm","critPool","getMessageData","OTHER","soundEffect","sounds","extraText","enrichNotes","itemChatData","formatTextNotes","commonProperties","addGenericPropertyLabels","combatProps","addCombatPropertyLabels","clNotes","dcSchoolNotes","clSchoolNotes","tokenUuid","identifiedDescription","unidentifiedDescription","hasSave","gmSensitiveLabel","rangeUnits","rangeLabel","spellFailureRoll","spellFailureSuccess","generateChatMetadata","totalChargeCost","useSpellPoints","showInAction","materialKey","normalMaterialAction","normalMaterialItem","baseMaterialItem","addonMaterialAction","addonMaterialItem","materialAddonNames","actionAlignments","itemAlignments","attackPenalty","woundThresholds","woundThresholdConditions","sl","attackRolls","damageRoll","executeScriptCalls","scriptData","postMessage","chatTemplate","chatMessage","hideChat","getTargets","getTokensWithin","combatant","isDefeated","_getDefenseDCParts","check","babIdent","prepareChargeCost","baseCostRoll","getChargeCost","process","skipDialog","measureResult","reqErr","code","perAttack","reject","premessage_promises","totalCost","updateTokenTargets","broadcastActivity","appOptions","initAmmoUsage","initAttacks","isPrimaryAttack","_toggleExtraAttack","rollModes","hasDamageAbility","isMeleeWeaponAttackAction","isRangedWeaponAttackAction","isFeat","hasTemplate","canConfigureHeld","inheritable","_onToggleFlag","_onChangeAttribute","_onSelectChange","_onToggleConditional","_onAmmoSelectClick","_onAmmoControlClick","_onAmmoClick","_unfocusElements","_hideExtraAttacks","_showExtraAttacks","resolveAttack","selectedIndex","cancelable","translationString","setAttackAmmo","listElem","attackBonusTotal","curAmmo","ChangeLogWindow","lastVersion","autoDisplay","dontShowAgain","xhr","XMLHttpRequest","onload","status","_processChangelog","response","statusText","responseURL","send","changelog","md","converter","showdown","Converter","latestVersion","version","latestMajor","latest","majorPatches","legacy","currentVersion","lines","line","makeHtml","patches","toggleDamageType","_toggleDamageType","customTypes","allTypes","standardTypes","categoryOrder","dt","sortOrder","dm","categoryObj","o2","idxA","idxB","AbstractDocumentSelector","_submit","delay","compositioning","_getSections","searchTerm","showSectionHeaders","searchInput","_onSearchComposition","ItemSelector","itemList","HelpBrowserPF","forward","_forwardInHistory","back","_backInHistory","home","_home","_backwardHistory","_forwardHistory","_currentPage","extensions","defaultExtensions","noHeaderId","ghCompatibleHeaderId","prefixHeaderId","currentUrl","hasHistoryBack","hasHistoryForward","pageContent","slugify","getCurrentHistoryObject","contentElement","scrollTop","headerElement","getElementById","href","removeAttribute","stopImmediatePropagation","regex","_offset","_string","foundrySrc","getRoute","ScriptEditor","_promises","submit","awaitResult","resolved","resolvePromises","_onSave","convertKeys","noSystemVision","prototypeToken","gridUnits","isToken","DocumentSheet","_callbacks","skillName","isSubSkill","isStaticSkill","skillTag","documentType","JournalEntryPage","skillCoreUpdateData","allowUpperCase","camelCase","newData","oldSubSkillId","oldSkillId","tagChanged","msgOpts","documentClass","_openCompendiumEntry","_onCompendiumControls","reportValidity","canAdd","stub","_getHeaderButtons","_onAction","sidx","_onDropContentSource","dropIndex","moved","addVisionSharingContextMenu","menu","documentId","visionSharingSheet","offsetTop","innerWidth","VisionSharingSheet","players","userId","ExperienceDistributor","_doSplitReward","_doFullReward","_bonusXP","_actors","getActorData","characters","npcs","totalExperience","toLocaleString","splitExperience","bonusXP","isNPC","actorID","_giveExperience","splitEvenly","isSafeInteger","updateDocuments","getXP","getCR","_shouldActorBeSelected","xpLabel","fromCombat","copyUuid","onCopyUuid","uniqueId","getID","defaultPriority","earlyPriority","latePriority","early","late","isValidOp","_onChangeTargetControl","inParent","oldOptions","ItemDirectoryPF","ItemDirectory","renderUpdateKeys","Troubleshooter","migrate","_runMigration","_openHelp","unlock","reprocess","migrating","world","unlockPacks","report","kb","discord","channel","faq","helpmodule","migrateWorld","migrateModules","_context","migrationButtons","ActorSelector","ownership","actorList","dialogOptions","splitValue","valueAsNumber","slider","oldStack","newStack","HTMLField","_processSubmitData","submitData","ApplyDamage","asWounds","damageOptions","dualHeal","enumerable","woundsAndVigor","_prepareInstances","_prepareTargets","apply","_onApply","hasPhysical","hasEnergy","_updateTarget","y","prev","equals","unknownTypes","hpconfig","ratio","getResistances","activeDR","activeER","reductionChoices","haveDIV","haveDER","resistanceType","res","_parseResistanceEntry","enrichResistance","typeIds","type0","type1","hasGeneric","rdata","baseReduction","updated","targetCount","_getTargetDamageOptions","renderOptions","subtitle","isFlag","isFlat","newKeys","ActiveEffectPF","ActiveEffect","_preCreate","isTemporary","isTracker","hideFromToken","turns","isSuppressed","ChatMessagePF","identifiedInfo","_initRollObject","maybeRollObject","actionSource","hasItemSource","templateId","targetIds","actionName","_renderRollContent","isRoll","clean","pruneData","_onCreate","_onCreateCheck","sceneId","tokenId","scenes","refMsg","addCombatTrackerContextOptions","menuItems","duplicateCombatantInitiativeDialog","combatantId","duplicateWithData","CombatPF","Combat","ids","updateTurn","messageOptions","currentId","roller","rollerName","opts","dialogData","showInitiativeDialog","getInitiativeRoll","cRollMode","PUBLIC","alias","toMessage","chatTemplateData","_onUpdate","worldTime","_onNewTurn","_preUpdate","diff","_isForwardTime","skipped","_detectSkippedTurns","_handleSkippedTurns","_processEndTurn","_processTurnStart","_processInitiative","r0","rd","roundChange","currentTurn","timeOffset","advanceTime","turnTimeOffset","rechargeItems","period","_onDelete","started","xpCfg","CombatantPF","Combatant","updateResource","resource","_getInitiativeFormula","defaultParts","SHIFT_KEYS","registerSystemControls","keybindings","uneditable","onDown","onUp","TokenDocumentPF","_preCreateSetSize","deleteFlags","sizeConf","tokenSizes","scaleX","scaleY","_getTrackedAttributesFromObject","bar","hpPart","getBarAttribute","barName","alternative","prepareBaseData","_syncSenses","detectionModes","baseRange","sight","visionMode","basicMode","DetectionMode","BASIC_MODE_ID","blindsight","blackAndWhite","trueseeing","trr","_sortDetectionModes","visionDefaults","Canvas","visionModes","fieldName","PRIORITY","applyChanges","changeOverrides","changeTargetData","getSortChangePriority","targetA","targetB","typeA","typeB","prioA","_sortChanges","changeFlags","chflagItems","hasChanges","getSourceInfo","sourceInfo","refreshDerivedData","continuousChanges","flats","createOverride","_safeApplyChange","applySourceInfo","cc","skillBasePrio","aSort","bSort","getChangeFlat","modifierType","subskill","speedKey","schoolDC","schoolCL","concnMatch","bookCL","sklKey","spread","subSklKey","events","pf1GetChangeFlat","setSourceInfoByName","srcInfo","getHighestChanges","ignoreTarget","highestTemplate","highestID","stackingBonusTypes","addDefaultChanges","Spellbook","addSpell","SpellbookLevel","SpellbookSlots","domainMax","domainUnused","SpellRanges","calculateRange","SpellbookMode","isSpontaneous","isSemiSpontaneous","Resource","_configure","itemFlags","_visionSharingSheet","_getSourceLabel","bFlags","dFlags","dEntries","_prepareChanges","_prepareTypeChanges","applyActiveEffects","prepareConditions","expiredEffects","startTime","startRound","aeInit","end","disableActiveEffects","deleteActiveEffects","disableBuffs","reason","deleteAEContext","disableAEContext","shieldTypes","armorTypes","resources","_resetInherentTotals","pf1PrepareBaseActorData","userPenalty","refreshAbilityModifiers","fractionalToString","_prepareSenses","_prepareClassSkills","_finalizeTraits","_prepareCreatureType","creatureType","living","senseId","sense","_prepareNaturalReach","getReach","skillSet","csSources","csItem","classSkillName","isClassSkill","skillKey","hasArmorProficiency","aprof","baseArmorProficiency","baseTypes","hasWeaponProficiency","override","wprof","_updateSpellBook","castsPerDayTables","hasProgressionChoices","bookClassId","bookClass","refresh","_generateSpellbookCache","bookInfo","spellbookAbility","spellSlotAbilityScoreBonus","spellSlotAbilityBonusFormula","spellSlotAbilityScore","spellSlotAbilityMod","getAbilityModifier","clTotal","autoFormula","autoSpellLevelCalculationFormula","autoBonus","autoTotal","clBonus","woundThresholdChangeTargets","newCL","woundPenalty","concFormula","concentrationFormula","formulaRoll","rollBonus","classAbilityMod","prevTotal","getAbilityBonus","getSpellSlotIncrease","useAuto","autoSpellLevels","preparedForLevels","classLevel","allLevelModFormula","allLevelMod","castsForLevels","offsetFormula","domainSlotValue","levelSpells","lvlSlots","slotCost","isDomain","maxLevelByAblScore","bonusSlotsModFormula","preparedAllOffsetFormula","bonusSlotsMod","spellLevelData","noAbilityLimit","unused","perLevelBonusSlotsFormula","preparedOffsetFormula","domainRemaining","domainSlotsRemaining","spellClass","bookKeys","allSpells","updateSpellbookInfo","maxBonus","encPen","gearPen","_applyArmorPenalties","acpSkill","prepareItemLinks","_prepareDependentData","updateItemResources","natReach","prepareSpecificDerivedData","prepareCMB","_prepareOverlandSpeeds","warnOnDuplicate","shrAtk","genAtk","cmbAbl","cmbAblMod","pf1PrepareDerivedActorData","totalAtk","updateWoundThreshold","backgroundSkills","acAbl","acTouchAbl","cmdDexAbl","dexAbility","acAblMod","acTouchAblMod","cmdDexAblMod","maxDex","acAblKey","flatFootedTotal","reducedSpeed","sInfo","encLevel","encLevels","eqData","_prepareArmorData","speedValue","getReducedMovementSpeed","encACPPenalty","encMaxDex","encLabel","maxDexLabel","attackACPPenalty","eqType","isShieldOrArmor","itemACP","bsInfo","getProficiency","mDex","isInteger","itemMDex","ignoreNull","sInfoA","brokenId","totalACP","prepareLinks","sourceDetails","dexDenied","changeGrp","sourceGroups","typeBonuses","srcValue","isDistance","isAC","stacking","_getInherentTotalsKeys","armorBonus","shieldBonus","skillKeys","_getBaseValueFillKeys","getTokenDocument","staticSize","maxVigor","excessVigorDamage","absoluteKeys","ablData","absKey","cbooks","prepMode","prog","progs","_detectHealthChange","updateVision","visionUpdate","getActiveTokens","sourceUser","hasProperty","visionSharing","_updateTokenSize","sizeKey","_onCreateDescendantDocuments","arguments","updateConditionTracks","_handleConditionTracks","previousConditions","tracks","trackedConditions","conditionGroup","disableConditionId","_conditionToggleNotify","setConditions","_onDeleteDescendantDocuments","updatedConditions","_cleanItemLinksTo","toRemove","_enumChildren","child","removeItemLink","commit","oldBook","cantrips","psychic","filterJoin","parentSkill","haveParentSkill","skillDataPathPart","conds","_getContextConditions","props","swim","climb","rollOptions","d20Roll","atkData","atkAbl","unchained","reverse","wt","wT","getWoundThresholdData","describePart","getDefenseHeaders","damageVulnerabilities","reSplit","cres","initiativeOptions","toCreate","inCombat","untokened","savingThrowId","changeBonus","abilityId","dataPathCheck","acNotes","cmdNotes","srNotes","saveNotes","drNotes","erNotes","immunity","vulnerability","showInDefense","wTlabel","saves","fastHealing","regen","canPopout","aeData","TypeError","newTrackState","disableTrackEntries","toDelete","immunities","currentCondition","oldAe","autoDelete","deleteContext","trender","createContext","hasCondition","mechanics","contexts","counter","type2","typeId","isER","typeId0","typeId1","type0name","type1name","thp","currentMP","newMp","currentHealth","woundAdjust","newHP","nld","newHp","forceDialog","reductionDefault","addTempHP","curTHP","newTHP","getWoundThresholdMultiplier","woundMult","woundLevel","hpActorConfig","penaltyBase","curHP","tempHP","maxHP","wtMult","wtMod","changeFlatKeys","fk","allNotes","getContainerContents","getContextNotes","string","noteSource","saveKey","subId","spellbookNotes","concentrationNotes","noteObjects","enrichContextNotes","enriched","noteObj","subnote","carry","getCarryCapacity","getCarriedWeight","_calculateCoinWeight","divisor","coins","carryMultiplier","sizeChart","encumbranceLoads","multiplierCount","getCurrency","currencies","armorData","skipRefresh","addStatic","temporaryRollDataFields","combats","viewed","hpKey","mpKey","sizes","maxAgeOffset","ageCategories","negLevels","parseAlignment","effectiveSize","reachStruct","qi","haveAnyCharges","maxCharge","getChargeCostSync","getDefaultChargeCost","recharging","newMod","bonusRoll","bonusFeatFormula","hasItemBooleanFlag","flagName","resetSpellbookUsage","restorePoints","restoreFormula","restoreRoll","rechargeOptions","itemUpdate","recharge","_restingHeal","longTermCare","restoreHealth","restoreDailyUses","healUpdate","spellbookUpdates","restOptions","modifyTokenAttribute","isDelta","isBar","isResource","BaseCharacterPF","hpData","oldHpData","oldAblData","_onDeltaUpdates","deltaLabels","feedback","conf","dmgKey","ablName","fontSize","textData","anchor","TEXT_ANCHOR_POINTS","CENTER","TOP","BOTTOM","fill","stroke","strokeThickness","jitter","sinceLast","createScrollingText","baseSize","sizeValue","baseAge","ageValue","tempChanges","pf1AddDefaultChanges","_calculateMaxHealth","_calculateMaxMana","useFractional","hasGoodSave","goodSaveFormula","classFractionalSavingThrowFormulas","mpCasterLevel","mpAbilityint","mpAbilitywis","mpAbilitycha","mpclass","classCastingStat","addSKillChanges","classSkillBonus","strAbl","strAbility","fortAbl","refAbl","willAbl","liteValues","valfn","trget","naturalAC","normalAC","enhAC","armorTarget","baseAC","enhACEffective","brokenAdjust","flyKey","flyValue","flyManeuverabilityValues","sizeStealthMods","sizeFlyMods","lookupStatement","changeData","changeObj","pcClasses","npcClasses","racialHD","actorHealthConfig","pushHealth","manualHealth","autoHealth","hpPerHD","hpPerTier","tiers","maxedHD","computeHealth","pushMana","mpAbility","spellMath","ClassSpellLvlProgression","currentSpellLvl","slvl","computeMana","mpSource","classBaseMPauto","manualMana","autoMana","level_mana","manaChart","classMPlevels","baseLabel","ablRE","actorHpConfig","wtData","canon","validItems","itemTrait","hasInfo","traitId","ActorCharacterPF","tokenUpdate","actorLink","disposition","TOKEN_DISPOSITIONS","_updateExp","xpData","totalXP","maxExp","curXp","ActorNPCPF","_prepareCR","newXP","crTotal","crOffset","getCRExp","ActorHauntPF","_prepareTemplates","prepareHealth","crDetail","ActorTrapPF","triggerType","visionType","trapPerceptionModifiers","ActorVehiclePF","sizeMod","sizeModSpecial","stoppedTotal","vehicleMaterials","magicallyHardened","squares","_prepareDriverData","driverBase","szCMBMod","abilityDamage","abilityDrain","ItemPF","hasActions","hasIdentifier","adjustsSize","adjustedSize","adjustedVision","adjustsVision","_preUpdateNumericValueGuard","keepPaths","_chargePreUpdate","memoryVariables","baseMaterial","firstAction","hasFiniteCharges","autoDeductCharges","autoDeductChargesCost","_rechargeUses","actionUpdate","_rechargeActions","rechargeFormula","changedActions","fullDescription","fullInfo","firstDamage","sizeIndex","critRange","actorSizes","parsed","capacity","actionTypes","final","_updateMaxUses","_prepareActions","_prepareIdentifier","adjustContained","noAction","isPassive","_updateInheritedCharges","replaceSource","extraParams","scripts","execute","_transformContainerUpdateData","memorizeVariables","containerItem","baseUpdate","_memoryVariables","memKeys","_hasSizeUpdate","_hasVisionUpdate","activeChanged","_activeStateChange","_onMemorizedUpdate","iuses","getRawEffectData","altChatData","isVersatile","extended","interactive","childTypeDistinct","childType","distanceValues","saveDesc","timePeriods","enhBonus","getTypeChatData","harmless","descriptionOnly","_result","getConditionalSubTargets","getContextChanges","getContextStack","resizing","_addTypeRollData","_canCreateItemLink","deeptarget","_generateLinkData","packageType","getLinkedItems","includeLinkData","_results","getAllLinkedItems","linkItems","getChangeTargets","actorSkills","s2","skl2","addItemBooleanFlag","removeItemBooleanFlag","getItemBooleanFlags","setItemDictionaryFlag","removeItemDictionaryFlag","getItemDictionaryFlag","getItemDictionaryFlags","getAttackSources","isManeuver","sizeBonus","effectiveChanges","ic","virtualEnh","enhancementBonus","isRng","getAllDamageSources","srcData","timeworn","artifact","wcat","wtype","ItemBuffPF","oldEffect","_preDelete","timePeriodsShort","getDuration","endTiming","ItemClassPF","classLinks","curLevel","newAssociations","itemsCreationData","_typeSorting","compendiumSource","itemIds","deleteDocuments","domainSlots","saveFormulas","classSavingThrowFormulas","saveData","saveType","babFormulas","classFractionalBABFormulas","classBABFormulas","babType","babFormula","_registerOnActor","classHpConfig","isBaseClass","isBase","customHD","hasFCB","ItemPhysicalPF","oldBase","_resetChargesOnQuantityUpdate","oldQuantity","oldUses","prepareDurability","prepareWeight","itemEnhancementMods","_sizeAdjustedHealth","itemSize","baseWeight","_getArmorWeightMultiplier","actorSize","armorWeight","identical","maxChargesValue","remainingCharges","getActualValue","pricePerUse","hpMax","checkYes","checkNo","ItemConsumablePF","ItemContainerPF","_containedItemUpdate","dryRun","fallback","weightReduction","percent","_prepareInventory","weightMult","currencyWeight","reductionFlat","itemsData","itemOptions","actuallyCreated","noHook","coreVersion","systemVersion","createdTime","lastModifiedBy","createContained","created","actuallyDeleted","removeContained","actuallyUpdated","modifiedTime","updateContained","fullOptions","ItemEquipmentPF","slotType","slotTypes","eType","typeKeys","eSubtype","subtypeKeys","isArmor","isOrdinary","subtypeLabels","armorValue","armorValueEffective","acpEffective","applyEquippedEffects","shieldType","armorType","ItemFeatPF","traitType","traitTypes","raceType","raceTypes","traitCategory","racialTraitCategories","abilityTypeLong","ItemLootPF","ItemRacePF","oldRace","newSize","oldSize","_preparationPreUpdate","prep","getSpellComponents","compact","spellAbility","casterLevel","getMinimumCasterLevelBySpellData","curUses","getSpellUses","tempMP","curMP","leftMP","newCharges","actorUpdateData","slOffset","clOffset","maxPrepared","srcComponents","srcMaterials","isDivine","spellComponents","tc","classCasterType","_replaceConsumableConversionString","toConsumable","origData","isWand","isPotion","isScroll","minLevel","minCl","materialPrice","gpValue","xsrc","convertNotes","arrKey","exAtk","bAtk","dmgPart","oldSaveDC","charcard","getFormData","createConsumable","headerContent","bodyContent","separator","savingThrowDescription","useDCandSR","ItemWeaponPF","newWeaponType","wType","wSubtype","ItemImplantPF","IDField","_defaults","required","readonly","_validateType","PreparedModel","_safePrepareData","prepareData","DocumentLikeModel","AEBaseModel","TypeDataModel","durationEndEvents","AEBuffModel","CompactingMixin","SetField","ExtraAttackModel","ReplaceableSourceMixin","BaseMessageModel","ObjectField","sv","ItemMessageModel","ActionMessageModel","ArrayField","CheckMessageModel","HauntModel","notice","TrapModel","technology","VehicleModel","crew","passengers","decks","drivingCheck","drivingDevice","drivingSpace","forwardFacing","propulsion","affirmative","findItem","enrichers","matchItem","packTypePriority","PF1TextEnricher","enricher","global","setIcon","prepend","parseDuration","unitLabel","draggable","setElementOptions","getSpeakerData","getRelevantActors","asSpeaker","asSheet","getSheetActor","tokenActors","generateTooltip","card","option","onSave","staticRoll","onAbility","onDraw","ident","draw","displayChat","onSkill","onUse","actionIdent","itemAction","actionTag","onAction","msgId","onHealth","vars","dual","speakerData","targetRollData","isHeal","tname","onBrowse","onCondition","getAliased","enableConfig","onApply","activationData","onToggle","enable","displayAction","NL","mainlabel","isDual","sourceMetric","sourceImperial","swapWeight","kgl","lbsl","swapDistance","ml","ftl","aliases","tables","tips","onEnrichedInteraction","handleChatInput","comment","chatOptions","withinRect","point","rect","TemplateLayerPF","TemplateLayer","_onDragLeftMove","interaction","interactionData","snapToGrid","snapMode","GRID_SNAPPING_MODES","EDGE_MIDPOINT","CORNER","destination","getSnappedPoint","preview","ray","Ray","measurePath","halfAngle","angle","baseDirection","normalizeDegrees","toDegrees","renderFlags","refreshShape","MeasuredTemplatePF","_getTemplateSnapCoordinates","isSquare","_setElementOffsets","snapX","snapY","offsetX","offsetY","ruler","dx","dy","_refreshRulerText","_refreshPosition","_refreshTemplate","_getGridHighlightPositions","templateType","isHexagonal","ox","oy","originInCenter","bounds","shape","getBounds","fit","positions","i0","j0","i1","j1","getOffsetRange","cx","cy","getCenterPoint","angleDiff","atan2","PI","docAngle","getTopLeftPoint","gridSizePx","gridSizeUnits","ticker","addOnce","PIXI","UPDATE_PRIORITY","LOW","tCenter","getCenter","maxDistance","relevantTokens","sizeErrorMargin","isLargeToken","withinCone","minAngle","maxAngle","rayAngle","rayWithinAngle","raySceneLength","getOccupiedCells","GRID_TYPES","GRIDLESS","cells","mapCoordsToCell","highlightSquares","cell","getHighlightLayer","highlightId","rangeColor","Color","border","multiply","reachColor","SquareHighlight","fillColor","borderColor","_squares","layer","addHighlightLayer","addSquare","gridSize","hlname","ig","highlightPosition","AttackHighlightBase","clearHighlight","renderHighlight","GridlessHighlight","rangeStops","tw","th","rangeKey","minRange","rangeMeasurements","rangeIncrements","tokenOffset","hl","removeChildren","circle","Graphics","stops","inner","beginFill","drawCircle","beginHole","endHole","endFill","addChild","SquareGridHighlight","currentHighlight","isFeet","useReachRule","getReachSquares","ftDistance","userLimit","maxSquareRange","squaresExtra","SQUARE","gridDist","tokenSquares","tokenRect","getClosestTokenSquare","pos","lowest","square","sqrt","squareRange","wMax","hMax","tl","closestSquare","shouldAddReachSquare","closestTokenSquare","p0","p1","dist2","SquareGrid","diagonals","GRID_DIAGONALS","EQUIDISTANT","reachRuleRange","attackReachHighlight","showAttackReach","addReachListeners","_onMouseEnterReach","_onMouseLeaveReach","_getTokenByUuid","LLVMixin","_getLightSourceData","bright","getRadius","hasSystemVision","requiresSelection","tokenDoc","lowLightTokens","actorVision","lowLight","tokenVision","lowLightMultiplier","lowLightMultiplierBright","reinitLightSources","lightSources","AmbientLight","initializeLightSource","debouncedLightSourceReInit","addLowLightVisionToLightConfig","toFormGroup","legend","TokenPF","toggleEffect","effectId","disableLowLight","_onControl","_onRelease","_isVisionSource","hasSight","guarantee","_getBarBoost","_getBarUnderline","_drawBar","boost","underline","boostlessMax","boostlessPct","fromRGBvalues","lineStyle","drawRoundedRect","posY","wr","hr","x0","y0","DetectionModeInvisibilityPF","DetectionModeInvisibility","_testPoint","visionSource","_testLOS","_testRange","lightSource","DetectionModeBlindSensePF","DETECTION_TYPES","walls","getDetectionFilter","_detectionFilter","OutlineOverlayFilter","outlineColor","knockout","wave","ID","_canDetect","DetectionModeBlindSightPF","DetectionModeLifesensePF","DetectionModeTremorPF","DetectionModeTremor","MOVE","hasStatusEffect","specialStatusEffects","SWIM","lighting","VisionMode","LIGHTING_LEVELS","DIM","TokenHUDPF","TokenHUD","_getStatusEffectChoices","isOverlay","addQuickActions","fragment","addQuickActionListeners","after","showReach","originalAngle","initialLayer","activeLayer","activatePreviewListeners","pfStyle","_onConfirm","_onMove","rotate","_onRotate","controlIcon","removeAllListeners","stage","lastMove","RENDER_THROTTLE","getLocalPosition","_onFinish","MeasuredTemplateDocument","snap","_onClickRight","_onDragLeftCancel","_applyStaticRoll","isDie","Die","_formula","isStatic","die","faces","evaluated","TEN","TWENTY","isCheck","overBy5","isMisfire","isNonRoll","isNormal","getFormula","bonusTerms","promptDialog","DIALOG_TEMPLATE","hasDC","editDC","_onDialogSubmit","STATIC_ROLL","_getFormData","baseDice","onDemand","precision","isAbnormal","abnormalTooltip","compendiumEntryType","_evaluate","_applyBonus","_evaluateSync","addBonus","DamageRoll","enableFlavorColorset","appearance","NORMAL","CRITICAL","NON_CRITICAL","TYPES","FunctionTermPF","termTypes","propagateFlavor","_evaluateAsync","json","StringTermPF","StringTerm","_conditionals","blankToNull","FilePathField","dismiss","minValue","ColorField","EmbeddedDataField","unchainedAction","spellArea","customColor","customTexture","FALLBACK_IMAGE","_prepareConditionals","maxUses","updateContext","dataObj","spellPointCost","_total","rangeIncrement","maxRange","rangeType","singleIncrementRange","baseDCFormula","dcSchoolBonus","universalDCBonus","dcFormula","damageSources","actionTypeToContext","mods","fakeCondChanges","allChanges","condData","chatDataOptions","isUnchainedActionEconomy","activationTypes","activationTypesPlural","abilityActivationTypesPlurals_unchained","abilityActivationTypesPlurals","activationType","durationFormula","variableDuration","minroll","maxroll","unflair","compress","totalDC","rangeUnit","rangeValue","lrange","itemActionTypes","isNatural","proficiencyPenalty","isNaturalSecondary","secondaryPenalty","applyChange","addParts","isExtra","ablDamage","ablLabel","rollParts","firstDie","nonCrit","exAtkCfg","bonusToAll","unnamedAttack","unnamedAttackNames","getUniqueName","replaceSpecificRollData","attackSetCount","formulaicAttack","unchainedEconomy","parseAttacks","countFormula","bonusFormula","bonusLabel","exAtkCount","minimized","alabel","formulaCfg","condBonuses","totalBonus","diffObject","component","defaultData","defaultDamageType","hasSound","updateTime","oldChangeData","newIds","newChangeData","targetData","getSourceInfoTargets","msgSourceReference","errorMessage","errorData","overrides","modifierChanger","abilityTarget","sourceInfoTargets","infoEntry","sourceInfoGroup","infoTarget","doAdd","sumValue","existingInfoEntry","hasSameParent","isEnh","hasSameTarget","hasHighestValue","isSameModifier","isSameTarget","hasHigherValue","oldEntry","prune","_modifiers","_prepareModifiers","newScriptCallData","getDelegate","scriptEditor","scriptCall","scm","actionRange","rng","actionDamage","hash","combine","numberFormatAlt","fraction","helpers","registerHelper","measureDistances","segments","renderCallback","rates","maxRate","copper","omit","isSimpleTerm","FormulaPart","_number","ParentheticalTerm","iformula","triTermOps","simpleOnly","eterms","right","replaceZeroDice","RollTerm","negativeTerms","nterms","nt","stringTerms","handleFormula","newformula","handleParts","dmgAbl","ablMax","dmgAblBaseMod","ablDmgMult","dmgAblMod","semiFinal","sizeRoll","origCount","origSides","targetSize","initialSize","_getSizeIndex","currentDie","sizeDie","shifted","sides","d6Index","d8Index","sizeOffset","curSize","sizeReach","ifelse","ifTrue","ifFalse","sizeRollFn","fromTerms","lookup","if","_if","eq","lt","lte","gt","gte","and","or","xor","not","getConditions","statusEffects","sys","toStatusEffect","oldKey","newKey","deadCond","numberFormat","strings","ListFormat","classIDMap","PartyRestConfig","restConfig","_prepareActors","_calculateHours","rest","_onToggleCategory","_onOpenSheet","restoreUses","conscious","_isConscious","watch","nowatch","watches","duo","solo","partyRest","watchTime","isWatch","_el","pf1NoRender","_onSubmitForm","_performRest","people","cancelled","allSettled","advance","quickRest","binarySearch","searchArr","compare_fn","cmp","uniquePermutations","concat","calculateRangeFormula","spellRangeFormulas","diffObjectAndArray","keepLength","isDifferent","difference","_difference","v0","v1","d2","_deepClone","Document","DisplayObject","clone","CR_EXP_LEVELS","replacement","allowInitialNumbers","substring","embeds","pcontent","_getTextNodes","rgx","_replaceTextContent","docType","fuzzyIndex","sortArrayByName","filteredIndex","it","searchMutations","mut","getActors","unlinked","User","testUsers","sceneList","Scene","isLinked","item0","item1","ms","lastCall","diagonalRule","gs","nx","ny","nDiagonal","nStraight","nd10","propertyKey","propA","propB","pageId","align","neutral","renderForEveryone","renderApplications","systemOnly","zIndex","throttle","timeoutId","Registry","_defaultData","unregister","registryObject","RegistryEntry","DamageType","DamageTypes","CATEGORIES","colorset","Material","intrinsic","primitive","hardnessMultiplier","healthPerInch","healthBonus","healthMultiplier","buckler","incompatible","perPound","ammunition","lightWeapon","oneHandWeapon","twoHandWeapon","rangedOneHandWeapon","rangedTwoHandWeapon","enhancement","bonusPerPound","Materials","ScriptCallCategory","ScriptCalls","omitFields","StatusHudModel","actorTypes","Condition","Conditions","TRACKS","hud","HUD_EXCLUDE_INANIMATE","SET_TO_ZERO","URLField","DateField","Source","optionalString","isbn","tieIn","Sources","companion","MigrationCategory","processed","invalid","errors","ignored","completed","progress","percentage","hasTotal","progressLabel","startEntry","actionState","processing","finishEntry","recordError","ignoreEntry","addIgnored","setTotal","setInvalid","setProgress","finish","currentName","timestamp","CompendiumCollection","getInvalidEntries","invalidDocumentIds","getInvalid","getErrorEntries","MigrationState","createCategory","MigrationIssuesDialog","Dialog","prompt","MigrationDialog","migrationState","autoClose","fastMigration","stateTracker","_onMigration","_showDetails","_reloadClients","typeChanges","debouncedReload","_lastProcessUpdate","RENDERED","_preClose","compendiumRenames","racialhd","commonbuffs","mythicpaths","registerRedirects","oldUuid","newUuid","uuidRedirects","prefix","oldName","materialChanges","nexavarianSteel","alchemicalsilver","angelskin","bloodcrystal","coldiron","darkleafcloth","eelhide","elysianbronze","fireforgedsteel","frostforgedsteel","griffonmane","liquidglass","livingsteel","singingsteel","spiresteel","isMigrated","migration","initializeStateAndDialog","migrateActors","noHooks","localState","tracker","migrateActorData","migrateItems","migrateItemData","migrateScenes","migrateScene","migrateCompendiums","migrateCompendium","server","marker","wasLocked","getDocuments","applyUpdates","UPDATE_CHUNK_SIZE","migrateTokenData","tokenData","lowLightVisionMultiplier","lowLightVisionMultiplierBright","customVisionRules","saturation","brightness","attenuation","contrast","migrateToken","migrateActiveEffectsToItems","_migrateActorEncumbrance","ent","updateKey","_migrateActorNoteArrays","_migrateActorSpeed","_migrateActorSpellbookCL","curBase","curFormula","_migrateActorSpellbookSlots","spellbookSlot","baseKey","maxKey","newBase","_migrateActorSpellbookPrep","wasSpontaneous","usesAuto","_migrateActorSpellbookKind","castingClass","_migrateActorConcentration","oldValue","isString","formulaKey","_migrateActorBaseStats","deleteEntries","dPath","_migrateUnusedActorCreatureType","_migrateActorSpellbookDCFormula","_migrateActorHPAbility","_migrateActorCR","_migrateAttackAbility","_migrateActorDefenseAbility","_migrateActorSpellbookUsage","_migrateActorNullValues","_migrateActorSpellbookDomainSlots","_migrateActorStatures","_migrateActorInitAbility","_migrateActorChangeRevamp","subPath","_migrateActorCMBRevamp","_migrateCarryBonus","_migrateBuggedValues","convertToInt","_migrateSpellbookUsage","usedSpellbooks","_migrateActorHP","_migrateActorSenses","oldSenses","brightSight","_migrateActorInvaliddSkills","sklData","subSklData","_migrateActorSkillRanks","_migrateActorSkillJournals","reOldJournalFormat","subSkillKey","_migrateActorSubskillData","subSkillData","_migrateActorUnusedData","_migrateActorDRandER","oldDR","oldER","_migrateActorTraits","selections","_migrateAnyTrait","_migrateActorProficiencies","wprofs","wprofmap","sim","mar","nwprofs","_migrateActorFlags","visionPermission","mapping","uid","_migrateGilToGoldBackend","pgcoin","ggcoin","sgcoin","cgcoin","apgcoin","aggcoin","asgcoin","acgcoin","pgil","gil","sgil","cgil","itemDoc","_migrateActorActiveEffects","migrateItemActiveEffects","migrateItemDataActiveEffects","endTiminig","_migrateItemFlags","_migrateItemArrayTypes","_migrateFlagsArrayToObject","bflags","dflags","_migrateWeaponImprovised","_migrateItemSpellDescription","shortDescription","_migrateClassDynamics","stKeys","_migrateClassType","_migrateClassCasting","_migrateSpellDivineFocus","_migrateWeaponCategories","weaponType","changeProp","two","_migrateArmorCategories","oldType","_migrateArmorMaxDex","_migrateItemSize","wdSize","_migrateItemFeatAbilityTypes","_migrateClassLevels","_migrateSavingThrowTypes","_migrateCR","_migrateItemChanges","newChanges","cd","oldChanges","updateChanges","_migrateItemChangeFlags","_migrateItemContextNotes","oldNotes","newNotes","oldNote","newNote","updateNotes","_migrateEquipmentSize","_migrateSpellCosts","autoDeduct","_migrateSpellPreparation","maxAmount","spontaneousPrepared","preparedAmount","_migrateLootEquip","_migrateItemLinks","_migrateItemProficiencies","oldKeys","nwprof","_migrateItemNotes","_migrateScriptCalls","_migrateItemActionToActions","hasOldAction","spellDuration","oldSpellPointCostFormula","_migrateItemChargeCost","_migrateItemLimitedUses","_migrateItemWeight","_migrateItemHealth","_migrateContainerReduction","_migrateContainerPrice","basePrice","_migrateItemType","_migrateItemLearnedAt","learned","_migrateItemTuples","_migrateEquipmentCategories","_migrateSpellDescriptors","exists","_migrateItemTraits","_migrateRaceItemCreatureType","oldTypes","lowerCaseKey","charAt","_migrateItemMaterials","materialPath","tg","ma","newMat","_migrateSpellMultischool","customMultischools","ssLoop","ssId","ssLabel","_migrateSpellSubschool","customSubschools","_migrateItemDefaultAmmo","_migrateItemDurability","_migrateItemHeld","_migrateItemUnusedData","priceUnits","identifiedName","weaponData","useCustomTag","itemActionData","migrateItemActionData","inventoryItems","sitem","subItem","itemUpdateData","subUpdate","migrateContainerItems","_migrateActionDamageType","damageGroupPaths","damageGroupKey","damageGroup","_Action_ConvertDamageType","_migrateActionLimitedUses","_migrateActionExtraAttacks","attackParts","formulaicAttacks","_migrateActionAmmunitionUsage","_migrateActionDuration","_migrateActionMaterials","_migrateActionConditionals","reResult","_migrateActionHarmlessSpell","migrateSceneTokens","migrateSceneActors","noEncumbrance","dataType","newLink","movedUuid","_index","hiddenLinks","_delete","damageTypeString","damageTypeList","tests","damageTest","testString","aeUpdate","migrateActiveEffectData","getNewRelativeOrigin","newOrigin","originFlag","migrateRollData","migrateMessageData","cmData","newRolls","newRoll","migrateMessages","migrateActor","migrateItem","migrateMessage","migrateSystem","systemPacks","startMessage","smsgId","permanent","_migrateWorldSettings","actorMigration","itemMigration","packMigration","chatMigration","sceneMigration","preparePacks","expireFromTokens","globalThis","_canvas","FFD20","PF1CONST","dice.RollPF","layers","layerClass","_canvas.TemplateLayerPF","objectClass","_canvas.MeasuredTemplatePF","_canvas.TokenPF","hudClass","_canvas.TokenHUDPF","documents.TokenDocumentPF","documents.actor.ActorCharacterPF","documents.actor.ActorNPCPF","documents.actor.ActorHauntPF","documents.actor.ActorTrapPF","documents.actor.ActorVehiclePF","dataModels","models.actor.HauntModel","models.actor.TrapModel","models.actor.VehicleModel","documents.item.ItemAttackPF","documents.item.ItemBuffPF","documents.item.ItemClassPF","documents.item.ItemConsumablePF","documents.item.ItemContainerPF","documents.item.ItemEquipmentPF","documents.item.ItemFeatPF","documents.item.ItemLootPF","documents.item.ItemRacePF","documents.item.ItemSpellPF","documents.item.ItemWeaponPF","documents.item.ItemImplantPF","documents.ActiveEffectPF","legacyTransferral","models.ae.AEBaseModel","models.ae.AEBuffModel","documents.CombatPF","documents.CombatantPF","documents.ChatMessagePF","models.chat.BaseMessageModel","models.chat.ItemMessageModel","models.chat.ActionMessageModel","models.chat.CheckMessageModel","applications.ItemDirectoryPF","dice.D20RollPF","dice.DamageRoll","functions","_canvas.lowLightVision.LLVMixin","Actors","unregisterSheet","registerSheet","applications.actor.ActorSheetPFCharacter","makeDefault","applications.actor.ActorSheetPFNPC","applications.actor.ActorSheetPFNPCLite","applications.actor.ActorSheetPFNPCLoot","applications.actor.ActorSheetPFHaunt","applications.actor.ActorSheetPFTrap","applications.actor.ActorSheetPFVehicle","Items","applications.item.ItemSheetPF","applications.item.ItemSheetPF_Container","DocumentSheetConfig","applications.journal.JournalTextPageSheetPF1","LABEL","DETECTION_TYPE","SIGHT","initializeSocket","initializeModuleIntegration","integration","SpeedProvider","registerSystem","Pf1SpeedProvider","colors","getRanges","baseSpeed","getBaseSpeed","inHeavyArmor","inHeavyLoad","runMultiplier","useElevation","getSetting","elevation","burrow","registries","registry.DamageTypes","registry.Materials","registry.ScriptCalls","registry.Conditions","registry.Sources","registryName","registryClass","toLocalize","toLocalizeConst","toSort","doLocalize","localized","akey","aval","bkey","bval","localA","localB","doLocalizeKeys","flattenObject","localizeLabels","doLocalizePaths","PREVIOUS_MIGRATION_VERSION","documents.settings.migrateSystemSettings","changelogVersion","curVersion","chatUtils.hideRollInfo","chatUtils.hideGMSensitiveInfo","chatUtils.hideInvisibleTargets","chatUtils.addTargetCallbacks","chatUtils.alterTargetDefense","chatUtils.alterAmmoRecovery","_canvas.attackReach.addReachListeners","applications.CurrencyTransfer","macros.createItemMacro","macros.createActionMacro","macros.createSkillMacro","macros.createSaveMacro","macros.createMiscActorMacro","sizingTemplateData","sizeContent","systemVision","visionTab","enableCustomVision","toggleCustomVision","dmTab","visionContent","applications.ChangeLogWindow","Settings"],"mappings":"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AUyT,YAAY,MAIvE9H,KAAM,CACJ/I,KAAM,CACJ3W,OAAQ,CAAEtP,KAAM,WAOtBQ,MAAM4X,KAAK,SAAS,KAClB,IAAA,MAAY4gB,EAAQ94B,KAAatB,OAAOyC,QAAQi1B,GAC9C,IAAA,MAAY2C,EAASC,KAAYt6B,OAAOyC,QAAQnB,GAAW,CACzDg5B,EAAQh5B,SAAW84B,EACnBE,EAAQj2B,GAAKg2B,EACbC,EAAQC,KAAO,GAAGH,KAAUC,IAE5BC,EAAQl9B,MAAQ8E,KAAKU,KAAKC,SAASy3B,EAAQl9B,OAE3C,MAAMo9B,EAAQF,EAAQ3C,UACM,mBAAjB6C,GAAO7B,QACV6B,EAAA7B,MAAQ6B,EAAM7B,QAE5B,CACA,qFAxyBa,CACX8B,KAAM,CACJ,EACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,KACA,MACA,KACA,MACA,MACA,MACA,MACA,KACA,KACA,MACA,MACA,MACA,OACA,OACA,OACA,OACA,QACA,QACA,QACA,SACA,UAEFC,OAAQ,CACN,EACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,KACA,MACA,MACA,MACA,KACA,KACA,KACA,MACA,KACA,KACA,KACA,MACA,MACA,MACA,OACA,OACA,OACA,QACA,SAEFC,KAAM,CACJ,EACA,KACA,KACA,IACA,IACA,KACA,KACA,KACA,IACA,KACA,MACA,MACA,KACA,MACA,MACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,OACA,OACA,OACA,wBAQS,CACX,IACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,MACA,MACA,OACA,OACA,OACA,OACA,OACA,OACA,OACA,QACA,QACA,QACA,QACA,QACA,QACA,kCA0EW,CACXC,UAAW,IACXC,WAAY,+BACZC,UAAW,+BACXC,OAAQ,+BACRC,cAAe,+BACfC,WAAY,+BACZC,cAAe,0CA/yGJ,CACXrpB,IAAK,mBACL2f,IAAK,mBACLC,IAAK,mBACLC,IAAK,mBA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CRC,OAAQ,yCA9mDG,CACXze,GAAI,yBACJC,GAAI,yBACJC,GAAI,yBACJwe,GAAI,uDArjCO,CACXC,OAAQ,qBACRC,QAAS,qBACTC,KAAM,qBACNC,KAAM,mCAilGK,CACX3sC,MAAO,CACLmU,OAAQ,0BACRqN,KAAM,yBACN7jB,MAAO,0BACPm6B,WAAY,wBACZiB,UAAW,uBACXlB,UAAW,uBACXH,KAAM,qBACNkV,KAAM,yBACNlmB,KAAM,qBACNxgB,MAAO,qBACPixB,OAAQ,uBAEV5Z,OAAQ,CACNE,UAAW,4BACX0jB,IAAK,uBACL0L,MAAO,uBACPC,MAAO,uBACPC,KAAM,oBACNC,QAAS,2CAt8DA,CACX/O,KAAM,aACNgP,SAAU,0BACVtR,MAAO,uBACP2J,MAAO,uBACPrT,MAAO,uBACP9G,MAAO,uBACP4O,OAAQ,wBACRuB,KAAM,sBACN4R,GAAI,oBACJC,GAAI,oBACJC,KAAM,gBACNC,QAAS,gBACTC,UAAW,+BA5hCA,CACX,EAAG,GACH,EAAG,sCACH,EAAG,uCACH,EAAG,0DAglCQ,CACXC,UAAW,wBACXC,WAAY,mBACZC,QAAS,yCAzlBE,CACXvP,MAAO,EACPnE,OAAQ,EACRoE,MAAO,oBAhEI,CACX,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,MACA,MACA,MACA,MACA,MACA,MACA,8BAoBW,CACXzC,OAAQ,CACNG,KAAM,KACNC,IAAK,IACLC,KAAM,GACNC,GAAI,IACJ1N,IAAK,EACL2N,GAAI,EACJC,KAAM,EACNC,IAAK,EACLC,IAAK,IAEPsR,UAAW,CACT7R,KAAM,IACNC,IAAK,GACLC,KAAM,IACNC,GAAI,EACJ1N,IAAK,IACL2N,GAAI,EACJC,KAAM,EACNC,IAAK,GACLC,IAAK,oBAoKI,CACXnE,MAAO,CA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AAU,YAAa,KAAM,QAAS,OAahG,MAAMm+K,gBAAgB7C,SAE3Bt7K,aAAe+9K,OAOf/9K,gBAAO,CACLo+K,UAAW,OAIbp+K,oBAAO,CACL,CACEoU,IAAK,UACL3oB,KAAM,gBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,eACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,aACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,aACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,aACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,aACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,aACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,YACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,QAER,CACEokB,IAAK,cACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACN96D,QAAQ,EACRvtB,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uDACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yDACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kDACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kDACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0DACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0DACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,qDACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wDACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,iDACNiqG,KAAM,UACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACN96D,QAAQ,EACRvtB,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNC,MAAO,iBACP/6D,QAAQ,EACRvtB,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8CACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,oCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8CACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,iDACNiqG,KAAM,QACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,qCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,iDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,aACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,sCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,2DACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNiqG,KAAM,SACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,sCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,sDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,2DACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,sCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,iDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,qCACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,sCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,qCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,kDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,mDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,kDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,+CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,wDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,2DACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,yCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,2DACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,oDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,cACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,EACPha,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,8CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,WACL3oB,KAAM,uCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,MAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,cACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,eACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,gCACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,eACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,IACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,YACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,GACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,aACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,aACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,cACL3oB,KAAM,eACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,aACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPwpK,KAAM,oBACNjuL,KAAM,UAER,CACEokB,IAAK,aACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPn7F,MAAO,EACPzkB,KAAM,UAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNwoF,KAAM,oBACN96D,QAAQ,EACRnzH,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNwoF,KAAM,oBACNroF,IAAK,sCACLutB,QAAQ,EACRnzH,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACN96D,QAAQ,EACRnzH,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,qBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNC,MAAO,YACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,kBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,gBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,cACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNiqG,KAAM,QACND,KAAM,aACNwoF,KAAM,oBACNC,MAAO,mBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iCACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,iBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,kBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNiqG,KAAM,MACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,yBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,eACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNiqG,KAAM,MACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,YACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,eACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,gBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,mBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,gBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,KACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,oBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNiqG,KAAM,MACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,kBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNiqG,KAAM,MACND,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,oBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,0BACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNwoF,KAAM,oBACNC,MAAO,iBACPluL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNwoF,KAAM,oBACNjuL,KAAM,aAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,wCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2DACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,0CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oDACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,UACNmzH,QAAQ,GAEV,CACE/uG,IAAK,UACL3oB,KAAM,4CACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,4CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,qDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,qDACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,UACN4lG,IAAK,uCAEP,CACExhF,IAAK,UACL3oB,KAAM,uCACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2CACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,eACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,cACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,uBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,wBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,8BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gCACNiqG,KAAM,OACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNiqG,KAAM,KACND,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,0BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNiqG,KAAM,MACND,KAAM,aACNma,MAAO,IACPquE,KAAM,oBACNroF,IAAK,sCACL5lG,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,+BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,sBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,mBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,kBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,oCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,UACL3oB,KAAM,4BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,2BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,oBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,yBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,iBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,qCACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,qBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,wBACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,WACL3oB,KAAM,6BACNgqG,KAAM,aACNma,MAAO,GACPquE,KAAM,oBACNjuL,KAAM,WAER,CACEokB,IAAK,YACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACP5/G,KAAM,QACN4lG,IAAK,sCACLJ,UAAW,0BAEb,CACEphF,IAAK,YACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACP5/G,KAAM,QACN4lG,IAAK,sCACLJ,UAAW,0BAEb,CACEphF,IAAK,YACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACP5/G,KAAM,QACN4lG,IAAK,sCACLJ,UAAW,0BAEb,CACEphF,IAAK,YACL3oB,KAAM,gBACNgqG,KAAM,aACNma,MAAO,GACP5/G,KAAM,QACN4lG,IAAK,sCACLJ,UAA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","x_google_ignoreList":[18]}